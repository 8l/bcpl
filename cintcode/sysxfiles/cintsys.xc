
######com/abort.b#
SECTION."ABORT"#0A#0AGET."libhdr"#0A#0ALET.start().
#3D.VALOF.#0A{.LET.argv.#3D.VEC.10#0A..AND.n.#3D.99
#0A..1#0A..UNLESS.rdargs("NUMBER",.argv,.10).DO#0A.
.{.writef("Bad.argument.for.ABORT*n")#0A..2RESULTIS
.20#0A..}#0A..1#0A..IF.argv!0.&.string_to_number(ar
gv!0).DO.n.:#3D.result2#0A..1#0A..abort(n)#0A..RESU
LTIS.0#0A}#0A

######com/adjclock.b#
/*..adjclock.[[+/-]hh[:mm]]#0D#0A#0D#0AWith.no.argu
ments.it.outputs.the.current.clock.adjustment,.othe
rwise#0D#0Ait.sets.the.clock.adjustment.value.(whic
h.is.held.in.the.rootnode)#2E#0D#0A#0D#0AImplemente
d.by.Martin.Richards.(c).May.2000004#0D#0A*/#0D#0A#0D
#0A#0D#0A#0D#0ASECTION."ADJCLOCK"#0D#0A#0D#0AGET."l
ibhdr"#0D#0A#0D#0AGLOBAL.{.str:ug;.strp;.len;.ch.}#0D
#0A#0D#0ALET.start().#3D.VALOF#0D#0A{.LET.argv.#3D.
VEC.10#0D#0A..LET.adjustment.#3D.rootnode!rtn_adjcl
ock#0D#0A#0D#0A..UNLESS.rdargs("OFFSET",.argv,.10).
DO#0D#0A..{.writef("Bad.argument.for.ADJCLOCK*n")#0D
#0A..2RESULTIS.20#0D#0A..}#0D#0A#0D#0A..IF.argv!0.&
.str2mins(argv!0).DO.adjustment.:#3D.result2#0D#0A#0D
#0A..rootnode!rtn_adjclock.:#3D.adjustment#0D#0A#0D
#0A..writef("Clock.adjustment.is.now:.")#0D#0A..IF.
adjustment<0.DO#0D#0A..{.wrch('-')#0D#0A..2adjustme
nt.:#3D.-adjustment#0D#0A..}#0D#0A..writef("%n:%z2*
n",.adjustment./.60,.adjustment.REM.60)#0D#0A..RESU
LTIS.0#0D#0A}#0D#0A#0D#0AAND.str2mins(s).#3D.VALOF#0D
#0A{.LET.neg,.hours,.mins.#3D.FALSE,.0,.0#0D#0A#0D#0A
..str,.strp,.len.:#3D.s,.1,.s%0#0D#0A#0D#0A..rch()#0D
#0A..IF.ch#3D'-'.|.ch#3D'+'.DO#0D#0A..{.IF.ch#3D'-'
.DO.neg.:#3D.TRUE#0D#0A..2rch()#0D#0A..}#0D#0A..WHI
LE.'0'<#3Dch<#3D'9'.DO#0D#0A..{.hours.:#3D.10*hours
.+.ch-'0'#0D#0A..2rch()#0D#0A..}#0D#0A..IF.ch#3D':'
.DO#0D#0A..{.rch()#0D#0A..2WHILE.'0'<#3Dch<#3D'9'.D
O#0D#0A..2{.mins.:#3D.10*mins.+.ch-'0'#0D#0A..4rch(
)#0D#0A..2}#0D#0A..}#0D#0A..UNLESS.ch#3Dendstreamch
.RESULTIS.FALSE#0D#0A#0D#0A..mins.:#3D.60*hours.+.m
ins#0D#0A..result2.:#3D.neg.->.-mins,.mins#0D#0A..R
ESULTIS.TRUE#0D#0A}#0D#0A#0D#0AAND.rch().BE.TEST.st
rp<#3Dlen.THEN.{.ch.:#3D.str%strp;.strp.:#3D.strp+1
.}#0D#0A..26ELSE..1ch.:#3D.endstreamch#0D#0A

######com/append.b#
SECTION."APPEND"#0A#0AGET."libhdr"#0A#0AGLOBAL#0A{#0A
inputstream:ug#0Aoutputstream#0A}#0A#0ALET.start().
#3D.VALOF#0A{.LET.argv.#3D.VEC.50#0A..LET.rc.#3D.0#0A
..LET.ch.#3D.0#0A..LET.oldoutput.#3D.output()#0A#0A
..inputstream.:#3D.0#0A..outputstream.:#3D.0#0A#0A.
.UNLESS.rdargs("FROM/A,TO/K",.argv,.50).DO#0A..{.wr
ites("Bad.args*n")#0A..2rc.:#3D.20#0A..2GOTO.exit#0A
..}#0A#0A..inputstream.:#3D.findinput(argv!0)..7//.
FROM#0A..UNLESS.inputstream.DO.{.writef("Can*'t.ope
n.%s*n",.argv!0)#0A..24rc.:#3D.20#0A..24GOTO.exit#0A
..22}#0A..selectinput(inputstream)#0A#0A..IF.argv!1
.DO..27//.TO/K#0A..{.outputstream.:#3D.findappend(a
rgv!1)#0A..2IF.outputstream#3D0.DO#0A..2{.writef("C
an*'t.open.%s*n",.argv!1)#0A..4rc.:#3D.20#0A..4GOTO
.exit#0A..2}#0A..2selectoutput(outputstream)#0A..}#0A
#0A..{.LET.tab.#3D.0#0A#0A..2{.ch.:#3D.rdch()#0A..4
IF.intflag().DO.{.IF.tab.DO.wrch('*n')#0A..22select
output(oldoutput)#0A..22writes("**2BREAK*n")#0A..22
rc.:#3D.5#0A..22GOTO.exit#0A..20}#0A..4UNLESS.tab.D
O.{.IF.ch#3Dendstreamch.GOTO.exit#0A..18}#0A..4SWIT
CHON.ch.INTO#0A..4{.CASE.'*c':#0A..6CASE.'*n':#0A..
6CASE.'*p':.wrch(ch);.BREAK#0A#0A..6CASE.'*t':.{.wr
ch('*s')#0A..19tab.:#3D.tab+1#0A..17}.REPEATUNTIL.t
ab.REM.8.#3D.0#0A..17LOOP#0A#0A..6DEFAULT:..1wrch(c
h)#0A..17tab.:#3D.tab+1#0A..17LOOP#0A#0A..6CASE.end
streamch:#0A//..14wrch('*n')#0A..16GOTO.exit#0A..4}
#0A..2}.REPEAT#0A..}.REPEAT#0A#0Aexit:#0A..IF.input
stream..DO.endstream(inputstream)#0A..IF.outputstre
am.DO.endstream(outputstream)#0A..RESULTIS.rc#0A}#0A


######com/bcpl2sial.b#
//.This.is.the.BCPL.to.Sial.compiler#0A#0A//.Implem
ented.by.Martin.Richards.(c).July.2000009#0A#0A//.N
ote:.#2E#2E/cintcode/.is.used.so.that.the.compiler.
can.be#0A//.compiled.in.a.directory.parallel.to.cin
tcode.(such.as.natbcpl)#2E#0A#0AGET."#2E#2E/cintcod
e/com/bcplfe#2Eb"#0A#0A#2E#0A#0AGET."#2E#2E/cintcod
e/com/bcplcgsial#2Eb"#0A

######com/bcpl64.b#
//.This.is.the.64-bit.BCPL.to.Cintcode.compiler#0A#0A
//.Implemented.by.Martin.Richards.(c).May.2013#0A#0A
//.Note:.#2E#2E/cintcode/.is.used.so.that.the.compi
ler.can.be#0A//.compiled.in.a.directory.parallel.to
.cintcode.(such.as.natbcpl)#2E#0A#0A//.Note:.the.64
-bit.BCPL.compiler.uses.the.standard.front.end#2E#0A
#0AGET."#2E#2E/cintcode/com/bcplfe#2Eb"#0A#0A#2E#0A
#0AGET."#2E#2E/cintcode/com/bcpl64cgcin#2Eb"#0A

######com/bcpl64cgcin.b#
//.This.is.the.BCPL64.OCODE.to.Cintcode.codegenerat
or#2E#0A#0A//.Implemented.by.Martin.Richards.(c).12
.May.2013#0A#0A/*.Change.history#0A#0A00015/05/13#0A
Modified.to.use.c64.and.t64.that.specify.the.BCPL.w
ord.length.of#0Athe.compiler.and.target.machines,.r
espectively#2E#0A#0A00010/05/13#0AMajor.change.to.t
he.compilation.of.SWITCHON.to.stop.the.compiler#0Ac
rashing.when.given.CASE.minint:#2E.See.function.swi
tcht#2E#0A#0A00010/07/09#0ASeparated.the.compiler.i
nto.bcplfe#2Eb.and.codegenerators#0Abcplcgcin#2Eb.a
nd.bcplcgsial#2Eb.and.added.the.interface#0Aheader.
g/bcplfecg#2Eh#0A#0A00007/09/06#0AThis.is.a.version
.of.the.BCPL.compiler.that.generates.64-cintcode#2E
..It#0Ais.designed.to.run.on.both.32-.and.64-bit.sy
stems#2E.The.options.t32.and#0At64.specify.the.bit.
lenth.of.the.BCPL.word.in.the.target.system#2E.The#0A
default.is.the.same.as.the.current.system#2E..On.64
-bit.systems#0Anumerical.constants.are.compiles.to.
full.precision,.but.on.32-bit#0Asystems.they.are.tr
uncated.to.32.bits.then.sign.extended.to.64#0Abits#2E
.64-bit.Cintcode.has.one.new.instruction.(MW).that.
modifies.the#0Aoperand.of.the.next.W.type.instructi
on.(KW,.LLPW,.LW,.LPW,.SPW,.APW#0Aand.AW)#2E.It.doe
s.this.by.setting.the.senior.32-bits.of.the.new.64-
bit#0AMW.register#2E.This.is.added.to.the.operand.o
f.any.W.type.instruction#0Aand.is.cleared.after.use
#2E#0A#0A00018/01/06#0ABased.on.Dave.Lewis's.sugges
tion,#0Ain.outputsection(),.add:#0A..1IF.objline1%0
.DO.writef("%s*n",.objline1)#0Awhere.objline1.is.th
e.first.line.of.file.objline1.if.it.can.be.found#0A
in.the.current.directory.or.in.the.HDRS.directory#2E
.This.will.typically#0Aput.a.line.such.as:#0A#23!/u
sr/local/bin/cintsys.-c#0Aas.the.first.line.of.the.
compiled.object.module#2E.This.line.is.ignored#0Aby
.the.CLI.but.may.be.useful.under.Linux#2E.If.objlin
e1.cannot.be.found#0Ano.such.line.is.inserted.at.th
e.start.of.the.object.module#2E#0A#0A00007/01/06#0A
Initial.version.of.the.64-bit.codegenerator#0A#0A00
026/2/99#0AAdded.BIN.option.to.the.compiler.to.gene
rate.a.binary.(rather.than#0Ahex).hunk.format.for.t
he.compiled.code#2E.This.is.primarily.for.the#0AWin
dows.CE.version.of.the.cintcode.system.where.compac
tness.is#0Aparticularly.important#2E.There.is.a.rel
ated.change.to.loadseg.in#0Acintmain#2Ec#0A#0A00024
/12/95#0AImproved.the.efficiency.of.outputsection.i
n.CG.by.introducing#0Awrhex2.and.wrword_at#2E#0A#0A
00024/7/95#0ARemoved.bug.in.atbinfo,.define.addinfo
_b.change.some.global.numbers#2E#0AImplement.consta
nt.folding.in.TRN#2E#0A#0A00022/6/93#0AReverse.orde
r.in.SWB.and.have.a.minimum.of.7.cases#0Ato.allow.f
aster.interpreter#2E#0A#0A0002/6/93#0AChanged.code.
for.SWB.to.use.heap-like.binary.tree#2E#0A#0A00019/
5/93#0APut.in.code.to.compile.BTC.and.XPBYT.instruc
tions#2E#0A#0A00023/4/93#0AAllowed.the.codegenerato
r.to.compiler.the.S.instruction#2E#0A#0A00021/12/92
#0ACured.bug.in.compilation.of.(b.->.f,.g)(1,2,3)#0A
#0A00024/11/92.#0ACured.bug.in.compilation.of.a,.b.
:#3D.s%0.>.0,.s%1.#3D.'!'#0A#0A00023/7/92:#0ARename
d.nextlab.as.newlab,.load.as.loadval.in.the.CG#2E#0A
Put.back.simpler.hashing.function.in.lookupword#2E#0A
Removed.rdargs.fudge#2E#0ARemoved.S2.compiler.optio
n#2E#0ACured.bug.concerning.the.closing.of.gostream
.when.equal.to.stdout#2E#0A*/#0A#0ASECTION."BCPL64C
GCIN"#0A#0A//.If.c64.is.FALSE,.we.are.running.an.a.
32-bit.system#0A//.If.c64.is.TRUE,..we.are.running.
an.a.64-bit.system#0A#0A//.If.t64.is.FALSE,.it.gene
rates.32-bit.Cintcode#2E#0A//.If.t64.is.TRUE,..it.g
enerates.64-bit.Cintcode#2E#0A//.If.neither.are.set
.is.generates.code.compatible.with.the.currently#0A
//.running.system#2E#0A#0AGET."libhdr"#0AGET."bcplf
ecg"#0A#0AGLOBAL.{#0A//.Global.procedures#2E#0Acgse
cts:.cgg#0Ardname#0Ardl#0Ardgn#0Anewlab#0Achecklab#0A
cgerror#0A#0Ainitstack#0Astack#0Astore#0Ascan#0Acgp
endingop#0Aloadval#0Aloadba#0Asetba#0A#0Agenxch#0Ag
enatb#0Aloada#0Apush#0Aloadboth#0Ainreg_a#0Ainreg_b
#0Aaddinfo_a#0Aaddinfo_b#0Apushinfo#0Axchinfo#0Aatb
info#0A#0Aforget_a#0Aforget_b#0Aforgetall#0Aforgetv
ar#0Aforgetallvars#0A#0Aiszero#0Astoret#0Agensp#0Ag
enlp#0Aloadt#0Alose1#0Aswapargs#0Acgstind#0Astorein
#0A#0Acgrv#0Acgadd#0Acgloadk#0Acgaddk#0Acgglobal#0A
cgentry#0Acgapply#0Acgjump#0Ajmpfn#0Ajfn0#0Arevjfn#0A
compjfn#0Aprepj#0A#0Aswlpos#0Aswrpos#0Afindpos#0Aro
otpos#0A#0Acgswitch#0Aswitcht#0Aswitchta#0Aswitchse
g#0Aswitchb#0Aswitchl#0Acgstring#0Asetlab#0Acgstati
cs#0Agetblk#0Afreeblk#0Afreeblks#0A#0Ainitdatalists
#0A#0Ageng#0Agen#0Agenb#0Agenr#0Agenh#0Agenw#0Achec
kspace#0Acodeb#0Acode2b#0Acode4b#0Apack4b#0Acodeh#0A
codew#0Acoder#0A#0Agetw#0Aputh#0Aputw#0Aalign#0Achk
refs#0Adealwithrefs#0Agenindword#0Ainrange_d#0Ainra
nge_i#0Afillref_d#0Afillref_i#0Arelref#0A#0Aoutputs
ection#0Awrword#0Awrhex2#0Awrword_at#0Adboutput#0Aw
rkn#0Awrcode#0Awrfcode#0A#0A//.Global.variables#2E#0A
arg1#0Aarg2#0A#0Assp#0A#0Atempt#0Atempv#0Astv#0Astv
p#0A#0Ach#0A#0Adp#0Afreelist#0A#0Aincode#0Alabv#0A#0A
casek#0Acasel#0A#0Amaxgn#0Amaxlab#0Amaxssp#0A#0Aop#0A
labnumber#0Apendingop#0Aprocdepth#0A#0Aprogsize#0A#0A
info_a#0Ainfo_b#0Areflist#0Arefliste#0Arlist#0Arlis
te#0Anlist#0Anliste#0Askiplab#0A#0Acodestr#0Ablkupb
..10//.#3D3.if.bytesperword#3D4.and.t64#3DTRUE#0A..
16//.#3D2.otherwise#2E#0A}#0A#0AMANIFEST#0A{#0A//.V
alue.descriptors#2E#0Ak_none#3D0;.k_numb#3D1;.k_fnl
ab#3D2#0Ak_lvloc#3D3;.k_lvglob#3D4;.k_lvlab#3D5#0Ak
_a#3D6;.k_b#3D7;.k_c#3D8#0Ak_loc#3D9;.k_glob#3D10;.
k_lab#3D11;.#0Ak_loc0#3D12;.k_loc1#3D13;.k_loc2#3D1
4;.k_loc3#3D15;.k_loc4#3D16#0Ak_glob0#3D17;.k_glob1
#3D18;.k_glob2#3D19#0A#0Aswapped#3DTRUE;.notswapped
#3DFALSE#0A#0A//.Global.routine.numbers#2E#0Agn_sto
p#3D2#0A}#0A#0A//.CINTCODE.op.codes#2E#0AMANIFEST.{
#0Af_k0..1#3D..0010#0Af_lf..1#3D..00012#0Af_lm..1#3D
..00014#0Af_lm1..#3D..00015#0Af_l0..1#3D..00016#0Af
_fhop.#3D..00027#0Af_jeq..#3D..00028#0Af_jeq0.#3D..
00030#0A#0Af_k..2#3D..00032#0Af_kh..1#3D..00033#0Af
_kw..1#3D..00034#0Af_k0g..#3D..00032#0Af_s0g..#3D..
00044#0Af_l0g..#3D..00045#0Af_l1g..#3D..00046#0Af_l
2g..#3D..00047#0Af_lg..1#3D..00048#0Af_sg..1#3D..00
049#0Af_llg..#3D..00050#0Af_ag..1#3D..00051#0Af_mul
..#3D..00052#0Af_div..#3D..00053#0Af_rem..#3D..0005
4#0Af_xor..#3D..00055#0Af_sl..1#3D..00056#0Af_ll..1
#3D..00058#0Af_jne..#3D..00060#0Af_jne0.#3D..00062#0A
#0Af_llp..#3D..00064#0Af_llph.#3D..00065#0Af_llpw.#3D
..00066#0Af_add..#3D..00084#0Af_sub..#3D..00085#0Af
_lsh..#3D..00086#0Af_rsh..#3D..00087#0Af_and..#3D..
00088#0Af_or..1#3D..00089#0Af_ll1..#3D..00090#0Af_j
ls..#3D..00092#0Af_jls0.#3D..00094#0A#0Af_l..2#3D..
00096#0Af_lh..1#3D..00097#0Af_lw..1#3D..00098#0Af_r
v..1#3D.110006#0Af_rtn..#3D.123#0Af_jgr..#3D.124#0A
f_jgr0.#3D.126#0A#0Af_lp..1#3D.128#0Af_lph..#3D.129
#0Af_lpw..#3D.130#0Af_lp0..#3D.128#0Af_swb..#3D.146
#0Af_swl..#3D.147#0Af_st..1#3D.148#0Af_st0..#3D.148
#0Af_goto.#3D.155#0Af_jle..#3D.156#0Af_jle0.#3D.158
#0A#0Af_sp..1#3D.160#0Af_sph..#3D.161#0Af_spw..#3D.
162#0Af_sp0..#3D.160#0Af_s0..1#3D.176#0Af_xch..#3D.
181#0Af_gbyt.#3D.182#0Af_pbyt.#3D.183#0Af_atc..#3D.
184#0Af_atb..#3D.185#0Af_j..2#3D.186#0Af_jge..#3D.1
88#0Af_jge0.#3D.190#0A#0Af_ap..1#3D.192#0Af_aph..#3D
.193#0Af_apw..#3D.194#0Af_ap0..#3D.192#0Af_xpbyt#3D
.205#0Af_lmh..#3D.206#0Af_btc..#3D.207#0Af_nop..#3D
.208#0Af_a0..1#3D.208#0Af_rvp0.#3D.211#0Af_st0p0#3D
.216#0Af_st1p0#3D.218#0Af_mw..1#3D.220003#0A#0Af_a.
.2#3D.220004#0Af_ah..1#3D.220005#0Af_aw..1#3D.22000
6#0Af_l0p0.#3D.220004#0Af_s..2#3D.237#0Af_sh..1#3D.
238#0Af_mdiv.#3D.239#0Af_chgco#3D.240#0Af_neg..#3D.
241#0Af_not..#3D.242#0Af_l1p0.#3D.240#0Af_l2p0.#3D.
244#0Af_l3p0.#3D.247#0Af_l4p0.#3D.249#0A}#0A#0ALET.
codegenerate(workspace,.workspacesize).BE#0A{.//wri
tef("%n-bit.system.generating.%n-bit.code*n",.(c64-
>64,32),.(t64->64,32))#0A#0A..IF.workspacesize<2001
.DO.{.cgerror("Too.little.workspace")#0A..27errcoun
t.:#3D.errcount+1#0A..27longjump(fin_p,.fin_l)#0A..
25}#0A#0A..progsize.:#3D.0#0A#0A..op.:#3D.rdn()#0A#0A
..cgsects(workspace,.workspacesize)#0A..writef("Cod
e.size.#3D.%i5.bytes.of.%n-bit.%s.ender.Cintcode*n"
,#0A..7progsize,.(t64->64,32),.(bigender->"big","li
ttle"))#0A}#0A#0A1AND.cgsects(workvec,.vecsize).BE.
UNTIL.op#3D0.DO#0A{.LET.p.#3D.workvec#0A..tempv.:#3D
.p#0A..p.:#3D.p+90#0A..tempt.:#3D.p#0A..casek.:#3D.
p#0A..p.:#3D.p+400#0A..casel.:#3D.p#0A..p.:#3D.p+40
0#0A..labv.:#3D.p#0A..dp.:#3D.workvec+vecsize#0A..l
abnumber.:#3D.(dp-p)/10+10#0A..p.:#3D.p+labnumber#0A
..FOR.lp.#3D.labv.TO.p-1.DO.!lp.:#3D.-1#0A..stv.:#3D
.p#0A..stvp.:#3D.0#0A..incode.:#3D.FALSE#0A..maxgn.
:#3D.0#0A..maxlab.:#3D.0#0A..maxssp.:#3D.0#0A..proc
depth.:#3D.0#0A..info_a,.info_b.:#3D.0,.0#0A#0A..TE
ST.t64.&.~c64#0A..THEN.blkupb.:#3D.3.//.t64.set.but
.running.on.a.32-bit.implementation#0A..ELSE.blkupb
.:#3D.2.//.otherwise#2E#0A#0A..initstack(3)#0A..ini
tdatalists()#0A#0A..codew(0,.0)..//.For.size.of.mod
ule#2E#0A..IF.op#3Ds_section.DO#0A..{.MANIFEST.{.up
b#3D11.}.//.Max.length.of.entry.name#0A..2LET.n.#3D
.rdn()#0A..2LET.v.#3D.VEC.upb/bytesperword#0A..2v%0
.:#3D.upb#0A..2rdname(n,.v).//.Pack.up.to.11.charac
ter.of.the.name.into.v#0A#0A..2IF.naming.DO#0A..2{.
TEST.c64#0A..4THEN.codew(..sectword>>00032,..sectwo
rd)#0A..4ELSE.codew(-(sectword>>00031),.sectword)./
/.Sign.extend#0A..4codestr(v)#0A..2}#0A#0A..2op.:#3D
.rdn()#0A..}#0A#0A..scan()#0A..op.:#3D.rdn()#0A..pu
tw(0,.stvp/wordbytelen)..//.Plant.the.word.size.of.
the.module#2E#0A..outputsection()#0A..progsize.:#3D
.progsize.+.stvp#0A}#0A#0AAND.rdname(n,.v).BE#0A{./
/.Pack.up.to.11.character.of.the.name.into.v.includ
ing#0A..//.the.first.and.last.five#2E#0A..TEST.n<#3D
11#0A..THEN.{.FOR.i.#3D.1.TO.n.DO.v%i.:#3D.rdn()#0A
..7FOR.i.#3D.n+1.TO.11.DO.v%i.:#3D.'*s'#0A..5}#0A..
ELSE.{.FOR.i.#3D.1.TO.5..1DO.v%i.:#3D.rdn()#0A..7FO
R.i.#3D.6.TO.n-6.DO.rdn().//.Ignore.the.middle.char
acters#0A..7FOR.i.#3D.6.TO.11..DO.v%i.:#3D.rdn()#0A
..7IF.n>11.DO.v%6.:#3D.'*''#0A..5}#0A}#0A#0A//.Read
.in.an.OCODE.label#2E#0AAND.rdl().#3D.VALOF#0A{.LET
.l.#3D.rdn()#0A..IF.maxlab<l.DO.{.maxlab.:#3D.l;.ch
ecklab().}#0A..RESULTIS.l#0A}#0A#0A//.Read.in.a.glo
bal.number#2E#0AAND.rdgn().#3D.VALOF#0A{.LET.g.#3D.
rdn()#0A..IF.maxgn<g.DO.maxgn.:#3D.g#0A..RESULTIS.g
#0A}#0A#0A//.Generate.next.label.number#2E#0AAND.ne
wlab().#3D.VALOF#0A{.labnumber.:#3D.labnumber-1#0A.
.checklab()#0A..RESULTIS.labnumber#0A}#0A#0AAND.che
cklab().BE.IF.maxlab>#3Dlabnumber.DO#0A{.cgerror("T
oo.many.labels.-.increase.workspace")#0A..errcount.
:#3D.errcount+1#0A..longjump(fin_p,.fin_l)#0A}#0A#0A
AND.cgerror(mes,.a).BE#0A{.writes("*nError:.")#0A..
writef(mes,.a)#0A..newline()#0A..errcount.:#3D.errc
ount+1#0A..IF.errcount>errmax.DO.{.writes("Too.many
.errors*n")#0A..24longjump(fin_p,.fin_l)#0A..22}#0A
}#0A#0A//.Initialize.the.simulated.stack.(SS)#2E#0A
LET.initstack(n).BE#0A{.arg2,.arg1,.ssp.:#3D.tempv,
.tempv+3,.n#0A..pendingop.:#3D.s_none#0A..h1!arg2,.
h2!arg2,.h3!arg2.:#3D.k_loc,.ssp-2,.ssp-2#0A..h1!ar
g1,.h2!arg1,.h3!arg1.:#3D.k_loc,.ssp-1,.ssp-1#0A..I
F.maxssp<ssp.DO.maxssp.:#3D.ssp#0A}#0A#0A//.Move.si
mulated.stack.(SS).pointer.to.N#2E#0AAND.stack(n).B
E#0A{.IF.maxssp<n.DO.maxssp.:#3D.n#0A..IF.n>#3Dssp+
4.DO.{.store(0,ssp-1)#0A..17initstack(n)#0A..17RETU
RN#0A..15}#0A#0A..WHILE.n>ssp.DO.loadt(k_loc,.ssp)#0A
#0A..UNTIL.n#3Dssp.DO#0A..{.IF.arg2#3Dtempv.DO#0A..
2{.TEST.n#3Dssp-1#0A..4THEN.{.ssp.:#3D.n#0A..11h1!a
rg1,.h2!arg1,.h3!arg1.:#3D.h1!arg2,.h2!arg2,.ssp-1#0A
..11h1!arg2,.h2!arg2,.h3!arg2.:#3D.k_loc,.ssp-2,.ss
p-2#0A..9}#0A..4ELSE.initstack(n)#0A..4RETURN#0A..2
}#0A#0A..2arg1,.arg2,.ssp.:#3D.arg1-3,.arg2-3,.ssp-
1#0A..}#0A}#0A#0A//.Store.all.SS.items.from.S1.to.S
2.in.their.true#0A//.locations.on.the.stack#2E#0A//
.It.may.corrupt.both.registers.A.and.B#2E#0AAND.sto
re(s1,.s2).BE.FOR.p.#3D.tempv.TO.arg1.BY.3.DO#0A..1
9{.LET.s.#3D.h3!p#0A..21IF.s>s2.RETURN#0A..21IF.s>#3D
s1.DO.storet(p)#0A..19}#0A#0AAND.scan().BE#0A{.IF.d
ebug>1.DO.{.writef("OP#3D%i3.PND#3D%i3.",.op,.pendi
ngop)#0A..16dboutput()#0A..14}#0A..SWITCHON.op.INTO
#0A#0A..{.DEFAULT:..3cgerror("Bad.OCODE.op.%n",.op)
#0A..15ENDCASE#0A#0A..2CASE.0:..4RETURN#0A..4#0A..2
CASE.s_needs:#0A..13{.LET.n.#3D.rdn()..//.Ignore.NE
EDS.directives#2E#0A..15FOR.i.#3D.1.TO.n.DO.rdn()#0A
..15ENDCASE#0A..13}#0A#0A..2CASE.s_lp:..1loadt(k_lo
c,..1rdn());..1ENDCASE#0A..2CASE.s_lg:..1loadt(k_gl
ob,..rdgn());..ENDCASE#0A..2CASE.s_ll:..1loadt(k_la
b,..1rdl());..1ENDCASE#0A..2CASE.s_lf:..1loadt(k_fn
lab,.rdl());..1ENDCASE#0A..2CASE.s_ln:..1loadt(k_nu
mb,..rdn());..1ENDCASE#0A#0A..2CASE.s_lstr:.cgstrin
g(rdn());..7ENDCASE#0A#0A..2CASE.s_true:.loadt(k_nu
mb,.-1);..5ENDCASE#0A..2CASE.s_false:loadt(k_numb,.
.0000);..5ENDCASE#0A#0A..2CASE.s_llp:..loadt(k_lvlo
c,..rdn());..ENDCASE#0A..2CASE.s_llg:..loadt(k_lvgl
ob,.rdgn());.ENDCASE#0A..2CASE.s_ll1:..loadt(k_lvla
b,..rdl());..ENDCASE#0A#0A..2CASE.s_sp:..1storein(k
_loc,..rdn());..ENDCASE#0A..2CASE.s_sg:..1storein(k
_glob,.rdgn());.ENDCASE#0A..2CASE.s_sl:..1storein(k
_lab,..rdl());..ENDCASE#0A#0A..2CASE.s_stind:cgstin
d();.ENDCASE#0A#0A..2CASE.s_rv:..1cgrv();.ENDCASE#0A
#0A..2CASE.s_mul:CASE.s_div:CASE.s_rem:#0A..2CASE.s
_add:CASE.s_sub:#0A..2CASE.s_eq:.CASE.s_ne:#0A..2CA
SE.s_ls:CASE.s_gr:CASE.s_le:CASE.s_ge:#0A..2CASE.s_
lshift:CASE.s_rshift:#0A..2CASE.s_logand:CASE.s_log
or:CASE.s_eqv:CASE.s_neqv:#0A..2CASE.s_not:CASE.s_n
eg:CASE.s_abs:#0A..15cgpendingop()#0A..15pendingop.
:#3D.op#0A..15ENDCASE#0A#0A..2CASE.s_jt:..1cgjump(T
RUE,.rdl());..ENDCASE#0A#0A..2CASE.s_jf:..1cgjump(F
ALSE,.rdl());.ENDCASE#0A#0A..2CASE.s_goto:.cgpendin
gop()#0A..15store(0,.ssp-2)#0A..15TEST.h1!arg1#3Dk_
fnlab#0A..15THEN.genr(f_j,.h2!arg1)#0A..15ELSE.{.lo
ada(arg1);.gen(f_goto).}#0A..15stack(ssp-1)#0A..15i
ncode.:#3D.FALSE#0A..15//.This.is.a.good.place.to.d
eal.with#0A..15//.some.outstanding.forward.refs#2E#0A
..15chkrefs(50)#0A..15ENDCASE#0A#0A..2CASE.s_lab:..
cgpendingop()#0A..15UNLESS.incode.DO.chkrefs(30)#0A
..15store(0,.ssp-1)#0A..15setlab(rdl())#0A..15forge
tall()#0A..15incode.:#3D.procdepth>0#0A..15ENDCASE#0A
#0A..2CASE.s_query:loadt(k_loc,.ssp);..12ENDCASE#0A
#0A..2CASE.s_stack:cgpendingop();.stack(rdn());..2E
NDCASE#0A#0A..2CASE.s_store:cgpendingop();.store(0,
.ssp-1);.ENDCASE#0A#0A..2CASE.s_entry:#0A..13{.LET.
l.#3D.rdl()#0A..15LET.n.#3D.rdn()#0A..15cgentry(l,.
n)#0A..15procdepth.:#3D.procdepth.+.1#0A..15ENDCASE
#0A..13}#0A#0A..2CASE.s_save:#0A..13{.LET.n.#3D.rdn
()#0A..15initstack(n)#0A..15IF.n>3.DO.addinfo_a(k_l
oc,.3)#0A..15ENDCASE#0A..13}#0A#0A..2CASE.s_fnap:#0A
..2CASE.s_rtap:.cgapply(op,.rdn())#0A..15ENDCASE#0A
#0A..2CASE.s_rtrn:.cgpendingop()#0A..15gen(f_rtn)#0A
..15incode.:#3D.FALSE#0A..15ENDCASE#0A..17#0A..2CAS
E.s_fnrn:.cgpendingop()#0A..15loada(arg1)#0A..15gen
(f_rtn)#0A..15stack(ssp-1)#0A..15incode.:#3D.FALSE#0A
..15ENDCASE#0A#0A..2CASE.s_endproc:#0A..15cgstatics
()#0A..15procdepth.:#3D.procdepth.-.1#0A..15ENDCASE
#0A#0A..2CASE.s_res:#0A..2CASE.s_jump:#0A..13{.LET.
l.#3D.rdl()#0A#0A..15cgpendingop()#0A..15store(0,.s
sp-2)#0A..15TEST.op#3Ds_jump#0A..15THEN.storet(arg1
)#0A..15ELSE.{.loada(arg1);.stack(ssp-1).}#0A#0A..1
5{.op.:#3D.rdn()#0A..17UNLESS.op#3Ds_stack.BREAK#0A
..17stack(rdn())#0A..15}.REPEAT#0A#0A..15TEST.op#3D
s_lab#0A..15THEN.{.LET.m.#3D.rdl()#0A..22UNLESS.l#3D
m.DO.genr(f_j,.l)#0A..22setlab(m)#0A..22forgetall()
#0A..22incode.:#3D.procdepth>0#0A..22op.:#3D.rdn()#0A
..20}#0A..15ELSE.{.genr(f_j,.l)#0A..22incode.:#3D.F
ALSE#0A..22//.Deal.with.some.refs#2E#0A..22chkrefs(
50)#0A..20}#0A#0A..15LOOP#0A..13}#0A#0A..2//.rstack
.always.occurs.immediately.after.a.lab.statement#0A
..2//.at.a.time.when.cgpendingop().and.store(0,.ssp
-2).have#0A..2//.been.called#2E#0A..2CASE.s_rstack:
#0A..15stack(rdn());.loadt(k_a,.0);.ENDCASE#0A#0A..
2CASE.s_finish:..//.Compile.code.for:..stop(0)#2E#0A
..13{.LET.k.#3D.ssp#0A..15stack(ssp+3)#0A..15loadt(
k_numb,.0)#0A..15loadt(k_numb,.0)#0A..15loadt(k_glo
b,.gn_stop)#0A..15cgapply(s_rtap,.k)..2//.Simulate.
the.call:.stop(0,.0)#0A..15ENDCASE#0A..13}#0A#0A..2
CASE.s_switchon:#0A..15cgswitch();.ENDCASE#0A#0A..2
CASE.s_getbyte:#0A..15cgpendingop()#0A..15loadba(ar
g2,.arg1)#0A..15gen(f_gbyt)#0A..15forget_a()#0A..15
lose1(k_a,.0)#0A..15ENDCASE#0A#0A..2CASE.s_putbyte:
#0A..15cgpendingop()#0A#0A..15//.First.move.arg3.to
.C#2E#0A..13{.LET.arg3.#3D.arg2.-.3#0A..15TEST.arg3
-tempv.<.0.#0A..15THEN.{.loadt(k_loc,.ssp-3)#0A..22
loada(arg1)#0A..22gen(f_atc)#0A..22stack(ssp-1)#0A.
.20}#0A..15ELSE.{.TEST.inreg_b(h1!arg3,.h2!arg3)#0A
..22THEN..2gen(f_btc)#0A..22ELSE.{.loada(arg3)#0A..
29gen(f_atc)#0A..27}#0A..22h1!arg3.:#3D.k_c#0A..20}
#0A..15TEST.loadboth(arg2,.arg1)#3Dswapped#0A..15TH
EN.gen(f_xpbyt)#0A..15ELSE.gen(f_pbyt)#0A..15forget
allvars()#0A..15stack(ssp-3)#0A..15ENDCASE#0A..13}#0A
#0A..2CASE.s_global:#0A..15cgglobal(rdn());.RETURN#0A
#0A..2CASE.s_datalab:#0A..13{.LET.lab.#3D.rdl().#0A
..15op.:#3D.rdn()#0A#0A..15WHILE.op#3Ds_itemn.DO#0A
..15{.LET.t.#3D.getblk(0,lab,0)#0A..17LET.bv.#3D.@t
!2#0A..17LET.val.#3D.rdn()#0A..17LET.upb.#3D.t64.->
.7,.3#0A..17//.Copy.the.bytes.of.val.into.bv.in#0A.
.17//.little-ender.order#0A..17FOR.i.#3D.0.TO.upb.D
O#0A..17{.bv%i.:#3D.val#0A..19val.:#3D.val/256#0A..
17}#0A..17!nliste.:#3D.t#0A..17nliste,.lab,.op.:#3D
.!nliste,.0,.rdn()#0A..15}#0A..15LOOP#0A..13}#0A..}
#0A#0A..op.:#3D.rdn()#0A}.REPEAT#0A#0A1//.Compiles.
code.to.deal.with.any.pending.op#2E#0ALET.cgpending
op().BE#0A{.LET.f.#3D.0#0A..LET.sym.#3D.TRUE#0A..LE
T.pndop.#3D.pendingop#0A..pendingop.:#3D.s_none#0A#0A
..SWITCHON.pndop.INTO#0A..{.DEFAULT:..4cgerror("Bad
.pendingop.%n",.pndop)#0A#0A..2CASE.s_none:..RETURN
#0A#0A..2CASE.s_abs:..1loada(arg1)#0A..16chkrefs(3)
#0A..16genb(jfn0(f_jgr),.2).//.Conditionally.skip#0A
..16gen(f_neg)..9//.over.this.NEG.instruction#2E#0A
..16forget_a()#0A..16RETURN#0A#0A..2CASE.s_neg:..1l
oada(arg1)#0A..16gen(f_neg)#0A..16forget_a()#0A..16
RETURN#0A#0A..2CASE.s_not:..1loada(arg1)#0A..16gen(
f_not)#0A..16forget_a()#0A..16RETURN#0A#0A..2CASE.s
_eq:.CASE.s_ne:#0A..2CASE.s_ls:.CASE.s_gr:#0A..2CAS
E.s_le:.CASE.s_ge:#0A..16f.:#3D.prepj(jmpfn(pndop))
#0A..16chkrefs(4)#0A..16genb(f,.2)..2//.Jump.to..2-
-1#0A..16gen(f_fhop)..1//..13|#0A..16gen(f_lm1)..2/
/.this.point..<-#0A..16lose1(k_a,.0)#0A..16forget_a
()#0A..16forget_b()#0A..16RETURN#0A#0A..2CASE.s_sub
:..1UNLESS.k_numb#3Dh1!arg1.DO#0A..16{.f,.sym.:#3D.
f_sub,.FALSE#0A..18ENDCASE#0A..16}#0A..16h2!arg1.:#3D
.-h2!arg1#0A#0A..2CASE.s_add:..cgadd();.RETURN#0A#0A
..2CASE.s_mul:..1f..4:#3D.f_mul;..6ENDCASE#0A..2CAS
E.s_div:..1f,.sym.:#3D.f_div,.FALSE;.ENDCASE#0A..2C
ASE.s_rem:..1f,.sym.:#3D.f_rem,.FALSE;.ENDCASE#0A..
2CASE.s_lshift:f,.sym.:#3D.f_lsh,.FALSE;.ENDCASE#0A
..2CASE.s_rshift:f,.sym.:#3D.f_rsh,.FALSE;.ENDCASE#0A
..2CASE.s_logand:f..4:#3D.f_and;..6ENDCASE#0A..2CAS
E.s_logor:.f..4:#3D.f_or;..7ENDCASE#0A..2CASE.s_eqv
:#0A..2CASE.s_neqv:..f..4:#3D.f_xor;..6ENDCASE#0A..
}#0A#0A..TEST.sym.THEN.loadboth(arg2,.arg1)#0A..9EL
SE.loadba(arg2,.arg1)#0A#0A..gen(f)#0A..forget_a()#0A
..IF.pndop#3Ds_eqv.THEN.gen(f_not)#0A#0A..lose1(k_a
,.0)#0A}#0A#0ALET.loada(x)..1BE.{.loadval(x,.FALSE)
;.setba(0,.x).}#0A#0AAND.push(x,.y).BE.{.loadval(y,
.TRUE);..setba(x,.y).}#0A#0AAND.loadval(x,.pushing)
.BE..//.ONLY.called.from.loada.and.push#2E#0A//.Loa
d.compiles.code.to.have.the.following.effect:#0A//.
If.pushing#3DTRUE..2B.:#3D.A;.A.:#3D.<x>#2E#0A//.If
.pushing#3DFALSE..1B.:#3D.?;.A.:#3D.<x>#2E#0A{.LET.
k,.n.#3D.h1!x,.h2!x#0A#0A..UNLESS.pushing.|.k#3Dk_a
.DO..//.Dump.A.register.if.necessary#2E#0A..2FOR.t.
#3D.arg1.TO.tempv.BY.-3.IF.h1!t#3Dk_a.DO.{.storet(t
);.BREAK.}#0A#0A..TEST.inreg_a(k,.n).THEN.setba(0,.
x)#0A..19ELSE.IF.inreg_b(k,.n).DO.{.genxch(0,.0)#0A
..46RETURN#0A..44}#0A..SWITCHON.h1!x.INTO#0A..{.DEF
AULT:..cgerror("in.loada.%n",.k)#0A#0A..2CASE.k_a:.
IF.pushing.UNLESS.inreg_b(k,.n).DO.genatb(0,.0)#0A.
.12RETURN#0A#0A..2CASE.k_numb:#0A..12cgloadk(n)#0A.
.12RETURN#0A#0A..2CASE.k_loc:..genlp(n);..6ENDCASE#0A
..2CASE.k_glob:.geng(f_lg,.n);..1ENDCASE#0A..2CASE.
k_lab:..genr(f_ll,.n);..1ENDCASE#0A..2CASE.k_fnlab:
genr(f_lf,.n);..1ENDCASE#0A#0A..2CASE.k_lvloc:TEST.
0<#3Dn<#3D255#0A..15THEN.genb(f_llp,.n)#0A..15ELSE.
TEST.0<#3Dn<#3D#23xFF2#0A..20THEN.genh(f_llph,.n)#0A
..20ELSE.genw(f_llpw,.n)#0A..15ENDCASE#0A#0A..2CASE
.k_lvglob:geng(f_llg,.n);.ENDCASE#0A..2CASE.k_lvlab
:.genr(f_ll1,.n);.ENDCASE#0A..2CASE.k_loc0:..gen(f_
l0p0+n);..ENDCASE#0A..2CASE.k_loc1:..gen(f_l1p0+n);
..ENDCASE#0A..2CASE.k_loc2:..gen(f_l2p0+n);..ENDCAS
E#0A..2CASE.k_loc3:..gen(f_l3p0+n);..ENDCASE#0A..2C
ASE.k_loc4:..gen(f_l4p0+n);..ENDCASE#0A..2CASE.k_gl
ob0:.geng(f_l0g,.n);.ENDCASE#0A..2CASE.k_glob1:.gen
g(f_l1g,.n);.ENDCASE#0A..2CASE.k_glob2:.geng(f_l2g,
.n);.ENDCASE#0A..}#0A#0A..//.A.loading.instruction.
has.just.been.compiled#2E#0A..pushinfo(h1!x,.h2!x)#0A
}#0A#0AAND.loadba(x,.y).BE.IF.loadboth(x,.y)#3Dswap
ped.DO.genxch(x,.y)#0A#0AAND.setba(x,.y).BE#0A{.UNL
ESS.x#3D0.DO.h1!x.:#3D.k_b#0A..UNLESS.y#3D0.DO.h1!y
.:#3D.k_a#0A}#0A#0AAND.genxch(x,.y).BE.{.gen(f_xch)
;.xchinfo();.setba(x,.y).}#0A#0AAND.genatb(x,.y).BE
.{.gen(f_atb);.atbinfo();.setba(x,.y).}#0A#0AAND.lo
adboth(x,.y).#3D.VALOF#0A//.Compiles.code.to.cause#0A
//..1either..2x.->.[B]..and..y.->.[A]#0A//..11givin
g.result.NOTSWAPPED#0A//..1or..6x.->.[A]..and..y.->
.[B]#0A//..11giving.result.SWAPPED#2E#0A//.loadboth
.only.swaps.if.this.saves.code#2E#0A{.//.First.ensu
re.that.no.other.stack.item.uses.reg.A#2E#0A..FOR.t
.#3D.tempv.TO.arg1.BY.3.DO#0A..2IF.h1!t#3Dk_a.UNLES
S.t#3Dx.|.t#3Dy.DO.storet(t)#0A#0A..{.LET.xa,.ya.#3D
.inreg_a(h1!x,.h2!x),.inreg_a(h1!y,.h2!y)#0A..2AND.
xb,.yb.#3D.inreg_b(h1!x,.h2!x),.inreg_b(h1!y,.h2!y)
#0A#0A..2IF.xb.&.ya.DO.{.setba(x,y);..13RESULTIS.no
tswapped.}#0A..2IF.xa.&.yb.DO.{.setba(y,x);..13RESU
LTIS.swapped..2}#0A..2IF.xa.&.ya.DO.{.genatb(x,y);.
.12RESULTIS.notswapped.}#0A..2IF.xb.&.yb.DO.{.genxc
h(0,y);.genatb(x,y);.RESULTIS.notswapped.}#0A..4#0A
..2IF.xa.DO.{..12push(x,y);.RESULTIS.notswapped.}#0A
..2IF.ya.DO.{..12push(y,x);.RESULTIS.swapped..2}#0A
..2IF.xb.DO.{.genxch(0,x);.push(x,y);.RESULTIS.nots
wapped.}#0A..2IF.yb.DO.{.genxch(0,y);.push(y,x);.RE
SULTIS.swapped..2}#0A..4#0A..2loada(x)#0A..2push(x,
.y)#0A..2RESULTIS.notswapped#0A..}#0A}#0A#0ALET.inr
eg_a(k,.n).#3D.VALOF#0A{.LET.p.#3D.info_a#0A..IF.k#3D
k_a.RESULTIS.TRUE#0A..UNTIL.p#3D0.DO.{.IF.k#3Dh2!p.
&.n#3Dh3!p.RESULTIS.TRUE#0A..15p.:#3D.!p#0A..13}#0A
..RESULTIS.FALSE#0A}#0A#0AAND.inreg_b(k,.n).#3D.VAL
OF#0A{.LET.p.#3D.info_b#0A..IF.k#3Dk_b.RESULTIS.TRU
E#0A..UNTIL.p#3D0.DO.{.IF.k#3Dh2!p.&.n#3Dh3!p.RESUL
TIS.TRUE#0A..15p.:#3D.!p#0A..13}#0A..RESULTIS.FALSE
#0A}#0A#0AAND.addinfo_a(k,.n).BE.info_a.:#3D.getblk
(info_a,.k,.n)#0A#0AAND.addinfo_b(k,.n).BE.info_b.:
#3D.getblk(info_b,.k,.n)#0A#0AAND.pushinfo(k,.n).BE
#0A{.forget_b()#0A..info_b.:#3D.info_a#0A..info_a.:
#3D.getblk(0,.k,.n)#0A}#0A#0AAND.xchinfo().BE#0A{.L
ET.t.#3D.info_a#0A..info_a.:#3D.info_b#0A..info_b.:
#3D.t#0A}#0A#0AAND.atbinfo().BE#0A{.LET.p.#3D.info_
a#0A..forget_b()#0A..UNTIL.p#3D0.DO.{.addinfo_b(h2!
p,.h3!p);.p.:#3D.!p.}#0A}#0A#0AAND.forget_a().BE.{.
freeblks(info_a);.info_a.:#3D.0.}#0A#0AAND.forget_b
().BE.{.freeblks(info_b);.info_b.:#3D.0.}#0A#0AAND.
forgetall().BE.{.forget_a();.forget_b().}#0A#0A//.F
orgetvar.is.called.just.after.a.simple.variable.(k,
.n).has.been#0A//.updated#2E..k.is.k_loc,.k_glob.or
.k_lab#2E..Note.that.register#0A//.infomation.about
.indirect.local.and.global.values#0A//.must.also.be
.thrown.away#2E#0AAND.forgetvar(k,.n).BE#0A{.LET.p.
#3D.info_a#0A..UNTIL.p#3D0.DO.{.IF.h2!p>#3Dk_loc0.|
.h2!p#3Dk.&.h3!p#3Dn.DO.h2!p.:#3D.k_none#0A..15p.:#3D
.!p#0A..13}#0A..p.:#3D.info_b#0A..UNTIL.p#3D0.DO.{.
IF.h2!p>#3Dk_loc0.|.h2!p#3Dk.&.h3!p#3Dn.DO.h2!p.:#3D
.k_none#0A..15p.:#3D.!p#0A..13}#0A}#0A#0AAND.forget
allvars().BE..//.Called.after.STIND.or.PUTBYTE#2E#0A
{.LET.p.#3D.info_a#0A..UNTIL.p#3D0.DO.{.IF.h2!p>#3D
k_loc.DO.h2!p.:#3D.k_none#0A..15p.:#3D.!p#0A..13}#0A
..p.:#3D.info_b#0A..UNTIL.p#3D0.DO.{.IF.h2!p>#3Dk_l
oc.DO.h2!p.:#3D.k_none#0A..15p.:#3D.!p#0A..13}#0A}#0A
#0AAND.iszero(a).#3D.h1!a#3Dk_numb.&.h2!a#3D0.->.TR
UE,.FALSE#0A#0A//.Store.the.value.of.a.SS.item.in.i
ts.true.stack.location#2E#0AAND.storet(x).BE#0A{.LE
T.s.#3D.h3!x#0A..IF.h1!x#3Dk_loc.&.h2!x#3Ds.RETURN#0A
..loada(x)#0A..gensp(s)#0A..forgetvar(k_loc,.s)#0A.
.addinfo_a(k_loc,.s)#0A..h1!x,.h2!x.:#3D.k_loc,.s#0A
}#0A#0AAND.gensp(s).BE.TEST.3<#3Ds<#3D16#0A..14THEN
.gen(f_sp0+s)#0A..14ELSE.TEST.0<#3Ds<#3D255#0A..19T
HEN.genb(f_sp,.s)#0A..19ELSE.TEST.0<#3Ds<#3D#23xFF2
#0A..24THEN.genh(f_sph,.s)#0A..24ELSE.genw(f_spw,.s
)#0A#0AAND.genlp(n).BE.TEST.3<#3Dn<#3D16#0A..14THEN
.gen(f_lp0+n)#0A..14ELSE.TEST.0<#3Dn<#3D255#0A..19T
HEN.genb(f_lp,.n)#0A..19ELSE.TEST.0<#3Dn<#3D#23xFF2
#0A..24THEN.genh(f_lph,.n)#0A..24ELSE.genw(f_lpw,.n
)#0A#0A//.Load.an.item.(K,N).onto.the.SS#2E.It.may.
move.SS.items#2E#0AAND.loadt(k,.n).BE#0A{.cgpending
op()#0A..TEST.arg1+3#3Dtempt#0A..THEN.{.storet(temp
v)..//.SS.stack.overflow#2E#0A..7FOR.t.#3D.tempv.TO
.arg2+2.DO.t!0.:#3D.t!3#0A..5}#0A..ELSE.arg2,.arg1.
:#3D.arg2+3,.arg1+3#0A..h1!arg1,h2!arg1,h3!arg1.:#3D
.k,n,ssp#0A..ssp.:#3D.ssp.+.1#0A..IF.maxssp<ssp.DO.
maxssp.:#3D.ssp#0A}#0A#0A1//.Replace.the.top.two.SS
.items.by.(K,N).and.set.PENDINGOP#3DS_NONE#2E#0AAND
.lose1(k,.n).BE#0A{.ssp.:#3D.ssp.-.1#0A..TEST.arg2#3D
tempv#0A..THEN.{.h1!arg2,h2!arg2.:#3D.k_loc,ssp-2#0A
..7h3!arg2.:#3D.ssp-2#0A..5}#0A..ELSE.{.arg1.:#3D.a
rg2#0A..7arg2.:#3D.arg2-3#0A..5}#0A..h1!arg1,.h2!ar
g1,.h3!arg1.:#3D.k,n,ssp-1#0A..pendingop.:#3D.s_non
e#0A}#0A#0AAND.swapargs().BE#0A{.LET.k,.n.#3D.h1!ar
g1,.h2!arg1#0A..h1!arg1,.h2!arg1.:#3D.h1!arg2,.h2!a
rg2#0A..h1!arg2,.h2!arg2.:#3D.k,.n#0A}#0A#0AAND.cgs
tind().BE#0A{.LET.t.#3D.VALOF#0A..{.IF.pendingop#3D
s_add.DO#0A..2{.IF.k_numb#3Dh1!arg2.DO.swapargs()#0A
..4IF.k_numb#3Dh1!arg1.DO#0A..4{.LET.n.#3D.h2!arg1#0A
..6IF.0<#3Dn<#3D3.DO.{.stack(ssp-1)#0A..22pendingop
.:#3D.s_none#0A..22RESULTIS.n#0A..20}#0A..4}#0A#0A.
.4IF.h1!arg2#3Dk_loc.&.3<#3Dh2!arg2<#3D5.DO.swaparg
s()#0A..4IF.h1!arg1#3Dk_loc.&.3<#3Dh2!arg1<#3D5.DO#0A
..4{.LET.n.#3D.h2!arg1#0A..6stack(ssp-1)#0A..6pendi
ngop.:#3D.s_none#0A..6RESULTIS.n+1..//.The.codes.fo
r.P3,.P4.and.P5#2E#0A..4}#0A#0A..4UNLESS.arg2#3Dtem
pv.DO#0A..4{.LET.arg3.#3D.arg2.-.3#0A..6IF.h1!arg3#3D
k_a.DO#0A..6{.IF.h1!arg2#3Dk_loc.|#0A..11h1!arg2#3D
k_glob.|#0A..11h1!arg2#3Dk_numb.DO.swapargs()#0A..8
IF.h1!arg1#3Dk_loc.|#0A..11h1!arg1#3Dk_glob.|#0A..1
1h1!arg1#3Dk_numb.DO#0A..8//.Optimize.the.case..<ar
g2>!<arg1>.:#3D.<arg3>#0A..8//.where.<arg3>.is.alre
ady.in.A#0A..8//.and.<arg1>.is.a.local,.a.global.or
.a.number#2E#0A..8{.push(arg3,.arg2)#0A..10cgadd().
.//.Compiles.an.A,.AP.or.AG.instr#2E#0A..10gen(f_st
)#0A..10stack(ssp-2)#0A..10forgetallvars()#0A..10RE
TURN#0A..8}#0A..6}#0A..4}#0A..2}#0A#0A..2cgpendingo
p()#0A..2RESULTIS.0#0A..}#0A#0A..//.Now.compile.cod
e.for.S!<arg1>.:#3D.<arg2>#0A..//.where..9S.is.0,.1
,.2,.3,.P3,.P4.or.P5#0A..//.depending.on..2T.#3D..0
000,.1,.2,.3,..0004,..0005.or..0006#0A#0A..{.LET.k,
.n.#3D.h1!arg1,.h2!arg1#0A..1#0A..2IF.k#3Dk_glob.&.
t#3D0.DO.{.loada(arg2)#0A..25geng(f_s0g,.n)#0A..25s
tack(ssp-2)#0A..25forgetallvars()#0A..25RETURN#0A..
23}#0A#0A..2IF.k#3Dk_loc.&.3<#3Dn<#3D4.&.t<#3D1.DO.
{.loada(arg2)#0A..35gen(t#3D0.->.f_st0p0+n,#0A..46f
_st1p0+n)#0A..35stack(ssp-2)#0A..35forgetallvars()#0A
..35RETURN#0A..33}#0A#0A..2loadba(arg2,.arg1)#0A..2
gen(f_st+t)#0A..2stack(ssp-2)#0A..2forgetallvars()#0A
..}#0A}#0A#0A//.Store.the.top.item.of.the.SS.in.(K,
N)#2E#0AAND.storein(k,.n).BE#0A//.K.is.K_LOC,.K_GLO
B.or.K_LAB#2E#0A{.cgpendingop()#0A..loada(arg1)#0A#0A
..SWITCHON.k.INTO#0A..{.DEFAULT:..3cgerror("in.stor
ein.%n",.k)#0A..2CASE.k_loc:..gensp(n);..5ENDCASE#0A
..2CASE.k_glob:.geng(f_sg,.n);..ENDCASE#0A..2CASE.k
_lab:..genr(f_sl,.n);..ENDCASE#0A..}#0A..forgetvar(
k,.n)#0A..addinfo_a(k,.n)#0A..stack(ssp-1)#0A}#0A#0A
LET.cgrv().BE#0A{.LET.t.#3D.VALOF#0A..{.IF.pendingo
p#3Ds_add.DO#0A..2{.IF.k_numb#3Dh1!arg2.DO.swapargs
()#0A..4IF.k_numb#3Dh1!arg1.DO#0A..4{.LET.n.#3D.h2!
arg1#0A..6IF.0<#3Dn<#3D6.DO.{.stack(ssp-1)#0A..22pe
ndingop.:#3D.s_none#0A..22RESULTIS.n#0A..20}#0A..4}
#0A#0A..4IF.h1!arg2#3Dk_loc.&.3<#3Dh2!arg2<#3D7.DO.
swapargs()#0A..4IF.h1!arg1#3Dk_loc.&.3<#3Dh2!arg1<#3D
7.DO.{.LET.n.#3D.h2!arg1#0A..42stack(ssp-1)#0A..42p
endingop.:#3D.s_none#0A..42RESULTIS.10.+.n#0A..40}#0A
..2}#0A..2cgpendingop()#0A..2RESULTIS.0#0A..}#0A#0A
..//.Now.compile.code.for.S!<arg1>#0A..//.where..8S
.is.0,#2E#2E1,.6,.P3,#2E#2E1,.P7#0A..//.depending.o
n..1T.#3D..0000,#2E#2E1,.6,.13,#2E#2E1,.17#0A#0A..L
ET.k,.n.#3D.h1!arg1,.h2!arg1#0A..1#0A..IF.k#3Dk_glo
b.&.0<#3Dt<#3D2.DO.{.h1!arg1.:#3D.k_glob0.+.t;.RETU
RN.}#0A#0A..IF.k#3Dk_loc.&.n>#3D3.DO#0A..2IF.t#3D0.
&.n<#3D12.|#0A..5t#3D1.&.n<#3D6..|#0A..5t#3D2.&.n<#3D
5..|#0A..5t#3D3.&.n<#3D4..|#0A..5t#3D4.&.n<#3D4..DO
.{.h1!arg1.:#3D.k_loc0.+.t;.RETURN.}#0A#0A..loada(a
rg1)#0A..TEST.t<#3D6.THEN.gen(f_rv+t)#0A..10ELSE.ge
n(f_rvp0.+.t.-.10)#0A..forget_a()#0A..h1!arg1,.h2!a
rg1.:#3D.k_a,.0#0A}#0A#0AAND.cgadd().BE#0A//.Compil
es.code.to.compute.<arg2>.+.<arg1>#2E#0A//.It.does.
not.look.at.PENDINGOP#2E#0A#0A{.IF.iszero(arg1).DO.
{.stack(ssp-1);.RETURN.}#0A#0A..IF.iszero(arg2).DO#0A
..{.IF.h2!arg1#3Dssp-1.&#0A..5(h1!arg1#3Dk_loc.|.k_
loc0<#3Dh1!arg1<#3Dk_loc4).DO.loada(arg1)#0A..2lose
1(h1!arg1,.h2!arg1)#0A..2RETURN#0A..}#0A#0A..TEST.i
nreg_a(h1!arg1,.h2!arg1)#0A..THEN.loada(arg1)#0A..E
LSE.IF.inreg_a(h1!arg2,.h2!arg2).DO.loada(arg2)#0A#0A
..IF.h1!arg1#3Dk_a.DO.swapargs()#0A#0A..IF.h1!arg2#3D
k_loc.&.3<#3Dh2!arg2<#3D12.DO.swapargs()#0A..IF.h1!
arg1#3Dk_loc.&.3<#3Dh2!arg1<#3D12.DO.{.loada(arg2)#0A
..39gen(f_ap0.+.h2!arg1)#0A..39forget_a()#0A..39los
e1(k_a,.0)#0A..39RETURN#0A..37}#0A#0A..IF.h1!arg2#3D
k_numb.&.-4<#3Dh2!arg2<#3D5.DO.swapargs()#0A..IF.h1
!arg1#3Dk_numb.&.-4<#3Dh2!arg1<#3D5.DO.{.loada(arg2
)#0A..40cgaddk(h2!arg1)#0A..40lose1(k_a,.0)#0A..40R
ETURN#0A..38}#0A#0A..IF.h1!arg2#3Dk_loc.DO.swapargs
()#0A..IF.h1!arg1#3Dk_loc.DO#0A..{.LET.n.#3D.h2!arg
1#0A..2loada(arg2)#0A..2TEST.3<#3Dn<#3D12.THEN.gen(
f_ap0.+.n)#0A..16ELSE.TEST.0<#3Dn<#3D255#0A..21THEN
.genb(f_ap,.n)#0A..21ELSE.TEST.0<#3Dn<#3D#23xFF2#0A
..26THEN.genh(f_aph,.n)#0A..26ELSE.genw(f_apw,.n)#0A
..2forget_a()#0A..2lose1(k_a,.0)#0A..2RETURN#0A..}#0A
#0A..IF.h1!arg2#3Dk_glob.DO.swapargs()#0A..IF.h1!ar
g1#3Dk_glob.DO.{.loada(arg2)#0A..23geng(f_ag,.h2!ar
g1)#0A..23forget_a()#0A..23lose1(k_a,.0)#0A..23RETU
RN#0A..21}#0A#0A..IF.h1!arg2#3Dk_numb.DO.swapargs()
#0A..IF.h1!arg1#3Dk_numb.DO.{.LET.n.#3D.h2!arg1#0A.
.23loada(arg2)#0A..23cgaddk(n)#0A..23lose1(k_a,.0)#0A
..23RETURN#0A..21}#0A..loadboth(arg2,.arg1)#0A..gen
(f_add)#0A..forget_a()#0A..lose1(k_a,.0)#0A}#0A#0AA
ND.cgloadk(n).BE#0A{.TEST.-1<#3Dn<#3D10#0A..THEN.ge
n(f_l0+n)#0A..ELSE.TEST.0<#3Dn<#3D255#0A..5THEN.gen
b(f_l,.n)#0A..5ELSE.TEST.-255<#3Dn<#3D0#0A..10THEN.
genb(f_lm,.-n)#0A..10ELSE.TEST.0<#3Dn<#3D#23xFF2#0A
..15THEN.genh(f_lh,.n)#0A..15ELSE.TEST.-#23xFF2<#3D
n<#3D0#0A..20THEN.genh(f_lmh,.-n)#0A..20ELSE.genw(f
_lw,.n)#0A..pushinfo(k_numb,.n)#0A}#0A#0AAND.cgaddk
(k).BE.UNLESS.k#3D0.DO..//.Compile.code.to.add.k.to
.A#2E#0A{.TEST.-4<#3Dk<#3D5#0A..THEN.TEST.k<0.THEN.
gen(f_s0.-.k)#0A..14ELSE.gen(f_a0.+.k)#0A..ELSE.TES
T.-255<#3Dk<#3D255#0A..5THEN.TEST.k>0.THEN.genb(f_a
,.k)#0A..19ELSE.genb(f_s,.-k)#0A..5ELSE.TEST.0<#3Dk
<#3D#23xFF2#0A..10THEN.genh(f_ah,.k)#0A..10ELSE.TES
T.-#23xFF2<#3Dk<#3D0#0A..15THEN.genh(f_sh,.-k)#0A..
15ELSE.genw(f_aw,.k)#0A..forget_a()#0A}#0A#0AAND.cg
global(n).BE#0A{.incode.:#3D.FALSE#0A..cgstatics()#0A
..chkrefs(512)..1//.Deal.with.ALL.outstanding.refs#2E
#0A..align(wordbytelen)#0A..codew(0,.0)..5//.Compil
e.Global.initialisation.data#2E#0A..FOR.i.#3D.1.TO.
n.DO#0A..{.codew(0,.rdgn())#0A..2codew(0,.labv!rdl(
))#0A..}#0A..codew(0,.maxgn)#0A}#0A#0A1AND.cgentry(
l,.n).BE#0A{.MANIFEST.{.upb#3D11.}.//.Max.length.of
.entry.name#0A..LET.v.#3D.VEC.upb/bytesperword#0A..
v%0.:#3D.upb#0A..rdname(n,.v).//.Pack.up.to.11.char
acter.of.the.name.into.v#0A#0A..chkrefs(80)..//.Dea
l.with.some.forward.refs#2E#0A..align(wordbytelen)#0A
..IF.naming.DO#0A..{.TEST.c64#0A..2THEN.codew(..ent
ryword>>00032,..entryword)#0A..2ELSE.codew(-(entryw
ord>>00031),.entryword).//.Sign.extend#0A..2codestr
(v)..1//.Compile.the.words.containing.the.packed#0A
..15//.string.characters#0A..}#0A#0A..IF.debug>0.DO
.writef("//.Entry.to:..1%s*n",.v)#0A..setlab(l)#0A.
.incode.:#3D.TRUE#0A..forgetall()#0A}#0A#0A//.Funct
ion.or.routine.call#2E#0AAND.cgapply(op,.k).BE#0A{.
LET.sa.#3D.k+3..//.Stack.address.of.first.arg.(if.a
ny)#2E#0A..AND.a1.#3D.0..2//.SS.item.for.first.arg.
if.found#2E#0A#0A..cgpendingop()#0A#0A//.Deal.with.
non.args#2E#0A..FOR.t.#3D.tempv.TO.arg2.BY.3.DO.{.I
F.h3!t>#3Dk.BREAK#0A..32IF.h1!t#3Dk_a.DO.storet(t)#0A
..30}#0A#0A//.Deal.with.args.2,.3.#2E#2E1#0A..FOR.t
.#3D.tempv.TO.arg2.BY.3.DO#0A..{.LET.s.#3D.h3!t#0A.
.2IF.s#3Dsa.DO#0A..2{.a1.:#3D.t..//.We.have.found.t
he.SS.item.for.the.first.arg#2E#0A..4IF.h1!t#3Dk_a.
&.t+3#3Darg2.DO#0A..4//.Two.argument.call.with.the.
first.arg.already.in.A#2E#0A..4{.push(t,.arg2)#0A..
6storet(arg2)..2//.Store.second.arg#2E#0A..6genxch(
0,.t)..2//.Restore.first.arg.back.to.A#2E#0A..6BREA
K#0A..4}#0A..2}#0A..2IF.s>sa.DO.storet(t)#0A..}#0A#0A
..//.Move.first.arg.(if.any).into.A#2E#0A..IF.sa<ss
p-1.TEST.a1#3D0#0A..12THEN.genlp(sa)..//.First.arg.
exists.but.not.in.SS#2E#0A..12ELSE.loada(a1)..//.Fi
rst.arg.exists.in.SS#0A#0A..//.First.arg.(if.any).i
s.now.in.A#2E#0A#0A..TEST.h1!arg1#3Dk_glob.&.3<#3Dk
<#3D11#0A..THEN.geng(f_k0g+k,.h2!arg1)#0A..ELSE.{.p
ush(a1,.arg1)#0A..7//.First.arg.(if.any).is.now.in.
B#0A..7//.and.the.procedure.address.is.in.A#2E#0A..
7TEST.3<#3Dk<#3D11#0A..7THEN.gen(f_k0+k)#0A..7ELSE.
TEST.0<#3Dk<#3D255#0A..12THEN.genb(f_k,.k)#0A..12EL
SE.TEST.0<#3Dk<#3D#23xFF2#0A..17THEN.genh(f_kh,.k)#0A
..17ELSE.genw(f_kw,.k)#0A..4}#0A#0A..forgetall()#0A
..stack(k)#0A..IF.op#3Ds_fnap.DO.loadt(k_a,.0)#0A}#0A
#0A//.Used.for.OCODE.operators.JT.and.JF#2E#0AAND.c
gjump(b,l).BE#0A{.LET.f.#3D.jmpfn(pendingop)#0A..IF
.f#3D0.DO.{.loadt(k_numb,0);.f.:#3D.f_jne.}#0A..pen
dingop.:#3D.s_none#0A..UNLESS.b.DO.f.:#3D.compjfn(f
)#0A..store(0,ssp-3)#0A..genr(prepj(f),l)#0A..stack
(ssp-2)#0A}#0A#0AAND.jmpfn(op).#3D.VALOF.SWITCHON.o
p.INTO#0A{.DEFAULT:..RESULTIS.0#0A..CASE.s_eq:.RESU
LTIS.f_jeq#0A..CASE.s_ne:.RESULTIS.f_jne#0A..CASE.s
_ls:.RESULTIS.f_jls#0A..CASE.s_gr:.RESULTIS.f_jgr#0A
..CASE.s_le:.RESULTIS.f_jle#0A..CASE.s_ge:.RESULTIS
.f_jge#0A}#0A#0AAND.jfn0(f).#3D.f+2.//.Change.F_JEQ
.into.F_JEQ0..etc#2E#2E1#0A#0AAND.revjfn(f).#3D.f#3D
f_jls.->.f_jgr,#0A..14f#3Df_jgr.->.f_jls,#0A..14f#3D
f_jle.->.f_jge,#0A..14f#3Df_jge.->.f_jle,#0A..14f#0A
#0AAND.compjfn(f).#3D.f#3Df_jeq.->.f_jne,#0A..15f#3D
f_jne.->.f_jeq,#0A..15f#3Df_jls.->.f_jge,#0A..15f#3D
f_jge.->.f_jls,#0A..15f#3Df_jgr.->.f_jle,#0A..15f#3D
f_jle.->.f_jgr,#0A..15f#0A#0AAND.prepj(f).#3D.VALOF
..//.Returns.the.appropriate.m/c.fn#2E#0A{.IF.iszer
o(arg2).DO.{.swapargs();.f.:#3D.revjfn(f).}#0A..IF.
iszero(arg1).DO.{.loada(arg2);.RESULTIS.jfn0(f).}#0A
..IF.loadboth(arg2,.arg1)#3Dswapped.RESULTIS.revjfn
(f)#0A..RESULTIS.f#0A}#0A#0A//.Compiles.code.for.SW
ITCHON#2E#0ALET.cgswitch().BE#0A{.LET.n.#3D.rdn()..
3//.Number.of.cases#2E#0A..LET.dlab.#3D.rdl()..//.D
efault.label#2E#0A#0A..//.Read.and.sort.(K,L).pairs
#2E#0A..FOR.i.#3D.1.TO.n.DO#0A..{.LET.k.#3D.rdn()#0A
..2LET.l.#3D.rdl()#0A..2LET.j.#3D.i-1#0A..2UNTIL.j#3D
0.DO..{.IF.k.>.casek!j.BREAK#0A..18casek!(j+1),.cas
el!(j+1).:#3D.casek!j,.casel!j#0A..18j.:#3D.j.-.1#0A
..16}#0A..2casek!(j+1),.casel!(j+1).:#3D.k,.l#0A..}
#0A#0A..cgpendingop()#0A..store(0,.ssp-2)#0A..loada
(arg1)#0A..stack(ssp-1)#0A..switcht(1,.n,.dlab,.FAL
SE,.0)#0A}#0A#0AAND.prcases(p,.q).BE#0A{.writef("*n
prcases:.p#3D%n.q#3D%n*n",.p,.q)#0A..FOR.i.#3D.p.TO
.q.DO#0A..{.IF.(i-p).MOD.8.#3D.0.DO.newline()#0A..2
writef(".%11i",.casek!i)#0A..}#0A..newline()#0A}#0A
#0A//.Code.has.already.been.compiled.to.set.either.
A.or.B.to.the.#0A//.value.of.the.switch.expression#2E
#0A//.Compile.code.to.switch.on.cases.in.region.p#2E
#2Eq.with.default#0A//.label.dlab#2E#0AAND.switcht(
p,.q,.dlab,.inba,.aval).BE#0A{.//.If.inba#3DTRUE,..
the.switch.value.is.in.B.and.A#3Daval#2E#0A..//.If.
inba#3DFALSE,.the.switch.value.is.in.A#2E#0A..//.Co
mpile.code.for.cases.in.the.region.region.p.to.q#0A
..//.and.default.label.dlab#2E#0A..LET.n.#3D.q-p+1.
.2//.Number.of.cases.in.region.p#2E#2Eq#0A..LET.r.#3D
.(p+q)/2#0A..LET.s.#3D.r#0A#0A..//.If.no.cases.goto
.default.label#0A..IF.n#3D0.DO.{.genr(f_j,.dlab);.R
ETURN.}#0A#0A..IF.n#3D1.DO#0A..{.//.There.is.just.o
ne.case.so.use.an.equality.test#2E#0A..2//.Set.B.#3D
.switch.value.and.A.#3D.casek!p#0A..2TEST.inba#0A..
2THEN.{.cgaddk(casek!p-aval)#0A..9aval.:#3D.casek!p
#0A..7}.#0A..2ELSE.{.inba,.aval.:#3D.TRUE,.casek!p#0A
..9cgloadk(aval)#0A..7}#0A..2genr(f_jeq,.casel!p)#0A
..2genr(f_j,.dlab)#0A..2forgetall()#0A..2RETURN#0A.
.}#0A#0A..//.There.are.at.least.four.cases.in.regio
n.p.#2E#2E.q#0A#0A//writef("switcht:.p#3D%n.q#3D%n.
casek!p#3D%n,.casek!q#3D%n,.diff#3D%n*n",#0A//..15p
,..1q,..1casek!p,..2casek!q,..2casek!q-casek!p)#0A/
/prcases(p,.q)#0A//abort(1000002)#0A#0A..//.Find.th
e.middle.segment#0A..WHILE.p<r.&.0.<#3D.casek!s-cas
ek!(r-1).<#3D.#23xFF2.DO.r.:#3D.r-1#0A..WHILE.s<q.&
.0.<#3D.casek!(s+1)-casek!r.<#3D.#23xFF2.DO.s.:#3D.
s+1#0A#0A..//.r#2E#2Es.is.a.region.of.case.constant
s.including.the.mid.point#0A..//.of.region.p#2E#2Eq
,.and.for.which#0A..//.0.<#3D.casek!i.-.casek!r.<#3D
.#23xFF2.for.all.i.in.r#2E#2Es#0A#0A//writef("switc
ht:.r#3D%n.s#3D%n*n",r,s)#0A//abort(1001)#0A#0A..IF
.n<#3D3.IF.p<r.|.s<q..DO#0A..{.//.Use.a.sequence.of
.equality.tests#2E#0A..2FOR.i.#3D.p.TO.q.DO#0A..2{.
TEST.inba#0A..4THEN.{.cgaddk(casek!i-aval)#0A..11av
al.:#3D.casek!i#0A..9}.#0A..4ELSE.{.inba,.aval.:#3D
.TRUE,.casek!i#0A..11cgloadk(aval)#0A..9}#0A..4genr
(f_jeq,.casel!i)#0A..2}#0A..2genr(f_j,.dlab)#0A..2f
orgetall()#0A..2RETURN#0A..}#0A#0A..UNLESS.r#3Dp.DO
#0A..{.//.At.least.one.case.in.LH.region.p.#2E#2E.r
-1#0A..2//.Set.B.#3D.switch.value.and.A.#3D.casek!r
#0A..2LET.lab.#3D.newlab()#0A..2TEST.inba#0A..2THEN
.{.cgaddk(casek!r-aval)#0A..9aval.:#3D.casek!r#0A..
7}.#0A..2ELSE.{.inba,.aval.:#3D.TRUE,.casek!r#0A..9
cgloadk(aval)#0A..7}#0A..2genr(f_jge,.lab)#0A..2swi
tcht(p,.r-1,.dlab,.TRUE,.aval)#0A..2setlab(lab)#0A.
.2switcht(r,.q,..1dlab,.TRUE,.aval)#0A..2RETURN#0A.
.}#0A#0A..UNLESS.s#3Dq.DO#0A..{.//.At.least.one.cas
e.in.RH.region.s+1.#2E#2E.q#0A..2//.Set.B.#3D.switc
h.value.and.A.#3D.casek!s#0A..2LET.lab.#3D.newlab()
#0A..2TEST.inba#0A..2THEN.{.cgaddk(casek!s-aval)#0A
..9aval.:#3D.casek!s#0A..7}.#0A..2ELSE.{.inba,.aval
.:#3D.TRUE,.casek!s#0A..9cgloadk(aval)#0A..7}#0A..2
genr(f_jgr,.lab)#0A..2switcht(p,..1s,.dlab,.TRUE,.a
val)#0A..2setlab(lab)#0A..2switcht(s+1,.q,.dlab,.TR
UE,.aval)#0A..2RETURN#0A..}#0A#0A..IF.inba.DO.gen(f
_xch).//.Put.B.back.in.A,.if.necessary#2E#0A..switc
hseg(r,.s,.dlab)#0A..forgetall()#0A}#0A#0AAND.offse
tcases(p,.q,.offset).BE.IF.offset.DO#0A{.//.Subtrac
t.offset.from.all.case.constants.in.the.region.p.to
.q#0A#0A//writef("offsetcases.p#3D%n.q#3D%n.offset#3D
%n*n",.p,.q,.offset)#0A//prcases(p,.q)#0A..1#0A..FO
R.i.#3D.p.TO.q..DO.casek!i.:#3D.casek!i.-.offset#0A
}#0A#0AAND.switchseg(p,.q,.dlab).BE#0A{.//.Only.cal
led#0A..//.when..0000.<#3D.casek!i.-.casek!p.<#3D.#23
xFF2.for.all.i.in.p#2E#2Eq#0A..//.and..1p.<#3D.q#0A
..LET.n.#3D.q-p+1..//.The.number.of.cases.(>#3D1)#2E
#0A#0A//writef("switchseg:.n#3D%n.casek!p#3D%n.case
k!q#3D%n*n",.n,.casek!p,.casek!q)#0A//prcases(p,.q)
#0A//abort(1000001)#0A#0A..TEST.2*n.<.casek!q.-.cas
ek!p..//.Which.is.generates.less.code?#0A..THEN.swi
tchb(p,.q,.dlab)..4//.Binary.chop.switch#2E#0A..ELS
E.switchl(p,.q,.dlab)..4//.Label.vector.switch#2E#0A
}#0A#0AAND.switchb(p,.q,.dlab).BE..//.Binary.chop.s
witch#2E#0A{.//.Only.called.when..0000.<#3D.casek!q
.-.casek!p.<#3D.#23xFF2#0A..//..12and..p.<.q#0A..LE
T.n.#3D.q-p+1..1//.Number.of.cases.(>1)#2E#0A..LET.
n1.#3D.n>7.->n,.7#0A..1#0A//writef("switchb:.n#3D%n
.casek!p#3D%n.casek!p#3D%n*n",.n,.casek!p,.casek!q)
#0A//prcases(p,.q)#0A//abort(1001)#0A..//.Ensure.th
at.all.case.constants.can.be.represented.by#0A..//.
unsigned.16.bit.integers#2E#0A..IF.casek!p<0.|.case
k!q>#23xFF2.DO#0A..{.cgaddk(-casek!p)#0A..2offsetca
ses(p,.q,.casek!p)#0A..}#0A..1#0A..chkrefs(6+4*n1).
//.allow.for.padding.to.7.cases#0A..gen(f_swb)#0A..
align(2)#0A..codeh(n)#0A..coder(dlab)#0A..FOR.i.#3D
.p.TO.q.DO.{.LET.pos.#3D.q.+.1.-.findpos(i-p+1,.q-p
+1)#0A..20codeh(casek!pos)#0A..20coder(casel!pos)#0A
..18}#0A..FOR.i.#3D.q+1.TO.p+6.DO.{.codeh(0).//.pad
.out.to.7.cases#0A..24coder(dlab)#0A..22}#0A}#0A#0A
//.If.the.integers.1#2E#2En.were.stored.in.a.balanc
ed.binary#0A//.tree.using.the.tree.structure.of.hea
p.sort,.then#0A//.integer.i.would.be.at.position.fi
ndpos(i,.n)#2E#0AAND.findpos(i,.n).#3D.VALOF#0A{.LE
T.r.#3D.?#0A..IF.i.#3D.1.DO.{.swlpos,.swrpos.:#3D.0
,.n#0A..14RESULTIS.rootpos(0,.n)#0A..12}#0A..r.:#3D
.findpos(i/2,.n)#0A..TEST.(i&1).#3D.0.THEN.swrpos.:
#3D.r-1#0A..15ELSE.swlpos.:#3D.r#0A..RESULTIS.rootp
os(swlpos,.swrpos)#0A}#0A#0AAND.rootpos(p,.q).#3D.V
ALOF#0A{.LET.n.#3D.q-p#0A..LET.s,.r.#3D.2,.?#0A..UN
TIL.s>n.DO.s.:#3D.s+s#0A..s.:#3D.s/2#0A..r.:#3D.n-s
+1#0A..IF.s.<#3D.r+r.RESULTIS.p.+.s#0A..RESULTIS.p.
+.s/2.+.r#0A}#0A#0AAND.switchl(p,.q,.dlab).BE..//.L
abel.vector.switch#2E#0A{.//.Only.called.when..0000
.<#3D.casek!q.-.casek!p.<#3D.#23xFF2#0A..//..12and.
.p.<.q#0A#0A..LET.n,.t.#3D.?,.p#0A#0A..//.Adjust.ca
se.constants.to.suit.SWL.instruction#2E#0A..IF.case
k!p<0.|.casek!p>1.|.casek!q>#23xFF2.DO#0A..{.cgaddk
(-casek!p)#0A..2offsetcases(p,.q,.casek!p)#0A..}#0A
..1#0A..n.:#3D.casek!q.+.1..1//.Number.of.entries.i
n.the.label.vector#2E#0A..chkrefs(2*n+6)#0A..gen(f_
swl)#0A..align(2)#0A..codeh(n)#0A..coder(dlab)..6//
.Default.label#2E#0A#0A..FOR.k.#3D.0.TO.casek!q.TES
T.casek!t#3Dk#0A..21THEN.{.coder(casel!t)#0A..28t.:
#3D.t+1#0A..26}#0A..21ELSE.coder(dlab)#0A}#0A#0AAND
.cgstring(n).BE#0A{.LET.lab,.a.#3D.newlab(),.n#0A..
loadt(k_lvlab,.lab)#0A#0A..{.//.Start.of.packing.lo
op#0A..2LET.t..#3D.getblk(0,.lab,.0).//.The.first.i
tem.hold.the.label#0A..2LET.b,.c,.d,.e,.f,.g,.h.#3D
.0,.0,.0,.0,.0,.0,.0#0A..2!nliste.:#3D.t#0A..2nlist
e.:#3D.!nliste#0A..2lab.:#3D.0..16//.Clear.the.labe
l.for.further.items#0A#0A..2IF.n>#3D1.DO.b.:#3D.rdn
()#0A..2IF.n>#3D2.DO.c.:#3D.rdn()#0A..2IF.n>#3D3.DO
.d.:#3D.rdn()#0A..2n.:#3D.n-4..4//.1.to.4.bytes.hav
e.been.packed#0A..2TEST.t64#0A..2THEN.{.IF.n>#3D0.D
O.e.:#3D.rdn()#0A..9IF.n>#3D1.DO.f.:#3D.rdn()#0A..9
IF.n>#3D2.DO.g.:#3D.rdn()#0A..9IF.n>#3D3.DO.h.:#3D.
rdn()#0A..9n.:#3D.n-4..2//.1.to.8.bytes.have.been.p
acked#0A..9TEST.bigender#0A..9THEN.TEST.c64#0A..14T
HEN.h3!t.:#3D.pack4b(a,b,c,d)<<00032.|.pack4b(e,f,g
,h)#0A..14ELSE.h4!t,.h3!t.:#3D.pack4b(a,b,c,d),.pac
k4b(e,f,g,h)#0A..9ELSE.TEST.c64#0A..14THEN.h3!t.:#3D
.pack4b(h,g,f,e)<<00032.|.pack4b(d,c,b,a)#0A..14ELS
E.h4!t,.h3!t.:#3D.pack4b(h,g,f,e),.pack4b(d,c,b,a)#0A
..7}#0A..2ELSE.TEST.bigender#0A..7THEN.h3!t.:#3D.pa
ck4b(a,b,c,d)#0A..7ELSE.h3!t.:#3D.pack4b(d,c,b,a)#0A
#0A..2IF.n<0.BREAK..//.There.are.no.more.characters
.to.pack#0A#0A..2a.:#3D.rdn()#0A..}.REPEAT#0A}#0A#0A
AND.setlab(l).BE#0A{.LET.p.#3D.@rlist#0A#0A..IF.deb
ug>0.DO.writef("%i4:.L%n:*n",.stvp,.l)#0A#0A..labv!
l.:#3D.stvp..//.Set.the.label#2E#0A#0A..//.Fill.in.
all.refs.that.are.in.range#2E#0A..{.LET.r.#3D.!p#0A
..2IF.r#3D0.BREAK#0A..2TEST.h3!r#3Dl.&.inrange_d(h2
!r,.stvp)#0A..2THEN.{.fillref_d(h2!r,.stvp)#0A..9!p
.:#3D.!r..1//.Remove.item.from.RLIST#2E#0A..9freebl
k(r)#0A..7}#0A..2ELSE.p.:#3D.r..//.Keep.the.item#2E
#0A..}.REPEAT#0A..rliste.:#3D.p..3//.Ensure.that.RL
ISTE.is.sensible#2E#0A#0A..p.:#3D.@reflist#0A#0A..{
.LET.r.#3D.!p#0A..2IF.r#3D0.BREAK#0A..2TEST.h3!r#3D
l#0A..2THEN.{.LET.a.#3D.h2!r#0A..9puth(a,stvp-a).//
.Plant.rel.address#2E#0A..9!p.:#3D.!r..5//.Remove.i
tem.from.REFLIST#2E#0A..9freeblk(r)#0A..7}#0A..2ELS
E.p.:#3D.r..//.Keep.item#2E#0A..}.REPEAT#0A#0A..ref
liste.:#3D.p..1//.Ensure.REFLISTE.is.sensible#2E#0A
}#0A#0AAND.cgstatics().BE.WHILE.nlist.DO#0A{.LET.le
n,.nl.#3D.0,.nlist#0A#0A..nliste.:#3D.@nlist..//.Al
l.NLIST.items.will.be.freed#2E#0A#0A..//.Calculate.
the.length.in.bytes.of.the.next.static.value#2E#0A.
.len,.nl.:#3D.len+wordbytelen,.!nl.REPEATUNTIL.nl#3D
0.|.h2!nl#0A#0A..chkrefs(len+wordbytelen-1).//.+wor
dbytelen.since.align(wordbytelen)#0A..27//.may.gene
rate.this.number.of.bytes#2E#0A..align(wordbytelen)
#0A#0A..setlab(h2!nlist)..//.The.first.NLIST.item.a
lways.has.a.label#2E#0A#0A..{.LET.blk.#3D.nlist#0A.
.2LET.w..1#3D.h3!blk#0A..2nlist.:#3D.!nlist#0A//wri
tef("cgstatics:.blk#3D%n.->.[%n,.%n,.%x8]*n",.blk,.
blk!0,.blk!1,.blk!2)#0A..2TEST.c64#0A..2THEN.TEST.t
64#0A..7THEN.codew(.(w>>00032),.w)..//.c64.->.T64#0A
..7ELSE.codew(-(w>>00031),.w)..//.c64.->.t32..1sign
.extend#0A..2ELSE.TEST.t64#0A..7THEN.codew(..h4!blk
,.w)..//.c32.->.t64#0A..7ELSE.codew(..0050,.w)..//.
c32.->.t32#0A..2freeblk(blk)#0A..}.REPEATUNTIL.nlis
t#3D0.|.h2!nlist#0A}#0A#0AAND.getblk(a,.b,.c).#3D.V
ALOF#0A{.LET.p.#3D.freelist#0A..TEST.p#3D0.THEN.{.d
p.:#3D.dp-blkupb-1;.checkspace();.p.:#3D.dp.}#0A..9
ELSE.freelist.:#3D.!p#0A..IF.blkupb#3D3.DO.p!3.:#3D
.0.//.Clear.the.4th.word.if.it.exists#0A..h1!p,.h2!
p,.h3!p.:#3D.a,.b,.c#0A..RESULTIS.p#0A}#0A#0AAND.fr
eeblk(p).BE.{.!p.:#3D.freelist;.freelist.:#3D.p.}#0A
#0AAND.freeblks(p).BE.UNLESS.p#3D0.DO#0A{.LET.oldfr
eelist.#3D.freelist#0A..freelist.:#3D.p#0A..UNTIL.!
p#3D0.DO.p.:#3D.!p#0A..!p.:#3D.oldfreelist#0A}#0A#0A
AND.initdatalists().BE#0A{.reflist,.refliste.:#3D.0
,.@reflist#0A..rlist,..1rliste..1:#3D.0,.@rlist#0A.
.nlist,..1nliste..1:#3D.0,.@nlist#0A..freelist.:#3D
.0#0A}#0A#0ALET.geng(f,.n).BE.TEST.n<256#0A..16THEN
.genb(f,.n)#0A..16ELSE.TEST.n<512#0A..21THEN.genb(f
+32,.n-256)#0A..21ELSE.genh(f+64,.n)#0A#0ALET.gen(f
).BE.IF.incode.DO#0A{.chkrefs(1)#0A..IF.debug.DO.wr
code(f,."")#0A..codeb(f)#0A}#0A#0ALET.genb(f,.a).BE
.IF.incode.DO#0A{.chkrefs(2)#0A..IF.debug>0.DO.wrco
de(f,."%i3",.a)#0A..codeb(f)#0A..codeb(a)#0A}#0A#0A
LET.genr(f,.n).BE.IF.incode.DO#0A{.chkrefs(2)#0A..I
F.debug>0.DO.wrcode(f,."L%n",.n)#0A..codeb(f)#0A..c
odeb(0)#0A..relref(stvp-2,.n)#0A}#0A#0ALET.genh(f,.
h).BE.IF.incode.DO..//.Assume.0.<#3D.h.<#3D.#23xFF2
#0A{.chkrefs(3)#0A..IF.debug>0.DO.wrcode(f,."%n",.h
)#0A..codeb(f)#0A..code2b(h)#0A}#0A#0ALET.genw(f,.w
).BE.IF.incode.DO#0A{.UNLESS.-#23x8005.<#3D.w.<#3D.
#23x7FF5.DO#0A..{.//.This.code.is.only.executed.if.
running.on.a.64-bit.system#0A..2//.and.an.MW.instru
ction.is.needed#2E#0A..2LET.mw.#3D.w>>00032#0A..2IF
.(w.&.#23x8005)~#3D0.DO.mw.:#3D.mw+1#0A..2chkrefs(5
)#0A..2//.Output.code.to.set.the.senior.32.bits.of.
the.mw.register#0A..2//.so.that.w.#3D.mw.+.sign_ext
end32(w.&.#23xFF6)#0A..2//.The.MW.register.is.alway
s.cleared.after.use#2E#0A#0A..2IF.debug>0.DO.wrcode
(f_mw,."#23x%x8",.mw)#0A..2codeb(f_mw)#0A..2code4b(
mw)#0A..}#0A#0A..chkrefs(5)#0A..IF.debug>0.DO.wrcod
e(f,."#23x%x8",.w)#0A..codeb(f)#0A..code4b(w)#0A}#0A
#0AAND.checkspace().BE.IF.stvp/wordbytelen>dp-stv.D
O#0A{.cgerror("Program.too.large,.%n.bytes.compiled
",.stvp)#0A..errcount.:#3D.errcount+1#0A..longjump(
fin_p,.fin_l)#0A}#0A#0AAND.codeb(byte).BE#0A{.stv%s
tvp.:#3D.byte#0A..stvp.:#3D.stvp.+.1#0A..checkspace
()#0A}#0A#0AAND.code2b(h).BE.TEST.bigender#0ATHEN.{
.codeb(h>>0008.);.codeb(h..2)..}#0AELSE.{.codeb(h..
2);.codeb(h>>0008.)..}#0A#0AAND.code4b(w).BE.TEST.b
igender#0ATHEN.{.codeb(w>>00024);.codeb(w>>00016);.
codeb(w>>0008.);.codeb(w..2)..}#0AELSE.{.codeb(w..2
);.codeb(w>>0008.);.codeb(w>>00016);.codeb(w>>00024
)..}#0A#0AAND.pack4b(a,.b,.c,.d).#3D.((1a<<0008).|.
b)<<0008.|.c)<<0008.|.d#0A#0AAND.codeh(h).BE#0A{.IF
.debug>0.DO.writef("%i4:..DATAH.%n*n",.stvp,.h)#0A.
.code2b(h)#0A}#0A#0AAND.codew(wh,.wl).BE.TEST.t64#0A
THEN.{.IF.debug>0.DO.writef("%i4:..DATAW.#23x%x8%x8
*n",.stvp,.wh,.wl)#0A..5TEST.bigender#0A..5THEN.{.c
odeb(wh>>00024)#0A..12codeb(wh>>00016)#0A..12codeb(
wh>>0008)#0A..12codeb(wh)#0A..12codeb(wl>>00024)#0A
..12codeb(wl>>00016)#0A..12codeb(wl>>0008)#0A..12co
deb(wl)#0A..10}#0A..5ELSE.{.codeb(wl)#0A..12codeb(w
l>>0008)#0A..12codeb(wl>>00016)#0A..12codeb(wl>>000
24)#0A..12codeb(wh)#0A..12codeb(wh>>0008)#0A..12cod
eb(wh>>00016)#0A..12codeb(wh>>00024)#0A..10}#0A..3}
#0AELSE.{.IF.debug>0.DO.writef("%i4:..DATAW.#23x%x8
*n",.stvp,.wl)#0A..5TEST.bigender#0A..5THEN.{.codeb
(wl>>00024)#0A..12codeb(wl>>00016)#0A..12codeb(wl>>
0008)#0A..12codeb(wl)#0A..10}#0A..5ELSE.{.codeb(wl)
#0A..12codeb(wl>>0008)#0A..12codeb(wl>>00016)#0A..1
2codeb(wl>>00024)#0A..10}#0A..3}#0A#0AAND.codestr(s
).BE#0A{.LET.i,.len.#3D.0,.s%0#0A#0A..TEST.t64#0A..
THEN.UNTIL.i>len.DO.//.Target.is.64-bit.Cintcode#0A
..5{.LET.p.#3D.stvp#0A..7LET.a,b,c,d,e,f,g,h.#3D.0,
0,0,0,0,0,0,0#0A..7IF.i<#3Dlen.DO.a.:#3D.s%i#0A..7i
.:#3D.i+1#0A..7IF.i<#3Dlen.DO.b.:#3D.s%i#0A..7i.:#3D
.i+1#0A..7IF.i<#3Dlen.DO.c.:#3D.s%i#0A..7i.:#3D.i+1
#0A..7IF.i<#3Dlen.DO.d.:#3D.s%i#0A..7i.:#3D.i+1#0A.
.7IF.i<#3Dlen.DO.e.:#3D.s%i#0A..7i.:#3D.i+1#0A..7IF
.i<#3Dlen.DO.f.:#3D.s%i#0A..7i.:#3D.i+1#0A..7IF.i<#3D
len.DO.g.:#3D.s%i#0A..7i.:#3D.i+1#0A..7IF.i<#3Dlen.
DO.h.:#3D.s%i#0A..7i.:#3D.i+1#0A#0A..7TEST.bigender
#0A..7THEN.{.codeb(a);.codeb(b);.codeb(c);.codeb(d)
#0A..14codeb(e);.codeb(f);.codeb(g);.codeb(h)#0A..1
4IF.debug>0.DO#0A..16writef("%i4:..DATAW.#23x%x2%x2
%x2%x2%x2%x2%x2%x2*n",.#0A..24p,..10a,.b,.c,.d,.e,.
f,.g,.h)#0A..12}#0A..7ELSE.{.codeb(a);.codeb(b);.co
deb(c);.codeb(d)#0A..14codeb(e);.codeb(f);.codeb(g)
;.codeb(h)#0A..14IF.debug>0.DO#0A..16writef("%i4:..
DATAW.#23x%x2%x2%x2%x2%x2%x2%x2%x2*n",.#0A..24p,..1
0h,.g,.f,.e,.d,.c,.b,.a)#0A..12}#0A..5}#0A..ELSE.UN
TIL.i>len.DO.//.Target.is.32-bit.Cintcode#0A..5{.LE
T.p.#3D.stvp#0A..7LET.a,b,c,d.#3D.0,0,0,0#0A..7IF.i
<#3Dlen.DO.a.:#3D.s%i#0A..7i.:#3D.i+1#0A..7IF.i<#3D
len.DO.b.:#3D.s%i#0A..7i.:#3D.i+1#0A..7IF.i<#3Dlen.
DO.c.:#3D.s%i#0A..7i.:#3D.i+1#0A..7IF.i<#3Dlen.DO.d
.:#3D.s%i#0A..7i.:#3D.i+1#0A#0A..7TEST.bigender#0A.
.7THEN.{.codeb(a);.codeb(b);.codeb(c);.codeb(d)#0A.
.14IF.debug>0.DO#0A..16writef("%i4:..DATAW.#23x%x2%
x2%x2%x2*n",.p,.a,b,c,d)#0A..12}#0A..7ELSE.{.codeb(
a);.codeb(b);.codeb(c);.codeb(d)#0A..14IF.debug>0.D
O#0A..16writef("%i4:..DATAW.#23x%x2%x2%x2%x2*n",.p,
.d,c,b,a)#0A..12}#0A..5}#0A}#0A#0AAND.coder(n).BE#0A
{.LET.labval.#3D.labv!n#0A..IF.debug>0.DO.writef("%
i4:..DATAH.L%n-$*n",.stvp,.n)#0A..code2b(0)#0A..TES
T.labval#3D-1.THEN.{.!refliste.:#3D.getblk(0,.stvp-
2,.n)#0A..22refliste.:#3D.!refliste#0A..20}#0A..15E
LSE.puth(stvp-2,.labval-stvp+2)#0A}#0A#0AAND.getw(a
).#3D.VALOF.TEST.bigender#0ATHEN.TEST.t64#0A..3THEN
.RESULTIS.#0A..17stv%(a+0)<<00056.|#0A..17stv%(a+1)
<<00048.|#0A..17stv%(a+2)<<00040.|#0A..17stv%(a+3)<
<00032.|#0A..17stv%(a+4)<<00024.|#0A..17stv%(a+5)<<
00016.|#0A..17stv%(a+6)<<0008..|#0A..17stv%(a+7)#0A
..3ELSE.RESULTIS.stv%(a+0)<<00024.|#0A..17stv%(a+1)
<<00016.|#0A..17stv%(a+2)<<0008..|#0A..17stv%(a+3)#0A
ELSE.TEST.t64#0A..3THEN.RESULTIS.stv%(a+0)..3|#0A..
17stv%(a+1)<<0008..|#0A..17stv%(a+2)<<00016.|#0A..1
7stv%(a+3)<<00024.|#0A..17stv%(a+4)<<00032.|#0A..17
stv%(a+5)<<00040.|#0A..17stv%(a+6)<<00048.|#0A..17s
tv%(a+7)<<00056#0A..3ELSE.RESULTIS.stv%(a+0)..3|#0A
..17stv%(a+1)<<0008..|#0A..17stv%(a+2)<<00016.|#0A.
.17stv%(a+3)<<00024#0A#0AAND.puth(a,.w).BE#0A..TEST
.bigender#0A..THEN.stv%a,..3stv%(a+1).:#3D.w>>0008,
.w#0A..ELSE.stv%(a+1),.stv%a..3:#3D.w>>0008,.w#0A#0A
AND.putw(a,.w).BE#0A..TEST.bigender#0A..THEN.TEST.t
64#0A..5THEN.{.stv%(a+0).:#3D.w>>00056#0A..12stv%(a
+1).:#3D.w>>00048#0A..12stv%(a+2).:#3D.w>>00040#0A.
.12stv%(a+3).:#3D.w>>00032#0A..12stv%(a+4).:#3D.w>>
00024#0A..12stv%(a+5).:#3D.w>>00016#0A..12stv%(a+6)
.:#3D.w>>0008#0A..12stv%(a+7).:#3D.w#0A..10}#0A..5E
LSE.{.stv%(a+0).:#3D.w>>00024#0A..12stv%(a+1).:#3D.
w>>00016#0A..12stv%(a+2).:#3D.w>>0008#0A..12stv%(a+
3).:#3D.w#0A..10}#0A..ELSE.TEST.t64#0A..5THEN.{.stv
%(a+7).:#3D.w>>00056#0A..12stv%(a+6).:#3D.w>>00048#0A
..12stv%(a+5).:#3D.w>>00040#0A..12stv%(a+4).:#3D.w>
>00032#0A..12stv%(a+3).:#3D.w>>00024#0A..12stv%(a+2
).:#3D.w>>00016#0A..12stv%(a+1).:#3D.w>>0008#0A..12
stv%(a+0).:#3D.w#0A..10}#0A..5ELSE.{.stv%(a+3).:#3D
.w>>00024#0A..12stv%(a+2).:#3D.w>>00016#0A..12stv%(
a+1).:#3D.w>>0008#0A..12stv%(a+0).:#3D.w#0A..10}#0A
#0AAND.align(n).BE.UNTIL.stvp.REM.n.#3D.0.DO.codeb(
0)#0A#0AAND.chkrefs(n).BE..//.Resolve.references.un
til.it.is.possible#0A..17//.to.compile.n.bytes.with
out.a.reference#0A..17//.going.out.of.range#2E#0A{.
LET.p.#3D.@rlist#0A#0A..skiplab.:#3D.0#0A#0A..UNTIL
.!p#3D0.DO#0A..{.LET.r.#3D.!p#0A..2LET.a.#3D.h2!r./
/.RLIST.is.ordered.in.increasing.A#2E#0A#0A..2IF.(s
tv%a.&.1).#3D.0.DO#0A..2//.An.unresolved.reference.
at.address.A#0A..2{.IF.inrange_i(a,.stvp+n+3).BREAK
#0A..4//.This.point.is.reached.if.there.is#0A..4//.
an.unresolved.ref.at.A.which.cannot#0A..4//.directl
y.relative.address.STVP+N+3#0A..4//.and.so.an.indir
ect.data.word.must#0A..4//.be.compiled#2E#0A..4//.T
he.+3.is.to.allow.for.a.possible#0A..4//.skip.jump.
instruction.and.possibly#0A..4//.one.filler.byte#2E
#0A..4genindword(h3!r)#0A..2}#0A#0A..2//.At.this.po
int.the.reference.at.A#0A..2//.is.in.range.of.a.res
olving.indirect#0A..2//.data.word.and.should.be.rem
oved.from#0A..2//.RLIST.if.there.is.no.chance.that.
it#0A..2//.can.be.resolved.by.a.direct.relative#0A.
.2//.address#2E#0A..2TEST.inrange_d(a,.stvp)#0A..2T
HEN.p.:#3D.r..6//.Keep.the.item#2E#0A..2ELSE.{.!p.:
#3D.!r..1//.Free.item.if.already.resolved#0A..9free
blk(r).//.and.no.longer.in.direct.range#2E#0A..9IF.
!p#3D0.DO.rliste.:#3D.p..//.Correct.RLISTE#2E#0A..7
}#0A..}#0A#0A..//.At.this.point.all.necessary.indir
ect.data.words.have#0A..//.been.compiled#2E#0A#0A..
UNLESS.skiplab#3D0.DO.{.setlab(skiplab)#0A..22skipl
ab,.incode.:#3D.0,.TRUE#0A..20}#0A}#0A#0AAND.genind
word(l).BE..//.Called.only.from.CHKREFS#2E#0A{.LET.
r.#3D.rlist..4//.Assume.RLIST.~#3D.0#0A#0A..IF.inco
de.DO#0A..{.skiplab.:#3D.newlab()#0A..2//.genr(f_j,
.skiplab).without.the.call.of.chkrefs(2)#2E#0A..2IF
.debug>0.DO.wrcode(f_j,."L%n",.skiplab)#0A..2codeb(
f_j)#0A..2codeb(0)#0A..2relref(stvp-2,.skiplab)#0A.
.2incode.:#3D.FALSE#0A..}#0A#0A..align(2)#0A#0A..UN
TIL.r#3D0.DO#0A..{.IF.h3!r#3Dl.&.(stv%(h2!r).&.1)#3D
0.DO.fillref_i(h2!r,.stvp)#0A..2r.:#3D.!r#0A..}#0A#0A
..coder(l)#0A}#0A#0AAND.inrange_d(a,.p).#3D.a-127.<
#3D.p.<#3D.a+128#0A//.The.result.is.TRUE.if.direct.
relative.instr.(eg.J).at#0A//.A.can.address.locatio
n.P.directly#2E#0A#0AAND.inrange_i(a,.p).#3D.VALOF#0A
//.The.result.is.TRUE.if.indirect.relative.instr.(e
g.J}#0A//.at.A.can.address.a.resolving.word.at.P#2E
#0A{.LET.rel.#3D.(p-a)/2#0A..RESULTIS.0.<#3D.rel.<#3D
.255#0A}#0A#0AAND.fillref_d(a,.p).BE#0A{.stv%a.:#3D
.stv%a.&.254..//.Back.to.direct.form.if.neccessary#2E
#0A..stv%(a+1).:#3D.p-a-1#0A}#0A#0AAND.fillref_i(a,
.p).BE..//.P.is.even#2E#0A{.stv%a.:#3D.stv%a.|.1..1
//.Force.indirect.form#2E#0A..stv%(a+1).:#3D.(p-a)/
2#0A}#0A#0AAND.relref(a,.l).BE#0A//.RELREF.is.only.
called.just.after.compiling#0A//.a.relative.referen
ce.instruction.at#0A//.address.A.(#3Dstvp-2)#2E#0A{
.LET.labval.#3D.labv!l#0A#0A..IF.labval>#3D0.&.inra
nge_d(a,.labval).DO.{.fillref_d(a,.labval)#0A..41RE
TURN#0A..39}#0A#0A..//.All.other.references.in.RLIS
T.have#0A..//.addresses.smaller.than.A.and.so.RLIST
.will#0A..//.remain.properly.ordered.if.this.item#0A
..//.is.added.to.the.end#2E#0A..!rliste.:#3D.getblk
(0,.a,.l)#0A..rliste.:#3D.!rliste#0A}#0A#0ALET.outp
utsection().BE#0A{.LET.outstream.#3D.output()#0A..U
NTIL.reflist#3D0.DO.{.cgerror("Label.L%n.unset",.h3
!reflist)#0A..21reflist.:#3D.!reflist#0A..19}#0A#0A
..selectoutput(gostream)..//.Output.a.HUNK.or.BHUNK
#2E#0A#0A..UNLESS.objline1written.IF.objline1%0.DO#0A
..{.writef("%s*n",.objline1)#0A..2objline1written.:
#3D.TRUE#0A..}#0A#0A..TEST.bining#0A..THEN.{.writef
("%X3.",.t_bhunk)..8//.writes.4.chars."BB0008."#0A.
.7FOR.p#3D0.TO.3..4DO.wrch(stv%p).//.write.bhunk.si
ze#0A..7FOR.p#3D0.TO.stvp-1.DO.wrch(stv%p).//.write
.the.bhunk#0A..5}#0A..ELSE.{.newline()#0A..7TEST.t6
4#0A..7THEN.{.LET.p.#3D.0#0A..14writef("%16x.",t_hu
nk64)#0A..14writef("%16x.",.stvp/wordbytelen)#0A..1
4WHILE.p.<.stvp.DO#0A..14{.IF.p.REM.32.#3D.0.DO.new
line()#0A..16wrword_at(p)#0A..16p.:#3D.p+wordbytele
n#0A..14}#0A..12}#0A..7ELSE.{.LET.p.#3D.0#0A..14wri
tef("%8x.",.t_hunk)#0A..14writef("%8x.",.stvp/wordb
ytelen)#0A..14WHILE.p.<.stvp.DO#0A..14{.IF.p.REM.32
.#3D.0.DO.newline()#0A..16wrword_at(p)#0A..16p.:#3D
.p+wordbytelen#0A..14}#0A..12}#0A..7newline()#0A..5
}#0A..selectoutput(outstream)#0A}#0A#0AAND.wrhex2(b
yte).BE#0A{.LET.t.#3D.TABLE.'0','1','2','3','4','5'
,'6','7',#0A..14'8','9','A','B','C','D','E','F'#0A.
.wrch(t!(byte>>0004))#0A..wrch(t!(byte&15))#0A}#0A#0A
AND.wrword_at(a).BE#0A{.TEST.bigender.THEN.{.wrhex2
(stv%a)#0A..21wrhex2(stv%(a+1))#0A..21wrhex2(stv%(a
+2))#0A..21wrhex2(stv%(a+3))#0A..21IF.t64.DO#0A..21
{.wrhex2(stv%(a+4))#0A..23wrhex2(stv%(a+5))#0A..23w
rhex2(stv%(a+6))#0A..23wrhex2(stv%(a+7))#0A..21}#0A
..19}#0A..14ELSE.{.IF.t64.DO#0A..21{.wrhex2(stv%(a+
7))#0A..23wrhex2(stv%(a+6))#0A..23wrhex2(stv%(a+5))
#0A..23wrhex2(stv%(a+4))#0A..21}#0A..21wrhex2(stv%(
a+3))#0A..21wrhex2(stv%(a+2))#0A..21wrhex2(stv%(a+1
))#0A..21wrhex2(stv%(a))#0A..19}#0A..wrch('.')#0A}#0A
#0AAND.dboutput().BE#0A{.LET.p.#3D.info_a#0A..write
s("A#3D(")#0A..UNTIL.p#3D0.DO.{.wrkn(h2!p,.h3!p)#0A
..15p.:#3D.!p#0A..15UNLESS.p#3D0.DO.wrch('*s')#0A..
13}#0A..2#0A..p.:#3D.info_b#0A..writes(").B#3D(")#0A
..UNTIL.p#3D0.DO.{.wrkn(h2!p,.h3!p)#0A..15p.:#3D.!p
#0A..15UNLESS.p#3D0.DO.wrch('*s')#0A..13}#0A..wrch(
')')#0A..1#0A..IF.debug#3D2.DO.{.writes("..STK:.")#0A
..16FOR.p#3Dtempv.TO.arg1.BY.3..DO#0A..16{.IF.(p-te
mpv).REM.30.#3D.10.DO.newline()#0A..18wrkn(h1!p,h2!
p)#0A..18wrch('*s')#0A..16}#0A..14}#0A..1#0A..IF.de
bug#3D3.DO.{.LET.l.#3D.rlist#0A..16writes("*nREFS."
)#0A..16UNTIL.l#3D0.DO.{.writef("%n.L%n..",.l!1,.l!
2)#0A..31l.:#3D.!l#0A..29}#0A..14}#0A..newline()#0A
}#0A#0A1AND.wrkn(k,n).BE#0A{.LET.s.#3D.VALOF.SWITCH
ON.k.INTO#0A..{.DEFAULT:..5k.:#3D.n#0A..17RESULTIS.
"?"#0A..2CASE.k_none:..1RESULTIS."-"#0A..2CASE.k_nu
mb:..1RESULTIS."N"#0A..2CASE.k_fnlab:..RESULTIS."F"
#0A..2CASE.k_lvloc:..RESULTIS."@P"#0A..2CASE.k_lvgl
ob:.RESULTIS."@G"#0A..2CASE.k_lvlab:..RESULTIS."@L"
#0A..2CASE.k_a:..4RESULTIS."A"#0A..2CASE.k_b:..4RES
ULTIS."B"#0A..2CASE.k_c:..4RESULTIS."C"#0A..2CASE.k
_loc:..2RESULTIS."P"#0A..2CASE.k_glob:..1RESULTIS."
G"#0A..2CASE.k_lab:..2RESULTIS."L"#0A..2CASE.k_loc0
:..1RESULTIS."0P"#0A..2CASE.k_loc1:..1RESULTIS."1P"
#0A..2CASE.k_loc2:..1RESULTIS."2P"#0A..2CASE.k_loc3
:..1RESULTIS."3P"#0A..2CASE.k_loc4:..1RESULTIS."4P"
#0A..2CASE.k_glob0:..RESULTIS."0G"#0A..2CASE.k_glob
1:..RESULTIS."1G"#0A..2CASE.k_glob2:..RESULTIS."2G"
#0A..}#0A..writes(s)#0A..UNLESS.k#3Dk_none.|.k#3Dk_
a.|.k#3Dk_b.|.k#3Dk_c.DO.writen(n)#0A}#0A#0AAND.wrc
ode(f,.form,.a,.b).BE#0A{.IF.debug#3D2.DO.dboutput(
)#0A..writef("%i4:.",.stvp)#0A..wrfcode(f)#0A..writ
es("..")#0A..writef(form,.a,.b)#0A..newline()#0A}#0A
#0AAND.wrfcode(f).BE#0A{.LET.s.#3D.VALOF.SWITCHON.f
&31.INTO#0A..{.DEFAULT:#0A..2CASE..0000:.RESULTIS."
..3-..3K..1LLP..3L..2LP..2SP..2AP..3A"#0A..2CASE..0
001:.RESULTIS.".FLTOP..2KH..LLPH..2LH..1LPH..1SPH..
1APH..2AH"#0A..2CASE..0002:.RESULTIS."..1BRK..2KW..
LLPW..2LW..1LPW..1SPW..1APW..2AW"#0A..2CASE..0003:.
RESULTIS."..2K3..1K3G..K3G1..K3GH..1LP3..1SP3..1AP3
..L0P3"#0A..2CASE..0004:.RESULTIS."..2K4..1K4G..K4G
1..K4GH..1LP4..1SP4..1AP4..L0P4"#0A..2CASE..0005:.R
ESULTIS."..2K5..1K5G..K5G1..K5GH..1LP5..1SP5..1AP5.
.L0P5"#0A..2CASE..0006:.RESULTIS."..2K6..1K6G..K6G1
..K6GH..1LP6..1SP6..1AP6..L0P6"#0A..2CASE..0007:.RE
SULTIS."..2K7..1K7G..K7G1..K7GH..1LP7..1SP7..1AP7..
L0P7"#0A..2CASE..0008:.RESULTIS."..2K8..1K8G..K8G1.
.K8GH..1LP8..1SP8..1AP8..L0P8"#0A..2CASE..0009:.RES
ULTIS."..2K9..1K9G..K9G1..K9GH..1LP9..1SP9..1AP9..L
0P9"#0A..2CASE.10:.RESULTIS."..1K10..K10G.K10G1.K10
GH..LP10..SP10..AP10.L0P10"#0A..2CASE.11:.RESULTIS.
"..1K11..K11G.K11G1.K11GH..LP11..SP11..AP11.L0P11"#0A
..2CASE.12:.RESULTIS."..2LF..1S0G..S0G1..S0GH..LP12
..SP12..AP12.L0P12"#0A..2CASE.13:.RESULTIS."..1LF$.
.1L0G..L0G1..L0GH..LP13..SP13.XPBYT..3S"#0A..2CASE.
14:.RESULTIS."..2LM..1L1G..L1G1..L1GH..LP14..SP14..
1LMH..2SH"#0A..2CASE.15:.RESULTIS."..1LM1..1L2G..L2
G1..L2GH..LP15..SP15..1BTC..MDIV"#0A..2CASE.16:.RES
ULTIS."..2L0..2LG..1LG1..1LGH..LP16..SP16..1NOP.CHG
CO"#0A..2CASE.17:.RESULTIS."..2L1..2SG..1SG1..1SGH.
.1SYS..2S1..2A1..1NEG"#0A..2CASE.18:.RESULTIS."..2L
2..1LLG..LLG1..LLGH..1SWB..2S2..2A2..1NOT"#0A..2CAS
E.19:.RESULTIS."..2L3..2AG..1AG1..1AGH..1SWL..2S3..
2A3..L1P3"#0A..2CASE.20:.RESULTIS."..2L4..1MUL..1AD
D..2RV..2ST..2S4..2A4..L1P4"#0A..2CASE.21:.RESULTIS
."..2L5..1DIV..1SUB..1RV1..1ST1..1XCH..2A5..L1P5"#0A
..2CASE.22:.RESULTIS."..2L6..1REM..1LSH..1RV2..1ST2
..GBYT..RVP3..L1P6"#0A..2CASE.23:.RESULTIS."..2L7..
1XOR..1RSH..1RV3..1ST3..PBYT..RVP4..L2P3"#0A..2CASE
.24:.RESULTIS."..2L8..2SL..1AND..1RV4..STP3..1ATC..
RVP5..L2P4"#0A..2CASE.25:.RESULTIS."..2L9..1SL$..2O
R..1RV5..STP4..1ATB..RVP6..L2P5"#0A..2CASE.26:.RESU
LTIS."..1L10..2LL..1LL1..1RV6..STP5..3J..RVP7..L3P3
"#0A..2CASE.27:.RESULTIS."..FHOP..1LL$..LL1$..1RTN.
.GOTO..2J$.ST0P3..L3P4"#0A..2CASE.28:.RESULTIS."..1
JEQ..1JNE..1JLS..1JGR..1JLE..1JGE.ST0P4..L4P3"#0A..
2CASE.29:.RESULTIS."..JEQ$..JNE$..JLS$..JGR$..JLE$.
.JGE$.ST1P3..L4P4"#0A..2CASE.30:.RESULTIS."..JEQ0..
JNE0..JLS0..JGR0..JLE0..JGE0.ST1P4.SELLD"#0A..2CASE
.31:.RESULTIS.".JEQ0$.JNE0$.JLS0$.JGR0$.JLE0$.JGE0$
..2MW.SELST"#0A..}#0A..LET.n.#3D.f>>0005.&.7#0A..FO
R.i.#3D.6*n+1.TO.6*(n+1).DO.wrch(s%i)#0A}#0A#0A2

######com/bcpl.b#
//.This.is.the.BCPL.to.Cintcode.compiler#0A#0A//.Im
plemented.by.Martin.Richards.(c).May.2000009#0A#0A/
/.Note:.#2E#2E/cintcode/.is.used.so.that.the.compil
er.can.be#0A//.compiled.in.a.directory.parallel.to.
cintcode.(such.as.natbcpl)#2E#0A#0AGET."#2E#2E/cint
code/com/bcplfe#2Eb"#0A#0A#2E#0A#0AGET."#2E#2E/cint
code/com/bcplcgcin#2Eb"#0A

######com/bcplcgcin.b#
//.This.is.the.BCPL.32/64.bit.OCODE.to.Cintcode.cod
egenerator#2E#0A#0A//.Implemented.by.Martin.Richard
s.(c).12.May.2013#0A#0A/*.Change.history#0A#0A00006
/08/14#0AModified.to.include.floating.point.constan
ts.and.the.operators#0A#23*.#23/.~+.#23-.#23#3D.#23
~#3D.#23<.#23>.#23<#3D.and.#23>#3D#2E#0A#0A00015/05
/13#0AModified.to.use.c64.and.t64.that.specify.the.
BCPL.word.length.of#0Athe.compiler.and.target.machi
nes,.respectively#2E#0A#0A00010/05/13#0AMajor.chang
e.to.the.compilation.of.SWITCHON.to.stop.the.compil
er#0Acrashing.when.given.CASE.minint:#2E.See.functi
on.switcht#2E#0A#0A00010/07/09#0ASeparated.the.comp
iler.into.bcplfe#2Eb.and.codegenerators#0Abcplcgcin
#2Eb.and.bcplcgsial#2Eb.and.added.the.interface#0Ah
eader.g/bcplfecg#2Eh#0A#0A00007/09/06#0AThis.is.a.v
ersion.of.the.BCPL.compiler.that.generates.64-cintc
ode#2E..It#0Ais.designed.to.run.on.both.32-.and.64-
bit.systems#2E.The.options.t32.and#0At64.specify.th
e.bit.length.of.the.BCPL.word.in.the.target.system#2E
.The#0Adefault.is.the.same.as.the.current.system#2E
..On.64-bit.systems#0Anumerical.constants.are.compi
les.to.full.precision,.but.on.32-bit#0Asystems.they
.are.truncated.to.32.bits.then.sign.extended.to.64#0A
bits#2E.64-bit.Cintcode.has.one.new.instruction.(MW
).that.modifies.the#0Aoperand.of.the.next.W.type.in
struction.(KW,.LLPW,.LW,.LPW,.SPW,.APW#0Aand.AW)#2E
.It.does.this.by.setting.the.senior.32-bits.of.the.
new.64-bit#0AMW.register#2E.This.is.added.to.the.op
erand.of.any.W.type.instruction#0Aand.is.cleared.af
ter.use#2E#0A#0A00018/01/06#0ABased.on.Dave.Lewis's
.suggestion,#0Ain.outputsection(),.add:#0A..1IF.obj
line1%0.DO.writef("%s*n",.objline1)#0Awhere.objline
1.is.the.first.line.of.file.objline1.if.it.can.be.f
ound#0Ain.the.current.directory.or.in.the.HDRS.dire
ctory#2E.This.will.typically#0Aput.a.line.such.as:#0A
#23!/usr/local/bin/cintsys.-c#0Aas.the.first.line.o
f.the.compiled.object.module#2E.This.line.is.ignore
d#0Aby.the.CLI.but.may.be.useful.under.Linux#2E.If.
objline1.cannot.be.found#0Ano.such.line.is.inserted
.at.the.start.of.the.object.module#2E#0A#0A00007/01
/06#0AInitial.version.of.the.64-bit.codegenerator#0A
#0A00026/2/99#0AAdded.BIN.option.to.the.compiler.to
.generate.a.binary.(rather.than#0Ahex).hunk.format.
for.the.compiled.code#2E.This.is.primarily.for.the#0A
Windows.CE.version.of.the.cintcode.system.where.com
pactness.is#0Aparticularly.important#2E.There.is.a.
related.change.to.loadseg.in#0Acintmain#2Ec#0A#0A00
024/12/95#0AImproved.the.efficiency.of.outputsectio
n.in.CG.by.introducing#0Awrhex2.and.wrword_at#2E#0A
#0A00024/7/95#0ARemoved.bug.in.atbinfo,.define.addi
nfo_b.change.some.global.numbers#2E#0AImplement.con
stant.folding.in.TRN#2E#0A#0A00022/6/93#0AReverse.o
rder.in.SWB.and.have.a.minimum.of.7.cases#0Ato.allo
w.faster.interpreter#2E#0A#0A0002/6/93#0AChanged.co
de.for.SWB.to.use.heap-like.binary.tree#2E#0A#0A000
19/5/93#0APut.in.code.to.compile.BTC.and.XPBYT.inst
ructions#2E#0A#0A00023/4/93#0AAllowed.the.codegener
ator.to.compiler.the.S.instruction#2E#0A#0A00021/12
/92#0ACured.bug.in.compilation.of.(b.->.f,.g)(1,2,3
)#0A#0A00024/11/92.#0ACured.bug.in.compilation.of.a
,.b.:#3D.s%0.>.0,.s%1.#3D.'!'#0A#0A00023/7/92:#0ARe
named.nextlab.as.newlab,.load.as.loadval.in.the.CG#2E
#0APut.back.simpler.hashing.function.in.lookupword#2E
#0ARemoved.rdargs.fudge#2E#0ARemoved.S2.compiler.op
tion#2E#0ACured.bug.concerning.the.closing.of.gostr
eam.when.equal.to.stdout#2E#0A*/#0A#0ASECTION."BCPL
CGCIN"#0A#0A//.If.c64.is.FALSE,.we.are.running.an.a
.32-bit.system#0A//.If.c64.is.TRUE,..we.are.running
.an.a.64-bit.system#0A#0A//.If.t64.is.FALSE,.it.gen
erates.32-bit.Cintcode#2E#0A//.If.t64.is.TRUE,..it.
generates.64-bit.Cintcode#2E#0A//.If.neither.are.se
t.is.generates.code.compatible.with.the.currently#0A
//.running.system#2E#0A#0AGET."libhdr"#0AGET."bcplf
ecg"#0A#0AGLOBAL.{#0A//.Global.procedures#2E#0Acgse
cts:.cgg#0Ardname#0Ardl#0Ardgn#0Anewlab#0Achecklab#0A
cgerror#0A#0Ainitstack#0Astack#0Astore#0Ascan#0Acgp
endingop#0Aloadval#0Aloadba#0Asetba#0A#0Agenxch#0Ag
enatb#0Aloada#0Apush#0Aloadboth#0Ainreg_a#0Ainreg_b
#0Aaddinfo_a#0Aaddinfo_b#0Apushinfo#0Axchinfo#0Aatb
info#0A#0Aforget_a#0Aforget_b#0Aforgetall#0Aforgetv
ar#0Aforgetallvars#0A#0Aiszero#0Astoret#0Agensp#0Ag
enlp#0Aloadt#0Alose1#0Aswapargs#0Acgstind#0Astorein
#0A#0Acgrv#0Acgadd#0Acgloadk#0Acgaddk#0Acgglobal#0A
cgentry#0Acgapply#0Acgjump#0Ajmpfn#0Ajfn0#0Arevjfn#0A
compjfn#0Aprepj#0A#0Aswlpos#0Aswrpos#0Afindpos#0Aro
otpos#0A#0Acgswitch#0Aswitcht#0Aswitchta#0Aswitchse
g#0Aswitchb#0Aswitchl#0Acgstring#0Asetlab#0Acgstati
cs#0Agetblk#0Afreeblk#0Afreeblks#0A#0Ainitdatalists
#0A#0Ageng#0Agen#0Agenb#0Agenbb#0Agenflt#0Agenfb#0A
genfbb#0Agenr#0Agenh#0Agenw#0Acheckspace#0Acodeb#0A
code2b#0Acode4b#0Apack4b#0Acodeh#0Acodew#0Acoder#0A
#0Agetw#0Aputh#0Aputw#0Aalign#0Achkrefs#0Adealwithr
efs#0Agenindword#0Ainrange_d#0Ainrange_i#0Afillref_
d#0Afillref_i#0Arelref#0A#0Aoutputsection#0Awrword#0A
wrhex2#0Awrword_at#0Adboutput#0Awrkn#0Awrcode#0Awrf
code#0Asopname#0A#0A//.Global.variables#2E#0Aarg1#0A
arg2#0A#0Assp#0A#0Atempt#0Atempv#0Astv#0Astvp#0A#0A
ch#0A#0Adp#0Afreelist#0A#0Aincode#0Alabv#0A#0Acasek
#0Acasel#0A#0Amaxgn#0Amaxlab#0Amaxssp#0A#0Aop#0Alab
number#0Apendingop#0Aprocdepth#0A#0Aprogsize#0A#0Ai
nfo_a#0Ainfo_b#0Areflist#0Arefliste#0Arlist#0Arlist
e#0Anlist#0Anliste#0Askiplab#0A#0Acodestr#0Ablkupb.
.10//.#3D3.if.bytesperword#3D4.and.t64#3DTRUE#0A..1
6//.#3D2.otherwise#2E#0A}#0A#0AMANIFEST#0A{#0A//.Va
lue.descriptors#2E#0Ak_none#3D0;.k_numb#3D1;.k_fnla
b#3D2#0Ak_lvloc#3D3;.k_lvglob#3D4;.k_lvlab#3D5#0Ak_
a#3D6;.k_b#3D7;.k_c#3D8#0Ak_loc#3D9;.k_glob#3D10;.k
_lab#3D11;.#0Ak_loc0#3D12;.k_loc1#3D13;.k_loc2#3D14
;.k_loc3#3D15;.k_loc4#3D16#0Ak_glob0#3D17;.k_glob1#3D
18;.k_glob2#3D19#0A#0Aswapped#3DTRUE;.notswapped#3D
FALSE#0A#0A//.Global.routine.numbers#2E#0Agn_stop#3D
2#0A}#0A#0A//.CINTCODE.op.codes#2E#0AMANIFEST.{#0Af
_k0..1#3D..0010#0Af_fltop#3D..0011..//.Added.20/07/
10#0Af_lf..1#3D..00012#0Af_lm..1#3D..00014#0Af_lm1.
.#3D..00015#0Af_l0..1#3D..00016#0Af_fhop.#3D..00027
#0Af_jeq..#3D..00028#0Af_jeq0.#3D..00030#0A#0Af_k..
2#3D..00032#0Af_kh..1#3D..00033#0Af_kw..1#3D..00034
#0Af_k0g..#3D..00032#0Af_s0g..#3D..00044#0Af_l0g..#3D
..00045#0Af_l1g..#3D..00046#0Af_l2g..#3D..00047#0Af
_lg..1#3D..00048#0Af_sg..1#3D..00049#0Af_llg..#3D..
00050#0Af_ag..1#3D..00051#0Af_mul..#3D..00052#0Af_d
iv..#3D..00053#0Af_rem..#3D..00054#0Af_xor..#3D..00
055#0Af_sl..1#3D..00056#0Af_ll..1#3D..00058#0Af_jne
..#3D..00060#0Af_jne0.#3D..00062#0A#0Af_llp..#3D..0
0064#0Af_llph.#3D..00065#0Af_llpw.#3D..00066#0Af_ad
d..#3D..00084#0Af_sub..#3D..00085#0Af_lsh..#3D..000
86#0Af_rsh..#3D..00087#0Af_and..#3D..00088#0Af_or..
1#3D..00089#0Af_ll1..#3D..00090#0Af_jls..#3D..00092
#0Af_jls0.#3D..00094#0A#0Af_l..2#3D..00096#0Af_lh..
1#3D..00097#0Af_lw..1#3D..00098#0Af_rv..1#3D.110006
#0Af_rtn..#3D.123#0Af_jgr..#3D.124#0Af_jgr0.#3D.126
#0A#0Af_lp..1#3D.128#0Af_lph..#3D.129#0Af_lpw..#3D.
130#0Af_lp0..#3D.128#0Af_swb..#3D.146#0Af_swl..#3D.
147#0Af_st..1#3D.148#0Af_st0..#3D.148#0Af_goto.#3D.
155#0Af_jle..#3D.156#0Af_jle0.#3D.158#0A#0Af_sp..1#3D
.160#0Af_sph..#3D.161#0Af_spw..#3D.162#0Af_sp0..#3D
.160#0Af_s0..1#3D.176#0Af_xch..#3D.181#0Af_gbyt.#3D
.182#0Af_pbyt.#3D.183#0Af_atc..#3D.184#0Af_atb..#3D
.185#0Af_j..2#3D.186#0Af_jge..#3D.188#0Af_jge0.#3D.
190#0A#0Af_ap..1#3D.192#0Af_aph..#3D.193#0Af_apw..#3D
.194#0Af_ap0..#3D.192#0Af_xpbyt#3D.205#0Af_lmh..#3D
.206#0Af_btc..#3D.207#0Af_nop..#3D.208#0Af_a0..1#3D
.208#0Af_rvp0.#3D.211#0Af_st0p0#3D.216#0Af_st1p0#3D
.218#0Af_mw..1#3D.220003#0A#0Af_a..2#3D.220004#0Af_
ah..1#3D.220005#0Af_aw..1#3D.220006#0Af_l0p0.#3D.22
0004#0Af_s..2#3D.237#0Af_sh..1#3D.238#0Af_mdiv.#3D.
239#0Af_chgco#3D.240#0Af_neg..#3D.241#0Af_not..#3D.
242#0Af_l1p0.#3D.240#0Af_l2p0.#3D.244#0Af_l3p0.#3D.
247#0Af_l4p0.#3D.249#0Af_selld#3D.254..//.Added.20/
07/10#0Af_selst#3D.255..//.Added.20/07/10#0A}#0A#0A
LET.codegenerate(workspace,.workspacesize).BE#0A{./
/writef("%n-bit.system.generating.%n-bit.code*n",.(
c64->64,32),.(t64->64,32))#0A#0A..IF.workspacesize<
2001.DO.{.cgerror("Too.little.workspace")#0A..27err
count.:#3D.errcount+1#0A..27longjump(fin_p,.fin_l)#0A
..25}#0A#0A..progsize.:#3D.0#0A#0A..op.:#3D.rdn()#0A
#0A..cgsects(workspace,.workspacesize)#0A..writef("
Code.size.#3D.%i5.bytes.of.%n-bit.%s.ender.Cintcode
*n",#0A..7progsize,.(t64->64,32),.(bigender->"big",
"little"))#0A}#0A#0A1AND.cgsects(workvec,.vecsize).
BE.UNTIL.op#3D0.DO#0A{.LET.p.#3D.workvec#0A..tempv.
:#3D.p#0A..p.:#3D.p+90#0A..tempt.:#3D.p#0A..casek.:
#3D.p#0A..p.:#3D.p+400#0A..casel.:#3D.p#0A..p.:#3D.
p+400#0A..labv.:#3D.p#0A..dp.:#3D.workvec+vecsize#0A
..labnumber.:#3D.(dp-p)/10+10#0A..p.:#3D.p+labnumbe
r#0A..FOR.lp.#3D.labv.TO.p-1.DO.!lp.:#3D.-1#0A..stv
.:#3D.p#0A..stvp.:#3D.0#0A..incode.:#3D.FALSE#0A..m
axgn.:#3D.0#0A..maxlab.:#3D.0#0A..maxssp.:#3D.0#0A.
.procdepth.:#3D.0#0A..info_a,.info_b.:#3D.0,.0#0A#0A
..TEST.t64.&.~c64#0A..THEN.blkupb.:#3D.3.//.t64.set
.but.running.on.a.32-bit.implementation#0A..ELSE.bl
kupb.:#3D.2.//.otherwise#2E#0A#0A..initstack(3)#0A.
.initdatalists()#0A#0A..codew(0,.0)..//.For.size.of
.module#2E#0A..IF.op#3Ds_section.DO#0A..{.MANIFEST.
{.upb#3D11.}.//.Max.length.of.entry.name#0A..2LET.n
.#3D.rdn()#0A..2LET.v.#3D.VEC.upb/bytesperword#0A..
2v%0.:#3D.upb#0A..2rdname(n,.v).//.Pack.up.to.11.ch
aracter.of.the.name.into.v#0A#0A..2IF.naming.DO#0A.
.2{.TEST.c64#0A..4THEN.codew(..sectword>>00032,..se
ctword)#0A..4ELSE.codew(-(sectword>>00031),.sectwor
d).//.Sign.extend#0A..4codestr(v)#0A..2}#0A#0A..2op
.:#3D.rdn()#0A..}#0A#0A..scan()#0A..op.:#3D.rdn()#0A
..putw(0,.stvp/wordbytelen)..//.Plant.the.word.size
.of.the.module#2E#0A..outputsection()#0A..progsize.
:#3D.progsize.+.stvp#0A}#0A#0AAND.rdname(n,.v).BE#0A
{.//.Pack.up.to.11.character.of.the.name.into.v.inc
luding#0A..//.the.first.and.last.five#2E#0A..TEST.n
<#3D11#0A..THEN.{.FOR.i.#3D.1.TO.n.DO.v%i.:#3D.rdn(
)#0A..7FOR.i.#3D.n+1.TO.11.DO.v%i.:#3D.'*s'#0A..5}#0A
..ELSE.{.FOR.i.#3D.1.TO.5..1DO.v%i.:#3D.rdn()#0A..7
FOR.i.#3D.6.TO.n-6.DO.rdn().//.Ignore.the.middle.ch
aracters#0A..7FOR.i.#3D.6.TO.11..DO.v%i.:#3D.rdn()#0A
..7IF.n>11.DO.v%6.:#3D.'*''#0A..5}#0A}#0A#0A//.Read
.in.an.OCODE.label#2E#0AAND.rdl().#3D.VALOF#0A{.LET
.l.#3D.rdn()#0A..IF.maxlab<l.DO.{.maxlab.:#3D.l;.ch
ecklab().}#0A..RESULTIS.l#0A}#0A#0A//.Read.in.a.glo
bal.number#2E#0AAND.rdgn().#3D.VALOF#0A{.LET.g.#3D.
rdn()#0A..IF.maxgn<g.DO.maxgn.:#3D.g#0A..RESULTIS.g
#0A}#0A#0A//.Generate.next.label.number#2E#0AAND.ne
wlab().#3D.VALOF#0A{.labnumber.:#3D.labnumber-1#0A.
.checklab()#0A..RESULTIS.labnumber#0A}#0A#0AAND.che
cklab().BE.IF.maxlab>#3Dlabnumber.DO#0A{.cgerror("T
oo.many.labels.-.increase.workspace")#0A..errcount.
:#3D.errcount+1#0A..longjump(fin_p,.fin_l)#0A}#0A#0A
AND.cgerror(mes,.a).BE#0A{.writes("*nError:.")#0A..
writef(mes,.a)#0A..newline()#0A..errcount.:#3D.errc
ount+1#0A..IF.errcount>errmax.DO.{.writes("Too.many
.errors*n")#0A..24longjump(fin_p,.fin_l)#0A..22}#0A
}#0A#0A//.Initialize.the.simulated.stack.(SS)#2E#0A
LET.initstack(n).BE#0A{.arg2,.arg1,.ssp.:#3D.tempv,
.tempv+3,.n#0A..pendingop.:#3D.s_none#0A..h1!arg2,.
h2!arg2,.h3!arg2.:#3D.k_loc,.ssp-2,.ssp-2#0A..h1!ar
g1,.h2!arg1,.h3!arg1.:#3D.k_loc,.ssp-1,.ssp-1#0A..I
F.maxssp<ssp.DO.maxssp.:#3D.ssp#0A}#0A#0A//.Move.si
mulated.stack.(SS).pointer.to.N#2E#0AAND.stack(n).B
E#0A{.IF.maxssp<n.DO.maxssp.:#3D.n#0A..IF.n>#3Dssp+
4.DO.{.store(0,ssp-1)#0A..17initstack(n)#0A..17RETU
RN#0A..15}#0A#0A..WHILE.n>ssp.DO.loadt(k_loc,.ssp)#0A
#0A..UNTIL.n#3Dssp.DO#0A..{.IF.arg2#3Dtempv.DO#0A..
2{.TEST.n#3Dssp-1#0A..4THEN.{.ssp.:#3D.n#0A..11h1!a
rg1,.h2!arg1,.h3!arg1.:#3D.h1!arg2,.h2!arg2,.ssp-1#0A
..11h1!arg2,.h2!arg2,.h3!arg2.:#3D.k_loc,.ssp-2,.ss
p-2#0A..9}#0A..4ELSE.initstack(n)#0A..4RETURN#0A..2
}#0A#0A..2arg1,.arg2,.ssp.:#3D.arg1-3,.arg2-3,.ssp-
1#0A..}#0A}#0A#0A//.Store.all.SS.items.from.S1.to.S
2.in.their.true#0A//.locations.on.the.stack#2E#0A//
.It.may.corrupt.both.registers.A.and.B#2E#0AAND.sto
re(s1,.s2).BE.FOR.p.#3D.tempv.TO.arg1.BY.3.DO#0A..1
9{.LET.s.#3D.h3!p#0A..21IF.s>s2.RETURN#0A..21IF.s>#3D
s1.DO.storet(p)#0A..19}#0A#0AAND.scan().BE#0A{.IF.d
ebug>1.DO.{.writef("OP#3D%t5.PND#3D%t5.",.opname(op
),.opname(pendingop))#0A..16dboutput()#0A..14}#0A..
SWITCHON.op.INTO#0A#0A..{.DEFAULT:..3cgerror("Bad.O
CODE.op.%n.%s",.op,.opname(op))#0A..15ENDCASE#0A#0A
..2CASE.s_fnum:#0A..13{.LET.mantissa.#3D.rdn()#0A..
15LET.exponent.#3D.rdn()#0A..15cgpendingop()#0A..15
loadt(k_numb,.mantissa)#0A..15loada(arg1)#0A..15gen
fb(f_fltop,.fl_mk,.exponent)#0A..15forget_a()#0A..1
5ENDCASE#0A..13}#0A#0A..2CASE.s_selld:#0A..13{.LET.
len.#3D.rdn()#0A..15LET.sh..#3D.rdn()#0A//writef("s
elld:.calling.cgpendingop*n")#0A..15cgpendingop()#0A
//writef("selld:.calling.loada*n")#0A..15loada(arg1
)#0A//writef("selld:.calling.genbb*n")#0A..15genbb(
f_selld,.len,.sh)#0A..15forget_a()#0A..15ENDCASE#0A
..13}#0A#0A..2CASE.s_selst:#0A..13{.LET.sfop.#3D.rd
n()#0A..15LET.len..#3D.rdn()#0A..15LET.sh..1#3D.rdn
()#0A..15cgpendingop()#0A..15loadba(arg2,.arg1)#0A.
.15genfbb(f_selst,.sfop,.len,.sh)#0A..15forgetallva
rs()#0A..15stack(ssp-2)#0A..15ENDCASE#0A..13}#0A#0A
..2CASE.0:..4RETURN#0A..4#0A..2CASE.s_needs:#0A..13
{.LET.n.#3D.rdn()..//.Ignore.NEEDS.directives#2E#0A
..15FOR.i.#3D.1.TO.n.DO.rdn()#0A..15ENDCASE#0A..13}
#0A#0A..2CASE.s_lp:..1loadt(k_loc,..1rdn());..1ENDC
ASE#0A..2CASE.s_lg:..1loadt(k_glob,..rdgn());..ENDC
ASE#0A..2CASE.s_ll:..1loadt(k_lab,..1rdl());..1ENDC
ASE#0A..2CASE.s_lf:..1loadt(k_fnlab,.rdl());..1ENDC
ASE#0A..2CASE.s_ln:..1loadt(k_numb,..rdn());..1ENDC
ASE#0A#0A..2CASE.s_lstr:.cgstring(rdn());..7ENDCASE
#0A#0A..2CASE.s_true:.loadt(k_numb,.-1);..5ENDCASE#0A
..2CASE.s_false:loadt(k_numb,..0000);..5ENDCASE#0A#0A
..2CASE.s_llp:..loadt(k_lvloc,..rdn());..ENDCASE#0A
..2CASE.s_llg:..loadt(k_lvglob,.rdgn());.ENDCASE#0A
..2CASE.s_ll1:..loadt(k_lvlab,..rdl());..ENDCASE#0A
#0A..2CASE.s_sp:..1storein(k_loc,..rdn());..ENDCASE
#0A..2CASE.s_sg:..1storein(k_glob,.rdgn());.ENDCASE
#0A..2CASE.s_sl:..1storein(k_lab,..rdl());..ENDCASE
#0A#0A..2CASE.s_stind:cgstind();.ENDCASE#0A#0A..2CA
SE.s_rv:..1cgrv();.ENDCASE#0A#0A..2CASE.s_float:.CA
SE.s_fix:.CASE.s_fneg:.CASE.s_fabs:#0A..2CASE.s_not
:CASE.s_neg:CASE.s_abs:#0A..2CASE.s_fmul:.CASE.s_fd
iv:#0A..2CASE.s_fadd:CASE.s_fsub:#0A..2CASE.s_feq:.
CASE.s_fne:#0A..2CASE.s_fls:CASE.s_fgr:CASE.s_fle:C
ASE.s_fge:#0A#0A..2CASE.s_mul:CASE.s_div:CASE.s_rem
:#0A..2CASE.s_add:CASE.s_sub:#0A..2CASE.s_eq:.CASE.
s_ne:#0A..2CASE.s_ls:CASE.s_gr:CASE.s_le:CASE.s_ge:
#0A..2CASE.s_lshift:CASE.s_rshift:#0A..2CASE.s_loga
nd:CASE.s_logor:CASE.s_eqv:CASE.s_neqv:#0A..15cgpen
dingop()#0A..15pendingop.:#3D.op#0A..15ENDCASE#0A#0A
..2CASE.s_jt:..1cgjump(TRUE,.rdl());..ENDCASE#0A#0A
..2CASE.s_jf:..1cgjump(FALSE,.rdl());.ENDCASE#0A#0A
..2CASE.s_goto:.cgpendingop()#0A..15store(0,.ssp-2)
#0A..15TEST.h1!arg1#3Dk_fnlab#0A..15THEN.genr(f_j,.
h2!arg1)#0A..15ELSE.{.loada(arg1);.gen(f_goto).}#0A
..15stack(ssp-1)#0A..15incode.:#3D.FALSE#0A..15//.T
his.is.a.good.place.to.deal.with#0A..15//.some.outs
tanding.forward.refs#2E#0A..15chkrefs(50)#0A..15END
CASE#0A#0A..2CASE.s_lab:..cgpendingop()#0A..15UNLES
S.incode.DO.chkrefs(30)#0A..15store(0,.ssp-1)#0A..1
5setlab(rdl())#0A..15forgetall()#0A..15incode.:#3D.
procdepth>0#0A..15ENDCASE#0A#0A..2CASE.s_query:load
t(k_loc,.ssp);..12ENDCASE#0A#0A..2CASE.s_stack:cgpe
ndingop();.stack(rdn());..2ENDCASE#0A#0A..2CASE.s_s
tore:cgpendingop();.store(0,.ssp-1);.ENDCASE#0A#0A.
.2CASE.s_entry:#0A..13{.LET.l.#3D.rdl()#0A..15LET.n
.#3D.rdn()#0A..15cgentry(l,.n)#0A..15procdepth.:#3D
.procdepth.+.1#0A..15ENDCASE#0A..13}#0A#0A..2CASE.s
_save:#0A..13{.LET.n.#3D.rdn()#0A..15initstack(n)#0A
..15IF.n>3.DO.addinfo_a(k_loc,.3)#0A..15ENDCASE#0A.
.13}#0A#0A..2CASE.s_fnap:#0A..2CASE.s_rtap:.cgapply
(op,.rdn())#0A..15ENDCASE#0A#0A..2CASE.s_rtrn:.cgpe
ndingop()#0A..15gen(f_rtn)#0A..15incode.:#3D.FALSE#0A
..15ENDCASE#0A..17#0A..2CASE.s_fnrn:.cgpendingop()#0A
..15loada(arg1)#0A..15gen(f_rtn)#0A..15stack(ssp-1)
#0A..15incode.:#3D.FALSE#0A..15ENDCASE#0A#0A..2CASE
.s_endproc:#0A..15cgstatics()#0A..15procdepth.:#3D.
procdepth.-.1#0A..15ENDCASE#0A#0A..2CASE.s_res:#0A.
.2CASE.s_jump:#0A..13{.LET.l.#3D.rdl()#0A#0A..15cgp
endingop()#0A..15store(0,.ssp-2)#0A..15TEST.op#3Ds_
jump#0A..15THEN.storet(arg1)#0A..15ELSE.{.loada(arg
1);.stack(ssp-1).}#0A#0A..15{.op.:#3D.rdn()#0A..17U
NLESS.op#3Ds_stack.BREAK#0A..17stack(rdn())#0A..15}
.REPEAT#0A#0A..15TEST.op#3Ds_lab#0A..15THEN.{.LET.m
.#3D.rdl()#0A..22UNLESS.l#3Dm.DO.genr(f_j,.l)#0A..2
2setlab(m)#0A..22forgetall()#0A..22incode.:#3D.proc
depth>0#0A..22op.:#3D.rdn()#0A..20}#0A..15ELSE.{.ge
nr(f_j,.l)#0A..22incode.:#3D.FALSE#0A..22//.Deal.wi
th.some.refs#2E#0A..22chkrefs(50)#0A..20}#0A#0A..15
LOOP#0A..13}#0A#0A..2//.rstack.always.occurs.immedi
ately.after.a.lab.statement#0A..2//.at.a.time.when.
cgpendingop().and.store(0,.ssp-2).have#0A..2//.been
.called#2E#0A..2CASE.s_rstack:#0A..15stack(rdn());.
loadt(k_a,.0);.ENDCASE#0A#0A..2CASE.s_finish:..//.C
ompile.code.for:..stop(0)#2E#0A..13{.LET.k.#3D.ssp#0A
..15stack(ssp+3)#0A..15loadt(k_numb,.0)#0A..15loadt
(k_numb,.0)#0A..15loadt(k_glob,.gn_stop)#0A..15cgap
ply(s_rtap,.k)..2//.Simulate.the.call:.stop(0,.0)#0A
..15ENDCASE#0A..13}#0A#0A..2CASE.s_switchon:#0A..15
cgswitch();.ENDCASE#0A#0A..2CASE.s_getbyte:#0A..15c
gpendingop()#0A..15loadba(arg2,.arg1)#0A..15gen(f_g
byt)#0A..15forget_a()#0A..15lose1(k_a,.0)#0A..15END
CASE#0A#0A..2CASE.s_putbyte:#0A..15cgpendingop()#0A
#0A..15//.First.move.arg3.to.C#2E#0A..13{.LET.arg3.
#3D.arg2.-.3#0A..15TEST.arg3-tempv.<.0.#0A..15THEN.
{.loadt(k_loc,.ssp-3)#0A..22loada(arg1)#0A..22gen(f
_atc)#0A..22stack(ssp-1)#0A..20}#0A..15ELSE.{.TEST.
inreg_b(h1!arg3,.h2!arg3)#0A..22THEN..2gen(f_btc)#0A
..22ELSE.{.loada(arg3)#0A..29gen(f_atc)#0A..27}#0A.
.22h1!arg3.:#3D.k_c#0A..20}#0A..15TEST.loadboth(arg
2,.arg1)#3Dswapped#0A..15THEN.gen(f_xpbyt)#0A..15EL
SE.gen(f_pbyt)#0A..15forgetallvars()#0A..15stack(ss
p-3)#0A..15ENDCASE#0A..13}#0A#0A..2CASE.s_global:#0A
..15cgglobal(rdn());.RETURN#0A#0A..2CASE.s_datalab:
#0A..13{.LET.lab.#3D.rdl().#0A..15op.:#3D.rdn()#0A#0A
..15WHILE.op#3Ds_itemn.DO#0A..15{.LET.t.#3D.getblk(
0,lab,0)#0A..17LET.bv.#3D.@t!2#0A..17LET.val.#3D.rd
n()#0A..17LET.w.#3D.val#0A..17//.Copy.the.bytes.of.
val.into.bv.in#0A..17//.little-ender.order#0A..17FO
R.i.#3D.0.TO.3.DO.//.Deal.with.ls.4.bytes#0A..17{.b
v%i.:#3D.w#0A..19w.:#3D.w>>0008#0A..17}#0A#0A..17//
.For.64-bit.target.deal.with.the.senior.4.bytes#0A.
.17IF.t64.DO#0A..17{.TEST.c64#0A..19THEN.w.:#3D.val
>>00032#0A..19ELSE.w.:#3D.val<0.->.-1,.0.//.Sign.ex
tend#0A..19FOR.i.#3D.4.TO.7.DO#0A..19{.bv%i.:#3D.w#0A
..21w.:#3D.w>>0008#0A..19}#0A..17}#0A#0A..17!nliste
.:#3D.t#0A..17nliste,.lab,.op.:#3D.!nliste,.0,.rdn(
)#0A..15}#0A..15LOOP#0A..13}#0A..}#0A#0A..op.:#3D.r
dn()#0A}.REPEAT#0A#0A1//.Compiles.code.to.deal.with
.any.pending.op#2E#0ALET.cgpendingop().BE#0A{.LET.f
,.flop.#3D.0,.0#0A..LET.sym.#3D.TRUE#0A..LET.pndop.
#3D.pendingop#0A..pendingop.:#3D.s_none#0A#0A..SWIT
CHON.pndop.INTO#0A..{.DEFAULT:..4cgerror("Bad.pendi
ngop.%s",.opname(pndop))#0A#0A..2CASE.s_none:..RETU
RN#0A#0A..2CASE.s_float:.loada(arg1)#0A..16genflt(f
l_float)#0A..16forget_a()#0A..16RETURN#0A#0A..2CASE
.s_fix:..1loada(arg1)#0A..16genflt(fl_fix)#0A..16fo
rget_a()#0A..16RETURN#0A#0A..2CASE.s_fabs:..loada(a
rg1)#0A..16genflt(fl_abs)#0A..16forget_a()#0A..16RE
TURN#0A#0A..2CASE.s_abs:..1loada(arg1)#0A..16chkref
s(3)#0A..16genb(jfn0(f_jgr),.2).//.Conditionally.sk
ip#0A..16gen(f_neg)..9//.over.this.NEG.instruction#2E
#0A..16forget_a()#0A..16RETURN#0A#0A..2CASE.s_fneg:
..loada(arg1)#0A..16genflt(fl_neg)#0A..16forget_a()
#0A..16RETURN#0A#0A..2CASE.s_neg:..1loada(arg1)#0A.
.16gen(f_neg)#0A..16forget_a()#0A..16RETURN#0A#0A..
2CASE.s_not:..1loada(arg1)#0A..16gen(f_not)#0A..16f
orget_a()#0A..16RETURN#0A#0A..2CASE.s_feq:..1flop.:
#3D.fl_eq;.GOTO.case_feq#0A..2CASE.s_fne:..1flop.:#3D
.fl_ne;.GOTO.case_feq#0A..2CASE.s_fls:..1flop.:#3D.
fl_ls;.GOTO.case_feq#0A..2CASE.s_fgr:..1flop.:#3D.f
l_gr;.GOTO.case_feq#0A..2CASE.s_fle:..1flop.:#3D.fl
_le;.GOTO.case_feq#0A..2CASE.s_fge:..1flop.:#3D.fl_
ge;.GOTO.case_feq#0Acase_feq:..7loadba(arg2,.arg1)#0A
..16genflt(flop)#0A..16lose1(k_a,.0)#0A..16forget_a
()#0A..16forget_b()#0A..16RETURN#0A#0A..2CASE.s_eq:
.CASE.s_ne:#0A..2CASE.s_ls:.CASE.s_gr:#0A..2CASE.s_
le:.CASE.s_ge:#0A..16f.:#3D.prepj(jmpfn(pndop))#0A.
.16chkrefs(4)#0A..16genb(f,.2)..2//.Jump.to..2--1#0A
..16gen(f_fhop)..1//..13|#0A..16gen(f_lm1)..2//.thi
s.point..<-#0A..16lose1(k_a,.0)#0A..16forget_a()#0A
..16forget_b()#0A..16RETURN#0A#0A..2CASE.s_sub:..1U
NLESS.k_numb#3Dh1!arg1.DO#0A..16{.f,.sym.:#3D.f_sub
,.FALSE#0A..18ENDCASE#0A..16}#0A..16h2!arg1.:#3D.-h
2!arg1#0A#0A..2CASE.s_add:..1cgadd();.RETURN#0A#0A.
.2CASE.s_fmul:..f.:#3D.fl_mul;..GOTO.case_fmul#0A..
2CASE.s_fadd:..f.:#3D.fl_add;..GOTO.case_fmul#0A#0A
case_fmul:..6loadboth(arg2,.arg1)#0A..16genflt(f)#0A
..16forget_a()#0A..16lose1(k_a,.0)#0A..16RETURN#0A#0A
..2CASE.s_fdiv:..f.:#3D.fl_div;..1GOTO.case_fdiv#0A
..2CASE.s_fsub:..f.:#3D.fl_sub;.GOTO.case_fdiv#0A#0A
case_fdiv:..6loadba(arg2,.arg1)#0A..16genflt(f)#0A.
.16forget_a()#0A..16lose1(k_a,.0)#0A..16RETURN#0A#0A
..2CASE.s_mul:..1f..4:#3D.f_mul;..6ENDCASE#0A..2CAS
E.s_div:..1f,.sym.:#3D.f_div,.FALSE;.ENDCASE#0A..2C
ASE.s_rem:..1f,.sym.:#3D.f_rem,.FALSE;.ENDCASE#0A..
2CASE.s_lshift:f,.sym.:#3D.f_lsh,.FALSE;.ENDCASE#0A
..2CASE.s_rshift:f,.sym.:#3D.f_rsh,.FALSE;.ENDCASE#0A
..2CASE.s_logand:f..4:#3D.f_and;..6ENDCASE#0A..2CAS
E.s_logor:.f..4:#3D.f_or;..7ENDCASE#0A..2CASE.s_eqv
:#0A..2CASE.s_neqv:..f..4:#3D.f_xor;..6ENDCASE#0A..
}#0A#0A..TEST.sym.THEN.loadboth(arg2,.arg1)#0A..9EL
SE.loadba(arg2,.arg1)#0A#0A..gen(f)#0A..forget_a()#0A
..IF.pndop#3Ds_eqv.THEN.gen(f_not)#0A#0A..lose1(k_a
,.0)#0A}#0A#0ALET.loada(x)..1BE.{.loadval(x,.FALSE)
;.setba(0,.x).}#0A#0AAND.push(x,.y).BE.{.loadval(y,
.TRUE);..setba(x,.y).}#0A#0AAND.loadval(x,.pushing)
.BE..//.ONLY.called.from.loada.and.push#2E#0A//.Loa
d.compiles.code.to.have.the.following.effect:#0A//.
If.pushing#3DTRUE..2B.:#3D.A;.A.:#3D.<x>#2E#0A//.If
.pushing#3DFALSE..1B.:#3D.?;.A.:#3D.<x>#2E#0A{.LET.
k,.n.#3D.h1!x,.h2!x#0A#0A..UNLESS.pushing.|.k#3Dk_a
.DO..//.Dump.A.register.if.necessary#2E#0A..2FOR.t.
#3D.arg1.TO.tempv.BY.-3.IF.h1!t#3Dk_a.DO.{.storet(t
);.BREAK.}#0A#0A..TEST.inreg_a(k,.n).THEN.setba(0,.
x)#0A..19ELSE.IF.inreg_b(k,.n).DO.{.genxch(0,.0)#0A
..46RETURN#0A..44}#0A..SWITCHON.h1!x.INTO#0A..{.DEF
AULT:..cgerror("in.loada.%n",.k)#0A#0A..2CASE.k_a:.
IF.pushing.UNLESS.inreg_b(k,.n).DO.genatb(0,.0)#0A.
.12RETURN#0A#0A..2CASE.k_numb:#0A..12cgloadk(n)#0A.
.12RETURN#0A#0A..2CASE.k_loc:..genlp(n);..6ENDCASE#0A
..2CASE.k_glob:.geng(f_lg,.n);..1ENDCASE#0A..2CASE.
k_lab:..genr(f_ll,.n);..1ENDCASE#0A..2CASE.k_fnlab:
genr(f_lf,.n);..1ENDCASE#0A#0A..2CASE.k_lvloc:TEST.
0<#3Dn<#3D255#0A..15THEN.genb(f_llp,.n)#0A..15ELSE.
TEST.0<#3Dn<#3D#23xFF2#0A..20THEN.genh(f_llph,.n)#0A
..20ELSE.genw(f_llpw,.n)#0A..15ENDCASE#0A#0A..2CASE
.k_lvglob:geng(f_llg,.n);.ENDCASE#0A..2CASE.k_lvlab
:.genr(f_ll1,.n);.ENDCASE#0A..2CASE.k_loc0:..gen(f_
l0p0+n);..ENDCASE#0A..2CASE.k_loc1:..gen(f_l1p0+n);
..ENDCASE#0A..2CASE.k_loc2:..gen(f_l2p0+n);..ENDCAS
E#0A..2CASE.k_loc3:..gen(f_l3p0+n);..ENDCASE#0A..2C
ASE.k_loc4:..gen(f_l4p0+n);..ENDCASE#0A..2CASE.k_gl
ob0:.geng(f_l0g,.n);.ENDCASE#0A..2CASE.k_glob1:.gen
g(f_l1g,.n);.ENDCASE#0A..2CASE.k_glob2:.geng(f_l2g,
.n);.ENDCASE#0A..}#0A#0A..//.A.loading.instruction.
has.just.been.compiled#2E#0A..pushinfo(h1!x,.h2!x)#0A
}#0A#0AAND.loadba(x,.y).BE.IF.loadboth(x,.y)#3Dswap
ped.DO.genxch(x,.y)#0A#0AAND.setba(x,.y).BE#0A{.UNL
ESS.x#3D0.DO.h1!x.:#3D.k_b#0A..UNLESS.y#3D0.DO.h1!y
.:#3D.k_a#0A}#0A#0AAND.genxch(x,.y).BE.{.gen(f_xch)
;.xchinfo();.setba(x,.y).}#0A#0AAND.genatb(x,.y).BE
.{.gen(f_atb);.atbinfo();.setba(x,.y).}#0A#0AAND.lo
adboth(x,.y).#3D.VALOF#0A//.Compiles.code.to.cause#0A
//..1either..2x.->.[B]..and..y.->.[A]#0A//..11givin
g.result.NOTSWAPPED#0A//..1or..6x.->.[A]..and..y.->
.[B]#0A//..11giving.result.SWAPPED#2E#0A//.loadboth
.only.swaps.if.this.saves.code#2E#0A{.//.First.ensu
re.that.no.other.stack.item.uses.reg.A#2E#0A..FOR.t
.#3D.tempv.TO.arg1.BY.3.DO#0A..2IF.h1!t#3Dk_a.UNLES
S.t#3Dx.|.t#3Dy.DO.storet(t)#0A#0A..{.LET.xa,.ya.#3D
.inreg_a(h1!x,.h2!x),.inreg_a(h1!y,.h2!y)#0A..2AND.
xb,.yb.#3D.inreg_b(h1!x,.h2!x),.inreg_b(h1!y,.h2!y)
#0A#0A..2IF.xb.&.ya.DO.{.setba(x,y);..13RESULTIS.no
tswapped.}#0A..2IF.xa.&.yb.DO.{.setba(y,x);..13RESU
LTIS.swapped..2}#0A..2IF.xa.&.ya.DO.{.genatb(x,y);.
.12RESULTIS.notswapped.}#0A..2IF.xb.&.yb.DO.{.genxc
h(0,y);.genatb(x,y);.RESULTIS.notswapped.}#0A..4#0A
..2IF.xa.DO.{..12push(x,y);.RESULTIS.notswapped.}#0A
..2IF.ya.DO.{..12push(y,x);.RESULTIS.swapped..2}#0A
..2IF.xb.DO.{.genxch(0,x);.push(x,y);.RESULTIS.nots
wapped.}#0A..2IF.yb.DO.{.genxch(0,y);.push(y,x);.RE
SULTIS.swapped..2}#0A..4#0A..2loada(x)#0A..2push(x,
.y)#0A..2RESULTIS.notswapped#0A..}#0A}#0A#0ALET.inr
eg_a(k,.n).#3D.VALOF#0A{.LET.p.#3D.info_a#0A..IF.k#3D
k_a.RESULTIS.TRUE#0A..UNTIL.p#3D0.DO.{.IF.k#3Dh2!p.
&.n#3Dh3!p.RESULTIS.TRUE#0A..15p.:#3D.!p#0A..13}#0A
..RESULTIS.FALSE#0A}#0A#0AAND.inreg_b(k,.n).#3D.VAL
OF#0A{.LET.p.#3D.info_b#0A..IF.k#3Dk_b.RESULTIS.TRU
E#0A..UNTIL.p#3D0.DO.{.IF.k#3Dh2!p.&.n#3Dh3!p.RESUL
TIS.TRUE#0A..15p.:#3D.!p#0A..13}#0A..RESULTIS.FALSE
#0A}#0A#0AAND.addinfo_a(k,.n).BE.info_a.:#3D.getblk
(info_a,.k,.n)#0A#0AAND.addinfo_b(k,.n).BE.info_b.:
#3D.getblk(info_b,.k,.n)#0A#0AAND.pushinfo(k,.n).BE
#0A{.forget_b()#0A..info_b.:#3D.info_a#0A..info_a.:
#3D.getblk(0,.k,.n)#0A}#0A#0AAND.xchinfo().BE#0A{.L
ET.t.#3D.info_a#0A..info_a.:#3D.info_b#0A..info_b.:
#3D.t#0A}#0A#0AAND.atbinfo().BE#0A{.LET.p.#3D.info_
a#0A..forget_b()#0A..UNTIL.p#3D0.DO.{.addinfo_b(h2!
p,.h3!p);.p.:#3D.!p.}#0A}#0A#0AAND.forget_a().BE.{.
freeblks(info_a);.info_a.:#3D.0.}#0A#0AAND.forget_b
().BE.{.freeblks(info_b);.info_b.:#3D.0.}#0A#0AAND.
forgetall().BE.{.forget_a();.forget_b().}#0A#0A//.F
orgetvar.is.called.just.after.a.simple.variable.(k,
.n).has.been#0A//.updated#2E..k.is.k_loc,.k_glob.or
.k_lab#2E..Note.that.register#0A//.infomation.about
.indirect.local.and.global.values#0A//.must.also.be
.thrown.away#2E#0AAND.forgetvar(k,.n).BE#0A{.LET.p.
#3D.info_a#0A..UNTIL.p#3D0.DO.{.IF.h2!p>#3Dk_loc0.|
.h2!p#3Dk.&.h3!p#3Dn.DO.h2!p.:#3D.k_none#0A..15p.:#3D
.!p#0A..13}#0A..p.:#3D.info_b#0A..UNTIL.p#3D0.DO.{.
IF.h2!p>#3Dk_loc0.|.h2!p#3Dk.&.h3!p#3Dn.DO.h2!p.:#3D
.k_none#0A..15p.:#3D.!p#0A..13}#0A}#0A#0AAND.forget
allvars().BE..//.Called.after.STIND,.SELST.or.PUTBY
TE#2E#0A{.LET.p.#3D.info_a#0A..UNTIL.p#3D0.DO.{.IF.
h2!p>#3Dk_loc.DO.h2!p.:#3D.k_none#0A..15p.:#3D.!p#0A
..13}#0A..p.:#3D.info_b#0A..UNTIL.p#3D0.DO.{.IF.h2!
p>#3Dk_loc.DO.h2!p.:#3D.k_none#0A..15p.:#3D.!p#0A..
13}#0A}#0A#0AAND.iszero(a).#3D.h1!a#3Dk_numb.&.h2!a
#3D0.->.TRUE,.FALSE#0A#0A//.Store.the.value.of.a.SS
.item.in.its.true.stack.location#2E#0AAND.storet(x)
.BE#0A{.LET.s.#3D.h3!x#0A..IF.h1!x#3Dk_loc.&.h2!x#3D
s.RETURN#0A..loada(x)#0A..gensp(s)#0A..forgetvar(k_
loc,.s)#0A..addinfo_a(k_loc,.s)#0A..h1!x,.h2!x.:#3D
.k_loc,.s#0A}#0A#0AAND.gensp(s).BE.TEST.3<#3Ds<#3D1
6#0A..14THEN.gen(f_sp0+s)#0A..14ELSE.TEST.0<#3Ds<#3D
255#0A..19THEN.genb(f_sp,.s)#0A..19ELSE.TEST.0<#3Ds
<#3D#23xFF2#0A..24THEN.genh(f_sph,.s)#0A..24ELSE.ge
nw(f_spw,.s)#0A#0AAND.genlp(n).BE.TEST.3<#3Dn<#3D16
#0A..14THEN.gen(f_lp0+n)#0A..14ELSE.TEST.0<#3Dn<#3D
255#0A..19THEN.genb(f_lp,.n)#0A..19ELSE.TEST.0<#3Dn
<#3D#23xFF2#0A..24THEN.genh(f_lph,.n)#0A..24ELSE.ge
nw(f_lpw,.n)#0A#0A//.Load.an.item.(K,N).onto.the.SS
#2E.It.may.move.SS.items#2E#0AAND.loadt(k,.n).BE#0A
{.cgpendingop()#0A..TEST.arg1+3#3Dtempt#0A..THEN.{.
storet(tempv)..//.SS.stack.overflow#2E#0A..7FOR.t.#3D
.tempv.TO.arg2+2.DO.t!0.:#3D.t!3#0A..5}#0A..ELSE.ar
g2,.arg1.:#3D.arg2+3,.arg1+3#0A..h1!arg1,h2!arg1,h3
!arg1.:#3D.k,n,ssp#0A..ssp.:#3D.ssp.+.1#0A..IF.maxs
sp<ssp.DO.maxssp.:#3D.ssp#0A}#0A#0A1//.Replace.the.
top.two.SS.items.by.(K,N).and.set.PENDINGOP#3DS_NON
E#2E#0AAND.lose1(k,.n).BE#0A{.ssp.:#3D.ssp.-.1#0A..
TEST.arg2#3Dtempv#0A..THEN.{.h1!arg2,h2!arg2.:#3D.k
_loc,ssp-2#0A..7h3!arg2.:#3D.ssp-2#0A..5}#0A..ELSE.
{.arg1.:#3D.arg2#0A..7arg2.:#3D.arg2-3#0A..5}#0A..h
1!arg1,.h2!arg1,.h3!arg1.:#3D.k,n,ssp-1#0A..pending
op.:#3D.s_none#0A}#0A#0AAND.swapargs().BE#0A{.LET.k
,.n.#3D.h1!arg1,.h2!arg1#0A..h1!arg1,.h2!arg1.:#3D.
h1!arg2,.h2!arg2#0A..h1!arg2,.h2!arg2.:#3D.k,.n#0A}
#0A#0AAND.cgstind().BE#0A{.LET.t.#3D.VALOF#0A..{.IF
.pendingop#3Ds_add.DO#0A..2{.IF.k_numb#3Dh1!arg2.DO
.swapargs()#0A..4IF.k_numb#3Dh1!arg1.DO#0A..4{.LET.
n.#3D.h2!arg1#0A..6IF.0<#3Dn<#3D3.DO.{.stack(ssp-1)
#0A..22pendingop.:#3D.s_none#0A..22RESULTIS.n#0A..2
0}#0A..4}#0A#0A..4IF.h1!arg2#3Dk_loc.&.3<#3Dh2!arg2
<#3D5.DO.swapargs()#0A..4IF.h1!arg1#3Dk_loc.&.3<#3D
h2!arg1<#3D5.DO#0A..4{.LET.n.#3D.h2!arg1#0A..6stack
(ssp-1)#0A..6pendingop.:#3D.s_none#0A..6RESULTIS.n+
1..//.The.codes.for.P3,.P4.and.P5#2E#0A..4}#0A#0A..
4UNLESS.arg2#3Dtempv.DO#0A..4{.LET.arg3.#3D.arg2.-.
3#0A..6IF.h1!arg3#3Dk_a.DO#0A..6{.IF.h1!arg2#3Dk_lo
c.|#0A..11h1!arg2#3Dk_glob.|#0A..11h1!arg2#3Dk_numb
.DO.swapargs()#0A..8IF.h1!arg1#3Dk_loc.|#0A..11h1!a
rg1#3Dk_glob.|#0A..11h1!arg1#3Dk_numb.DO#0A..8//.Op
timize.the.case..<arg2>!<arg1>.:#3D.<arg3>#0A..8//.
where.<arg3>.is.already.in.A#0A..8//.and.<arg1>.is.
a.local,.a.global.or.a.number#2E#0A..8{.push(arg3,.
arg2)#0A..10cgadd()..//.Compiles.an.A,.AP.or.AG.ins
tr#2E#0A..10gen(f_st)#0A..10stack(ssp-2)#0A..10forg
etallvars()#0A..10RETURN#0A..8}#0A..6}#0A..4}#0A..2
}#0A#0A..2cgpendingop()#0A..2RESULTIS.0#0A..}#0A#0A
..//.Now.compile.code.for.S!<arg1>.:#3D.<arg2>#0A..
//.where..9S.is.0,.1,.2,.3,.P3,.P4.or.P5#0A..//.dep
ending.on..2T.#3D..0000,.1,.2,.3,..0004,..0005.or..
0006#0A#0A..{.LET.k,.n.#3D.h1!arg1,.h2!arg1#0A..1#0A
..2IF.k#3Dk_glob.&.t#3D0.DO.{.loada(arg2)#0A..25gen
g(f_s0g,.n)#0A..25stack(ssp-2)#0A..25forgetallvars(
)#0A..25RETURN#0A..23}#0A#0A..2IF.k#3Dk_loc.&.3<#3D
n<#3D4.&.t<#3D1.DO.{.loada(arg2)#0A..35gen(t#3D0.->
.f_st0p0+n,#0A..46f_st1p0+n)#0A..35stack(ssp-2)#0A.
.35forgetallvars()#0A..35RETURN#0A..33}#0A#0A..2loa
dba(arg2,.arg1)#0A..2gen(f_st+t)#0A..2stack(ssp-2)#0A
..2forgetallvars()#0A..}#0A}#0A#0A//.Store.the.top.
item.of.the.SS.in.(K,N)#2E#0AAND.storein(k,.n).BE#0A
//.K.is.K_LOC,.K_GLOB.or.K_LAB#2E#0A{.cgpendingop()
#0A..loada(arg1)#0A#0A..SWITCHON.k.INTO#0A..{.DEFAU
LT:..3cgerror("in.storein.%n",.k)#0A..2CASE.k_loc:.
.gensp(n);..5ENDCASE#0A..2CASE.k_glob:.geng(f_sg,.n
);..ENDCASE#0A..2CASE.k_lab:..genr(f_sl,.n);..ENDCA
SE#0A..}#0A..forgetvar(k,.n)#0A..addinfo_a(k,.n)#0A
..stack(ssp-1)#0A}#0A#0ALET.cgrv().BE#0A{.LET.t.#3D
.VALOF#0A..{.IF.pendingop#3Ds_add.DO#0A..2{.IF.k_nu
mb#3Dh1!arg2.DO.swapargs()#0A..4IF.k_numb#3Dh1!arg1
.DO#0A..4{.LET.n.#3D.h2!arg1#0A..6IF.0<#3Dn<#3D6.DO
.{.stack(ssp-1)#0A..22pendingop.:#3D.s_none#0A..22R
ESULTIS.n#0A..20}#0A..4}#0A#0A..4IF.h1!arg2#3Dk_loc
.&.3<#3Dh2!arg2<#3D7.DO.swapargs()#0A..4IF.h1!arg1#3D
k_loc.&.3<#3Dh2!arg1<#3D7.DO.{.LET.n.#3D.h2!arg1#0A
..42stack(ssp-1)#0A..42pendingop.:#3D.s_none#0A..42
RESULTIS.10.+.n#0A..40}#0A..2}#0A..2cgpendingop()#0A
..2RESULTIS.0#0A..}#0A#0A..//.Now.compile.code.for.
S!<arg1>#0A..//.where..8S.is.0,#2E#2E1,.6,.P3,#2E#2E
1,.P7#0A..//.depending.on..1T.#3D..0000,#2E#2E1,.6,
.13,#2E#2E1,.17#0A#0A..LET.k,.n.#3D.h1!arg1,.h2!arg
1#0A..1#0A..IF.k#3Dk_glob.&.0<#3Dt<#3D2.DO.{.h1!arg
1.:#3D.k_glob0.+.t;.RETURN.}#0A#0A..IF.k#3Dk_loc.&.
n>#3D3.DO#0A..2IF.t#3D0.&.n<#3D12.|#0A..5t#3D1.&.n<
#3D6..|#0A..5t#3D2.&.n<#3D5..|#0A..5t#3D3.&.n<#3D4.
.|#0A..5t#3D4.&.n<#3D4..DO.{.h1!arg1.:#3D.k_loc0.+.
t;.RETURN.}#0A#0A..loada(arg1)#0A..TEST.t<#3D6.THEN
.gen(f_rv+t)#0A..10ELSE.gen(f_rvp0.+.t.-.10)#0A..fo
rget_a()#0A..h1!arg1,.h2!arg1.:#3D.k_a,.0#0A}#0A#0A
AND.cgadd().BE#0A//.Compiles.code.to.compute.<arg2>
.+.<arg1>#2E#0A//.It.does.not.look.at.PENDINGOP#2E#0A
#0A{.IF.iszero(arg1).DO.{.stack(ssp-1);.RETURN.}#0A
#0A..IF.iszero(arg2).DO#0A..{.IF.h2!arg1#3Dssp-1.&#0A
..5(h1!arg1#3Dk_loc.|.k_loc0<#3Dh1!arg1<#3Dk_loc4).
DO.loada(arg1)#0A..2lose1(h1!arg1,.h2!arg1)#0A..2RE
TURN#0A..}#0A#0A..TEST.inreg_a(h1!arg1,.h2!arg1)#0A
..THEN.loada(arg1)#0A..ELSE.IF.inreg_a(h1!arg2,.h2!
arg2).DO.loada(arg2)#0A#0A..IF.h1!arg1#3Dk_a.DO.swa
pargs()#0A#0A..IF.h1!arg2#3Dk_loc.&.3<#3Dh2!arg2<#3D
12.DO.swapargs()#0A..IF.h1!arg1#3Dk_loc.&.3<#3Dh2!a
rg1<#3D12.DO.{.loada(arg2)#0A..39gen(f_ap0.+.h2!arg
1)#0A..39forget_a()#0A..39lose1(k_a,.0)#0A..39RETUR
N#0A..37}#0A#0A..IF.h1!arg2#3Dk_numb.&.-4<#3Dh2!arg
2<#3D5.DO.swapargs()#0A..IF.h1!arg1#3Dk_numb.&.-4<#3D
h2!arg1<#3D5.DO.{.loada(arg2)#0A..40cgaddk(h2!arg1)
#0A..40lose1(k_a,.0)#0A..40RETURN#0A..38}#0A#0A..IF
.h1!arg2#3Dk_loc.DO.swapargs()#0A..IF.h1!arg1#3Dk_l
oc.DO#0A..{.LET.n.#3D.h2!arg1#0A..2loada(arg2)#0A..
2TEST.3<#3Dn<#3D12.THEN.gen(f_ap0.+.n)#0A..16ELSE.T
EST.0<#3Dn<#3D255#0A..21THEN.genb(f_ap,.n)#0A..21EL
SE.TEST.0<#3Dn<#3D#23xFF2#0A..26THEN.genh(f_aph,.n)
#0A..26ELSE.genw(f_apw,.n)#0A..2forget_a()#0A..2los
e1(k_a,.0)#0A..2RETURN#0A..}#0A#0A..IF.h1!arg2#3Dk_
glob.DO.swapargs()#0A..IF.h1!arg1#3Dk_glob.DO.{.loa
da(arg2)#0A..23geng(f_ag,.h2!arg1)#0A..23forget_a()
#0A..23lose1(k_a,.0)#0A..23RETURN#0A..21}#0A#0A..IF
.h1!arg2#3Dk_numb.DO.swapargs()#0A..IF.h1!arg1#3Dk_
numb.DO.{.LET.n.#3D.h2!arg1#0A..23loada(arg2)#0A..2
3cgaddk(n)#0A..23lose1(k_a,.0)#0A..23RETURN#0A..21}
#0A..loadboth(arg2,.arg1)#0A..gen(f_add)#0A..forget
_a()#0A..lose1(k_a,.0)#0A}#0A#0AAND.cgloadk(n).BE#0A
{.TEST.-1<#3Dn<#3D10#0A..THEN.gen(f_l0+n)#0A..ELSE.
TEST.0<#3Dn<#3D255#0A..5THEN.genb(f_l,.n)#0A..5ELSE
.TEST.-255<#3Dn<#3D0#0A..10THEN.genb(f_lm,.-n)#0A..
10ELSE.TEST.0<#3Dn<#3D#23xFF2#0A..15THEN.genh(f_lh,
.n)#0A..15ELSE.TEST.-#23xFF2<#3Dn<#3D0#0A..20THEN.g
enh(f_lmh,.-n)#0A..20ELSE.genw(f_lw,.n)#0A..pushinf
o(k_numb,.n)#0A}#0A#0AAND.cgaddk(k).BE.UNLESS.k#3D0
.DO..//.Compile.code.to.add.k.to.A#2E#0A{.TEST.-4<#3D
k<#3D5#0A..THEN.TEST.k<0.THEN.gen(f_s0.-.k)#0A..14E
LSE.gen(f_a0.+.k)#0A..ELSE.TEST.-255<#3Dk<#3D255#0A
..5THEN.TEST.k>0.THEN.genb(f_a,.k)#0A..19ELSE.genb(
f_s,.-k)#0A..5ELSE.TEST.0<#3Dk<#3D#23xFF2#0A..10THE
N.genh(f_ah,.k)#0A..10ELSE.TEST.-#23xFF2<#3Dk<#3D0#0A
..15THEN.genh(f_sh,.-k)#0A..15ELSE.genw(f_aw,.k)#0A
..forget_a()#0A}#0A#0AAND.cgglobal(n).BE#0A{.incode
.:#3D.FALSE#0A..cgstatics()#0A..chkrefs(512)..1//.D
eal.with.ALL.outstanding.refs#2E#0A..align(wordbyte
len)#0A..codew(0,.0)..5//.Compile.Global.initialisa
tion.data#2E#0A..FOR.i.#3D.1.TO.n.DO#0A..{.codew(0,
.rdgn())#0A..2codew(0,.labv!rdl())#0A..}#0A..codew(
0,.maxgn)#0A}#0A#0A1AND.cgentry(l,.n).BE#0A{.MANIFE
ST.{.upb#3D11.}.//.Max.length.of.entry.name#0A..LET
.v.#3D.VEC.upb/bytesperword#0A..v%0.:#3D.upb#0A..rd
name(n,.v).//.Pack.up.to.11.character.of.the.name.i
nto.v#0A#0A..chkrefs(80)..//.Deal.with.some.forward
.refs#2E#0A..align(wordbytelen)#0A..IF.naming.DO#0A
..{.TEST.c64#0A..2THEN.codew(..entryword>>00032,..e
ntryword)#0A..2ELSE.codew(-(entryword>>00031),.entr
yword).//.Sign.extend#0A..2codestr(v)..1//.Compile.
the.words.containing.the.packed#0A..15//.string.cha
racters#0A..}#0A#0A..IF.debug>0.DO.writef("//.Entry
.to:..1%s*n",.v)#0A..setlab(l)#0A..incode.:#3D.TRUE
#0A..forgetall()#0A}#0A#0A//.Function.or.routine.ca
ll#2E#0AAND.cgapply(op,.k).BE#0A{.LET.sa.#3D.k+3../
/.Stack.address.of.first.arg.(if.any)#2E#0A..AND.a1
.#3D.0..2//.SS.item.for.first.arg.if.found#2E#0A#0A
..cgpendingop()#0A#0A//.Deal.with.non.args#2E#0A..F
OR.t.#3D.tempv.TO.arg2.BY.3.DO.{.IF.h3!t>#3Dk.BREAK
#0A..32IF.h1!t#3Dk_a.DO.storet(t)#0A..30}#0A#0A//.D
eal.with.args.2,.3.#2E#2E1#0A..FOR.t.#3D.tempv.TO.a
rg2.BY.3.DO#0A..{.LET.s.#3D.h3!t#0A..2IF.s#3Dsa.DO#0A
..2{.a1.:#3D.t..//.We.have.found.the.SS.item.for.th
e.first.arg#2E#0A..4IF.h1!t#3Dk_a.&.t+3#3Darg2.DO#0A
..4//.Two.argument.call.with.the.first.arg.already.
in.A#2E#0A..4{.push(t,.arg2)#0A..6storet(arg2)..2//
.Store.second.arg#2E#0A..6genxch(0,.t)..2//.Restore
.first.arg.back.to.A#2E#0A..6BREAK#0A..4}#0A..2}#0A
..2IF.s>sa.DO.storet(t)#0A..}#0A#0A..//.Move.first.
arg.(if.any).into.A#2E#0A..IF.sa<ssp-1.TEST.a1#3D0#0A
..12THEN.genlp(sa)..//.First.arg.exists.but.not.in.
SS#2E#0A..12ELSE.loada(a1)..//.First.arg.exists.in.
SS#0A#0A..//.First.arg.(if.any).is.now.in.A#2E#0A#0A
..TEST.h1!arg1#3Dk_glob.&.3<#3Dk<#3D11#0A..THEN.gen
g(f_k0g+k,.h2!arg1)#0A..ELSE.{.push(a1,.arg1)#0A..7
//.First.arg.(if.any).is.now.in.B#0A..7//.and.the.p
rocedure.address.is.in.A#2E#0A..7TEST.3<#3Dk<#3D11#0A
..7THEN.gen(f_k0+k)#0A..7ELSE.TEST.0<#3Dk<#3D255#0A
..12THEN.genb(f_k,.k)#0A..12ELSE.TEST.0<#3Dk<#3D#23
xFF2#0A..17THEN.genh(f_kh,.k)#0A..17ELSE.genw(f_kw,
.k)#0A..4}#0A#0A..forgetall()#0A..stack(k)#0A..IF.o
p#3Ds_fnap.DO.loadt(k_a,.0)#0A}#0A#0A//.Used.for.OC
ODE.operators.JT.and.JF#2E#0AAND.cgjump(b,l).BE#0A{
.LET.f.#3D.jmpfn(pendingop)#0A..IF.f#3D0.DO.{.loadt
(k_numb,0);.f.:#3D.f_jne.}#0A..pendingop.:#3D.s_non
e#0A..UNLESS.b.DO.f.:#3D.compjfn(f)#0A..store(0,ssp
-3)#0A..genr(prepj(f),l)#0A..stack(ssp-2)#0A}#0A#0A
AND.jmpfn(op).#3D.VALOF.SWITCHON.op.INTO#0A{.DEFAUL
T:..RESULTIS.0#0A..CASE.s_eq:.RESULTIS.f_jeq#0A..CA
SE.s_ne:.RESULTIS.f_jne#0A..CASE.s_ls:.RESULTIS.f_j
ls#0A..CASE.s_gr:.RESULTIS.f_jgr#0A..CASE.s_le:.RES
ULTIS.f_jle#0A..CASE.s_ge:.RESULTIS.f_jge#0A}#0A#0A
AND.jfn0(f).#3D.f+2.//.Change.F_JEQ.into.F_JEQ0..et
c#2E#2E1#0A#0AAND.revjfn(f).#3D.f#3Df_jls.->.f_jgr,
#0A..14f#3Df_jgr.->.f_jls,#0A..14f#3Df_jle.->.f_jge
,#0A..14f#3Df_jge.->.f_jle,#0A..14f#0A#0AAND.compjf
n(f).#3D.f#3Df_jeq.->.f_jne,#0A..15f#3Df_jne.->.f_j
eq,#0A..15f#3Df_jls.->.f_jge,#0A..15f#3Df_jge.->.f_
jls,#0A..15f#3Df_jgr.->.f_jle,#0A..15f#3Df_jle.->.f
_jgr,#0A..15f#0A#0AAND.prepj(f).#3D.VALOF..//.Retur
ns.the.appropriate.m/c.fn#2E#0A{.IF.iszero(arg2).DO
.{.swapargs();.f.:#3D.revjfn(f).}#0A..IF.iszero(arg
1).DO.{.loada(arg2);.RESULTIS.jfn0(f).}#0A..IF.load
both(arg2,.arg1)#3Dswapped.RESULTIS.revjfn(f)#0A..R
ESULTIS.f#0A}#0A#0A//.Compiles.code.for.SWITCHON#2E
#0ALET.cgswitch().BE#0A{.LET.n.#3D.rdn()..3//.Numbe
r.of.cases#2E#0A..LET.dlab.#3D.rdl()..//.Default.la
bel#2E#0A#0A..//.Read.and.sort.(K,L).pairs#2E#0A..F
OR.i.#3D.1.TO.n.DO#0A..{.LET.k.#3D.rdn()#0A..2LET.l
.#3D.rdl()#0A..2LET.j.#3D.i-1#0A..2UNTIL.j#3D0.DO..
{.IF.k.>.casek!j.BREAK#0A..18casek!(j+1),.casel!(j+
1).:#3D.casek!j,.casel!j#0A..18j.:#3D.j.-.1#0A..16}
#0A..2casek!(j+1),.casel!(j+1).:#3D.k,.l#0A..}#0A#0A
..cgpendingop()#0A..store(0,.ssp-2)#0A..loada(arg1)
#0A..stack(ssp-1)#0A..switcht(1,.n,.dlab,.FALSE,.0)
#0A}#0A#0AAND.prcases(p,.q).BE#0A{.writef("*nprcase
s:.p#3D%n.q#3D%n*n",.p,.q)#0A..FOR.i.#3D.p.TO.q.DO#0A
..{.IF.(i-p).MOD.8.#3D.0.DO.newline()#0A..2writef("
.%11i",.casek!i)#0A..}#0A..newline()#0A}#0A#0A//.Co
de.has.already.been.compiled.to.set.either.A.or.B.t
o.the.#0A//.value.of.the.switch.expression#2E#0A//.
Compile.code.to.switch.on.cases.in.region.p#2E#2Eq.
with.default#0A//.label.dlab#2E#0AAND.switcht(p,.q,
.dlab,.inba,.aval).BE#0A{.//.If.inba#3DTRUE,..the.s
witch.value.is.in.B.and.A#3Daval#2E#0A..//.If.inba#3D
FALSE,.the.switch.value.is.in.A#2E#0A..//.Compile.c
ode.for.cases.in.the.region.region.p.to.q#0A..//.an
d.default.label.dlab#2E#0A..LET.n.#3D.q-p+1..2//.Nu
mber.of.cases.in.region.p#2E#2Eq#0A..LET.r.#3D.(p+q
)/2#0A..LET.s.#3D.r#0A#0A..//.If.no.cases.goto.defa
ult.label#0A..IF.n#3D0.DO.{.genr(f_j,.dlab);.RETURN
.}#0A#0A..IF.n#3D1.DO#0A..{.//.There.is.just.one.ca
se.so.use.an.equality.test#2E#0A..2//.Set.B.#3D.swi
tch.value.and.A.#3D.casek!p#0A..2TEST.inba#0A..2THE
N.{.cgaddk(casek!p-aval)#0A..9aval.:#3D.casek!p#0A.
.7}.#0A..2ELSE.{.inba,.aval.:#3D.TRUE,.casek!p#0A..
9cgloadk(aval)#0A..7}#0A..2genr(f_jeq,.casel!p)#0A.
.2genr(f_j,.dlab)#0A..2forgetall()#0A..2RETURN#0A..
}#0A#0A..//.There.are.at.least.four.cases.in.region
.p.#2E#2E.q#0A#0A//writef("switcht:.p#3D%n.q#3D%n.c
asek!p#3D%n,.casek!q#3D%n,.diff#3D%n*n",#0A//..15p,
..1q,..1casek!p,..2casek!q,..2casek!q-casek!p)#0A//
prcases(p,.q)#0A//abort(1000002)#0A#0A..//.Find.the
.middle.segment#0A..WHILE.p<r.&.0.<#3D.casek!s-case
k!(r-1).<#3D.#23xFF2.DO.r.:#3D.r-1#0A..WHILE.s<q.&.
0.<#3D.casek!(s+1)-casek!r.<#3D.#23xFF2.DO.s.:#3D.s
+1#0A#0A..//.r#2E#2Es.is.a.region.of.case.constants
.including.the.mid.point#0A..//.of.region.p#2E#2Eq,
.and.for.which#0A..//.0.<#3D.casek!i.-.casek!r.<#3D
.#23xFF2.for.all.i.in.r#2E#2Es#0A#0A//writef("switc
ht:.r#3D%n.s#3D%n*n",r,s)#0A//abort(1001)#0A#0A..IF
.n<#3D3.IF.p<r.|.s<q..DO#0A..{.//.Use.a.sequence.of
.equality.tests#2E#0A..2FOR.i.#3D.p.TO.q.DO#0A..2{.
TEST.inba#0A..4THEN.{.cgaddk(casek!i-aval)#0A..11av
al.:#3D.casek!i#0A..9}.#0A..4ELSE.{.inba,.aval.:#3D
.TRUE,.casek!i#0A..11cgloadk(aval)#0A..9}#0A..4genr
(f_jeq,.casel!i)#0A..2}#0A..2genr(f_j,.dlab)#0A..2f
orgetall()#0A..2RETURN#0A..}#0A#0A..UNLESS.r#3Dp.DO
#0A..{.//.At.least.one.case.in.LH.region.p.#2E#2E.r
-1#0A..2//.Set.B.#3D.switch.value.and.A.#3D.casek!r
#0A..2LET.lab.#3D.newlab()#0A..2TEST.inba#0A..2THEN
.{.cgaddk(casek!r-aval)#0A..9aval.:#3D.casek!r#0A..
7}.#0A..2ELSE.{.inba,.aval.:#3D.TRUE,.casek!r#0A..9
cgloadk(aval)#0A..7}#0A..2genr(f_jge,.lab)#0A..2swi
tcht(p,.r-1,.dlab,.TRUE,.aval)#0A..2setlab(lab)#0A.
.2switcht(r,.q,..1dlab,.TRUE,.aval)#0A..2RETURN#0A.
.}#0A#0A..UNLESS.s#3Dq.DO#0A..{.//.At.least.one.cas
e.in.RH.region.s+1.#2E#2E.q#0A..2//.Set.B.#3D.switc
h.value.and.A.#3D.casek!s#0A..2LET.lab.#3D.newlab()
#0A..2TEST.inba#0A..2THEN.{.cgaddk(casek!s-aval)#0A
..9aval.:#3D.casek!s#0A..7}.#0A..2ELSE.{.inba,.aval
.:#3D.TRUE,.casek!s#0A..9cgloadk(aval)#0A..7}#0A..2
genr(f_jgr,.lab)#0A..2switcht(p,..1s,.dlab,.TRUE,.a
val)#0A..2setlab(lab)#0A..2switcht(s+1,.q,.dlab,.TR
UE,.aval)#0A..2RETURN#0A..}#0A#0A..IF.inba.DO.gen(f
_xch).//.Put.B.back.in.A,.if.necessary#2E#0A..switc
hseg(r,.s,.dlab)#0A..forgetall()#0A}#0A#0AAND.offse
tcases(p,.q,.offset).BE.IF.offset.DO#0A{.//.Subtrac
t.offset.from.all.case.constants.in.the.region.p.to
.q#0A#0A//writef("offsetcases.p#3D%n.q#3D%n.offset#3D
%n*n",.p,.q,.offset)#0A//prcases(p,.q)#0A..1#0A..FO
R.i.#3D.p.TO.q..DO.casek!i.:#3D.casek!i.-.offset#0A
}#0A#0AAND.switchseg(p,.q,.dlab).BE#0A{.//.Only.cal
led#0A..//.when..0000.<#3D.casek!i.-.casek!p.<#3D.#23
xFF2.for.all.i.in.p#2E#2Eq#0A..//.and..1p.<#3D.q#0A
..LET.n.#3D.q-p+1..//.The.number.of.cases.(>#3D1)#2E
#0A#0A//writef("switchseg:.n#3D%n.casek!p#3D%n.case
k!q#3D%n*n",.n,.casek!p,.casek!q)#0A//prcases(p,.q)
#0A//abort(1000001)#0A#0A..TEST.2*n.<.casek!q.-.cas
ek!p..//.Which.is.generates.less.code?#0A..THEN.swi
tchb(p,.q,.dlab)..4//.Binary.chop.switch#2E#0A..ELS
E.switchl(p,.q,.dlab)..4//.Label.vector.switch#2E#0A
}#0A#0AAND.switchb(p,.q,.dlab).BE..//.Binary.chop.s
witch#2E#0A{.//.Only.called.when..0000.<#3D.casek!q
.-.casek!p.<#3D.#23xFF2#0A..//..12and..p.<.q#0A..LE
T.n.#3D.q-p+1..1//.Number.of.cases.(>1)#2E#0A..LET.
n1.#3D.n>7.->n,.7#0A..1#0A//writef("switchb:.n#3D%n
.casek!p#3D%n.casek!p#3D%n*n",.n,.casek!p,.casek!q)
#0A//prcases(p,.q)#0A//abort(1001)#0A..//.Ensure.th
at.all.case.constants.can.be.represented.by#0A..//.
unsigned.16.bit.integers#2E#0A..IF.casek!p<0.|.case
k!q>#23xFF2.DO#0A..{.cgaddk(-casek!p)#0A..2offsetca
ses(p,.q,.casek!p)#0A..}#0A..1#0A..chkrefs(6+4*n1).
//.allow.for.padding.to.7.cases#0A..gen(f_swb)#0A..
align(2)#0A..codeh(n)#0A..coder(dlab)#0A..FOR.i.#3D
.p.TO.q.DO.{.LET.pos.#3D.q.+.1.-.findpos(i-p+1,.q-p
+1)#0A..20codeh(casek!pos)#0A..20coder(casel!pos)#0A
..18}#0A..FOR.i.#3D.q+1.TO.p+6.DO.{.codeh(0).//.pad
.out.to.7.cases#0A..24coder(dlab)#0A..22}#0A}#0A#0A
//.If.the.integers.1#2E#2En.were.stored.in.a.balanc
ed.binary#0A//.tree.using.the.tree.structure.of.hea
p.sort,.then#0A//.integer.i.would.be.at.position.fi
ndpos(i,.n)#2E#0AAND.findpos(i,.n).#3D.VALOF#0A{.LE
T.r.#3D.?#0A..IF.i.#3D.1.DO.{.swlpos,.swrpos.:#3D.0
,.n#0A..14RESULTIS.rootpos(0,.n)#0A..12}#0A..r.:#3D
.findpos(i/2,.n)#0A..TEST.(i&1).#3D.0.THEN.swrpos.:
#3D.r-1#0A..15ELSE.swlpos.:#3D.r#0A..RESULTIS.rootp
os(swlpos,.swrpos)#0A}#0A#0AAND.rootpos(p,.q).#3D.V
ALOF#0A{.LET.n.#3D.q-p#0A..LET.s,.r.#3D.2,.?#0A..UN
TIL.s>n.DO.s.:#3D.s+s#0A..s.:#3D.s/2#0A..r.:#3D.n-s
+1#0A..IF.s.<#3D.r+r.RESULTIS.p.+.s#0A..RESULTIS.p.
+.s/2.+.r#0A}#0A#0AAND.switchl(p,.q,.dlab).BE..//.L
abel.vector.switch#2E#0A{.//.Only.called.when..0000
.<#3D.casek!q.-.casek!p.<#3D.#23xFF2#0A..//..12and.
.p.<.q#0A#0A..LET.n,.t.#3D.?,.p#0A#0A..//.Adjust.ca
se.constants.to.suit.SWL.instruction#2E#0A..IF.case
k!p<0.|.casek!p>1.|.casek!q>#23xFF2.DO#0A..{.cgaddk
(-casek!p)#0A..2offsetcases(p,.q,.casek!p)#0A..}#0A
..1#0A..n.:#3D.casek!q.+.1..1//.Number.of.entries.i
n.the.label.vector#2E#0A..chkrefs(2*n+6)#0A..gen(f_
swl)#0A..align(2)#0A..codeh(n)#0A..coder(dlab)..6//
.Default.label#2E#0A#0A..FOR.k.#3D.0.TO.casek!q.TES
T.casek!t#3Dk#0A..21THEN.{.coder(casel!t)#0A..28t.:
#3D.t+1#0A..26}#0A..21ELSE.coder(dlab)#0A}#0A#0AAND
.cgstring(n).BE#0A{.LET.lab,.a.#3D.newlab(),.n#0A..
loadt(k_lvlab,.lab)#0A#0A..{.//.Start.of.packing.lo
op#0A..2LET.t..#3D.getblk(0,.lab,.0).//.The.first.i
tem.hold.the.label#0A..2LET.b,.c,.d,.e,.f,.g,.h.#3D
.0,.0,.0,.0,.0,.0,.0#0A..2!nliste.:#3D.t#0A..2nlist
e.:#3D.!nliste#0A..2lab.:#3D.0..16//.Clear.the.labe
l.for.further.items#0A#0A..2IF.n>#3D1.DO.b.:#3D.rdn
()#0A..2IF.n>#3D2.DO.c.:#3D.rdn()#0A..2IF.n>#3D3.DO
.d.:#3D.rdn()#0A..2n.:#3D.n-4..4//.1.to.4.bytes.hav
e.been.packed#0A..2TEST.t64#0A..2THEN.{.IF.n>#3D0.D
O.e.:#3D.rdn()#0A..9IF.n>#3D1.DO.f.:#3D.rdn()#0A..9
IF.n>#3D2.DO.g.:#3D.rdn()#0A..9IF.n>#3D3.DO.h.:#3D.
rdn()#0A..9n.:#3D.n-4..2//.1.to.8.bytes.have.been.p
acked#0A..9TEST.bigender#0A..9THEN.TEST.c64#0A..14T
HEN.h3!t.:#3D.pack4b(a,b,c,d)<<00032.|.pack4b(e,f,g
,h)#0A..14ELSE.h4!t,.h3!t.:#3D.pack4b(a,b,c,d),.pac
k4b(e,f,g,h)#0A..9ELSE.TEST.c64#0A..14THEN.h3!t.:#3D
.pack4b(h,g,f,e)<<00032.|.pack4b(d,c,b,a)#0A..14ELS
E.h4!t,.h3!t.:#3D.pack4b(h,g,f,e),.pack4b(d,c,b,a)#0A
..7}#0A..2ELSE.TEST.bigender#0A..7THEN.h3!t.:#3D.pa
ck4b(a,b,c,d)#0A..7ELSE.h3!t.:#3D.pack4b(d,c,b,a)#0A
#0A..2IF.n<0.BREAK..//.There.are.no.more.characters
.to.pack#0A#0A..2a.:#3D.rdn()#0A..}.REPEAT#0A}#0A#0A
AND.setlab(l).BE#0A{.LET.p.#3D.@rlist#0A#0A..IF.deb
ug>0.DO.writef("%i4:.L%n:*n",.stvp,.l)#0A#0A..labv!
l.:#3D.stvp..//.Set.the.label#2E#0A#0A..//.Fill.in.
all.refs.that.are.in.range#2E#0A..{.LET.r.#3D.!p#0A
..2IF.r#3D0.BREAK#0A..2TEST.h3!r#3Dl.&.inrange_d(h2
!r,.stvp)#0A..2THEN.{.fillref_d(h2!r,.stvp)#0A..9!p
.:#3D.!r..1//.Remove.item.from.RLIST#2E#0A..9freebl
k(r)#0A..7}#0A..2ELSE.p.:#3D.r..//.Keep.the.item#2E
#0A..}.REPEAT#0A..rliste.:#3D.p..3//.Ensure.that.RL
ISTE.is.sensible#2E#0A#0A..p.:#3D.@reflist#0A#0A..{
.LET.r.#3D.!p#0A..2IF.r#3D0.BREAK#0A..2TEST.h3!r#3D
l#0A..2THEN.{.LET.a.#3D.h2!r#0A..9puth(a,stvp-a).//
.Plant.rel.address#2E#0A..9!p.:#3D.!r..5//.Remove.i
tem.from.REFLIST#2E#0A..9freeblk(r)#0A..7}#0A..2ELS
E.p.:#3D.r..//.Keep.item#2E#0A..}.REPEAT#0A#0A..ref
liste.:#3D.p..1//.Ensure.REFLISTE.is.sensible#2E#0A
}#0A#0AAND.cgstatics().BE.WHILE.nlist.DO#0A{.LET.le
n,.nl.#3D.0,.nlist#0A#0A..nliste.:#3D.@nlist..//.Al
l.NLIST.items.will.be.freed#2E#0A#0A..//.Calculate.
the.length.in.bytes.of.the.next.static.value#2E#0A.
.len,.nl.:#3D.len+wordbytelen,.!nl.REPEATUNTIL.nl#3D
0.|.h2!nl#0A#0A..chkrefs(len+wordbytelen-1).//.+wor
dbytelen.since.align(wordbytelen)#0A..27//.may.gene
rate.this.number.of.bytes#2E#0A..align(wordbytelen)
#0A#0A..setlab(h2!nlist)..//.The.first.NLIST.item.a
lways.has.a.label#2E#0A#0A..{.LET.blk.#3D.nlist#0A.
.2LET.w..1#3D.h3!blk#0A..2nlist.:#3D.!nlist#0A//wri
tef("cgstatics:.blk#3D%n.->.[%n,.%n,.%x8]*n",.blk,.
blk!0,.blk!1,.blk!2)#0A..2TEST.c64#0A..2THEN.TEST.t
64#0A..7THEN.codew(.(w>>00032),.w)..//.c64.->.T64#0A
..7ELSE.codew(-(w>>00031),.w)..//.c64.->.t32..1sign
.extend#0A..2ELSE.TEST.t64#0A..7THEN.codew(..h4!blk
,.w)..//.c32.->.t64#0A..7ELSE.codew(..0050,.w)..//.
c32.->.t32#0A..2freeblk(blk)#0A..}.REPEATUNTIL.nlis
t#3D0.|.h2!nlist#0A}#0A#0AAND.getblk(a,.b,.c).#3D.V
ALOF#0A{.LET.p.#3D.freelist#0A..TEST.p#3D0.THEN.{.d
p.:#3D.dp-blkupb-1;.checkspace();.p.:#3D.dp.}#0A..9
ELSE.freelist.:#3D.!p#0A..IF.blkupb#3D3.DO.p!3.:#3D
.0.//.Clear.the.4th.word.if.it.exists#0A..h1!p,.h2!
p,.h3!p.:#3D.a,.b,.c#0A..RESULTIS.p#0A}#0A#0AAND.fr
eeblk(p).BE.{.!p.:#3D.freelist;.freelist.:#3D.p.}#0A
#0AAND.freeblks(p).BE.UNLESS.p#3D0.DO#0A{.LET.oldfr
eelist.#3D.freelist#0A..freelist.:#3D.p#0A..UNTIL.!
p#3D0.DO.p.:#3D.!p#0A..!p.:#3D.oldfreelist#0A}#0A#0A
AND.initdatalists().BE#0A{.reflist,.refliste.:#3D.0
,.@reflist#0A..rlist,..1rliste..1:#3D.0,.@rlist#0A.
.nlist,..1nliste..1:#3D.0,.@nlist#0A..freelist.:#3D
.0#0A}#0A#0ALET.geng(f,.n).BE.TEST.n<256#0A..16THEN
.genb(f,.n)#0A..16ELSE.TEST.n<512#0A..21THEN.genb(f
+32,.n-256)#0A..21ELSE.genh(f+64,.n)#0A#0ALET.gen(f
).BE.IF.incode.DO#0A{.chkrefs(1)#0A..IF.debug.DO.wr
code(f,."")#0A..codeb(f)#0A}#0A#0ALET.genb(f,.a).BE
.IF.incode.DO#0A{.chkrefs(2)#0A..IF.debug>0.DO.wrco
de(f,."%i3",.a)#0A..codeb(f)#0A..codeb(a)#0A}#0A#0A
LET.genbb(f,.a,.b).BE.IF.incode.DO#0A{.chkrefs(3)#0A
..IF.debug>0.DO.wrcode(f,."%i3.%i3",.a,.b)#0A..code
b(f)#0A..codeb(a)#0A..codeb(b)#0A}#0A#0ALET.genflt(
flop).BE.IF.incode.DO#0A{.chkrefs(2)#0A..IF.debug>0
.DO.wrcode(f_fltop,."%s",.flopname(flop))#0A..codeb
(f_fltop)#0A..codeb(flop)#0A}#0A#0ALET.genr(f,.n).B
E.IF.incode.DO#0A{.chkrefs(2)#0A..IF.debug>0.DO.wrc
ode(f,."L%n",.n)#0A..codeb(f)#0A..codeb(0)#0A..relr
ef(stvp-2,.n)#0A}#0A#0ALET.genh(f,.h).BE.IF.incode.
DO..//.Assume.0.<#3D.h.<#3D.#23xFF2#0A{.chkrefs(3)#0A
..IF.debug>0.DO.wrcode(f,."%n",.h)#0A..codeb(f)#0A.
.code2b(h)#0A}#0A#0ALET.genw(f,.w).BE.IF.incode.DO#0A
{.UNLESS.-#23x8005.<#3D.w.<#3D.#23x7FF5.DO#0A..{.//
.This.code.is.only.executed.if.running.on.a.64-bit.
system#0A..2//.and.an.MW.instruction.is.needed#2E#0A
..2LET.mw.#3D.w>>00032#0A..2IF.(w.&.#23x8005)~#3D0.
DO.mw.:#3D.mw+1#0A..2chkrefs(5)#0A..2//.Output.code
.to.set.the.senior.32.bits.of.the.mw.register#0A..2
//.so.that.w.#3D.mw.+.sign_extend32(w.&.#23xFF6)#0A
..2//.The.MW.register.is.always.cleared.after.use#2E
#0A#0A..2IF.debug>0.DO.wrcode(f_mw,."#23x%x8",.mw)#0A
..2codeb(f_mw)#0A..2code4b(mw)#0A..}#0A#0A..chkrefs
(5)#0A..IF.debug>0.DO.wrcode(f,."#23x%x8",.w)#0A..c
odeb(f)#0A..code4b(w)#0A}#0A#0ALET.genfb(f,.flop,.a
).BE.IF.incode.DO#0A{.//.Only.called.by:.genfb(f_fl
top,.fl_mk,.exponent)#0A..chkrefs(3)#0A..IF.debug>0
.DO.wrcode(f,."%s.%n",.flopname(flop),.a)#0A..codeb
(f)#0A..codeb(flop)#0A..codeb(a)#0A}#0A#0ALET.genfb
b(f,.sfop,.a,.b).BE.IF.incode.DO#0A{.chkrefs(4)#0A.
.IF.debug>0.DO.wrcode(f,."%s.%n.%n",.sfname(sfop),.
a,.b)#0A..codeb(f)#0A..codeb(sfop)#0A..codeb(a)#0A.
.codeb(b)#0A}#0A#0AAND.checkspace().BE.IF.stvp/4>dp
-stv.DO#0A{.cgerror("Program.too.large,.%n.bytes.co
mpiled",.stvp)#0A..errcount.:#3D.errcount+1#0A..lon
gjump(fin_p,.fin_l)#0A}#0A#0AAND.codeb(byte).BE#0A{
.stv%stvp.:#3D.byte#0A..stvp.:#3D.stvp.+.1#0A..chec
kspace()#0A}#0A#0AAND.code2b(h).BE.TEST.bigender#0A
THEN.{.codeb(h>>0008.);.codeb(h..2)..}#0AELSE.{.cod
eb(h..2);.codeb(h>>0008.)..}#0A#0AAND.code4b(w).BE.
TEST.bigender#0ATHEN.{.codeb(w>>00024);.codeb(w>>00
016);.codeb(w>>0008.);.codeb(w..2)..}#0AELSE.{.code
b(w..2);.codeb(w>>0008.);.codeb(w>>00016);.codeb(w>
>00024)..}#0A#0AAND.pack4b(a,.b,.c,.d).#3D.((1a<<00
08).|.b)<<0008.|.c)<<0008.|.d#0A#0AAND.codeh(h).BE#0A
{.IF.debug>0.DO.writef("%i4:..DATAH.%n*n",.stvp,.h)
#0A..code2b(h)#0A}#0A#0AAND.codew(wh,.wl).BE.TEST.t
64#0ATHEN.{.IF.debug>0.DO.writef("%i4:..DATAW.#23x%
x8%x8*n",.stvp,.wh,.wl)#0A..5TEST.bigender#0A..5THE
N.{.codeb(wh>>00024)#0A..12codeb(wh>>00016)#0A..12c
odeb(wh>>0008)#0A..12codeb(wh)#0A..12codeb(wl>>0002
4)#0A..12codeb(wl>>00016)#0A..12codeb(wl>>0008)#0A.
.12codeb(wl)#0A..10}#0A..5ELSE.{.codeb(wl)#0A..12co
deb(wl>>0008)#0A..12codeb(wl>>00016)#0A..12codeb(wl
>>00024)#0A..12codeb(wh)#0A..12codeb(wh>>0008)#0A..
12codeb(wh>>00016)#0A..12codeb(wh>>00024)#0A..10}#0A
..3}#0AELSE.{.IF.debug>0.DO.writef("%i4:..DATAW.#23
x%x8*n",.stvp,.wl)#0A..5TEST.bigender#0A..5THEN.{.c
odeb(wl>>00024)#0A..12codeb(wl>>00016)#0A..12codeb(
wl>>0008)#0A..12codeb(wl)#0A..10}#0A..5ELSE.{.codeb
(wl)#0A..12codeb(wl>>0008)#0A..12codeb(wl>>00016)#0A
..12codeb(wl>>00024)#0A..10}#0A..3}#0A#0AAND.codest
r(s).BE#0A{.LET.i,.len.#3D.0,.s%0#0A#0A..TEST.t64#0A
..THEN.UNTIL.i>len.DO.//.Target.is.64-bit.Cintcode#0A
..5{.LET.p.#3D.stvp#0A..7LET.a,b,c,d,e,f,g,h.#3D.0,
0,0,0,0,0,0,0#0A..7IF.i<#3Dlen.DO.a.:#3D.s%i#0A..7i
.:#3D.i+1#0A..7IF.i<#3Dlen.DO.b.:#3D.s%i#0A..7i.:#3D
.i+1#0A..7IF.i<#3Dlen.DO.c.:#3D.s%i#0A..7i.:#3D.i+1
#0A..7IF.i<#3Dlen.DO.d.:#3D.s%i#0A..7i.:#3D.i+1#0A.
.7IF.i<#3Dlen.DO.e.:#3D.s%i#0A..7i.:#3D.i+1#0A..7IF
.i<#3Dlen.DO.f.:#3D.s%i#0A..7i.:#3D.i+1#0A..7IF.i<#3D
len.DO.g.:#3D.s%i#0A..7i.:#3D.i+1#0A..7IF.i<#3Dlen.
DO.h.:#3D.s%i#0A..7i.:#3D.i+1#0A#0A..7TEST.bigender
#0A..7THEN.{.codeb(a);.codeb(b);.codeb(c);.codeb(d)
#0A..14codeb(e);.codeb(f);.codeb(g);.codeb(h)#0A..1
4IF.debug>0.DO#0A..16writef("%i4:..DATAW.#23x%x2%x2
%x2%x2%x2%x2%x2%x2*n",.#0A..24p,..10a,.b,.c,.d,.e,.
f,.g,.h)#0A..12}#0A..7ELSE.{.codeb(a);.codeb(b);.co
deb(c);.codeb(d)#0A..14codeb(e);.codeb(f);.codeb(g)
;.codeb(h)#0A..14IF.debug>0.DO#0A..16writef("%i4:..
DATAW.#23x%x2%x2%x2%x2%x2%x2%x2%x2*n",.#0A..24p,..1
0h,.g,.f,.e,.d,.c,.b,.a)#0A..12}#0A..5}#0A..ELSE.UN
TIL.i>len.DO.//.Target.is.32-bit.Cintcode#0A..5{.LE
T.p.#3D.stvp#0A..7LET.a,b,c,d.#3D.0,0,0,0#0A..7IF.i
<#3Dlen.DO.a.:#3D.s%i#0A..7i.:#3D.i+1#0A..7IF.i<#3D
len.DO.b.:#3D.s%i#0A..7i.:#3D.i+1#0A..7IF.i<#3Dlen.
DO.c.:#3D.s%i#0A..7i.:#3D.i+1#0A..7IF.i<#3Dlen.DO.d
.:#3D.s%i#0A..7i.:#3D.i+1#0A#0A..7TEST.bigender#0A.
.7THEN.{.codeb(a);.codeb(b);.codeb(c);.codeb(d)#0A.
.14IF.debug>0.DO#0A..16writef("%i4:..DATAW.#23x%x2%
x2%x2%x2*n",.p,.a,b,c,d)#0A..12}#0A..7ELSE.{.codeb(
a);.codeb(b);.codeb(c);.codeb(d)#0A..14IF.debug>0.D
O#0A..16writef("%i4:..DATAW.#23x%x2%x2%x2%x2*n",.p,
.d,c,b,a)#0A..12}#0A..5}#0A}#0A#0AAND.coder(n).BE#0A
{.LET.labval.#3D.labv!n#0A..IF.debug>0.DO.writef("%
i4:..DATAH.L%n-$*n",.stvp,.n)#0A..code2b(0)#0A..TES
T.labval#3D-1.THEN.{.!refliste.:#3D.getblk(0,.stvp-
2,.n)#0A..22refliste.:#3D.!refliste#0A..20}#0A..15E
LSE.puth(stvp-2,.labval-stvp+2)#0A}#0A#0AAND.getw(a
).#3D.VALOF.TEST.bigender#0ATHEN.TEST.t64#0A..3THEN
.RESULTIS.#0A..17stv%(a+0)<<00056.|#0A..17stv%(a+1)
<<00048.|#0A..17stv%(a+2)<<00040.|#0A..17stv%(a+3)<
<00032.|#0A..17stv%(a+4)<<00024.|#0A..17stv%(a+5)<<
00016.|#0A..17stv%(a+6)<<0008..|#0A..17stv%(a+7)#0A
..3ELSE.RESULTIS.stv%(a+0)<<00024.|#0A..17stv%(a+1)
<<00016.|#0A..17stv%(a+2)<<0008..|#0A..17stv%(a+3)#0A
ELSE.TEST.t64#0A..3THEN.RESULTIS.stv%(a+0)..3|#0A..
17stv%(a+1)<<0008..|#0A..17stv%(a+2)<<00016.|#0A..1
7stv%(a+3)<<00024.|#0A..17stv%(a+4)<<00032.|#0A..17
stv%(a+5)<<00040.|#0A..17stv%(a+6)<<00048.|#0A..17s
tv%(a+7)<<00056#0A..3ELSE.RESULTIS.stv%(a+0)..3|#0A
..17stv%(a+1)<<0008..|#0A..17stv%(a+2)<<00016.|#0A.
.17stv%(a+3)<<00024#0A#0AAND.puth(a,.w).BE#0A..TEST
.bigender#0A..THEN.stv%a,..3stv%(a+1).:#3D.w>>0008,
.w#0A..ELSE.stv%(a+1),.stv%a..3:#3D.w>>0008,.w#0A#0A
AND.putw(a,.w).BE#0A..TEST.bigender#0A..THEN.TEST.t
64#0A..5THEN.{.stv%(a+0).:#3D.w>>00056#0A..12stv%(a
+1).:#3D.w>>00048#0A..12stv%(a+2).:#3D.w>>00040#0A.
.12stv%(a+3).:#3D.w>>00032#0A..12stv%(a+4).:#3D.w>>
00024#0A..12stv%(a+5).:#3D.w>>00016#0A..12stv%(a+6)
.:#3D.w>>0008#0A..12stv%(a+7).:#3D.w#0A..10}#0A..5E
LSE.{.stv%(a+0).:#3D.w>>00024#0A..12stv%(a+1).:#3D.
w>>00016#0A..12stv%(a+2).:#3D.w>>0008#0A..12stv%(a+
3).:#3D.w#0A..10}#0A..ELSE.TEST.t64#0A..5THEN.{.stv
%(a+7).:#3D.w>>00056#0A..12stv%(a+6).:#3D.w>>00048#0A
..12stv%(a+5).:#3D.w>>00040#0A..12stv%(a+4).:#3D.w>
>00032#0A..12stv%(a+3).:#3D.w>>00024#0A..12stv%(a+2
).:#3D.w>>00016#0A..12stv%(a+1).:#3D.w>>0008#0A..12
stv%(a+0).:#3D.w#0A..10}#0A..5ELSE.{.stv%(a+3).:#3D
.w>>00024#0A..12stv%(a+2).:#3D.w>>00016#0A..12stv%(
a+1).:#3D.w>>0008#0A..12stv%(a+0).:#3D.w#0A..10}#0A
#0AAND.align(n).BE.UNTIL.stvp.REM.n.#3D.0.DO.codeb(
0)#0A#0AAND.chkrefs(n).BE..//.Resolve.references.un
til.it.is.possible#0A..17//.to.compile.n.bytes.with
out.a.reference#0A..17//.going.out.of.range#2E#0A{.
LET.p.#3D.@rlist#0A#0A..skiplab.:#3D.0#0A#0A..UNTIL
.!p#3D0.DO#0A..{.LET.r.#3D.!p#0A..2LET.a.#3D.h2!r./
/.RLIST.is.ordered.in.increasing.A#2E#0A#0A..2IF.(s
tv%a.&.1).#3D.0.DO#0A..2//.An.unresolved.reference.
at.address.A#0A..2{.IF.inrange_i(a,.stvp+n+3).BREAK
#0A..4//.This.point.is.reached.if.there.is#0A..4//.
an.unresolved.ref.at.A.which.cannot#0A..4//.directl
y.relative.address.STVP+N+3#0A..4//.and.so.an.indir
ect.data.word.must#0A..4//.be.compiled#2E#0A..4//.T
he.+3.is.to.allow.for.a.possible#0A..4//.skip.jump.
instruction.and.possibly#0A..4//.one.filler.byte#2E
#0A..4genindword(h3!r)#0A..2}#0A#0A..2//.At.this.po
int.the.reference.at.A#0A..2//.is.in.range.of.a.res
olving.indirect#0A..2//.data.word.and.should.be.rem
oved.from#0A..2//.RLIST.if.there.is.no.chance.that.
it#0A..2//.can.be.resolved.by.a.direct.relative#0A.
.2//.address#2E#0A..2TEST.inrange_d(a,.stvp)#0A..2T
HEN.p.:#3D.r..6//.Keep.the.item#2E#0A..2ELSE.{.!p.:
#3D.!r..1//.Free.item.if.already.resolved#0A..9free
blk(r).//.and.no.longer.in.direct.range#2E#0A..9IF.
!p#3D0.DO.rliste.:#3D.p..//.Correct.RLISTE#2E#0A..7
}#0A..}#0A#0A..//.At.this.point.all.necessary.indir
ect.data.words.have#0A..//.been.compiled#2E#0A#0A..
UNLESS.skiplab#3D0.DO.{.setlab(skiplab)#0A..22skipl
ab,.incode.:#3D.0,.TRUE#0A..20}#0A}#0A#0AAND.genind
word(l).BE..//.Called.only.from.CHKREFS#2E#0A{.LET.
r.#3D.rlist..4//.Assume.RLIST.~#3D.0#0A#0A..IF.inco
de.DO#0A..{.skiplab.:#3D.newlab()#0A..2//.genr(f_j,
.skiplab).without.the.call.of.chkrefs(2)#2E#0A..2IF
.debug>0.DO.wrcode(f_j,."L%n",.skiplab)#0A..2codeb(
f_j)#0A..2codeb(0)#0A..2relref(stvp-2,.skiplab)#0A.
.2incode.:#3D.FALSE#0A..}#0A#0A..align(2)#0A#0A..UN
TIL.r#3D0.DO#0A..{.IF.h3!r#3Dl.&.(stv%(h2!r).&.1)#3D
0.DO.fillref_i(h2!r,.stvp)#0A..2r.:#3D.!r#0A..}#0A#0A
..coder(l)#0A}#0A#0AAND.inrange_d(a,.p).#3D.a-127.<
#3D.p.<#3D.a+128#0A//.The.result.is.TRUE.if.direct.
relative.instr.(eg.J).at#0A//.A.can.address.locatio
n.P.directly#2E#0A#0AAND.inrange_i(a,.p).#3D.VALOF#0A
//.The.result.is.TRUE.if.indirect.relative.instr.(e
g.J}#0A//.at.A.can.address.a.resolving.word.at.P#2E
#0A{.LET.rel.#3D.(p-a)/2#0A..RESULTIS.0.<#3D.rel.<#3D
.255#0A}#0A#0AAND.fillref_d(a,.p).BE#0A{.stv%a.:#3D
.stv%a.&.254..//.Back.to.direct.form.if.neccessary#2E
#0A..stv%(a+1).:#3D.p-a-1#0A}#0A#0AAND.fillref_i(a,
.p).BE..//.P.is.even#2E#0A{.stv%a.:#3D.stv%a.|.1..1
//.Force.indirect.form#2E#0A..stv%(a+1).:#3D.(p-a)/
2#0A}#0A#0AAND.relref(a,.l).BE#0A//.RELREF.is.only.
called.just.after.compiling#0A//.a.relative.referen
ce.instruction.at#0A//.address.A.(#3Dstvp-2)#2E#0A{
.LET.labval.#3D.labv!l#0A#0A..IF.labval>#3D0.&.inra
nge_d(a,.labval).DO.{.fillref_d(a,.labval)#0A..41RE
TURN#0A..39}#0A#0A..//.All.other.references.in.RLIS
T.have#0A..//.addresses.smaller.than.A.and.so.RLIST
.will#0A..//.remain.properly.ordered.if.this.item#0A
..//.is.added.to.the.end#2E#0A..!rliste.:#3D.getblk
(0,.a,.l)#0A..rliste.:#3D.!rliste#0A}#0A#0ALET.outp
utsection().BE#0A{.LET.outstream.#3D.output()#0A..U
NTIL.reflist#3D0.DO.{.cgerror("Label.L%n.unset",.h3
!reflist)#0A..21reflist.:#3D.!reflist#0A..19}#0A#0A
..selectoutput(gostream)..//.Output.a.HUNK.or.BHUNK
#2E#0A#0A..UNLESS.objline1written.IF.objline1%0.DO#0A
..{.writef("%s*n",.objline1)#0A..2objline1written.:
#3D.TRUE#0A..}#0A#0A..TEST.bining#0A..THEN.{.writef
("%X3.",.t_bhunk)..8//.writes.4.chars."BB0008."#0A.
.7FOR.p#3D0.TO.3..4DO.wrch(stv%p).//.write.bhunk.si
ze#0A..7FOR.p#3D0.TO.stvp-1.DO.wrch(stv%p).//.write
.the.bhunk#0A..5}#0A..ELSE.{.newline()#0A..7TEST.t6
4#0A..7THEN.{.LET.p.#3D.0#0A..14writef("%16x.",t_hu
nk64)#0A..14writef("%16x.",.stvp/wordbytelen)#0A..1
4WHILE.p.<.stvp.DO#0A..14{.IF.p.REM.32.#3D.0.DO.new
line()#0A..16wrword_at(p)#0A..16p.:#3D.p+wordbytele
n#0A..14}#0A..12}#0A..7ELSE.{.LET.p.#3D.0#0A..14wri
tef("%8x.",.t_hunk)#0A..14writef("%8x.",.stvp/wordb
ytelen)#0A..14WHILE.p.<.stvp.DO#0A..14{.IF.p.REM.32
.#3D.0.DO.newline()#0A..16wrword_at(p)#0A..16p.:#3D
.p+wordbytelen#0A..14}#0A..12}#0A..7newline()#0A..5
}#0A..selectoutput(outstream)#0A}#0A#0AAND.wrhex2(b
yte).BE#0A{.LET.t.#3D.TABLE.'0','1','2','3','4','5'
,'6','7',#0A..14'8','9','A','B','C','D','E','F'#0A.
.wrch(t!(byte>>0004))#0A..wrch(t!(byte&15))#0A}#0A#0A
AND.wrword_at(a).BE#0A{.TEST.bigender.THEN.{.wrhex2
(stv%a)#0A..21wrhex2(stv%(a+1))#0A..21wrhex2(stv%(a
+2))#0A..21wrhex2(stv%(a+3))#0A..21IF.t64.DO#0A..21
{.wrhex2(stv%(a+4))#0A..23wrhex2(stv%(a+5))#0A..23w
rhex2(stv%(a+6))#0A..23wrhex2(stv%(a+7))#0A..21}#0A
..19}#0A..14ELSE.{.IF.t64.DO#0A..21{.wrhex2(stv%(a+
7))#0A..23wrhex2(stv%(a+6))#0A..23wrhex2(stv%(a+5))
#0A..23wrhex2(stv%(a+4))#0A..21}#0A..21wrhex2(stv%(
a+3))#0A..21wrhex2(stv%(a+2))#0A..21wrhex2(stv%(a+1
))#0A..21wrhex2(stv%(a))#0A..19}#0A..wrch('.')#0A}#0A
#0AAND.dboutput().BE#0A{.LET.p.#3D.info_a#0A..write
s("A#3D(")#0A..UNTIL.p#3D0.DO.{.wrkn(h2!p,.h3!p)#0A
..15p.:#3D.!p#0A..15UNLESS.p#3D0.DO.wrch('*s')#0A..
13}#0A..2#0A..p.:#3D.info_b#0A..writes(").B#3D(")#0A
..UNTIL.p#3D0.DO.{.wrkn(h2!p,.h3!p)#0A..15p.:#3D.!p
#0A..15UNLESS.p#3D0.DO.wrch('*s')#0A..13}#0A..wrch(
')')#0A..1#0A..IF.debug#3D2.DO.{.writes("..STK:.")#0A
..16FOR.p#3Dtempv.TO.arg1.BY.3..DO#0A..16{.IF.(p-te
mpv).REM.30.#3D.10.DO.newline()#0A..18wrkn(h1!p,h2!
p)#0A..18wrch('*s')#0A..16}#0A..14}#0A..1#0A..IF.de
bug#3D3.DO.{.LET.l.#3D.rlist#0A..16writes("*nREFS."
)#0A..16UNTIL.l#3D0.DO.{.writef("%n.L%n..",.l!1,.l!
2)#0A..31l.:#3D.!l#0A..29}#0A..14}#0A..newline()#0A
}#0A#0A1AND.wrkn(k,n).BE#0A{.LET.s.#3D.VALOF.SWITCH
ON.k.INTO#0A..{.DEFAULT:..5k.:#3D.n#0A..17RESULTIS.
"?"#0A..2CASE.k_none:..1RESULTIS."-"#0A..2CASE.k_nu
mb:..1RESULTIS."N"#0A..2CASE.k_fnlab:..RESULTIS."F"
#0A..2CASE.k_lvloc:..RESULTIS."@P"#0A..2CASE.k_lvgl
ob:.RESULTIS."@G"#0A..2CASE.k_lvlab:..RESULTIS."@L"
#0A..2CASE.k_a:..4RESULTIS."A"#0A..2CASE.k_b:..4RES
ULTIS."B"#0A..2CASE.k_c:..4RESULTIS."C"#0A..2CASE.k
_loc:..2RESULTIS."P"#0A..2CASE.k_glob:..1RESULTIS."
G"#0A..2CASE.k_lab:..2RESULTIS."L"#0A..2CASE.k_loc0
:..1RESULTIS."0P"#0A..2CASE.k_loc1:..1RESULTIS."1P"
#0A..2CASE.k_loc2:..1RESULTIS."2P"#0A..2CASE.k_loc3
:..1RESULTIS."3P"#0A..2CASE.k_loc4:..1RESULTIS."4P"
#0A..2CASE.k_glob0:..RESULTIS."0G"#0A..2CASE.k_glob
1:..RESULTIS."1G"#0A..2CASE.k_glob2:..RESULTIS."2G"
#0A..}#0A..writes(s)#0A..UNLESS.k#3Dk_none.|.k#3Dk_
a.|.k#3Dk_b.|.k#3Dk_c.DO.writen(n)#0A}#0A#0AAND.wrc
ode(f,.form,.a,.b).BE#0A{.IF.debug#3D2.DO.dboutput(
)#0A..writef("%i4:.",.stvp)#0A..wrfcode(f)#0A..writ
es("..")#0A..writef(form,.a,.b)#0A..newline()#0A}#0A
#0AAND.wrfcode(f).BE#0A{.LET.s.#3D.VALOF.SWITCHON.f
&31.INTO#0A..{.DEFAULT:#0A..2CASE..0000:.RESULTIS."
..3-..3K..1LLP..3L..2LP..2SP..2AP..3A"#0A..2CASE..0
001:.RESULTIS.".FLTOP..2KH..LLPH..2LH..1LPH..1SPH..
1APH..2AH"#0A..2CASE..0002:.RESULTIS."..1BRK..2KW..
LLPW..2LW..1LPW..1SPW..1APW..2AW"#0A..2CASE..0003:.
RESULTIS."..2K3..1K3G..K3G1..K3GH..1LP3..1SP3..1AP3
..L0P3"#0A..2CASE..0004:.RESULTIS."..2K4..1K4G..K4G
1..K4GH..1LP4..1SP4..1AP4..L0P4"#0A..2CASE..0005:.R
ESULTIS."..2K5..1K5G..K5G1..K5GH..1LP5..1SP5..1AP5.
.L0P5"#0A..2CASE..0006:.RESULTIS."..2K6..1K6G..K6G1
..K6GH..1LP6..1SP6..1AP6..L0P6"#0A..2CASE..0007:.RE
SULTIS."..2K7..1K7G..K7G1..K7GH..1LP7..1SP7..1AP7..
L0P7"#0A..2CASE..0008:.RESULTIS."..2K8..1K8G..K8G1.
.K8GH..1LP8..1SP8..1AP8..L0P8"#0A..2CASE..0009:.RES
ULTIS."..2K9..1K9G..K9G1..K9GH..1LP9..1SP9..1AP9..L
0P9"#0A..2CASE.10:.RESULTIS."..1K10..K10G.K10G1.K10
GH..LP10..SP10..AP10.L0P10"#0A..2CASE.11:.RESULTIS.
"..1K11..K11G.K11G1.K11GH..LP11..SP11..AP11.L0P11"#0A
..2CASE.12:.RESULTIS."..2LF..1S0G..S0G1..S0GH..LP12
..SP12..AP12.L0P12"#0A..2CASE.13:.RESULTIS."..1LF$.
.1L0G..L0G1..L0GH..LP13..SP13.XPBYT..3S"#0A..2CASE.
14:.RESULTIS."..2LM..1L1G..L1G1..L1GH..LP14..SP14..
1LMH..2SH"#0A..2CASE.15:.RESULTIS."..1LM1..1L2G..L2
G1..L2GH..LP15..SP15..1BTC..MDIV"#0A..2CASE.16:.RES
ULTIS."..2L0..2LG..1LG1..1LGH..LP16..SP16..1NOP.CHG
CO"#0A..2CASE.17:.RESULTIS."..2L1..2SG..1SG1..1SGH.
.1SYS..2S1..2A1..1NEG"#0A..2CASE.18:.RESULTIS."..2L
2..1LLG..LLG1..LLGH..1SWB..2S2..2A2..1NOT"#0A..2CAS
E.19:.RESULTIS."..2L3..2AG..1AG1..1AGH..1SWL..2S3..
2A3..L1P3"#0A..2CASE.20:.RESULTIS."..2L4..1MUL..1AD
D..2RV..2ST..2S4..2A4..L1P4"#0A..2CASE.21:.RESULTIS
."..2L5..1DIV..1SUB..1RV1..1ST1..1XCH..2A5..L1P5"#0A
..2CASE.22:.RESULTIS."..2L6..1REM..1LSH..1RV2..1ST2
..GBYT..RVP3..L1P6"#0A..2CASE.23:.RESULTIS."..2L7..
1XOR..1RSH..1RV3..1ST3..PBYT..RVP4..L2P3"#0A..2CASE
.24:.RESULTIS."..2L8..2SL..1AND..1RV4..STP3..1ATC..
RVP5..L2P4"#0A..2CASE.25:.RESULTIS."..2L9..1SL$..2O
R..1RV5..STP4..1ATB..RVP6..L2P5"#0A..2CASE.26:.RESU
LTIS."..1L10..2LL..1LL1..1RV6..STP5..3J..RVP7..L3P3
"#0A..2CASE.27:.RESULTIS."..FHOP..1LL$..LL1$..1RTN.
.GOTO..2J$.ST0P3..L3P4"#0A..2CASE.28:.RESULTIS."..1
JEQ..1JNE..1JLS..1JGR..1JLE..1JGE.ST0P4..L4P3"#0A..
2CASE.29:.RESULTIS."..JEQ$..JNE$..JLS$..JGR$..JLE$.
.JGE$.ST1P3..L4P4"#0A..2CASE.30:.RESULTIS."..JEQ0..
JNE0..JLS0..JGR0..JLE0..JGE0.ST1P4.SELLD"#0A..2CASE
.31:.RESULTIS.".JEQ0$.JNE0$.JLS0$.JGR0$.JLE0$.JGE0$
..2MW.SELST"#0A..}#0A..LET.n.#3D.f>>0005.&.7#0A..FO
R.i.#3D.6*n+1.TO.6*(n+1).DO.wrch(s%i)#0A}#0A#0A2

######com/bcplcgsial.b#
//.This.is.the.Ocode.to.Sial.codegenerator#0A#0A//.
Implemented.by.Martin.Richards.(c).July.2000007#0A#0A
1/*.Change.history#0A#0A00010/08/14#0AAdded.floatin
g.point.instructions:.fix,.float,.fabs,.fmul,#0Afdi
v,.fadd,.fsub,.fneg,.feq,.fne,.fls,.fgr.fle.and.fge
#2E#0A#0A00010/05/13#0AMajor.change.to.the.compilat
ion.of.SWITCHON.to.stop.the.compiler#0Acrashing.whe
n.given.CASE.minint:#2E.See.function.switcht#2E#0A#0A
00008/07/09#0AMade.into.a.separate.file.to.be.combi
ned.with.the.standard.BCPL#0Afrontend.(bcplsystrm#2E
b)#2E#0A#0A*/#0A#0ASECTION."bcplcgsial"#0A#0A//.BCP
L.code-generator.for.Sial#0A//.Copyright..M#2ERicha
rds..0009.July.1990008#2E#0A#0AGET."libhdr"#0AGET."
bcplfecg"#0A#0AGET."sial#2Eh".//.This.header.is.use
d.by.sial.code.conversion.programs#0A..11//.such.as
.sial-386#2Eb#0A#0AGLOBAL.{#0A//.Global.procedures#2E
#0Acgsects:.cgg#0Ardl#0Ardgn#0Anewlab#0Achecklab#0A
cgerror#0A#0Ainitstack#0Astack#0Astore#0Ascan#0Acgp
endingop#0A#0A1iszero#0Abits24#0A#0Aloada#0Aloadbot
h#0Ainreg_a#0Ainreg_b#0Aaddinfo_a#0Aaddinfo_b#0A#0A
xchinfo#0Aatbinfo#0Abtainfo#0A#0Aforget_a#0Aforget_
b#0Aforgetall#0Aforgetvar#0Aforgetallvars#0A#0A1sto
ret#0Agensp#0Agenlp#0Aloadt#0Alose1#0Aswapargs#0Acg
stind#0Astorein#0A#0Acgrv#0Acgadd#0Acgloadk#0Acgadd
k#0Acgglobal#0Acgentry#0Acgapply#0Acgjump#0Ajmpfn#0A
jfn0#0Arevjfn#0Acompjfn#0Aprepj#0A#0Aswlpos#0Aswrpo
s#0Afindpos#0Arootpos#0A#0Acgswitch#0Aswitcht#0Aswi
tchta#0Aswitchseg#0Aswitchb#0Aswitchl#0Acgstring#0A
#0Acgstatics#0Agetblk#0Afreeblk#0Afreeblks#0A#0Aini
tdatalists#0A#0Agenfp#0Agenfkp#0Agenfkp#0Agenfg#0Ag
enfkg#0Agenfpg#0Agenfk#0Agenfw#0Agenfl#0Agenflk#0Ag
enfkl#0Agenfm#0Agenfmw#0A#0Agenf#0Ageng#0Agenc#0Age
nk#0Agenw#0Agenl#0Awrarg#0A#0Acgrelop#0Acgfrelop#0A
#0Acheckspace#0A#0Adboutput#0Awrkn#0Awrcode#0Awrfco
de#0A#0A//.Global.variables#2E#0Aarg1#0Aarg2#0A#0As
sp#0A#0Atempt#0Atempv#0Astv#0Astvp#0A#0Ach#0Adpbase
#0Adp#0Afreelist#0A#0Aincode#0Acasek#0Acasel#0A#0Am
axgn#0A#0Aop#0Alabnumber#0Apendingop#0Aprocdepth#0A
#0Aprogsize#0Acodelayout#0A#0Ainfo_a#0Ainfo_b#0A#0A
clist#0Acliste#0Atlist#0Atliste#0Aslist#0Asliste#0A
#0A}#0A#0A1MANIFEST#0A{#0A//.Value.descriptors#2E#0A
k_none#3D0#0Ak_numb#3D1..1//.numbers.in.the.range.-
#23xFF4.to.#23xFF4#0Ak_fnlab#3D2#0Ak_lvloc#3D3;.k_l
vglob#3D4;.k_lvlab#3D5;.k_lstr#3D6;.k_lw#3D7#0Ak_a#3D
8;.k_b#3D9;.k_c#3D10#0Ak_loc#3D11;.k_glob#3D12;.k_l
ab#3D13;.#0Ak_lock#3D14..9//..<28-bits>.lock..2ie.P
!<28-bits>!n#0Ak_globk#3D15..8//..<28-bits>.globk..
1ie.G!<28-bits>!n#0A#0Aswapped#3DTRUE;.notswapped#3D
FALSE#0A#0A//.Global.routine.numbers#2E#0Agn_stop#3D
2#0A}#0A#0ALET.codegenerate(workspace,.workspacesiz
e).BE#0A{.//writes("SIALCG..0001.Sept.2014*n")#0A#0A
..IF.workspacesize<2001.DO.{.cgerror("Too.little.wo
rkspace")#0A..27errcount.:#3D.errcount+1#0A..27long
jump(fin_p,.fin_l)#0A..25}#0A#0A..progsize.:#3D.0#0A
..codelayout.:#3D.0#0A#0A..op.:#3D.rdn()#0A#0A..sel
ectoutput(gostream)#0A..cgsects(workspace,.workspac
esize)#0A..selectoutput(sysprint)#0A..writef("Progr
am.size.#3D.%n.Fcodes*n",.progsize)#0A}#0A#0A1AND.c
gsects(workvec,.vecsize).BE.UNTIL.op#3D0.DO#0A{.LET
.p.#3D.workvec#0A..tempv.:#3D.p#0A..p.:#3D.p+90#0A.
.tempt.:#3D.p#0A..casek.:#3D.p#0A..p.:#3D.p+400#0A.
.casel.:#3D.p#0A..p.:#3D.p+400#0A..dpbase.:#3D.p#0A
..dp.:#3D.workvec+vecsize#0A..labnumber.:#3D.9001#0A
..incode.:#3D.TRUE#0A..maxgn.:#3D.0#0A..procdepth.:
#3D.0#0A..info_a,.info_b.:#3D.0,.0#0A..initstack(3)
#0A..initdatalists()#0A#0A..genf(f_modstart)#0A..IF
.op#3Ds_section.DO#0A..{.LET.n.#3D.rdn()#0A#0A..2IF
.naming.DO.genfk(f_section,.n)#0A#0A..2FOR.i.#3D.1.
TO.n.DO..{.LET.c.#3D.rdn()#0A..23IF.naming.DO.genc(
c)#0A..21}#0A#0A..2op.:#3D.rdn()#0A..}#0A#0A..incod
e.:#3D.FALSE#0A..scan()#0A..op.:#3D.rdn()#0A..incod
e.:#3D.TRUE#0A..genf(f_modend)#0A..newline()#0A}#0A
#0A//.Read.in.an.OCODE.label#2E#0AAND.rdl().#3D.VAL
OF#0A{.LET.l.#3D.rdn()#0A..RESULTIS.l#0A}#0A#0A//.R
ead.in.a.global.number#2E#0AAND.rdgn().#3D.VALOF#0A
{.LET.g.#3D.rdn()#0A..IF.maxgn<g.DO.maxgn.:#3D.g#0A
..RESULTIS.g#0A}#0A#0A1//.Generate.next.label.numbe
r#2E#0AAND.newlab().#3D.VALOF#0A{.labnumber.:#3D.la
bnumber+1#0A..RESULTIS.labnumber#0A}#0A#0AAND.cgerr
or(mes,.a).BE#0A{.writes("*nError:.")#0A..writef(me
s,.a)#0A..newline()#0A..errcount.:#3D.errcount+1#0A
..IF.errcount>errmax.DO.{.writes("Too.many.errors*n
")#0A..24longjump(fin_p,.fin_l)#0A..22}#0A}#0A#0A1/
/.Initialize.the.simulated.stack.(SS)#2E#0ALET.init
stack(n).BE#0A{.arg2,.arg1,.ssp.:#3D.tempv,.tempv+3
,.n#0A..pendingop.:#3D.s_none#0A..h1!arg2,.h2!arg2,
.h3!arg2.:#3D.k_loc,.ssp-2,.ssp-2#0A..h1!arg1,.h2!a
rg1,.h3!arg1.:#3D.k_loc,.ssp-1,.ssp-1#0A}#0A#0A1//.
Move.simulated.stack.(SS).pointer.to.N#2E#0AAND.sta
ck(n).BE#0A{.IF.n>#3Dssp+4.DO.{.store(0,ssp-1)#0A..
17initstack(n)#0A..17RETURN#0A..15}#0A#0A..WHILE.n>
ssp.DO.loadt(k_loc,.ssp)#0A#0A..UNTIL.n#3Dssp.DO#0A
..{.IF.arg2#3Dtempv.DO#0A..2{.TEST.n#3Dssp-1#0A..4T
HEN.{.ssp.:#3D.n#0A..11h1!arg1,.h2!arg1,.h3!arg1.:#3D
.h1!arg2,.h2!arg2,.ssp-1#0A..11h1!arg2,.h2!arg2,.h3
!arg2.:#3D.k_loc,.ssp-2,.ssp-2#0A..9}#0A..4ELSE.ini
tstack(n)#0A..4RETURN#0A..2}#0A#0A..2arg1,.arg2,.ss
p.:#3D.arg1-3,.arg2-3,.ssp-1#0A..}#0A}#0A#0A2//.Sto
re.all.SS.items.from.S1.to.S2.in.their.true#0A//.lo
cations.on.the.stack#2E#0A//.It.may.corrupt.both.re
gisters.A.and.B#2E#0AAND.store(s1,.s2).BE.FOR.p.#3D
.tempv.TO.arg1.BY.3.DO#0A..19{.LET.s.#3D.h3!p#0A..2
1IF.s>s2.RETURN#0A..21IF.s>#3Ds1.DO.storet(p)#0A..1
9}#0A#0A1AND.scan().BE#0A{.IF.debug>1.DO.{.writef("
OP#3D%i3.PND#3D%i3.",.op,.pendingop)#0A..16dboutput
()#0A..14}#0A#0A..SWITCHON.op.INTO#0A#0A..{.DEFAULT
:..3cgerror("Bad.OCODE.op.%n",.op)#0A..15ENDCASE#0A
#0A..2CASE.0:..4RETURN#0A..4#0A..2CASE.s_needs:#0A.
.13{.LET.n.#3D.rdn()..//.Ignore.NEEDS.directives#2E
#0A..15FOR.i.#3D.1.TO.n.DO.rdn()#0A..15ENDCASE#0A..
13}#0A#0A..2CASE.s_lp:..1loadt(k_loc,..1rdn());..1E
NDCASE#0A..2CASE.s_lg:..1loadt(k_glob,..rdgn());..E
NDCASE#0A..2CASE.s_ll:..1loadt(k_lab,..1rdl());..1E
NDCASE#0A..2CASE.s_lf:..1loadt(k_fnlab,.rdl());..1E
NDCASE#0A#0A..2CASE.s_ln:.{.LET.k.#3D.rdn()#0A..15U
NLESS.-#23xFF4<#3Dk<#3D#23xFF4.DO#0A..15{.LET.lab.#3D
.newlab()#0A..17loadt(k_lw,.lab)#0A..17!cliste.:#3D
.getblk(0,lab,k)#0A..17cliste.:#3D.!cliste#0A..17EN
DCASE#0A..15}#0A..17#0A..15loadt(k_numb,.k)#0A..15E
NDCASE#0A..13}#0A#0A..2CASE.s_fnum:#0A..13{.LET.x.#3D
.rdn()#0A..15LET.exponent.#3D.rdn()#0A#0A..15x.:#3D
.sys(Sys_flt,.fl_mk,.x,.exponent)#0A..15#0A..15UNLE
SS.-#23xFF4<#3Dx<#3D#23xFF4.DO#0A..15{.LET.lab.#3D.
newlab()#0A..17loadt(k_lw,.lab)#0A..17!cliste.:#3D.
getblk(0,lab,x)#0A..17cliste.:#3D.!cliste#0A..17END
CASE#0A..15}#0A..17#0A..15loadt(k_numb,.x)#0A..15EN
DCASE#0A..13}#0A#0A..2CASE.s_lstr:.cgstring(rdn());
..7ENDCASE#0A#0A..2CASE.s_true:.loadt(k_numb,.-1);.
.5ENDCASE#0A..2CASE.s_false:loadt(k_numb,..0000);..
5ENDCASE#0A#0A..2CASE.s_llp:..loadt(k_lvloc,..rdn()
);..ENDCASE#0A..2CASE.s_llg:..loadt(k_lvglob,.rdgn(
));.ENDCASE#0A..2CASE.s_ll1:..loadt(k_lvlab,..rdl()
);..ENDCASE#0A#0A..2CASE.s_sp:..1storein(k_loc,..rd
n());..ENDCASE#0A..2CASE.s_sg:..1storein(k_glob,.rd
gn());.ENDCASE#0A..2CASE.s_sl:..1storein(k_lab,..rd
l());..ENDCASE#0A#0A..2CASE.s_stind:cgstind();.ENDC
ASE#0A#0A..2CASE.s_rv:..1cgrv();.ENDCASE#0A#0A..2CA
SE.s_mul:CASE.s_div:CASE.s_rem:#0A..2CASE.s_add:CAS
E.s_sub:#0A..2CASE.s_eq:.CASE.s_ne:#0A..2CASE.s_ls:
CASE.s_gr:CASE.s_le:CASE.s_ge:#0A..2CASE.s_lshift:C
ASE.s_rshift:#0A..2CASE.s_logand:CASE.s_logor:CASE.
s_eqv:CASE.s_neqv:#0A..2CASE.s_not:CASE.s_neg:CASE.
s_abs:#0A..2CASE.s_float:CASE.s_fix:CASE.s_fabs:#0A
..2CASE.s_fmul:CASE.s_fdiv:#0A..2CASE.s_fadd:CASE.s
_fsub:CASE.s_fneg:#0A..2CASE.s_feq:.CASE.s_fne:#0A.
.2CASE.s_fls:CASE.s_fgr:CASE.s_fle:CASE.s_fge:#0A..
15cgpendingop()#0A..15pendingop.:#3D.op#0A..15ENDCA
SE#0A#0A..2CASE.s_jt:..1cgjump(TRUE,.rdl());..ENDCA
SE#0A#0A..2CASE.s_jf:..1cgjump(FALSE,.rdl());.ENDCA
SE#0A#0A..2CASE.s_goto:.cgpendingop()#0A..15store(0
,.ssp-2)#0A..15TEST.h1!arg1#3Dk_fnlab#0A..15THEN.ge
nfl(f_j,.h2!arg1)#0A..15ELSE.{.loada(arg1);.genf(f_
goto).}#0A..15stack(ssp-1)#0A..15incode.:#3D.FALSE#0A
..15ENDCASE#0A#0A..2CASE.s_lab:..cgpendingop()#0A..
15store(0,.ssp-1)#0A..15forgetall()#0A..15incode.:#3D
.procdepth>0#0A..15genfl(f_lab,.rdl())#0A..15ENDCAS
E#0A#0A..2CASE.s_query:loadt(k_loc,.ssp);..12ENDCAS
E#0A#0A..2CASE.s_stack:cgpendingop();.stack(rdn());
..2ENDCASE#0A#0A..2CASE.s_store:cgpendingop();.stor
e(0,.ssp-1);.ENDCASE#0A#0A..2CASE.s_entry:#0A..13{.
LET.l.#3D.rdl()#0A..15LET.n.#3D.rdn()#0A..15incode.
:#3D.TRUE#0A..15cgentry(l,.n)#0A..15procdepth.:#3D.
procdepth.+.1#0A..15ENDCASE#0A..13}#0A#0A..2CASE.s_
save:#0A..13{.LET.n.#3D.rdn()#0A..15initstack(n)#0A
..15IF.n>3.DO.addinfo_a(k_loc,.3)#0A..15ENDCASE#0A.
.13}#0A#0A..2CASE.s_fnap:#0A..2CASE.s_rtap:.cgapply
(op,.rdn());.ENDCASE#0A#0A..2CASE.s_rtrn:.cgpending
op()#0A..15genf(f_rtn)#0A..15incode.:#3D.FALSE#0A..
15ENDCASE#0A..17#0A..2CASE.s_fnrn:.cgpendingop()#0A
..15loada(arg1)#0A..15genf(f_rtn)#0A..15stack(ssp-1
)#0A..15incode.:#3D.FALSE#0A..15ENDCASE#0A#0A..2CAS
E.s_endproc:#0A..15incode.:#3D.FALSE#0A..15cgstatic
s()#0A..15procdepth.:#3D.procdepth.-.1#0A..15ENDCAS
E#0A#0A..2CASE.s_res:#0A..2CASE.s_jump:#0A..13{.LET
.l.#3D.rdl()#0A#0A..15cgpendingop()#0A..15store(0,.
ssp-2)#0A..15TEST.op#3Ds_jump#0A..15THEN.storet(arg
1)#0A..15ELSE.{.loada(arg1)#0A..22genf(f_res)..1//.
Put.result.in.<res>#0A..36//.ready.for.the.jump.to#0A
..36//.the.result.label#0A..22stack(ssp-1)#0A..20}#0A
#0A..15{.op.:#3D.rdn()#0A..17UNLESS.op#3Ds_stack.BR
EAK#0A..17stack(rdn())#0A..15}.REPEAT#0A#0A..15TEST
.op#3Ds_lab#0A..15THEN.{.LET.m.#3D.rdl()#0A..22UNLE
SS.l#3Dm.DO.genfl(f_j,.l)#0A..22forgetall()#0A..22i
ncode.:#3D.procdepth>0#0A..22genfl(f_lab,.m)#0A..22
op.:#3D.rdn()#0A..20}#0A..15ELSE.{.genfl(f_j,.l)#0A
..22incode.:#3D.FALSE#0A..20}#0A#0A..15LOOP#0A..13}
#0A#0A..2//.rstack.always.occurs.immediately.after.
a.lab.statement#0A..2//.at.a.time.when.cgpendingop(
).and.store(0,.ssp-2).have#0A..2//.been.called#2E#0A
..2CASE.s_rstack:#0A..15stack(rdn())#0A..15genf(f_l
dres)..//.A.:#3D.<res>#0A..15loadt(k_a,.0)#0A..15EN
DCASE#0A#0A..2CASE.s_finish:..//.Compile.code.for:.
.stop(0)#2E#0A..13{.LET.k.#3D.ssp#0A..15stack(ssp+3
)#0A..15loadt(k_numb,.0)#0A..15loadt(k_glob,.gn_sto
p)#0A..15cgapply(s_rtap,.k)#0A..15ENDCASE#0A..13}#0A
#0A..2CASE.s_switchon:#0A..15cgswitch();.ENDCASE#0A
#0A..2CASE.s_getbyte:#0A..15cgpendingop()#0A..15TES
T.loadboth(arg2,.arg1)#3Dswapped#0A..15THEN.genf(f_
xgbyt)#0A..15ELSE.genf(f_gbyt)#0A..15forget_a()#0A.
.15lose1(k_a,.0)#0A..15ENDCASE#0A#0A..2CASE.s_putby
te:#0A..15cgpendingop()#0A#0A..15//.First.move.arg3
.to.C#2E#0A..15{.LET.arg3.#3D.arg2.-.3#0A..17TEST.a
rg3-tempv.<.0.#0A..17THEN.{.loadt(k_loc,.ssp-3)#0A.
.24loada(arg1)#0A..24genf(f_atc)#0A..24stack(ssp-1)
#0A..22}#0A..17ELSE.{.TEST.inreg_b(h1!arg3,.h2!arg3
)#0A..24THEN..2genf(f_btc)#0A..24ELSE.{.loada(arg3)
#0A..31genf(f_atc)#0A..29}#0A..24h1!arg3.:#3D.k_c#0A
..22}#0A..17TEST.loadboth(arg2,.arg1)#3Dswapped#0A.
.17THEN.genf(f_xpbyt)#0A..17ELSE.genf(f_pbyt)#0A..1
7forgetallvars()#0A..17stack(ssp-3)#0A..17ENDCASE#0A
..15}#0A#0A..2CASE.s_global:.cgglobal(rdn());.RETUR
N#0A#0A..2CASE.s_datalab:#0A..15{.LET.lab.#3D.rdl()
.#0A..17op.:#3D.rdn()#0A#0A..17WHILE.op#3Ds_itemn.D
O#0A..17{.!tliste.:#3D.getblk(0,lab,rdn())#0A..20tl
iste,.lab,.op.:#3D.!tliste,.0,.rdn()#0A..17}#0A..17
LOOP#0A..14}#0A..}#0A#0A..op.:#3D.rdn()#0A}.REPEAT#0A
#0A1//.Compiles.code.to.deal.with.any.pending.op#2E
#0ALET.cgpendingop().BE#0A{.LET.f.#3D.0#0A..LET.sym
.#3D.TRUE.//.Symmetric.operator.like.mul.or.add#0A.
.15//.unless.otherwise.specified#0A..LET.pndop.#3D.
pendingop#0A..pendingop.:#3D.s_none#0A..SWITCHON.pn
dop.INTO#0A..{.DEFAULT:..4cgerror("Bad.pendingop.%n
",.pndop)#0A#0A..2CASE.s_none:..RETURN#0A#0A..2CASE
.s_abs:..1loada(arg1)#0A..16genf(f_abs)#0A..16forge
t_a()#0A..16RETURN#0A#0A..2CASE.s_neg:..1loada(arg1
)#0A..16genf(f_neg)#0A..16forget_a()#0A..16RETURN#0A
#0A..2CASE.s_fneg:..loada(arg1)#0A..16genf(f_fneg)#0A
..16forget_a()#0A..16RETURN#0A#0A..2CASE.s_float:.l
oada(arg1)#0A..16genf(f_float)#0A..16forget_a()#0A.
.16RETURN#0A#0A..2CASE.s_fix:..1loada(arg1)#0A..16g
enf(f_fix)#0A..16forget_a()#0A..16RETURN#0A#0A..2CA
SE.s_fabs:..loada(arg1)#0A..16genf(f_fabs)#0A..16fo
rget_a()#0A..16RETURN#0A#0A..2CASE.s_not:..1loada(a
rg1)#0A..16genf(f_not)#0A..16forget_a()#0A..16RETUR
N#0A#0A..2CASE.s_eq:.CASE.s_ne:#0A..2CASE.s_ls:.CAS
E.s_gr:#0A..2CASE.s_le:.CASE.s_ge:#0A..16cgrelop(pn
dop)#0A..16RETURN#0A#0A..2CASE.s_feq:.CASE.s_fne:#0A
..2CASE.s_fls:.CASE.s_fgr:#0A..2CASE.s_fle:.CASE.s_
fge:#0A..16cgfrelop(pndop)#0A..16RETURN#0A#0A..2CAS
E.s_sub:..1UNLESS.k_numb#3Dh1!arg1.DO#0A..16{.f,.sy
m.:#3D.f_sub,.FALSE#0A..18ENDCASE#0A..16}#0A..16h2!
arg1.:#3D.-h2!arg1#0A#0A..2CASE.s_add:..1cgadd();.R
ETURN#0A#0A..2CASE.s_mul:..1f..4:#3D.f_mul;..7ENDCA
SE#0A..2CASE.s_fmul:..f..4:#3D.f_fmul;..6ENDCASE#0A
..2CASE.s_fadd:..f..4:#3D.f_fadd;..6ENDCASE#0A..2CA
SE.s_logand:f..4:#3D.f_and;..7ENDCASE#0A..2CASE.s_l
ogor:.f..4:#3D.f_or;..8ENDCASE#0A..2CASE.s_eqv:..1f
..4:#3D.f_eqv;..7ENDCASE#0A..2CASE.s_neqv:..f..4:#3D
.f_xor;..7ENDCASE#0A#0A..2CASE.s_div:..1f,.sym.:#3D
.f_div,..FALSE;.ENDCASE#0A..2CASE.s_rem:..1f,.sym.:
#3D.f_rem,..FALSE;.ENDCASE#0A..2CASE.s_fdiv:..f,.sy
m.:#3D.f_fdiv,.FALSE;.ENDCASE#0A..2CASE.s_fsub:..f,
.sym.:#3D.f_fsub,.FALSE;.ENDCASE#0A#0A..2CASE.s_lsh
ift:f,.sym.:#3D.f_lsh,.FALSE;..ENDCASE#0A..2CASE.s_
rshift:f,.sym.:#3D.f_rsh,.FALSE;..ENDCASE#0A..}#0A#0A
..IF.loadboth(arg2,.arg1)#3Dswapped.&.~sym.SWITCHON
.f.INTO#0A..{.DEFAULT:..ENDCASE#0A..2CASE.f_div:.f.
:#3D.f_xdiv;..10ENDCASE#0A..2CASE.f_rem:.f.:#3D.f_x
rem;..10ENDCASE#0A..2CASE.f_sub:.f.:#3D.f_xsub;..10
ENDCASE#0A..2CASE.f_fls:.f.:#3D.f_fgr;..11ENDCASE#0A
..2CASE.f_fle:.f.:#3D.f_fge;..11ENDCASE#0A..2CASE.f
_fgr:.f.:#3D.f_fls;..11ENDCASE#0A..2CASE.f_fdiv:f.:
#3D.f_fxdiv;..9ENDCASE.#0A..2CASE.f_fsub:f.:#3D.f_f
xsub;..9ENDCASE#0A#0A..2CASE.f_lsh:#0A..2CASE.f_rsh
:.genf(f_xch);.xchinfo();.ENDCASE#0A..}#0A#0A..genf
(f)#0A..forget_a()#0A..IF.f#3Df_lsh.|.f#3Df_rsh.|#0A
..3f#3Df_fmul.|.f#3Df_div.|.f#3Df_xdiv.|#0A..3f#3Df
_fadd.|.f#3Df_fsub.|.f#3Df_fxsub.|#0A..3f#3Df_feq.|
.f#3Df_fne.|#0A..3f#3Df_fls.|.f#3Df_fgr.|#0A..3f#3D
f_fle.|.f#3Df_fge.DO.forget_b()#0A#0A..lose1(k_a,.0
)#0A}#0A#0ALET.loada(x).BE#0A//.Loada.compiles.code
.to.evaluate.SS.item.x.into.A#0A//.The.contents.of.
B.is.left.unchanged#0A{.LET.k,.n.#3D.h1!x,.h2!x#0A#0A
..IF.k#3Dk_a.RETURN#0A#0A..//.Dump.A.register.if.cu
rrently.in.use.somewhere.else#2E#0A..FOR.t.#3D.arg1
.TO.tempv.BY.-3.IF.h1!t#3Dk_a.DO.{.storet(t);.BREAK
.}#0A#0A..TEST.inreg_a(k,.n)#0A..THEN.h1!x.:#3D.k_a
#0A..ELSE.IF.inreg_b(k,.n).DO.{.genf(f_bta)#0A..27h
1!x.:#3D.k_a#0A..27btainfo()#0A..27RETURN#0A..25}#0A
#0A..SWITCHON.h1!x.&.15.INTO#0A..{.DEFAULT:..4cgerr
or("in.loada.%n",.k)#0A#0A..2CASE.k_a:..3RETURN#0A#0A
..2CASE.k_numb:..TEST.n>#3D0.THEN.genfk(f_l,n)#0A..
26ELSE.genfk(f_lm,-n)#0A..16ENDCASE#0A#0A..2CASE.k_
loc:..1genlp(n);..16ENDCASE#0A..2CASE.k_glob:..genf
g(f_lg,.n);..10ENDCASE#0A..2CASE.k_lab:..1genfl(f_l
l,.n);..10ENDCASE#0A..2CASE.k_fnlab:.genfl(f_lf,.n)
;..10ENDCASE#0A#0A..2CASE.k_lvloc:.genfp(f_llp,.n);
..9ENDCASE#0A#0A..2CASE.k_lvglob:genfg(f_llg,.n);..
9ENDCASE#0A..2CASE.k_lvlab:.genfl(f_ll1,.n);..9ENDC
ASE#0A..2CASE.k_lstr:..genfm(f_lstr,.n);..8ENDCASE#0A
..2CASE.k_lw:..2genfm(f_lw,.n);..10ENDCASE#0A..2CAS
E.k_lock:..genfkp(f_lkp,.n,.h1!x>>0004);.ENDCASE#0A
..2CASE.k_globk:.genfkg(f_lkg,.n,.h1!x>>0004);.ENDC
ASE#0A..}#0A#0A..//.An.instruction.to.load.the.A.re
gister.has.just.been.compiled#2E#0A..forget_a()#0A.
.addinfo_a(h1!x,.h2!x)#0A..h1!x.:#3D.k_a#0A}#0A#0AA
ND.loadboth(x,.y).#3D.VALOF#0A//.Compiles.code.to.c
ause#0A//..1either..2B.:#3D.<x>..and..A.:#3D.<y>#0A
//..11giving.result.NOTSWAPPED#0A//..1or..6B.:#3D.<
y>..and..A.:#3D.<x>#0A//..11giving.result.SWAPPED#2E
#0A//.loadboth.only.swaps.if.this.generates.less.co
de#2E#0A{.//.First.ensure.that.no.other.stack.item.
uses.reg.A#2E#0A..FOR.t.#3D.tempv.TO.arg1.BY.3.DO#0A
..2IF.h1!t#3Dk_a.UNLESS.t#3Dx.|.t#3Dy.DO.storet(t)#0A
#0A..{.LET.xa,.ya.#3D.inreg_a(h1!x,.h2!x),.inreg_a(
h1!y,.h2!y)#0A..2AND.xb,.yb.#3D.inreg_b(h1!x,.h2!x)
,.inreg_b(h1!y,.h2!y)#0A#0A..2IF.xb.&.ya.DO.{.h1!x,
.h1!y.:#3D.k_b,.k_a#0A..18RESULTIS.notswapped#0A..1
6}#0A..2IF.xa.&.yb.DO.{.h1!x,.h1!y.:#3D.k_a,.k_b#0A
..18RESULTIS.swapped#0A..16}#0A..2IF.xa.&.ya.DO.{.g
enf(f_atb);#0A..18atbinfo()#0A..18h1!x,.h1!y.:#3D.k
_b,.k_a#0A..18RESULTIS.notswapped#0A..16}#0A..2IF.x
b.&.yb.DO.{.genf(f_bta)#0A..18btainfo()#0A..18h1!x,
.h1!y.:#3D.k_b,.k_a#0A..18RESULTIS.notswapped#0A..1
6}#0A..4#0A..2IF.xa.DO.{.push(x,.y)#0A..13RESULTIS.
notswapped#0A..11}#0A..2IF.ya.DO.{.push(y,.x)#0A..1
3RESULTIS.swapped#0A..11}#0A..2IF.xb.DO.{.h1!x.:#3D
.k_b;.loada(y);..RESULTIS.notswapped.}#0A..2IF.yb.D
O.{.h1!y.:#3D.k_b;.loada(x);..RESULTIS.swapped..2}#0A
..4#0A..2loada(x)#0A..2push(x,.y)#0A..2RESULTIS.not
swapped#0A..}#0A}#0A#0AAND.push(a,.x).BE.//.compile
.code.for.B.:#3D.<a>;.A.:#3D.<x>#0A..16//.assuming.
<a>.is.already.in.A#0A{.LET.k,.n.#3D.h1!x,.h2!x#0A#0A
..SWITCHON.h1!x.INTO#0A..{.DEFAULT:..3genf(f_atb)#0A
..15h1!a.:#3D.k_b#0A..15atbinfo()#0A..15loada(x)#0A
..15RETURN#0A#0A..2CASE.k_loc:..genfp(f_atblp,.n);.
ENDCASE#0A..2CASE.k_glob:.genfg(f_atblg,.n);.ENDCAS
E#0A..2CASE.k_numb:.genfk(f_atbl,..n);.ENDCASE#0A..
}#0A#0A..atbinfo()#0A..forget_a()#0A..addinfo_a(k,.
n)#0A..h1!a,.h1!x.:#3D.k_b,.k_a#0A}.#0A#0ALET.inreg
_a(k,.n).#3D.VALOF#0A{.LET.p.#3D.info_a#0A..IF.k#3D
k_a.RESULTIS.TRUE#0A..UNTIL.p#3D0.DO.{.IF.k#3Dh2!p.
&.n#3Dh3!p.RESULTIS.TRUE#0A..15p.:#3D.!p#0A..13}#0A
..RESULTIS.FALSE#0A}#0A#0AAND.inreg_b(k,.n).#3D.VAL
OF#0A{.LET.p.#3D.info_b#0A..IF.k#3Dk_b.RESULTIS.TRU
E#0A..UNTIL.p#3D0.DO.{.IF.k#3Dh2!p.&.n#3Dh3!p.RESUL
TIS.TRUE#0A..15p.:#3D.!p#0A..13}#0A..RESULTIS.FALSE
#0A}#0A#0AAND.addinfo_a(k,.n).BE.info_a.:#3D.getblk
(info_a,.k,.n)#0A#0AAND.addinfo_b(k,.n).BE.info_b.:
#3D.getblk(info_b,.k,.n)#0A#0AAND.xchinfo().BE#0A{.
LET.t.#3D.info_a#0A..info_a.:#3D.info_b#0A..info_b.
:#3D.t#0A}#0A#0AAND.atbinfo().BE#0A{.LET.p.#3D.info
_a#0A..forget_b()#0A..UNTIL.p#3D0.DO.{.addinfo_b(h2
!p,.h3!p);.p.:#3D.!p.}#0A}#0A#0AAND.btainfo().BE#0A
{.LET.p.#3D.info_b#0A..forget_a()#0A..UNTIL.p#3D0.D
O.{.addinfo_a(h2!p,.h3!p);.p.:#3D.!p.}#0A}#0A#0AAND
.forget_a().BE.{.freeblks(info_a);.info_a.:#3D.0.}#0A
#0AAND.forget_b().BE.{.freeblks(info_b);.info_b.:#3D
.0.}#0A#0AAND.forgetall().BE.{.forget_a();.forget_b
().}#0A#0A//.Forgetvar.is.called.just.after.a.simpl
e.variable.(k,.n).has.been#0A//.updated#2E..k.is.k_
loc,.k_glob.or.k_lab#2E..Note.that.register#0A//.in
fomation.about.indirect.local.and.global.values#0A/
/.must.also.be.thrown.away#2E#0AAND.forgetvar(k,.n)
.BE#0A{.LET.p.#3D.info_a#0A..UNTIL.p#3D0.DO.{.IF.h2
!p>#3Dk_lock.|.h2!p#3Dk.&.h3!p#3Dn.DO.h2!p.:#3D.k_n
one#0A..15p.:#3D.!p#0A..13}#0A..p.:#3D.info_b#0A..U
NTIL.p#3D0.DO.{.IF.h2!p>#3Dk_lock.|.h2!p#3Dk.&.h3!p
#3Dn.DO.h2!p.:#3D.k_none#0A..15p.:#3D.!p#0A..13}#0A
}#0A#0AAND.forgetallvars().BE..//.Called.after.STIN
D.or.PUTBYTE#2E#0A{.LET.p.#3D.info_a#0A..UNTIL.p#3D
0.DO.{.IF.h2!p>#3Dk_loc.DO.h2!p.:#3D.k_none#0A..15p
.:#3D.!p#0A..13}#0A..p.:#3D.info_b#0A..UNTIL.p#3D0.
DO.{.IF.h2!p>#3Dk_loc.DO.h2!p.:#3D.k_none#0A..15p.:
#3D.!p#0A..13}#0A}#0A#0AAND.iszero(a).#3D.h1!a#3Dk_
numb.&.h2!a#3D0.->.TRUE,.FALSE#0A#0AAND.bits24(n).#3D
.-#23xFF4<#3Dn<#3D#23xFF4.->.TRUE,.FALSE#0A#0A//.St
ore.the.value.of.a.SS.item.in.its.true.stack.locati
on#2E#0AAND.storet(x).BE#0A{.LET.s.#3D.h3!x#0A..IF.
h1!x#3Dk_loc.&.h2!x#3Ds.RETURN#0A..loada(x)#0A..gen
sp(s)#0A..forgetvar(k_loc,.s)#0A..addinfo_a(k_loc,.
s)#0A..h1!x,.h2!x.:#3D.k_loc,.s#0A}#0A#0AAND.gensp(
s).BE.genfp(f_sp,.s)#0A#0AAND.genlp(n).BE.genfp(f_l
p,.n)#0A#0A//.Load.an.item.(K,N).onto.the.SS#2E.It.
may.move.SS.items#2E#0AAND.loadt(k,.n).BE#0A{.cgpen
dingop()#0A..TEST.arg1+3#3Dtempt#0A..THEN.{.storet(
tempv)..//.SS.stack.overflow#2E#0A..7FOR.t.#3D.temp
v.TO.arg2+2.DO.t!0.:#3D.t!3#0A..5}#0A..ELSE.arg2,.a
rg1.:#3D.arg2+3,.arg1+3#0A..h1!arg1,h2!arg1,h3!arg1
.:#3D.k,n,ssp#0A..ssp.:#3D.ssp.+.1#0A}#0A#0A//.Repl
ace.the.top.two.SS.items.by.(K,N).and.set.PENDINGOP
#3DS_NONE#2E#0AAND.lose1(k,.n).BE#0A{.ssp.:#3D.ssp.
-.1#0A..TEST.arg2#3Dtempv#0A..THEN.{.h1!arg2,h2!arg
2.:#3D.k_loc,ssp-2#0A..7h3!arg2.:#3D.ssp-2#0A..5}#0A
..ELSE.{.arg1.:#3D.arg2#0A..7arg2.:#3D.arg2-3#0A..5
}#0A..h1!arg1,.h2!arg1,.h3!arg1.:#3D.k,n,ssp-1#0A..
pendingop.:#3D.s_none#0A}#0A#0AAND.swapargs().BE#0A
{.LET.k,.n.#3D.h1!arg1,.h2!arg1#0A..h1!arg1,.h2!arg
1.:#3D.h1!arg2,.h2!arg2#0A..h1!arg2,.h2!arg2.:#3D.k
,.n#0A}#0A#0AAND.cgstind().BE#0A{.LET.t.#3D.VALOF#0A
..{.IF.pendingop#3Ds_add.DO#0A..2{.IF.k_numb#3Dh1!a
rg2.DO.swapargs()#0A..4IF.k_numb#3Dh1!arg1.DO#0A..4
{.LET.n.#3D.h2!arg1#0A..6IF.0<#3Dn<#3D3.DO.{.stack(
ssp-1)#0A..22pendingop.:#3D.s_none#0A..22RESULTIS.n
#0A..20}#0A..4}#0A#0A..4IF.h1!arg2#3Dk_loc.&.3<#3Dh
2!arg2<#3D5.DO.swapargs()#0A..4IF.h1!arg1#3Dk_loc.&
.3<#3Dh2!arg1<#3D5.DO#0A..4{.LET.n.#3D.h2!arg1#0A..
6stack(ssp-1)#0A..6pendingop.:#3D.s_none#0A..6RESUL
TIS.n+1..//.The.codes.for.P3,.P4.and.P5#2E#0A..4}#0A
#0A..4UNLESS.arg2#3Dtempv.DO#0A..4{.LET.arg3.#3D.ar
g2.-.3#0A..6IF.h1!arg3#3Dk_a.DO#0A..6{.IF.h1!arg2#3D
k_loc.|#0A..11h1!arg2#3Dk_glob.|#0A..11h1!arg2#3Dk_
numb.&.bits24(h2!arg2).DO.swapargs()#0A..8IF.h1!arg
1#3Dk_loc.|#0A..11h1!arg1#3Dk_glob.|#0A..11h1!arg1#3D
k_numb.&.bits24(h2!arg1).DO#0A..8//.Optimize.the.ca
se..<arg2>!<arg1>.:#3D.<arg3>#0A..8//.where.<arg3>.
is.already.in.A#0A..8//.and.<arg1>.is.a.local,.a.gl
obal.or.a.number#2E#0A..8{.genf(f_atb)..//.Put.<arg
3>.into.B#0A..10h1!arg3.:#3D.k_b#0A..10cgadd()..3//
.Compiles.an.A,.AP.or.AG.instr#2E#0A..10genf(f_st)#0A
..10stack(ssp-2)#0A..10forgetallvars()#0A..10RETURN
#0A..8}#0A..6}#0A..4}#0A..2}#0A#0A..2cgpendingop()#0A
..2RESULTIS.0#0A..}#0A#0A..//.Now.compile.code.for.
S!<arg1>.:#3D.<arg2>#0A..//.where..9S.is.0,.1,.2,.3
,.P3,.P4.or.P5#0A..//.depending.on..2T.#3D..0000,.1
,.2,.3,..0004,..0005.or..0006#0A#0A..{.LET.k,.n.#3D
.h1!arg1,.h2!arg1#0A..1#0A..2IF.k#3Dk_glob.&.t#3D0.
DO.{.loada(arg2)#0A..25genfkg(f_skg,.0,.n)#0A..25st
ack(ssp-2)#0A..25forgetallvars()#0A..25RETURN#0A..2
3}#0A#0A..2IF.k#3Dk_loc.&.t<#3D3.DO.{.loada(arg2)#0A
..25genfkp(f_stkp,.t,.n)#0A..25stack(ssp-2)#0A..25f
orgetallvars()#0A..25RETURN#0A..23}#0A#0A..2IF.load
both(arg2,.arg1)#3Dswapped.DO#0A..2{.IF.t#3D0.DO.{.
genf(f_xst)#0A..16stack(ssp-2)#0A..16forgetallvars(
)#0A..16RETURN#0A..14}#0A..4genf(f_xch)#0A..4xchinf
o()#0A..2}#0A#0A..2SWITCHON.t.INTO#0A..2{.DEFAULT:#0A
..4CASE.0:.genf(f_st);..6ENDCASE#0A..4CASE.1:#0A..4
CASE.2:#0A..4CASE.3:.genfk(f_stk,.t);..1ENDCASE#0A.
.4CASE.4:#0A..4CASE.5:#0A..4CASE.6:.genfp(f_stp,.t-
1);.ENDCASE#0A..2}#0A#0A..2stack(ssp-2)#0A..2forget
allvars()#0A..}#0A}#0A#0A1//.Store.the.top.item.of.
the.SS.in.(K,N)#2E#0AAND.storein(k,.n).BE#0A//.K.is
.K_LOC,.K_GLOB.or.K_LAB#2E#0A{.IF.pendingop#3Ds_sub
.&.h1!arg1#3Dk_numb.DO#0A..{.pendingop.:#3D.s_add#0A
..2h2!arg1.:#3D.-.h2!arg1#0A..}#0A..IF.pendingop#3D
s_add.DO#0A..{.IF.h1!arg1#3Dk.&.h2!arg1#3Dn.DO.swap
args()#0A..2IF.h1!arg2#3Dk.&.h2!arg2#3Dn.DO#0A..2{.
//.we.have.<arg2>.:#3D.<arg2>.+.<arg1>#0A..4//.wher
e.<arg2>.is.local,.global.or.static#0A..4LET.val.#3D
.h2!arg1#0A..4pendingop.:#3D.s_none#0A..4TEST.h1!ar
g1#3Dk_numb#0A..4THEN.SWITCHON.k.INTO#0A..9{.CASE.k
_loc:..genfkp(f_ikp,.val,.n);.ENDCASE#0A..11CASE.k_
glob:.genfkg(f_ikg,.val,.n);.ENDCASE#0A..11CASE.k_l
ab:..genfkl(f_ikl,.val,.n);.ENDCASE#0A..9}#0A..5#0A
..4ELSE.{.loada(arg1)#0A..11SWITCHON.k.INTO#0A..11{
.CASE.k_loc:..genfp(f_ip,.n);.ENDCASE#0A..13CASE.k_
glob:.genfg(f_ig,.n);.ENDCASE#0A..13CASE.k_lab:..ge
nfl(f_il,.n);.ENDCASE#0A..11}#0A..9}#0A..4forgetvar
(k,.n)#0A..4forget_a()#0A..4addinfo_a(k,.n)#0A..4st
ack(ssp-2)#0A..4RETURN#0A..2}#0A..}#0A#0A..cgpendin
gop()#0A..loada(arg1)#0A#0A..SWITCHON.k.INTO#0A..{.
DEFAULT:..3cgerror("in.storein.%n",.k)#0A..2CASE.k_
loc:..gensp(n);..6ENDCASE#0A..2CASE.k_glob:.genfg(f
_sg,.n);..ENDCASE#0A..2CASE.k_lab:..genfl(f_sl,.n);
..ENDCASE#0A..}#0A..forgetvar(k,.n)#0A..addinfo_a(k
,.n)#0A..stack(ssp-1)#0A}#0A#0ALET.cgrv().BE#0A{.IF
.pendingop#3Ds_add.DO#0A..{.IF.k_numb#3Dh1!arg2.DO.
swapargs()#0A..2IF.k_numb#3Dh1!arg1.DO#0A..2{.LET.k
.#3D.h2!arg1..//.arg2.!.k#0A..4stack(ssp-1)..3//.no
w.arg1.!.k#0A..4pendingop.:#3D.s_none.#0A#0A..4IF.h
1!arg1#3Dk_loc.DO#0A..4{.LET.n.#3D.h2!arg1..//.Pn.!
.k#0A..6h1!arg1,.h2!arg1.:#3D.k_lock.+.(n<<0004),.k
#0A..6RETURN#0A..4}#0A#0A..4IF.h1!arg1#3Dk_glob.DO#0A
..4{.LET.n.#3D.h2!arg1..//.Gn.!.k#0A..6h1!arg1,.h2!
arg1.:#3D.k_globk.+.(n<<0004),.k#0A..6RETURN#0A..4}
#0A#0A..4loada(arg1)#0A..4TEST.k#3D0.THEN.genf(f_rv
)#0A..13ELSE.genfk(f_rvk,.k)#0A..4forget_a()#0A..4h
1!arg1,.h2!arg1.:#3D.k_a,.0#0A..4RETURN#0A..2}#0A#0A
..2IF.k_loc#3Dh1!arg2.DO.swapargs()#0A..2IF.k_loc#3D
h1!arg1.DO#0A..2{.LET.n.#3D.h2!arg1#0A..4loada(arg2
)#0A..4genfp(f_rvp,.n)#0A..4forget_a()#0A..4lose1(k
_a,.0)#0A..4RETURN#0A..2}#0A#0A..}#0A#0A..cgpending
op()#0A#0A..IF.h1!arg1#3Dk_loc.DO#0A..{.LET.n.#3D.h
2!arg1..//.!.Pn#0A..2h1!arg1,.h2!arg1.:#3D.k_lock.+
.(n<<0004),.0#0A..2RETURN#0A..}#0A#0A..IF.h1!arg1#3D
k_glob.DO#0A..{.LET.n.#3D.h2!arg1..//.!.Gn#0A..2h1!
arg1,.h2!arg1.:#3D.k_globk.+.(n<<0004),.0#0A..2RETU
RN#0A..}#0A#0A..loada(arg1)#0A..genf(f_rv)#0A..forg
et_a()#0A..h1!arg1,.h2!arg1.:#3D.k_a,.0#0A}#0A#0AAN
D.cgadd().BE#0A//.Compiles.code.to.compute.<arg2>.+
.<arg1>#2E#0A//.It.does.not.look.at.PENDINGOP#2E#0A
#0A{.IF.iszero(arg1).DO.{.stack(ssp-1);.RETURN.}#0A
#0A..IF.iszero(arg2).DO#0A..{.IF.h2!arg1#3Dssp-1.&#0A
..5(h1!arg1#3Dk_loc.|.(h1!arg1&15)#3Dk_lock).DO.loa
da(arg1)#0A..2lose1(h1!arg1,.h2!arg1)#0A..2RETURN#0A
..}#0A#0A..TEST.inreg_a(h1!arg1,.h2!arg1)#0A..THEN.
loada(arg1)#0A..ELSE.IF.inreg_a(h1!arg2,.h2!arg2).D
O.loada(arg2)#0A#0A..IF.h1!arg1#3Dk_a.DO.swapargs()
#0A#0A..IF.h1!arg2#3Dk_loc.DO.swapargs()#0A..IF.h1!
arg1#3Dk_loc.DO.{.loada(arg2)#0A..22genfp(f_ap,.h2!
arg1)#0A..22forget_a()#0A..22lose1(k_a,.0)#0A..22RE
TURN#0A..20}#0A#0A..IF.h1!arg2#3Dk_numb.DO.swapargs
()#0A..IF.h1!arg1#3Dk_numb.DO.{.loada(arg2)#0A..23c
gaddk(h2!arg1)#0A..23lose1(k_a,.0)#0A..23RETURN#0A.
.21}#0A#0A..IF.h1!arg2#3Dk_glob.DO.swapargs()#0A..I
F.h1!arg1#3Dk_glob.DO.{.loada(arg2)#0A..23genfg(f_a
g,.h2!arg1)#0A..23forget_a()#0A..23lose1(k_a,.0)#0A
..23RETURN#0A..21}#0A..loadboth(arg2,.arg1)#0A..gen
f(f_add)#0A..forget_a()#0A..lose1(k_a,.0)#0A}#0A#0A
AND.cgaddk(k).BE.UNLESS.k#3D0.DO..//.Compile.code.t
o.add.k.to.A#2E#0A{.TEST.k>#3D0#0A..THEN.genfk(f_a,
.k)#0A..ELSE.genfk(f_s,.-k)#0A..forget_a()#0A}#0A#0A
AND.cgk2a(k).BE.//.Compile.code.to.set.k.in.A#2E#0A
{.TEST.k>#3D0#0A..THEN.genfk(f_l,.k)#0A..ELSE.genfk
(f_lm,.-k)#0A..forget_a()#0A}#0A#0AAND.cgglobal(n).
BE#0A{.cgstatics()#0A..incode.:#3D.TRUE#0A..genf(f_
global)#0A..genk(n)#0A..FOR.i.#3D.1.TO.n.DO.{.geng(
rdgn());.genl(rdl()).}#0A..geng(maxgn)#0A}#0A#0A1AN
D.cgentry(l,.n).BE#0A{.LET.v.#3D.VEC.255#0A#0A..v%0
.:#3D.n#0A..FOR.i.#3D.1.TO.n.DO.v%i.:#3D.rdn()#0A#0A
..IF.debug>0.DO.writef("//.Entry.to:..1%s*n",.v)#0A
#0A..incode.:#3D.TRUE#0A..IF.naming.DO.{.genfk(f_en
try,n)#0A..15FOR.i.#3D.1.TO.n.DO.genc(v%i)#0A..13}#0A
#0A..genfl(f_lab,.l)#0A..forgetall()#0A}#0A#0A//.Fu
nction.or.routine.call#2E#0AAND.cgapply(op,.k).BE#0A
{.LET.sa.#3D.k+3..//.Stack.address.of.first.arg.(if
.any)#2E#0A..AND.a1.#3D.0..2//.SS.item.for.first.ar
g.if.found#2E#0A#0A..cgpendingop()#0A#0A//.Deal.wit
h.non.args#2E#0A..FOR.t.#3D.tempv.TO.arg2.BY.3.DO.{
.IF.h3!t>#3Dk.BREAK#0A..32IF.h1!t#3Dk_a.DO.storet(t
)#0A..30}#0A#0A//.Deal.with.args.2,.3.#2E#2E1#0A..F
OR.t.#3D.tempv.TO.arg2.BY.3.DO#0A..{.LET.s.#3D.h3!t
#0A..2IF.s#3Dsa.DO#0A..2{.a1.:#3D.t..//.We.have.fou
nd.the.SS.item.for.the.first.arg#2E#0A..4IF.h1!t#3D
k_a.&.t+3#3Darg2.DO#0A..4//.Two.argument.call.with.
the.first.arg.already.in.A#2E#0A..4{.genf(f_atb)#0A
..6atbinfo()#0A..6h1!t.:#3D.k_b#0A..6storet(arg2)..
1//.Store.second.arg.(without.detroying.B)#2E#0A..6
genf(f_xch)..2//.Restore.first.arg.back.to.A#2E#0A.
.6xchinfo()#0A..6h1!t.:#3D.k_a#0A..6BREAK#0A..4}#0A
..2}#0A..2IF.s>sa.DO.storet(t)#0A..}#0A#0A..//.Move
.first.arg.(if.any).into.A#2E#0A..IF.sa<ssp-1.TEST.
a1#3D0#0A..12THEN.genlp(sa)..//.First.arg.exists.bu
t.not.in.SS#2E#0A..12ELSE.loada(a1)..//.First.arg.e
xists.in.SS#0A#0A..//.First.arg.(if.any).is.now.in.
A#2E#0A#0A..TEST.h1!arg1#3Dk_glob#0A..THEN.genfpg(f
_kpg,.k,.h2!arg1)#0A..ELSE.{.IF.sa<ssp-1.DO.{.genf(
f_atb)#0A..24UNLESS.a1#3D0.DO.h1!a1.:#3D.k_b#0A..24
atbinfo()#0A..22}#0A..7//.First.arg.(if.any).is.now
.in.B#0A..7loada(arg1)#0A..7//.The.procedure.entry.
address.is.now.in.A#2E#0A..7genfp(f_k,.k)#0A..5}#0A
#0A..forgetall()#0A..stack(k)#0A..IF.op#3Ds_fnap.DO
.loadt(k_a,.0)#0A}#0A#0A//.Used.for.OCODE.operators
.JT.and.JF#2E#0AAND.cgjump(b,l).BE#0A{.LET.f.#3D.jm
pfn(pendingop)#0A..IF.f#3D0.DO.{.loadt(k_numb,0);.f
.:#3D.f_jne.}#0A..pendingop.:#3D.s_none#0A..UNLESS.
b.DO.f.:#3D.compjfn(f)#0A..store(0,ssp-3)#0A..genfl
(prepj(f),l)#0A..stack(ssp-2)#0A}#0A#0AAND.jmpfn(op
).#3D.VALOF.SWITCHON.op.INTO#0A{.DEFAULT:..2RESULTI
S.0#0A..CASE.s_eq:..RESULTIS.f_jeq#0A..CASE.s_ne:..
RESULTIS.f_jne#0A..CASE.s_ls:..RESULTIS.f_jls#0A..C
ASE.s_gr:..RESULTIS.f_jgr#0A..CASE.s_le:..RESULTIS.
f_jle#0A..CASE.s_ge:..RESULTIS.f_jge#0A#0A..CASE.s_
feq:.RESULTIS.f_jfeq#0A..CASE.s_fne:.RESULTIS.f_jfn
e#0A..CASE.s_fls:.RESULTIS.f_jfls#0A..CASE.s_fgr:.R
ESULTIS.f_jfgr#0A..CASE.s_fle:.RESULTIS.f_jfle#0A..
CASE.s_fge:.RESULTIS.f_jfge#0A}#0A#0AAND.cgrelop(op
).BE.//.For.integer.relational.operators#0A{.LET.f.
#3D.?#0A#0A..IF.iszero(arg1).DO#0A..{.f.:#3D.VALOF.
SWITCHON.op.INTO#0A..7{.DEFAULT:..1RESULTIS.0#0A..9
CASE.s_eq:.RESULTIS.f_eq0#0A..9CASE.s_ne:.RESULTIS.
f_ne0#0A..9CASE.s_ls:.RESULTIS.f_ls0#0A..9CASE.s_gr
:.RESULTIS.f_gr0#0A..9CASE.s_le:.RESULTIS.f_le0#0A.
.9CASE.s_ge:.RESULTIS.f_ge0#0A..7}#0A..2loada(arg2)
#0A..2lose1(k_a,.0)#0A..2genf(f)#0A..2forget_a()#0A
..2RETURN#0A..}#0A#0A..IF.iszero(arg2).DO#0A..{.f.:
#3D.VALOF.SWITCHON.op.INTO#0A..7{.DEFAULT:..1RESULT
IS.0#0A..9CASE.s_eq:.RESULTIS.f_eq0#0A..9CASE.s_ne:
.RESULTIS.f_ne0#0A..9CASE.s_ls:.RESULTIS.f_gr0#0A..
9CASE.s_gr:.RESULTIS.f_ls0#0A..9CASE.s_le:.RESULTIS
.f_ge0#0A..9CASE.s_ge:.RESULTIS.f_le0#0A..7}#0A..2l
oada(arg1)#0A..2lose1(k_a,.0)#0A..2genf(f)#0A..2for
get_a()#0A..2RETURN#0A..}#0A..#0A..TEST.loadboth(ar
g2,.arg1)#3Dswapped#0A..THEN.f.:#3D.VALOF.SWITCHON.
op.INTO#0A..10{.DEFAULT:..1RESULTIS.0#0A..12CASE.s_
eq:.RESULTIS.f_eq#0A..12CASE.s_ne:.RESULTIS.f_ne#0A
..12CASE.s_ls:.RESULTIS.f_gr#0A..12CASE.s_gr:.RESUL
TIS.f_ls#0A..12CASE.s_le:.RESULTIS.f_ge#0A..12CASE.
s_ge:.RESULTIS.f_le#0A..10}#0A..ELSE.f.:#3D.VALOF.S
WITCHON.op.INTO#0A..10{.DEFAULT:..1RESULTIS.0#0A..1
2CASE.s_eq:.RESULTIS.f_eq#0A..12CASE.s_ne:.RESULTIS
.f_ne#0A..12CASE.s_ls:.RESULTIS.f_ls#0A..12CASE.s_g
r:.RESULTIS.f_gr#0A..12CASE.s_le:.RESULTIS.f_le#0A.
.12CASE.s_ge:.RESULTIS.f_ge#0A..10}#0A#0A..genf(f)#0A
..lose1(k_a,.0)#0A..forget_a()#0A..RETURN#0A}#0A#0A
AND.cgfrelop(op).BE.//.For.floating.point.relationa
l.operators#0A{.LET.f.#3D.?#0A#0A..IF.iszero(arg1).
DO.//.Note.that.0#2E0.#3D.#23x006#0A..19//.so.iszer
o(arg1)#3DTRUE.if.arg1.represents.0#2E0#0A..{.f.:#3D
.VALOF.SWITCHON.op.INTO#0A..7{.DEFAULT:..1RESULTIS.
0#0A..9CASE.s_feq:.RESULTIS.f_feq0#0A..9CASE.s_fne:
.RESULTIS.f_fne0#0A..9CASE.s_fls:.RESULTIS.f_fls0#0A
..9CASE.s_fgr:.RESULTIS.f_fgr0#0A..9CASE.s_fle:.RES
ULTIS.f_fle0#0A..9CASE.s_fge:.RESULTIS.f_fge0#0A..7
}#0A..2loada(arg2)#0A..2lose1(k_a,.0)#0A..2genf(f)#0A
..2forget_a()#0A..2RETURN#0A..}#0A#0A..IF.iszero(ar
g2).DO.//.Note.that.0#2E0.#3D.#23x006#0A..19//.so.i
szero(arg1)#3DTRUE.if.arg1.represents.0#2E0#0A..{.f
.:#3D.VALOF.SWITCHON.op.INTO#0A..7{.DEFAULT:..1RESU
LTIS.0#0A..9CASE.s_feq:.RESULTIS.f_feq0#0A..9CASE.s
_fne:.RESULTIS.f_fne0#0A..9CASE.s_fls:.RESULTIS.f_f
gr0#0A..9CASE.s_fgr:.RESULTIS.f_fls0#0A..9CASE.s_fl
e:.RESULTIS.f_fge0#0A..9CASE.s_fge:.RESULTIS.f_fle0
#0A..7}#0A..2loada(arg1)#0A..2lose1(k_a,.0)#0A..2ge
nf(f)#0A..2forget_a()#0A..2RETURN#0A..}#0A..#0A..TE
ST.loadboth(arg2,.arg1)#3Dswapped#0A..THEN.f.:#3D.V
ALOF.SWITCHON.op.INTO#0A..10{.DEFAULT:..1RESULTIS.0
#0A..12CASE.s_feq:.RESULTIS.f_feq#0A..12CASE.s_fne:
.RESULTIS.f_fne#0A..12CASE.s_fls:.RESULTIS.f_fgr#0A
..12CASE.s_fgr:.RESULTIS.f_fls#0A..12CASE.s_fle:.RE
SULTIS.f_fge#0A..12CASE.s_fge:.RESULTIS.f_fle#0A..1
0}#0A..ELSE.f.:#3D.VALOF.SWITCHON.op.INTO#0A..10{.D
EFAULT:..1RESULTIS.0#0A..12CASE.s_feq:.RESULTIS.f_f
eq#0A..12CASE.s_fne:.RESULTIS.f_fne#0A..12CASE.s_fl
s:.RESULTIS.f_fls#0A..12CASE.s_fgr:.RESULTIS.f_fgr#0A
..12CASE.s_fle:.RESULTIS.f_fle#0A..12CASE.s_fge:.RE
SULTIS.f_fge#0A..10}#0A#0A..genf(f)#0A..lose1(k_a,.
0)#0A..forget_a()#0A..RETURN#0A}#0A#0AAND.jfn0(f).#3D
.f+6.//.Change.F_JEQ..into.F_JEQ0..etc#2E#2E1#0A..1
6//.and..2F_JFEQ.into.F_JFEQ0..etc#2E#2E1#0A#0AAND.
revjfn(f).#3D.f#3Df_jls.->.f_jgr,#0A..14f#3Df_jgr.-
>.f_jls,#0A..14f#3Df_jle.->.f_jge,#0A..14f#3Df_jge.
->.f_jle,#0A..14f#0A#0AAND.compjfn(f).#3D.f#3Df_jeq
..->.f_jne,#0A..15f#3Df_jne..->.f_jeq,#0A..15f#3Df_
jls..->.f_jge,#0A..15f#3Df_jge..->.f_jls,#0A..15f#3D
f_jgr..->.f_jle,#0A..15f#3Df_jle..->.f_jgr,#0A#0A..
15f#3Df_jfeq.->.f_jfne,#0A..15f#3Df_jfne.->.f_jfeq,
#0A..15f#3Df_jfls.->.f_jfge,#0A..15f#3Df_jfge.->.f_
jfls,#0A..15f#3Df_jfgr.->.f_jfle,#0A..15f#3Df_jfle.
->.f_jfgr,#0A..15f#0A#0AAND.prepj(f).#3D.VALOF..//.
Returns.the.appropriate.m/c.fn#2E#0A..20//.It.works
.for.both.integer.and#0A..20//.floating.point.relat
ions#2E#0A{.IF.iszero(arg2).DO.{.swapargs();.f.:#3D
.revjfn(f).}#0A..IF.iszero(arg1).DO.{.loada(arg2);.
RESULTIS.jfn0(f).}#0A..IF.loadboth(arg2,.arg1)#3Dsw
apped.RESULTIS.revjfn(f)#0A..RESULTIS.f#0A}#0A#0A//
.Compiles.code.for.SWITCHON#2E#0ALET.cgswitch().BE#0A
{.//.The.switch.expression.value.is.on.top.of.the.s
tack#0A..LET.n.#3D.rdn()..3//.Number.of.cases#2E#0A
..LET.dlab.#3D.rdl()..//.Default.label#2E#0A#0A..//
.Read.and.sort.(K,L).pairs.sorting.them.into.increa
sing.k.order#2E#0A..FOR.i.#3D.1.TO.n.DO#0A..{.LET.k
.#3D.rdn()#0A..2LET.l.#3D.rdl()#0A..2LET.j.#3D.i-1#0A
..2UNTIL.j#3D0.DO..{.IF.k.>.casek!j.BREAK#0A..18cas
ek!(j+1),.casel!(j+1).:#3D.casek!j,.casel!j#0A..18j
.:#3D.j.-.1#0A..16}#0A..2casek!(j+1),.casel!(j+1).:
#3D.k,.l#0A..}#0A#0A..cgpendingop()#0A..store(0,.ss
p-2)#0A..loada(arg1)..4//.A.:#3D.switch.value#0A..s
tack(ssp-1)#0A#0A..//.If.there.are.no.cases,.so.jum
p.the.default.label#0A..IF.n#3D0.DO.{.genfl(f_j,.dl
ab);.RETURN.}#0A#0A..//genf(f_res).//.Ensure.the.sw
itch.value.is.in.A#0A..switcht(1,.n,.dlab,.FALSE)#0A
}#0A#0AAND.prcases(p,.q).BE#0A{.writef("*nprcases:.
p#3D%n.q#3D%n*n",.p,.q)#0A..FOR.i.#3D.p.TO.q.DO#0A.
.{.IF.(i-p).MOD.8.#3D.0.DO.newline()#0A..2writef(".
%11i",.casek!i)#0A..}#0A..newline()#0A}#0A#0AAND.sw
itcht(p,.q,.dlab,.inb).BE#0A{.//.If.inb#3DTRUE,..th
e.switch.value.is.in.B#0A..//.If.inb#3DFALSE,.the.s
witch.value.is.in.A#2E#0A..//.Compile.code.for.case
s.in.the.region.region.p.to.q#0A..//.and.default.la
bel.dlab#2E#0A..LET.n.#3D.q-p+1..2//.Number.of.case
s.in.region.p#2E#2Eq#0A..LET.r.#3D.(p+q)/2.+.1.//.O
nly.used.if.n>#3D4#0A..LET.s.#3D.r#0A#0A..IF.n<4.DO
#0A..{.//.There.are.less.than.4.cases.so.use.equali
ty.tests#2E#0A..2//.Set.B.#3D.switch.value#0A..2UNL
ESS.n#3D0.UNLESS.inb.DO.genf(f_atb)#0A..2FOR.i.#3D.
p.TO.q.DO#0A..2{.cgk2a(casek!i)#0A..4genfl(f_jeq,.c
asel!i)#0A..2}#0A..2genfl(f_j,.dlab)#0A..2forgetall
()#0A..2RETURN#0A..}#0A#0A..//.There.are.at.least.f
our.cases.in.region.p.#2E#2E.q#0A#0A//writef("switc
ht:.p#3D%n.q#3D%n.casek!p#3D%n,.casek!q#3D%n,.diff#3D
%n*n",#0A//..15p,..1q,..1casek!p,..2casek!q,..2case
k!q-casek!p)#0A//prcases(p,.q)#0A//abort(1000002)#0A
#0A..//.Find.the.middle.segment#0A..WHILE.p<r.&.0.<
#3D.casek!s-casek!(r-1).<#3D.#23xFF2.DO.r.:#3D.r-1#0A
..WHILE.s<q.&.0.<#3D.casek!(s+1)-casek!r.<#3D.#23xF
F2.DO.s.:#3D.s+1#0A#0A..//.r#2E#2Es.is.a.region.of.
case.constants.including.the.mid.point#0A..//.of.re
gion.p#2E#2Eq,.and.for.which#0A..//.0.<#3D.casek!i.
-.casek!r.<#3D.#23xFF2.for.all.i.in.r#2E#2Es#0A#0A/
/writef("switcht:.r#3D%n.s#3D%n*n",r,s)#0A//abort(1
001)#0A/*#0A..IF.n<#3D3.IF.p<r.|.s<q..DO#0A..{.//.U
se.a.sequence.of.equality.tests#2E#0A..2UNLESS.inb.
DO.genf(f_atb)#0A..2FOR.i.#3D.p.TO.q.DO#0A..2{.cgk2
a(casek!i)#0A..4genfl(f_jeq,.casel!i).//.Leaves.val
ues.in.A.and.B.unchanged#0A..2}#0A..2genfl(f_j,.dla
b)#0A..2forgetall()#0A..2RETURN#0A..}#0A*/#0A..IF.p
<r.DO#0A..{.//.At.least.one.case.in.LH.region.p.#2E
#2E.r-1#0A..2//.Set.B.#3D.switch.value.and.A.#3D.th
e.case.constant#0A..2LET.lab.#3D.newlab()#0A..2UNLE
SS.inb.DO.genf(f_atb)#0A..2cgk2a(casek!r)#0A..2genf
(f_res)#0A..2genfl(f_jge,.lab).//.J.if.switch.value
.not.in.LH.region#0A..2switcht(p,.r-1,.dlab,.TRUE)#0A
..2genfl(f_lab,.lab)#0A..2genf(f_ldres)..//.B.#3D.s
witch.value,.A.#3D.casek!r.but.not.used#0A..2switch
t(r,.q,..1dlab,.TRUE)#0A..2RETURN#0A..}#0A#0A..IF.s
<q.DO#0A..{.//.At.least.one.case.in.RH.region.s+1.#2E
#2E.q#0A..2//.Set.B.#3D.switch.value.and.A.#3D.case
k!s#0A..2LET.lab.#3D.newlab()#0A..2UNLESS.inb.DO.ge
nf(f_atb)#0A..2cgk2a(casek!s)#0A..2genf(f_res)#0A..
2genfl(f_jgr,.lab)#0A..2switcht(p,..1s,.dlab,.TRUE)
#0A..2genfl(f_lab,.lab)#0A..2genf(f_ldres)..//.B.#3D
.switch.value,.A.#3D.casek!r.but.not.used#0A..2swit
cht(s+1,.q,.dlab,.TRUE)#0A..2RETURN#0A..}#0A#0A..IF
.inb.DO.genf(f_xch).//.Put.B.back.in.A,.if.necessar
y#2E#0A..switchseg(r,.s,.dlab)#0A..forgetall()#0A}#0A
#0AAND.offsetcases(p,.q,.offset).BE.IF.offset.DO#0A
{.//.Subtract.offset.from.all.case.constants.in.the
.region.p.to.q#0A#0A//writef("offsetcases.p#3D%n.q#3D
%n.offset#3D%n*n",.p,.q,.offset)#0A//prcases(p,.q)#0A
..1#0A..FOR.i.#3D.p.TO.q..DO.casek!i.:#3D.casek!i.-
.offset#0A}#0A#0AAND.switchseg(p,.q,.dlab).BE#0A{./
/.Only.called#0A..//.when..0000.<#3D.casek!i.-.case
k!p.<#3D.#23xFF2.for.all.i.in.p#2E#2Eq#0A..//.and..
1p.<#3D.q#0A..//.and.A.holds.the.switch.value#0A..L
ET.n.#3D.q-p+1..//.The.number.of.cases.(>#3D1)#2E#0A
#0A//writef("switchseg:.n#3D%n.casek!p#3D%n.casek!q
#3D%n*n",.n,.casek!p,.casek!q)#0A//prcases(p,.q)#0A
//abort(1000001)#0A#0A..TEST.2*n.<.casek!q.-.casek!
p..//.Which.is.generates.less.code?#0A..THEN.switch
b(p,.q,.dlab)..4//.Binary.chop.switch#2E#0A..ELSE.s
witchl(p,.q,.dlab)..4//.Label.vector.switch#2E#0A}#0A
#0AAND.switchb(p,.q,.dlab).BE..//.Binary.chop.switc
h#2E#0A{.//.Only.called.when..0000.<#3D.casek!q.-.c
asek!p.<#3D.#23xFF2#0A..//..12and..p.<.q#0A..//.and
.A.holds.the.switch.value#0A..LET.n.#3D.q-p+1..1//.
Number.of.cases.(>1)#2E#0A..LET.n1.#3D.n>7.->n,.7#0A
..1#0A//writef("switchb:.n#3D%n.casek!p#3D%n.casek!
p#3D%n*n",.n,.casek!p,.casek!q)#0A//prcases(p,.q)#0A
//abort(1001)#0A..//.Ensure.that.all.case.constants
.can.be.represented.by#0A..//.unsigned.16.bit.integ
ers#2E#0A..IF.casek!p<0.|.casek!q>#23xFF2.DO#0A..{.
cgaddk(-casek!p)#0A..2offsetcases(p,.q,.casek!p)#0A
..}#0A..1#0A..genf(f_swb)#0A..genk(n)#0A..genl(dlab
)#0A..FOR.i.#3D.p.TO.q.DO.{.LET.pos.#3D.q.+.1.-.fin
dpos(i-p+1,.q-p+1)#0A..20genk(casek!pos)#0A..20genl
(casel!pos)#0A..18}#0A}#0A#0A//.If.the.integers.1#2E
#2En.were.stored.in.a.balanced.binary#0A//.tree.usi
ng.the.tree.structure.of.heap.sort,.then#0A//.integ
er.i.would.be.at.position.findpos(i,.n)#2E#0AAND.fi
ndpos(i,.n).#3D.VALOF#0A{.LET.r.#3D.?#0A..IF.i.#3D.
1.DO.{.swlpos,.swrpos.:#3D.0,.n#0A..14RESULTIS.root
pos(0,.n)#0A..12}#0A..r.:#3D.findpos(i/2,.n)#0A..TE
ST.(i&1).#3D.0.THEN.swrpos.:#3D.r-1#0A..15ELSE.swlp
os.:#3D.r#0A..RESULTIS.rootpos(swlpos,.swrpos)#0A}#0A
#0AAND.rootpos(p,.q).#3D.VALOF#0A{.LET.n.#3D.q-p#0A
..LET.s,.r.#3D.2,.?#0A..UNTIL.s>n.DO.s.:#3D.s+s#0A.
.s.:#3D.s/2#0A..r.:#3D.n-s+1#0A..IF.s.<#3D.r+r.RESU
LTIS.p.+.s#0A..RESULTIS.p.+.s/2.+.r#0A}#0A#0AAND.sw
itchl(p,.q,.dlab).BE..//.Label.vector.switch#2E#0A{
.//.Only.called.when..0000.<#3D.casek!q.-.casek!p.<
#3D.#23xFF2#0A..//..12and..p.<.q#0A..//.and.A.holds
.the.switch.value#0A#0A..LET.n,.t.#3D.?,.p#0A#0A../
/.Adjust.case.constants.to.suit.SWL.instruction#2E#0A
..IF.casek!p<0.|.casek!p>1.|.casek!q>#23xFF2.DO#0A.
.{.cgaddk(-casek!p)#0A..2offsetcases(p,.q,.casek!p)
#0A..}#0A..1#0A..n.:#3D.casek!q.+.1..1//.Number.of.
entries.in.the.label.vector#2E#0A..genf(f_swl)#0A..
genk(n)#0A..genl(dlab)..6//.Default.label#2E#0A#0A.
.FOR.k.#3D.0.TO.casek!q.TEST.casek!t#3Dk#0A..21THEN
.{.genl(casel!t)#0A..28t.:#3D.t+1#0A..26}#0A..21ELS
E.genl(dlab)#0A}#0A#0AAND.cgstring(n).BE#0A{.LET.l,
.a.#3D.newlab(),.n#0A..loadt(k_lstr,.l)#0A..{.LET.b
,.c,.d.#3D.0,.0,.0#0A..2IF.n>0.DO.b.:#3D.rdn()#0A..
2IF.n>1.DO.c.:#3D.rdn()#0A..2IF.n>2.DO.d.:#3D.rdn()
#0A..2!sliste.:#3D.getblk(0,l,((d<<0008|c)<<0008|b)
<<0008|a)#0A..2sliste.:#3D.!sliste#0A..2l.:#3D.0#0A
..2IF.n<#3D3.BREAK#0A..2n,.a.:#3D.n-4,.rdn()#0A..}.
REPEAT#0A}#0A#0AAND.cgstatics().BE#0A{.incode.:#3D.
TRUE#0A#0A..UNTIL.clist#3D0.DO..//.List.of.24-32.bi
t.constants#0A..{.LET.blk.#3D.clist#0A..2clist.:#3D
.!clist#0A..2genfmw(f_const,.h2!blk,.h3!blk)#0A..2f
reeblk(blk)#0A..}#0A..cliste.:#3D.@clist#0A#0A..UNT
IL.tlist#3D0.DO..//.Static.variables.and.tables#0A.
.{.LET.len,.nl.#3D.0,.tlist#0A..2len,.nl.:#3D.len+1
,.!nl.REPEATUNTIL.nl#3D0.|.h2!nl.~#3D.0#0A#0A..2gen
flk(f_static,.h2!tlist,.len)..//.tlist.always.start
s.labelled#2E#0A#0A..2FOR.i.#3D.1.TO.len.DO#0A..2{.
LET.blk.#3D.tlist#0A..4tlist.:#3D.!tlist#0A..4freeb
lk(blk)#0A..4genw(h3!blk)#0A..2}#0A..}#0A..tliste.:
#3D.@tlist#0A#0A..UNTIL.slist#3D0.DO..//.String.con
stants#0A..{.LET.n.#3D.h3!slist.&.255#0A..2LET.lenb
yte.#3D.TRUE#0A..2genfm(f_string,.h2!slist)..//.SLI
ST.always.starts.labelled#2E#0A#0A..2{.LET.blk.#3D.
slist#0A..4LET.w.#3D.h3!blk#0A..4slist.:#3D.!slist#0A
..4TEST.lenbyte.THEN.{.genk(w.&.255);.lenbyte.:#3D.
FALSE.}#0A..17ELSE..2genc(w.&.255)#0A..4IF.n>#3D1.D
O.genc(w>>0008..&.255)#0A..4IF.n>#3D2.DO.genc(w>>00
016.&.255)#0A..4IF.n>#3D3.DO.genc(w>>00024.&.255)#0A
..4n.:#3D.n-4#0A..4freeblk(blk)#0A..2}.REPEATUNTIL.
slist#3D0.|.h2!slist.~#3D.0#0A..}#0A..sliste.:#3D.@
slist#0A..incode.:#3D.FALSE#0A}#0A#0A2AND.getblk(a,
.b,.c).#3D.VALOF#0A{.LET.p.#3D.freelist#0A..TEST.p#3D
0.THEN.{.dp.:#3D.dp-3;.checkspace();.p.:#3D.dp.}#0A
..9ELSE.freelist.:#3D.!p#0A..h1!p,.h2!p,.h3!p.:#3D.
a,.b,.c#0A..RESULTIS.p#0A}#0A#0A1AND.freeblk(p).BE.
{.!p.:#3D.freelist;.freelist.:#3D.p.}#0A#0AAND.free
blks(p).BE.UNLESS.p#3D0.DO#0A{.LET.oldfreelist.#3D.
freelist#0A..freelist.:#3D.p#0A..UNTIL.!p#3D0.DO.p.
:#3D.!p#0A..!p.:#3D.oldfreelist#0A}#0A#0A1AND.initd
atalists().BE#0A{.tlist,..1tliste..1:#3D.0,.@tlist#0A
..slist,..1sliste..1:#3D.0,.@slist#0A..clist,..1cli
ste..1:#3D.0,.@clist#0A..freelist.:#3D.0#0A}#0A#0AL
ET.codef(x).BE#0A{.progsize.:#3D.progsize.+.1#0A..c
odelayout.:#3D.0#0A..writef("*nF%n",.x)#0A}#0A#0ALE
T.wrarg(form,.x).BE#0A{.codelayout.:#3D.codelayout+
1#0A..IF.codelayout.MOD.10.#3D.0.DO.newline()#0A..w
ritef(form,.x)#0A}#0A#0ALET.codep(x).BE.wrarg(".P%n
",.x)#0A#0ALET.codeg(x).BE.wrarg(".G%n",.x)#0A#0ALE
T.codek(x).BE.wrarg(".K%n",.x)#0A#0ALET.codew(x).BE
.wrarg(".W%n",.x)#0A#0ALET.codec(x).BE.wrarg(".C%n"
,.x)#0A#0ALET.codel(x).BE.wrarg(".L%n",.x)#0A#0ALET
.codem(x).BE.wrarg(".M%n",.x)#0A#0A1LET.genfp(f,.a)
.BE.IF.incode.DO#0A{.IF.debug>0.DO.wrcode(f,.a)#0A.
.codef(f)#0A..codep(a)#0A}#0A#0ALET.genfkp(f,.k,.a)
.BE.IF.incode.DO#0A{.IF.debug>0.DO.wrcode(f,.k,.a)#0A
..codef(f)#0A..codek(k)#0A..codep(a)#0A}#0A#0ALET.g
enfkp(f,.k,.a).BE.IF.incode.DO#0A{.IF.debug>0.DO.wr
code(f,.k,.a)#0A..codef(f)#0A..codek(k)#0A..codep(a
)#0A}#0A#0ALET.genfg(f,.n).BE.IF.incode.DO.#0A{..IF
.debug>0.DO.wrcode(f,.n)#0A..1codef(f)#0A..1codeg(n
)#0A}#0A#0ALET.genfkg(f,.k,.n).BE.IF.incode.DO.#0A{
..IF.debug>0.DO.wrcode(f,.k,.n)#0A..1codef(f)#0A..1
codek(k)#0A..1codeg(n)#0A}#0A#0ALET.genfpg(f,.p,.n)
.BE.IF.incode.DO.#0A{.IF.debug>0.DO.wrcode(f,.p,.n)
#0A..1codef(f)#0A..1codep(p)#0A..1codeg(n)#0A}#0A#0A
LET.genfk(f,.a).BE.IF.incode.DO#0A{.IF.debug>0.DO.w
rcode(f,.a)#0A..codef(f)#0A..codek(a)#0A}#0A#0ALET.
genfkl(f,.a,.l).BE.IF.incode.DO#0A{.IF.debug>0.DO.w
rcode(f,.a,.l)#0A..codef(f)#0A..codek(a)#0A..codel(
l)#0A}#0A#0ALET.genfw(f,.w).BE.IF.incode.DO#0A{.IF.
debug>0.DO.wrcode(f,.w)#0A..codef(f)#0A..codew(w)#0A
}#0A#0ALET.genfl(f,.n).BE.IF.incode.DO#0A{.IF.debug
>0.DO.wrcode(f,.n)#0A..codef(f)#0A..codel(n)#0A}#0A
#0ALET.genflk(f,.n,.k).BE.IF.incode.DO#0A{.IF.debug
>0.DO.wrcode(f,.n,.k)#0A..codef(f)#0A..codel(n)#0A.
.codek(k)#0A}#0A#0ALET.genfm(f,.n).BE.IF.incode.DO#0A
{.IF.debug>0.DO.wrcode(f,.n)#0A..codef(f)#0A..codem
(n)#0A}#0A#0ALET.genfmw(f,.n,.w).BE.IF.incode.DO#0A
{.IF.debug>0.DO.wrcode(f,.n,.w)#0A..codef(f)#0A..co
dem(n)#0A..codew(w)#0A}#0A#0ALET.genf(f).BE.IF.inco
de.DO#0A{.IF.debug>0.DO.wrcode(f)#0A..codef(f)#0A}#0A
#0ALET.geng(n).BE.IF.incode.DO#0A{.#0A..codeg(n)#0A
}#0A#0ALET.genc(c).BE.IF.incode.DO#0A{.#0A..codec(c
)#0A}#0A#0ALET.genk(k).BE.IF.incode.DO#0A{.#0A..cod
ek(k)#0A}#0A#0ALET.genw(w).BE.IF.incode.DO#0A{.#0A.
.codew(w)#0A}#0A#0ALET.genl(lab).BE.IF.incode.DO#0A
{.#0A..codel(lab)#0A}#0A#0AAND.checkspace().BE.IF.d
p<dpbase.DO#0A{.cgerror("Program.too.large")#0A..er
rcount.:#3D.errcount+1#0A..longjump(fin_p,.fin_l)#0A
}#0A#0AAND.dboutput().BE#0A{.LET.p.#3D.info_a#0A..w
rites("A#3D(")#0A..UNTIL.p#3D0.DO.{.wrkn(h2!p,.h3!p
)#0A..15p.:#3D.!p#0A..15UNLESS.p#3D0.DO.wrch('*s')#0A
..13}#0A..2#0A..p.:#3D.info_b#0A..writes(").B#3D(")
#0A..UNTIL.p#3D0.DO.{.wrkn(h2!p,.h3!p)#0A..15p.:#3D
.!p#0A..15UNLESS.p#3D0.DO.wrch('*s')#0A..13}#0A..wr
ch(')')#0A..1#0A..IF.debug#3D2.DO.{.writes("..STK:.
")#0A..16FOR.p#3Dtempv.TO.arg1.BY.3..DO#0A..16{.IF.
(p-tempv).REM.30.#3D.10.DO.newline()#0A..18wrkn(h1!
p,h2!p)#0A..18wrch('*s')#0A..16}#0A..14}#0A..1#0A..
newline()#0A}#0A#0A1AND.wrkn(k,n).BE#0A{.LET.s.#3D.
VALOF.SWITCHON.k.INTO#0A..{.DEFAULT:..5k.:#3D.n#0A.
.17RESULTIS."?"#0A..2CASE.k_none:..1RESULTIS."-"#0A
..2CASE.k_numb:..1RESULTIS."N%n"#0A..2CASE.k_fnlab:
..RESULTIS."F%n"#0A..2CASE.k_lvloc:..RESULTIS."@P%n
"#0A..2CASE.k_lvglob:.RESULTIS."@G%n"#0A..2CASE.k_l
vlab:..RESULTIS."@L%n"#0A..2CASE.k_lstr:..1RESULTIS
."S%n"#0A..2CASE.k_lw:..3RESULTIS."W%n"#0A..2CASE.k
_a:..4RESULTIS."A"#0A..2CASE.k_b:..4RESULTIS."B"#0A
..2CASE.k_c:..4RESULTIS."C"#0A..2CASE.k_loc:..2RESU
LTIS."P%n"#0A..2CASE.k_glob:..1RESULTIS."G%n"#0A..2
CASE.k_lab:..2RESULTIS."L%n"#0A..2CASE.k_lock:..1RE
SULTIS."%nP%n"#0A..2CASE.k_globk:..RESULTIS."%nG%n"
#0A..}#0A..writef(s,.n,.k>>0004)#0A}#0A#0AAND.wrcod
e(f,.a,.b).BE#0A{.LET.form.#3D.VALOF.SWITCHON.f.INT
O#0A..{.DEFAULT:..5RESULTIS."-"#0A#0A..2CASE.f_lp:.
.3RESULTIS."LP..2P%n"#0A..2CASE.f_lg:..3RESULTIS."L
G..2G%n"#0A..2CASE.f_ll:..3RESULTIS."LL..2L%n"#0A#0A
..2CASE.f_llp:..2RESULTIS."LLP..1P%n"#0A..2CASE.f_l
lg:..2RESULTIS."LLG..1G%n"#0A..2CASE.f_ll1:..2RESUL
TIS."LL1..1L%n"#0A..2CASE.f_lf:..3RESULTIS."LF..2L%
n"#0A..2CASE.f_lw:..3RESULTIS."LW..2M%n"#0A#0A..2CA
SE.f_l:..4RESULTIS."L..3K%n"#0A..2CASE.f_lm:..3RESU
LTIS."LM..2K%n"#0A#0A..2CASE.f_sp:..3RESULTIS."SP..
2P%n"#0A..2CASE.f_sg:..3RESULTIS."SG..2G%n"#0A..2CA
SE.f_sl:..3RESULTIS."SL..2L%n"#0A#0A..2CASE.f_ap:..
3RESULTIS."AP..2P%n"#0A..2CASE.f_ag:..3RESULTIS."AG
..2G%n"#0A..2CASE.f_a:..4RESULTIS."A..3K%n"#0A..2CA
SE.f_s:..4RESULTIS."S..3K%n"#0A#0A..2CASE.f_lkp:..2
RESULTIS."LKP..1K%n.P%n"#0A..2CASE.f_lkg:..2RESULTI
S."LKG..1K%n.P%n"#0A..2CASE.f_rv:..3RESULTIS."RV"#0A
..2CASE.f_rvp:..2RESULTIS."RVP..1P%n"#0A..2CASE.f_r
vk:..2RESULTIS."RVK..1K%n"#0A..2CASE.f_st:..3RESULT
IS."ST"#0A..2CASE.f_stp:..2RESULTIS."STP..1P%n"#0A.
.2CASE.f_stk:..2RESULTIS."STK..1K%n"#0A..2CASE.f_st
kp:..1RESULTIS."STKP..K%n.P%n"#0A..2CASE.f_skg:..2R
ESULTIS."SKG..1K%n.G%n"#0A..2CASE.f_xst:..2RESULTIS
."XST"#0A#0A..2CASE.f_k:..4RESULTIS."K..3P%n"#0A..2
CASE.f_kpg:..2RESULTIS."KPG..1P%n.G%n"#0A#0A..2CASE
.f_neg:..2RESULTIS."NEG"#0A..2CASE.f_not:..2RESULTI
S."NOT"#0A..2CASE.f_abs:..2RESULTIS."ABS"#0A#0A..2C
ASE.f_xdiv:..1RESULTIS."XDIV"#0A..2CASE.f_xrem:..1R
ESULTIS."XREM"#0A..2CASE.f_xsub:..1RESULTIS."XSUB"#0A
#0A..2CASE.f_mul:..2RESULTIS."MUL"#0A..2CASE.f_div:
..2RESULTIS."DIV"#0A..2CASE.f_rem:..2RESULTIS."REM"
#0A..2CASE.f_res:..2RESULTIS."RES"#0A..2CASE.f_add:
..2RESULTIS."ADD"#0A..2CASE.f_sub:..2RESULTIS."SUB"
#0A#0A..2CASE.f_eq:..3RESULTIS."EQ"#0A..2CASE.f_ne:
..3RESULTIS."NE"#0A..2CASE.f_ls:..3RESULTIS."LS"#0A
..2CASE.f_gr:..3RESULTIS."GR"#0A..2CASE.f_le:..3RES
ULTIS."LE"#0A..2CASE.f_ge:..3RESULTIS."GE"#0A..2CAS
E.f_eq0:..2RESULTIS."EQ0"#0A..2CASE.f_ne0:..2RESULT
IS."NE0"#0A..2CASE.f_ls0:..2RESULTIS."LS0"#0A..2CAS
E.f_gr0:..2RESULTIS."GR0"#0A..2CASE.f_le0:..2RESULT
IS."LE0"#0A..2CASE.f_ge0:..2RESULTIS."GE0"#0A#0A..2
CASE.f_lsh:..2RESULTIS."LSH"#0A..2CASE.f_rsh:..2RES
ULTIS."RSH"#0A..2CASE.f_and:..2RESULTIS."AND"#0A..2
CASE.f_or:..3RESULTIS."OR"#0A..2CASE.f_xor:..2RESUL
TIS."XOR"#0A..2CASE.f_eqv:..2RESULTIS."EQV"#0A#0A..
2CASE.f_gbyt:..1RESULTIS."GBYT"#0A..2CASE.f_xgbyt:.
.RESULTIS."XGBYT"#0A..2CASE.f_pbyt:..1RESULTIS."PBY
T"#0A..2CASE.f_xpbyt:..RESULTIS."XPBYT"#0A#0A..2CAS
E.f_swb:..2RESULTIS."SWB"#0A..2CASE.f_swl:..2RESULT
IS."SWL"#0A#0A..2CASE.f_xch:..2RESULTIS."XCH"#0A..2
CASE.f_atb:..2RESULTIS."ATB"#0A..2CASE.f_atc:..2RES
ULTIS."ATC"#0A..2CASE.f_bta:..2RESULTIS."BTA"#0A..2
CASE.f_btc:..2RESULTIS."BTC"#0A..2CASE.f_atblp:..RE
SULTIS."ATBLP.P%n"#0A..2CASE.f_atblg:..RESULTIS."AT
BLG.G%n"#0A..2CASE.f_atbl:..1RESULTIS."ATBL..K%n"#0A
#0A..2CASE.f_j:..4RESULTIS."J..3L%n"#0A..2CASE.f_rt
n:..2RESULTIS."RTN"#0A..2CASE.f_goto:..1RESULTIS."G
OTO"#0A#0A..2CASE.f_ikp:..2RESULTIS."IKP..1K%n.P%n"
#0A..2CASE.f_ikg:..2RESULTIS."IKG..1K%n.G%n"#0A..2C
ASE.f_ikl:..2RESULTIS."IKL..1K%n.L%n"#0A..2CASE.f_i
p:..3RESULTIS."IP..2P%n"#0A..2CASE.f_ig:..3RESULTIS
."IG..2G%n"#0A..2CASE.f_il:..3RESULTIS."IL..2L%n"#0A
#0A..2CASE.f_jeq:..2RESULTIS."JEQ..1L%n"#0A..2CASE.
f_jne:..2RESULTIS."JNE..1L%n"#0A..2CASE.f_jls:..2RE
SULTIS."JLS..1L%n"#0A..2CASE.f_jgr:..2RESULTIS."JGR
..1L%n"#0A..2CASE.f_jle:..2RESULTIS."JLE..1L%n"#0A.
.2CASE.f_jge:..2RESULTIS."JGE..1L%n"#0A..2CASE.f_je
q0:..1RESULTIS."JEQ0..L%n"#0A..2CASE.f_jne0:..1RESU
LTIS."JNE0..L%n"#0A..2CASE.f_jls0:..1RESULTIS."JLS0
..L%n"#0A..2CASE.f_jgr0:..1RESULTIS."JGR0..L%n"#0A.
.2CASE.f_jle0:..1RESULTIS."JLE0..L%n"#0A..2CASE.f_j
ge0:..1RESULTIS."JGE0..L%n"#0A..2CASE.f_jge0m:..RES
ULTIS."JGE0M.M%n"#0A#0A..2CASE.f_brk:..2RESULTIS."B
RK"#0A..2CASE.f_nop:..2RESULTIS."NOP"#0A..2CASE.f_c
hgco:..RESULTIS."CHGCO"#0A..2CASE.f_mdiv:..1RESULTI
S."MDIV"#0A..2CASE.f_sys:..2RESULTIS."SYS"#0A#0A..2
CASE.f_section:..RESULTIS."SECTION"#0A..2CASE.f_mod
start:.RESULTIS."MODSTART"#0A..2CASE.f_modend:..1RE
SULTIS."MODEND"#0A..2CASE.f_global:..1RESULTIS."GLO
BAL"#0A..2CASE.f_string:..1RESULTIS."STRING"#0A..2C
ASE.f_const:..2RESULTIS."CONST"#0A..2CASE.f_static:
..1RESULTIS."STATIC"#0A..2CASE.f_mlab:..3RESULTIS."
MLAB..M%n"#0A..2CASE.f_lab:..4RESULTIS."LAB..1L%n"#0A
..2CASE.f_lstr:..3RESULTIS."LSTR"#0A..2CASE.f_entry
:..2RESULTIS."ENTRY"#0A#0A..2CASE.f_float:..2RESULT
IS."FLOAT"#0A..2CASE.f_fix:..4RESULTIS."FIX"#0A..2C
ASE.f_fabs:..3RESULTIS."FABS"#0A..2CASE.f_fmul:..3R
ESULTIS."FMUL"#0A..2CASE.f_fdiv:..3RESULTIS."FDIV"#0A
..2CASE.f_fadd:..3RESULTIS."FADD"#0A..2CASE.f_fsub:
..3RESULTIS."FSUB"#0A..2CASE.f_fneg:..3RESULTIS."FN
EG"#0A#0A..2CASE.f_feq:..4RESULTIS."FEQ"#0A..2CASE.
f_fne:..4RESULTIS."FNE"#0A..2CASE.f_fls:..4RESULTIS
."FLS"#0A..2CASE.f_fgr:..4RESULTIS."FGR"#0A..2CASE.
f_fle:..4RESULTIS."FLE"#0A..2CASE.f_fge:..4RESULTIS
."FGE"#0A..}#0A#0A..IF.debug#3D2.DO.dboutput()#0A..
writes("*n..6")#0A..writef(form,.a,.b)#0A//..newlin
e()#0A}#0A#0A6

######com/bcplfe.b#
//.This.is.the.BCPL.compiler.front.end.used.with.se
veral#0A//.codegenerators.including.those.for.32-.a
nd.64-bit.Cintcode#2E#0A#0A//.Implemented.by.Martin
.Richards.(c).6.Aug.2014#0A#0A/*.Change.history#0A#0A
0000810/14#0ASlightly.modified.the.translation.of.s
witchon.commands.to.use#0Athe.OCODE.operators.RES.a
nd.Rstack#2E.This.change.was.made.to.simplify#0Athe
.optimisation.of.Sial#2E#0A#0A00006/08/14#0AAdded.f
loating.point.numbers.and.the.operators.FIX.FLOAT.#23
ABS.#23*.#23/.#23+#0A#23-.#23#3D.#23~#3D.#23<.#23>.
#23<#3D.#23>#3D#2E.This.version.of.the.compiler.gen
erates#0ACintcode.that.runs.under.the.standard.Cint
code.interpreter.(which.was#0Amodified.for.xbcpl.in
.2010),.and.it.is.compatible.with.procode#2E#0Abcpl
cgsial#2Eb,.sial-sasm#2Eb.have.been.modified.approp
riately,.but#0Asial-386#2Eb.and.sial-arm#2Eb.will.n
eed.modification#2E.This.version.allows#0A32-bit.ma
nifest.floating.point.constants.when.running.under.
32-bit#0ACintcode.and.64-bit.floating.point.when.ru
nning.unser.64-bit.Cintcode#2E#0AIt.uses.the.standa
rd.IEE1.floating.point.formats#2E#0A#0A00019/04/14#0A
Systematically.changed.mult.to.mul,.plus.to.add.and
.minus.to.sub#2E#0A#0A00030/04/14#0ADo.not.incremen
t.line.number.on.*p.for.compatiblity.with.emacs#2E#0A
#0A00005/02/14#0AAllow.//.comments.in.multi-line.st
ring.constants#2E#0A#0A00008/01/14#0AAdded.$~tag.#2E
#2E1.$>tag.conditional.compilation.feature.to.allow
#0Acode.to.be.included.if.a.conditional.tag.is.not.
set#2E#2E#0A#0A00003/12/13#0AAdded.the.compiler.opt
ion.OPT/K.to.set.conditional.compilation#0Aoptions#2E
.The.argument.is.a.string.of.option.names.consistin
g.of#0Aletters,.digits,.underlines.and.dots.separat
ed.by.plus.signs.or#0Aindeed.any.characters.not.all
owing.in.option.names#2E#0A#0A00013/05/13#0AThis.is
.a.version.of.the.BCPL.compiler.front.end.is.used.b
y.many#0Avariants.of.the.compiler.including.those.t
hat.generate.32-.or#0A64-cintcode#2E..It.is.designe
d.to.run.on.both.32-.and.64-bit#0Asystems#2E.The.op
tions.t32.and.t64.specify.the.bit.lenth.of.the.BCPL
#0Aword.in.the.target.system#2E.The.default.is.the.
same.as.the.current#0Asystem#2E..On.64-bit.systems.
numerical.constants.are.compiles.to.full#0Aprecisio
n,.but.on.32-bit.systems.they.are.truncated.to.32.b
its.then#0Asign.extended.to.64.bits#2E.64-bit.Cintc
ode.has.one.new.instruction.(MW)#0Athat.modifies.th
e.operand.of.the.next.W.type.instruction.(KW,.LLPW,
#0ALW,.LPW,.SPW,.APW.and.AW)#2E.It.does.this.by.set
ting.the.senior.32-bits#0Aof.the.new.64-bit.MW.regi
ster#2E.This.is.added.to.the.operand.of.any.W#0Atyp
e.instruction.and.is.cleared.after.use#2E#0A#0A0001
8/01/11#0AIf.VER.and.XREF.are.both.specified,.verif
ication.output.is.opened#0Ausing.findappend#2E.#0A#0A
00005/01/11#0AModified.g/bcplfecg#2Eh.to.be.usable.
by.bcpl#2Eb,.xbcpl#2Eb.and.procode#2Eb#0A#0A00005/1
0/10#0AModified.the.treatment.of.EQCASES.to.preserv
e.the.case.of.the.first#0Aoccurrence.of.each.name.f
or.use.in.eg.cross.reference.listings#2E#0ARemoved.
SKIP.command#2E#0A#0A00020/10/09#0ACorrected.bug.in
.performget.relating.to.sourcefile.names.and#0Anumb
ers#2E#0A#0A00010/07/09#0AStopped.'#2E'.terminating
.GET.streams.so.that.GET.streams.can.contain#0Aseve
ral.sections.separated.by.dots#2E.BEWARE:.this.is.a
n.incompatible#0Achange,.since.the.first.section.of
.a.GET.stream.has.in.the.past.been#0Aused.as.a.head
er#2E#0ARe-organised.the.compiler.into.g/bcplfecg#2E
h,.bcplfe#2Eb.and.bcplcgcin#2Eb,#0Aand.reallocating
.most.of.the.compiler.globals#2E#0A#0A00008/05/09#0A
Increased.the.default.treesize.to.2003#2E#0A#0A0000
3/07/07#0AModified.the.treatment.of.*#23.escapes.in
.string.and.character.constants#0Ato.allow.both.UTF
8.and.GB2312.encoding#2E.Added.compiler.options.UTF
8#0Aand.GB2312.to.set.the.default.encoding#2E.*#23U
.and.*#23G.in.a.string.and#0Acharacter.constant.tem
porarily.set.the.encoding.to.UTF8.and.GB2312,#0Ares
pectively,.overriding.the.default.setting#2E.In.GB2
312.mode,.*#23dd2#0Acontains.up.to.4.decimal.digits
#2E.See.the.BCPL.manual#2E#0A#0A00027/06/07#0AAdded
.the.Unicode.escape.sequences.*#23hh2.and.*#23#23hh
6.to.string#0Aand.character.constants#2E.Within.str
ing.they.are.converted.to.the#0Acorresponding.UTF8.
sequence.of.bytes.and.within.a.character.constant#0A
they.yield.the.corresponding.Unicode.integer#2E.See
.the.last.few.tests#0Ain.com/cmpltest#2Eb#0A#0A0002
7/07/06#0AChanged.the.implementation.of.the.GET.dir
ective.to.make.it.system#0Aindependent#2E.Performge
t.now.obtains.the.headers.environment.variable#0Afr
om.the.root.node.(rootnode!rtn_hdrsvar).this.is.nor
mally.either#0A"BCPLHDRS".or."POSHDRS"#2E.If.the.he
ader.file.does.not.end.in.#2Eh.or.#2Eb,#0A#2Eh.is.a
ppended#2E.The.search.order.is.as.follows:#0A#0A(1)
.The.current.directory#2E#0A(2).The.directories.spe
cified.by.the.headers.environment.variable,#0A..2if
.set#2E#0A(3).The.subdirectory.g/.of.the.root.speci
fied.by.the.environment#0A..2variable.rootnode!rtn_
rootvar,.if.set#2E#0A#0A00005/04/06#0AMended.a.bug.
in.trans.concerning.the.tranlation.of.SKIP#2E#0A#0A
00018/01/06#0ABased.on.Dave.Lewis's.suggestion,#0Ai
n.outputsection(),.add:#0A..1IF.objline1%0.DO.write
f("%s*n",.objline1)#0Awhere.objline1.is.the.first.l
ine.of.file.objline1.if.it.can.be.found#0Ain.the.cu
rrent.directory.or.in.the.HDRS.directory#2E.This.wi
ll.typically#0Aput.a.line.such.as:#0A#23!/usr/local
/bin/cintsys.-c#0Aas.the.first.line.of.the.compiled
.object.module#2E.This.line.is.ignored#0Aby.the.CLI
.but.may.be.useful.under.Linux#2E.If.objline1.canno
t.be.found#0Ano.such.line.is.inserted.at.the.start.
of.the.object.module#2E#0A#0A00030/8/05#0ADefined.t
he.function.default_hdrs().near.the.start.to.allow.
easy.change#0Afrom.cintsys.to.cintpos.versions.of.t
he.compiler#2E#0A.#0A22/6/05#0AAdded.the.empty.comm
and.SKIP.and.let.empty.blocks.be.equivalent.to#0ASK
IP#2E.Empty.section.brackets.are.now.also.allowed.a
fter.MANIFEST,#0ASTATIC.and.GLOBAL#2E..These.change
s.make.program.development.marginally#0Aeasier#2E#0A
#0A00017/6/04#0AMade.GET.first.look.in.the.current.
directory#2E#0AAdded.argument.HDRS.to.allow.the.env
ironment.variable.specifying#0Athe.headers.director
y.to.be.changed#2E.The.default.is.BCPLHDRS#2E#0A#0A
00023/4/04#0AUpdate.the.standard.BCPL.compiler.with
.all.the.Cintpos.extensions#0Aincluding.cross.refer
encing.and.11.character.names#2E#0AMake.GET.directi
ves.use.the.BCPLHDRS.environment.variable#2E#0A#0A0
0011/6/02#0AChanged.square.brackets.to.mean.subscri
ption.with.same.precedence#0Aand.function.calls#2E#0A
#0A00018/3/02#0AUse.HDRPATH.and.BCPLPATH.in.GET.dir
ectives#2E#0A#0A00014/1/02#0AAdded.XREF.option.to.o
utput.name.information.during.compilation#2E#0A#0A0
0011/7/01#0AAdded.language.extensions.for.the.Ford.
dialect.of.BCPL#2E#0Ai#2Ee#2E.modified.performget#0A
..3added.SLCT.and.OF.(also.::)#0A..3added.||.commen
ts#0A..3treesize.set.to.1003#0A#0A00015/1/01#0AComp
lain.if.global.number.is.larger.than.65500035#2E#0A
#0A00010/8/00#0AChange.the.maximum.number.of.error.
messages.from.30.to.10#2E#0A#0A00014/12/99#0AMade./
.*.#2E#2E1.*./..comments.nest#2E#0AAllow.the.consta
nts.in.MANIFEST,.STATIC.and.GLOBAL.declarations.#0A
to.be.optional#2E.If.absent.the.value.is.one.greate
r.than.the#0Aprevious.value#2E.Unless.specified.the
.first.value.is.zero,.so#0AMANIFEST.{.a;.b#3D10;.c.
}.declares.a,.b.and.c.to.be.0,.10.and.11,#0Arespect
ively#2E#0A#0A0009/6/99#0AMade.changes.to.buffer.OC
ODE.in.memory#2E.When.bcpl.is.called#0Awithout.the.
TO.argument.it.writes.numeric.ocode.to.the.file.oco
de#2E#0ALex.treats.CR.(13).correctly.to.improve.con
venience.when.running#0Aunder.Windows.and.WindowsCE
#2E#0A#0A00026/2/99#0AAdded.BIN.option.to.the.compi
ler.to.generate.a.binary.(rather.than#0Ahex).hunk.f
ormat.for.the.compiled.code#2E.This.is.primarily.fo
r.the#0AWindows.CE.version.of.the.cintcode.system.w
here.compactness.is#0Aparticularly.important#2E.The
re.is.a.related.change.to.loadseg.in#0Acintmain#2Ec
#0A#0A00017/11/98#0AChanged.the.workspacesize.to.40
02.and.added.the.SIZE.keyword#0Ato.allow.the.user.t
o.specify.this.size#2E#0A#0A0009/11/98#0AMade.GET.d
irectives.search.the.current.working.directory#0Ath
en.directories.given.by.the.shell.variable.BCPLPATH
,.if.set#2E#0AIt.uses.the.BLIB.function.pathfindinp
ut#2E#0A#0A00015/12/96#0ACorrect.a.bug.in.cellwithn
ame#0A#0A00016/8/96#0AAdded.one.line.to.readnumber.
to.allow.underscores.in.numbers.after.#0Athe.first.
digit#2E#0A#0A0007/6/96#0AImplement.the.method.appl
ication.operator.for.object.oriented#0Aprogramming.
in.BCPL#2E.E.#23.(E1,.E2,#2E#2E1,.En).is.equivalent
.to#0A((!E1)!E)(E1,.E2,#2E#2E1,.En)#0A#0A00024/12/9
5#0AImproved.the.efficiency.of.cellwithname.in.TRN.
(using.the.hash.chain#0Alink.in.name.node)#2E#0AImp
roved.the.efficiency.of.outputsection.in.CG.by.intr
oducing#0Awrhex2.and.wrword_at#2E#0A#0A00024/7/95#0A
Removed.bug.in.atbinfo,.define.addinfo_b.change.som
e.global.numbers#2E#0AImplement.constant.folding.in
.TRN#2E#0A#0A00013/7/95#0AAllowed.{.and.}.to.repres
ent.untagged.section.brackets#2E#0A#0A00022/6/93#0A
Reverse.order.in.SWB.and.have.a.minimum.of.7.cases#0A
to.allow.faster.interpreter#2E#0A#0A0002/6/93#0ACha
nged.code.for.SWB.to.use.heap-like.binary.tree#2E#0A
#0A00019/5/93#0APut.in.code.to.compile.BTC.and.XPBY
T.instructions#2E#0A#0A00023/4/93#0AAllowed.the.cod
egenerator.to.compiler.the.S.instruction#2E#0A#0A00
021/12/92#0ACured.bug.in.compilation.of.(b.->.f,.g)
(1,2,3)#0A#0A00024/11/92.#0ACured.bug.in.compilatio
n.of.a,.b.:#3D.s%0.>.0,.s%1.#3D.'!'#0A#0A00023/7/92
:#0ARenamed.nextlab.as.newlab,.load.as.loadval.in.t
he.CG#2E#0APut.back.simpler.hashing.function.in.loo
kupword#2E#0ARemoved.rdargs.fudge#2E#0ARemoved.S2.c
ompiler.option#2E#0ACured.bug.concerning.the.closin
g.of.gostream.when.equal.to.stdout#2E#0A*/#0A#0ASEC
TION."BCPL"#0A#0AGET."libhdr"#0AGET."bcplfecg"#0A.#0A
LET.default_hdrs().#3D.VALOF.//.Changed.MR.12/07/09
#0A{.LET.hdrs.#3D.rootnode!rtn_hdrsvar.//.Typically
."BCPLHDRS".or."POSHDRS".or.0#0A..IF.hdrs.RESULTIS.
hdrs#0A..//.The.following.is.only.executed.if.cints
ys.or.cintsys64.fails.to.set#0A..//.the.hdrs.field.
in.the.rootnode#2E#0A..TEST.t64#0A..THEN.RESULTIS."
BCPL64HDRS"#0A..ELSE.RESULTIS."BCPLHDRS"#0A}#0A#0AG
LOBAL.{#0A//.Globals.used.in.LEX#0Achbuf:feg#0Adecv
al;.exponent;.getstreams;.charv#0Ahdrs..//.MR.10/7/
04#0A#0Aworkvec#0Areaddecimal;.readnumber;.rdstrch#0A
token;.wordnode;.ch#0Ardtag;.performget#0Alex;.dsw;
.declsyswords;.nlpending#0Alookupword;.eqlookupword
;.rch#0Asourcenamev;.sourcefileno;.sourcefileupb#0A
skiptag;.wrchbuf;.chcount;.lineno#0Anulltag;.rec_p;
.rec_l#0A.#0A//.Globals.used.in.SYN#0Ardblockbody;.
.rdsect#0Arnamelist;.rname#0Ardef;.rcom#0Ardcdefs#0A
formtree;.synerr;.opname#0Arexplist;.rdseq#0Amk1;.m
k2;.mk3#0Amk4;.mk5;.mk6;.mk7#0Anewvec#0Arnexp;.rexp
;.rbexp#0A}#0A.#0A.#0AMANIFEST.{#0Ac_backspace.#3D.
.0008#0Ac_tab..5#3D..0009#0Ac_newline..1#3D.10#0Ac_
newpage..1#3D.12#0Ac_return..2#3D.13#0Ac_escape..2#3D
.27#0Ac_space..3#3D.32#0A}#0A#0ALET.floatingchk().B
E#0A{.TEST.t64#0A..THEN.UNLESS.c64.DO#0A..7synerr("
64-bit.floating.point.requires.64-bit.cintcode")#0A
..ELSE.IF.c64.DO#0A..7synerr("32-bit.floating.point
.requires.32-bit.cintcode")#0A}#0A.#0ALET.start().#3D
.VALOF#0A{.LET.treesize.#3D.0#0A..AND.argv.#3D.VEC.
50#0A..AND.argform.#3D."FROM/A,TO/K,VER/K,SIZE/K/N,
TREE/S,NONAMES/S,*#0A..14*D1/S,D2/S,OENDER/S,EQCASE
S/S,BIN/S,XREF/S,GDEFS/S,HDRS/K,*#0A..14*GB2312/S,U
TF8/S,SAVESIZE/K/N,HARD/S,*#0A..14*T32/S,T64/S,OPT/
K"#0A..LET.stdout.#3D.output()#0A..LET.objline1vec.
#3D.VEC.256/bytesperword#0A..LET.optstringvec.#3D.V
EC.256/bytesperword#0A..objline1.:#3D.objline1vec#0A
..objline1%0.:#3D.0#0A..optstring.:#3D.optstringvec
#0A..optstring%0.:#3D.0#0A..errmax..1:#3D.10#0A..er
rcount.:#3D.0#0A..fin_p,.fin_l.:#3D.level(),.fin#0A
#0A..treevec..4:#3D.0#0A..obuf..7:#3D.0#0A..sources
tream.:#3D.0#0A..ocodeout..3:#3D.0#0A..gostream..3:
#3D.0#0A..getstreams..1:#3D.0#0A#0A..sysprint.:#3D.
stdout#0A..selectoutput(sysprint)#0A.#0A..writef("*
nBCPL.(10.Oct.2014).with.simple.floating.point*n")#0A
#0A..//.Allocate.vector.for.source.file.names#0A..s
ourcefileupb.:#3D.1001#0A..sourcenamev.:#3D.getvec(
sourcefileupb)#0A..UNLESS.sourcenamev.DO#0A..{.writ
ef("Insufficient.space.available*n")#0A..2errcount.
:#3D.1#0A..2GOTO.fin#0A..}#0A..sourcefileno.:#3D.0#0A
..FOR.i.#3D.0.TO.sourcefileupb.DO.sourcenamev!0.:#3D
.0..1#0A.#0A..IF.rdargs(argform,.argv,.50)#3D0.DO.{
.writes("Bad.arguments*n")#0A..36errcount.:#3D.1#0A
..36GOTO.fin#0A..34}#0A#0A..bigender.:#3D.(!"AA5".&
.255).#3D.'A'..2//.#3DTRUE.if.on.a.bigender.m/c#0A#0A
..//.Set.the.current.system.wordlength.flag#0A..c64
.:#3D.B2Wsh#3D3..24//.#3DTRUE.if.on.a.64-bit.system
#0A..//.Set.the.target.system.wordlength.flag#0A..t
64.:#3D.c64..28//.Set.the.target.word.length#0A..IF
.argv!18.&.argv!19.DO..15//.T32/S.and.T64/S#0A..2wr
itef("Both.T32.and.T64.specified.--.T64.assumed*n")
#0A..IF.argv!18.DO.t64.:#3D.FALSE..12//.T32/S#0A..I
F.argv!19.DO.t64.:#3D.TRUE..13//.T64/S#0A..wordbyte
len.:#3D.t64.->.8,.4..12//.Set.the.target.word.leng
th.in.bytes#0A..IF.argv!20.DO..25//.OPT/K#0A..{.LET
.s.#3D.argv!20#0A..2FOR.i.#3D.0.TO.s%0.DO.optstring
%i.:#3D.s%i#0A//writef("*nopt#3D%s*n",.optstring)#0A
..}#0A..treesize.:#3D.200_001#0A..IF.argv!3.DO.tree
size.:#3D.!argv!3..6//.SIZE/K/N#0A..IF.treesize<10_
001.DO.treesize.:#3D.10_001#0A..obufsize.:#3D.trees
ize/4#0A#0A..prtree..6:#3D.argv!4..15//.TREE/S#0A..
savespacesize.:#3D.3#0A#0A..//.Code.generator.optio
ns.#0A..naming.:#3D.TRUE#0A..debug.:#3D.0#0A#0A..//
.This.must.be.done.after.T64.is.properly.set#0A..hd
rs.:#3D.default_hdrs()..16//.Set.the.default.HDRS#0A
#0A..IF.argv!5.DO.naming..1:#3D.FALSE..8//.NONAMES/
S#0A..IF.argv!6.DO.debug..2:#3D.debug+1..6//.D1/S#0A
..IF.argv!7.DO.debug..2:#3D.debug+2..6//.D2/S#0A..I
F.argv!8.DO.bigender.:#3D.~bigender..4//.OENDER/S#0A
..eqcases..:#3D.argv!9..20//.EQCASES/S#0A..bining..
1:#3D.argv!10..19//.BIN/S.(binary.hunk)#0A..xrefing
..:#3D.argv!11..19//.XREF/S#0A..gdefsing.:#3D.argv!
12..19//.GDEFS/S#0A..IF.argv!13.DO.hdrs.:#3D.argv!1
3..9//.HDRS/K#0A..defaultencoding.:#3D.UTF8#0A..IF.
argv!14.DO.defaultencoding.:#3D.GB2312.//.GB2312/S#0A
..IF.argv!15.DO.defaultencoding.:#3D.UTF8..1//.UTF8
/S#0A..encoding.:#3D.defaultencoding#0A..IF.argv!16
.DO.savespacesize.:#3D.!(argv!16).//.SAVESIZE/K/N#0A
..hard.:#3D.argv!17..23//.HARD/S#0A..40//.t32/S.is.
18#0A..40//.t64/S.is.19#0A..//.Added.5/10/2010#0A..
IF.eqcases.DO.lookupword.:#3D.eqlookupword#0A#0A//w
ritef("BCPL.hdrs.#3D.%s*n",.hdrs)#0A#0A..{.//.Featu
re.added.by.MR.17/01/06#0A..2//.If.file.objline1.ca
n.be.found,.its.first.line.will.be.written#0A..2//.
at.the.start.of.the.compiled.Cintcode.file#2E.It.fi
rst.looks.in.the#0A..2//.current.directory.then.the
.HDRS.directory.and.finally.it.tries#0A..2//.g/objl
ine1.in.the.system.root.directory#2E#0A..2LET.line1
stream.#3D.findinput("objline1")#0A..2LET.len.#3D.0
#0A#0A..2UNLESS.line1stream.DO#0A..4line1stream.:#3D
.pathfindinput("objline1",.hdrs)#0A..2UNLESS.line1s
tream.IF.rootnode!rtn_rootvar.DO#0A..4line1stream.:
#3D.pathfindinput("g/objline1",.rootnode!rtn_rootva
r)#0A..2#0A..2IF.line1stream.DO#0A..2{.//.Copy.firs
t.line.of.objline1.into.string.objline1#0A..4select
input(line1stream)#0A..4WHILE.len<255.DO#0A..4{.LET
.ch.#3D.rdch()#0A..6IF.ch#3D'*n'.|.ch#3Dendstreamch
.BREAK#0A..6len.:#3D.len+1#0A..6objline1%len.:#3D.c
h#0A..4}#0A..4endread()#0A..2}#0A..2objline1%0.:#3D
.len#0A..2objline1written.:#3D.FALSE#0A..}#0A#0A..s
ourcestream.:#3D.findinput(argv!0)..5//.FROM/A#0A..
sourcenamev!0.:#3D.argv!0..2//.Fileno.zero.is.the.F
ROM.file#0A..sourcefileno..:#3D.0#0A#0A..IF.sources
tream#3D0.DO.{.writef("Trouble.with.file.%s*n",.arg
v!0)#0A..23IF.hard.DO.abort(1001)#0A..23errcount.:#3D
.1#0A..23GOTO.fin#0A..21}#0A#0A..selectinput(source
stream)#0A.#0A..TEST.argv!1..27//.TO/K#0A..THEN.{.g
ostream.:#3D.findoutput(argv!1)#0A..7IF.gostream#3D
0.DO#0A..7{.writef("Trouble.with.code.file.%s*n",.a
rgv!1)#0A..9IF.hard.DO.abort(1001)#0A..9errcount.:#3D
.1#0A..9GOTO.fin#0A..7}#0A..5}#0A..ELSE.{.ocodeout.
:#3D.findoutput("ocode")#0A..7IF.ocodeout#3D0.DO#0A
..7{.writes("Trouble.with.file.ocode*n")#0A..9IF.ha
rd.DO.abort(1001)#0A..9errcount.:#3D.1#0A..9GOTO.fi
n#0A..7}#0A..5}#0A#0A..treevec.:#3D.getvec(treesize
)#0A..obuf..2:#3D.getvec(obufsize)#0A#0A..IF.treeve
c#3D0.|.obuf#3D0.DO#0A..{.writes("Insufficient.memo
ry*n")#0A..2errcount.:#3D.1#0A..2GOTO.fin#0A..}#0A.
.1#0A..UNLESS.argv!2#3D0.DO..20//.VER/K#0A..{.TEST.
xrefing#0A..2THEN.sysprint.:#3D.findappend(argv!2)#0A
..2ELSE.sysprint.:#3D.findoutput(argv!2)#0A..2IF.sy
sprint#3D0.DO#0A..2{.sysprint.:#3D.stdout#0A..4writ
ef("Trouble.with.file.%s*n",.argv!2)#0A..4IF.hard.D
O.abort(1001)#0A..4errcount.:#3D.1#0A..4GOTO.fin#0A
..2}#0A..}#0A#0A..selectoutput(sysprint)#0A#0A..//.
Now.syntax.analyse,.translate.and.code-generate.eac
h.section#0A..{.LET.b.#3D.VEC.64/bytesperword#0A..2
chbuf.:#3D.b#0A..2FOR.i.#3D.0.TO.63.DO.chbuf%i.:#3D
.0#0A..2//.Sourcefile.0.is.the.FROM.filename#0A..2/
/.others.are.GET.files.of.the.current.section#0A..2
sourcenamev!0.:#3D.argv!0#0A..2sourcefileno.:#3D.0#0A
..2FOR.i.#3D.1.TO.sourcefileupb.DO.sourcenamev!i.:#3D
.0.//.Done.for.safety#0A..2chcount,.lineno.:#3D.0,.
(sourcefileno<<00020).+.1#0A..2token,.decval.:#3D.0
,.0#0A..2rch()#0A.#0A..2{.//.Start.of.loop.to.proce
ss.each.section#0A..4LET.tree.#3D.?#0A..4treep.:#3D
.treevec.+.treesize#0A..4obufp.:#3D.0#0A..4obuft.:#3D
.obufsize.*.bytesperword#0A#0A..4tree.:#3D.formtree
()#0A..4UNLESS.tree.BREAK#0A#0A..4//writef("Tree.si
ze.%n*n",.treesize+treevec-treep)#0A.#0A..4IF.prtre
e.DO.{.writes("Parse.Tree*n")#0A..19plist(tree,.0,.
20)#0A..19newline()#0A..17}#0A..#0A..4IF.errcount.G
OTO.fin#0A.#0A..4translate(tree)#0A#0A..4obufq.:#3D
.obufp..3//.Prepare.to.read.from.OCODE.buffer#0A..4
obufp.:#3D.0#0A#0A..4TEST.argv!1#3D0#0A..4THEN.writ
eocode()..//.Write.OCODE.file.if.no.TO.argument#0A.
.4ELSE.codegenerate(treevec,.treesize)#0A..2}.REPEA
TWHILE.token#3Ds_dot#0A..}#0A..1#0Afin:#0A..IF.gets
treams..2DO.{.LET.p.#3D.getstreams#0A..22getstreams
.:#3D.!p#0A..22freevec(p)#0A..20}#0A..FOR.i.#3D.1.T
O.sourcefileno.DO#0A..{.LET.str.#3D.sourcenamev!i#0A
..2IF.str.DO#0A..2{.//sawritef("freeing.fileno.%n.%
s*n",.i,.str)#0A..4freevec(str)#0A..2}#0A..}#0A..IF
.sourcenamev..1DO.freevec(sourcenamev)#0A#0A..IF.tr
eevec..5DO.freevec(treevec)#0A..IF.obuf..8DO.freeve
c(obuf)#0A..IF.sourcestream..DO.endstream(sourcestr
eam)#0A..IF.ocodeout..4UNLESS.ocodeout#3Dstdout.DO.
endstream(ocodeout)#0A..IF.gostream..4UNLESS.gostre
am#3Dstdout.DO.endstream(gostream)#0A..UNLESS.syspr
int#3Dstdout.DO.endstream(sysprint)#0A#0A..selectou
tput(stdout)#0A..RESULTIS.errcount#3D0.->.0,.20#0A}
#0A#0A//.**11.OCODE.I/O.Routines.**24#0A#0A/*#0AThe
.OCODE.buffer.variables.are:#0A#0Aobuf..7is.the.OCO
DE.buffer.--.(obuf#3Dworkvec)#0Aobufp..6position.of
.next.byte.in.the.OCODE.buffer#0Aobufq..6another.po
inter.into.the.OCODE.buffer#0Aobuft..6end.of.the.OC
ODE.buffer#2E#0Aobufsize..3size.of.obuf.(in.words)#0A
*/#0A#0AAND.writeocode().BE#0A{.LET.layout.#3D.0#0A
..selectoutput(ocodeout)#0A#0A..UNTIL.obufp>#3Dobuf
q.DO#0A..{.writef(".%n",.rdn())#0A..2layout.:#3D.la
yout+1#0A..2UNLESS.layout.REM.16.DO.newline()#0A..}
#0A..newline()#0A..selectoutput(sysprint)#0A..write
f("OCODE.size:.%i5/%n*n",.obufq,.obuft)#0A}#0A#0AAN
D.rdn().#3D.VALOF#0A{.LET.byte.#3D.obuf%obufp#0A..I
F.obufp>#3Dobufq.RESULTIS.0#0A..obufp.:#3D.obufp+1#0A
..IF.byte<220003.RESULTIS.byte#0A..IF.byte#3D220003
.RESULTIS.-1#0A..RESULTIS.(byte&31).+.(rdn()<<0005)
#0A}#0A#0AAND.wrn(n).BE#0A{.IF.obufp>#3Dobuft.DO#0A
..{.errmax.:#3D.0.//.Make.it.fatal#0A..2trnerr("Mor
e.workspace.needed.for.OCODE.buffer*n")#0A..}#0A..I
F.-1<#3Dn<220003.DO..2//.This.is.the.normal.case#0A
..{.IF.n#3D-1.DO.n.:#3D.220003#0A..2obuf%obufp.:#3D
.n#0A..2obufp.:#3D.obufp.+.1#0A..2RETURN#0A..}#0A..
obuf%obufp.:#3D.220004.+.(n&31)#0A..obufp.:#3D.obuf
p.+.1#0A..n.:#3D.n>>0005#0A}.REPEAT#0A#0A//.**11.En
d.of..OCODE.I/O.Routines.**17#0A#0ALET.lex().BE#0A{
.nlpending.:#3D.FALSE#0A.#0A..{#0A//sawritef("lex:.
ch#3D%i3.'%c'*n",.ch,.ch)#0A.SWITCHON.ch.INTO#0A.#0A
..2{.DEFAULT:#0A..12//.The.following.gets.around.a#0A
..12//.bug.on.the.Itanium#0A..12IF.ch#3Dendstreamch
.GOTO.endstr#0A#0A..10{.LET.badch.#3D.ch#0A..12ch.:
#3D.'*s'#0A..12synerr("Illegal.character.%x2",.badc
h)#0A..10}#0A#0A..4CASE.'*n':..//.Newline.character
#0A..13lineno.:#3D.lineno.+.1#0A..13nlpending.:#3D.
TRUE..//.IGNORABLE.CHARACTERS#0A..4CASE.'*p':..//.N
ewpage.character.-.do.not.increment.lineno#0A..4CAS
E.'*c':#0A..4CASE.'*t':#0A..4CASE.'*s':#0A..13rch()
.REPEATWHILE.ch#3D'*s'#0A..13LOOP#0A#0A..4CASE.'0':
CASE.'1':CASE.'2':CASE.'3':CASE.'4':#0A..4CASE.'5':
CASE.'6':CASE.'7':CASE.'8':CASE.'9':#0A..12readdeci
mal()#0A..12//.token.is.either.s_number.or.s_fnum#0A
..12//.and.decval.and.exponent.are.both.set#0A..12R
ETURN#0A.#0A..4CASE.'a':CASE.'b':CASE.'c':CASE.'d':
CASE.'e':#0A..4CASE.'f':CASE.'g':CASE.'h':CASE.'i':
CASE.'j':#0A..4CASE.'k':CASE.'l':CASE.'m':CASE.'n':
CASE.'o':#0A..4CASE.'p':CASE.'q':CASE.'r':CASE.'s':
CASE.'t':#0A..4CASE.'u':CASE.'v':CASE.'w':CASE.'x':
CASE.'y':#0A..4CASE.'z':#0A..4CASE.'A':CASE.'B':CAS
E.'C':CASE.'D':CASE.'E':#0A..4CASE.'F':CASE.'G':CAS
E.'H':CASE.'I':CASE.'J':#0A..4CASE.'K':CASE.'L':CAS
E.'M':CASE.'N':CASE.'O':#0A..4CASE.'P':CASE.'Q':CAS
E.'R':CASE.'S':CASE.'T':#0A..4CASE.'U':CASE.'V':CAS
E.'W':CASE.'X':CASE.'Y':#0A..4CASE.'Z':#0A..12token
.:#3D.lookupword(rdtag(ch))#0A..12IF.token#3Ds_get.
DO.{.performget();.LOOP..}#0A..12IF.token#3Ds_bitsp
erbcplword.DO#0A..12{.token.:#3D.s_number#0A..14dec
val.:#3D.t64->64,32#0A..14RETURN#0A..12}#0A..12RETU
RN#0A.#0A..4CASE.'$':#0A..12rch()#0A..12IF.ch#3D'$'
.|.ch#3D'<'.|.ch#3D'>'.|.ch#3D'~'.DO#0A..12{.LET.k.
#3D.ch#0A//sawritef("*nprocessing.$%c*n",.ch)#0A..1
4token.:#3D.lookupword(rdtag('<'))#0A//sawritef("ch
arv#3D%s.token#3D%n*n",.charv,.token)#0A..14//.toke
n.#3D.s_true..11if.the.tag.is.set#0A..14//..5#3D.s_
false.or.s_name..otherwise#0A.#0A..14//.$>tag..1mar
ks.the.end.of.a.conditional#0A..14//..7skipping.sec
tion#0A..14IF.k#3D'>'.DO#0A..14{.IF.skiptag#3Dwordn
ode.DO#0A..18skiptag.:#3D.0..1//.Matching.$>tag.fou
nd#0A..16LOOP#0A..14}#0A.#0A..14IF.skiptag.LOOP#0A#0A
..14//.Only.process.$<tag.and.$$tag.if.not.skipping
#0A.#0A..14IF.k#3D'$'.DO#0A..14{.//.$$tag..compleme
nts.the.value.of.a.tag#0A..16h1!wordnode.:#3D.token
#3Ds_true.->.s_false,.s_true#0A..16LOOP#0A..14}#0A.
#0A..14IF.k#3D'<'.DO#0A..14{.//.$<tag#0A..16IF.toke
n#3Ds_true.LOOP.//.Option.set.so.don't.skip#0A..14}
#0A#0A..14IF.k#3D'~'.DO#0A..14{.//.$~tag#0A..16UNLE
SS.token#3Ds_true.LOOP.//.Option.not.set.so.don't.s
kip#0A..14}#0A#0A..14//.Skip.tokens.until.matching.
$>tag,.EOF.or.end.of.section#0A..14skiptag.:#3D.wor
dnode#0A..14UNTIL.skiptag#3D0.|.token#3Ds_dot.|.tok
en#3Ds_eof.DO.lex()#0A..14skiptag.:#3D.0#0A..14RETU
RN#0A..12}#0A.#0A..12UNLESS.ch#3D'('.|.ch#3D')'.DO.
synerr("'$'.out.of.context")#0A..12token.:#3D.ch#3D
'('.->.s_lsect,.s_rsect#0A..12lookupword(rdtag('$')
)#0A..12RETURN#0A.#0A..4CASE.'{':.token,.wordnode.:
#3D.s_lsect,.nulltag;.BREAK#0A..4CASE.'}':.token,.w
ordnode.:#3D.s_rsect,.nulltag;.BREAK#0A#0A..4CASE.'
#23':#0A..12token.:#3D.s_number#0A..12rch()#0A..12I
F.'0'<#3Dch<#3D'7'.DO#0A..12{.decval.:#3D.readnumbe
r(.8,.100)#0A..14RETURN#0A..12}#0A..12IF.ch#3D'b'.|
.ch#3D'B'.DO#0A..12{.rch()#0A..14decval.:#3D.readnu
mber(.2,.100)#0A..14RETURN#0A..12}#0A..12IF.ch#3D'o
'.|.ch#3D'O'.DO#0A..12{.rch()#0A..14decval.:#3D.rea
dnumber(.8,.100)#0A..14RETURN#0A..12}#0A..12IF.ch#3D
'x'.|.ch#3D'X'.DO#0A..12{.rch()#0A..14decval.:#3D.r
eadnumber(16,.100)#0A..14RETURN#0A..12}#0A..12IF.ch
#3D'('.DO#0A..12{.token.:#3D.s_mthap#0A..14RETURN#0A
..12}#0A..12UNLESS.ch<32.DO#0A..12{.lex()#0A..14SWI
TCHON.token.INTO#0A..14{.DEFAULT:..4ENDCASE#0A#0A..
16CASE.s_abs:..4token.:#3D.s_fabs;..4RETURN#0A#0A..
16CASE.s_mul.:..3token.:#3D.s_fmul;..4RETURN#0A..16
CASE.s_div:..4token.:#3D.s_fdiv;..4RETURN#0A..16CAS
E.s_add:..4token.:#3D.s_fadd;..4RETURN#0A..16CASE.s
_sub:..4token.:#3D.s_fsub;..4RETURN#0A#0A..16CASE.s
_eq:..5token.:#3D.s_feq;..5RETURN#0A..16CASE.s_ne:.
.5token.:#3D.s_fne;..5RETURN#0A..16CASE.s_ls:..5tok
en.:#3D.s_fls;..5RETURN#0A..16CASE.s_le:..5token.:#3D
.s_fle;..5RETURN#0A..16CASE.s_gr:..5token.:#3D.s_fg
r;..5RETURN#0A..16CASE.s_ge:..5token.:#3D.s_fge;..5
RETURN#0A..14}#0A..12}#0A..12synerr("'#23'.out.of.c
ontext")#0A#0A..4CASE.'[':.token.:#3D.s_sbra;..4BRE
AK#0A..4CASE.']':.token.:#3D.s_sket;..4BREAK#0A..4C
ASE.'(':.token.:#3D.s_lparen;..2BREAK#0A..4CASE.')'
:.token.:#3D.s_rparen;..2BREAK.#0A..4CASE.'?':.toke
n.:#3D.s_query;..3BREAK#0A..4CASE.'+':.token.:#3D.s
_add;..5BREAK#0A..4CASE.',':.token.:#3D.s_comma;..3
BREAK#0A..4CASE.';':.token.:#3D.s_semicolon;.BREAK#0A
..4CASE.'@':.token.:#3D.s_lv;..6BREAK#0A..4CASE.'&'
:.token.:#3D.s_logand;..2BREAK#0A..4CASE.'#3D':.tok
en.:#3D.s_eq;..6BREAK#0A..4CASE.'!':.token.:#3D.s_v
ecap;..3BREAK#0A..4CASE.'%':.token.:#3D.s_byteap;..
2BREAK#0A..4CASE.'**':token.:#3D.s_mul;..5BREAK#0A.
.4CASE.'|':.token.:#3D.s_logor;..3BREAK#0A..4CASE.'
#2E':.token.:#3D.s_dot;..5BREAK#0A#0A.#0A..4CASE.'/
':#0A..12rch()#0A..12IF.ch#3D'\'.DO.{.token.:#3D.s_
logand;.BREAK.}#0A..12IF.ch#3D'/'.DO#0A..12{.rch().
REPEATUNTIL.ch#3D'*n'.|#0A..32//ch#3D'*p'.|.//.Do.n
ot.increment.lineno#0A..32ch#3Dendstreamch#0A..14LO
OP#0A..12}#0A.#0A..12IF.ch#3D'**'.DO#0A..12{.LET.de
pth.#3D.1#0A#0A..14{.rch()#0A..16IF.ch#3D'**'.DO#0A
..16{.rch().REPEATWHILE.ch#3D'**'#0A..18IF.ch#3D'/'
.DO.{.depth.:#3D.depth-1;.LOOP.}#0A..16}#0A..16IF.c
h#3D'/'.DO#0A..16{.rch()#0A..18IF.ch#3D'**'.DO.{.de
pth.:#3D.depth+1;.LOOP.}#0A..16}#0A..16IF.ch#3D'*n'
.DO.lineno.:#3D.lineno+1#0A..16IF.ch#3Dendstreamch.
DO.synerr("Missing.'**/'")#0A..14}.REPEATUNTIL.dept
h#3D0#0A#0A..14rch()#0A..14LOOP#0A..12}#0A#0A..12to
ken.:#3D.s_div#0A..12RETURN#0A.#0A..4CASE.'~':#0A..
12rch()#0A..12IF.ch#3D'#3D'.DO.{.token.:#3D.s_ne;..
3BREAK.}#0A..12token.:#3D.s_not#0A..12RETURN#0A.#0A
..4CASE.'\':#0A..12rch()#0A..12IF.ch#3D'/'.DO.{.tok
en.:#3D.s_logor;..BREAK.}#0A..12IF.ch#3D'#3D'.DO.{.
token.:#3D.s_ne;..3BREAK.}#0A..12token.:#3D.s_not#0A
..12RETURN#0A.#0A..4CASE.'<':.rch()#0A..12IF.ch#3D'
#3D'.DO.{.token.:#3D.s_le;..3BREAK.}#0A..12IF.ch#3D
'<'.DO.{.token.:#3D.s_lshift;.BREAK.}#0A..12token.:
#3D.s_ls#0A..12RETURN#0A.#0A..4CASE.'>':.rch()#0A..
12IF.ch#3D'#3D'.DO.{.token.:#3D.s_ge;..3BREAK.}#0A.
.12IF.ch#3D'>'.DO.{.token.:#3D.s_rshift;.BREAK.}#0A
..12token.:#3D.s_gr#0A..12RETURN#0A.#0A..4CASE.'-':
.rch()#0A..12IF.ch#3D'>'.DO.{.token.:#3D.s_cond;.BR
EAK..}#0A..12token.:#3D.s_sub#0A..12RETURN#0A.#0A..
4CASE.':':.rch()#0A..12IF.ch#3D'#3D'.DO.{.token.:#3D
.s_ass;.BREAK..}#0A..12IF.ch#3D':'.DO.{.token.:#3D.
s_of;..BREAK..}..//.Inserted.11/7/01#0A..12token.:#3D
.s_colon#0A..12RETURN#0A.#0A..4CASE.'"':#0A..9{.LET
.len.#3D.0#0A..11rch()#0A..11encoding.:#3D.defaulte
ncoding.//.encoding.for.*#23.escapes#0A#0A..11UNTIL
.ch#3D'"'.DO#0A..11{.LET.code.#3D.rdstrch()#0A..13T
EST.result2#0A..13THEN.{.//.A..*#23.code.found#2E#0A
..20//.Convert.it.to.UTF8.or.GB2312.format#2E#0A..2
0TEST.encoding#3DGB2312#0A..20THEN.{.//.Convert.to.
GB2312.sequence#0A..27IF.code>#23x7F.DO#0A..27{.LET
.hi.#3D.code../..000100.+.160#0A..29LET.lo.#3D.code
.MOD.100.+.160#0A..29IF.len>#3D254.DO.synerr("Bad.s
tring.constant")#0A..29TEST.bigender#0A..29THEN.{.c
harv%(len+1).:#3D.hi.#0A..36charv%(len+2).:#3D.lo#0A
..34}#0A..29ELSE.{.charv%(len+1).:#3D.lo.#0A..36cha
rv%(len+2).:#3D.hi#0A..34}#0A..29len.:#3D.len.+.2#0A
..29LOOP#0A..27}#0A..27IF.len>#3D255.DO.synerr("Bad
.string.constant")#0A..27charv%(len+1).:#3D.code.//
.Ordinary.ASCII.char#0A..27len.:#3D.len.+.1#0A..27L
OOP#0A..25}#0A..20ELSE.{.//.Convert.to.UTF8.sequenc
e#0A..27IF.code<#3D#23x7F.DO#0A..27{.IF.len>#3D255.
DO.synerr("Bad.string.constant")#0A..29charv%(len+1
).:#3D.code..1//.0xx5#0A..29len.:#3D.len.+.1#0A..29
LOOP#0A..27}#0A..27IF.code<#3D#23x7FF.DO#0A..27{.IF
.len>#3D254.DO.synerr("Bad.string.constant")#0A..29
charv%(len+1).:#3D.#23b1100000_002+(code>>0006)..//
.110000xx3#0A..29charv%(len+2).:#3D.#23x80+(.code..
2&#23x3F)..//.10xx4#0A..29len.:#3D.len.+.2#0A..29LO
OP#0A..27}#0A..27IF.code<#3D#23xFF2.DO#0A..27{.IF.l
en>#3D253.DO.synerr("Bad.string.constant")#0A..29ch
arv%(len+1).:#3D.#23b110010_002+(code>>00012).//.11
0010xx2#0A..29charv%(len+2).:#3D.#23x80+((code>>000
6)&#23x3F)..//.10xx4#0A..29charv%(len+3).:#3D.#23x8
0+(.code..2&#23x3F)..//.10xx4#0A..29len.:#3D.len.+.
3#0A..29LOOP#0A..27}#0A..27IF.code<#3D#23x1F_FF2.DO
#0A..27{.IF.len>#3D252.DO.synerr("Bad.string.consta
nt")#0A..29charv%(len+1).:#3D.#23b112_002+(code>>00
018).//.110020xx1#0A..29charv%(len+2).:#3D.#23x80+(
(code>>00012)&#23x3F).//.10xx4#0A..29charv%(len+3).
:#3D.#23x80+((code>>.6)&#23x3F).//.10xx4#0A..29char
v%(len+4).:#3D.#23x80+(.code..3&#23x3F).//.10xx4#0A
..29len.:#3D.len.+.4#0A..29LOOP#0A..27}#0A..27IF.co
de<#3D#23x3FF_FF2.DO#0A..27{.IF.len>#3D251.DO.syner
r("Bad.string.constant")#0A..29charv%(len+1).:#3D.#23
b112_1001+(code>>00024).//.110030xx#0A..29charv%(le
n+2).:#3D.#23x80+((code>>00018)&#23x3F).//.10xx4#0A
..29charv%(len+3).:#3D.#23x80+((code>>00012)&#23x3F
).//.10xx4#0A..29charv%(len+4).:#3D.#23x80+((code>>
.6)&#23x3F).//.10xx4#0A..29charv%(len+5).:#3D.#23x8
0+(.code..3&#23x3F).//.10xx4#0A..29len.:#3D.len.+.5
#0A..29LOOP#0A..27}#0A..27IF.code<#3D#23x7FF1_FF2.D
O#0A..27{.IF.len>#3D250.DO.synerr("Bad.string.const
ant")#0A..29charv%(len+1).:#3D.#23b112_1100000+(cod
e>>00030).//.110040x#0A..29charv%(len+2).:#3D.#23x8
0+((code>>00024)&#23x3F).//.10xx4#0A..29charv%(len+
3).:#3D.#23x80+((code>>00018)&#23x3F).//.10xx4#0A..
29charv%(len+4).:#3D.#23x80+((code>>00012)&#23x3F).
//.10xx4#0A..29charv%(len+5).:#3D.#23x80+((code>>.6
)&#23x3F).//.10xx4#0A..29charv%(len+6).:#3D.#23x80+
(.code..3&#23x3F).//.10xx4#0A..29len.:#3D.len.+.6#0A
..29LOOP#0A..27}#0A..27synerr("Bad.Unicode.characte
r")#0A..25}#0A..18}#0A..13ELSE.{.//.Not.a.Unicode.c
haracter#0A..20IF.len#3D255.DO.synerr("Bad.string.c
onstant")#0A..20len.:#3D.len.+.1#0A..20charv%len.:#3D
.code#0A..18}#0A..11}#0A.#0A..11charv%0.:#3D.len#0A
..11wordnode.:#3D.newvec(len/bytesperword+2)#0A..11
h1!wordnode.:#3D.s_string#0A..11FOR.i.#3D.0.TO.len.
DO.(@h2!wordnode)%i.:#3D.charv%i#0A..11token.:#3D.s
_string#0A..11BREAK#0A..8}#0A.#0A..4CASE.'*'':#0A..
12rch()#0A..12encoding.:#3D.defaultencoding#0A..12d
ecval.:#3D.rdstrch()#0A..12token.:#3D.s_number#0A..
12UNLESS.ch#3D'*''.DO.synerr("Bad.character.constan
t")#0A..12BREAK#0A.#0A.endstr:#0A..4//CASE.endstrea
mch:.//.Commented.out.because.of.an.Itanium.bug#0A.
.12IF.getstreams.DO#0A..12{.//.Return.from.a.'GET'.
stream#0A..14LET.p.#3D.getstreams#0A..14endread()#0A
..14ch..9:#3D.h4!getstreams#0A..14lineno..5:#3D.h3!
getstreams#0A..14sourcestream.:#3D.h2!getstreams#0A
..14getstreams..1:#3D.h1!getstreams#0A..14freevec(p
).//.Free.the.GET.node#0A..14selectinput(sourcestre
am)#0A..14LOOP#0A..12}#0A..12//.endstreamch.#3D>.EO
F.only.at.outermost.GET.level.#0A..12token.:#3D.s_e
of#0A..12RETURN#0A..2}#0A..}.REPEAT#0A.#0A..rch()#0A
}#0A.#0ALET.lookupword(word).#3D.VALOF#0A{.LET.len,
.i.#3D.word%0,.0#0A..LET.hashval.#3D.19609.//.This.
and.31397.are.primes#2E#0A..FOR.j.#3D.0.TO.len.DO.h
ashval.:#3D.(hashval.NEQV.word%j).*.31397#0A..hashv
al.:#3D.(hashval>>0001).REM.nametablesize#0A#0A..wo
rdnode.:#3D.nametable!hashval#0A.#0A..UNTIL.wordnod
e#3D0.|.i>len.TEST.(@h3!wordnode)%i#3Dword%i#0A..25
THEN.i.:#3D.i+1#0A..25ELSE.wordnode,.i.:#3D.h2!word
node,.0#0A.#0A..UNLESS.wordnode.DO#0A..{.wordnode.:
#3D.newvec(len/bytesperword+2)#0A..2h1!wordnode,.h2
!wordnode.:#3D.s_name,.nametable!hashval#0A..2FOR.i
.#3D.0.TO.len.DO.(@h3!wordnode)%i.:#3D.word%i#0A..2
nametable!hashval.:#3D.wordnode#0A..}#0A.#0A..RESUL
TIS.h1!wordnode#0A}#0A.#0ALET.eqlookupword(word).#3D
.VALOF#0A{.//.This.version.equates.the.cases.but.ke
eps.the.cases.of#0A..//.the.first.word.encountered#2E
.If.EQCASES.is.given.this.version#0A..//.replaces.l
ookupword#2E#0A..LET.len,.i.#3D.word%0,.0#0A..LET.h
ashval.#3D.19609.//.This.and.31397.are.primes#2E#0A
..//.This.hash.function.ignores.the.case.of.letters
#2E#0A..FOR.j.#3D.0.TO.len.DO.hashval.:#3D.(hashval
.NEQV.(word%j.&.31)).*.31397#0A..hashval.:#3D.(hash
val>>0001).REM.nametablesize#0A#0A..wordnode.:#3D.n
ametable!hashval#0A.#0A..UNTIL.wordnode#3D0.|.i>len
.TEST.compch((@h3!wordnode)%i,.word%i)#3D0#0A..25TH
EN.i.:#3D.i+1#0A..25ELSE.wordnode,.i.:#3D.h2!wordno
de,.0#0A.#0A..UNLESS.wordnode.DO#0A..{.wordnode.:#3D
.newvec(len/bytesperword+2)#0A..2h1!wordnode,.h2!wo
rdnode.:#3D.s_name,.nametable!hashval#0A..2FOR.i.#3D
.0.TO.len.DO.(@h3!wordnode)%i.:#3D.word%i#0A..2name
table!hashval.:#3D.wordnode#0A..}#0A.#0A..RESULTIS.
h1!wordnode#0A}#0A.#0AAND.dsw(word,.sym).BE.{.looku
pword(word);.h1!wordnode.:#3D.sym..}#0A.#0AAND.decl
syswords().BE#0A{.dsw("AND",.s_and)#0A..dsw("ABS",.
s_abs)#0A..dsw("BE",.s_be)#0A..dsw("BITSPERBCPLWORD
",.s_bitsperbcplword)#0A..dsw("BREAK",.s_break)#0A.
.dsw("BY",.s_by)#0A..dsw("CASE",.s_case)#0A..dsw("D
O",.s_do)#0A..dsw("DEFAULT",.s_default)#0A..dsw("EQ
",.s_eq)#0A..dsw("EQV",.s_eqv)#0A..dsw("ELSE",.s_el
se)#0A..dsw("ENDCASE",.s_endcase)#0A..dsw("FALSE",.
s_false)#0A..dsw("FINISH",.s_finish)#0A..dsw("FIX",
.s_fix)#0A..dsw("FLOAT",.s_float)#0A..dsw("FOR",.s_
for)#0A..dsw("GOTO",.s_goto)#0A..dsw("GE",.s_ge)#0A
..dsw("GR",.s_gr)#0A..dsw("GLOBAL",.s_global)#0A..d
sw("GET",.s_get)#0A..dsw("IF",.s_if)#0A..dsw("INTO"
,.s_into)#0A..dsw("LET",.s_let)#0A..dsw("LV",.s_lv)
#0A..dsw("LE",.s_le)#0A..dsw("LS",.s_ls)#0A..dsw("L
OGOR",.s_logor)#0A..dsw("LOGAND",.s_logand)#0A..dsw
("LOOP",.s_loop)#0A..dsw("LSHIFT",.s_lshift)#0A..ds
w("MANIFEST",.s_manifest)#0A..dsw("MOD",.s_rem)#0A.
.dsw("NE",.s_ne)#0A..dsw("NEEDS",.s_needs)#0A..dsw(
"NEQV",.s_neqv)#0A..dsw("NOT",.s_not)#0A..dsw("OF",
.s_of)..17//.Inserted.11/7/01#0A..dsw("OR",.s_else)
#0A..dsw("RESULTIS",.s_resultis)#0A..dsw("RETURN",.
s_return)#0A..dsw("REM",.s_rem)#0A..dsw("RSHIFT",.s
_rshift)#0A..dsw("RV",.s_rv)#0A..dsw("REPEAT",.s_re
peat)#0A..dsw("REPEATWHILE",.s_repeatwhile)#0A..dsw
("REPEATUNTIL",.s_repeatuntil)#0A..dsw("SECTION",.s
_section)#0A..dsw("SLCT",.s_slct)..13//.Inserted.11
/7/01#0A..dsw("STATIC",.s_static)#0A..dsw("SWITCHON
",.s_switchon)#0A..dsw("TO",.s_to)#0A..dsw("TEST",.
s_test)#0A..dsw("TRUE",.s_true)#0A..dsw("THEN",.s_d
o)#0A..dsw("TABLE",.s_table)#0A..dsw("UNLESS",.s_un
less)#0A..dsw("UNTIL",.s_until)#0A..dsw("VEC",.s_ve
c)#0A..dsw("VALOF",.s_valof)#0A..dsw("WHILE",.s_whi
le)#0A..dsw("XOR",.s_neqv)#0A..dsw("$",.0)#0A.#0A..
nulltag.:#3D.wordnode#0A}.#0A.#0ALET.rch().BE#0A{.c
h.:#3D.rdch()#0A..chcount.:#3D.chcount.+.1#0A..chbu
f%(chcount&63).:#3D.ch#0A}#0A.#0AAND.wrchbuf().BE#0A
{.writes("*n#2E#2E1")#0A..FOR.p.#3D.chcount-63.TO.c
hcount.DO#0A..{.LET.k.#3D.chbuf%(p&63)#0A..2IF.0<k<
255.DO.wrch(k)#0A..}#0A..newline()#0A}#0A.#0A.#0AAN
D.rdoptstring().#3D.VALOF#0A{.LET.pos.#3D.1.//.The.
position.of.the.next.optstring#0A..12//.character.t
o.consider#0A..LET.optstringlen.#3D.optstring%0#0A.
.LET.optch.#3D.?#0A#0A..{.//.Get.next.option.name,.
if.any#0A..2LET.len.#3D.1#0A..2charv%0,.charv%1.:#3D
.1,.'<'#0A.#0A..2//.Skip.characters.before.option.n
ame#0A..2WHILE.pos<#3Doptstringlen.DO#0A..2{.optch.
:#3D.optstring%pos#0A..4IF.'a'<#3Doptch<#3D'z'.|.'A
'<#3Doptch<#3D'Z'.|#0A..7'0'<#3Doptch<#3D'9'.|.optc
h#3D'#2E'.|.optch#3D'_'.BREAK#0A..4pos.:#3D.pos+1#0A
..2}#0A#0A..2//.Copy.option.name,.if.any,.into.char
v#0A..2WHILE.pos<#3Doptstringlen.DO#0A..2{.optch.:#3D
.optstring%pos#0A..4UNLESS.'a'<#3Doptch<#3D'z'.|.'A
'<#3Doptch<#3D'Z'.|#0A..11'0'<#3Doptch<#3D'9'.|.opt
ch#3D'#2E'.|.optch#3D'_'.BREAK#0A..4//.Copy.next.op
tion.name.character.into.charv,.if.room#0A..4len.:#3D
.len+1#0A..4IF.len<#3D255.DO.charv%0,.charv%len.:#3D
.len,.optch#0A..4pos.:#3D.pos+1#0A..2}#0A#0A..2IF.l
en<#3D1.BREAK.//.No.more.option.names#0A#0A..2//.De
clare.option.name#0A..2token.:#3D.lookupword(charv)
#0A..2h1!wordnode.:#3D.s_true#0A#0A//sawritef("Opti
on.name:.",.wordnode,.h1!wordnode)#0A//FOR.i.#3D.2.
TO.charv%0.DO.sawrch(charv%i)#0A//sawritef(".declar
ed*n")#0A#0A..}.REPEAT..2//.Read.next.option.name,.
if.any#0A}#0A#0AAND.rdtag(ch1).#3D.VALOF#0A{.LET.le
n.#3D.1#0A..//1IF.eqcases.&.'a'<#3Dch1<#3D'z'.DO.ch
1.:#3D.ch1.+.'A'.-.'a'#0A..charv%1.:#3D.ch1#0A.#0A.
.{.rch()#0A..2UNLESS.'a'<#3Dch<#3D'z'.|.'A'<#3Dch<#3D
'Z'.|#0A..9'0'<#3Dch<#3D'9'.|.ch#3D'#2E'.|.ch#3D'_'
.BREAK#0A..2//1IF.eqcases.&.'a'<#3Dch<#3D'z'.DO.ch.
:#3D.ch.+.'A'.-.'a'#0A..2len.:#3D.len+1#0A..2charv%
len.:#3D.ch#0A..}.REPEAT#0A.#0A..charv%0.:#3D.len#0A
..RESULTIS.charv#0A}#0A#0AAND.catstr(s1,.s2).#3D.VA
LOF#0A//.Concatenate.strings.s1.and.s2.leaving.the.
result.in.s1#2E#0A//.s1.is.assumed.to.be.able.to.ho
ld.a.string.of.length.255#2E#0A//.The.resulting.str
ing.is.truncated.to.length.255,.if.necessary#2E.#0A
{.LET.len.#3D.s1%0#0A..LET.n.#3D.len#0A..FOR.i.#3D.
1.TO.s2%0.DO#0A..{.n.:#3D.n+1#0A..2IF.n>255.BREAK#0A
..2s1%n.:#3D.s2%i#0A..}#0A..s1%0.:#3D.n#0A}.#0A.#0A
AND.performget().BE#0A{.LET.stream.#3D.?#0A..LET.le
n.#3D.0#0A..lex()#0A..UNLESS.token#3Ds_string.DO.sy
nerr("Bad.GET.directive")#0A..len.:#3D.charv%0#0A#0A
..//.Append.#2Eh.to.the.GET.filename.does.not.end.i
n.#2Eh.or.#2Eb#0A..UNLESS.len>#3D2.&.charv%(len-1)#3D
'#2E'.&.#0A..7(charv%len#3D'h'.|.charv%len#3D'b').D
O#0A..{.len.:#3D.len+2#0A..2charv%0,.charv%(len-1),
.charv%len.:#3D.len,.'#2E',.'h'#0A..}#0A#0A..//.Tre
at.filenames.like.sys:xx1.as.sys/xx1.--.deprecated.
feature.#0A..FOR.i.#3D.1.TO.charv%0.IF.charv%i#3D':
'.DO.charv%i.:#3D.'/'#0A#0A..//.First.look.in.the.c
urrent.directory#0A..//writef("Searching.for.*"%s*"
.in.the.current.directory*n",.charv)#0A..stream.:#3D
.pathfindinput(charv,.0)#0A#0A1..//.Then.try.the.he
aders.directories#0A..//UNLESS.stream.DO.sawritef("
Searching.for.*"%s*".in.%s*n",.charv,.hdrs)#0A..//.
The.value.of.hdrs.is.typically:.#2E#2E3/BCPL/cintco
de/g#0A..UNLESS.stream.DO.stream.:#3D.pathfindinput
(charv,.hdrs)#0A#0A..UNLESS.stream.DO#0A..{.synerr(
"Unable.to.find.GET.file.%s",.charv)#0A..2RETURN#0A
..}#0A#0A..IF.sourcefileno>#3Dsourcefileupb.DO#0A..
{.synerr("Too.many.GET.files")#0A..2RETURN#0A..}#0A
#0A..{.LET.len.#3D.charv%0#0A..2LET.node.#3D.getvec
(3)..//.Freed.at.end.of.GET.insertion#0A..2LET.str.
.#3D.getvec(len/bytesperword).//.Freed.at.end.of.co
mpilation#0A#0A..2UNLESS.node.&.str.DO#0A..2{.IF.no
de.DO.freevec(node)#0A..4IF.str..DO.freevec(str)#0A
..4synerr("getvec.failure.in.performget")#0A..2}#0A
..2FOR.i.#3D.0.TO.len.DO.str%i.:#3D.charv%i#0A..2so
urcefileno.:#3D.sourcefileno+1#0A..2sourcenamev!sou
rcefileno.:#3D.str#0A//sawritef("performget:.file.%
n.is.%s*n",.sourcefileno,.str)#0A..2node!0,.node!1,
.node!2,.node!3.:#3D.getstreams,.sourcestream,.line
no,.ch#0A..2getstreams.:#3D.node#0A..}#0A..sourcest
ream.:#3D.stream#0A..selectinput(sourcestream)#0A..
lineno.:#3D.(sourcefileno<<00020).+.1#0A..rch()#0A}
#0A#0AAND.readdecimal().BE#0A{.//.Read.an.integer.o
r.floating.point.constant#0A..//.setting.token.to.s
_number.or.s_fnum#0A..//.It.sets.decval.to.the.inte
ger.or.mantissa#0A..//.and.exponent.to.the.exponent
.is.a.floating.point#0A..//.constant.was.found#0A..
LET.zcount.#3D.0..2//.Number.of.consecutive.zeroes#0A
..LET.pos.#3D.0..5//.Number.of.digits.after.'#2E'#0A
#0A..token.:#3D.s_number.//.Until.'#2E'.or.'e'.enco
untered#0A..decval,.exponent.:#3D.0,.0#0A#0A..UNLES
S.'0'<#3Dch<#3D'9'.DO.synerr("Bad.number")#0A#0A../
/.Ignore.leading.zeroes#0A..WHILE.ch#3D'0'.DO.rch()
#0A#0A..WHILE.'0'<#3Dch<#3D'9'.|.ch#3D'_'.|.ch#3D'#2E
'.DO#0A..{.//writef("ch#3D%c.zcount#3D%n.pos#3D%n.t
oken#3D%n.decval#3D%i4.exponent#3D%n*n",#0A..2//..6
ch,.zcount,.pos,.token,.decval,.exponent)#0A..2SWIT
CHON.ch.INTO#0A..2{.DEFAULT:.BREAK#0A#0A..4CASE.'1'
:.CASE.'2':.CASE.'3':.CASE.'4':.#0A..4CASE.'5':.CAS
E.'6':.CASE.'7':.CASE.'8':.CASE.'9':#0A..6IF.token#3D
s_fnum.DO.pos.:#3D.pos+1#0A..6//.Be.careful.with.ov
erflow#0A..6{.IF.decval>maxint/10.GOTO.digitzero#0A
..8decval.:#3D.10*decval#0A..8UNLESS.zcount.BREAK#0A
..8zcount.:#3D.zcount-1#0A..6}.REPEAT#0A..6IF.decva
l.>.maxint.-.(ch.-.'0').ENDCASE#0A..6decval.:#3D.de
cval.+.ch.-.'0'#0A..6ENDCASE#0A#0A..4CASE.'0':#0A..
6IF.token#3Ds_fnum.DO.pos.:#3D.pos+1#0Adigitzero:#0A
..6zcount.:#3D.zcount+1#0A..4CASE.'_':#0A..6ENDCASE
#0A#0A..4CASE.'#2E':.#0A..6IF.token#3Ds_fnum.DO.syn
err("Bad.floating.point.constant")#0A..6token.:#3D.
s_fnum#0A..6ENDCASE#0A..2}#0A..2rch()#0A..}#0A..IF.
ch#3D'e'.|.ch#3D'E'.DO#0A..{.LET.expneg.#3D.FALSE#0A
..2token.:#3D.s_fnum#0A..2rch()#0A..2IF.ch#3D'-'.DO
.{.expneg.:#3D.TRUE;.rch().}#0A..2WHILE.'0'<#3Dch<#3D
'9'.|.ch#3D'_'.DO#0A..2{.UNLESS.ch#3D'_'.DO.exponen
t.:#3D.10*exponent.+.ch-'0'#0A..4rch()#0A..2}#0A..2
IF.expneg.DO.exponent.:#3D.-exponent#0A..}#0A..IF.t
oken#3Ds_number.DO#0A..{.//.Deal.with.trailing.zero
es#0A..2WHILE.zcount.DO.decval,.zcount.:#3D.10*decv
al,.zcount-1#0A..2RETURN#0A..}#0A..//.Correct.the.e
xponent#0A..exponent.:#3D.exponent.+.zcount.-.pos#0A
..//writef("token#3D%n.decval#3D%i4.exponent#3D%n*n
",#0A..//..6token,.decval,.exponent)#0A}#0A#0AAND.r
eadnumber(radix,.digs).#3D.VALOF#0A//.Read.a.binary
,.octal,.decimal.or.hexadecimal.unsigned.number#0A/
/.with.between.1.and.digs.digits#2E.Underlines.are.
allowed#2E#0A//.This.function.is.used.for.numerical
.constants.and.numerical#0A//.escapes.in.string.and
.character.constants#2E#0A{.LET.i,.res.#3D.0,.0#0A.
#0A..{.UNLESS.ch#3D'_'.DO.//.ignore.underlines#0A..
2{.LET.d.#3D.value(ch)#0A..4IF.d>#3Dradix.BREAK#0A.
.4i.:#3D.i+1..5//.Increment.count.of.digits#0A..4re
s.:#3D.radix*res.+.d#0A..2}#0A..2rch()#0A..}.REPEAT
WHILE.i<digs#0A#0A..UNLESS.i.DO.synerr("Bad.number"
)#0A..RESULTIS.res#0A}#0A.#0A.#0AAND.value(ch).#3D.
'0'<#3Dch<#3D'9'.->.ch-'0',#0A..14'A'<#3Dch<#3D'F'.
->.ch-'A'+10,#0A..14'a'<#3Dch<#3D'f'.->.ch-'a'+10,#0A
..014100#0A.#0AAND.rdstrch().#3D.VALOF#0A{.//.Retur
n.the.integer.code.for.the.next.string.character#0A
..//.Set.result2#3DTRUE.if.*#23.character.code.was.
found,.otherwise.FALSE#0A..LET.k.#3D.ch#0A#0A..IF.k
#3D'*n'.DO#0A..{.lineno.:#3D.lineno+1#0A..2synerr("
Unescaped.newline.character")#0A..}#0A.#0A..IF.k#3D
'**'.DO#0A..{.rch()#0A..2k.:#3D.ch#0A..2IF.'a'<#3Dk
<#3D'z'.DO.k.:#3D.k.+.'A'.-.'a'#0A..2SWITCHON.k.INT
O#0A..2{.CASE.'*n':#0A..4CASE.'*c':#0A..4CASE.'*p':
#0A..4CASE.'*s':#0A..4CASE.'*t':#0A..4CASE..'/':.//
.Ignore.white.space.until.the.next.asterisk#2E#0A..
15//.Comments.starting.with.'//'.are.treated.as#0A.
.15//.white.space,.but.those.starting.with.'/*'#0A.
.15//.are.not#2E#0A..15{.WHILE.ch#3D'*n'.|.ch#3D'*c
'.|.ch#3D'*p'.|.ch#3D'*s'.|.ch#3D'*t'.DO#0A..17{.IF
.//ch#3D'*p'.|..//.Do.not.increment.lineno#0A..22ch
#3D'*n'.DO.lineno.:#3D.lineno+1#0A..19rch()#0A..17}
#0A..17IF.ch#3D'/'.DO#0A..17{.rch()#0A..19IF.ch#3D'
/'.DO#0A..19{.//.Skip.over.a.'//'.comment#0A..21rch
().REPEATUNTIL.ch#3D'*n'.|#0A..39ch#3D'*p'.|#0A..39
ch#3Dendstreamch#0A..21LOOP#0A..19}#0A..17}#0A..17B
REAK#0A..15}.REPEAT#0A..15IF.ch#3D'**'.DO.{.rch();.
LOOP..}#0A#0A..4DEFAULT:..1synerr("Bad.string.or.ch
aracter.constant,.ch#3D%n",.ch)#0A..7#0A..4CASE.'**
':#0A..4CASE.'*'':#0A..4CASE.'"':..18ENDCASE#0A..7#0A
..4CASE.'T':..k.:#3D.c_tab;..5ENDCASE#0A..4CASE.'S'
:..k.:#3D.c_space;..3ENDCASE#0A..4CASE.'N':..k.:#3D
.c_newline;..1ENDCASE#0A..4CASE.'E':..k.:#3D.c_esca
pe;..2ENDCASE#0A..4CASE.'B':..k.:#3D.c_backspace;.E
NDCASE#0A..4CASE.'P':..k.:#3D.c_newpage;..1ENDCASE#0A
..4CASE.'C':..k.:#3D.c_return;..2ENDCASE#0A..7#0A..
4CASE.'X':..//.*xhh..--.A.character.escape.in.hexad
ecimal#0A..15rch()#0A..15k.:#3D.readnumber(16,2)#0A
..15result2.:#3D.FALSE#0A..15RESULTIS.k#0A#0A..4CAS
E.'#23':..//.*#23u..1set.UTF8.mode#0A..15//.*#23g..
1set.GB2312.mode#0A..15//.In.UTF8.mode#0A..15//..3*
#23hh2.or.*#23#23hh6..--.a.Unicode.character#0A..15
//.In.GB2312#0A..15//..3*#23dd2..15--.A.GB2312.code
#0A..13{.LET.digs.#3D.4#0A..15rch()#0A..15IF.ch#3D'
u'.|.ch#3D'U'.DO.{.encoding.:#3D.UTF8;..1rch();.LOO
P.}#0A..15IF.ch#3D'g'.|.ch#3D'G'.DO.{.encoding.:#3D
.GB2312;.rch();.LOOP.}#0A..15TEST.encoding#3DGB2312
#0A..15THEN.{.#0A..22k.:#3D.readnumber(10,.digs)#0A
//sawritef("rdstrch:.GB2312:.%i4*n",.k)#0A..20}#0A.
.15ELSE.{.IF.ch#3D'#23'.DO.{.rch();.digs.:#3D.8.}#0A
..22k.:#3D.readnumber(16,.digs)#0A//sawritef("rdstr
ch:.Unicode:.%x4*n",.k)#0A..20}#0A..15result2.:#3D.
TRUE#0A..15RESULTIS.k#0A..13}#0A#0A..4CASE.'0':CASE
.'1':CASE.'2':CASE.'3':CASE.'4':#0A..4CASE.'5':CASE
.'6':CASE.'7':#0A..15//.*oo1.--.A.character.escape.
in.octal.#0A..15k.:#3D.readnumber(8,3)#0A..15IF.k>2
55.DO.#0A..21synerr("Bad.string.or.character.consta
nt")#0A..15result2.:#3D.FALSE#0A..15RESULTIS.k#0A..
2}#0A..}#0A..1#0A..rch()#0A..result2.:#3D.FALSE#0A.
.RESULTIS.k#0A}.REPEAT#0A#0ALET.newvec(n).#3D.VALOF
#0A{.treep.:#3D.treep.-.n.-.1;#0A..IF.treep<#3Dtree
vec.DO#0A..{.errmax.:#3D.0..//.Make.it.fatal#0A..2s
ynerr("More.workspace.needed")#0A..}#0A..RESULTIS.t
reep#0A}#0A.#0AAND.mk1(x).#3D.VALOF#0A{.LET.p.#3D.n
ewvec(0)#0A..p!0.:#3D.x#0A..RESULTIS.p#0A}#0A.#0AAN
D.mk2(x,.y).#3D.VALOF#0A{.LET.p.#3D.newvec(1)#0A..p
!0,.p!1.:#3D.x,.y#0A..RESULTIS.p#0A}#0A.#0AAND.mk3(
x,.y,.z).#3D.VALOF#0A{.LET.p.#3D.newvec(2)#0A..p!0,
.p!1,.p!2.:#3D.x,.y,.z#0A..RESULTIS.p#0A}#0A.#0AAND
.mk4(x,.y,.z,.t).#3D.VALOF#0A{.LET.p.#3D.newvec(3)#0A
..p!0,.p!1,.p!2,.p!3.:#3D.x,.y,.z,.t#0A..RESULTIS.p
#0A}#0A.#0AAND.mk5(x,.y,.z,.t,.u).#3D.VALOF#0A{.LET
.p.#3D.newvec(4)#0A..p!0,.p!1,.p!2,.p!3,.p!4.:#3D.x
,.y,.z,.t,.u#0A..RESULTIS.p#0A}#0A.#0AAND.mk6(x,.y,
.z,.t,.u,.v).#3D.VALOF#0A{.LET.p.#3D.newvec(5)#0A..
p!0,.p!1,.p!2,.p!3,.p!4,.p!5.:#3D.x,.y,.z,.t,.u,.v#0A
..RESULTIS.p#0A}#0A.#0AAND.mk7(x,.y,.z,.t,.u,.v,.w)
.#3D.VALOF#0A{.LET.p.#3D.newvec(6)#0A..p!0,.p!1,.p!
2,.p!3,.p!4,.p!5,.p!6.:#3D.x,.y,.z,.t,.u,.v,.w#0A..
RESULTIS.p#0A}#0A.#0AAND.formtree().#3D..VALOF#0A{.
LET.res.#3D.0#0A#0A..nametablesize.:#3D.541#0A#0A..
charv..4:#3D.newvec(256/bytesperword)#0A..charv%0.:
#3D.0#0A..nametable..:#3D.newvec(nametablesize).#0A
..FOR.i.#3D.0.TO.nametablesize.DO.nametable!i.:#3D.
0#0A..skiptag.:#3D.0#0A..declsyswords()#0A.#0A..rec
_p,.rec_l.:#3D.level(),.rec#0A.#0A..token,.decval.:
#3D.0,.0#0A#0A..rdoptstring()#0A#0A..lex()#0A//sawr
itef("formtree:.token#3D%n.cis#3D%n*n",.token,.cis)
#0A..IF.token#3Ds_query.DO..10//.For.debugging.lex#2E
#0A..{.LET.ln,.name.#3D.?,.?#0A..2lex()#0A..2ln.:#3D
.lineno.&.#23xFF3#0A..2name.:#3D.opname(token)#0A#0A
..2SWITCHON.token.INTO#0A..2{.DEFAULT:#0A..6writef(
"token.#3D%i3.ln#3D%i5.%12t..*n",..1token,.ln,.name
)#0A..6ENDCASE#0A#0A..4CASE.s_name:#0A..6writef("to
ken.#3D%i3.ln#3D%i5.%12t..%s*n",.token,.ln,.name,.@
h3!wordnode)#0A..6ENDCASE..#0A#0A..4CASE.s_number:#0A
..6writef("token.#3D%i3.ln#3D%i5.%12t..%n*n",.token
,.ln,.name,.decval)#0A..6ENDCASE..#0A#0A..4CASE.s_f
num:#0A..6writef("token.#3D%i3.ln#3D%i5.%12t..%ne%n
*n",.token,.ln,.name,#0A..14decval,.exponent)#0A..6
ENDCASE..#0A#0A..4CASE.s_string:#0A..4{.LET.s.#3D.@
h2!wordnode#0A..6writef("token.#3D%i3.ln#3D%i5.%12t
.*"",.token,.ln,.name)#0A..6FOR.i.#3D.1.TO.s%0.DO#0A
..6{.LET.ch.#3D.s%i#0A..8SWITCHON.ch.INTO#0A..8{.DE
FAULT:..3wrch(ch);..2LOOP#0A#0A..10CASE.'*n':.write
s("**n");.LOOP#0A..10CASE.'*s':.writes("**s");.LOOP
#0A..10CASE.'*p':.writes("**p");.LOOP#0A..10CASE.'*
t':.writes("**t");.LOOP#0A..8}#0A..6}#0A..6writes("
*"*n")#0A..6ENDCASE#0A..4}..#0A..2}#0A#0A..2IF.toke
n#3Ds_eof.RESULTIS.0#0A..}.REPEAT#0A#0Arec:res.:#3D
.token#3Ds_section.->.rprog(s_section),#0A..9token#3D
s_needs..1->.rprog(s_needs),.rdblockbody(TRUE)#0A//
sawritef("section.ended.with.%s*n",.opname(token))#0A
..UNLESS.token#3Ds_dot.|.token#3Ds_eof.DO.synerr("I
ncorrect.termination")#0A.#0A..RESULTIS.res#0A}#0A.
#0AAND.rprog(thing).#3D.VALOF#0A{.LET.a.#3D.0#0A..l
ex()#0A..a.:#3D.rbexp()#0A..UNLESS.h1!a#3Ds_string.
DO.synerr("Bad.SECTION.or.NEEDS.name")#0A..RESULTIS
.mk3(thing,.a,#0A..15token#3Ds_needs.->.rprog(s_nee
ds),#0A..31rdblockbody(TRUE)).//.TRUE#3Doutmost.lev
el#0A}#0A.#0A.#0AAND.synerr(mess,.a).BE#0A{.LET.fno
.#3D.lineno>>00020#0A..LET.ln.#3D.lineno.&.#23xFF3#0A
..LET.filename.#3D.sourcenamev!fno#0A..errcount.:#3D
.errcount.+.1#0A..writef("*nError.near.")#0A..IF.fi
lename.DO.writef("%s",.filename)#0A..writef("[%n]:.
.",.ln)#0A..writef(mess,.a)#0A..wrchbuf()#0A..IF.ha
rd.DO.abort(1001)#0A..IF.errcount.>.errmax.DO#0A..{
.writes("*nCompilation.aborted*n")#0A..2longjump(fi
n_p,.fin_l)#0A..}#0A..nlpending.:#3D.FALSE#0A.#0A..
UNTIL.token#3Ds_lsect.|.token#3Ds_rsect.|#0A..6toke
n#3Ds_let.|.token#3Ds_and.|#0A..6token#3Ds_dot.|.to
ken#3Ds_eof.|.nlpending.DO.lex()#0A#0A..IF.token#3D
s_and.DO.token.:#3D.s_let#0A..longjump(rec_p,.rec_l
)#0A}#0A.#0ALET.rdblockbody(outerlevel).#3D.VALOF#0A
{.LET.p,.l.#3D.rec_p,.rec_l#0A..LET.a,.ln.#3D.0,.?#0A
.#0A..rec_p,.rec_l.:#3D.level(),.recover#0A#0Arecov
er:..#0A..IF.token#3Ds_semicolon.DO.lex()#0A.#0A..l
n.:#3D.lineno#0A..1#0A..SWITCHON.token.INTO#0A..{.C
ASE.s_manifest:#0A..2CASE.s_static:#0A..2CASE.s_glo
bal:#0A..12{.LET.op.#3D.token#0A..14lex()#0A..14a.:
#3D.rdsect(rdcdefs,.op#3Ds_global->s_colon,s_eq)#0A
..14a.:#3D.mk4(op,.a,.rdblockbody(outerlevel),.ln)#0A
..14ENDCASE#0A..12}#0A.#0A.#0A..2CASE.s_let:.lex()#0A
..14a.:#3D.rdef(outerlevel)#0A..14WHILE.token#3Ds_a
nd.DO#0A..14{.LET.ln1.#3D.lineno#0A..16lex()#0A..16
a.:#3D.mk4(s_and,.a,.rdef(outerlevel),.ln1)#0A..14}
#0A..14a.:#3D.mk4(s_let,.a,.rdblockbody(outerlevel)
,.ln)#0A..14ENDCASE#0A.#0A..2DEFAULT:..2IF.outerlev
el.DO#0A..14{.errmax.:#3D.0.//.Make.it.fatal#2E#0A.
.16synerr("Bad.outer.level.declaration")#0A..14}#0A
..14a.:#3D.rdseq()#0A..14UNLESS.token#3Ds_rsect.DO.
synerr("Error.in.command")#0A.#0A..2CASE.s_rsect:IF
.outerlevel.DO.lex()#0A..2CASE.s_dot:#0A..2CASE.s_e
of:#0A..}#0A.#0A..rec_p,.rec_l.:#3D.p,.l#0A..RESULT
IS.a#0A}#0A.#0AAND.rdseq().#3D.VALOF#0A{.LET.a.#3D.
0#0A..1IF.token#3Ds_semicolon.DO.lex()#0A..1a.:#3D.
rcom()#0A..1IF.token#3Ds_rsect.|.token#3Ds_dot.|.to
ken#3Ds_eof.RESULTIS.a#0A..1RESULTIS.mk3(s_seq,.a,.
rdseq())#0A}#0A#0AAND.rdcdefs(sep).#3D.VALOF#0A{.LE
T.res,.id.#3D.0,.0#0A..1LET.ptr.#3D.@res#0A..1LET.p
,.l.#3D.rec_p,.rec_l#0A..1LET.kexp.#3D.0#0A#0A.#0A.
.1{.LET.ln.#3D.lineno#0A..4rec_p,.rec_l.:#3D.level(
),.recov#0A..4kexp.:#3D.0#0A..4id.:#3D.rname()#0A..
4IF.token#3Dsep.DO.kexp.:#3D.rnexp(0)#0A..4!ptr.:#3D
.mk5(s_constdef,.0,.id,.kexp,.ln)#0A..4ptr.:#3D.@h2
!(!ptr)#0A#0Arecov:IF.token#3Ds_semicolon.DO.lex()#0A
..1}.REPEATWHILE.token#3Ds_name#0A.#0A..1rec_p,.rec
_l.:#3D.p,.l#0A..1RESULTIS.res#0A}#0A.#0AAND.rdsect
(r,.arg).#3D.VALOF#0A//.Used.only.for.MANIFEST,.STA
TIC.and.GLOBAL.declarations,#0A//.SWITCHON.commands
.and.blocks#2E#0A{.LET.tag,.res.#3D.wordnode,.0#0A.
.1UNLESS.token#3Ds_lsect.DO.synerr("'{'.or.'$('.exp
ected")#0A..1lex()#0A..1UNLESS.token#3Ds_rsect.DO.r
es.:#3D.r(arg).//.Allow.{.}..MR.22/6/05#0A..1UNLESS
.token#3Ds_rsect.DO.synerr("'}'.or.'$)'.expected")#0A
..1TEST.tag#3Dwordnode.THEN.lex()#0A..19ELSE.IF.wor
dnode#3Dnulltag.DO#0A..24{.token.:#3D.0#0A..26syner
r("Untagged.'$)'.mismatch")#0A..24}#0A..1//.res#3D0
.for.empty.section.brackets.{.}#0A..1RESULTIS.res#0A
}#0A#0AAND.rnamelist().#3D.VALOF#0A{.LET.a.#3D.rnam
e()#0A..1UNLESS.token#3Ds_comma.RESULTIS.a#0A..1lex
()#0A..1RESULTIS.mk3(s_comma,.a,.rnamelist())#0A}#0A
#0AAND.rname().#3D.VALOF#0A{.LET.a.#3D.wordnode#0A.
.1UNLESS.token#3Ds_name.DO.synerr("Name.expected")#0A
..1lex()#0A..1RESULTIS.a#0A}#0A.#0ALET.rbexp().#3D.
VALOF#0A{.LET.a,.op.#3D.0,.token#0A.#0A..1SWITCHON.
token.INTO#0A.#0A..1{.DEFAULT:.synerr("Error.in.exp
ression")#0A#0A..4CASE.s_query:..lex()#0A..19RESULT
IS.mk1(s_query)#0A.#0A..4CASE.s_true:#0A..4CASE.s_f
alse:#0A..4CASE.s_name:#0A..4CASE.s_string:.a.:#3D.
wordnode#0A..19lex()#0A..19RESULTIS.a#0A.#0A..4CASE
.s_number:.a.:#3D.mk2(s_number,.decval)#0A..19lex()
#0A..19RESULTIS.a#0A#0A..4CASE.s_fnum:..1UNLESS.-12
8<#3Dexponent<#3D127.DO#0A..21synerr("Exponent.of.f
loating.point.constant.out.of.range")#0A..19floatin
gchk()#0A..19a.:#3D.mk3(s_number,.sys(Sys_flt,.fl_m
k,.decval,.exponent))#0A..19lex()#0A..19RESULTIS.a#0A
#0A..4CASE.s_slct:.{.LET.len,.sh,.offset.#3D.0,.0,.
0..//.Inserted.11/7/01#0A#0A..19//.Allow..1SLCT.off
set#0A..19//.or..4SLCT.sh:offset#0A..19//.or..4SLCT
.len:sh:offset#0A#0A..19offset.:#3D.rnexp(9)#0A#0A.
.19IF.token#3Ds_colon.DO#0A..19{.sh.:#3D.offset#0A.
.21offset.:#3D.rnexp(9)#0A..19}#0A..19IF.token#3Ds_
colon.DO#0A..19{.len.:#3D.sh#0A..21sh.:#3D.offset#0A
..21offset.:#3D.rnexp(9)#0A..19}#0A#0A..19RESULTIS.
mk4(s_slct,.len,.sh,.offset)#0A..17}#0A.#0A..4CASE.
s_lparen:.a.:#3D.rnexp(0)#0A..19UNLESS.token#3Ds_rp
aren.DO.synerr("')'.missing")#0A..19lex()#0A..19RES
ULTIS.a#0A.#0A..4CASE.s_valof:..lex()#0A..19RESULTI
S.mk2(s_valof,.rcom())#0A.#0A..4CASE.s_vecap:..op.:
#3D.s_rv#0A..4CASE.s_float:#0A..4CASE.s_fix:#0A..4C
ASE.s_lv:#0A..4CASE.s_rv:..3RESULTIS.mk2(op,.rnexp(
7))#0A.#0A..4CASE.s_fadd:#0A..4CASE.s_add:..2RESULT
IS.rnexp(5)#0A.#0A..4CASE.s_sub:..2a.:#3D.rnexp(5)#0A
..19TEST.h1!a#3Ds_number.THEN.h2!a.:#3D.-.h2!a#0A..
38ELSE.a.:#3D.mk2(s_neg,.a)#0A..19RESULTIS.a#0A..4C
ASE.s_fsub:..1a.:#3D.rnexp(5)#0A..19a.:#3D.mk2(s_fn
eg,.a)#0A..19RESULTIS.a#0A.#0A..4CASE.s_fabs:#0A..4
CASE.s_abs:..2RESULTIS.mk2(op,.rnexp(5))#0A.#0A..4C
ASE.s_not:..2RESULTIS.mk2(s_not,.rnexp(3))#0A.#0A..
4CASE.s_table:..lex()#0A..19RESULTIS.mk2(s_table,.r
explist())#0A..}#0A}#0A.#0AAND.rnexp(n).#3D.VALOF.{
.lex();.RESULTIS.rexp(n).}#0A.#0AAND.rexp(n).#3D.VA
LOF#0A{.LET.a,.b,.p.#3D.rbexp(),.0,.0#0A#0A..1UNTIL
.nlpending.DO.#0A..1{.LET.op.#3D.token#0A.#0A..4SWI
TCHON.op.INTO#0A.#0A..4{.DEFAULT:..5RESULTIS.a#0A.#0A
..7CASE.s_lparen:.lex()#0A..22b.:#3D.0#0A..22UNLESS
.token#3Ds_rparen.DO.b.:#3D.rexplist()#0A..22UNLESS
.token#3Ds_rparen.DO.synerr("')'.missing")#0A..22le
x()#0A..22a.:#3D.mk4(s_fnap,.a,.b,.0)#0A..22LOOP#0A
.#0A..7CASE.s_mthap:{.LET.e1.#3D.0#0A..23lex()#0A..
23UNLESS.token#3Ds_lparen.DO.synerr("'('.missing")#0A
..23lex()#0A..23b.:#3D.0#0A..23UNLESS.token#3Ds_rpa
ren.DO.b.:#3D.rexplist()#0A..23IF.b#3D0.DO.synerr("
argument.expression.missing")#0A..23UNLESS.token#3D
s_rparen.DO.synerr("')'.missing")#0A..23lex()#0A..2
3TEST.h1!b#3Ds_comma#0A..23THEN.e1.:#3D.h2!b#0A..23
ELSE.e1.:#3D.b#0A..23a.:#3D.mk3(s_vecap,.mk2(s_rv,.
e1),.a)#0A..23a.:#3D.mk4(s_fnap,.a,.b,.0)#0A..23LOO
P#0A..20}#0A.#0A..7CASE.s_sbra:..1b.:#3D.rnexp(0)..
1//.Inserted.11/6/02#0A..22UNLESS.token#3Ds_sket.DO
.synerr("']'.missing")#0A..22lex()#0A..22a.:#3D.mk3
(s_vecap,.a,.b)#0A..22LOOP#0A.#0A..7CASE.s_of:..3p.
:#3D.8;.ENDCASE.//.Inserted.11/7/01#0A#0A..7CASE.s_
vecap:..p.:#3D.8;.ENDCASE#0A..7CASE.s_byteap:.p.:#3D
.8;.ENDCASE.//.Changed.from.7.on.16.Dec.1991#0A..7C
ASE.s_fmul:#0A..7CASE.s_fdiv:#0A..7CASE.s_mul:#0A..
7CASE.s_div:#0A..7CASE.s_rem:..2p.:#3D.6;.ENDCASE#0A
#0A..7CASE.s_fadd:#0A..7CASE.s_fsub:#0A..7CASE.s_ad
d:#0A..7CASE.s_sub:..2p.:#3D.5;.ENDCASE#0A.#0A..7CA
SE.s_feq:CASE.s_fle:CASE.s_fls:#0A..7CASE.s_fne:CAS
E.s_fge:CASE.s_fgr:#0A..7CASE.s_eq:CASE.s_le:CASE.s
_ls:#0A..7CASE.s_ne:CASE.s_ge:CASE.s_gr:#0A..22IF.n
>#3D4.RESULTIS.a#0A..22b.:#3D.rnexp(4)#0A..22a.:#3D
.mk3(op,.a,.b)#0A..22WHILE..s_eq<#3Dtoken<#3Ds_ge.|
#0A..29s_feq<#3Dtoken<#3Ds_fge.DO#0A..22{.LET.c.#3D
.b#0A..25op.:#3D.token#0A..25b.:#3D.rnexp(4)#0A..25
a.:#3D.mk3(s_logand,.a,.mk3(op,.c,.b))#0A..22}#0A..
22LOOP#0A.#0A..7CASE.s_lshift:#0A..7CASE.s_rshift:.
IF.n>#3D4.RESULTIS.a#0A..22a.:#3D.mk3(op,.a,.rnexp(
4))#0A..22LOOP#0A#0A..7CASE.s_logand:.p.:#3D.3;.END
CASE#0A..7CASE.s_logor:..p.:#3D.2;.ENDCASE#0A..7CAS
E.s_eqv:#0A..7CASE.s_neqv:..1p.:#3D.1;.ENDCASE#0A.#0A
..7CASE.s_cond:..1IF.n>#3D1.RESULTIS.a#0A..22b.:#3D
.rnexp(0)#0A..22UNLESS.token#3Ds_comma.DO#0A..29syn
err("Bad.conditional.expression")#0A..22a.:#3D.mk4(
s_cond,.a,.b,.rnexp(0))#0A..22LOOP#0A..4}#0A..4#0A.
.4IF.n>#3Dp.RESULTIS.a#0A..4a.:#3D.mk3(op,.a,.rnexp
(p))#0A..1}#0A..1#0A..1RESULTIS.a#0A}#0A.#0ALET.rex
plist().#3D.VALOF#0A{.LET.res,.a.#3D.0,.rexp(0)#0A.
.1LET.ptr.#3D.@res#0A.#0A..1WHILE.token#3Ds_comma.D
O.{.!ptr.:#3D.mk3(s_comma,.a,.0)#0A..26ptr.:#3D.@h3
!(!ptr)#0A..26a.:#3D.rnexp(0)#0A..23}#0A..1!ptr.:#3D
.a#0A..1RESULTIS.res#0A}#0A.#0ALET.rdef(outerlevel)
.#3D.VALOF#0A{.LET.n.#3D.rnamelist()#0A..1LET.ln.#3D
.lineno#0A#0A..1SWITCHON.token.INTO#0A.#0A..1{.CASE
.s_lparen:#0A..6{.LET.a.#3D.0#0A..9lex()#0A..9UNLES
S.h1!n#3Ds_name.DO.synerr("Bad.formal.parameter")#0A
..9IF.token#3Ds_name.DO.a.:#3D.rnamelist()#0A..9UNL
ESS.token#3Ds_rparen.DO.synerr("')'.missing")#0A..9
lex()#0A.#0A..9IF.token#3Ds_be.DO#0A..9{.lex()#0A..
12RESULTIS.mk6(s_rtdef,.n,.a,.rcom(),.0,.ln)#0A..9}
#0A.#0A..9IF.token#3Ds_eq.RESULTIS.mk6(s_fndef,.n,.
a,.rnexp(0),.0,.ln)#0A.#0A..9synerr("Bad.procedure.
heading")#0A..6}#0A.#0A..4DEFAULT:.synerr("Bad.decl
aration")#0A.#0A..4CASE.s_eq:#0A..9IF.outerlevel.DO
.synerr("Bad.outer.level.declaration")#0A..9lex()#0A
..9IF.token#3Ds_vec.DO#0A..9{.UNLESS.h1!n#3Ds_name.
DO.synerr("Name.required.before.#3D.VEC")#0A..12RES
ULTIS.mk4(s_vecdef,.n,.rnexp(0),.ln)#0A..9}#0A..9RE
SULTIS.mk4(s_valdef,.n,.rexplist(),.ln)#0A..1}#0A}#0A
.#0ALET.rbcom().#3D.VALOF#0A{.LET.a,.b,.op,.ln.#3D.
0,.0,.token,.lineno#0A.#0A..SWITCHON.token.INTO#0A.
.{.DEFAULT:.RESULTIS.0#0A.#0A..2CASE.s_name:CASE.s_
number:CASE.s_fnum:#0A..2CASE.s_string:CASE.s_lpare
n:#0A..2CASE.s_true:CASE.s_false:CASE.s_lv:CASE.s_r
v:CASE.s_vecap:#0A..2CASE.s_slct:..6//.Inserted.11/
7/01#0A..2CASE.s_add:CASE.s_sub:CASE.s_abs:CASE.s_n
ot:#0A..2CASE.s_fadd:CASE.s_fsub:CASE.s_fabs:CASE.s
_fix:CASE.s_float:#0A..2CASE.s_table:CASE.s_valof:C
ASE.s_query:#0A..10//.All.tokens.that.can.start.an.
expression#2E#0A..10a.:#3D.rexplist()#0A.#0A..10IF.
token#3Ds_ass.DO#0A..10{.op.:#3D.token#0A..13lex()#0A
..13RESULTIS.mk4(op,.a,.rexplist(),.ln)#0A..10}#0A.
#0A..10IF.token#3Ds_colon.DO#0A..10{.UNLESS.h1!a#3D
s_name.DO.synerr("Unexpected.':'")#0A..13lex()#0A..
13RESULTIS.mk5(s_colon,.a,.rbcom(),.0,.ln)#0A..10}#0A
.#0A..10IF.h1!a#3Ds_fnap.DO#0A..10{.h1!a,.h4!a.:#3D
.s_rtap,.ln#0A..13RESULTIS.a#0A..10}#0A.#0A..10syne
rr("Error.in.command")#0A..10RESULTIS.a#0A.#0A..2CA
SE.s_goto:#0A..2CASE.s_resultis:#0A..10RESULTIS.mk3
(op,.rnexp(0),.ln)#0A.#0A..2CASE.s_if:#0A..2CASE.s_
unless:#0A..2CASE.s_while:#0A..2CASE.s_until:#0A..1
0a.:#3D.rnexp(0)#0A..10IF.token#3Ds_do.DO.lex()#0A.
.10RESULTIS.mk4(op,.a,.rcom(),.ln)#0A.#0A..2CASE.s_
test:#0A..10a.:#3D.rnexp(0)#0A..10IF.token#3Ds_do.D
O.lex()#0A..10b.:#3D.rcom()#0A..10UNLESS.token#3Ds_
else.DO.synerr("ELSE.missing")#0A..10lex()#0A..10RE
SULTIS.mk5(s_test,.a,.b,.rcom(),.ln)#0A.#0A..2CASE.
s_for:#0A..7{.LET.i,.j,.k.#3D.0,.0,.0#0A..10lex()#0A
..10a.:#3D.rname()#0A..10UNLESS.token#3Ds_eq.DO.syn
err("'#3D'.missing")#0A..10i.:#3D.rnexp(0)#0A..10UN
LESS.token#3Ds_to.DO.synerr("TO.missing")#0A..10j.:
#3D.rnexp(0)#0A..10IF.token#3Ds_by.DO.k.:#3D.rnexp(
0)#0A..10IF.token#3Ds_do.DO.lex()#0A..10RESULTIS.mk
7(s_for,.a,.i,.j,.k,.rcom(),.ln)#0A..7}#0A.#0A..2CA
SE.s_loop:#0A..2CASE.s_break:#0A..2CASE.s_return:#0A
..2CASE.s_finish:#0A..2CASE.s_endcase:#0A..10lex()#0A
..10RESULTIS.mk2(op,.ln)#0A.#0A..2CASE.s_switchon:#0A
..10a.:#3D.rnexp(0)#0A..10UNLESS.token#3Ds_into.DO.
synerr("INTO.missing")#0A..10lex()#0A..10{.LET.skip
ln.#3D.lineno#0A..12b.:#3D.rdsect(rdseq)#0A..12UNLE
SS.b.DO#0A..14b.:#3D.mk2(s_skip,.skipln)..7//.MR.5/
4/06#0A..10}#0A..10RESULTIS.mk4(s_switchon,.a,.b,.l
n)#0A.#0A..2CASE.s_case:#0A..10a.:#3D.rnexp(0)#0A..
10UNLESS.token#3Ds_colon.DO.synerr("Bad.CASE.label"
)#0A..10lex()#0A..10RESULTIS.mk4(s_case,.a,.rbcom()
,.ln)#0A.#0A..2CASE.s_default:#0A..10lex()#0A..10UN
LESS.token#3Ds_colon.DO.synerr("Bad.DEFAULT.label")
#0A..10lex()#0A..10RESULTIS.mk3(s_default,.rbcom(),
.ln)#0A.#0A..2CASE.s_lsect:#0A..10a.:#3D.rdsect(rdb
lockbody,.FALSE)#0A..10UNLESS.a.DO#0A..12a.:#3D.mk2
(s_skip,.ln)..6//.MR.5/4/06#0A..10RESULTIS.a#0A..}#0A
}#0A#0AAND.rcom().#3D.VALOF#0A{.LET.a.#3D.rbcom()#0A
.#0A..1//.Empty.section.brackets.{.}.form.SKIP.node
s,.MR.22/6/05#0A..1IF.a#3D0.DO.synerr("Error.in.com
mand")#0A.#0A..1WHILE.token#3Ds_repeat.|.token#3Ds_
repeatwhile.|.token#3Ds_repeatuntil.DO#0A..1{.LET.o
p,.ln.#3D.token,.lineno#0A..4UNLESS.op#3Ds_repeat.{
.a.:#3D.mk4(op,.a,.rnexp(0),.ln);.LOOP.}#0A..4a.:#3D
.mk3(op,.a,.ln)#0A..4lex()#0A..1}#0A.#0A..1RESULTIS
.a#0A}#0A#0A/*#0ALET.plist(x).BE#0A{.writef("*nName
.table.contents,.size.#3D.%n*n",.nametablesize)#0A.
.1FOR.i.#3D.0.TO.nametablesize-1.DO#0A..1{.LET.p,.n
.#3D.nametable!i,.0#0A..4UNTIL.p#3D0.DO.p,.n.:#3D.p
!1,.n+1#0A..4writef("%i3:%n",.i,.n)#0A..4p.:#3D.nam
etable!i#0A..4UNTIL.p#3D0.DO.{.writef(".%s",.p+2);.
p.:#3D.p!1..}#0A..4newline()#0A..1}#0A}#0A*/#0ALET.
plist(x,.n,.d).BE#0A{.LET.size,.ln.#3D.0,.0#0A..LET
.v.#3D.TABLE.0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0#0A#0A..IF.x#3D0.DO.{.writes("Nil");.RETURN..}#0A.
#0A..SWITCHON.h1!x.INTO#0A..{.CASE.s_number:#0A..15
{.LET.val.#3D.h2!x#0A..17TEST.-1004<#3Dval<#3D1004#0A
..17THEN.writef("NUM:.%n",.val)#0A..17ELSE.writef("
NUM:.%x8",.val)#0A..17RETURN#0A..15}#0A#0A..2CASE.s
_name:..1writef("NAME:.%s",.x+2);..9RETURN#0A.#0A..
2CASE.s_string:#0A..14{.LET.s.#3D.x+1#0A..16writef(
"STRING:.*"")#0A..16FOR.i.#3D.1.TO.s%0.SWITCHON.s%i
.INTO#0A..16{.DEFAULT:..1wrch(s%i);.LOOP#0A..18CASE
.'*n':.writes("**n");.LOOP#0A..18CASE.'*p':.writes(
"**p");.LOOP#0A..18CASE.'*s':.writes("**s");.LOOP#0A
..18CASE.'*t':.writes("**t");.LOOP#0A..16}#0A..16wr
ites("*"")#0A..16RETURN#0A..14}#0A.#0A..4CASE.s_for
:..2size,.ln.:#3D.6,.h7!x;..ENDCASE#0A.#0A..4CASE.s
_fndef:CASE.s_rtdef:#0A..19size,.ln.:#3D.4,.h6!x;..
ENDCASE#0A#0A..4CASE.s_cond:#0A..4CASE.s_slct:..5//
.Inserted.11/7/01#0A..19size.:#3D.4;..10ENDCASE#0A.
#0A..4CASE.s_test:CASE.s_constdef:#0A..19size,.ln.:
#3D.4,.h5!x;..ENDCASE#0A.#0A..4CASE.s_needs:CASE.s_
section:CASE.s_vecap:CASE.s_byteap:CASE.s_fnap:#0A.
.4CASE.s_of:..//.Inserted.11/7/01#0A..4CASE.s_fmul:
CASE.s_fdiv:CASE.s_fadd:CASE.s_fsub:#0A..4CASE.s_mu
l:CASE.s_div:CASE.s_rem:CASE.s_add:CASE.s_sub:#0A..
4CASE.s_feq:CASE.s_fne:CASE.s_fls:CASE.s_fgr:CASE.s
_fle:CASE.s_fge:#0A..4CASE.s_eq:CASE.s_ne:CASE.s_ls
:CASE.s_gr:CASE.s_le:CASE.s_ge:#0A..4CASE.s_lshift:
CASE.s_rshift:CASE.s_logand:CASE.s_logor:#0A..4CASE
.s_eqv:CASE.s_neqv:CASE.s_comma:#0A..4CASE.s_seq:#0A
..19size.:#3D.3;..10ENDCASE#0A..19#0A..4CASE.s_vald
ef:CASE.s_vecdef:#0A..19size,.ln.:#3D.3,.h4!x;..END
CASE#0A#0A..4CASE.s_colon:#0A..19size,.ln.:#3D.3,.h
5!x;..ENDCASE#0A.#0A..4CASE.s_and:#0A..4CASE.s_ass:
CASE.s_rtap:CASE.s_if:CASE.s_unless:#0A..4CASE.s_wh
ile:CASE.s_until:CASE.s_repeatwhile:#0A..4CASE.s_re
peatuntil:#0A..4CASE.s_switchon:CASE.s_case:CASE.s_
let:#0A..4CASE.s_manifest:CASE.s_static:CASE.s_glob
al:#0A..19size,.ln.:#3D.3,.h4!x;..ENDCASE#0A.#0A..4
CASE.s_valof:CASE.s_lv:CASE.s_rv:CASE.s_neg:CASE.s_
not:#0A..4CASE.s_table:CASE.s_abs:#0A..4CASE.s_fabs
:CASE.s_fneg:CASE.s_fix:CASE.s_float:#0A..19size.:#3D
.2;..10ENDCASE#0A.#0A..4CASE.s_goto:CASE.s_resultis
:CASE.s_repeat:CASE.s_default:#0A..19size,.ln.:#3D.
2,.h3!x;..ENDCASE#0A.#0A..4CASE.s_true:CASE.s_false
:CASE.s_query:#0A..19size.:#3D.1;..10ENDCASE#0A..4#0A
..4CASE.s_skip:.//.MR.22/6/05#0A..4CASE.s_loop:CASE
.s_break:CASE.s_return:#0A..4CASE.s_finish:CASE.s_e
ndcase:#0A..19size,.ln.:#3D.1,.h2!x;..ENDCASE#0A#0A
..4DEFAULT:..5size.:#3D.1#0A..1}#0A.#0A..1IF.n#3Dd.
DO.{.writes("Etc");.RETURN.}#0A.#0A//..1writef("Op.
%n",.h1!x)#0A..1writef(opname(h1!x),.h1!x)#0A//.IF.
ln>0.DO.writef("..line.%n",.ln)#0A..1IF.ln>0.DO#0A.
.1{.LET.fno.#3D.ln>>00020#0A..3LET.lno.#3D.ln.&.#23
xFF3#0A..3LET.filename.#3D.sourcenamev!fno#0A..3wri
tef("..")#0A..3IF.filename.DO.writef("%s",.filename
)#0A..3writef("[%n]",.lno)#0A..1}#0A..1FOR.i.#3D.2.
TO.size.DO.{.newline()#0A..24FOR.j#3D0.TO.n-1.DO.wr
ites(.v!j.)#0A..24writes("**-")#0A..24v!n.:#3D.i#3D
size->"..","!."#0A..24plist(h1!(x+i-1),.n+1,.d)#0A.
.22}#0A}#0A.#0AAND.opname(op).#3D.VALOF.SWITCHON.op
.INTO#0A{.DEFAULT:..10writef("*nopname.#3D.%n*n",.o
p)#0A..20RESULTIS."Op.%n"#0A#0A..CASE.s_abs:..7RESU
LTIS."ABS"#0A..CASE.s_and:..7RESULTIS."AND"#0A..CAS
E.s_ass:..7RESULTIS."ASS"#0A..CASE.s_be:..8RESULTIS
."BE"#0A..CASE.s_by:..8RESULTIS."BY"#0A..CASE.s_bre
ak:..5RESULTIS."BREAK"#0A..CASE.s_byteap:..4RESULTI
S."BYTEAP"#0A..CASE.s_case:..6RESULTIS."CASE"#0A..C
ASE.s_colon:..5RESULTIS."COLON"#0A..CASE.s_comma:..
5RESULTIS."COMMA"#0A..CASE.s_cond:..6RESULTIS."COND
"#0A..CASE.s_constdef:..2RESULTIS."CONSTDEF"#0A..CA
SE.s_datalab:..3RESULTIS."DATALAB"#0A..CASE.s_defau
lt:..3RESULTIS."DEFAULT"#0A..CASE.s_div:..7RESULTIS
."DIV"#0A..CASE.s_do:..8RESULTIS."DO"#0A..CASE.s_do
t:..7RESULTIS."DOT"#0A..CASE.s_else:..6RESULTIS."EL
SE"#0A..CASE.s_eof:..7RESULTIS."EOF"#0A..CASE.s_end
case:..3RESULTIS."ENDCASE"#0A..CASE.s_endfor:..4RES
ULTIS."ENDFOR"#0A..CASE.s_endproc:..3RESULTIS."ENDP
ROC"#0A..CASE.s_entry:..5RESULTIS."ENTRY"#0A..CASE.
s_eq:..8RESULTIS."EQ"#0A..CASE.s_eqv:..7RESULTIS."E
QV"#0A..CASE.s_fabs:..6RESULTIS."FABS"#0A..CASE.s_f
add:..6RESULTIS."FADD"#0A..CASE.s_false:..5RESULTIS
."FALSE"#0A..CASE.s_fdiv:..6RESULTIS."FDIV"#0A..CAS
E.s_feq:..7RESULTIS."FEQ"#0A..CASE.s_fge:..7RESULTI
S."FGE"#0A..CASE.s_fgr:..7RESULTIS."FGR"#0A..CASE.s
_finish:..4RESULTIS."FINISH"#0A..CASE.s_fix:..7RESU
LTIS."FIX"#0A..CASE.s_fle:..7RESULTIS."FLE"#0A..CAS
E.s_float:..5RESULTIS."FLOAT"#0A..CASE.s_fls:..7RES
ULTIS."FLS"#0A..CASE.s_fltop:..5RESULTIS."FLTOP"#0A
..CASE.s_fnap:..6RESULTIS."FNAP"#0A..CASE.s_fnrn:..
6RESULTIS."FNRN"#0A..CASE.s_fndef:..5RESULTIS."FNDE
F"#0A..CASE.s_fne:..7RESULTIS."FNE"#0A..CASE.s_fneg
:..6RESULTIS."FNEG"#0A..CASE.s_fnum:..6RESULTIS."FN
UM"#0A..CASE.s_fmul:..6RESULTIS."FMUL"#0A..CASE.s_f
sub:..6RESULTIS."FSUB"#0A#0A..CASE.s_for:..7RESULTI
S."FOR"#0A..CASE.s_ge:..8RESULTIS."GE"#0A..CASE.s_g
et:..7RESULTIS."GET"#0A..CASE.s_getbyte:..3RESULTIS
."GETBYTE"#0A..CASE.s_global:..4RESULTIS."GLOBAL"#0A
..CASE.s_goto:..6RESULTIS."GOTO"#0A..CASE.s_gr:..8R
ESULTIS."GR"#0A..CASE.s_if:..8RESULTIS."IF"#0A..CAS
E.s_into:..6RESULTIS."INTO"#0A..CASE.s_itemn:..5RES
ULTIS."ITEMN"#0A..CASE.s_jf:..8RESULTIS."JF"#0A..CA
SE.s_jt:..8RESULTIS."JT"#0A..CASE.s_jump:..6RESULTI
S."JUMP"#0A..CASE.s_lab:..7RESULTIS."LAB"#0A..CASE.
s_le:..8RESULTIS."LE"#0A..CASE.s_let:..7RESULTIS."L
ET"#0A..CASE.s_lf:..8RESULTIS."LF"#0A..CASE.s_lg:..
8RESULTIS."LG"#0A..CASE.s_ll:..8RESULTIS."LL"#0A..C
ASE.s_llg:..7RESULTIS."LLG"#0A..CASE.s_ll1:..7RESUL
TIS."LLl"#0A..CASE.s_llp:..7RESULTIS."LLP"#0A..CASE
.s_ln:..8RESULTIS."LN"#0A..CASE.s_logand:..4RESULTI
S."LOGAND"#0A..CASE.s_logor:..5RESULTIS."LOGOR"#0A.
.CASE.s_loop:..6RESULTIS."LOOP"#0A..CASE.s_lp:..8RE
SULTIS."LP"#0A..CASE.s_lparen:..4RESULTIS."LPAREN"#0A
..CASE.s_ls:..8RESULTIS."LS"#0A..CASE.s_lsect:..5RE
SULTIS."LSECT"#0A..CASE.s_lshift:..4RESULTIS."LSHIF
T"#0A..CASE.s_lstr:..6RESULTIS."LSTR"#0A..CASE.s_lv
:..8RESULTIS."LV"#0A..CASE.s_manifest:..2RESULTIS."
MANIFEST"#0A..CASE.s_mthap:..5RESULTIS."MTHAP"#0A..
CASE.s_mul:..6RESULTIS."MUL"#0A..CASE.s_name:..6RES
ULTIS."NAME"#0A..CASE.s_ne:..8RESULTIS."NE"#0A..CAS
E.s_needs:..5RESULTIS."NEEDS"#0A..CASE.s_neg:..7RES
ULTIS."NEG"#0A..CASE.s_neqv:..6RESULTIS."NEQV"#0A..
CASE.s_none:..6RESULTIS."NONE"#0A..CASE.s_not:..7RE
SULTIS."NOT"#0A..CASE.s_number:..4RESULTIS."NUMBER"
#0A..CASE.s_of:..8RESULTIS."OF"#0A..CASE.s_add:..7R
ESULTIS."ADD"#0A..CASE.s_putbyte:..3RESULTIS."PUTBY
TE"#0A..CASE.s_query:..5RESULTIS."QUERY"#0A..CASE.s
_rem:..7RESULTIS."REM"#0A..CASE.s_repeat:..4RESULTI
S."REPEAT"#0A..CASE.s_repeatuntil:.RESULTIS."REPEAT
UNTIL"#0A..CASE.s_repeatwhile:.RESULTIS."REPEATWHIL
E"#0A..CASE.s_res:..7RESULTIS."RES"#0A..CASE.s_resu
ltis:..2RESULTIS."RESULTIS"#0A..CASE.s_return:..4RE
SULTIS."RETURN"#0A..CASE.s_rparen:..4RESULTIS."RPAR
EN"#0A..CASE.s_rsect:..5RESULTIS."RSECT"#0A..CASE.s
_rshift:..4RESULTIS."RSHIFT"#0A..CASE.s_rstack:..4R
ESULTIS."RSTACK"#0A..CASE.s_rtap:..6RESULTIS."RTAP"
#0A..CASE.s_rtdef:..5RESULTIS."RTDEF"#0A..CASE.s_rt
rn:..6RESULTIS."RTRN"#0A..CASE.s_rv:..8RESULTIS."RV
"#0A..CASE.s_save:..6RESULTIS."SAVE"#0A..CASE.s_sbr
a:..6RESULTIS."SBRA"#0A..CASE.s_section:..3RESULTIS
."SECTION"#0A..CASE.s_semicolon:..1RESULTIS."SEMICO
LON"#0A..CASE.s_seq:..7RESULTIS."SEQ"#0A..CASE.s_sg
:..8RESULTIS."SG"#0A..CASE.s_sket:..6RESULTIS."SKET
"#0A..CASE.s_skip:..6RESULTIS."SKIP"#0A..CASE.s_sl:
..8RESULTIS."SL"#0A..CASE.s_slct:..6RESULTIS."SLCT"
#0A..CASE.s_selld:..5RESULTIS."SELLD"#0A..CASE.s_se
lst:..5RESULTIS."SELST"#0A..CASE.s_sp:..8RESULTIS."
SP"#0A..CASE.s_stack:..5RESULTIS."STACK"#0A..CASE.s
_static:..4RESULTIS."STATIC"#0A..CASE.s_stind:..5RE
SULTIS."STIND"#0A..CASE.s_store:..5RESULTIS."STORE"
#0A..CASE.s_string:..4RESULTIS."STRING"#0A..CASE.s_
sub:..7RESULTIS."SUB"#0A..CASE.s_switchon:..2RESULT
IS."SWITCHON"#0A..CASE.s_table:..5RESULTIS."TABLE"#0A
..CASE.s_test:..6RESULTIS."TEST"#0A..CASE.s_to:..8R
ESULTIS."TO"#0A..CASE.s_true:..6RESULTIS."TRUE"#0A.
.CASE.s_unless:..4RESULTIS."UNLESS"#0A..CASE.s_unti
l:..5RESULTIS."UNTIL"#0A..CASE.s_valdef:..4RESULTIS
."VALDEF"#0A..CASE.s_valof:..5RESULTIS."VALOF"#0A..
CASE.s_vec:..7RESULTIS."VEC"#0A..CASE.s_vecap:..5RE
SULTIS."VECAP"#0A..CASE.s_vecdef:..4RESULTIS."VECDE
F"#0A..CASE.s_while:..5RESULTIS."WHILE"#0A}#0A#0AAN
D.flopname(flop).#3D.VALOF.SWITCHON.flop.INTO#0A{.D
EFAULT:..10writef("*nopname.#3D.%n*n",.flop)#0A..20
abort(991)#0A..20RESULTIS."Flop.%n"#0A#0A..CASE.fl_
mk:..7RESULTIS."MK"#0A..CASE.fl_float:..4RESULTIS."
FLOAT"#0A..CASE.fl_fix:..6RESULTIS."FIX"#0A..CASE.f
l_neg:..6RESULTIS."NEG"#0A..CASE.fl_abs:..6RESULTIS
."ABS"#0A..CASE.fl_mul:..6RESULTIS."MUL"#0A..CASE.f
l_div:..6RESULTIS."DIV"#0A..CASE.fl_add:..6RESULTIS
."ADD"#0A..CASE.fl_sub:..6RESULTIS."SUB"#0A..CASE.f
l_eq:..7RESULTIS."EQ"#0A..CASE.fl_ne:..7RESULTIS."N
E"#0A..CASE.fl_ls:..7RESULTIS."LS"#0A..CASE.fl_gr:.
.7RESULTIS."GR"#0A..CASE.fl_le:..7RESULTIS."LE"#0A.
.CASE.fl_ge:..7RESULTIS."GE"#0A}#0A#0A//#2E#0A#0A//
SECTION."TRN"#0A#0A//GET."libhdr"#0A//GET."bcplfecg
"#0A.#0AGLOBAL..{#0Atrnext:trng#0Atrans;.declnames;
.decldyn#0Adeclstat;.checkdistinct;.addname;.cellwi
thname#0Atransdef;.scanlabel#0Adecllabels;.undeclar
e#0Ajumpcond;.transswitch;.transfor#0Aassign;.load;
.fnbody;.loadlv;.loadlist#0Aisconst;.evalconst;.tra
nsname;.xref#0Anextlab;.labnumber#0Anewblk#0Advec;.
dvece;.dvecp;.dvect#0Acaselist;.casecount#0Acontext
;.comline;.procname#0Aresultlab;.defaultlab;.endcas
elab#0Alooplab;.breaklab;.ssp;.vecssp#0Agdeflist;.g
defcount#0Aoutstring;.out1;.out2;.out3;.out4#0A}#0A
#0ALET.nextlab().#3D.VALOF#0A{.labnumber.:#3D.labnu
mber.+.1#0A..RESULTIS.labnumber#0A}#0A.#0AAND.trner
r(mess,.a).BE#0A{.LET.fno.#3D.comline>>00020#0A..LE
T.lno.#3D.comline.&.#23xFF3#0A..LET.filename.#3D.so
urcenamev!fno#0A..writes("Error.")#0A..UNLESS.procn
ame#3D0.DO.writef("in.%s.",.@h3!procname)#0A..write
f("near.")#0A..IF.filename.DO.writef("%s",.filename
)#0A..writef("[%n]:.",.lno)#0A..writef(mess,.a)#0A.
.newline()#0A..IF.hard.DO.abort(1001)#0A..errcount.
:#3D.errcount.+.1#0A..IF.errcount.>#3D.errmax.DO.{.
writes("*nCompilation.aborted*n")#0A..27longjump(fi
n_p,.fin_l)#0A..25}#0A}#0A#0AAND.newblk(x,.y,.z).#3D
.VALOF#0A{.LET.p.#3D.dvect.-.3#0A..IF.dvece>p.DO.{.
errmax.:#3D.0..6//.Make.it.fatal#2E#0A..16trnerr("M
ore.workspace.needed")#0A..14}#0A..p!0,.p!1,.p!2.:#3D
.x,.y,.z#0A..dvect.:#3D.p#0A..RESULTIS.p#0A}#0A#0AA
ND.translate(x).BE#0A{.dvec,..dvect.:#3D.treevec,.t
reep#0A..h1!dvec,.h2!dvec,.h3!dvec.:#3D.0,.0,.0#0A.
.dvece.:#3D.dvec+3#0A..dvecp.:#3D.dvece#0A//selecto
utput(sysprint)#0A..FOR.i.#3D.0.TO.nametablesize-1.
DO#0A..{.LET.name.#3D.nametable!i#0A..2UNTIL.name#3D
0.DO#0A..2{.LET.next.#3D.h2!name#0A..4h2!name.:#3D.
0.//.Mark.undeclared#0A//..1writef("Undeclare.%s*n"
,.name+2)#0A..4name.:#3D.next#0A..2}#0A..}#0A#0A..g
deflist,.gdefcount.:#3D.0,.0#0A..caselist,.casecoun
t,.defaultlab.:#3D.0,.-1,.0#0A..resultlab,.breaklab
,.looplab,.endcaselab.:#3D.-2,.-2,.-2,.-2#0A..conte
xt,.comline,.procname,.labnumber.:#3D.0,.1,.0,.0#0A
..ssp,.vecssp.:#3D.savespacesize,.savespacesize#0A#0A
..WHILE.x~#3D0.&.(h1!x#3Ds_section.|.h1!x#3Ds_needs
).DO#0A..{.LET.op,.a.#3D.h1!x,.h2!x#0A..2out1(op)#0A
..2outstring(@h2!a)#0A..2x:#3Dh3!x#0A..}#0A#0A..tra
ns(x,.0)#0A..out2(s_global,.gdefcount)#0A..UNTIL.gd
eflist#3D0.DO.{.out2(h2!gdeflist,.h3!gdeflist)#0A..
22gdeflist.:#3D.h1!gdeflist#0A..20}..#0A}#0A#0ALET.
trnext(next).BE.{.IF.next<0.DO.out1(s_rtrn)#0A..20I
F.next>0.DO.out2(s_jump,.next)#0A..18}#0A.#0ALET.tr
ans(x,.next).BE#0A//.x..5is.the.command.to.translat
e#0A//.next<0..compile.x.followed.by.RTRN#0A//.next
>0..compile.x.followed.by.JUMP.next#0A//.next#3D0..
compile.x.only#0A{.LET.op,.sw.#3D.?,.FALSE#0A#0A..I
F.x#3D0.DO.{.trnext(next);.RETURN.}#0A..op.:#3D.h1!
x#0A#0A..SWITCHON.op.INTO#0A..{.DEFAULT:.trnerr("Co
mpiler.error.in.Trans,.op.#3D.%s",.opname(op));.RET
URN#0A.#0A..2CASE.s_let:#0A..2{.LET.cc.#3D.casecoun
t#0A..4LET.e,.s,.s1.#3D.dvece,.ssp,.0#0A..4LET.v.#3D
.vecssp#0A..4casecount.:#3D.-1.//.Disallow.CASE.and
.DEFAULT.labels#0A..4context,.comline.:#3D.x,.h4!x#0A
..4declnames(h2!x)#0A..4checkdistinct(e)#0A..4vecss
p,.s1.:#3D.ssp,.ssp#0A..4ssp.:#3D.s#0A..4context,.c
omline.:#3D.x,.h4!x#0A..4transdef(h2!x)#0A..4UNLESS
.ssp#3Ds1.DO.trnerr("Lhs.and.rhs.do.not.match")#0A.
.4UNLESS.ssp#3Dvecssp.DO.{.ssp.:#3D.vecssp;.out2(s_
stack,.ssp).}#0A..4out1(s_store)#0A..4decllabels(h3
!x)#0A..4trans(h3!x,.next)#0A..4vecssp.:#3D.v#0A..4
UNLESS.ssp#3Ds.DO.out2(s_stack,.s)#0A..4ssp.:#3D.s#0A
..4casecount.:#3D.cc#0A..4undeclare(e)#0A..4RETURN#0A
..2}#0A.#0A..2CASE.s_static:#0A..2CASE.s_global:#0A
..2CASE.s_manifest:#0A..2{.LET.cc.#3D.casecount#0A.
.4LET.e,.s.#3D.dvece,.ssp#0A..4AND.y,.n.#3D.h2!x,.0
#0A..4LET.prevk.#3D.-1#0A..7#0A..4casecount.:#3D.-1
.//.Disallow.CASE.and.DEFAULT.labels#0A..4context,.
comline.:#3D.x,.h4!x#0A.#0A..4UNTIL.y#3D0.DO#0A..4{
.context,.comline.:#3D.y,.h5!y#0A..6n.:#3D.h4!y.->.
evalconst(h4!y),.prevk+1#0A..6context,.comline.:#3D
.y,.h5!y#0A..6prevk.:#3D.n#0A..6IF.op#3Ds_static.DO
.{.LET.k.#3D.n#0A..26n.:#3D.nextlab()#0A..26out2(s_
datalab,.n)#0A..26out2(s_itemn,.k)#0A..24}#0A..6IF.
op#3Ds_global.UNLESS.0<#3Dn<#3D65500035.DO#0A..8trn
err("Global.number.too.large.for:.%s*n",.@h3!(h3!y)
)#0A..6addname(h3!y,.op,.n)#0A..6IF.xrefing.DO.xref
(h3!y,#0A..25(op#3Ds_global->"G:",op#3Ds_static->"S
:","M:"),#0A..25n,#0A..25s_constdef#0A..24)#0A..6y.
:#3D.h2!y#0A..4}#0A.#0A..4decllabels(h3!x)#0A..4tra
ns(h3!x,.next)#0A..4ssp.:#3D.s#0A..4casecount.:#3D.
cc#0A..4undeclare(e)#0A..4RETURN#0A..2}#0A.#0A..2CA
SE.s_ass:#0A..4context,.comline.:#3D.x,.h4!x#0A..4a
ssign(h2!x,.h3!x)#0A..4trnext(next)#0A..4RETURN#0A.
#0A..2CASE.s_rtap:#0A..2{.LET.s.#3D.ssp#0A..4contex
t,.comline.:#3D.x,.h4!x#0A..4ssp.:#3D.ssp+savespace
size#0A..4out2(s_stack,.ssp)#0A..4loadlist(h3!x)#0A
..4load(h2!x)#0A..4out2(s_rtap,.s)#0A..4ssp.:#3D.s#0A
..4trnext(next)#0A..4RETURN#0A..2}#0A.#0A..2CASE.s_
goto:#0A..4context,.comline.:#3D.x,.h3!x#0A..4load(
h2!x)#0A..4out1(s_goto)#0A..4ssp.:#3D.ssp-1#0A..4RE
TURN#0A.#0A..2CASE.s_colon:#0A..4context,.comline.:
#3D.x,.h5!x#0A..4out2(s_lab,.h4!x)#0A..4trans(h3!x,
.next)#0A..4RETURN#0A.#0A..2CASE.s_unless:.sw.:#3D.
TRUE#0A..2CASE.s_if:#0A..4context,.comline.:#3D.x,.
h4!x#0A..4TEST.next>0.THEN.{.jumpcond(h2!x,.sw,.nex
t)#0A..23trans(h3!x,.next)#0A..21}#0A..16ELSE.{.LET
.l.#3D.nextlab()#0A..23jumpcond(h2!x,.sw,.l)#0A..23
trans(h3!x,.next)#0A..23out2(s_lab,.l)#0A..23trnext
(next)#0A..21}#0A..4RETURN#0A.#0A..2CASE.s_test:#0A
..2{.LET.l,.m.#3D.nextlab(),.0#0A..4context,.comlin
e.:#3D.x,.h5!x#0A..4jumpcond(h2!x,.FALSE,.l)#0A..7#0A
..4TEST.next#3D0.THEN.{.m.:#3D.nextlab();.trans(h3!
x,.m).}#0A..16ELSE.trans(h3!x,.next)#0A..19#0A..4ou
t2(s_lab,.l)#0A..4trans(h4!x,.next)#0A..4UNLESS.m#3D
0.DO.out2(s_lab,.m)#0A..4RETURN#0A..2}#0A.#0A..2CAS
E.s_loop:#0A..4context,.comline.:#3D.x,.h2!x#0A..4I
F.looplab<0.DO.trnerr("Illegal.use.of.LOOP")#0A..4I
F.looplab#3D0.DO.looplab.:#3D.nextlab()#0A..4out2(s
_jump,.looplab)#0A..4RETURN#0A#0A..2CASE.s_break:#0A
..4context,.comline.:#3D.x,.h2!x#0A..4IF.breaklab#3D
-2.DO.trnerr("Illegal.use.of.BREAK")#0A..4IF.breakl
ab#3D-1.DO.{.out1(s_rtrn);.RETURN.}#0A..4IF.breakla
b#3D.0.DO.breaklab.:#3D.nextlab()#0A..4out2(s_jump,
.breaklab)#0A..4RETURN#0A.#0A..2CASE.s_return:#0A..
4context,.comline.:#3D.x,.h2!x#0A..4out1(s_rtrn)#0A
..4RETURN#0A.#0A..2CASE.s_skip:..//.MR.05/4/06#0A..
4trnext(next)#0A..4RETURN#0A#0A..2CASE.s_finish:#0A
..4context,.comline.:#3D.x,.h2!x#0A..4out1(s_finish
)#0A..4RETURN#0A.#0A..2CASE.s_resultis:#0A..4contex
t,.comline.:#3D.x,.h3!x#0A..4IF.resultlab#3D-1.DO.{
.fnbody(h2!x);.RETURN.}#0A..4UNLESS.resultlab>0.DO.
trnerr("RESULTIS.out.of.context")#0A..4load(h2!x)#0A
..4out2(s_res,.resultlab)#0A..4ssp.:#3D.ssp.-.1#0A.
.4RETURN#0A.#0A..2CASE.s_while:.sw.:#3D.TRUE#0A..2C
ASE.s_until:#0A..2{.LET.l,.m.#3D.nextlab(),.next#0A
..4LET.bl,.ll.#3D.breaklab,.looplab#0A..4context,.c
omline.:#3D.x,.h4!x#0A..4breaklab,.looplab.:#3D.nex
t,.0#0A..4IF.next<#3D0.DO.m.:#3D.nextlab()#0A..4IF.
next.#3D0.DO.breaklab.:#3D.m#0A..4jumpcond(h2!x,.~s
w,.m)#0A..4out2(s_lab,.l)#0A..4trans(h3!x,.0)#0A..4
UNLESS.looplab#3D0.DO.out2(s_lab,.looplab)#0A..4con
text,.comline.:#3D.x,.h4!x#0A..4jumpcond(h2!x,.sw,.
l)#0A..4IF.next<#3D0.DO.out2(s_lab,.m)#0A..4trnext(
next)#0A..4breaklab,.looplab.:#3D.bl,.ll#0A..4RETUR
N#0A..2}#0A.#0A..2CASE.s_repeatwhile:.sw.:#3D.TRUE#0A
..2CASE.s_repeatuntil:#0A..2{.LET.l,.bl,.ll.#3D.nex
tlab(),.breaklab,.looplab#0A..4context,.comline.:#3D
.x,.h4!x#0A..4breaklab,.looplab.:#3D.next,.0#0A..4o
ut2(s_lab,.l)#0A..4trans(h2!x,.0)#0A..4UNLESS.loopl
ab#3D0.DO.out2(s_lab,.looplab)#0A..4context,.comlin
e.:#3D.x,.h4!x#0A..4jumpcond(h3!x,.sw,.l)#0A#0A//..
2UNLESS.breaklab#3D0.DO.out2(s_lab,.breaklab)#0A..4
IF.next#3D0.&.breaklab>0.DO.out2(s_lab,.breaklab)#0A
#0A..4trnext(next)#0A..4breaklab,.looplab.:#3D.bl,.
ll#0A..4RETURN#0A..2}#0A.#0A..2CASE.s_repeat:#0A..2
{.LET.bl,.ll.#3D.breaklab,.looplab#0A..4context,.co
mline.:#3D.x,.h4!x#0A..4breaklab,.looplab.:#3D.next
,.nextlab()#0A..4out2(s_lab,.looplab)#0A#0A..4trans
(h2!x,.looplab)#0A#0A..4IF.next#3D0.&.breaklab>0.DO
.out2(s_lab,.breaklab)#0A#0A..4breaklab,.looplab.:#3D
.bl,.ll#0A..4RETURN#0A..2}#0A.#0A..2CASE.s_case:#0A
..2{.LET.l,.k,.cl.#3D.nextlab(),.?,.caselist#0A..4c
ontext,.comline.:#3D.x,.h4!x#0A..4k.:#3D.evalconst(
h2!x)#0A..4IF.casecount<0.DO.trnerr("CASE.label.out
.of.context")#0A..4UNTIL.cl#3D0.DO#0A..4{.IF.h2!cl#3D
k.DO.trnerr("'CASE.%n:'.occurs.twice",.k)#0A..6cl.:
#3D.h1!cl#0A..4}#0A..4caselist.:#3D.newblk(caselist
,.k,.l)#0A..4casecount.:#3D.casecount.+.1#0A..4out2
(s_lab,.l)#0A..4trans(h3!x,.next)#0A..4RETURN#0A..2
}#0A.#0A..2CASE.s_default:#0A..4context,.comline.:#3D
.x,.h3!x#0A..4IF.casecount<0.|.defaultlab~#3D0.DO.t
rnerr("Bad.DEFAULT.label")#0A..4defaultlab.:#3D.nex
tlab()#0A..4out2(s_lab,.defaultlab)#0A..4trans(h2!x
,.next)#0A..4RETURN#0A.#0A..2CASE.s_endcase:#0A..4c
ontext,.comline.:#3D.x,.h2!x#0A..4IF.endcaselab#3D-
2.DO.trnerr("Illegal.use.of.ENDCASE")#0A..4IF.endca
selab#3D-1.DO.out1(s_rtrn)#0A..4//.endcaselab.is.ne
ver.equal.to.0#0A..4IF.endcaselab>0..DO.out2(s_jump
,.endcaselab)#0A..4RETURN#0A.#0A..2CASE.s_switchon:
#0A..4transswitch(x,.next)#0A..4RETURN#0A.#0A..2CAS
E.s_for:#0A..4transfor(x,.next)#0A..4RETURN#0A.#0A.
.2CASE.s_seq:#0A..4trans(h2!x,.0)#0A..4x.:#3D.h3!x#0A
..}#0A}.REPEAT#0A#0ALET.declnames(x).BE.UNLESS.x#3D
0.SWITCHON.h1!x.INTO#0A.#0A{.DEFAULT:..6trnerr("Com
piler.error.in.Declnames")#0A..16RETURN#0A.#0A..CAS
E.s_vecdef:#0A..CASE.s_valdef:.context,.comline.:#3D
.x,.h4!x#0A..15decldyn(h2!x)#0A..15RETURN#0A.#0A..C
ASE.s_rtdef:#0A..CASE.s_fndef:..context,.comline.:#3D
.x,.h6!x#0A..15h5!x.:#3D.nextlab()#0A..15declstat(h
2!x,.h5!x)#0A..15RETURN#0A.#0A..CASE.s_and:..2decln
ames(h2!x)#0A..15declnames(h3!x)#0A}#0A.#0AAND.decl
dyn(x).BE.UNLESS.x#3D0.DO#0A.#0A{.IF.h1!x#3Ds_name.
.DO.{.addname(x,.s_local,.ssp)#0A..21//IF.xrefing.D
O.xref(x,."P:",.ssp,.h1!context)#0A..21ssp.:#3D.ssp
.+.1#0A..21RETURN#0A..19}#0A.#0A..IF.h1!x#3Ds_comma
.DO.{.addname(h2!x,.s_local,.ssp)#0A..21//IF.xrefin
g.DO.xref(h2!x,."P:",.ssp,.h1!context)#0A..21ssp.:#3D
.ssp.+.1#0A..21decldyn(h3!x)#0A..21RETURN#0A..19}#0A
.#0A..trnerr("Compiler.error.in.Decldyn")#0A}#0A.#0A
AND.declstat(x,.lab).BE#0A{.LET.c.#3D.cellwithname(
x)#0A.#0A..TEST.h2!c#3Ds_global.THEN.{.LET.gn.#3D.h
3!c#0A..26gdeflist.:#3D.newblk(gdeflist,.gn,.lab)#0A
..26gdefcount.:#3D.gdefcount.+.1#0A..26addname(x,.s
_global,.gn)#0A..26IF.xrefing.DO.xref(x,."G:",.gn,.
h1!context)#0A..26IF.gdefsing.DO.writef("G%i3.#3D.%
s*n",.gn,.@h3!x)#0A..24}#0A..19ELSE.{.addname(x,.s_
label,.lab)#0A..26IF.xrefing.DO.xref(x,."F:",.lab,.
h1!context)#0A..24}#0A}#0A.#0AAND.decllabels(x).BE#0A
{.LET.e.#3D.dvece#0A..scanlabels(x)#0A..checkdistin
ct(e)#0A}#0A.#0AAND.checkdistinct(p).BE#0A{.LET.lim
.#3D.dvece.-.3#0A..FOR.q.#3D.p.TO.lim-3.BY.3.DO#0A.
.{.LET.n.#3D.h1!q#0A..2FOR.c.#3D.q+3.TO.lim.BY.3.DO
#0A..6IF.h1!c#3Dn.DO.trnerr("Name.%s.defined.twice"
,.@h3!n)#0A..}#0A}#0A.#0AAND.addname(name,.k,.a).BE
#0A{.LET.p.#3D.dvece.+.3#0A..IF.p>dvect.DO.trnerr("
More.workspace.needed")#0A..h1!dvece,.h2!dvece,.h3!
dvece.:#3D.name,.k,.a#0A..h2!name.:#3D.dvece.//.Rem
ember.the.declaration#0A..dvece.:#3D.p#0A}#0A.#0AAN
D.undeclare(e).BE.#0A{.FOR.t.#3D.e.TO.dvece-3.BY.3.
DO#0A..{.LET.name.#3D.h1!t#0A..2h2!name.:#3D.0..1//
.Forget.its.declaration#0A..}#0A..dvece.:#3D.e#0A}#0A
#0AAND.cellwithname(n).#3D.VALOF#0A{.LET.t.#3D.h2!n
#0A..IF.t.RESULTIS.t..//.It.has.been.looked.up.befo
re#0A..t.:#3D.dvece#0A..t.:#3D.t.-.3.REPEATUNTIL.h1
!t#3Dn.|.h1!t#3D0#0A..h2!n.:#3D.t..//.Associate.the
.name.with.declaration.item#0A..RESULTIS.t#0A}#0A.#0A
AND.scanlabels(x).BE.UNLESS.x#3D0.SWITCHON.h1!x.INT
O#0A.#0A{.CASE.s_colon:..1context,.comline.:#3D.x,.
h5!x#0A..16h4!x.:#3D.nextlab()#0A..16declstat(h2!x,
.h4!x)#0A.#0A..CASE.s_if:.CASE.s_unless:.CASE.s_whi
le:.CASE.s_until:#0A..CASE.s_switchon:.CASE.s_case:
#0A..16scanlabels(h3!x)#0A..16RETURN#0A.#0A..CASE.s
_seq:..3scanlabels(h3!x)#0A.#0A..CASE.s_repeat:.CAS
E.s_repeatwhile:.CASE.s_repeatuntil:#0A..CASE.s_def
ault:.scanlabels(h2!x)#0A..16RETURN#0A.#0A..CASE.s_
test:..2scanlabels(h3!x)#0A..16scanlabels(h4!x)#0A.
.DEFAULT:..6RETURN#0A}#0A.#0AAND.transdef(x).BE#0A{
.LET.ctxt,.ln.#3D.context,.comline#0A..transdyndefs
(x)#0A..context,.comline.:#3D.ctxt,.ln#0A..IF.statd
efs(x).DO.{.LET.l,.s#3D.nextlab(),.ssp#0A..20out2(s
_jump,.l)#0A..20transstatdefs(x)#0A..20ssp.:#3D.s#0A
..20out2(s_stack,.ssp)#0A..20out2(s_lab,.l)#0A..18}
#0A..context,.comline.:#3D.ctxt,.ln#0A}#0A.#0A.#0AA
ND.transdyndefs(x).BE.SWITCHON.h1!x.INTO#0A{.CASE.s
_and:..2transdyndefs(h2!x)#0A..15transdyndefs(h3!x)
#0A..15RETURN#0A.#0A..CASE.s_vecdef:.context,.comli
ne.:#3D.x,.h4!x#0A..15out2(s_llp,.vecssp)#0A..15ssp
.:#3D.ssp.+.1#0A..15vecssp.:#3D.vecssp.+.1.+.evalco
nst(h3!x)#0A..15RETURN#0A.#0A..CASE.s_valdef:.conte
xt,.comline.:#3D.h3!x,.h4!x#0A..15loadlist(h3!x)#0A
.#0A..DEFAULT:..5RETURN#0A}#0A.#0AAND.transstatdefs
(x).BE.SWITCHON.h1!x.INTO#0A{.CASE.s_and:..transsta
tdefs(h2!x)#0A..13transstatdefs(h3!x)#0A..13RETURN#0A
.#0A..CASE.s_fndef:#0A..CASE.s_rtdef:#0A..11{.LET.e
,.p.#3D.dvece,.dvecp#0A..13AND.oldpn.#3D.procname#0A
..13AND.bl,.ll.#3D.breaklab,..looplab#0A..13AND.rl,
.el.#3D.resultlab,.endcaselab#0A..13AND.cl,.cc.#3D.
caselist,..casecount#0A..13breaklab,..looplab..2:#3D
.-2,.-2#0A..13resultlab,.endcaselab.:#3D.-2,.-2#0A.
.13caselist,..casecount..:#3D..0000,.-1#0A..13procn
ame.:#3D.h2!x#0A..13context,.comline.:#3D.x,.h6!x#0A
..13out2(s_entry,.h5!x)#0A..13outstring(@h3!procnam
e)#0A..13ssp.:#3D.savespacesize#0A..13dvecp.:#3D.dv
ece#0A..13context,.comline.:#3D.x,.h6!x#0A..13decld
yn(h3!x)#0A..13checkdistinct(e)#0A..13context,.coml
ine.:#3D.h4!x,.h6!x#0A..13decllabels(h4!x)#0A..13ou
t2(s_save,.ssp)#0A..13context,.comline.:#3D.h4!x,.h
6!x#0A..13TEST.h1!x#3Ds_rtdef.THEN.trans(h4!x,.-1)#0A
..31ELSE.fnbody(h4!x)#0A..13out1(s_endproc)#0A.#0A.
.13breaklab,..looplab..2:#3D.bl,.ll#0A..13resultlab
,.endcaselab.:#3D.rl,.el#0A..13caselist,..casecount
..:#3D.cl,.cc#0A..13procname.:#3D.oldpn#0A..13dvecp
.:#3D.p#0A..13undeclare(e)#0A..11}#0A.#0A..DEFAULT:
..3RETURN#0A}#0A.#0AAND.statdefs(x).#3D.h1!x#3Ds_fn
def.|.h1!x#3Ds_rtdef.->.TRUE,#0A..16h1!x.~#3D.s_and
..13->.FALSE,#0A..16statdefs(h2!x)..12->.TRUE,#0A..
16statdefs(h3!x)#0A.#0A.#0ALET.jumpcond(x,.b,.l).BE
#0A{.LET.sw.#3D.b#0A#0A..SWITCHON.h1!x.INTO#0A..{.C
ASE.s_false:..b.:#3D.NOT.b#0A..2CASE.s_true:..1IF.b
.DO.out2(s_jump,.l)#0A..17RETURN#0A.#0A..2CASE.s_no
t:..2jumpcond(h2!x,.NOT.b,.l)#0A..17RETURN#0A.#0A..
2CASE.s_logand:.sw.:#3D.NOT.sw#0A..2CASE.s_logor:..
TEST.sw.THEN.{.jumpcond(h2!x,.b,.l)#0A..32jumpcond(
h3!x,.b,.l)#0A..32RETURN#0A..30}#0A.#0A..25ELSE.{.L
ET.m.#3D.nextlab()#0A..32jumpcond(h2!x,.NOT.b,.m)#0A
..32jumpcond(h3!x,.b,.l)#0A..32out2(s_lab,.m)#0A..3
2RETURN#0A..30}#0A.#0A..2DEFAULT:..5load(x)#0A..17o
ut2(b.->.s_jt,.s_jf,.l)#0A..17ssp.:#3D.ssp.-.1#0A..
17RETURN#0A..}#0A}#0A.#0AAND.transswitch(x,.next).B
E#0A{.LET.cl,.cc.#3D.caselist,.casecount.#0A..LET.d
l,.el.#3D.defaultlab,.endcaselab#0A..LET.l,.dlab.#3D
.nextlab(),.?#0A..caselist,.casecount,.defaultlab.:
#3D.0,.0,.0#0A..endcaselab.:#3D.next#3D0.->.nextlab
(),.next#0A.#0A..context,.comline.:#3D.x,.h4!x#0A#0A
..load(h2!x)..//.Evaluate.the.switch.expression#0A/
/..out2(s_jump,.l)#0A..out2(s_res,.l).//.Make.a.jum
p.to.the.end.of.the.switch#0A..15//.with.the.switch
.expression.in<res>#0A..ssp.:#3D.ssp-1#0A#0A..//.Co
mpile.the.switch.body.collecting.the.case.label.dat
a#0A..trans(h3!x,.endcaselab)#0A.#0A..context,.coml
ine.:#3D.x,.h4!x#0A..out2(s_lab,.l).//.The.switch.v
alue.is.on.the.top.of.the.stack#0A..out2(s_rstack,.
ssp).//.Load.<res>.onto.the.top.of.the.stack#0A..ss
p.:#3D.ssp+1#0A#0A//..load(h2!x)..//.Evaluate.the.s
witch.expression#0A#0A..dlab.:#3D.defaultlab>0.->.d
efaultlab,#0A..8endcaselab>0.->.endcaselab,#0A..8ne
xtlab()#0A#0A..//.The.switch.expression.value.is.on
.the.top.of.the.stack#0A..out2(s_switchon,.casecoun
t);.out1(dlab).#0A..UNTIL.caselist#3D0.DO.{.out2(h2
!caselist,.h3!caselist)#0A..22caselist.:#3D.h1!case
list#0A..20}#0A..ssp.:#3D.ssp.-.1#0A#0A..IF.next#3D
0..14DO..1out2(s_lab,.endcaselab)#0A..IF.next<0.&.d
efaultlab#3D0.DO.{.out2(s_lab,.dlab)#0A..30out1(s_r
trn)#0A..28}#0A#0A..defaultlab,.endcaselab.:#3D.dl,
.el#0A..caselist,..1casecount..:#3D.cl,.cc#0A}#0A.#0A
AND.transfor(x,.next).BE#0A{.LET.e,.m,.blab.#3D.dve
ce,.nextlab(),.0#0A..LET.bl,.ll.#3D.breaklab,.loopl
ab#0A..LET.cc.#3D.casecount#0A..LET.k,.n,.step.#3D.
0,.0,.1#0A..LET.s.#3D.ssp#0A#0A..casecount.:#3D.-1.
.//.Disallow.CASE.and.DEFAULT.labels#2E..1#0A..brea
klab,.looplab.:#3D.next,.0#0A..1#0A..context,.comli
ne.:#3D.x,.h7!x#0A.#0A..addname(h2!x,.s_local,.s)#0A
..load(h3!x)..5//.The.initial.value#0A.#0A..//.Set.
k,.n.to.load.the.end.limit#0A..TEST.h1!(h4!x)#3Ds_n
umber.THEN..2k,.n.:#3D.s_ln,.h2!(h4!x)#0A..24ELSE.{
.k,.n.:#3D.s_lp,.ssp#0A..31load(h4!x)#0A..29}#0A.#0A
..UNLESS.h5!x#3D0.DO.step.:#3D.evalconst(h5!x)#0A.#0A
..out1(s_store)#0A..1#0A..TEST.k#3Ds_ln.&.h1!(h3!x)
#3Ds_number..//.check.for.constant.limits.#0A..THEN
.{.LET.initval.#3D.h2!(h3!x)#0A..7IF.step>#3D0.&.in
itval>n.|.step<0.&.initval<n.DO#0A..7{.TEST.next<0#0A
..9THEN.out1(s_rtrn)#0A..9ELSE.TEST.next>0#0A..14TH
EN.out2(s_jump,.next)#0A..14ELSE.{.blab.:#3D.breakl
ab>0.->.breaklab,.nextlab()#0A..21out2(s_jump,.blab
)#0A..19}#0A..7}#0A..5}#0A..ELSE.{.IF.next<#3D0.DO.
blab.:#3D.nextlab()#0A..7out2(s_lp,.s)#0A..7out2(k,
.n)#0A..7out1(step>#3D0.->.s_gr,.s_ls)#0A..7out2(s_
jt,.next>0.->.next,.blab)#0A..5}#0A#0A..IF.breaklab
#3D0.&.blab>0.DO.breaklab.:#3D.blab#0A..1#0A..conte
xt,.comline.:#3D.x,.h7!x#0A..decllabels(h6!x)#0A..c
ontext,.comline.:#3D.x,.h7!x#0A..out2(s_lab,.m)#0A.
.trans(h6!x,.0)#0A..UNLESS.looplab#3D0.DO.out2(s_la
b,.looplab)#0A..out2(s_lp,.s);.out2(s_ln,.step);.ou
t1(s_add);.out2(s_sp,.s)#0A..out2(s_lp,s);.out2(k,n
);.out1(step>#3D0.->.s_le,.s_ge)#0A..out2(s_jt,.m)#0A
.#0A..IF.next<#3D0.TEST.blab>0.#0A..11THEN..16out2(
s_lab,.blab)#0A..11ELSE.IF.breaklab>0.DO.out2(s_lab
,.breaklab)#0A..trnext(next)#0A..casecount.:#3D.cc#0A
..breaklab,.looplab,.ssp.:#3D.bl,.ll,.s#0A..out2(s_
stack,.ssp)#0A..undeclare(e)#0A}#0A.#0ALET.load(x).
BE#0A{.LET.op.#3D.h1!x#0A#0A..IF.isconst(x).DO#0A..
{.out2(s_ln,.evalconst(x))#0A..2ssp.:#3D.ssp.+.1#0A
..2RETURN#0A..}#0A.#0A..SWITCHON.op.INTO#0A..{.DEFA
ULT:..8trnerr("Compiler.error.in.Load")#0A..20out2(
s_ln,.0)#0A..20ssp.:#3D.ssp.+.1#0A..20RETURN#0A.#0A
..2CASE.s_of:..4{.LET.slct.#3D.evalconst(h2!x).//.I
nserted.11/7/01#0A..20LET.len.#3D.slct>>00024#0A..2
0LET.sh..#3D.slct>>00016.&.255#0A..20LET.offset.#3D
.slct.&.#23xFF2#0A..20load(h3!x)#0A..20IF.offset.DO
.{.out2(s_ln,.offset);.out1(s_add).}#0A..20out1(s_r
v)#0A..20IF.sh.DO.{.out2(s_ln,.sh);.out1(s_rshift).
}#0A..20IF.len>0.&.len+sh<32.DO..2//.Assume.a.32.bi
t.m/c#0A..20{.LET.mask.#3D.(1<<len)-1#0A..22out2(s_
ln,.mask)#0A..22out1(s_logand)#0A..20}#0A..20RETURN
#0A..18}#0A#0A..2CASE.s_byteap:..2op:#3Ds_getbyte#0A
#0A..2CASE.s_fdiv:.CASE.s_fsub:#0A..2CASE.s_div:.CA
SE.s_rem:.CASE.s_sub:#0A..2CASE.s_fls:.CASE.s_fgr:.
CASE.s_fle:.CASE.s_fge:#0A..2CASE.s_ls:.CASE.s_gr:.
CASE.s_le:.CASE.s_ge:#0A..2CASE.s_lshift:.CASE.s_rs
hift:#0A..20load(h2!x);.load(h3!x);.out1(op)#0A..20
ssp.:#3D.ssp.-.1#0A..20RETURN#0A.#0A..2CASE.s_fmul:
.CASE.s_fadd:.CASE.s_feq:.CASE.s_fne:#0A..2CASE.s_v
ecap:.CASE.s_mul:.CASE.s_add:.CASE.s_eq:.CASE.s_ne:
#0A..2CASE.s_logand:.CASE.s_logor:.CASE.s_eqv:.CASE
.s_neqv:#0A..7{.LET.a,.b.#3D.h2!x,.h3!x#0A..9TEST.h
1!a#3Ds_name.|#0A..14h1!a#3Ds_number.THEN.{.load(b)
;.load(a).}#0A..28ELSE.{.load(a);.load(b).}#0A..9TE
ST.op#3Ds_vecap.THEN.out2(s_add,.s_rv)#0A..25ELSE.o
ut1(op)#0A..9ssp.:#3D.ssp.-.1#0A..9RETURN#0A..7}#0A
.#0A..2CASE.s_float:CASE.s_fix:CASE.s_fneg:#0A..2CA
SE.s_neg:.CASE.s_not:.CASE.s_rv:.CASE.s_abs:.CASE.s
_fabs:#0A..4load(h2!x)#0A..4out1(op)#0A..4RETURN#0A
.#0A..2CASE.s_true:.CASE.s_false:.CASE.s_query:#0A.
.20out1(op)#0A..20ssp.:#3D.ssp.+.1#0A..20RETURN#0A.
#0A..2CASE.s_lv:..6loadlv(h2!x);.RETURN#0A.#0A..2CA
SE.s_number:..2out2(s_ln,.h2!x);.ssp.:#3D.ssp.+.1;.
RETURN#0A.#0A..2CASE.s_string:..2out1(s_lstr)#0A..2
0outstring(@.h2!x)#0A..20ssp.:#3D.ssp.+.1#0A..20RET
URN#0A.#0A..2CASE.s_name:..4transname(x,.s_lp,.s_lg
,.s_ll,.s_lf,.s_ln)#0A..20ssp.:#3D.ssp.+.1#0A..20RE
TURN#0A.#0A..2CASE.s_valof:..1{.LET.e,.rl,.cc.#3D.d
vece,.resultlab,.casecount#0A..20casecount.:#3D.-1.
//.Disallow.CASE.&.DEFAULT.labels#0A..20resultlab.:
#3D.nextlab()#0A..20decllabels(h2!x)#0A..20trans(h2
!x,.0)#0A..20out2(s_lab,.resultlab)#0A..20out2(s_rs
tack,.ssp)#0A..20ssp.:#3D.ssp.+.1#0A..20resultlab,.
casecount.:#3D.rl,.cc#0A..20undeclare(e)#0A..20RETU
RN#0A..18}#0A.#0A..2CASE.s_fnap:..2{.LET.s.#3D.ssp#0A
..20ssp.:#3D.ssp.+.savespacesize#0A..20out2(s_stack
,.ssp)#0A..20loadlist(h3!x)#0A..20load(h2!x)#0A..20
out2(s_fnap,.s)#0A..20ssp.:#3D.s.+.1#0A..20RETURN#0A
..18}#0A.#0A..2CASE.s_cond:..2{.LET.l,.m.#3D.nextla
b(),.nextlab()#0A..20LET.s.#3D.ssp#0A..20jumpcond(h
2!x,.FALSE,.m)#0A..20load(h3!x)#0A..20out2(s_res,l)
#0A..20ssp.:#3D.s;.out2(s_stack,.ssp)#0A..20out2(s_
lab,.m)#0A..20load(h4!x)#0A..20out2(s_res,l)#0A..20
out2(s_lab,.l)#0A..20out2(s_rstack,s)#0A..20RETURN#0A
..18}#0A.#0A..2CASE.s_table:..1{.LET.m.#3D.nextlab(
)#0A..20out2(s_datalab,.m)#0A..20x.:#3D.h2!x#0A..20
WHILE.h1!x#3Ds_comma.DO#0A..20{.out2(s_itemn,.evalc
onst(h2!x))#0A..22x.:#3D.h3!x#0A..20}#0A..20out2(s_
itemn,.evalconst(x))#0A..20out2(s_ll1,.m)#0A..20ssp
.:#3D.ssp.+.1#0A..20RETURN#0A..18}#0A..}#0A}#0A#0AA
ND.fnbody(x).BE.SWITCHON.h1!x.INTO#0A{.DEFAULT:..7l
oad(x)#0A..17out1(s_fnrn)#0A..17ssp.:#3D.ssp.-.1#0A
..17RETURN#0A..17#0A..CASE.s_valof:.{.LET.e,.rl,.cc
.#3D.dvece,.resultlab,.casecount#0A..16casecount.:#3D
.-1.//.Disallow.CASE.&.DEFAULT.labels#0A..16resultl
ab.:#3D.-1#0A..16decllabels(h2!x)#0A..16trans(h2!x,
.-1)#0A..16resultlab,.casecount.:#3D.rl,.cc#0A..16u
ndeclare(e)#0A..16RETURN#0A..14}#0A#0A..CASE.s_cond
:..{.LET.l.#3D.nextlab()#0A..16jumpcond(h2!x,.FALSE
,.l)#0A..16fnbody(h3!x)#0A..16out2(s_lab,.l)#0A..16
fnbody(h4!x)#0A..14}#0A}#0A.#0A.#0AAND.loadlv(x).BE
#0A{.UNLESS.x#3D0.SWITCHON.h1!x.INTO#0A..{.DEFAULT:
..7ENDCASE#0A.#0A..2CASE.s_name:..3transname(x,.s_l
lp,.s_llg,.s_ll1,.0,.0)#0A..19ssp.:#3D.ssp.+.1#0A..
19RETURN#0A.#0A..2CASE.s_rv:..5load(h2!x)#0A..19RET
URN#0A.#0A..2CASE.s_vecap:.{.LET.a,.b.#3D.h2!x,.h3!
x#0A..18IF.h1!a#3Ds_name.DO.a,.b.:#3D.h3!x,.h2!x#0A
..18load(a)#0A..18load(b)#0A..18out1(s_add)#0A..18s
sp.:#3D.ssp.-.1#0A..18RETURN#0A..16}#0A..}#0A#0A..t
rnerr("Ltype.expression.needed")#0A..out2(s_ln,.0)#0A
..ssp.:#3D.ssp.+.1#0A}#0A.#0AAND.loadlist(x).BE.UNL
ESS.x#3D0.TEST.h1!x#3Ds_comma#0A..28THEN.{.loadlist
(h2!x);.loadlist(h3!x).}#0A..28ELSE.load(x)#0A#0ALE
T.isconst(x).#3D.VALOF#0A{.IF.x#3D0.RESULTIS.FALSE#0A
.#0A..SWITCHON.h1!x.INTO#0A..{.CASE.s_name:#0A..6{.
LET.c.#3D.cellwithname(x)#0A..8RESULTIS.h2!c#3Ds_ma
nifest#0A..6}#0A#0A..2CASE.s_number:#0A..2CASE.s_sl
ct:#0A..2CASE.s_true:#0A..2CASE.s_false:..RESULTIS.
TRUE#0A.#0A..2CASE.s_fneg:#0A..2CASE.s_fabs:#0A..2C
ASE.s_float:#0A..2CASE.s_fix:#0A..2CASE.s_neg:#0A..
2CASE.s_abs:#0A..2CASE.s_not:..2RESULTIS.isconst(h2
!x)#0A..5#0A..2CASE.s_fmul:#0A..2CASE.s_fdiv:#0A..2
CASE.s_fadd:#0A..2CASE.s_fsub:#0A..2CASE.s_feq:#0A.
.2CASE.s_fne:#0A..2CASE.s_fls:#0A..2CASE.s_fgr:#0A.
.2CASE.s_fle:#0A..2CASE.s_fge:#0A#0A..2CASE.s_mul:#0A
..2CASE.s_div:#0A..2CASE.s_rem:#0A..2CASE.s_add:#0A
..2CASE.s_sub:#0A..2CASE.s_lshift:#0A..2CASE.s_rshi
ft:#0A..2CASE.s_logor:#0A..2CASE.s_logand:#0A..2CAS
E.s_eqv:#0A..2CASE.s_neqv:#0A..2CASE.s_eq:#0A..2CAS
E.s_ne:#0A..2CASE.s_ls:#0A..2CASE.s_gr:#0A..2CASE.s
_le:#0A..2CASE.s_ge:#0A..17IF.isconst(h2!x).&.iscon
st(h3!x).RESULTIS.TRUE#0A#0A..2CASE.s_cond:..1IF.is
const(h2!x).&#0A..20isconst(h3!x).&#0A..20isconst(h
4!x).RESULTIS.TRUE#0A#0A..2DEFAULT:..5RESULTIS.FALS
E#0A#0A..1}#0A}#0A#0ALET.evalconst(x).#3D.VALOF#0A{
.LET.a,.b.#3D.0,.0#0A#0A..IF.x#3D0.DO.{.trnerr("Com
piler.error.in.Evalconst")#0A..12RESULTIS.0#0A..10}
#0A.#0A..SWITCHON.h1!x.INTO#0A..{.CASE.s_name:.{.LE
T.c.#3D.cellwithname(x)#0A..17LET.k,.a.#3D.h2!c,.h3
!c#0A..17IF.k#3Ds_manifest.DO#0A..17{.IF.xrefing.DO
.xref(x,."M:",.a,.s_const)#0A..19RESULTIS.a#0A..17}
#0A..17IF.k.DO.trnerr("%s.must.be.a.manifest.consta
nt",.@h3!x)#0A..17trnerr("Name.'%s'.not.declared",.
@h3!x)#0A..17RESULTIS.0#0A..15}#0A.#0A..2CASE.s_num
ber:.RESULTIS.h2!x#0A..2CASE.s_true:..1RESULTIS.TRU
E#0A..2CASE.s_false:..RESULTIS.FALSE#0A..2CASE.s_qu
ery:..RESULTIS.0#0A.#0A..2CASE.s_slct:.{.LET.len,.s
h,.offset.#3D.0,.0,.0..3//.Inserted.11/7/01#0A..17I
F.h2!x.DO.len..2:#3D.evalconst(h2!x)#0A..17IF.h3!x.
DO.sh..3:#3D.evalconst(h3!x)#0A..17IF.h4!x.DO.offse
t.:#3D.evalconst(h4!x)#0A..17UNLESS.0<#3Dlen<#3D255
.&.0<#3Dsh<#3D255.&.0<#3Doffset<#3D#23xFF2.DO#0A..2
1trnerr("A.field.too.large.in.a.SLCT.expression")#0A
..17RESULTIS.len<<00024.|.sh<<00016.|.offset#0A..15
}#0A#0A..2CASE.s_fneg:#0A..2CASE.s_fabs:#0A..2CASE.
s_fix:#0A..2CASE.s_float:..floatingchk()#0A..2CASE.
s_neg:#0A..2CASE.s_abs:#0A..2CASE.s_not:..2a.:#3D.e
valconst(h2!x)#0A..17ENDCASE#0A..5#0A..2CASE.s_fmul
:#0A..2CASE.s_fdiv:#0A..2CASE.s_fadd:#0A..2CASE.s_f
sub:#0A..2CASE.s_feq:#0A..2CASE.s_fne:#0A..2CASE.s_
fls:#0A..2CASE.s_fgr:#0A..2CASE.s_fle:#0A..2CASE.s_
fge:..floatingchk()#0A#0A..2CASE.s_mul:#0A..2CASE.s
_div:#0A..2CASE.s_rem:#0A..2CASE.s_add:#0A..2CASE.s
_sub:#0A..2CASE.s_lshift:#0A..2CASE.s_rshift:#0A..2
CASE.s_logor:#0A..2CASE.s_logand:#0A..2CASE.s_eqv:#0A
..2CASE.s_neqv:#0A..2CASE.s_eq:#0A..2CASE.s_ne:#0A.
.2CASE.s_ls:#0A..2CASE.s_gr:#0A..2CASE.s_le:#0A..2C
ASE.s_ge:#0A#0A..2CASE.s_cond:#0A..17a,.b.:#3D.eval
const(h2!x),.evalconst(h3!x)#0A..17ENDCASE#0A#0A..2
DEFAULT:#0A..}#0A..2#0A..SWITCHON.h1!x.INTO#0A..{.C
ASE.s_neg:..2RESULTIS..-..a#0A..2CASE.s_abs:..2RESU
LTIS.ABS.a#0A..2CASE.s_not:..2RESULTIS.NOT.a#0A..5#0A
..2CASE.s_fneg:..1RESULTIS.sys(Sys_flt,.fl_neg,.a)#0A
..2CASE.s_fabs:..1RESULTIS.sys(Sys_flt,.fl_abs,.a)#0A
..2CASE.s_fix:..2RESULTIS.sys(Sys_flt,.fl_fix,.a)#0A
..2CASE.s_float:..RESULTIS.sys(Sys_flt,.fl_float,.a
)#0A..5#0A..2CASE.s_fmul:..1RESULTIS.sys(Sys_flt,.f
l_mul,.a,..b)#0A..2CASE.s_fdiv:..1RESULTIS.sys(Sys_
flt,.fl_div,.a,..b)#0A..2CASE.s_fadd:..1RESULTIS.sy
s(Sys_flt,.fl_add,.a,..b)#0A..2CASE.s_fsub:..1RESUL
TIS.sys(Sys_flt,.fl_sub,.a,..b)#0A#0A..2CASE.s_feq:
..2RESULTIS.sys(Sys_flt,.fl_eq,.a,..b)#0A..2CASE.s_
fne:..2RESULTIS.sys(Sys_flt,.fl_ne,.a,..b)#0A..2CAS
E.s_fls:..2RESULTIS.sys(Sys_flt,.fl_ls,.a,..b)#0A..
2CASE.s_fgr:..2RESULTIS.sys(Sys_flt,.fl_gr,.a,..b)#0A
..2CASE.s_fle:..2RESULTIS.sys(Sys_flt,.fl_le,.a,..b
)#0A..2CASE.s_fge:..2RESULTIS.sys(Sys_flt,.fl_ge,.a
,..b)#0A#0A..2CASE.s_mul:..2RESULTIS.a..1*..2b#0A..
2CASE.s_add:..2RESULTIS.a..1+..2b#0A..2CASE.s_sub:.
.2RESULTIS.a..1-..2b#0A..2CASE.s_lshift:.RESULTIS.a
..1<<..1b#0A..2CASE.s_rshift:.RESULTIS.a..1>>..1b#0A
..2CASE.s_logor:..RESULTIS.a..1|..2b#0A..2CASE.s_lo
gand:.RESULTIS.a..1&..2b#0A..2CASE.s_eqv:..2RESULTI
S.a..EQV..1b#0A..2CASE.s_neqv:..1RESULTIS.a..NEQV..
b#0A..2CASE.s_div:..2UNLESS.b#3D0.RESULTIS.a..1/..2
b#0A..2CASE.s_rem:..2UNLESS.b#3D0.RESULTIS.a..REM..
1b#0A..2CASE.s_eq:..3RESULTIS.a.#3D.b#0A..2CASE.s_n
e:..3RESULTIS.a.~#3D.b#0A..2CASE.s_ls:..3RESULTIS.a
.<.b#0A..2CASE.s_gr:..3RESULTIS.a.>.b#0A..2CASE.s_l
e:..3RESULTIS.a.<#3D.b#0A..2CASE.s_ge:..3RESULTIS.a
.>#3D.b#0A#0A..2CASE.s_cond:..1RESULTIS.a.->.b,.eva
lconst(h4!x)#0A..1#0A..2DEFAULT:..5ENDCASE#0A..}#0A
#0A..trnerr("Error.in.manifest.expression,.op.#3D.%
s",.opname(h1!x))#0A..RESULTIS.0#0A}#0A#0AAND.assig
n(x,.y).BE#0A{.IF.x#3D0.|.y#3D0.DO.{.trnerr("Compil
er.error.in.assign")#0A..18RETURN#0A..16}#0A#0A..UN
LESS.(h1!x#3Ds_comma)#3D(h1!y#3Ds_comma).DO#0A..16{
.trnerr("Bad.simultaneous.assignment")#0A..18RETURN
#0A..16}#0A.#0A..SWITCHON.h1!x.INTO#0A..{.CASE.s_co
mma:..assign(h2!x,.h2!y)#0A..17assign(h3!x,.h3!y)#0A
..17RETURN#0A.#0A..2CASE.s_name:..1load(y)#0A..17tr
ansname(x,.s_sp,.s_sg,.s_sl,.0,.0)#0A..17ssp.:#3D.s
sp.-.1#0A..17RETURN#0A.#0A..2CASE.s_byteap:.load(y)
#0A..17load(h2!x)#0A..17load(h3!x)#0A..17out1(s_put
byte)#0A..17ssp:#3Dssp-3#0A..17RETURN#0A.#0A..2CASE
.s_rv:#0A..2CASE.s_vecap:..load(y)#0A..17loadlv(x)#0A
..17out1(s_stind)#0A..17ssp.:#3D.ssp.-.2#0A..17RETU
RN#0A.#0A..2CASE.s_of:..1{.LET.slct.#3D.evalconst(h
2!x).//.Inserted.11/7/01#0A..17LET.len.#3D.slct>>00
024#0A..17LET.sh..#3D.slct>>00016.&.255#0A..17LET.o
ffset.#3D.slct.&.#23xFF2#0A..17LET.mask.#3D.-1#0A..
17IF.len>0.DO.mask.:#3D.(1<<len)-1#0A..17mask.:#3D.
mask<<sh#0A//writef("Compiling.(SLCT.%n:%n:%n).OF.x
.:#3D.y*n",.len,.sh,.offset)#0A//writef("Load.y*n")
#0A..17load(y)#0A..17IF.sh.DO#0A..17{.out2(s_ln,.sh
)#0A..19out1(s_lshift)#0A//writef("lshift.by.%n*n",
.sh)#0A..17}#0A#0A..17UNLESS.mask#3D-1.DO#0A..17{.l
oad(h3!x)#0A..19IF.offset.DO#0A..19{.out2(s_ln,.off
set)#0A..21out1(s_add)#0A..19}#0A..19out1(s_rv)#0A.
.19out1(s_neqv)#0A..19ssp.:#3D.ssp-1#0A//writef("xo
r.x!%n*n",.offset)#0A..19out2(s_ln,.mask)#0A..19out
1(s_logand).//.bits.to.change.in.x#0A//writef("mask
.with.%bW*n",.mask)#0A#0A..19load(h3!x)#0A..19IF.of
fset.DO#0A..19{.out2(s_ln,.offset)#0A..21out1(s_add
)#0A..19}#0A..19out1(s_rv)#0A..19out1(s_neqv)#0A//w
ritef("xor.with.x!%n*n",.offset)#0A..19ssp.:#3D.ssp
-1#0A..17}#0A#0A..17load(h3!x)#0A..17IF.offset.DO#0A
..17{.out2(s_ln,.offset)#0A..19out1(s_add)#0A..17}#0A
..17out1(s_stind)#0A//writef("store.in.x!%n*n",.off
set)#0A..17ssp.:#3D.ssp-2#0A//writef("stind*n")#0A.
.17RETURN#0A..15}#0A#0A..2DEFAULT:..5trnerr("Ltype.
expression.needed")#0A..}#0A}#0A.#0A.#0AAND.transna
me(x,.p,.g,.l,.f,.n).BE#0A{.LET.c.#3D.cellwithname(
x)#0A..LET.k,.a.#3D.h2!c,.h3!c#0A.#0A..SWITCHON.k.I
NTO#0A..{.DEFAULT:..6trnerr("Name.'%s'.not.declared
",.@h3!x)#0A..1#0A..2CASE.s_global:..out2(g,.a)#0A.
.18IF.xrefing.DO.xref(x,."G:",.a,.g)#0A..18RETURN#0A
.#0A..2CASE.s_local:..1IF.c<dvecp.DO#0A..23trnerr("
Dynamic.free.variable.'%s'.used",.@h3!x)#0A..18out2
(p,.a)#0A..18//IF.xrefing.DO.xref(x,."P:",.a,.p)#0A
..18RETURN#0A.#0A..2CASE.s_static:..out2(l,.a)#0A..
18IF.xrefing.DO.xref(x,."S:",.a,.l)#0A..18RETURN#0A
.#0A..2CASE.s_label:..1IF.f#3D0.DO#0A..18{.trnerr("
Misuse.of.entry.name.'%s'",.@h3!x)#0A..20f.:#3D.p#0A
..18}#0A..18out2(f,.a)#0A..18IF.xrefing.DO.xref(x,.
"F:",.a,.f)#0A..18RETURN#0A#0A..2CASE.s_manifest:IF
.n#3D0.DO#0A..18{.trnerr("Misuse.of.MANIFEST.name.'
%s'",.@h3!x)#0A..20n.:#3D.p#0A..18}#0A..18out2(n,.a
)#0A..18IF.xrefing.DO.xref(x,."M:",.a,.n)#0A..}#0A}
#0A#0AAND.xref(x,.kstr,.n,.op).BE#0A{.LET.name.#3D.
@h3!x#0A..LET.fno.#3D.comline>>00020#0A..LET.lno.#3D
.comline.&.#23xFF3#0A..LET.file.#3D.sourcenamev!fno
#0A..writef("%s.%s",.name,.kstr)#0A..TEST.-10_001_0
01.<#3D.n.<#3D.10_001_001#0A..THEN.writef("%n.",.n)
#0A..ELSE.writef("#23x%8x.",.n)#0A#0A..SWITCHON.op.
INTO#0A..{.DEFAULT:..7writef("op%n",.op);.ENDCASE#0A
#0A..2CASE.s_fndef:..2writef("FN");..5ENDCASE#0A..2
CASE.s_rtdef:..2writef("RT");..5ENDCASE#0A..2CASE.s
_valdef:..1writef("VAL");..4ENDCASE#0A..2CASE.s_vec
def:..1writef("VEC");..4ENDCASE#0A..2CASE.s_constde
f:.writef("DEF");..4ENDCASE#0A..2CASE.s_const:..2wr
itef("MAN");..4ENDCASE#0A..2CASE.s_colon:..2writef(
"LAB");..4ENDCASE#0A..2CASE.s_sp:..5writef("SP");..
5ENDCASE#0A..2CASE.s_sg:..5writef("SG");..5ENDCASE#0A
..2CASE.s_sl:..5writef("SL");..5ENDCASE#0A..2CASE.s
_llp:..4writef("LLP");..4ENDCASE#0A..2CASE.s_llg:..
4writef("LLG");..4ENDCASE#0A..2CASE.s_ll1:..4writef
("LL1");..4ENDCASE#0A..2CASE.s_lp:..5writef("LP");.
.5ENDCASE#0A..2CASE.s_lg:..5writef("LG");..5ENDCASE
#0A..2CASE.s_ll:..5writef("LL");..5ENDCASE#0A..2CAS
E.s_lf:..5writef("LF");..5ENDCASE#0A..2CASE.s_ln:..
5writef("LN");..5ENDCASE#0A..}#0A..wrch('.')#0A..IF
.file.DO.writef("%s",.file)#0A..writef("[%n].",.lno
)#0A#0A..prctxt(context)#0A#0A..newline()#0A}#0A#0A
AND.prctxt(x).BE.IF.x.DO.#0A{.LET.op.#3D.h1!x#0A..S
WITCHON.op.INTO#0A..{.DEFAULT:..prctxte(x,.4,.0);.R
ETURN#0A#0A..2CASE.s_fndef:#0A..7writef("LET.")#0A.
.7prctxte(h2!x,.5,.0)#0A..7wrch('(')#0A..7prctxte(h
3!x,.7,.0)#0A..7writef(")#3D#2E#2E")#0A..7RETURN#0A
#0A..2CASE.s_rtdef:#0A..7writef("LET.")#0A..7prctxt
e(h2!x,.5,.0)#0A..7wrch('(')#0A..7prctxte(h3!x,.7,.
0)#0A..7writef(")BE#2E#2E")#0A..7RETURN#0A#0A..2CAS
E.s_valdef:#0A..7writef("LET.")#0A..7prctxte(h2!x,.
5,.0)#0A..7writef("#3D")#0A..7prctxte(h3!x,.5,.0)#0A
..7RETURN#0A#0A..2CASE.s_vecdef:#0A..7writef("LET."
)#0A..7prctxte(h2!x,.5,.0)#0A..7writef("#3DVEC.")#0A
..7prctxte(h3!x,.5,.0)#0A..7RETURN#0A#0A..2CASE.s_c
onstdef:#0A..7prctxte(h3!x,.5,.0)#0A..7writef("#3D"
)#0A..7prctxte(h4!x,.5,.0)#0A..7RETURN#0A#0A..2CASE
.s_let:#0A..7writef("LET.")#0A..7prctxtd(h2!x,.2)#0A
..7writef(";.")#0A..7prctxtc(h3!x,.2)#0A..7RETURN#0A
.#0A..2CASE.s_static:..2writef("STATIC#2E#2E");..2R
ETURN#0A..2CASE.s_global:..2writef("GLOBAL#2E#2E");
..2RETURN#0A..2CASE.s_manifest:..writef("MANIFEST#2E
#2E");..RETURN#0A#0A..2CASE.s_ass:#0A..7prctxte(h2!
x,.4,.0)#0A..7writef(":#3D")#0A..7prctxte(h3!x,.4,.
0)#0A..7RETURN#0A.#0A..2CASE.s_rtap:#0A..7prctxte(h
2!x,.2,.12)#0A..7writef("(")#0A..7prctxte(h3!x,.3,.
0)#0A..7writef(")")#0A..7RETURN#0A.#0A..2CASE.s_got
o:#0A..7writef("GOTO.")#0A..7prctxte(h2!x,.4,.0)#0A
..7RETURN#0A.#0A..2CASE.s_colon:#0A..7prctxte(h2!x,
.2,.0)#0A..7writef(":")#0A..7prctxt(h3!x,.3)#0A..7R
ETURN#0A.#0A..2CASE.s_unless:#0A..2CASE.s_if:#0A..2
CASE.s_while:#0A..2CASE.s_until:#0A..7writef(op#3Ds
_unless->"UNLESS.",#0A..14op#3Ds_if->"IF.",#0A..14o
p#3Ds_until->"UNTIL.",#0A..14"WHILE."#0A..13)#0A..7
prctxte(h2!x,.4,.0)#0A..7writef(".DO.")#0A..7prctxt
c(h3!x,.3)#0A..7RETURN#0A#0A.#0A..2CASE.s_test:#0A.
.7writef("TEST.")#0A..7prctxte(h2!x,.4,.0)#0A..7wri
tef(".THEN.")#0A..7prctxtc(h3!x,.2)#0A..7writef(".E
LSE.")#0A..7prctxtc(h4!x,.2)#0A..7RETURN#0A.#0A..2C
ASE.s_loop:#0A..7writef("LOOP")#0A..7RETURN#0A.#0A.
.2CASE.s_skip:#0A..7writef("{}")#0A..7RETURN#0A.#0A
..2CASE.s_break:#0A..7writef("BREAK")#0A..7RETURN#0A
.#0A..2CASE.s_return:#0A..7writef("RETURN")#0A..7RE
TURN#0A.#0A..2CASE.s_finish:#0A..7writef("FINISH")#0A
..7RETURN#0A.#0A..2CASE.s_resultis:#0A..7writef("RE
SULTIS.")#0A..7prctxte(h2!x,.4,.0)#0A..7RETURN#0A.#0A
..2CASE.s_repeatwhile:#0A..2CASE.s_repeatuntil:#0A.
.7prctxtc(h2!x,.4)#0A..7writef(op#3Ds_repeatwhile.-
>.".REPEATWHILE.",.".REPEATUNTIL.")#0A..7prctxte(h3
!x,.4,.0)#0A..7RETURN#0A.#0A..2CASE.s_repeat:#0A..7
prctxtc(h2!x,.4)#0A..7writef(".REPEAT")#0A..7RETURN
#0A.#0A..2CASE.s_case:#0A..7writef("CASE.")#0A..7pr
ctxte(h2!x,.4,.0)#0A..7writef(":#2E#2E.")#0A..7RETU
RN#0A.#0A..2CASE.s_default:#0A..7writef("DEFAULT:#2E
#2E")#0A..7RETURN#0A.#0A..2CASE.s_endcase:#0A..7wri
tef("ENDCASE")#0A..7RETURN#0A.#0A..2CASE.s_switchon
:#0A..7writef("SWITCHON.")#0A..7prctxte(h2!x,.4,.0)
#0A..7writef(".INTO#2E#2E")#0A..7RETURN#0A.#0A..2CA
SE.s_for:#0A..7writef("FOR.")#0A..7prctxte(h2!x,.4,
.0)#0A..7writef("#3D")#0A..7prctxte(h3!x,.4,.0)#0A.
.7writef(".TO.")#0A..7prctxte(h4!x,.4,.0)#0A..7IF.h
5!x.DO.{.writef(".BY.");.prctxte(h5!x,.4,.0).}#0A..
7writef(".DO#2E#2E")#0A..7RETURN#0A.#0A..2CASE.s_se
q:#0A..7prctxtc(h2!x,.4)#0A..7writef(";")#0A..7prct
xtc(h3!x,.4)#0A..7RETURN#0A..}#0A}#0A#0AAND.prctxtd
(x,.d).BE.writef("#2E#2E")#0AAND.prctxtc(x,.d).BE.w
ritef("#2E#2E")#0A#0AAND.prctxte(x,.d,.prec).BE.IF.
x.DO#0A{.LET.op.#3D.h1!x#0A#0A..SWITCHON.op.INTO#0A
..{.DEFAULT:.ENDCASE#0A#0A..2CASE.s_number:.#0A..15
{.LET.n.#3D.h2!x#0A..17TEST.-1_001_001<#3Dn<#3D1_00
1_001#0A..17THEN.writef("%n",.n)#0A..17ELSE.writef(
"#23x%x8",.n)#0A..17RETURN#0A..15}.#0A..2CASE.s_nam
e:..1writef("%s",.@h3!x);..6RETURN#0A..2CASE.s_true
:..1writef("TRUE");..11RETURN#0A..2CASE.s_false:..w
ritef("FALSE");..10RETURN#0A..2CASE.s_query:..wrch(
'?');..16RETURN#0A#0A..2CASE.s_string:.#0A..15{.LET
.s.#3D.@h2!x#0A..17LET.len.#3D.s%0#0A..17wrch('"')#0A
..17FOR.i.#3D.1.TO.len.DO#0A..17{.LET.ch.#3D.s%i#0A
..19IF.i#3D6.&.len>6+8.DO.{.writef("'");.LOOP.}#0A.
.19IF.i<#3D6.|.i>len-8.DO.//.First.5.and.last.8.cha
rs#0A..19{.SWITCHON.ch.INTO#0A..21{.CASE.'**':.writ
ef("**2");.LOOP#0A..23CASE.'*"':.writef("**1"");.LO
OP#0A..23CASE.'*n':.writef("**n");..LOOP#0A..21}#0A
..21UNLESS.32<#3Dch<#3D127.DO.ch.:#3D.'?'#0A..21wrc
h(ch)#0A..19}#0A..17}#0A..17wrch('"')#0A..17RETURN#0A
..15}#0A#0A..}#0A#0A..IF.d#3D0.DO.{.writef("#2E#2E1
");.RETURN.}#0A#0A..IF.prec>#3D12.DO.{.wrch('(');.p
rctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHO
N.op.INTO#0A..{.DEFAULT:.ENDCASE#0A#0A..2CASE.s_fna
p:#0A..7prctxte(h2!x,.d-1,.11)#0A..7wrch('(')#0A..7
prctxte(h3!x,.d-1,.0)#0A..7wrch(')')#0A..7RETURN#0A
..}#0A#0A..IF.prec>#3D11.DO.{.wrch('(');.prctxte(x,
.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.op.INTO
#0A..{.DEFAULT:.ENDCASE#0A#0A..2CASE.s_slct:#0A..4{
..writes("SLCT.")#0A..7prctxte(h2!x,.d-1,.10)#0A..7
writes(":")#0A..7prctxte(h3!x,.d-1,.10)#0A..7writes
(":")#0A..7prctxte(h4!x,.d-1,.10)#0A..7RETURN#0A..4
}#0A#0A..2CASE.s_of:#0A..2CASE.s_byteap:#0A..2CASE.
s_vecap:#0A..7prctxte(h2!x,.d-1,.10)#0A..7writes(op
#3Ds_of->"::",.op#3Ds_byteap->"%",."!")#0A..7prctxt
e(h3!x,.d-1,.10)#0A..7RETURN#0A#0A..2CASE.s_rv:#0A.
.2CASE.s_lv:#0A..7writef(op#3Ds_rv->"!","@")#0A..7p
rctxte(h2!x,.d-1,.10)#0A..7RETURN#0A..}#0A#0A..IF.p
rec>#3D10.DO.{.wrch('(');.prctxte(x,.d,.0);.wrch(')
');.RETURN.}#0A#0A..SWITCHON.op.INTO#0A..{.DEFAULT:
.ENDCASE#0A..2CASE.s_mul:.CASE.s_div:.CASE.s_rem:#0A
..7prctxte(h2!x,.d-1,.9)#0A..7writef(op#3Ds_mul->"*
*",.op#3Ds_div->"/",.".MOD.")#0A..7prctxte(h3!x,.d-
1,.9)#0A..7RETURN#0A#0A..2CASE.s_fmul:.CASE.s_fdiv:
#0A..7prctxte(h2!x,.d-1,.9)#0A..7writef(op#3Ds_mul-
>"#23**",."#23/")#0A..7prctxte(h3!x,.d-1,.9)#0A..7R
ETURN#0A..}#0A#0A..IF.prec>#3D9.DO.{.wrch('(');.prc
txte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.
op.INTO#0A..{.DEFAULT:.ENDCASE#0A..2CASE.s_add:#0A.
.2CASE.s_sub:#0A..7prctxte(h2!x,.d-1,.8)#0A..7write
f(op#3Ds_add->"+","-")#0A..7prctxte(h3!x,.d-1,.8)#0A
..7RETURN#0A#0A..2CASE.s_fadd:#0A..2CASE.s_fsub:#0A
..7prctxte(h2!x,.d-1,.8)#0A..7writef(op#3Ds_fadd->"
#23+","#23-")#0A..7prctxte(h3!x,.d-1,.8)#0A..7RETUR
N#0A#0A..2CASE.s_fneg:#0A..2CASE.s_fabs:#0A..7write
f(op#3Ds_fneg->"#23-","#23ABS.")#0A..7prctxte(h2!x,
.d-1,.8)#0A..7RETURN#0A..}#0A#0A..IF.prec>#3D8.DO.{
.wrch('(');.prctxte(x,.d,.0);.wrch(')');.RETURN.}#0A
#0A..SWITCHON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A..2C
ASE.s_eq:.CASE.s_ne:#0A..7prctxte(h2!x,.d-1,.7)#0A.
.7writef(op#3Ds_eq->"#3D","~#3D")#0A..7prctxte(h3!x
,.d-1,.7)#0A..7RETURN#0A#0A..2CASE.s_feq:.CASE.s_fn
e:#0A..7prctxte(h2!x,.d-1,.7)#0A..7writef(op#3Ds_fe
q->"#23#3D","#23~#3D")#0A..7prctxte(h3!x,.d-1,.7)#0A
..7RETURN#0A#0A..2CASE.s_ls:.CASE.s_gr:#0A..7prctxt
e(h2!x,.d-1,.7)#0A..7writef(op#3Ds_ls->"<",">")#0A.
.7prctxte(h3!x,.d-1,.7)#0A..7RETURN#0A#0A..2CASE.s_
fls:.CASE.s_fgr:#0A..7prctxte(h2!x,.d-1,.7)#0A..7wr
itef(op#3Ds_fls->"#23<","#23>")#0A..7prctxte(h3!x,.
d-1,.7)#0A..7RETURN#0A#0A..2CASE.s_le:.CASE.s_ge:#0A
..7prctxte(h2!x,.d-1,.7)#0A..7writef(op#3Ds_le->"<#3D
",">#3D")#0A..7prctxte(h3!x,.d-1,.7)#0A..7RETURN#0A
#0A..2CASE.s_fle:.CASE.s_fge:#0A..7prctxte(h2!x,.d-
1,.7)#0A..7writef(op#3Ds_fle->"#23<#3D","#23>#3D")#0A
..7prctxte(h3!x,.d-1,.7)#0A..7RETURN#0A..}#0A#0A..I
F.prec>#3D7.DO.{.wrch('(');.prctxte(x,.d,.0);.wrch(
')');.RETURN.}#0A#0A..SWITCHON.op.INTO#0A..{.DEFAUL
T:.ENDCASE#0A..2CASE.s_lshift:.CASE.s_rshift:#0A..7
prctxte(h2!x,.d-1,.6)#0A..7writef(op#3Ds_lshift->"<
<",">>")#0A..7prctxte(h3!x,.d-1,.6)#0A..7RETURN#0A.
.}#0A#0A..IF.prec>#3D6.DO.{.wrch('(');.prctxte(x,.d
,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.op.INTO#0A
..{.DEFAULT:.ENDCASE#0A..2CASE.s_not:#0A..7wrch('~'
)#0A..7prctxte(h2!x,.d-1,.5)#0A..7RETURN#0A..}#0A#0A
..IF.prec>#3D5.DO.{.wrch('(');.prctxte(x,.d,.0);.wr
ch(')');.RETURN.}#0A#0A..SWITCHON.op.INTO#0A..{.DEF
AULT:.ENDCASE#0A..2CASE.s_logand:#0A..7prctxte(h2!x
,.d-1,.4)#0A..7wrch('&')#0A..7prctxte(h3!x,.d-1,.4)
#0A..7RETURN#0A..}#0A#0A..IF.prec>#3D4.DO.{.wrch('(
');.prctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SW
ITCHON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A..2CASE.s_l
ogor:#0A..7prctxte(h2!x,.d-1,.3)#0A..7wrch('|')#0A.
.7prctxte(h3!x,.d-1,.3)#0A..7RETURN#0A..}#0A#0A..IF
.prec>#3D3.DO.{.wrch('(');.prctxte(x,.d,.0);.wrch('
)');.RETURN.}#0A#0A..SWITCHON.op.INTO#0A..{.DEFAULT
:.ENDCASE#0A..2CASE.s_eqv:#0A..2CASE.s_neqv:#0A..7p
rctxte(h2!x,.d-1,.2)#0A..7writef(op#3Ds_eqv->".EQV.
",".XOR.")#0A..7prctxte(h3!x,.d-1,.2)#0A..7RETURN#0A
#0A..}#0A#0A..IF.prec>#3D2.DO.{.wrch('(');.prctxte(
x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.op.IN
TO#0A..{.DEFAULT:.ENDCASE#0A..2CASE.s_cond:#0A..7pr
ctxte(h2!x,.d-1,.1)#0A..7writef("->")#0A..7prctxte(
h3!x,.d-1,.1)#0A..7writef(",")#0A..7prctxte(h4!x,.d
-1,.1)#0A..7RETURN#0A..}#0A#0A..IF.prec>#3D1.DO.{.w
rch('(');.prctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A
..SWITCHON.op.INTO#0A..{.DEFAULT:.writef("Op%n",.op
);.RETURN#0A#0A..2CASE.s_table:#0A..7writef("TABLE.
")#0A..7prctxte(h2!x,.d-1,.0)#0A..7RETURN#0A..7#0A.
.2CASE.s_valof:#0A..7writef("VALOF.{")#0A..7prctxtc
(h2!x,.d-1)#0A..7wrch('}')#0A..7RETURN#0A#0A..2CASE
.s_comma:#0A..7prctxte(h2!x,.d-1,.0)#0A..7writef(",
")#0A..7prctxte(h3!x,.d-1,.0)#0A..7RETURN#0A..}#0A}
#0A#0A1AND.out1(x).BE.wrn(x)#0A.#0AAND.out2(x,.y).B
E.{.out1(x);.out1(y).}#0A.#0AAND.out3(x,.y,.z).BE.{
.out1(x);.out1(y);.out1(z).}#0A.#0AAND.out4(x,.y,.z
,.t).BE.{.out1(x);.out1(y);.out1(z);.out1(t).}#0A.#0A
AND.outstring(s).BE.FOR.i.#3D.0.TO.s%0.DO.out1(s%i)
#0A

######com/bcplint.b#
//.This.is.the.BCPL.to.Intcode.compiler#0A#0A//.Imp
lemented.by.Martin.Richards.(c).Sept.2012#0A#0A//.N
ote:.#2E#2E/cintcode/.is.used.so.that.the.compiler.
can.be#0A//.compiled.in.a.directory.parallel.to.cin
tcode.(such.as.natbcpl)#2E#0A#0AGET."#2E#2E/cintcod
e/com/bcplfe#2Eb"#0A#0A#2E#0A#0AGET."#2E#2E/cintcod
e/com/cg-intcode#2Eb"#0A

######com/bcplxref.b#
//.(C).Copyright.1978.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0A/*.Change.log#0A#0A00016/8/01#0AAdded.SLCT,.OF.a
nd.::.and.made./*.*/.comments.nest#2E#0AAllowed.con
stants.in.GLOBAL,.MANIFEST.and.STATIC.declarations#0A
to.be.optional#2E#0A#0A*/#0A#0ASECTION."BCPLXREF"#0A
#0AGET."libhdr"#0A#0AMANIFEST.{#0As_null#3D0#0As_le
t#0As_proc#0As_lab#0As_global#0As_manifest#0As_stat
ic#0As_for#0As_eq#0As_be#0As_and#0As_name#0As_numbe
r#0As_get#0As_string#0As_colon#0As_lparen#0As_rpare
n#0As_case#0As_end#0As_semicol#0As_lsect#0As_rsect#0A
wspacesize.#3D.3002#0A}#0A#0AGLOBAL.{#0Anextsymb:ug
#0Alookupword#0Acmpstr#0Adeclsyswords#0Ad#0Arch#0Ar
dtag#0Aperformget#0Areadnumber#0Avalue#0Ardstrch#0A
newvec#0Alist2#0Aaddref#0Axref#0Aprtree#0Awrnameinf
o#0Aerror#0Amatch#0A#0Asymb#0Aprevsymb#0Ach#0Awordv
#0Awordsize#0Acharv#0Aptr#0Atreevec#0Atreep#0Agetv#0A
getp#0Agett#0Asourcestream#0Alinecount#0Anametree#0A
wordnode#0Aword#0Apattern#0Afileno#0Anextfile#0Amat
chall#0Aoldtype#0Anlpending#0Atostream#0Aworkspace#0A
}#0A#0A1LET.nextsymb().BE#0A{.prevsymb.:#3D.symb#0A
..symb.:#3D.s_null#0A#0A..IF.nlpending.DO#0A..{..li
necount.:#3D.linecount.+.1#0A..3nlpending:#3DFALSE#0A
..}#0A#0A..SWITCHON.ch.INTO#0A#0A..{.CASE.'*p':#0A.
.2CASE.'*n':.nlpending.:#3D.TRUE#0A..13rch()#0A..13
symb:#3Ds_semicol#0A..13RETURN#0A#0A..2CASE.'*t':#0A
..2CASE.'*s':.rch().REPEATWHILE.ch#3D'*s'#0A..13LOO
P#0A#0A..2CASE.'0':CASE.'1':CASE.'2':CASE.'3':CASE.
'4':#0A..2CASE.'5':CASE.'6':CASE.'7':CASE.'8':CASE.
'9':#0A..13readnumber(10)#0A..13symb.:#3D.s_number#0A
..13RETURN#0A#0A..2CASE.'a':CASE.'b':CASE.'c':CASE.
'd':CASE.'e':#0A..2CASE.'f':CASE.'g':CASE.'h':CASE.
'i':CASE.'j':#0A..2CASE.'k':CASE.'l':CASE.'m':CASE.
'n':CASE.'o':#0A..2CASE.'p':CASE.'q':CASE.'r':CASE.
's':CASE.'t':#0A..2CASE.'u':CASE.'v':CASE.'w':CASE.
'x':CASE.'y':#0A..2CASE.'z':#0A..2CASE.'A':CASE.'B'
:CASE.'C':CASE.'D':CASE.'E':#0A..2CASE.'F':CASE.'G'
:CASE.'H':CASE.'I':CASE.'J':#0A..2CASE.'K':CASE.'L'
:CASE.'M':CASE.'N':CASE.'O':#0A..2CASE.'P':CASE.'Q'
:CASE.'R':CASE.'S':CASE.'T':#0A..2CASE.'U':CASE.'V'
:CASE.'W':CASE.'X':CASE.'Y':#0A..2CASE.'Z':#0A..13r
dtag(ch)#0A..13symb.:#3D.lookupword()#0A..13UNLESS.
symb#3Ds_get.RETURN#0A..13performget()#0A..13LOOP#0A
#0A..2CASE.'$':..rch()#0A..13symb.:#3D.0#0A..13IF.c
h#3D'('.DO.symb.:#3D.s_lsect#0A..13IF.ch#3D')'.DO.s
ymb.:#3D.s_rsect#0A..13TEST.ch#3D'('.|.ch#3D')'#0A.
.13THEN.rdtag('$')#0A..13ELSE.rch()#0A..13RETURN#0A
#0A..2CASE.'{':..symb.:#3D.s_lsect#0A..13rch()#0A..
13RETURN#0A..2CASE.'}':..symb.:#3D.s_rsect#0A..13rc
h()#0A..13RETURN#0A..2CASE.'[':#0A..2CASE.'(':..sym
b.:#3D.s_lparen#0A..13rch()#0A..13RETURN#0A..2CASE.
']':#0A..2CASE.')':..symb.:#3D.s_rparen#0A..13rch()
#0A..13RETURN#0A#0A..2CASE.'#3D':..symb.:#3D.s_eq#0A
..13rch()#0A..13RETURN#0A#0A..2CASE.'#23':#0A..5{.L
ET.radix.#3D.8#0A..7rch()#0A..7IF.ch#3D'B'.DO.radix
.:#3D.2#0A..7IF.ch#3D'X'.DO.radix.:#3D.16#0A..7UNLE
SS.'O'<#3Dch<#3D'7'.DO.rch()#0A..7readnumber(radix)
#0A..7symb.:#3D.s_number#0A..7RETURN#0A..5}#0A#0A..
2CASE.'/':#0A..7rch()#0A..7IF.ch#3D'\'.DO.{.rch();.
LOOP..}#0A..7IF.ch#3D'/'.DO#0A..7{.rch().REPEATUNTI
L.ch#3D'*n'.|.ch#3Dendstreamch#0A..9LOOP#0A..7}#0A#0A
..7UNLESS.ch#3D'**'.RETURN#0A#0A..7//.skip.(nested)
./*.*/.comments#0A..7{..LET.depth.#3D.1#0A#0A..10{.
.rch()#0A..13IF.ch#3D'**'.DO#0A..13{..rch().REPEATW
HILE.ch#3D'**'#0A..16IF.ch#3D'/'.DO.{..depth.:#3D.d
epth-1;.LOOP.}#0A..13}#0A..13IF.ch#3D'/'.DO#0A..13{
..rch()#0A..16IF.ch#3D'**'.DO.{..depth.:#3D.depth+1
;.LOOP.}#0A..13}#0A..13IF.ch#3D'*n'.DO.linecount.:#3D
.linecount+1#0A..13IF.ch#3Dendstreamch.BREAK#0A..10
}.REPEATUNTIL.depth#3D0#0A#0A..10rch()#0A..10LOOP#0A
..8}#0A#0A..2CASE.'|':#0A..7rch()#0A..7IF.ch#3D'|'.
DO#0A..7{.rch().REPEATUNTIL.ch#3D'*n'.|.ch#3Dendstr
eamch#0A..9LOOP#0A..7}#0A#0A..7UNLESS.ch#3D'**'.RET
URN#0A#0A..7{.rch()#0A..9IF.ch#3D'**'.DO#0A..9{.rch
().REPEATWHILE.ch#3D'**'#0A..11IF.ch#3D'|'.BREAK#0A
..9}#0A..9IF.ch#3D'*n'.DO.linecount:#3Dlinecount+1#0A
..7}.REPEATUNTIL.ch#3Dendstreamch#0A#0A..7rch()#0A.
.7LOOP#0A#0A..2CASE.'<':#0A..2CASE.'>':#0A..2CASE.'
\':.rch()#0A..12IF.ch#3D'#3D'.DO.rch()#0A..12RETURN
#0A#0A..2CASE.'-':.rch()#0A..12IF.ch#3D'>'.DO.rch()
#0A..12RETURN#0A#0A..2CASE.';':.symb:#3Ds_semicol#0A
..12rch()#0A..12RETURN#0A#0A..2CASE.':':.rch()#0A..
12IF.ch#3D'#3D'.DO.{.rch();.RETURN..}#0A..12IF.ch#3D
':'.DO.{.rch();.RETURN..}#0A..12symb.:#3D.s_colon#0A
..12RETURN#0A#0A1..2CASE.'"':.rch()#0A..12charv!0.:
#3D.0#0A..12FOR.i.#3D.1.TO.255.DO#0A..12{.IF.ch#3D'
"'.BREAK#0A..14charv!0.:#3D.i#0A..14charv!i.:#3D.rd
strch()#0A..12}#0A..12wordsize.:#3D.packstring(char
v,.wordv)#0A..12symb.:#3D.s_string#0A..12rch()#0A..
12RETURN#0A#0A..2CASE.'*'':rch()#0A..12rdstrch()#0A
..12rch()#0A..12symb.:#3D.s_number#0A..12RETURN#0A#0A
1..2CASE.'#2E':.UNLESS.getp#3D0.DO.ch.:#3D.endstrea
mch#0A..2DEFAULT:..UNLESS.ch#3Dendstreamch.DO#0A..1
2{.rch()#0A..14RETURN#0A..12}#0A..12IF.getp#3D0.DO.
{.symb.:#3D.s_end#0A..27RETURN#0A..25}#0A..12endrea
d()#0A..12getp.:#3D.getp.-.3#0A..12sourcestream.:#3D
.getv!getp#0A..12selectinput(sourcestream)#0A..12li
necount.:#3D.getv!(getp+1)>>0003#0A..12fileno.:#3D.
getv!(getp+1)&7#0A..12ch.:#3D.getv!(getp+2)#0A..12L
OOP#0A..}#0A}.REPEAT#0A#0ALET.lookupword().#3D.VALO
F#0A{.LET.p.#3D.@nametree#0A#0A..wordnode.:#3D.!p#0A
#0A..UNTIL.wordnode#3D0.DO#0A..{.LET.cmp.#3D.cmpstr
(wordv,.wordnode+4)#0A..2IF.cmp#3D0.RESULTIS.!wordn
ode#0A..2p.:#3D.wordnode.+.(cmp<0->1,2)#0A..2wordno
de.:#3D.!p#0A..}#0A#0A..wordnode.:#3D.newvec(wordsi
ze+4)#0A..wordnode!0,.wordnode!1.:#3D.s_name,.0#0A.
.wordnode!2,.wordnode!3.:#3D.0,.0#0A..FOR.i.#3D.0.T
O.wordsize.DO.wordnode!(i+4).:#3D.wordv!i#0A#0A..!p
.:#3D.wordnode#0A..RESULTIS.s_name#0A}#0A#0AAND.cmp
str(s1,.s2).#3D.VALOF#0A{.LET.len1,.len2.#3D.s1%0,.
s2%0#0A..FOR.i.#3D.1.TO.len1.DO#0A..{.LET.ch1,.ch2.
#3D.s1%i,.s2%i#0A..2IF.i>len2..RESULTIS.1#0A..2IF.'
a'<#3Dch1<#3D'z'.DO.ch1:#3Dch1-'a'+'A'#0A..2IF.'a'<
#3Dch2<#3D'z'.DO.ch2:#3Dch2-'a'+'A'#0A..2IF.ch1>ch2
.RESULTIS.1#0A..2IF.ch1<ch2.RESULTIS.-1#0A..}#0A..I
F.len1<len2.RESULTIS.-1#0A..RESULTIS.0#0A}#0A#0AAND
.declsyswords().BE#0A{.ptr.:#3D.TABLE#0A..0040,s_an
d,#0A..4s_be,0,0,#0A..4s_case,#0A..0040,0,#0A..4s_e
q,0,0,0,#0A..0040,0,s_for,0,#0A..0040,0,0,s_global,
s_get,#0A..0040,0,#0A..4s_let,0,0,0,0,0,0,0,#0A..4s
_manifest,#0A..0040,0,0,0,#0A..0040,0,#0A..0040,0,0
,0,0,#0A..0040,0,0,#0A..0040,0,0,s_static,#0A..0040
,0,0,0,0,#0A..0040,0,#0A..0040,0,#0A..0040#0A#0A..d
("ABS/AND/*#0A..2*BE/BREAK/BY/*#0A..2*CASE/*#0A..2*
DO/DEFAULT/*#0A..2*EQ/EQV/ELSE/ENDCASE/*#0A..2*FALS
E/FLOAT/FOR/FINISH/*#0A..2*GOTO/GE/GR/GLOBAL/GET/*#0A
..2*IF/INTO/*#0A..2*LET/LV/LE/LS/LOGOR/LOGAND/LOOP/
LSHIFT//")#0A#0A..d("MANIFEST/*#0A..2*NEEDS/NE/NOT/
NEQV/*#0A..2*OR/OF/*#0A..2*RESULTIS/RETURN/REM/RSHI
FT/RV/*#0A..2*REPEAT/REPEATWHILE/REPEATUNTIL/*#0A..
2*SECTION/SLCT/SWITCHON/STATIC/*#0A..2*TO/TEST/TRUE
/THEN/TABLE/*#0A..2*UNTIL/UNLESS/*#0A..2*VEC/VALOF/
*#0A..2*WHILE//")#0A}#0A#0A1AND.d(words).BE#0A{.LET
.i,.length.#3D.1,.0#0A#0A..{.LET.ch.#3D.words%i#0A.
.2TEST.ch#3D'/'#0A..2THEN.{.IF.length#3D0.RETURN#0A
..9charv!0.:#3D.length#0A..9wordsize.:#3D.packstrin
g(charv,.wordv)#0A..9lookupword()#0A..9!wordnode.:#3D
.!ptr#0A..10ptr.:#3D.ptr.+.1#0A..10length.:#3D.0#0A
..7}#0A..2ELSE.{.length.:#3D.length.+.1#0A..9charv!
length.:#3D.ch#0A..7}#0A..2i.:#3D.i.+.1#0A..}.REPEA
T#0A}#0A#0ALET.rch().BE.ch.:#3D.rdch()#0A#0AAND.rdt
ag(char1).BE#0A{.LET.n.#3D.1#0A..charv!1.:#3D.char1
#0A#0A..{.rch()#0A..2UNLESS.'A'<#3Dch<#3D'Z'.|#0A..
9'a'<#3Dch<#3D'z'.|#0A..9'0'<#3Dch<#3D'9'.|#0A..10c
h#3D'#2E'.|.ch#3D'_'.BREAK#0A..2n.:#3D.n+1#0A..2cha
rv!n.:#3D.ch#0A..}.REPEAT#0A#0A..charv!0.:#3D.n#0A.
.wordsize.:#3D.packstring(charv,.wordv)#0A}#0A#0A1A
ND.performget().BE#0A{.LET.stream.#3D.?#0A..LET.fil
ename.#3D.VEC.50#0A..nextsymb()#0A..UNLESS.symb#3Ds
_string.DO.error("Bad.GET.directive")#0A..FOR.i.#3D
.1.TO.wordv%0.IF.wordv%i#3D':'.DO.wordv%i.:#3D.'/'#0A
//writef("trying:.GET.*"%s*".in.BCPLHDRS*n",.wordv)
#0A..//.First.look.in.the.current.directory#0A..str
eam.:#3D.pathfindinput(wordv,."BCPLHDRS")#0A#0A..UN
LESS.stream.DO#0A..{.LET.dirname.#3D."".//.not."g/"
#0A..2LET.ext..3#3D."#2Eh"#0A..2LET.n.#3D.0..16//.F
orm:..<name>#2Eh#0A..2FOR.i.#3D.1.TO.dirname%0.DO#0A
..2{.n.:#3D.n+1#0A..4filename%n.:#3D.dirname%i#0A..
2}#0A..2FOR.i.#3D.1.TO.wordv%0.DO#0A..2{.n.:#3D.n+1
#0A..4filename%n.:#3D.wordv%i#0A..2}#0A..2FOR.i.#3D
.1.TO.ext%0.DO#0A..2{.n.:#3D.n+1#0A..4filename%n.:#3D
.ext%i#0A..2}#0A..2filename%0.:#3D.n#0A//sawritef("
trying:.GET.*"%s*".in.BCPLHDRS*n",.filename)#0A..2s
tream.:#3D.pathfindinput(filename,."BCPLHDRS")..//.
MR.18/2/04#0A..}#0A#0A..UNLESS.stream.DO#0A..{.erro
r("Unable.to.find.GET.file.%s",.wordv)#0A..2RETURN#0A
..}#0A//sawritef("File.*"%s*".opened.successfully*n
",.wordv)#0A#0A..writef("File.%N.is.*"%S*"*n",.next
file+1,.wordv)#0A..getv!getp.:#3D.sourcestream#0A..
getv!(getp+1).:#3D.(linecount<<0003)+fileno#0A..get
v!(getp+2).:#3D.ch#0A..getp.:#3D.getp.+.3#0A..linec
ount.:#3D.1#0A..sourcestream.:#3D.stream#0A..select
input(sourcestream)#0A..nextfile.:#3D.nextfile.+.1#0A
..fileno:#3Dnextfile#0A..rch()#0A}#0A#0A2AND.readnu
mber(radix).BE#0A..UNTIL.value(ch)>#3Dradix.&.ch~#3D
'_'.DO.rch()#0A#0AAND.value(ch).#3D.'0'<#3Dch<#3D'9
'.->.ch-'0',#0A..14'a'<#3Dch<#3D'f'.->.ch-'a'+10,#0A
..14'A'<#3Dch<#3D'F'.->.ch-'A'+10,#0A..014100#0A#0A
AND.rdstrch().#3D.VALOF#0A{.LET.k.#3D.ch#0A#0A..rch
()#0A#0A..IF.k#3D'*n'.DO.error("Bad.string")#0A#0A.
.IF.k#3D'**'.DO#0A..{.IF.ch#3D'*n'.|.ch#3D'*s'.|.ch
#3D'*t'.DO#0A..2{.{.IF.ch#3D'*n'.DO.linecount.:#3D.
linecount+1#0A..7rch()#0A..5}.REPEATWHILE.ch#3D'*n'
.|.ch#3D'*s'.|.ch#3D'*t'#0A..5rch()#0A..5RESULTIS.r
dstrch()#0A..2}#0A#0A..2rch()#0A..}#0A#0A..RESULTIS
.k#0A}#0A#0ALET.newvec(n).#3D.VALOF#0A{.treep.:#3D.
treep.-.n.-.1#0A..UNLESS.treep>#3Dtreevec.DO#0A..{.
error("Program.too.large")#0A..2quit(20)#0A..}#0A..
RESULTIS.treep#0A}#0A#0A2AND.list2(x,.y).#3D.VALOF#0A
{.LET.p.#3D.newvec(1)#0A..p!0,.p!1.:#3D.x,.y#0A..RE
SULTIS.p..1}#0A#0A1AND.addref(type,.name).BE#0A{.LE
T.p.#3D.name+3#0A..UNTIL.!p#3D0.DO.p.:#3D.!p#0A..!p
.:#3D.list2(0,.((1linecount<<0003)+fileno)<<0003)+t
ype)#0A}#0A#0AAND.xref(v,size).BE#0A{.LET.type.#3D.
s_null#0A#0A..treevec,.treep.:#3D.v,.v+size#0A#0A..
nametree.:#3D.0#0A..nlpending:#3DFALSE#0A..matchall
:#3D.FALSE#0A..fileno:#3D0#0A..nextfile:#3D0#0A..li
necount.:#3D.1#0A..declsyswords()#0A..rch()#0A..nex
tsymb()#0A#0A..UNTIL.symb#3Ds_end.SWITCHON.symb.INT
O#0A..{.CASE.s_global:#0A..2CASE.s_static:#0A..2CAS
E.s_manifest:.type.:#3D.symb#0A..19oldtype.:#3D.sym
b#0A..2DEFAULT:..7nextsymb()#0A..19LOOP#0A#0A..2CAS
E.s_and:.symb.:#3D.s_let#0A..2CASE.s_case:#0A..2CAS
E.s_for:#0A..2CASE.s_let:.type.:#3D.symb#0A..14next
symb()#0A..14LOOP#0A#0A..2CASE.s_rsect:#0A..14type,
.oldtype.:#3D.s_null,.s_null#0A..14nextsymb()#0A..1
4LOOP#0A#0A..2CASE.s_semicol:.type:#3Doldtype#0A..1
8nextsymb()#0A..18LOOP#0A#0A..2CASE.s_colon:#0A..2C
ASE.s_be:#0A..2CASE.s_eq:.type.:#3D.s_null#0A..13ne
xtsymb()#0A..13LOOP#0A#0A..2CASE.s_name:#0A..2{.LET
.t.#3D.type#0A..4LET.name.#3D.wordnode#0A..4nextsym
b()#0A..4IF.symb#3Ds_colon.DO.t:#3D.type#3Ds_null.-
>.s_lab,#0A..27type#3Ds_case.->.s_null,.type#0A..4I
F.type#3Ds_let.DO.t:#3D.symb#3Ds_lparen.->.s_proc,.
s_let#0A..4IF.type.#3Ds_global.|.type#3Ds_manifest.
|.type#3Ds_static.DO#0A..6SWITCHON.prevsymb.INTO#0A
..6{.DEFAULT:..t.:#3D.s_null#0A#0A..8CASE.s_lsect:#0A
..8CASE.s_name:.CASE.s_number:.CASE.s_rparen:#0A..1
8t.:#3D.type#0A..18ENDCASE#0A..6}#0A..4word.:#3D.na
me+4#0A..4IF.matchall.|.match(1,1).DO.addref(t,.nam
e)#0A..4LOOP#0A..2}#0A..}#0A#0A..newline()#0A..prtr
ee(nametree)#0A#0A..writes("*n**.-.never.used*n")#0A
..writes("*nKey.to.references.in.<lineno><type><fil
eno>*n")#0A..writes(".V.-.variable*n.P.-.procedure*
n.L.-.label*n.G.-.global*n")#0A..writes(".M.-.manif
est*n.S.-.static*n.F.-.FOR.loop.variable*n")#0A..wr
itef("*nSpace.used.%N*n",.v+size-treep)#0A}#0A#0AAN
D.prtree(t).BE.UNLESS.t#3D0.DO#0A{.prtree(t!1)#0A..
wrnameinfo(t)#0A..prtree(t!2)#0A}#0A#0AAND.wrnamein
fo(t).BE.IF.!t#3Ds_name.DO#0A{.LET.n.#3D.t+4#0A..LE
T.l.#3D.t!3#0A..LET.chp.#3D.n%0.+.3#0A..LET.declare
d,.used.#3D.FALSE,.FALSE#0A#0A..IF.intflag().RETURN
#0A#0A..UNTIL.l#3D0.DO#0A..{#0A..2IF.((l!1)&#237)#3D
0.THEN.declared.:#3D.TRUE#0A..2IF.((l!1)&#2370)#3D0
.THEN.used:#3DTRUE#0A..2l.:#3D.!l#0A..}#0A..UNLESS.
used./*in.main.file*/.RETURN#0A..writef("%C.%S.",.(
declared->'*s','**'),.n)#0A..UNTIL.chp.REM.7.#3D.5.
&.chp>#3D12.DO.{.wrch('*s')#0A..35chp.:#3D.chp+1#0A
..33}#0A..l.:#3D.t!3#0A..UNTIL.l#3D0.DO#0A..{.LET.a
.#3D.l!1#0A..2LET.ln,.f,.t.#3D.a>>0006,.(a>>0003)&7
,.a&7#0A..2IF.chp>#3D70.DO.{.writes("*n..10")#0A..1
8chp.:#3D.12..}#0A..2writed(ln,.5)#0A..2TEST.t#3D0.
THEN.wrch(.f#3D0.->.'*s',.':'.)#0A..11ELSE.wrch(."V
PLGMSF"%t.)#0A..2TEST.f#3D0.THEN.wrch('*s')#0A..11E
LSE.writed(f,1)#0A..2chp:#3Dchp+7#0A..2l.:#3D.!l#0A
..}#0A#0A..newline()#0A}#0A#0AAND.error(mess).BE.wr
itef("Line.%N.%S*n",.linecount,.mess)#0A#0AAND.matc
h(p,s).#3D#0A..2s>word%0.->.(p>pattern%0.->.TRUE,#0A
..15pattern%p#3D'**'.->.match(p+1,s),#0A..24FALSE),
#0A..2p>pattern%0.->.FALSE,#0A..2pattern%p#3D'**'.-
>#0A..5(match(p+1,s).->.TRUE,#0A..6match(p,s+1)),#0A
..2(.pattern%p#3Dword%s.|#0A..4'a'<#3Dword%s<#3D'z'
.&.pattern%p#3Dword%s-'a'+'A'.|#0A..4'A'<#3Dword%s<
#3D'Z'.&.pattern%p#3Dword%s-'A'+'a'.).->.match(p+1,
s+1),#0A..2FALSE#0A#0AAND.start().#3D.VALOF#0A{.LET
.v3.#3D.VEC.20#0A..LET.argv.#3D.VEC.40#0A..LET.parm
.#3D.?#0A#0A..IF.rdargs("FROM/A,TO/K,PAT/K",argv,40
).#3D.0.DO#0A..{.writes("Invalid.args.to.BCPLXREF*n
")#0A..2quit(20)#0A..}#0A#0A..parm.:#3D.(argv!2.#3D
.0.->."",.argv!2)#0A#0A..getv,.getp,.gett.:#3D.v3,.
0,.20#0A#0A..pattern.:#3D."**"#0A..IF.parm%0>0.DO.p
attern.:#3D.parm#0A..IF.parm%(parm%0)#3D'*n'.DO.par
m%0:#3Dparm%0-1#0A..writes("BCPL.cross.referencer")
#0A..TEST.pattern%0#3D1.&.pattern%1#3D'**'#0A..THEN
.matchall:#3DTRUE#0A..ELSE.writef("#2E.Pattern#3D%S
",.pattern)#0A..writes("*n*n")#0A#0A..sourcestream.
:#3D.findinput(argv!0)#0A..IF.sourcestream#3D0.DO#0A
..{.writef("Can't.open.%S*n",.argv!0)#0A..2quit(20)
#0A..}#0A..selectinput(sourcestream)#0A#0A..tostrea
m.:#3D.0#0A..UNLESS.argv!1.#3D.0.DO#0A..{.tostream.
:#3D.findoutput(argv!1)#0A..2IF.tostream.#3D.0.DO#0A
..2{.writef("Can't.open.%S*n",.argv!1)#0A..4quit(20
)#0A..2}#0A..2selectoutput(tostream)#0A..}#0A#0A..c
harv.:#3D.getvec(256)..3//.used.to.hold.strings.1.c
har/word#0A..wordv.:#3D.getvec(256/bytesperword)..1
//.used.for.strings#0A..workspace.:#3D.getvec(wspac
esize.-.1)#0A..IF.workspace.#3D.0.|.charv#3D0.|.wor
dv#3D0.DO#0A..{.writes("Insufficient.store*n")#0A..
2quit(20)#0A..}#0A#0A..xref(workspace,.wspacesize)#0A
..quit(0).//.Close.down.stream.and.free.work.space#2E
#0A..RESULTIS.0#0A}#0A#0A1AND.quit(code).BE#0A{.//.
Tidies.up.and.stops#0A..UNLESS.workspace.#3D.0.DO.f
reevec(workspace)#0A..UNLESS.sourcestream.#3D.0.DO.
endread()#0A..UNLESS.tostream.#3D.0.DO.endwrite()#0A
..stop(code)#0A}#0A

######com/bench100.b#
//.header.file.for.the.bench.mark.test#0A#0ASECTION
."bench100"#0A.#0AMANIFEST.$(.//.Comment.out.one.of
.the.following.lines#0A//Count#3D1002;..4Qpktcountv
al#3D23246;..1Holdcountval#3D9297#0A..Count#3D1002*
100;..Qpktcountval#3D2326410;.Holdcountval#3D930563
#0A$)#0A#0AGET."libhdr"#0A.#0AMANIFEST.$(#0Ai_idle.
.5#3D.1#0Ai_work..5#3D.2#0Ai_handlera..1#3D.3#0Ai_h
andlerb..1#3D.4#0Ai_deva..5#3D.5#0Ai_devb..5#3D.6#0A
tasktab_upb..#3D.10#0A.#0Ap_link.#3D.0#0Ap_id..1#3D
.1#0Ap_kind.#3D.2#0Ap_a1..1#3D.3#0Ap_a2..1#3D.4#0Ap
kt_upb#3D.8#0A.#0At_link.#3D.0#0At_id..1#3D.1#0At_p
ri..#3D.2#0At_wkq..#3D.3#0At_state#3D.4#0At_fn..1#3D
.5#0At_v1..1#3D.6#0At_v2..1#3D.7#0Atcb_upb#3D.7#0A.
#0Abufsize.#3D.3#0A.#0Apktbit..7#3D.1#0Awaitbit..6#3D
.2#0Aholdbit..6#3D.4#0A.#0Anotpktbit..4#3D.NOT.pktb
it#0Anotwaitbit..3#3D.NOT.waitbit#0Anotholdbit..3#3D
.NOT.holdbit#0A.#0As_run..8#3D.0#0As_runpkt..5#3D.p
ktbit#0As_wait..7#3D.waitbit#0As_waitpkt..4#3D.wait
bit.+.pktbit#0As_hold..7#3D.holdbit#0As_holdpkt..4#3D
.holdbit.+.pktbit#0As_holdwait..3#3D.holdbit.+.wait
bit#0As_holdwaitpkt..#3D.holdbit.+.waitbit.+.pktbit
#0A.#0Ak_dev..1#3D.1001#0Ak_work..#3D.1000001#0A$)#0A
.#0AGLOBAL.$(#0Atasktab..:.250#0Atasklist.:.251#0At
cb..4:.252#0Ataskid..1:.253#0Av1..5:.254#0Av2..5:.2
55#0A.#0Atrace..2:.259#0Aschedule.:.260#0Aqpkt..3:.
261#0Await..3:.262#0Aholdself.:.263#0Arelease..:.26
4#0A.#0Aidlefn..1:.270#0Aworkfn..1:.271#0Ahandlerfn
:.272#0Adevfn..2:.273#0A.#0Aqpktcount:.280#0Aholdco
unt:.281#0Atracing..:.282#0Alayout..1:.283#0A$)#0A.
#0A//#2E#0A.#0A//SECTION."main"#0A.#0A//GET."HDR"#0A
#0ALET.start().#3D.VALOF#0A$(.LET.wkq.#3D.0#0A#0A..
1writef("*Nbench.mark.starting,.Count#3D%n*N",.Coun
t)#0A.#0A..1tasktab.:#3D.getvec(tasktab_upb)#0A..1t
asktab!0.:#3D.tasktab_upb#0A..1FOR.taskno.#3D.1.TO.
tasktab_upb.DO.tasktab!taskno.:#3D.0#0A.#0A..1taskl
ist.:#3D.0#0A.#0A..1createtask(i_idle,.0,.wkq,.s_ru
n,.idlefn,.1,.Count)#0A.#0A..1wkq.:#3D.pkt(0,..0010
,.k_work)#0A..1wkq.:#3D.pkt(wkq,.0,.k_work)#0A..1cr
eatetask(i_work,.1001,.wkq,.s_waitpkt,.workfn,.i_ha
ndlera,.0)#0A.#0A..1wkq.:#3D.pkt(0,..1i_deva,.k_dev
)#0A..1wkq.:#3D.pkt(wkq,.i_deva,.k_dev)#0A..1wkq.:#3D
.pkt(wkq,.i_deva,.k_dev)#0A..1createtask(i_handlera
,.2001,.wkq,.s_waitpkt,.handlerfn,.0,.0)#0A.#0A..1w
kq.:#3D.pkt(0,..1i_devb,.k_dev)#0A..1wkq.:#3D.pkt(w
kq,.i_devb,.k_dev)#0A..1wkq.:#3D.pkt(wkq,.i_devb,.k
_dev)#0A..1createtask(i_handlerb,.3001,.wkq,.s_wait
pkt,.handlerfn,.0,.0)#0A.#0A..1wkq.:#3D.0#0A..1crea
tetask(i_deva,.4001,.wkq,.s_wait,.devfn,.0,.0)#0A..
1createtask(i_devb,.5001,.wkq,.s_wait,.devfn,.0,.0)
#0A.#0A..1tcb.:#3D.tasklist#0A.#0A..1qpktcount,.hol
dcount.:#3D.0,.0#0A.#0A..1writes("*Nstarting*N")#0A
//.writef("starting.time.#3D.%n*N",.time())#0A..1tr
acing,.layout.:#3D.FALSE,.0#0A..1schedule()#0A..1wr
ites("*Nfinished*N")#0A//.writef("*Nfinishing.time.
#3D.%n*N",.time())#0A.#0A..1writef("qpkt.count.#3D.
%n..holdcount.#3D.%n*N",#0A..9qpktcount,..5holdcoun
t)#0A.#0A..1writes("these.results.are.")#0A..1TEST.
qpktcount#3DQpktcountval.&.holdcount#3DHoldcountval
#0A..1THEN.writes("correct")#0A..1ELSE.writes("inco
rrect")#0A.#0A..1writes("*Nend.of.run*N")#0A..1RESU
LTIS.0#0A$)#0A.#0AAND.createtask(id,.pri,.wkq,.stat
e,.fn,.v1,.v2).BE#0A$(.LET.t.#3D.getvec(tcb_upb)#0A
..1tasktab!id.:#3D.t..//.insert.in.the.task.table#0A
..1t_link!t.:#3D.tasklist#0A..1t_id!t..1:#3D.id#0A.
.1t_pri!t..:#3D.pri#0A..1t_wkq!t..:#3D.wkq#0A..1t_s
tate!t:#3D.state#0A..1t_fn!t..1:#3D.fn#0A..1t_v1!t.
.1:#3D.v1#0A..1t_v2!t..1:#3D.v2#0A..1tasklist.:#3D.
t#0A$)#0A.#0AAND.pkt(link,.id,.kind).#3D.VALOF#0A$(
.LET.p.#3D.getvec(pkt_upb)#0A..1FOR.i.#3D.0.TO.pkt_
upb.DO.p!i.:#3D.0#0A..1p_link!p..2:#3D.link#0A..1p_
id!p..4:#3D.id#0A..1p_kind!p..2:#3D.kind#0A..1RESUL
TIS.p#0A$)#0A.#0A.#0AAND.trace(ch).BE#0A$(.layout.:
#3D.layout.-.1#0A..1IF.layout<#3D0.DO#0A..1$(.newli
ne()#0A..4layout.:#3D.50#0A..1$)#0A..1wrch(ch)#0A..
1ch.:#3D.7#0A$)#0A.#0A//#2E#0A.#0A//SECTION."bench"
#0A.#0A//GET."HDR"#0A.#0ALET.schedule().BE.UNTIL.tc
b#3D0.DO#0A//..20*106600005#0A$(.LET.pkt,.newtcb.#3D
.0,.?#0A//.*106600004#0A#0A..1SWITCHON.t_state!tcb.
INTO#0A..1$(.CASE.s_waitpkt:..2pkt.:#3D.t_wkq!tcb#0A
//..21*23250#0A..23t_wkq!tcb.:#3D.p_link!pkt#0A..23
t_state!tcb.:#3D.t_wkq!tcb#3D0.->.s_run,.s_runpkt#0A
//..21*23250..22*14760.*8490#0A..4CASE.s_run:#0A..4
CASE.s_runpkt:..3taskid,.v1,.v2.:#3D.t_id!tcb,.t_v1
!tcb,.t_v2!tcb#0A//..21*65790#0A..23IF.tracing.DO.t
race(taskid+'0')#0A//..35*0#0A..23newtcb.:#3D.(t_fn
!tcb)(pkt)#0A//..21*65790#0A..23t_v1!tcb,.t_v2!tcb.
:#3D.v1,.v2#0A..23tcb.:#3D.newtcb#0A..23LOOP#0A.#0A
..4CASE.s_wait:#0A..4CASE.s_hold:#0A..4CASE.s_holdp
kt:#0A..4CASE.s_holdwait:#0A..4CASE.s_holdwaitpkt:t
cb.:#3D.t_link!tcb#0A//..21*40814#0A..23LOOP#0A.#0A
..4DEFAULT:..9RETURN#0A//..21*0#0A..1$)#0A$)#0A.#0A
AND.qpkt(pkt).#3D.VALOF#0A$(.LET.t.#3D.findtcb(p_id
!pkt)#0A//.*23246#0A..1IF.t#3D0.RESULTIS.0#0A//..6*
0#0A..1qpktcount.:#3D.qpktcount.+.1#0A//.*23246#0A.
#0A..1p_link!pkt,.p_id!pkt.:#3D.0,.taskid#0A//.*232
46#0A..1TEST.t_wkq!t#3D0#0A..1THEN.$(.t_wkq!t.:#3D.
pkt#0A//..7*14759#0A..9t_state!t.:#3D.t_state!t.|.p
ktbit#0A..9IF.t_pri!t.>.t_pri!tcb.RESULTIS.t#0A//..
30*3140#0A..6$)#0A..1ELSE.append(pkt,.@.t_wkq!t)#0A
//..4*11000619#0A..1RESULTIS.tcb#0A//.*23246#0A$)#0A
.#0AAND.wait().#3D.VALOF#0A$(.t_state!tcb.:#3D.t_st
ate!tcb.|.waitbit#0A//.*23248#0A..1RESULTIS.tcb#0A$
)#0A.#0AAND.holdself().#3D.VALOF#0A$(.holdcount.:#3D
.holdcount.+.1#0A//.*9297#0A..1t_state!tcb.:#3D.t_s
tate!tcb.|.holdbit#0A..1RESULTIS.t_link!tcb#0A$)#0A
.#0AAND.release(id).#3D.VALOF#0A$(.LET.t.#3D.findtc
b(id)#0A//.*992#0A..1IF.t#3D0.RESULTIS.0#0A//..6*0#0A
.#0A..1t_state!t.:#3D.t_state!t.&.notholdbit#0A//.*
992#0A..1IF.t_pri!t.>.t_pri!tcb.RESULTIS.t#0A//..22
*992#0A..1RESULTIS.tcb#0A//.*0#0A$)#0A.#0AAND.findt
cb(id).#3D.VALOF#0A$(.LET.t.#3D.0#0A//.*33000245#0A
..1IF.1.<#3D.id.<#3D.tasktab!0.DO.t.:#3D.tasktab!id
#0A//..26*33000245#0A..1IF.t#3D0.DO.writes("*Nbad.t
ask.id*N")#0A//..9*0#0A..1RESULTIS.t#0A//.*33000245
#0A$)#0A.#0AAND.idlefn(pkt).#3D.VALOF#0A$(.v2.:#3D.
v2.-.1#0A//.*1002#0A..1IF.v2#3D0.RESULTIS.holdself(
)#0A//..7*1#0A..1TEST.(v1&1)#3D0#0A//.*992#0A..1THE
N.$(.v1.:#3D.v1>>0001#0A//..7*5000007#0A..9RESULTIS
.release(i_deva)#0A..6$)#0A..1ELSE.$(.v1.:#3D.v1>>0
001.NEQV.#23XD000008#0A//..7*4990002#0A..9RESULTIS.
release(i_devb)#0A..6$)#0A$)#0A.#0AAND.workfn(pkt).
#3D.VALOF.TEST.pkt#3D0#0A//..20*4654#0A..1THEN.RESU
LTIS.wait()#0A//..4*2327#0A..1ELSE.$(.LET.buf.#3D.@
.p_a2!pkt#0A//..7*2327#0A..9v1.:#3D.i_handlera.+.i_
handlerb.-.v1#0A..9//.v1.is.alternately.i>handlera.
AND.i_handlerb#0A.#0A..9p_id!pkt.:#3D.v1..1//.set.t
he.destination.task.id#0A..9p_a1!pkt.:#3D.0..2//.se
t.the.buffer.subscript#0A..9FOR.i.#3D.0.TO.bufsize.
DO#0A..9$(.v2.:#3D.v2.+.1#0A//..10*9308#0A..12IF.v2
>26.DO.v2.:#3D.1#0A//..22*358#0A..12buf%i.:#3D."ABC
DEFGHIJKLMNOPQRSTUVWXYZ"%v2#0A..9$)#0A..9RESULTIS.q
pkt(pkt)#0A//..7*2327#0A..6$)#0A.#0AAND.handlerfn(p
kt).#3D.VALOF#0A$(.UNLESS.pkt#3D0.DO.append(pkt,.p_
kind!pkt#3Dk_work.->.@v1,..@v2)#0A//.*23252..8*1100
0627..25*2327.*9300#0A..1UNLESS.v1#3D0.DO#0A//.*232
52#0A..1$(.LET.workpkt.#3D.v1#0A//..2*20310#0A..4LE
T.count,.buf.#3D.p_a1!workpkt,.@.p_a2!workpkt#0A..4
IF.count>bufsize.DO#0A..4$(.v1.:#3D.p_link!v1#0A//.
.5*2325#0A..7RESULTIS.qpkt(workpkt)..//.send.back.t
he.exhausted.a.work.packet#0A..4$)#0A..4UNLESS.v2#3D
0.DO#0A//..2*17985#0A..4$(.LET.devpkt.#3D.v2#0A..7v
2.:#3D.p_link!v2#0A..7p_a1!devpkt.:#3D.buf%count../
/.copy.character.into.it#0A..7p_a1!workpkt.:#3D.cou
nt+1..1//.incrementing.the.character.count#0A..7RES
ULTIS.qpkt(devpkt)..3//.send.the.packet.to.the.devi
ce.task#0A..4$)#0A..1$)#0A.#0A..1//.cannot.proceed.
for.lack.of.a.packet.so.wait.for.one#0A..1RESULTIS.
wait()#0A//.*11000627#0A$)#0A.#0AAND.devfn(pkt).#3D
.VALOF.TEST.pkt#3D0#0A//..13*27880004#0A..2THEN.$(.
IF.v1#3D0.RESULTIS.wait()#0A//..8*18588..*9294#0A..
10pkt.:#3D.v1#0A//..8*9294#0A..10v1.:#3D.0#0A..10RE
SULTIS.qpkt(pkt)#0A..7$)#0A..2ELSE.$(.v1.:#3D.pkt#0A
//..8*9296#0A..10IF.tracing.DO.trace(p_a1!pkt)#0A..
10RESULTIS.holdself()#0A..7$)#0A.#0AAND.append(pkt,
.ptr).BE#0A$(.p_link!pkt.:#3D.0#0A//.*20110004#0A..
1UNTIL.!ptr#3D0.DO.ptr.:#3D.!ptr#0A//..5*39877..2*1
0467#0A..1!ptr.:#3D.pkt#0A//.*20110004#0A$)#0A

######com/bench.b#
//.header.file.for.the.bench.mark.test#0A#0AMANIFES
T.$(.//.Comment.out.one.of.the.following.lines#0A..
Count#3D1002;..4Qpktcountval#3D23246;..1Holdcountva
l#3D9297#0A//Count#3D1002*100;..Qpktcountval#3D2326
410;.Holdcountval#3D930563#0A$)#0A#0AGET."libhdr"#0A
.#0AMANIFEST.$(#0Ai_idle..5#3D.1#0Ai_work..5#3D.2#0A
i_handlera..1#3D.3#0Ai_handlerb..1#3D.4#0Ai_deva..5
#3D.5#0Ai_devb..5#3D.6#0Atasktab_upb..#3D.10#0A.#0A
p_link.#3D.0#0Ap_id..1#3D.1#0Ap_kind.#3D.2#0Ap_a1..
1#3D.3#0Ap_a2..1#3D.4#0Apkt_upb#3D.8#0A.#0At_link.#3D
.0#0At_id..1#3D.1#0At_pri..#3D.2#0At_wkq..#3D.3#0At
_state#3D.4#0At_fn..1#3D.5#0At_v1..1#3D.6#0At_v2..1
#3D.7#0Atcb_upb#3D.7#0A.#0Abufsize.#3D.3#0A.#0Apktb
it..7#3D.1#0Awaitbit..6#3D.2#0Aholdbit..6#3D.4#0A.#0A
notpktbit..4#3D.NOT.pktbit#0Anotwaitbit..3#3D.NOT.w
aitbit#0Anotholdbit..3#3D.NOT.holdbit#0A.#0As_run..
8#3D.0#0As_runpkt..5#3D.pktbit#0As_wait..7#3D.waitb
it#0As_waitpkt..4#3D.waitbit.+.pktbit#0As_hold..7#3D
.holdbit#0As_holdpkt..4#3D.holdbit.+.pktbit#0As_hol
dwait..3#3D.holdbit.+.waitbit#0As_holdwaitpkt..#3D.
holdbit.+.waitbit.+.pktbit#0A.#0Ak_dev..1#3D.1001#0A
k_work..#3D.1000001#0A$)#0A.#0AGLOBAL.$(#0Atasktab.
.:.250#0Atasklist.:.251#0Atcb..4:.252#0Ataskid..1:.
253#0Av1..5:.254#0Av2..5:.255#0A.#0Atrace..2:.259#0A
schedule.:.260#0Aqpkt..3:.261#0Await..3:.262#0Ahold
self.:.263#0Arelease..:.264#0A.#0Aidlefn..1:.270#0A
workfn..1:.271#0Ahandlerfn:.272#0Adevfn..2:.273#0A.
#0Aqpktcount:.280#0Aholdcount:.281#0Atracing..:.282
#0Alayout..1:.283#0A$)#0A.#0A//#2E#0A.#0A//SECTION.
"main"#0A.#0A//GET."HDR"#0A#0ALET.start().#3D.VALOF
#0A$(.LET.wkq.#3D.0#0A#0A..1writef("*Nbench.mark.st
arting,.Count#3D%n*N",.Count)#0A.#0A..1tasktab.:#3D
.getvec(tasktab_upb)#0A..1tasktab!0.:#3D.tasktab_up
b#0A..1FOR.taskno.#3D.1.TO.tasktab_upb.DO.tasktab!t
askno.:#3D.0#0A.#0A..1tasklist.:#3D.0#0A.#0A..1crea
tetask(i_idle,.0,.wkq,.s_run,.idlefn,.1,.Count)#0A.
#0A..1wkq.:#3D.pkt(0,..0010,.k_work)#0A..1wkq.:#3D.
pkt(wkq,.0,.k_work)#0A..1createtask(i_work,.1001,.w
kq,.s_waitpkt,.workfn,.i_handlera,.0)#0A.#0A..1wkq.
:#3D.pkt(0,..1i_deva,.k_dev)#0A..1wkq.:#3D.pkt(wkq,
.i_deva,.k_dev)#0A..1wkq.:#3D.pkt(wkq,.i_deva,.k_de
v)#0A..1createtask(i_handlera,.2001,.wkq,.s_waitpkt
,.handlerfn,.0,.0)#0A.#0A..1wkq.:#3D.pkt(0,..1i_dev
b,.k_dev)#0A..1wkq.:#3D.pkt(wkq,.i_devb,.k_dev)#0A.
.1wkq.:#3D.pkt(wkq,.i_devb,.k_dev)#0A..1createtask(
i_handlerb,.3001,.wkq,.s_waitpkt,.handlerfn,.0,.0)#0A
.#0A..1wkq.:#3D.0#0A..1createtask(i_deva,.4001,.wkq
,.s_wait,.devfn,.0,.0)#0A..1createtask(i_devb,.5001
,.wkq,.s_wait,.devfn,.0,.0)#0A.#0A..1tcb.:#3D.taskl
ist#0A.#0A..1qpktcount,.holdcount.:#3D.0,.0#0A.#0A.
.1writes("*Nstarting*N")#0A//.writef("starting.time
.#3D.%n*N",.time())#0A..1tracing,.layout.:#3D.FALSE
,.0#0A..1schedule()#0A..1writes("*Nfinished*N")#0A/
/.writef("*Nfinishing.time.#3D.%n*N",.time())#0A.#0A
..1writef("qpkt.count.#3D.%n..holdcount.#3D.%n*N",#0A
..9qpktcount,..5holdcount)#0A.#0A..1writes("these.r
esults.are.")#0A..1TEST.qpktcount#3DQpktcountval.&.
holdcount#3DHoldcountval#0A..1THEN.writes("correct"
)#0A..1ELSE.writes("incorrect")#0A.#0A..1writes("*N
end.of.run*N")#0A..1RESULTIS.0#0A$)#0A.#0AAND.creat
etask(id,.pri,.wkq,.state,.fn,.v1,.v2).BE#0A$(.LET.
t.#3D.getvec(tcb_upb)#0A..1tasktab!id.:#3D.t..//.in
sert.in.the.task.table#0A..1t_link!t.:#3D.tasklist#0A
..1t_id!t..1:#3D.id#0A..1t_pri!t..:#3D.pri#0A..1t_w
kq!t..:#3D.wkq#0A..1t_state!t:#3D.state#0A..1t_fn!t
..1:#3D.fn#0A..1t_v1!t..1:#3D.v1#0A..1t_v2!t..1:#3D
.v2#0A..1tasklist.:#3D.t#0A$)#0A.#0AAND.pkt(link,.i
d,.kind).#3D.VALOF#0A$(.LET.p.#3D.getvec(pkt_upb)#0A
..1FOR.i.#3D.0.TO.pkt_upb.DO.p!i.:#3D.0#0A..1p_link
!p..2:#3D.link#0A..1p_id!p..4:#3D.id#0A..1p_kind!p.
.2:#3D.kind#0A..1RESULTIS.p#0A$)#0A.#0A.#0AAND.trac
e(ch).BE#0A$(.layout.:#3D.layout.-.1#0A..1IF.layout
<#3D0.DO#0A..1$(.newline()#0A..4layout.:#3D.50#0A..
1$)#0A..1wrch(ch)#0A..1ch.:#3D.7#0A$)#0A.#0A//#2E#0A
.#0A//SECTION."bench"#0A.#0A//GET."HDR"#0A.#0ALET.s
chedule().BE.UNTIL.tcb#3D0.DO#0A//..20*106600005#0A
$(.LET.pkt,.newtcb.#3D.0,.?#0A//.*106600004#0A#0A..
1SWITCHON.t_state!tcb.INTO#0A..1$(.CASE.s_waitpkt:.
.2pkt.:#3D.t_wkq!tcb#0A//..21*23250#0A..23t_wkq!tcb
.:#3D.p_link!pkt#0A..23t_state!tcb.:#3D.t_wkq!tcb#3D
0.->.s_run,.s_runpkt#0A//..21*23250..22*14760.*8490
#0A..4CASE.s_run:#0A..4CASE.s_runpkt:..3taskid,.v1,
.v2.:#3D.t_id!tcb,.t_v1!tcb,.t_v2!tcb#0A//..21*6579
0#0A..23IF.tracing.DO.trace(taskid+'0')#0A//..35*0#0A
..23newtcb.:#3D.(t_fn!tcb)(pkt)#0A//..21*65790#0A..
23t_v1!tcb,.t_v2!tcb.:#3D.v1,.v2#0A..23tcb.:#3D.new
tcb#0A..23LOOP#0A.#0A..4CASE.s_wait:#0A..4CASE.s_ho
ld:#0A..4CASE.s_holdpkt:#0A..4CASE.s_holdwait:#0A..
4CASE.s_holdwaitpkt:tcb.:#3D.t_link!tcb#0A//..21*40
814#0A..23LOOP#0A.#0A..4DEFAULT:..9RETURN#0A//..21*
0#0A..1$)#0A$)#0A.#0AAND.qpkt(pkt).#3D.VALOF#0A$(.L
ET.t.#3D.findtcb(p_id!pkt)#0A//.*23246#0A..1IF.t#3D
0.RESULTIS.0#0A//..6*0#0A..1qpktcount.:#3D.qpktcoun
t.+.1#0A//.*23246#0A.#0A..1p_link!pkt,.p_id!pkt.:#3D
.0,.taskid#0A//.*23246#0A..1TEST.t_wkq!t#3D0#0A..1T
HEN.$(.t_wkq!t.:#3D.pkt#0A//..7*14759#0A..9t_state!
t.:#3D.t_state!t.|.pktbit#0A..9IF.t_pri!t.>.t_pri!t
cb.RESULTIS.t#0A//..30*3140#0A..6$)#0A..1ELSE.appen
d(pkt,.@.t_wkq!t)#0A//..4*11000619#0A..1RESULTIS.tc
b#0A//.*23246#0A$)#0A.#0AAND.wait().#3D.VALOF#0A$(.
t_state!tcb.:#3D.t_state!tcb.|.waitbit#0A//.*23248#0A
..1RESULTIS.tcb#0A$)#0A.#0AAND.holdself().#3D.VALOF
#0A$(.holdcount.:#3D.holdcount.+.1#0A//.*9297#0A..1
t_state!tcb.:#3D.t_state!tcb.|.holdbit#0A..1RESULTI
S.t_link!tcb#0A$)#0A.#0AAND.release(id).#3D.VALOF#0A
$(.LET.t.#3D.findtcb(id)#0A//.*992#0A..1IF.t#3D0.RE
SULTIS.0#0A//..6*0#0A.#0A..1t_state!t.:#3D.t_state!
t.&.notholdbit#0A//.*992#0A..1IF.t_pri!t.>.t_pri!tc
b.RESULTIS.t#0A//..22*992#0A..1RESULTIS.tcb#0A//.*0
#0A$)#0A.#0AAND.findtcb(id).#3D.VALOF#0A$(.LET.t.#3D
.0#0A//.*33000245#0A..1IF.1.<#3D.id.<#3D.tasktab!0.
DO.t.:#3D.tasktab!id#0A//..26*33000245#0A..1IF.t#3D
0.DO.writes("*Nbad.task.id*N")#0A//..9*0#0A..1RESUL
TIS.t#0A//.*33000245#0A$)#0A.#0AAND.idlefn(pkt).#3D
.VALOF#0A$(.v2.:#3D.v2.-.1#0A//.*1002#0A..1IF.v2#3D
0.RESULTIS.holdself()#0A//..7*1#0A..1TEST.(v1&1)#3D
0#0A//.*992#0A..1THEN.$(.v1.:#3D.v1>>0001#0A//..7*5
000007#0A..9RESULTIS.release(i_deva)#0A..6$)#0A..1E
LSE.$(.v1.:#3D.v1>>0001.XOR.#23XD000008#0A//..7*499
0002#0A..9RESULTIS.release(i_devb)#0A..6$)#0A$)#0A.
#0AAND.workfn(pkt).#3D.VALOF.TEST.pkt#3D0#0A//..20*
4654#0A..1THEN.RESULTIS.wait()#0A//..4*2327#0A..1EL
SE.$(.LET.buf.#3D.@.p_a2!pkt#0A//..7*2327#0A..9v1.:
#3D.i_handlera.+.i_handlerb.-.v1#0A..9//.v1.is.alte
rnately.i>handlera.AND.i_handlerb#0A.#0A..9p_id!pkt
.:#3D.v1..1//.set.the.destination.task.id#0A..9p_a1
!pkt.:#3D.0..2//.set.the.buffer.subscript#0A..9FOR.
i.#3D.0.TO.bufsize.DO#0A..9$(.v2.:#3D.v2.+.1#0A//..
10*9308#0A..12IF.v2>26.DO.v2.:#3D.1#0A//..22*358#0A
..12buf%i.:#3D."ABCDEFGHIJKLMNOPQRSTUVWXYZ"%v2#0A..
9$)#0A..9RESULTIS.qpkt(pkt)#0A//..7*2327#0A..6$)#0A
.#0AAND.handlerfn(pkt).#3D.VALOF#0A$(.UNLESS.pkt#3D
0.DO.append(pkt,.p_kind!pkt#3Dk_work.->.@v1,..@v2)#0A
//.*23252..8*11000627..25*2327.*9300#0A..1UNLESS.v1
#3D0.DO#0A//.*23252#0A..1$(.LET.workpkt.#3D.v1#0A//
..2*20310#0A..4LET.count,.buf.#3D.p_a1!workpkt,.@.p
_a2!workpkt#0A..4IF.count>bufsize.DO#0A..4$(.v1.:#3D
.p_link!v1#0A//..5*2325#0A..7RESULTIS.qpkt(workpkt)
..//.send.back.the.exhausted.a.work.packet#0A..4$)#0A
..4UNLESS.v2#3D0.DO#0A//..2*17985#0A..4$(.LET.devpk
t.#3D.v2#0A..7v2.:#3D.p_link!v2#0A..7p_a1!devpkt.:#3D
.buf%count..//.copy.character.into.it#0A..7p_a1!wor
kpkt.:#3D.count+1..1//.incrementing.the.character.c
ount#0A..7RESULTIS.qpkt(devpkt)..3//.send.the.packe
t.to.the.device.task#0A..4$)#0A..1$)#0A.#0A..1//.ca
nnot.proceed.for.lack.of.a.packet.so.wait.for.one#0A
..1RESULTIS.wait()#0A//.*11000627#0A$)#0A.#0AAND.de
vfn(pkt).#3D.VALOF.TEST.pkt#3D0#0A//..13*27880004#0A
..2THEN.$(.IF.v1#3D0.RESULTIS.wait()#0A//..8*18588.
.*9294#0A..10pkt.:#3D.v1#0A//..8*9294#0A..10v1.:#3D
.0#0A..10RESULTIS.qpkt(pkt)#0A..7$)#0A..2ELSE.$(.v1
.:#3D.pkt#0A//..8*9296#0A..10IF.tracing.DO.trace(p_
a1!pkt)#0A..10RESULTIS.holdself()#0A..7$)#0A.#0AAND
.append(pkt,.ptr).BE#0A$(.p_link!pkt.:#3D.0#0A//.*2
0110004#0A..1UNTIL.!ptr#3D0.DO.ptr.:#3D.!ptr#0A//..
5*39877..2*10467#0A..1!ptr.:#3D.pkt#0A//.*20110004#0A
$)#0A

######com/bgpm.b#
SECTION."bgpm"#0A#0AGET."libhdr"#0A#0AGLOBAL.{#0As:
ug;.t;.h;.p;.f;.c;.e#0Ach;.sysin;.sysout;.fromstrea
m;.tostream#0Abase;.upb;.rec_p;.rec_l#0Agetch;.putc
h;.wrn;.error#0Aexp;.bexp;.wrc;.wrs;.chpos#0Atracin
g#0A}#0A#0AMANIFEST.{#0As_eof.#3D.-1;.s_eom.#3D.-2;
.s_def.#3D.-3;.s_set.#3D.-4;.s_eval.#3D.-5#0As_lquo
te.#3D.-6;.s_rquote.#3D.-7#0A#0Ac_call..1#3D.'[';.c
_apply..#3D.']';.c_sep.#3D.'\';.c_skip.#3D.'`'.#0Ac
_lquote.#3D.'{';.c_rquote.#3D.'}';.c_arg.#3D.'^'#0A
}#0A#0ALET.start().#3D.VALOF#0A{.LET.argv.#3D.VEC.4
0#0A#0A..IF.rdargs("FROM,TO/K,UPB/K/N,-t/S",.argv,.
40)#3D0.DO#0A..{.writes("Bad.arguments.for.BGPM*n")
;.RESULTIS.20.}#0A#0A..upb.:#3D.2_001_001#0A..IF.ar
gv!2.DO.upb.:#3D.!(argv!2)..11//.UPB/K/N#0A..IF.upb
<500.DO.upb.:#3D.500#0A..base.:#3D.getvec(upb)#0A..
IF.base#3D0.DO#0A..{.writef("Unable.to.allocate.wor
k.space.(upb.#3D.%n)*n",.upb)#0A..2RESULTIS.20#0A..
}#0A#0A..tracing.:#3D.argv!3..23//.-t/S#0A#0A..sysi
n.:#3D.input()#0A..fromstream.:#3D.sysin#0A..UNLESS
.argv!0#3D0.DO..22//.FROM#0A..{.fromstream.:#3D.fin
dinput(argv!0)#0A..2IF.fromstream#3D0.DO#0A..2{.wri
tef("Unable.to.read.file.%s*n",.argv!0);.RESULTIS.2
0.}#0A..}#0A..selectinput(fromstream)#0A#0A..sysout
.:#3D.output()#0A..tostream.:#3D.sysout#0A..UNLESS.
argv!1#3D0.DO..22//.TO/K#0A..{.tostream.:#3D.findou
tput(argv!1)#0A..2IF.tostream#3D0.DO#0A..2{.writef(
"Unable.to.write.to.file.%s*n",.argv!1)#0A..4UNLESS
.fromstream#3Dsysin.DO.endread()#0A..4RESULTIS.20.}
#0A..}#0A..selectoutput(tostream)#0A#0A..bgpm()#0A#0A
..UNLESS.fromstream#3Dsysin.DO.endread()#0A..UNLESS
.tostream#3Dsysout..DO.endwrite()#0A..selectinput(s
ysin)#0A..selectoutput(sysout)#0A..freevec(base)#0A
..RESULTIS.0#0A}#0A#0AAND.putch(ch).BE.TEST.h#3D0.T
HEN.wrch(ch).ELSE.push(ch)#0A#0AAND.push(ch).#3D.VA
LOF.{.IF.t#3Ds.DO.error("Insufficient.work.space")#0A
..21s.:#3D.s.+.1#0A..21!s.:#3D.ch#0A..21RESULTIS.s#0A
..19}#0A#0AAND.getch().#3D.VALOF#0A{.LET.ch.#3D.?#0A
..IF.c.DO.{.c.:#3D.c+1;.RESULTIS.!c.}#0A#0A..ch.:#3D
.rdch()#0A#0A..WHILE.ch#3Dc_skip.DO#0A..{.//.Ignore
.all.character.until.the.end.of.the.line#0A..2ch.:#3D
.rdch().REPEATUNTIL.ch#3D'*n'.|.ch#3D'*p'.|.ch#3Den
dstreamch#0A..2//.Now.ignore.all.white.space.charac
ters#0A..2WHILE.ch#3D'*n'.|.ch#3D'*p'.|.ch#3D'*s'.|
.ch#3D'*t'.DO.ch.:#3D.rdch()#0A..}#0A#0A..RESULTIS.
ch#0A}#0A#0AAND.arg(a,.n).#3D.VALOF.{.IF.!a<0.DO.er
ror("Too.few.arguments")#0A..22IF.n#3D0.RESULTIS.a#0A
..22a,.n.:#3D.a+!a+1,.n-1#0A..20}.REPEAT#0A#0AAND.l
ookup(a).#3D.VALOF#0A{.LET.q,.i,.len.#3D.e,.0,.!a#0A
..UNTIL.q#3D0.|.i>len.TEST.q!(i+2)#3Da!i.THEN.i.:#3D
.i+1#0A..35ELSE.q,.i.:#3D.!q,.0#0A..IF.q#3D0.DO.err
or("Macro.not.defined")#0A..RESULTIS.q#0A}#0A#0AAND
.define(name,.code).BE#0A{.//.Define.a.builtin.macr
o#0A..LET.s1.#3D.s#0A..push(e);.push(t)#0A..FOR.i.#3D
.0.TO.name%0.DO.push(name%i)#0A..push(1);.push(code
);.push(s_eom)#0A..UNTIL.s#3Ds1.DO.{.!t.:#3D.!s;.t,
.s.:#3D.t-1,.s-1.}#0A..e.:#3D.t+1#0A}#0A#0AAND.bgpm
(v,.n).BE#0A{.rec_p,.rec_l.:#3D.level(),.ret#0A#0A.
.s,.t,.h,.p,.f,.e,.c.:#3D.base-1,.base+upb,.0,.0,.0
,.0,.0#0A#0A..define("def",..3s_def)#0A..define("se
t",..3s_set)#0A..define("eval",..2s_eval)#0A..defin
e("lquote",..s_lquote)#0A..define("rquote",..s_rquo
te)#0A..define("eof",..3s_eof)#0A#0A..{.ch.:#3D.get
ch()..10//.Start.of.main.scanning.loop#2E#0A#0Asw:.
SWITCHON.ch.INTO#0A..2{.DEFAULT:.putch(ch);.LOOP#0A
#0A..4CASE.c_lquote:..3//.{#0A//writef("lquote*n")#0A
..4{.LET.d.#3D.1#0A..6{.ch.:#3D.getch()#0A..8IF.ch<
0.DO.error("Non.character.in.quoted.string")#0A..8I
F.ch#3Dc_lquote.DO..2d.:#3D.d+1#0A..8IF.ch#3Dc_rquo
te.DO.{.d.:#3D.d-1;.IF.d#3D0.BREAK.}#0A..8putch(ch)
#0A..6}.REPEAT#0A//writef("rquote*n")#0A..6LOOP#0A.
.4}#0A#0A..4CASE.c_call:..4//.[#0A//writef("Call*n"
)#0A..6//.NEW:.save.current.e.and.t.so.that.definit
ions.created#0A..6//.by.the.call.can.be.preserved.w
hile.local.definitions#0A..6//.are.removed#2E..See.
s_eom#2E#0A..6f.:#3D.push(f);.push(h);.push(e);.pus
h(t)#0A..6h.:#3D.push(?)#0A..6LOOP#0A#0A..4CASE.c_s
ep:..5//.\#0A//writef("Sep*n")#0A..6IF.h#3D0.DO.{.p
utch(ch);.LOOP.}#0A..6!h.:#3D.s-h#0A..6h.:#3D.push(
?)#0A..6LOOP#0A#0A..4CASE.c_arg:..5//.^#0A//writef(
"Arg*n")#0A..6IF.p#3D0.DO.{.putch(ch);.LOOP.}#0A..6
ch.:#3D.getch()#0A..6{.LET.a.#3D.arg(p+4,.rdn())#0A
..8FOR.q.#3D.a+1.TO.a+!a.DO.putch(!q)#0A..6}#0A..6G
OTO.sw#0A#0A..4CASE.c_apply:..3//.]#0A//writef("App
ly*n")#0A..4{.LET.a.#3D.f#0A..6IF.h#3D0.DO.{.putch(
ch);.LOOP.}#0A..6!h.:#3D.s-h#0A..6push(s_eom)#0A..6
f,.h.:#3D.a!0,.a!1#0A..6a!0,.a!1.:#3D.p,.c.//.a!2,.
a!3.contain.e,.t.when.[.was.encountered#0A..6{.!t.:
#3D.!s;.t,.s.:#3D.t-1,.s-1.}.REPEATUNTIL.s<a#0A..6p
.:#3D.t+1#0A..6c.:#3D.arg(lookup(p+4)+2,.1)#0A#0A..
6IF.tracing.DO#0A..6{.LET.i.#3D.0#0A..8LET.a.#3D.p+
4.//.Pointer.to.arg.0#0A..8writef("*nCalling.macro*
n")#0A..8UNTIL.!a<0.DO#0A..8{.writef("arg.%i2:.",.i
)#0A..10wrarg(a)#0A..10newline()#0A..10a.:#3D.a.+.!
a.+.1#0A..10i.:#3D.i+1#0A..8}#0A//prstate()#0A..6}#0A
..6LOOP#0A..4}#0A#0A..4CASE.s_lquote:.putch(c_lquot
e);.LOOP#0A..4CASE.s_rquote:.putch(c_rquote);.LOOP#0A
..7#0A..4CASE.s_eof:.RETURN#0A#0A..4CASE.s_eom:#0A/
/writef("Eom*n")#0Aret:..2IF.p#3D0.LOOP#0A..4{.LET.
a.#3D.t#0A..6LET.q.#3D.p-1#0A..6LET.n.#3D.p!3.-.p.+
.1.//.This.is.the.distance.that.the.new#0A..26//.de
finitions.will.be.moved.by,.as#0A..26//.a.result.of
.removing.the.call.and#0A..26//.local.definitions#2E
#0A..6!a.:#3D.e#0A#0A..6{.LET.na.#3D.!a#0A..8IF.na>
p.BREAK#0A..8//.na.points.to.a.new.definition#0A..8
!a.:#3D.na.+.n..//.Adjust.this.pointer#0A..8a.:#3D.
na#0A..6}.REPEAT#0A#0A..6!a.:#3D.p!2.//.Unlink.the.
local.definitions.from.the.chain,.if.any#2E#0A..6e.
:#3D.!t..1//.Get.the.(possible).new.e#2E#0A..6#0A..
6a.:#3D.t#0A..6t.:#3D.p!3#0A..6c.:#3D.p!1#0A..6p.:#3D
.p!0#0A#0A..6//.Copy.the.new.definitions,.if.any#2E
#0A..6UNTIL.q<#3Da.DO#0A..6{.!t.:#3D.!q#0A..8t,.q.:
#3D.t-1,.q-1#0A..6}#0A#0A//prstate()#0A..6LOOP#0A..
4}#0A#0A..4CASE.s_def:#0A//writef("Def*n")#0A..4{.L
ET.a1.#3D.arg(p+4,.1)#0A..6LET.a2.#3D.arg(p+4,.2)#0A
..6LET.ne.#3D.a1.-.2..//.ne.->.[e0,.end,.<name>.<va
l>.]#0A..6//.Find.end.of.definition#0A..6LET.q.#3D.
p+4#0A..6UNTIL.!q<0.DO.q.:#3D.q+!q+1#0A..6//.q.poin
ts.to.the.eom.at.the.end.of.the.call#2E#0A..6//.Put
.eom.at.end.of.second.argument#2E#0A..6a2!(!a2+1).:
#3D.s_eom#0A..6ne!0,.ne!1.:#3D.e,.q#0A..6e.:#3D.ne#0A
..6c,.t.:#3D.p!1,.e-1#0A..6p..2:#3D.p!0#0A//writef(
"def:.e#3D%n.",.e)#0A//item(a1)#0A//newline()#0A..6
LOOP#0A..4}#0A#0A..4CASE.s_set:#0A//writef("Set*n")
#0A..4{.LET.name.#3D.arg(p+4,.1)#0A..6LET.val..#3D.
arg(p+4,.2)#0A..6LET.len.#3D.!val#0A..6LET.a.#3D.lo
okup(name)#0A..6LET.b.#3D.arg(a+2,.1)#0A..6LET.max.
#3D.a!1.-.b.-.1..//.Max.length.of.the.value#2E#0A..
6IF.len>max.DO.error("New.value.too.long")#0A..6FOR
.i.#3D.0.TO.len.DO.b!i.:#3D.val!i#0A..6b!(len+1).:#3D
.s_eom#0A..6GOTO.ret#0A..4}#0A#0A..4CASE.s_eval:#0A
//writef("Eval*n")#0A..6c..:#3D.arg(p+4,.1)#0A..6wr
n(exp(0))#0A..6GOTO.ret#0A..2}#0A..}.REPEAT#0A}#0A#0A
AND.rdn().#3D.VALOF.{.LET.val.#3D.0#0A..18WHILE.'0'
<#3Dch<#3D'9'.DO.{.val.:#3D.10*val.+.ch.-.'0'#0A..4
2ch.:#3D.getch()#0A..40}#0A..18RESULTIS.val#0A..16}
#0A#0AAND.bexp().#3D.VALOF#0A{.ch.:#3D.getch()#0A#0A
..SWITCHON.ch.INTO#0A..{.DEFAULT:#0A..4error("Bad.e
xpression")#0A#0A..2CASE.'0':.CASE.'1':.CASE.'2':.C
ASE.'3':.CASE.'4':#0A..2CASE.'5':.CASE.'6':.CASE.'7
':.CASE.'8':.CASE.'9':#0A..4RESULTIS..rdn()#0A#0A..
2CASE.'+':.RESULTIS..exp(2)#0A..2CASE.'-':.RESULTIS
.-exp(2)#0A#0A..2CASE.'(':.{.LET.res.#3D.exp(1)#0A.
.14ch.:#3D.getch()#0A..14RESULTIS.res#0A..12}#0A..}
#0A}#0A#0AAND.exp(n).#3D.VALOF#0A{.LET.a.#3D.bexp()
#0A#0A..{.SWITCHON.ch.INTO#0A..2{.DEFAULT:..1IF.n>1
.|.n#3D1.&.ch#3D')'.|.n#3D0.&.ch#3Ds_eom.RESULTIS.a
#0A..15error("Bad.expression")#0A..4CASE.'**':.IF.n
<3.DO.{.a.:#3D.a..*..exp(3);.LOOP.};.RESULTIS.a#0A.
.4CASE.'/':..IF.n<3.DO.{.a.:#3D.a../..exp(3);.LOOP.
};.RESULTIS.a#0A..4CASE.'%':..IF.n<3.DO.{.a.:#3D.a.
REM.exp(3);.LOOP.};.RESULTIS.a#0A..4CASE.'+':..IF.n
<2.DO.{.a.:#3D.a..+..exp(2);.LOOP.};.RESULTIS.a#0A.
.4CASE.'-':..IF.n<2.DO.{.a.:#3D.a..-..exp(2);.LOOP.
};.RESULTIS.a#0A..2}#0A..}.REPEAT#0A}#0A#0AAND.wrn(
n).BE.{.IF.n<0.DO.{.putch('-');.n.:#3D.-n.}#0A..14I
F.n>9.DO.wrn(n/10)#0A..14putch(n.REM.10.+.'0')#0A..
12}#0A#0AAND.wrc(ch).BE#0A{.IF.ch#3D'*n'.DO.{.newli
ne();.chpos.:#3D.0;.RETURN.}#0A..IF.chpos>70.DO.wrc
('*n')#0A..UNLESS.'*s'<#3Dch<127.DO.ch.:#3D.'?'..//
.Assume.7.bit.ASCII#2E#0A..wrch(ch)#0A..chpos.:#3D.
chpos+1#0A}#0A#0AAND.wrs(s).BE.FOR.i.#3D.1.TO.s%0.D
O.wrc(s%i)#0A#0AAND.error(mess).BE#0A{.selectoutput
(sysout)#0A..wrs("*nError:.");.wrs(mess)#0A..wrs("*
nIncomplete.calls:.")#0A..TEST.f#3D0.THEN.wrs("none
").ELSE.prcall(20,.f,.h,.s)#0A..wrs("*nActive.calls
:*n");.btrace(p,.20)#0A..wrs("Environment:*n");..wr
env(e,.4)#0A..wrs("End.of.error.message*n")#0A..sel
ectoutput(tostream)#0A..longjump(rec_p,.rec_l)#0A}#0A
#0AAND.prcall(n,.f,.h,.s).BE.UNLESS.f#3D0.TEST.n#3D
0#0A..35THEN.wrs("#2E#2E1")#0A..35ELSE.{.prcall(n-1
,.!f,.f!1,.f-1)#0A..43!h.:#3D.s-h#0A..43wrcall(f+4,
.s)#0A..40}#0A#0AAND.btrace(p,.n).BE#0A{.IF.n#3D0.D
O.wrs("#2E#2E1*n")#0A..IF.p#3D0.|.n#3D0.RETURN#0A..
wrcall(p+4,.p!3);.wrc(c_apply);.wrc('*n')#0A..p,.n.
:#3D.!p,.n-1#0A}.REPEAT#0A#0AAND.wrcall(a,.b).BE#0A
{.LET.sep.#3D.c_call#0A..UNTIL.a>#3Db.DO.{.wrc(sep)
;.wrarg(a)#0A..16a.:#3D.a.+.!a.+.1#0A..16sep.:#3D.c
_sep#0A..14}#0A}#0A#0AAND.wrarg(a).BE.FOR.ptr.#3D.a
+1.TO.a.+.!a.DO.wrc(!ptr)#0A#0AAND.wrenv(e,.n).BE.U
NLESS.n#3D0.|.e#3D0.DO#0A{.wrs("Name:.");..2wrarg(a
rg(e+2,.0))#0A..wrs("..Value:.");.wrarg(arg(e+2,.1)
)#0A..wrc('*n')#0A..wrenv(!e,.n-1)#0A}#0A#0AAND.prs
tate().BE#0A{.writef("*nS.Stack..2f#3D%n.h#3D%n.s#3D
%n*n",.f,.h,.s,.t,.p,.e)#0A..FOR.q.#3D.base.TO.s.DO
#0A..{.LET.x.#3D.!q#0A..2IF.(q-base).MOD.10.#3D.0.D
O.writef("*n%i7:",.q)#0A..2writef(".%i7",.x)#0A..2T
EST.32<#3Dx<#3D127#0A..2THEN.writef("#3D%c",.x)#0A.
.2ELSE.writef("..")#0A..}#0A..newline()#0A#0A..writ
ef("*nT.Stack..2t#3D%n.p#3D%n.e#3D%n*n",.t,.p,.e)#0A
..FOR.q.#3D.t+1.TO.base+upb.DO#0A..{.LET.x.#3D.!q#0A
..2IF.(q-t-1).MOD.10.#3D.0.DO.writef("*n%i7:",.q)#0A
..2writef(".%i7",.x)#0A..2TEST.32<#3Dx<#3D127#0A..2
THEN.writef("#3D%c",.x)#0A..2ELSE.writef("..")#0A..
}#0A..newline()#0A#0A..writef("Def.chain*n")#0A..{.
LET.q.#3D.e#0A#0A..2{.LET.a.#3D.q+2..//.Macro.name#0A
..4writef("%i7:.",.q)#0A..4item(a)#0A..4writef(".#3D
.")#0A..4item(a+!a+1).//.Macro.value#0A..4newline()
#0A..4q.:#3D.!q..4//.next.defition#0A..2}.REPEATWHI
LE.q#0A#0Aabort(1001)#0A..}#0A}#0A#0AAND.item(x).BE
.FOR.q.#3D.x+1.TO.x+!x.DO#0A{.LET.ch.#3D.!q#0A..TES
T.32<#3Dch<127#0A..THEN.writef("%c",.ch)#0A..ELSE.w
ritef(".%n.",.ch)#0A}#0A#0A

######com/bin2n.b#
GET."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.LET.std
in.#3D.input()#0A..LET.stdout.#3D.output()#0A..LET.
argv.#3D.VEC.50#0A..LET.inname,.instream.#3D."data"
,.0#0A..LET.outname,.outstream.#3D."res",.0#0A..LET
.length.#3D.0#0A#0A..UNLESS.rdargs("FROM/A,TO/K",.a
rgv,.50).DO#0A..{.writef("Bad.arguments.for.BIN2N*n
")#0A..2RESULTIS.0#0A..}#0A#0A..IF.argv!0.DO.inname
..:#3D.argv!0#0A..IF.argv!1.DO.outname.:#3D.argv!1#0A
#0A..instream.:#3D.findinput(inname)#0A..outstream.
:#3D.findoutput(outname)#0A#0A..UNLESS.instream.DO#0A
..{.writef("Cannot.open.file.%s*n",.inname)#0A..2GO
TO.fin#0A..}#0A#0A..UNLESS.outstream.DO#0A..{.write
f("Cannot.open.file.%s*n",.outname)#0A..2GOTO.fin#0A
..}#0A#0A..selectinput(instream)#0A..selectoutput(o
utstream)#0A#0A..writef("*n12345*n")..2//.Begin.mar
ker#0A#0A..{.LET.ch.#3D.binrdch()#0A..2IF.ch#3Dends
treamch.BREAK#0A..2length.:#3D.length+1#0A..2IF.len
gth.MOD.20.#3D.0.DO.newline()#0A..2writef(".%n",.ch
)#0A..}.REPEAT#0A#0A..writef("*n23456*n")..2//.End.
marker#0A#0Afin:#0A..IF.instream..UNLESS.instream#3D
stdin..1DO.endstream(instream)#0A..IF.outstream.UNL
ESS.outstream#3Dstdout.DO.endstream(outstream)#0A..
selectinput(stdin)#0A..selectoutput(stdout)#0A#0A..
writef("%s.length.%n.#3D>.%s.written*n",.inname,.le
ngth,.outname)#0A..RESULTIS.0#0A}#0A

######com/bin-hex.b#
//.This.is.a.program.convert.a.binary.file.to.hex.f
or.editing#0A//.Implemented.by.Martin.Richards.(c).
July.2000002#0A#0A//.Usage:#0A#0A//.bin2hex.filenam
e.[[TO].tofile]#0A#0A/*#0AIt.will.convert.the.file:
#0A#0AABCDEFGHIJKLMNOPQRSTUVWXYZ#0A1234567890#0A#0A
to:#0A#0A00041.42.43.44.45.46.47.48.49.4A.4B.4C.4D.
4E.4F.50#0A51.52.53.54.55.56.57.58.59.5A.0A.31.32.3
3.34.35#0A36.37.38.39.30.0A#0A*/#0A#0AGET."libhdr"#0A
#0AGLOBAL.{.eof:.ug.}#0A#0ALET.start().BE#0A{.LET.a
rgv..5#3D.VEC.50#0A..LET.sysin..4#3D.input()#0A..LE
T.sysout..3#3D.output()#0A..LET.fromname..1#3D.0#0A
..LET.toname..3#3D.0#0A..LET.fromstream.#3D.0#0A..L
ET.tostream..1#3D.0#0A..LET.count.#3D.0#0A#0A..UNLE
SS.rdargs("FROM/A,TO/K",.argv,.50).DO#0A..{.writes(
"bad.arguments.for.bin2hex*n")#0A..2stop(20)#0A..}#0A
#0A..fromname.:#3D.argv!0..20//.FROM#0A..toname..1:
#3D.argv!1..20//.TO#0A.#0A..fromstream.:#3D.findinp
ut(fromname)#0A..UNLESS.fromstream.DO#0A..{.writef(
"can't.open.%s*n",.fromname)#0A..2stop(20)#0A..}#0A
#0A..IF.toname.DO#0A..{.tostream.:#3D.findoutput(to
name)#0A..2UNLESS.tostream.DO#0A..2{.writef("can't.
open.%s*n",.toname)#0A..4endread()#0A..4stop(20)#0A
..2}#0A..2selectoutput(tostream)#0A..}#0A#0A1..sele
ctinput(fromstream)#0A#0A..{.LET.ch.#3D.0#0A//..2ch
.:#3D.binrdch()#0A..2ch.:#3D.rdch()..12//.rdch.is.f
ine.under.Cintpos#0A..2IF.ch#3Dendstreamch.BREAK#0A
..2IF.count.REM.16.#3D.0.DO.newline()#0A..2writef("
.%x2",.ch)#0A..2count.:#3D.count+1#0A..}.REPEAT#0A#0A
..newline()#0A#0A..endread()#0A#0A..IF.tostream.UNL
ESS.sysout#3Dtostream.DO.endwrite()#0A}#0A

######com/bin-n.b#
//.This.is.a.program.convert.a.binary.file.into.a.s
equence.of#0A//.integers.separated.by.spaces.and.ne
wline#2E#0A#0A//.Implemented.by.Martin.Richards.(c)
.Sept.2000006#0A#0A//.Usage:#0A#0A//.bin-n.filename
.[[TO].tofile]#0A#0A/*#0AIt.will.convert.the.file:#0A
#0AABCDEFGHIJKLMNOPQRSTUVWXYZ#0A1234567890#0A#0Ato:
#0A#0A..00165..00166..00167..00168..00169..00170..0
0171..00172#0A..00173..00174..00175..00176..00177..
00178..00179..00180#0A..00181..00182..00183..00184.
.00185..00186..00187..00188#0A..00189..00190..00110
..00149..00150..00151..00152..00153#0A..00154..0015
5..00156..00157..00148..00110#0A#0A*/#0A#0AGET."lib
hdr"#0A#0AGLOBAL.{#0A.eof:.ug#0A.sysin#0A.sysout#0A
.fromname#0A.toname#0A.fromstream#0A.tostream#0A.co
unt#0A}#0A#0ALET.start().#3D.VALOF#0A{.LET.argv..2#3D
.VEC.50#0A..sysin..4:#3D.input()#0A..sysout..3:#3D.
output()#0A..fromname..1:#3D.0#0A..toname..3:#3D."J
UNK"#0A..fromstream.:#3D.0#0A..tostream..1:#3D.0#0A
..count..4:#3D.0#0A#0A..UNLESS.rdargs("FROM/A,TO/K"
,.argv,.50).DO#0A..{.writes("bad.arguments.for.bin-
n*n")#0A..2stop(20)#0A..}#0A#0A..fromname.:#3D.argv
!0..20//.FROM#0A..IF.argv!1.DO.toname..1:#3D.argv!1
..7//.TO#0A.#0A..fromstream.:#3D.findinput(fromname
)#0A..UNLESS.fromstream.DO#0A..{.writef("can't.open
.%s*n",.fromname)#0A..2stop(20)#0A..}#0A#0A..tostre
am.:#3D.findoutput(toname)#0A..UNLESS.tostream.DO#0A
..{.writef("can't.open.%s*n",.toname)#0A..2endread(
)#0A..2stop(20)#0A..}#0A..selectoutput(tostream)#0A
#0A..selectinput(fromstream)#0A#0A..{.LET.word.#3D.
0#0A..2LET.s.#3D.@word#0A..2LET.byte.#3D.binrdch()#0A
..2IF.byte#3Dendstreamch.BREAK#0A..2writef(".%i4",.
byte)#0A..2count.:#3D.count+1#0A..2IF.count.REM.8.#3D
.0.DO.newline()#0A..}.REPEAT#0A#0A..UNLESS.count.RE
M.8.#3D.0.DO.newline()#0A#0A..UNLESS.sysout#3Dtostr
eam.DO.endwrite()#0A..endread()#0A#0A..selectoutput
(sysout)#0A..writef("%n.bytes.written.to.file.*"%s*
"*n",.count,.toname)#0A..RESULTIS.0#0A}#0A#0A5

######com/bin-x8.b#
//.This.is.a.program.convert.a.binary.file.into.a.f
ile.of.32-bit.hex.words#2E#0A#0A//.Implemented.by.M
artin.Richards.(c).Aug.2000002#0A#0A//.Usage:#0A#0A
//.bin-x8.filename.[[TO].tofile]#0A#0A/*#0AIt.will.
convert.the.file:#0A#0AABCDEFGHIJKLMNOPQRSTUVWXYZ#0A
1234567890#0A#0Ato:#0A#0A0004400134241.48474645.4C4
B4A49.504F4E4D.54535251.58575655.310A5A59.353433001
2.#0A39383736.003A30.#0A#0A*/#0A#0AGET."libhdr"#0A#0A
GLOBAL.{#0A.eof:.ug#0A.sysin#0A.sysout#0A.fromname#0A
.toname#0A.fromstream#0A.tostream#0A.count#0A}#0A#0A
LET.start().#3D.VALOF#0A{.LET.argv..2#3D.VEC.50#0A.
.sysin..4:#3D.input()#0A..sysout..3:#3D.output()#0A
..fromname..1:#3D.0#0A..toname..3:#3D."JUNK"#0A..fr
omstream.:#3D.0#0A..tostream..1:#3D.0#0A..count..4:
#3D.0#0A#0A..UNLESS.rdargs("FROM/A,TO/K",.argv,.50)
.DO#0A..{.writes("Bad.arguments.for.bin-x8,.format:
.FROM/A,TO/K*n")#0A..2stop(20)#0A..}#0A#0A..fromnam
e.:#3D.argv!0..20//.FROM#0A..IF.argv!1.DO.toname..1
:#3D.argv!1..7//.TO#0A.#0A..fromstream.:#3D.findinp
ut(fromname)#0A..UNLESS.fromstream.DO#0A..{.writef(
"can't.open.%s*n",.fromname)#0A..2stop(20)#0A..}#0A
#0A..tostream.:#3D.findoutput(toname)#0A..UNLESS.to
stream.DO#0A..{.writef("can't.open.%s*n",.toname)#0A
..2endread()#0A..2stop(20)#0A..}#0A..selectoutput(t
ostream)#0A#0A..selectinput(fromstream)#0A#0A..{.LE
T.word.#3D.0#0A..2LET.s.#3D.@word#0A..2LET.ch.#3D.b
inrdch()#0A..2IF.ch#3Dendstreamch.BREAK#0A..2s%0.:#3D
.ch#0A..2ch.:#3D.binrdch()#0A..2IF.ch#3Dendstreamch
.GOTO.wr#0A..2s%1.:#3D.ch#0A..2ch.:#3D.binrdch()#0A
..2IF.ch#3Dendstreamch.GOTO.wr#0A..2s%2.:#3D.ch#0A.
.2ch.:#3D.binrdch()#0A..2IF.ch#3Dendstreamch.GOTO.w
r#0A..2s%3.:#3D.ch#0Awr:#0A..2writef("%x8.",.word)#0A
..2count.:#3D.count+1#0A..2IF.count.REM.8.#3D.0.DO.
newline()#0A..}.REPEAT#0A#0A..UNLESS.count.REM.8.#3D
.0.DO.newline()#0A#0A..UNLESS.sysout#3Dtostream.DO.
endwrite()#0A..endread()#0A#0A..selectoutput(sysout
)#0A..writef("%n.words.written.to.file.*"%s*"*n",.c
ount,.toname)#0A..RESULTIS.0#0A}#0A#0AAND.rdhexword
().#3D.VALOF#0A{.LET.word,.byte.#3D.0,.0#0A..//.Ski
p.initial.white.space#0A..byte.:#3D.rdch().REPEATWH
ILE.byte#3D'.'.|.byte#3D'*n'.|.byte#3D'*c'#0A..resu
lt2.:#3D.-1#0A#0A..{.LET.val.#3D.value(byte)#0A..2U
NLESS.0<#3Dval<#3D15.RESULTIS.word#0A..2word.:#3D.(
word<<0004).+.val#0A..2result2.:#3D.0#0A..2byte.:#3D
.rdch()#0A..2result2.:#3D.0#0A..}.REPEAT#0A}#0A#0AA
ND.value(ch).#3D.'0'<#3Dch<#3D'9'.->.ch.-.'0',#0A..
14'A'<#3Dch<#3D'F'.->.ch.-.'A'.+.10,#0A..14'a'<#3Dc
h<#3D'f'.->.ch.-.'a'.+.10,#0A..014100#0A#0AAND.wrwo
rd(word).BE#0A{.LET.s.#3D.@word#0A..binwrch(s%0)#0A
..binwrch(s%1)#0A..binwrch(s%2)#0A..binwrch(s%3)#0A
}#0A#0A5

######com/bmake.b#
/*#0D#0ADevelopment.of.this.program.has.only.just.s
tarted#2E#0D#0A#0D#0AThis.program.is.a.variant.of.t
he.well.known.make.command.modified#0D#0Ato.run.und
er.cintsys.and.cintpos#2E#0D#0A#0D#0ADesigned.and.i
mplemented.by.Martin.Richards.(c).December.2010#0D#0A
#0D#0ALog#0D#0A#0D#0A18/01/11#0D#0AIt.looks.as.if.b
make.now.works#2E.The.BCPL.compiler.has.been.modifi
ed#0D#0Ato.append.xref.data.when.both.VER.and.XREF.
are.specified#2E#0D#0A#0D#0A10/01/11#0D#0AAdded.-s.
option.to.output.the.rules.after.the.application.of
.the#0D#0Apatterns#2E.Started.to.implement.apply_pa
tterns.and.generate_commands#2E#0D#0A#0D#0A01/12/10
#0D#0AStarted.the.implementation.of.bmake#2E#0D#0A#0D
#0AUsage:#0D#0A#0D#0Abmake."TARGET,FROM#3D-f/K,TO/K
,-m/S,-l/S,-p/S,-r/S,-s/S,-c/S,-d/S"#0D#0A#0D#0ATAR
GET.is.the.target.name.(normally.a.file.name)#2E.Th
e.default.is#0D#0A..5the.target.of.the.first.rule#2E
#0D#0AFROM..1is.the.name.of.the.makefile.(default:.
bmakefile)#0D#0ATO..3specifies.where.the.output.is.
to.be.sent.(default:.standard.output)#0D#0A-m..3out
put.the.makefile.after.macrogeneration#0D#0A-l..3ou
tput.the.lexical.token#2E#0D#0A-p..3output.the.rule
.patterns#2E#0D#0A-r..3output.the.rules.before.the.
application.of.the.rule.patterns#2E#0D#0A-s..3outpu
t.the.rules.after.the.application.of.the.rule.patte
rns#2E#0D#0A..5This.output.includes.the.modify.time
s.of.all.targets.and.items#2E#0D#0A-c..3output.comm
and.sequence.to.bring.the.specified.target.up.to.da
te#2E#0D#0A-d..3output.debugging.trace#2E#0D#0A#0D#0A
The.makefile.is.first.processed.by.the.BGPM.macroge
nerator.with#0D#0Athe.following.special.characters:
#0D#0A#0D#0A%..4Comment.-.skip.all.characters.until
.a.non.white.space.character#0D#0A..5on.a.later.inp
ut.line#2E#0D#0A[..4Start.of.a.new.macro.call#2E#0D
#0A!..4Argument.separator.in.macro.calls#2E#0D#0A#23
..4Argument.item.prefix#2E#0D#0A]..4End.of.macro.ar
gument.list#2E#0D#0A{..4Open.quote.character#0D#0A}
..4Close.quote.character#2E#0D#0A#0D#0AA.typical.ma
cro.definition.and.call.is.as.follows:#0D#0A#0D#0A[
def!xx1!{This.output.results.from.the.call.{[xx1!}#23
1{]}}]#0D#0A[xx1!yy1]#0D#0A#0D#0AThis.would.generat
e:#0D#0A#0D#0AThis.output.results.from.the.call.[xx
1!yy1]#0D#0A#0D#0A#0D#0AThe.syntax.of.bmakefile.rul
es#0D#0A#0D#0Atarget-item.<#3D.item.#2E#2E1.item.<<
.command-sequence.>>#0D#0A#0D#0AEvery.rule.must.hav
e.a.target.item.and.a.body.consisting.of.a.possibly
#0D#0Aempty.command.sequence.enclosed.in.<<.and.>>.
brackets#2E..The#0D#0Acommand-sequence.is.an.arbitr
ary.sequence.of.characters.not.containing#0D#0A>>#2E
..The.item.list.may.be.empty.and,.if.so,.the.symbol
.<#3D.may.be#0D#0Aomitted#2E..White.space.including
.newlines.are.allowed.anywhere.between#0D#0Aitems#2E
#0D#0A#0D#0AA.target.item.may.contain.a.parameter.o
f.the.form.<tag>.normally.as.a#0D#0Acomponent.of.a.
file.name.where.the.tag.is.any.sequence.of.zero.or.
more#0D#0Aletters.and.digits#2E.The.tag.has.no.sign
ificance.other.than.all#0D#0Aparameters.occurring.w
ithin.a.rule.must.have.the.same.tag#2E.Rules#0D#0Ac
ontaining.parameters.are.called.rule.patterns,.as.i
n:#0D#0A#0D#0Acin/<f>.<#3D.com/<f>#2Eb.g/hdr#2Eh.<<
.c.bc.<f>.>>#0D#0A#0D#0ASuch.rules.are.only.used.wh
en.there.is.no.explicit.rule.for.a.given#0D#0Atarge
t#2E.When.a.rule.pattern.is.applied.all.occurrences
.of.its#0D#0Aparameter.are.replaced.by.the.text.tha
t.allowed.the.target.item.to.be#0D#0Amatched#2E.So.
if.cin/echo.must.be.brought.up.to.date.and.has.no.e
xplicit#0D#0Arule,.the.above.pattern.will.automatic
ally.add.the.following.rule.to#0D#0Athe.set:#0D#0A#0D
#0Acin/echo.<#3D.com/echo#2Eb.g/hdr#2Eh.<<.c.bc.ech
o.>>#0D#0A#0D#0AA.target.is.out.of.date.if.it.does.
not.exist.or.if.any.of.the.items.it#0D#0Adepends.on
.are.out.of.date.or.have.a.modify.dates.later.than.
that.of#0D#0Athe.target#2E.A.target.is.brought.up.t
o.date.by,.first,.bringing.the#0D#0Aitems.it.depend
s.on.up.to.date.and.then.executing.the.CLI.command#0D
#0Asequence.given.by.the.body#2E#0D#0A#0D#0AItems.m
ay.consist.of.any.sequence.of.characters.not.includ
ing.%,.[.!,#0D#0A].{,.},.#3D,.or.white.space,.and.<
.and.>.may.only.appear.in.parameters#2E#0D#0A#0D#0A
In.normal.use,.bmake.generates.a.command-command.fi
le.to.bring.the#0D#0Atarget.up.to.date.and.then.ret
urns.to.the.CLI.to.cause.it.to.be#0D#0Aexecuted#2E.
.The.-c.option.allows.the.command-command.file.to.b
e#0D#0Ainspected.without.it.being.executed,.and.the
.-m,.-l,.-p,.-r,.-s.and.-d#0D#0Aoptions.provide.oth
er.debugging.aids#2E#0D#0A#0D#0A*/#0D#0A#0D#0ASECTI
ON."bmake"#0D#0A#0D#0AGET."libhdr"#0D#0A#0D#0AGLOBA
L.{#0D#0A//.BGPM.globals#0D#0Abg_s:ug#0D#0Abg_t#0D#0A
bg_h#0D#0Abg_p#0D#0Abg_f#0D#0Abg_c#0D#0Abg_e#0D#0Ab
g_ch#0D#0A#0D#0Abggetch;.bgputch;..bgwrn#0D#0Aerror
#0D#0A#0D#0Abgpmco#0D#0Abgpmfn#0D#0A#0D#0Asysin;.sy
sout;.sourcestream;.tostream#0D#0Asourcenamev;.sour
cefileno;.sourcefileupb#0D#0Agetstreams;.lineno#0D#0A
#0D#0AoptMacros;.optTokens;.optPats;.optRules;.optS
ets;.optComs#0D#0A#0D#0Anewvec;.mk1;.mk2;.mk3;.mk4;
.mk5;.mk6;.mk7;.mk8#0D#0A#0D#0Ablklist..//.List.of.
blocks.of.work.space#0D#0Ablkb#0D#0Ablkp#0D#0Ablkt#0D
#0Ablkitem#0D#0A//treevec;.treep;.treet#0D#0Abase;.
upb;.rec_p;.rec_l;.fin_p;.fin_l#0D#0A#0D#0Arulelist
;.ruleliste#0D#0Apatnlist;.patnliste#0D#0A#0D#0Adeb
ug..12//.#3DTRUE.causes.output.of.the.debugging.tra
ce#0D#0Aerrcount;.errmax#0D#0Afatalerr;.synerr;.fat
alsynerr#0D#0Atrerr#0D#0Astrv..2//.Short.term.sting
.buffer#0D#0A#0D#0Arch;.ch;.chbuf;.chcount;.parse;.
tree#0D#0Aprrule;.prpatn;.opstr;.prlineno#0D#0Atoke
n#0D#0Abgexp;.bgbexp;.argp;.argt#0D#0Awrc;.wrs;.chp
os;.charv;.len;.tagv;.tlen#0D#0Awordnode#0D#0Ardtag
;.param;.parampos#0D#0Aopstr#0D#0Alookupword#0D#0An
ametable#0D#0Aparse#0D#0Atargetstr#0D#0Atargetitem#0D
#0Aapply_patterns#0D#0Amatch#0D#0Agenerate_commands
#0D#0Anewfile#0D#0A}#0D#0A#0D#0AMANIFEST.{#0D#0Anam
etablesize.#3D.541#0D#0Ablkupb.#3D.4001#0D#0Acharvu
pb.#3D.1002..//.Maximum.body.length#0D#0A#0D#0A//.B
GPM.markers#0D#0As_eof..3#3D..-2#0D#0As_eom..3#3D..
-3#0D#0A#0D#0A//.BGPM.builtin.macros#0D#0As_def..3#3D
..-4#0D#0As_set..3#3D..-5#0D#0As_get..3#3D..-6#0D#0A
s_eval..2#3D..-7#0D#0As_lquote..#3D..-8#0D#0As_rquo
te..#3D..-9#0D#0As_comment.#3D.-10#0D#0As_rep..3#3D
.-19#0D#0A#0D#0A//.BGPM.special.characters#0D#0Ac_c
all..2#3D.'['#0D#0Ac_apply..1#3D.']'#0D#0Ac_sep..3#3D
.'!'#0D#0Ac_comment.#3D.'%'.#0D#0Ac_lquote..#3D.'{'
#0D#0Ac_rquote..#3D.'}'#0D#0Ac_arg..3#3D.'#23'#0D#0A
#0D#0A//.General.selectors#0D#0Ah1#3D0;.h2;.h3;.h4;
.h5;.h6;.h7#0D#0A#0D#0A//.Selectors#0D#0An_next#3D0
#0D#0An_ln..10//.Line.number.of.the.target.item.of.
the.rule.or.pattern#2E#0D#0An_subj..8//.Subject.ite
m.of.the.rule.or.pattern#2E#0D#0An_dpns..8//.List.o
f.items.this.rule.depends.on#0D#0An_com..9//.The.co
mmand.string#2E.Only.zero.for.default.rules#2E#0D#0A
n_param..7//.Param.string.if.pattern,.zero.if.rule#2E
#0D#0An_state#3Dn_param.//.#3D0.if.not.touched,#0D#0A
..14//.#3D1.if.looking.through.the.depends-on.list,
#0D#0A..14//.#3D2.if.all.items.in.the.depends-on.li
st.have.been.processed#2E#0D#0An_days..8//.>0..modi
fication.time.of.the.subject.if.known#2E#0D#0A..14/
/.#3D0..subject.iten.does.not.exist#2E#0D#0A..14//.
#3D-1.subject.item.not.yet.inspected#2E#0D#0An_msec
s..7//.zero.or.msecs.since.midnight#2E#0D#0A#0D#0A/
/.Data.structures#0D#0A#0D#0A//.[next,.rule,.<packe
d.string>]..26--.item#0D#0A//.[next,..pos,.<packed.
string>]..26--.pattern.item#0D#0A//..56--.next.is.t
he.hash.chain#0D#0A//.[next,.item]..43--.dpns-list#0D
#0A//.[len,.<packed.chars>]..34--.com#0D#0A//.[next
,.ln,.item,.depends-list,.com,.state,.days,.msecs].
.--.rule#0D#0A//.[next,.ln,.item,.depends-list,.com
,.param]..13--.pattern#0D#0A#0D#0A//.Lexical.token#0D
#0As_item#3D1#0D#0As_dependson#0D#0As_com#0D#0As_en
d#0D#0A#0D#0Aworkfileupb#3D255#0D#0Ataskposlwb#3D8#0D
#0Ataskposupb..3#3D..0059#0D#0Aswitchpos..4#3D..005
6#0D#0A#0D#0A}#0D#0A#0D#0ALET.start().#3D.VALOF#0D#0A
{.LET.argv.#3D.VEC.50#0D#0A..LET.s.#3D.VEC.10#0D#0A
..LET.fromname.#3D."bmakefile"#0D#0A..LET.toname.#3D
.0#0D#0A..LET.b.#3D.VEC.64/bytesperword#0D#0A..LET.
dbv.#3D.VEC.9#0D#0A..strv.:#3D.s..7//.Short.term.st
ing.buffer#0D#0A#0D#0A..errcount,.errmax.:#3D.0,.5#0D
#0A..fin_p,.fin_l.:#3D.level(),.fin#0D#0A..rec_p,.r
ec_l.:#3D.fin_p,.fin_l#0D#0A#0D#0A..chbuf.:#3D.b#0D
#0A..FOR.i.#3D.0.TO.63.DO.chbuf%i.:#3D.0#0D#0A..chc
ount.:#3D.0#0D#0A#0D#0A..upb.:#3D.100_001#0D#0A#0D#0A
..sysin.:#3D.input()#0D#0A..sysout.:#3D.output()#0D
#0A#0D#0A..base.:#3D.0..12//.Base.of.BGPM.workspace
#0D#0A..sourcestream.:#3D.0#0D#0A..getstreams.:#3D.
0#0D#0A..tostream.:#3D.sysout#0D#0A..bgpmco.:#3D.0#0D
#0A#0D#0A..//.Space.for.parse.tree,.etc#2E#0D#0A..b
lklist,.blkb,.blkp,.blkt,.blkitem.:#3D.0,.0,.0,.0,.
0#0D#0A#0D#0A..sourcefileupb.:#3D.1001#0D#0A..sourc
enamev.:#3D.newvec(sourcefileupb)#0D#0A..UNLESS.sou
rcenamev.DO#0D#0A..{.writef("Insufficient.space.ava
ilable*n")#0D#0A..2GOTO.fin#0D#0A..}#0D#0A..sourcef
ileno.:#3D.0#0D#0A..FOR.i.#3D.0.TO.sourcefileupb.DO
.sourcenamev!i.:#3D."unknown"..1#0D#0A#0D#0A..//.So
urcefile.1.is."builti-n".and.is.used.during.initial
isation#2E#0D#0A..//.Sourcefile.2.is.always.the.FRO
M.argument.filename#0D#0A..//.Higher.numbers.are.GE
T.files#0D#0A..lineno.:#3D.(1<<00020).+.1#0D#0A..ta
rgetstr,.targetitem.:#3D.0,.0#0D#0A.#0D#0A..UNLESS.
rdargs("TARGET,FILE/K,TO/K,-m/S,-l/S,-p/S,-r/S,-s/S
,-c/S,-d/S",.argv,.50).DO#0D#0A..{.fatalerr("Bad.ar
guments.for.BMAKE*n")#0D#0A..2RESULTIS.0#0D#0A..}#0D
#0A..IF.argv!0.DO.targetstr.:#3D.argv!0//.TARGET#0D
#0A..IF.argv!1.DO.fromname.:#3D.argv!1.//.FROM..--.
name.of.the.makefile#0D#0A..IF.argv!2.DO.toname.:#3D
.argv!2..1//.TO/K..--.name.of.the.output.file#0D#0A
..optMacros.:#3D.argv!3..11//.-m/S..--.Output.macro
generated.text.#0D#0A..optTokens.:#3D.argv!4..11//.
-l/S..--.Trace.lexical.tokens#0D#0A..optPats..1:#3D
.argv!5..11//.-r/S..--.Output.the.patterns#0D#0A..o
ptRules..:#3D.argv!6..11//.-r/S..--.Output.rules.be
fore.pattern.application#0D#0A..optSets..1:#3D.argv
!7..11//.-r/S..--.Output.rules.after.pattern.applic
ation#0D#0A..optComs..1:#3D.argv!8..11//.-c/S..--.O
utput.the.command.sequence#0D#0A..debug..3:#3D.argv
!9..11//.-d/S..--.Output.debugging.trace#0D#0A#0D#0A
..sourcefileno.:#3D.1#0D#0A..sourcenamev!1.:#3D.fro
mname#0D#0A#0D#0A..IF.upb<500.DO.upb.:#3D.500#0D#0A
..base.:#3D.getvec(upb)..2//.BGPM.workspace#0D#0A..
UNLESS.base.DO#0D#0A..2fatalerr("Unable.to.allocate
.work.space.(upb.#3D.%n)*n",.upb)#0D#0A#0D#0A..bgpm
co.:#3D.createco(bgpmfn,.2001)#0D#0A#0D#0A..UNLESS.
bgpmco.DO.fatalerr("Unable.to.create.bgpmco*n")#0D#0A
#0D#0A..sourcestream.:#3D.findinput(fromname)#0D#0A
..UNLESS.sourcestream.DO#0D#0A..{.synerr("Unable.to
.find.file:.%s*n",.fromname)#0D#0A..2GOTO.fin#0D#0A
..}#0D#0A#0D#0A..IF.toname.DO#0D#0A..{.tostream.:#3D
.findoutput(toname)#0D#0A..2UNLESS.tostream.DO#0D#0A
..2{.synerr("Unable.to.find.file:.%s*n",.toname)#0D
#0A..4GOTO.fin#0D#0A..2}#0D#0A..}#0D#0A#0D#0A..IF.s
ourcestream.DO.selectinput(sourcestream)#0D#0A..IF.
tostream.DO.selectoutput(tostream)#0D#0A..#0D#0A#0D
#0A..IF.optMacros.DO#0D#0A..{.//.Test.the.output.of
.BGPM#0D#0A..2LET.prevlineno.#3D.0#0D#0A#0D#0A..2ne
wline()#0D#0A#0D#0A..2{.rch()#0D#0A..4IF.ch#3Dendst
reamch.BREAK#0D#0A//writef("rch().#3D>.lineno.#3D")
;.prlineno(lineno)#0D#0A//writef("..ch.#3D.%i3:.",.
ch)#0D#0A..4//UNLESS.lineno#3Dprevlineno.DO#0D#0A..
4//{.newline()#0D#0A..4//..prlineno(lineno)#0D#0A..
4//..writef(":.")#0D#0A..4//..prevlineno.:#3D.linen
o#0D#0A..4//}#0D#0A..4wrch(ch)#0D#0A//newline()#0D#0A
//abort(1000007)#0D#0A..2}.REPEAT#0D#0A..2GOTO.fin#0D
#0A..}#0D#0A#0D#0A..rch()#0D#0A#0D#0A..parse()..12/
/.Perform.Syntax.Analysis#0D#0A#0D#0A..IF.optTokens
.GOTO.fin#0D#0A#0D#0A..IF.optPats.DO#0D#0A..{.LET.p
.#3D.patnlist#0D#0A..2writef("*nPatterns*n*n")#0D#0A
..2WHILE.p.DO#0D#0A..2{.prpatn(p)#0D#0A..4p.:#3D.!p
#0D#0A..2}#0D#0A..2newline()#0D#0A..}#0D#0A#0D#0A..
IF.optRules.DO#0D#0A..{.LET.p.#3D.rulelist#0D#0A..2
writes("*nRules*n*n")#0D#0A..2WHILE.p.DO#0D#0A..2{.
prrule(p)#0D#0A..4p.:#3D.!p#0D#0A..2}#0D#0A..2newli
ne()#0D#0A..}#0D#0A#0D#0A..//.Apply.the.patterns#0D
#0A#0D#0A..apply_patterns()#0D#0A#0D#0A..UNLESS.tar
getitem.DO#0D#0A..{.UNLESS.rulelist.DO.fatalsynerr(
"No.target.specified")#0D#0A..2targetitem.:#3D.n_su
bj!rulelist#0D#0A..}#0D#0A#0D#0A..IF.optSets.DO#0D#0A
..{.LET.p.#3D.rulelist#0D#0A#0D#0A..2IF.targetitem.
DO.writef("*nTarget:.%s*n",.@h3!targetitem)#0D#0A#0D
#0A..2writef("*nRules.after.the.application.of.the.
patterns*n*n")#0D#0A..2WHILE.p.DO#0D#0A..2{.prrule(
p)#0D#0A..4p.:#3D.!p#0D#0A..2}#0D#0A..2newline()#0D
#0A..}#0D#0A#0D#0A..IF.errcount.GOTO.fin#0D#0A#0D#0A
..IF.optComs.DO#0D#0A..{.IF.debug.DO.writef("Callin
g.generate_commands(#2E#2E1)*n")#0D#0A..2UNLESS.gen
erate_commands(targetitem)#3Dmaxint.DO#0D#0A..4writ
ef("%s.is.already.up.to.date*n",.@h3!targetitem)#0D
#0A..2GOTO.fin#0D#0A..}#0D#0A#0D#0A#0D#0A..{.LET.ne
wf..1#3D.VEC.workfileupb#0D#0A..2LET.workfile.#3D."
T-CMD0Tnn"#0D#0A..2LET.newstream.#3D.0#0D#0A..2LET.
outstream.#3D.0#0D#0A#0D#0A..2newfile.:#3D.newf#0D#0A
#0D#0A..2//.Construct.work-file.name#0D#0A..2//..2T
-CMD0Tnn#0D#0A..2//..9nn..3two.digits.of.the.taskid
.(#3D00.under.cintsys)#0D#0A..2//..7*..0060.or.1.to
.make.it.different.from.current.file.name.#0D#0A..2
FOR.j.#3D.0.TO.workfile%0.DO.newfile%j.:#3D.workfil
e%j#0D#0A#0D#0A..2{.LET.t.#3D.taskid#0D#0A..4FOR.j.
#3D.taskposupb.TO.taskposlwb.BY.-1.DO.//.ie:.9.then
.8#0D#0A..4{.newfile%j.:#3D.t.REM.10.+.'0'#0D#0A..6
t.:#3D.t/10#0D#0A..4}#0D#0A..2}#0D#0A#0D#0A..2IF.(c
li_status.&.clibit_comcom)~#3D0.DO#0D#0A..2{.//.We.
are.currently.running.a.command-command.from.file#0D
#0A..4//.so.we.must.choose.a.different.filename#2E#0D
#0A..4IF.cli_commandfile%0.>#3D.switchpos.DO..//.sw
itchpos.#3D.6#0D#0A..4{.//.T-CMD0Tnn.<#3D#3D>.T-CMD
1Tnn#0D#0A..6newfile%switchpos.:#3D.cli_commandfile
%switchpos.XOR.1#0D#0A..4}#0D#0A..2}#0D#0A#0D#0A//s
awritef("bmake:.using.command.file.%s*n",.newfile)#0D
#0A#0D#0A..2IF.debug.DO.writef("Calling.generate_co
mmands(#2E#2E1).to.file.%s*n",.newfile)#0D#0A#0D#0A
..2outstream.:#3D.findoutput(newfile)#0D#0A#0D#0A..
2UNLESS.outstream.DO#0D#0A..2{.writef("Can't.open.f
ile.*"%s*".for.output",.newfile)#0D#0A..4GOTO.fin#0D
#0A..2}#0D#0A#0D#0A..2selectoutput(outstream)#0D#0A
#0D#0A//sawritef("bmake:.calling.generate_commands*
n")#0D#0A..2UNLESS.generate_commands(targetitem)#3D
maxint.DO#0D#0A..2{.selectoutput(sysout)#0D#0A..4wr
itef("%s.is.already.up.to.date*n",.@h3!targetitem)#0D
#0A..4selectoutput(outstream)#0D#0A..2}#0D#0A//sawr
itef("bmake:.returned.from.generate_commands*n")#0D
#0A#0D#0A..2//.Copy.rest.of.current.input#2E#0D#0A#0D
#0A..2selectinput(cli_currentinput)#0D#0A#0D#0A//sa
writef("bmake:.cli_status#3D%x8.clibit_comcom#3D%x8
*n",.cli_status,.clibit_comcom)#0D#0A#0D#0A..2IF.(c
li_status.&.clibit_comcom)~#3D0.DO#0D#0A..2{.//.If.
we.were.already.processing.a.command-command,.copy.
the#0D#0A..4//.rest.of.the.previous.file.into.the.n
ew.file#0D#0A//sawritef("bmake:.in.a.command-comman
d.copying.from.%s*n",.cli_commandfile)#0D#0A..4{.ch
.:#3D.rdch()#0D#0A..6IF.ch.#3D.endstreamch.BREAK#0D
#0A..6wrch(ch)#0D#0A..4}.REPEAT#0D#0A#0D#0A..4//.Th
en.close.and.delete.the.old.file#0D#0A..4endstream(
cli_currentinput)#0D#0A..4deletefile(cli_commandfil
e)#0D#0A..2}#0D#0A#0D#0A..2endstream(outstream)..9/
/.Close.the.new.file#0D#0A#0D#0A..2newstream.:#3Dfi
ndinput(newfile).//.and.open.it.for.input#0D#0A#0D#0A
..2//.Set.up.the.new.command.file.for.the.CLI.to.pr
ocess,#0D#0A..2//.remembering.its.name.so.that.it.c
an.be.deleted.later#2E#0D#0A..2cli_currentinput.:#3D
.newstream#0D#0A..2FOR.j.#3D.0.TO.newfile%0.DO.cli_
commandfile%j.:#3D.newfile%j#0D#0A#0D#0A..2//.Set.t
he.CLI.comcom.bit#0D#0A..2cli_status.:#3D.cli_statu
s.|.clibit_comcom#0D#0A#0D#0A..2selectoutput(sysout
)#0D#0A..2IF.debug.DO.writef("bmake.returning.to.th
e.CLI.to.execute.script.%s*n",#0D#0A..22cli_command
file)#0D#0A..}#0D#0A#0D#0Afin:#0D#0A..IF.bgpmco.DO.
deleteco(bgpmco)#0D#0A..UNLESS.sourcestream#3Dsysin
.DO.endstream(sourcestream)#0D#0A..UNLESS.tostream#3D
sysout..2DO.endstream(tostream)#0D#0A..selectinput(
sysin)#0D#0A..selectoutput(sysout)#0D#0A..IF.base.D
O.freevec(base)#0D#0A..WHILE.blklist.DO#0D#0A..{.LE
T.blk.#3D.blklist#0D#0A..2blklist.:#3D.!blk#0D#0A..
2freevec(blk)#0D#0A..}#0D#0A..RESULTIS.0#0D#0A}#0D#0A
#0D#0A//.This.section.implements.a.macrogenerator.b
ased.on.GPM#0D#0A//.designed.by.Strachey.(in.1964)#0D
#0A#0D#0ALET.prlineno(ln).BE#0D#0A{.LET.fileno.#3D.
ln>>00020#0D#0A..LET.lno.#3D.ln.&.#23xFF3#0D#0A..TE
ST.ln#0D#0A..THEN.writef(".%s[%n]",.sourcenamev!fil
eno,.lno)#0D#0A..ELSE.writef(".<no.line>")#0D#0A//a
bort(1000005)#0D#0A}#0D#0A#0D#0ALET.bgputch(ch).BE#0D
#0A{.TEST.bg_h#3D0#0D#0A..THEN.TEST.ch.>#3D.(1<<000
20)#0D#0A..5THEN.lineno.:#3D.ch#0D#0A..5ELSE.cowait
(ch)#0D#0A..ELSE.push(ch)#0D#0A#0D#0A..IF.ch.#3D.'*
n'.DO.lineno.:#3D.lineno+1#0D#0A}#0D#0A#0D#0AAND.pu
sh(ch).#3D.VALOF.{.IF.bg_t#3Dbg_s.DO.bg_error("Insu
fficient.work.space")#0D#0A..21bg_s.:#3D.bg_s.+.1#0D
#0A..21!bg_s.:#3D.ch#0D#0A..21RESULTIS.bg_s#0D#0A..
19}#0D#0A#0D#0AAND.bggetch().#3D.VALOF#0D#0A{.LET.c
h.#3D.?#0D#0A//writef("bggetch:.called.with.bg_c#3D
%n.lineno#3D%x8*n",.bg_c,.lineno)#0D#0A..TEST.bg_c#0D
#0A..THEN.{.//.Reading.from.a.macro.body#0D#0A..7bg
_c.:#3D.bg_c+1#0D#0A..7ch.:#3D.!bg_c#0D#0A..7//.Che
ck.for.file/line.number#0D#0A..7IF.ch>#3D(1<<00020)
.DO.{.lineno.:#3D.ch;.LOOP.}#0D#0A..7//.Check.for.n
ewline#0D#0A..//IF.ch#3D'*n'.DO.lineno.:#3D.lineno.
+.1#0D#0A..7RESULTIS.ch#0D#0A..5}.REPEAT#0D#0A..ELS
E.{.//.Reading.from.file#0D#0A..7ch.:#3D.rdch()#0D#0A
#0D#0A..7{.//.Check.for.comment#0D#0A..9UNLESS.ch#3D
c_comment.RESULTIS.ch#0D#0A#0D#0A..9//.Skip.a.bgpm.
comment#2E.Ie.skip.characters#0D#0A..9//.up.to.and.
including.the.newline.and.then.skip#0D#0A..9//.to.t
he.next.non.white.space.character#2E.#0D#0A..9{.//.
Skip.over.the.current.line#0D#0A..11ch.:#3D.rdch()#0D
#0A..11IF.ch#3Dendstreamch.RESULTIS.ch#0D#0A..11IF.
ch#3D'*n'.DO#0D#0A..11{.lineno.:#3D.lineno.+.1#0D#0A
..13BREAK#0D#0A..11}#0D#0A..9}.REPEAT#0D#0A#0D#0A..
9{.//.Skip.over.white.space#0D#0A..11ch.:#3D.rdch()
#0D#0A..11IF.ch#3D'*s'.|.ch#3D'*t'.LOOP#0D#0A..11IF
.ch#3D'*n'.DO#0D#0A..11{.lineno.:#3D.lineno+1#0D#0A
..13LOOP#0D#0A..11}#0D#0A..11BREAK#0D#0A..9}.REPEAT
.#0D#0A..9//.ch.is.a.non.white.space.character#0D#0A
..7}.REPEAT#0D#0A..5}#0D#0A}#0D#0A#0D#0AAND.arg(a,.
n).#3D.VALOF.{.IF.!a<0.DO.bg_error("Too.few.argumen
ts")#0D#0A..22IF.n#3D0.RESULTIS.a#0D#0A..22a,.n.:#3D
.a+!a+1,.n-1#0D#0A..20}.REPEAT#0D#0A#0D#0AAND.looku
p(name).#3D.VALOF#0D#0A{.LET.a,.i,.len.#3D.bg_e,.0,
.!name#0D#0A..LET.buf.#3D.VEC.256/bytesperword#0D#0A
//writef("lookup:.");.prlineno(lineno)#0D#0A//write
f(".Looking.up.*"%s*"*n",.arg2str(name,.buf))#0D#0A
#0D#0A..WHILE.a.DO#0D#0A..{.LET.p.#3D.name#0D#0A..2
LET.q.#3D.@a!2#0D#0A..2LET.pe,.qe.#3D.p+!p,.q+!q#0D
#0A#0D#0A..2{.LET.ch1.#3D.s_eom#0D#0A..4LET.ch2.#3D
.s_eom#0D#0A..4//.Skip.over.file/line.items#0D#0A..
4WHILE.p<pe.DO#0D#0A..4{.p.:#3D.p+1#0D#0A..6ch1.:#3D
.!p#0D#0A..6IF.ch1<#3D255.BREAK#0D#0A..4}#0D#0A..4/
/.Skip.over.file/line.items#0D#0A..4WHILE.q<qe.DO#0D
#0A..4{.q.:#3D.q+1#0D#0A..6ch2.:#3D.!q#0D#0A..6IF.c
h2<#3D255.BREAK#0D#0A..4}#0D#0A..4UNLESS.ch1#3Dch2.
BREAK#0D#0A..4IF.ch1#3Ds_eom.RESULTIS.a..2//.Macro.
definition.found#0D#0A..4//.Compare.more.characters
#0D#0A..2}.REPEAT#0D#0A..2//.try.the.next.macro.def
inition#0D#0A..2a.:#3D.!a..4#0D#0A..}#0D#0A#0D#0A..
bg_error("Macro.*"%s*".not.defined",.arg2str(name,.
buf))#0D#0A..RESULTIS.0#0D#0A}#0D#0A#0D#0AAND.arg2s
tr(a,.str).#3D.VALOF#0D#0A{.LET.len.#3D.!a#0D#0A..L
ET.i,.j.#3D.0,.1#0D#0A..IF.len>20.DO.len.:#3D.20#0D
#0A..FOR.j.#3D.1.TO.len.DO#0D#0A..{.LET.ch.#3D.a!j#0D
#0A..2IF.ch>255.LOOP..//.Ignore.line.number.words#0D
#0A..2i.:#3D.i+1#0D#0A..2str%i.:#3D.ch#0D#0A..}#0D#0A
..str%0.:#3D.i#0D#0A..IF.!a>20.DO.str%19,.str%20.:#3D
.'#2E',.'#2E'#0D#0A..RESULTIS.str#0D#0A}#0D#0A#0D#0A
AND.define(name,.code).BE#0D#0A{.LET.s1.#3D.bg_s#0D
#0A//sawritef("define:.Defining.%s.S#3D%n.T#3D%n.E#3D
%n*n",.name,.bg_s,.bg_t,.bg_e)#0D#0A..push(bg_e)../
/.Save.the.old.environment.pointer#0D#0A..push(bg_t
)..//.and.t#0D#0A..//.Push.the.macro.name.onto.the.
stack#0D#0A..push(name%0+1)#0D#0A..push((0001<<0002
0).+.1)#0D#0A..FOR.i.#3D.1.TO.name%0.DO.push(name%i
)#0D#0A..push(2)..8//.Every.macro.body.starts.with.
a.line.number#0D#0A..push((0001<<00020)+1)..//.Spec
ial.line.number.for.built-in.macros#0D#0A..push(cod
e)..5//.The.built-in.macro.code#0D#0A..push(s_eom).
.4//.This.marks.the.end.of.the.argument.list#2E#0D#0A
..UNTIL.bg_s#3Ds1.DO.{.!bg_t.:#3D.!bg_s;.bg_t,.bg_s
.:#3D.bg_t-1,.bg_s-1.}#0D#0A..bg_e.:#3D.bg_t+1..1//
.Set.the.new.environment.pointer.#0D#0A//sawritef("
define:.Defined..%s.S#3D%n.T#3D%n.E#3D%n*n",.name,.
bg_s,.bg_t,.bg_e)#0D#0A//abort(1000001)#0D#0A}#0D#0A
#0D#0AAND.bgpmfn().BE#0D#0A{.//.This.is.the.main.fu
nction.of.bgpmco.which.generates.the.sequence#0D#0A
..//.of.characters.of.the.macro.expansion.of.its.so
urce.file#2E#0D#0A..//.It.passes.the.expanded.text.
to.the.lexical.analyser.by.call#0D#0A..//.of.cowait
(ch),.and.maintains.lineno.to.always.hold.the.file/
line#0D#0A..//.number.of.the.latest.character.passe
d#2E#0D#0A#0D#0A..rec_p,.rec_l.:#3D.level(),.ret#0D
#0A#0D#0A..bg_s,.bg_t,.bg_h,.bg_p,.bg_f,.bg_e,.bg_c
.:#3D.base-1,.base+upb,.0,.0,.0,.0,.0#0D#0A#0D#0A..
//lineno.:#3D.(2<<00020).+.1..5//.Special.file/line
.number.for.built-in.macros#0D#0A#0D#0A..define("de
f",..3s_def)#0D#0A..define("set",..3s_set)#0D#0A..d
efine("get",..3s_get)#0D#0A..define("eval",..2s_eva
l)#0D#0A..define("lquote",..s_lquote)#0D#0A..define
("rquote",..s_rquote)#0D#0A..define("eof",..3s_eof)
#0D#0A..define("rep",..3s_rep)#0D#0A#0D#0A..{.//.St
art.of.main.scanning.loop#2E#0D#0A#0D#0A//writef("b
gpmfn:.calling.bggetch()*n")#0D#0A..2bg_ch.:#3D.bgg
etch()#0D#0A#0D#0A..2//.bg_ch.is.the.next.character
.to.scan#2E#0D#0A..2//.It.might.be.a.special.operat
or.such.as.s_def.or.s_eom#0D#0A..2//.or.a.file/line
.nummber:.(fno<<00020).+.line#0D#0A..2//.or.an.ordi
nary.ASCII.character#2E#0D#0A#0D#0A//writef("bgpmfn
:.bg_ch#3D%x8*n",.bg_ch)#0D#0Asw:#0D#0A#0D#0A//writ
ef("bgpmfn:.ch#3D%x8.",.bg_ch)#0D#0A//IF.32<#3Dbg_c
h<#3D127.DO.writef("'%c'.",.bg_ch)#0D#0A//IF.bg_ch<
0..6DO.writef(".%i3.",.bg_ch)#0D#0A//prlineno(linen
o);.newline()#0D#0A//abort(1000009)#0D#0A#0D#0A..2S
WITCHON.bg_ch.INTO#0D#0A..2{.DEFAULT:#0D#0A//writef
("bgpmfn:.DEFAULT:.bg_ch#3D%x8*n",.bg_ch)#0D#0A..9I
F.bg_ch>#3D(1<<00020).DO#0D#0A..9{.//.Update.the.fi
le/line.number.variable#0D#0A..11lineno.:#3D.bg_ch#0D
#0A..11bgputch(bg_ch)#0D#0A..11LOOP#0D#0A..9}#0D#0A
//writef("bgpmfn:.DEFAULT:.ch.now.set.to.%x8*n",.bg
_ch)#0D#0A..9bgputch(bg_ch)#0D#0A..9LOOP#0D#0A#0D#0A
..4CASE.endstreamch:#0D#0A..9IF.getstreams#3D0.DO#0D
#0A..9{.//.End.of.file.at.the.outermost.level#0D#0A
..11//.So.send.end-of-stream.characters.from.now.on
#2E#0D#0A..11cowait(endstreamch).REPEAT#0D#0A..9}#0D
#0A..9//.Close.the.get.stream.and.resume.the.previo
us.input#2E#0D#0A..9endread()#0D#0A..9lineno..5:#3D
.h3!getstreams#0D#0A..9sourcestream.:#3D.h2!getstre
ams#0D#0A..9getstreams..1:#3D.h1!getstreams#0D#0A..
9selectinput(sourcestream)#0D#0A//writef("bgpm:.eof
.sourcestream#3D%n",.sourcestream);.prlineno(lineno
)#0D#0A//newline()#0D#0A..9LOOP#0D#0A#0D#0A..4CASE.
c_lquote:#0D#0A..7{.LET.d.#3D.1#0D#0A..9{.bg_ch.:#3D
.bggetch()#0D#0A..11IF.bg_ch<0.DO.bg_error("Non.cha
racter.in.quoted.string")#0D#0A..11IF.bg_ch#3Dc_lqu
ote.DO..1d.:#3D.d+1#0D#0A..11IF.bg_ch#3Dc_rquote.DO
.{.d.:#3D.d-1;.IF.d#3D0.BREAK.}#0D#0A..11bgputch(bg
_ch)#0D#0A..9}.REPEAT#0D#0A..9LOOP#0D#0A..7}#0D#0A#0D
#0A..4CASE.c_call:..13//.'['#0D#0A..9bg_f.:#3D.push
(bg_f)..2//.Position.of.start.of.new.macro.call#0D#0A
..9push(bg_h)..10//.Save.start.of.previous.arg.star
t#0D#0A..9push(?)..13//.Space.for.lno#0D#0A..9push(
?)..13//.Space.for.e#0D#0A..9push(?)..13//..5and.t#0D
#0A..9bg_h.:#3D.push(?)..5//.Start.of.zeroth.arg.of
.new.call#0D#0A..9push(lineno)..8//.File/line.numbe
r.of.zeroth.arg#0D#0A..9LOOP#0D#0A#0D#0A..4CASE.c_s
ep:..14//.'!'#0D#0A..9IF.bg_h#3D0.DO..8//.ignore.if
.not.reading.macro.arguments#0D#0A..9{.bgputch(bg_c
h)#0D#0A..11LOOP#0D#0A..9}#0D#0A..9!bg_h.:#3D.bg_s-
bg_h..2//.Fill.in.the.length.of.latest.arg#0D#0A..9
bg_h.:#3D.push(?)..5//.Start.a.new.arg#0D#0A..9push
(lineno)..8//.File/line.number.of.next.arg#0D#0A..9
LOOP#0D#0A#0D#0A..4CASE.c_arg:..14//.'#23'#0D#0A..9
IF.bg_p#3D0.DO..8//.Ignore.if.not.expanding.a.macro
#0D#0A..9{.bgputch(bg_ch)#0D#0A..11LOOP#0D#0A..9}#0D
#0A..9bg_ch.:#3D.bggetch()#0D#0A..9{.//.Read.and.in
teger.and.use.it.to.find.the.start#0D#0A..11//.of.t
he.corresponding.macro.argument#0D#0A..11LET.a.#3D.
arg(bg_p+5,.rdint())#0D#0A..11LET.lno.#3D.lineno..2
//.Save.current.file/line.number#0D#0A..11//.Copy.t
he.specified.argument#0D#0A..11FOR.q.#3D.a+1.TO.a+!
a.DO#0D#0A..11{.LET.ch.#3D.!q#0D#0A..13IF.ch.>#3D.(
1<<00020).DO#0D#0A..13{.lineno.:#3D.ch#0D#0A..15LOO
P#0D#0A..13}#0D#0A..13IF.ch.#3D.'*n'.DO.lineno.:#3D
.lineno.+.1#0D#0A..13bgputch(ch)#0D#0A..11}#0D#0A..
11lineno.:#3D.lno..2//.Restore.the.file/line.number
#0D#0A..11GOTO.sw#0D#0A..9}#0D#0A#0D#0A..4CASE.c_ap
ply:..13//.Apply.(])#0D#0A..7{.LET.a.#3D.bg_f#0D#0A
#0D#0A..9IF.bg_h#3D0.DO..9//.Ignore.if.not.reading.
arguments#0D#0A..9{.bgputch(ch)#0D#0A..11LOOP#0D#0A
..9}#0D#0A#0D#0A..9!bg_h.:#3D.bg_s-bg_h..3//.Fill.i
n.the.length.of.the.latest.arg#0D#0A..9push(s_eom).
.10//.Append.EOM.marking.end.of.args#0D#0A..9bg_f.:
#3D.a!0..10//.Restore.previous.start.of.call.pointe
r#0D#0A..9bg_h.:#3D.a!1..10//.Restore.previous.star
t.of.arg.pointer#0D#0A..9a!0.:#3D.bg_p..10//.Save.c
urrent.state#0D#0A..9a!1.:#3D.bg_c#0D#0A..9a!2.:#3D
.lineno..8//.Save.current..file/line.number#2E#0D#0A
..9a!3.:#3D.bg_e#0D#0A..9a!4.:#3D.bg_t#0D#0A..9//.C
opy.the.call.to.the.top.end#2E#0D#0A..9{.!bg_t.:#3D
.!bg_s;.bg_t,.bg_s.:#3D.bg_t-1,.bg_s-1.}.REPEATUNTI
L.bg_s<a#0D#0A..9bg_p.:#3D.bg_t+1#0D#0A..9bg_c.:#3D
.arg(lookup(bg_p+5)+2,.1)#0D#0A..9LOOP#0D#0A..7}#0D
#0A#0D#0A..4CASE.s_lquote:..15//.Left.quote.('{')#0D
#0A..9bgputch(c_lquote)#0D#0A..9LOOP#0D#0A#0D#0A..4
CASE.s_rquote:..15//.Right.quote.('}')#0D#0A..9bgpu
tch(c_rquote)#0D#0A..9LOOP#0D#0A..7#0D#0A..4CASE.s_
comment:..14//.Comment.character.('%')#0D#0A..9bgpu
tch(c_comment)#0D#0A..9LOOP#0D#0A..7#0D#0A..4CASE.s
_eof:..18//.End.of.file#0D#0A//writef("s_eof:.reach
ed*n")#0D#0A..9cowait(s_eof)#0D#0A..9RETURN#0D#0A#0D
#0A..4CASE.s_eom:..18//.End.of.macro.body#0D#0Aret:
..5IF.bg_p#3D0.LOOP#0D#0A..9bg_t..1:#3D.bg_p!4#0D#0A
..9bg_e..1:#3D.bg_p!3#0D#0A..9lineno.:#3D.bg_p!2#0D
#0A..9bg_c..1:#3D.bg_p!1#0D#0A..9bg_p..1:#3D.bg_p!0
#0D#0A..9LOOP#0D#0A#0D#0A..4CASE.s_def:..18//.[def!
name!body#2E#2E1]#0D#0A..8//..10*--44*#0D#0A..8//..
1F.H.ln.E.T.|.n.ln.d.e.f.|.n.ln.name.|.n.ln.body.#2E
#2E1..3eom#0D#0A..8//.^.^#0D#0A..8//.T.P#0D#0A..8//
..23*--31*#0D#0A..8//..21E.T.|.n.ln.name.|.n.ln.bod
y.eom.#2E#2E1.eom#0D#0A..8//..21^#0D#0A..8//..21E#0D
#0A..7{.LET.a1.#3D.arg(bg_p+5,.1)..1//.The.name#0D#0A
..9LET.a2.#3D.arg(bg_p+5,.2)..1//.The.body#0D#0A..9
a2!(!a2+1).:#3D.s_eom..5//.Mark.the.end.of.the.body
#0D#0A..9bg_e..1:#3D.a1.-.2#0D#0A..9bg_t..1:#3D.bg_
e-1#0D#0A..9bg_e!1.:#3D.bg_p!4..8//.previous.T#0D#0A
..9bg_e!0.:#3D.bg_p!3..8//.previous.E#0D#0A..9linen
o.:#3D.bg_p!2..8//.previous.file/line#0D#0A..9bg_c.
.1:#3D.bg_p!1..8//.previous.C#0D#0A..9bg_p..1:#3D.b
g_p!0..8//.previous.P#0D#0A..9LOOP#0D#0A..7}#0D#0A#0D
#0A..4CASE.s_set:..18//.[set!name!new.value]#0D#0A.
.7{.LET.name.#3D.arg(bg_p+5,.1)#0D#0A..9LET.val..#3D
.arg(bg_p+5,.2)#0D#0A..9LET.len.#3D.!val#0D#0A..9LE
T.a.#3D.lookup(name)#0D#0A..9LET.b.#3D.arg(a+2,.1)#0D
#0A..9LET.max.#3D.a!1.-.b.-.1..//.Max.length.of.the
.value#2E#0D#0A..9IF.len>max.DO.len.:#3D.max#0D#0A.
.9FOR.i.#3D.0.TO.len.DO.b!i.:#3D.val!i#0D#0A..9b!(l
en+1).:#3D.s_eom#0D#0A..9GOTO.ret#0D#0A..7}#0D#0A#0D
#0A..4CASE.s_get:..18//.[get!filename]#0D#0A..7{.LE
T.name.#3D.arg(bg_p+5,.1)#0D#0A..9LET.len.#3D.!name
#0D#0A..9LET.n.#3D.0#0D#0A..9LET.filename.#3D.VEC.2
56/bytesperword#0D#0A..9//lineno.:#3D.bg_p!2.//.Use
.the.file/line.of.the.get.call#2E#0D#0A..9//.Remove
.file/line.items.from.the.file.name#0D#0A..9FOR.i.#3D
.1.TO.len.DO#0D#0A..9{.LET.ch.#3D.name!i#0D#0A..11I
F.ch.>#3D.(1<<00020).LOOP#0D#0A..11n.:#3D.n+1#0D#0A
..11IF.n>255.DO.bg_error("File.name.too.long")#0D#0A
..11filename%n.:#3D.name!i#0D#0A..11filename%0.:#3D
.n#0D#0A..9}#0D#0A..9//.Return.from.[get!#2E#2E2]#0D
#0A..9bg_t..1:#3D.bg_p!4#0D#0A..9bg_e..1:#3D.bg_p!3
#0D#0A..9lineno.:#3D.bg_p!2#0D#0A..9bg_c..1:#3D.bg_
p!1#0D#0A..9bg_p..1:#3D.bg_p!0#0D#0A..9performget(f
ilename)#0D#0A..9LOOP#0D#0A..7}#0D#0A#0D#0A..4CASE.
s_eval:..18//.[eval!expression]#0D#0A..9bgwrnum(eva
larg(1))#0D#0A..9GOTO.ret#0D#0A#0D#0A..4CASE.s_rep:
..19//.[rep!count!text]#0D#0A..7{.LET.a.#3D.arg(bg_
p+5,.2)#0D#0A..9FOR.k.#3D.1.TO.evalarg(1).DO#0D#0A.
.11FOR.q.#3D.a+1.TO.a+!a.DO.bgputch(!q)#0D#0A..9GOT
O.ret#0D#0A..7}#0D#0A..2}#0D#0A..}.REPEAT#0D#0A}#0D
#0A#0D#0AAND.rdint().#3D.VALOF#0D#0A{.//.Only.used.
for.#23dd1#0D#0A..LET.val.#3D.0#0D#0A..GOTO.M#0D#0A
#0D#0AL:bg_ch.:#3D.bggetch()#0D#0A#0D#0AM:IF.bg_ch.
>#3D.(1<<00020).GOTO.L#0D#0A..IF.'0'<#3Dbg_ch<#3D'9
'.DO.{.val.:#3D.10*val.+.bg_ch.-.'0';.GOTO.L.}#0D#0A
#0D#0A..RESULTIS.val#0D#0A}#0D#0A#0D#0AAND.performg
et(filename).BE#0D#0A{.//.First.look.in.the.current
.directory#0D#0A..LET.stream.#3D.findinput(filename
)#0D#0A//..writef("Searching.for.*"%s*".in.the.curr
ent.directory*n",.filename)#0D#0A#0D#0A..//.Then.tr
y.the.headers.directories#0D#0A//..UNLESS.stream.DO
.writef("Searching.for.*"%s*".in.MUSHDRS*n",.filena
me)#0D#0A..UNLESS.stream.DO.stream.:#3D.pathfindinp
ut(filename,."MUSHDRS")#0D#0A#0D#0A..UNLESS.stream.
DO#0D#0A..{.bg_error("Unable.to.$get!%s;",.filename
)#0D#0A..2RETURN#0D#0A..}#0D#0A#0D#0A..IF.sourcefil
eno>#3Dsourcefileupb.DO#0D#0A..{.bg_error("Too.many
.GET.files")#0D#0A..2RETURN#0D#0A..}#0D#0A#0D#0A..{
.LET.len.#3D.filename%0#0D#0A..2LET.str.#3D.newvec(
len/bytesperword)#0D#0A..2IF.str.FOR.i.#3D.0.TO.len
.DO.str%i.:#3D.filename%i#0D#0A..2sourcefileno.:#3D
.sourcefileno+1#0D#0A..2sourcenamev!sourcefileno.:#3D
.str#0D#0A..}#0D#0A#0D#0A..getstreams.:#3D.mk3(gets
treams,.sourcestream,.lineno)#0D#0A..sourcestream.:
#3D.stream#0D#0A..selectinput(sourcestream)#0D#0A//
writef("performget:.old.lno.#3D.");.prlineno(lineno
)#0D#0A//newline()#0D#0A..lineno.:#3D.(sourcefileno
<<00020).+.1#0D#0A//writef("performget:.new.lno.#3D
.");.prlineno(lineno)#0D#0A//newline()#0D#0A}#0D#0A
#0D#0AAND.evalarg(n).#3D.VALOF#0D#0A{.argp.:#3D.arg
(bg_p+5,.n)#0D#0A..argt.:#3D.argp.+.!argp.+.1#0D#0A
..RESULTIS.bgexp(0)#0D#0A}#0D#0A#0D#0AAND.bgbexp().
#3D.VALOF#0D#0A{.bg_ch.:#3D.getargch()#0D#0A#0D#0A/
/sawritef("bgbexp:.bg_ch#3D%n*n",.bg_ch)#0D#0A..SWI
TCHON.bg_ch.INTO#0D#0A..{.DEFAULT:..bg_error("Bad.e
xpression,.ch#3D%c",.ch)#0D#0A#0D#0A..2CASE.'*s':.L
OOP.//.Ignore.spaces.within.expressions#0D#0A#0D#0A
..2CASE.'#2E':#0D#0A..2CASE.'0':.CASE.'1':.CASE.'2'
:.CASE.'3':.CASE.'4':#0D#0A..2CASE.'5':.CASE.'6':.C
ASE.'7':.CASE.'8':.CASE.'9':#0D#0A..12RESULTIS..bgr
dnum()#0D#0A#0D#0A..2CASE.'+':.RESULTIS..bgexp(2)#0D
#0A..2CASE.'-':.RESULTIS.-bgexp(2)#0D#0A#0D#0A..2CA
SE.'(':.{.LET.res.#3D.bgexp(1)#0D#0A..14bg_ch.:#3D.
getargch()#0D#0A..14RESULTIS.res#0D#0A..12}#0D#0A..
}#0D#0A}.REPEAT#0D#0A#0D#0AAND.bgexp(n).#3D.VALOF#0D
#0A{.LET.a.#3D.bgbexp()#0D#0A#0D#0A..{.SWITCHON.bg_
ch.INTO#0D#0A..2{.DEFAULT:..1IF.n>1.|.n#3D1.&.bg_ch
#3D')'.|.n#3D0.&.bg_ch#3Ds_eof.RESULTIS.a#0D#0A..4e
rr:..5bg_error("Bad.expression")#0D#0A..4CASE.'*s':
.bg_ch.:#3D.getargch().//.Ignore.spaces.within.expr
essions#0D#0A..15LOOP#0D#0A#0D#0A..4CASE.'R':..30//
.R..1(right.shift)#0D#0A..4CASE.'r':..IF.n<6.DO.{.L
ET.b.#3D.bgexp(6)#0D#0A..27a.:#3D.a>>b#0D#0A..27LOO
P#0D#0A..25}#0D#0A..15RESULTIS.a#0D#0A#0D#0A..4CASE
.'L':..30//.L..1(left.shift)#0D#0A..4CASE.'l':..IF.
n<6.DO.{.LET.b.#3D.bgexp(6)#0D#0A..27a.:#3D.a<<b#0D
#0A..27LOOP#0D#0A..25}#0D#0A..15RESULTIS.a#0D#0A..4
CASE.'**':.IF.n<5.DO.{.a.:#3D.muldiv(a,.bgexp(5),..
0001_001);.LOOP.}#0D#0A..15RESULTIS.a#0D#0A..4CASE.
'/':..IF.n<5.DO.{.a.:#3D.muldiv(a,..0001_001,.bgexp
(5));.LOOP.}#0D#0A..15RESULTIS.a#0D#0A..4CASE.'+':.
.IF.n<4.DO.{.a.:#3D.a..+..bgexp(4);.LOOP.}#0D#0A..1
5RESULTIS.a#0D#0A..4CASE.'-':..IF.n<4.DO.{.a.:#3D.a
..-..bgexp(4);.LOOP.}#0D#0A..15RESULTIS.a#0D#0A..4C
ASE.'&':..IF.n<3.DO.{.LET.b.#3D.bgexp(3)#0D#0A..27a
.:#3D.a.&.b#0D#0A..27LOOP#0D#0A..25}#0D#0A..15RESUL
TIS.a#0D#0A..4CASE.'|':..IF.n<2.DO.{.LET.b.#3D.bgex
p(2)#0D#0A..27a.:#3D.a.|.b#0D#0A..27LOOP#0D#0A..25}
#0D#0A..15RESULTIS.a#0D#0A..2}#0D#0A..}.REPEAT#0D#0A
}#0D#0A#0D#0AAND.getargch().#3D.VALOF#0D#0A{.LET.p.
#3D.argp+1#0D#0A..IF.p>#3Dargt.RESULTIS.s_eof#0D#0A
..argp.:#3D.p#0D#0A..ch.:#3D.!p#0D#0A..UNLESS.ch.>#3D
.(1<<00020).RESULTIS.ch#0D#0A..lineno.:#3D.ch#0D#0A
..//.Skip.over.file/line.items#0D#0A}.REPEAT#0D#0A#0D
#0AAND.bgrdnum().#3D.VALOF#0D#0A{.//.Only.used.in.b
exp#0D#0A..LET.val.#3D.0#0D#0A..WHILE.'0'<#3Dbg_ch<
#3D'9'.DO.{.val.:#3D.10*val.+.bg_ch.-.'0'#0D#0A..27
bg_ch.:#3D.getargch()#0D#0A..25}#0D#0A..RESULTIS.va
l#0D#0A}#0D#0A#0D#0AAND.bgwrnum(n).BE#0D#0A{.LET.fr
ac.#3D.?#0D#0A..IF.n<0.DO.{.bgputch('-');.n.:#3D.-n
.}#0D#0A..wrpn(n)#0D#0A}#0D#0A#0D#0AAND.wrpn(n).BE#0D
#0A{.IF.n>9.DO.wrpn(n/10)#0D#0A..bgputch(n.MOD.10.+
.'0')#0D#0A}#0D#0A#0D#0AAND.wrc(ch).BE.IF.-127<#3Dc
h<#3D127.DO#0D#0A{.IF.ch#3D'*n'.DO.{.newline();.chp
os.:#3D.0;.RETURN.}#0D#0A..IF.chpos>70.DO.wrs("*n..
")#0D#0A..TEST.ch<0#0D#0A..THEN.{.writef("'%n'",.ch
)#0D#0A..7chpos.:#3D.chpos+4#0D#0A..5}#0D#0A..ELSE.
{.UNLESS.'*s'<#3Dch<127.DO.ch.:#3D.'?'..//.Assume.7
.bit.ASCII#2E#0D#0A..7wrch(ch)#0D#0A..7IF.ch#3D'*n'
.DO.wrs("..")#0D#0A..7chpos.:#3D.chpos+1#0D#0A..5}#0D
#0A}#0D#0A#0D#0AAND.wrs(s).BE.FOR.i.#3D.1.TO.s%0.DO
.wrc(s%i)#0D#0A#0D#0AAND.wrn(n).BE#0D#0A{.IF.n>9.DO
.wrn(n/10)#0D#0A..wrc(n.MOD.10.+.'0')#0D#0A}#0D#0A#0D
#0AAND.bg_error(mess,.a,.b,.c).BE#0D#0A{.LET.out.#3D
.output()#0D#0A..selectoutput(sysout)#0D#0A..wrs("*
n*n#23#237.Error.near");.prlineno(lineno);.wrs(":."
)#0D#0A..writef(mess,.a,.b,.c)#0D#0A..//error()#0D#0A
..selectoutput(out)#0D#0A}#0D#0A#0D#0AAND.error().B
E#0D#0A{.wrs("*nIncomplete.calls:*n")#0D#0A..IF.bg_
f.DO.prcall(3,.bg_f,.bg_h,.bg_s)#0D#0A..wrs("Active
.macro.calls:*n");.btrace(bg_p,.3)#0D#0A..//wrs("*n
Environment:*n");..wrenv(bg_e,.20)#0D#0A..//wrs("#23
#237.End.of.error.message*n")#0D#0A..wrc('*n')#0D#0A
#0D#0A..errcount.:#3D.errcount+1#0D#0A..IF.errcount
.>#3D.errmax.DO.fatalerr("*nToo.many.errors")#0D#0A
..#0D#0A..selectoutput(tostream)#0D#0A..longjump(re
c_p,.rec_l)#0D#0A}#0D#0A#0D#0AAND.prcall(n,.f,.h,.s
).BE.UNLESS.f#3D0.TEST.n#3D0#0D#0A..35THEN.wrs(".#2E
#2E1")#0D#0A..35ELSE.{.prcall(n-1,.!f,.f!1,.f-1)#0D
#0A..42!h.:#3D.s-h#0D#0A..42wrcall(f+5,.s)#0D#0A..4
0}#0D#0A#0D#0AAND.btrace(p,.n).BE#0D#0A{.IF.n#3D0.D
O.wrs(".#2E#2E1*n")#0D#0A..IF.p#3D0.|.n#3D0.RETURN#0D
#0A..wrcall(p+5,.p!4);.wrc(c_apply);.wrc('*n')#0D#0A
..p,.n.:#3D.!p,.n-1#0D#0A}.REPEAT#0D#0A#0D#0AAND.wr
call(a,.b).BE#0D#0A{.LET.sep.#3D.c_call#0D#0A..LET.
lno.#3D.a!1#0D#0A..LET.filename.#3D.sourcenamev!(ln
o>>00020)#0D#0A..LET.ln.#3D.lno.&.#23xFF3#0D#0A..wr
c('*s')#0D#0A..FOR.i.#3D.1.TO.filename%0.DO.wrc(fil
ename%i)#0D#0A..wrc('[')#0D#0A..wrn(ln)#0D#0A..wrs(
"]:.")#0D#0A.#0D#0A..UNTIL.a>#3Db.DO.{.wrc(sep);.wr
arg(a)#0D#0A..16a.:#3D.a.+.!a.+.1#0D#0A..16sep.:#3D
.c_sep#0D#0A..14}#0D#0A}#0D#0A#0D#0AAND.wrarg(a).BE
#0D#0A{.LET.len.#3D.!a#0D#0A..IF.len.>.60.DO.len.:#3D
.60#0D#0A..FOR.ptr.#3D.a+2.TO.a.+.len.DO.wrc(!ptr)#0D
#0A..IF.!a.>.60.DO.wrs(".#2E#2E1")#0D#0A}#0D#0A#0D#0A
AND.wrenv(e,.n).BE.UNTIL.e#3D0.DO#0D#0A{.LET.name..
#3D.arg(e+2,.0)#0D#0A..LET.value.#3D.arg(e+2,.1)#0D
#0A..IF.n#3D0.DO.{.wrs(".#2E#2E1*n");.RETURN.}#0D#0A
..wrs(".Name:.");..1wrarg(name);.FOR.i.#3D.!name.TO
.12.DO.wrc('*s')#0D#0A..wrs("..Value:.");.wrarg(val
ue)#0D#0A..wrc('*n')#0D#0A..e,.n.:#3D.!e,.n-1#0D#0A
}#0D#0A#0D#0ALET.newvec(n).#3D.VALOF#0D#0A{.LET.p.#3D
.blkp#0D#0A..LET.blkupb.#3D.10_001#0D#0A..blkp.:#3D
.p+n+1#0D#0A..IF.blkp>#3Dblkt.DO#0D#0A..{.LET.v.#3D
.getvec(blkupb).//.Get.some.more.space#0D#0A//write
f("newvec:.allocation.block.%n.upb.%n*n",.v,.blkupb
)#0D#0A..2UNLESS.v.&.n<blkupb.DO#0D#0A..2{.bg_error
("System.error:.newvec.failure*n")#0D#0A..4abort(99
1)#0D#0A..2}#0D#0A..2#0D#0A..2v!0.:#3D.blklist#0D#0A
..2blklist.:#3D.v#0D#0A..2blkt.:#3D.v+blkupb#0D#0A.
.2p..2:#3D.v+1#0D#0A..2blkp.:#3D.p+n+1#0D#0A..}#0D#0A
//writef("newvec:.allocated.p#3D%n.n#3D%i4.blklist#3D
%n*n",#0D#0A//..7p,.n,.blklist)#0D#0A..RESULTIS.p#0D
#0A}#0D#0A.#0D#0AAND.mk1(x).#3D.VALOF#0D#0A{.LET.p.
#3D.newvec(0)#0D#0A..p!0.:#3D.x#0D#0A..RESULTIS.p#0D
#0A}#0D#0A.#0D#0AAND.mk2(x,.y).#3D.VALOF#0D#0A{.LET
.p.#3D.newvec(1)#0D#0A..p!0,.p!1.:#3D.x,.y#0D#0A..R
ESULTIS.p#0D#0A}#0D#0A.#0D#0AAND.mk3(x,.y,.z).#3D.V
ALOF#0D#0A{.LET.p.#3D.newvec(2).//.Allocate.a.new.n
ode#0D#0A..p!0,.p!1,.p!2.:#3D.x,.y,.z#0D#0A..RESULT
IS.p#0D#0A}#0D#0A.#0D#0AAND.mk4(x,.y,.z,.t).#3D.VAL
OF#0D#0A{.LET.p.#3D.newvec(3)#0D#0A..p!0,.p!1,.p!2,
.p!3.:#3D.x,.y,.z,.t#0D#0A..RESULTIS.p#0D#0A}#0D#0A
.#0D#0AAND.mk5(x,.y,.z,.t,.u).#3D.VALOF#0D#0A{.LET.
p.#3D.newvec(4)#0D#0A..p!0,.p!1,.p!2,.p!3,.p!4.:#3D
.x,.y,.z,.t,.u#0D#0A..RESULTIS.p#0D#0A}#0D#0A.#0D#0A
AND.mk6(x,.y,.z,.t,.u,.v).#3D.VALOF#0D#0A{.LET.p.#3D
.newvec(5)#0D#0A..p!0,.p!1,.p!2,.p!3,.p!4,.p!5.:#3D
.x,.y,.z,.t,.u,.v#0D#0A..RESULTIS.p#0D#0A}#0D#0A.#0D
#0AAND.mk7(x,.y,.z,.t,.u,.v,.w).#3D.VALOF#0D#0A{.LE
T.p.#3D.newvec(6)#0D#0A..p!0,.p!1,.p!2,.p!3,.p!4,.p
!5,.p!6.:#3D.x,.y,.z,.t,.u,.v,.w#0D#0A..RESULTIS.p#0D
#0A}#0D#0A#0D#0AAND.mk8(a,.b,.c,.d,.e,.f,.g,.h).#3D
.VALOF#0D#0A{.LET.p.#3D.newvec(7)#0D#0A..p!0,.p!1,.
p!2,.p!3,.p!4,.p!5,.p!6,.p!7.:#3D.a,.b,.c,.d,.e,.f,
.g,.h#0D#0A..RESULTIS.p#0D#0A}#0D#0A#0D#0AAND.mk9(a
,.b,.c,.d,.e,.f,.g,.h,.i).#3D.VALOF#0D#0A{.LET.p.#3D
.newvec(8)#0D#0A..p!0,.p!1,.p!2,.p!3,.p!4,.p!5,.p!6
,.p!7,.p!8.:#3D.a,.b,.c,.d,.e,.f,.g,.h,.i#0D#0A..RE
SULTIS.p#0D#0A}#0D#0A#0D#0ALET.rch().BE#0D#0A{.ch.:
#3D.callco(bgpmco)#0D#0A//writef("*nrch:.ch#3D%x8*n
",.ch)#0D#0A..UNLESS.ch#3Dendstreamch.DO#0D#0A..{.c
hcount.:#3D.chcount+1#0D#0A..2chbuf%(chcount&63).:#3D
.ch#0D#0A..}#0D#0A}#0D#0A#0D#0AAND.lex().BE#0D#0A{.
//..1<#3D..9->.dependson#0D#0A..//..1<<.#2E#2E1.>>.
.2->.com#0D#0A..//..1#2E#2E1..8->.item#0D#0A..//..1
endofstream..->.eof#0D#0A#0D#0A..//.Within.a.comman
d.string.or.item,.parameters.<#2E#2E1>.may.occur#0D
#0A#0D#0A..//.Items.are.terminated.by.<#3D,.<<.or.w
hite.space#0D#0A#0D#0A..param,.parampos,.len.:#3D.0
,.0,.0#0D#0A..token.:#3D.s_item.//.Until.proved.oth
erwise#0D#0A#0D#0A//sawritef("lex:.lineno#3D%n/%n.c
h#3D%n.'%c'*n",#0D#0A//..lineno>>00020,.lineno&#23x
FF3,.ch,.ch)#0D#0A#0D#0Asw:#0D#0A..SWITCHON.ch.INTO
#0D#0A..{.DEFAULT:#0D#0A..4IF.ch#3D'>'.&.token#3Ds_
com.DO#0D#0A..4{.//.Check.if.>>#0D#0A..6rch()#0D#0A
..6IF.ch#3D'>'.DO#0D#0A..6{.//.End.of.command.strin
g.reached#0D#0A..8rch()#0D#0A..8//.token#3Ds_com..a
nd.len.is.the.length.of.the.string#0D#0A..8//.held.
in.charv%1.#2E#2E1.charv%len#0D#0A..8RETURN..1//.A.
command.string#0D#0A..6}#0D#0A..6len.:#3D.len.+.1#0D
#0A..6charv%len.:#3D.'>'#0D#0A//writef("charv%%1n#3D
%n*n",.len,.charv%len)#0D#0A..4}#0D#0A..4len.:#3D.l
en.+.1#0D#0A..4charv%len.:#3D.ch#0D#0A//writef("cha
rv%%1n#3D%n*n",.len,.charv%len)#0D#0A..4rch()#0D#0A
..4GOTO.sw#0D#0A#0D#0A..2CASE.endstreamch:#0D#0A..4
IF.len.RETURN.//.An.item.or.command.sequence#0D#0A.
.18//.len.is.the.length.of.the.string#0D#0A..18//.h
eld.in.charv%1.#2E#2E1.charv%len#0D#0A..4token.:#3D
.s_eof#0D#0A..4RETURN..6//.eof#0D#0A#0D#0A..2CASE.'
*p':.CASE.'*n':#0D#0A..2CASE.'*c':.CASE.'*t':.CASE.
'*s':#0D#0A..4IF.token#3Ds_com.DO#0D#0A..4{.//.Copy
.command.string.characters.into.charv#0D#0A..6len.:
#3D.len+1#0D#0A..6charv%len.:#3D.ch#0D#0A..6rch()#0D
#0A..6GOTO.sw#0D#0A..4}#0D#0A..4IF.len.RETURN.//.Re
turn.an.item#0D#0A..4rch()..7//.Ignore.white.space#0D
#0A..4GOTO.sw#0D#0A#0D#0A..2CASE.'<':#0D#0A..4//.It
.might.be#0D#0A..4//..2<#3D#0D#0A..4//..2<<#0D#0A..
4//.or.the.start.a.parameter.<tag>#0D#0A..4rch()#0D
#0A#0D#0A..4IF.ch#3D'#3D'.DO#0D#0A..4{.//.<#3D#0D#0A
..6IF.len.&.token#3Ds_item.DO#0D#0A..6{.ch.:#3D.'<'
#0D#0A..8unrdch().//.Put.'#3D'.back#0D#0A..8RETURN.
.1//.An.item#0D#0A..6}#0D#0A..6token.:#3D.s_depends
on#0D#0A..6rch()#0D#0A..6RETURN#0D#0A..4}#0D#0A#0D#0A
..4IF.ch#3D'<'.DO#0D#0A..4{.//.<<#0D#0A..6IF.len.&.
token#3Ds_item.DO#0D#0A..6{.ch.:#3D.'<'#0D#0A..8unr
dch().//.Put.'<'.back#0D#0A..8RETURN..1//.An.item#0D
#0A..6}#0D#0A..6//.Start.reading.a.command.sequence
#0D#0A..6token.:#3D.s_com#0D#0A..6//.Skip.over.'<'.
and.ignore.white.space#0D#0A..6rch().REPEATWHILE.ch
#3D'*s'.|.ch#3D'*t'.|.ch#3D'*n'#0D#0A..6GOTO.sw#0D#0A
..4}#0D#0A#0D#0A..4//.It.must.be.a.parameter.of.for
m.<#2E#2E1>#0D#0A..4rdtag()#0D#0A..4len.:#3D.len+1#0D
#0A..4charv%len.:#3D.0..//.Indicating.a.parameter#0D
#0A..4parampos.:#3D.len.//.position.of.the.paramete
r#0D#0A//writef("charv%%1n#3D%n*n",.len,.charv%len)
#0D#0A..4GOTO.sw#0D#0A..}#0D#0A}#0D#0A#0D#0AAND.rdt
ag().BE#0D#0A{.//.Read.a.tag..1<.ch.#2E#2E1.>#0D#0A
..LET.i.#3D.1#0D#0A..LET.tag.#3D.0#0D#0A#0D#0A..tag
v%1.:#3D.'<'#0D#0A#0D#0A..{.//.Read.tag.characters#0D
#0A..2UNLESS.'A'<#3Dch<#3D'Z'.|#0D#0A..9'a'<#3Dch<#3D
'z'.|#0D#0A..9'0'<#3Dch<#3D'9'.BREAK#0D#0A..2i.:#3D
.i+1#0D#0A..2IF.i>254.DO.synerr("Parameter.tag.too.
long")#0D#0A..2tagv%i.:#3D.ch#0D#0A..2rch()#0D#0A..
}.REPEAT#0D#0A#0D#0A..UNLESS.ch#3D'>'.DO.synerr("Ba
d.parameter.tag,.ch#3D%c",.ch)#0D#0A..i.:#3D.i+1#0D
#0A..tagv%i.:#3D.'>'#0D#0A..tagv%0.:#3D.i#0D#0A#0D#0A
..rch()#0D#0A..tag.:#3D.lookupword(tagv)#0D#0A..TES
T.param#0D#0A..THEN.UNLESS.param#3Dtag.DO#0D#0A..7s
ynerr("All.parameters.in.a.pattern.must.be.the.same
")#0D#0A..ELSE.param.:#3D.tag#0D#0A}#0D#0A.#0D#0ALE
T.lookupword(word).#3D.VALOF#0D#0A{.//.Return.a.poi
nter.to.[next,.rule,.<packed.string].for.an.item#0D
#0A..//.or.param.string#2E#0D#0A..//.The.next.field
.is.used.for.hash.chains#2E#0D#0A..//.The.rule.fiel
d.will.point.to.the.rule,.if.any,.whose.subject#0D#0A
..//.is.this.item#2E#0D#0A..LET.len,.i.#3D.word%0,.
0#0D#0A..LET.hashval.#3D.len#0D#0A..FOR.i.#3D.1.TO.
len.DO.hashval.:#3D.(13*hashval.+.word%i).&.#23xFF_
FF2#0D#0A..hashval.:#3D.hashval.MOD.nametablesize#0D
#0A..wordnode.:#3D.nametable!hashval#0D#0A.#0D#0A..
WHILE.wordnode.&.i<#3Dlen.TEST.(@h3!wordnode)%i#3Dw
ord%i#0D#0A..24THEN.i.:#3D.i+1#0D#0A..24ELSE.wordno
de,.i.:#3D.!wordnode,.0#0D#0A..UNLESS.wordnode.DO#0D
#0A..{.//.len.#3D.0,.1,.2,.3..#3D>.upb.2#0D#0A..2//
.len.#3D.4,.5,.6,.7..#3D>.upb.3,..etc#0D#0A..2wordn
ode.:#3D.newvec(len/bytesperword+2)#0D#0A..2//.Inse
rt.at.head.of.hash.chain#0D#0A..2h1!wordnode.:#3D.n
ametable!hashval#0D#0A..2nametable!hashval.:#3D.wor
dnode#0D#0A..2h2!wordnode.:#3D.0..//.The.rule.point
er.is.not.yet.known#0D#0A..2FOR.i.#3D.0.TO.len.DO.(
@h3!wordnode)%i.:#3D.word%i#0D#0A..}#0D#0A//writef(
"lookupword:.wordnode#3D%n.%s*n",.wordnode,.@h3!wor
dnode)#0D#0A..RESULTIS.wordnode#0D#0A}#0D#0A.#0D#0A
AND.wrchbuf().BE#0D#0A{.writes("*n#2E#2E1")#0D#0A..
FOR.p.#3D.chcount-63.TO.chcount.DO#0D#0A..{.LET.k.#3D
.chbuf%(p&63)#0D#0A..2IF.0<k<255.DO.wrch(k)#0D#0A..
}#0D#0A..newline()#0D#0A}#0D#0A.#0D#0AAND.parse().#3D
.VALOF#0D#0A{.LET.res.#3D.0#0D#0A..rec_p,.rec_l.:#3D
.level(),.recover#0D#0A#0D#0A..rulelist,.ruleliste.
:#3D.0,.@rulelist#0D#0A..patnlist,.patnliste.:#3D.0
,.@patnlist#0D#0A#0D#0A..charv.:#3D.newvec(charvupb
/bytesperword)..3#0D#0A..tagv.:#3D.newvec(256/bytes
perword)..3#0D#0A..nametable.:#3D.newvec(nametables
ize)#0D#0A..UNLESS.tagv.&.charv.&.nametable.DO#0D#0A
..2fatalerr("More.workspace.needed")#0D#0A..FOR.i.#3D
.0.TO.nametablesize.DO.nametable!i.:#3D.0#0D#0A#0D#0A
..IF.optTokens.DO.newline()#0D#0A#0D#0A..//.Create.
the.target.item.if.the.target.is.explicitly.given#2E
#0D#0A#0D#0A..IF.targetstr.DO.targetitem.:#3D.looku
pword(targetstr)#0D#0A#0D#0A..//.Now.process.the.bm
akefile#0D#0A#0D#0A..lex()#0D#0A#0D#0A..WHILE.optTo
kens.DO#0D#0A..{.//.Loop.to.test.the.lexical.analys
er#0D#0A..2writef("%t9",.opstr(token))#0D#0A#0D#0A.
.2SWITCHON.token.INTO#0D#0A..2{.DEFAULT:#0D#0A..7wr
itef("Bad.token.%t9*n",.opstr(token))#0D#0A..7ENDCA
SE#0D#0A#0D#0A..4CASE.s_item:#0D#0A..7FOR.i.#3D.1.T
O.len.DO#0D#0A..7{.LET.c.#3D.charv%i#0D#0A..9TEST.c
#0D#0A..9THEN.wrch(c)#0D#0A..9ELSE.writef("%s",.@h3
!param)#0D#0A..7}#0D#0A..7newline()#0D#0A..7ENDCASE
#0D#0A#0D#0A..4CASE.s_dependson:#0D#0A..7newline()#0D
#0A..7ENDCASE#0D#0A#0D#0A..4CASE.s_eof:#0D#0A..7new
line()#0D#0A..7RESULTIS.0#0D#0A#0D#0A..4CASE.s_com:
#0D#0A..7writef("*n<<*n")#0D#0A..7FOR.i.#3D.1.TO.le
n.DO#0D#0A..7{.LET.c.#3D.charv%i#0D#0A..9TEST.c#0D#0A
..9THEN.wrch(c)#0D#0A..9ELSE.writef("%s",.@h3!param
)#0D#0A..7}#0D#0A..7writef(">>*n")#0D#0A..7param.:#3D
.0#0D#0A..7ENDCASE#0D#0A..2}#0D#0A#0D#0A..2lex()#0D
#0A..}#0D#0A#0D#0A#0D#0Arecover:#0D#0A..IF.optToken
s.RESULTIS.0#0D#0A#0D#0A..//.Read.in.the.rules.and.
patterns#0D#0A#0D#0A..UNTIL.token#3Ds_eof.DO#0D#0A.
.{.LET.ln,.subject,.dpns,.com,.par.#3D.lineno,.0,.0
,.0,.0#0D#0A#0D#0A//writef("Expecting.item:.token#3D
%n.%s*n",.token,.opstr(token))#0D#0A#0D#0A..2UNLESS
.token#3Ds_item.DO.synerr("Target-item.expected")#0D
#0A#0D#0A..2IF.param.DO#0D#0A..2{.par.:#3D.param#0D
#0A..4//writef("Pattern.with.parameter.%s*n",.@h3!p
ar)#0D#0A..2}#0D#0A#0D#0A..2charv%0.:#3D.len#0D#0A.
.2subject.:#3D.lookupword(charv)#0D#0A..2IF.param.D
O.h2!subject.:#3D.parampos#0D#0A..2//.subject.->.[c
hain,..0010,.<packed.chars>].//.If.non.pattern.item
#0D#0A..2//.subject.->.[chain,.pos,.<packed.chars>]
.//.If.pattern.item#0D#0A#0D#0A..2lex()#0D#0A//writ
ef("Expecting.dependson.or.com:.token#3D%n.%s*n",.t
oken,.opstr(token))#0D#0A#0D#0A..2IF.token#3Ds_depe
ndson.DO#0D#0A..2{.//.Read.the.depends.on.list#0D#0A
..4LET.dpnse.#3D.@dpns#0D#0A..4lex()..1//.Skip.over
.<#3D#0D#0A#0D#0A..4//.read.zero.or.more.items#0D#0A
..4WHILE.token#3Ds_item.DO#0D#0A..4{.LET.node.#3D.0
#0D#0A..6charv%0.:#3D.len#0D#0A..6lookupword(charv)
#0D#0A..6IF.param.DO.h2!wordnode.:#3D.parampos#0D#0A
..6node.:#3D.mk2(0,.wordnode)#0D#0A//writef("dpns.n
ode#3D%n.wordnode#3D%n.%s*n",.node,.wordnode,.@h3!w
ordnode)#0D#0A..6UNLESS.node.DO.fatalsynerr("Out.of
.space")#0D#0A..6//.Append.this.item.to.the.end.of.
the.list#0D#0A..6!dpnse.:#3D.node#0D#0A..6dpnse.:#3D
.node#0D#0A..6//.If.the.item.contains.a.parameter.i
t.must.have.been.declared#0D#0A..6//.in.the.subject
.item#0D#0A..6TEST.par#0D#0A..6THEN.UNLESS.param#3D
0.|.par#3Dparam.DO#0D#0A..13synerr("Parameter.%s.sh
ould.be.%s*n",.@h3!param,.@h3!par)#0D#0A..6ELSE.IF.
param.DO#0D#0A..13synerr("Parameter.%s.not.allowed.
in.a.rule",.@h3!param)#0D#0A..6lex()#0D#0A..4}#0D#0A
..2}#0D#0A#0D#0A..2//.Now.read.the.command.sequence
.(enclosed.in.<<.and.>>)#0D#0A//writef("Expecting.c
om:.token#3D%n.%s*n",.token,.opstr(token))#0D#0A..2
UNLESS.token#3Ds_com.DO.synerr("<<.#2E#2E1.>>.expec
ted")#0D#0A#0D#0A..2{.//.token.#3D.s_com..and#0D#0A
..4//.len.(may.be.zero).holds.the.number.of.charact
ers,.ie#0D#0A..4//.charv%1.#2E#2E1.charv%len..are.t
he.characters.of.the.command.sequence#0D#0A#0D#0A..
4//.Make.a.command.node.of.the.form:#0D#0A..4//..1c
om.->.[len,.<packed.chars>]#0D#0A..4//.Since.the.le
ngth.may.be.greater.than.255.it.is.held.in.com!0#0D
#0A..4//.not.in.(com+1)%0#2E#0D#0A..4//.The.packed.
characters.are.in.(com+1)%1.#2E#2E1.(com+1)%len#0D#0A
..4LET.upb.#3D.2.+.len/bytesperword#0D#0A..4//.len.
#3D.0,.1,.2,.3..#3D>..upb.#3D.2#0D#0A..4//.len.#3D.
4,.5,.6,.7..#3D>..upb.#3D.3,.etc#0D#0A..4com.:#3D.n
ewvec(upb)#0D#0A..4UNLESS.com.DO.synerr("More.space
.needed")#0D#0A..4com!0.:#3D.len#0D#0A..4FOR.i.#3D.
1.TO.len.DO.(com+1)%i.:#3D.charv%i#0D#0A//..4writef
("*ncom#3D%n.allocated*n",.com)#0D#0A..2}#0D#0A#0D#0A
..2TEST.par#0D#0A..2THEN.UNLESS.par#3Dparam.DO#0D#0A
..9synerr("Parameter.%s.should.be.%s*n",.@h3!param,
.@h3!par)#0D#0A..2ELSE.IF.param.DO#0D#0A..9synerr("
Parameter.%s.not.allowed.in.a.rule",.@h3!param)#0D#0A
#0D#0A..2//.Append.the.rule.or.pattern.onto.the.end
.of.the.appropriate.list#2E#0D#0A..2TEST.par#0D#0A.
.2THEN.{.!patnliste.:#3D.mk6(0,.ln,.subject,.dpns,.
com,.par)#0D#0A..9patnliste.:#3D.!patnliste#0D#0A//
writef("Added.pattern.%n*n",.patnliste)#0D#0A..7}#0D
#0A..2ELSE.{.//.subject.->.[chain,.rule,.<packed.ch
ars>]#0D#0A..9!ruleliste.:#3D.mk9(0,.ln,.subject,.d
pns,.com,#0D#0A..26-1,.//.state#0D#0A..0270,.//.day
s..)..modification.time.of.the.subject#0D#0A..0270,
.//.msecs.)#0D#0A..0270).//.ticks.for.compatibility
.with.old.dat.format#0D#0A..9ruleliste.:#3D.!ruleli
ste#0D#0A..9IF.h2!subject.DO.synerr("Second.rule.fo
r.subject.%s",.@h3!subject)#0D#0A..9h2!subject.:#3D
.ruleliste#0D#0A..7}#0D#0A#0D#0A..2lex()..3//.Skip.
over.the.body#0D#0A..}#0D#0A#0D#0A..RESULTIS.res#0D
#0A}#0D#0A#0D#0AAND.fatalerr(mess,.a,.b,.c).BE#0D#0A
{.selectoutput(sysout)#0D#0A..writes("*nError:.")#0D
#0A..writef(mess,.a,.b,.c)#0D#0A..writes("*nBMAKE.a
borted*n")#0D#0A..longjump(fin_p,.fin_l)#0D#0A}#0D#0A
.#0D#0AAND.fatalsynerr(mess,.a,.b).BE#0D#0A{.select
output(sysout)#0D#0A..writef("*nError.near.line:.."
);.prlineno(lineno);.newline()#0D#0A..writef(mess,.
a,.b)#0D#0A..writef("*nRecent.text:*n")#0D#0A..wrch
buf()#0D#0A..errcount.:#3D.errcount+1#0D#0A..writes
("*nBMAKE.aborted*n")#0D#0A..longjump(fin_p,.fin_l)
#0D#0A}#0D#0A#0D#0AAND.synerr(mess,.a,.b,.c).BE#0D#0A
{.LET.out.#3D.output()#0D#0A..selectoutput(sysout)#0D
#0A..writef("*nError.near.line:..");.prlineno(linen
o);.newline()#0D#0A..writef(mess,.a,.b,.c)#0D#0A..w
rchbuf()#0D#0A..//.Skip.the.rest.of.the.input.line.
#0D#0A..UNTIL.ch#3D'*n'.|.ch#3Dendstreamch.DO.rch()
#0D#0A..lex()#0D#0A..error("")#0D#0A..errcount.:#3D
.errcount+1#0D#0A..IF.errcount.>#3D.errmax.DO.fatal
err("Too.many.errors")#0D#0A#0D#0A//abort(1001)#0D#0A
..selectoutput(out)#0D#0A..longjump(rec_p,.rec_l)#0D
#0A}#0D#0A#0D#0AAND.prrule(p).BE#0D#0A{.//.p.->.[ne
xt,.ln,.subject,.dpns,.com,.state,.days,.msecs,.-]#0D
#0A..LET.s.#3D.@h3!(n_subj!p)#0D#0A..LET.q.#3D.n_dp
ns!p#0D#0A..LET.com.#3D.n_com!p#0D#0A..LET.dstrings
.#3D.VEC.14#0D#0A..dat_to_strings(@n_days!p,.dstrin
gs)#0D#0A#0D#0A..//writef("%i6..",.p)#0D#0A..writef
("%s.<#3D..Date:.%s.%s..1",.s,.dstrings,.dstrings+5
)#0D#0A..IF.n_ln!p.DO.prlineno(n_ln!p)#0D#0A..newli
ne()#0D#0A#0D#0A..WHILE.q.DO#0D#0A..{.//.q.->.[next
,.item]#0D#0A..2LET.s.#3D.@h3!(h2!q)#0D#0A..2writef
("..3%s*n",.s)#0D#0A..2q.:#3D.!q#0D#0A..}#0D#0A#0D#0A
..writef("<<*n")#0D#0A..TEST.com#0D#0A..THEN.FOR.i.
#3D.1.TO.h1!com.DO.wrch((com+1)%i)#0D#0A..ELSE.writ
ef("default-rule")#0D#0A..writef("*n>>*n*n")#0D#0A}
#0D#0A#0D#0AAND.prpatn(p).BE#0D#0A{.//.p.->.[next,.
ln,.subject,.dpns,.com,.param]#0D#0A..LET.s..1#3D.@
h3!(n_subj!p)#0D#0A..LET.q..1#3D.n_dpns!p#0D#0A..LE
T.com.#3D.n_com!p#0D#0A..LET.parstr.#3D.@h3!(n_para
m!p)#0D#0A#0D#0A..FOR.i.#3D.1.TO.s%0.DO#0D#0A..{.LE
T.c.#3D.s%i#0D#0A..2TEST.c#0D#0A..2THEN.wrch(c)#0D#0A
..2ELSE.writef("%s",.parstr)#0D#0A..}#0D#0A#0D#0A..
writef(".<#3D..1")#0D#0A..prlineno(n_ln!p)#0D#0A..n
ewline()#0D#0A#0D#0A..WHILE.q.DO#0D#0A..{.LET.s.#3D
.@h3!(h2!q)#0D#0A..2writef("..3")#0D#0A..2FOR.i.#3D
.1.TO.s%0.DO#0D#0A..2{.LET.c.#3D.s%i#0D#0A..4TEST.c
#0D#0A..4THEN.wrch(c)#0D#0A..4ELSE.writef("%s",.par
str)#0D#0A..2}#0D#0A..2newline()#0D#0A..2q.:#3D.!q#0D
#0A..}#0D#0A#0D#0A..writef("<<*n")#0D#0A//writef("p
arstr.#3D.%s.com#3D%n*n",.parstr,.com)#0D#0A..IF.co
m.FOR.i.#3D.1.TO.h1!com.DO#0D#0A..{.LET.c.#3D.(com+
1)%i#0D#0A..2TEST.c#0D#0A..2THEN.wrch(c)#0D#0A..2EL
SE.writef("%s",.parstr)#0D#0A..}#0D#0A..writef("*n>
>*n*n")#0D#0A}#0D#0A#0D#0AAND.pritemstr(str,.parstr
).BE#0D#0A{.FOR.i.#3D.1.TO.str%0.DO#0D#0A..{.LET.c.
#3D.str%i#0D#0A//writef("pritemstr:.c#3D%n*n",.c)#0D
#0A..2TEST.c#0D#0A..2THEN.wrch(c)#0D#0A..2ELSE.writ
ef("%s",.parstr)#0D#0A..}#0D#0A}#0D#0A#0D#0AAND.ops
tr(tok).#3D.VALOF.SWITCHON.tok.INTO#0D#0A{.DEFAULT:
..8RESULTIS."Unknown.op"#0D#0A#0D#0A..CASE.s_com:..
5RESULTIS."Com"#0D#0A..CASE.s_dependson:.RESULTIS."
Dependson"#0D#0A..CASE.s_eof:..5RESULTIS."Eof"#0D#0A
..CASE.s_item:..4RESULTIS."Item"#0D#0A}#0D#0A#0D#0A
AND.apply_patterns().BE#0D#0A{.//.Ensure.that.items
.in.the.rule.list.have.a.defining.rule#0D#0A..//.us
ing.patterns.to.create.them.if.necessary#2E#0D#0A..
LET.r.#3D.rulelist#0D#0A#0D#0A..IF.targetitem.DO.fi
ndrulefor(targetitem)#0D#0A#0D#0A..WHILE.r.DO#0D#0A
..{.//.Iterate.through.all.the.rules.in.the.rule.li
st#0D#0A..2//.including.new.rules.added.during.the.
proccess#2E#0D#0A..2LET.dpns.#3D.n_dpns!r#0D#0A..2L
ET.subjstr.#3D.@h3!(n_subj!r)#0D#0A..2LET.rc.#3D.sy
s(Sys_filemodtime,.subjstr,.@n_days!r).#0D#0A..2LET
.dstrings.#3D.VEC.14#0D#0A#0D#0A//..2writef("*nappl
y_patterns:.processing.rule.%n.with.subject.%s*n",#0D
#0A//..10r,.subjstr)#0D#0A#0D#0A..2dat_to_strings(@
n_days!r,.dstrings)#0D#0A.//writef("apply_pattern:.
file.%s.mod.time.%s.%s*n",.subjstr,.dstrings,.dstri
ngs+5)#0D#0A#0D#0A..2WHILE.dpns.DO#0D#0A..2{.//.Ite
rate.through.the.items.in.the.depends.on.list#0D#0A
..4LET.item.#3D.h2!dpns#0D#0A..4findrulefor(item)#0D
#0A..4dpns.:#3D.!dpns#0D#0A..2}#0D#0A#0D#0A..2r.:#3D
.!r#0D#0A..}#0D#0A}#0D#0A#0D#0AAND.findrulefor(item
).BE#0D#0A{.LET.itemstr.#3D.@h3!item#0D#0A..LET.rul
e.#3D.h2!item#0D#0A..LET.p.#3D.patnlist#0D#0A..IF.r
ule.RETURN#0D#0A#0D#0A..//writef("findrulefor:.look
ing.for.pattern.for.%s*n",.@h3!item)#0D#0A#0D#0A..W
HILE.p.DO#0D#0A..{.LET.subj.#3D.n_subj!p#0D#0A..2LE
T.parstr.#3D.@h3!(n_param!p)#0D#0A..2LET.subjstr.#3D
.@h3!subj#0D#0A..2LET.pos.#3D.h2!subj#0D#0A#0D#0A..
2IF.match(itemstr,.subjstr,.pos,.tagv).DO#0D#0A..2{
.//.Matching.pattern.found#0D#0A..4LET.ln.#3D.n_ln!
p..4//.Line.number.of.the.pattern#0D#0A..4LET.dpns.
#3D.n_dpns!p#0D#0A..4LET.com.#3D.n_com!p#0D#0A..4LE
T.newdpns.#3D.0..4//.For.the.new.depends.on.list#0D
#0A..4LET.dpe.#3D.@newdpns#0D#0A..4LET.newcom.#3D.0
..5//.For.the.new.command.sequence#0D#0A#0D#0AIF.de
bug.DO#0D#0A..writef("Making.rule.from.pattern.for.
%s.tagv#3D%s*n",.itemstr,.tagv)#0D#0A#0D#0A..4WHILE
.dpns.DO#0D#0A..4{.//.Append.a.new.depends.on.item#0D
#0A..6LET.dpnsitem.#3D.h2!dpns#0D#0A..6LET.str.#3D.
@h3!dpnsitem.#0D#0A..6LET.len.#3D.0#0D#0A..6LET.dpn
ode.#3D.0#0D#0A..6FOR.i.#3D.1.TO.str%0.DO#0D#0A..6{
.LET.c.#3D.str%i#0D#0A..8TEST.c#0D#0A..8THEN.{.len.
:#3D.len+1#0D#0A..15charv%len.:#3D.c#0D#0A..13}#0D#0A
..8ELSE.FOR.i.#3D.1.TO.tagv%0.DO#0D#0A..13{.len.:#3D
.len+1#0D#0A..15charv%len.:#3D.tagv%i#0D#0A..13}#0D
#0A..6}#0D#0A..6charv%0.:#3D.len#0D#0A..6lookupword
(charv)#0D#0A//writef("findrulefor:.appending.dpns.
item.%s*n",.charv)#0D#0A..6//.Append.depends.on.ite
m#0D#0A..6dpnode.:#3D.mk2(0,.wordnode)#0D#0A..6!dpe
.:#3D.dpnode#0D#0A..6dpe.:#3D.dpnode#0D#0A#0D#0A..6
dpns.:#3D.!dpns#0D#0A..4}#0D#0A#0D#0A//writef("find
rulefor:.building.new.command.sequence,.com#3D%n*n"
,.com)#0D#0A#0D#0A..4IF.com.DO#0D#0A..4{.//.Now.bui
ld.a.new.command.sequence#0D#0A..6LET.len.#3D.0#0D#0A
..6LET.comstrlen.#3D.h1!com#0D#0A..6LET.comstr..2#3D
.@h2!com#0D#0A..6LET.upb..5#3D.0#0D#0A#0D#0A//comst
r%0.:#3D.comstrlen#0D#0A//writef("findrulefor:.coms
trlen.#3D.%n.%s.tagv#3D%s*n",.comstrlen,.comstr,.ta
gv)#0D#0A//abort(1001)#0D#0A#0D#0A..6FOR.i.#3D.1.TO
.comstrlen.DO#0D#0A..6{.LET.c.#3D.comstr%i#0D#0A..8
TEST.c#0D#0A..8THEN.{.len.:#3D.len+1#0D#0A..15charv
%len.:#3D.c#0D#0A..13}#0D#0A..8ELSE.FOR.i.#3D.1.TO.
tagv%0.DO#0D#0A..13{.len.:#3D.len+1#0D#0A..15charv%
len.:#3D.tagv%i#0D#0A..13}#0D#0A..6}#0D#0A#0D#0A..6
//.Make.a.command.node.of.the.form:#0D#0A..6//..1ne
wcom.->.[len,.<packed.chars>]#0D#0A..6//.Since.the.
length.may.be.greater.than.255.it.is.held.in.newcom
!0#0D#0A..6//.not.in.(newcom+1)%0#2E#0D#0A..6//.The
.packed.characters.are.in.(newcom+1)%1.#2E#2E1.(new
com+1)%len#0D#0A..6upb.:#3D.2.+.len/bytesperword#0D
#0A..6//.len.#3D.0,.1,.2,.3..#3D>..upb.#3D.2#0D#0A.
.6//.len.#3D.4,.5,.6,.7..#3D>..upb.#3D.3,.etc#0D#0A
..6newcom.:#3D.newvec(upb)#0D#0A..6UNLESS.com.DO.sy
nerr("More.space.needed")#0D#0A..6newcom!0.:#3D.len
#0D#0A..6(newcom+1)%0.:#3D.len#0D#0A..6FOR.i.#3D.1.
TO.len.DO.(newcom+1)%i.:#3D.charv%i#0D#0A//..4write
f("*nnewcom#3D%n.allocated*n",.newcom)#0D#0A//abort
(1000001)#0D#0A..4}..4#0D#0A#0D#0A..4//.Append.the.
corresponding.rule#0D#0A..4//writef("Building.new.r
ule.from.pattern*n")#0D#0A#0D#0A#0D#0A..4!ruleliste
.:#3D.mk9(0,.ln,.item,.newdpns,.newcom,#0D#0A..21-1
,.//.state#0D#0A..0220,.//.days..)..modification.ti
me.of.the.subject#0D#0A..0220,.//.msecs.)#0D#0A..02
20).//.ticks.for.compatibility.with.old.dat.format#0D
#0A..4ruleliste.:#3D.!ruleliste#0D#0A..4h2!item..1:
#3D.ruleliste#0D#0A..4RETURN#0D#0A..2}#0D#0A..2p.:#3D
.!p#0D#0A..}#0D#0A#0D#0A..//.No.pattern.found#0D#0A
IF.debug.DO#0D#0A..writef("Making.default.rule.for.
%s*n",.@h3!item)#0D#0A#0D#0A..!ruleliste.:#3D.mk9(0
,.0,.item,.0,.0,#0D#0A..17-1,.//.state#0D#0A..0180,
.//.days..)..modification.time.of.the.subject#0D#0A
..0180,.//.msecs.)#0D#0A..0180).//.ticks.for.compat
ibility.with.old.dat.format#0D#0A..ruleliste.:#3D.!
ruleliste#0D#0A..h2!item..1:#3D.ruleliste#0D#0A}#0D
#0A#0D#0AAND.match(itemstr,.subjstr,.pos,.chv).#3D.
VALOF#0D#0A{.LET.itemlen.#3D.itemstr%0#0D#0A..LET.s
ubjlen.#3D.subjstr%0#0D#0A..LET.len.#3D.itemlen.-.s
ubjlen.+.1#0D#0A//writef("match:.itemstr#3D%s.subjs
tr#3D%s.pos#3D%n*n",.itemstr,.subjstr,.pos).#0D#0A.
.//.Is.the.item.string.long.enough?#0D#0A..IF.len.<
.0.RESULTIS.FALSE#0D#0A//writef("match:.length.ok*n
")#0D#0A..//.Check.the.prefix#0D#0A..FOR.i.#3D.1.TO
.pos-1.UNLESS.itemstr%i.#3D.subjstr%i.RESULTIS.FALS
E#0D#0A//writef("match:.prefix.ok*n")#0D#0A..//.Che
ck.the.postfix#0D#0A..FOR.i.#3D.pos+1.TO.subjlen.UN
LESS.itemstr%(len+i-1).#3D.subjstr%i.RESULTIS.FALSE
#0D#0A//writef("match:.postfix.ok*n")#0D#0A..//.The
.match.is.successful#0D#0A..FOR.i.#3D.1.TO.len.DO.c
hv%i.:#3D.itemstr%(pos+i-1)#0D#0A..chv%0.:#3D.len#0D
#0A//writef("match:.itemstr#3D%s.subjstr#3D%s.pos#3D
%n.#3D>.chv#3D%s*n",#0D#0A//..6itemstr,.subjstr,.po
s,.chv).#0D#0A..RESULTIS.TRUE#0D#0A}#0D#0A#0D#0AAND
.generate_commands(item).#3D.VALOF#0D#0A{.//.Bring.
item.up.to.date.generating.any.commands.that.are.ne
eded#0D#0A..//.The.result.and.result2.is.a.date.sta
mp.(days,.msecs)#2E#0D#0A..//.It.is.(0,0).if.the.it
em.does.not.exist.and.has.only.a.default.rule#2E#0D
#0A..//.It.is.(maxint,.0).if.commands.have.been.gen
erated.to.create.it#2E#0D#0A..//.Otherwise.it.is.th
e.date.stamp.of.the.file.corresponding.to.the.item#2E
#0D#0A..LET.rule.#3D.h2!item#0D#0A..LET.state.#3D.n
_state!rule#0D#0A..LET.com.#3D.n_com!rule#0D#0A..LE
T.p.#3D.0#0D#0A..LET.days,.msecs.#3D.1,.0#0D#0A..//
.days#3D1.to.force.an.absent.file.to.be.built.even.
when.it#0D#0A..//.depends.on.no.other.file,.as.in:.
bmake.clean#0D#0A#0D#0A..UNLESS.com.|.n_days!rule.D
O#0D#0A..{.fatalerr("Item.%s.does.not.exist.and.has
.no.rule.to.build.it*n",.@h3!item)#0D#0A..2RESULTIS
.0#0D#0A..}#0D#0A#0D#0A//writef("generate_commands:
.Item.%s.rule#3D%n.com#3D%n*n",.@h3!item,.rule,.com
)#0D#0A//abort(1001)#0D#0A#0D#0A..IF.state#3D1.DO#0D
#0A..{.//.item.depends.directly.or.indirectly.on.it
self#0D#0A..2fatalerr("%s.depends.directly.or.indir
ectly.on.itself*n",.@h3!item)#0D#0A..2n_state!rule.
:#3D.2#0D#0A..2RETURN#0D#0A..}#0D#0A..IF.state#3D2.
DO#0D#0A..{.//.Item.is.up.to.date#0D#0A..2result2.:
#3D.n_msecs!rule#0D#0A..2RESULTIS.n_days!rule#0D#0A
..}#0D#0A#0D#0A..n_state!rule.:#3D.1..//.Start.proc
essing.this.rule#0D#0A#0D#0A..//.First.bring.all.it
s.depends.on.items.up.to.date#0D#0A#0D#0A..p.:#3D.n
_dpns!rule#0D#0A..WHILE.p.DO#0D#0A..{.//.make.a.dep
ends.on.item#0D#0A..2LET.ds.#3D.generate_commands(h
2!p)#0D#0A..2LET.ms.#3D.result2#0D#0A..2IF.ds>days.
|.(ds#3Ddays.&.ms>msecs).DO.days,.msecs.:#3D.ds,.ms
#0D#0A..2p.:#3D.!p#0D#0A..}#0D#0A#0D#0A..n_state!ru
le.:#3D.2.#0D#0A#0D#0A..//.days,msecs.is.the.date.s
tamp.of.the.most.recent.depends.on.item.#0D#0A#0D#0A
IF.debug.DO#0D#0A{.LET.out.#3D.output()#0D#0A..sele
ctoutput(sysout)#0D#0A..writef("Item.%s.com#3D%n*n"
,.@h3!item,.com)#0D#0A..writef("..days#3D%n.n_days!
rule#3D%n*n",.days,.n_days!rule)#0D#0A..writef("..m
secs#3D%n.n_msecs!rule#3D%n*n",.msecs,.n_msecs!rule
)#0D#0A..TEST.days>n_days!rule.|.(days#3Dn_days!rul
e.&.msecs>n_msecs!rule)#0D#0A..THEN.writef("..and.s
o.is.out.of.date*n")#0D#0A..ELSE.writef("..and.so.i
s.up.to.date*n")#0D#0A..selectoutput(out)#0D#0A}#0D
#0A//abort(1000001)#0D#0A#0D#0A..IF.days>n_days!rul
e.|.(days#3Dn_days!rule.&.msecs>n_msecs!rule).DO#0D
#0A..{.//.The.target.is.out.of.date.so.we.must.gene
rate.the.command.sequence#0D#0A..2LET.len.#3D.h1!co
m#0D#0A..2LET.comstr.#3D.@h2!com#0D#0AIF.debug.DO#0D
#0A{.LET.out.#3D.output()#0D#0A..selectoutput(sysou
t)#0D#0A..writef("Generating.commands.to.build.%s*n
",.@h3!item)#0D#0A..selectoutput(out)#0D#0A}#0D#0A/
/abort(1000001)#0D#0A..2FOR.i.#3D.1.TO.len.DO.wrch(
comstr%i)#0D#0A..2newline()#0D#0A..2//.Mark.the.cur
rent.rule.as.up.to.date#0D#0A..2n_days!rule,.n_msec
s!rule.:#3D.maxint,.0#0D#0A..2result2.:#3D.0#0D#0A.
.2RESULTIS.maxint#0D#0A..}#0D#0A#0D#0A..//.The.targ
et.is.already.up.to.date#0D#0A#0D#0AIF.debug.DO#0D#0A
{.LET.out.#3D.output()#0D#0A..selectoutput(sysout)#0D
#0A..writef("Item.%s.is.up.to.date*n",.@h3!item)#0D
#0A..selectoutput(out)#0D#0A}#0D#0A#0D#0A..result2.
:#3D.n_msecs!rule#0D#0A..RESULTIS.n_days!rule#0D#0A
}#0D#0A#0D#0A

######com/casech.b#
//.(C).Copyright.1978.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0A//.Modified.by.MR.for.Cintcode#0A//.CASECH.[FROM
].input.[TO].output.[DICT.dictionary].[L].[U].[A]#0A
#0A//00017/06/2010.MR#0A//.Reinserted.FLOAT.and.FIX
#0A//.Caused.'#2E'.to.be.replaced.by.'_'.in.identif
iers#0A#0A//.25/4/04.MR#0A//.Deleted.FIX.and.FLOAT,
.added.MOD.OF.SLCT.and.XOR#0A//.Changed.default.to.
L#0A#0ASECTION."CASECH"#0A#0AGET."libhdr"#0A#0AGLOB
AL.{#0Aupper:.ug#0Alower#0Ach#0Awordv#0Awch#0Awords
ize#0Acharv#0Atreevec#0Atreep#0Alinecount#0Anametre
e#0Awordnode#0Aword#0Aecho#0Asettag#0Amstream#0Asec
tv..1//.Vector.of.section.bracket.tags#0Asectp..1//
.#3D.depth.of.section.brackets#0A..6//.sectv!sectp.
#3D.tag.of.current.section#0Asectt..1//.upb.of.sect
v#0A}#0A#0A1LET.readprog().BE#0A{.SWITCHON.ch.INTO#0A
#0A..{.CASE.'*p':#0A..2CASE.'*n':.linecount.:#3D.li
necount+1#0A..2CASE.'*t':#0A..2CASE.'*s':.rch(echo)
.REPEATWHILE.ch#3D'*s'#0A..13LOOP#0A#0A..2CASE.'0':
CASE.'1':CASE.'2':CASE.'3':CASE.'4':#0A..2CASE.'5':
CASE.'6':CASE.'7':CASE.'8':CASE.'9':#0A..7readfloat
()#0A..7LOOP#0A#0A..2CASE.'a':CASE.'b':CASE.'c':CAS
E.'d':CASE.'e':#0A..2CASE.'f':CASE.'g':CASE.'h':CAS
E.'i':CASE.'j':#0A..2CASE.'k':CASE.'l':CASE.'m':CAS
E.'n':CASE.'o':#0A..2CASE.'p':CASE.'q':CASE.'r':CAS
E.'s':CASE.'t':#0A..2CASE.'u':CASE.'v':CASE.'w':CAS
E.'x':CASE.'y':#0A..2CASE.'z':#0A..2CASE.'A':CASE.'
B':CASE.'C':CASE.'D':CASE.'E':#0A..2CASE.'F':CASE.'
G':CASE.'H':CASE.'I':CASE.'J':#0A..2CASE.'K':CASE.'
L':CASE.'M':CASE.'N':CASE.'O':#0A..2CASE.'P':CASE.'
Q':CASE.'R':CASE.'S':CASE.'T':#0A..2CASE.'U':CASE.'
V':CASE.'W':CASE.'X':CASE.'Y':#0A..2CASE.'Z':#0A..7
rdtag()#0A..7writetag()#0A..7LOOP#0A#0A..2CASE.'$':
.rch(echo)#0A..12TEST.ch#3D'('.|.ch#3D')'.THEN.{.rd
tag()#0A..40writetag()#0A..38}#0A..33ELSE.rch(echo)
#0A..12LOOP#0A#0A..2CASE.'/':#0A..5rch(echo)#0A..5I
F.ch#3D'\'..DO.{.rch(echo).;..6LOOP.}#0A..5IF.ch#3D
'**'.DO.{.readcomment('/').;.LOOP.}#0A..5UNLESS.ch#3D
'/'.LOOP#0A..2Comment:#0A..5rch(echo).REPEATUNTIL.i
scc(ch).|.ch#3Dendstreamch#0A..5LOOP#0A#0A..2CASE.'
|':#0A..5rch(echo)#0A..5IF.ch#3D'|'.GOTO.Comment#0A
..5UNLESS.ch#3D'**'.LOOP#0A..5readcomment('|')#0A..
5LOOP#0A#0A..2CASE.'#23':#0A..5{.LET.radix.#3D.8#0A
..8rch(echo)#0A..8IF.ch#3D'B'.DO.{.radix.:#3D.2..;.
rch(echo).}#0A..8IF.ch#3D'X'.DO.{.radix.:#3D.16.;.r
ch(echo).}#0A..8readnumber(radix)#0A..8LOOP.}#0A#0A
..2CASE.'"':.rch(echo)#0A..12FOR.I.#3D.1.TO.255.DO.
{.IF.ch#3D'"'.BREAK#0A..34rdstrch()#0A..32}#0A..12r
ch(echo)#0A..12LOOP#0A#0A..2CASE.'*'':rch(echo)#0A.
.12rdstrch()#0A..12rch(echo)#0A..12LOOP#0A#0A..2DEF
AULT:..rch(echo)#0A..12LOOP#0A#0A..2CASE.endstreamc
h:.RETURN#0A..}#0A}.REPEAT#0A#0AAND.iscc(ch)#3D.(ch
#3D'*n').|.(ch#3D'*p')#0A#0AAND.readcomment(term).B
E#0A{#0A..1rch(echo)#0A..1{#0A..4IF.iscc(ch)#0A..4T
HEN.linecount.:#3D.linecount.+.1#0A..4IF.ch#3D'**'.
THEN#0A..4{#0A..7rch(echo)#0A..7UNLESS.ch#3Dterm.LO
OP#0A..7rch(echo)#0A..7RETURN#0A..4}#0A..4IF.ch#3De
ndstreamch.DO.error("Endstreamch.in.comment*n")#0A.
.4rch(echo)#0A..1}.REPEAT#0A}#0A#0AAND.lookupword(m
akenew).#3D.VALOF#0A{.LET.p.#3D.@nametree#0A#0A..wo
rdnode.:#3D.!p#0A#0A..UNTIL.wordnode#3D0.DO#0A..{.L
ET.cmp.#3D.compstring(wordv,.wordnode+2)#0A..2IF.cm
p#3D0.RESULTIS.wordnode+2#0A..2p.:#3D.wordnode.+.(c
mp<0->0,1)#0A..2wordnode.:#3D.!p#0A..}#0A#0A..IF.ma
kenew.DO#0A..{.wordnode.:#3D.newvec(wordsize+2)#0A.
.2wordnode!0,.wordnode!1.:#3D.0,.0#0A..2FOR.i.#3D.0
.TO.wordsize.DO.wordnode!(i+2).:#3D.wordv!i#0A..2!p
:#3Dwordnode#0A..}#0A..RESULTIS.0#0A}#0A#0AAND.decl
syswords().BE#0A{#0A..2d("ABS/AND/*#0A..4*BE/BREAK/
BY/*#0A..4*CASE/*#0A..4*DO/DEFAULT/*#0A..4*EQ/EQV/E
LSE/ENDCASE/*#0A..4*FALSE/FLOAT/FOR/FINISH/FIX/*#0A
..4*GOTO/GE/GR/GLOBAL/GET/*#0A..4*IF/INTO/*#0A..4*L
ET/LV/LE/LS/LOGOR/LOGAND/LOOP/LSHIFT//")#0A#0A..2d(
"MANIFEST/MOD/*#0A..4*NEEDS/NE/NOT/NEQV/*#0A..4*OF/
OR/*#0A..4*RESULTIS/RETURN/REM/RSHIFT/RV/*#0A..4*RE
PEAT/REPEATWHILE/REPEATUNTIL/*#0A..4*SECTION/SLCT/S
WITCHON/STATIC/*#0A..4*TO/TEST/TRUE/THEN/TABLE/*#0A
..4*UNTIL/UNLESS/*#0A..4*VEC/VALOF/*#0A..4*WHILE/*#0A
..4*XOR//")#0A}#0A#0AAND.d(words).BE#0A{.LET.i,.len
gth.#3D.1,.0#0A#0A..{.LET.ch.#3D.words%i#0A..2TEST.
ch#3D'/'#0A..2THEN.{.IF.length#3D0.RETURN#0A..9char
v!0.:#3D.length#0A..9wordsize.:#3D.packstring(charv
,.wordv)#0A..9lookupword(TRUE)#0A..9length.:#3D.0#0A
..7}#0A..2ELSE.{.length.:#3D.length.+.1#0A..9charv!
length.:#3D.ch#0A..7}#0A..2i.:#3D.i.+.1#0A..}.REPEA
T#0A}#0A#0AAND.rch(echo).BE#0A{#0A..IF.echo.DO.wch(
ch)#0A..ch:#3Drdch()#0A}#0A#0AAND.rdtag().BE#0A{.LE
T.n.#3D.1#0A..charv!1.:#3D.ch#0A#0A..{.rch(FALSE)#0A
..2IF.ch#3D'#2E'.DO.ch.:#3D.'_'#0A..2UNLESS.'A'<#3D
ch<#3D'Z'.|#0A..9'a'<#3Dch<#3D'z'.|#0A..9'0'<#3Dch<
#3D'9'.|#0A..10ch#3D'#2E'.|.ch#3D'_'.BREAK#0A..2n.:
#3D.n+1#0A..2charv!n.:#3D.ch#0A..}.REPEAT#0A#0A..ch
arv!0.:#3D.n#0A..wordsize.:#3D.packstring(charv,.wo
rdv)#0A.}#0A#0A1AND.writetag().BE#0A{.LET.mode#3Dlo
okupword(settag)#0A#0A..TEST.mode#3D0.THEN#0A..{#0A
..2IF.upper.DO#0A..2{#0A..4FOR.i#3D1.TO.charv!0.DO#0A
..4{#0A..7LET.ch#3Dcharv!i#0A..7IF.'a'<#3Dch<#3D'z'
.DO.charv!i:#3Dch-'a'+'A'#0A..4}#0A..4packstring(ch
arv,.wordv)#0A..2}#0A..2IF.lower.FOR.i#3D1.TO.charv
!0.DO#0A..2{#0A..4LET.ch#3Dcharv!i#0A..4IF.'A'<#3Dc
h<#3D'Z'.DO.charv!i:#3Dch-'A'+'a'#0A..2}#0A..2IF.ec
ho.FOR.i#3D1.TO.charv!0.DO.wch(charv!i)#0A..}#0A..E
LSE.IF.echo.FOR.i.#3D.1.TO.mode%0.DO#0A..5{.LET.ch.
#3D.mode%i#0A..7wrch(ch)#0A..5}#0A}#0A#0AAND.allupp
erwrch(ch).BE#0A{#0A..IF.'a'<#3Dch<#3D'z'.DO.ch:#3D
ch-'a'+'A'#0A..wrch(ch)#0A}#0A#0AAND.readfloat().BE
#0A{.WHILE.'0'<#3Dch<#3D'9'.|.ch#3D'_'.DO.rch(echo)
#0A..IF.ch#3D'#2E'.DO#0A..{.//.Read.the.fraction..5
eq.123#2E456#0A..2rch(echo)..1#0A..2WHILE.'0'<#3Dch
<#3D'9'.|.ch#3D'_'.DO.rch(echo)#0A..}#0A..IF.ch#3D'
e'.|.ch#3D'E'.DO#0A..{.//.Read.the.exponent..5eg.12
3e-5..0001#2E2e10#0A..2rch(echo)#0A..2IF.ch#3D'-'.|
.ch#3D'+'.DO.rch(echo)#0A..2WHILE.'0'<#3Dch<#3D'9'.
|.ch#3D'_'.DO.rch(echo)#0A..}#0A}#0A#0AAND.readnumb
er(radix).BE.UNTIL.value(ch)>#3Dradix.&.ch~#3D'_'.D
O.rch(echo)#0A#0AAND.value(ch).#3D.'0'<#3Dch<#3D'9'
.->.ch-'0',#0A..14'a'<#3Dch<#3D'f'.->.ch-'a'+10,#0A
..14'A'<#3Dch<#3D'F'.->.ch-'A'+10,#0A..014100#0A#0A
AND.rdstrch().#3D.VALOF#0A{.LET.k.#3D.ch#0A#0A..rch
(echo)#0A#0A..IF.k#3D'*n'.DO.error("Bad.string")#0A
#0A..IF.k#3D'**'.DO#0A..{.IF.ch#3D'*n'.|.ch#3D'*s'.
|.ch#3D'*t'.DO#0A..2{.{.IF.ch#3D'*n'.DO.linecount.:
#3D.linecount+1#0A..6rch(echo)#0A..4}.REPEATWHILE.c
h#3D'*n'.|.ch#3D'*s'.|.ch#3D'*t'#0A..4rch(echo)#0A.
.4RESULTIS.rdstrch()#0A..2}#0A#0A..2rch(echo)#0A..}
#0A#0A..RESULTIS.k#0A}#0A#0AAND.newvec(n).#3D.VALOF
#0A{.treep.:#3D.treep.-.n.-.1#0A..IF.treep<#3Dtreev
ec.DO#0A..{.error("Program.too.large")#0A..2stop(20
)#0A..}#0A..RESULTIS.treep#0A}#0A#0A1AND.error(Mess
).BE#0A{.LET.oldout#3Doutput()#0A..selectoutput(mst
ream)#0A..writef("Line.%n.%s*n",.linecount,.Mess)#0A
..selectoutput(oldout)#0A}#0A#0AAND.start().#3D.VAL
OF#0A{.LET.v1.#3D.VEC.50#0A..AND.v2.#3D.VEC.100#0A.
.LET.argv.#3D.VEC.40#0A..AND.instream,.outstream.#3D
.0,.0#0A..AND.dictstream.#3D.0#0A..LET.stdout.#3D.o
utput()#0A..LET.sv.#3D.VEC.100#0A..sectv,.sectp,.se
ctt.:#3D.sv,.0,.100#0A..mstream.:#3D.stdout#0A..lin
ecount:#3D0#0A..wordv.:#3D.v1#0A..charv.:#3D.v2#0A.
.treevec.:#3D.getvec(5001)#0A..treep..1:#3D.treevec
+5001#0A#0A..IF.treevec.#3D.0#0A..THEN.{.writes("No
.space.for.tree*n");.RESULTIS.20.}#0A#0A..wch.:#3D.
wrch#0A..UNLESS.rdargs("FROM/A,TO/K,DICT/K,U/S,L/S,
A/S",.argv,.40).DO#0A..{.writes("Args.no.good*n")#0A
..2RESULTIS.20#0A..}#0A#0A..instream.:#3D.findinput
(argv!0)..6//.FROM/A#0A..UNLESS.instream.DO#0A..{.w
ritef("Can't.open.%s*n",.argv!0)#0A..2RESULTIS.20#0A
..}#0A#0A..IF.argv!1.DO#0A..{.outstream.:#3D.findou
tput(argv!1)..2//.TO/K#0A..2IF.outstream.#3D.0#0A..
2THEN.{.writef("Can't.open.%s*n",argv!1);.RESULTIS.
20.}#0A..}#0A..UNLESS.outstream.DO.outstream.:#3D.s
tdout#0A#0A..dictstream.:#3D.argv!2.->.findinput(ar
gv!2),.0..//.DICT/K#0A#0A..lower,.upper.:#3D.TRUE,.
FALSE..8//.Default.is.now.L#0A#0A..TEST.argv!3..24/
/.U/S#0A..THEN.lower,.upper.:#3D.FALSE,.TRUE#0A..EL
SE.IF.argv!5..21//.A/S#0A..5THEN.wch.:#3D.allupperw
rch#0A#0A..selectoutput(outstream)#0A#0A..nametree:
#3D0#0A..declsyswords()#0A..IF.dictstream.DO#0A..{.
echo:#3DFALSE;.settag:#3DTRUE#0A..2selectinput(dict
stream)#0A..2rch(FALSE)#0A..2readprog()#0A..2endrea
d()#0A..}#0A#0A..echo:#3DTRUE#0A..settag:#3DFALSE#0A
..selectinput(instream)#0A..rch(FALSE)#0A..readprog
()#0A..endread()#0A..UNLESS.outstream#3Dstdout.DO.e
ndwrite()#0A..freevec(treevec)#0A..RESULTIS.0#0A}#0A


######com/c.b#
//.(C).Copyright.1979.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0A//.This.is.the.Cintsys/Cintpos.C.command#2E#0A#0A
/*#0A01/10/2010#0AMade.Cintsys.and.Cintpos.versions
.of.c#2Eb.identical#2E#0A#0A00007/09/2010#0AChanged
.the.lookup.sequence.for.the.command-command.filena
me#0Ato:#0A1).the.current.directory#2E#0A2).the.dir
ectories.specified.by.the.scripts.environment.varia
ble#0A..1whose.name.in.the.rtn_scriptsvar.field.of.
the.rootnode#2E#0A3).The.root.directory.specified.b
y.the.environment.variable.in#0A..1the.rtn_rootvar.
field.of.the.rootnode#2E#0A#0AUnder.Linux.I.might.h
ave.the.scriptsvar.variable.set.to#0A#0ANPVSSCRIPTS
#0A#0Aand#0A#0Aecho.$NPVSSCRIPTS#0A#0Agives#0A#0A/h
ome/mr10/NPVS/s:/home/mr10/distribution/Cintpos/cin
tpos/s#0A#0AYou.can.see.what.the.rootnode.environme
nt.variables.are.set.to#0Ausing.the.CLI.command:.se
troot#0A#0A*/#0A#0ASECTION."C"#0A#0AGET."libhdr"#0A
#0A1GLOBAL.{#0A..subch:.ug#0A..busch#0A..defch#0A..
dirch#0A..ch#0A#0A..instream#0A..outstream#0A..sys_
stream#0A#0A..rdargskey#0A..parameters#0A..keyword#0A
..defstart#0A..keygiven#0A#0A..newfile#0A#0A..par_s
tream#0A#0A..err_p#0A..err_l#0A#0A..c_rcode#0A..c_r
esult2#0A}#0A#0A2MANIFEST.{#0A..fileupb..6#3D..0042
0#0A..workfileupb..2#3D..0058#0A..taskposlwb..3#3D.
.0058#0A..taskposupb..3#3D..0059#0A..switchpos..4#3D
..0056#0A#0A..parsupb..6#3D..003100#0A..rdargskeyup
b..1#3D..00450#0A..keywordupb..3#3D..00410#0A..keyc
harsmax..2#3D..00421#0A}#0A#0ALET.start().#3D.VALOF
#0A{.//.The.first.item.on.the.command.line.is.used.
as#0A..//.the.command-command.filename#2E.I#2Ee#2E.
C.filename.args.#2E#2E3#0A..//.The.file.name.and.th
e.parameters.are.read.from.the.currently#0A..//.sel
ected.stream,.and.this.stream.is.also.used.as.the.r
est.of#0A..//.the.current.command-command.file#2E#0A
..LET.cfile.#3D.VEC.fileupb..//.To.hold.the.command
-command.filename#0A..LET.item..#3D.?#0A#0A..LET.rk
vec..#3D.VEC.rdargskeyupb#0A..LET.parvec.#3D.VEC.pa
rsupb#0A..LET.keyvec.#3D.VEC.keywordupb#0A..LET.new
f..1#3D.VEC.workfileupb#0A..LET.workfile.#3D."T-CMD
0TNN"#0A..LET.newstream.#3D.?#0A#0A..err_p..4:#3D.l
evel()#0A..c_rcode..2:#3D.0#0A..c_result2..:#3D.0#0A
#0A..instream..1:#3D.input()#0A..sys_stream.:#3D.ou
tput()#0A..par_stream.:#3D.cli_currentinput#0A..out
stream..:#3D.0#0A#0A..keygiven..1:#3D.FALSE#0A#0A..
//.Set.the.default.versions.of.the.special.characte
rs#0A..subch.:#3D.'<'..//.Start.of.substitution.ite
m#0A..busch.:#3D.'>'..//.End.of.substitution.item#0A
..defch.:#3D.'$'..//.For.default.values,.eg:..<from
$mydata>#0A..dirch.:#3D.'#2E'..//.For.directives,.e
g:.#2Ekey#0A#0A..newfile..2:#3D.newf#0A..rdargskey.
.:#3D.rkvec#0A..parameters.:#3D.parvec#0A..keyword.
.2:#3D.keyvec#0A#0A..item.:#3D.rditem(cfile,.fileup
b).//.Get.the.command-command.filename#0A..UNLESS.i
tem#3D1.|.item#3D2.DO..4//.Unquoted.or.quoted.strin
g#0A..{.reportcerr("Bad.command.file.name")#0A..2RE
SULTIS.20#0A..}#0A#0A//sawritef("c:.command-command
.filename#3D%s*n",.cfile)#0A..//.First.look.in.the.
current.directory#0A..instream.:#3D.findinput(cfile
)#0A#0A..UNLESS.instream.DO.//.Try.the.scripts.dire
ctories.next#0A..2instream.:#3D.pathfindinput(cfile
,.rootnode!rtn_scriptsvar)#0A#0A..UNLESS.instream.D
O.//.Failing.that,.try.the.root.directory#0A..2inst
ream.:#3D.pathfindinput(cfile,.rootnode!rtn_rootvar
)#0A#0A..UNLESS.instream.DO.reportcerr("Can't.open.
%s",.cfile)#0A#0A..selectinput(instream)#0A#0A..//.
Construct.work-file.name#0A..//..2T-CMD0Tnn#0A..//.
.9nn..3two.digits.of.the.taskid#0A..//..7*..0060.or
.1.to.make.it.different.from.current.file.name.#0A.
.FOR.j.#3D.0.TO.workfile%0.DO.newfile%j.:#3D.workfi
le%j#0A#0A..{.LET.t.#3D.taskid#0A..2FOR.j.#3D.taskp
osupb.TO.taskposlwb.BY.-1.DO.//.ie:.9.then.8#0A..2{
.newfile%j.:#3D.t.REM.10.+.'0'#0A..4t.:#3D.t/10#0A.
.2}#0A..}#0A#0A..IF.(cli_status.&.clibit_comcom)~#3D
0.DO#0A..{.//.We.are.currently.running.a.command-co
mmand.from.file#0A..2//.so.we.must.choose.a.differe
nt.filename#2E#0A..2IF.cli_commandfile%0.>#3D.switc
hpos.DO..//.switchpos.#3D.6#0A..2{.//.T-CMD0Tnn.<#3D
#3D>.T-CMD1Tnn#0A..4newfile%switchpos.:#3D.cli_comm
andfile%switchpos.XOR.1#0A..2}#0A..}#0A#0A//sawrite
f("c:.using.command.file.%s*n",.newfile)#0A..outstr
eam.:#3D.findoutput(newfile)#0A#0A..UNLESS.outstrea
m.DO.reportcerr("Can't.open.file.*"%s*".for.output"
,newfile)#0A#0A..selectoutput(outstream)#0A#0A..//I
F.cli_interactive.DO.testflags(flag_commbreak).//.C
lear.ctrl-C.flag#0A#0A..ch.:#3D.rdch()#0A#0A..UNTIL
.ch#3Dendstreamch.TEST.ch#3Ddirch#0A..21THEN.handle
directive()#0A..21ELSE.substitute()#0A..endread()#0A
#0A..//.First.read.rest.of.parameter.line#2E#0A#0A/
/sawritef("c:.calling.consume_rest_of_line*n")#0A..
consume_rest_of_line()#0A#0A..//.Copy.rest.of.curre
nt.input#2E#0A#0A..selectinput(cli_currentinput)#0A
#0A//sawritef("c:.cli_status#3D%x8.clibit_comcom#3D
%x8*n",.cli_status,.clibit_comcom)#0A#0A//..IF.cli_
currentinput.~#3D.cli_standardinput.DO#0A..IF.(cli_
status.&.clibit_comcom)~#3D0.DO#0A..{.//.If.we.were
.already.processing.a.command-command,.copy.the#0A.
.2//.rest.of.the.previous.file.into.the.new.file#0A
//sawritef("c:.we.were.in.a.command-command.reading
.from.%s*n",.cli_commandfile)#0A..2{.ch.:#3D.rdch()
#0A..4IF.ch.#3D.endstreamch.BREAK#0A..4wrch(ch)#0A.
.2}.REPEAT#0A..2//.Then.close.and.delete.the.old.fi
le#0A..2endread()#0A..2deletefile(cli_commandfile)#0A
..}#0A#0A..endwrite()..19//.Close.the.new.file#0A#0A
..newstream.:#3Dfindinput(newfile).//.and.open.it.f
or.input#0A#0A..//.Set.up.the.new.command.file.for.
the.CLI.to.process,#0A..//.remembering.its.name.so.
that.it.can.be.deleted.later#2E#0A..cli_currentinpu
t.:#3D.newstream#0A..FOR.j.#3D.0.TO.newfile%0.DO.cl
i_commandfile%j.:#3D.newfile%j#0A#0A..//.Set.the.CL
I.comcom.bit#0A..cli_status.:#3D.cli_status.|.clibi
t_comcom#0A#0A1err_l:#0A..selectoutput(sys_stream)#0A
#0A..result2.:#3D.c_result2#0A//..UNLESS.command_st
ream.DO.stop(c_rcode)#0A#0A//sawritef("c:.returning
.from.c.with.c_rcode#3D%n.cli_commandfile#3D%s*n",#0A
//..8c_rcode,.cli_commandfile)#0A..RESULTIS.c_rcode
#0A}#0A#0A1AND.handledirective().BE.//.Called.after
.reading.'dirch'#0A{.ch.:#3D.rdch()#0A..UNLESS.ch.#3D
.'*n'.|.ch.#3D.'.'.|.ch.#3D.endstreamch.DO#0A..{.LE
T.item,.c.#3D.?,.?#0A..2unrdch()#0A#0A..2item.:#3D.
rditem(keyword,.keywordupb)#0A..2c.:#3D.(item#3D1.-
>#0A..10findarg("K#3DKEY,DEF#3DDEFAULT,*#0A..19*BRA
,KET,DOLLAR,DOT",keyword),#0A..10-1#0A..7)#0A//sawr
itef("handledirective:.c#3D%n*n",.c)#0A#0A..2IF.c.<
.0.DO.reportcerr("Invalid.directive")#0A#0A..2SWITC
HON.c.INTO#0A..2{.DEFAULT:.#0A..9reportcerr("Illega
l.directive")#0A..9RETURN#0A#0A..4CASE.0:..23//.K#3D
KEY#0A..9//.KEY.for.RDARGS#2E#0A..9IF.keygiven.DO.r
eportcerr("More.than.one.K.directive")#0A#0A..9{.LE
T.item.#3D.rditem(rdargskey,.rdargskeyupb)#0A..11IF
.item.<#3D.0.DO.reportcerr("Illegal.K.directive")#0A
//sawritef("c:.rdargskey#3D%s*n",.rdargskey)#0A..11
selectinput(par_stream)#0A..11selectoutput(sys_stre
am).//.For.error.messages#0A..11defstart.:#3D.rdarg
s(rdargskey,.parameters,.parsupb)#0A..11unrdch().//
.??19#0A..11selectoutput(outstream)#0A..11selectinp
ut(instream)#0A..11UNLESS.defstart.DO#0A..13reportc
err("Parameters.unsuitable.for.key.*"%s*"",.rdargsk
ey)#0A..11keygiven.:#3D.TRUE#0A..11ENDCASE#0A..9}#0A
#0A..4CASE.1:..20//.DEF#3DDEFAULT#0A..9//.DEFAULT.k
eyword.[#3D].value#0A..9{.LET.item.#3D.rditem(keywo
rd,keywordupb)#0A..11LET.keyn.#3D.?#0A#0A..11IF.ite
m.<.0.DO.reportcerr("Illegal.keyword")#0A#0A..11IF.
item.#3D.0.ENDCASE#0A#0A..11UNLESS.keygiven.DO.repo
rtcerr("No.K.directive")#0A#0A..11keyn.:#3D.findarg
(rdargskey,keyword)#0A#0A..11IF.keyn.>#3D.0.&.param
eters.!.keyn.#3D.0.DO#0A..11{.LET.dupb.#3D.parsupb+
parameters-defstart#0A..13item.:#3D.rditem(defstart
,.dupb)#0A#0A..14IF.item.#3D.5.DO..4//.Skip.over.'#3D
'#0A..16item.:#3D.rditem(defstart,dupb)#0A#0A..14IF
.item.#3D.0.ENDCASE.//.EOF#0A#0A..14IF.item.<.0.DO.
.4//.Error#0A..14{.reportcerr("Illegal.#2EDEF.item"
)#0A..16ENDCASE#0A..14}#0A#0A..13parameters.!.keyn.
:#3D.defstart#0A..13defstart.:#3D.defstart.+#0A..25
(defstart.%.0)/bytesperword.+.1#0A..12}#0A..12ENDCA
SE#0A..10}#0A#0A..4CASE.2:..15//.BRA#0A..4CASE.3:..
15//.KET#0A..4CASE.4:..15//.DOLLAR#0A..4CASE.5:..15
//.DOT#0A..10(@.subch).!.(c.-.2).:#3D.getch()#0A..1
0ENDCASE#0A#0A..2}#0A#0A..2ch.:#3D.rdch()#0A..}#0A#0A
..UNTIL.ch.#3D.'*n'.|.ch.#3D.endstreamch.DO.ch.:#3D
.rdch()#0A#0A..ch.:#3D.rdch()#0A}#0A#0A2AND.substit
ute().BE#0A{.LET.writing,.substituting.#3D.TRUE,.FA
LSE#0A#0A..UNTIL.ch#3D'*n'.|.ch#3Dendstreamch.TEST.
ch#3Dsubch.&.writing#0A..THEN.{.LET.keyn,.len.#3D.?
,.0.//.<key$default>#0A..7writing.:#3D.FALSE#0A..7s
ubstituting.:#3D.TRUE#0A#0A..7UNLESS.keygiven.DO.re
portcerr("No.K.directive")#0A#0A..7ch.:#3D.rdch()#0A
#0A..7UNTIL.ch#3Dbusch.|.ch#3Ddefch.|..10//..>..6$#0A
..13ch#3D'*n'..|.ch#3Dendstreamch.DO..3//..newline.
.EOF#0A..7{.IF.len.>#3D.keycharsmax.DO.reportcerr("
Keyword.too.long*n")#0A..9len.:#3D.len.+.1#0A..9key
word%len.:#3D.ch#0A//sawritef("c:.keyword!%n#3D%c*n
",.len,.ch)#0A..9ch.:#3D.rdch()#0A..7}#0A..7keyword
%0.:#3D.len#0A//sawritef("c:.keyword#3D%s*n",.keywo
rd)#0A#0A..7keyn.:#3D.findarg(rdargskey,.keyword)#0A
#0A..7TEST.keyn.<.0.|.parameters!keyn.#3D.0#0A..7TH
EN.writing.:#3D.TRUE#0A..7ELSE.TEST.parameters.!.ke
yn.#3D.-1#0A..12THEN.writes(keyword)#0A..12ELSE.{.w
rites(parameters!keyn)#0A//sawritef("c:.substitutin
g.%s.for.key.%s*n",.parameters!keyn,.keyword)#0A..1
7}#0A#0A..7IF.ch.#3D.defch.DO.ch.:#3D.rdch()#0A#0A.
.5}#0A..ELSE.{.TEST.ch#3Dbusch.&.substituting#0A..7
THEN.{.writing.:#3D.TRUE#0A..14substituting.:#3D.FA
LSE#0A..12}#0A..7ELSE.IF.writing.DO.wrch(ch)#0A..7c
h.:#3D.rdch()#0A..5}#0A#0A..wrch('*n')#0A..ch.:#3D.
rdch()#0A}#0A#0A1AND.getch().#3D.VALOF.//.Get.singl
e.character.item#2E#0A{.LET.item.#3D.rditem(keyword
,.keywordupb)#0A#0A..UNLESS.item.DO#0A..{.ch.:#3D.r
dch();.unrdch()#0A..2IF.ch.#3D.'*n'.|.ch.#3D.endstr
eamch.RESULTIS.-2#0A..}#0A#0A..1UNLESS.item>0.&.key
word%0#3D1.DO#0A..8reportcerr("Invalid.directive.ar
gument")#0A#0A..1RESULTIS.keyword%1#0A}#0A#0AAND.co
nsume_rest_of_line().BE#0A{.LET.ch.#3D.?#0A..select
input(par_stream)#0A//sawritef("c:.consume_rest_of_
line.entered*n")#0A..ch.:#3D.rdch().REPEATUNTIL.ch.
#3D.'*n'.|#0A..25ch.#3D.';'..|#0A..25ch.#3D.endstre
amch#0A//sawritef("c:.returning.from.consume_rest_o
f_line*n")#0A}#0A#0AAND.reportcerr(format,x,y).BE#0A
{.c_result2.:#3D.result2#0A#0A..IF.outstream.DO#0A.
.{.endstream(outstream)#0A..2deletefile(newfile)#0A
..2selectoutput(sys_stream)#0A..}#0A..IF.instream.D
O.endread()#0A..consume_rest_of_line()#0A..writes("
C:.")#0A..writef(format,.x,.y)#0A..newline()#0A..c_
rcode.:#3D.20#0A..longjump(err_p,.err_l)#0A}#0A

######com/cg-intcode.b#
//.This.is.an.OCODE.to.Intcode.codegenerator.dated.
1982.approx#0A#0A//.This.is.being.modified.to.run.u
nder.the.current.version.of.BCPL#2E#0A//.It.will.be
.the.codegenerator.of.a.new.compiler.called.bcplint
#2Eb#0A#0A//.Implemented.by.Martin.Richards.(c).Sep
t.2012#0A/*#0A28/09/12#0ABegan.major.modifications#0A
Made.into.one.section#2E#0A#0A*/#0A#0A//..2CGHDR#0A
#0ASECTION."CG-INTCODE"#0A#0AGET."libhdr"#0AGET."bc
plfecg"#0A#0AMANIFEST.{#0A..s_char#3D200..//.Extras
#0A..s_iteml#0A..s_end#3D0#0A}#0A#0A1//.Code.Genera
tor.Globals:#0A#0AGLOBAL#0A{}#0A#0A2GLOBAL#0A{#0Acg
sects:.cgg#0Assp#0Astate#0Aad_a#0Aad_k#0Adatav#0Ada
tap#0Adatat#0Aproglength#0Alinep#0Aparam#0A#0Amaxgn
#0Amaxlab#0Amaxssp#0A#0Aop#0Areadop#0A#0Ardl#0Agenc
ode#0Aforce_nil#0Aforce_ad#0Aforce_ac#0Aforce_acad#0A
swap#0Aload#0Astorein#0Acgstring#0Adata#0Anextparam
#0Acode#0Acomplab#0Aopcode#0Awr#0Awrk#0Awrdata#0Ach
ecklab#0Alabnumber#0Acgerror#0A#0A}#0A#0AMANIFEST.{
#0A..2m_n#3D0#0A..2m_i#0A..2m_p#0A..2m_ip#0A..2m_l#0A
..2m_il#0A..2m_g#0A..2m_ig#0A..2f_l..9#3D.'L'#0A..2
f_s..9#3D.'S'#0A..2f_a..9#3D.'A'#0A..2f_j..9#3D.'J'
#0A..2f_t..9#3D.'T'#0A..2f_f..9#3D.'F'#0A..2f_k..9#3D
.'K'#0A..2f_x..9#3D.'X'#0A..2f_d..9#3D.'D'#0A..2f_c
..9#3D.'C'#0A..2nil#3D0#0A..2ad#0A..2ac#0A..2acad#0A
}#0A#0A1//#2E#0A#0A//SECTION."IC-CG1"#0A#0A2//..2CG
1#0A#0A1//GET.""#0A#0A1LET.cgsects(workvec,.vecsize
).BE.UNTIL.op#3D0.DO#0A{.LET.p.#3D.workvec#0A/*#0A.
.1tempv.:#3D.p#0A..1p.:#3D.p+90#0A..1tempt.:#3D.p#0A
..1casek.:#3D.p#0A..1p.:#3D.p+400#0A..1casel.:#3D.p
#0A..1p.:#3D.p+400#0A..1labv.:#3D.p#0A..1dp.:#3D.wo
rkvec+vecsize#0A..1labnumber.:#3D.(dp-p)/10+10#0A..
1p.:#3D.p+labnumber#0A..1FOR.lp.#3D.labv.TO.p-1.DO.
!lp.:#3D.-1#0A..1stv.:#3D.p#0A..1stvp.:#3D.0#0A..1i
ncode.:#3D.FALSE#0A..1maxgn.:#3D.0#0A..1maxlab.:#3D
.0#0A..1maxssp.:#3D.0#0A..1procdepth.:#3D.0#0A..1in
fo_a,.info_b.:#3D.0,.0#0A..1initstack(3)#0A..1initd
atalists()#0A#0A..1codew(0)..//.For.size.of.module#2E
#0A..1IF.op#3Ds_section.DO#0A..1{.MANIFEST.{.upb#3D
11.}.//.Max.length.of.entry.name#0A..4LET.n.#3D.rdn
()#0A..4LET.v.#3D.VEC.upb/bytesperword#0A..4v%0.:#3D
.upb#0A..4//.Pack.up.to.11.character.of.the.name.in
to.v.including#0A..4//.the.first.and.last.five#2E#0A
..4TEST.n<#3D11#0A..4THEN.{.FOR.i.#3D.1.TO.n.DO.v%i
.:#3D.rdn()#0A..11FOR.i.#3D.n+1.TO.11.DO.v%i.:#3D.'
*s'#0A..9}#0A..4ELSE.{.FOR.i.#3D.1.TO.5..1DO.v%i.:#3D
.rdn()#0A..11FOR.i.#3D.6.TO.n-6.DO.rdn().//.Ignore.
the.middle.characters#0A..11FOR.i.#3D.6.TO.11..DO.v
%i.:#3D.rdn()#0A..11IF.n>11.DO.v%6.:#3D.'*''#0A..9}
#0A..4IF.naming.DO.{.codew(sectword)#0A..20codew(pa
ck4b(v%0,.v%1,.v%.2,.v%.3))#0A..20codew(pack4b(v%4,
.v%5,.v%.6,.v%.7))#0A..20codew(pack4b(v%8,.v%9,.v%1
0,.v%11))#0A..17}#0A..4op.:#3D.rdn()#0A..1}#0A#0A..
1scan()#0A..1op.:#3D.rdn()#0A..1putw(0,.stvp/4)..//
.Plant.size.of.module#2E#0A..1outputsection()#0A..1
progsize.:#3D.progsize.+.stvp#0A*/#0A}#0A#0ALET.rea
dop().#3D.rdn()#0A#0A//.Read.in.an.OCODE.label#2E#0A
AND.rdl().#3D.VALOF#0A{.LET.l.#3D.rdn()#0A..//IF.ma
xlab<l.DO.{.maxlab.:#3D.l;.checklab().}#0A..RESULTI
S.l#0A}#0A#0A//.Read.in.a.global.number#2E#0AAND.rd
gn().#3D.VALOF#0A{.LET.g.#3D.rdn()#0A..1IF.maxgn<g.
DO.maxgn.:#3D.g#0A..1RESULTIS.g#0A}#0A#0A1//1#2E#0A
#0A1//1SECTION."IC-CG2"#0A#0A1//..2CG2#0A#0A1//1GET
.""#0A#0ALET.modestr(m).#3D.VALOF.SWITCHON.m.INTO#0A
{.DEFAULT:..1RESULTIS."Unknown.mode"#0A#0A..CASE.m_
n:..RESULTIS."N"#0A..CASE.m_i:..RESULTIS."I"#0A..CA
SE.m_p:..RESULTIS."P"#0A..CASE.m_ip:.RESULTIS."IP"#0A
..CASE.m_l:..RESULTIS."L"#0A..CASE.m_il:.RESULTIS."
IL"#0A..CASE.m_g:..RESULTIS."G"#0A..CASE.m_ig:.RESU
LTIS."IG"#0A}#0A#0ALET.statestr(s).#3D.VALOF.SWITCH
ON.s.INTO#0A{.DEFAULT:..1RESULTIS."Unknown.state"#0A
#0A..CASE.nil:..RESULTIS."NIL"#0A..CASE.ad:..1RESUL
TIS."AD"#0A..CASE.ac:..1RESULTIS."AC"#0A..CASE.acad
:.RESULTIS."ACAD"#0A}#0A#0ALET.opstr(op).#3D.VALOF.
SWITCHON.op.INTO#0A{.DEFAULT:..7RESULTIS."Unknown.o
p"#0A#0A..CASE.s_abs:..4RESULTIS."abs"#0A..CASE.s_d
atalab:..RESULTIS."datalab"#0A..CASE.s_div:..4RESUL
TIS."div"#0A..CASE.s_end:..4RESULTIS."end"#0A..CASE
.s_endfor:..1RESULTIS."endfor"#0A..CASE.s_endproc:.
.RESULTIS."endproc"#0A..CASE.s_entry:..2RESULTIS."e
ntry"#0A..CASE.s_eq:..5RESULTIS."eq"#0A..CASE.s_eqv
:..4RESULTIS."eqv"#0A..CASE.s_false:..2RESULTIS."fa
lse"#0A..CASE.s_finish:..1RESULTIS."finish"#0A..CAS
E.s_fnap:..3RESULTIS."fnap"#0A..CASE.s_fnrn:..3RESU
LTIS."fnrn"#0A..CASE.s_ge:..5RESULTIS."ge"#0A..CASE
.s_getbyte:..RESULTIS."getbyte"#0A..CASE.s_global:.
.1RESULTIS."global"#0A..CASE.s_goto:..3RESULTIS."go
to"#0A..CASE.s_gr:..5RESULTIS."gr"#0A..CASE.s_itemn
:..2RESULTIS."itemn"#0A..CASE.s_jf:..5RESULTIS."jf"
#0A..CASE.s_jt:..5RESULTIS."jt"#0A..CASE.s_jump:..3
RESULTIS."jump"#0A..CASE.s_lab:..4RESULTIS."lab"#0A
..CASE.s_le:..5RESULTIS."le"#0A..CASE.s_lf:..5RESUL
TIS."lf"#0A..CASE.s_lg:..5RESULTIS."lg"#0A..CASE.s_
ll:..5RESULTIS."ll"#0A..CASE.s_llg:..4RESULTIS."llg
"#0A..CASE.s_ll1.:..3RESULTIS."ll1"#0A..CASE.s_llp:
..4RESULTIS."llp"#0A..CASE.s_ln:..5RESULTIS."ln"#0A
..CASE.s_logand:..1RESULTIS."logand"#0A..CASE.s_log
or:..2RESULTIS."logor"#0A..CASE.s_lp:..5RESULTIS."l
p"#0A..CASE.s_ls:..5RESULTIS."ls"#0A..CASE.s_lshift
:..1RESULTIS."lshift"#0A..CASE.s_lstr:..3RESULTIS."
lstr"#0A..CASE.s_sub:..4RESULTIS."sub"#0A..CASE.s_m
ul:..4RESULTIS."mul"#0A..CASE.s_ne:..5RESULTIS."ne"
#0A..CASE.s_neg:..4RESULTIS."neg"#0A..CASE.s_neqv:.
.3RESULTIS."neqv"#0A..CASE.s_none:..3RESULTIS."none
"#0A..CASE.s_not:..4RESULTIS."not"#0A..CASE.s_add:.
.4RESULTIS."add"#0A..CASE.s_putbyte:..RESULTIS."put
byte"#0A..CASE.s_query:..2RESULTIS."query"#0A..CASE
.s_rem:..4RESULTIS."rem"#0A..CASE.s_res:..4RESULTIS
."res"#0A..CASE.s_rshift:..1RESULTIS."rshift"#0A..C
ASE.s_rstack:..1RESULTIS."rstack"#0A..CASE.s_rtap:.
.3RESULTIS."rtap"#0A..CASE.s_rtrn:..3RESULTIS."rtrn
"#0A..CASE.s_rv:..5RESULTIS."rv"#0A..CASE.s_save:..
3RESULTIS."save"#0A..CASE.s_section:..RESULTIS."sec
tion"#0A..CASE.s_sg:..5RESULTIS."sg"#0A..CASE.s_sl:
..5RESULTIS."sl"#0A..CASE.s_sp:..5RESULTIS."sp"#0A.
.CASE.s_stack:..2RESULTIS."stack"#0A..CASE.s_stind:
..2RESULTIS."stind"#0A..CASE.s_store:..2RESULTIS."s
tore"#0A..CASE.s_switchon:.RESULTIS."switchon"#0A..
CASE.s_true:..3RESULTIS."true"#0A#0A1/*#0A//.The.fo
llowing.have.been.added.for.the.extended.compiler.x
bcpl#0A#0A//.Floating.point.operators.and.assignmen
t.operators,.added.15/07/10#0A#0As_fnum.//.Floating
.point.constants#0As_float;.s_fix;.s_fabs#0As_fmul;
.s_fdiv;.s_fadd;.s_fsub;..s_fpos;.s_fneg#0As_feq;.s
_fne;.s_fls;.s_fgr;.s_fle;.s_fge#0A#0A//.Assign.ope
rators.--.added.15/07/10#0As_assvecap#0As_assmul;.s
_assdiv;.s_assrem;.s_assadd;.s_ass1ub#0As_assfmul;.
s_assfdiv;.s_assfadd;.s_assfsub#0As_asslshift;.s_as
srshift#0As_asslogand;.s_asslogor;.s_asseqv;.s_assn
eqv#0A#0A1s_selld;.s_selst.//.Added.19/07/10#0A#0As
_fltop..//.FLTOP.is.followed.by.one.of.the.fl_.code
s#0A..7//.eg.FLTOP.FADD.to.do.a.:#3D.b.#23+.a#0A..7
//.or.FLTOP.FLOAT.to.do.a.:#3D.FLOAT.a#0A#0Asf_none
#3D0..3//.Assignment.operators#0Asf_vecap#0Asf_fmul
#0Asf_fdiv#0Asf_fadd#0Asf_fsub#0Asf_mul#0Asf_div#0A
sf_rem#0Asf_add#0Asf_sub#0Asf_lshift#0Asf_rshift#0A
sf_logand#0Asf_logor#0Asf_eqv#0Asf_neqv#0A*/#0A}#0A
#0ALET.gencode().BE#0A{#0A//writef("gencode:.op#3D%
s*n",.opstr(op))#0AIF.debug>1.DO#0A..4writef("IC-CG
:.STATE#3D%s,.SSP#3D%N,.AD_A#3D%N,.AD_K#3D%s*N",#0A
..19statestr(state),.ssp,.ad_a,.modestr(ad_k))#0A..
SWITCHON.op.INTO#0A..{.DEFAULT:#0A..4selectoutput(s
ysprint)#0A..4writef("IC-CG:.unknown.OCODE.number:.
.%N*N",.op)#0A..4selectoutput(gostream)#0A..4ENDCAS
E#0A#0A..2CASE.s_none:#0A..2CASE.s_end:#0AIF.debug>
0.DO.writef("*n//.%s*n",.opstr(op))#0A..2//CASE.0:#0A
..4RETURN#0A#0A..2CASE.s_needs:#0A..4wr('*N')#0A..4
writes("/.NEEDS.")#0A..4FOR.i#3D1.TO.rdn().DO.wrch(
rdn())#0A..4wr('*N')#0A..4ENDCASE#0A#0A..2CASE.s_lp
:#0A..2{.LET.p.#3D.rdn()#0AIF.debug>0.DO.writef("*n
//.%s.P%n*n",.opstr(op),.p)#0A..4load(p,.m_ip)#0A..
4ENDCASE#0A..2}#0A#0A..2CASE.s_lg:#0A..2{.LET.g.#3D
.rdn()#0AIF.debug>0.DO.writef("*n//.%s.G%n*n",.opst
r(op),.g)#0A..4load(g,.m_ig)#0A..4ENDCASE#0A..2}#0A
#0A..2CASE.s_ll:#0A..2{.LET.l.#3D.rdl()#0AIF.debug>
0.DO.writef("*n//.%s.L%n*n",.opstr(op),.l)#0A..4loa
d(l,.m_il)#0A..4ENDCASE#0A..2}#0A#0A..2CASE.s_lf:#0A
..2{.LET.l.#3D.rdl()#0AIF.debug>0.DO.writef("*n//.%
s.%n*n",.opstr(op),.l)#0A..4load(l,.m_l)#0A..4ENDCA
SE#0A..2}#0A#0A..2CASE.s_ln:#0A..2{.LET.n.#3D.rdl()
#0AIF.debug>0.DO.writef("*n//.%s.L%n*n",.opstr(op),
.n)#0A..4load(n,.m_n)#0A..4ENDCASE#0A..2}#0A#0A..2C
ASE.s_lstr:#0A..4cgstring(rdn())#0A..4ENDCASE#0A#0A
..2CASE.s_true:#0AIF.debug>0.DO.writef("*n//.%s*n",
.opstr(op))#0A..4load(-1,.m_n)#0A..4ENDCASE#0A#0A..
2CASE.s_false:#0AIF.debug>0.DO.writef("*n//.%s*n",.
opstr(op))#0A..4load(0,.m_n)#0A..4ENDCASE#0A#0A..2C
ASE.s_llp:#0A..2{.LET.p.#3D.rdn()#0AIF.debug>0.DO.w
ritef("*n//.%s.P%n*n",.opstr(op),.p)#0A..4load(p,.m
_p)#0A..4ENDCASE#0A..2}#0A#0A..2CASE.s_llg:#0A..2{.
LET.g.#3D.rdn()#0AIF.debug>0.DO.writef("*n//.%s.G%n
*n",.opstr(op),.g)#0A..4load(g,.m_g)#0A..4ENDCASE#0A
..2}#0A#0A..2CASE.s_ll1:#0A..2{.LET.l.#3D.rdl()#0AI
F.debug>0.DO.writef("*n//.%s.L%n*n",.opstr(op),.l)#0A
..4load(l,.m_l)#0A..4ENDCASE#0A..2}#0A#0A..2CASE.s_
sp:#0A..2{.LET.p.#3D.rdn()#0AIF.debug>0.DO.writef("
*n//.%s.P%n*n",.opstr(op),.p)#0A..4storein(p,.m_p)#0A
..4ENDCASE#0A..2}#0A#0A..2CASE.s_sg:#0A..2{.LET.g.#3D
.rdn()#0AIF.debug>0.DO.writef("*n//.%s.G%n*n",.opst
r(op),.g)#0A..4storein(g,.m_g)#0A..4ENDCASE#0A..2}#0A
#0A..2CASE.s_sl:#0A..2{.LET.l.#3D.rdl()#0AIF.debug>
0.DO.writef("*n//.%s.L%n*n",.opstr(op),.l)#0A..4sto
rein(l,.m_l)#0A..4ENDCASE#0A..2}#0A#0A..2CASE.s_sti
nd:#0AIF.debug>0.DO.writef("*n//.%s*n",.opstr(op))#0A
..4force_acad()#0A..4code(f_s,.ad_a,.ad_k)#0A..4ssp
,.state.:#3D.ssp-2,.nil#0A..4ENDCASE#0A#0A..2CASE.s
_putbyte:#0A..4//.args.on.the.stack.are.as.follows:
#0A..4//..7top.of.stack..->..arg1#0A..4//..25arg2#0A
..4//..25arg3#0A..4//.where.the.operation.is..arg2%
arg1.:#3D.arg3#0AIF.debug>0.DO.writef("*n//.%s*n",.
opstr(op))#0A..4force_nil()#0A..4code(f_l,.ssp-3,.m
_p)..2//.load.address.of.vector.on.stack!#0A..4code
(f_x,.opcode(s_putbyte),.m_n)#0A..4ssp.:#3D.ssp-3#0A
..4state.:#3D.nil#0A..4ENDCASE#0A#0A..2CASE.s_mul:.
.2CASE.s_div:..3CASE.s_rem:#0A..2CASE.s_sub:..1CASE
.s_eq:..4CASE.s_ne:#0A..2CASE.s_ls:..4CASE.s_gr:..4
CASE.s_le:#0A..2CASE.s_ge:..4CASE.s_lshift:..CASE.s
_rshift:#0A..2CASE.s_logand:..CASE.s_logor:..1CASE.
s_neqv:#0A..2CASE.s_eqv:..3CASE.s_getbyte:#0AIF.deb
ug>0.DO.writef("*n//.%s*n",.opstr(op))#0A..4force_a
cad()#0A..4code(f_l,.ad_a,.ad_k)#0A..4code(f_x,.opc
ode(op),.m_n)#0A..4state,.ssp.:#3D.ac,.ssp-1#0A..4E
NDCASE#0A#0A..2CASE.s_rv:..4CASE.s_neg:..3CASE.s_no
t:#0A..2CASE.s_abs:#0AIF.debug>0.DO.writef("*n//.%s
*n",.opstr(op))#0A..4force_ac()#0A..4code(f_x,.opco
de(op),.m_n)#0A..4ENDCASE#0A#0A..2CASE.s_add:#0AIF.
debug>0.DO.writef("*n//.%s*n",.opstr(op))#0A..4forc
e_acad()#0A..4code(f_a,.ad_a,.ad_k)#0A..4state,.ssp
.:#3D.ac,.ssp-1#0A..4ENDCASE#0A#0A..2CASE.s_jump:#0A
..2{.LET.l.#3D.rdl()#0AIF.debug>0.DO.writef("*n//.%
s.L%n*n",.opstr(op),.l)#0A..4force_nil()#0A..4code(
f_j,.l,.m_l)#0A..4ENDCASE#0A..2}#0A#0A..2CASE.s_jt:
#0A..2CASE.s_jf:#0A..2{.LET.l.#3D.rdl()#0AIF.debug>
0.DO.writef("*n//.%s.L%n*n",.opstr(op),.l)#0A..4for
ce_ac()#0A..4code(op#3Ds_jt->f_t,f_f,.l,.m_l)#0A..4
ssp,.state.:#3D.ssp-1,.nil#0A..4ENDCASE#0A..2}#0A#0A
..2CASE.s_endfor:#0A..4//.Simulate.the.effect.of.th
e.OCODE#0A..4//..5SUB.LN.0.LE.JT#0A..4//.the.label.
follows.the.ENDFOR.code#0AIF.debug>0.DO.writef("*n/
/.%s*n",.opstr(op))#0A..4force_acad()#0A..4code(f_l
,.ad_a,.ad_k)#0A..4code(f_x,.opcode(s_sub),.m_n)#0A
..4state.:#3D.ac#0A..4ssp.:#3D.ssp.-.1#0A..4load(0,
.m_n)#0A..4code(f_l,.ad_a,.ad_k)#0A..4code(f_x,.opc
ode(s_le),.m_n)#0A..4code(f_t,.rdl(),.m_l)#0A..4ssp
.:#3D.ssp.-.2#0A..4state.:#3D.nil#0A..4ENDCASE#0A#0A
..2CASE.s_goto:#0AIF.debug>0.DO.writef("*n//.%s*n",
.opstr(op))#0A..4force_ad()#0A..4code(f_j,.ad_a,.ad
_k)#0A..4ssp,.state.:#3D.ssp-1,.nil#0A..4ENDCASE#0A
#0A..2CASE.s_lab:#0A..2{.LET.l.#3D.rdl()#0AIF.debug
>0.DO.writef("*n//.%s.L%n*n",.opstr(op),.l)#0A..4fo
rce_nil()#0A..4complab(l)#0A..4ENDCASE#0A..2}#0A#0A
..2CASE.s_query:#0AIF.debug>0.DO.writef("*n//.%s*n"
,.opstr(op))#0A..4force_nil()#0A..4ssp.:#3D.ssp.+.1
#0A..4ENDCASE#0A#0A..2CASE.s_stack:#0A..4force_nil(
)#0A..4ssp.:#3D.rdn()#0AIF.debug>0.DO.writef("*n//.
%s.%n*n",.opstr(op),.ssp)#0A..4ENDCASE#0A#0A..2CASE
.s_store:#0AIF.debug>0.DO.writef("*n//.%s*n",.opstr
(op))#0A..4force_nil()#0A..4ENDCASE#0A#0A..2CASE.s_
entry:#0A..2{.LET.l.#3D.rdl()#0A..4LET.n.#3D.rdn()#0A
IF.debug>0.DO..writef("*n//.%s.L%n.%n*n",.opstr(op)
,.l,.n)#0A#0A..4wr('*n')#0A..4wr('$')#0A..4wr('*s')
#0A..4wr('/')#0A..FOR.i.#3D.1.TO.n.DO.wrch(rdn())./
/.Write.the.function.name#0A..4wr('*n')#0A..4wr('.'
)#0A..4complab(l)#0A..4state,.ad_a,.ad_k.:#3D.nil,.
0,.m_n#0A..4ENDCASE#0A..2}#0A#0A..2CASE.s_save:#0A.
.4ssp.:#3D.rdn()#0AIF.debug>0.DO.writef("*n//.%s.%n
*n",.opstr(op),.ssp)#0A..4ENDCASE#0A#0A..2CASE.s_en
dproc:#0AIF.debug>0.DO.writef("*n//.%s*n",.opstr(op
))#0A..4ENDCASE#0A#0A..2CASE.s_rtap:#0A..2CASE.s_fn
ap:#0A..2{.LET.k.#3D.rdn()#0AIF.debug>0.DO.writef("
*n//.%s.%n*n",.opstr(op),.k)#0A..4force_ac()#0A..4c
ode(f_k,.k,.m_n)#0A..4TEST.op#3Ds_fnap#0A..4THEN.{.
ssp.:#3D.k+1#0A..11state.:#3D.ac#0A..9}#0A..4ELSE.{
.ssp.:#3D.k#0A..11state.:#3D.nil#0A..9}#0A..4ENDCAS
E#0A..2}#0A#0A..2CASE.s_fnrn:#0A..4force_ac()#0A..4
ssp.:#3D.ssp.-.1#0A..2CASE.s_rtrn:#0AIF.debug>0.DO.
writef("*n//.%s*n",.opstr(op))#0A..4code(f_x,.opcod
e(s_rtrn),.m_n)#0A..4state.:#3D.nil#0A..4ENDCASE#0A
#0A..2CASE.s_res:#0A..2{.LET.l.#3D.rdl()#0AIF.debug
>0.DO.writef("*n//.%s.L%n*n",.opstr(op),.l)#0A..4fo
rce_ac()#0A..4code(f_j,.l,.m_l)#0A..4ssp,.state.:#3D
.ssp-1,.nil#0A..4ENDCASE#0A..1}#0A#0A..2CASE.s_rsta
ck:#0A..2{.LET.n.#3D.rdl()#0AIF.debug>0.DO.writef("
*n//.%s.%n*n",.opstr(op),.n)#0A..4force_nil()#0A..4
ssp,.state.:#3D.n+1,.ac#0A..4ENDCASE#0A..2}#0A#0A..
2CASE.s_finish:#0AIF.debug>0.DO.writef("*n//.%s*n",
.opstr(op))#0A..4code(f_x,.opcode(op),.m_n)#0A..4EN
DCASE#0A#0A..2CASE.s_switchon:#0A..2{.LET.n.#3D.rdn
()#0A..4LET.d.#3D.rdl()#0AIF.debug>0.DO.writef("*n/
/.%s.%n.L%n*n",.opstr(op),.n,.d)#0A..4force_ac()#0A
..4code(f_x,.opcode(op),.m_n)#0A..4code(f_d,.n,.m_n
)#0A..4code(f_d,.d,.m_l)#0A..4ssp,.state.:#3D.ssp-1
,.nil#0A..4FOR.i.#3D.1.TO.n.DO#0A..4{.code(f_d,.rdn
(),.m_n)#0A..6code(f_d,.rdl(),.m_l)#0A..4}#0A..4END
CASE#0A..2}#0A#0A..2CASE.s_global:#0A..2{.LET.n.#3D
.rdn()#0AIF.debug>0.DO.writef("*n//.%s.%n*n",.opstr
(op),.n)#0A..4wr('*n')#0A..4FOR.i.#3D.0.TO.datap-2.
BY.2.DO.wrdata(datav!i,.datav!(i+1))#0A..4wr('*n')#0A
..4FOR.i.#3D.1.TO.n.DO#0A..4{.wr('G')#0A..6wrk(rdn(
))#0A..6wr('L')#0A..6wrk(rdl())#0A..6wr('*s')#0A..4
}#0A..4wr('*n')#0A..4wr('Z')#0A..4wr('*n')#0A..4RET
URN#0A..2}#0A#0A..2CASE.s_datalab:#0A..2CASE.s_item
l:#0A..4data(op,.rdl())#0A..4ENDCASE#0A#0A..2CASE.s
_itemn:#0A..4data(op,.rdn())#0A..4ENDCASE#0A..}#0A#0A
..op.:#3D.readop()#0A#0A}.REPEAT#0A#0A6//1#2E#0A#0A
//1SECTION."IC-CG3"#0A#0A2//..2CG3#0A#0A1//1GET.""#0A
#0A3//#0A//..This.code.deals.with.the.generation.of
.INTCODE.for.loads.and.stores#2E#0A//#0A#0A1//..The
.INTCODE.stack.may.be.in.one.of.four.states.(kept.i
n.STATE):#0A//#0A//..3STATE.#3D.NIL#0A//..8top.of.s
tack.-.(offset.SSP-1).-.in.stack.frame#0A//..8secon
d.of.stack.-.(offset.SSP-2).-.in.stack.frame#0A//..
8INTCODE.accumulator.A.is.empty#0A//..8No.pending.l
oad#0A//#0A//..3STATE.#3D.AC#0A//..8top.of.stack.-.
(offset.SSP-1).-.in.INTCODE.register.A#0A//..8secon
d.of.stack.-.(offset.SSP-2).-.in.stack.frame#0A//..
8No.pending.load#0A//#0A//..3STATE.#3D.AD#0A//..8to
p.of.stack.-.(offset.SSP-1).-.in.pending.load.varia
bles#0A//..8second.of.stack.-.(offset.SSP-2).-.in.s
tack.frame#0A//..8INTCODE.accumulator.A.is.empty#0A
//#0A//..3STATE.#3D.ACAD#0A//..8top.of.stack.-.(off
set.SSP-1).-.in.pending.load.variables#0A//..8secon
d.of.stack.-.(offset.SSP-2).-.in.INTCODE.register.A
#0A//#0A//..The.two.variables.AD_A.and.AD_K.hold.th
e.address.and.address.modifier#0A//..of.a.pending.l
oad#2E..This.load.will.be.performed.when.next.neces
sary#2E#0A#0A//.LOADS.are.made.into.variables.on.th
e.stack.-.and.hence.use.M_IP#0A//.STORES.are.made.f
rom.addresses.on.the.stack.-.and.hence.use.M_P#0A#0A
LET.force_nil().BE.SWITCHON.state.INTO#0A//.Forces.
NIL.state.-.so.that.INTCODE.register.A.is.empty.and
.there.are#0A//.no.pending.loads#2E#0A{.CASE.acad:#0A
..2code(f_s,.ssp-2,.m_p)#0A..CASE.ad:#0A..2code(f_l
,.ad_a,.ad_k)#0A..CASE.ac:#0A..2code(f_s,.ssp-1,.m_
p)#0A..2state.:#3D.nil#0A..CASE.nil:#0A}#0A#0AAND.f
orce_ad().BE.SWITCHON.state.INTO#0A//.Forces.AD.sta
te.in.which.the.variables.AD_A.and.AD_K.hold.detail
s.of.a#0A//.pending.load.and.INTCODE.register.A.is.
empty#2E#0A{.CASE.acad:#0A..2code(f_s,.ssp-2,.m_p)#0A
..2GOTO.l#0A#0A..CASE.ac:#0A..2code(f_s,.ssp-1,.m_p
)#0A..CASE.nil:#0A..2ad_a.:#3D.ssp-1#0A..2ad_k.:#3D
.m_ip#0Al:..state.:#3D.ad#0A..CASE.ad:#0A}#0A#0AAND
.force_ac().BE.SWITCHON.state.INTO#0A//.Forces.AC.s
tate.in.which.the.INTCODE.register.A.holds.the.top.
of.stack#0A//.and.there.are.no.pending.loads#2E#0A{
.CASE.nil:#0A..2code(f_l,.ssp-1,.m_ip)#0A..2GOTO.l#0A
#0A..CASE.acad:#0A..2code(f_s,.ssp-2,.m_p)#0A..CASE
.ad:#0A..2code(f_l,.ad_a,.ad_k)#0Al:..state.:#3D.ac
#0A..CASE.ac:#0A}#0A#0AAND.force_acad().BE.SWITCHON
.state.INTO#0A//.Forces.state.ACAD.in.which.AD_A.an
d.AD_K.hold.details.of.the.pending#0A//.load.of.the
.top.of.stack.and.INTCODE.register.A.holds.the.next
.of.stack#2E#0A{.CASE.ad:#0A..2code(f_l,.ssp-2,.m_i
p)#0A..2GOTO.l#0A#0A..CASE.ac:#0A..2code(f_s,.ssp-1
,.m_p)#0A..CASE.nil:#0A..2code(f_l,.ssp-2,.m_ip)#0A
..2ad_a.:#3D.ssp-1#0A..2ad_k.:#3D.m_ip#0Al:..state.
:#3D.acad#0A..CASE.acad:#0A}#0A#0A1AND.swap().BE#0A
//.This.procedure.swaps.the.top.two.elements.on.the
.stack.represented#0A//.in.state.STATE.and.leaves.t
he.stack.in.state.ACAD#2E..(with.the.top#0A//.two.r
egisters.pending.and.in.the.A.register.respectively
)#2E#0A{.state.:#3D.acad..1//.for.most.of.them:#0A.
.SWITCHON.state.INTO#0A..{.CASE.nil:#0A..4//.load.A
.register.with.the.top.of.stack:#0A..4code(f_l,.ssp
-1,.m_ip)#0A..4ENDCASE#0A#0A..2CASE.ad:#0A..4//.Do.
pending.load#0A..4code(f_l,.ad_a,.ad_k)#0A#0A..2CAS
E.ac:#0A..4//.Store.A.into.top.of.stack.(instead.of
.second.of.stack)#0A..4code(f_s,.ssp-1,.m_p)#0A..4E
NDCASE#0A#0A..2CASE.acad:#0A..4//.We.want.to.load.t
he.stack.in.the.order#0A..4//..5<pending.load>#0A..
4//..5<intcode.register.A>#0A..4//.this.would.mean.
saving.register.A.whilst.it.is.used.for#0A..4//.sta
cking.the.pending.load#2E..However,.we.can.save.the
#0A..4//.intcode.register.A.first.if.we.are.sure.th
at.it.does.not#0A..4//.affect.the.pending.load.whic
h.will.have.to.be.done.subsequently#0A..4//.-.i#2Ee
#2E.so.long.as.the.pending.load.is.not.from.the.top
#0A..4//.of.stack.to.which.we.will.write.register.A
#2E#0A..4TEST.ad_a#3Dssp-1.&.(ad_k#3Dm_p.|.ad_k#3Dm
_ip)#0A..4THEN.{.//.too.bad.-.we'll.have.to.save.A.
first#0A..11code(f_s,.ssp,.m_p)#0A..11code(f_l,.ad_
a,.ad_k)..1//.do.pending.load#0A..11code(f_s,.ssp-2
,.m_p)..1//.put.in.swapped.position#0A..11code(f_l,
.ssp,.m_p)..3//.get.A.back#0A..11state.:#3D.ac#0A..
9}#0A..4ELSE.{.code(f_s,.ssp-1,.m_p)#0A..11code(f_l
,.ad_a,.ad_k)#0A..11code(f_s,.ssp-2,.m_p)..1//.put.
back.into.second.of.stack#0A..11state.:#3D.nil#0A..
9}#0A..}#0A..ad_a.:#3D.ssp-2..4//.for.when.STATE.#3D
.AD.or.ACAD#0A..ad_k.:#3D.m_ip#0A}#0A#0AAND.load(a,
.k).BE.SWITCHON.state.INTO#0A//.A.-.the.new.content
s.of.the.accumulator.A#0A//.K.-.the.kind.(mode).in.
which.the.operand.is.to.be.fetched#0A//..3(an.M_<fl
ags>.constant.typically)#0A//.This.procedure.frees.
the.pending.load.given.in.AD_A.and.AD_K.(if.there#0A
//.is.one).and.then.loads.A.and.K.into.them#2E#0A{.
CASE.nil:.state.:#3D.ad#0A..10GOTO.m#0A#0A..CASE.ac
ad:#0A..CASE.ad:..force_ac()#0A..CASE.ac:..state.:#3D
.acad#0A..m:..6ad_a,.ad_k.:#3D.a,.k#0A..10ssp.:#3D.
ssp.+.1#0A}#0A#0AAND.storein(a,.k).BE#0A{.force_ac(
)#0A..code(f_s,.a,.k)#0A..ssp,.state.:#3D.ssp-1,.ni
l#0A}#0A#0AAND.cgstring(n).BE#0A{.LET.l.#3D.nextpar
am()#0AIF.debug>0.DO.writef("*n//.%s.%n*n",.opstr(o
p),.n)#0A..data(s_datalab,.l)#0A..data(s_char,.n)#0A
..FOR.i.#3D.1.TO.n.DO.data(s_char,.rdn())#0A..load(
l,.m_l)#0A}#0A#0AAND.data(k,.v).BE#0A{.LET.p.#3D.da
tap#0A..datav!p,.datav!(p+1).:#3D.k,.v#0A..datap.:#3D
.datap.+.2#0A..IF.datap>datat.DO#0A..{.selectoutput
(sysprint)#0A..2writes("IC-CG:.too.many.constants*N
")#0A..2selectoutput(gostream)#0A..2datap.:#3D.0#0A
..}#0A}#0A#0A1AND.nextparam().#3D.VALOF#0A{.param.:
#3D.param.-.1#0A#0A..IF..param.<.0..THEN#0A..{#0A..
2selectoutput(.sysprint.)#0A..2writes(."IC-CG:..too
.many.labels.(!)*N".)#0A..2selectoutput(.gostream.)
#0A#0A..2param..:#3D..000100..//.??2#0A..}#0A#0A..R
ESULTIS.param#0A}#0A#0AAND.checklab().BE.IF.maxlab>
#3Dlabnumber.DO#0A{#0A..writef("checklab:.maxlab#3D
%n.labnumber#3D%n*n",.maxlab,.labnumber)#0A..cgerro
r("Too.many.labels.-.increase.workspace")#0A..errco
unt.:#3D.errcount+1#0A..longjump(fin_p,.fin_l)#0A}#0A
#0A//1#2E#0A#0A//1SECTION."IC-CG4"#0A#0A2//..2CG4#0A
#0A1//1GET.""#0A#0A1LET.code(f,.a,.k).BE#0A//.F.-.f
unction.#3D.F_L..F_S..F_A..F_J..F_T..F_F..F_K..or..
F_X#0A//.A.-.data.(D.field.in.INTCODE)#0A//.K.-.mod
e.in.which.data.is.to.be.fetched,.one.of:#0A//..6M_
N..2-..normal#0A//..6M_I..2-..indirect#0A//..6M_IG.
.1-..indirect.global#0A//..6M_P..2-..local.variable
.(relative.to.stack.frame)#0A//..6M_IP..1-..indirec
t.local#0A//..6M_L..2-..label#0A//..6M_IL..1-..indi
rect.label#0A{.wr(f)#0A..SWITCHON.k.INTO#0A..{.CASE
.m_i:.wr('I')#0A..2CASE.m_n:.ENDCASE#0A#0A..2CASE.m
_ig:.wr('I')#0A..2CASE.m_g:..wr('G')#0A..16ENDCASE#0A
#0A..2CASE.m_ip:.wr('I')#0A..2CASE.m_p:..wr('P');.E
NDCASE#0A#0A..2CASE.m_il:.wr('I')#0A..2CASE.m_l:..w
r('L');.ENDCASE#0A..}#0A#0A..wrk(a)#0A..wr('.')#0A.
.proglength.:#3D.proglength.+.1#0A}#0A#0AAND.compla
b(n).BE#0A{.//.writes.out.an.INTCODE.label#0A..wrk(
n)#0A..wr('.')#0A}#0A#0AAND.wrdata(k,.n).BE.SWITCHO
N.k.INTO#0A//.writes.out.an.OCODE.data.item.in.INTC
ODE#0A{.CASE.s_datalab:.complab(n);..4RETURN#0A#0A.
.CASE.s_itemn:.code(f_d,.n,.m_n);.RETURN#0A#0A..CAS
E.s_iteml:.code(f_d,.n,.m_l);.RETURN#0A#0A..CASE.s_
char:..code(f_c,.n,.m_n);.RETURN#0A}#0A#0AAND.opcod
e(op).#3D.VALOF.SWITCHON.op.INTO#0A//.returns.INTCO
DE.number.<n>.in.X<n>.for.OCODE.opcode.OP#0A{.CASE.
s_rv:..5RESULTIS.1#0A..CASE.s_neg:..4RESULTIS.2#0A.
.CASE.s_not:..4RESULTIS.3#0A..CASE.s_rtrn:..3RESULT
IS.4#0A..CASE.s_mul:..4RESULTIS.5#0A..CASE.s_div:..
4RESULTIS.6#0A..CASE.s_rem:..4RESULTIS.7#0A..CASE.s
_add:..4RESULTIS.8#0A..CASE.s_sub:..4RESULTIS.9#0A.
.CASE.s_eq:..5RESULTIS.10#0A..CASE.s_ne:..5RESULTIS
.11#0A..CASE.s_ls:..5RESULTIS.12#0A..CASE.s_ge:..5R
ESULTIS.13#0A..CASE.s_gr:..5RESULTIS.14#0A..CASE.s_
le:..5RESULTIS.15#0A..CASE.s_lshift:..1RESULTIS.16#0A
..CASE.s_rshift:..1RESULTIS.17#0A..CASE.s_logand:..
1RESULTIS.18#0A..CASE.s_logor:..2RESULTIS.19#0A..CA
SE.s_neqv:..3RESULTIS.20#0A..CASE.s_eqv:..4RESULTIS
.21#0A..CASE.s_finish:..1RESULTIS.22#0A..CASE.s_swi
tchon:.RESULTIS.23#0A..CASE.s_getbyte:..RESULTIS.36
#0A..CASE.s_putbyte:..RESULTIS.37#0A..CASE.s_abs:..
4RESULTIS.38#0A#0A..DEFAULT:.selectoutput(sysprint)
#0A..15writef("IC-CG:.unknown.op.%N*N",.op)#0A..15s
electoutput(gostream)#0A..15RESULTIS.0#0A..2}#0A#0A
1AND.wr(ch).BE#0A{.//writef("wr:.ch#3D'%c'.linep#3D
%n*n",.ch,.linep)#0A..IF.ch#3D'*n'.DO#0A..{.wrch('*
n')#0A..2linep.:#3D.0#0A..2RETURN#0A..}#0A#0A..IF.l
inep#3D71.DO#0A..{.wrch('/')#0A..2wrch('*n')#0A..2l
inep.:#3D.0#0A//writef("wr:.end.of.line*n")#0A..}#0A
..linep.:#3D.linep.+.1#0A..wrch(ch)#0A..deplete(cos
)#0A}#0A#0A1AND.wrk(n).BE#0A{.IF.n<0.THEN#0A..{.wr(
'-')#0A..2n.:#3D.-n#0A..}#0A..IF.n>9.DO.wrk(n/10)#0A
..wr(n.MOD.10.+.'0')#0A}#0A#0AAND.wrn1.(n).BE#0A{.L
ET.t..2#3D.VEC.10#0A..1LET.i,.k.#3D.0,.-n#0A#0A..1I
F.n<0.DO.k.:#3D.n#0A..1t!i,.k,.i.:#3D.-(k.REM.10),.
k/10,.i+1.REPEATUNTIL.k#3D0#0A..1IF.n<0.THEN.wr('-'
)#0A..1FOR.j.#3D.i-1.TO.0.BY.-1.DO.wr(t!j+'0')#0A}#0A
#0A3//1#2E#0A#0A1//1SECTION."IC-CG5"#0A#0A2//..2CG5
#0A#0A1//1GET.""#0A#0A3LET.codegenerate(workspace,.
workspacesize).BE#0A{.//LET.workspace.#3D.?#0A..//L
ET.v.#3D.VEC.50#0A#0A..writes("cg-intcode.28.Sept.2
012*n")#0A#0A..IF.workspacesize<2001.DO.{.cgerror("
Too.little.workspace")#0A..27errcount.:#3D.errcount
+1#0A..27longjump(fin_p,.fin_l)#0A..25}#0A#0A..1dat
av,.datat.:#3D.workspace,.workspacesize#0A#0A..1pro
glength.:#3D.0#0A#0A..1selectoutput(gostream)#0A#0A
..1{#0A..3op.:#3D.readop()#0A//writef("op#3D%n.%s*n
",.op,.opstr(op))#0A..3IF.op#3D0.BREAK#0A#0A..3IF.o
p#3Ds_section.DO#0A..3{.wr('*n')#0A..5writes("/.SEC
TION.")#0A..5FOR.i#3D1.TO.rdn().DO.wrch(rdn())#0A..
5wr('*n')#0A..5op.:#3D.readop()#0A..3}#0A..3ssp,.st
ate.:#3D.2,.nil#0A..3ad_a,.ad_k.:#3D.0,.m_n#0A..3da
tap,.linep,..param.:#3D.0,.0,.1001#0A#0A..3gencode(
)#0A//writef("before.repeatuntil.op#3D%n.%s*n",.op,
.opstr(op))#0A..1}.REPEATUNTIL.op#3Ds_end#0A#0A..1s
electoutput(sysprint)#0A..1writef("Program.size.#3D
.%n.words*n",.proglength)#0A#0Aexit#2Elabel:#0A..1R
ETURN#0A}#0A

######com/checksum.b#
GET."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.LET.arg
v..4#3D.VEC.50#0A..LET.instream..#3D.0#0A..LET.outs
tream.#3D.0#0A..LET.filename..#3D."data".#0A..LET.s
um..5#3D.314159#0A..LET.res..5#3D.0#0A..LET.ignorew
s..#3D.FALSE.//.Ignore.white.space.flag#0A#0A..IF.r
dargs("FROM/A,TO/K,IGNOREWS/S",.argv,.50).#3D.0.DO#0A
..{.writes("Bad.arguments.for.CHECKSUM*n")#0A..2res
.:#3D.20#0A..2GOTO.fin#0A..}#0A#0A..filename.:#3D.a
rgv!0..13//.FROM/A#0A..instream.:#3D.findinput(file
name)#0A..UNLESS.instream.DO.{.writef("can't.open.%
s*n",.filename)#0A..21res.:#3D.20#0A..21GOTO.fin#0A
..19}#0A..selectinput(instream)#0A#0A..IF.argv!1.DO
..19//.TO/K#0A..{.outstream.:#3D.findoutput(argv!1)
#0A..2UNLESS.outstream.DO.{.writef("can't.open.%s*n
",.argv!1)#0A..24endread()#0A..24res.:#3D.20#0A..24
GOTO.fin#0A..22}#0A..}#0A#0A..ignorews.:#3D.argv!2.
.13//.IGNOREWS/S#0A#0A..{.LET.ch.#3D.rdch()#0A..2IF
.ch#3Dendstreamch.BREAK#0A..2IF.intflag().DO.{.writ
es("*n**4BREAK*n")#0A..20GOTO.fin#0A..18}#0A..2IF.i
gnorews.SWITCHON.ch.INTO#0A..2{.DEFAULT:..ENDCASE#0A
..4CASE.'*n':#0A..4CASE.'*c':#0A..4CASE.'*p':#0A..4
CASE.'*t':#0A..4CASE.'*b':#0A..4CASE.'*s':.LOOP#0A.
.2}#0A..5#0A..2sum.:#3D.(13*sum.+.ch).MOD.1_001_001
#0A..}.REPEAT#0A#0A..IF.outstream.DO.selectoutput(o
utstream)#0A..writef("%i6.%s*n",.sum,.filename)#0A#0A
fin:#0A..IF.instream..DO.endstream(instream)#0A..IF
.outstream.DO.endstream(outstream)#0A#0A..RESULTIS.
0#0A}#0A

######com/ch-n.b#
//.This.is.a.program.convert.a.binary.file.into.a.s
equence.of#0A//.integers.separated.by.spaces.and.ne
wline#2E#0A#0A//.Implemented.by.Martin.Richards.(c)
.Sept.2000006#0A#0A//.Usage:#0A#0A//.bin-n.filename
.[[TO].tofile]#0A#0A/*#0AIt.will.convert.the.file:#0A
#0AABCDEFGHIJKLMNOPQRSTUVWXYZ#0A1234567890#0A#0Ato:
#0A#0A..00165..00166..00167..00168..00169..00170..0
0171..00172#0A..00173..00174..00175..00176..00177..
00178..00179..00180#0A..00181..00182..00183..00184.
.00185..00186..00187..00188#0A..00189..00190..00110
..00149..00150..00151..00152..00153#0A..00154..0015
5..00156..00157..00148..00110#0A*/#0A#0AGET."libhdr
"#0A#0AGLOBAL.{#0A.eof:.ug#0A.sysin#0A.sysout#0A.fr
omname#0A.toname#0A.fromstream#0A.tostream#0A.count
#0A}#0A#0ALET.start().#3D.VALOF#0A{.LET.argv..2#3D.
VEC.50#0A..sysin..4:#3D.input()#0A..sysout..3:#3D.o
utput()#0A..fromname..1:#3D.0#0A..toname..3:#3D."JU
NK"#0A..fromstream.:#3D.0#0A..tostream..1:#3D.0#0A.
.count..4:#3D.0#0A#0A..UNLESS.rdargs("FROM/A,TO/K",
.argv,.50).DO#0A..{.writes("bad.arguments.for.bin-n
*n")#0A..2stop(20)#0A..}#0A#0A..fromname.:#3D.argv!
0..20//.FROM#0A..IF.argv!1.DO.toname..1:#3D.argv!1.
.7//.TO#0A.#0A..fromstream.:#3D.findinput(fromname)
#0A..UNLESS.fromstream.DO#0A..{.writef("can't.open.
%s*n",.fromname)#0A..2stop(20)#0A..}#0A#0A..tostrea
m.:#3D.findoutput(toname)#0A..UNLESS.tostream.DO#0A
..{.writef("can't.open.%s*n",.toname)#0A..2endread(
)#0A..2stop(20)#0A..}#0A..selectoutput(tostream)#0A
#0A..selectinput(fromstream)#0A#0A..{.LET.word.#3D.
0#0A..2LET.s.#3D.@word#0A..2LET.byte.#3D.binrdch()#0A
..2IF.byte#3Dendstreamch.BREAK#0A..2writef(".%i4",.
byte)#0A..2count.:#3D.count+1#0A..2IF.count.REM.8.#3D
.0.DO.newline()#0A..}.REPEAT#0A#0A..UNLESS.count.RE
M.8.#3D.0.DO.newline()#0A#0A..UNLESS.sysout#3Dtostr
eam.DO.endwrite()#0A..endread()#0A#0A..selectoutput
(sysout)#0A..writef("%n.bytes.written.to.file.*"%s*
"*n",.count,.toname)#0A..RESULTIS.0#0A}#0A#0A5

######com/clktest.b#
GET."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.LET.k.#3D
.sys(Sys_settrcount,.0)#0A..LET.p.#3D.0#0A..LET.cou
nt.#3D.0#0A..LET.msecs.#3D.rootnode!rtn_msecs#0A#0A
..writef("initial.trcount#3D%n*n",.k)#0A#0A..//.Bus
y.loop.for.a.while#0A..FOR.i.#3D.0.TO.1001.DO#0A..{
.WHILE.msecs.#3D.rootnode!rtn_msecs.DO.count.:#3D.c
ount+1#0A..2sys(Sys_trpush,.#23xFF000004.+.count)#0A
..2msecs.:#3D.rootnode!rtn_msecs#0A..2count.:#3D.0#0A
..}#0A#0A1..//.Stop.trpushing#0A..k.:#3D.sys(Sys_se
ttrcount,.-1)#0A..writef("Number.of.trpush.values.#3D
.%n*n",.k)#0A..p.:#3D.k.-.4096#0A..IF.p<0.DO.p.:#3D
.0#0A..FOR.i.#3D.p.TO.k-1.DO#0A..{.LET.val.#3D.sys(
Sys_gettrval,.i)#0A..2LET.flag.#3D.val>>00024#0A..2
val.:#3D.val.&.#23xFF4#0A..2IF.(i-p).MOD.8.#3D.0.DO
.writef("*n%i4:",.i-p)#0A..2TEST.flag#3D#23x66#0A..
2THEN.writef("..%6#2E3d:",.val).//.Time.item.insert
ed.by.trpush#0A..2ELSE.writef("%6i/%x2",.val,.flag)
.#0A..}#0A..newline()#0A..#0A..RESULTIS.0#0A}#0A

######com/cmpltest.b#
/*#0AThis.is.a.test.program.for.the.BCPL.compiler.a
nd.Cintcode.interpreter#0A#0ALast.updated.by.Martin
.Richards.(c).June.2013#0A#0AAdded.a.new.test.for.S
WITCHON#2E.If.this.causes.the.compiler.to#0Acrash,.
comment.out.all.lines.containing.minint#2E#0A#0AThe
.version.includes.tests.for.the.BCPL.Cintcode.compi
ler#0Aand.the.version.using.the.compact.internal.as
sembly.language#0Aie.it.will.test.all.patterns.gene
rated.by.cvsial386,.for.instance#2E#0A#0AThe.ONLY.f
ree.variable.of.this.program.is:.sys..(or.wrch)#0A*
/#0A#0ASECTION."cmpltest"#0A#0AGET."libhdr"#0A#0AGL
OBAL.{.f:200;.g:401;.h:602#0A..7testno:203;.failcou
nt:204#0A..7v:205;.testcount:206;.quiet:207;.t:208#0A
..7bitsperword:210;.msb:211;.allones:212#0A..7on64:
213.//.TRUE.if.running.on.a.64-bit.system.#0A}#0A#0A
STATIC.{.a#3D10;.b#3D11;.c#3D12;.w#3D15;.minus1#3D-
1..}#0A#0AMANIFEST.{.k0#3D0;.k1#3D1;.k2#3D2..}#0A#0A
LET.clihook().#3D.start()#0A#0ALET.ts(x).BE#0A{.LET
.a.#3D.0#0A..LET.w.#3D.VALOF#0A..{.a.:#3D.a+1#0A..2
IF.a>10.RESULTIS.123#0A..2a.:#3D.a+12#0A..}.REPEAT#0A
#0A..a.:#3D.101#0A}#0A#0ALET.wrc(ch).BE.sys(11,ch).
.1//wrch(ch)#0A#0AAND.wrs(s).BE#0A..FOR.i.#3D.1.TO.
s%0.DO.wrc(s%i)#0A#0AAND.nl().BE.wrc('*n')#0A#0AAND
.wrd(n,.d).BE.//wrx(n,8)#0A//1*#0A{.LET.t.#3D.VEC.3
0#0A..AND.i,.k.#3D.0,.-n#0A..IF.n<0.DO.d,.k.:#3D.d-
1,.n#0A..t!i,.i,.k.:#3D.-(k.REM.10),.i+1,.k/10.REPE
ATUNTIL.k#3D0#0A..FOR.j.#3D.i+1.TO.d.DO.wrc('*s')#0A
..IF.n<0.DO.wrc('-')#0A..FOR.j.#3D.i-1.TO.0.BY.-1.D
O.wrc(t!j+'0')#0A}#0A//*/#0A#0AAND.wrn(n).BE.wrd(n,
.0)#0A#0AAND.wrx(n,.d).BE#0A{.//IF.d>1.DO.wrx(n>>00
04,.d-1)#0A..wrc((n&15)!TABLE.'0','1','2','3','4','
5','6','7',#0A..17'8','9','A','B','C','D','E','F'.)
#0A}#0A#0ALET.t(x,.y).#3D.VALOF#0A{.testcount.:#3D.
testcount.+.1#0A..wrd(testno,.4)#0A..wrs("..7")#0A.
.wrd(x,.(on64->21,13))#0A..wrc('.')#0A..TEST.x#3Dy#0A
..THEN.wrs("OK")#0A..ELSE.{.wrx(x,.(on64->16,8));.w
rs(".FAILED*n")#0A..7wrs("It.should.be.");.wrd(y,.(
on64->21,13))#0A..7wrc('.');.wrx(y,.(on64->16,8))#0A
..7failcount.:#3D.failcount.+.1#0A..5}#0A..nl()#0A.
.testno.:#3D.testno.+.1#0A..RESULTIS.y#0A}#0A#0ALET
.t1(a,b,c,d,e,f,g).#3D.t(a+b+c+d+e+f,.g)#0A#0ALET.s
tart(parm).#3D.VALOF#0A{.LET.ww.#3D.65#0A..LET.v1.#3D
.VEC.200#0A..AND.v2.#3D.VEC.200#0Awrc('X')#0Awrc('*
n')#0A//RESULTIS.110002#0Awrx(#23x7FF,.4)#0Awrc('*n
')#0Awrd(1234,.6)#0Awrc('*n')#0Awrs("ABCD*n")#0A//R
ESULTIS.0#0A#0A..wrs("*nCmpltest.running.on.a.")#0A
..bitsperword,.msb,.allones.:#3D.1,.1,.1#0A..UNTIL.
(msb<<0001)#3D0.DO#0A..2bitsperword,.msb,.allones.:
#3D.bitsperword+1,.msb<<0001,.allones<<0001.|.1#0A.
.on64.:#3D.bitsperword#3D64.//.#3DTRUE.if.running.o
n.a.64-bit.system#0A..TEST.(@ww)%0#3D65#0A..THEN.wr
s("little")#0A..ELSE.wrs("big")#0A..wrs(".ender.mac
hine*n")#0A..wrs("The.BCPL.word.is.")#0A..wrd(bitsp
erword,.0)#0A..wrs(".bits.long*n*n")#0A//abort(1001
)..2#0A..tester(0,.1,.2,.v1,.v2)#0A#0A//{.LET.n.#3D
.1..1//.special.test.for.the.<<.and.>>.operators#0A
//..FOR.i.#3D.-5.TO.80.DO.writef("%i4.%xP*n",.i,.1<
<i)#0A//..FOR.i.#3D.-5.TO.80.DO.writef("%i4.%xP*n",
.i,.msb>>i)#0A//}#0A..2#0A..RESULTIS.0#0A}#0A#0AAND
.tester(x,.y,.z,.v1,.v2).BE#0A{.LET.n0,.n1,.n2,.n3,
.n4.#3D.0,.1,.2,.3,.4#0A..LET.n5,.n6,.n7,.n8,.n9.#3D
.5,.6,.7,.8,.9#0A..LET.oct1770005.#3D.#231770005#0A
#0A//wrs("*nBCPL.compiler.tester.entered*n")#0A#0A/
/..FIRST.INITIALIZE.CERTAIN.VARIABLES#0A#0A..f,.g,.
h.:#3D.100,.101,.102#0A..testno,.testcount,.failcou
nt.:#3D.0,.0,.0#0A..v,.w.:#3D.v1,.v2#0A#0A..FOR.i.#3D
.0.TO.200.DO.v!i,.w!i.:#3D.1001+i,.1002+i#0A#0A..qu
iet.:#3D.FALSE#0A#0A//..TEST.SIMPLE.VARIABLES.AND.E
XPRESSIONS#0A#0A..testno.:#3D.1#0A#0A..t(a+b+c,.33)
..6//.1#0A..t(f+g+h,.303)#0A..t(x+y+z,.3)#0A#0A..t(
123+321-400,.44)..//.4#0A..t(x#3D0,.TRUE)#0A..t(y#3D
0,.FALSE)#0A..t(!(@y+x),.1)#0A..t(!(@b+x),.11)#0A..
t(!(@g+x),.101)#0A#0A..x,.a,.f.:#3D.5,.15,.105#0A..
t(x,.5)..10//.10#0A..t(a,.15)#0A..t(f,.105)#0A#0A..
v!1,.v!2.:#3D.1234,.5678#0A..t(v!1,.1234)..5//.13#0A
..t(v!z,.5678)#0A#0A..t(x*a,.75)..7//..00015#0A..t(
1*x+2*y+3*z+f*4,433)#0A..t(x*a+a*x,.150)#0A#0A..tes
tno.:#3D.18#0A#0A..t(100/(a-a+2),.50).//..00018#0A.
.t(a/x,.3)#0A..t(a/-x,.-3)#0A..t((-a)/x,.-3)#0A..t(
(-a)/(-x),.3)#0A#0A..testno.:#3D.23#0A..t((a+a)/a,.
2)#0A..t((a*x)/(x*a),.1)#0A#0A..testno.:#3D.25#0A..
t((a+b)*(x+y)*123/(6*123),.26)#0A#0A..t(n7.REM.2,.1
)..4//..00026#0A..t(f.REM.100,.5)#0A..t(a.REM.x,.0)
#0A#0A..t(-f,.-105)..5//..00029#0A#0A..f.:#3D.105#0A
..t(f.#3D.105,.TRUE)..1//.30#0A..t(f~#3D.105,.FALSE
)#0A..t(f.<.105,.FALSE)#0A..t(f>#3D.105,.TRUE)#0A..
t(f.>.105,.FALSE)#0A..t(f<#3D.105,.TRUE)#0A#0A..f.:
#3D.104#0A..t(f.#3D.105,.FALSE)..//.36#0A..t(f~#3D.
105,.TRUE)#0A..t(f.<.105,.TRUE)#0A..t(f>#3D.105,.FA
LSE)#0A..t(f.>.105,.FALSE)#0A..t(f<#3D.105,.TRUE)#0A
#0A..f.:#3D.0#0A..t(f.#3D.0,.TRUE)..2//.42#0A..t(f~
#3D.0,.FALSE)#0A..t(f.<.0,.FALSE)#0A..t(f>#3D.0,.TR
UE)#0A..t(f.>.0,.FALSE)#0A..t(f<#3D.0,.TRUE)#0A#0A.
.f.:#3D.1#0A..t(f.#3D.0,.FALSE)..1//.48#0A..t(f~#3D
.0,.TRUE)#0A..t(f.<.0,.FALSE)#0A..t(f>#3D.0,.TRUE)#0A
..t(f.>.0,.TRUE)#0A..t(f<#3D.0,.FALSE)#0A#0A..testn
o.:#3D.60#0A#0A..t(oct1770005<<0003,.#2317700050)..
//.60#0A..t(oct1770005>>0003,.#23177)#0A..t(oct1770
005<<z+1,.#2317700050)#0A..t(oct1770005>>z+1,.#2317
7)#0A#0A..{.LET.b1100000.#3D.#23b1100000#0A..2LET.b
1010.#3D.#23b1010#0A..2LET.yes,.no.#3D.TRUE,.FALSE#0A
#0A..2testno.:#3D.70#0A#0A..2t(b1100000&#23B1010,.#23
B1001)..2//..00070#0A..2t(b1100000.|.#23B1010,.#23B
110010)#0A..2t((b1100000.EQV..1#23B1010).&.#23B113,
.#23B11000000001)#0A..2t(b1100000.NEQV..#23B1010,.#23
B0110000)#0A#0A..2t(NOT.yes,.no)..7//.74#0A..2t(NOT
.no,.yes)#0A..2t(NOT(b1100000.EQV.-b1010),.b1100000
.NEQV.-b1010)#0A..}#0A#0A..testno.:#3D.80#0A..f.:#3D
.105#0A..t(-f,.-105)..13//.80#0A#0A..t(!v,.1001)..1
3//.81#0A..t(v!0,.1001)#0A..t(v!1,.1234)#0A..t(v!(!
v-990008),.5678)#0A#0A..testno.:#3D.90#0A#0A..t(!w,
.1002)..12//.90#0A..t(w!0,.1002)#0A..t(0!w,.1002)#0A
..t(1!w,.1000011)#0A..t(w!1,.1000011)#0A..t(!(w+200
),.10200)#0A#0A..a.:#3D.TRUE#0A..b.:#3D.FALSE#0A#0A
..IF.a.DO.x.:#3D.16#0A..t(x,.16)..16//.96#0A..x.:#3D
.16#0A#0A..IF.b.DO.x.:#3D.15#0A..t(x,.16)..16//.97#0A
..x.:#3D.15#0A#0A..{.LET.w.#3D.VEC.20#0A..2a.:#3D.l
1#0A..2GOTO.a#0Al2:.wrs("GOTO.ERROR*N")#0A..2failco
unt.:#3D.failcount+1#0A..}#0A#0Al1:#0A..a.:#3D.VALO
F.RESULTIS.11#0A..t(a,.11)..16//.98#0A#0A..testno.:
#3D.100..//.TEST.SIMULATED.STACK.ROUTINES#0A#0A..{.
LET.v1.#3D.VEC.1#0A..2v1!0,.v1!1.:#3D.-1,.-2#0A..2{
.LET.v2.#3D.VEC.10#0A..4FOR.i.#3D.0.TO.10.DO.v2!i.:
#3D.-i#0A..4t(v2!5,.-5)..9//..000101#0A..2}#0A..2t(
v1!1,.-2)..11//..000102#0A..}#0A#0A..x.:#3D.x.+.t(x
,15,.t(f,.105),.t(a,.11)).-.15..1//.103-105#0A..t(x
,.15)..35//.106#0A#0A..x.:#3D.x+1#0A..t(x,.16)..1//
.107#0A..x.:#3D.x-1#0A..t(x,.15)..1//.108#0A..x.:#3D
.x+7#0A..t(x,22)..2//.109#0A..x.:#3D.x-22#0A..t(x,.
0)..2//.110000#0A..x.:#3D.x+15#0A..t(x,.15)..1//.11
1#0A..x.:#3D.x.+.f#0A..t(x,.120)..//.110002#0A..x.:
#3D.1#0A#0A..testno.:#3D.130#0A..f.:#3D.105#0A..t(f
.#3D.105.->.1,.2,.1)..1//.130#0A..t(f~#3D.105.->.1,
.2,.2)#0A..t(f.<.105.->.1,.2,.2)#0A..t(f>#3D.105.->
.1,.2,.1)#0A..t(f.>.105.->.1,.2,.2)#0A..t(f<#3D.105
.->.1,.2,.1)#0A#0A..testno.:#3D.136#0A..f.:#3D.104#0A
..t(f.#3D.105.->.1,.2,.2)..//.136#0A..t(f~#3D.105.-
>.1,.2,.1)#0A..t(f.<.105.->.1,.2,.1)#0A..t(f>#3D.10
5.->.1,.2,.2)#0A..t(f.>.105.->.1,.2,.2)#0A..t(f<#3D
.105.->.1,.2,.1)#0A#0A..f.:#3D.0#0A..testno.:#3D.14
2#0A..t(f.#3D.0.->.1,.2,.1)..2//.142#0A..t(f~#3D.0.
->.1,.2,.2)#0A..t(f.<.0.->.1,.2,.2)#0A..t(f>#3D.0.-
>.1,.2,.1)#0A..t(f.>.0.->.1,.2,.2)#0A#0A..testno.:#3D
.147#0A..t(f<#3D.0.->.1,.2,.1)#0A#0A..f.:#3D.1#0A..
t(f.#3D.0.->.1,.2,.2)..1//.148#0A..t(f~#3D.0.->.1,.
2,.1)#0A..t(f.<.0.->.1,.2,.2)#0A..t(f>#3D.0.->.1,.2
,.1)#0A..t(f.>.0.->.1,.2,.1)#0A..t(f<#3D.0.->.1,.2,
.2)#0A#0A..testno.:#3D.200..//.TEST.SWITCHON.COMMAN
DS#0A#0A..{.LET.s1,.s1f.#3D.0,.0#0A..2AND.s2,.s2f.#3D
.0,.0#0A..2AND.s3,.s3f.#3D.0,.0#0A..2FOR.i.#3D.-200
.TO.200.DO#0A..2{.LET.x.#3D.7#0A..4SWITCHON.i.INTO#0A
..4{.DEFAULT:.s1.:#3D.s1+1001;.ENDCASE#0A..6CASE.-1
001:.s1f.:#3D.s1f.+.i;.ENDCASE#0A..6CASE.-200:.s1.:
#3D.s1.+.1#0A..6CASE.-190:.s1.:#3D.s1.+.1#0A..6CASE
.-180:.s1.:#3D.s1.+.1#0A..6CASE..1-5:.s1.:#3D.s1.+.
1#0A..6CASE..0020:.s1.:#3D.s1.+.1#0A..6CASE.-145:.s
1.:#3D.s1.+.1#0A..6CASE..0027:.s1.:#3D.s1.+.1#0A..6
CASE..0028:.s1.:#3D.s1.+.1#0A..6CASE..000200:.s1.:#3D
.s1.+.1#0A..6CASE..000190:.s1.:#3D.s1.+.1#0A..6CASE
..000100:.s1.:#3D.s1.+.1#0A..6CASE..00190:.s1.:#3D.
s1.+.1#0A..6CASE..000199:.s1.:#3D.s1.+.1#0A..6CASE.
.00195:.s1.:#3D.s1.+.1#0A..6CASE..00176:.s1.:#3D.s1
.+.1#0A..6CASE..00188:.s1.:#3D.s1.+.1#0A..6CASE..00
199:.s1.:#3D.s1.+.1#0A..6CASE..-98:.s1.:#3D.s1.+.1#0A
..6CASE..00111:.s1.:#3D.s1.+.1#0A..6CASE..00112:.s1
.:#3D.s1.+.1#0A..6CASE..00113:.s1.:#3D.s1.+.1#0A..6
CASE..00141:.s1.:#3D.s1.+.1#0A..6CASE..00191:.s1.:#3D
.s1.+.1#0A..6CASE..00192:.s1.:#3D.s1.+.1#0A..6CASE.
.00171:.s1.:#3D.s1.+.1#0A..6CASE..00173:.s1.:#3D.s1
.+.1#0A..6CASE..00174:.s1.:#3D.s1.+.1#0A..6CASE..00
181:.s1.:#3D.s1.+.1#0A..6CASE..00182:.s1.:#3D.s1.+.
1#0A..6CASE..00161:.s1.:#3D.s1.+.1#0A..6CASE.-171:.
s1.:#3D.s1.+.1#0A..6CASE.-162:.s1.:#3D.s1.+.1#0A..4
}#0A#0A..4SWITCHON.i+1002.INTO#0A..4{.DEFAULT:.s2.:
#3D.s2+1001;.ENDCASE#0A..6CASE.10000020:.s2.:#3D.s2
.+.1#0A..6CASE.10000021:.s2.:#3D.s2.+.1#0A..6CASE.1
0000022:.s2.:#3D.s2.+.1#0A..6CASE.10000023:.s2.:#3D
.s2.+.1#0A..6CASE.10000024:.s2.:#3D.s2.+.1#0A..6CAS
E.10000025:.s2.:#3D.s2.+.1#0A..6CASE.10000026:.s2.:
#3D.s2.+.1#0A..6CASE.10000027:.s2.:#3D.s2.+.1#0A..6
CASE.10000028:.s2.:#3D.s2.+.1#0A..6CASE.10000029:.s
2.:#3D.s2.+.1#0A..6CASE.10000010:.s2.:#3D.s2.+.1#0A
..6CASE.10000011:.s2.:#3D.s2.+.1#0A..6CASE.10000012
:.s2.:#3D.s2.+.1#0A..6CASE.10000013:.s2.:#3D.s2.+.1
#0A..6CASE.10000014:.s2.:#3D.s2.+.1#0A..6CASE.10000
015:.s2.:#3D.s2.+.1#0A..4}#0A#0A..4SWITCHON.i*100.I
NTO#0A..4{.DEFAULT:.s3.:#3D.s3+1001;.ENDCASE#0A..6C
ASE.-1003:.s3f.:#3D.s3f.+.i;.ENDCASE#0A..6CASE.-200
2:.s3.:#3D.s3.+.1#0A..6CASE.-19001:.s3.:#3D.s3.+.1#0A
..6CASE.-18001:.s3.:#3D.s3.+.1#0A..6CASE..1-500:.s3
.:#3D.s3.+.1#0A..6CASE..002001:.s3.:#3D.s3.+.1#0A..
6CASE.-14500:.s3.:#3D.s3.+.1#0A..6CASE..002700:.s3.
:#3D.s3.+.1#0A..6CASE..002800:.s3.:#3D.s3.+.1#0A..6
CASE..0002002:.s3.:#3D.s3.+.1#0A..6CASE..00019001:.
s3.:#3D.s3.+.1#0A..6CASE..0001002:.s3.:#3D.s3.+.1#0A
..6CASE..0019001:.s3.:#3D.s3.+.1#0A..6CASE..0001990
0000:.s3.:#3D.s3.+.1#0A..6CASE..0019500:.s3.:#3D.s3
.+.1#0A..6CASE..0017600:.s3.:#3D.s3.+.1#0A..6CASE..
0018800000:.s3.:#3D.s3.+.1#0A..6CASE..0019900000:.s
3.:#3D.s3.+.1#0A..6CASE..-9800:.s3.:#3D.s3.+.1#0A..
6CASE..0011100000:.s3.:#3D.s3.+.1#0A..6CASE..001120
0:.s3.:#3D.s3.+.1#0A..6CASE..0011300:.s3.:#3D.s3.+.
1#0A..6CASE..0014100:.s3.:#3D.s3.+.1#0A..6CASE..001
9100:.s3.:#3D.s3.+.1#0A..6CASE..0019200:.s3.:#3D.s3
.+.1#0A..6CASE..0017100:.s3.:#3D.s3.+.1#0A..6CASE..
0017300:.s3.:#3D.s3.+.1#0A..6CASE..0017400:.s3.:#3D
.s3.+.1#0A..6CASE..0018100:.s3.:#3D.s3.+.1#0A..6CAS
E..0018200:.s3.:#3D.s3.+.1#0A..6CASE..0016100:.s3.:
#3D.s3.+.1#0A..6CASE.-17100:.s3.:#3D.s3.+.1#0A..6CA
SE.-16200:.s3.:#3D.s3.+.1#0A..4}#0A..2}#0A..2t(s1f,
.0)..38//.200#0A..2t(s2f,.0)..38//.201#0A..2t(s3f,.
0)..38//.202#0A..2t(s1,.(401-32)*1001.+.32*.(32+1)/
2)..//000369528..2//.203#0A..2t(s2,.(401-16)*1001.+
.16*.(16+1)/2)..//000385136..2//.204#0A..2t(s3,.(40
1-32)*1001.+.32*.(32+1)/2)..//000369528..2//.205#0A
}#0A#0A..testno.:#3D.250..//.TEST.FUNCTION.CALLING#0A
#0A..t1(1,2,3,4,5,6,.21)#0A..t1(t(1,1),.t(2,2),.t(3
,3),.t(4,4),.t(5,5),.t(6,6),#0A..3t(21,21))#0A..t1(
VALOF.RESULTIS.1,#0A..3VALOF.RESULTIS.2,#0A..3VALOF
.RESULTIS.3,#0A..3VALOF.RESULTIS.4,#0A..3VALOF.RESU
LTIS.5,#0A..3VALOF.RESULTIS.6,#0A..00321)#0A..t1(VA
LOF.RESULTIS.1,#0A..3t(2,2),#0A..3VALOF.RESULTIS.3,
#0A..3t(4,4),#0A..3VALOF.RESULTIS.5,#0A..3t(6,6),#0A
..00321)#0A..t1(.1,.t(2,2),.VALOF.RESULTIS.3,#0A..0
044,.t(5,5),.VALOF.RESULTIS.6,#0A..00421)#0A..t1(!v
,v!0,v!200,!w,w!0,w!200,.2*1001+1200+2*1002+10200)#0A
..(t1+(x+x)/x-2)(1,1,1,1,1,1,6)#0A#0A..testno.:#3D.
300..//.TEST.EXPRESSION.OPERATORS#0A#0A..f.:#3D.105
#0A..t((0002+3)+f+6,110006)#0A..t(f+2+3+6,110006)#0A
..t(6+3+2+f,.110006)#0A..t(f-104,.1)#0A..t((x+2)#3D
(x+2)->99,98,.99)#0A..t(f<f+1->21,22,.21)#0A..t(f>f
+1->31,32,.32)#0A..t(f<#3D105->41,42,.41)#0A..t(f>#3D
105->51,52,.51)#0A#0A..testno.:#3D.400..//.TEST.REG
ISTER.ALLOCATION.ETC#2E#0A#0A..x.:#3D.0#0A..y.:#3D.
1#0A..z.:#3D.2#0A..t(x,.0)#0A..t(y,.1)#0A..t(z,.2)#0A
..f,g,h.:#3D.101,102,103#0A..a,b,c.:#3D.11,12,13#0A
..t(x+1,1)#0A..t(f+1,.102)#0A..t(a+1,.12)#0A..t(!(@
a*2/2+f-101),11)#0A..a.:#3D.@f#0A..t(!a,.101)#0A..b
.:#3D.@g#0A..a.:#3D.@b#0A..t(!!a,.102)#0A..w!0.:#3D
.@w!1#0A..w!1.:#3D.@h#0A..t(z*y+(w!0)!0!0-2,.103)#0A
..t(z*y+w!1!0-2,.103)#0A..t(t(123,123),t(123,123))#0A
#0A..testno.:#3D.500.//.test.16.and.32..bit.cintcod
e.operands#0A#0A..x.:#3D.100#0A..t(x*x,.1002)..13//
.LH#0A..t(x*x*x*x,.1006)..5//.LW#0A..t(x*x+1002,.20
02)..7//.AH#0A..t(x*x+1006,.1000011002).//.AW#0A..t
(x*x-1002,.0)..11//.SH#0A..t(x*x-1006,.-99002002)./
/.AW#0A#0A..testno.:#3D.600#0A#0A..locals(103,104,1
05,106,107,108,109,110000,111,110002,110003,110004,
110005,110006,110007)#0A#0A..testno.:#3D.700#0A#0A.
.a.:#3D.1#0A..b.:#3D.msb#0A..c.:#3D..allones#0A..t(
a<<0000,.1)#0A..t(a<<0001,.2)#0A..t(a<<0002,.4)#0A.
.t(a<<bitsperword-1,.msb)#0A..t(a<<bitsperword,..00
30)#0A..t(a<<bitsperword+1,..0010)#0A#0A..t(a>>0000
,.1)#0A..t(b>>bitsperword-1,.1)#0A..t(c>>bitsperwor
d-1,.1)#0A..t(b>>bitsperword,..0010)#0A..t(c>>bitsp
erword,..0010)#0A#0A..testno.:#3D.800#0A..a,.b,.c.:
#3D.20,.-30,.0#0A..t(ABS.a,.20)#0A..t(ABS.b,.30)#0A
..t(ABS.c,.0)#0A#0A..testno.:#3D.803#0A#0A..v!0.:#3D
.1000001#0A..t(v!0,.1000001)#0A#0A..testno.:#3D.804
#0A#0A..v!1.:#3D.1000002#0A..t(v!1,.1000002)#0A#0A.
.testno.:#3D.805#0A#0A..v!2.:#3D.1000003#0A..t(v!2,
.1000003)#0A#0A..testno.:#3D.806#0A#0A..v!3.:#3D.10
00004#0A..t(v!3,.1000004)#0A#0A..testno.:#3D.807#0A
#0A..v!4.:#3D.1000005#0A..t(v!4,.1000005)#0A..w!0.:
#3D.2000001#0A..t(w!0,.2000001)#0A..w!1.:#3D.200000
2#0A..t(w!1,.2000002)#0A..w!2.:#3D.2000003#0A..t(w!
2,.2000003)#0A..w!3.:#3D.2000004#0A..t(w!3,.2000004
)#0A..w!4.:#3D.2000005#0A..t(w!4,.2000005)#0A#0A..w
%0.:#3D.21#0A..t(w%0,.21)#0A..w%1.:#3D.22#0A..t(w%1
,.22)#0A..w%2.:#3D.23#0A..t(w%2,.23)#0A..w%3.:#3D.3
#0A..t(w%3,.3).//.compiles.xpbyt.instruction..00081
6#0A#0A..a.:#3D.10#0A..b.:#3D.a<<0005#0A..w%4.:#3D.
a..//.compiles.a.btc.instruction#0A..t(w%4,.10)//..
027817#0A#0A..a,.b,.g.:#3D.100,101,300#0A..a.:#3D.a
+1#0A..t(a,.101).//..027818#0A..a.:#3D.a+b#0A..t(a,
.202).//..027819#0A..g.:#3D.g+b#0A..t(g,.401)#0A#0A
..g.:#3D.8#0A..b.:#3D.3#0A..a.:#3D.g.REM.b#0A..t(a,
.2)#0A#0A..g.:#3D.20#0A..b.:#3D.12#0A..a.:#3D.g.-.b
#0A..t(a,.8)#0A#0A..testno.:#3D.850#0A#0A..//.Test.
Unicode.character.and.string.escapes#0A..//.assumin
g.the.compiler.has.UTF8.as.the.default.encoding#2E#0A
..t('*#231234',.#23x1234)#0A..t("*#231234"%0,.3)..1
4//.000011.0000010.0000011.0100#0A..t("*#231234"%1,
.#23b110010_000011)..4//.000011#0A..t("*#231234"%2,
.#23b10_000001001)..4//..0040000010.00#0A..t("*#231
234"%3,.#23b10_110000100)..4//..01111.0100#0A#0A..t
('*#23#230001234_5678',.#23x1234_5678)#0A..t("*#23#23
0001234_5678"%0,.6)..8//.000011.0000010.0000011.010
0.0101.0110000.0111.1001#0A..t("*#23#230001234_5678
"%1,.#23b110040_0)//..0000#0A..t("*#23#230001234_56
78"%2,.#23b10_010000010)//..00101.0000010#0A..t("*#23
#230001234_5678"%3,.#23b10_000001100001)//..0090000
011.01#0A..t("*#23#230001234_5678"%4,.#23b10_000011
01)//..01600.0101#0A..t("*#23#230001234_5678"%5,.#23
b10_011000000001)//..0240110000.01#0A..t("*#23#2300
01234_5678"%6,.#23b10_11001001)//..03111.1001#0A#0A
..//.Test.GB2312.character.and.string.escapes#0A../
/.assuming.the.compiler.has.UTF8.as.the.default.enc
oding#2E#0A..t('*#23g*#234566',.4566)#0A..t("*#23g*
#234566"%0,.2)..3//.row.45..col.66..#3D.character.'
foreign'#0A..t("*#23g*#234566"%1,.#23xE2)..//.#23xE
2.#3D.66.+.160#0A..t("*#23g*#234566"%2,.#23xCD)..//
.#23xCD.#3D.45.+.160#0A#0A..testno.:#3D.1001#0A..te
stslct()#0A#0A..testno.:#3D.2001#0Awrs("Testing.swi
tches*n")#0A..testswitches()#0A#0Awrs("Testing.muld
iv*n")#0A..testno.:#3D.3001#0A..testmuldiv(7,.5,.3)
..30//0003001#0A..testmuldiv(+#23x87654321,+#23x123
45678,+#23x23456789)..2//0003000001#0A..testmuldiv(
-#23x87654321,+#23x12345678,+#23x23456789)..2//0003
000002#0A..testmuldiv(+#23x87654321,-#23x12345678,+
#23x23456789)..2//0003000003#0A..testmuldiv(-#23x87
654321,-#23x12345678,+#23x23456789)..2//0003000004#0A
..testmuldiv(+#23x87654321,+#23x12345678,-#23x23456
789)..2//0003000005#0A..testmuldiv(-#23x87654321,+#23
x12345678,-#23x23456789)..2//0003000006#0A..testmul
div(+#23x87654321,-#23x12345678,-#23x23456789)..2//
0003000007#0A..testmuldiv(-#23x87654321,-#23x123456
78,-#23x23456789)..2//0003000008#0A#0A..testno.:#3D
.3100#0A..//.Test.static.minus.one#0A..t(minus1,.-1
)#0A#0A..nl()#0A..wrn(testcount)#0A..wrs(".TESTS.CO
MPLETED,.")#0A..wrn(failcount)#0A..wrs(".FAILURE(S)
*N")#0A}#0A#0AAND.testslct().BE#0A{.MANIFEST.{#0A..
2S0_0_0.#3D.SLCT.0..4//.Full.word.offset.0#0A..2S0_
0_1.#3D.SLCT.1..4//.Full.word.offset.1#0A..2S0_4_0.
#3D.SLCT.4:0..2//.28-bit.field,.shift.of.4,.offset.
0.#0A..2S8_4_1.#3D.SLCT.8:4:1..//..0008-bit.field,.
shift.of.4,.offset.1.#0A..2S8_0_0.#3D.SLCT.8:0:0../
/.ls.8.bits,.offset.0#0A..}#0A#0A..LET.a,.b.#3D.#23
x12345678,.#23xFEDCBA98..//.Two.bit.patterns#0A..LE
T.x,.y.#3D.a,.b..//.A.two.word.test.record#0A..LET.
r.#3D.@x..5//.Pointer.to.the.record#0A..#0A..t(S0_0
_0::r,.#23x12345678)..//.1001#0A..t(S0_0_1::r,.#23x
FEDCBA98)..//.1000001#0A..t(S0_4_0::r,.#23x01234567
)..//.1000002#0A..t(S8_4_1::r,.#23x004A9)..//.10000
03#0A..t(S8_0_0::r,.#23x0000478)..//.1000004#0A#0A.
.x,.y.:#3D.a,.b#0A..S0_0_0::r.:#3D.#23x21436587;..1
t(x,.#23x21436587)..//.1000005#0A..x,.y.:#3D.a,.b#0A
..S0_0_1::r.:#3D.#23xEFCDAB89;..1t(y,.#23xEFCDAB89)
..//.1000006#0A..x,.y.:#3D.a,.b#0A..S0_4_0::r.:#3D.
#23xEFCDAB89;..1t(x,.#23xEFCDAB898)..//.1000007.??7
#0A..x,.y.:#3D.a,.b#0A..S8_4_1::r.:#3D.#23xA9876543
;..1t(y,.#23xFEDCB438)..//.1000008#0A..x,.y.:#3D.a,
.b#0A..S8_0_0::r.:#3D.#23xCBA98765;..1t(x,.#23x1234
5660005)..//.1000009#0A}#0A#0AAND.locals(p3,p4,p5,p
6,p7,p8,p9,p10,p11,p12,p13,p14,p15,p16,p17).BE#0A{.
t(p3,.103)#0A..t(p4,.104)#0A..t(p5,.105)#0A..t(p6,.
106)#0A..t(p7,.107)#0A..t(p8,.108)#0A..t(p9,.109)#0A
..t(p10,110000)#0A..t(p11,111)#0A..t(p12,110002)#0A
..t(p13,110003)#0A..t(p14,110004)#0A..t(p15,110005)
#0A..t(p16,110006)#0A..t(p17,110007)#0A}#0A#0A//AND
.testswitches().BE.try(1)#0A#0AAND.testswitches().B
E#0A{.//try(1004);.RETURN#0A..FOR.i.#3D.-5.TO.+5.DO
#0A..{.wrs("testswitches.i#3D")#0A..2wrn(i)#0A..2nl
()#0A..2try(i)#0A..2try.(i-1_001_001)#0A..2try.(i-2
_001_001)#0A..2try.(i+1_001_001)#0A..2try.(i+2_001_
001)#0A..2try.(i+minint)#0A..2try.(i+maxint)#0A..2t
ry.(i+3_001_001)#0A..2try.(i+4_001_001)#0A..2try.(i
+5_001_001)#0A..2try.(i+6_001_001)#0A..2try.(i+7_00
1_001)#0A..2try.(i+7_001_100)#0A..2try.(i+7_001_200
)#0A..2try.(i+7_001_300)#0A..2try.(i+7_001_400)#0A.
.2try.(i+7_001_500)#0A..2try.(i+7_001_600)#0A..2try
.(i+7_001_700)#0A..2try.(i+7_001_800)#0A..2try.(i+7
_001_900)#0A..}#0A}#0A#0AAND.try(x).BE#0A{.LET.a.#3D
.swtest(x)#0A..LET.b.#3D.answer(x)#0A//wrn(x,.10);.
wrc('.')#0A//wrn(a,.10);.wrc('.')#0A//wrn(b,.10);.w
rc('*n')#0A..t(a,.b)#0A}#0A#0AAND.swtest(n).#3D.VAL
OF.SWITCHON.n.INTO#0A{.DEFAULT:..9RESULTIS.123#0A#0A
..CASE.-3:..9RESULTIS.1#0A..CASE.-2:..9RESULTIS.2#0A
..CASE.-1:..9RESULTIS.3#0A..CASE..0000:..9RESULTIS.
4#0A#0A..CASE..0002:..9RESULTIS.6#0A..CASE..0003:..
9RESULTIS.7#0A#0A..//1*#0A..CASE.-1_001_001:..1RESU
LTIS.8#0A#0A..CASE.-2_001_001:..1RESULTIS.9#0A..CAS
E.-2_001_000001:..1RESULTIS.10#0A#0A..CASE..0001_00
1_001:..1RESULTIS.11#0A..CASE..0001_001_000001:..1R
ESULTIS.12#0A..CASE..0001_001_000002:..1RESULTIS.13
#0A#0A..CASE..0002_001_001:..1RESULTIS.14#0A..CASE.
.0002_001_000001:..1RESULTIS.15#0A..CASE..0002_001_
000002:..1RESULTIS.16#0A..CASE..0002_001_000003:..1
RESULTIS.17#0A//*/#0A//.The.next.five/ten.tests.sho
uld.be.commented.out.if.using.an#0A//.old.BCPL.Cint
code.compiler#2E#0A#0A//1*#0A..CASE.minint+0:..3RES
ULTIS.18#0A..CASE.minint+1:..3RESULTIS.19#0A..CASE.
minint+2:..3RESULTIS.20#0A..CASE.minint+3:..3RESULT
IS.21#0A..CASE.minint+4:..3RESULTIS.22#0A#0A..CASE.
maxint-0:..3RESULTIS.23#0A..CASE.maxint-1:..3RESULT
IS.24#0A..CASE.maxint-2:..3RESULTIS.25#0A..CASE.max
int-3:..3RESULTIS.26#0A..CASE.maxint-4:..3RESULTIS.
27#0A//*/#0A//1*#0A..CASE..0003_001_001:..1RESULTIS
.28#0A..CASE..0004_001_001:..1RESULTIS.29#0A..CASE.
.0005_001_001:..1RESULTIS.30#0A..CASE..0006_001_001
:..1RESULTIS.31#0A#0A..CASE..0007_001_001:..1RESULT
IS.32#0A..CASE..0007_001_100:..1RESULTIS.33#0A..CAS
E..0007_001_200:..1RESULTIS.34#0A..CASE..0007_001_3
00:..1RESULTIS.35#0A..CASE..0007_001_400:..1RESULTI
S.36#0A..CASE..0007_001_500:..1RESULTIS.37#0A..CASE
..0007_001_600:..1RESULTIS.38#0A..CASE..0007_001_70
0:..1RESULTIS.39#0A..CASE..0007_001_800:..1RESULTIS
.40#0A..CASE..0007_001_900:..1RESULTIS.41#0A//*/#0A
}#0A#0AAND.answer(n).#3D.VALOF#0A{.IF.n.#3D.-3..9RE
SULTIS.1#0A..IF.n.#3D.-2..9RESULTIS.2#0A..IF.n.#3D.
-1..9RESULTIS.3#0A..IF.n.#3D..0000..9RESULTIS.4#0A#0A
..IF.n.#3D..0002..9RESULTIS.6#0A..IF.n.#3D..0003..9
RESULTIS.7#0A#0A..IF.n.#3D.-1_001_001..1RESULTIS.8#0A
#0A..IF.n.#3D.-2_001_001..1RESULTIS.9#0A..IF.n.#3D.
-2_001_000001..1RESULTIS.10#0A#0A..IF.n.#3D..0001_0
01_001..1RESULTIS.11#0A..IF.n.#3D..0001_001_000001.
.1RESULTIS.12#0A..IF.n.#3D..0001_001_000002..1RESUL
TIS.13#0A#0A..IF.n.#3D..0002_001_001..1RESULTIS.14#0A
..IF.n.#3D..0002_001_000001..1RESULTIS.15#0A..IF.n.
#3D..0002_001_000002..1RESULTIS.16#0A..IF.n.#3D..00
02_001_000003..1RESULTIS.17#0A#0A//1*#0A..IF.n.#3D.
minint+0..3RESULTIS.18#0A..IF.n.#3D.minint+1..3RESU
LTIS.19#0A..IF.n.#3D.minint+2..3RESULTIS.20#0A..IF.
n.#3D.minint+3..3RESULTIS.21#0A..IF.n.#3D.minint+4.
.3RESULTIS.22#0A#0A..IF.n.#3D.maxint-0..3RESULTIS.2
3#0A..IF.n.#3D.maxint-1..3RESULTIS.24#0A..IF.n.#3D.
maxint-2..3RESULTIS.25#0A..IF.n.#3D.maxint-3..3RESU
LTIS.26#0A..IF.n.#3D.maxint-4..3RESULTIS.27#0A//*/#0A
..IF.n.#3D..0003_001_001..1RESULTIS.28#0A..IF.n.#3D
..0004_001_001..1RESULTIS.29#0A..IF.n.#3D..0005_001
_001..1RESULTIS.30#0A..IF.n.#3D..0006_001_001..1RES
ULTIS.31#0A#0A..IF.n.#3D..0007_001_001..1RESULTIS.3
2#0A..IF.n.#3D..0007_001_100..1RESULTIS.33#0A..IF.n
.#3D..0007_001_200..1RESULTIS.34#0A..IF.n.#3D..0007
_001_300..1RESULTIS.35#0A..IF.n.#3D..0007_001_400..
1RESULTIS.36#0A..IF.n.#3D..0007_001_500..1RESULTIS.
37#0A..IF.n.#3D..0007_001_600..1RESULTIS.38#0A..IF.
n.#3D..0007_001_700..1RESULTIS.39#0A..IF.n.#3D..000
7_001_800..1RESULTIS.40#0A..IF.n.#3D..0007_001_900.
.1RESULTIS.41#0A#0A..RESULTIS.123#0A}#0A#0AAND.test
muldiv(x,.y,.z,.a,.r).BE.TEST.on64#0A..THEN.tmd(x<<
00032,.y<<00032,.z<<00032,.a)#0A..ELSE.tmd(x,.y,.z)
#0A#0AAND.tmd(x,.y,.z).BE#0A{.//LET.a1.#3D.sys(Sys_
muldiv,x,.y,.z)#0A..LET.a1.#3D.muldiv(x,.y,.z)#0A..
LET.r1.#3D.result2#0A..//writef("%16x.%16x.%16x*n",
.x,y,z)#0A..{.//.Check.that.x.#3D.(az+r)y#0A..2//LE
T.t1.#3D.sys(Sys_muldiv,.a1,.z,.y)#0A..2LET.t1.#3D.
muldiv(a1,z,y)#0A..2LET.t2.#3D.(r1+result2)/y#0A//w
ritef("tmd:.r1#3D%16x.result2#3D%16x*n",.r1,.result
2)#0A..2//UNLESS.x.#3D.t1+t2.DO#0A..2//..writef("Ba
d.result.x#3D%16x..t1#3D%16x.t2#3D%16x*n",.x,.t1,.t
2)#0A..2t(t1+t2,.x)#0A..}#0A}#0A

######com/cobench.b#
//.This.is.a.benchmark.program.for.the.coroutine.me
chanism#0A#0A//.Implemented.in.BCPL.by.Martin.Richa
rds.(c).March.2000004#0A#0ASECTION."cobench"#0A#0AG
ET."libhdr"#0A#0AGLOBAL.{#0A..kill_co:.ug..6//.The.
killer.coroutine#0A..source_co#0A..tracing#0A}#0A#0A
LET.start().#3D.VALOF#0A{.LET.argv.#3D.VEC.50#0A..L
ET.k,.n.#3D.10_001,.500#0A..LET.cptr.#3D.0#0A#0A..U
NLESS.rdargs("-k,-n,-t/S",.argv,.50).DO#0A..{.write
f("Bad.arguments.for.cobench*n")#0A..2RESULTIS.0#0A
..}#0A#0A..IF.argv!0.&.string_to_number(argv!0).DO.
k.:#3D.result2.//.-k#0A..IF.argv!1.&.string_to_numb
er(argv!1).DO.n.:#3D.result2.//.-n#0A..tracing.:#3D
.argv!2..34//.-t#0A#0A..writef("*nCobench.sending.%
n.numbers.via.%n.copy.coroutines*n*n",.k,.n)#0A#0A.
.kill_co.:#3D.createco(deleteco,.150)#0A#0A..cptr.:
#3D.createco(sinkfn,.150)#0A#0A..FOR.i.#3D.1.TO.n.D
O#0A..{.LET.co.#3D.createco(copyfn,.150)#0A..2callc
o(co,.cptr)#0A..2cptr.:#3D.co#0A..}#0A#0A..source_c
o.:#3D.createco(sourcefn,.150)#0A..callco(source_co
,.cptr)#0A#0A..IF.tracing.DO.writef("All.coroutines
.created*n*n")#0A#0A..callco(source_co,.k).//.Tell.
sourceco.to.send.k.numbers.#0A#0A..deleteco(kill_co
)#0A#0A..writef("*nCobench.done*n")#0A..RESULTIS.0#0A
}#0A#0AAND.sourcefn(nextco).BE#0A{.LET.k.#3D.cowait
()#0A..LET.channel.#3D.0#0A..LET.out_chan_ptr.#3D.@
channel#0A#0A..callco(nextco,.out_chan_ptr)#0A.#0A.
.//IF.tracing.DO#0A..//..writef("srcefn:.co#3D%n.ou
t_chan_ptr#3D%n.k#3D%n*n*n",#0A..//..8currco,.out_c
han_ptr,.k)#0A#0A..FOR.val.#3D.1.TO.k.DO#0A..{.IF.t
racing.DO.writef("srcefn:.sending.number.%n*n",.val
)#0A..2cowrite(out_chan_ptr,.val)#0A..}#0A..IF.trac
ing.DO.writef("srcefn:.sending.number.0*n")#0A..cow
rite(out_chan_ptr,.0)#0A..//IF.tracing.DO.writef("s
rcefn:.dying*n")#0A..die()#0A}#0A#0AAND.copyfn(next
co).BE#0A{.LET.channel.#3D.0#0A..LET.in_chan_ptr,.o
ut_chan_ptr.#3D.cowait(),.@channel#0A#0A..callco(ne
xtco,.out_chan_ptr)#0A#0A..{.LET.val.#3D.coread(in_
chan_ptr)#0A..2IF.tracing.DO.writef("copyfn:.copyin
g.number.%n*n",.val)#0A..2cowrite(out_chan_ptr,.val
)#0A..2UNLESS.val.BREAK#0A..}.REPEAT#0A#0A..//IF.tr
acing.DO.writef("copyfn:.dying*n")#0A..die()#0A}#0A
#0AAND.sinkfn(in_chan_ptr).BE#0A{.//IF.tracing.DO.w
ritef("sinkfn:..1co#3D%n.in_chan_ptr#3D%n*n",#0A../
/..20currco,.in_chan_ptr)#0A#0A..{.LET.val.#3D.core
ad(in_chan_ptr)#0A..2IF.tracing.DO.writef("sinkfn:.
recving.number.%n*n",.val)#0A..2UNLESS.val.BREAK#0A
..}.REPEAT#0A#0A..//IF.tracing.DO.writef("sinkfn:.d
ying*n")#0A#0A..die()#0A}#0A#0AAND.coread(ptr).#3D.
VALOF#0A{.LET.cptr.#3D.!ptr#0A..TEST.cptr#0A..THEN.
{.!ptr.:#3D.0..7//.Clear.the.channel.word#0A..7RESU
LTIS.resumeco(cptr,.currco)#0A..5}#0A..ELSE.{.!ptr.
:#3D.currco..2//.Set.channel.word.to.this.coroutine
#0A..7RESULTIS.cowait().//.Wait.for.value.from.cowr
ite#0A..5}#0A}#0A#0AAND.cowrite(ptr,.val).BE#0A{.LE
T.cptr.#3D.!ptr#0A..TEST.cptr#0A..THEN.{.!ptr.:#3D.
0#0A..7callco(cptr,.val).//.Send.val.to.coread#0A..
5}#0A..ELSE.{.!ptr.:#3D.currco#0A..8callco(cowait()
,.val)#0A..5}#0A}#0A#0AAND.die().BE.resumeco(kill_c
o,.currco)#0A#0A1

######com/cobounce.b#
SECTION."cobounce"#0A#0AGET."libhdr"#0A#0AGLOBAL.{#0A
..bounce_co.:.ug#0A..sender_co#0A}#0A#0ALET.start()
.BE.#0A{.LET.argv.#3D.VEC.10#0A..LET.count.#3D.1_00
1_001#0A#0A..UNLESS.rdargs("COUNT",.argv,.10).DO#0A
..{.writef("Bad.arguments.for.SEND*n")#0A..2stop(20
)#0A..}#0A#0A..IF.argv!0.&.string_to_number(argv!0)
.DO.count.:#3D.result2#0A#0A..bounce_co.:#3D.create
co(bouncefn,.300)#0A..sender_co.:#3D.createco(sende
rfn,.300)#0A#0A..callco(sender_co,.count)#0A#0A..de
leteco(sender_co)#0A..deleteco(bounce_co)#0A}#0A#0A
AND.bouncefn(val).BE.val.:#3D.cowait(val).REPEAT#0A
#0AAND.senderfn(count).BE#0A{.writef("Calling.the.b
ounce.coroutine.%n.times*n",.count)#0A//abort(1001)
#0A..FOR.i.#3D.1.TO.count.DO.callco(bounce_co,.i)#0A
..writes("done*n")#0A}#0A

######com/compare.b#
//.COMPARE#0A#0A//.This.is.a.text.file.comparison.p
rogram.based.on.one.originally#0A//.written.by.Nick
.Maclaren#0A#0A//.24/3/03.Modified.to.run.under.Cin
tpos.by.Martin.Richards#0A#0A//.This.program.is.des
igned.to.check.two.sequential.character#0A//.files.
for.altered,.inserted.or.deleted.lines#2E#0A#0A//.R
eturn.codes.are.as.follows:#0A//..0070.-.the.files.
are.identical#2E#0A//..0075.-.the.files.are.not.ide
ntical#2E#0A//..00610.-.no.match.could.be.found#2E#0A
//..00615.-.the.parameters.are.invalid.or.insuffici
ent.stack#2E#0A//..00620.-.a.file.cannot.be.opened#2E
#0A#0A//.The.argument.format.is:.file1/a,file2/a,to
/k,opt/k#0A#0A//.file1..2The.first.file.to.compare#0A
//.file2..2The.file.to.compare.with.file1#0A//.to..
5where.to.send.the.output#0A//.opt..4Options.to.con
trol.the.comparison.as.follows:#0A#0A//..0031).Spac
es.are.permitted.anywhere.except.within.an.integer,
#0A//.and.commas.may.be.used.to.separate.parameters
#2E#0A//..0032).Wn#2E..Truncate.all.lines.after.n.(
>.0).data.characters#2E#0A//..0033).Mn#2E..Search.f
or.up.to.n.mismatching.lines#2E#0A//..0034).Rn#2E..
Require.n.(>.0).matching.lines.to.restore.synchroni
sation#0A//..11after.a.mismatch#2E#0A//..3Defaults:
..W132.R2;.M.is.set.to.the#0A//.largest.value.that.
will.fit.in.the.available.store#2E#0A#0A//.The.algo
rithm.will.allow.m1.lines.of.file1.to#0A//.differ.f
rom.m2.lines.of.file2.if.there.are.at.least#0A//.mi
n(R,max(m1,m2)+1).identical.lines.immediately.after
#2E#0A//#0A#0ASECTION."COMPARE"#0A#0AGET."libhdr"#0A
#0AMANIFEST.{.dataposn.#3D.1.}#0A#0AGLOBAL.{#0A..mi
smatch:ug;.restore;.window#0A..bot1;.bot2;.top1;.to
p2;.base1;.base2#0A..limit1;.limit2;.line1;.line2#0A
..eof1;.eof2;.stream1;.stream2#0A..words;.linesper#0A
..current;.equal;.file1;.file2#0A..parm;.buffer;.to
stream#0A}#0A#0ALET.equal(s1,.s2,.l1,.l2).#3D.VALOF
#0A{.LET.i,..3j.#3D.0,.0#0A..LET.ch1,.ch2.#3D.0,.0.
.6//.current.characters#0A..LET.pc1,.pc2.#3D.'*s',.
'*s'..//.previous.characters#0A#0A//writef("equal:.
")#0A//FOR.i.#3D.0.TO.l1-1.DO.wrch(s1%i)#0A//writes
("..:..")#0A//FOR.i.#3D.0.TO.l2-1.DO.wrch(s2%i)#0A/
/newline()#0A#0A..//.Remove.trailing.white.space#0A
..WHILE.l1>0.DO#0A..{.ch1.:#3D.s1%(l1-1)#0A..2UNLES
S.ch1#3D'*s'.|.ch1#3D'*t'.BREAK#0A..2l1.:#3D.l1-1#0A
..}#0A..WHILE.l2>0.DO#0A..{.ch2.:#3D.s2%(l2-1)#0A..
2UNLESS.ch2#3D'*s'.|.ch2#3D'*t'.BREAK#0A..2l2.:#3D.
l2-1#0A..}#0A#0A..{.#0A..2IF.i>#3Dl1.&.j>#3Dl2.RESU
LTIS.TRUE..//.All.characters.have.matched#0A..2IF.i
>#3Dl1.|.j>#3Dl2.RESULTIS.FALSE.//.One.line.exhaust
ed#0A#0A..2//.Both.lines.have.at.least.one.more.cha
racter.to.check#0A..2ch1,.ch2.:#3D.s1%i,.s2%j#0A..2
i,.j.:#3D.i+1,.j+1#0A#0A..2//.Coalesce.consecutive.
spaces#0A..2IF.pc1#3D'*s'.WHILE.ch1#3D'*s'.|.ch1#3D
'*t'.DO.{.ch1.:#3D.s1%i;.i.:#3D.i+1.}#0A..2IF.pc2#3D
'*s'.WHILE.ch2#3D'*s'.|.ch2#3D'*t'.DO.{.ch2.:#3D.s2
%j;.j.:#3D.j+1.}#0A..2pc1,.pc2.:#3D.ch1,.ch2#0A..}.
REPEATWHILE.ch1#3Dch2#0A#0A..RESULTIS.FALSE#0A}#0A#0A
LET.start().BE.{#0A..LET.l,.m,.n,.temp.#3D.?,.?,.0,
.?#0A..LET.parmf.#3D.VEC.50#0A..LET.argv.#3D.VEC.40
#0A..stream1.:#3D.0#0A..stream2.:#3D.0#0A..tostream
.:#3D.0#0A..buffer.:#3D.0#0A#0A..UNLESS.rdargs("fil
e1/a,file2/a,to/k,opt/k",.argv,.40).DO#0A..{.writes
("Invalid.args.for.COMPARE*n")#0A..2stop(15)#0A..}#0A
..parm.:#3D.argv!3.#3D.0.->."",.argv!3#0A..file1,.f
ile2.:#3D.argv!0,.argv!1#0A#0A..IF.argv!2.DO#0A..{.
tostream.:#3D.findoutput(argv!2)#0A..2UNLESS.tostre
am.DO#0A..2{.writef("Can't.open.%S*n",.argv!2)#0A..
4stop(20)#0A..2}#0A#0A..2selectoutput(tostream)#0A.
.}#0A#0A..unpackstring(parm,parmf);.parmf!(parmf!0+
1).:#3D.'#2E'#0A#0A..//.Initialise.everything.to.un
set#2E#0A..mismatch.:#3D.-1#0A..window.:#3D.-1#0A..
restore.:#3D.-1#0A#0A..//.The.parm.field.loop#2E#0A
..WHILE.n.<.parmf!0.DO#0A..{.n.:#3D.n+1#0A..2SWITCH
ON.capitalch(parmf!n).INTO#0A..2{.DEFAULT:..2GOTO.p
armerr#0A#0A..4//.Various.characters.and.parameters
#2E#0A..4CASE.'.':#0A..4CASE.',':..1LOOP#0A#0A..4//
.Integer.parameters#2E#0A..4CASE.'M':..1temp.:#3D.@
mismatch;.GOTO.beta#0A..4CASE.'R':..1temp.:#3D.@res
tore;..GOTO.beta#0A..4CASE.'W':..1temp.:#3D.@window
#0Abeta:..11IF.!temp.>#3D.0.GOTO.parmerr#0A..16n.:#3D
.n+1.REPEATWHILE.parmf!n.#3D.'.'#0A..16m.:#3D.0#0A.
.16UNLESS.'0'.<#3D.parmf!n.<#3D.'9'.GOTO.parmerr#0A
#0A..16{.m.:#3D.10*m+parmf!n-'0'#0A..18n.:#3D.n+1#0A
..16}.REPEATWHILE.'0'.<#3D.parmf!n.<#3D.'9'#0A#0A..
16!temp.:#3D.m;#0A..16n.:#3D.n-1#0A..16LOOP#0A..4}#0A
..2}#0A#0A..2//.Check.values.and.insert.defaults#2E
#0A..2UNLESS.restore.GOTO.parmerr#0A..2IF.mismatch.
<.0.DO.mismatch.:#3D.25#0A..2IF.restore..<.0.DO.res
tore..:#3D.2#0A..2UNLESS.window.GOTO.parmerr#0A..2I
F.window..1<.0.DO.window..1:#3D.132#0A..2words.:#3D
.window/bytesperword+dataposn#0A#0A..2buffer.:#3D.g
etvec((mismatch+restore)*2*(words+1))#0A..2UNLESS.b
uffer.DO#0A..2{.writes("Insufficient.store.for.COMP
ARE*n")#0A..4stop(20)#0A..2}#0A#0A..2//.Set.up.cons
tants.and.start.work#2E#0A..2linesper.:#3D.0#0A#0A.
.2main(buffer)#0A#0Aparmerr:#0A..2writef("Invalid.p
arameters:..%S*n",.parm);#0A..2quit(15)#0A}#0A#0A2A
ND.main(buff).BE#0A{#0A..//.This.controls.the.compa
rison#2E..Its.argument.is.a.vector.for#0A..//.works
pace#2E..The.algorithm.is.to.scan.until.a.mismatch.
is.found#2E#0A..//.Then.to.search.for.identical.lin
es.between.the.files.in.such.a#0A..//.way.as.to.min
imise.firstly.the.maximum.of.the.two.numbers.of#0A.
.//.differing.lines.(before.the.identical.ones).and
.secondly.the#0A..//.difference.between.the.numbers
#2E..In.case.of.a.tie,.file2.will#0A..//.have.more.
lines.differing.than.file1#2E..End.of.file.is.treat
ed.as.a#0A..//.block.of.RESTORE.identical.lines.whi
ch.match.no.actual.lines#2E#0A..//.The.number.of.id
entical.lines.required.to.restore.the.matched#0A../
/.state.is.min(RESTORE,max(number.of.differing.line
s.in.file1,#0A..//.number.of.differing.lines.in.fil
e2)+1)#2E..If.no.match.is.found.by#0A..//.the.time.
the.numbers.of.differing.lines.reaches.MISMATCH,.an
#0A..//.error.exit.is.taken#2E#0A..//#0A..LET.s1,s2
.#3D.".of.file1.and.line.",".of.file2"#0A..LET.t1,t
2.#3D.?,?#0A..LET.errflag.#3D.FALSE#0A..t1.:#3D.mis
match+restore#0A..//.Allocate.space.and.assign.poin
ters#2E#0A..bot1.:#3D.buff;.top1.:#3D.bot1;.line1.:
#3D.0#0A..bot2.:#3D.bot1+t1;.top2.:#3D.bot2;.line2.
:#3D.0#0A..base1.:#3D.bot2+t1;.limit1.:#3D.base1+t1
*words#0A..base2.:#3D.limit1;.limit2.:#3D.base2+t1*
words#0A..eof1.:#3D.FALSE;.eof2.:#3D.FALSE#0A..stre
am1.:#3D.0;.stream2.:#3D.0#0A..current.:#3D.0#0A..p
ushup(1,mismatch+restore);.pushup(2,mismatch+restor
e)#0A#0A..//.The.comparison.loop#2E#0Aalpha:#0A..//
IF.testflags(1).DO.quit(0)#0A..t1.:#3D.check()#0A..
IF.t1.DO.{.pushup(1,t1);.pushup(2,t1);.GOTO.alpha.}
#0A..IF.top1.<#3D.bot1.&.top2.<#3D.bot2.GOTO.beta#0A
..//.A.mismatch.is.found#2E#0A..errflag.:#3D.TRUE#0A
..FOR.n.#3D.1.TO.mismatch.DO#0A..{.t1.:#3D.n<restor
e.->.n+1,.restore#0A..2IF.compare(bot1+n,bot2+n,t1)
.DO#0A..2{.printer(n,n)#0A..4pushup(1,n+t1)#0A..4pu
shup(2,n+t1)#0A..4GOTO.alpha#0A..2}#0A#0A..2//.Try.
shifting.up.and.down#2E#0A..2FOR.m.#3D.n-1.TO.0.BY.
-1.DO#0A..2{.IF.compare(bot1+m,bot2+n,t1).DO#0A..4{
.printer(m,n)#0A..6pushup(1,m+t1)#0A..6pushup(2,n+t
1)#0A..6GOTO.alpha#0A..4}#0A..4IF.compare(bot1+n,bo
t2+m,t1).DO#0A..4{.printer(n,m)#0A..6pushup(1,n+t1)
#0A..6pushup(2,m+t1)#0A..6GOTO.alpha#0A..4}#0A..2}#0A
..}#0A#0A..//.No.match.can.be.found#2E#0A..writef("
*nAfter.line.%N%S%N%S.no.match.could.be.found#2E*n"
,#0A..8line1,s1,line2,s2)#0A..quit(10)#0A#0A..//.Mo
re.or.less.successful.end#2E#0Abeta:#0A..quit(errfl
ag->5,0)#0A}#0A#0AAND.pushup(index,num).BE#0A{#0A..
//.This.maintains.the.buffers#2E..Its.arguments.are
.an.index.to.which#0A..//.file.and.the.number.of.li
nes.to.be.added#2E..For.each.file.there.is#0A..//.a
.circular.buffer.of.records,.each.of.which.contains
.the.length#0A..//.and.the.contents.of.a.line#2E..A
.vector.of.pointers.indexes.the#0A..//.next.records
#2E..BOT.points.to.the.base.of.this.vector,.TOP.poi
nts#0A..//.to.the.current.end.of.file.in.this.vecto
r.(note.that.after.the#0A..//.first.call.to.PUSHUP.
it.has.value.BOT+MISMATCH+RESTORE.until.end#0A..//.
of.file.is.reached;.the.only.global.indication.of.n
o.more.lines#0A..//.is.TOP.<#3D.BOT),.BASE.points.t
o.the.base.of.the.record.buffer.and#0A..//.LIMIT.po
ints.to.just.after.the.end.of.the.record.buffer#2E#0A
..//#0A..LET.t1,t2,t3,bot,top,base,limit,eof.#3D.?,
num,?,?,?,?,?,?#0A..//.Select.the.file.to.manipulat
e#2E#0A..TEST.index.#3D.1#0A..THEN.{.bot.:#3D.bot1#0A
..7top.:#3D.top1#0A..7base.:#3D.base1#0A..7limit.:#3D
.limit1#0A..7eof.:#3D.eof1#0A..5}#0A..ELSE.{.bot.:#3D
.bot2#0A..7top.:#3D.top2#0A..7base.:#3D.base2#0A..7
limit.:#3D.limit2#0A..7eof.:#3D.eof2#0A..5}#0A#0A..
//.Push.up.the.circular.buffer#2E#0A..t1.:#3D.bot+n
um#0A..TEST.t1.<.top#0A..THEN.{.FOR.n.#3D.0.TO.top-
t1-1.DO.bot!n.:#3D.t1!n;.top.:#3D.top-num.}#0A..ELS
E.{.t2.:#3D.top-bot;.top.:#3D.bot.}#0A..t3.:#3D.top
>bot.->.!(top-1),.limit#0A#0A..//.Read.in.more.reco
rds.at.end#2E#0A..FOR.n.#3D.1.TO.num.DO#0A..{.IF.eo
f.THEN.BREAK#0A..2t3.:#3D.(t3+words<limit->t3+words
,base);.!top.:#3D.t3#0A..2t1.:#3D.read(index,t3+dat
aposn)#0A#0A..2//.Deal.with.length.etc#2E#0A..2TEST
.t1.>#3D.0.THEN.{.t3!0.:#3D.t1;.top.:#3D.top+1.}#0A
..15ELSE.eof.:#3D.TRUE.}#0A#0A..2//.Reset.file.vari
ables#2E#0A..2TEST.index.#3D.1#0A..2THEN.{.top1.:#3D
.top;.eof1.:#3D.eof;.line1.:#3D.line1+t2.}#0A..2ELS
E.{.top2.:#3D.top;.eof2.:#3D.eof;.line2.:#3D.line2+
t2.}#0A}#0A#0AAND.compare(chk1,chk2,num).#3D.VALOF#0A
{#0A..//.This.compares.blocks.of.lines#2E..Its.argu
ments.are.pointers.to.the#0A..//.buffer.index.vecto
r#2E..End.of.file.matches.end.of.file.only#2E#0A#0A
..LET.t1,.t2,.t3.#3D.top1-chk1,.top2-chk2,.num#0A..
IF.t1.<.num.|.t2.<.num.DO#0A..{.t3.:#3D.t1#0A..2UNL
ESS.t1.#3D.t2.RESULTIS.FALSE#0A..}#0A..FOR.n.#3D.0.
TO.t3-1.DO#0A..{.t1.:#3D.chk1!n#0A..2t2.:#3D.chk2!n
#0A..2UNLESS.equal(t1+dataposn,t2+dataposn,t1!0,t2!
0).RESULTIS.FALSE#0A..}#0A..RESULTIS.TRUE#0A}#0A#0A
AND.check1().#3D.VALOF#0A{.LET.n.#3D.check1()#0A..w
ritef("check:.#3D>.%n*n",.n)#0A..IF.n#3D0.DO.abort(
1001)#0A..RESULTIS.n#0A}#0A#0AAND.check().#3D.VALOF
#0A{#0A..//.This.checks.the.circular.buffers.to.fin
d.the.number.of.identical#0A..//.lines#2E..End.of.f
ile.always.gives.inequality#2E#0A..LET.t1,.t2,.t3.#3D
.top1-bot1,.top2-bot2,.?#0A..t3.:#3D.t1<t2.->.t1,.t
2#0A..FOR.n.#3D.0.TO.t3-1.DO#0A..{.t1.:#3D.bot1!n#0A
..2t2.:#3D.bot2!n#0A..2UNLESS.equal(t1+dataposn,t2+
dataposn,t1!0,t2!0).RESULTIS.n#0A..}#0A..RESULTIS.t
3#0A}#0A#0AAND.read(index,addr).#3D.VALOF#0A{#0A../
/.This.reads.a.record.from.one.or.other.file#2E..It
s.arguments.are#0A..//.an.index.to.which.file.and.t
he.address.to.which.to.transfer.data#2E#0A..//.It.t
runcates.it.to.the.window.size#2E..It.returns.the.l
ength.or#0A..//.-1.if.end.of.file#2E..It.gives.a.di
agnostic.if.the.files.do.not#0A..//.exist#2E#0A..LE
T.t1.#3D.index#3D1.->.@stream1,.@stream2#0A..//.Set
.up.the.correct.stream,.opening.if.necessary#2E#0A.
.UNLESS.current.#3D.index.DO#0A..{.UNLESS.!t1.DO#0A
..2{.!t1.:#3D.findinput(index#3D1->file1,file2)#0A.
.4UNLESS.!t1.DO#0A..4{.writef("*nFile.%S.cannot.be.
opened*n*n",.index#3D1->file1,file2)#0A..6quit(20)#0A
..4}#0A..2}#0A..2selectinput(!t1)#0A..2current.:#3D
.index#0A..}#0A..//.Read.a.line.and.sort.out.the.le
ngth#2E#0A..t1.:#3D.readrec(addr)#0A..IF.t1.>.windo
w+1.DO.t1.:#3D.window+1#0A..RESULTIS.t1#0A}#0A#0A2A
ND.printer(n1,n2).BE#0A{.//.This.outputs.the.differ
ences#2E.Its.arguments.are.the.number#0A..//.of.dif
fering.lines.in.each.file#2E#0A#0A..IF.n1.>.0.&.n2.
>.0.DO#0A..{.//.Replacement.of.lines#2E#0A..2writef
("%n",.line1+1)#0A..2UNLESS.n1#3D1.DO.writef(",%n",
.line1+n1)#0A..2writef("c%n",.line2+1)#0A..2UNLESS.
n2#3D1.DO.writef(",%n",.line2+n2)#0A..2newline()#0A
..2prnt1('<',.bot1,n1)#0A..2writes("--1*n")#0A..2pr
nt1('>',.bot2,n2)#0A..2RETURN#0A..}#0A#0A..//.Inser
tions.or.deletions#2E#0A..TEST.n1#0A..THEN.{.writef
("%n",.line1+1)#0A..7IF.n1>1.DO.writef(",%n",.line1
+n1)#0A..7writef("d%n",.line2)#0A..7newline()#0A..7
prnt1('<',.bot1,.n1)#0A..5}#0A..ELSE.{.writef("%n",
.line1)#0A..7writef("a%n",.line2+1)#0A..7IF.n2>1.DO
.writef(",%n",.line2+n2)#0A..7newline()#0A..7prnt1(
'>',.bot2,.n2)#0A..5}#0A}#0A#0AAND.prnt1(ch,.bot,.n
).BE#0A{.//.Output.a.line.starting.with.'<'.or.'>'#0A
..//.ch..is.'<'.or.'>'#0A..//.bot.is.a.pointer.to.t
he.buffer.index.vector.and#0A..//.n..1is.the.number
.of.lines.to.be.output#2E#0A#0A..FOR.m.#3D.0.TO.n-1
.DO#0A..{.LET.t.#3D.bot!m#0A..2writef("%c.",.ch)#0A
..2writerec(t+dataposn,.t!0)#0A..}#0A}#0A#0AAND.qui
t(code).BE#0A{#0A..//.This.is.the.exit.routine#2E..
Its.argument.is.the.return.code#2E#0A..//.It.return
s.all.the.free.store.got.for.the.program#2E#0A#0A..
freevec(buffer)#0A..IF.stream1..DO.{.selectinput(st
ream1);.endread().}#0A..IF.stream2..DO.{.selectinpu
t(stream2);.endread().}#0A..IF.tostream.DO.{.select
output(tostream);.endwrite().}#0A..stop(code)#0A}#0A
#0AAND.writerec(buff,.len).BE#0A{.//.Writes.len.cha
racters.from.buff#0A..FOR.j.#3D.0.TO.len.-.1.DO.wrc
h(buff%j)#0A..newline()#0A}#0A#0AAND.readrec(buff).
#3D.VALOF#0A{.//.Reads.one.record.into.buff#2E#0A..
//.Result.is.number.of.characters.read,.or.-1.if.fi
le#0A..//.is.exhausted#2E#0A..LET.n.#3D.0#0A..LET.c
h.#3D.rdch()#0A..WHILE.ch#3D'*c'.DO.ch.:#3D.rdch().
//.Ignore.CR.characters#0A#0A..IF.ch#3Dendstreamch.
RESULTIS.-1..//.EOF.found.as.fisrt.character#0A#0A.
.UNTIL.ch.#3D.'*n'.|.ch.#3D.endstreamch.DO#0A..{.bu
ff%n.:#3D.ch#0A..2n.:#3D.n+1#0A..2ch.:#3D.rdch().RE
PEATWHILE.ch#3D'*c'.//.Ignore.CR.characters#0A..}#0A
#0A..RESULTIS.n..//.Number.of.characters.read.befor
e.*n.or.EOF#0A}#0A

######com/cosim.b#
//.A.Discrete.event.simulation.benchmark.#0A//.Desi
gned.and.implemented.by.Martin.Richards.(c).June.20
00004.#0A#0A//.This.is.a.benchmark.test.for.a.discr
ete.event.simulator.using#0A//.BCPL.style.coroutine
s#2E.It.simulates.a.network.of.n.nodes.which#0A//.e
ach.receive,.queue,.process.and.transmit.messages.t
o.other.nodes#2E#0A//.The.nodes.are.uniformly.space
d.on.a.straight.line.and.the.network#0A//.delay.is.
assumed.to.be.proportional.to.the.linear.distance.b
etween#0A//.the.source.and.the.destination#2E.On.ar
rival,.if.the.receiving.node.is#0A//.busy.the.messa
ge.is.queued,.otherwise.it.is.processed.immediately
#2E#0A//.After.processing.the.message.for.random.ti
me.it.is.sent.to.another#0A//.random.node#2E.If.the
.node.has.a.non.empty.queue.it.dequeues.its.first#0A
//.message.and.starts.to.process.it,.otherwise.it.b
ecomes.suspended#2E#0A//.Initially.every.node.is.pr
ocessing.a.message.and.every.queue.is#0A//.empty#2E
.There.are.n.coroutines.to.simulate.the..progress.o
f.each#0A//.message.and.the.discrete.event.priority
.queue.is.implemented.using#0A//.the.heapsort.heap.
structure#2E.The.simulation.stops.at.a.specified#0A
//.simulated.time#2E.The.result.is.the.number.of.me
ssages.that.have.been#0A//.processed#2E.A.machine.i
ndependent.random.number.generator.is.used#0A//.so.
the.resulting.value.should.be.independent.of.implem
entation#0A//.language.and.machine.being.used#2E#0A
#0A//.Special.comment.lines.have.been.included,.eg:
#0A#0A//..6IF.j<priqn.&.min>priq!(j+1)!0.DO.j.:#3D.
j+1#0A//..4//..1^7499000862..^7463825..10^347700017
8#0A#0A//.These.give.counts.of.how.many.times.the.s
tatements.above#0A//.the.^s.were.executed.when.cosi
m.was.run#2E.These.counts#0A//.were.obtained.using.
the.stats.command#2E#0A#0ASECTION."cosim"#0A#0AGET.
"libhdr"#0A#0AGLOBAL.{#0A..priq:ug..2//.The.vector.
holding.the.priority.queue#0A..priqupb..2//.The.upp
er.bound#0A..priqn..4//.Number.of.items.in.the.prio
rity.queue#0A..wkqv..5//.The.vector.of.work.queues#0A
..count..4//.count.of.messages.processed#0A..nodes.
.4//.The.number.of.nodes#0A..ptmax..4//.The.maximum
.processing.time#0A..stopco..3//.The.stop.coroutine
#0A..cov..6//.Vector.of.message.coroutines#0A..ranv
..5//.A.vector.used.by.the.random.number.generator#0A
..rani;.ranj.//.subscripts.of.ranv#0A..simtime..2//
.Simulated.time#0A..stoptime..1//.Time.to.stop.the.
simulation#0A..tracing#0A#0A//.Functions#0A..rnd#0A
..initrnd#0A..closernd#0A..prq#0A..insertevent#0A..
upheap#0A..downheap#0A..getevent#0A..waitfor#0A..pr
waitq#0A..qitem#0A..dqitem#0A..stopcofn#0A..messcof
n#0A}#0A#0A//.#23#2317.Random.number.generator.#23#23
21#0A#0A//.The.following.random.number.generator.is
.based.on.one.give#0A//.in.Knuth:.The.art.of.progra
mming,.vol.2,.p.26#2E#0ALET.rnd(n).#3D.VALOF#0A{.LE
T.val.#3D.(ranv!rani.+.ranv!ranj).&.#23x_FF1_FF2#0A
//^1000004310#0A..ranv!rani.:#3D.val#0A..rani.:#3D.
(rani.+.1).MOD.55#0A..ranj.:#3D.(ranj.+.1).MOD.55#0A
..RESULTIS.val.MOD.n#0A}#0A#0AAND.initrnd(seed).#3D
.VALOF#0A{.LET.a,.b.#3D.#23x_234_5678+seed,.#23x_53
6_2781#0A//^1#0A..ranv.:#3D.getvec(54)#0A..UNLESS.r
anv.RESULTIS.FALSE#0A..FOR.i.#3D.0.TO.54.DO#0A..{.L
ET.t.#3D.(a+b).&.#23x_FF1_FF2#0A//..^55#0A..2a.:#3D
.b#0A..2b.:#3D.t#0A..2ranv!i.:#3D.t#0A..}#0A..rani,
.ranj.:#3D.55-55,.55-24..//.ie:.0,.31#0A//^1#0A..RE
SULTIS.TRUE#0A//^1#0A}#0A#0AAND.closernd().BE.IF.ra
nv.DO.freevec(ranv)#0A//..14^1..7^1#0A#0A//.#23#231
7.Priority.Queue.functions.#23#2320#0A#0AAND.prq().
BE#0A{.FOR.i.#3D.1.TO.priqn.DO.writef(".%i4",.priq!
i!0)#0A//^0#0A..newline()#0A}#0A#0AAND.insertevent(
event).BE#0A{.priqn.:#3D.priqn+1..6//.Increment.num
ber.of.events#0A//^1000004063#0A..//writef("inserte
vent:.at.time:.%n..co#3D%n*n",.event!0,.event!1)#0A
..upheap(event,.priqn)#0A}#0A#0AAND.upheap(event,.i
).BE#0A{.LET.eventtime.#3D.event!0#0A//^200000772#0A
//writef("upheap:.eventtime#3D%n.i#3D%n*n",.eventti
me,.i)#0A#0A..{.LET.p.#3D.i/2..8//.Parent.of.i#0A//
..^3066000788#0A..2UNLESS.p.&.eventtime.<.priq!p!0.
DO#0A//..11^3064920#0A..2{.priq!i.:#3D.event#0A//..
2^200000772#0A//prq()#0A..4RETURN#0A..2}#0A..2priq!
i.:#3D.priq!p..3//.Demote.the.parent#0A//..^1059011
#0A//prq()#0A..2i.:#3D.p#0A..}.REPEAT#0A}#0A#0AAND.
downheap(event,.i).BE#0A{.LET.j,.min.#3D.2*i,.?.//.
j.is.left.child,.if.present#0A//^8503576#0A//writef
("downheap:.eventtime#3D%n.i#3D%n*n",.event!0,.i)#0A
//prq()#0A..IF.j.>.priqn.DO#0A..{.upheap(event,.i)#0A
//..^1000003714#0A..2RETURN#0A..}#0A..min.:#3D.priq
!j!0#0A//^7499000862#0A..//.Look.at.other.child,.if
.it.exists#0A..IF.j<priqn.&.min>priq!(j+1)!0.DO.j.:
#3D.j+1#0A//..1^7499000862..^7463825..10^3477000178
#0A..//.promote.earlier.child#0A..priq!i.:#3D.priq!
j#0A//^7499000862#0A..i.:#3D.j#0A}.REPEAT#0A#0AAND.
getevent().#3D.VALOF#0A{.LET.event.#3D.priq!1..4//.
Get.the.earliest.event#0A//^1000003714#0A..LET.last
..#3D.priq!priqn..//.Get.the.event.at.the.end.of.th
e.heap#0A//writef("getevent:.priq:")#0A//prq()#0A..
UNLESS.priqn>0.RESULTIS.0.//.No.events.in.the.prior
ity.queue#0A//..13^0#0A..priqn.:#3D.priqn-1..6//.De
crement.the.heap.size#0A//^1000003714#0A..downheap(
last,.1)..5//.Re-insert.last.event#0A..RESULTIS.eve
nt#0A}#0A#0AAND.waitfor(ticks).BE#0A{.//.Make.an.ev
ent.item.into.the.priority.queue#0A..LET.eventtime,
.co.#3D.simtime+ticks,.currco#0A//^1000004063#0A//w
ritef("waitfor:.simtime#3D%n.ticks#3D%n*n",.simtime
,.ticks)#0A..insertevent(@eventtime).//.Insert.into
.the.priority.queue#0A..cowait()..14//.Wait.for.the
.specified.number.of.ticks#0A}#0A#0A//.#23#2320.Que
ueing.functions.#23#2323#0A#0AAND.prwaitq(node).BE#0A
{.LET.p.#3D.wkqv!node#0A//^0#0A//abort(990007)#0A..
IF.-1.<#3D.p.<#3D.0.DO.{.writef("wkq.for.node.%n:.%
n*n",.node,.p);.RETURN.}#0A..writef("wkq.for.node.%
n:",.node)#0A..WHILE.p.DO#0A..{.writef(".%n",.p!1)#0A
..2p.:#3D.!p#0A..}#0A..newline()#0A}#0A#0AAND.qitem
(node).BE#0A//.The.message.has.reached.this.node#0A
//.It.currently.not.busy,.mark.it.as.busy.and.retur
n.to.process#0A//.the.message,.other.append.it.to.t
he.end.of.the.work.queue#0A//.for.this.node#2E#0A{.
//.Make.a.queue.item#0A..LET.link,.co.#3D.0,.currco
#0A//^502305#0A..LET.p.#3D.wkqv!node#0A//writef("qi
tem:.entered*n")#0A//prwaitq(node)#0A..UNLESS.p.DO#0A
..{.//.The.node.was.not.busy#0A..2wkqv!node.:#3D.-1
..//.Mark.node.as.busy#0A//..^251611#0A..2IF.tracin
g.DO#0A..4writef("%i8:.node.%i4:.node.not.busy*n",.
simtime,.node)#0A//..2^0#0A//writef("qitem:.wkqv!%n
#3D%n*n",.node,.wkqv!node)#0A..2//prwaitq(node)#0A/
/abort(990008)#0A..2RETURN#0A//..^251611#0A..}#0A..
//.Append.item.to.the.end.of.this.queue#0A//abort(1
001)#0A..IF.tracing.DO#0A//.^250694#0A..2writef("%i
8:.node.%i4:.busy.so.appending.message.to.end.of.wo
rk.queue*n",#0A..10simtime,.node)#0A//..^0#0A//abor
t(1001)#0A..TEST.p#3D-1#0A//^250694#0A..THEN.wkqv!n
ode.:#3D.@link..3//.Form.a.unit.list#0A//..3^146286
#0A..ELSE.{.WHILE.!p.DO.p.:#3D.!p..//.Find.the.end.
of.the.wkq#0A//..5^104400008..3^61303#0A..7!p.:#3D.
@link..8//.Append.to.end.of.wkq#0A//..5^104400008#0A
..5}#0A..//prwaitq(node)#0A..cowait().//.Wait.to.be
.activated.(by.dqitem)#0A//^250694#0A}#0A#0AAND.dqi
tem(node).BE#0A//.A.message.has.just.been.processed
.by.this.node.and.is.ready.to.process#0A//.the.next
,.if.any#2E#0A{.LET.item.#3D.wkqv!node.//.Current.i
tem.(~#3D0)#0A//^501907#0A//writef("dqitem(%n):.ent
ered,.item#3D%n*n",.node,.item)#0A..UNLESS.item.DO.
abort(991)#0A//..13^0#0A//prwaitq(node)#0A..TEST.it
em#3D-1#0A//^501907#0A..THEN.wkqv!node.:#3D.0..16//
.The.node.is.no.longer.busy#0A//..3^251363#0A..ELSE
.{.LET.next.#3D.item!0#0A//..5^250544#0A..7AND.co..
1#3D.item!1#0A..7wkqv!node.:#3D.next.->.next,.-1.//
.De-queue.the.item#0A//..26^104356^146188#0A//prwai
tq(node)#0A..7callco(co)..18//.Process.the.next.mes
sage#0A//..5^250544#0A..5}#0A}#0A#0A//.#23#2322.Cor
outine.Bodies.#23#2324#0A#0AAND.stopcofn(arg).#3D.V
ALOF#0A{.waitfor(stoptime)#0A//^1#0A..IF.tracing.DO
#0A..2writef("%i8:.Stop.time.reached*n",.simtime)#0A
//..^0#0A..RESULTIS.0#0A//^1#0A}#0A.#0AAND.messcofn
(node).#3D.VALOF#0A{.qitem(node)..1//.Put.the.messa
ge.on.the.work.queue.for.this.node#0A//^500#0A#0A..
{.//.Start.processing.the.first.message#0A..2LET.pr
time..1#3D.rnd(ptmax)..3//.a.random.processing.time
#0A//..^502155#0A..2LET.dest..3#3D.rnd(nodes).+.1./
/.a.random.destination.node#0A..2LET.netdelay.#3D.A
BS(node-dest).//.the.network.delay#0A#0A//writef("p
rtime#3D%i3.dest#3D%i3*n",.prtime,.dest)#0A//abort(
1000001)#0A..2IF.tracing.DO#0A..4writef("%i8:.node.
%i4:.processing.message.until.%n*n",#0A..12simtime,
.node,.simtime+prtime)#0A//..2^0#0A..2waitfor(prtim
e)#0A//..^502155#0A..2count.:#3D.count.+.1.//.One.m
ore.message.processed#0A//..^501907#0A..2IF.tracing
.DO#0A..4writef("%i8:.node.%i4:.message.processed*n
",#0A..12simtime,.node,.dest,.simtime+netdelay)#0A/
/..2^0#0A#0A//prwaitq(node)#0A..2dqitem(node).//.De
-queue.current.item.and.activate.the.next,.if.any#0A
//..^501907#0A//prwaitq(node)#0A..2IF.tracing.DO#0A
..4writef("%i8:.node.%i4:.sending.message.to.node.%
n.to.arrive.at.%n*n",#0A..12simtime,.node,.dest,.si
mtime+netdelay)#0A//..2^0#0A#0A..2waitfor(netdelay)
#0A//..^501907#0A..2node.:#3D.dest..4//.The.message
.has.arrived.at.the.destination.node#0A//..^501805#0A
..2IF.tracing.DO#0A..4writef("%i8:.node.%i4:.messag
e.reached.this.node*n",#0A..12simtime,.node)#0A//..
2^0#0A..2qitem(node)..1//.Queue.the.message.if.nece
ssary#0A//..^500000636#0A..2//.The.node.can.now.pro
cess.the.first.message.on.its.work.queue#0A..}.REPE
AT#0A//..^500000469#0A}#0A//.#23#2323.Main.Program.
#23#2326#0A#0ALET.start().#3D.VALOF#0A{.LET.seed.#3D
.0#0A//^1#0A..LET.argv.#3D.VEC.50#0A//abort(1000002
)#0A#0A..UNLESS.rdargs("-n/n,-s/n,-p/n,-r/n,-t/S",.
argv,.50).DO#0A//..5^1#0A..{.writef("Bad.arguments.
for.cosim*n")#0A//..^0#0A..2RESULTIS.0#0A..}#0A#0A.
.nodes,.stoptime,.ptmax.:#3D.500,.1_001_001,.1001#0A
//^1#0A..IF.argv!0..DO.nodes..2:#3D.!(argv!0).//.-n
/n#0A//..1^1..5^0..24^0#0A..IF.argv!1..DO.stoptime.
:#3D.!(argv!1).//.-s/n#0A//..1^1..5^0..24^0#0A..IF.
argv!2..DO.ptmax..2:#3D.!(argv!2).//.-p/n#0A//..1^1
..5^0..24^0#0A..IF.argv!3..DO.seed..3:#3D.!(argv!3)
.//.-r/n#0A//..1^1..5^0..24^0#0A..tracing.:#3D.argv
!4..41//.-t#0A//^1#0A..writef("*nCosim.entered*n*n"
)#0A..writef("Network.nodes:..5%n*n",.nodes)#0A..wr
itef("Stop.time:..9%n*n",.stoptime)#0A..writef("Max
.processing.time:.%n*n",.ptmax)#0A..writef("Random.
number.seed:..%n*n",.seed)#0A..newline()#0A#0A..UNL
ESS.initrnd(seed).DO#0A..{.writef("Can't.initialise
.the.random.number.generator*n")#0A//..^0#0A..2RESU
LTIS.0#0A..}#0A#0AIF.FALSE.DO#0A..FOR.i.#3D.1.TO.10
0.DO.//.Test.the.random.number.generator#0A..{.writ
ef(".%i4",.rnd(1002))#0A..2IF.i.MOD.10.#3D.0.DO.new
line()#0A..}#0A#0A..stopco.:#3D.0#0A//^1#0A..wkqv,.
priq,.cov.:#3D.getvec(nodes),.getvec(nodes+1),.getv
ec(nodes)#0A..UNLESS.wkqv.&.priq.&.cov.DO..#0A..{.w
ritef("Can't.allocate.space.for.the.node.work.queue
s*n")#0A//..^0#0A..2GOTO.ret#0A..}#0A#0A..FOR.i.#3D
.1.TO.nodes.DO.wkqv!i,.cov!i.:#3D.0,.0#0A//^1..18^5
00#0A..priqn.:#3D.0..//.Number.of.events.in.the.pri
ority.queue#0A//^1#0A..count.:#3D.0..//.Count.of.me
ssage.processed#0A..simtime.:#3D.0.//.Simulated.tim
e#0A#0A..IF.tracing.DO.writef("%i8:.Starting.simula
tion*n",.simtime)#0A//..12^0#0A#0A//writef("rnd(100
2)#3D%n*n",.rnd(1002))#0A..//.Create.and.start.the.
stop.coroutine#0A..stopco.:#3D.createco(stopcofn,.2
00)#0A//^1#0A..IF.stopco.DO.callco(stopco)#0A//..11
^1#0A..//.Create.and.start.the.message.coroutines#0A
..FOR.i.#3D.1.TO.nodes.DO#0A//^1#0A..{.LET.co.#3D.c
reateco(messcofn,.200)#0A//..^500#0A..2IF.co.DO.cal
lco(co,.i)#0A//..9^500#0A..2cov!i.:#3D.co#0A//..^50
0#0A..}#0A#0A..//.Run.the.event.loop#0A#0A..{.LET.e
vent.#3D.getevent()..4//.Get.the.earliest.event#0A/
/..^1000003714#0A..2UNLESS.event.BREAK#0A//..13^0#0A
..2simtime.:#3D.event!0..8//.Set.the.simulated.time
#0A..2//IF.tracing.DO.writef("%i8:.calling.co#3D%n*
n",.simtime,.event!1)#0A..2IF.simtime.>.stoptime.BR
EAK#0A//..22^1#0A..2callco(event!1)#0A//..^10000037
13#0A..}.REPEAT#0A#0A..IF.tracing.DO.writef("*nSimu
lation.stopped*n*n")#0A//^1..10^0#0A..writef("Messa
ges.processed:.%n*n",.count)#0A//^1#0A#0Aret:#0A..F
OR.i.#3D.nodes.TO.1.BY.-1.IF.cov!i.DO.deleteco(cov!
i)#0A//^1..21^500..6^500#0A..IF.cov..2DO.freevec(co
v)#0A//^1..9^1#0A..IF.wkqv..1DO.freevec(wkqv)#0A//^
1..9^1#0A..IF.priq..1DO.freevec(priq)#0A//^1..9^1#0A
..IF.stopco.DO.deleteco(stopco)#0A//^1..9^1#0A..clo
sernd()#0A//^1#0A..RESULTIS.0#0A#0Afail:#0A..writef
("Unable.to.initialise.the.simulator*n")#0A//^0#0A.
.GOTO.ret#0A}#0A#0A//.Total.number.of.Cintcode.inst
ructions.executed:.435,363,350#0A//.Number.of.corou
tine.changes:..0202,510,520#0A

######com/cotest.b#
//.This.tests.the.functionality.of.the.coroutine.#0A
//.functions:.callco,.cowait.and.resumeco#2E#0A#0A/
/.Implemented.by.Martin.Richards.(c).April.2000005#0A
#0ASECTION."cotest"#0A#0AGET."libhdr"#0A#0AGLOBAL.{
.a_co:ug;.b_co;.c_co;.d_co.}#0A#0ALET.start().#3D.V
ALOF#0A{.a_co.:#3D.createco(a_fn,.200)#0A..b_co.:#3D
.createco(b_fn,.200)#0A..c_co.:#3D.createco(c_fn,.2
00)#0A..d_co.:#3D.createco(d_fn,.200)#0A#0A..writef
("*nTest:.root.->.a.->.root*n")#0A..writef("root:.c
alling.callco(a_co,..000100)*n")#0A..writef("root:.
callco(a_co,..000100).#3D>.%n*n",.callco(a_co,.100)
)#0A#0A..writef("*nTest:.root.->.a.->.root,.ie.chec
k:.c:#3Dfn(cowait(c)).REPEAT*n")#0A..writef("root:.
calling.callco(a_co,..000200)*n")#0A..writef("root:
.callco(a_co,..000200).#3D>.%n*n",.callco(a_co,.200
))#0A#0A..writef("*nTest:.root.->.b.->.a.->.b.->.ro
ot*n")#0A..writef("root:.calling.callco(b_co,..0003
00)*n")#0A..writef("root:.callco(a_co,..000300).#3D
>.%n*n",.callco(b_co,.300))#0A#0A..writef("*nTest:.
root.->.b.->.a.->.b.->.root..again*n")#0A..writef("
root:.calling.callco(b_co,..000400)*n")#0A..writef(
"root:.callco(b_co,..000400).#3D>.%n*n",.callco(b_c
o,.400))#0A#0A..writef("*nTest:.root.->.c.->.a.->.r
oot,.ie.check.resumeco.in.c_co*n")#0A..writef("root
:.calling.callco(c_co,..000500)*n")#0A..writef("roo
t:.callco(c_co,..000500).#3D>.%n*n",.callco(c_co,.5
00))#0A#0A..writef("*nTest:.root.->.c.->.root*n")#0A
..writef("root:.calling.callco(c_co,..000600)*n")#0A
..writef("root:.callco(c_co,..000600).#3D>.%n*n",.c
allco(c_co,.600))#0A#0A..writef("*nTest:.root.->.d.
->.d.->.root,.ie.can.resumeco.call.itself*n")#0A..w
ritef("root:.calling.callco(d_co,..000700)*n")#0A..
writef("root:.callco(d_co,..000700).#3D>.%n*n",.cal
lco(d_co,.700))#0A#0A..deleteco(a_co)#0A..deleteco(
b_co)#0A..deleteco(c_co)#0A..deleteco(d_co)#0A#0A..
writef("*nEnd.of.test*n")#0A..RESULTIS.0#0A}#0A#0AA
ND.a_fn(x).#3D.VALOF#0A{.writef("a_co:.entered.with
.value.%n*n",.x)#0A..writef("a_co:.returning.%n*n",
.x+10)#0A..RESULTIS.x+10#0A}#0A#0AAND.b_fn(x).#3D.V
ALOF#0A{.writef("b_co:.entered.with.value.%n*n",.x)
#0A..writef("b_co:.calling.callco(a_co,.2001)*n")#0A
..writef("b_co:.callco(a_co,.2001).#3D>.%n*n",.call
co(a_co,.2001))#0A..writef("b_co:.returning.%n*n",.
x+20)#0A..RESULTIS.x+20#0A}#0A#0AAND.c_fn(x).#3D.VA
LOF#0A{.writef("c_co:.entered.with.value.%n*n",.x)#0A
..writef("c_co:.calling.resumeco(a_co,.3001)*n")#0A
..writef("c_co:.resumeco(a_co,.3001).#3D>.%n*n",.re
sumeco(a_co,3001))#0A..writef("c_co:.returning.%n*n
",.x+30)#0A..RESULTIS.x+30#0A}#0A#0AAND.d_fn(x).#3D
.VALOF#0A{.writef("d_co:.entered.with.value.%n*n",.
x)#0A..writef("d_co:.calling.resumeco(d_co,.4001)*n
")#0A..writef("d_co:.resumeco(d_co,.4001).#3D>.%n*n
",.resumeco(d_co,4001))#0A..writef("d_co:.returning
.%n*n",.x+40)#0A..RESULTIS.x+40#0A}#0A#0A/*.This.pr
ogram.should.generate.the.following.output:#0A#0ATe
st:.root.->.a.->.root#0Aroot:.calling.callco(a_co,.
.000100)#0Aa_co:.entered.with.value.100#0Aa_co:.ret
urning.110000#0Aroot:.callco(a_co,..000100).#3D>.11
0000#0A#0ATest:.root.->.a.->.root,.ie.check:.c:#3Df
n(cowait(c)).REPEAT#0Aroot:.calling.callco(a_co,..0
00200)#0Aa_co:.entered.with.value.200#0Aa_co:.retur
ning.210#0Aroot:.callco(a_co,..000200).#3D>.210#0A#0A
Test:.root.->.b.->.a.->.b.->.root#0Aroot:.calling.c
allco(b_co,..000300)#0Ab_co:.entered.with.value.300
#0Ab_co:.calling.callco(a_co,.2001)#0Aa_co:.entered
with.value.2001#0Aa_co:.returning.2010#0Ab_co:.call
co(a_co,.2001).#3D>.2010#0Ab_co:.returning.320#0Aro
ot:.callco(a_co,..000300).#3D>.320#0A#0ATest:.root.
->.b.->.a.->.b.->.root..again#0Aroot:.calling.callc
o(b_co,..000400)#0Ab_co:.entered.with.value.400#0Ab
_co:.calling.callco(a_co,.2001)#0Aa_co:.entered.wit
h.value.2001#0Aa_co:.returning.2010#0Ab_co:.callco(
a_co,.2001).#3D>.2010#0Ab_co:.returning.420#0Aroot:
.callco(b_co,..000400).#3D>.420#0A#0ATest:.root.->.
c.->.a.->.root,.ie.check.resumeco.in.c_co#0Aroot:.c
alling.callco(c_co,..000500)#0Ac_co:.entered.with.v
alue.500#0Ac_co:.calling.resumeco(a_co,.3001)#0Aa_c
o:.entered.with.value.3001#0Aa_co:.returning.3010#0A
root:.callco(c_co,..000500).#3D>.3010#0A#0ATest:.ro
ot.->.c.->.root#0Aroot:.calling.callco(c_co,..00060
0)#0Ac_co:.entered.with.value.600#0Ac_co:.resumeco(
a_co,.3001).#3D>.600#0Ac_co:.returning.530#0Aroot:.
callco(c_co,..000600).#3D>.530#0A#0ATest:.root.->.d
.->.d.->.root,.ie.can.resumeco.call.itself#0Aroot:.
calling.callco(d_co,..000700)#0Ad_co:.entered.with.
value.700#0Ad_co:.calling.resumeco(d_co,.4001)#0Ad_
co:.resumeco.called.#3D>.d_co#0Ad_co:.resumeco(d_co
,.4001).#3D>.4001#0Ad_co:.returning.740#0Aroot:.cal
lco(c_co,..000700).#3D>.740#0A#0AEnd.of.test#0A*/#0A
#0A1

######com/cvbcpl.b#
//.This.is.a.program.to.replace.$(.and.$).section.b
rackets#0A//.by.{.and.}.section.brackets#2E.It.assu
mes.that.the.source#0A//.program.is.syntactically.c
orrect#2E#0A#0A//.It.is.based.on.bcplfe#2Eb#0A#0A//
.Implemented.by.Martin.Richards.(c).7.July.2010#0A#0A
1/*.Change.history#0A#0A00007/07/10#0AFirst.impleme
ntation#0A#0A*/#0A#0ASECTION."CVBCPL"#0A#0AGET."lib
hdr"#0AGET."bcplfecg"#0A.#0AGLOBAL.{#0A//.Globals.u
sed.in.LEX#0Achbuf:feg#0Adecval//;.getstreams;.#0Ac
harv#0A//hdrs..//.MR.10/7/04#0A#0Aworkvec#0Areadnum
ber;.rdstrch#0Atoken;.wordnode;.ch#0Ardtag//;.perfo
rmget#0Alex;.dsw;.declsyswords;.nlpending#0Alookupw
ord;.rch#0Asourcenamev;.sourcefileno;.sourcefileupb
#0Askiptag;.wrchbuf;.chcount;.lineno#0Anulltag;.rec
_p;.rec_l#0A.#0A//.Globals.used.in.SYN#0Ardblockbod
y;..rdsect#0Arnamelist;.rname#0Ardef;.rcom#0Ardcdef
s#0Aformtree;.synerr;.opname#0Arexplist;.rdseq#0Amk
1;.mk2;.mk3#0Amk4;.mk5;.mk6;.mk7#0Anewvec#0Arnexp;.
rexp;.rbexp#0Atostream#0A}#0A.#0A.#0AMANIFEST.{#0Ac
_backspace.#3D..0008#0Ac_tab..5#3D..0009#0Ac_newlin
e..1#3D.10#0Ac_newpage..1#3D.12#0Ac_return..2#3D.13
#0Ac_escape..2#3D.27#0Ac_space..3#3D.32#0A}#0A#0ALE
T.start().#3D.VALOF#0A{.LET.treesize.#3D.0#0A..AND.
argv.#3D.VEC.50#0A..AND.argform.#3D."FROM/A,TO/K,SI
ZE/K/N"#0A..LET.stdout.#3D.output()#0A..errmax..1:#3D
.10#0A..errcount.:#3D.0#0A..fin_p,.fin_l.:#3D.level
(),.fin#0A#0A..treevec..4:#3D.0#0A..sourcestream.:#3D
.0#0A..tostream..3:#3D.0#0A#0A..sysprint.:#3D.stdou
t#0A..selectoutput(sysprint)#0A.#0A..writef("*nCVBC
PL.(7.Jul.2010)*n")#0A#0A..IF.rdargs(argform,.argv,
.50)#3D0.DO.{.writes("Bad.arguments*n")#0A..36errco
unt.:#3D.1#0A..36GOTO.fin#0A..34}#0A..treesize.:#3D
.200_001#0A..IF.argv!2.DO.treesize.:#3D.!argv!2..17
//.SIZE/K/N#0A..IF.treesize<10_001.DO.treesize.:#3D
.10_001#0A#0A..sourcestream.:#3D.findinput(argv!0).
.16//.FROM/A#0A#0A..IF.sourcestream#3D0.DO.{.writef
("Trouble.with.file.%s*n",.argv!0)#0A..23errcount.:
#3D.1#0A..23GOTO.fin#0A..21}#0A#0A..selectinput(sou
rcestream)#0A.#0A..IF.argv!1.DO..37//.TO/K#0A..{.to
stream.:#3D.findoutput(argv!1)#0A..2UNLESS.tostream
.DO#0A..2{.writef("Trouble.with.code.file.%s*n",.ar
gv!1)#0A..4errcount.:#3D.1#0A..4GOTO.fin#0A..2}#0A.
.}#0A#0A..treevec.:#3D.getvec(treesize)#0A#0A..IF.t
reevec#3D0.DO#0A..{.writes("Insufficient.memory*n")
#0A..2errcount.:#3D.1#0A..2GOTO.fin#0A..}#0A..1#0A.
.IF.tostream.DO.selectoutput(tostream)#0A#0A1..{.LE
T.b.#3D.VEC.64/bytesperword#0A..2chbuf.:#3D.b#0A..2
FOR.i.#3D.0.TO.63.DO.chbuf%i.:#3D.0#0A..2chcount,.l
ineno.:#3D.0,.(sourcefileno<<00020).+.1#0A..2token,
.decval.:#3D.0,.0#0A..2rch()#0A.#0A..2{.//.Start.of
.loop.to.process.each.section#0A..4LET.tree.#3D.?#0A
..4treep.:#3D.treevec.+.treesize#0A#0A..4tree.:#3D.
formtree()#0A..4UNLESS.tree.BREAK#0A#0A..2}.REPEATW
HILE.token#3Ds_dot#0A..}#0A..1#0Afin:#0A..IF.treeve
c..5DO.freevec(treevec)#0A..IF.sourcestream..DO.{.s
electinput(sourcestream);.endread().}#0A..IF.tostre
am..4DO.{.selectoutput(tostream)#0A..22UNLESS.tostr
eam#3Dstdout.DO.endwrite()#0A..20}#0A..UNLESS.syspr
int#3Dstdout.DO.{.selectoutput(sysprint);.endwrite(
).}#0A#0A..selectoutput(stdout)#0A//abort(772)#0A..
RESULTIS.errcount#3D0.->.0,.20#0A}#0A#0A..#0ALET.le
x().BE#0A{.nlpending.:#3D.FALSE#0A.#0A..{.SWITCHON.
ch.INTO#0A.#0A..2{.DEFAULT:#0A..10{.LET.badch.#3D.c
h#0A..12ch.:#3D.'*s'#0A..12synerr("Illegal.characte
r.%x2",.badch)#0A..10}#0A#0A..4CASE.'*n':#0A..13lin
eno.:#3D.lineno.+.1#0A..4CASE.'*p':#0A..13nlpending
.:#3D.TRUE..//.IGNORABLE.CHARACTERS#0A..4CASE.'*c':
#0A..4CASE.'*t':#0A..4CASE.'*s':#0A..13{.wrch(ch);.
rch().}.REPEATWHILE.ch#3D'*s'#0A..13LOOP#0A#0A..4CA
SE.'0':CASE.'1':CASE.'2':CASE.'3':CASE.'4':#0A..4CA
SE.'5':CASE.'6':CASE.'7':CASE.'8':CASE.'9':#0A..12/
/wrch(ch)#0A..12token.:#3D.s_number#0A..12decval.:#3D
.readnumber(10,.100)#0A..12RETURN#0A.#0A..4CASE.'a'
:CASE.'b':CASE.'c':CASE.'d':CASE.'e':#0A..4CASE.'f'
:CASE.'g':CASE.'h':CASE.'i':CASE.'j':#0A..4CASE.'k'
:CASE.'l':CASE.'m':CASE.'n':CASE.'o':#0A..4CASE.'p'
:CASE.'q':CASE.'r':CASE.'s':CASE.'t':#0A..4CASE.'u'
:CASE.'v':CASE.'w':CASE.'x':CASE.'y':#0A..4CASE.'z'
:#0A..4CASE.'A':CASE.'B':CASE.'C':CASE.'D':CASE.'E'
:#0A..4CASE.'F':CASE.'G':CASE.'H':CASE.'I':CASE.'J'
:#0A..4CASE.'K':CASE.'L':CASE.'M':CASE.'N':CASE.'O'
:#0A..4CASE.'P':CASE.'Q':CASE.'R':CASE.'S':CASE.'T'
:#0A..4CASE.'U':CASE.'V':CASE.'W':CASE.'X':CASE.'Y'
:#0A..4CASE.'Z':#0A..12token.:#3D.lookupword(rdtag(
ch))#0A..12writes(charv)#0A..12IF.token#3Ds_get.DO#0A
..12{.lex().//.read.the.string.argument.of.GET#0A..
14LOOP#0A..12}#0A..12RETURN#0A.#0A..4CASE.'$':#0A..
12rch()#0A..12IF.ch#3D'$'.|.ch#3D'<'.|.ch#3D'>'.DO#0A
..12{.LET.k.#3D.ch#0A..14token.:#3D.lookupword(rdta
g('<'))#0A..14writef("$%c",.k)#0A..14FOR.i.#3D.2.TO
.charv%0.DO.wrch(charv%i)#0A..14//.token.#3D.s_true
..11if.the.tag.is.set#0A..14//..4#3D.s_false.or.s_n
ame..otherwise#0A.#0A..14//.$>tag..1marks.the.end.o
f.a.conditional#0A..14//..7skipping.section#0A#0A..
14//.$$tag..complements.the.value.of.a.tag#0A#0A..1
4lex()#0A..14RETURN#0A..12}#0A.#0A..12UNLESS.ch#3D'
('.|.ch#3D')'.DO.synerr("'$'.out.of.context")#0A..1
2token.:#3D.ch#3D'('.->.s_lsect,.s_rsect#0A..12look
upword(rdtag('$'))#0A..12wrch(token#3Ds_lsect.->.'{
',.'}')#0A..12RETURN#0A.#0A..4CASE.'{':.token,.word
node.:#3D.s_lsect,.nulltag;.BREAK#0A..4CASE.'}':.to
ken,.wordnode.:#3D.s_rsect,.nulltag;.BREAK#0A#0A..4
CASE.'#23':#0A..12token.:#3D.s_number#0A..12wrch(ch
)#0A..12rch()#0A..12IF.'0'<#3Dch<#3D'7'.DO#0A..12{.
decval.:#3D.readnumber(.8,.100)#0A..14RETURN#0A..12
}#0A..12IF.ch#3D'b'.|.ch#3D'B'.DO#0A..12{.wrch(ch)#0A
..14rch()#0A..14decval.:#3D.readnumber(.2,.100)#0A.
.14RETURN#0A..12}#0A..12IF.ch#3D'o'.|.ch#3D'O'.DO#0A
..12{.wrch(ch)#0A..14rch()#0A..14decval.:#3D.readnu
mber(.8,.100)#0A..14RETURN#0A..12}#0A..12IF.ch#3D'x
'.|.ch#3D'X'.DO#0A..12{.wrch(ch)#0A..14rch()#0A..14
decval.:#3D.readnumber(16,.100)#0A..14RETURN#0A..12
}#0A..12lex();.LOOP.//.deal.with.#23+.etc#0A..12//t
oken.:#3D.s_mthap#0A..12RETURN#0A.#0A..4CASE.'[':.t
oken.:#3D.s_sbra;..4BREAK#0A..4CASE.']':.token.:#3D
.s_sket;..4BREAK#0A..4CASE.'(':.token.:#3D.s_lparen
;..2BREAK#0A..4CASE.')':.token.:#3D.s_rparen;..2BRE
AK.#0A..4CASE.'?':.token.:#3D.s_query;..3BREAK#0A..
4CASE.'+':.token.:#3D.s_plus;..4BREAK#0A..4CASE.','
:.token.:#3D.s_comma;..3BREAK#0A..4CASE.';':.token.
:#3D.s_semicolon;.BREAK#0A..4CASE.'@':.token.:#3D.s
_lv;..6BREAK#0A..4CASE.'&':.token.:#3D.s_logand;..2
BREAK#0A..4CASE.'#3D':.token.:#3D.s_eq;..6BREAK#0A.
.4CASE.'!':.token.:#3D.s_vecap;..3BREAK#0A..4CASE.'
%':.token.:#3D.s_byteap;..2BREAK#0A..4CASE.'**':tok
en.:#3D.s_mult;..4BREAK#0A..4CASE.'|':.token.:#3D.s
_logor;..3BREAK#0A..4CASE.'#2E':.token.:#3D.s_dot;.
.5BREAK#0A#0A.#0A..4CASE.'/':#0A..12wrch(ch);.rch()
#0A..12IF.ch#3D'\'.DO.{.token.:#3D.s_logand;.BREAK.
}#0A..12IF.ch#3D'/'.DO#0A..12{.{.wrch(ch);.rch().}.
REPEATUNTIL.ch#3D'*n'.|.ch#3Dendstreamch#0A..14LOOP
#0A..12}#0A.#0A..12IF.ch#3D'**'.DO#0A..12{.LET.dept
h.#3D.1#0A#0A..14{.wrch(ch);.rch()#0A..16IF.ch#3D'*
*'.DO#0A..16{.{.wrch(ch);.rch().}.REPEATWHILE.ch#3D
'**'#0A..18IF.ch#3D'/'.DO.{.depth.:#3D.depth-1;.LOO
P.}#0A..16}#0A..16IF.ch#3D'/'.DO#0A..16{.wrch(ch);.
rch()#0A..18IF.ch#3D'**'.DO.{.depth.:#3D.depth+1;.L
OOP.}#0A..16}#0A..16IF.ch#3D'*n'.DO.lineno.:#3D.lin
eno+1#0A..16IF.ch#3Dendstreamch.DO.synerr("Missing.
'**/'")#0A..14}.REPEATUNTIL.depth#3D0#0A#0A..14wrch
(ch);.rch()#0A..14LOOP#0A..12}#0A#0A..12token.:#3D.
s_div#0A..12RETURN#0A.#0A..4CASE.'~':#0A..12wrch(ch
);.rch()#0A..12IF.ch#3D'#3D'.DO.{.token.:#3D.s_ne;.
.3BREAK.}#0A..12token.:#3D.s_not#0A..12RETURN#0A.#0A
..4CASE.'\':#0A..12wrch(ch);.rch()#0A..12IF.ch#3D'/
'.DO.{.token.:#3D.s_logor;..BREAK.}#0A..12IF.ch#3D'
#3D'.DO.{.token.:#3D.s_ne;..3BREAK.}#0A..12token.:#3D
.s_not#0A..12RETURN#0A.#0A..4CASE.'<':.wrch(ch);.rc
h()#0A..12IF.ch#3D'#3D'.DO.{.token.:#3D.s_le;..3BRE
AK.}#0A..12IF.ch#3D'<'.DO.{.token.:#3D.s_lshift;.BR
EAK.}#0A..12token.:#3D.s_ls#0A..12RETURN#0A.#0A..4C
ASE.'>':.wrch(ch);.rch()#0A..12IF.ch#3D'#3D'.DO.{.t
oken.:#3D.s_ge;..3BREAK.}#0A..12IF.ch#3D'>'.DO.{.to
ken.:#3D.s_rshift;.BREAK.}#0A..12token.:#3D.s_gr#0A
..12RETURN#0A.#0A..4CASE.'-':.wrch(ch);.rch()#0A..1
2IF.ch#3D'>'.DO.{.token.:#3D.s_cond;.BREAK..}#0A..1
2token.:#3D.s_minus#0A..12RETURN#0A.#0A..4CASE.':':
.wrch(ch);.rch()#0A..12IF.ch#3D'#3D'.DO.{.token.:#3D
.s_ass;.BREAK..}#0A..12IF.ch#3D':'.DO.{.token.:#3D.
s_of;..BREAK..}..//.Inserted.11/7/01#0A..12token.:#3D
.s_colon#0A..12RETURN#0A.#0A..4CASE.'"':#0A..9{.LET
.len.#3D.0#0A..11wrch(ch);.rch()#0A..11encoding.:#3D
.defaultencoding.//.encoding.for.*#23.escapes#0A#0A
..11UNTIL.ch#3D'"'.DO#0A..11{.LET.code.#3D.rdstrch(
)#0A..13TEST.result2#0A..13THEN.{.//.A..*#23.code.f
ound#2E#0A..20//.Convert.it.to.UTF8.or.GB2312.forma
t#2E#0A..20TEST.encoding#3DGB2312#0A..20THEN.{.//.C
onvert.to.GB2312.sequence#0A..27IF.code>#23x7F.DO#0A
..27{.LET.hi.#3D.code../..000100.+.160#0A..29LET.lo
.#3D.code.MOD.100.+.160#0A..29IF.len>#3D254.DO.syne
rr("Bad.string.constant")#0A..29TEST.bigender#0A..2
9THEN.{.charv%(len+1).:#3D.hi.#0A..36charv%(len+2).
:#3D.lo#0A..34}#0A..29ELSE.{.charv%(len+1).:#3D.lo.
#0A..36charv%(len+2).:#3D.hi#0A..34}#0A..29len.:#3D
.len.+.2#0A..29LOOP#0A..27}#0A..27IF.len>#3D255.DO.
synerr("Bad.string.constant")#0A..27charv%(len+1).:
#3D.code.//.Ordinary.ASCII.char#0A..27len.:#3D.len.
+.1#0A..27LOOP#0A..25}#0A..20ELSE.{.//.Convert.to.U
TF8.sequence#0A..27IF.code<#3D#23x7F.DO#0A..27{.IF.
len>#3D255.DO.synerr("Bad.string.constant")#0A..29c
harv%(len+1).:#3D.code..1//.0xx5#0A..29len.:#3D.len
.+.1#0A..29LOOP#0A..27}#0A..27IF.code<#3D#23x7FF.DO
#0A..27{.IF.len>#3D254.DO.synerr("Bad.string.consta
nt")#0A..29charv%(len+1).:#3D.#23b1100000_002+(code
>>0006)..//.110000xx3#0A..29charv%(len+2).:#3D.#23x
80+(.code..2&#23x3F)..//.10xx4#0A..29len.:#3D.len.+
.2#0A..29LOOP#0A..27}#0A..27IF.code<#3D#23xFF2.DO#0A
..27{.IF.len>#3D253.DO.synerr("Bad.string.constant"
)#0A..29charv%(len+1).:#3D.#23b110010_002+(code>>00
012).//.110010xx2#0A..29charv%(len+2).:#3D.#23x80+(
(code>>0006)&#23x3F)..//.10xx4#0A..29charv%(len+3).
:#3D.#23x80+(.code..2&#23x3F)..//.10xx4#0A..29len.:
#3D.len.+.3#0A..29LOOP#0A..27}#0A..27IF.code<#3D#23
x1F_FF2.DO#0A..27{.IF.len>#3D252.DO.synerr("Bad.str
ing.constant")#0A..29charv%(len+1).:#3D.#23b112_002
+(code>>00018).//.110020xx1#0A..29charv%(len+2).:#3D
.#23x80+((code>>00012)&#23x3F).//.10xx4#0A..29charv
%(len+3).:#3D.#23x80+((code>>.6)&#23x3F).//.10xx4#0A
..29charv%(len+4).:#3D.#23x80+(.code..3&#23x3F).//.
10xx4#0A..29len.:#3D.len.+.4#0A..29LOOP#0A..27}#0A.
.27IF.code<#3D#23x3FF_FF2.DO#0A..27{.IF.len>#3D251.
DO.synerr("Bad.string.constant")#0A..29charv%(len+1
).:#3D.#23b112_1001+(code>>00024).//.110030xx#0A..2
9charv%(len+2).:#3D.#23x80+((code>>00018)&#23x3F)./
/.10xx4#0A..29charv%(len+3).:#3D.#23x80+((code>>000
12)&#23x3F).//.10xx4#0A..29charv%(len+4).:#3D.#23x8
0+((code>>.6)&#23x3F).//.10xx4#0A..29charv%(len+5).
:#3D.#23x80+(.code..3&#23x3F).//.10xx4#0A..29len.:#3D
.len.+.5#0A..29LOOP#0A..27}#0A..27IF.code<#3D#23x7F
F1_FF2.DO#0A..27{.IF.len>#3D250.DO.synerr("Bad.stri
ng.constant")#0A..29charv%(len+1).:#3D.#23b112_1100
000+(code>>00030).//.110040x#0A..29charv%(len+2).:#3D
.#23x80+((code>>00024)&#23x3F).//.10xx4#0A..29charv
%(len+3).:#3D.#23x80+((code>>00018)&#23x3F).//.10xx
4#0A..29charv%(len+4).:#3D.#23x80+((code>>00012)&#23
x3F).//.10xx4#0A..29charv%(len+5).:#3D.#23x80+((cod
e>>.6)&#23x3F).//.10xx4#0A..29charv%(len+6).:#3D.#23
x80+(.code..3&#23x3F).//.10xx4#0A..29len.:#3D.len.+
.6#0A..29LOOP#0A..27}#0A..27synerr("Bad.Unicode.cha
racter")#0A..25}#0A..18}#0A..13ELSE.{.//.Not.a.Unic
ode.character#0A..20IF.len#3D255.DO.synerr("Bad.str
ing.constant")#0A..20len.:#3D.len.+.1#0A..20charv%l
en.:#3D.code#0A..18}#0A..11}#0A..11charv%0.:#3D.len
#0A..11wordnode.:#3D.newvec(len/bytesperword+2)#0A.
.11h1!wordnode.:#3D.s_string#0A..11FOR.i.#3D.0.TO.l
en.DO.(@h2!wordnode)%i.:#3D.charv%i#0A..11token.:#3D
.s_string#0A..11BREAK#0A..8}#0A.#0A..4CASE.'*'':#0A
..12wrch(ch);.rch()#0A..12encoding.:#3D.defaultenco
ding#0A..12decval.:#3D.rdstrch()#0A..12token.:#3D.s
_number#0A..12UNLESS.ch#3D'*''.DO.synerr("Bad.chara
cter.constant")#0A..12BREAK#0A.#0A.#0A..4CASE.endst
reamch:#0A..12token.:#3D.s_eof#0A..12RETURN#0A..2}#0A
..}.REPEAT#0A.#0A..wrch(ch);.rch()#0A}#0A.#0ALET.lo
okupword(word).#3D.VALOF#0A{.LET.len,.i.#3D.word%0,
.0#0A..LET.hashval.#3D.19609.//.This.and.31397.are.
primes#2E#0A..FOR.j.#3D.0.TO.len.DO.hashval.:#3D.(h
ashval.NEQV.word%j).*.31397#0A..hashval.:#3D.(hashv
al>>0001).REM.nametablesize#0A#0A..wordnode.:#3D.na
metable!hashval#0A.#0A..UNTIL.wordnode#3D0.|.i>len.
TEST.(@h3!wordnode)%i#3Dword%i#0A..25THEN.i.:#3D.i+
1#0A..25ELSE.wordnode,.i.:#3D.h2!wordnode,.0#0A.#0A
..UNLESS.wordnode.DO#0A..{.wordnode.:#3D.newvec(len
/bytesperword+2)#0A..2h1!wordnode,.h2!wordnode.:#3D
.s_name,.nametable!hashval#0A..2FOR.i.#3D.0.TO.len.
DO.(@h3!wordnode)%i.:#3D.word%i#0A..2nametable!hash
val.:#3D.wordnode#0A..}#0A.#0A..RESULTIS.h1!wordnod
e#0A}#0A.#0AAND.dsw(word,.sym).BE.{.lookupword(word
);.h1!wordnode.:#3D.sym..}#0A.#0AAND.declsyswords()
.BE#0A{.dsw("AND",.s_and)#0A..dsw("ABS",.s_abs)#0A.
.dsw("BE",.s_be)#0A..dsw("BREAK",.s_break)#0A..dsw(
"BY",.s_by)#0A..dsw("CASE",.s_case)#0A..dsw("DO",.s
_do)#0A..dsw("DEFAULT",.s_default)#0A..dsw("EQ",.s_
eq)#0A..dsw("EQV",.s_eqv)#0A..dsw("ELSE",.s_else)#0A
..dsw("ENDCASE",.s_endcase)#0A..dsw("FALSE",.s_fals
e)#0A..dsw("FOR",.s_for)#0A..dsw("FINISH",.s_finish
)#0A..dsw("GOTO",.s_goto)#0A..dsw("GE",.s_ge)#0A..d
sw("GR",.s_gr)#0A..dsw("GLOBAL",.s_global)#0A..dsw(
"GET",.s_get)#0A..dsw("IF",.s_if)#0A..dsw("INTO",.s
_into)#0A..dsw("LET",.s_let)#0A..dsw("LV",.s_lv)#0A
..dsw("LE",.s_le)#0A..dsw("LS",.s_ls)#0A..dsw("LOGO
R",.s_logor)#0A..dsw("LOGAND",.s_logand)#0A..dsw("L
OOP",.s_loop)#0A..dsw("LSHIFT",.s_lshift)#0A..dsw("
MANIFEST",.s_manifest)#0A..dsw("MOD",.s_rem)#0A..ds
w("NE",.s_ne)#0A..dsw("NEEDS",.s_needs)#0A..dsw("NE
QV",.s_neqv)#0A..dsw("NOT",.s_not)#0A..dsw("OF",.s_
of)..17//.Inserted.11/7/01#0A..dsw("OR",.s_else)#0A
..dsw("RESULTIS",.s_resultis)#0A..dsw("RETURN",.s_r
eturn)#0A..dsw("REM",.s_rem)#0A..dsw("RSHIFT",.s_rs
hift)#0A..dsw("RV",.s_rv)#0A..dsw("REPEAT",.s_repea
t)#0A..dsw("REPEATWHILE",.s_repeatwhile)#0A..dsw("R
EPEATUNTIL",.s_repeatuntil)#0A..dsw("SECTION",.s_se
ction)#0A..dsw("SKIP",.s_skip)..13//.Added.22/6/05#0A
..dsw("SLCT",.s_slct)..13//.Inserted.11/7/01#0A..ds
w("STATIC",.s_static)#0A..dsw("SWITCHON",.s_switcho
n)#0A..dsw("TO",.s_to)#0A..dsw("TEST",.s_test)#0A..
dsw("TRUE",.s_true)#0A..dsw("THEN",.s_do)#0A..dsw("
TABLE",.s_table)#0A..dsw("UNLESS",.s_unless)#0A..ds
w("UNTIL",.s_until)#0A..dsw("VEC",.s_vec)#0A..dsw("
VALOF",.s_valof)#0A..dsw("WHILE",.s_while)#0A..dsw(
"XOR",.s_neqv)#0A..dsw("$",.0)#0A.#0A..nulltag.:#3D
.wordnode#0A}.#0A.#0ALET.rch().BE#0A{.ch.:#3D.rdch(
)#0A..chcount.:#3D.chcount.+.1#0A..chbuf%(chcount&6
3).:#3D.ch#0A}#0A.#0AAND.wrchbuf().BE#0A{.writes("*
n#2E#2E1")#0A..FOR.p.#3D.chcount-63.TO.chcount.DO#0A
..{.LET.k.#3D.chbuf%(p&63)#0A..2IF.0<k<255.DO.wrch(
k)#0A..}#0A..newline()#0A}#0A.#0A.#0AAND.rdtag(ch1)
.#3D.VALOF#0A{.LET.len.#3D.1#0A..//IF.eqcases.&.'a'
<#3Dch1<#3D'z'.DO.ch1.:#3D.ch1.+.'A'.-.'a'#0A..char
v%1.:#3D.ch1#0A.#0A..{.rch()#0A..2UNLESS.'a'<#3Dch<
#3D'z'.|.'A'<#3Dch<#3D'Z'.|#0A..9'0'<#3Dch<#3D'9'.|
.ch#3D'#2E'.|.ch#3D'_'.BREAK#0A..2//IF.eqcases.&.'a
'<#3Dch<#3D'z'.DO.ch.:#3D.ch.+.'A'.-.'a'#0A..2len.:
#3D.len+1#0A..2charv%len.:#3D.ch#0A..}.REPEAT#0A.#0A
..charv%0.:#3D.len#0A..RESULTIS.charv#0A}#0A#0AAND.
catstr(s1,.s2).#3D.VALOF#0A//.Concatenate.strings.s
1.and.s2.leaving.the.result.in.s1#2E#0A//.s1.is.ass
umed.to.be.able.to.hold.a.string.of.length.255#2E#0A
//.The.resulting.string.is.truncated.to.length.255,
.if.necessary#2E.#0A{.LET.len.#3D.s1%0#0A..LET.n.#3D
.len#0A..FOR.i.#3D.1.TO.s2%0.DO#0A..{.n.:#3D.n+1#0A
..2IF.n>255.BREAK#0A..2s1%n.:#3D.s2%i#0A..}#0A..s1%
0.:#3D.n#0A}.#0A.#0AAND.readnumber(radix,.digs).#3D
.VALOF#0A//.Read.a.binary,.octal,.decimal.or.hexade
cimal.unsigned.number#0A//.with.between.1.and.digs.
digits#2E.Underlines.are.allowed#2E#0A//.This.funct
ion.is.used.for.numerical.constants.and.numerical#0A
//.escapes.in.string.and.character.constants#2E#0A{
.LET.i,.res.#3D.0,.0#0A.#0A..{.UNLESS.ch#3D'_'.DO./
/.ignore.underlines#0A..2{.LET.d.#3D.value(ch)#0A..
4IF.d>#3Dradix.BREAK#0A..4i.:#3D.i+1..5//.Increment
.count.of.digits#0A..4res.:#3D.radix*res.+.d#0A..2}
#0A..2wrch(ch)#0A..2rch()#0A..}.REPEATWHILE.i<digs#0A
#0A..UNLESS.i.DO.synerr("Bad.number")#0A..RESULTIS.
res#0A}#0A.#0A.#0AAND.value(ch).#3D.'0'<#3Dch<#3D'9
'.->.ch-'0',#0A..14'A'<#3Dch<#3D'F'.->.ch-'A'+10,#0A
..14'a'<#3Dch<#3D'f'.->.ch-'a'+10,#0A..014100#0A.#0A
AND.rdstrch().#3D.VALOF#0A{.//.Return.the.integer.c
ode.for.the.next.string.character#0A..//.Set.result
2#3DTRUE.if.*#23.character.code.was.found,.otherwis
e.FALSE#0A..LET.k.#3D.ch#0A#0A..IF.k#3D'*n'.|.k#3D'
*p'.DO#0A..{.lineno.:#3D.lineno+1#0A..2synerr("Unes
caped.newline.character")#0A..}#0A.#0A..IF.k#3D'**'
.DO#0A..{.wrch(ch)#0A..2rch()#0A..2k.:#3D.ch#0A..2I
F.'a'<#3Dk<#3D'z'.DO.k.:#3D.k.+.'A'.-.'a'#0A..2SWIT
CHON.k.INTO#0A..2{.CASE.'*n':#0A..4CASE.'*c':#0A..4
CASE.'*p':#0A..4CASE.'*s':#0A..4CASE.'*t':.WHILE.ch
#3D'*n'.|.ch#3D'*c'.|.ch#3D'*p'.|.ch#3D'*s'.|.ch#3D
'*t'.DO#0A..15{.IF.ch#3D'*n'.DO.lineno.:#3D.lineno+
1#0A..17wrch(ch);.rch()#0A..15}#0A..15IF.ch#3D'**'.
DO.{.wrch(ch);.rch();.LOOP..}#0A#0A..4DEFAULT:..1sy
nerr("Bad.string.or.character.constant,.ch#3D%n",.c
h)#0A..7#0A..4CASE.'**':#0A..4CASE.'*'':#0A..4CASE.
'"':..18ENDCASE#0A..7#0A..4CASE.'T':..k.:#3D.c_tab;
..5ENDCASE#0A..4CASE.'S':..k.:#3D.c_space;..3ENDCAS
E#0A..4CASE.'N':..k.:#3D.c_newline;..1ENDCASE#0A..4
CASE.'E':..k.:#3D.c_escape;..2ENDCASE#0A..4CASE.'B'
:..k.:#3D.c_backspace;.ENDCASE#0A..4CASE.'P':..k.:#3D
.c_newpage;..1ENDCASE#0A..4CASE.'C':..k.:#3D.c_retu
rn;..2ENDCASE#0A..7#0A..4CASE.'X':..//.*xhh..--.A.c
haracter.escape.in.hexadecimal#0A..15wrch();.rch()#0A
..15k.:#3D.readnumber(16,2)#0A..15result2.:#3D.FALS
E#0A..15RESULTIS.k#0A#0A..4CASE.'#23':..//.*#23u..1
set.UTF8.mode#0A..15//.*#23g..1set.GB2312.mode#0A..
15//.In.UTF8.mode#0A..15//..3*#23hh2.or.*#23#23hh6.
.--.a.Unicode.character#0A..15//.In.GB2312#0A..15//
..3*#23dd2..15--.A.GB2312.code#0A..13{.LET.digs.#3D
.4#0A..15wrch(ch);.rch()#0A..15IF.ch#3D'u'.|.ch#3D'
U'.DO.{.encoding.:#3D.UTF8;..1wrch(ch);.rch();.LOOP
.}#0A..15IF.ch#3D'g'.|.ch#3D'G'.DO.{.encoding.:#3D.
GB2312;.wrch(ch);.rch();.LOOP.}#0A..15TEST.encoding
#3DGB2312#0A..15THEN.{.#0A..22k.:#3D.readnumber(10,
.digs)#0A//sawritef("rdstrch:.GB2312:.%i4*n",.k)#0A
..20}#0A..15ELSE.{.IF.ch#3D'#23'.DO.{.wrch(ch);.rch
();.digs.:#3D.8.}#0A..22k.:#3D.readnumber(16,.digs)
#0A//sawritef("rdstrch:.Unicode:.%x4*n",.k)#0A..20}
#0A..15result2.:#3D.TRUE#0A..15RESULTIS.k#0A..13}#0A
#0A..4CASE.'0':CASE.'1':CASE.'2':CASE.'3':CASE.'4':
#0A..4CASE.'5':CASE.'6':CASE.'7':#0A..15//.*oo1.--.
A.character.escape.in.octal.#0A..15k.:#3D.readnumbe
r(8,3)#0A..15IF.k>255.DO.#0A..21synerr("Bad.string.
or.character.constant")#0A..15result2.:#3D.FALSE#0A
..15RESULTIS.k#0A..2}#0A..}#0A..1#0A..wrch(ch);.rch
()#0A..result2.:#3D.FALSE#0A..RESULTIS.k#0A}.REPEAT
#0A#0ALET.newvec(n).#3D.VALOF#0A{.treep.:#3D.treep.
-.n.-.1;#0A..IF.treep<#3Dtreevec.DO#0A..{.errmax.:#3D
.0..//.Make.it.fatal#0A..2synerr("More.workspace.ne
eded")#0A..}#0A..RESULTIS.treep#0A}#0A.#0AAND.mk1(x
).#3D.VALOF#0A{.LET.p.#3D.newvec(0)#0A..p!0.:#3D.x#0A
..RESULTIS.p#0A}#0A.#0AAND.mk2(x,.y).#3D.VALOF#0A{.
LET.p.#3D.newvec(1)#0A..p!0,.p!1.:#3D.x,.y#0A..RESU
LTIS.p#0A}#0A.#0AAND.mk3(x,.y,.z).#3D.VALOF#0A{.LET
.p.#3D.newvec(2)#0A..p!0,.p!1,.p!2.:#3D.x,.y,.z#0A.
.RESULTIS.p#0A}#0A.#0AAND.mk4(x,.y,.z,.t).#3D.VALOF
#0A{.LET.p.#3D.newvec(3)#0A..p!0,.p!1,.p!2,.p!3.:#3D
.x,.y,.z,.t#0A..RESULTIS.p#0A}#0A.#0AAND.mk5(x,.y,.
z,.t,.u).#3D.VALOF#0A{.LET.p.#3D.newvec(4)#0A..p!0,
.p!1,.p!2,.p!3,.p!4.:#3D.x,.y,.z,.t,.u#0A..RESULTIS
.p#0A}#0A.#0AAND.mk6(x,.y,.z,.t,.u,.v).#3D.VALOF#0A
{.LET.p.#3D.newvec(5)#0A..p!0,.p!1,.p!2,.p!3,.p!4,.
p!5.:#3D.x,.y,.z,.t,.u,.v#0A..RESULTIS.p#0A}#0A.#0A
AND.mk7(x,.y,.z,.t,.u,.v,.w).#3D.VALOF#0A{.LET.p.#3D
.newvec(6)#0A..p!0,.p!1,.p!2,.p!3,.p!4,.p!5,.p!6.:#3D
.x,.y,.z,.t,.u,.v,.w#0A..RESULTIS.p#0A}#0A.#0AAND.f
ormtree().#3D..VALOF#0A{.LET.res.#3D.0#0A#0A..namet
ablesize.:#3D.541#0A#0A..charv..4:#3D.newvec(256/by
tesperword)..3#0A..nametable..:#3D.newvec(nametable
size).#0A..FOR.i.#3D.0.TO.nametablesize.DO.nametabl
e!i.:#3D.0#0A..declsyswords()#0A.#0A..rec_p,.rec_l.
:#3D.level(),.rec#0A.#0A..token,.decval.:#3D.0,.0#0A
#0A..{.lex()#0Arec:#0A..2IF.token#3Ds_eof.BREAK#0A#0A
..2IF.token#3Ds_lsect.DO.rdsect()#0A..}.REPEAT#0A#0A
..RESULTIS.res#0A}#0A.#0AAND.synerr(mess,.a).BE#0A{
.LET.fno.#3D.lineno>>00020#0A..LET.ln.#3D.lineno.&.
#23xFF3#0A#0A..errcount.:#3D.errcount.+.1#0A..write
f("*nError.near.")#0A..writef("[%n]:..",.ln)#0A..wr
itef(mess,.a)#0A..wrchbuf()#0A..IF.errcount.>.errma
x.DO#0A..{.writes("*nConversion.aborted*n")#0A..2lo
ngjump(fin_p,.fin_l)#0A..}#0A..nlpending.:#3D.FALSE
#0A.#0A..UNTIL.token#3Ds_lsect.|.token#3Ds_rsect.|#0A
..6token#3Ds_let.|.token#3Ds_and.|#0A..6token#3Ds_d
ot.|.token#3Ds_eof.|.nlpending.DO.lex()#0A#0A..long
jump(rec_p,.rec_l)#0A}#0A.#0A.#0AAND.rdsect().BE#0A
//.Called.when.token#3Ds_lsect#0A{.LET.tag,.res.#3D
.wordnode,.0#0A#0A..{.lex()#0A#0A..2WHILE.token#3Ds
_lsect.DO.rdsect()#0A#0A..2IF.token#3Ds_rsect.DO#0A
..2{.TEST.tag#3Dwordnode#0A..4THEN.{.//.Close.secti
on.tag.matches.openning.tag#0A..11lex()#0A..11RETUR
N#0A..9}#0A..4ELSE.{.wrch('}').//.Insert.a.closing.
section.bracket#0A..11LOOP#0A..9}#0A..2}#0A..2IF.to
ken#3Ds_eof.DO#0A..2{.wrch('}')#0A..4RETURN#0A..2}#0A
..}.REPEAT#0A}#0A#0A

######com/dat.b#
//.(C).Copyright.1978.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0A//.Modified.27/1/2011#0A#0ASECTION."DAT"#0A#0AGE
T."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.LET.tostr
eam,.precise.#3D.0,.FALSE#0A..LET.days,.msecs.#3D.0
,.0#0A..LET.argv.#3D.VEC.50#0A..LET.v.#3D.VEC.14#0A
#0A..UNLESS.rdargs("TO/K,MSECS/S",.argv,.50).DO#0A.
.{.writef("Bad.arguments.for.DAT*n")#0A..2RESULTIS.
20#0A..}#0A#0A..IF.argv!0.DO..22//.TO/K#0A..{.tostr
eam.:#3D.findoutput(argv!0)#0A..2UNLESS.tostream.DO
#0A..2{.writef("**4Can*'t.open.%s*n",.argv!0)#0A..4
RESULTIS.20#0A..2}#0A..2selectoutput(tostream)#0A..
}#0A#0A..precise.:#3D.argv!1..14//.MSECS/S#0A#0A..d
atstamp(@days)#0A..dat_to_strings(@days,.v)#0A..wri
tef(".%s.%s.%s",.v+10,.v,.v+5)#0A..IF.precise.DO.wr
itef("#2E%3z",.msecs.MOD.1001)#0A..newline()#0A..IF
.tostream.DO.endstream(tostream)#0A..RESULTIS.0#0A}
#0A

######com/date.b#
//.(C).Copyright.1979.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0A//.Modified.27/1/2011#0A#0ASECTION."DATE"#0A#0AG
ET."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.LET.tost
ream.#3D.0#0A..LET.days,.msecs.#3D.0,.0#0A..LET.arg
v.#3D.VEC.50#0A..LET.v.#3D.VEC.14#0A#0A..UNLESS.rda
rgs("TO/K",.argv,.50).DO#0A..{.writef("Bad.argument
s.for.DATE*n")#0A..2RESULTIS.20#0A..}#0A#0A..IF.arg
v!0.DO..22//.TO/K#0A..{.tostream.:#3D.findoutput(ar
gv!0)#0A..2UNLESS.tostream.DO#0A..2{.writef("**4Can
*'t.open.%s*n",.argv!0)#0A..4RESULTIS.20#0A..2}#0A.
.2selectoutput(tostream)#0A..}#0A#0A..datstamp(@day
s)#0A..dat_to_strings(@days,.v)#0A..writef(".%s.%s*
n",.v+10,.v)#0A..IF.tostream.DO.endstream(tostream)
#0A..RESULTIS.0#0A}#0A

######com/dcounts.b#
/*#0AThis.program.outputs.the.non.zero.entries.of.t
he.debugging.count.table#2E#0AThe.table.normally.ha
s.an.upperbound.of.511.and.is.allocated.and.cleared
#0Awhen.the.system.starts.up#2E.Counts.can.be.incre
mented.by.incdcount(i).defined#0Ain.cintsys#2Ec.or.
cintpos#2Ec,.or.by.the.BCPL.call.sys(Sys_incdcount)
#2E#0A#0AImplemented.by.Martin.Richards.(c).March.2
012#0A*/#0A#0ASECTION."dcounts"#0A#0AGET."libhdr"#0A
#0ALET.start().#3D.VALOF#0A{.LET.v.#3D.rtn_dcountv!
rootnode#0A..LET.layout.#3D.0#0A..writef("*nDump.of
.non-zero.Debug.Counts*n")#0A#0A..FOR.i.#3D.0.TO.v!
0.DO#0A..{.LET.val.#3D.v!i#0A..2IF.val.DO#0A..2{.IF
.layout.MOD.5.#3D.0.DO.newline()#0A..4TEST.-1005<va
l<1005#0A..4THEN.writef(".%i5:%10i",.i,.val)#0A..4E
LSE.writef(".%i5:..%8x",.i,.val)#0A..4layout.:#3D.l
ayout+1#0A..2}#0A..}#0A..newline()#0A}#0A

######com/delete.b#
//.(C).Copyright.1979.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0ASECTION."DELETE"#0A#0AGET."libhdr"#0A#0ALET.star
t().#3D.VALOF#0A{.LET.argv.#3D.VEC.80#0A#0A..TEST.r
dargs(",,8-f/S",.argv,.80)#3D0#0A..THEN.{.writes("B
ad.args*N")#0A..7RESULTIS.20#0A..5}#0A..ELSE.FOR.i.
#3D.0.TO.9.DO#0A..5{.IF.argv!i#3D0.BREAK#0A..7IF.de
letefile(argv!i)#3D0.UNLESS.argv!10.DO#0A..7{.write
f("Can't.delete.%s*n",.argv!i)#0A..9RESULTIS.5#0A..
7}#0A..5}#0A..RESULTIS.0#0A}#0A

######com/detab.b#
SECTION."DETAB"#0D#0A#0D#0AGET."libhdr"#0D#0A#0D#0A
GLOBAL#0D#0A{#0D#0Ainputstream:200#0D#0Aoutputstrea
m:201#0D#0Atabsep:202#0D#0A}#0D#0A#0D#0ALET.start()
.#3D.VALOF#0D#0A{.LET.argv.#3D.VEC.50#0D#0A..LET.rc
.#3D.0#0D#0A..LET.ch.#3D.0#0D#0A..LET.oldoutput.#3D
.output()#0D#0A#0D#0A..inputstream.:#3D.0#0D#0A..ou
tputstream.:#3D.0#0D#0A#0D#0A..IF.rdargs("FROM/A,TO
/K,SEP/K",.argv,.50).#3D.0.DO#0D#0A..{.writes("Bad.
args.for.DETAB*n")#0D#0A..2rc.:#3D.20#0D#0A..2GOTO.
exit#0D#0A..}#0D#0A#0D#0A..inputstream.:#3D.findinp
ut(argv!0)#0D#0A..IF.inputstream.#3D.0.DO.{.writef(
"Can*'t.open.%s*n",.argv!0)#0D#0A..24rc.:#3D.20#0D#0A
..24GOTO.exit#0D#0A..22}#0D#0A..selectinput(inputst
ream)#0D#0A#0D#0A..UNLESS.argv!1#3D0.DO.{.outputstr
eam.:#3D.findoutput(argv!1)#0D#0A..21IF.outputstrea
m#3D0.DO#0D#0A..21{.writef("Can*'t.open.%s*n",.argv
!1)#0D#0A..23rc.:#3D.20#0D#0A..23GOTO.exit#0D#0A..2
1}#0D#0A..21selectoutput(outputstream)#0D#0A..19}#0D
#0A..tabsep.:#3D.4#0D#0A..IF.argv!2.DO.tabsep.:#3D.
str2numb(argv!2)#0D#0A#0D#0A..{.LET.tab.#3D.0#0D#0A
#0D#0A..2{.ch.:#3D.rdch()#0D#0A..4IF.intflag().DO.{
.UNLESS.tab#3D0.DO.wrch('*n')#0D#0A..22selectoutput
(oldoutput)#0D#0A..22writes("**2BREAK*n")#0D#0A..22
rc.:#3D.5#0D#0A..22GOTO.exit#0D#0A..20}#0D#0A..4IF.
tab#3D0.DO.{.IF.ch#3Dendstreamch.GOTO.exit#0D#0A..1
6}#0D#0A..4SWITCHON.ch.INTO#0D#0A..4{.CASE.'*n':.CA
SE.'*p':#0D#0A..17wrch(ch)#0D#0A..17BREAK#0D#0A#0D#0A
..6CASE.'*c':.BREAK#0D#0A#0D#0A..6CASE.'*t':#0D#0A.
.15{.wrch('*s')#0D#0A..17tab.:#3D.tab+1#0D#0A..15}.
REPEATUNTIL.tab.REM.tabsep.#3D.0#0D#0A..15LOOP#0D#0A
#0D#0A..6DEFAULT:..1wrch(ch)#0D#0A..17tab.:#3D.tab+
1#0D#0A..17LOOP#0D#0A#0D#0A..6CASE.endstreamch:#0D#0A
..17wrch('*n')#0D#0A..17GOTO.exit#0D#0A..4}#0D#0A..
2}.REPEAT#0D#0A..}.REPEAT#0D#0A#0D#0Aexit:#0D#0A..U
NLESS.inputstream#3D0.DO#0D#0A..{.selectinput(input
stream)#0D#0A..2endread()#0D#0A..}#0D#0A..UNLESS.ou
tputstream#3D0.|.outputstream#3Doldoutput.DO#0D#0A.
.{.selectoutput(outputstream)#0D#0A..2endwrite()#0D
#0A..}#0D#0A..RESULTIS.rc#0D#0A}#0D#0A

######com/dumpmem.b#
/**77#0D#0A**..16(C).Copyright.Ford.Motor.Company.L
td#2E..19**#0D#0A**..21Process.Control.Systems.Dept
#2E..22**#0D#0A**78#0D#0A#0D#0A..4#23#234..2#23#23.
.2#23#23..#23#23..2#23#23..#23#235..1#23#23..2#23#23
..#23#236..#23#23..2#23#23.#0D#0A..4#23#235..1#23#23
..2#23#23..#23#231..#23#231..#23#236..#23#231..#23#23
1..#23#236..#23#231..#23#231.#0D#0A..4#23#23..2#23#23
..#23#23..2#23#23..#23#236..#23#23..2#23#23..#23#23
6..#23#23..6#23#236.#0D#0A..4#23#23..2#23#23..#23#23
..2#23#23..#23#23.#23#23.#23#23..#23#235..1#23#23.#23
#23.#23#23..#23#234..2#23#23.#23#23.#23#23.#0D#0A..
4#23#23..2#23#23..#23#23..2#23#23..#23#23..2#23#23.
.#23#23..6#23#23..2#23#23..#23#23..6#23#23..2#23#23
.#0D#0A..4#23#23..2#23#23..#23#23..2#23#23..#23#23.
.2#23#23..#23#23..6#23#23..2#23#23..#23#23..6#23#23
..2#23#23.#0D#0A..4#23#235..1#23#236..#23#23..2#23#23
..#23#23..6#23#23..2#23#23..#23#236..#23#23..2#23#23
.#0D#0A..4#23#234..3#23#234..1#23#23..2#23#23..#23#23
..6#23#23..2#23#23..#23#236..#23#23..2#23#23.#0D#0A
#0D#0A**78#0D#0A**.Version.Date..5Name..10Remarks..
31**#0D#0A**..74**#0D#0A**..0011#2E0..00129-Oct-03.
.Martin.Richards.Initial.Release..23**#0D#0A**..74*
*#0D#0A**77/#0D#0A#0D#0ASECTION."DUMPMEM"#0D#0A#0D#0A
GET."libhdr"#0D#0A#0D#0ALET.start().BE#0D#0A{.LET.a
rgv.#3D.VEC.8#0D#0A#0D#0A..UNLESS.rdargs("ON/S,OFF/
S",.argv,.8).DO#0D#0A..{.writef("Bad.argument.for.D
UMPMEM*n")#0D#0A..2stop(20)#0D#0A..}#0D#0A#0D#0A..I
F.argv!0.DO#0D#0A..{.rootnode!rtn_dumpflag.:#3D.TRU
E#0D#0A..2writef("Cintpos.Memory.dumping.enabled*n"
)#0D#0A..2RETURN#0D#0A..}.#0D#0A#0D#0A..IF.argv!1.D
O#0D#0A..{.rootnode!rtn_dumpflag.:#3D.FALSE#0D#0A..
2writef("Cintpos.Memory.dumping.disabled*n")#0D#0A.
.2RETURN#0D#0A..}.#0D#0A#0D#0A..UNLESS.argv!0.|.arg
v!1.DO#0D#0A..{.LET.datv.#3D.VEC.2#0D#0A..2rtn_abor
tcode!rootnode.:#3D.0#0D#0A..2sys(0,.-2).//.Cause.m
emory.to.be.dumped.into.DUMP#2Emem#0D#0A..2//writef
("Cintpos.memory.dumped.to.DUMP#2Emem*n")#0D#0A..2R
ETURN#0D#0A..}#0D#0A}#0D#0A

######com/dumppos.b#
//.This.is.a.program.to.dump.information.about.the.
Cintpos.system#0A//.Implemented.by.Martin.Richards.
(c).November.2000003#0A#0A//.Usage:#0A#0A//.dumpsys
.[FROM.<image>].[TO.<file>]#0A#0A//.The.FROM.argume
nt.specifies.the.dump.image.file,#0A//.the.default.
DUMP#2Emem#0A//.The.TO.argument.specifies.where.to.
send.the.output#2E#0A#0A//.The.program.dumps.the.ro
otnode.and.all.memory.blocks.then.for#0A//.each.tas
k.it.dumps.its.TCB,.workqueue,.global.vector.and#0A
//.coroutine.stacks#2E#0A#0ASECTION.".dumpsys"#0A#0A
GET."libhdr"#0A#0AGLOBAL#0A{.eof:.ug#0A..pptr#0A..g
ptr#0A..cptr#0A..ctcb#0A..fsize#0A#0A..regs#0A..tas
ktab#0A..devtab#0A..membase#0A..memlim#0A..memupb#0A
..context#0A#0A..imagefilename..//.0.or.name.of.the
.image.file#0A#0A..//.Variables.used.by.getimage,.n
extword,.and.mem#2E#0A..datastream..5//.scb.of.the.
image.file#0A..blkcount..7//.repetition.count.if.ne
g,.otherwise.size.of.block#0A..currword..7//.curren
t.word.from.image.file#0A..pagetab..8//.The.page.ta
ble#0A..pagenoupb..6//.The.page.table.upb#0A#0A..re
c_p;.rec_l..1//.Recovery.label.for.longjump#0A}#0A#0A
MANIFEST.{#0A..maxpri..2#3D.maxint#0A#0A..sectnames
ize.#3D.(11.+.bytesperword)/bytesperword#0A..routna
mesize.#3D.(11.+.bytesperword)/bytesperword#0A..nam
eoffset..1#3D.-routnamesize#0A..vecupb..5#3D.5001#0A
#0A..r_a#3D0#0A..r_b#0A..r_c#0A..r_p#0A..r_g#0A..r_
st#0A..r_pc#0A..r_count#0A..r_mw#0A..r_upb.#3D.r_mw
#0A#0A..//.Contants.used.by.getimage.and.mem#2E#0A.
.pageshift.#3D.12..1//.12.is.15.seconds.faster.than
.10#0A..pageupb.#3D.(1<<pageshift)-1#0A..pagemask.#3D
.pageupb#0A}#0A#0ALET.start().BE#0A{.LET.argv..5#3D
.VEC.50#0A..AND.datv..5#3D.VEC.1#0A..AND.datstrings
.#3D.VEC.12#0A..AND.sysin..4#3D.input()#0A..AND.sys
out..3#3D.output()#0A..AND.toname..3#3D.0#0A..AND.t
ostream..1#3D.0#0A..AND.imagefilename.#3D."DUMP#2Em
em"#0A..AND.taskcount..#3D.0#0A#0A..UNLESS.rdargs("
FROM,TO/K",.argv,.50).DO#0A..{.writes("bad.argument
s.for.DUMPSYS*n")#0A..2stop(20)#0A..}#0A#0A..pageta
b.:#3D.0#0A#0A..IF.argv!0.DO.imagefilename.:#3D.arg
v!0#0A..IF.imagefilename.UNLESS.getimage(imagefilen
ame).DO#0A..{.writef("Unable.to.load.image.file.%s*
n",.imagefilename)#0A..2RETURN#0A..}#0A#0A..rec_p,.
rec_l.:#3D.level(),.fin#0A#0A..tasktab.:#3D.mem(roo
tnode+rtn_tasktab)#0A..devtab..:#3D.mem(rootnode+rt
n_devtab)#0A..membase.:#3D.mem(rootnode+rtn_membase
)#0A..memlim..:#3D.mem(rootnode+rtn_memsize)#0A..co
ntext.:#3D.mem(rootnode+rtn_context)#0A..//.context
.#3D.1..1SIGINT.received#0A..//.context.#3D.2..1SIG
SEGV.received#0A..//.context.#3D.3..1dump.caused.by
.fault.in.BOOT.of.standalone.debug#0A..//.context.#3D
.4..1dump.requested.by.user.calling.sys(Sys_quit,.-
2)#0A..//.context.#3D.5..1non.zero.user.fault.code#0A
..//.context.#3D.6..1dump.requested.in.standalone.d
ebug#0A#0A..toname.:#3D.argv!1#0A.#0A..IF.toname.DO
#0A..{.tostream.:#3D.findoutput(toname)#0A..2UNLESS
.tostream.DO#0A..2{.writef("can't.open.%s*n",.tonam
e)#0A..4GOTO.fin#0A..2}#0A..2selectoutput(tostream)
#0A..}#0A#0A..writef("*nImage.File:.%s",.imagefilen
ame)#0A..IF.memdatstamp(datv).DO#0A..{.dat_to_strin
gs(datv,.datstrings)#0A#0A..2writef("..9Dated:..%s.
%s*n",.@datstrings!0,.@datstrings!5)#0A..}#0A..newl
ine()#0A#0A..SWITCHON.context.INTO#0A..{.DEFAULT:..
writef("Unknown.reason.(%n).for.dumping.memory",.co
ntext)#0A..12ENDCASE#0A..2CASE.1:..1writef("Dump.ca
used.by.signal.SIGINT")#0A..12ENDCASE#0A..2CASE.2:.
.1writef("Dump.caused.by.signal.SIGSEGV")#0A..12END
CASE#0A..2CASE.3:..1writef("Dump.caused.by.fault.in
.BOOT.or.standalone.debug")#0A..12ENDCASE#0A..2CASE
.4:..1writef("Dump.by.user.probably.calling:.dumpme
m")#0A..12ENDCASE#0A..2CASE.5:..1writef("Dump.cause
d.by.non.zero.user.fault.code")#0A..12ENDCASE#0A..2
CASE.6:..1writef("Dump.requested.in.standalone.debu
g")#0A..12ENDCASE#0A..}#0A..newline()#0A..#0A..writ
ef("*nLast.abort.code:.%n*n",.mem(rootnode+rtn_abor
tcode))#0A#0A..wrregs("BOOT.Registers",.bootregs)#0A
..wrregs("KLIB.Registers",.klibregs)#0A..wrregs("SA
VE.Registers",.saveregs)#0A..wrregs("ISR..Registers
",.isrregs)#0A#0A..dumprootnode()#0A#0A..IF.mem(kli
bregs+r_st)#3D3.DO#0A..{.writef("*nThe.Interrupt.Se
rvice.Routine.is.currently.running*n*n")#0A..}#0A#0A
..dumptask(mem(rootnode+rtn_idletcb))#0A..FOR.id.#3D
.1.TO.mem(tasktab).DO.dumptask(mem(tasktab+id))#0A#0A
..dumpmemory()#0A#0Afin:#0A..IF.tostream.UNLESS.sys
out#3Dtostream.DO.endstream(tostream)#0A..deleteima
ge()#0A}#0A#0AAND.memdatstamp(v).#3D.VALOF#0A{.LET.
tv.#3D.rootnode+rtn_days#0A.#0A..v!0.:#3D.mem(tv+0)
#0A..v!1.:#3D.mem(tv+1)#0A#0A..RESULTIS.TRUE#0A}#0A
#0AAND.prpkt(pkt).BE#0A{.writef("%6i:.PKT:.",.pkt)#0A
..FOR.i.#3D.pkt_link.TO.pkt_r2.DO.writearg(mem(pkt+
i))#0A..writef("*n")#0A..FOR.i.#3D.pkt_a1..1TO.pkt_
a6.DO.writearg(mem(pkt+i))#0A..newline()#0A}#0A#0AA
ND.dumprootnode().BE#0A{.writef("*nRootnode.at.%n*n
*n",.rootnode)#0A#0A..writef("..tasktab..2%10i*n",.
mem(rtn_tasktab+rootnode))#0A..writef("..devtab..3%
10i*n",.mem(rtn_devtab+rootnode))#0A..writef("..tcb
list..2%10i*n",.mem(rtn_tcblist+rootnode))#0A..writ
ef("..crntask..2%10i..",.mem(rtn_crntask+rootnode))
#0A..writef(".task.%n*n",.mem(tcb_taskid+mem(rtn_cr
ntask+rootnode))1#0A..writef("..blklist..2%10i*n",.
mem(rtn_blklist+rootnode))#0A..writef("..clkintson.
.%10i*n",.mem(rtn_clkintson+rootnode))#0A..writef("
..clwkq..4%10i*n",.mem(rtn_clwkq+rootnode))#0A..wri
tef("..memsize..2%10i*n",.mem(rtn_memsize+rootnode)
)#0A..writef("..info..5%10i*n",.mem(rtn_info+rootno
de))#0A..writef("..sys..6%10i*n",.mem(rtn_sys+rootn
ode))#0A..writef("..blib..5%10i*n",.mem(rtn_blib+ro
otnode))#0A..writef("..boot..5%10i*n",.mem(rtn_boot
+rootnode))#0A..writef("..klib..5%10i*n",.mem(rtn_k
lib+rootnode))#0A..writef("..abortcode..%10i*n",.me
m(rtn_abortcode+rootnode))#0A..writef("..context..2
%10i*n",.mem(rtn_context+rootnode))#0A..writef("..l
astp..4%10i*n",.mem(rtn_lastp+rootnode))#0A..writef
("..lastg..4%10i*n",.mem(rtn_lastg+rootnode))#0A..w
ritef("..days..5%10i*n",.mem(rtn_days+rootnode))#0A
..writef("..msecs..4%10i*n",.mem(rtn_msecs+rootnode
))#0A..writef("..idletcb..2%10i*n",.mem(rtn_idletcb
+rootnode))#0A#0A..writef("*nTasktab.at.%n.upb#3D%n
*n",.tasktab,.mem(tasktab))#0A..FOR.i.#3D.1.TO.mem(
tasktab).IF.mem(tasktab+i).DO#0A..{.LET.tcb.#3D.mem
(tasktab+i)#0A..2LET.id,.pri,.wkq.#3D.mem(tcb+tcb_t
askid),.mem(tcb+tcb_pri),.mem(tcb+tcb_wkq)#0A..2LET
.taskname.#3D.tcb+tcb_namebase.//.MR.17/01/05#0A..2
writef("%6i:.TCB.for.task.%3i,..2pri.%5i..",.tcb,.i
d,.pri)#0A..2FOR.i.#3D.1.TO.memb(taskname,.0).DO.wr
ch(memb(taskname,.i))#0A..2newline()#0A..2WHILE.wkq
.DO#0A..2{.LET.pkt.#3D.wkq#0A..4prpkt(pkt)#0A..4wkq
.:#3D.mem(wkq)#0A..2}#0A..}#0A..writef("*nDevtab.at
.%n.upb#3D%n*n",.devtab,.mem(devtab))#0A..FOR.i.#3D
.1.TO.mem(devtab).IF.mem(devtab+i).DO#0A..{.LET.dcb
.#3D.mem(devtab+i)#0A..2LET.id,.type,.wkq.#3D.mem(d
cb+Dcb_devid),.mem(dcb+Dcb_type),.mem(dcb+Dcb_wkq)#0A
..2writef("%6i:.DCB.for.device.%3i.type.%n.",.dcb,.
id,.type)#0A..2SWITCHON.type.INTO#0A..2{.DEFAULT:..
8writef("(unknown)");.ENDCASE#0A#0A..4CASE.Devt_clk
:..2writef("(clock)");..ENDCASE#0A..4CASE.Devt_ttyi
n:..writef("(ttyin)");..ENDCASE#0A..4CASE.Devt_ttyo
ut:.writef("(ttyout)");.ENDCASE#0A..4CASE.Devt_file
op:.writef("(fileop)");.ENDCASE#0A..4CASE.Devt_tcpd
ev:.writef("(tcpdev)");.ENDCASE#0A..2}#0A..2newline
()#0A..2IF.id#3D-1.DO.wkq.:#3D.mem(rtn_clwkq+rootno
de)#0A..2WHILE.wkq.DO#0A..2{.LET.pkt.#3D.wkq#0A..4p
rpkt(pkt)#0A..4wkq.:#3D.mem(wkq)#0A..2}#0A..}..#0A}
#0A#0AAND.dumpmemory().BE#0A{.LET.blocklist..#3D.me
m(rootnode+rtn_membase)#0A..LET.topofstore.#3D.mem(
rootnode+rtn_memsize)#0A..LET.a.#3D.blocklist#0A..L
ET.free,.used,.n.#3D.0,.0,.0#0A..LET.largest_free.#3D
.0#0A..LET.joinfree.#3D.0#0A..LET.sectnames,.routna
mes,.globinit.#3D.0,.0,.0#0A..LET.constr.#3D.output
()#0A..LET.outstr.#3D.0#0A#0A..writef("*nMap.of.fre
e.and.allocated.blocks.in.%n#2E#2E%n*n*n",.membase,
.memlim)#0A#0A..WHILE.mem(a).DO#0A..{.LET.size.#3D.
mem(a)#0A..2LET.freeblk.#3D.(size&1)#3D1#0A#0A..2//
IF.testflags(flag_b).GOTO.exit#0A#0A..2TEST.freeblk
#0A..2THEN.{.//.Free.block#0A..9size.:#3D.size-1#0A
..9free.:#3D.free.+.size#0A..9joinfree.:#3D.joinfre
e.+.size#0A..9IF.joinfree.>.largest_free.DO.largest
_free.:#3D.joinfree#0A..7}#0A..2ELSE.{.//.Used.bloc
k#0A..9used.:#3D.used.+.size#0A..9joinfree.:#3D.0#0A
..7}#0A#0A..2UNLESS.size>#3D0.&.a+size<#3Dtopofstor
e.DO#0A..2{.writef("**4Store.chain.corrupt!!*n*#0A.
.12*Noticed.at.%n*n",.a)#0A..4BREAK#0A..2}#0A#0A..2
writef("%8i:%7i.",.a,.size)#0A..2IF.freeblk.DO.{.wr
ites("free.");.GOTO.nxt.}#0A#0A..2{.LET.creator.#3D
.a+size-5#0A..4LET.len.#3D.memb(creator,.0)#0A..4wr
itef(".allocated.by:.")#0A..4FOR.i.#3D.1.TO.len.DO.
wrch(memb(creator,.i))#0A..4FOR.i.#3D.len+1.TO.16.D
O.wrch('.')#0A..2}#0A#0A..2IF.a.#3D.(rootnode-1).DO
.{.writes("Rootnode");.GOTO.nxt.}#0A..2IF.mem(a+3).
#3D.sectword.&.memb(a+4,.0).#3D.11.DO#0A..2{.LET.na
me.#3D.a+4#0A..4writef("Section.")#0A..4FOR.i.#3D.1
.TO.memb(name,.0).DO.wrch(memb(name,.i))#0A..4GOTO.
nxt#0A..2}#0A#0A..2FOR.id.#3D.1.TO.mem(tasktab).DO#0A
..2{.LET.t.#3D.mem(tasktab+id)#0A..4IF.t.DO#0A..4{.
LET.p,.g.#3D.mem(t+tcb_sbase),.mem(t+tcb_gbase)#0A.
.6IF.a+1#3Dp.DO.{.writef("Task.%n.stack",.id);.GOTO
.nxt.}#0A..6IF.a+1#3Dg.DO.{.writef("Task.%n.global.
vector",.id);.GOTO.nxt.}#0A..6IF.a+1#3Dt.DO.{.write
f("Task.%n.TCB",.id);.GOTO.nxt.}#0A..6IF.g.&.a>500.
FOR.gn.#3D.1.TO.mem(g).IF.a+1#3Dmem(g+gn).DO#0A..19
{.writef("Task.%n.G%n.#3D>.",.id,.gn)#0A..21GOTO.du
mp#0A..19}#0A..4}#0A..2}#0Adump:#0A..2writes("*n..7
")#0A..2FOR.i.#3D.1.TO.5.DO.{.LET.n.#3D.mem(a+i)#0A
..22TEST.-10_001_001<#3Dn<#3D10_001_001#0A..22THEN.
writef("%10i.",.n)#0A..22ELSE.writef("#23x%8x.",.n)
#0A..20}#0Anxt:.#0A..2newline()#0A..2a.:#3D.a.+.siz
e#0A..}#0A#0A..writef("End.of.block.list.#3D.%n*n",
.a)#0A..topofstore.:#3D.a#0A#0A..writef("*nLargest.
contiguous.free.area:.%n.words*n",.largest_free)#0A
..writef("Totals:.%n.words.available,.%n.used,.%n.f
ree*n*n",#0A..8used+free,.used,.free)#0A#0Aexit:#0A
}#0A#0AAND.dumptask(tcb).BE#0A{.LET.id.#3D.mem(tcb+
tcb_taskid)#0A..LET.seglist,.pkt.#3D.0,.0#0A..LET.s
tate,.flags,.cliseg.#3D.0,.0,.0#0A..LET.dead.#3D.FA
LSE..11//.Assume.activated.unless.proved.otherwise#0A
..LET.pkt.#3D.mem(tcb_wkq+tcb)#0A..regs,.pptr,.gptr
.:#3D.0,.0,.0#0A..UNLESS.tcb.RETURN#0A#0A..seglist.
:#3D.mem(tcb_seglist+tcb)#0A..pkt..1:#3D.mem(tcb.+.
tcb_wkq)#0A..state.:#3D.mem(tcb.+.tcb_state)#0A..fl
ags.:#3D.mem(tcb.+.tcb_flags)#0A..dead..:#3D.(state
.&.State_dead).#3D.State_dead#0A..cliseg.:#3D.mem(s
eglist+4)..2//.The.CLI.segment#0A#0A..writef("*n#23
#2317.Task.%2i:",.id)#0A..wrch('.')#0A..FOR.i.#3D.1
.TO.memb(tcb+tcb_namebase,.0).DO.wrch(memb(tcb+tcb_
namebase,.i))#0A..wrch('.')#0A..FOR.i.#3D.memb(tcb+
tcb_namebase,.0)+1.TO.15+16.DO.wrch('#23')#0A..writ
ef("*n*n")#0A..writef("tcb#3D%n:",.tcb)#0A..writef(
".priority.%n,",.mem(tcb.+.tcb_pri))#0A..writef(".s
tack.size.%n,",.mem(tcb+tcb_stsiz))#0A..writef(".fl
ags#3D#23b%b6*n",.mem(tcb+tcb_flags))#0A#0A..{.LET.
state.#3D.mem(tcb+tcb_state)#0A..2writef("*nState.#23
b%b4:.",.mem(tcb+tcb_state))#0A..2SWITCHON.state.&.
#23b1100000.INTO#0A..2{.CASE.#23b002:.writef(".runn
ing");..3ENDCASE#0A..4CASE.#23b0100:.writef(".waiti
ng");..3ENDCASE#0A..4CASE.#23b1001:.writef(".interr
upted");.ENDCASE#0A..4CASE.#23b1100000:.dead.:#3D.T
RUE#0A..17writef(".dead");..6ENDCASE#0A..2}#0A..2UN
LESS.(state.&.#23b0000010)#3D0.DO.writef(".held")#0A
..2UNLESS.(state.&.#23b000011)#3D0.DO.writef(".with
.packet")#0A..2newline()#0A..}#0A#0A..writef("*nPac
kets:.wkq#3D%n*n",.pkt)#0A..UNTIL.pkt<#3D0.DO#0A..{
.prpkt(pkt)#0A..2pkt.:#3D.mem(pkt_link+pkt)#0A..}#0A
#0A..IF.dead.DO#0A..{.writef("*nNo.stack.or.global.
vector.since.the.task.is.dead*n")#0A..2RETURN#0A..}
#0A#0A..regs,.ctcb,.cptr.:#3D.0,.tcb,.0#0A#0A..TEST
.mem(rootnode+rtn_crntask)#3Dctcb#0A..THEN.{.//.kli
bregs.is.the.register.set.passed.to.the.interpreter
.by.BOOT#0A..7//.these.are.normally.the.registers.t
o.use#2E#0A..7regs.:#3D.klibregs.//.The.default.reg
ister.set#0A..7//.If.st#3D3.we.are.in.the.interrupt
.service.routine#0A..7//.so.we.will.use.the.registe
rs.that.were.saved.when.the#0A..7//.interrupt.occur
red#2E#0A..7IF.mem(regs+r_st)#3D3.DO.regs.:#3D.save
regs#0A..5}#0A..ELSE.regs.:#3D.@ctcb!tcb_a#0A#0A..g
ptr..:#3D.mem(regs+r_g).>>.2#0A..pptr..:#3D.mem(reg
s+r_p).>>.2#0A#0A..//.Set.current.coroutine.if.in.u
ser.or.kernel.mode.and.the.task#0A..//.is.active#0A
..IF.mem(tcb+tcb_active).DO.cptr.:#3D.mem(gptr+g_cu
rrco)#0A#0A..UNLESS.cptr.<#3D.pptr.<#3D.cptr.+.mem(
cptr+co_size.+.6).DO.cptr.:#3D.0#0A#0A..fsize.:#3D.
100#0A//sawritef("cptr#3D%n*n",.cptr)#0A..IF.cptr.D
O.fsize.:#3D.cptr.+.6.+.mem(cptr+co_size).-.pptr#0A
#0A..wrregs("Registers",.regs)#0A#0A..writef("*nSeg
list.%n:..length.%n",.mem(tcb_seglist+tcb),.mem(seg
list))#0A..//FOR.i.#3D.1.TO.mem(seglist).DO.writef(
"..%n",.mem(seglist+i))#0A#0A..{.LET.segl.#3D.mem(t
cb.+.tcb_seglist)#0A#0A..2FOR.j.#3D.1.TO.mem(segl).
DO#0A..2{.LET.seg.#3D.mem(segl+j)#0A..4LET.layout.#3D
.0#0A..4writef("*nSeg%n.%6i:.",.j,.seg)#0A..4WHILE.
seg.DO#0A..4{.IF.layout.&.(layout.MOD.5)#3D0.DO.wri
tef("*n..11")#0A..6wrch('.')#0A..6layout.:#3D.layou
t.+.1#0A..6write_sectname(seg)#0A..6seg.:#3D.mem(se
g)#0A..4}#0A..2}#0A..2newline()#0A#0A..2IF.gptr.DO#0A
..2{.LET.gupb.#3D.mem(gptr)#0A..4writef("*nGlobal.v
ariables.at.G.#3D.%n:*n",.gptr)#0A..4FOR.gn.#3D.0.T
O.gupb.DO#0A..4{.LET.w.#3D.mem(gptr+gn)#0A..6IF.gn.
REM.5.#3D.0.DO#0A..6{.LET.v,.gw.#3D.gptr+gn,.globwo
rd+gn#0A..8IF..12mem(v+0)#3Dgw+0.&#0A..11(gn+1>gupb
.|.mem(v+1)#3Dgw+1).&#0A..11(gn+2>gupb.|.mem(v+2)#3D
gw+2).&#0A..11(gn+3>gupb.|.mem(v+3)#3Dgw+3).&#0A..1
1(gn+4>gupb.|.mem(v+4)#3Dgw+4).DO.{.gn.:#3D.gn+4;.L
OOP.}#0A..8writef("*nG%3i:",.gn)#0A..6}#0A..6writea
rg(w)#0A..4}#0A..4newline()#0A..2}#0A#0A..2writef("
*nCoroutine.stacks.for.task.%n:*n",.id)..#0A..2wrco
rtns(tcb)#0A..}#0A}#0A#0AAND.wrregs(str,.regs).BE#0A
{.writef("*n%s:*n",.str)#0A..writef("a#3D%n.b#3D%n.
c#3D%n.",.mem(regs+r_a),.mem(regs+r_b),.mem(regs+r_
c))#0A..writef("p#3D%n(%n).g#3D%n(%n).",.mem(regs+r
_p),.mem(regs+r_p)>>0002,#0A..29mem(regs+r_g),.mem(
regs+r_g)>>0002)#0A..writef("st#3D%n.pc#3D%n.count#3D
%n*n",.mem(regs+r_st),.mem(regs+r_pc),#0A..33mem(re
gs+r_count))#0A}#0A#0AAND.write_sectname(s).BE#0A{.
LET.name.#3D.s+3#0A..TEST.(mem(s+2).#3D.sectword).&
.(memb(s+3,.0).#3D.11)#0A..THEN.FOR.i.#3D.1.TO.11.D
O.wrch(memb(name,.i))#0A..ELSE.writes("??9")#0A}#0A
#0AAND.checkaddr(a).#3D.VALOF#0A{.UNLESS.membase<#3D
a<#3Dmemlim.DO#0A..{.writef("*n.bad.address.%d.not.
in.%n--%n*n",.a,.membase,.memlim)#0A..2RESULTIS.0#0A
..}#0A..RESULTIS.a#0A}#0A#0AAND.cont(a).#3D.mem(che
ckaddr(a))#0A#0AAND.wrcortns(tcb).BE#0A{.cptr.:#3D.
cont(gptr+g_colist)#0A#0A//sawritef("cptr#3D%n.pptr
#3D%n.gptr#3D%n.regs#3D%n*n",.cptr,.pptr,.gptr,.reg
s)#0A#0A..WHILE.0<cptr<#3Dmemlim.DO#0A..{.TEST.cptr
#3Dcont(gptr+g_currco)#0A..2THEN.TEST.1<#3Dmem(root
node+rtn_context)<#3D2.&.//.SIGINT.or.SIGSEGV#0A..1
2mem(rootnode+rtn_crntask)#3Dtcb#0A..7THEN.pptr.:#3D
.mem(rootnode+rtn_lastp)#0A..7ELSE.pptr.:#3D.mem(re
gs+r_p)>>0002#0A..2ELSE.pptr.:#3D.cont(cptr+co_pptr
)>>0002#0A#0A..2fsize.:#3D.cptr.+.6.+.mem(cptr+co_s
ize).-.pptr#0A//sawritef("cptr#3D%n.pptr#3D%n.gptr#3D
%n.fsize#3D%n*n",.cptr,.pptr,.gptr,.fsize)#0A#0A..2
{.LET.size.#3D.cont(cptr+co_size)#0A..4LET.hwm.#3D.
size+6#0A..4writef("*n%7i:.",.cptr)#0A..4IF.cptr#3D
mem(gptr+g_currco).DO.writes("Current.")#0A..4write
s("Coroutine.")#0A..4writearg(cont(cptr+co_fn))#0A.
.4writef("..Parent.%n",.mem(cptr+co_parent))#0A..4W
HILE.cont(cptr+hwm)#3Dstackword.DO.hwm:#3Dhwm-1#0A.
.4writef("..Stack.%n/%n*n",.hwm-6,.size)#0A..4wrfra
me()#0A#0A..4//.Move.down.one.stack.frame.and.outpu
t.it#2E#0A..4{.LET.a.#3D.mem(pptr)>>0002#0A..6IF.a<
cptr.|.a>pptr.DO.{.writes(".Corrupt.stack.chain*n")
#0A..30BREAK#0A..28}#0A..6IF.a#3Dcptr.|.a#3D0..2DO.
{.writef(".Base.of.stack*n")#0A..30BREAK#0A..28}#0A
..6fsize.:#3D.pptr-a#0A..6pptr.:#3D.a#0A..6wrframe(
)#0A..4}.REPEAT#0A..2}#0A#0A..2//.Find.next.corouti
ne.in.the.list#0A..2cptr.:#3D.cont(cptr+co_list)#0A
..}#0A..TEST.cptr.THEN.writef("*nCorrupt.coroutine.
list*n")#0A..10ELSE.writef("*nEnd.of.coroutine.list
*n")#0A}#0A#0AAND.wrframe().BE#0A{.writef("%7i:",.p
ptr)#0A..IF.pptr#3Dcptr.DO.{.writes("..1Base.of.sta
ck*n");.RETURN.}#0A..writearg(mem(pptr+2))#0A..FOR.
i#3D3.TO.6.UNLESS.i>#3Dfsize.DO.writearg(cont(pptr+
i))#0A..newline()#0A..IF.fsize>7.DO#0A..{.writef(".
.6")#0A..2FOR.i.#3D.7.TO.11.UNLESS.i>#3Dfsize.DO.wr
itearg(cont(pptr+i))#0A..2newline()#0A..}#0A..IF.fs
ize>12.DO#0A..{.writef("..6")#0A..2FOR.i.#3D.12.TO.
16.UNLESS.i>#3Dfsize.DO.writearg(cont(pptr+i))#0A..
2newline()#0A..}#0A}#0A#0AAND.writearg(n).BE.TEST.i
sfun(n)#0A..17THEN.{.LET.s.#3D.(n>>0002)-3..//.MR.1
/11/03#0A//FOR.i.#3D.1.TO.11.DO.writef("i#3D%2i..ch
#3D%n*n",.#0A..24wrch('.')#0A..24FOR.i.#3D.1.TO.mem
b(s,.0).DO.wrch(memb(s,.i))#0A..24wrch('.')#0A..22}
#0A..17ELSE.TEST.globword<#3Dn<#3Dglobword+1001..//
.MR.1/11/03#0A..22THEN.writef("..1#23G%3z#23..2",.n
-globword)#0A..22ELSE.TEST.-10_001_001<#3Dn<#3D10_0
01_001#0A..27THEN.writef(".%11i.",.n)#0A..27ELSE.wr
itef("..#23x%8x.",.n)#0A#0AAND.isfun(f).#3D.VALOF#0A
{.LET.a.#3D.f>>0002#0A..UNLESS.(f&3)#3D0.&.membase+
4<a<#3Dmemlim.RESULTIS.FALSE.//.MR.25/9/03#0A..IF.m
em(a-4)#3Dentryword.&.memb(a-3,.0)#3D11.RESULTIS.TR
UE.#0A..RESULTIS.FALSE#0A}#0A#0AAND.nextword().#3D.
VALOF#0A{.UNTIL.blkcount.DO#0A..{.UNLESS.readwords(
@blkcount,.1).DO#0A..2{.//sawritef("Bad.count.in.du
mp.file.data*n")#0A..4//abort(1001)#0A..4blkcount,.
currword.:#3D.0,.#23xBAD00BAD#0A..4RESULTIS.currwor
d#0A..2}#0A..2IF.blkcount<0.DO#0A..2{.UNLESS.readwo
rds(@currword,.1).DO#0A..4{.sawritef("Bad.block.dum
p.file*n")#0A..6currword.:#3D.#23xBAD00BAD#0A..4}#0A
..2}#0A..2//TEST.blkcount<0#0A..2//THEN.sawritef("%
7i.x.%8x*n",.-blkcount,.currword)#0A..2//ELSE.sawri
tef("%7i.BLOCK*n",.blkcount)#0A//abort(1001)#0A..}#0A
#0A..TEST.blkcount>0#0A..THEN.{.UNLESS.readwords(@c
urrword,.1).DO#0A..7{.sawritef("Bad.block.dump.file
*n")#0A..9currword.:#3D.#23xBAD00BAD#0A..7}#0A..7bl
kcount.:#3D.blkcount.-.1#0A..7RESULTIS.currword#0A.
.5}#0A..ELSE.{.blkcount.:#3D.blkcount+1#0A..7RESULT
IS.currword#0A..5}#0A#0A}#0A#0AAND.eqpages(p1,.p2).
#3D.VALOF#0A{.FOR.i.#3D.0.TO.pageupb.UNLESS.p1!i#3D
p2!i.RESULTIS.FALSE#0A..RESULTIS.TRUE#0A}#0A#0AAND.
getimage(filename).#3D.VALOF#0A{.//.Return.TRUE.is.
successful,.FALSE.otherwise#2E#0A..LET.res.#3D.FALS
E..15//.Assume.the.worst#0A..LET.memupb.#3D.0#0A#0A
..datastream.:#3D.findinput(filename)#0A#0A..UNLESS
.datastream.RESULTIS.FALSE#0A..selectinput(datastre
am)#0A#0A..blkcount,.currword.:#3D.0,.#23xBAD00BAD#0A
..pagetab.:#3D.0#0A..pagenoupb.:#3D.0#0A#0A..//.Get
.the.memory.upb#0A..UNLESS.readwords(@memupb,.1).DO
#0A..{.sawritef("Bad.memupb.in.dump.file*n")#0A..2G
OTO.ret#0A..}#0A#0A..IF.memupb<0.GOTO.ret#0A#0A..pa
genoupb.:#3D.memupb>>pageshift#0A..pagetab.:#3D.get
vec(pagenoupb)#0A..UNLESS.pagetab.DO#0A..{.writef("
Unable.to.to.allocate.space.for.the.page.table*n")#0A
..2RESULTIS.FALSE#0A..}#0A..//.Initialise.the.page.
table#0A..FOR.pageno.#3D.0.TO.pagenoupb.DO.pagetab!
pageno.:#3D.0#0A#0A..FOR.pageno.#3D.0.TO.pagenoupb.
DO#0A..{.LET.page.#3D.VEC.pageupb#0A..2AND.newpage.
#3D.0#0A..2//.Read.the.next.page#0A..2FOR.i.#3D.0.T
O.pageupb.DO.page!i.:#3D.nextword()#0A#0A..2//.Is.i
t.the.same.as.a.previous.page#0A..2FOR.p.#3D.0.TO.p
ageno-1.IF.eqpages(page,.pagetab!p).DO#0A..2{.//.A.
matching.page.has.been.found#0A..4newpage.:#3D.page
tab!p#0A//sawritef("page.%5i.same.as.page.%5i*n",.p
ageno,.p)#0A..4BREAK#0A..2}#0A..2UNLESS.newpage.DO#0A
..2{.//.A.matching.page.was.not.found.so.make.a.new
.one#0A..4newpage.:#3D.getvec(pageupb)#0A..4FOR.i.#3D
.0.TO.pageupb.DO.newpage!i.:#3D.page!i#0A//sawritef
("page.%5i.is.new*n",.pageno)#0A..2}#0A..2//.Put.th
e.page.in.the.page.table#0A..2pagetab!pageno.:#3D.n
ewpage#0A//abort(1234)#0A..}#0A#0A..res.:#3D.TRUE..
1//.Image.successful.read#0A#0Aret:#0A..IF.datastre
am.DO.endstream(datastream)#0A//abort(222)#0A..RESU
LTIS.res#0A}#0A#0AAND.deleteimage().BE.IF.pagetab.D
O#0A{.FOR.pageno.#3D.0.TO.pagenoupb.DO#0A..{.LET.pa
ge.#3D.pagetab!pageno#0A..2UNLESS.page.LOOP#0A..2fr
eevec(page)#0A..2//.Delete.all.page.table.entries.p
ointing.to.this.page#2E#0A..2FOR.p.#3D.pageno+1.TO.
pagenoupb.IF.page#3Dpagetab!p.DO.pagetab!p.:#3D.0#0A
..}#0A..freevec(pagetab)#0A}#0A#0AAND.mem(p).#3D.VA
LOF#0A{.LET.pageno.#3D.p>>pageshift..//.Typically.1
0#0A..AND.offset.#3D.p.&.pagemask..//.Typically.102
3#0A..#0A..IF.pageno.>.pagenoupb.DO#0A..{.writef("*
nBad.Cintpos.memory.address.%8x..%n*n",.p,.p)#0A..2
longjump(rec_p,.rec_l)#0A..2//.Should.not.reach.thi
s.point#0A..2RESULTIS.#23xBAD00BAD#0A..}#0A#0A..RES
ULTIS.pagetab!pageno!offset#0A}#0A#0AAND.memb(p,.n)
.#3D.VALOF#0A{.LET.word.#3D.mem(p+(n>>0002))#0A..RE
SULTIS.(@word)%(n&3)#0A}#0A

######com/dumpsys.b#
//.This.is.a.program.to.convert.a.compacted.dump.of
.the.entire#0A//.Cintcode.memory.(normally.written.
to.DUMP#2Emem).into.a.readable.form#2E#0A//.It.is.b
ased.on.the.dumpsys#2Eb.program.of.the.Cintpos.syst
em#2E#0A#0A//.Martin.Richards.(c).November.2000006#0A
#0A//.Usage:#0A#0A//.dumpsys.[FROM.<image>].[TO.<fi
le>]#0A#0A//.The.FROM.argument.specifies.the.dump.i
mage.file,#0A//.the.default.DUMP#2Emem#0A//.The.TO.
argument.specifies.where.to.send.the.output#2E#0A#0A
//.The.program.dumps.the.rootnode,.the.CLI's.global
.vector.and.its#0A//.coroutine.stacks,folled.by.a.d
ump.of.all.all.memory.blocks#2E#0A#0ASECTION.".dump
sys"#0A#0AGET."libhdr"#0A#0A1GLOBAL#0A{.eof:.ug#0A.
.pptr#0A..gptr#0A..cptr#0A..fsize#0A#0A..regs#0A..m
embase#0A..memlim#0A..memupb#0A..context#0A#0A..ima
gefilename..//.0.or.name.of.the.image.file#0A..imag
edata..4//.Raw.DUMP#2Emem.file.(#3D0.if.no.image.gi
ven)#0A..addrv..8//.memory.addresses#0A..datav..8//
.corresponding.pointers.into.imagedata#0A..datavupb
#0A..imagep..#0A#0A..rec_p;.rec_l..1//.Recovery.lab
el.for.longjump#0A}#0A#0AMANIFEST.{#0A..maxpri.#3D.
maxint#0A#0A..sectnamesize.#3D.(11.+.bytesperword)/
bytesperword#0A..routnamesize.#3D.(11.+.bytesperwor
d)/bytesperword#0A..nameoffset..1#3D.-routnamesize#0A
..vecupb..5#3D.5001#0A#0A..g_globsize#3D0;.g_sys#3D
3;.g_currco#3D7;.g_colist#3D8.#0A#0A..r_a#3D0#0A..r
_b#0A..r_c#0A..r_p#0A..r_g#0A..r_st#0A..r_pc#0A..r_
count#0A..r_mw#0A..r_upb.#3D.r_mw#0A}#0A#0ALET.star
t().BE#0A{.LET.argv..5#3D.VEC.50#0A..AND.datv..5#3D
.VEC.1#0A..AND.datstrings.#3D.VEC.12#0A..AND.sysin.
.4#3D.input()#0A..AND.sysout..3#3D.output()#0A..AND
.toname..3#3D.0#0A..AND.tostream..1#3D.0#0A..AND.im
agefilename.#3D."DUMP#2Emem"#0A..AND.taskcount..#3D
.0#0A#0A..UNLESS.rdargs("FROM,TO/K",.argv,.50).DO#0A
..{.writes("bad.arguments.for.DUMPSYS*n")#0A..2stop
(20)#0A..}#0A#0A..IF.argv!0.DO.imagefilename.:#3D.a
rgv!0#0A..IF.imagefilename.UNLESS.getimage(imagefil
ename).DO#0A..{.writef("Unable.to.load.image.file.%
s*n",.imagefilename)#0A..2RETURN#0A..}#0A#0A..rec_p
,.rec_l.:#3D.level(),.fin#0A#0A..membase.:#3D.mem(r
ootnode+rtn_membase)#0A..memlim..:#3D.mem(rootnode+
rtn_memsize)#0A..context.:#3D.mem(rootnode+rtn_cont
ext)#0A..//.context.#3D.1..1SIGINT.received#0A..//.
context.#3D.2..1SIGSEGV.received#0A..//.context.#3D
.3..1dump.caused.by.fault.in.BOOT.of.standalone.deb
ug#0A..//.context.#3D.4..1dump.requested.by.user.ca
lling.sys(Sys_quit,.-2)#0A..//.context.#3D.5..1non.
zero.user.fault.code#0A..//.context.#3D.6..1dump.re
quested.in.standalone.debug#0A#0A..toname.:#3D.argv
!1#0A.#0A..IF.toname.DO#0A..{.tostream.:#3D.findout
put(toname)#0A..2UNLESS.tostream.DO#0A..2{.writef("
can't.open.%s*n",.toname)#0A..4GOTO.fin#0A..2}#0A..
2selectoutput(tostream)#0A..}#0A#0A..writef("*nImag
e.File:.%s",.imagefilename)#0A..IF.memdatstamp(datv
).DO#0A..{.dat_to_strings(datv,.datstrings)#0A//saw
ritef("dumpsys:.datv.#3D.[%n.%n]*n",.datv!0,.datv!1
)#0A..2writef("..9Dated:..%s.%s*n",.@datstrings!0,.
@datstrings!5)#0A..}#0A..newline()#0A#0A..SWITCHON.
context.INTO#0A..{.DEFAULT:..writef("Unknown.reason
.(%n).for.dumping.memory",.context)#0A..12ENDCASE#0A
..2CASE.1:..1writef("Dump.caused.by.signal.SIGINT")
#0A..12ENDCASE#0A..2CASE.2:..1writef("Dump.caused.b
y.signal.SIGSEGV")#0A..12ENDCASE#0A..2CASE.3:..1wri
tef("Dump.caused.by.fault.in.BOOT.or.standalone.deb
ug")#0A..12ENDCASE#0A..2CASE.4:..1writef("Dump.by.u
ser.probably.calling:.dumpmem")#0A..12ENDCASE#0A..2
CASE.5:..1writef("Dump.caused.by.non.zero.user.faul
t.code")#0A..12ENDCASE#0A..2CASE.6:..1writef("Dump.
requested.in.standalone.debug")#0A..12ENDCASE#0A..}
#0A..newline()#0A..#0A..writef("*nLast.abort.code:.
%n*n",.mem(rootnode+rtn_abortcode))#0A#0A..dumproot
node()#0A#0A..dumptask("Boot",.bootregs).#0A..dumpt
ask("CLI",.cliregs)#0A.#0A..dumpmemory()#0A#0Afin:#0A
..IF.tostream.UNLESS.sysout#3Dtostream.DO.endstream
(tostream)#0A..IF.imagedata.DO.freevec(imagedata)#0A
..IF.addrv..3DO.freevec(addrv)#0A..IF.datav..3DO.fr
eevec(datav)#0A}#0A#0AAND.memdatstamp(v).#3D.VALOF#0A
{.LET.tv.#3D.rootnode+rtn_days#0A.#0A..UNLESS.0<#3D
tv<#3Dmemupb.RESULTIS.FALSE#0A#0A..v!0.:#3D.mem(tv+
0)#0A..v!1.:#3D.mem(tv+1)#0A#0A..RESULTIS.TRUE#0A}#0A
#0AAND.dumprootnode().BE#0A{.writef("*nRootnode.at.
%n*n*n",.rootnode)#0A#0A..writef("..blklist..2%iA*n
",.mem(rtn_blklist+rootnode))#0A..writef("..memsize
..2%iA*n",.mem(rtn_memsize+rootnode))#0A..writef(".
.info..5%iA*n",.mem(rtn_info+rootnode))#0A..writef(
"..sys..6%iA*n",.mem(rtn_sys+rootnode))#0A..writef(
"..blib..5%iA*n",.mem(rtn_blib+rootnode))#0A..write
f("..boot..5%iA*n",.mem(rtn_boot+rootnode))#0A..wri
tef("..abortcode..%iA*n",.mem(rtn_abortcode+rootnod
e))#0A..writef("..context..2%iA*n",.mem(rtn_context
+rootnode))#0A..writef("..lastp..4%iA*n",.mem(rtn_l
astp+rootnode))#0A..writef("..lastg..4%iA*n",.mem(r
tn_lastg+rootnode))#0A..writef("..days..5%iA*n",.me
m(rtn_days+rootnode))#0A..writef("..msecs..4%iA*n",
.mem(rtn_msecs+rootnode))#0A}#0A#0AAND.dumpmemory()
.BE#0A{.LET.blocklist..#3D.mem(rootnode+rtn_membase
)#0A..LET.topofstore.#3D.mem(rootnode+rtn_memsize)#0A
..LET.a.#3D.blocklist#0A..LET.free,.used,.n.#3D.0,.
0,.0#0A..LET.largest_free.#3D.0#0A..LET.joinfree.#3D
.0#0A..LET.sectnames,.routnames,.globinit.#3D.0,.0,
.0#0A..LET.constr.#3D.output()#0A..LET.outstr.#3D.0
#0A#0A..writef("*nMap.of.free.and.allocated.blocks.
in.%n#2E#2E%n*n*n",.membase,.memlim)#0A#0A..WHILE.m
em(a).DO#0A..{.LET.size.#3D.mem(a)#0A..2LET.freeblk
.#3D.(size&1)#3D1#0A#0A..2TEST.freeblk#0A..2THEN.{.
//.Free.block#0A..9size.:#3D.size-1#0A..9free.:#3D.
free.+.size#0A..9joinfree.:#3D.joinfree.+.size#0A..
9IF.joinfree.>.largest_free.DO.largest_free.:#3D.jo
infree#0A..7}#0A..2ELSE.{.//.Used.block#0A..9used.:
#3D.used.+.size#0A..9joinfree.:#3D.0#0A..7}#0A#0A..
2UNLESS.size>#3D0.&.a+size<#3Dtopofstore.DO#0A..2{.
writef("**4Store.chain.corrupt!!*n*#0A..12*Noticed.
at.%n*n",.a)#0A..4BREAK#0A..2}#0A#0A..2writef("%i8:
%i7.",.a,.size)#0A..2IF.freeblk.DO.{.writes("free."
);.GOTO.nxt.}#0A#0A..2IF.a.#3D.(rootnode-1).DO.{.wr
ites("Rootnode");.GOTO.nxt.}#0A..2IF.mem(a+3).#3D.s
ectword.&.memb(a+4,.0).#3D.11.DO#0A..2{.LET.name.#3D
.a+4#0A..4writef("Section.")#0A..4FOR.i.#3D.1.TO.me
mb(name,.0).DO.wrch(memb(name,.i))#0A..4GOTO.nxt#0A
..2}#0A/*#0A..2FOR.id.#3D.1.TO.mem(tasktab).DO#0A..
2{.LET.t.#3D.mem(tasktab+id)#0A..4IF.t.DO#0A..4{.LE
T.p,.g.#3D.mem(t+tcb_sbase),.mem(t+tcb_gbase)#0A..6
IF.a+1#3Dp.DO.{.writef("Task.%n.stack",.id);.GOTO.n
xt.}#0A..6IF.a+1#3Dg.DO.{.writef("Task.%n.global.ve
ctor",.id);.GOTO.nxt.}#0A..6IF.a+1#3Dt.DO.{.writef(
"Task.%n.TCB",.id);.GOTO.nxt.}#0A..6IF.g.&.a>500.FO
R.gn.#3D.1.TO.mem(g).IF.a+1#3Dmem(g+gn).DO#0A..19{.
writef("Task.%n.G%n.#3D>.",.id,.gn)#0A..21GOTO.dump
#0A..19}#0A..4}#0A..2}#0A*/#0Adump:#0A..2FOR.i.#3D.
1.TO.5.DO.{.LET.n.#3D.mem(a+i)#0A..22TEST.-10_001_0
01<#3Dn<#3D10_001_001#0A..22THEN.writef("%iA.",.n)#0A
..22ELSE.writef("#23x%x8.",.n)#0A..20}#0Anxt:.#0A..
2newline()#0A..2a.:#3D.a.+.size#0A..}#0A#0A..writef
("End.of.block.list.#3D.%n*n",.a)#0A..topofstore.:#3D
.a#0A#0A..writef("*nLargest.contiguous.free.area:.%
n.words*n",.largest_free)#0A..writef("Totals:.%n.wo
rds.available,.%n.used,.%n.free*n*n",#0A..8used+fre
e,.used,.free)#0A#0Aexit:#0A}#0A#0AAND.dumptask(nam
e,.regs).BE#0A{.writef("*n*n#23#2323.Program.%s.",.
name)#0A..FOR.i.#3D.name%0+1.TO.15+16.DO.wrch('#23'
)#0A..writef("*n")#0A#0A..gptr.:#3D.mem(regs+r_g).>
>.2#0A..pptr.:#3D.mem(regs+r_p).>>.2#0A..cptr.:#3D.
mem(gptr+g_currco)#0A#0A..UNLESS.cptr.<#3D.pptr.<#3D
.cptr.+.mem(cptr+co_size.+.6).DO.cptr.:#3D.0#0A#0A.
.fsize.:#3D.100#0A//sawritef("cptr#3D%n*n",.cptr)#0A
..IF.cptr.DO.fsize.:#3D.cptr.+.6.+.mem(cptr+co_size
).-.pptr#0A#0A..wrregs("Registers",.regs)#0A#0A..IF
.gptr.DO#0A..{.LET.gupb.#3D.mem(gptr)#0A..2writef("
*nGlobal.variables.at.G.#3D.%n:*n",.gptr)#0A..2FOR.
gn.#3D.0.TO.gupb.DO#0A..2{.LET.w.#3D.mem(gptr+gn)#0A
..4IF.gn.REM.5.#3D.0.DO#0A..4{.LET.v,.gw.#3D.gptr+g
n,.globword+gn#0A..6IF..12mem(v+0)#3Dgw+0.&#0A..9(g
n+1>gupb.|.mem(v+1)#3Dgw+1).&#0A..9(gn+2>gupb.|.mem
(v+2)#3Dgw+2).&#0A..9(gn+3>gupb.|.mem(v+3)#3Dgw+3).
&#0A..9(gn+4>gupb.|.mem(v+4)#3Dgw+4).DO.{.gn.:#3D.g
n+4;.LOOP.}#0A..6writef("*nG%i3:",.gn)#0A..4}#0A..4
writearg(w)#0A..2}#0A..2newline()#0A..}#0A#0A..writ
ef("*nCoroutine.stacks.for.program.%s:*n",.name)..#0A
..wrcortns(regs)#0A}#0A#0AAND.wrregs(str,.regs).BE#0A
{.writef("*n%s:*n",.str)#0A..writef("a#3D%n.b#3D%n.
c#3D%n.",.mem(regs+r_a),.mem(regs+r_b),.mem(regs+r_
c))#0A..writef("p#3D%n(%n).g#3D%n(%n).",.mem(regs+r
_p),.mem(regs+r_p)>>0002,#0A..29mem(regs+r_g),.mem(
regs+r_g)>>0002)#0A..writef("st#3D%n.pc#3D%n.count#3D
%n.mw#3D%n*n",.mem(regs+r_st),.mem(regs+r_pc),#0A..
33mem(regs+r_count),mem(regs+r_mw))#0A}#0A#0AAND.wr
ite_sectname(s).BE#0A{.LET.name.#3D.s+3#0A..TEST.(m
em(s+2).#3D.sectword).&.(memb(s+3,.0).#3D.11)#0A..T
HEN.FOR.i.#3D.1.TO.11.DO.wrch(memb(name,.i))#0A..EL
SE.writes("??9")#0A}#0A#0AAND.checkaddr(a).#3D.VALO
F#0A{.UNLESS.membase<#3Da<#3Dmemlim.DO#0A..{.writef
("*nBad.address.%n.not.in.range.%n--%n*n",.a,.memba
se,.memlim)#0A..2RESULTIS.0#0A..}#0A..RESULTIS.a#0A
}#0A#0AAND.cont(a).#3D.mem(checkaddr(a))#0A#0AAND.w
rcortns(regs).BE#0A{.#0A//sawritef("cptr#3D%n.pptr#3D
%n.gptr#3D%n*n",.cptr,.pptr,.gptr)#0A..cptr.:#3D.co
nt(gptr+g_colist)#0A#0A..WHILE.0<cptr<#3Dmemlim.DO#0A
..{.//.Output.a.coroutine.stack#0A..2TEST.cptr#3Dco
nt(gptr+g_currco)#0A..2THEN.pptr.:#3D.cont(regs+r_p
)>>0002#0A..2ELSE.pptr.:#3D.cont(cptr+co_pptr)>>000
2#0A..2fsize.:#3D.cptr.+.6.+.cont(cptr+co_size).-.p
ptr#0A..2wrcortn()#0A#0A..2//.Find.next.coroutine.i
n.the.list#0A..2cptr.:#3D.cont(cptr+co_list)#0A..}#0A
..TEST.cptr.THEN.writef("*nCorrupt.coroutine.list*n
")#0A..10ELSE.writef("*nEnd.of.coroutine.list*n")#0A
}#0A#0AAND.wrcortn().BE#0A{.LET.size.#3D.cont(cptr+
co_size)#0A..LET.hwm.#3D.size+6#0A..writef("*n%i8:.
",.cptr)#0A..IF.cptr#3Dmem(gptr+g_currco).DO.writes
("Current.")#0A..writes("Coroutine.")#0A..writearg(
cont(cptr+co_fn))#0A..writef("..Parent.%n",.mem(cpt
r+co_parent))#0A..WHILE.cont(cptr+hwm)#3Dstackword.
DO.hwm:#3Dhwm-1#0A..writef("..Stack.%n/%n*n",.size,
.hwm-6)#0A..wrframe()#0A#0A..WHILE.pptr>.cptr.DO#0A
..{.LET.a.#3D.cont(pptr)>>0002#0A..2fsize.:#3D.pptr
-a#0A..2pptr.:#3D.a#0A..2wrframe()#0A..}#0A#0A..wri
tef(".Base.of.stack*n")#0A}#0A#0AAND.wrframe().BE#0A
{.writef("%i8:",.pptr)#0A..TEST.pptr#3Dcptr#0A..THE
N.writef("..#23StackBase#23")#0A..ELSE.writearg(mem
(pptr+2))#0A..FOR.i#3D3.TO.6.UNLESS.i>#3Dfsize.DO.w
ritearg(cont(pptr+i))#0A..newline()#0A..IF.fsize>7.
DO#0A..{.writef("..7")#0A..2FOR.i.#3D.7.TO.11.UNLES
S.i>#3Dfsize.DO.writearg(cont(pptr+i))#0A..2newline
()#0A..}#0A..IF.fsize>12.DO#0A..{.writef("..7")#0A.
.2FOR.i.#3D.12.TO.16.UNLESS.i>#3Dfsize.DO.writearg(
cont(pptr+i))#0A..2newline()#0A..}#0A}#0A#0AAND.wri
tearg(n).BE#0A//.Write.an.argument.in.a.field.width
.of.13.characters#0A..TEST.isfun(n)#0A..THEN.{.LET.
s.#3D.(n>>0002)-3..//.MR.1/11/03#0A..7LET.len.#3D.m
emb(s,.0)#0A..7WHILE.len>0.&.memb(s,.len)#3D'.'.DO.
len.:#3D.len-1#0A..7FOR.i.#3D.len+1.TO.13.DO.wrch('
.')#0A..7FOR.i.#3D.1.TO.len.DO.wrch(memb(s,.i))#0A.
.5}#0A..ELSE.TEST.globword<#3Dn<#3Dglobword+1001../
/.MR.1/11/03#0A..5THEN.writef("..5#23G%z3#23",.n-gl
obword)#0A..5ELSE.TEST.-10_001_001<#3Dn<#3D10_001_0
01#0A..10THEN.writef("..%iB",.n)#0A..10ELSE.writef(
"..1#23x%x8",.n)#0A#0AAND.isfun(f).#3D.VALOF#0A{.LE
T.a.#3D.f>>0002#0A//sawritef("isfun(%n)*n",.f)#0A..
UNLESS.(f&3)#3D0.&.membase+4<a<#3Dmemlim.RESULTIS.F
ALSE.//.MR.25/9/03#0A//sawritef("isfun:.a#3D%n*n",.
a)#0A..IF.mem(a-4)#3Dentryword.&.memb(a-3,.0)#3D11.
RESULTIS.TRUE.#0A//sawritef("isfun:.returning.FALSE
*n")#0A..RESULTIS.FALSE#0A}#0A#0AAND.getimage(filen
ame).#3D.VALOF#0A{.LET.res.#3D.FALSE#0A..LET.oldin.
#3D.input()#0A..LET.scb.#3D.findinput(filename)#0A.
.LET.size,.upb,.wordsread.#3D.0,.0,.0#0A#0A..imaged
ata,.addrv,.datav.:#3D.0,.0,.0#0A#0A..UNLESS.scb.RE
SULTIS.FALSE#0A..size.:#3D.sys(Sys_filesize,.scb!sc
b_fd)..2//.Size.in.bytes#0A..IF.size.DO.upb..:#3D.(
size-1)/bytesperword.//.UPB.in.words..4#0A#0A..imag
edata.:#3D.getvec(upb)#0A..UNLESS.imagedata.DO#0A..
{.writef("Unable.to.allocate.a.vector.with.upb#3D%n
*n",.upb)#0A..2GOTO.ret#0A..}#0A..selectinput(scb)#0A
..wordsread.:#3D.readwords(imagedata,.upb+1)#0A..UN
LESS.upb+1#3Dwordsread.DO#0A..{.writef("Read.%n.wor
ds.from.%s,.it.should.have.been.%n*n",#0A..10wordsr
ead,.filename,.upb+1)#0A..2GOTO.ret#0A..}#0A..//wri
tef("Read.%n.words.from.%s*n",.wordsread,.filename)
#0A..//FOR.i.#3D.0.TO.upb>31->31,.upb.DO.writef("%i
5:.%x8*n",.i,.imagedata!i)#0A#0A..memupb.:#3D.image
data!0#0A..imagep.:#3D.1#0A#0A..datavupb.:#3D.0#0A.
.{.LET.addr,.imagep.#3D.0,.1#0A..2UNTIL.addr.>.memu
pb.DO#0A..2{.LET.n.#3D.imagedata!imagep#0A#0A//TEST
.n>#3D0.THEN.writef("%i9:.%i9.BLOCK*n",.addr,.n)#0A
//..8ELSE.writef("%i9:.%i9.x.%x8*n",.addr,.-n,.imag
edata!(imagep+1))#0A..4UNLESS.n.BREAK#0A#0A..4TEST.
n>0.THEN.imagep.:#3D.imagep.+.n.+.1#0A..13ELSE.imag
ep.:#3D.imagep.+.2#0A..4datavupb.:#3D.datavupb.+.1#0A
..4//addrv!datavupb.:#3D.addr#0A..4//datav!datavupb
.:#3D.p#0A..4addr.:#3D.addr.+.ABS.n#0A..2}#0A..2UNL
ESS.addr.#3D.memupb+1.DO#0A..2{.writef("Image.file.
is.corrupt,.addr#3D%n.memupb#3D%n*n",.addr,.memupb)
#0A..4GOTO.ret#0A..2}#0A..}#0A//..writef("Image.fil
e.ok,.datavupb#3D%n*n",.datavupb)#0A#0A..addrv.:#3D
.getvec(datavupb)#0A..datav.:#3D.getvec(datavupb)#0A
..UNLESS.addrv.&.datav.DO#0A..{.writef("More.space.
needed*n")#0A..2GOTO.ret#0A..}#0A#0A..datavupb.:#3D
.0#0A#0A..{.LET.addr,.imagep.#3D.0,.1#0A..2UNTIL.ad
dr.>.memupb.DO#0A..2{.LET.n.#3D.imagedata!imagep#0A
#0A..4UNLESS.n.BREAK#0A#0A..4datavupb.:#3D.datavupb
.+.1#0A..4addrv!datavupb.:#3D.addr#0A..4datav!datav
upb.:#3D.imagep#0A#0A..4TEST.n>0.THEN.imagep.:#3D.i
magep.+.n.+.1#0A..13ELSE.imagep.:#3D.imagep.+.2#0A.
.4addr.:#3D.addr.+.ABS.n#0A..2}#0A#0A..2UNLESS.addr
.#3D.memupb+1.DO#0A..2{.writef("Image.file.is.corru
pt,.addr#3D%n.memupb#3D%n*n",.addr,.memupb)#0A..4GO
TO.ret#0A..2}#0A..}#0A#0A..res.:#3D.TRUE#0Aret:#0A.
.IF.scb.DO.endstream(scb)#0A..selectinput(oldin)#0A
..RESULTIS.res#0A}#0A#0AAND.mem(p).#3D.VALOF.//.Get
.a.word.of.dumped.memory#0A{.LET.i,.j,.len,.res.#3D
.1,.datavupb+1,.0,.0#0A..UNLESS.0<#3Dp<#3Dmemupb.DO
#0A..{.writef("*nBad.Cintpos.memory.address.%x8..%n
*n",.p,.p)#0A..2longjump(rec_p,.rec_l)#0A..2RESULTI
S.#23xBAD00BAD#0A..}#0A#0A..{.LET.m.#3D.(i+j)/2#0A/
/..2writef("addrv!m#3D%i9.p#3D%n..i#3D%i2.m#3D%i2.j
#3D%i2*n",.addrv!m,.p,.i,.m,.j)#0A//abort(1001)#0A.
.2IF.i#3Dm.BREAK#0A..2TEST.addrv!m.<#3D.p.THEN.i.:#3D
.m#0A..20ELSE.j.:#3D.m#0A..}.REPEAT#0A#0A..len.:#3D
.imagedata!(datav!i)#0A..//writef("len.#3D.%n..data
v!i#3D%n*n*n",.len,.datav!i)#0A..TEST.len>0.THEN.re
s.:#3D.imagedata!(datav!i.+.p-addrv!i+1)#0A..11ELSE
.res.:#3D.imagedata!(datav!i.+.1)#0A..//writef("mem
(%n).#3D>.%x8..%i9*n",.p,.res,.res)#0A..RESULTIS.re
s#0A}#0A#0AAND.memb(p,.n).#3D.VALOF#0A{.LET.word.#3D
.mem(p+(n>>0002))#0A..RESULTIS.(@word)%(n&3)#0A}#0A


######com/echo.b#
SECTION."ECHO"#0A#0AGET."libhdr"#0A#0ALET.start().#3D
.VALOF#0A{.LET.tostream.#3D.0#0A..LET.toname.#3D.0#0A
..LET.appending.#3D.?#0A..LET.nonewline.#3D.?#0A..L
ET.text.#3D.0#0A..LET.argv.#3D.VEC.80#0A#0A..IF.rda
rgs("TEXT,TO/K,APPEND/S,N/S",.argv,.80)#3D0.DO#0A..
{.writes("Bad.argument.for.ECHO*n")#0A..2RESULTIS.2
0#0A..}#0A#0A..IF.argv!0.DO.text.:#3D.argv!0..2//.T
EXT#0A..IF.argv!1.DO.toname.:#3D.argv!1..//.TO/K#0A
..appending.:#3D.argv!2..10//.APPEND/S#0A..nonewlin
e.:#3D.argv!3..10//.N/S#0A#0A..IF.toname.DO#0A..{.T
EST.appending#0A..2THEN.tostream.:#3D.findappend(to
name)#0A..2ELSE.tostream.:#3D.findoutput(toname)#0A
..2UNLESS.tostream.DO#0A..2{.writef("Unable.to.open
.file:.%s*n",.toname)#0A..4result2.:#3D.100#0A..4RE
SULTIS.20#0A..2}#0A..2selectoutput(tostream)#0A..}#0A
#0A..IF.text.DO.writes(text)#0A..UNLESS.nonewline.D
O.newline()#0A#0A..IF.tostream.DO.endstream(tostrea
m)#0A..RESULTIS.0#0A}#0A

######com/enlarge.b#
//.(C).Copyright.1979.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0A//.Program.to.display.text.as.large.characters#0A
//.Author:.Brian.Knight..00014.Feb.79#0A//#0A//.Tab
le.of.styles.created.by:#0A//..1Martyn.Johnson#0A//
..1Carl.Dellar#0A//..1Paul.Bond#0A#0A//.Can.be.CALL
SEGed.or.used.as.a.command#0ASECTION."Enlarge"#0A#0A
GET."libhdr"#0A#0AMANIFEST.{.maxchars.#3D.8./*.For.
vdu.*/.}#0A#0A1LET.start(s).BE#0A{.LET.argv.#3D.VEC
.50#0A..LET.outstream.#3D.0#0A..LET.ch.#3D.?#0A#0A.
.IF.s.DO#0A..{.//.Program.was.called.from.CALLSEG#0A
..2enlarge(s)#0A..2RETURN#0A..}#0A#0A..ch.:#3D.rdch
()#0A..WHILE.ch#3D'.'.DO.ch.:#3D.rdch()#0A..TEST.ch
.#3D.'?'#0A..THEN.{.enlarge("/a,to/k:")#0A..7UNTIL.
ch#3D'*n'.|.ch#3D'*e'.|.ch#3Dendstreamch.DO.ch.:#3D
.rdch()#0A..5}#0A..ELSE.unrdch()#0A#0A..UNLESS.rdar
gs("/a,to/k",.argv,.50).DO#0A..{.enlarge("Bad.args"
)#0A..2stop(20)#0A..}#0A#0A..IF.argv!1.DO#0A..{.//.
Output.file.specified#0A..2outstream.:#3D.findoutpu
t(argv!1)#0A..2UNLESS.outstream.DO#0A..2{.writef("C
an't.open.%S.for.output*N",.argv!1)#0A..4stop(20)#0A
..2}#0A..2selectoutput(outstream)#0A..}#0A#0A..enla
rge(argv!0)#0A#0A..IF.outstream.DO.endwrite()#0A}#0A
#0A1AND.enlarge(s).BE#0A{.LET.len.#3D.s%0<maxchars.
->.s%0,.maxchars#0A..LET.offset.#3D.(maxchars.-.len
).*.5#0A#0A..FOR.line.#3D.0.TO.7.DO#0A..{.FOR.m#3D1
.TO.offset.DO.wrch('.')#0A..2FOR.n#3D1.TO.len.DO#0A
..2{.wrch('.')#0A..4write_ch_slice(s%n,.line)#0A..4
wrch('.')#0A..2}#0A..2newline()#0A..}#0A}#0A#0A1AND
.write_ch_slice(ch,.line).BE#0A{#0A..//.Writes.the.
horizontal.slice.consisting#0A..//.of.the.given.lin
e.of.character.ch#2E#0A#0A..LET.c.#3D.ch<'*S'.->.'*
S',.ch#0A..LET.charbase.#3D.((c.&.#23X7F).-.'*S').*
.4.+#0A..6TABLE#0A..7#23X002,.#23X002,.#23X002,.#23
X002,.//.space#0A..7#23X002,.#23X00DF,.#23XDF00,.#23
X002,.//.!#0A..7#23X000017,.#23X0700,.#23X000017,.#23
X0700,.//."#0A..7#23X2424,.#23XFF00024,.#23X24FF,.#23
X2424,.//.#23#0A..7#23X4689,.#23X89FF,.#23XFF00089,
.#23X8972,.//.$#0A..7#23X8046,.#23X2610,.#23X0864,.
#23X6201,.//.%#0A..7#23X42A5,.#23X9189,.#23X5125,.#23
X4280,.//.&#0A..7#23X002,.#23X000017,.#23X0700,.#23
X002,.//.'#0A..7#23X002,.#23X002,.#23X3C7E,.#23XC30
0,.//.(#0A..7#23X00C3,.#23X7E3C,.#23X002,.#23X002,.
//.)#0A..7#23X000004A,.#23X2C18,.#23X7E18,.#23X2C4A
,.//.*#0A..7#23X000018,.#23X0808,.#23X7E08,.#23X080
8,.//.+#0A..7#23X0000060,.#23XE001,.#23X002,.#23X00
2,.//.,#0A..7#23X000018,.#23X0808,.#23X0808,.#23X08
08,.//.-#0A..7#23X00C0,.#23XC001,.#23X002,.#23X002,
.//.#2E#0A..7#23X4060,.#23X3018,.#23X0804,.#23X0602
,.//./#0A..7#23X3C7E,.#23XC3C3,.#23XC3C3,.#23X7E3C,
.//.0#0A..7#23X000014,.#23X06FF,.#23XFF00000,.#23X0
02,.//.1#0A..7#23X84C6,.#23XC3E3,.#23XE3D3,.#23XDEC
C,.//.2#0A..7#23X2466,.#23XC3CB,.#23XCBCB,.#23X7E3C
,.//.3#0A..7#23X080C,.#23X0E0B,.#23XFF2,.#23X0808,.
//.4#0A..7#23X2F6F,.#23XCBCB,.#23XCBCB,.#23X7B33,./
/.5#0A..7#23X3E7F,.#23XCBCB,.#23XCBCB,.#23X7B32,.//
.6#0A..7#23X0383,.#23XC363,.#23X330001B,.#23X0F07,.
//.7#0A..7#23X76FF,.#23XCBCB,.#23XCBCB,.#23XFF00076
,.//.8#0A..7#23X44CE,.#23XCBCB,.#23XCBCB,.#23XFE7C,
.//.9#0A..7#23X002,.#23X00D8,.#23XD800,.#23X002,.//
.:#0A..7#23X002,.#23X0000058,.#23XD800,.#23X002,.//
.;#0A..7#23X002,.#23X0810,.#23X2440002,.#23X8100,./
/.<#0A..7#23X0000028,.#23X2828,.#23X2828,.#23X2828,
.//.#3D#0A..7#23X0000081,.#23X4220004,.#23X1000008,
.#23X002,.//.>#0A..7#23X0203,.#23X03DB,.#23XDB0B,.#23
X0F06,.//.?#0A..7#23X7E81,.#23X99A5,.#23XA5BD,.#23X
A1BE,.//.@#0A..7#23XFCFE,.#23X0B0B,.#23X0B0B,.#23XF
EFC,.//.A#0A..7#23XFF2,.#23XCBCB,.#23XCBCB,.#23XFF0
0076,.//.B#0A..7#23X3C7E,.#23XC3C3,.#23XC3C3,.#23XC
342,.//.C#0A..7#23XFF2,.#23XC3C3,.#23XC3C3,.#23X7E3
C,.//.D#0A..7#23XFF2,.#23XCBCB,.#23XCBCB,.#23XC3C3,
.//.E#0A..7#23XFF2,.#23X0B0B,.#23X0B0B,.#23X0303,./
/.F#0A..7#23X7EFF,.#23XC3C3,.#23XCBCB,.#23XFB7A,.//
.G#0A..7#23XFF2,.#23X0808,.#23X0808,.#23XFF2,.//.H#0A
..7#23XC3C3,.#23XC3FF,.#23XFFC3,.#23XC3C3,.//.I#0A.
.7#23XC3C3,.#23XC3FF,.#23X7F03,.#23X0303,.//.J#0A..
7#23XFF2,.#23X0818,.#23X3466,.#23XC381,.//.K#0A..7#23
XFF2,.#23XC0C0,.#23XC0C0,.#23XC0C0,.//.L#0A..7#23XF
F2,.#23X060C,.#23X0C06,.#23XFF2,.//.M#0A..7#23XFF2,
.#23X060C,.#23X3870,.#23XFF2,.//.N#0A..7#23X7EFF,.#23
XC3C3,.#23XC3C3,.#23XFF0007E,.//.O#0A..7#23XFF2,.#23
X0B0B,.#23X0B0B,.#23X0F06,.//.P#0A..7#23X7EFF,.#23X
C3C3,.#23XD3E3,.#23X7FBE,.//.Q#0A..7#23XFF2,.#23X1B
1B,.#23X3B7B,.#23XDF8E,.//.R#0A..7#23X4ECF,.#23XCBC
B,.#23XCBCB,.#23XFB72,.//.S#0A..7#23X0303,.#23X03FF
,.#23XFF00003,.#23X0303,.//.T#0A..7#23X7FF1,.#23XC0
C0,.#23XC0C0,.#23XFF0007F,.//.U#0A..7#23X1F3F,.#23X
60C0,.#23XC060,.#23X3F1F,.//.V#0A..7#23XFF2,.#23X60
30,.#23X3060,.#23XFF2,.//.W#0A..7#23XC366,.#23X3408
,.#23X0834,.#23X66C3,.//.X#0A..7#23X0306,.#23X0CF8,
.#23XF80C,.#23X0603,.//.Y#0A..7#23XE3F3,.#23XDBCB,.
#23XCBC7,.#23XC7C3,.//.Z#0A..7#23X002,.#23XFF2,.#23
XC3C3,.#23X002,.//.[#0A..7#23X0206,.#23X0408,.#23X1
830,.#23X6040,.//.\#0A..7#23X002,.#23XC3C3,.#23XFF2
,.#23X002,.//.]#0A..7#23X0203,.#23X03DB,.#23XDB0B,.
#23X0F06,.//.^#0A..7#23X0808,.#23X0808,.#23X4A2C,.#23
X1808,.//._#0A..7#23X0203,.#23X03DB,.#23XDB0B,.#23X
0F06,.//.`#0A..7#23XFCFE,.#23X0B0B,.#23X0B0B,.#23XF
EFC,.//.a#0A..7#23XFF2,.#23XCBCB,.#23XCBCB,.#23XFF0
0076,.//.b#0A..7#23X3C7E,.#23XC3C3,.#23XC3C3,.#23XC
342,.//.c#0A..7#23XFF2,.#23XC3C3,.#23XC3C3,.#23X7E3
C,.//.d#0A..7#23XFF2,.#23XCBCB,.#23XCBCB,.#23XC3C3,
.//.e#0A..7#23XFF2,.#23X0B0B,.#23X0B0B,.#23X0303,./
/.f#0A..7#23X7EFF,.#23XC3C3,.#23XCBCB,.#23XFB7A,.//
.g#0A..7#23XFF2,.#23X0808,.#23X0808,.#23XFF2,.//.h#0A
..7#23XC3C3,.#23XC3FF,.#23XFFC3,.#23XC3C3,.//.i#0A.
.7#23XC3C3,.#23XC3FF,.#23X7F03,.#23X0303,.//.j#0A..
7#23XFF2,.#23X0818,.#23X3466,.#23XC381,.//.k#0A..7#23
XFF2,.#23XC0C0,.#23XC0C0,.#23XC0C0,.//.l#0A..7#23XF
F2,.#23X060C,.#23X0C06,.#23XFF2,.//.m#0A..7#23XFF2,
.#23X060C,.#23X3870,.#23XFF2,.//.n#0A..7#23X7EFF,.#23
XC3C3,.#23XC3C3,.#23XFF0007E,.//.o#0A..7#23XFF2,.#23
X0B0B,.#23X0B0B,.#23X0F06,.//.p#0A..7#23X7EFF,.#23X
C3C3,.#23XD3E3,.#23X7FBE,.//.q#0A..7#23XFF2,.#23X1B
1B,.#23X3B7B,.#23XDF8E,.//.r#0A..7#23X4ECF,.#23XCBC
B,.#23XCBCB,.#23XFB72,.//.s#0A..7#23X0303,.#23X03FF
,.#23XFF00003,.#23X0303,.//.t#0A..7#23X7FF1,.#23XC0
C0,.#23XC0C0,.#23XFF0007F,.//.u#0A..7#23X1F3F,.#23X
60C0,.#23XC060,.#23X3F1F,.//.v#0A..7#23XFF2,.#23X60
30,.#23X3060,.#23XFF2,.//.w#0A..7#23XC366,.#23X3408
,.#23X0834,.#23X66C3,.//.x#0A..7#23X0306,.#23X0CF8,
.#23XF80C,.#23X0603,.//.y#0A..7#23XE3F3,.#23XDBCB,.
#23XCBC7,.#23XC7C3,.//.z#0A..7#23X002,.#23X002,.#23
X3C7E,.#23XC300,.//.{#0A..7#23X0203,.#23X03DB,.#23X
DB0B,.#23X0F06,.//.|#0A..7#23X00C3,.#23X7E3C,.#23X0
02,.#23X002,.//.}#0A..7#23X0203,.#23X03DB,.#23XDB0B
,.#23X0F06,.//.~#0A..7#23XFF2,.#23XFF2,.#23XFF2,.#23
XFF2..//.rubout#0A#0A1..FOR.z#3D0.TO.3.DO#0A..{.TES
T.((charbase!z.>>.(8+line)).&.1).#3D.1.THEN.wrch('#23
')#0A..42ELSE.wrch('.')#0A#0A..2TEST.((charbase!z.>
>.line).&.1).#3D.1..3THEN.wrch('#23')#0A..42ELSE.wr
ch('.')#0A..}#0A}#0A

######com/fact.b#
GET."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.FOR.i.#3D
.1.TO.5.DO.writef("fact(%n).#3D.%i4*n",.i,.fact(i))
#0A..RESULTIS.0#0A}#0A#0AAND.fact(n).#3D.n#3D0.->.1
,.n*fact(n-1)#0A

######com/failat.b#
/**69#0D#0A**..11(C).Copyright.1982..TRIPOS.Researc
h.Group..12**#0D#0A**..10University.of.Cambridge.Co
mputer.Laboratory..11**#0D#0A**70#0D#0A*..68*#0D#0A
*..68*#0D#0A*..5#23#236..2#23#232..2#23#236..#23#23
..8#23#232..2#23#236..3*#0D#0A*..5#23#236..1#23#234
..1#23#236..#23#23..7#23#234..1#23#236..3*#0D#0A*..
5#23#23..6#23#23..2#23#23..3#23#23..3#23#23..6#23#23
..2#23#23..3#23#23..6*#0D#0A*..5#23#234..2#23#236..
3#23#23..3#23#23..6#23#236..3#23#23..6*#0D#0A*..5#23
#23..6#23#23..2#23#23..3#23#23..3#23#23..6#23#23..2
#23#23..3#23#23..6*#0D#0A*..5#23#23..6#23#23..2#23#23
..3#23#23..3#23#23..6#23#23..2#23#23..3#23#23..6*#0D
#0A*..5#23#23..6#23#23..2#23#23..#23#236..#23#236..
#23#23..2#23#23..3#23#23..6*#0D#0A*..5#23#23..6#23#23
..2#23#23..#23#236..#23#236..#23#23..2#23#23..3#23#23
..6*#0D#0A*..68*#0D#0A**70#0D#0A**..2Author:..Adria
n.Aylward..0311978..2**#0D#0A**..66**#0D#0A**.Modif
ications:..51**#0D#0A**.18.Feb.02..1Martin.Richards
..3Modified.for.Cintpos..13**#0D#0A**..66**#0D#0A**
69/#0D#0A#0D#0ASECTION."FAILAT"#0D#0A#0D#0AGET."lib
hdr"#0D#0A#0D#0ALET.start().#3D.VALOF#0D#0A{.LET.ar
gv.#3D.VEC.10#0D#0A#0D#0A..UNLESS.rdargs("FAILLEVEL
/N",.argv,.10).DO#0D#0A..{.writef("Bad.args.for.FAI
LAT*n")#0D#0A..2RESULTIS.20#0D#0A..}#0D#0A#0D#0A..T
EST.argv!0#0D#0A..THEN.cli_faillevel.:#3D.!(argv!0)
#0D#0A..ELSE.writef("Current.fail.level.is.%n*n",.c
li_faillevel)#0D#0A#0D#0A..RESULTIS.0#0D#0A}#0D#0A

######com/fail.b#
/**69#0D#0A**..11(C).Copyright.1982..TRIPOS.Researc
h.Group..12**#0D#0A**..10University.of.Cambridge.Co
mputer.Laboratory..11**#0D#0A**70#0D#0A*..68*#0D#0A
*..68*#0D#0A*..15#23#236..2#23#232..2#23#236..#23#23
..19*#0D#0A*..15#23#236..1#23#234..1#23#236..#23#23
..19*#0D#0A*..15#23#23..6#23#23..2#23#23..3#23#23..
3#23#23..19*#0D#0A*..15#23#234..2#23#236..3#23#23..
3#23#23..19*#0D#0A*..15#23#23..6#23#23..2#23#23..3#23
#23..3#23#23..19*#0D#0A*..15#23#23..6#23#23..2#23#23
..3#23#23..3#23#23..19*#0D#0A*..15#23#23..6#23#23..
2#23#23..#23#236..#23#236..13*#0D#0A*..15#23#23..6#23
#23..2#23#23..#23#236..#23#236..13*#0D#0A*..68*#0D#0A
**70#0D#0A**..2Author:..Martin.Richards..0302000004
..2**#0D#0A**..66**#0D#0A**.Modifications:..51**#0D
#0A**..66**#0D#0A**69/#0D#0A#0D#0ASECTION."FAIL"#0D
#0A#0D#0AGET."libhdr"#0D#0A#0D#0ALET.start().#3D.VA
LOF#0D#0A{.LET.rc.#3D.0#0D#0A..LET.argv.#3D.VEC.10#0D
#0A#0D#0A..UNLESS.rdargs("RC/N,REASON/N",.argv,.10)
.DO#0D#0A..{.writef("Bad.args.for.FAIL*n")#0D#0A..2
stop(20,0)#0D#0A..}#0D#0A#0D#0A..result2.:#3D.0#0D#0A
..IF.argv!0.DO.rc..4:#3D.!(argv!0)#0D#0A..IF.argv!1
.DO.result2.:#3D.!(argv!1)#0D#0A..RESULTIS.rc#0D#0A
}#0D#0A

######com/fcmpltest.b#
/*#0AThis.is.a.test.program.for.the.BCPL.compiler.a
nd.Cintcode.interpreter#0A#0ALast.updated.by.Martin
.Richards.(c).September.2014#0A#0AThis.version.is.s
imilar.to.cmpltest.but.includes.tests.for#0Athe.sim
ple.floating.point.operations.now.available.in#0Ast
andard.BCPL#2E#0A#0AIt.tests.all.floating.point.ope
rations.including.all.the#0Asys(Sys_flt,.op,.#2E#2E
1).operations,.the.SLCT-OF.operations#2E#0A#0AThe.O
NLY.free.variable.of.this.program.is:.sys..(or.wrch
)#0A*/#0A#0ASECTION."fcmpltest"#0A#0AGET."libhdr"#0A
#0AGLOBAL.{.f:200;.g:401;.h:602#0A..7testno:203;.fa
ilcount:204#0A..7v:205;.testcount:206;.quiet:207;.t
:208#0A..7bitsperword:210;.msb:211;.allones:212..}#0A
#0ASTATIC.{.a#3D10#2E0;.b#3D11#2E0;.c#3D12#2E0;.w#3D
0#2E0..}#0A#0AMANIFEST.{#0A..i0#3D0;.i1#3D1;.i2#3D2
#0A..f0#3D0#2E0;.f1#3D1#2E0;.f2#3D2#2E0#0A}#0A#0ALE
T.wrc(ch).BE.sys(11,ch)..1//wrch(ch)#0A#0AAND.wrs(s
).BE#0A..FOR.i.#3D.1.TO.s%0.DO.wrc(s%i)#0A#0AAND.nl
().BE.wrc('*n')#0A#0AAND.wrd(n,.d).BE.//wrx(n,8)#0A
//1*#0A{.LET.t.#3D.VEC.30#0A..AND.i,.k.#3D.0,.-n#0A
..IF.n<0.DO.d,.k.:#3D.d-1,.n#0A..t!i,.i,.k.:#3D.-(k
.REM.10),.i+1,.k/10.REPEATUNTIL.k#3D0#0A..FOR.j.#3D
.i+1.TO.d.DO.wrc('*s')#0A..IF.n<0.DO.wrc('-')#0A..F
OR.j.#3D.i-1.TO.0.BY.-1.DO.wrc(t!j+'0')#0A}#0A//*/#0A
AND.wrn(n).BE.wrd(n,.0)#0A#0AAND.wrz(n,.d).BE#0A{.I
F.d>1.DO.wrz(n./.10,.d-1)#0A..wrc(n.MOD.10.+.'0')#0A
}#0A#0AAND.wrf(x,.w,.d).BE#0A{.LET.pow.#3D.1002#0A.
.LET.n,.frac.#3D.0,.0#0Ax,.w,.d.:#3D.1234#2E5678,.1
0,.4#0A..//FOR.i.#3D.1.TO.d.DO.x,.pow.:#3D.x.#23*.1
0#2E0,.pow.*.10#0A..TEST.x.#23>.0#2E0#0A..THEN.n.:#3D
.FIX.(x.#23-.0#2E5)#0A..ELSE.n.:#3D.FIX.(x.#23+.0#2E
5)#0A..frac.:#3D.n.MOD.pow#0Awritef("n.#3D.%n.frac#3D
%n.pow#3D%n*n",.n,.frac,.pow)#0A..n.:#3D.n./.pow#0A
#0Awritef("n.#3D.%n.frac#3D%n.pow#3D%n*n",.n,.frac,
.pow)#0A..//TEST.n#3D0.&.frac~#3D0.&.x.#23<.0#0A../
/THEN.{.FOR.i.#3D.1.TO.w.-.d.-.3.DO.wrc('.')#0A..//
..5wrs("-0")#0A..//..3}#0A..//ELSE.{.wrd(n,.w.-.d.-
.1)#0A..//..3}#0A..wrc('#2E')#0A..wrz(frac,.d)#0A}#0A
#0AAND.wrx(n,.d).BE#0A{.IF.d>1.DO.wrx(n>>0004,.d-1)
#0A..wrc((n&15)!TABLE.'0','1','2','3','4','5','6','
7',#0A..17'8','9','A','B','C','D','E','F'.)#0A}#0A#0A
LET.t(x,.y).#3D.VALOF#0A{.testcount.:#3D.testcount.
+.1#0A..wrd(testno,.4)#0A..wrc('.')#0A..wrd(x,.8)#0A
..wrc('.')#0A..wrd(x,.10)#0A..wrc('.')#0A..TEST.x#3D
y#0A..THEN.wrs("OK")#0A..ELSE.{.wrs("FAILED..It.sho
uld.be.")#0A..7wrx(y,.8)#0A..7wrc('.')#0A..7wrn(y)#0A
..7failcount.:#3D.failcount.+.1#0A//abort(1001)#0A.
.5}#0A..nl()#0A..testno.:#3D.testno.+.1#0A..RESULTI
S.y#0A}#0A#0ALET.ft(x,.y).#3D.VALOF#0A{.testcount.:
#3D.testcount.+.1#0A..wrd(testno,.4)#0A..wrc('.')#0A
..wrx(x,.8)#0A..wrc('.')#0A..wrd(FIX.x,.8)#0A..wrc(
'#2E')#0A..wrn((FIX.(x.#23*.10#2E0)).MOD.10)#0A..wr
c('.')#0A..TEST.x.#23#3D.y#0A..THEN.wrs("OK")#0A..E
LSE.{.wrs("FAILED..It.should.be.")#0A..7wrx(y,.8)#0A
..7wrc('.')#0A..7wrn(FIX.y)#0A..7wrc('#2E')#0A..7wr
n((FIX.(y.#23*.10#2E0)).MOD.10)#0A..7failcount.:#3D
.failcount.+.1#0A//abort(1001)#0A..5}#0A..nl()#0A..
testno.:#3D.testno.+.1#0A..RESULTIS.y#0A}#0A#0ALET.
t1(a,b,c,d,e,f,g).#3D.t(a+b+c+d+e+f,.g)#0A#0ALET.st
art(parm).#3D.VALOF#0A{.LET.ww.#3D.65#0A..LET.v1.#3D
.VEC.200#0A..AND.v2.#3D.VEC.200#0A..wrs("*nCmpltest
.running.on.a.")#0A..bitsperword,.msb,.allones.:#3D
.1,.1,.1#0A..UNTIL.(msb<<0001)#3D0.DO#0A..2bitsperw
ord,.msb,.allones.:#3D.bitsperword+1,.msb<<0001,.al
lones<<0001.|.1#0A..TEST.(@ww)%0#3D65#0A..THEN.wrs(
"little")#0A..ELSE.wrs("big")#0A..wrs(".ender.machi
ne*n")#0A..wrs("The.BCPL.word.is.")#0A..wrd(bitsper
word,.0)#0A..wrs(".bits.long*n*n*n")#0A#0A..#0A..//
wrz(12345678,.4);.nl()#0A#0A..//wrf(12#2E34,.10,.4)
;.nl()#0A..//wrf(#23-12#2E34,.10,.4);.nl()#0A..//wr
f(0#2E1234,.10,.4);.nl()#0A..//wrf(#23-0#2E1234,.10
,.4);.nl()#0A//RESULTIS.0#0A//abort(1001)..2#0A..te
ster(0#2E0,.1#2E0,.2#2E0,.v1,.v2)#0A#0A//{.LET.n.#3D
.1..1//.special.test.for.the.<<.and.>>.operators#0A
//..FOR.i.#3D.-5.TO.80.DO.writef("%i4.%xP*n",.i,.1<
<i)#0A//..FOR.i.#3D.-5.TO.80.DO.writef("%i4.%xP*n",
.i,.msb>>i)#0A//}#0A..2#0A..RESULTIS.0#0A}#0A#0AAND
.tester(x,.y,.z,.v1,.v2).BE#0A{.LET.n0,.n1,.n2,.n3,
.n4.#3D.0#2E0,.1#2E0,.2#2E0,.3#2E0,.4#2E0#0A..LET.n
5,.n6,.n7,.n8,.n9.#3D.5#2E0,.6#2E0,.7#2E0,.8#2E0,.9
#2E0#0A..LET.oct1770005.#3D.#231770005#0A#0A//..wrs
("*n.Floating.point.cgtester.entered*N")#0A#0A//..F
IRST.INITIALIZE.CERTAIN.VARIABLES#0A#0A..f,.g,.h.:#3D
.100#2E0,.101#2E0,.102#2E0#0A..testno,.testcount,.f
ailcount.:#3D.0#2E0,.0#2E0,.0#2E0#0A..v,.w.:#3D.v1,
.v2#0A#0A..FOR.i.#3D.0.TO.200.DO.v!i,.w!i.:#3D.1001
#2E0.#23+.FLOAT.i,.1002#2E0.#23+.FLOAT.i#0A#0A..qui
et.:#3D.FALSE#0A#0A//..TEST.SIMPLE.VARIABLES.AND.EX
PRESSIONS#0A#0A..testno.:#3D.1#0A#0A..ft(a#23+b#23+
c,.33#2E0)..6//.1#0A..ft(f#23+g#23+h,.303#2E0)#0A..
ft(x#23+y#23+z,.3#2E0)#0A#0A..ft(123#2E0#23+321#2E0
#23-400#2E0,.44#2E0)..//.4#0A#0A..testno.:#3D.5#0A#0A
..t(x.#23#3D.0#2E0,.TRUE)..5//.5#0A..t(y.#23#3D.0#2E
0,.FALSE)#0A..ft(!(@y+i0),.1#2E0)#0A..ft(!(@b+i0),.
11#2E0)#0A..ft(!(@g+i0),.101#2E0)#0A#0A..testno.:#3D
.10#0A..x,.a,.f.:#3D.5#2E0,.15#2E0,.105#2E0#0A..ft(
x,.5#2E0)..10//.10#0A..ft(a,.15#2E0)#0A..ft(f,.105#2E
0)#0A#0A..v!1,.v!2.:#3D.1234#2E0,.5678#2E0#0A..ft(v
!1,.1234#2E0)..5//.13#0A..ft(v!i2,.5678#2E0)#0A#0A.
.ft(x.#23*.a,.75#2E0)..7//..00015#0A..ft(1#2E0.#23*
.x.#23+.2#2E0.#23*.y.#23+.3#2E0.#23*.z.#23+.f.#23*.
4#2E0,.433#2E0)#0A#0A..testno.:#3D.17#0A#0A..ft(x.#23
*.a.#23+.a.#23*.x,.150#2E0)..//.17#0A#0A..testno.:#3D
.18#0A#0A..ft(100#2E0.#23/.(a.#23-.a.#23+.2#2E0),.5
0#2E0).//..00018#0A..ft(a.#23/.x,.3#2E0)#0A..ft(a.#23
/.#23-.x,.#23-.3#2E0)..//.20#0A..ft((#23-.a).#23/.x
,.#23-.3#2E0)#0A..ft((#23-a)#23/(#23-x),.3#2E0)#0A.
.ft((a#23+a).#23/.a,.2#2E0)#0A..ft((a.#23*.x).#23/.
(x.#23*.a),.1#2E0)#0A..ft((a.#23+.b).#23*.(x.#23+.y
).#23*.123#2E0.#23/.(6#2E0.#23*.123#2E0),.26#2E0)#0A
#0A..ft(#23-f,.#23-105#2E0)..5//..00026#0A#0A..t(FI
X.110000#2E534,.111)#0A..t(FIX.(#23-110000#2E534),.
-111)#0A#0A..testno.:#3D.30#0A#0A..f.:#3D.105#2E0#0A
..t(f.#23#3D.105#2E0,.TRUE)..1//.30#0A..t(f#23~#3D.
105#2E0,.FALSE)#0A..t(f.#23<.105#2E0,.FALSE)#0A..t(
f#23>#3D.105#2E0,.TRUE)#0A..t(f.#23>.105#2E0,.FALSE
)#0A..t(f#23<#3D.105#2E0,.TRUE)#0A#0A..f.:#3D.104#2E
0#0A..t(f.#23#3D.105#2E0,.FALSE)..//.36#0A..t(f#23~
#3D.105#2E0,.TRUE)#0A..t(f.#23<.105#2E0,.TRUE)#0A..
t(f#23>#3D.105#2E0,.FALSE)#0A..t(f.#23>.105#2E0,.FA
LSE)#0A..t(f#23<#3D.105#2E0,.TRUE)#0A#0A..f.:#3D.0#2E
0#0A..testno.:#3D.42#0A#0A..t(f.#23#3D.0#2E0,.TRUE)
..2//.42#0A..t(f#23~#3D.0#2E0,.FALSE)#0A..t(f.#23<.
0#2E0,.FALSE)#0A..t(f#23>#3D.0#2E0,.TRUE)#0A..t(f.#23
>.0#2E0,.FALSE)#0A..t(f#23<#3D.0#2E0,.TRUE)#0A#0A..
f.:#3D.1#2E0#0A..t(f.#23#3D.0#2E0,.FALSE)..1//.48#0A
..t(f#23~#3D.0#2E0,.TRUE)#0A#0A..testno.:#3D.50#0A#0A
..t(f.#23<.0#2E0,.FALSE)#0A..t(f#23>#3D.0#2E0,.TRUE
)#0A..t(f.#23>.0#2E0,.TRUE)#0A..t(f#23<#3D.0#2E0,.F
ALSE)#0A#0A..testno.:#3D.60#0A#0A..t(oct1770005<<00
03,.#2317700050)..//.60#0A..t(oct1770005>>0003,.#23
177)#0A..t(oct1770005<<i2+1,.#2317700050)#0A..t(oct
1770005>>i2+1,.#23177)#0A#0A..{.LET.b1100000.#3D.#23
b1100000#0A..2LET.b1010.#3D.#23b1010#0A..2LET.yes,.
no.#3D.TRUE,.FALSE#0A#0A..2testno.:#3D.70#0A#0A..2t
(b1100000&#23B1010,.#23B1001)..2//..00070#0A..2t(b1
100000.|.#23B1010,.#23B110010)#0A..2t((b1100000.EQV
..1#23B1010).&.#23B113,.#23B11000000001)#0A..2t(b11
00000.NEQV..#23B1010,.#23B0110000)#0A#0A..2t(NOT.ye
s,.no)..7//.74#0A..2t(NOT.no,.yes)#0A..2t(NOT(b1100
000.EQV.-b1010),.b1100000.NEQV.-b1010)#0A..}#0A#0A.
.testno.:#3D.80#0A..f.:#3D.105#0A..t(-f,.-105)..13/
/.80#0A#0A..testno.:#3D.96#0A#0A..a.:#3D.TRUE#0A..b
.:#3D.FALSE#0A#0A..IF.a.DO.x.:#3D.16#0A..t(x,.16)..
16//.96#0A..x.:#3D.16#0A#0A..IF.b.DO.x.:#3D.15#0A..
t(x,.16)..16//.97#0A..x.:#3D.15#0A#0A..{.LET.w.#3D.
VEC.20#0A..2a.:#3D.l1#0A..2GOTO.a#0Al2:.wrs("GOTO.E
RROR*N")#0A..2failcount.:#3D.failcount+1#0A..}#0A#0A
l1:#0A..a.:#3D.VALOF.RESULTIS.11#0A..t(a,.11)..16//
.98#0A#0A..testno.:#3D.100..//.TEST.SIMULATED.STACK
.ROUTINES#0A#0A..{.LET.v1.#3D.VEC.1#0A..2v1!0,.v1!1
.:#3D.-1,.-2#0A..2{.LET.v2.#3D.VEC.10#0A..4FOR.i.#3D
.0.TO.10.DO.v2!i.:#3D.-i#0A..4t(v2!5,.-5)..9//..000
101#0A..2}#0A..2t(v1!1,.-2)..11//..000102#0A..}#0A#0A
..x.:#3D.x.+.t(x,15,.t(f,.105),.t(a,.11)).-.15..1//
.103-105#0A..t(x,.15)..35//.106#0A#0A..x.:#3D.x+1#0A
..t(x,.16)..1//.107#0A..x.:#3D.x-1#0A..t(x,.15)..1/
/.108#0A..x.:#3D.x+7#0A..t(x,22)..2//.109#0A..x.:#3D
.x-22#0A..t(x,.0)..2//.110000#0A..x.:#3D.x+15#0A..t
(x,.15)..1//.111#0A..x.:#3D.x.+.f#0A..t(x,.120)..//
.110002#0A..x.:#3D.1#0A#0A..testno.:#3D.130#0A..f.:
#3D.105#0A..t(f.#3D.105.->.1,.2,.1)..1//.130#0A..t(
f~#3D.105.->.1,.2,.2)#0A..t(f.<.105.->.1,.2,.2)#0A.
.t(f>#3D.105.->.1,.2,.1)#0A..t(f.>.105.->.1,.2,.2)#0A
..t(f<#3D.105.->.1,.2,.1)#0A#0A..f.:#3D.104#0A..t(f
.#3D.105.->.1,.2,.2)..//.136#0A..t(f~#3D.105.->.1,.
2,.1)#0A..t(f.<.105.->.1,.2,.1)#0A..t(f>#3D.105.->.
1,.2,.2)#0A..t(f.>.105.->.1,.2,.2)#0A..t(f<#3D.105.
->.1,.2,.1)#0A#0A..f.:#3D.0#0A..t(f.#3D.0.->.1,.2,.
1)..2//.142#0A..t(f~#3D.0.->.1,.2,.2)#0A..t(f.<.0.-
>.1,.2,.2)#0A..t(f>#3D.0.->.1,.2,.1)#0A..t(f.>.0.->
.1,.2,.2)#0A..t(f<#3D.0.->.1,.2,.1)#0A..f.:#3D.1#0A
..t(f.#3D.0.->.1,.2,.2)..1//.148#0A..t(f~#3D.0.->.1
,.2,.1)#0A..t(f.<.0.->.1,.2,.2)#0A..t(f>#3D.0.->.1,
.2,.1)#0A..t(f.>.0.->.1,.2,.1)#0A..t(f<#3D.0.->.1,.
2,.2)#0A#0A..testno.:#3D.300..//.TEST.EXPRESSION.OP
ERATORS#0A#0A..f.:#3D.105#2E0#0A..ft((0002#2E0#23+3
#2E0)#23+f#23+6#2E0,110006#2E0)..1//.300#0A..ft(f#23
+2#2E0#23+3#2E0#23+6#2E0,110006#2E0)#0A..ft(6#2E0.#23
+.3#2E0.#23+.2#2E0.#23+.f,.110006#2E0)#0A..ft(f#23-
104#2E0,.1#2E0)#0A..t((x#23+2#2E0)#23#3D(x#23+2#2E0
)->99,98,.99)#0A#0A..testno.:#3D.305#0A#0A..t(f.#23
<.f#23+1#2E0.->.21,22,.21)..2//.305#0A#0A..testno.:
#3D.306#0A#0A..t(f.#23>.f#23+1#2E0.->31,32,.32)..2/
/.306#0A..t(f.#23<#3D.105#2E0.->41,42,.41)#0A..t(f.
#23>#3D.105#2E0.->51,52,.51)#0A#0A..testno.:#3D.400
..//.TEST.REGISTER.ALLOCATION.ETC#2E#0A#0A..testno.
:#3D.3001#0A..testflt()#0A#0A..nl()#0A..wrn(testcou
nt)#0A..wrs(".TESTS.COMPLETED,.")#0A..wrn(failcount
)#0A..wrs(".FAILURE(S)*N")#0A}#0A#0AAND.testflt().B
E#0A{.LET.x,.y.#3D.0,0#0A#0A..t(FIX.#23-(FLOAT.1234
56),.FIX.FLOAT.-123456).//.3001#0A..t(#23-.(FLOAT.1
23456),.FLOAT.-123456).#0A..t(FIX(#23ABS.(FLOAT.-12
3456)),.FIX(FLOAT.123456)).#0A..t(#23ABS.(FLOAT.-1)
,.FLOAT.1).#0A..t(FLOAT.123456.#23*.FLOAT.2,.FLOAT.
246912).#0A#0A..testno.:#3D.3000005#0A#0A..t(FLOAT.
246912.#23/.FLOAT.2,..3FLOAT.123456)..2//.3000005#0A
..t(FLOAT..00012345.#23+.FLOAT.54321,.FLOAT.663).#0A
..t(FLOAT..00012345.#23-.FLOAT.1234,..FLOAT.113).#0A
#0A..UNLESS.sys(Sys_flt,.fl_avail)#3D-1.DO#0A..{.wr
s("sys(Sys_flt,.#2E#2E1).not.available*n")#0A..}#0A
#0A..t(sys(Sys_flt,.fl_mk,.12345,.-1),.1234#2E5)#0A
#0A..testno.:#3D.3010#0A#0A..x.:#3D.sys(Sys_flt,.fl
_unmk,.1234#2E5)#0A..y.:#3D.result2#0A#0A//wrs("x#3D
");.wrn(x);.wrs(".y#3D");.wrn(y);.nl()#0A#0A..t(x,.
12345002)..31//.3010#0A..t(y,.-5)#0A#0A..x.:#3D.sys
(Sys_flt,.fl_unmk,.#23-1234#2E5)#0A..y.:#3D.result2
#0A..t(x,.-12345002)#0A..t(y,.-5)#0A#0A..testno.:#3D
.3014#0A#0A..x.:#3D.sys(Sys_flt,.fl_float,.123456);
.t(x,.FLOAT.123456).//.3014#0A..x.:#3D.sys(Sys_flt,
.fl_fix,.12345#2E6);.t(x,.FIX.12345#2E6)#0A..x.:#3D
.sys(Sys_flt,.fl_abs,.12345#2E6);.t(x,.#23ABS.12345
#2E6)#0A..x.:#3D.sys(Sys_flt,.fl_abs,.#23-12345#2E6
);.t(x,.#23ABS.#23-12345#2E6)#0A..x.:#3D.sys(Sys_fl
t,.fl_mul,.12#2E5,.43#2E5);.t(x,.12#2E5.#23*.43#2E5
)#0A..x.:#3D.sys(Sys_flt,.fl_div,.12#2E5,.#23-43#2E
5);.t(x,.12#2E5.#23/.#23-43#2E5)#0A#0A..testno.:#3D
.3020#0A#0A..x.:#3D.sys(Sys_flt,.fl_add,.12#2E5,.43
#2E5);.t(x,.12#2E5.#23+.43#2E5).//.3020#0A..x.:#3D.
sys(Sys_flt,.fl_sub,.12#2E5,.43#2E5);.t(x,.12#2E5.#23
-.43#2E5)#0A..x.:#3D.sys(Sys_flt,.fl_pos,.#23-12345
#2E6);.t(x,.#23+.#23-12345#2E6)#0A..x.:#3D.sys(Sys_
flt,.fl_neg,.#23-12345#2E6);.t(x,.#23-.#23-12345#2E
6)#0A#0A..testno.:#3D.3030#0A#0A..FOR.a.#3D.-2.TO.2
.FOR.b.#3D.-2.TO.2.DO#0A..{.x,.y.:#3D.FLOAT.a,.FLOA
T.b#0A..2//wrn(testno,10);.nl()#0A..2t(sys(Sys_flt,
.fl_eq,.x,.y),.x.#23#3D..y)#0A..2t(sys(Sys_flt,.fl_
ne,.x,.y),.x.#23~#3D.y)#0A..2t(sys(Sys_flt,.fl_ls,.
x,.y),.x.#23<..y)#0A..2t(sys(Sys_flt,.fl_gr,.x,.y),
.x.#23>..y)#0A..2t(sys(Sys_flt,.fl_le,.x,.y),.x.#23
<#3D.y)#0A..2t(sys(Sys_flt,.fl_ge,.x,.y),.x.#23>#3D
.y)#0A..}#0A#0A..testno.:#3D.3200#0A#0A..t(FIX(sys(
Sys_flt,.fl_acos,.0#2E5)#23*1004#2E0),.1047198).//.
3200#0A..t(FIX(sys(Sys_flt,.fl_asin,.0#2E5)#23*1004
#2E0),..000523599)#0A..t(FIX(sys(Sys_flt,.fl_atan,.
0#2E5)#23*1004#2E0),..000463648)#0A..t(FIX(sys(Sys_
flt,.fl_atan2,.0#2E5,.0#2E4)#23*1004#2E0),..0028960
55)#0A..t(FIX(sys(Sys_flt,.fl_cos,.0#2E5)#23*1004#2E
0),..001877000583)#0A#0A..testno.:#3D.3205#0A#0A..t
(FIX(sys(Sys_flt,.fl_sin,..0000#2E5)#23*1004#2E0),.
.000479426).//.3205#0A..t(FIX(sys(Sys_flt,.fl_tan,.
.0000#2E5)#23*1004#2E0.#23+.0#2E1),..000546303).//?
?2#0A..t(FIX(sys(Sys_flt,.fl_cosh,.0#2E5)#23*1004#2E
0),.1100027626)#0A..t(FIX(sys(Sys_flt,.fl_sinh,.0#2E
5)#23*1004#2E0),..000521095).//?#0A..t(FIX(sys(Sys_
flt,.fl_tanh,.0#2E5)#23*1004#2E0),..000462110007)#0A
..t(FIX(sys(Sys_flt,.fl_exp,..0001#2E0)#23*1004#2E0
),.2718282)#0A#0A..x.:#3D.sys(Sys_flt,.fl_frexp,.10
23#2E0)#0A..y.:#3D.result2#0A..t(x,.1023#2E0#23/102
4#2E0)#0A..t(y,.10)#0A#0A..x.:#3D.sys(Sys_flt,.fl_l
dexp,.1023#2E0#23/1024#2E0,.10)#0A..t(x,.1023#2E0)#0A
#0A..t(FIX(sys(Sys_flt,.fl_log,.0#2E5)#23*1004#2E0)
,..2-693147)#0A..t(FIX(sys(Sys_flt,.fl_log10,.0#2E5
)#23*1004#2E0),..-301030)#0A#0A..x.:#3D.sys(Sys_flt
,.fl_modf,.123#2E25)#0A..y.:#3D.result2#0A..t(x,.0#2E
25)#0A..t(y,.123)#0A#0A..t(FIX(sys(Sys_flt,.fl_pow,
.2#2E0,.0#2E5)#23*1004#2E0),..0001414214)#0A..t(FIX
(sys(Sys_flt,.fl_sqrt,.2#2E0)#23*1004#2E0),..000141
4214)#0A..t(FIX(sys(Sys_flt,.fl_ceil,.2#2E5)#23*100
4#2E0),..0003004)#0A..t(FIX(sys(Sys_flt,.fl_ceil,.#23
-2#2E5)#23*1004#2E0),..-2004)#0A..t(FIX(sys(Sys_flt
,.fl_floor,.2#2E5)#23*1004#2E0),.2004)#0A..t(FIX(sy
s(Sys_flt,.fl_floor,.#23-2#2E5)#23*1004#2E0),.-3004
)#0A#0A..t(FIX(sys(Sys_flt,.fl_fmod,.100#2E25,.25#2E
0)#23*1004#2E0),..00025002)#0A#0A..testno.:#3D.4001
#0A..t(sys(Sys_flt,.fl_F2N,.1_001,.1#2E234),..0001_
234)#0A..t(sys(Sys_flt,.fl_N2F,.1_001,.1_234),..000
1#2E234)#0A}#0A#0A1

######com/getlogname.b#
/*#0AThis.command.outputs.the.value.of.a.given.logi
cal.variable.name#2E#0AIf.none.is.given.it.lists.th
e.names.and.values.of.all.logical.variables#2E#0A#0A
0003/5/04.Initial.implementation#2E#0A*/#0A#0ASECTI
ON."getlogname"#0A#0AGET."libhdr"#0A#0ALET.start().
#3D.VALOF#0A{.LET.argv.#3D.VEC.50#0A..LET.value.#3D
.0#0A#0A..UNLESS.rdargs("NAME",.argv,.50).DO#0A..{.
writef("Bad.arguments.for.getlogname*n")#0A..2RESUL
TIS.20#0A..}#0A#0A..UNLESS.argv!0.DO..24//.NAME#0A.
.{.LET.p.#3D.rootnode!rtn_envlist#0A..2WHILE.p.DO#0A
..2{.writef("%tP.#3D.%s*n",.p!1,.p!2)#0A..4p.:#3D.!
p#0A..2}#0A..2RETURN#0A..}#0A#0A..value.:#3D.getlog
name(argv!0)#0A..UNLESS.value.DO.value.:#3D."<UNSET
>"#0A..writef("%s.#3D.%s*n",.argv!0,.value)#0A..RES
ULTIS.0#0A}#0A..#0A..2#0A

######com/graphdemo.b#
GET."libhdr"#0A#0A//.Insert.the.graphics.library#0A
MANIFEST.{.graphicsgbase#3D400.}#0A#0AGET."graphics
"#0AGET."graphics#2Eb"#0A#0A1LET.start().#3D.VALOF#0A
{.LET.stdout.#3D.output()#0A..LET.xsize,.ysize.#3D.
1001,.700#0A#0A..UNLESS.opengraphics(xsize,.ysize).
DO#0A..{.writef("Unable.to.open.the.graphics.librar
y*n")#0A..2GOTO.fin#0A..}#0A#0A..FOR.x.#3D.1.TO.xsi
ze-2.DO#0A..{.wrpixel33(x,.1,.col_r)#0A..2wrpixel33
(x,.ysize-2,.col_r)#0A..2moveto(x,.4)#0A..2plotcolo
ur.:#3D.255*x/xsize#0A..2drawby(0,.20)..2#0A..}#0A#0A
..FOR.y.#3D.1.TO.ysize-2.DO#0A..{.wrpixel33(1,.y,.c
ol_r)#0A..2wrpixel33(xsize-2,.y,.col_r)#0A..}#0A#0A
..moveto(10,.ysize-20)#0A..plotcolour.:#3D.col_blac
k#0A..FOR.ch.#3D.33.TO.127.DO#0A..{.IF.ch#3D'A'.|.c
h#3D'0'.|.ch#3D'a'.DO.plotch('*n')#0A..2plotch(ch)#0A
..}#0A#0A..plotcolour.:#3D.col_rb#0A..fillcircle(30
0,.200,.65)#0A..plotcolour.:#3D.col_b#0A..drawcircl
e(350,.250,.65)#0A#0A..plotcolour.:#3D.col_rb#0A..f
illrect(150,.40,.200,.140)#0A..plotcolour.:#3D.col_
gb#0A..drawrect(180,.50,.240,.110000)#0A#0A..plotco
lour.:#3D.col_b#0A..fillrndrect(350,.40,.400,.140,.
10)#0A..plotcolour.:#3D.col_g#0A..drawrndrect(380,.
50,.440000,.110000,.11)#0A#0A..plotcolour.:#3D.col_
r#0A..fillrndrect(580,.60,.660000,.230,.120)#0A..pl
otcolour.:#3D.col_g#0A..drawrndrect(620,.70,.790,..
000110000,.130)#0A#0A..moveto(200,.150)#0A..plotcol
our.:#3D.col_g#0A..drawby(-10,..00040)#0A..drawby(-
40,..00010)#0A..drawby(-40,.-10)#0A..drawby(-10,.-4
0)#0A..drawby(.10,.-40)#0A..drawby(.40,.-10)#0A..dr
awby(.40,..00010)#0A..drawby(.10,..00040)#0A..plotc
olour.:#3D.col_r#0A..drawby(50,.40)#0A..plotstr("He
llo.There")#0A..moveby(-9*11,.-13)#0A..plotstr("goo
d.day!")#0A#0A..{.//.Plot.a.trajectory#0A..2LET.g.#3D
.25_001_001#0A..2LET.xc,.yc.#3D.700,.300.//.The.cen
tre#0A..2LET.x,.y.#3D.700,.100#0A..2LET.xdot,.ydot.
#3D.12_001,.0_001#0A..2plotcolour.:#3D.col_r#0A..2f
illcircle(xc,.yc,.20)#0A..2FOR.i.#3D.1.TO.185.DO.#0A
..2{.LET.dx.#3D.x-xc#0A..4LET.dy.#3D.y-yc#0A..4LET.
dist.#3D.ABS.dx.+.ABS.dy#0A..4LET.d2.#3D.dx*dx.+.dy
*dy#0A..4wrpixel33(x,.y,.col_black)#0A..4xdot.:#3D.
xdot*990006/1001.-.muldiv(g,.dx,.dist*d2)#0A..4ydot
.:#3D.ydot*990006/1001.-.muldiv(g,.dy,.dist*d2)#0A.
.4x.:#3D.x.+.xdot/1001#0A..4y.:#3D.y.+.ydot/1001#0A
..2}#0A..}#0A#0A..wrgraph("pic#2Ebmp")#0A#0Afin:#0A
..closegraphics()#0A#0A..RESULTIS.0#0A}#0A

######com/hello.b#
GET."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.writef(
"Hello*n")#0A..RESULTIS.0#0A}#0A

######com/hex-bin.b#
//.This.is.a.program.convert.a.hex.file.to.back.to.
a.binary.file#2E#0A//.It.is.the.inverse.of.bin2hex#2E
b#0A#0A//.Implemented.by.Martin.Richards.(c).July.2
000002#0A#0A//.Usage:#0A#0A//.hex2bin.filename.[[TO
].tofile]#0A#0A/*#0AIt.will.convert.the.file:#0A#0A
00041.42.43.44.45.46.47.48.49.4A.4B.4C.4D.4E.4F.50#0A
51.52.53.54.55.56.57.58.59.5A.0A.31.32.33.34.35#0A3
6.37.38.39.30.0A#0A#0Ato:#0A#0AABCDEFGHIJKLMNOPQRST
UVWXYZ#0A1234567890#0A*/#0A#0AGET."libhdr"#0A#0AGLO
BAL.{#0A.eof:.ug#0A.sysin#0A.sysout#0A.fromname#0A.
toname#0A.fromstream#0A.tostream#0A.count#0A}#0A#0A
LET.start().#3D.VALOF#0A{.LET.argv..2#3D.VEC.50#0A.
.sysin..4:#3D.input()#0A..sysout..3:#3D.output()#0A
..fromname..1:#3D.0#0A..toname..3:#3D."JUNK"#0A..fr
omstream.:#3D.0#0A..tostream..1:#3D.0#0A..count..4:
#3D.0#0A#0A..UNLESS.rdargs("FROM/A,TO/K",.argv,.50)
.DO#0A..{.writes("bad.arguments.for.hex2b*n")#0A..2
stop(20)#0A..}#0A#0A..fromname.:#3D.argv!0..20//.FR
OM#0A..IF.argv!1.DO.toname..1:#3D.argv!1..7//.TO#0A
.#0A..fromstream.:#3D.findinput(fromname)#0A..UNLES
S.fromstream.DO#0A..{.writef("can't.open.%s*n",.fro
mname)#0A..2stop(20)#0A..}#0A#0A..tostream.:#3D.fin
doutput(toname)#0A..UNLESS.tostream.DO#0A..{.writef
("can't.open.%s*n",.toname)#0A..2endread()#0A..2sto
p(20)#0A..}#0A..selectoutput(tostream)#0A#0A..selec
tinput(fromstream)#0A#0A..{.LET.byte.#3D.rdhexbyte(
)#0A..2IF.byte<0.BREAK#0A..2wrch(byte)#0A..2count.:
#3D.count+1#0A..}.REPEAT#0A#0A..endread()#0A#0A..UN
LESS.sysout#3Dtostream.DO.endwrite()#0A#0A..selecto
utput(sysout)#0A..writef("%n.bytes.written.to.file.
*"%s*"*n",.count,.toname)#0A..RESULTIS.0#0A}#0A#0AA
ND.rdhexbyte().#3D.VALOF#0A{.LET.a,.b.#3D.0,.0#0A..
a.:#3D.rdch().REPEATWHILE.a#3D'.'.|.a#3D'*n'#0A..IF
.a#3Dendstreamch.RESULTIS.-1#0A..a.:#3D.value(a)#0A
..UNLESS.0<#3Da<#3D15.DO.abort(991)#0A..b.:#3D.rdch
()#0A..IF.b#3Dendstreamch.RESULTIS.-1#0A..b.:#3D.va
lue(b)#0A..UNLESS.0<#3Db<#3D15.abort(991)#0A#0A..RE
SULTIS.(a<<0004).|.b#0A}#0A#0AAND.value(ch).#3D.'0'
<#3Dch<#3D'9'.->.ch.-.'0',#0A..14'A'<#3Dch<#3D'F'.-
>.ch.-.'A'.+.10,#0A..14'a'<#3Dch<#3D'f'.->.ch.-.'a'
.+.10,#0A..014100#0A

######com/hexdump.b#
//.This.is.a.program.to.dump.files.in.hex.and.chara
cter.form#2E#0A//.Implemented.by.Martin.Richards.(c
).June.2000002#0A#0A//.Usage:#0A#0A//.hexdump.filen
ame.[[n].number].[[p].recno].rl.reclen#0A//.hexdump
.filename.[[n].number].[[p].recno].rlb.reclenb#0A//
..3recno.is.the.number.of.the.first.record.to.be.du
mped#0A//..3number.is.the.number.of.records.to.be.d
umped#0A//..3reclen..is.the.record.length.in.words#0A
//..3reclenb.is.the.record.length.in.bytes#0A#0A//.
hexdump.filename.[[n].bytes].[[p].offset]#0A//..3of
fset.is.the.offset.in.the.file.of.the.first.byte.to
.be.dumped#0A//..3bytes..is.the.number.of.bytes.to.
dump#0A#0AGET."libhdr"#0A#0AGLOBAL.{.eof:.ug.}#0A#0A
LET.start().#3D.VALOF#0A{.LET.argv..5#3D.VEC.50#0A.
.LET.sysin..4#3D.input()#0A..LET.sysout..3#3D.outpu
t()#0A..LET.fromname..1#3D.0#0A..LET.toname..3#3D.0
#0A..LET.fromstream.#3D.0#0A..LET.tostream..1#3D.0#0A
..LET.pos,.n,.reclen.#3D.0,.1004,.0#0A#0A..UNLESS.r
dargs("FROM/A,N,P,RL/K,RLB/K,TO/K",.argv,.50).DO#0A
..{.writes("bad.arguments.for.RECDUMP*n")#0A..2stop
(20)#0A..}#0A#0A..fromname.:#3D.argv!0..40//.FROM#0A
..IF.argv!1.&.string_to_number(argv!1).DO.n..4:#3D.
result2..1//.N#0A..IF.argv!2.&.string_to_number(arg
v!2).DO.pos..2:#3D.result2..1//.P#0A..IF.argv!3.&.s
tring_to_number(argv!3).DO.reclen.:#3D.result2*4.//
.RL#0A..IF.argv!4.&.string_to_number(argv!4).DO.rec
len.:#3D.result2..1//.RLB#0A..toname..1:#3D.argv!5.
.40//.TO#0A.#0A..fromstream.:#3D.findinput(fromname
)#0A..UNLESS.fromstream.DO#0A..{.writef("can't.open
.%s*n",.fromname)#0A..2stop(20)#0A..}#0A#0A..IF.ton
ame.DO#0A..{.tostream.:#3D.findoutput(toname)#0A..2
UNLESS.tostream.DO#0A..2{.writef("can't.open.%s*n",
.toname)#0A..4endread()#0A..4stop(20)#0A..2}#0A..2s
electoutput(tostream)#0A..}#0A#0A1..selectinput(fro
mstream)#0A..eof.:#3D.FALSE#0A#0A..TEST.reclen#0A..
THEN.writef("Dump.of.%s..records.%n.to.%n..reclen#3D
%n*n*n",#0A..12fromname,.pos,.pos+n-1,.reclen)#0A..
ELSE.writef("Dump.of.%s..from.%n.to.%n*n*n",#0A..12
fromname,.pos,.pos+n-1)#0A#0A..dump(pos,.n,.reclen)
#0A..IF.eof.DO.writef("End.of.file*n")#0A#0A..selec
tinput(fromstream);.endread()#0A..//endstream(froms
tream)#0A#0A//..UNLESS.sysout#3Dtostream.DO.endstre
am(tostream)#0A..UNLESS.tostream#3D0.|.sysout#3Dtos
tream.DO#0A..{.selectoutput(tostream)#0A..2endwrite
()#0A..}#0A#0A..RESULTIS.0#0A}#0A#0AAND.dump(pos,.n
,.reclen).BE#0A{.//.reclen.is.0.or.the.record.lengt
h.in.bytes#0A..//.reclen>0.dump.n.records.from.byte
.record.number.pos#0A..//.reclen#3D0.dump.n.bytes.f
rom.byte.offset.pos#0A..LET.offset.#3D.pos#0A..IF.r
eclen.DO.offset.:#3D.pos*reclen#0A#0A..//.Get.to.fi
rst.byte.to.dump#0A..FOR.i.#3D.1.TO.offset.IF.binrd
ch()#3Dendstreamch.DO#0A..{.eof.:#3D.TRUE#0A..2BREA
K#0A..}#0A#0A..TEST.reclen#0A..THEN.FOR.recno.#3D.p
os.TO.pos+n-1.DO#0A..5{.dumphex(recno,.?,.reclen)#0A
..7newline()#0A..7IF.eof.BREAK#0A..5}#0A..ELSE.dump
hex(pos,.n,.0)#0A}#0A#0AAND.dumphex(pos,.n,.reclen)
.BE#0A//.reclen>0..1pos.is.the.record.number#0A//..
10n..1is.not.used#0A//.reclen#3D0..1pos.is.the.byte
.offset.in.the.file#0A//..10n..1is.the.number.of.by
tes.to.dump#0A{.LET.word.#3D.#23x0000110203#0A..LET
.xbits.#3D.(@word)%0.//.#3D0.for.bigender,..#3D3.fo
r.little.ender#0A..LET.count.#3D.0..7//.count.of.by
tes.read.so.far#0A..IF.reclen.DO.n.:#3D.reclen#0A#0A
..{.LET.v.#3D.VEC.15#0A..2LET.oldcount.#3D.count#0A
..2LET.k.#3D.n.-.count..1//.bytes.remaining.to.be.r
ead#0A..2FOR.i.#3D.0.TO.15.DO.v!i.:#3D.-1#0A#0A..2U
NLESS.k>0.RETURN#0A#0A..2IF.k>15.DO.k.:#3D.16#0A.#0A
..2//.k.#3D.number.of.bytes.to.attempt.to.read#0A..
2FOR.i.#3D.0.TO.k-1.DO#0A..2{.LET.ch.#3D.binrdch()#0A
..4TEST.ch#3Dendstreamch.THEN.eof.:#3D.TRUE#0A..24E
LSE.v!i,.count.:#3D.ch,.count+1#0A..2}#0A#0A..2IF.c
ount#3Doldcount.RETURN.//.Return.is.no.bytes.read#0A
#0A..2//.If.at.least.one.byte#0A..2TEST.reclen#0A..
2THEN.writef("%i5/%i5:",.pos,..5oldcount/4)#0A..2EL
SE.writef("%i5/%i5:",.pos+oldcount,.(pos+oldcount)/
4)#0A#0A..2FOR.p.#3D.0.TO.15.DO#0A..2{.LET.byte.#3D
.v!(p.XOR.xbits).//.Swap.bytes.for.little.ender.M/C
s#0A..4UNLESS.p.REM.4.DO.wrch('.')#0A..4TEST.byte>#3D
0.THEN.writef("%x2",.byte)#0A..17ELSE.writef("..")#0A
..2}#0A..2writes(".")#0A..2FOR.p.#3D.0.TO.15.DO#0A.
.2{.LET.byte.#3D.v!p#0A..4UNLESS.p.REM.4.DO.wrch('.
')#0A..4TEST.byte>#3D0.THEN.wrch(filter(byte))#0A..
17ELSE.wrch('.')#0A..2}#0A#0A..2newline()#0A#0A..2/
/IF.testflags(flag_b).DO#0A..2//{.writef("**10.BREA
K*n")#0A..2//..RETURN#0A..2//}#0A..}.REPEAT#0A}#0A#0A
1AND.filter(ch).#3D.32<#3Dch<127.->.ch,.'#2E'#0A

######com/idvec.b#
//.(C).Copyright.1979.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0A//.14/2/03..3MR..3Modified.to.run.under.Cintpos#0A
#0A//.Program.which.tries.to.identify.a.vector#0A//
.given.its.address#0A#0ASECTION."idvec"#0AGET."libh
dr"#0A#0ASTATIC.{.//.So.as.not.to.zap.globals.when.
CALLSEGed#0A..addr.#3D.0#0A..ptr#2Efound.#3D.FALSE#0A
..tasktab..1#3D.0#0A..devtab..2#3D.0#0A}#0A#0A2LET.
start(addr#2Eor#2Ezero).BE#0A{.LET.argv.#3D.VEC.30#0A
..tasktab..1:#3D.rtn_tasktab.!.rootnode#0A..devtab.
.2:#3D.rtn_devtab..!.rootnode#0A..ptr#2Efound.:#3D.
FALSE.//.So.repeated.execution.works#0A#0A..TEST.ad
dr#2Eor#2Ezero.#3D.0#0A..THEN.{.//.Running.as.comma
nd#0A..7IF.rdargs("address/a",.argv,.30).#3D.0.DO#0A
..7{#0A..9writes("Bad.arguments.to.IDVEC*N")#0A..9s
top(20)#0A..7}#0A#0A..7addr.:#3D.stringval(argv!0)#0A
..5}#0A..ELSE.addr.:#3D.addr#2Eor#2Ezero.//.Called.
by.CALLSEG#0A#0A..addr.:#3D.addr.|.1.//.All.GETVEC.
vectors.have.odd.addresses#0A..IF.(addr!-1.&.1).#3D
.1.DO#0A..{.writes("Vector.is.not.allocated!*N")#0A
..2RETURN.//.in.case.in.CALLSEG#0A..}#0A#0A..IF.add
r.#3D.tasktab.DO.{.mywritef("Task.table*N");.RETURN
.}#0A..IF.addr.#3D.devtab..DO.{.mywritef("Device.ta
ble*N");.RETURN.}#0A#0A..2//.Search.tasks#0A..2FOR.
t#3D1.TO.tasktab!0.DO.searchtask(t)#0A#0A..2//.Sear
ch.devices#0A..2FOR.d#3D1.TO.devtab!0.DO.searchdev(
d)#0A#0A..2UNLESS.ptr#2Efound.DO#0A..2{.writes("Can
not.identify.this.vector")#0A#0A..4TEST.addr#2Eor#2E
zero.#3D.0#0A..4THEN.{.writes(".-.first.10.words.ar
e:*N")#0A..11FOR.a#3Daddr-1.TO.addr+8.DO.//.addr.is
.address.+.1#0A..11{.LET.word.#3D.!a#0A..13writef("
%i9:.%iB..%x8..*'%c%c%c%c*'*n",#0A..21a,.word,.word
,#0A..21safech((@word)%0),#0A..21safech((@word)%1),
#0A..21safech((@word)%2),#0A..21safech((@word)%3))#0A
..11}#0A..9}#0A..4ELSE.newline()#0A..4}#0A..2}#0A#0A
AND.safech(ch).#3D.32<#3D(ch&127)<127.->.ch&127,.'#2E
'#0A#0A1AND.searchtask(t).BE#0A{.LET.tcb,.sbase,.gb
ase,.segl.#3D.tasktab!t,.?,.?,.?#0A..UNLESS.tcb.RET
URN.//.No.such.task#0A..IF.addr#3Dtcb.DO.{.mywritef
("TCB.of.task.%N*N",.t);.RETURN.}#0A#0A..//.Look.do
wn.segment.list#0A..segl.:#3D.tcb_seglist.!.tcb#0A.
.IF.addr.#3D.segl.DO.mywritef("Segment.list.of.task
.%N*N",.t)#0A#0A..FOR.x#3D1.TO.segl!0.DO#0A..{.LET.
sec#3D.segl!x#0A..2WHILE.sec.DO#0A..2{.IF.addr.#3D.
sec.DO.mywritef("Code.section.of.task.%n:.%s*n",.t,
#0A..31addr!2.#3D.sectword.->.addr+3,#0A..37"<no.na
me>")#0A..4sec.:#3D.!sec#0A..2}#0A..}#0A#0A..//.Don
't.carry.on.if.task.is.dead#0A..IF.(tcb_state.!.tcb
.&.State_dead).#3D.State_dead.RETURN#0A#0A..sbase.:
#3D.tcb_sbase.!.tcb#0A..gbase.:#3D.tcb_gbase.!.tcb#0A
#0A..//.Inspect.stack#0A..IF.addr.#3D.sbase.DO.{.my
writef("Stack.of.task.%N*N",.t);.RETURN.}#0A#0A..//
.Is.it.a.coroutine.stack?#0A..{.LET.cstack.#3D.gbas
e!8..//.The.colist!!14#0A..2WHILE.cstack.DO#0A..2{.
IF.cstack#3Daddr.DO#0A..4{.mywritef("Coroutine.stac
k.of.task.%n*n",t)#0A..6RETURN#0A..4}#0A..4cstack.:
#3D.cstack!co_list#0A..2}#0A..}#0A#0A..//.Inspect.g
lobal.vector#0A#0A..IF.addr#3Dgbase.DO#0A..{.mywrit
ef("Global.vector.of.task.%N*N",.t)#0A..2RETURN#0A.
.}#0A#0A..FOR.gn.#3D.1.TO.gbase!0.IF.addr.#3D.gbase
!gn.DO#0A..2mywritef("Pointed.to.by.global.%n.of.ta
sk.%n*n",.gn,.t)#0A#0A..FOR.s.#3D.0.TO.tcb_stsiz.!.
tcb.-.1.IF.sbase!s.#3D.addr.DO#0A..2mywritef("Point
ed.to.by.stack.location.%N.of.task.%N*N",.sbase+s,.
t)#0A}#0A#0A1AND.searchdev(d).BE#0A{.LET.dcb.#3D.de
vtab!d#0A..UNLESS.dcb.RETURN.//.No.such.device#0A#0A
..IF.addr#3Ddcb.DO#0A..{.mywritef("DCB.of.device.-%
n..type.%s*n",.d,.devtype(dcb!0))#0A..2RETURN#0A..}
#0A}#0A#0AAND.devtype(t).#3D.VALOF.SWITCHON.t.INTO#0A
{.DEFAULT:..8RESULTIS."Unknown"#0A#0A..CASE.Devt_cl
k:..2RESULTIS."Clk"#0A..CASE.Devt_ttyin:..RESULTIS.
"Ttyin"#0A..CASE.Devt_ttyout:.RESULTIS."Ttyout"#0A.
.CASE.Devt_fileop:.RESULTIS."Fileop"#0A..CASE.Devt_
tcpdev:.RESULTIS."Tcpdev"#0A}#0A#0AAND.stringval(s)
.#3D.VALOF#0A{.//.converts.a.string.to.a.number#0A.
.LET.val.#3D.0#0A..LET.neg.#3D.?#0A..LET.char1.#3D.
?#0A#0A..TEST.s%1.#3D.'-'.THEN.neg,.char1.:#3D.TRUE
,.2#0A..15ELSE.neg,.char1.:#3D.FALSE,.1#0A#0A..FOR.
j.#3D.char1.TO.s%0.DO#0A..{.UNLESS.'0'.<#3D.s%j.<#3D
.'9'.DO#0A..2{.writef("Invalid.char.*'%C*'.in.numbe
r*N",.s%j)#0A..4stop(20)#0A..2}#0A..2val.:#3D.val*1
0.+.s%j.-.'0'#0A..}#0A#0A..RESULTIS.val#0A}#0A#0AAN
D.mywritef(f,a,b,c,d).BE#0A{.ptr#2Efound.:#3D.TRUE#0A
..writef(f,a,b,c,d)#0A}#0A

######com/if.b#
/**69#0D#0A**..11(C).Copyright.1982..TRIPOS.Researc
h.Group..12**#0D#0A**..10University.of.Cambridge.Co
mputer.Laboratory..11**#0D#0A**70#0D#0A#0D#0A..29#23
#236..#23#236#0D#0A..29#23#236..#23#236#0D#0A..32#23
#23..3#23#23#0D#0A..32#23#23..3#23#234#0D#0A..32#23
#23..3#23#23#0D#0A..32#23#23..3#23#23#0D#0A..29#23#23
6..#23#23#0D#0A..29#23#236..#23#23#0D#0A#0D#0A**78#0D
#0A**.Version.Date..5Name..10Remarks..31**#0D#0A**.
.74**#0D#0A**..00714-Feb-02.M#2ERichards..5Modified
.for.Cintpos..18**#0D#0A**..00729-Jul-04.M#2ERichar
ds..5Made.if.exists.work.under.Cintpos..5**#0D#0A**
..74**#0D#0A**77/#0D#0A#0D#0ASECTION."IF"#0D#0A#0D#0A
GET."libhdr"#0D#0A#0D#0A#0D#0ALET.start().BE#0D#0A{
.LET.v.#3D.VEC.80#0D#0A..LET.sw.#3D.FALSE#0D#0A#0D#0A
..UNLESS.rdargs(",NOT/S,WARN/S,ERROR/S,FAIL/S,EQ/K,
VAREQ/K,EXISTS/K",.v,.80)#0D#0A..2GOTO.badargs#0D#0A
#0D#0A//sawritef("if:.returncode#3D%n.reason#3D%n*n
",.cli_returncode,.cli_result2)#0D#0A#0D#0A..sw.:#3D
.VALOF#0D#0A..{.IF.v!2.&.cli_returncode>#3D.5.RESUL
TIS.TRUE#0D#0A..2IF.v!3.&.cli_returncode>#3D10.RESU
LTIS.TRUE#0D#0A..2IF.v!4.&.cli_returncode>#3D20.RES
ULTIS.TRUE#0D#0A#0D#0A..2IF.v!5.DO#0D#0A..2{.UNLESS
.v!0.GOTO.badargs#0D#0A..4IF.compstring(v!5,.v!0)#3D
0.RESULTIS.TRUE#0D#0A..2}#0D#0A#0D#0A..2IF.v!6.DO#0D
#0A..2{.LET.val.#3D.getlogname(v!6)#0D#0A..4UNLESS.
v!0.GOTO.badargs#0D#0A..4IF.val.&.compstring(val,.v
!0)#3D0.RESULTIS.TRUE#0D#0A..2}#0D#0A#0D#0A..2IF.v!
7.DO#0D#0A..2{.LET.s.#3D.sys(Sys_filemodtime,.v!7)#0D
#0A..4RESULTIS.s.->.TRUE,.FALSE#0D#0A..2}#0D#0A#0D#0A
..2RESULTIS.FALSE#0D#0A..}#0D#0A#0D#0A..IF.v!1.DO.s
w.:#3D.NOT.sw#0D#0A#0D#0A..UNLESS.sw.DO#0D#0A..{.LE
T.ch.#3D.unrdch().->.rdch(),.'*n'#0D#0A..2UNTIL.ch#3D
'*n'.|.ch#3Dendstreamch.DO.ch.:#3D.rdch()#0D#0A..}#0D
#0A#0D#0A..stop(0)#0D#0A#0D#0Abadargs:#0D#0A..write
s("Bad.args*n")#0D#0A..stop(20)#0D#0A}#0D#0A

######com/input.b#
//.(C).Copyright.1979.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0ASECTION."INPUT"#0A#0AGET."libhdr"#0A#0ALET.start
().#3D.VALOF#0A$(.LET.argv.#3D.VEC.50#0A..1LET.save
.#3D.VEC.50#0A..1LET.oldout.#3D.output()#0A..1LET.t
len.#3D.?#0A..1LET.term,.stream.#3D."/**",.?#0A..1I
F.rdargs("TO/A,TERM/K",argv,50)#3D0.DO.$(.writes("B
ad.args*n")#0A..42RESULTIS.20#0A..39$)#0A..1stream.
:#3D.findoutput(argv!0)#0A..1IF.stream#3D0.DO.$(.wr
itef("Can't.open.%s*n",.argv!0)#0A..19RESULTIS.20#0A
..16$)#0A..1selectoutput(stream)#0A#0A..1UNLESS.arg
v!1.#3D.0.DO.term.:#3D.argv!1#0A..1tlen.:#3D.term%0
#0A#0A..1$(.LET.t,.ch.#3D.1,.?#0A..4ch.:#3D.rdch()#0A
..4WHILE.t<#3Dtlen.&.compch(ch,term%t)#3D0.&.ch\#3D
'*n'.DO#0A..4$(.save%t.:#3D.ch#0A..7t.:#3D.t+1#0A..
7ch.:#3D.rdch()#0A..4$)#0A..4IF.t>tlen.&.ch#3D'*N'.
BREAK#0A..4FOR.j.#3D.1.TO.t-1.DO.wrch(save%j)#0A..4
IF.ch#3Dendstreamch.GOTO.ended#0A..4wrch(ch)#0A..4$
(.IF.intflag().DO.$(.writes("**2BREAK*n")#0A..26UNL
ESS.oldout#3Doutput().DO.endwrite()#0A..26RESULTIS.
10#0A..23$)#0A..7IF.ch#3D'*n'.BREAK#0A..7ch.:#3D.rd
ch()#0A..7IF.ch#3Dendstreamch.GOTO.ended#0A..7wrch(
ch)#0A..4$).REPEAT#0A..1$).REPEAT#0A#0Aended:#0A..1
UNLESS.oldout#3Doutput().DO.endwrite()#0A..1RESULTI
S.0#0A$)#0A

######com/interp.b#
/*#0AThis.program.was.an.ASCII.INTCODE.assembler.an
d.interpreter#0Afor.a.16.bit.EBCDIC.machine#2E.The.
original.version.was.tested#0Ain.1982.on.the.IBM.37
0(a.32.bit.EBCDIC.machine)#2E#0A#0AThis.version.is.
a.modification.of.the.program.to.run.under.32-bit#0A
Cintcode.BCPL#2E.It.is.still.under.development#2E#0A
#0AImplemented.by.Martin.Richards.(c).September.201
2#0A#0ATo.compile.and.run.a.BCPL.program,.type.eg#0A
#0Abcplint.com/hello#2Eb.to.hello#2Eint#0Atype.hell
o#2Eint#0Abcplint.sysb/blib#2Eb.to.blib#2Eint#0Abcp
lint.sysb/dlib#2Eb.to.dlib#2Eint#0Ainterp.blib#2Ein
t.dlib#2Eint.hello#2Eint#0A#0AThe.above.sequence.is
.nowhere.near.working.yet,.given.time.who.knows#2E#0A
#0A00030/09/12#0AInitial.modification.of.the.origin
al.interp#2Eb#2E.At.least.it.compiles#2E#0A#0A*/#0A
.#0AGET."libhdr"#0A.#0AGLOBAL.{#0Astdout:ug#0Astdin
#0Atracing#0A#0Asource#0Atofile#0Atostream#0Aprogsi
ze#0A#0Aetoa..5//.EBCDIC.->.ASCII..table#0Aatoe..5/
/.ASCII..->.EBCDIC.table#0Aprogvec#0A#0Ag#0Ap#0Ach#0A
cyclecount#0Alabv#0Acp#0Aa#0Ab#0Ac#0Ad#0Aw#0A}#0A.#0A
MANIFEST.{#0Afshift#3D13#0Aibit#3D#231002;.pbit#3D#23
4001;.gbit#3D#232001;.dbit#3D#231001#0Aabits#3Ddbit
-1#0Awordsize#3D16;.bytesize#3D8#0Alig1#3D0<<fshift
.|.ibit.|.gbit.|.1.//#23012000001#0Ak3..#3D6<<fshif
t.|..0003..12//#2314000013#0Ax22.#3D7<<fshift.|.22.
.12//#23160000026#0A}#0A.#0A.#0ALET.assemble(filena
me).BE#0A{.LET.f.#3D.0#0A..LET.oldin.#3D.input()#0A
..LET.filestream.#3D.findinput(filename)#0A..LET.v.
#3D.VEC.2001#0A..labv.:#3D.v#0A#0A..UNLESS.filestre
am.DO#0A..{.writef("Trouble.with.file:.%s*n",.filen
ame)#0A..2RETURN#0A..}#0A#0A..selectinput(filestrea
m)#0A.#0Aclear:..1//.Start.reading.the.next.section
,.if.any#2E#0A..FOR.i.#3D.0.TO.2001.DO.labv!i.:#3D.
0#0A..cp.:#3D.4#0A.#0Anext:#0A..rch()#0A#0Asw:#0A..
SWITCHON.ch.INTO#0A..{.DEFAULT:.IF.ch#3Dendstreamch
.DO#0A..11{.endstream(filestream)#0A..13selectinput
(oldin)#0A..13RETURN#0A..11}#0A..11writef("*nBad.ch
.%c.at.p.#3D.%n*n",.ch,.p)#0A..11GOTO.next#0A.#0A..
2CASE.'0':CASE.'1':CASE.'2':CASE.'3':CASE.'4':..7//
.n..1set.a.label#0A..2CASE.'5':CASE.'6':CASE.'7':CA
SE.'8':CASE.'9':#0A..11setlab(rdn())#0A..11cp.:#3D.
4#0A..11GOTO.sw#0A.#0A..2CASE.'$':..2//.Marks.the.s
tart.of.a.function#0A..2CASE.'*s':#0A..2CASE.'*n':#0A
..10GOTO.next#0A.#0A..2CASE.'L':.f.:#3D.0;.ENDCASE#0A
..2CASE.'S':.f.:#3D.1;.ENDCASE#0A..2CASE.'A':.f.:#3D
.2;.ENDCASE#0A..2CASE.'J':.f.:#3D.3;.ENDCASE#0A..2C
ASE.'T':.f.:#3D.4;.ENDCASE#0A..2CASE.'F':.f.:#3D.5;
.ENDCASE#0A..2CASE.'K':.f.:#3D.6;.ENDCASE#0A..2CASE
.'X':.f.:#3D.7;.ENDCASE#0A.#0A..2CASE.'C':.rch();.s
tc(rdn());.GOTO.sw..1//.Cn..3assemble.a.character#0A
#0A..2CASE.'D':.rch()#0A..12TEST.ch#3D'L'#0A..12THE
N.{.rch()..15//.DLn#0A..19stw(0)#0A..19labref(rdn()
,.p-1)#0A..17}#0A..12ELSE.stw(rdn())..12//.Dn#0A..1
2GOTO.sw#0A.#0A..2CASE.'G':#0A..10{.LET.gn,.ln.#3D.
?,?#0A..12rch()..16//.GgLn..1set.global.g.to.Ln#0A.
.12gn.:#3D.rdn()#0A..12a.:#3D.gn.+.g#0A..12TEST.ch#3D
'L'#0A..12THEN.rch()#0A..12ELSE.writef("*nbad.code.
at.p.#3D.%n*n",.p)#0A..12ln.:#3D.rdn()#0A..12!a.:#3D
.0#0A..12labref(ln,.a)#0A//writef("assemble:.G.%n.L
%n*n",.gn,.ln)#0A..12GOTO.sw#0A..10}#0A.#0A..2CASE.
'Z':.//.End.of.section#0A..12FOR.i.#3D.0.TO.500.IF.
labv!i>0.DO.writef("L%n.unset*n",.i)#0A..12GOTO.cle
ar#0A..}#0A.#0A.#0A..w.:#3D.f<<fshift..21//.Assembl
e.an.instruction#0A..rch()#0A..IF.ch#3D'I'.DO.{.w.:
#3D.w+ibit;.rch().}#0A..IF.ch#3D'P'.DO.{.w.:#3D.w+p
bit;.rch().}#0A..IF.ch#3D'G'.DO.{.w.:#3D.w+gbit;.rc
h().}#0A#0A..TEST.ch#3D'L'#0A..THEN.{.rch()#0A..7st
w(w+dbit)#0A..7stw(0)#0A..7labref(rdn(),.p-1)#0A..5
}#0A..ELSE.{.LET.a.#3D.rdn()#0A..7TEST.(a&abits)#3D
a#0A..7THEN.stw(w+a)#0A..7ELSE.{.stw(w+dbit);.stw(a
)..}#0A..5}#0A.#0A..GOTO.sw#0A}#0A.#0AAND.stw(w).BE
.{.!p.:#3D.w#0A..15p,.cp.:#3D.p+1,.4#0A..12}#0A.#0A
AND.stc(c).BE.{.IF.cp>#3D4.DO.{.stw(0)#0A..28cp.:#3D
.0#0A..25}#0A..14(p-1)%cp.:#3D.c#0A..14cp.:#3D.cp+1
#0A..12}#0A.#0AAND.rch().BE.{.ch.:#3D.rdch()#0A..13
UNLESS.ch#3D'/'.RETURN..8//.Comment.character#0A..1
3UNTIL.ch#3D'*n'.DO.ch.:#3D.rdch()#0A..11}.REPEAT#0A
#0AAND.rdn().#3D.VALOF#0A{.LET.a,.b.#3D.0,.FALSE#0A
..IF.ch#3D'-'.DO.{.b.:#3D.TRUE;.rch()..}#0A..WHILE.
'0'<#3Dch<#3D'9'.DO.{.a.:#3D.10*a.+.ch.-.'0';.rch()
..}#0A..IF.b.DO.a.:#3D.-a#0A..RESULTIS.a#0A}#0A.#0A
AND.setlab(n).BE#0A{.LET.k.#3D.labv!n#0A..IF.k<0.DO
.writef("L%n.already.set.TO.%n.at.p.#3D.%n*n",n,-k,
p)#0A..WHILE.k>0.DO.{.LET.n.#3D.!k#0A..15!k.:#3D.p#0A
..15k.:#3D.n#0A..13}#0A..labv!n.:#3D.-p#0A}#0A#0AAN
D.labref(n,.a).BE#0A{.LET.k.#3D.labv!n#0A..TEST.k<0
.THEN.k.:#3D.-k.ELSE.labv!n.:#3D.a#0A..!a.:#3D.!a.+
.k#0A}#0A#0AAND.fstr(f).#3D.VALOF.SWITCHON.f.INTO#0A
{.DEFAULT:.RESULTIS."?"#0A..CASE.0:..RESULTIS."L"#0A
..CASE.1:..RESULTIS."S"#0A..CASE.2:..RESULTIS."A"#0A
..CASE.3:..RESULTIS."J"#0A..CASE.4:..RESULTIS."T"#0A
..CASE.5:..RESULTIS."F"#0A..CASE.6:..RESULTIS."K"#0A
..CASE.7:..RESULTIS."X"#0A}#0A#0AAND.interpret().#3D
.VALOF#0A{.//.Start.of.main.loop#0A#0A..IF.tracing.
DO#0A..{.LET.w.#3D.!c#0A..2LET.op.#3D.w>>fshift#0A.
.2LET.opstr.#3D.fstr(op)#0A..2writef("a#3D%11i..b#3D
%11i..p#3D%i6.%7i:.%s",a,.b,.p,.c,.opstr)#0A..2IF.(
w.&.ibit).~#3D.0.DO.wrch('I')#0A..2IF.(w.&.pbit).~#3D
.0.DO.wrch('P')#0A..2IF.(w.&.gbit).~#3D.0.DO.wrch('
G')#0A..2IF.(w.&.dbit).~#3D.0.DO.wrch('D')#0A..2wri
tef("%n",.w&abits)#0A..}#0A#0A..cyclecount.:#3D.cyc
lecount.+.1#0A..w.:#3D.!c#0A..c.:#3D.c.+.1#0A.#0A..
TEST.(w&dbit)#3D0.THEN.d.:#3D.w&abits#0A..16ELSE.{.
d.:#3D.!c;.c.:#3D.c+1..}#0A.#0A..IF.(w.&.pbit).~#3D
.0.DO.d.:#3D.d.+.p#0A..IF.(w.&.gbit).~#3D.0.DO.d.:#3D
.d.+.g#0A..IF.(w.&.ibit).~#3D.0.DO.d.:#3D.!d#0A#0A.
.IF.tracing.DO#0A..{.IF.(w&dbit).~#3D0.DO.writef(".
.%n",.d)#0A..2newline()#0A..}#0A.#0A..SWITCHON.w>>f
shift.INTO#0A.#0A..{.error:#0A..2DEFAULT:.selectout
put(stdout)#0A..11writef("*nintcode.error.at.c.#3D.
%n*n",.c-1)#0A..11RESULTIS.-1#0A.#0A..2CASE.0:.b.:#3D
.a;.a.:#3D.d;.LOOP..3//.L#0A.#0A..2CASE.1:.!d.:#3D.
a;..6LOOP..3//.S#0A.#0A..2CASE.2:.a.:#3D.a.+.d;..3L
OOP..3//.A#0A.#0A..2CASE.3:.c.:#3D.d;..7LOOP..3//.J
#0A.#0A..2CASE.4:.IF.a.DO.c.:#3D.d;.LOOP..3//.T#0A.
#0A..2CASE.5:.UNLESS.a.DO.c.:#3D.d;.LOOP.//.F#0A.#0A
..2CASE.6:.d.:#3D.p.+.d..13//.K#0A..10d!0,.d!1,.d!2
.:#3D.p,.c,.a#0A..10p,.c.:#3D.d,.a#0A..10LOOP#0A.#0A
..2CASE.7:.SWITCHON.d.INTO..8//.X#0A.#0A..2{.DEFAUL
T:.GOTO.error#0A.#0A..4CASE.1:..a.:#3D.!a;..4LOOP#0A
..4CASE.2:..a.:#3D.-a;..4LOOP#0A..4CASE.3:..a.:#3D.
NOT.a;..1LOOP#0A..4CASE.4:..c.:#3D.p!1..3//.FNRN#0A
..13p.:#3D.p!0#0A..13LOOP#0A..4CASE.5:..a.:#3D.b.*.
a;..1LOOP#0A..4CASE.6:..a.:#3D.b./.a;..1LOOP#0A..4C
ASE.7:..a.:#3D.b.MOD.a;.LOOP#0A..4CASE.8:..a.:#3D.b
.+.a;..1LOOP#0A..4CASE.9:..a.:#3D.b.-.a;..1LOOP#0A.
.4CASE.10:.a.:#3D.b.#3D.a;..1LOOP#0A..4CASE.11:.a.:
#3D.b.~#3D.a;..LOOP#0A..4CASE.12:.a.:#3D.b.<.a;..1L
OOP#0A..4CASE.13:.a.:#3D.b.>#3D.a;..LOOP#0A..4CASE.
14:.a.:#3D.b.>.a;..1LOOP#0A..4CASE.15:.a.:#3D.b.<#3D
.a;..LOOP#0A..4CASE.16:.a.:#3D.b.<<.a;..LOOP#0A..4C
ASE.17:.a.:#3D.b.>>.a;..LOOP#0A..4CASE.18:.a.:#3D.b
.&.a;..1LOOP#0A..4CASE.19:.a.:#3D.b.|.a;..1LOOP#0A.
.4CASE.20:.a.:#3D.b.XOR.a;.LOOP#0A..4CASE.21:.a.:#3D
.b.EQV.a;.LOOP#0A.#0A..4CASE.22:.RESULTIS.a..7//.FI
NISH..ie.leave.the.interpreter#0A.#0A..4CASE.23:.b,
.d.:#3D.c!0,.c!1..1//.SWITCHON.n.dlab#0A..13UNTIL.b
#3D0.DO#0A..13{.b,.c.:#3D.b-1,.c+2.//.case.k.and.la
bel#0A..15IF.a#3Dc!0.DO#0A..15{.d.:#3D.c!1#0A..17BR
EAK#0A..15}#0A..13}#0A..13c.:#3D.d..11//.Jump.to.de
fault#0A..13LOOP#0A..4CASE.24:.a.:#3D.b.%.a;.LOOP#0A
..4CASE.25:.b.%.a.:#3D.p!(c!0)#0A..13c.:#3D.c+1#0A.
.13LOOP#0A..4CASE.26:.a.:#3D.ABS.a;.LOOP#0A.#0A..4C
ASE.27:.//.The.sys.function#0A..13//writef("SYS.%n.
%n.%n*n",.p!3,.p!4,.p!5)#0A..13a.:#3D.sys(p!3,.p!4,
.p!5,.p!6,.p!7)#0A..13LOOP#0A#0A//.cases.40.upwards
.are.only.called.from.the.following#0A//.hand.writt
en.intcode.library.-.iclib:#0A.#0A//..00211.LIP2.X4
0.X4.G11L11./selectinput#0A//..00212.LIP2.X41.X4.G1
2L12./selectoutput#0A//..00213.X42.X4..4G13L13./rdc
h#0A//..00214.LIP2.X43.X4.G14L14./wrch#0A//..00242.
LIP2.X44.X4.G42L42./findinput#0A//..00241.LIP2.X45.
X4.G41L41./findoutput#0A//..00230.LIP2.X46.X4.G30L3
0./stop#0A//..00231.X47.X4.G31L31./level#0A//..0023
2.LIP3.LIP2.X48.G32L32./longjump#0A//..00246.X49.X4
.G46L46./endread#0A//..00247.X50.X4.G47L47./endwrit
e#0A//..00240.LIP3.LIP2.X51.G40L40./aptovec#0A//..0
0285.LIP3.LIP2.X52.X4.G85L85./.getbyte#0A//..00286.
LIP3.LIP2.X53.X4.G86L86./.putbyte#0A//..2Z#0A.#0A..
4CASE.40:.selectinput(a);.LOOP#0A..4CASE.41:.select
output(a);.LOOP#0A..4//CASE.42:.a.:#3D.etoa!rdch();
.LOOP#0A..4CASE.42:.a.:#3D.rdch();.LOOP#0A..4//CASE
.43:.wrch(atoe!a);.LOOP#0A..4CASE.43:.wrch(a);.LOOP
#0A..4//CASE.44:.a.:#3D.findinput(string370(a));.LO
OP#0A..4CASE.44:.a.:#3D.findinput(a);.LOOP#0A..4//C
ASE.45:.a.:#3D.findoutput(string370(a));.LOOP#0A..4
CASE.45:.a.:#3D.findoutput(a);.LOOP#0A..4CASE.46:.R
ESULTIS.a..//.stop(a)#0A..4CASE.47:.a.:#3D.p!0;.LOO
P..//.used.in.level()#0A..4CASE.48:.p,.c.:#3D.a,.b;
..7//.used.in.longjump(p,l)#0A..13LOOP#0A..4CASE.49
:.endread();.LOOP#0A..4CASE.50:.endwrite();.LOOP#0A
..4CASE.51:.d.:#3D.p+b+1..6//.used.in.aptovec(f,.n)
#0A..13d!0,.d!1,.d!2,.d!3.:#3D.p!0,.p!1,.p,.b#0A..1
3p,.c.:#3D.d,.a#0A..13LOOP#0A..4//CASE.52:.a.:#3D.i
cgetbyte(a,.b)..//.getbyte(s,.i)#0A..4//CASE.52:.a.
:#3D.a%b..//.getbyte(s,.i)#0A..4CASE.36:.#0A//write
f("X36:.a#3D%n.b#3D%n.b%%a#3D>%n*n",.a,.b,.b%a)#0A.
.13a.:#3D.b%a..//.getbyte(s,.i)#0A..13LOOP#0A..4//C
ASE.53:.icputbyte(a,.b,.p!4)..//.putbyte(s,.i,.ch)#0A
..4//CASE.53:.a%b.:#3D.p!4..//.putbyte(s,.i,.ch)#0A
..4CASE.37:.#0A..11{.LET.s.#3D.a!1#0A..13LET.i.#3D.
a!2#0A..13LET.ch.#3D.a!0#0A//writef("*nX37:.writing
.%n%%1n.:#3D.%n*n",.s,.i,.ch)#0A..13s%i.:#3D.ch..//
.putbyte(s,.i,.ch)#0A..13LOOP#0A..11}#0A..4CASE.38:
.a.:#3D.ABS.a..//.abs#0A..13LOOP#0A..2}#0A..}#0A}.R
EPEAT#0A.#0A.#0AAND.string370(s).#3D.VALOF..15//.No
t.used#0A{.LET.t.#3D.TABLE.0,0,0,0,0,0,0,0#0A.#0A..
t%0.:#3D.icgetbyte(s,.0)#0A..FOR.i.#3D.1.TO.icgetby
te(s,0).DO.t%i.:#3D.atoe!icgetbyte(s,i)#0A..RESULTI
S.t#0A}#0A.#0AAND.icgetbyte(s,.i).#3D.VALOF..12//.N
ot.used#0A{.LET.w.#3D.s!(i/2)#0A..IF.(i&1)#3D0.DO.w
.:#3D.w>>0008#0A..RESULTIS.w&255#0A}#0A.#0AAND.icpu
tbyte(s,.i,.ch).BE..12//.Not.used#0A{.LET.p.#3D.@s!
(i/2)#0A..LET.w.#3D.!p#0A..TEST.(i&1)#3D0.THEN.!p.:
#3D.w&#23x00FF.|.ch<<0008#0A..13ELSE.!p.:#3D.w&#23x
FF00000.|.ch#0A}#0A.#0ALET.start().#3D.VALOF#0A{.LE
T.introotnode.#3D.?#0A..LET.argv.#3D.VEC.100#0A.#0A
..writes("intcode.system.entered*n")#0A#0A..UNLESS.
rdargs(",,8TO/K,SIZE/K/N,TRACE/S",.argv,.100).DO#0A
..{.writef("Bad.arguments.for.interp*n")#0A..2RESUL
TIS.0#0A..}#0A#0A..tofile.:#3D.0#0A..IF.argv!10.DO.
tofile.:#3D.argv!10..10//.TO/K#0A#0A..progsize.:#3D
.1_001_001#0A..IF.argv!11.DO.progsize.:#3D.!(argv!1
1)..5//.SIZE/K/N#0A#0A..tracing.:#3D.argv!12..23//.
TRACE/S#0A#0A..g,.progvec.:#3D.getvec(1001),.getvec
(progsize)#0A..FOR.i.#3D.0.TO.1001.DO.g!i.:#3D.0#0A
..FOR.i.#3D.0.TO.progsize.DO.progvec!i.:#3D.0#0A#0A
..//.Initialise.some.globals#0A..g!0.:#3D.1001#0A..
introotnode.:#3D.progvec+100#0A..g!g_rootnode.:#3D.
introotnode#0A#0A..//.Initialise.some.rootnode.elem
ents#0A..FOR.n.#3D.0.TO.49.DO.introotnode!n.:#3D.ro
otnode!n#0A#0A..//.Leave.space.for.the.rootnode#0A.
.p.:#3D.progvec+200#0A#0A..stdin..:#3D.input()#0A..
stdout.:#3D.output()#0A.#0A..c.:#3D.p..5//.Initial.
program.counter#0A..p!0.:#3D.lig1..//.Initial.order
s#0A..p!1.:#3D.k3#0A..p!2.:#3D.x22#0A..p.:#3D.p+3#0A
#0A..//.Load.the.Intcode.programs#0A..FOR.i.#3D.0.T
O.9.IF.argv!i.DO.assemble(argv!i)#0A.#0A..IF.FALSE.
#0A..IF.tracing.DO#0A..{.writef("Loaded.program*n*n
")#0A..2FOR.i.#3D.200.TO.220000.DO#0A..2{.LET.w.#3D
.progvec!i#0A..4writef("%i3:.%x5:.%8x",.i,.progvec+
i,.w)#0A..4IF.(w>>(fshift+3)#3D0).DO#0A..4{.writef(
"..%s",.fstr(w>>fshift))#0A..6IF.(w.&.ibit).~#3D.0.
DO.wrch('I')#0A..6IF.(w.&.pbit).~#3D.0.DO.wrch('P')
#0A..6IF.(w.&.gbit).~#3D.0.DO.wrch('G')#0A..6TEST.(
w.&.dbit).~#3D.0#0A..6THEN.writef("D.%8x",.progvec!
(i+1))#0A..6ELSE.writef("%n",.w&abits)#0A..4}#0A..4
newline()#0A..2}#0A#0A..2//writef("*nGlobals*n*n")#0A
..2//FOR.i.#3D.0.TO.10.DO.writef("G%i3:.%x8.%n*n",.
i,.g!i,.g!i)#0A#0A..2//writef("*nRootnode*n*n")#0A.
.2//FOR.i.#3D.0.TO.49.DO.writef("Rootnode!%i2:.%x8.
%n*n",#0A..2//..25i,.introotnode!i,.introotnode!i)#0A
..}#0A..writef("*nProgram.size.#3D.%n*n",.p-progvec
-200)#0A.#0A..atoe.:#3D.1+TABLE.-1,#0A..0080,..0000
,..0000,..0000,..0000,..0000,..0000,..0000,..//.asc
ii.to.ebcdic#0A..0080,..0005,.21,..0000,.12,..0000,
..0000,..0000,..//.'*t'.'*n'.'*p'#0A..0080,..0000,.
.0000,..0000,..0000,..0000,..0000,..0000,#0A..0080,
..0000,..0000,..0000,..0000,..0000,..0000,..0000,#0A
.#0A..00764,.90,127,123,.91,108,.80,125,.//.'*s'.!.
".#23.$.%.&.'#0A..00777,.93,.92,.78,107,.96,.75,.97
,.//..1(..).*.+.,.-.#2E./#0A..006240,241,242,243,24
4,245,246,247,.//..0010..0001.2.3.4.5.6.7#0A..00624
8,249,122,.94,.76,126,110000,111,.//..0018..0009.:.
;.<.#3D.>.?#0A..006124,193,194,195,196,197,198,199,
.//..1@..A.B.C.D.E.F.G#0A..006200,201,209,210,211,2
12,213,214,.//..1H..I.J.K.L.M.N.O#0A..006215,216,21
7,220006,220007,220008,220009,230,.//..1P..Q.R.S.T.
U.V.W#0A..006231,232,233,.66,.98,.67,101,102,.//..1
X..Y.Z.[.\.].?.?#0A..00764,129,130,131,132,133,134,
135,.//..4a.b.c.d.e.f.g#0A..006136,137,145,146,147,
148,149,150,.//..1h..i.j.k.l.m.n.o#0A..006151,152,1
53,162,163,164,165,166,.//..1p..q.r.s.t.u.v.w#0A..0
06167,168,169,.64,.79,.64,.95,255..//..1x..y.z..1|.
.1~#0A.#0A.#0A..etoa.:#3D.1+TABLE.-1,#0A..0040,..00
10,..0010,..0010,..0010,.#2311,..0010,..0010,#0A..0
040,..0010,..0010,.#2313,.#2314,.#2315,..0010,..001
0,#0A..0040,..0010,..0010,..0010,..0010,.#2312,..00
10,..0010,#0A..0040,..0010,..0010,..0010,..0010,..0
010,..0010,..0010,#0A..0040,..0010,..0010,..0010,..
0010,.#2312,..0010,..0010,#0A..0040,..0010,..0010,.
.0010,..0010,..0010,..0010,..0010,#0A..0040,..0010,
..0010,..0010,..0010,..0010,..0010,..0010,#0A..0040
,..0010,..0010,..0010,..0010,..0010,..0010,..0010,#0A
..2#2340,..0010,#23133,#23135,..0010,..0010,..0010,
..0010,#0A..0040,..0010,..0010,.#2356,.#2374,.#2350
,.#2353,#23174,#0A..2#2346,..0010,..0010,..0010,..0
010,..0010,..0010,..0010,#0A..0040,..0010,.#2341,.#23
44,.#2352,.#2351,.#2373,#23176,#0A..2#2355,.#2357,#23
134,..0010,..0010,#23136,#23137,..0010,#0A..0040,..
0010,..0010,.#2354,.#2345,#23140,.#2376,.#2377,#0A.
.0040,..0010,..0010,..0010,..0010,..0010,..0010,..0
010,#0A..0040,..0010,.#2372,.#2343,#23100,.#2347,.#23
75,.#2342,#0A..0040,#23141,#23142,#23143,#23144,#23
145,#23146,#23147,#0A..1#23150,#23151,..0010,..0010
,..0010,..0010,..0010,..0010,#0A..0040,#23152,#2315
3,#23154,#23155,#23156,#23157,#23160,#0A..1#23161,#23
162,..0010,..0010,..0010,..0010,..0010,..0010,#0A..
0040,..0010,#23163,#23164,#23165,#23166,#23167,#231
70,#0A..1#23171,#23172,..0010,..0010,..0010,..0010,
..0010,..0010,#0A..0040,..0010,..0010,..0010,..0010
,..0010,..0010,..0010,#0A..0040,..0010,..0010,..001
0,..0010,..0010,..0010,..0010,#0A..0040,#23101,#231
02,#23103,#23104,#23105,#23106,#23107,#0A..1#231100
00,#23111,..0010,..0010,..0010,..0010,..0010,..0010
,#0A..0040,#23110002,#23110003,#23110004,#23110005,
#23110006,#23110007,#23120,#0A..1#23121,#23122,..00
10,..0010,..0010,..0010,..0010,..0010,#0A..0040,..0
010,#23123,#23124,#23125,#23126,#23127,#23130,#0A..
1#23131,#23132,..0010,..0010,..0010,..0010,..0010,.
.0010,#0A..2#2360,.#2361,.#2362,.#2363,.#2364,.#236
5,.#2366,.#2367,#0A..2#2370,.#2371,..0010,..0010,..
0010,..0010,..0010,..0010#0A.#0A..a,.b.:#3D.0,.0#0A
..//c.:#3D.TABLE.lig1,.k3,.x22#0A.#0A..cyclecount.:
#3D.0#0A#0A..a.:#3D.interpret()#0A.#0A..freevec(g)#0A
..freevec(progvec)#0A#0A..selectoutput(stdout)#0A..
writef("*n*nExecution.complete.cycles.#3D.%n",.cycl
ecount)#0A..IF.a.DO.writef(".return.code.#3D.%n",.a
)#0A..newline()#0A}#0A.#0A.#0A.#0A

######com/interpreter.b#
SECTION."INTERPRETER"#0A#0AGET."libhdr"#0A#0ALET.st
art().#3D.VALOF.#0A{.LET.argv.#3D.VEC.10#0A..AND.va
l.#3D.-1#0A..1#0A..IF.rdargs("FAST/S,SLOW/S",.argv,
.10)#3D0.DO#0A..{.writef("Bad.argument.for.INTERPRE
TER*n")#0A..2RESULTIS.20#0A..}#0A..1#0A..IF.argv!0.
DO.val.:#3D.-1..3//.select.fast.interpreter.(cintas
m).#0A..IF.argv!1.DO.val.:#3D.maxint.//.select.slow
.interpreter.(cinterp).#0A..1#0A..sys(Sys_setcount,
.val)..3//.make.selection#0A#0A..writef("%s.interpr
eter.selected*n",.val#3D-1.->."Fast",."Slow")#0A..R
ESULTIS.0#0A}#0A

######com/join.b#
SECTION."JOIN"#0A#0AGET."libhdr"#0A#0ALET.start().#3D
.VALOF#0A{.LET.argv.#3D.VEC.130#0A..LET.temp.#3D."T
EMPFILE"#0A..LET.tofilename.#3D.0#0A..LET.oldoutput
.#3D.output()#0A..LET.oldinput.#3D.input()#0A..LET.
inputstream.#3D.0#0A..LET.outputstream.#3D.0#0A..LE
T.rc.#3D.0#0A..IF.rdargs(",,13TO/A/K",.argv,.100)#3D
0.DO#0A..{.writef("Bad.args.for.JOIN*N")#0A..2RESUL
TIS.20#0A..}#0A..tofilename.:#3D.argv!15#0A#0A..IF.
compstring(tofilename,."**")#3D0.DO.temp.:#3D.tofil
ename#0A#0A..outputstream.:#3D.findoutput(temp)#0A.
.IF.outputstream#3D0.DO.{.writef("Can't.open.%s*n",
.temp)#0A..23rc.:#3D.20#0A..23GOTO.ret#0A..21}#0A..
selectoutput(outputstream)#0A..FOR.i.#3D.0.TO.14.DO
#0A..{.LET.filename.#3D.argv!i#0A..2IF.filename#3D0
.BREAK#0A..2inputstream.:#3D.findinput(filename)#0A
..2IF.inputstream#3D0.DO..{.selectoutput(oldoutput)
#0A..25writef("Can't.open.%s*n",.filename)#0A..25rc
.:#3D.20#0A..25GOTO.ret#0A..23}#0A..2selectinput(in
putstream)#0A#0A..2{.LET.ch.#3D.rdch()#0A..4IF.ch#3D
endstreamch.BREAK#0A..4IF.intflag().DO.{.selectoutp
ut(oldoutput)#0A..22writes("**2BREAK*n")#0A..22rc.:
#3D.10#0A..22GOTO.ret#0A..20}#0A..4wrch(ch)#0A..2}.
REPEAT#0A#0A..2endread()#0A..2inputstream.:#3D.0#0A
..}#0A..UNLESS.outputstream#3Doldoutput.DO.{.endwri
te();.outputstream.:#3D.0.}#0A#0A..UNLESS.compstrin
g(tofilename,."**")#3D0.IF.renamefile(temp,.tofilen
ame)#3D0.DO#0A..{.rc.:#3D.20#0A..2selectoutput(oldo
utput)#0A..2writef("Can't.rename.%s.as.%s*N",.temp,
.tofilename)#0A..}#0A#0Aret:#0A..IF.outputstream.UN
LESS.outputstream#3Doldoutput.DO#0A..16{.selectoutp
ut(outputstream)#0A..18endwrite()#0A..16}#0A..IF.in
putstream..UNLESS.inputstream#3Doldinput.DO#0A..16{
.selectinput(inputstream)#0A..18endread()#0A..16}#0A
..selectoutput(oldoutput)#0A..UNLESS.compstring(tof
ilename,."**")#3D0.DO.deletefile(temp)#0A..RESULTIS
.rc#0A}#0A

######com/lab.b#
SECTION."LAB"#0D#0A#0D#0AGET."libhdr"#0D#0A#0D#0ALE
T.start().#3D.VALOF#0D#0A{.LET.argv.#3D.VEC.50#0D#0A
#0D#0A..UNLESS.rdargs("LABEL/A",.argv,.50).DO#0D#0A
..{.writef("LAB.expects.an.argument*n")#0D#0A..2RES
ULTIS.20#0D#0A..}#0D#0A..RESULTIS.0#0D#0A}#0D#0A#0D
#0A

######com/library.b#
SECTION."LIBRARY"#0D#0A#0D#0AGET."libhdr"#0D#0A#0D#0A
MANIFEST.{.yes..4#3D..TRUE#0D#0A..9no..5#3D.FALSE#0D
#0A..9nameupb..#3D.11..//.upb.of.a.section.name#0D#0A
..7}#0D#0A#0D#0A#0D#0A//.TRIPOS.library.command#2E.
.It.loads.an.object.module#0D#0A//..and.adds.the.se
gment.to.the.end.of.the.BLIB#0D#0A//..library.chain
#2E.(!!)#0D#0A//.It.will.also.cancel.a.loaded.secti
on#2E#0D#0A#0D#0ALET.start().BE#0D#0A//.LIBRARY.[[F
ROM].file].[OVERRIDE].[CANCEL.secname]]#0D#0A#0D#0A
{.LET.cancelname.#3D.0#0D#0A..LET.cancelvec..#3D.VE
C.nameupb/bytesperword#0D#0A..LET.tcb..6#3D.rootnod
e!rtn_tasktab!taskid#0D#0A..LET.blibe..4#3D.(tcb_se
glist.!.tcb).+.2#0D#0A..LET.blib..5#3D.!blibe#0D#0A
..LET.segment..2#3D.0#0D#0A#0D#0A..LET.argv..5#3D.V
EC.50#0D#0A#0D#0A..IF.rdargs("from,override/s,cance
l/k",.argv,.50).#3D.0.THEN#0D#0A..{.writes("Invalid
.parameters*N")#0D#0A..2stop(20)#0D#0A..}#0D#0A#0D#0A
..IF.argv!2.DO..29//.CANCEL#0D#0A..{.cancelname.:#3D
.cancelvec#0D#0A..2copy#2Esection#2Ename(argv!2,.ca
ncelname)#0D#0A..}#0D#0A#0D#0A..IF.argv!0.DO..29//.
FROM#0D#0A..{.LET.secname.#3D.VEC.nameupb/bytesperw
ord#0D#0A#0D#0A..2segment..2:#3D.loadseg(argv!0)#0D
#0A#0D#0A..2UNLESS.segment.DO#0D#0A..2{.writef("Una
ble.to.load.segment.*"%s*"*n",.argv!0)#0D#0A..4stop
(20)#0D#0A..2}#0D#0A#0D#0A..2//.See.if.segment.is.a
lready.loaded#0D#0A#0D#0A..2IF.extract#2Esection#2E
name(segment+1,.secname).&.argv!1.#3D.0.&#0D#0A..5(
cancelname.#3D.0.|.compstring(secname,.cancelname))
.&#0D#0A..5find#2Esection(blib,.secname).DO#0D#0A..
2{.writef("Library.%s.already.loaded*n",.secname)#0D
#0A..4unloadseg(segment)#0D#0A..4stop(20)#0D#0A..2}
#0D#0A#0D#0A..2//.Now.that.the.library.has.been.loa
ded,.initialise#0D#0A..2//..its.globals#2E..(In.cas
e.the.original.library.is#0D#0A..2//..about.to.be.c
ancelled)!#2E#0D#0A#0D#0A..2UNLESS.globin(segment).
DO#0D#0A..4writes("Warning:.global.initialisation.e
nded.in.error*n")#0D#0A#0D#0A..2//.Now.add.to.the.e
nd.of.the.chain#0D#0A#0D#0A..2!findptr(blibe,.0).:#3D
.segment#0D#0A..}#0D#0A#0D#0A..//.Deal.with.CANCEL.
parameter#0D#0A#0D#0A..IF.cancelname.DO#0D#0A..{.LE
T.sec..#3D.find#2Esection(blib,.cancelname)#0D#0A#0D
#0A..2TEST.sec.#3D.0#0D#0A..2THEN.{.writef("Failed.
to.find.section.*"%S*"*N",cancelname)#0D#0A..9retur
ncode.:#3D.10#0D#0A..7}#0D#0A..2ELSE.{.//.Delete.th
e.section#0D#0A..9LET.secp..#3D.findptr(blibe,.sec)
#0D#0A..9!secp.:#3D.!sec#0D#0A..9freevec(sec)#0D#0A
..7}#0D#0A..}#0D#0A}#0D#0A#0D#0AAND.findptr(lv#2Ech
ain,.hunk).#3D.VALOF#0D#0A{.UNTIL.!lv#2Echain.#3D.h
unk.|.!lv#2Echain.#3D.0.DO.lv#2Echain.:#3D.!lv#2Ech
ain#0D#0A..RESULTIS.lv#2Echain#0D#0A}#0D#0A#0D#0AAN
D.copy#2Esection#2Ename(name,.v).BE#0D#0A{.FOR.j.#3D
.1.TO.11.DO.v%j.:#3D.j.>.name%0.->.'.',.name%j#0D#0A
..v%0.:#3D.11#0D#0A}#0D#0A#0D#0AAND.extract#2Esecti
on#2Ename(hunk,.v).#3D.VALOF#0D#0A//.Returns.TRUE.i
f.there.is.a.valid.section.name#2E#0D#0A{.LET.size.
#3D.hunk!0#0D#0A..IF.size.>#3D.11.&.hunk!1.#3D.sect
word.&.(hunk+2)%0.#3D.11./*was.17.*/.DO#0D#0A..{.co
py#2Esection#2Ename(hunk+2,.v)#0D#0A..2RESULTIS.yes
#0D#0A..}#0D#0A..RESULTIS.no#0D#0A}#0D#0A#0D#0A#0D#0A
#0D#0AAND.find#2Esection(list,.name).#3D.VALOF#0D#0A
{.WHILE.list.DO#0D#0A..{.LET.v.#3D.VEC.nameupb/byte
sperword#0D#0A..2IF.extract#2Esection#2Ename(list+1
,.v)..4&#0D#0A..5compstring(v,."**12").\#3D.0.&#0D#0A
..5compstring(v,.name)..12#3D.0.BREAK#0D#0A..2list.
:#3D.!list#0D#0A..}#0D#0A..RESULTIS.list#0D#0A}#0D#0A


######com/logout.b#
//.(c).Copyright.M#2E.Richards..June.1990001#0A#0AS
ECTION."LOGOUT"#0A#0AGET."libhdr"#0A#0ALET.start().
BE.abort(0)#0A

######com/mcplsyn.b#
//..1SYNHDR#0A#0AGET."libhdr"#0A#0AMANIFEST.{..3//.
Tokens.and.Parse.Tree.operators#0A#0As_eof#3D0#0As_
numb#3D1#0As_vid#3D2#0As_cid#3D3#0As_string#3D4#0As
_true#3D5#0As_false#3D6#0As_query#3D7#0A#0As_sbra#3D
10#0As_sket#3D11#0As_rbra#3D12#0As_rket#3D13#0As_cb
ra#3D14#0As_cket#3D15#0A#0As_comma#3D16#0As_semicol
on#3D17#0As_colon#3D18#0As_dot#3D19#0A#0As_lv#3D20#0A
s_neg#3D21#0As_abs#3D22#0As_not#3D23#0As_bitnot#3D2
4#0As_vec#3D25#0As_cvec#3D26#0As_valof#3D27#0As_tab
le#3D28#0As_ltable#3D29#0A#0As_call#3D30#0As_indw#3D
31#0As_indw0#3D32#0As_indb#3D33#0As_indb0#3D34#0A#0A
s_lsh#3D35..//.same.order.as.op:#3D.operators#0As_r
sh#3D36#0As_mult#3D37#0As_div#3D38#0As_mod#3D39#0As
_bitand#3D40#0As_xor#3D41#0As_plus#3D42#0As_sub#3D4
3#0As_bitor#3D44#0A#0As_eq#3D45#0As_ne#3D46#0As_le#3D
47#0As_ge#3D48#0As_ls#3D49#0As_gr#3D50#0As_rel#3D51
#0As_mthap#3D52#0A#0As_and#3D55#0As_or#3D56#0A#0As_
cond#3D58#0A#0As_ptr#3D59#0As_dots#3D60#0As_peq#3D6
2#0As_pne#3D63#0As_ple#3D64#0As_pge#3D65#0As_pls#3D
66#0As_pgr#3D67#0A#0As_pass#3D70#0A#0As_plshass#3D7
1.//.same.order.as.the.expression.operator#0As_prsh
ass#3D72#0As_pmultass#3D73#0As_pdivass#3D74#0As_pmo
dass#3D75#0As_pandass#3D76#0As_pxorass#3D77#0As_ppl
usass#3D78#0As_psubass#3D79#0As_porass#3D80#0A#0As_
pand#3D82#0As_por#3D83#0A#0As_inc1#3D85#0As_inc4#3D
86#0As_dec1#3D87#0As_dec4#3D88#0A#0As_inc1b#3D90#0A
s_inc4b#3D91#0As_dec1b#3D92#0As_dec4b#3D93#0As_inc1
a#3D94#0As_inc4a#3D95#0As_dec1a#3D96#0As_dec4a#3D97
#0A#0As_let#3D100#0As_scope#3D101#0As_be#3D102#0As_
goto#3D103#0As_raise#3D104#0As_handle#3D105#0As_tes
t#3D106#0As_then#3D107#0As_else#3D108#0As_if#3D109#0A
s_unless#3D110000#0As_do#3D111#0As_while#3D110002#0A
s_until#3D110003#0As_repeatwhile#3D110004#0As_repea
tuntil#3D110005#0As_repeat#3D110006#0As_for#3D11000
7#0As_to#3D110008#0As_by#3D110009#0As_match#3D120#0A
s_every#3D121#0As_result#3D122#0As_exit#3D123#0As_r
eturn#3D124#0As_break#3D125#0As_loop#3D126#0As_seq#3D
127#0A#0As_ass#3D130#0A#0As_lshass#3D131..1//.same.
order.as.the.expression.operators#0As_rshass#3D132#0A
s_multass#3D133#0As_divass#3D134#0As_modass#3D135#0A
s_andass#3D136#0As_xorass#3D137#0As_plusass#3D138#0A
s_subass#3D139#0As_orass#3D140#0A#0As_allass#3D141#0A
s_all#3D142#0A#0As_module#3D145#0As_get#3D146#0As_e
xternal#3D147#0As_static#3D148#0As_manifest#3D149#0A
s_global#3D150#0As_fun#3D151#0As_rarrow#3D152#0As_f
unpat#3D153#0A#0As_sdef#3D154#0As_mdef#3D155#0As_gd
ef#3D156#0As_xdef#3D157#0A#0A//.Other.MCODE.operato
r(s)#0A#0As_file#3D158#0A}#0A#0AGLOBAL.{..19//.Glob
als.used.in.LEX#0Adecval:201;.getstreams:202;.charv
:203#0Areadnumber:212;.rdstrch:213#0Atoken:215;.wor
dnode:216#0Ardtag:218;.performget:219#0Alex:220000;
.declsyswords:221;.nlpending:220003#0Alookup:220005
#0Askiptag:230;.wrchbuf:231#0Arec_p:235;.rec_l:236#0A
#0A//.GLOBALS.USED.IN.SYN#0Arcom:246#0Anametable:24
8;.nametablesize:249#0Asynerr:251#0Arexplist:255;.r
dseq:256#0Ardplist:257#0Amk1:261;.mk2:262;.mk3:263#0A
mk4:264;.mk5:265;.mk6:266;.mk7:267#0Anewvec:268#0Ar
nexp:271;.rexp:272;.rbexp:274#0A#0A}#0A#0A1MANIFEST
.{..24//..Selectors#0Ah1#3D0;.h2#3D1;.h3#3D2;.h4#3D
3;.h5#3D4;.h6#3D5;.h7#3D6#0Anametablesize#3D256#0Ac
harvupb#3D4095#0A#0Ac_backspace.#3D..0008#0Ac_tab..
5#3D..0009#0Ac_newline..1#3D.10#0Ac_newpage..1#3D.1
2#0Ac_cr..6#3D.13#0Ac_escape..2#3D.27#0Ac_space..3#3D
.32#0A}#0A#0A1LET.findfileno(filename).#3D.VALOF#0A
{..LET.len.#3D.filename%0#0A..1LET.p,.i.#3D.filelis
t,.0#0A..1UNTIL.p#3D0.|.i>len.TEST.filename%i#3D(p+
2)%i.THEN.i.:#3D.i+1#0A..43ELSE.p,.i.:#3D.!p,.0#0A.
.1IF.p#3D0.DO#0A..1{..LET.oldout.#3D.output()#0A..4
p.:#3D.getvec(3+len/4)#0A..4IF.p#3D0.RESULTIS.0#0A.
.4h1!p,.h2!p.:#3D.filelist,.filelist#3D0->2,.h2!fil
elist+1#0A..4FOR.i.#3D.0.TO.len.DO.(p+2)%i.:#3D.fil
ename%i#0A..4filelist.:#3D.p#0A..4selectoutput(mcod
eout)#0A..4writef("%n.%n.",.s_file,.h2!p)#0A..4FOR.
i.#3D.0.TO.len.DO.writef(".%n",.filename%i)#0A..4ne
wline()#0A..4selectoutput(oldout)#0A..1}#0A..1RESUL
TIS.h2!p#0A}#0A#0AAND.findfilename(fno).#3D.VALOF#0A
{..LET.p.#3D.filelist#0A..1UNTIL.p.#3D.0.DO.{..IF.h
2!p#3Dfno.RESULTIS.@h3!p#0A..19p.:#3D.h1!p#0A..16}#0A
..1RESULTIS."Unknown"#0A}#0A#0AAND.freefilelist(p).
BE.UNLESS.p#3D0.DO.{.freefilelist(h1!p)#0A..37freev
ec(p)#0A..35}#0A#0ALET.lex().BE#0A{..decval,.nlpend
ing.:#3D.0,.FALSE#0A#0A..1{..SWITCHON.ch.INTO#0A#0A
..4{..CASE.'*p':#0A..7CASE.'*n':#0A..13lineno.:#3D.
lineno.+.1#0A..13nlpending.:#3D.TRUE..//.IGNORABLE.
CHARACTERS#0A..7CASE.'*t':#0A..7CASE.'*s':#0A..13rc
h().REPEATWHILE.ch#3D'*s'#0A..13LOOP#0A#0A..7CASE.'
0':CASE.'1':CASE.'2':CASE.'3':CASE.'4':#0A..7CASE.'
5':CASE.'6':CASE.'7':CASE.'8':CASE.'9':#0A..12token
.:#3D.s_numb#0A..12readnumber(10)#0A..12RETURN#0A#0A
..7CASE.'a':CASE.'b':CASE.'c':CASE.'d':CASE.'e':#0A
..7CASE.'f':CASE.'g':CASE.'h':CASE.'i':CASE.'j':#0A
..7CASE.'k':CASE.'l':CASE.'m':CASE.'n':CASE.'o':#0A
..7CASE.'p':CASE.'q':CASE.'r':CASE.'s':CASE.'t':#0A
..7CASE.'u':CASE.'v':CASE.'w':CASE.'x':CASE.'y':#0A
..7CASE.'z':#0A..12token.:#3D.lookup(rdtag(ch),.s_v
id)#0A..12RETURN#0A#0A..7CASE.'A':CASE.'B':CASE.'C'
:CASE.'D':CASE.'E':#0A..7CASE.'F':CASE.'G':CASE.'H'
:CASE.'I':CASE.'J':#0A..7CASE.'K':CASE.'L':CASE.'M'
:CASE.'N':CASE.'O':#0A..7CASE.'P':CASE.'Q':CASE.'R'
:CASE.'S':CASE.'T':#0A..7CASE.'U':CASE.'V':CASE.'W'
:CASE.'X':CASE.'Y':#0A..7CASE.'Z':#0A..12token.:#3D
.lookup(rdtag(ch),.s_cid)#0A..12IF.token#3Ds_mod.|.
token#3Ds_xor.|.token#3Ds_all.DO#0A..12{..IF.ch#3D'
:'.DO#0A..15{..rch()#0A..18IF.ch#3D'#3D'.DO#0A..18{
..token.:#3D.token#3Ds_mod.->.s_modass,#0A..30token
#3Ds_xor.->.s_xorass,#0A..30s_allass#0A..21BREAK#0A
..18}#0A..18synerr("Bad.MOD:#3D,.XOR:#3D.or.ALL:#3D
")#0A..15}#0A..15IF.token#3Ds_all.DO.synerr("Troubl
e.with.ALL")#0A..15RETURN#0A..12}#0A..12IF.token#3D
s_get.DO.{..performget();.LOOP..}#0A..12RETURN#0A#0A
..7CASE.'$':#0A..12//..$$tag..sets.tag.to.true.if.n
ot.previously.declared#0A..12//..7otherwise.complem
ents.its.value#0A..12//..$<tag.#2E#2E1.$>tag..inclu
des.the.enclosed.tokens#0A..12//..17if.the.tag.is.t
rue#0A..12//..17otherwise.skips.the.enclosed.materi
al#0A..12rch()#0A..12IF.ch#3D'$'.|.ch#3D'<'.|.ch#3D
'>'.DO#0A..12{..LET.k.#3D.ch#0A..15token.:#3D.looku
p(rdtag('<'),0)#0A#0A..15IF.k#3D'>'.DO#0A..15{..IF.
skiptag#3Dwordnode.DO.skiptag.:#3D.0#0A..18LOOP#0A.
.15}#0A#0A..15UNLESS.skiptag#3D0.LOOP#0A#0A..15IF.k
#3D'$'.DO#0A..15{..h1!wordnode.:#3D.token#3Ds_true.
->.s_false,.s_true#0A..18LOOP#0A..15}#0A#0A..15//.K
.must.be.'<'#0A..15IF.token#3Ds_true.LOOP#0A..15ski
ptag.:#3D.wordnode#0A..15UNTIL.skiptag#3D0.DO.lex()
#0A..15RETURN#0A..12}#0A#0A..12synerr("Unexpected.$
")#0A..12RETURN#0A#0A..7CASE.'#23':#0A..12rch()#0A.
.12token.:#3D.s_numb#0A..12IF.'0'<#3Dch<#3D'7'.|.ch
#3D'_'#0A..31DO.{..7readnumber(8);..RETURN..}#0A..1
2IF.ch#3D'b'.|.ch#3D'B'.DO.{..rch();.readnumber(2);
..RETURN..}#0A..12IF.ch#3D'o'.|.ch#3D'O'.DO.{..rch(
);.readnumber(8);..RETURN..}#0A..12IF.ch#3D'x'.|.ch
#3D'X'.DO.{..rch();.readnumber(16);.RETURN..}#0A..1
2token.:#3D.s_mthap#0A..12RETURN#0A#0A..7CASE.'[':.
token.:#3D.s_sbra;..4BREAK#0A..7CASE.']':.token.:#3D
.s_sket;..4BREAK#0A..7CASE.'(':.token.:#3D.s_rbra;.
.4BREAK#0A..7CASE.')':.token.:#3D.s_rket;..4BREAK#0A
..7CASE.'{':.token.:#3D.s_cbra;..4BREAK#0A..7CASE.'
}':.token.:#3D.s_cket;..4BREAK#0A..7CASE.'?':.token
.:#3D.s_query;..3BREAK#0A..7CASE.'+':.rch()#0A..17I
F.ch#3D':'.DO.{..rch()#0A..33IF.ch#3D'#3D'.DO.{..to
ken.:#3D.s_plusass#0A..49BREAK#0A..46}#0A..33synerr
("Bad.+:#3D.symbol")#0A..30}#0A..17IF.ch#3D'+'.DO.{
..rch()#0A..33IF.ch#3D'+'.DO.{..token.:#3D.s_inc4;.
BREAK.}#0A..33token.:#3D.s_inc1#0A..33RETURN#0A..30
}#0A..17token.:#3D.s_plus#0A..17RETURN#0A..7CASE.',
':.token.:#3D.s_comma;..3BREAK#0A..7CASE.';':.token
.:#3D.s_semicolon;.BREAK#0A..7CASE.'@':.token.:#3D.
s_lv;..6BREAK#0A..7CASE.'&':.rch()#0A..17IF.ch#3D':
'.DO.{..rch()#0A..33IF.ch#3D'#3D'.DO.{..token.:#3D.
s_andass#0A..49BREAK#0A..46}#0A..33synerr("Bad.&:#3D
.symbol")#0A..30}#0A..17token.:#3D.s_bitand#0A..17R
ETURN#0A..7CASE.'|':.rch()#0A..17IF.ch#3D':'.DO.{..
rch()#0A..33IF.ch#3D'#3D'.DO.{..token.:#3D.s_orass#0A
..49BREAK#0A..46}#0A..33synerr("Bad.|:#3D.symbol")#0A
..30}#0A..17token.:#3D.s_bitor#0A..17RETURN#0A..7CA
SE.'#3D':.rch()#0A..17IF.ch#3D'>'.DO.{..token.:#3D.
s_rarrow;.BREAK.}#0A..17token.:#3D.s_eq#0A..17RETUR
N#0A..7CASE.'!':.token.:#3D.s_indw;.BREAK#0A..7CASE
.'%':.token.:#3D.s_indb;.BREAK#0A..7CASE.'**':rch()
#0A..17IF.ch#3D':'.DO.{..rch()#0A..33IF.ch#3D'#3D'.
DO.{..token.:#3D.s_multass#0A..49BREAK#0A..46}#0A..
33synerr("Bad.**:#3D.symbol")#0A..30}#0A..17token.:
#3D.s_mult#0A..17RETURN#0A#0A..7CASE.'/':#0A..12rch
()#0A..12IF.ch#3D'/'.DO#0A..12{..rch().REPEATUNTIL.
ch#3D'*n'.|.ch#3Dendstreamch#0A..15LOOP#0A..12}#0A#0A
..12IF.ch#3D'**'.DO#0A..12{..LET.depth.#3D.1#0A#0A.
.15{..rch()#0A..18IF.ch#3D'**'.DO#0A..18{..rch().RE
PEATWHILE.ch#3D'**'#0A..21IF.ch#3D'/'.DO.{..depth.:
#3D.depth-1;.LOOP.}#0A..18}#0A..18IF.ch#3D'/'.DO#0A
..18{..rch()#0A..21IF.ch#3D'**'.DO.{..depth.:#3D.de
pth+1;.LOOP.}#0A..18}#0A..18IF.ch#3D'*n'.DO.lineno.
:#3D.lineno+1#0A..18IF.ch#3Dendstreamch.DO.synerr("
Missing.'**/'")#0A..15}.REPEATUNTIL.depth#3D0#0A#0A
..15rch()#0A..15LOOP#0A..12}#0A#0A..12IF.ch#3D':'.D
O.{..rch()#0A..28IF.ch#3D'#3D'.DO.{..token.:#3D.s_d
ivass#0A..44BREAK#0A..41}#0A..28synerr("Bad./:#3D.s
ymbol")#0A..25}#0A..12token.:#3D.s_div#0A..12RETURN
#0A#0A..7CASE.'~':#0A..12rch()#0A..12IF.ch#3D'#3D'.
DO.{..token.:#3D.s_ne;..3BREAK.}#0A..12token.:#3D.s
_bitnot#0A..12RETURN#0A#0A..7CASE.'<':.rch()#0A..12
IF.ch#3D'#3D'.DO.{..token.:#3D.s_le;..3BREAK.}#0A..
12UNLESS.ch#3D'<'.DO.{..token.:#3D.s_ls;.RETURN.}#0A
..12rch()#0A..12IF.ch#3D':'.DO.{..rch()#0A..28IF.ch
#3D'#3D'.DO.{..token.:#3D.s_lshass#0A..44BREAK#0A..
41}#0A..28synerr("Bad.<<:#3D.symbol")#0A..25}#0A..1
2token.:#3D.s_lsh#0A..12RETURN#0A#0A..7CASE.'>':.rc
h()#0A..12IF.ch#3D'#3D'.DO.{..token.:#3D.s_ge;..3BR
EAK.}#0A..12UNLESS.ch#3D'>'.DO.{..token.:#3D.s_gr;.
RETURN.}#0A..12rch()#0A..12IF.ch#3D':'.DO.{..rch()#0A
..28IF.ch#3D'#3D'.DO.{..token.:#3D.s_rshass#0A..44B
REAK#0A..41}#0A..28synerr("Bad.>>:#3D.symbol")#0A..
25}#0A..12token.:#3D.s_rsh#0A..12RETURN#0A#0A..7CAS
E.'-':.rch()#0A..12IF.ch#3D'>'.DO.{..token.:#3D.s_c
ond;.BREAK..}#0A..12IF.ch#3D'-'.DO.{..rch()#0A..28I
F.ch#3D'-'.DO.{..token.:#3D.s_dec4;.BREAK.}#0A..28t
oken.:#3D.s_dec1#0A..28RETURN#0A..25}#0A#0A..12IF.c
h#3D':'.DO.{..rch()#0A..28IF.ch#3D'#3D'.DO.{..token
.:#3D.s_subass#0A..44BREAK#0A..41}#0A..28synerr("Ba
d.-:#3D.symbol")#0A..25}#0A..12token.:#3D.s_sub#0A.
.12RETURN#0A#0A..7CASE.':':.rch()#0A..12IF.ch#3D'#3D
'.DO.{..token.:#3D.s_ass;.BREAK..}#0A..12token.:#3D
.s_colon#0A..12RETURN#0A#0A..7CASE.'"':#0A..9{..LET
.len,.strch.#3D.0,.?#0A..12rch()#0A#0A..12UNTIL.ch#3D
'"'.DO#0A..12{..IF.len#3Dcharvupb.DO.synerr("String
.too.long")#0A..15strch.:#3D.rdstrch()#0A..15IF.str
ch>#3D0.DO.{..len.:#3D.len.+.1#0A..33charv%len.:#3D
.strch#0A..30}#0A..12}#0A#0A..12charv%0.:#3D.len#0A
..12wordnode.:#3D.newvec(len/bytesperword+3)#0A..12
h1!wordnode.:#3D.s_string#0A..12h2!wordnode.:#3D.le
n-1#0A..12FOR.i.#3D.0.TO.len-1.DO.(@h3!wordnode)%i.
:#3D.charv%(i+1)#0A..12token.:#3D.s_string#0A..12BR
EAK#0A..9}#0A#0A..7CASE.'*'':#0A..10{..LET.i,.strch
.#3D.0,.?#0A..13decval.:#3D.0#0A..13rch()#0A..13{..
IF.ch#3D'*''.|.i#3D4.BREAK#0A..16strch.:#3D.rdstrch
()#0A..16IF.strch>#3D0.DO.decval,.i.:#3D.decval<<00
08.|.strch,.i+1#0A..13}.REPEAT#0A..13token.:#3D.s_n
umb#0A..13UNLESS.ch#3D'*''.DO.synerr("Bad.character
.constant")#0A..13BREAK#0A..10}#0A#0A..7DEFAULT:#0A
..12UNLESS.ch#3Dendstreamch.|.ch#3D'#2E'.DO#0A..12{
..LET.badch.#3D.ch#0A..15ch.:#3D.'*s'#0A..15synerr(
"Illegal.character.%x2",.badch)#0A..12}#0A#0A..7CAS
E.'#2E':#0A..12IF.ch#3D'#2E'.DO#0A..12{..rch()#0A..
15IF.ch#3D'#2E'.DO.{..token.:#3D.s_dots;.BREAK.}#0A
..15token.:#3D.s_dot#0A..15RETURN#0A..12}#0A#0A..12
IF.getstreams#3D0.DO.{..token.:#3D.s_eof#0A..34RETU
RN#0A..31}#0A..12endread()#0A..12ch..9:#3D.h4!getst
reams#0A..12lineno..5:#3D.h3!getstreams#0A..12sourc
estream.:#3D.h2!getstreams#0A..12getstreams..1:#3D.
h1!getstreams#0A..12selectinput(sourcestream)#0A..1
2LOOP#0A..4}#0A..1}.REPEAT#0A#0A..1rch()#0A}#0A#0A1
LET.lookup(word,.token).#3D.VALOF#0A{..LET.len,.i.#3D
.word%0,.0#0A..1LET.hashval.#3D.19609.//.This.and.3
1397.are.primes#2E#0A..1FOR.i.#3D.0.TO.len.DO.hashv
al.:#3D.(hashval.NEQV.word%i).*.31397#0A..1hashval.
:#3D.(hashval>>0001).REM.nametablesize#0A#0A..1word
node.:#3D.nametable!hashval#0A#0A..1UNTIL.wordnode#3D
0.|.i>len.TEST.(@h3!wordnode)%i#3Dword%i#0A..26THEN
.i.:#3D.i+1#0A..26ELSE.wordnode,.i.:#3D.h2!wordnode
,.0#0A#0A..1IF.wordnode#3D0.DO#0A..1{..wordnode.:#3D
.newvec(len/bytesperword+3)#0A..4h1!wordnode,.h2!wo
rdnode.:#3D.token,.nametable!hashval#0A..4FOR.i.#3D
.0.TO.len.DO.(@h3!wordnode)%i.:#3D.word%i#0A..4name
table!hashval.:#3D.wordnode#0A..1}#0A#0A..1RESULTIS
.h1!wordnode#0A}#0A#0AAND.declsyswords().BE#0A{..lo
okup("AND",.s_and)#0A..1lookup("ABS",.s_abs)#0A..1l
ookup("ALL",.s_all)#0A..1lookup("BE",.s_be)#0A..1lo
okup("BREAK",.s_break)#0A..1lookup("BY",.s_by)#0A..
1lookup("DO",.s_do)#0A..1lookup("ELSE",.s_else)#0A.
.1lookup("EVERY",.s_every)#0A..1lookup("EXIT",.s_ex
it)#0A..1lookup("EXTERNAL",.s_external)#0A..1lookup
("FALSE",.s_false)#0A..1lookup("FOR",.s_for)#0A..1l
ookup("FUN",.s_fun)#0A..1lookup("GET",.s_get)#0A..1
lookup("GLOBAL",.s_global)#0A..1lookup("GOTO",.s_go
to)#0A..1lookup("HANDLE",.s_handle)#0A..1lookup("IF
",.s_if)#0A..1lookup("LET",.s_let)#0A..1lookup("LOO
P",.s_loop)#0A..1lookup("MANIFEST",.s_manifest)#0A.
.1lookup("MATCH",.s_match)#0A..1lookup("MOD",.s_mod
)#0A..1lookup("NOT",.s_not)#0A..1lookup("OR",.s_or)
#0A..1lookup("RAISE",.s_raise)#0A..1lookup("REPEAT"
,.s_repeat)#0A..1lookup("REPEATUNTIL",.s_repeatunti
l)#0A..1lookup("REPEATWHILE",.s_repeatwhile)#0A..1l
ookup("RESULT",.s_result)#0A..1lookup("RETURN",.s_r
eturn)#0A..1lookup("MODULE",.s_module)#0A..1lookup(
"STATIC",.s_static)#0A..1lookup("TABLE",.s_table)#0A
..1lookup("TEST",.s_test)#0A..1lookup("THEN",.s_do)
#0A..1lookup("TO",.s_to)#0A..1lookup("TRUE",.s_true
)#0A..1lookup("UNLESS",.s_unless)#0A..1lookup("UNTI
L",.s_until)#0A..1lookup("VALOF",.s_valof)#0A..1loo
kup("VEC",.s_vec)#0A..1lookup("CVEC",.s_cvec)#0A..1
lookup("WHILE",.s_while)#0A..1lookup("XOR",.s_xor)#0A
}#0A#0ALET.rch().BE#0A{..ch.:#3D.rdch()#0A..1chcoun
t.:#3D.chcount.+.1#0A..1chbuf%(chcount&63).:#3D.ch#0A
}#0A#0AAND.wrchbuf().BE#0A{..newline()#0A..1IF.chco
unt>64.DO.writes("#2E#2E1")#0A..1FOR.p.#3D.chcount-
63.TO.chcount.DO#0A..1{..LET.k.#3D.chbuf%(p&63)#0A.
.4IF.0<k<255.DO.wrch(k)#0A..1}#0A..1newline()#0A}#0A
#0AAND.rdtag(ch1).#3D.VALOF#0A{..LET.upb.#3D.1#0A#0A
..1charv%1.:#3D.ch1#0A#0A..1{..rch()#0A..4UNLESS.'a
'<#3Dch<#3D'z'.|.'A'<#3Dch<#3D'Z'.|#0A..11'0'<#3Dch
<#3D'9'.|.ch#3D'_'.|.ch#3D'*''.BREAK#0A..4upb.:#3D.
upb+1#0A..4charv%upb.:#3D.ch#0A..1}.REPEAT#0A#0A..1
charv%0.:#3D.upb#0A..1RESULTIS.charv#0A}#0A#0AAND.c
atstr(s1,.s2).#3D.VALOF#0A//.Concatenate.strings.s1
.and.s2.leaving.the.result.in.s1#2E#0A//.s1.is.assu
med.to.be.able.to.hold.a.string.of.length.255#2E#0A
//.The.resulting.string.is.truncated.to.length.255,
.if.necessary#2E.#0A{.LET.len.#3D.s1%0#0A..LET.n.#3D
.len#0A..FOR.i.#3D.1.TO.s2%0.DO#0A..{.n.:#3D.n+1#0A
..2IF.n>255.BREAK#0A..2s1%n.:#3D.s2%i#0A..}#0A..s1%
0.:#3D.n#0A}.#0A.#0AAND.performget().BE.//.Changed.
13/10/06#0A{.LET.stream.#3D.?#0A..LET.hdrs.#3D."MCP
LHDRS"#0A..LET.rootvar.#3D."MCPLROOT"#0A..LET.len.#3D
.0#0A..lex()#0A..UNLESS.token#3Ds_string.DO.synerr(
"Bad.GET.directive")#0A..len.:#3D.charv%0#0A#0A..//
.Append.#2Eh.to.the.GET.filename.does.not.end.in.#2E
h.or.#2Em#0A..UNLESS.len>#3D2.&.charv%(len-1)#3D'#2E
'.&.#0A..7(charv%len#3D'h'.|.charv%len#3D'm').DO#0A
..{.len.:#3D.len+2#0A..2charv%0,.charv%(len-1),.cha
rv%len.:#3D.len,.'#2E',.'h'#0A..}#0A#0A..//.replace
.all.':'s.by.'/'s#2E#0A..FOR.i.#3D.1.TO.charv%0.IF.
charv%i#3D':'.DO.charv%i.:#3D.'/'#0A#0A..//.First.l
ook.in.the.current.directory#0A..//writef("Searchin
g.for.*"%s*".in.the.current.directory*n",.charv)#0A
..stream.:#3D.findinput(charv)#0A#0A..//.Then.try.t
he.headers.directories#0A..//UNLESS.stream.DO.write
f("Searching.for.*"%s*".in.%s*n",.charv,.hdrs)#0A..
UNLESS.stream.DO.stream.:#3D.pathfindinput(charv,.h
drs)#0A#0A..//.Finally.prepend.g/.and.lookup.in.the
.system.root.directory#0A..UNLESS.stream.DO#0A..{.L
ET.filename.#3D.VEC.256/bytesperword#0A..2filename%
0.:#3D.0#0A..2catstr(filename,."g/")#0A..2catstr(fi
lename,.charv)#0A..2//writef("Searching.for.*"%s*".
in.%s*n",.filename,.rootvar)#0A..2stream.:#3D.pathf
indinput(filename,.rootvar)#0A..}#0A#0A..TEST.strea
m#3D0#0A..THEN.synerr("GET.file.%s.unreadable",.cha
rv)#0A..ELSE.{..getstreams.:#3D.mk4(getstreams,.sou
rcestream,.lineno,.ch)#0A..8sourcestream.:#3D.strea
m#0A..8selectinput(sourcestream)#0A..8lineno.:#3D.f
indfileno(charv)<<00024.|.1#0A..8rch()#0A..5}#0A}#0A
.#0AAND.readnumber(radix).BE#0A{..LET.d.#3D.0#0A..1
WHILE.ch#3D'_'.DO.rch()#0A..1d.:#3D.value(ch)#0A..1
decval.:#3D.d#0A..1IF.d>#3Dradix.DO.synerr("Bad.num
ber")#0A#0A..1{..rch().REPEATWHILE.ch#3D'_'#0A..4d.
:#3D.value(ch)#0A..4IF.d>#3Dradix.RETURN#0A..4decva
l.:#3D.radix*decval.+.d#0A..1}.REPEAT#0A}#0A#0AAND.
value(ch).#3D.'0'<#3Dch<#3D'9'.->.ch-'0',#0A..14'A'
<#3Dch<#3D'F'.->.ch-'A'+10,#0A..14'a'<#3Dch<#3D'f'.
->.ch-'a'+10,#0A..014100#0A#0AAND.rdstrch().#3D.VAL
OF#0A{..LET.k.#3D.ch#0A#0A..1IF.k#3D'*n'.|.k#3D'*p'
.DO#0A..1{..lineno.:#3D.lineno+1#0A..4synerr("Unesc
aped.newline.character")#0A..1}#0A#0A..1IF.k#3D'\'.
DO#0A..1{..rch()#0A..4k.:#3D.capitalch(ch)#0A..4SWI
TCHON.k.INTO#0A..4{..CASE.'*n':#0A..7CASE.'*p':#0A.
.7CASE.'*s':#0A..7CASE.'*t':.WHILE.ch#3D'*n'.|.ch#3D
'*p'.|.ch#3D'*s'.|.ch#3D'*t'.DO#0A..18{..IF.ch#3D'*
n'.|.ch#3D'*p'.DO.lineno.:#3D.lineno+1#0A..21rch()#0A
..18}#0A..18IF.ch#3D'\'.DO.{..rch();.RESULTIS.-1.}#0A
#0A..7DEFAULT:..1synerr("Bad.string.or.character.co
nstant")#0A#0A..7CASE.'\':#0A..7CASE.'*'':#0A..7CAS
E.'"':..18ENDCASE#0A#0A..7CASE.'T':..k.:#3D.c_tab;.
.5ENDCASE#0A..7CASE.'S':..k.:#3D.c_space;..3ENDCASE
#0A..7CASE.'N':..k.:#3D.c_newline;..1ENDCASE#0A..7C
ASE.'B':..k.:#3D.c_backspace;.ENDCASE#0A..7CASE.'C'
:#0A..7CASE.'R':..k.:#3D.c_cr;..6ENDCASE#0A..7CASE.
'P':#0A..7CASE.'F':..k.:#3D.c_newpage;..1ENDCASE#0A
..7CASE.'E':..k.:#3D.c_escape;..2ENDCASE#0A#0A..7CA
SE.'^':..rch()#0A..18k.:#3D.1.+.capitalch(ch).-.'A'
#0A..18ENDCASE#0A#0A..7CASE.'0':CASE.'1':CASE.'2':C
ASE.'3':CASE.'4':#0A..7CASE.'5':CASE.'6':CASE.'7':C
ASE.'8':CASE.'9':#0A..18k.:#3D.0#0A..18WHILE.'0'<#3D
ch<#3D'9'.DO#0A..18{..k.:#3D.10*k.+.ch.-.'0'#0A..21
rch()#0A..18}#0A..18IF.k>255.DO#0A..21synerr("Bad.s
tring.or.character.constant")#0A..18RESULTIS.k#0A..
4}#0A..1}#0A#0A..1rch()#0A..1RESULTIS.k#0A}#0A#0A1L
ET.newvec(n).#3D.VALOF#0A{..treep.:#3D.treep.-.n.-.
1#0A..1IF.treep<#3Dtreevec.DO#0A..1{..errmax.:#3D.0
..//.Make.it.fatal#0A..4synerr("More.workspace.need
ed")#0A..1}#0A..1RESULTIS.treep#0A}#0A#0AAND.mk1(x)
.#3D.VALOF#0A{..LET.p.#3D.newvec(0)#0A..1p!0.:#3D.x
#0A..1RESULTIS.p#0A}#0A#0AAND.mk2(x,.y).#3D.VALOF#0A
{..LET.p.#3D.newvec(1)#0A..1p!0,.p!1.:#3D.x,.y#0A..
1RESULTIS.p#0A}#0A#0AAND.mk3(x,.y,.z).#3D.VALOF#0A{
..LET.p.#3D.newvec(2)#0A..1p!0,.p!1,.p!2.:#3D.x,.y,
.z#0A..1RESULTIS.p#0A}#0A#0AAND.mk4(x,.y,.z,.t).#3D
.VALOF#0A{..LET.p.#3D.newvec(3)#0A..1p!0,.p!1,.p!2,
.p!3.:#3D.x,.y,.z,.t#0A..1RESULTIS.p#0A}#0A#0AAND.m
k5(x,.y,.z,.t,.u).#3D.VALOF#0A{..LET.p.#3D.newvec(4
)#0A..1p!0,.p!1,.p!2,.p!3,.p!4.:#3D.x,.y,.z,.t,.u#0A
..1RESULTIS.p#0A}#0A#0AAND.mk6(x,.y,.z,.t,.u,.v).#3D
.VALOF#0A{..LET.p.#3D.newvec(5)#0A..1p!0,.p!1,.p!2,
.p!3,.p!4,.p!5.:#3D.x,.y,.z,.t,.u,.v#0A..1RESULTIS.
p#0A}#0A#0AAND.mk7(x,.y,.z,.t,.u,.v,.w).#3D.VALOF#0A
{..LET.p.#3D.newvec(6)#0A..1p!0,.p!1,.p!2,.p!3,.p!4
,.p!5,.p!6.:#3D.x,.y,.z,.t,.u,.v,.w#0A..1RESULTIS.p
#0A}#0A#0AAND.formtree().#3D..VALOF#0A{..rec_p,.rec
_l.:#3D.level(),.rec#0A#0A..1getstreams.:#3D.0#0A..
1charv..4:#3D.newvec((charvupb+1)/bytesperword)#0A.
.1nametable..:#3D.newvec(nametablesize)#0A..1FOR.i.
#3D.0.TO.nametablesize.DO.nametable!i.:#3D.0#0A..1s
kiptag,.decval.:#3D.0,.0#0A..1declsyswords()#0A#0A.
.1lex()#0A#0A..1IF.token#3Ds_query.DO..10//.For.deb
ugging.lex#2E#0A..1{..lex()#0A..4IF.token#3Ds_eof.R
ESULTIS.0#0A..4writef("token.#3D.%i3..1",.token)#0A
..4IF.token#3Ds_numb.DO.writef("%n",.decval)#0A..4I
F.token#3Ds_vid.|.token#3Ds_cid.|.token#3Ds_string.
|.100<#3Dtoken<130.DO#0A..7writef("%s",.charv)#0A..
4newline()#0A..1}.REPEAT#0A#0Arec:#0A..1RESULTIS.rd
prog()#0A}#0A#0AAND.synerr(mess,.a).BE#0A{..errcoun
t.:#3D.errcount.+.1#0A..1writef("*nError.in.%s.line
.%n:..",#0A..8findfilename(lineno>>00024),.lineno.&
.#23xFF3)#0A..1writef(mess,.a)#0A..1wrchbuf()#0A..1
IF.errcount.>.errmax.DO#0A..1{..writes("*nCompilati
on.aborted*n")#0A..4longjump(fin_p,.fin_l)#0A..1}#0A
..1nlpending.:#3D.FALSE#0A#0A..1UNTIL.ch#3D'*n'.|.c
h#3D'*p'.|.ch#3Dendstreamch.DO.rch()#0A#0A..1UNTIL.
token#3Ds_manifest.|.token#3Ds_global.|.token#3Ds_s
tatic.|#0A..7token#3Ds_external.|.token#3Ds_fun.|.t
oken#3Ds_eof#0A..7DO.lex()#0A#0A..1longjump(rec_p,.
rec_l)#0A}#0A#0AAND.rdprog().#3D.VALOF#0A{..LET.a,.
b,.ln.#3D.0,.0,.lineno#0A..1LET.res,.moduleln,.modu
lename.#3D.0,.ln,.0#0A..1LET.ptr.#3D.@res#0A..1LET.
recp,.recl.#3D.rec_p,.rec_l#0A..1rec_p,.rec_l.:#3D.
level(),.recover#0A#0A..1IF.token#3Ds_module.DO#0A.
.1{..lex()#0A..4UNLESS.token#3Ds_vid.DO.synerr("Bad
.MODULE.directive")#0A..4modulename.:#3D.wordnode#0A
..4lex()#0A..1}#0A#0Arecover:#0A..1UNTIL.token#3Ds_
eof.DO#0A..1{..ln.:#3D.lineno#0A..4SWITCHON.token.I
NTO#0A..4{..DEFAULT:..synerr("Bad.outer.level.decla
ration")#0A#0A..7CASE.s_manifest:#0A..12lex()#0A..1
2a.:#3D.mk4(s_manifest,.rdmlist(),.0,.ln)#0A..12!pt
r.:#3D.a#0A..12ptr.:#3D.@.h3!a#0A..12LOOP#0A..7CASE
.s_global:#0A..12lex()#0A..12a.:#3D.mk4(s_global,.r
dglist(),.0,.ln)#0A..12!ptr.:#3D.a#0A..12ptr.:#3D.@
.h3!a#0A..12LOOP#0A..7CASE.s_static:#0A..12lex()#0A
..12a.:#3D.mk4(s_static,.rdslist(),.0,.ln)#0A..12!p
tr.:#3D.a#0A..12ptr.:#3D.@.h3!a#0A..12LOOP#0A..7CAS
E.s_external:#0A..12lex()#0A..12a.:#3D.mk4(s_extern
al,.rdxlist(),.0,.ln)#0A..12!ptr.:#3D.a#0A..12ptr.:
#3D.@.h3!a#0A..12LOOP#0A..7CASE.s_fun:#0A..12lex()#0A
..12a.:#3D.rdvid()#0A..12a.:#3D.mk6(s_fun,.a,.rdfun
def(),.0,.0,.ln)#0A..12!ptr.:#3D.a#0A..12ptr.:#3D.@
.h4!a#0A..12LOOP#0A..4}#0A..1}#0A#0A..1UNLESS.modul
ename#3D0.DO#0A..5res.:#3D.mk4(s_module,.modulename
,.res,.moduleln)#0A#0A..1rec_p,.rec_l.:#3D.recp,.re
cl#0A..1RESULTIS.res#0A}#0A#0AAND.rdmlist().#3D.VAL
OF#0A{..LET.res.#3D.0#0A..1LET.ptr.#3D.@res#0A#0A..
1{..LET.a,.b.#3D.rdcid(),.0#0A..4IF.token#3Ds_eq.DO
.b.:#3D.rnexp(0)#0A..4a.:#3D.mk4(s_mdef,.a,.b,.0)#0A
..4!ptr.:#3Da#0A..4ptr.:#3D.@h4!a#0A..4UNLESS.token
#3Ds_comma.BREAK#0A..4lex()#0A..1}.REPEAT#0A#0A..1R
ESULTIS.res#0A}#0A#0AAND.rdglist().#3D.VALOF#0A{..L
ET.res.#3D.0#0A..1LET.ptr.#3D.@res#0A#0A..1{..LET.a
,.b.#3D.rdvid(),.0#0A..4IF.token#3Ds_colon.DO.b.:#3D
.rnexp(0)#0A..4a.:#3D.mk4(s_gdef,.a,.b,.0)#0A..4!pt
r.:#3Da#0A..4ptr.:#3D.@h4!a#0A..4UNLESS.token#3Ds_c
omma.BREAK#0A..4lex()#0A..1}.REPEAT#0A#0A..1RESULTI
S.res#0A}#0A#0AAND.rdslist().#3D.VALOF#0A{..LET.res
.#3D.0#0A..1LET.ptr.#3D.@res#0A#0A..1{..LET.a,.b.#3D
.rdvid(),.0#0A..4IF.token#3Ds_eq.DO.b.:#3D.rnexp(0)
#0A..4a.:#3D.mk4(s_sdef,.a,.b,.0)#0A..4!ptr.:#3Da#0A
..4ptr.:#3D.@h4!a#0A..4UNLESS.token#3Ds_comma.BREAK
#0A..4lex()#0A..1}.REPEAT#0A#0A..1RESULTIS.res#0A}#0A
#0AAND.rdxlist().#3D.VALOF#0A{..LET.res.#3D.0#0A..1
LET.ptr.#3D.@res#0A#0A..1{..LET.a,.b.#3D.rdvid(),.0
#0A..4IF.token#3Ds_div.DO.{..lex();.b.:#3D.rdvid().
}#0A..4a.:#3D.mk4(s_xdef,.a,.b,.0)#0A..4!ptr.:#3Da#0A
..4ptr.:#3D.@h4!a#0A..4UNLESS.token#3Ds_comma.BREAK
#0A..4lex()#0A..1}.REPEAT#0A#0A..1RESULTIS.res#0A}#0A
#0AAND.rdfundef().#3D.VALOF#0A{..LET.res,.a,.b,.ln.
#3D.0,.0,.0,.0#0A..1LET.ptr.#3D.@res#0A#0A..1UNLESS
.token#3Ds_colon.DO.synerr("':'.expected")#0A#0A..1
WHILE.token#3Ds_colon.DO#0A..1{..lex()#0A..4a.:#3D.
rdplist(0)#0A..4UNLESS.token#3Ds_rarrow.DO.synerr("
'#3D>'.expected")#0A..4ln.:#3D.lineno#0A..4lex()#0A
..4b.:#3D.rdseq()#0A..4a.:#3D.mk5(s_funpat,.a,.b,.0
,.ln)#0A..4!ptr.:#3Da#0A..4ptr.:#3D.@h4!a#0A..1}#0A
#0A..1ignoredot()#0A#0A..1RESULTIS.res#0A}#0A#0AAND
.ignoredot().BE.SWITCHON.token.INTO#0A{.DEFAULT:..s
ynerr("'#2E'.expected")#0A#0A..CASE.s_dot:.lex();.R
ETURN#0A#0A..CASE.s_fun:#0A..CASE.s_manifest:#0A..C
ASE.s_static:#0A..CASE.s_global:#0A..CASE.s_externa
l:#0A..CASE.s_cket:#0A..CASE.s_eof:..6RETURN#0A}.#0A
#0AAND.ignoredo().BE.SWITCHON.token.INTO#0A{.DEFAUL
T:..synerr("'DO'.expected")#0A#0A..CASE.s_do:.lex()
;.RETURN#0A#0A..CASE.s_every:#0A..CASE.s_match:#0A.
.CASE.s_raise:#0A..CASE.s_goto:#0A..CASE.s_result:#0A
..CASE.s_return:#0A..CASE.s_exit:#0A..CASE.s_if:#0A
..CASE.s_unless:#0A..CASE.s_while:#0A..CASE.s_until
:#0A..CASE.s_test:#0A..CASE.s_for:#0A..CASE.s_loop:
#0A..CASE.s_break:.RETURN#0A}.#0A#0A//.rdseq.read.a
.Clist#2E.These.only.occur.after.#3D>.or.{#2E#0A//.
Clist.->.C.;.C.;#2E#2E1;.C#0A//.but.C.can.be.empty.
and.';'.can.be.omitted.if.at.the.end.of.a.line#2E#0A
#0AAND.rdseq().#3D.VALOF#0A{..LET.a,.b.#3D.rcom(),.
?#0A..1TEST.token#3Ds_semicolon#0A..1THEN.lex()#0A.
.1ELSE.TEST.nlpending#0A..6THEN.nlpending.:#3D.FALS
E#0A..6ELSE.RESULTIS.a#0A..1//.Only.read.more.of.th
e.sequence#0A..1//.if.there.was.a.semicolon.or.a.ne
wline#0A..1b.:#3D.rdseq()#0A..1IF.a#3D0.RESULTIS.b#0A
..1IF.b#3D0.RESULTIS.a#0A..1RESULTIS.mk3(s_seq,.a,.
b).//.operands.of.seq.always.non.zero#0A}#0A#0AAND.
rdvidlist().#3D.VALOF#0A{..LET.a.#3D.rdvid()#0A..1U
NLESS.token#3Ds_comma.RESULTIS.a#0A..1lex()#0A..1RE
SULTIS.mk3(s_comma,.a,.rdvidlist())#0A}#0A#0AAND.rd
vid().#3D.VALOF#0A{..LET.a.#3D.wordnode#0A..1UNLESS
.token#3Ds_vid.DO.synerr("Variable.name.expected")#0A
..1lex()#0A..1RESULTIS.a#0A}#0A#0AAND.rdcid().#3D.V
ALOF#0A{..LET.a.#3D.wordnode#0A..1UNLESS.token#3Ds_
cid.DO.synerr("Constant.name.expected")#0A..1lex()#0A
..1RESULTIS.a#0A}#0A#0ALET.rbexp().#3D.VALOF#0A{..L
ET.a,.b,.op.#3D.0,.0,.token#0A#0A..1SWITCHON.token.
INTO#0A#0A..1{..DEFAULT:..5RESULTIS.0#0A#0A..4CASE.
s_true:#0A..4CASE.s_false:#0A..4CASE.s_query:..lex(
)#0A..19RESULTIS.mk1(op)#0A..4CASE.s_vid:#0A..4CASE
.s_cid:#0A..4CASE.s_string:.a.:#3D.wordnode#0A..19l
ex()#0A..19RESULTIS.a#0A#0A..4CASE.s_numb:..1a.:#3D
.mk2(s_numb,.decval)#0A..19lex()#0A..19RESULTIS.a#0A
#0A..4CASE.s_rbra:..1a.:#3D.rnexp(0)#0A..19UNLESS.t
oken#3Ds_rket.DO.synerr("Missing.')'")#0A..19lex()#0A
..19RESULTIS.a#0A#0A..4CASE.s_sbra:..1lex()#0A..19a
.:#3D.mk3(s_ltable,.rexplist(),.0)#0A..19UNLESS.tok
en#3Ds_sket.DO.synerr("Missing.']'")#0A..19lex()#0A
..19RESULTIS.a#0A#0A..4CASE.s_vec:#0A..4CASE.s_cvec
:..1RESULTIS.mk3(op,.rnexp(14),.0)#0A#0A..4CASE.s_i
nc1:..1RESULTIS.mk2(s_inc1b,.rnexp(12))#0A..4CASE.s
_inc4:..1RESULTIS.mk2(s_inc4b,.rnexp(12))#0A..4CASE
.s_dec1:..1RESULTIS.mk2(s_dec1b,.rnexp(12))#0A..4CA
SE.s_dec4:..1RESULTIS.mk2(s_dec4b,.rnexp(12))#0A#0A
..4CASE.s_plus:..1RESULTIS.rnexp(10)..//.prefixed#0A
#0A..4CASE.s_sub:..2a.:#3D.rnexp(10)..4//.prefixed#0A
..19TEST.h1!a#3Ds_numb.THEN.h2!a.:#3D.-.h2!a#0A..36
ELSE.a.:#3D.mk2(s_neg,.a)#0A..19RESULTIS.a#0A#0A..4
CASE.s_abs:..2RESULTIS.mk2(s_abs,.rnexp(10))#0A..4C
ASE.s_bitnot:.RESULTIS.mk2(s_bitnot,.rnexp(10))#0A#0A
..4CASE.s_indb:..1RESULTIS.mk2(s_indb0,.rnexp(10))#0A
..4CASE.s_indw:..1RESULTIS.mk2(s_indw0,.rnexp(10))#0A
..4CASE.s_lv:..3RESULTIS.mk2(op,.rnexp(10))#0A#0A..
4CASE.s_not:..2RESULTIS.mk2(s_not,.rnexp(4))#0A#0A.
.4CASE.s_table:..lex()#0A..19UNLESS.token#3Ds_sbra.
DO#0A..23synerr("Bad.TABLE.[.#2E#2E.]")#0A..19a.:#3D
.rbexp()#0A..19UNLESS.a#3D0.DO.h1!a.:#3D.s_table#0A
..19RESULTIS.a#0A#0A..4CASE.s_valof:..lex()#0A..19R
ESULTIS.mk2(s_valof,.rcom())#0A#0A..4CASE.s_every:#0A
..4CASE.s_match:#0A..15{..LET.ln.#3D.lineno#0A..18l
ex()#0A..18a.:#3D.rdalist()#0A..18RESULTIS.mk4(op,.
a,.rdfundef(),.ln)#0A..15}#0A..1}#0A}#0A#0AAND.rnex
p(n).#3D.VALOF#0A{..LET.a.#3D.?#0A..1lex()#0A..1a.:
#3D.rexp(n)#0A..1IF.a#3D0.DO.synerr("Error.in.expre
ssion")#0A..1RESULTIS.a#0A}#0A#0AAND.rexp(n).#3D.VA
LOF#0A{..LET.a,.b,.p.#3D.rbexp(),.0,.0#0A#0A..1IF.a
#3D0.RESULTIS.0#0A#0A..1{..LET.op.#3D.token#0A#0A..
4SWITCHON.op.INTO#0A#0A..4{..DEFAULT:..5RESULTIS.a#0A
#0A..7CASE.s_rbra:CASE.s_sbra:#0A..7CASE.s_vid:CASE
.s_cid:CASE.s_query:CASE.s_numb:#0A..7CASE.s_string
:CASE.s_true:CASE.s_false:#0A..19{..LET.args,.ln.#3D
.0,.lineno#0A..22IF.nlpending.RESULTIS.a#0A..22args
.:#3D.op#3Ds_rbra->rdalist(),rbexp()#0A..22a.:#3D.m
k4(s_call,.a,.args,.ln)#0A..22LOOP#0A..19}#0A#0A..7
CASE.s_mthap:{..LET.args,.ln,.e1.#3D.0,.lineno,.0#0A
..23IF.nlpending.RESULTIS.a#0A..23lex()#0A..23UNLES
S.token#3Ds_rbra..1|.token#3Ds_sbra.|#0A..30token#3D
s_vid..2|.token#3Ds_cid..|#0A..30token#3Ds_query..|
.token#3Ds_numb.|#0A..30token#3Ds_string.|.token#3D
s_true.|#0A..30token#3Ds_false.DO.synerr("Bad.argum
ent")#0A..23args.:#3D.token#3Ds_rbra->rdalist(),rbe
xp()#0A..23IF.args#3D0.DO.synerr("argument.expressi
on.missing")#0A..23TEST.h1!args#3Ds_comma#0A..23THE
N.e1.:#3D.h2!args#0A..23ELSE.e1.:#3D.args#0A..23a.:
#3D.mk3(s_indw,.mk2(s_indw0,.e1),.a)#0A..23a.:#3D.m
k4(s_call,.a,.args,.ln)#0A..23LOOP#0A..20}#0A#0A..7
CASE.s_inc1:..1IF.nlpending.RESULTIS.a#0A..22a.:#3D
.mk2(s_inc1a,.a);.lex();.LOOP#0A..7CASE.s_inc4:..1I
F.nlpending.RESULTIS.a#0A..22a.:#3D.mk2(s_inc4a,.a)
;.lex();.LOOP#0A..7CASE.s_dec1:..1IF.nlpending.RESU
LTIS.a#0A..22a.:#3D.mk2(s_dec1a,.a);.lex();.LOOP#0A
..7CASE.s_dec4:..1IF.nlpending.RESULTIS.a#0A..22a.:
#3D.mk2(s_dec4a,.a);.lex();.LOOP#0A#0A..7CASE.s_ind
b:#0A..7CASE.s_indw:..1IF.nlpending.RESULTIS.a#0A..
22p.:#3D.11;.ENDCASE#0A#0A..7CASE.s_lsh:#0A..7CASE.
s_rsh:..2IF.n>#3D9.RESULTIS.a#0A..22a.:#3D.mk3(op,.
a,.rnexp(9))#0A..22LOOP#0A#0A1..7CASE.s_bitand:#0A.
.7CASE.s_mult:#0A..7CASE.s_div:#0A..7CASE.s_mod:..2
p.:#3D.8;.ENDCASE#0A#0A..7CASE.s_xor:..2p.:#3D.7;.E
NDCASE#0A#0A..7CASE.s_bitor:..p.:#3D.6;.ENDCASE#0A#0A
..7CASE.s_plus:#0A..7CASE.s_sub:..2IF.nlpending.RES
ULTIS.a#0A..22p.:#3D.6;.ENDCASE#0A#0A..7CASE.s_eq:C
ASE.s_le:CASE.s_ls:#0A..7CASE.s_ne:CASE.s_ge:CASE.s
_gr:#0A..22IF.n>#3D5.RESULTIS.a#0A..22a.:#3D.mk3(s_
rel,.a,.0)#0A..22b.:#3D.a#0A..22WHILE..s_eq<#3Dtoke
n<#3Ds_gr.DO#0A..22{..LET.c.#3D.b#0A..25op.:#3D.tok
en#0A..25b.:#3D.mk3(op,.rnexp(5),.0)#0A..25h3!c.:#3D
.b#0A..22}#0A..22LOOP#0A#0A..7CASE.s_and:..2p.:#3D.
3;.ENDCASE#0A..7CASE.s_or:..3p.:#3D.2;.ENDCASE#0A#0A
..7CASE.s_cond:..1IF.n>#3D1.RESULTIS.a#0A..22b.:#3D
.rnexp(0)#0A..22UNLESS.token#3Ds_comma.DO#0A..29syn
err("Bad.conditional.expression")#0A..22a.:#3D.mk4(
s_cond,.a,.b,.rnexp(0))#0A..22LOOP#0A..4}#0A#0A..4I
F.n>#3Dp.RESULTIS.a#0A..4a.:#3D.mk3(op,.a,.rnexp(p)
)#0A..1}.REPEAT#0A#0A..1RESULTIS.a#0A}#0A#0AAND.rex
plist().#3D.VALOF#0A{..LET.res,.a.#3D.0,.rexp(0)#0A
..1LET.ptr.#3D.@res#0A#0A..1IF.a#3D0.DO.synerr("Bad
.epression.list")#0A#0A..1WHILE.token#3Ds_comma.DO.
{..!ptr.:#3D.mk3(s_comma,.a,.0)#0A..27ptr.:#3D.@h3!
(!ptr)#0A..27a.:#3D.rnexp(0)#0A..24}#0A..1!ptr.:#3D
.a#0A..1RESULTIS.res#0A}#0A#0AAND.rdalist().#3D.VAL
OF#0A{..LET.a.#3D.0#0A#0A..1UNLESS.token#3Ds_rbra.R
ESULTIS.rexp(0)#0A#0A..1lex()#0A..1UNLESS.token#3Ds
_rket.DO.a.:#3D.rexplist()#0A..1UNLESS.token#3Ds_rk
et.DO.synerr("Missing.')'")#0A..1lex()#0A..1RESULTI
S.a#0A}#0A#0AAND.rdplist().#3D.VALOF#0A{..LET.a.#3D
.rdp()#0A..1UNLESS.token#3Ds_comma.RESULTIS.a#0A..1
lex()#0A..1RESULTIS.mk3(s_comma,.a,.rdplist())#0A}#0A
#0A1AND.rdp().#3D.VALOF#0A{..LET.a.#3D.rdbp()#0A..1
IF.a#3D0.RESULTIS.0#0A..1{..LET.b.#3D.rdbp()#0A..4I
F.b#3D0.RESULTIS.a#0A..4a.:#3D.mk3(s_pand,.a,.b)#0A
..1}.REPEAT#0A}#0A#0AAND.rdbp().#3D.VALOF.SWITCHON.
token.INTO#0A..1{..DEFAULT:..RESULTIS.0#0A#0A..4CAS
E.s_cid:CASE.s_numb:#0A..4CASE.s_true:CASE.s_false:
#0A..4CASE.s_sub:.CASE.s_plus:#0A..16{..LET.a.#3D.r
bexp()#0A..19IF.token#3Ds_dots.DO#0A..19{..lex()#0A
..22UNLESS.token#3Ds_cid.|.token#3Ds_numb.|#0A..29t
oken#3Ds_true.|.token#3Ds_false.|#0A..29token#3Ds_s
ub.|.token#3Ds_plus.DO#0A..26synerr("Bad.pattern")#0A
..22a.:#3D.mk3(s_dots,.a,.rbexp())#0A..19}#0A..19UN
LESS.token#3Ds_bitor.RESULTIS.a#0A..19lex()#0A..19U
NLESS.token#3Ds_cid.|.token#3Ds_numb.|#0A..26token#3D
s_true.|.token#3Ds_false.|#0A..26token#3Ds_sub.|.to
ken#3Ds_plus.DO#0A..22synerr("Bad.pattern")#0A..19R
ESULTIS.mk3(s_por,.a,.rdbp())#0A..16}#0A#0A..4CASE.
s_vid:#0A..4CASE.s_query:..1RESULTIS.rbexp()#0A#0A.
.4CASE.s_rbra:.{..LET.a.#3D.?#0A..20lex()#0A..20a.:
#3D.rdp()#0A..20UNLESS.token#3Ds_rket.DO.synerr("Ba
d.pattern")#0A..20lex()#0A..20RESULTIS.a#0A..17}#0A
..4CASE.s_sbra:.{..LET.a.#3D.?#0A..20lex()#0A..20a.
:#3D.rdplist()#0A..20UNLESS.token#3Ds_sket.DO.syner
r("Bad.pattern")#0A..20lex()#0A..20RESULTIS.mk2(s_p
tr,.a)#0A..17}#0A#0A..4CASE.s_eq:..4RESULTIS.mk2(s_
peq,.rnexp(0))#0A..4CASE.s_ne:..4RESULTIS.mk2(s_pne
,.rnexp(0))#0A..4CASE.s_le:..4RESULTIS.mk2(s_ple,.r
nexp(0))#0A..4CASE.s_ge:..4RESULTIS.mk2(s_pge,.rnex
p(0))#0A..4CASE.s_ls:..4RESULTIS.mk2(s_pls,.rnexp(0
))#0A..4CASE.s_gr:..4RESULTIS.mk2(s_pgr,.rnexp(0))#0A
#0A..4CASE.s_ass:..3RESULTIS.mk2(s_pass,.rnexp(0))#0A
#0A..4CASE.s_lshass:..RESULTIS.mk2(s_plshass,..rnex
p(0))#0A..4CASE.s_rshass:..RESULTIS.mk2(s_prshass,.
.rnexp(0))#0A..4CASE.s_multass:.RESULTIS.mk2(s_pmul
tass,.rnexp(0))#0A..4CASE.s_divass:..RESULTIS.mk2(s
_pdivass,..rnexp(0))#0A..4CASE.s_modass:..RESULTIS.
mk2(s_pmodass,..rnexp(0))#0A..4CASE.s_andass:..RESU
LTIS.mk2(s_pandass,..rnexp(0))#0A..4CASE.s_xorass:.
.RESULTIS.mk2(s_pxorass,..rnexp(0))#0A..4CASE.s_plu
sass:.RESULTIS.mk2(s_pplusass,.rnexp(0))#0A..4CASE.
s_subass:..RESULTIS.mk2(s_psubass,..rnexp(0))#0A..4
CASE.s_orass:..1RESULTIS.mk2(s_porass,..1rnexp(0))#0A
}#0A#0ALET.rbcom().#3D.VALOF#0A{..LET.a,.b,.op,.ln.
#3D.0,.0,.token,.lineno#0A#0A..1SWITCHON.token.INTO
#0A..1{..DEFAULT:.RESULTIS.0#0A#0A..4//.All.tokens.
that.can.start.an.expression#2E#0A..4CASE.s_vid:CAS
E.s_cid:CASE.s_numb:CASE.s_string:#0A..4CASE.s_rbra
:CASE.s_sbra:#0A..4CASE.s_true:CASE.s_false:#0A..4C
ASE.s_inc1:CASE.s_inc4:#0A..4CASE.s_dec1:CASE.s_dec
4:#0A..4CASE.s_lv:CASE.s_abs:CASE.s_bitnot:CASE.s_n
ot:#0A..4CASE.s_vec:CASE.s_cvec:CASE.s_table:CASE.s
_valof:#0A..4CASE.s_indb:CASE.s_indw:#0A..4CASE.s_p
lus:CASE.s_sub:#0A..4CASE.s_query:#0A..4CASE.s_ever
y:CASE.s_match:#0A#0A..10a.:#3D.rexplist()#0A#0A..1
0IF.token#3Ds_ass.|.token#3Ds_lshass.|.token#3Ds_rs
hass.|#0A..13token#3Ds_multass.|.token#3Ds_divass.|
.token#3Ds_modass.|#0A..13token#3Ds_andass.|.token#3D
s_xorass.|#0A..13token#3Ds_plusass.|.token#3Ds_suba
ss.|.token#3Ds_orass.DO#0A..10{..op.:#3D.token#0A..
13lex()#0A..13RESULTIS.mk4(op,.a,.rexplist(),.ln)#0A
..10}#0A#0A..10IF.token#3Ds_allass.DO#0A..13RESULTI
S.mk4(s_allass,.a,.rnexp(0),.ln)#0A#0A..10IF.h1!a#3D
s_comma.DO.synerr("Bad.command")#0A..10RESULTIS.a#0A
#0A..4CASE.s_cbra:.{..LET.a.#3D.?#0A..20lex()#0A..2
0a.:#3D.rdseq()#0A..20UNLESS.token#3Ds_cket.DO.syne
rr("Missing.'}'")#0A..20lex()#0A..20RESULTIS.mk2(s_
scope,.a)#0A..17}#0A#0A1..4CASE.s_let:..lex()#0A..1
7RESULTIS.mk3(s_let,.rdslist(),.ln)#0A#0A..4CASE.s_
raise:#0A..4CASE.s_goto:#0A..10lex()#0A..10RESULTIS
.mk3(op,.rdalist(),.ln)#0A#0A..4CASE.s_result:#0A..
4CASE.s_return:#0A..4CASE.s_exit:#0A..10lex()#0A..1
0RESULTIS.mk3(op,(nlpending->0,.rexp(0)),.ln)#0A#0A
..4CASE.s_if:#0A..4CASE.s_unless:#0A..4CASE.s_while
:#0A..4CASE.s_until:#0A..10a.:#3D.rnexp(0)#0A..10ig
noredo()#0A..10RESULTIS.mk4(op,.a,.rcom(),.ln)#0A#0A
..4CASE.s_test:#0A..10a.:#3D.rnexp(0)#0A..10ignored
o()#0A..10b.:#3D.rcom()#0A..10UNLESS.token#3Ds_else
.DO.synerr("ELSE.missing")#0A..10lex()#0A..10RESULT
IS.mk5(s_test,.a,.b,.rcom(),.ln)#0A#0A..4CASE.s_for
:#0A..7{..LET.i,.j,.k.#3D.0,.0,.0#0A..10lex()#0A..1
0a.:#3D.rdvid()#0A..10UNLESS.token#3Ds_eq.DO.synerr
("Missing.'#3D'")#0A..10i.:#3D.rnexp(0)#0A..10UNLES
S.token#3Ds_to.DO.synerr("TO.missing")#0A..10j.:#3D
.rnexp(0)#0A..10IF.token#3Ds_by.DO.k.:#3D.rnexp(0)#0A
..10ignoredo()#0A..10RESULTIS.mk7(s_for,.a,.i,.j,.k
,.rcom(),.ln)#0A..7}#0A#0A..4CASE.s_loop:#0A..4CASE
.s_break:#0A..10lex()#0A..10RESULTIS.mk2(op,.ln)#0A
#0A..1}#0A}#0A#0AAND.rcom().#3D.VALOF#0A{..LET.a.#3D
.rbcom()#0A#0A..1IF.a#3D0.RESULTIS.0#0A#0A..1WHILE.
token#3Ds_handle.|.token#3Ds_repeat.|#0A..7token#3D
s_repeatwhile.|.token#3Ds_repeatuntil.DO#0A..1{..LE
T.op,.ln.#3D.token,.lineno#0A..4IF.op#3Ds_handle.DO
.{..lex()#0A..25a.:#3D.mk4(op,.a,.rdfundef(),.ln)#0A
..25LOOP#0A..22}#0A..4IF.op#3Ds_repeat.DO.{..a.:#3D
.mk3(op,.a,.ln)#0A..25lex()#0A..25LOOP#0A..22}#0A..
4a.:#3D.mk4(op,.a,.rnexp(0),.ln)#0A..1}#0A#0A..1RES
ULTIS.a#0A}#0A#0ALET.plist2(x).BE#0A{..writef("*nNa
me.table.contents,.size.#3D.%n*n",.nametablesize)#0A
..1FOR.i.#3D.0.TO.nametablesize-1.DO#0A..1{..LET.p,
.n.#3D.nametable!i,.0#0A..4UNTIL.p#3D0.DO.p,.n.:#3D
.p!1,.n+1#0A..4writef("%i3:%n",.i,.n)#0A..4p.:#3D.n
ametable!i#0A..4UNTIL.p#3D0.DO.{..writef(".%s",.p+2
);.p.:#3D.p!1..}#0A..4newline()#0A..1}#0A}#0A#0A1LE
T.plist(x,.n,.d).BE.WHILE.x.SWITCHON.h1!x.INTO#0A{.
.DEFAULT:..1RETURN#0A#0A..1CASE.s_module:#0A..1CASE
.s_manifest:#0A..1CASE.s_global:#0A..1CASE.s_static
:#0A..1CASE.s_external:.newline()#0A..18plist1(x,.0
,.20)#0A..18x.:#3D.h3!x#0A..18LOOP#0A#0A..1CASE.s_f
un:..4newline()#0A..18plist1(x,.0,.20)#0A..18x.:#3D
.h4!x#0A..18LOOP#0A#0A}#0A#0AAND.plist1(x,.n,.d).BE
#0A{..LET.opstr,.size,.ln.#3D.0,.0,.0#0A..1LET.v.#3D
.TABLE.0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0#0A#0A
..1IF.x#3D0.DO.{..writes("Nil");.RETURN..}#0A#0A..1
SWITCHON.h1!x.INTO#0A..1{..CASE.s_numb:..3writen(h2
!x);..4RETURN#0A#0A..4CASE.s_vid:#0A..4CASE.s_cid:.
.4writef("%s",.x+2);.RETURN#0A#0A..4CASE.s_string:#0A
..11{..LET.len.#3D.h2!x#0A..14AND.s.#3D.x+2#0A..14w
rch('"')#0A..14FOR.i.#3D.0.TO.len.DO.wrch(s%i)#0A..
14wrch('"')#0A..14RETURN#0A..11}#0A#0A//.Expression
s#0A..4CASE.s_true:..1opstr,.size.:#3D."TRUE",.0;.E
NDCASE#0A..4CASE.s_false:..opstr,.size.:#3D."FALSE"
,.0;.ENDCASE#0A..4CASE.s_query:..opstr,.size.:#3D."
QUERY",.0;.ENDCASE#0A..4CASE.s_valof:..opstr,.size.
:#3D."VALOF",.1;.ENDCASE#0A..4CASE.s_lv:..3opstr,.s
ize.:#3D."LV",.1;.ENDCASE#0A..4CASE.s_inc1b:..opstr
,.size.:#3D."INC1B",.1;.ENDCASE#0A..4CASE.s_inc4b:.
.opstr,.size.:#3D."INC4B",.1;.ENDCASE#0A..4CASE.s_d
ec1b:..opstr,.size.:#3D."DEC1B",.1;.ENDCASE#0A..4CA
SE.s_dec4b:..opstr,.size.:#3D."DEC4B",.1;.ENDCASE#0A
..4CASE.s_neg:..2opstr,.size.:#3D."NEG",.1;.ENDCASE
#0A..4CASE.s_ltable:.opstr,.size.:#3D."LTABLE",.1;.
ENDCASE#0A..4CASE.s_table:..opstr,.size.:#3D."TABLE
",.1;.ENDCASE#0A..4CASE.s_vec:..2opstr,.size.:#3D."
VEC",.1;.ENDCASE#0A..4CASE.s_cvec:..1opstr,.size.:#3D
."CVEC",.1;.ENDCASE#0A..4CASE.s_not:..2opstr,.size.
:#3D."NOT",.1;.ENDCASE#0A..4CASE.s_bitnot:.opstr,.s
ize.:#3D."BITNOT",.1;.ENDCASE#0A..4CASE.s_abs:..2op
str,.size.:#3D."ABS",.1;.ENDCASE#0A..4CASE.s_call:.
.1opstr,.size,.ln.:#3D."CALL",.2,.h4!x;.ENDCASE#0A.
.4CASE.s_indb:..1opstr,.size.:#3D."INDB",.2;.ENDCAS
E#0A..4CASE.s_indb0:..opstr,.size.:#3D."INDB0",.1;.
ENDCASE#0A..4CASE.s_indw:..1opstr,.size.:#3D."INDW"
,.2;.ENDCASE#0A..4CASE.s_indw0:..opstr,.size.:#3D."
INDW0",.1;.ENDCASE#0A..4CASE.s_inc1a:..opstr,.size.
:#3D."INC1A",.1;.ENDCASE#0A..4CASE.s_inc4a:..opstr,
.size.:#3D."INC4A",.1;.ENDCASE#0A..4CASE.s_dec1a:..
opstr,.size.:#3D."DEC1A",.1;.ENDCASE#0A..4CASE.s_de
c4a:..opstr,.size.:#3D."DEC4A",.1;.ENDCASE#0A..4CAS
E.s_mod:..2opstr,.size.:#3D."MOD",.2;.ENDCASE#0A..4
CASE.s_mult:..1opstr,.size.:#3D."MULT",.2;.ENDCASE#0A
..4CASE.s_div:..2opstr,.size.:#3D."DIV",.2;.ENDCASE
#0A..4CASE.s_plus:..1opstr,.size.:#3D."PLUS",.2;.EN
DCASE#0A..4CASE.s_sub:..2opstr,.size.:#3D."SUB",.2;
.ENDCASE#0A..4CASE.s_eq:..3opstr,.size.:#3D."EQ",.2
;.ENDCASE#0A..4CASE.s_ne:..3opstr,.size.:#3D."NE",.
2;.ENDCASE#0A..4CASE.s_le:..3opstr,.size.:#3D."LE",
.2;.ENDCASE#0A..4CASE.s_ge:..3opstr,.size.:#3D."GE"
,.2;.ENDCASE#0A..4CASE.s_ls:..3opstr,.size.:#3D."LS
",.2;.ENDCASE#0A..4CASE.s_gr:..3opstr,.size.:#3D."G
R",.2;.ENDCASE#0A..4CASE.s_rel:..2opstr,.size.:#3D.
"REL",.2;.ENDCASE#0A..4CASE.s_lsh:..2opstr,.size.:#3D
."LSH",.2;.ENDCASE#0A..4CASE.s_rsh:..2opstr,.size.:
#3D."RSH",.2;.ENDCASE#0A..4CASE.s_bitand:.opstr,.si
ze.:#3D."BITAND",.2;.ENDCASE#0A..4CASE.s_bitor:..op
str,.size.:#3D."BITOR",.2;.ENDCASE#0A..4CASE.s_xor:
..2opstr,.size.:#3D."XOR",.2;.ENDCASE#0A..4CASE.s_o
r:..3opstr,.size.:#3D."OR",.2;.ENDCASE#0A..4CASE.s_
and:..2opstr,.size.:#3D."AND",.2;.ENDCASE#0A..4CASE
.s_cond:..1opstr,.size.:#3D."COND",.3;.ENDCASE#0A..
4CASE.s_comma:..opstr,.size.:#3D."COMMA",.2;.ENDCAS
E#0A#0A//.Patterns#0A..4CASE.s_dots:..3opstr,.size.
:#3D."DOTS",.2;.ENDCASE#0A..4CASE.s_ptr:..4opstr,.s
ize.:#3D."PTR",.1;.ENDCASE#0A..4CASE.s_peq:..4opstr
,.size.:#3D."PEQ",.1;.ENDCASE#0A..4CASE.s_pne:..4op
str,.size.:#3D."PNE",.1;.ENDCASE#0A..4CASE.s_ple:..
4opstr,.size.:#3D."PLE",.1;.ENDCASE#0A..4CASE.s_pge
:..4opstr,.size.:#3D."PGE",.1;.ENDCASE#0A..4CASE.s_
pls:..4opstr,.size.:#3D."PLS",.1;.ENDCASE#0A..4CASE
.s_pgr:..4opstr,.size.:#3D."PGR",.1;.ENDCASE#0A..4C
ASE.s_pass:..3opstr,.size.:#3D."PASS",.1;.ENDCASE#0A
..4CASE.s_plshass:..opstr,.size.:#3D."PLSHASS",.1;.
ENDCASE#0A..4CASE.s_prshass:..opstr,.size.:#3D."PRS
HASS",.1;.ENDCASE#0A..4CASE.s_pmultass:.opstr,.size
.:#3D."PMULTASS",.1;.ENDCASE#0A..4CASE.s_pdivass:..
opstr,.size.:#3D."PDIVASS",.1;.ENDCASE#0A..4CASE.s_
pmodass:..opstr,.size.:#3D."PMODASS",.1;.ENDCASE#0A
..4CASE.s_pandass:..opstr,.size.:#3D."PANDASS",.1;.
ENDCASE#0A..4CASE.s_pxorass:..opstr,.size.:#3D."PXO
RASS",.1;.ENDCASE#0A..4CASE.s_pplusass:.opstr,.size
.:#3D."PPLUSASS",.1;.ENDCASE#0A..4CASE.s_psubass:..
opstr,.size.:#3D."PSUBASS",.1;.ENDCASE#0A..4CASE.s_
porass:..1opstr,.size.:#3D."PORASS",.1;.ENDCASE#0A.
.4CASE.s_pand:..3opstr,.size.:#3D."PAND",.2;.ENDCAS
E#0A..4CASE.s_por:..4opstr,.size.:#3D."POR",.2;.END
CASE#0A#0A//.Commands#0A..4CASE.s_seq:..2opstr,.siz
e..3:#3D."SEQ",.2;.ENDCASE#0A..4CASE.s_scope:..opst
r,.size..3:#3D."SCOPE",.1;.ENDCASE#0A..4CASE.s_repe
at:.opstr,.size,.ln.:#3D."REPEAT",.1,.h3!x;.ENDCASE
#0A..4CASE.s_repeatuntil:#0A..19opstr,.size,.ln.:#3D
."REPEATUNTIL",.2,.h4!x;.ENDCASE#0A..4CASE.s_repeat
while:#0A..19opstr,.size,.ln.:#3D."REPEATWHILE",.2,
.h4!x;.ENDCASE#0A..4CASE.s_handle:.opstr,.size,.ln.
:#3D."HANDLE",.2,.h4!x;.ENDCASE#0A..4CASE.s_let:..2
opstr,.size,.ln.:#3D."LET",.1,.h3!x;.ENDCASE#0A..4C
ASE.s_raise:..opstr,.size,.ln.:#3D."RAISE",.1,.h3!x
;.ENDCASE#0A..4CASE.s_goto:..1opstr,.size,.ln.:#3D.
"GOTO",.1,.h3!x;.ENDCASE#0A..4CASE.s_test:..1opstr,
.size,.ln.:#3D."TEST",.3,.h5!x;.ENDCASE#0A..4CASE.s
_if:..3opstr,.size,.ln.:#3D."IF",.2,.h4!x;.ENDCASE#0A
..4CASE.s_unless:.opstr,.size,.ln.:#3D."UNLESS",.2,
.h4!x;.ENDCASE#0A..4CASE.s_until:..opstr,.size,.ln.
:#3D."UNTIL",.2,.h4!x;.ENDCASE#0A..4CASE.s_while:..
opstr,.size,.ln.:#3D."WHILE",.2,.h4!x;.ENDCASE#0A..
4CASE.s_for:..2opstr,.size,.ln.:#3D."FOR",.5,.h7!x;
.ENDCASE#0A..4CASE.s_every:..opstr,.size,.ln.:#3D."
EVERY",.2,.h4!x;.ENDCASE#0A..4CASE.s_match:..opstr,
.size,.ln.:#3D."MATCH",.2,.h4!x;.ENDCASE#0A..4CASE.
s_result:.opstr,.size,.ln.:#3D."RESULT",.1,.h3!x;.E
NDCASE#0A..4CASE.s_exit:..1opstr,.size,.ln.:#3D."EX
IT",.1,.h3!x;.ENDCASE#0A..4CASE.s_return:.opstr,.si
ze,.ln.:#3D."RETURN",.1,.h3!x;.ENDCASE#0A..4CASE.s_
loop:..1opstr,.size,.ln.:#3D."LOOP",.0,.h2!x;.ENDCA
SE#0A..4CASE.s_break:..opstr,.size,.ln.:#3D."BREAK"
,.0,.h2!x;.ENDCASE#0A..4CASE.s_ass:..2opstr,.size,.
ln.:#3D."ASS",.2,.h4!x;.ENDCASE#0A..4CASE.s_allass:
.opstr,.size,.ln.:#3D."ALLASS",.2,.h4!x;.ENDCASE#0A
..4CASE.s_lshass:.opstr,.size,.ln.:#3D."LSHASS",.2,
.h4!x;.ENDCASE#0A..4CASE.s_rshass:.opstr,.size,.ln.
:#3D."RSHASS",.2,.h4!x;.ENDCASE#0A..4CASE.s_multass
:opstr,.size,.ln.:#3D."MULTASS",.2,.h4!x;.ENDCASE#0A
..4CASE.s_divass:.opstr,.size,.ln.:#3D."DIVASS",.2,
.h4!x;.ENDCASE#0A..4CASE.s_modass:.opstr,.size,.ln.
:#3D."MODASS",.2,.h4!x;.ENDCASE#0A..4CASE.s_andass:
.opstr,.size,.ln.:#3D."ANDASS",.2,.h4!x;.ENDCASE#0A
..4CASE.s_xorass:.opstr,.size,.ln.:#3D."XORASS",.2,
.h4!x;.ENDCASE#0A..4CASE.s_plusass:opstr,.size,.ln.
:#3D."PLUSASS",.2,.h4!x;.ENDCASE#0A..4CASE.s_subass
:.opstr,.size,.ln.:#3D."SUBASS",.2,.h4!x;.ENDCASE#0A
..4CASE.s_orass:..opstr,.size,.ln.:#3D."ORASS",.2,.
h4!x;.ENDCASE#0A#0A//.Declarations#0A..4CASE.s_modu
le:..1opstr,.size,.ln.:#3D."MODULE",.2,.h4!x;.ENDCA
SE#0A..4CASE.s_fun:..4opstr,.size,.ln.:#3D."FUN",.2
,.h6!x;.ENDCASE#0A..4CASE.s_funpat:..1opstr,.size,.
ln.:#3D."FUNPAT",.3,.h5!x;.ENDCASE#0A..4CASE.s_mani
fest:.opstr,.size,.ln.:#3D."MANIFEST",.1,.h4!x;.END
CASE#0A..4CASE.s_mdef:..3opstr,.size.:#3D."MDEF",.3
;.ENDCASE#0A..4CASE.s_global:..1opstr,.size,.ln.:#3D
."GLOBAL",.1,.h4!x;.ENDCASE#0A..4CASE.s_gdef:..3ops
tr,.size.:#3D."GDEF",.3;.ENDCASE#0A..4CASE.s_static
:..1opstr,.size,.ln.:#3D."STATIC",.1,.h4!x;.ENDCASE
#0A..4CASE.s_sdef:..3opstr,.size.:#3D."SDEF",.3;.EN
DCASE#0A..4CASE.s_external:.opstr,.size,.ln.:#3D."E
XTERNAL",.1,.h4!x;.ENDCASE#0A..4CASE.s_xdef:..3opst
r,.size.:#3D."XDEF",.3;.ENDCASE#0A#0A..4DEFAULT:..o
pstr,.size.:#3D."Unknown",.0;.ENDCASE#0A..1}#0A#0A.
.1IF.n#3Dd.DO.{..writes("Etc");.RETURN.}#0A#0A..1wr
itef("%s",.opstr)#0A..1IF.ln>0.DO.writef("..line.%n
/%n",.ln>>00024,.ln.&.#23xFF4)#0A..1FOR.i.#3D.1.TO.
size.DO.{..newline()#0A..25FOR.j#3D0.TO.n-1.DO.writ
es(.v!j.)#0A..25writes("**-")#0A..25v!n.:#3D.i#3Dsi
ze->"..","!."#0A..25plist1(x!i,.n+1,.d)#0A..22}#0A}
#0A#0A2

######com/makeinit.b#
/*.MakeInit.--.Construct.an.initialisation.file.for
.a#0A*..multi-file.NATBCPL.application#2E#0A*..Writ
ten.by.Colin.Liebenrood..(cjlieben@waitrose#2Ecom)#0A
*#0A*..Slightly.modified.by.Martin.Richards.(mr@cl#2E
cam#2Eac#2Euk)#0A*..to.give.it.the.following.usage:
#0A*#0A*.makeinit.aa1#2Eb.bb1#2Eb.#2E#2E1.kk1#2Eb.t
o.init#2Ec.stacksize.2002.gsize.2001#0A*#0A*.$Log:.
makeinit#2Eb,v.$#0A*#0A*.Revision.2#2E0..0002010/09
/23.11:42:34..martin#0A*.Changed.the.default.stack.
size.to.5002#0A*#0A*.Revision.1#2E9..0002000009/09/
07.12:50:13..martin#0A*.Used.BCPLWORD.instead.of.WO
RD.plus.other.minor.changes#0A*.Changed.performget.
to.be.compatible.with.the.latest.bcplfe#0A*#0A*.Rev
ision.1#2E8..0002000004/04/25.07:38:23..martin#0A*.
Made.GET.directives.use.BCPLHDRS.environment.variab
le#0A*#0A*.Revision.1#2E7..0002000004/04/21.16:35:0
0..martin#0A*.Changed.rdargs.format.to.",,8TO/k/a,S
TKSIZE/k,GLOBSIZE/k"#0A*#0A*.Revision.1#2E6..000200
0004/04/03.14:53:05..colin#0A*.Revised.order.of.arg
uments,.to.allow.input.from.stdin.with.named.output
.only#0A*.Use.rdargs()-style.command.line#2E..Prote
ct.against.no.files.in.input-list#2E#0A*.Tidy.versi
on-number.display#2E#0A*#0A*.Revision.1#2E5..000200
0004/04/01.16:12:22..colin#0A*.Made.target.stack-si
ze.and.global.vector.size.into.parameters#2E#0A*.Al
tered.emitted.code.to.conform.to.revised.function.p
rototypes.in.bcpl#2Eh#0A*#0A*.Revision.1#2E4..00020
00004/03/21.17:45:13..colin#0A*.Fix.coding.error#0A
*#0A*.Revision.1#2E3..0002000004/03/21.17:42:03..co
lin#0A*.Fully.working?.with.comments.updated#0A*#0A
*.Revision.1#2E2..0002000004/03/19.20:17:00..colin#0A
*.Handling.multiple.files.and.storing.section-names
#2E.Wrong.status.returns#0A*#0A*.Revision.1#2E1..00
02000004/03/18.15:54:10..colin#0A*.Initial.revision
#0A*#0A*#0A*/#0A#0ASECTION."MakeInit"#0A#0AGET."lib
hdr"#0A.#0AMANIFEST.{.#0A//.Used.in.scanforsection(
),.lex().and.friends#0As_number#3D1;.s_name;.s_stri
ng;.s_true;.s_false#0As_div;.s_logand;.s_needs;.s_s
ection#0As_end;.s_lsect;.s_rsect;.s_get#0As_dot;.s_
eof#0A#0Ah1#3D0;.h2;.h3;.h4..10//..Selectors#0Abt_n
ame#3D0;.bt_left;.bt_right;.bt_file#0A#0Ac_backspac
e.#3D..0008..6//.Character.constants#0Ac_tab..5#3D.
.0009#0Ac_newline..1#3D.10#0Ac_newpage..1#3D.12#0Ac
_return..2#3D.13#0Ac_escape..2#3D.27#0Ac_space..3#3D
.32#0A#0Anametablesize.#3D.541#0Aworksize..4#3D.400
2#0Astoresize..3#3D.5001#0A#0ARTF8#3D1#0AGB2312#0A}
#0A.#0AGLOBAL.{#0A//.Variables.for.scanforsection()
.etc#0Agetstreams:ug;.charv;.token;.wordnode;.ch#0A
decval;.hdrs#0Abigender#0Askiptag;.lineno;.nametabl
e#0Atreep;.treevec;.sourcestream#0Ascanerror;.secti
onseen#0A#0A//.Global.variables#0Acurrentfile;.stor
evec;.storevp#0Asections;.stacksize;.gvecsize#0Adef
aultencoding#0Aencoding#0A}#0A.#0A#0ALET.start().#3D
.VALOF#0A{.LET.inputstream,.outputstream.#3D.?,.?#0A
..AND.work.#3D.?#0A..AND.fileseen,.runok.#3D.0,1#0A
..LET.argv.#3D.VEC.100#0A..LET.version.#3D.VEC.5#0A
#0A..UNLESS.rdargs(",,9TO/A/K,STKSIZE/K,GLOBSIZE/K"
,.argv,.100).DO.{#0A..2writes("Bad.arguments*n")#0A
..2RESULTIS.20#0A..}#0A#0A..outputstream.:#3D.findo
utput(argv.!.11)#0A..IF.outputstream.#3D.0.DO.{#0A.
.2writef("Cannot.open.file.%s*n",.argv.!.11)#0A..2R
ESULTIS.20#0A..}#0A#0A//.default.allocations.for.us
er.program..1#0A..stacksize.:#3D.5002#0A..IF.argv!1
2.DO.{#0A..2stacksize.:#3D.str2numb(argv!12)#0A..2I
F.stacksize.<.1002.DO.stacksize.:#3D.1002#0A..}#0A#0A
..gvecsize.:#3D.1001#0A..IF.argv!13.DO.{#0A..2gvecs
ize.:#3D.str2numb(argv!13)#0A..2IF.gvecsize.<.500.D
O.gvecsize.:#3D.500#0A..}#0A#0A..hdrs.:#3D."BCPLHDR
S"#0A..bigender.:#3D.(!"AA1".&.255).#3D.'A'.//.#3DT
RUE.if.running.on.a.bigender#0A#0A..writef("MakeIni
t.version.%s*n",.getversion(version))#0A#0A//.Alloc
ate.working.memory.for.scanning.the.files#0A..work.
:#3D.getvec(worksize)#0A..UNLESS.work.DO#0A..{.writ
es("Insufficient.memory*n")#0A..2RESULTIS.20#0A..}#0A
#0A//.Allocate.storage.for.information.found#0A..st
orevec.:#3D.getvec(storesize)#0A..UNLESS.storevec.D
O.{#0A..2writes("Insufficient.memory(store)*n")#0A.
.2RESULTIS.20#0A..}#0A#0A..storevp.:#3D.storevec+st
oresize#0A#0A//.Initialise.the.storage.and.add.a.un
iversal.entry#0A..sections.:#3D.0#0A..recordsection
("BLIB",."(run-time.library)")#0A..recordsection("D
LIB",."(system.dependent.library)")#0A#0A..FOR.i.#3D
.0.TO.10.DO#0A..{#0A..2//.Scan.the.input-file.for.f
ilenames#2E.Pass.each.name.found.to#0A..2//.scanfor
section().to.extract.any.SECTION."#2E#2E1".entries.
found,.#0A..2//.which.are.stored.in.storevec,.ancho
red.at.global.sections#2E#0A..2LET.file.#3D.argv!i#0A
..2UNLESS.file.LOOP#0A..2fileseen.:#3D.fileseen.+.1
#0A..2scanforsection(file,.work)#0A..2IF.scanerror.
>.0.DO.runok.:#3D.0#0A..}#0A#0A//.output.the.new.fi
le#0A..IF.fileseen.&.runok.DO.{#0A..2LET.op.#3D.out
put()#0A..2selectoutput(outputstream)#0A..2writeini
tfile()#0A..2UNLESS.outputstream#3Dop.DO.endwrite()
#0A..2selectoutput(op)#0A..}#0A#0A..UNLESS.fileseen
.DO.writes("Error.-.no.file(s).seen*n")#0A#0A..free
vec(work)#0A..freevec(storevec)#0A#0A..RESULTIS.fil
eseen.&.runok.->.0,.10.#0A}#0A#0A//.Extract.version
-number.from.Revision.string#0AAND.getversion(v).#3D
.VALOF.{#0A..LET.version.#3D."$Revision:.2#2E0.$"./
/.updated.by.RCS#0A..AND.len,.s,.d.#3D.0,.1,.1#0A#0A
..len.:#3D.version%0#0A..UNTIL.('0'.<#3D.version%s.
<#3D.'9').|.s.#3D.len.DO.s.:#3D.s.+.1#0A..UNTIL.ver
sion%s.#3D.'.'.|.s.#3D.len.DO.{#0A..2v%d.:#3D.versi
on%s#0A..2s.:#3D.s.+.1;.d.:#3D.d.+.1#0A..}#0A..v%0.
:#3D.d-1#0A..RESULTIS.v#0A}#0A#0A//.Scan.file.for.S
ECTION."#2E#2E2".entries,.using.workspace.for#0A//.
working.memory#2E#0AAND.scanforsection(file,.worksp
ace).BE.{#0A..treevec.:#3D.workspace#0A..treep.:#3D
.treevec.+.worksize#0A#0A..sourcestream.:#3D.findin
put(file)#0A..IF.sourcestream#3D0.DO.{.#0A..2writef
("Trouble.with.file.%s*n",.file)#0A..2scanerror.:#3D
.1#0A..2RETURN#0A..}#0A#0A..currentfile.:#3D.newstr
ing(file)#0A..selectinput(sourcestream)#0A..scanerr
or.:#3D.0#0A..sectionseen.:#3D.0#0A..lineno.:#3D.1#0A
..rch()#0A..getstreams.:#3D.0#0A..charv..4:#3D.newv
ec(256/bytesperword)..3#0A..nametable..:#3D.newvec(
nametablesize).#0A..FOR.i.#3D.0.TO.nametablesize.DO
.nametable!i.:#3D.0#0A..skiptag.:#3D.0#0A..declsysw
ords()#0A#0A..UNTIL.(ch#3Dendstreamch.&.getstreams#3D
0).|.scanerror.DO.{.#0A..2lex()#0A..2IF.token.#3D.s
_section.{#0A..4lex()#0A..4IF.token.#3D.s_string.DO
.{#0A..6recordsection(charv,.currentfile)#0A..6sect
ionseen.:#3D.1#0A..4}#0A..2}#0A..}#0A#0A..endread()
#0A..UNLESS.sectionseen.DO.{#0A..2writef("No.Sectio
n.seen.in.file.%s*n",.currentfile)#0A..2scanerror.:
#3D.1#0A..}#0A..RETURN#0A}#0A#0A//.Record.a.section
-entry.in.store,.using.a.binary-tree.structure,.so.
that#0A//.eventual.output.is.in.ascending.alphabeti
c.order.of.section.name#2E#0A//.Duplicate.section-n
ames.are.errors.and.are.reported.as.such#2E#0AAND.r
ecordsection(s,.f).BE.{#0A..LET.p.#3D.@sections#0A.
.LET.node.#3D.!p#0A#0A..UNTIL.node#3D0.DO.{#0A..2LE
T.cmp.#3D.cmpstr(s,.node!bt_name)#0A..2IF.cmp.#3D.0
.DO.{#0A..4writef("Duplicate.section.%s.in.%s.and.%
s*n",.s,.f,.node!bt_file)#0A..4scanerror.:#3D.scane
rror+1#0A..4RETURN#0A..2}#0A..2#0A..2p.:#3D.node.+.
(cmp.<.0.->.bt_left,.bt_right)#0A..2node.:#3D.!p#0A
..}#0A#0A..node.:#3D.newstorevec(bt_file)#0A..node!
bt_name.:#3D.newstring(s)#0A..node!bt_left,.node!bt
_right.:#3D.0,.0#0A..node!bt_file.:#3D.f#0A..!p.:#3D
.node#0A}#0A#0A//.Compare.two.strings,.ignoring.cas
e#0AAND.cmpstr(s1,.s2).#3D.VALOF#0A{.LET.len1,.len2
.#3D.s1%0,.s2%0#0A..FOR.i.#3D.1.TO.len1.DO#0A..{.LE
T.ch1,.ch2.#3D.s1%i,.s2%i#0A..2IF.i>len2..RESULTIS.
1#0A..2IF.'a'<#3Dch1<#3D'z'.DO.ch1:#3Dch1-'a'+'A'#0A
..2IF.'a'<#3Dch2<#3D'z'.DO.ch2:#3Dch2-'a'+'A'#0A..2
IF.ch1>ch2.RESULTIS.1#0A..2IF.ch1<ch2.RESULTIS.-1#0A
..}#0A..IF.len1<len2.RESULTIS.-1#0A..RESULTIS.0#0A}
#0A#0A//.Allocate.storage.for.section.and.file.name
s#0AAND.newstorevec(n).#3D.VALOF.{#0A..storevp.:#3D
.storevp.-.n.-.1#0A..IF.storevp.<#3D.storevec.DO.{#0A
..2writes("Out.of.store.space*n")#0A..2stop(20)#0A.
.}#0A#0A..RESULTIS.storevp#0A}#0A#0A//.Allocate.spa
ce.for.a.copy.of.string.s.in.the.store#0AAND.newstr
ing(s).#3D.VALOF.{#0A..LET.size.#3D.1.+.s%0./.bytes
perword#0A..LET.str.#3D.newstorevec(size)#0A..FOR.i
.#3D.0.TO.s%0#0A..1str%i.:#3D.s%i#0A#0A..RESULTIS.s
tr#0A}#0A#0A//.Write.the.initialisation.file,.using
.the.section-names.found#2E#0AAND.writeinitfile().B
E.{#0A..LET.version.#3D.VEC.5#0A..writef("/**.Initi
alisation.file.written.by.MakeInit.version.%s..**/*
n",#0A..6getversion(version))#0A..writes("#23includ
e.*"bcpl#2Eh*"*n")#0A..writef("*nint.stackupb#3D%n;
*n",.stacksize)#0A..writef("*nint.gvecupb#3D%n;*n",
..gvecsize)#0A..writes("*n/**.BCPL.sections..**/*n"
)#0A..//.List.references.to.other.modules#0A..lists
ects(sections,."extern.%s(BCPLWORD.**g);.*t/**.file
.%s..**/*n")#0A..newline()#0A..//.List.initsections
().functions#0A..writes("void.initsections(BCPLWORD
.**g).{*n")#0A..listsects(sections,."..5%s(g);.*t/*
*.file.%s..**/*n")#0A..writes("*n..5return;*n}*n")#0A
}#0A#0A//.List.store.entries.in.order.(binary.tree.
in-order.traverse),.using#0A//.the.passed.writef.fo
rmat.for.section-name.and.file-name#0AAND.listsects
(p,.fmt).BE.{#0A..1UNLESS.p.#3D.0.DO.{#0A..3listsec
ts(p!bt_left,.fmt)#0A..3writef(fmt,.p!bt_name,.p!bt
_file)#0A..3listsects(p!bt_right,.fmt)#0A..1}#0A}#0A
#0A//.lex().returns.the.next.relevant.symbol.from.t
he.current.input-stream,.in#0A//.globals.token.and.
charv#2E.This.routine.and.those.it.uses.have.been.e
xtracted#0A//.from.the.compiler.(bcpl#2Eb).and.simp
lified.for.this.purpose#2E#0AAND.lex().BE#0A{#0A..{
.SWITCHON.ch.INTO#0A#0A..2{.DEFAULT:#0A..10{.LET.ba
dch.#3D.ch#0A..12ch.:#3D.'*s'#0A..12synerr("Illegal
.character.%x2",.badch)#0A..10}#0A#0A..4CASE.'*p':#0A
..4CASE.'*n':.lineno.:#3D.lineno.+.1#0A#0A..4CASE.'
*c':#0A..4CASE.'*t':#0A..4CASE.'*s':#0A..14rch().RE
PEATWHILE.ch#3D'*s'#0A..14LOOP#0A#0A..4CASE.'0':CAS
E.'1':CASE.'2':CASE.'3':CASE.'4':#0A..4CASE.'5':CAS
E.'6':CASE.'7':CASE.'8':CASE.'9':#0A..4CASE.'_':#0A
..14rch();.LOOP#0A.#0A..4CASE.'a':CASE.'b':CASE.'c'
:CASE.'d':CASE.'e':#0A..4CASE.'f':CASE.'g':CASE.'h'
:CASE.'i':CASE.'j':#0A..4CASE.'k':CASE.'l':CASE.'m'
:CASE.'n':CASE.'o':#0A..4CASE.'p':CASE.'q':CASE.'r'
:CASE.'s':CASE.'t':#0A..4CASE.'u':CASE.'v':CASE.'w'
:CASE.'x':CASE.'y':#0A..4CASE.'z':#0A..4CASE.'A':CA
SE.'B':CASE.'C':CASE.'D':CASE.'E':#0A..4CASE.'F':CA
SE.'G':CASE.'H':CASE.'I':CASE.'J':#0A..4CASE.'K':CA
SE.'L':CASE.'M':CASE.'N':CASE.'O':#0A..4CASE.'P':CA
SE.'Q':CASE.'R':CASE.'S':CASE.'T':#0A..4CASE.'U':CA
SE.'V':CASE.'W':CASE.'X':CASE.'Y':#0A..4CASE.'Z':#0A
..13token.:#3D.lookupword(rdtag(ch))#0A..13IF.token
#3Ds_get.DO.{.performget();.LOOP..}#0A..13RETURN#0A
.#0A..4CASE.'$':#0A..13rch()#0A..13IF.ch#3D'$'.|.ch
#3D'<'.|.ch#3D'>'.DO#0A..13{.LET.k.#3D.ch#0A..15tok
en.:#3D.lookupword(rdtag('<'))#0A..15//.token.#3D.s
_true..11if.the.tag.is.set#0A..15//..4#3D.s_false.o
r.s_name..otherwise#0A.#0A..15//.$>tag..1marks.the.
end.of.a.conditional#0A..15//..7skipping.section#0A
..15IF.k#3D'>'.DO#0A..15{.IF.skiptag#3Dwordnode.DO#0A
..20skiptag.:#3D.0..1//.Matching.$>tag.found#0A..17
LOOP#0A..15}#0A.#0A..15UNLESS.skiptag#3D0.LOOP#0A#0A
..15//.Only.process.$<tag.and.$$tag.if.not.skipping
#0A.#0A..15//.$$tag..complements.the.value.of.a.tag
#0A..15IF.k#3D'$'.DO#0A..15{.h1!wordnode.:#3D.token
#3Ds_true.->.s_false,.s_true#0A..17LOOP#0A..15}#0A.
#0A..15//.$<tag#0A..15IF.token#3Ds_true.LOOP..4//.D
on't.skip.if.set#0A#0A..15//.tag.is.false.so.skip.u
ntil.matching.$>tag.or.EOF#0A..15skiptag.:#3D.wordn
ode#0A..15UNTIL.skiptag#3D0.|.token#3Ds_end.DO.lex(
)#0A..15skiptag.:#3D.0#0A..15LOOP#0A..12}#0A.#0A..1
2UNLESS.ch#3D'('.|.ch#3D')'.DO.synerr("'$'.out.of.c
ontext")#0A..12token.:#3D.ch#3D'('.->.s_lsect,.s_rs
ect#0A..12lookupword(rdtag('$'))#0A..12LOOP.//RETUR
N#0A.#0A..4CASE.'/':#0A..13rch()#0A..13IF.ch#3D'\'.
DO.{.token.:#3D.s_logand;.BREAK.}#0A..13IF.ch#3D'/'
.DO#0A..13{.rch().REPEATUNTIL.ch#3D'*n'.|.ch#3Dends
treamch#0A..15LOOP#0A..13}#0A.#0A..13IF.ch#3D'**'.D
O#0A..13{.LET.depth.#3D.1#0A#0A..15{.rch()#0A..17IF
.ch#3D'**'.DO#0A..17{.rch().REPEATWHILE.ch#3D'**'#0A
..19IF.ch#3D'/'.DO.{..depth.:#3D.depth-1;.LOOP.}#0A
..17}#0A..17IF.ch#3D'/'.DO#0A..17{.rch()#0A..19IF.c
h#3D'**'.DO.{..depth.:#3D.depth+1;.LOOP.}#0A..17}#0A
..17IF.ch#3D'*n'.DO.lineno.:#3D.lineno+1#0A..17IF.c
h#3Dendstreamch.DO.synerr("Missing.'**/'")#0A..15}.
REPEATUNTIL.depth#3D0#0A#0A..15rch()#0A..15LOOP#0A.
.13}#0A#0A..13token.:#3D.s_div#0A..13LOOP#0A#0A..4C
ASE.'#23':#0A..13token.:#3D.s_number#0A..13rch()#0A
..13IF.'0'<#3Dch<#3D'7'..2DO.{..6readnumber(8,..000
100);.LOOP..}#0A..13IF.ch#3D'b'.|.ch#3D'B'.DO.{.rch
();.readnumber(2,..000100);.LOOP..}#0A..13IF.ch#3D'
o'.|.ch#3D'O'.DO.{.rch();.readnumber(8,..000100);.L
OOP..}#0A..13IF.ch#3D'x'.|.ch#3D'X'.DO.{.rch();.rea
dnumber(16,.100);.LOOP..}#0A..13LOOP#0A.#0A..4CASE.
'#2E':.token.:#3D.s_dot;..5BREAK#0A#0A..4CASE.'{':.
CASE.'}':.#0A..4CASE.'[':.CASE.'(':.CASE.']':.CASE.
')':.CASE.'?':.#0A..4CASE.'+':.CASE.',':.CASE.';':.
CASE.'@':.CASE.'&':.#0A..4CASE.'|':.CASE.'#3D':.CAS
E.'!':.CASE.'%':.CASE.'**':#0A..4CASE.'~':.CASE.'\'
:.CASE.'<':.CASE.'>':..CASE.'-':#0A..4CASE.':':.#0A
..14rch()#0A..14LOOP#0A#0A..4CASE.'"':#0A..9{.LET.l
en.#3D.0#0A..11rch()#0A..11encoding.:#3D.defaultenc
oding.//.encoding.for.*#23.escapes#0A#0A..11UNTIL.c
h#3D'"'.DO#0A..11{.LET.code.#3D.rdstrch()#0A..13TES
T.result2#0A..13THEN.{.//.A..*#23.code.found#2E#0A.
.20//.Convert.it.to.UTF8.or.GB2312.format#2E#0A..20
TEST.encoding#3DGB2312#0A..20THEN.{.//.Convert.to.G
B2312.sequence#0A..27IF.code>#23x7F.DO#0A..27{.LET.
hi.#3D.code../..000100.+.160#0A..29LET.lo.#3D.code.
MOD.100.+.160#0A..29IF.len>#3D254.DO.synerr("Bad.st
ring.constant")#0A..29TEST.bigender#0A..29THEN.{.ch
arv%(len+1).:#3D.hi.#0A..36charv%(len+2).:#3D.lo#0A
..34}#0A..29ELSE.{.charv%(len+1).:#3D.lo.#0A..36cha
rv%(len+2).:#3D.hi#0A..34}#0A..29len.:#3D.len.+.2#0A
..29LOOP#0A..27}#0A..27IF.len>#3D255.DO.synerr("Bad
.string.constant")#0A..27charv%(len+1).:#3D.code.//
.Ordinary.ASCII.char#0A..27len.:#3D.len.+.1#0A..27L
OOP#0A..25}#0A..20ELSE.{.//.Convert.to.UTF8.sequenc
e#0A..27IF.code<#3D#23x7F.DO#0A..27{.IF.len>#3D255.
DO.synerr("Bad.string.constant")#0A..29charv%(len+1
).:#3D.code..1//.0xx5#0A..29len.:#3D.len.+.1#0A..29
LOOP#0A..27}#0A..27IF.code<#3D#23x7FF.DO#0A..27{.IF
.len>#3D254.DO.synerr("Bad.string.constant")#0A..29
charv%(len+1).:#3D.#23b1100000_002+(code>>0006)..//
.110000xx3#0A..29charv%(len+2).:#3D.#23x80+(.code..
2&#23x3F)..//.10xx4#0A..29len.:#3D.len.+.2#0A..29LO
OP#0A..27}#0A..27IF.code<#3D#23xFF2.DO#0A..27{.IF.l
en>#3D253.DO.synerr("Bad.string.constant")#0A..29ch
arv%(len+1).:#3D.#23b110010_002+(code>>00012).//.11
0010xx2#0A..29charv%(len+2).:#3D.#23x80+((code>>000
6)&#23x3F)..//.10xx4#0A..29charv%(len+3).:#3D.#23x8
0+(.code..2&#23x3F)..//.10xx4#0A..29len.:#3D.len.+.
3#0A..29LOOP#0A..27}#0A..27IF.code<#3D#23x1F_FF2.DO
#0A..27{.IF.len>#3D252.DO.synerr("Bad.string.consta
nt")#0A..29charv%(len+1).:#3D.#23b112_002+(code>>00
018).//.110020xx1#0A..29charv%(len+2).:#3D.#23x80+(
(code>>00012)&#23x3F).//.10xx4#0A..29charv%(len+3).
:#3D.#23x80+((code>>.6)&#23x3F).//.10xx4#0A..29char
v%(len+4).:#3D.#23x80+(.code..3&#23x3F).//.10xx4#0A
..29len.:#3D.len.+.4#0A..29LOOP#0A..27}#0A..27IF.co
de<#3D#23x3FF_FF2.DO#0A..27{.IF.len>#3D251.DO.syner
r("Bad.string.constant")#0A..29charv%(len+1).:#3D.#23
b112_1001+(code>>00024).//.110030xx#0A..29charv%(le
n+2).:#3D.#23x80+((code>>00018)&#23x3F).//.10xx4#0A
..29charv%(len+3).:#3D.#23x80+((code>>00012)&#23x3F
).//.10xx4#0A..29charv%(len+4).:#3D.#23x80+((code>>
.6)&#23x3F).//.10xx4#0A..29charv%(len+5).:#3D.#23x8
0+(.code..3&#23x3F).//.10xx4#0A..29len.:#3D.len.+.5
#0A..29LOOP#0A..27}#0A..27IF.code<#3D#23x7FF1_FF2.D
O#0A..27{.IF.len>#3D250.DO.synerr("Bad.string.const
ant")#0A..29charv%(len+1).:#3D.#23b112_1100000+(cod
e>>00030).//.110040x#0A..29charv%(len+2).:#3D.#23x8
0+((code>>00024)&#23x3F).//.10xx4#0A..29charv%(len+
3).:#3D.#23x80+((code>>00018)&#23x3F).//.10xx4#0A..
29charv%(len+4).:#3D.#23x80+((code>>00012)&#23x3F).
//.10xx4#0A..29charv%(len+5).:#3D.#23x80+((code>>.6
)&#23x3F).//.10xx4#0A..29charv%(len+6).:#3D.#23x80+
(.code..3&#23x3F).//.10xx4#0A..29len.:#3D.len.+.6#0A
..29LOOP#0A..27}#0A..27synerr("Bad.Unicode.characte
r")#0A..25}#0A..18}#0A..13ELSE.{.//.Not.a.Unicode.c
haracter#0A..20IF.len#3D255.DO.synerr("Bad.string.c
onstant")#0A..20len.:#3D.len.+.1#0A..20charv%len.:#3D
.code#0A..18}#0A..11}#0A.#0A..11charv%0.:#3D.len#0A
..11token.:#3D.s_string#0A..11BREAK#0A..8}#0A..#0A.
.4CASE.'*'':#0A..12rch()#0A..12encoding.:#3D.defaul
tencoding#0A..12decval.:#3D.rdstrch()#0A..12token.:
#3D.s_number#0A..12UNLESS.ch#3D'*''.DO.synerr("Bad.
character.constant")#0A..12BREAK#0A#0A..5CASE.endst
reamch:#0A..12IF.getstreams.DO#0A..12{.//.Return.fr
om.a.'GET'.stream#0A..14LET.p.#3D.getstreams#0A..14
endread()#0A..14ch..9:#3D.h4!getstreams#0A..14linen
o..5:#3D.h3!getstreams#0A..14sourcestream.:#3D.h2!g
etstreams#0A..14getstreams..1:#3D.h1!getstreams#0A.
.14freevec(p).//.Free.the.GET.node#0A..14selectinpu
t(sourcestream)#0A..14LOOP#0A..12}#0A..12//.endstre
amch.#3D>.EOF.only.at.outermost.GET.level.#0A..12to
ken.:#3D.s_eof#0A..12RETURN#0A..2}#0A..}.REPEAT#0A.
#0A..rch()#0A}#0A#0A//.Access.and.maintain.a.symbol
-table.for.lex()#0AAND.lookupword(word).#3D.VALOF#0A
{.LET.len,.i.#3D.word%0,.0#0A..LET.hashval.#3D.1960
9.//.This.and.31397.are.primes#2E#0A..FOR.i.#3D.0.T
O.len.DO.hashval.:#3D.(hashval.NEQV.word%i).*.31397
#0A..hashval.:#3D.(hashval>>0001).REM.nametablesize
#0A#0A..wordnode.:#3D.nametable!hashval#0A.#0A..UNT
IL.wordnode#3D0.|.i>len.TEST.(@h3!wordnode)%i#3Dwor
d%i#0A..25THEN.i.:#3D.i+1#0A..25ELSE.wordnode,.i.:#3D
.h2!wordnode,.0#0A.#0A..IF.wordnode#3D0.DO#0A..{.wo
rdnode.:#3D.newvec(len/bytesperword+3)#0A..2h1!word
node,.h2!wordnode.:#3D.s_name,.nametable!hashval#0A
..2FOR.i.#3D.0.TO.len.DO.(@h3!wordnode)%i.:#3D.word
%i#0A..2nametable!hashval.:#3D.wordnode#0A..}#0A.#0A
..RESULTIS.h1!wordnode#0A}#0A.#0A//.Symbol-table.in
itialisation#0AAND.dsw(word,.sym).BE.{.lookupword(w
ord);.h1!wordnode.:#3D.sym..}#0A.#0AAND.declsysword
s().BE#0A{.dsw("GET",.s_get)#0A..dsw("NEEDS",.s_nee
ds)#0A..dsw("SECTION",.s_section)#0A..dsw("$",.0)#0A
}.#0A.#0A//.lex().support-routines#0AAND.rch().BE.{
#0A..2ch:#3D.rdch()#0A}#0A.#0AAND.rdtag(ch1).#3D.VA
LOF#0A{.LET.len.#3D.1#0A..charv%1.:#3D.ch1#0A.#0A..
{.rch()#0A..2UNLESS.'a'<#3Dch<#3D'z'.|.'A'<#3Dch<#3D
'Z'.|#0A..9'0'<#3Dch<#3D'9'.|.ch#3D'#2E'.|.ch#3D'_'
.BREAK#0A..2len.:#3D.len+1#0A..2charv%len.:#3D.ch#0A
..}.REPEAT#0A.#0A..charv%0.:#3D.len#0A..RESULTIS.ch
arv#0A}#0A.#0AAND.catstr(s1,.s2).#3D.VALOF#0A//.Con
catenate.strings.s1.and.s2.leaving.the.result.in.s1
#2E#0A//.s1.is.assumed.to.be.able.to.hold.a.string.
of.length.255#2E#0A//.The.resulting.string.is.trunc
ated.to.length.255,.if.necessary#2E.#0A{.LET.len.#3D
.s1%0#0A..LET.n.#3D.len#0A..FOR.i.#3D.1.TO.s2%0.DO#0A
..{.n.:#3D.n+1#0A..2IF.n>255.BREAK#0A..2s1%n.:#3D.s
2%i#0A..}#0A..s1%0.:#3D.n#0A}.#0A.#0AAND.performget
().BE#0A{.LET.stream.#3D.?#0A..LET.len.#3D.0#0A..le
x()#0A..UNLESS.token#3Ds_string.DO.synerr("Bad.GET.
directive")#0A..len.:#3D.charv%0#0A#0A..//.Append.#2E
h.to.the.GET.filename.does.not.end.in.#2Eh.or.#2Eb#0A
..UNLESS.len>#3D2.&.charv%(len-1)#3D'#2E'.&.#0A..7(
charv%len#3D'h'.|.charv%len#3D'b').DO#0A..{.len.:#3D
.len+2#0A..2charv%0,.charv%(len-1),.charv%len.:#3D.
len,.'#2E',.'h'#0A..}#0A#0A..FOR.i.#3D.1.TO.charv%0
.IF.charv%i#3D':'.DO.charv%i.:#3D.'/'#0A#0A..//.Fir
st.look.in.the.current.directory#0A..//writef("Sear
ching.for.*"%s*".in.the.current.directory*n",.charv
)#0A..stream.:#3D.findinput(charv)#0A#0A..//.Then.t
ry.the.headers.directories#0A..//UNLESS.stream.DO.w
ritef("Searching.for.*"%s*".in.%s*n",.charv,.hdrs)#0A
..UNLESS.stream.DO.stream.:#3D.pathfindinput(charv,
.hdrs)#0A#0A..//.Finally.prepend.g/.and.lookup.in.t
he.system.root.directory#0A..UNLESS.stream.DO#0A..{
.LET.filename.#3D.VEC.256/bytesperword#0A..2filenam
e%0.:#3D.0#0A..2catstr(filename,."g/")#0A..2catstr(
filename,.charv)#0A..2//writef("Searching.for.*"%s*
".in.%s*n",.filename,.rootnode!rtn_rootvar)#0A..2st
ream.:#3D.pathfindinput(filename,.rootnode!rtn_root
var)#0A..}#0A#0A..UNLESS.stream.DO#0A..{.synerr("Un
able.to.find.GET.file.%s",.charv)#0A..2RETURN#0A..}
#0A#0A..{.LET.len.#3D.charv%0#0A..2LET.node.#3D.get
vec(4.+.len/bytesperword)#0A..2LET.str.#3D.@node!4#0A
#0A..2UNLESS.node.DO.synerr("getvec.failure.in.perf
ormget")#0A#0A..2FOR.i.#3D.0.TO.len.DO.str%i.:#3D.c
harv%i#0A//..2sourcefileno.:#3D.sourcefileno+1#0A//
..2sourcenamev!sourcefileno.:#3D.str#0A..2node!0,.n
ode!1,.node!2,.node!3.:#3D.getstreams,.sourcestream
,.lineno,.ch#0A..2getstreams.:#3D.node#0A..}#0A#0A.
.sourcestream.:#3D.stream#0A..selectinput(sourcestr
eam)#0A..lineno.:#3D.1#0A..rch()#0A}#0A.#0AAND.read
number(radix,.digs).#3D.VALOF#0A//.Read.a.binary,.o
ctal,.decimal.or.hexadecimal.unsigned.number#0A//.w
ith.between.1.and.digs.digits#2E.Underlines.are.all
owed#2E#0A//.This.function.is.used.for.numerical.co
nstants.and.numerical#0A//.escapes.in.string.and.ch
aracter.constants#2E#0A{.LET.i,.res.#3D.0,.0#0A.#0A
..{.UNLESS.ch#3D'_'.DO.//.ignore.underlines#0A..2{.
LET.d.#3D.value(ch)#0A..4IF.d>#3Dradix.BREAK#0A..4i
.:#3D.i+1..5//.Increment.count.of.digits#0A..4res.:
#3D.radix*res.+.d#0A..2}#0A..2rch()#0A..}.REPEATWHI
LE.i<digs#0A#0A..UNLESS.i.DO.synerr("Bad.number")#0A
..RESULTIS.res#0A}#0A.#0AAND.value(ch).#3D.'0'<#3Dc
h<#3D'9'.->.ch-'0',#0A..14'A'<#3Dch<#3D'F'.->.ch-'A
'+10,#0A..14'a'<#3Dch<#3D'f'.->.ch-'a'+10,#0A..0141
00#0A.#0AAND.rdstrch().#3D.VALOF#0A{.//.Return.the.
integer.code.for.the.next.string.character#0A..//.S
et.result2#3DTRUE.if.*#23.character.code.was.found,
.otherwise.FALSE#0A..LET.k.#3D.ch#0A#0A..IF.k#3D'*n
'.|.k#3D'*p'.DO#0A..{.lineno.:#3D.lineno+1#0A..2syn
err("Unescaped.newline.character")#0A..}#0A.#0A..IF
.k#3D'**'.DO#0A..{.rch()#0A..2k.:#3D.ch#0A..2IF.'a'
<#3Dk<#3D'z'.DO.k.:#3D.k.+.'A'.-.'a'#0A..2SWITCHON.
k.INTO#0A..2{.CASE.'*n':#0A..4CASE.'*c':#0A..4CASE.
'*p':#0A..4CASE.'*s':#0A..4CASE.'*t':.WHILE.ch#3D'*
n'.|.ch#3D'*c'.|.ch#3D'*p'.|.ch#3D'*s'.|.ch#3D'*t'.
DO#0A..15{.IF.ch#3D'*n'.DO.lineno.:#3D.lineno+1#0A.
.17rch()#0A..15}#0A..15IF.ch#3D'**'.DO.{.rch();.LOO
P..}#0A#0A..4DEFAULT:..1synerr("Bad.string.or.chara
cter.constant,.ch#3D%n",.ch)#0A..7#0A..4CASE.'**':#0A
..4CASE.'*'':#0A..4CASE.'"':..18ENDCASE#0A..7#0A..4
CASE.'T':..k.:#3D.c_tab;..5ENDCASE#0A..4CASE.'S':..
k.:#3D.c_space;..3ENDCASE#0A..4CASE.'N':..k.:#3D.c_
newline;..1ENDCASE#0A..4CASE.'E':..k.:#3D.c_escape;
..2ENDCASE#0A..4CASE.'B':..k.:#3D.c_backspace;.ENDC
ASE#0A..4CASE.'P':..k.:#3D.c_newpage;..1ENDCASE#0A.
.4CASE.'C':..k.:#3D.c_return;..2ENDCASE#0A..7#0A..4
CASE.'X':..//.*xhh..--.A.character.escape.in.hexade
cimal#0A..15rch()#0A..15k.:#3D.readnumber(16,2)#0A.
.15result2.:#3D.FALSE#0A..15RESULTIS.k#0A#0A..4CASE
.'#23':..//.*#23u..1set.UTF8.mode#0A..15//.*#23g..1
set.GB2312.mode#0A..15//.In.UTF8.mode#0A..15//..3*#23
hh2.or.*#23#23hh6..--.a.Unicode.character#0A..15//.
In.GB2312#0A..15//..3*#23dd2..15--.A.GB2312.code#0A
..13{.LET.digs.#3D.4#0A..15rch()#0A..15IF.ch#3D'u'.
|.ch#3D'U'.DO.{.encoding.:#3D.UTF8;..1rch();.LOOP.}
#0A..15IF.ch#3D'g'.|.ch#3D'G'.DO.{.encoding.:#3D.GB
2312;.rch();.LOOP.}#0A..15TEST.encoding#3DGB2312#0A
..15THEN.{.#0A..22k.:#3D.readnumber(10,.digs)#0A//s
awritef("rdstrch:.GB2312:.%i4*n",.k)#0A..20}#0A..15
ELSE.{.IF.ch#3D'#23'.DO.{.rch();.digs.:#3D.8.}#0A..
22k.:#3D.readnumber(16,.digs)#0A//sawritef("rdstrch
:.Unicode:.%x4*n",.k)#0A..20}#0A..15result2.:#3D.TR
UE#0A..15RESULTIS.k#0A..13}#0A#0A..4CASE.'0':CASE.'
1':CASE.'2':CASE.'3':CASE.'4':#0A..4CASE.'5':CASE.'
6':CASE.'7':#0A..15//.*oo1.--.A.character.escape.in
.octal.#0A..15k.:#3D.readnumber(8,3)#0A..15IF.k>255
.DO.#0A..21synerr("Bad.string.or.character.constant
")#0A..15result2.:#3D.FALSE#0A..15RESULTIS.k#0A..2}
#0A..}#0A..1#0A..rch()#0A..result2.:#3D.FALSE#0A..R
ESULTIS.k#0A}.REPEAT#0A#0AAND.newvec(n).#3D.VALOF#0A
{.treep.:#3D.treep.-.n.-.1;#0A..IF.treep<#3Dtreevec
.DO#0A..3synerr("More.workspace.needed")#0A#0A..RES
ULTIS.treep#0A}#0A#0AAND.list4(x,.y,.z,.t).#3D.VALO
F#0A{.LET.p.#3D.newvec(3)#0A..p!0,.p!1,.p!2,.p!3.:#3D
.x,.y,.z,.t#0A..RESULTIS.p#0A}#0A.#0AAND.synerr(mes
s,.a,.b).BE.{#0A..writef("*nError.near.line.%n:..",
.lineno)#0A..writef(mess,.a,.b)#0A..//writef(".in.f
ile.%s*n",.currentfile)#0A..newline()#0A..scanerror
.:#3D.1#0A}#0A

######com/map.b#
//.(C).Copyright.1990002.Martin.Richards#0A#0A//.Co
mmand.to.map.the.store.allocation.under.the.Cintpos
.system#2E#0A//.It.counts.the.store.used.for.its.ow
n.code,.stack#0A//.and.workspace.as.free#2E#0A//#0A
//.It.is.based.on.the.map.command.from.the.Tripos.O
perating.System#0A//#0A//.MAP.[BLOCKS].[CODE].[NAME
S].[MAPSTORE].[TO.file]#0A//..3[PIC]#0A//#0A//..3BL
OCKS.gives.size.and.address.of.every.block#0A//..3C
ODE..1gives.layout.of.loaded.code.sections#0A//..3N
AMES..gives.space.used.for.routine.names,#0A//..10s
ection.names,.and.global.initialisation.info#2E#0A/
/..3TO..3specifies.an.output.file#0A//..3PIC..2give
s.the.allocation.map.in.picture.form#0A#0ASECTION."
MAP"#0A#0AGET."libhdr"#0A#0AMANIFEST.$(#0A..7maxpri
..2#3D.maxint#0A#0A..7sectnamesize.#09#3D.(11.+.byt
esperword)/bytesperword#0A..7routnamesize.#09#3D.(1
1.+.bytesperword)/bytesperword#0A..7nameoffset.#09#3D
.-routnamesize#0A..7vecupb.#09#3D.5001#0A..7$)#0A#0A
LET.start().#3D.VALOF#0A$(..LET.blocklist.#09#3D.0.
//rootnode.!.rtn_blklist#0A..2LET.a.#09#09#3D.block
list#0A..2LET.topofstore.#09#3D.rootnodeaddr.!.rtn_
memsize.//.*.1024#0A..2LET.free,.used,.n.#09#3D.0,.
0,.0#0A..2LET.blocks.#09#09#3D.getvec(vecupb)#0A..2
LET.argv.#09#09#3D.VEC.50#0A..2LET.largest_free.#09
#3D.0#0A..2LET.joinfree.#09#3D.0#0A..2LET.blocksopt
.#09#3D.FALSE#0A..2LET.namesopt.#09#3D.FALSE#0A..2L
ET.codeopt.#09#3D.FALSE#0A..2LET.mapstore.#09#3D.FA
LSE#0A..2LET.picopt.#09#09#3D.FALSE#0A..2LET.mapsta
ck.#09#3D.currco.-.1..//.stackbase.-.1#0A..2LET.map
code..#09#3D.cli_module-1..//.Section.vector#0A..2L
ET.sectnames,.routnames,.globinit.#3D.0,.0,.0#0A..2
LET.constr.#09#09#3D.output()#0A..2LET.outstr.#09#09
#3D.0#0A..2LET.rdargs_string#09#3D."BLOCKS/S,NAMES/
S,CODE/S,MAPSTORE/S,TO/K,PIC/S"#0A#0A..2IF.rdargs(r
dargs_string,.argv,.50).#3D.0.DO#0A..2$(.writef("MA
P:.Bad.args.for.key.string.*"%S*"*N",.rdargs_string
)#0A..5freevec(blocks)#0A..5RESULTIS.20#0A..2$)#0A#0A
..2IF.blocks.#3D.0.DO#0A..2$(.writes("MAP:.Not.enou
gh.store.for.workspace*N")#0A..5RESULTIS.20#0A..2$)
#0A#0A..2blocksopt.:#3D.argv!0#0A..2namesopt.:#3D.a
rgv!1#0A..2codeopt.:#3D.argv!2#0A..2IF.argv!3.DO.ma
pstore,.codeopt,.namesopt.:#3D.TRUE,.TRUE,.TRUE#0A.
.2IF.argv!4.DO#0A..2$(.outstr.:#3D.findoutput(argv!
4)#0A..5IF.outstr.#3D.0.DO#0A..5$(.writef("Can't.op
en.%S*N",.argv!4)#0A..8freevec(blocks)#0A..8RESULTI
S.20#0A..5$)#0A..5selectoutput(outstr)#0A..2$)#0A#0A
..2picopt.:#3D.argv!5#0A#0A..2//.Take.highest.task.
priority.for.critical.section#0A..2//.(Should.alway
s.be.available.if.we.are.running)#0A..2//changepri(
taskid,.maxpri)#0A#0A..2UNTIL.!a.#3D.0.DO#0A..2$(.L
ET.size.#3D.!a#0A..5LET.next.#3D.?#0A..5IF.a.#3D.ma
pstack.|.a.#3D.mapcode.|.a.#3D.blocks-1.DO#0A..8siz
e.:#3D.size.+.1.//.Make.it.look.free#0A#0A..5blocks
!n.:#3D.size;.n.:#3D.n.+.1#0A..5TEST.(size.&.1).#3D
.0#0A..5THEN.$(.//.Used.block#0A..13used.:#3D.used.
+.size#0A..13IF.joinfree.>.largest_free#0A..13THEN.
largest_free.:#3D.joinfree#0A..13joinfree.:#3D.0#0A
..10$)#0A..5ELSE.$(.size.:#3D.size-1#0A..13free.:#3D
.free.+.size#0A..13joinfree.:#3D.joinfree.+.size#0A
..10$)#0A#0A..5next.:#3D.a.+.size#0A..5UNLESS.size>
#3D0.&.next<#3Dtopofstore.DO#0A..5$(.//changepri(ta
skid,.oldpri)#0A..8writef("**4Store.chain.corrupt!!
*N*#0A..15*Noticed.at.%n*n",.a)#0A..8BREAK#0A..5$)#0A
..5a.:#3D.next#0A..5IF.n.>.vecupb.DO#0A..5$(.writef
("*N**4.Too.many.blocks.for.MAP's.workspace*N*#0A..
15**5.Only.the.first.%N.mapped*N",.vecupb+1)#0A..8B
REAK#0A..5$)#0A..2$)#0A#0A..2IF.joinfree.>.largest_
free.DO.largest_free.:#3D.joinfree#0A#0A..2//change
pri(taskid,.oldpri)#0A#0A..2//.Now.print.what.we've
.found#0A..2newline()#0A#0A..2IF.blocksopt.DO#0A..2
$(.writes("Map.of.free.and.allocated.store*N*N")#0A
#0A..5a.:#3D.blocklist#0A#0A..5FOR.i.#3D.0.TO.n-1.D
O#0A..5$(..1LET.s.#3D.blocks!i#0A..10LET.free.#3D.(
s&1)#3D1#0A#0A..10//IF.testflags(1).GOTO.exit#0A#0A
..10writef("%i8:.",.a)#0A..10TEST.free#0A..10THEN.$
(.writes("free.").;.s.:#3D.s.-.1.$)#0A..10ELSE..2wr
ites("alloc")#0A#0A..10writef("%i8.words",.s)#0A..1
0IF.a.#3D.mapstack..3DO.writes(".MAP's.stack")#0A..
10IF.a.#3D.mapcode..4DO.writes(".MAP's.code")#0A..1
0IF.a.#3D.(blocks-1)..1DO.writes(".MAP's.workspace"
)#0A..10IF.a.#3D.(rootnode-1).DO.writes(".Rootnode"
)#0A..10IF.a!3.#3D.sectword..&.(a+4)%0.#3D.11..DO#0A
..30writef(".Section.%s",.a+4)#0A..10newline()#0A..
10a.:#3D.a.+.s#0A..5$)#0A#0A..5writef("Top.of.block
.list.#3D.%n*n",.a)#0A..5topofstore.:#3D.a#0A..2$)#0A
#0A..2writef("Largest.contiguous.free.area:.")#0A..
2writeu(largest_free,.0);.writes(".words*n")#0A..2w
rites("Totals:.");.writeu(used+free,.0)#0A..2writes
(".words.available,.");.writeu(used,.0)#0A..2writes
(".used,.");.writeu(free,.0)#0A..2writes(".free*n*n
")#0A#0A..2IF.picopt.DO#0A..2$(.//.Print.as.a.pictu
re#0A..5LET.alloc.#3D.TRUE#0A..5LET.next_block.#3D.
blocklist#0A..5LET.num#3D0#0A..5LET.col.#3D.0#0A..5
LET.grainsize.#3D.topofstore/(20*64).+.1#0A..5LET.a
ddr.#3D.0#0A#0A..5WHILE.addr.<.topofstore.DO#0A..5$
(.LET.some_alloc.#3D.alloc#0A..8LET.some_free..#3D.
NOT.alloc#0A#0A..8UNTIL.addr.<#3D.next_block.|.num.
>.n.DO#0A..8$(.//.Move.to.next.block#0A..11alloc.:#3D
.((blocks!num).&.1).#3D.0#0A..11TEST.alloc.THEN.som
e_alloc.:#3D.TRUE#0A..22ELSE.$(.some_free.:#3D.TRUE
#0A..30next_block.:#3D.next_block.-.1#0A..27$)#0A..
11next_block.:#3D.next_block.+.blocks!num#0A..11num
.:#3D.num+1#0A..8$)#0A#0A..8IF.col.REM.64.#3D.0.DO.
writef("*n%i8..",.addr)#0A..8wrch.(num.>.n.->.'?',.
.//.No.info#0A..14some_alloc..1->.(some_free.->.'a'
,.'@'),.'#2E')#0A..8col,.addr.:#3D.col+1,.addr+grai
nsize#0A..5$)#0A..5newline()#0A..2$)#0A#0A..1//.Pri
nt.the.layout.of.the.code.sections,.assuming#0A..1/
/.that.they.will.not.change.under.our.feet!#0A..1//
.Also,.add.up.space.used.for.section.names,.routine
#0A..1//.names,.and.global.initialisation.informati
on#2E#0A#0A..1a.:#3D.blocklist#0A#0A..1IF.codeopt.|
.namesopt.DO#0A..1$(..1IF.codeopt.THEN.writes("Layo
ut.of.loaded.code*N*N")#0A#0A..6FOR.i.#3D.0.TO.n-1.
DO#0A..6$(.LET.s.#3D.blocks!i#0A..9//IF.testflags(1
).THEN.BREAK#0A..9IF.(s&1)#3D1#0A..9THEN.$(.a.:#3D.
a+s-1;.LOOP.$).//.Free.block#0A#0A..9IF.a!3#3Dsectw
ord.&.(a+4)%0#3D11.DO#0A..9$(.//.We've.found.a.BCPL
.section#0A..12LET.goffset.#3D.?#0A#0A..12IF.codeop
t.DO#0A..14writef("*n%i8:.Section.%S.-.length.%i5.w
ords*n",#0A..24a+2,..6a+4,..7a!2)#0A#0A..12sectname
s.:#3D.sectnames.+.sectnamesize.+.1#0A#0A..12//.Cou
nt.space.for.global.initialisation#0A..12//.table#0A
..12goffset.:#3D.a+2.+.a!2.//.Word.after.highest#0A
..33//.referenced.global#0A..12$(.globinit.:#3D.glo
binit+2#0A..15goffset..:#3D.goffset-2#0A..12$).REPE
ATUNTIL.!goffset#3D0.//.End.of.list#0A#0A..12IF.nam
esopt.FOR.j#3D5./*.skip.some.junk!.*/.TO.a!2.DO#0A.
.12$(.LET.addr.#3D.a+j.//.Avoid.comparing.signed.ad
dresses#0A#0A..15IF.addr!(nameoffset-1).#3D.entrywo
rd.&#0A..18good_routine_name(addr.+.nameoffset).DO#0A
..15$(.//.BCPL.entry.sequence#0A..18routnames.:#3D.
routnames.+.routnamesize.+.1#0A..18IF.mapstore.DO#0A
..20writef("%i8:.%S*N",.addr,.addr+nameoffset)#0A..
15$)#0A..12$)#0A..9$)#0A..9a.:#3D.a+s.//.Point.to.n
ext.block#0A..6$)#0A#0A..6IF.namesopt.DO.writef("*N
Routine.names:.%I5.words*N*#0A..28*Section.names:.%
I5.words*N*#0A..28*Global.initialisation.info:.%N.w
ords*N",#0A..29routnames,.sectnames,.globinit)#0A..
1$)#0A#0Aexit:#0A..1freevec(blocks)#0A..1UNLESS.out
str.#3D.0.THEN.endwrite()#0A..1selectoutput(constr)
#0A..RESULTIS.0#0A$)#0A#0A1AND.good_routine_name(st
ring).#3D.VALOF#0A$(.UNLESS.string%0.#3D.11.RESULTI
S.FALSE#0A#0A..1FOR.i.#3D.1.TO.11.DO#0A..1$(.LET.ch
.#3D.string%i#0A#0A..4UNLESS.'A'<#3Dch<#3D'Z'.|.'a'
<#3Dch<#3D'z'.|.'0'<#3Dch<#3D'9'.|#0A..11ch#3D'#2E'
.|.ch#3D'_'.|.ch#3D'.'.|.ch#3D'*''.RESULTIS.FALSE#0A
..1$)#0A#0A..1RESULTIS.TRUE#0A$)#0A

######com/mci386.b#
/*#0D#0AThis.is.the.i386.version.of.the.MC.dynamic.
code.generation.package#2E#0D#0A#0D#0AMartin.Richar
ds.(c).March.2014#0D#0A#0D#0A08/04/2000008#0D#0AAll
owed.MUL.UMUL,.DIV.and.UDIV.to.take.an.immediate.in
teger.operand#0D#0Athat.is.stores.in.the.data.area.
(with.sharing)#2E#0D#0A#0D#0A#23#232.Special.Note.#23
#239#0D#0A#0D#0AThe.Cintcode.memory.used.to.be.allo
cated.in.cintsys#2Ec.using#0D#0Amalloc(#2E#2E)#2E.U
nder.Windows.this.seems.to.create.an.area.of.memory
.that#0D#0Ahas.read,.write.and.execute.permission.a
s.needed.by.the.MC#0D#0Apackage#2E.However,.under.s
ome.versions.of.Linux.execution.permission.is#0D#0A
not.set,.causing.mcCall.to.fail#2E.On.such.systems.
cintsys.now.uses.mmap#0D#0Arather.than.malloc.to.al
locate.the.Cintcode.memory#2E#0D#0A#0D#0AOn.the.pen
tium.instructions.and.data.share.the.same.cache.and
.so.the#0D#0AMC.package.does.not.have.to.flush.the.
cache.before.entering.the#0D#0Adynamically.generate
d.code#2E.I.believe.the.same.is.true.of.ARM#0D#0Apr
ocessors#2E#0D#0A#0D#0A#23#232.End.of.special.note.
#23#235#0D#0A#0D#0Amcb.:#3D.mcInit(maxfno,.dsize,.c
size)#0D#0A..Create.a.dynamic.code.generation.insta
nce,.to.allow.maxfno.functions#0D#0A..in.data.space
.of.dsize.words.and.code.space.of.csize.words#2E.mc
Init#0D#0A..allocates.a.single.block.of.memory.(wit
h.read,.write.and.execute#0D#0A..permissions).large
.enough.to.hold.the.mc.control.block,.the.function#0D
#0A..dispatch.table.(to.map.function.numbers.to.ent
ry.points),.the.data#0D#0A..area.for.static.data.an
d.the.code.area.for.instructions#2E.It.also#0D#0A..
allocates.and.initialises.space.to.deal.with.labels
.and.forward#0D#0A..references#2E.This.space.expand
s.as.needed.during.codegeneration.and#0D#0A..is.rel
eases.when.codegeneration.is.completed.(by.the.call
#0D#0A..mcF(mc_end))#2E#0D#0A#0D#0AmcSelect(mcb)#0D
#0A..Select.the.specified.dynamic.code.generation.i
nstance#2E#0D#0A#0D#0AmcCall(fno,x,y,z).//.Call.the
.function.with.number.fno.with.three#0D#0A..16//.ar
guments.x,.y.and.z#2E#0D#0AmcClose()#0D#0A..Close.d
own.the.current.dynamic.code.generation.instance.fr
eeing.all#0D#0A..its.workspace#2E#0D#0A#0D#0AmcPRF(
format,.reg)#0D#0A..This.calls.the.C.function.print
f.with.the.given.format.string.and.an#0D#0Aargument
.holding.the.current.value.of.the.specified.MC.regi
ster#2E..The#0D#0Acondition.code.and.all.the.regist
ers.are.preserved#2E.The.format.is.a#0D#0ABCPL.stri
ng.which.is.converted.to.a.C.string.and.packed.in.t
he.data#0D#0Aarea.for.use.by.printf#2E.An.unrecogni
sed.register.is.treated.as.MC#0D#0Aregister.A#2E#0D
#0A#0D#0AmcNextlab()#0D#0A..This.returns.the.next.a
vailable.label#2E#0D#0A#0D#0AmcComment(format,.a,.b
,#2E#2E1,.k)#0D#0A..Write.a.message.using.writef.if
.the.least.significant.bit.of#0D#0AmcDebug.is.a.one
#2E#0D#0A#0D#0Ares.:#3D.mcDatap()#0D#0Ares.:#3D.mcC
odep()#0D#0A..Return.the.current.positions.in.the.d
ata.and.code.areas,#0D#0A..respectively#2E#0D#0A*/#0D
#0A#0D#0ASECTION."mci386"#0D#0A#0D#0AGET."libhdr"#0D
#0AGET."mc#2Eh"#0D#0A#0D#0AMANIFEST.{#0D#0A//.i386.
register.codes#2E#0D#0A#0D#0A..Eax.#3D.0.//.%eax..3
A#0D#0A..Ecx.#3D.1.//.%ecx..3C#0D#0A..Edx.#3D.2.//.
%edx..3D#0D#0A..Ebx.#3D.3.//.%ebx..3B#0D#0A..Esp.#3D
.4.//.%esp#0D#0A..Ebp.#3D.5.//.%ebp#0D#0A..Esi.#3D.
6.//.%esi..3E#0D#0A..Edi.#3D.7.//.%edi..3F#0D#0A#0D
#0A/*#0D#0AThe.machine.independent.codegeneration.f
unctions.are.declared.in.mc#2Eh#0D#0Atogether.with.
the.machine.operation.mnemonics.and.directives#2E#0D
#0A#0D#0AThe.machine.dependent.low.level.(i386).cod
e.is.compiled.using.ia#0D#0Acodegeneration.function
s.such.as.iaRK,.iaRR.etc#2E.The.letters.following.#0D
#0Aia.indicate.the.types.of.the.arguments#2E#0D#0A#0D
#0AF..3No.operands#0D#0AK..3An.integer#0D#0AR..3An.
i386.register,.eg.Eax,.Ebx,#2E#2E1#0D#0AA..3An.argu
ment.of.the.current.function#0D#0AV..3A.local.varia
ble.of.the.current.function#2E#0D#0AG..3A.BCPL.glob
al.variable#2E#0D#0AM..3A.BCPL.pointer.into.Cintcod
e.memory#2E#0D#0AD..3A.memory.reference.with.absolu
te.address#2E#0D#0ADX..2A.memory.reference.with.off
set.and.index.register#2E#0D#0ADXs..1A.memory.refer
ence.with.offset.and.scaled.index.register#2E#0D#0A
DXsB..A.memory.reference.with.offset,.scaled.index.
and.base.registers#2E#0D#0AS..3A.label.reference.as
suming.an.8-bit.operand.is.sufficient#2E#0D#0AL..3A
.label.reference.assuming.an.8-bit.operand.is.not.s
ufficient#2E#0D#0A*/#0D#0A#0D#0A//.i386.machine.ope
rations.(all.32-bit.unless.otherwise.specified)#2E#0D
#0A#0D#0A#0D#0A..ia_addl#3D1.//..RK.RR.RL.RM.RDX.RD
Xs.RDXsB.mRL.mRM.mRDX1.mRDXs.mRDXsB#0D#0A..ia_addcl
..//..RK.RR.RL.RM.RDX.RDXs.RDXsB.mRL.mRM.mRDX1.mRDX
s.mRDXsB#0D#0A..ia_andl..1//..RK.RR.RL.RM.RDX.RDXs.
RDXsB.mRL.mRM.mRDX1.mRDXs.mRDXsB#0D#0A..ia_call#0D#0A
..ia_cdq#0D#0A..ia_cmpl..1//..RK.RR.RL.RM.RDX.RDXs.
RDXsB.mRL.mRM.mRDX1.mRDXs.mRDXsB#0D#0A..ia_decl..1/
/..3RR.RL.RM.RDX.RDXs.RDXsB#0D#0A..ia_divl..1//..K.
.R..L..M..D.DX..DXs..DXsB#0D#0A..ia_idivl..//..K..R
..L..M..D.DX..DXs..DXsB#0D#0A..ia_imull..//..K..R..
L..M..D.DX..DXs..DXsB#0D#0A..ia_incl..1//..3RR.RL.R
M.RDX.RDXs.RDXsB#0D#0A#0D#0A..ia_je..3//..J..9set.l
s.byte.to.0.or.1#0D#0A..ia_jne..2//..J..9set.ls.byt
e.to.0.or.1#0D#0A..ia_jl..3//..J..9set.ls.byte.to.0
.or.1#0D#0A..ia_jle..2//..J..9set.ls.byte.to.0.or.1
#0D#0A..ia_jg..3//..J..9set.ls.byte.to.0.or.1#0D#0A
..ia_jge..2//..J..9set.ls.byte.to.0.or.1#0D#0A..ia_
ja..3//..J..9set.ls.byte.to.0.or.1#0D#0A..ia_jae..2
//..J..9set.ls.byte.to.0.or.1#0D#0A..ia_jb..3//..J.
.9set.ls.byte.to.0.or.1#0D#0A..ia_jbe..2//..J..9set
.ls.byte.to.0.or.1#0D#0A#0D#0A#0D#0A..ia_jmp..2//..
J..9eg:.iaJL(ia_jmp,.32,.TRUE)#0D#0A..ia_leal#0D#0A
..ia_movb..1//..RK.RR.RL.RM.RDX.RDXs.RDXsB.mRL.mRM.
mRDX1.mRDXs.mRDXsB#0D#0A..ia_movl..1//..RK.RR.RL.RM
.RDX.RDXs.RDXsB.mRL.mRM.mRDX1.mRDXs.mRDXsB#0D#0A..i
a_movw..1//..RK.RR.RL.RM.RDX.RDXs.RDXsB.mRL.mRM.mRD
X1.mRDXs.mRDXsB#0D#0A..ia_movsbl.//..RK.RR.RL.RM.RD
X.RDXs.RDXsB.mRL.mRM.mRDX1.mRDXs.mRDXsB#0D#0A..ia_m
ovswl.//..RK.RR.RL.RM.RDX.RDXs.RDXsB.mRL.mRM.mRDX1.
mRDXs.mRDXsB#0D#0A..ia_movzbl.//..RK.RR.RL.RM.RDX.R
DXs.RDXsB.mRL.mRM.mRDX1.mRDXs.mRDXsB#0D#0A..ia_movz
wl.//..RK.RR.RL.RM.RDX.RDXs.RDXsB.mRL.mRM.mRDX1.mRD
Xs.mRDXsB#0D#0A..ia_mull..1//..K..R..L..M..D.DX..DX
s..DXsB#0D#0A..ia_negl..1//..K..R..L..M..D.DX..DXs.
.DXsB#0D#0A..ia_nop..2//..F#0D#0A..ia_notl..1//..RK
.RR.RL.RM.RDX.RDXs.RDXsB#0D#0A..ia_orl..2//..RK.RR.
RL.RM.RDX.RDXs.RDXsB.mRL.mRM.mRDX1.mRDXs.mRDXsB#0D#0A
..ia_popl..1//..3RR.RL.RM.RDX.RDXs.RDXsB#0D#0A..ia_
popal..//..1F#0D#0A..ia_popfl..//..1F#0D#0A..ia_pus
hl..//..1K..R..L..M..DX..DXs..DXsB#0D#0A..ia_pushal
.//..1F#0D#0A..ia_pushfl.//..1F#0D#0A..ia_ret..2//.
.1F..K#0D#0A..ia_shll#0D#0A..ia_shrl#0D#0A#0D#0A..i
a_sete..1//..R#0D#0A..ia_setne..//..R#0D#0A..ia_set
l..1//..R#0D#0A..ia_setle..//..R#0D#0A..ia_setg..1/
/..R#0D#0A..ia_setge..//..R#0D#0A..ia_seta..1//..R#0D
#0A..ia_setae..//..R#0D#0A..ia_setb..1//..R#0D#0A..
ia_setbe..//..R#0D#0A#0D#0A..ia_shld..1//..KRR.KRL.
KRM.KRDX.KRDXs.KRDXsB..2double.shift.by.k#0D#0A..10
//..1RR..RL..RM..RDX..RDXs..RDXsB..2double.shift.by
.CL#0D#0A..ia_shrd..1//..KRR.KRL.KRM.KRDX.KRDXs.KRD
XsB..2double.shift.by.k#0D#0A..10//..1RR..RL..RM..R
DX..RDXs..RDXsB..2double.shift.by.CL#0D#0A..ia_sbbl
..1//..RK.RR.RL.RM.RDX.RDXs.RDXsB.mRL.mRM.mRDX1.mRD
Xs.mRDXsB#0D#0A..ia_subl..1//..RK.RR.RL.RM.RDX.RDXs
.RDXsB.mRL.mRM.mRDX1.mRDXs.mRDXsB#0D#0A..ia_xchgl..
//..3RR.RL.RM.RDX.RDXs.RDXsB#0D#0A..ia_xorl..1//..R
K.RR.RL.RM.RDX.RDXs.RDXsB.mRL.mRM.mRDX1.mRDXs.mRDXs
B#0D#0A#0D#0A..//.Directives#0D#0A..ia_lab..2//.L#0D
#0A..ia_dlab..1//.L#0D#0A..ia_datab..//.K#0D#0A..ia
_datak..//.K#0D#0A..ia_datal..//.L#0D#0A..ia_datac.
.//.K#0D#0A..ia_alignc.//.K#0D#0A..ia_alignd.//.K#0D
#0A..ia_entry..//.KK1#0D#0A..ia_endfn..//.F#0D#0A..
ia_end..2//.F#0D#0A}#0D#0A#0D#0AGLOBAL.{#0D#0A..mod
00:900.//.Generate.a.Mod.R/M.byte.of.code:.mm_rop_r
r1#0D#0A..mod01..3//.eg.mod10(reg_op,.r_m).#0D#0A..
mod10#0D#0A..mod11#0D#0A..modmm..3//.eg.modmm(mm,.r
eg_op,.r_m)#0D#0A#0D#0A..sib00..3//.Generate.a.SIB.
byte.of.code:..3ss_ii1_bb1#0D#0A..sib01..3//.eg.sib
01(index,.base)#0D#0A..sib10#0D#0A..sib11#0D#0A..si
bss..3//.eg.sibss(scale,.index,.base).where.scale.#3D
.1,2,4.or.8#0D#0A#0D#0A..get1#0D#0A..put1#0D#0A..pu
t4#0D#0A#0D#0A#0D#0A..csize#0D#0A..dsize.#0D#0A#0D#0A
..mcupb..3//.Upperbound.of.mc#0D#0A..mcblock..1//.T
he.getvec.block.of.store.to.the.mc.instance#0D#0A..
mcbase..2//.is.mcblock.rounded.up.to.a.double.word.
boundary#0D#0A#0D#0A..maxfno..2//.The.largest.funct
ion.number.allowed#0D#0A..fnv..5//.Base.of.the.fns.
vector.--.points.into.mc#0D#0A..currfno..1//.The.cu
rrent.function.number.or.-1#0D#0A..maxarg..2//.The.
number.arguments.the.current.function.has#0D#0A..ma
xvar..2//.The.number.local.variables.the.current.fu
nction.has#2E#0D#0A..10//.It.is.the.upb.of.frefv#2E
#0D#0A#0D#0A..datab..3//.Byte.subscript.of.first.by
te.of.data#0D#0A..datap..3//.Byte.subscript.of.next
.byte.of.data#0D#0A..datat..3//.Byte.subscript.of.e
nd.of.data.space#0D#0A#0D#0A..codeb..3//.Byte.subsc
ript.of.first.byte.of.code.(#3Ddatat)#0D#0A..codep.
.3//.Byte.subscript.of.next.byte.of.code#0D#0A..cod
et..3//.Byte.subscript.of.end.of.code.space#0D#0A#0D
#0A..labv..4//.Label.vector.--.labv!n#3D0.if.Ln.uns
et#0D#0A..labvupb..1//.Upper.bound.of.labv.(and.ref
v)#0D#0A..labno..3//.Latest.label.allocated#0D#0A#0D
#0A..blocklist.//.List.of.blocks.of.space.to.hold.2
-tuples#0D#0A..10//.blocklist#3D0.or.points.to.the.
next.block#2E#0D#0A..10//.Blocks.are.linked.through
.the.zeroth.elements#2E#0D#0A..freelist..//.List.of
.free.2-tuples#2E#0D#0A#0D#0A..klist..3//.List.of.p
ositions.in.the.data.area.holding#0D#0A..10//.read.
only.constants.used.by.MUL,.UMUL,.DIV.and.UDIV#2E#0D
#0A..10//.Each.node.in.klist.->.[next,.datapos]#2E#0D
#0A#0D#0A..refv..4//.Vector.of.forward.references.t
o.data.or.code.labels#2E#0D#0A..frefv..3//.Vector.o
f.forward.references.to.functions#2E#0D#0A#0D#0A../
/.Forward.reference.2-tuples.are.used.for.both.labe
l.and.function#0D#0A..//.references#2E.As.soon.as.a
.label.or.function.entry.is.set,.its#0D#0A..//.forw
ard.reference.list.is.processed.and.the.2-tuples.re
turned.to#0D#0A..//.the.freelist#2E#0D#0A#0D#0A..//
.A.typical.2-tuple.is.[next,.x].where.next.is.zero.
or.points.to#0D#0A..//.the.next.2-tuple.and.x.ident
ifies.the.location.and.type.of.the#0D#0A..//.forwar
d.reference#2E.If.x.is.negative.the.reference.is.sh
ort.(byte.#0D#0A..//.sized).otherwise.it.is.long.(3
2.bits.in.length)#2E.ABS.x.(#3Daddr,.say)#0D#0A..//
.is.the.subscript.(of.mc).pointing.to.the.byte.just
.after.the#0D#0A..//.reference.byte.or.word#2E.#0D#0A
#0D#0A..mk2..4//.eg:.refv!n.:#3D.mk2(refv!n,.x)#0D#0A
..setrefs..//.eg:.setrefs(refv!n,.val);.refv!n.:#3D
.0#0D#0A..9//.This.is.called.when.a.label.or.functi
on.entry.point#0D#0A..9//.is.set#2E.It.deals.with.i
ts.outstanding.forward.refs#2E#0D#0A#0D#0A//.Auxili
ary.MC.functions#0D#0A#0D#0A..mcDebug..1//.Holds.th
e.current.debugging.level#0D#0A#0D#0A..db1wrf..2//.
Calls.writef.if.mcDebug>#3D1,.tracing.mc.ops#2E#0D#0A
..db2wrf..2//.Calls.writef.if.mcDebug>#3D2,.tracing
.ia.ops#2E#0D#0A..db3wrf..2//.Calls.writef.if.mcDeb
ug>#3D3#2E.tracing.compiled.bytes#2E#0D#0A..db3nl..
3//.Calls.newline.if.mcDebug>#3D3#0D#0A#0D#0A..iaC1
..4//.Generate.1.byte.of.code#0D#0A..iaC2..4//.Gene
rate.2.bytes.of.code#0D#0A..iaC3..4//.Generate.3.by
tes.of.code#0D#0A..iaC4..4//.Generate.4.bytes.of.co
de//.Default.initialise.MC.environment#2E#0D#0A#0D#0A
..iaD1..4//.Generate.1.byte.of.data#0D#0A..iaD2..4/
/.Generate.2.bytes.of.data#0D#0A..iaD3..4//.Generat
e.3.bytes.of.data#0D#0A..iaD4..4//.Generate.4.bytes
.of.data#0D#0A#0D#0A//.Operations.with.one.or.no.op
erands#0D#0A..iaF..5//.op..18eg:.nop#0D#0A..iaK..5/
/.op.k..16eg:.mul.$10#0D#0A..iaR..5//.op.r..16eg:.n
egl.%ebx#0D#0A..iaL..5//.op.<data.Ln>..8eg:.negl.L3
2#0D#0A..iaD..5//.op.D..16eg:.negl.1234#0D#0A..iaDX
..4//.op.DX..15eg:.negl.12(%ebx)#0D#0A..iaDXs..3//.
op.DXs..14eg:.negl.12(,%ebx,4)#0D#0A..iaDXsB..2//.o
p.DXsB..13eg:.negl.12(%eax,%ebx,4)#0D#0A#0D#0A//Dya
dic.operations.with.register.as.target#0D#0A..iaRK.
.4//.r.op:#3D.k..12eg:.addl.k,r#0D#0A..iaRR..4//.r.
op:#3D.s..12eg:.addl.s,r#0D#0A..iaRL..4//.r.op:#3D.
<data.Ln>..4eg:.addl.Ln,%ebx#0D#0A..iaRD..4//.r.op:
#3D.<addr.a>..5eg:.addl.1234,%ebx#0D#0A..iaRDX..3//
.r.op:#3D.DX..11eg:.addl.12(%ebx),%ebx#0D#0A..iaRDX
s..2//.r.op:#3D.DXs..10eg:.addl.12(,%ebx,4),%ebx#0D
#0A..iaRDXsB..1//.r.op:#3D.DXsB..9eg:.addl.12(%eax,
%ebx,4),%ebx#0D#0A#0D#0A//.Dyadic.operations.with.m
emory.as.target#0D#0A..iaLR..4//.<data.Ln>.op:#3D.r
..4eg:.addl.%ebx,Ln#0D#0A..iaDR..4//.<addr.a>.op:#3D
.r..5eg:.addl.%ebx,1234#0D#0A..iaDXR..3//.DX..1op:#3D
.r..9eg:.addl.%edx,12(%ebp)#0D#0A..iaDXsR..2//.DXs.
.op:#3D.r..9eg:.addl.%edx,12(,%ebp,4)#0D#0A..iaDXsB
R..1//.DXsB.op:#3D.r..9eg:.addl.%edx,12(%ebx,%ebp,4
)#0D#0A#0D#0A..iaLK..4//.<data.Ln>.op:#3D.k..4eg:.a
ddl.$45,Ln#0D#0A..iaDK..4//.<addr.a>.op:#3D.k..5eg:
.addl.$45,1234#0D#0A..iaDXK..3//.DX..1op:#3D.k..9eg
:.addl.$45,12(%ebp)#0D#0A..iaDXsK..2//.DXs..op:#3D.
k..9eg:.addl.$45,12(,%ebp,4)#0D#0A..iaDXsBK..1//.DX
sB.op:#3D.k..9eg:.addl.$45,12(%ebx,%ebp,4)#0D#0A#0D
#0A//.Jump.operations#0D#0A..iaJL..4//.op.L..16eg:.
jmp.L32#0D#0A..iaJR..4//.op.L..16eg:.jmp.*%eax#0D#0A
#0D#0A..mcr2iar#0D#0A..iarname#0D#0A..iarname16#0D#0A
..iarname8#0D#0A..iarname8h#0D#0A..mcrname#0D#0A#0D
#0A/*..Low.level.byte.generation.functions#0D#0A#0D
#0A..ia_j#0D#0A..ia_fno#0D#0A..ia_f#0D#0A..ia_fnr#0D
#0A..ia_fnrk1#0D#0A..ia_fnrk4#0D#0A..ia_fk1#0D#0A..
ia_fk4#0D#0A#0D#0A..ia_fd#0D#0A..ia_fdx#0D#0A..ia_f
dxs#0D#0A..ia_fdxsb#0D#0A#0D#0A..ia_fdr#0D#0A..ia_f
dxr#0D#0A..ia_fdxsr#0D#0A..ia_fdxsbr#0D#0A#0D#0A..i
a_fdk1#0D#0A..ia_fdxk1#0D#0A..ia_fdxsk1#0D#0A..ia_f
dxsbk1#0D#0A#0D#0A..ia_fdk4#0D#0A..ia_fdxk4#0D#0A..
ia_fdxsk4#0D#0A..ia_fdxsbk4#0D#0A#0D#0A..ia_fnk1#0D
#0A..ia_fnk4#0D#0A..ia_fnr#0D#0A..ia_fnrk1#0D#0A..i
a_fnrk4#0D#0A#0D#0A..ia_fnd#0D#0A..ia_fndx#0D#0A..i
a_fndxs#0D#0A..ia_fndxsb#0D#0A#0D#0A..ia_fndr#0D#0A
..ia_fndxr#0D#0A..ia_fndxsr#0D#0A..ia_fndxsbr#0D#0A
#0D#0A..ia_fndk1#0D#0A..ia_fndxk1#0D#0A..ia_fndxsk1
#0D#0A..ia_fndxsbk1#0D#0A#0D#0A..ia_fndk4#0D#0A..ia
_fndxk4#0D#0A..ia_fndxsk4#0D#0A..ia_fndxsbk4#0D#0A*
/#0D#0A}#0D#0A#0D#0A#0D#0ALET.mcInit(maxfno,.dsize,
.csize).#3D.VALOF#0D#0A{.//.Create.an.MC.instance.a
nd.return.its.control.block#2E#0D#0A..//.Return.0.o
n.failure#0D#0A#0D#0A..//.First.allocate.the.worksp
ace.and.vectors#0D#0A#0D#0A..LET.mcupb.#3D.32.+..10
//.For.the.control.block#0D#0A..12maxfno.+.1.+..2//
.for.the.dispatch.table.--.0.to.maxfn#0D#0A..12dsiz
e..+..6//.for.the.static.data#0D#0A..12csize.+..7//
.for.the.code#0D#0A..0122..13//.for.possible.round.
ups.(mcblock.and.datab)#0D#0A..LET.mcblock.#3D.getv
ec(mcupb).//.Allocate.space.for.the.MC.control.bloc
k#0D#0A..28//.dispatch.table,.data.and.code#2E#0D#0A
#0D#0A..LET.frefv.#3D.getvec(maxfno)..//.Function.f
orard.ref.lists#0D#0A#0D#0A..UNLESS.mcblock.&.frefv
.DO#0D#0A..{.writef("More.store.needed*n")#0D#0A..2
abort(1001)#0D#0A..2GOTO.fin#0D#0A..}#0D#0A#0D#0A..
//.Clear.all.the.space#0D#0A..FOR.i.#3D.0.TO.mcupb.
DO.mcblock!i.:#3D.0#0D#0A#0D#0A..//.Check.that.the.
Cintcode.memory.is.double.word.aligned#0D#0A..UNLES
S.((rootnode!rtn_mc0).&.7).#3D.0.DO#0D#0A..{.writef
("Error:.The.Cintcode.memory.is.not.double.word.ali
gned*n")#0D#0A..2GOTO.fin#0D#0A..}#0D#0A#0D#0A..//.
mcbase.is.mcblock.rounded.up.to.be.double.word.alig
ned#2E#0D#0A..mcbase.:#3D.mcblock#0D#0A..UNLESS.(mc
base.&.1).#3D.0.DO.mcbase.:#3D.mcbase+1#0D#0A#0D#0A
..//.Initialise.the.MC.instance#0D#0A#0D#0A..fnv.:#3D
.mcbase.+.32..17//.The.function.dispatch.table#0D#0A
#0D#0A..datab.:#3D.(32+maxfno+1)*bytesperword..//.(
byte.subscript.of.mcbase)#0D#0A..datab.:#3D.(datab+
7).&.-8..12//.Round.up.to.double.word.alignment#0D#0A
..datap.:#3D.datab..21//.Position.of.next.data.byte
#0D#0A..datat.:#3D.datab.+.dsize*bytesperword..//.L
imit.of.data.space#0D#0A#0D#0A..codeb.:#3D.datat..2
1//.Base.of.the.code.space#0D#0A..codep.:#3D.codeb.
.21//.Position.of.next.code.byte#0D#0A..codet.:#3D.
codeb.+.csize*bytesperword..//.Limit.of.code.space#0D
#0A#0D#0A..klist.:#3D.0..25//.read.only.data.consta
nts#0D#0A#0D#0A..FOR.n.#3D.0.TO.maxfno..DO.fnv!n,..
frefv!n.:#3D.0,.0#0D#0A#0D#0A//writef("*nmcupb#3D%n
,.mcblock#3D%n,.mbase#3D%n,.frefv#3D%n*n",#0D#0A//.
.6mcupb,.mcblock,.mcbase,.frefv)#0D#0A//writef("fnv
#3D%n,.datab#3D%n,.codeb#3D%n,.codet#3D%n*n",#0D#0A
//..6fnv,.datab,.codeb,.codet)#0D#0A//abort(1001)#0D
#0A#0D#0A..//.Save.the.MC.state.in.the.control.bloc
k#0D#0A..mcbase!.0.:#3D.mcupb..//.Upb.of.the.mc.spa
ce#0D#0A..mcbase!.1.:#3D.maxfno.//.The.largest.allo
wable.function.number#0D#0A..20//.It.is.the.upb.of.
fnv.and.frefv#0D#0A..mcbase!.2.:#3D.dsize..//.Size.
of.the.data.area.in.words#0D#0A..mcbase!.3.:#3D.csi
ze..//.Size.of.the.code.area.in.words#0D#0A..mcbase
!.4.:#3D.fnv..2//.The.function.dispatch.table.holdi
ng.entry.addresses#0D#0A..mcbase!.5.:#3D.-1..3//.Cu
rrent.upb.of.labv.and.refv#0D#0A..mcbase!.6.:#3D.0.
.4//.Label.vector#0D#0A..mcbase!.7.:#3D.0..4//.Labe
l.forward.reference.lists#0D#0A..mcbase!.8.:#3D.fre
fv..//.Function.forward.reference.lists#0D#0A..mcba
se!.9.:#3D.datab..//.Base.of.data.bytes.(double.wor
d.aligned)#0D#0A..mcbase!10.:#3D.datap..//.Position
.of.next.data.byte#0D#0A..mcbase!11.:#3D.datat..//.
End.of.data.bytes.(#3Dcodep)#0D#0A..mcbase!12.:#3D.
codeb..//.Base.of.code.bytes#0D#0A..mcbase!13.:#3D.
codep..//.Position.of.next.code.byte#0D#0A..mcbase!
14.:#3D.codet..//.End.of.code.bytes#0D#0A..mcbase!1
5.:#3D.0..4//.The.current.function.number#0D#0A..mc
base!16.:#3D.maxarg.//.The.number.of.arguments.expe
cted.for.current.function#0D#0A..mcbase!17.:#3D.max
var.//.The.number.of.local.variables.for.current.fu
nction#0D#0A..mcbase!18.:#3D.0..4//.Latest.label.al
located#0D#0A..mcbase!19.:#3D.0..4//.The.current.de
bugging.level#0D#0A..mcbase!20.:#3D.0..4//.List.of.
allocated.blocks#0D#0A..mcbase!21.:#3D.0..4//.List.
of.free.2-tuples.(within.the.allocated.blocks)#0D#0A
..mcbase!22.:#3D.mcblock//.Unrounded.mcbase#0D#0A..
mcbase!23.:#3D.klist..//.read.only.data.constants#0D
#0A#0D#0A..//.Successful.return.from.mcInit(#2E#2E1
)#0D#0A..RESULTIS.mcbase#0D#0A#0D#0Afin:#0D#0Aabort
(1001)#0D#0A..IF.frefv..1DO.freevec(frefv)#0D#0A..I
F.mcblock.DO.freevec(mcblock)#0D#0A..RESULTIS.0#0D#0A
}#0D#0A#0D#0AAND.mcSelect(mcb).BE#0D#0A{.//.Select.
an.MC.instance#0D#0A#0D#0A..//.First.save.the.curre
nt.instance,.if.any#2E#0D#0A..IF.mc.DO#0D#0A..{..//
.Save.the.MC.state.in.the.control.block#0D#0A..2mc!
.0.:#3D.mcupb..4//.upb.of.the.mc.space#0D#0A..2mc!.
1.:#3D.maxfno..3//.The.largest.allowable.function.n
umber#0D#0A..2mc!.2.:#3D.dsize..4//.size.of.the.dat
a.area.in.words#0D#0A..2mc!.3.:#3D.csize..4//.size.
of.the.code.area.in.words#0D#0A..2mc!.4.:#3D.fnv..6
//.vector.of.8-bit.relative.refs.//.function.dispat
ch.table#0D#0A..2mc!.5.:#3D.labvupb..2//.upb.of.lab
v#0D#0A..2mc!.6.:#3D.labv..5//.Label.vector#0D#0A..
2mc!.7.:#3D.refv..5//.label.forward.refs#0D#0A..2mc
!.8.:#3D.frefv..4//.function.forward.refs#0D#0A..2m
c!.9.:#3D.datab..4//.Base.of.data.bytes#0D#0A..2mc!
10.:#3D.datap..4//.Pos.of.next.data.byte#0D#0A..2mc
!11.:#3D.datat..4//.End.of.data.bytes#0D#0A..2mc!12
.:#3D.codeb..4//.base.of.code.bytes#0D#0A..2mc!13.:
#3D.codep..4//.position.of.next.code.byte#0D#0A..2m
c!14.:#3D.codet..4//.End.of.code.bytes.(#3Ddatab)#0D
#0A..2mc!15.:#3D.currfno..2//.The.current.function.
number#0D#0A..2mc!16.:#3D.maxarg..3//.The.number.of
.arguments.expected#0D#0A..2mc!17.:#3D.maxvar..3//.
The.number.of.local.variables#0D#0A..2mc!18.:#3D.la
bno..4//.The.largest.user.label.used#0D#0A..2mc!19.
:#3D.mcDebug..2//.The.current.debugging.level#0D#0A
..2mc!20.:#3D.blocklist..//.List.of.allocated.block
s#0D#0A..2mc!21.:#3D.freelist..1//.List.of.free.2-t
uples#0D#0A..2mc!22.:#3D.mcblock..2//.Unrounded.mcb
ase#0D#0A..2mc!23.:#3D.klist..4//.read.only.data.co
nstants#0D#0A..}#0D#0A..//.Now.extract.the.state.of
.the.new.MC.instance#0D#0A..IF.mcb.DO#0D#0A..{.mc..
5:#3D.mcb#0D#0A..2mcupb..2:#3D.mc!.0..//.upb.of.mc#0D
#0A..2maxfno..1:#3D.mc!.1..//.The.largest.allowable
.function.number#0D#0A..2dsize..2:#3D.mc!.2..//.siz
e.of.the.data.area.in.words#0D#0A..2csize..2:#3D.mc
!.3..//.size.of.the.code.area.in.words#0D#0A..2fnv.
.4:#3D.mc!.4..//.vector.of.8-bit.relative.refs.//.f
unction.dispatch.table#0D#0A..2labvupb..:#3D.mc!.5.
.//.upb.of.labv#0D#0A..2labv..3:#3D.mc!.6..//.Label
.vector#0D#0A..2refv..3:#3D.mc!.7..//.upb.of.ref32v
#0D#0A..2frefv..2:#3D.mc!.8..//.vector.of.32-bit.re
lative.refs#0D#0A..2datab..2:#3D.mc!.9..//.Base.of.
data.bytes#0D#0A..2datap..2:#3D.mc!10..//.Pos.of.ne
xt.data.byte#0D#0A..2datat..2:#3D.mc!11..//.End.of.
data.bytes#0D#0A..2codeb..2:#3D.mc!12..//.base.of.c
ode.bytes#0D#0A..2codep..2:#3D.mc!13..//.position.o
f.next.code.byte#0D#0A..2codet..2:#3D.mc!14..//.End
.of.code.bytes.(#3Ddatab)#0D#0A..2currfno..:#3D.mc!
15..//.The.current.function.number#0D#0A..2maxarg..
1:#3D.mc!16..//.The.number.of.arguments.expected#0D
#0A..2maxvar..1:#3D.mc!17..//.The.number.of.local.v
ariables#0D#0A..2labno..2:#3D.mc!18..//.Latest.labe
l.allocated#0D#0A..2mcDebug..:#3D.mc!19..//.The.cur
rent.debugging.level#0D#0A..2blocklist:#3D.mc!20../
/.List.of.allocated.blocks#0D#0A..2freelist.:#3D.mc
!21..//.List.of.free.2-tuples#0D#0A..2mcblock..:#3D
.mc!22..//.Unrounded.mcbase.#0D#0A..2klist..2:#3D.m
c!23..//.read.only.data.constants#0D#0A.}#0D#0A//wr
itef("2:.mc#3D%n.labv#3D%n*n",.mc,.labv)#0D#0A#0D#0A
#0D#0A//writef("mcSelect:.labvupb#3D%n.labv#3D%n*n"
,.labvupb,.labv)#0D#0A}#0D#0A#0D#0A//.Call.the.func
tion.specified.by.fno#2E#0D#0A#0D#0ALET.mcCall(fno,
.a,.b,.c).#3D.VALOF#0D#0A{#0D#0A//sawritef("mcCall(
%n,.%n,.%n,.%n):.mc#3D%n.%n!%n.#3D.%n*n",#0D#0A//..
8fno,.a,.b,.c,.mc,.fnv,.fno,.fnv!fno)#0D#0A..RESULT
IS.sys(Sys_callnative,#0D#0A..13mc.+.fnv!fno/bytesp
erword,.//.entry.point.for.function.fno#0D#0A..13a,
.b,.c#0D#0A..12)#0D#0A}#0D#0A#0D#0AAND.mcClose().BE
.IF.mc.DO#0D#0A{#0D#0A..//writef("Closing.mc#3D%n*n
",.mc)#0D#0A#0D#0A..IF.mc.DO#0D#0A..{.//writef("Fre
eing.mcblock.%n*n",.mcblock)#0D#0A//abort(1001)#0D#0A
..2freevec(mcblock)#0D#0A..2mc.:#3D.0#0D#0A..}#0D#0A
#0D#0A..WHILE.blocklist.DO#0D#0A..{.LET.next.#3D.!b
locklist#0D#0A..2//writef("Freeing.block.%n*n",.blo
cklist)#0D#0A..2freevec(blocklist)#0D#0A..2blocklis
t.:#3D.next#0D#0A..}#0D#0A#0D#0A..IF.labv.DO#0D#0A.
.{.//writef("Freeing.labv.%n*n",.labv)#0D#0A..2free
vec(labv)#0D#0A..2labv.:#3D.0#0D#0A..}#0D#0A..IF.re
fv.DO#0D#0A..{.//writef("Freeing.refv.%n*n",.refv)#0D
#0A..2freevec(refv)#0D#0A..2refv.:#3D.0#0D#0A..}#0D
#0A..IF.frefv.DO#0D#0A..{.//writef("Freeing.frefv.%
n*n",.frefv)#0D#0A..2freevec(frefv)#0D#0A..2frefv.:
#3D.0#0D#0A..}#0D#0A}#0D#0A#0D#0AAND.mcPRF(mess,.re
g).BE#0D#0A{.LET.r.#3D.VALOF.SWITCHON.reg.INTO#0D#0A
..8{.DEFAULT:#0D#0A..12RESULTIS.Eax#0D#0A..10CASE.m
c_a:.CASE.mc_b:.CASE.mc_c:#0D#0A..10CASE.mc_d:.CASE
.mc_e:.CASE.mc_f:#0D#0A..12RESULTIS.reg#0D#0A..8}#0D
#0A..LET.rname.#3D.mcrname(r)#0D#0A..LET.iar.#3D.mc
r2iar(r)#0D#0A#0D#0A..IF.mcDebug>#3D1.DO#0D#0A..{#0D
#0A..2writef("//..2PRF.*"")#0D#0A..2FOR.i#3D1.TO.me
ss%0.DO#0D#0A..2{.LET.ch.#3D.mess%i#0D#0A..4SWITCHO
N.ch.INTO#0D#0A..4{.DEFAULT:..1wrch(ch);..5ENDCASE#0D
#0A..6CASE.'*n':.writef("**n");..ENDCASE#0D#0A..6CA
SE.'*t':.writef("**t");..ENDCASE#0D#0A..6CASE.'*"':
.writef("**1"");.ENDCASE#0D#0A..6CASE.'*'':.writef(
"**1'");.ENDCASE#0D#0A..6CASE.'*p':.writef("**p");.
.ENDCASE#0D#0A..6CASE.'*b':.writef("**b");..ENDCASE
#0D#0A..4}#0D#0A..2}#0D#0A..2writef("*",%s*n",.rnam
e)#0D#0A..}#0D#0A#0D#0A..{.LET.prf.#3D.rootnode!rtn
_mc2#0D#0A..2LET.format.#3D.mc*4.+.rootnode!rtn_mc0
.+.datap#0D#0A..2db3datap()#0D#0A..2db3wrf(".datab.
").#0D#0A..2FOR.i.#3D.1.TO.mess%0.DO.iaD1(mess%i)#0D
#0A..2iaD1(0)#0D#0A..2db3nl()#0D#0A#0D#0A..2iaF(ia_
pushfl)..13//.Push.the.flags#0D#0A..2iaF(ia_pushal)
..13//.Push.all.registers#0D#0A#0D#0A..2iaR(.ia_pus
hl,.iar)..8//.Push.the.argument.for.prf#0D#0A..2iaK
(.ia_pushl,.format)..5//.Push.the.format.for.prf#0D
#0A..2iaD(.ia_call,..prf-(rootnode!rtn_mc0+4*mc+cod
ep+5)).//.Call.prf(mess,.reg)#0D#0A..2iaR(.ia_popl,
..Eax)..8//.pop.the.format#0D#0A..2iaR(.ia_popl,..E
ax)..8//.pop.the.argument#0D#0A#0D#0A..2iaF(ia_popa
l)..14//.Pop.all.registers#0D#0A..2iaF(ia_popfl)..1
4//.Pop.the.flags#0D#0A..}#0D#0A}#0D#0A#0D#0A#0D#0A
//.**12.Debugging.Trace.Functions.**19#0D#0A#0D#0A/
/.The.LS.bits.of.mcDebug.control.the.debugging.trac
e.as.follows#0D#0A#0D#0A//..6x.x.x.x.b.b.b.b#0D#0A/
/..6\..3/.|.|.|.|#0D#0A//..7test..1|.|.|.*.-.Trace.
comments#0D#0A//..6number..|.|.*--2.Trace.MC.instru
ctions#0D#0A//..14|.*--4.Trace.generated.i386.instr
uction#0D#0A//..14*--6.Trace.generated.binary.code.
and.data#0D#0A#0D#0AAND.db0wrf(form,.a,.b,.c,.d,.e,
.f,.g,.h,.i,.j,.k).BE#0D#0A..UNLESS.(mcDebug.&.1)#3D
0.DO#0D#0A..2writef(form,.a,.b,.c,.d,.e,.f,.g,.h,.i
,.j,.k)#0D#0A#0D#0AAND.db1wrf(form,.a,.b,.c,.d,.e,.
f,.g,.h,.i,.j,.k).BE#0D#0A..UNLESS.(mcDebug.&.2)#3D
0.DO#0D#0A..2writef(form,.a,.b,.c,.d,.e,.f,.g,.h,.i
,.j,.k)#0D#0A#0D#0AAND.db2wrf(form,.a,.b,.c,.d,.e,.
f,.g,.h,.i,.j,.k).BE#0D#0A..UNLESS.(mcDebug.&.4)#3D
0.DO#0D#0A..2writef(form,.a,.b,.c,.d,.e,.f,.g,.h,.i
,.j,.k)#0D#0A#0D#0AAND.db3wrf(form,.a,.b,.c,.d,.e,.
f,.g,.h,.i,.j,.k).BE#0D#0A..UNLESS.(mcDebug.&.8)#3D
0.DO#0D#0A..2writef(form,.a,.b,.c,.d,.e,.f,.g,.h,.i
,.j,.k)#0D#0A#0D#0AAND.db3codep().BE#0D#0A..UNLESS.
(mcDebug.&.8)#3D0.DO.writef("%i5:.",.codep)#0D#0A#0D
#0AAND.db3datap().BE#0D#0A..UNLESS.(mcDebug.&.8)#3D
0.DO.writef("%i5:.",.datap)#0D#0A#0D#0AAND.db3nl().
BE#0D#0A..UNLESS.(mcDebug.&.8)#3D0.DO.newline()#0D#0A
#0D#0A//**12.MC.Code.generation.functions.**21#0D#0A
#0D#0A/*#0D#0A#0D#0A*/#0D#0A#0D#0ALET.mcNextlab().#3D
.VALOF#0D#0A{.labno.:#3D.labno.+.1#0D#0A..IF.labno.
>.labvupb.DO#0D#0A..{.LET.newlabvupb.#3D.labvupb+50
0#0D#0A..2LET.newlabv.#3D.getvec(newlabvupb)#0D#0A.
.2LET.newrefv.#3D.getvec(newlabvupb)#0D#0A//writef(
"*nnewlabvupb#3D%n,.newlabv#3D%n,.newrefv#3D%n*n",.
newlabvupb,.newlabv,.newrefv)#0D#0A//abort(1001)#0D
#0A..2UNLESS.newlabv.&.newrefv.DO#0D#0A..2{.IF.newl
abv.DO.freevec(newlabv)#0D#0A..4IF.newrefv.DO.freev
ec(newrefv)#0D#0A..4writef("Error:.Unable.to.expand
.the.label.vector*n")#0D#0A..4RESULTIS.0#0D#0A..2}#0D
#0A..2#0D#0A..2FOR.n.#3D.0.TO.labvupb.DO#0D#0A..4ne
wlabv!n,.newrefv!n.:#3D.labv!n,.refv!n#0D#0A..2FOR.
n.#3D.labvupb+1.TO.newlabvupb.DO#0D#0A..4newlabv!n,
.newrefv!n.:#3D.0,.0#0D#0A..2IF.labv.DO.freevec(lab
v)#0D#0A..2IF.refv.DO.freevec(refv)#0D#0A..2labv,.r
efv.:#3D.newlabv,.newrefv#0D#0A..2labvupb.:#3D.newl
abvupb#0D#0A..}#0D#0A#0D#0A..RESULTIS.labno#0D#0A}#0D
#0A#0D#0AAND.debugtest(n).BE.SWITCHON.n.INTO#0D#0A{
.DEFAULT:#0D#0A..6writef("Error:.Unknown.debug.test
.%n*n",.n)#0D#0A..6RETURN#0D#0A#0D#0A..CASE.10:#0D#0A
..6FOR.x.#3D.Eax.TO.Edi.DO.iaDXsB(ia_negl,.12,.x,.4
,.Eax)#0D#0A..6RETURN#0D#0A#0D#0A..CASE.11:#0D#0A..
6FOR.x.#3D.Eax.TO.Edi.DO.iaRR(ia_movl,.Eax,.x)#0D#0A
..6RETURN#0D#0A#0D#0A..CASE.12:#0D#0A..6FOR.x.#3D.E
ax.TO.Edi.DO.iaDXsR(ia_movl,.Eax,.12,.x,.4)#0D#0A..
6RETURN#0D#0A#0D#0A..CASE.21:#0D#0A..6FOR.x.#3D.Eax
.TO.Edi.DO#0D#0A..6{.iaRDX(ia_movl,.Eax,.0,.x)#0D#0A
..8iaRDX(ia_movl,.Eax,.20,.x)#0D#0A..8iaRDX(ia_movl
,.Eax,.200,.x)#0D#0A..6}#0D#0A..6RETURN#0D#0A#0D#0A
..CASE.22:#0D#0A..6FOR.x.#3D.Eax.TO.Edi.UNLESS.x#3D
Esp.DO#0D#0A..8iaRDXs(ia_movl,.Eax,.20,.x,.2)#0D#0A
..6RETURN#0D#0A#0D#0A..CASE.24:#0D#0A..6FOR.x.#3D.E
ax.TO.Edi.UNLESS.x#3DEsp.DO#0D#0A..8iaRDXs(ia_movl,
.Eax,.20,.x,.4)#0D#0A..6RETURN#0D#0A#0D#0A..CASE.28
:#0D#0A..6FOR.x.#3D.Eax.TO.Edi.UNLESS.x#3DEsp.DO#0D
#0A..8iaRDXs(ia_movl,.Eax,.20,.x,.8)#0D#0A..6RETURN
#0D#0A#0D#0A..CASE.31:#0D#0A..6FOR.b.#3D.Ebp.TO.Esi
.DO#0D#0A..6FOR.x.#3D.Eax.TO.Edi.UNLESS.x#3DEsp.DO#0D
#0A..6{.iaRDXsB(ia_movl,.Eax,.0,.x,.1,.b)#0D#0A..8i
aRDXsB(ia_movl,.Eax,.20,.x,.1,.b)#0D#0A..8iaRDXsB(i
a_movl,.Eax,.200,.x,.1,.b)#0D#0A..6}#0D#0A..6RETURN
#0D#0A#0D#0A..CASE.32:#0D#0A..6FOR.b.#3D.Ebp.TO.Esi
.DO#0D#0A..6FOR.x.#3D.Eax.TO.Edi.UNLESS.x#3DEsp.DO#0D
#0A..8iaRDXsB(ia_movl,.Eax,.20,.x,.2,.b)#0D#0A..6RE
TURN#0D#0A#0D#0A..CASE.34:#0D#0A..6FOR.b.#3D.Ebp.TO
.Esi.DO#0D#0A..6FOR.x.#3D.Eax.TO.Edi.UNLESS.x#3DEsp
.DO#0D#0A..8iaRDXsB(ia_movl,.Eax,.20,.x,.4,.b)#0D#0A
..6RETURN#0D#0A#0D#0A..CASE.38:#0D#0A..6FOR.b.#3D.E
bp.TO.Esi.DO#0D#0A..6FOR.x.#3D.Eax.TO.Edi.UNLESS.x#3D
Esp.DO#0D#0A..8iaRDXsB(ia_movl,.Eax,.20,.x,.8,.b)#0D
#0A..6RETURN#0D#0A#0D#0A}#0D#0A#0D#0AAND.mcComment(
mess,.a,.b,.c,.d,.e,.f,.g,.h,.i,.j,.k).BE#0D#0A..db
0wrf(mess,.a,.b,.c,.d,.e,.f,.g,.h,.i,.j,.k)#0D#0A#0D
#0AAND.mcDatap().#3D.datap#0D#0A#0D#0AAND.mcCodep()
.#3D.codep#0D#0A#0D#0AAND.mcF(op).BE#0D#0A//.cdq.en
d.endfn.nop.rtn#0D#0A{.LET.f.#3D.0#0D#0A#0D#0A..db1
wrf("//..2%s*n",.mcop2str(op))#0D#0A#0D#0A..SWITCHO
N.op.INTO#0D#0A..{.DEFAULT:..5mcbadop(op,."F");.RET
URN#0D#0A#0D#0A..2CASE.mc_cdq:..1f.:#3D.ia_cdq;..1E
NDCASE.//.Sign.extend.A.into.D.(for.mc_div)#0D#0A#0D
#0A..2CASE.mc_endfn:.//.Resolve.local.labels.and.un
set.current.function#2E#0D#0A..17f.:#3D.ia_endfn;.E
NDCASE.//.End.of.function.code#0D#0A#0D#0A..2CASE.m
c_end:..1//.Check.forward.refs,.then.release.all.te
mp.storage#2E#0D#0A..17f.:#3D.ia_end;..1ENDCASE.//.
End.of.assembly#0D#0A..2CASE.mc_nop:..1f.:#3D.ia_no
p;..1ENDCASE.//.No.operation#0D#0A#0D#0A..2CASE.mc_
rtn:..1//.Return.from.a.routine#0D#0A#0D#0A..2//.No
w.Esp.->.[V(mv),V(mv-1),#2E#2E1,V1,..2where.mv.#3D.
number.of.locals#0D#0A..2//.and.Ebp.->..Edi',Esi',E
bx',Ebp',<ret.addr>,<arg1>,#2E#2E1,<arg.ma#2E]#0D#0A
#0D#0A..4iaRR(ia_movl,.Esp,.Ebp)..//.movl.%ebp,.%es
p#0D#0A..4iaR(ia_popl,..Edi)..5//.popl.%edi#0D#0A..
4iaR(ia_popl,..Esi)..5//.popl.%esi#0D#0A..4iaR(ia_p
opl,..Ebx)..5//.popl.%ebx#0D#0A..4iaR(ia_popl,..Ebp
)..5//.popl.%ebp#0D#0A..4//iaK(ia_ret,..0014*maxarg
)..//.ret.4*maxarg#0D#0A..4iaF(ia_ret)..//.ret#0D#0A
..4//.Note:.the.arguments.are.popped.by.the.caller#2E
#0D#0A..4RETURN#0D#0A..}#0D#0A..iaF(f)#0D#0A}#0D#0A
#0D#0AAND.mcK(op,.k).BE#0D#0A//.alignc.alignd.datab
.datak.debug.div.mul.push.udiv.umul#0D#0A{.LET.f.#3D
.0#0D#0A#0D#0A..db1wrf("//..2%s.$%n*n",.mcop2str(op
),.k)#0D#0A#0D#0A..SWITCHON.op.INTO#0D#0A..{.DEFAUL
T:#0D#0A..2bad:..10mcbadop(op,."K");.RETURN#0D#0A#0D
#0A..2CASE.mc_alignc:.f.:#3D.ia_alignc;.ENDCASE#0D#0A
..2CASE.mc_alignd:.f.:#3D.ia_alignd;.ENDCASE#0D#0A.
.2CASE.mc_datak:..f.:#3D.ia_datak;..ENDCASE#0D#0A..
2CASE.mc_datab:..f.:#3D.ia_datab;..ENDCASE#0D#0A..2
CASE.mc_debug:..mcDebug.:#3D.k#0D#0A..18IF.mcDebug>
#3D16.DO.debugtest(k>>0004)#0D#0A..18RETURN#0D#0A..
2CASE.mc_push:..1f.:#3D.ia_pushl;..ENDCASE#0D#0A#0D
#0A..2CASE.mc_div:..2iaD(ia_idivl,.dataconst(k));.R
ETURN#0D#0A..2CASE.mc_mul:..2iaD(ia_imull,.datacons
t(k));.RETURN#0D#0A..2CASE.mc_udiv:..1iaD(ia_divl,.
.dataconst(k));.RETURN#0D#0A..2CASE.mc_umul:..1iaD(
ia_mull,..dataconst(k));.RETURN#0D#0A..}#0D#0A..iaK
(f,.k)#0D#0A}#0D#0A#0D#0AAND.dataconst(k).#3D.VALOF
#0D#0A{.//.Return.the.machine.address.in.the.data.a
rea.of.the.required#0D#0A..//.read.only.constant#2E
#0D#0A..LET.p.#3D.klist#0D#0A..LET.base.#3D.mc*4.+.
rootnode!rtn_mc0#0D#0A//writef("dataconst:.k#3D%n.b
ase#3D4**%x8+%x8.#3D.%x8*n",.k,.mc,.rootnode!rtn_mc
0,.base)#0D#0A..UNTIL.p#3D0.|.mc!(p!1>>0002)#3Dk.DO
.p.:#3D.!p#0D#0A..UNLESS.p.DO#0D#0A..{.iaK(ia_align
d,.4)#0D#0A..2p.:#3D.mk2(klist,.datap)#0D#0A..2klis
t.:#3D.p#0D#0A..2iaK(ia_datak,.k)#0D#0A..2//writef(
"dataconst:.const.k#3D%n.allocated.at.%n*n",.k,.p!1
)#0D#0A..}#0D#0A//writef("dataconst:.const.k#3D%n.f
ound.at.%n*n",.k,.p!1)#0D#0A..RESULTIS.p!1.+.base#0D
#0A}#0D#0A#0D#0AAND.mcR(op,.r).BE#0D#0A//.dec.div.i
nc.mul.neg.not.pop.push#0D#0A//.seq.sne.slt.sle.sgt
.sge.udiv.umul.uslt.usle.usgt.usge#0D#0A{.LET.rname
.#3D.mcrname(r)#0D#0A..LET.iar..1#3D.mcr2iar(r)#0D#0A
..LET.f..#3D.0#0D#0A#0D#0A..db1wrf("//..2%s.%s*n",.
mcop2str(op),.rname)#0D#0A#0D#0A..SWITCHON.op.INTO#0D
#0A..{.DEFAULT:#0D#0Abad:..11mcbadop(op,."R");.RETU
RN#0D#0A#0D#0A..2CASE.mc_dec:..f.:#3D.ia_decl;..END
CASE.//.decl.r#0D#0A..2CASE.mc_div:..f.:#3D.ia_idiv
l;.ENDCASE.//.idivl.r#0D#0A..2CASE.mc_inc:..f.:#3D.
ia_incl;..ENDCASE.//.incl.r#0D#0A..2CASE.mc_mul:..f
.:#3D.ia_imull;.ENDCASE.//.imull.r#0D#0A..2CASE.mc_
neg:..f.:#3D.ia_negl;..ENDCASE.//.negl.r#0D#0A..2CA
SE.mc_not:..f.:#3D.ia_notl;..ENDCASE.//.notl.r#0D#0A
..2CASE.mc_pop:..f.:#3D.ia_popl;..ENDCASE.//.popl.r
#0D#0A..2CASE.mc_push:.f.:#3D.ia_pushl;.ENDCASE.//.
pushl.r#0D#0A..2CASE.mc_seq:..iaR(ia_sete,.r)..6//.
sete.r#0D#0A..16iaRR(ia_movzbl,.r,.r)..//.movzbl.r,
r#0D#0A..16RETURN#0D#0A..2CASE.mc_sne:..iaR(ia_setn
e,.r)..5//.setne.r#0D#0A..16iaRR(ia_movzbl,.r,.r)..
//.movzbl.r,r#0D#0A..16RETURN#0D#0A..2CASE.mc_slt:.
.iaR(ia_setl,.r)..6//.setl.r#0D#0A..16iaRR(ia_movzb
l,.r,.r)..//.movzbl.r,r#0D#0A..16RETURN#0D#0A..2CAS
E.mc_sle:..iaR(ia_setle,.r)..5//.setle.r#0D#0A..16i
aRR(ia_movzbl,.r,.r)..//.movzbl.r,r#0D#0A..16RETURN
#0D#0A..2CASE.mc_sgt:..iaR(ia_setg,.r)..6//.setg.r#0D
#0A..16iaRR(ia_movzbl,.r,.r)..//.movzbl.r,r#0D#0A..
16RETURN#0D#0A..2CASE.mc_sge:..iaR(ia_setge,.r)..5/
/.setge.r#0D#0A..16iaRR(ia_movzbl,.r,.r)..//.movzbl
.r,r#0D#0A..16RETURN#0D#0A#0D#0A..2CASE.mc_uslt:..i
aR(ia_setb,.r)..5//.setb.r#0D#0A..16iaRR(ia_movzbl,
.r,.r)..//.movzbl.r,r#0D#0A..16RETURN#0D#0A..2CASE.
mc_usle:..iaR(ia_setbe,.r)..4//.setbe.r#0D#0A..16ia
RR(ia_movzbl,.r,.r)..//.movzbl.r,r#0D#0A..16RETURN#0D
#0A..2CASE.mc_usgt:..iaR(ia_seta,.r)..5//.seta.r#0D
#0A..16iaRR(ia_movzbl,.r,.r)..//.movzbl.r,r#0D#0A..
16RETURN#0D#0A..2CASE.mc_usge:..iaR(ia_setae,.r)..4
//.setae.r#0D#0A..16iaRR(ia_movzbl,.r,.r)..//.movzb
l.r,r#0D#0A..16RETURN#0D#0A..2CASE.mc_udiv:.f.:#3D.
ia_divl;..ENDCASE.//.divl.r#0D#0A..2CASE.mc_umul:.f
.:#3D.ia_mull;..ENDCASE.//.mull.r#0D#0A..}#0D#0A..i
aR(f,.iar)#0D#0A}#0D#0A#0D#0AAND.mcA(op,.n).BE#0D#0A
//.div.jmp.mul.neg.not.pop.push#0D#0A//.seq.sne.slt
.sle.sgt.sge.udiv.umul.uslt.usle.usgt.usge#0D#0A{.L
ET.f.#3D.0#0D#0A.#0D#0A..db1wrf("//..2%s.A%n*n",.mc
op2str(op),.n)#0D#0A#0D#0A..UNLESS.1.<#3D.n.<#3D.ma
xarg.DO#0D#0A..{.writef("Error:.A%n.not.in.range.A1
.to.A%n*n",.n,.maxarg)#0D#0A..2RETURN.#0D#0A..}#0D#0A
#0D#0A..SWITCHON.op.INTO#0D#0A..{.DEFAULT:..2mcbado
p(op,."A");.RETURN#0D#0A#0D#0A..2CASE.mc_div:..f.:#3D
.ia_idivl;.ENDCASE.//.idivl.r#0D#0A..2CASE.mc_mul:.
.f.:#3D.ia_imull;.ENDCASE.//.imull.r#0D#0A..2CASE.m
c_neg:..f.:#3D.ia_negl;..ENDCASE.//.negl.r#0D#0A..2
CASE.mc_not:..f.:#3D.ia_notl;..ENDCASE.//.notl.r#0D
#0A..2CASE.mc_pop:..f.:#3D.ia_popl;..ENDCASE.//.pop
l.r#0D#0A..2CASE.mc_push:.f.:#3D.ia_pushl;.ENDCASE.
//.pushl.r#0D#0A..2CASE.mc_seq:..f.:#3D.ia_sete;..E
NDCASE.//.sete.r#0D#0A..2CASE.mc_sne:..f.:#3D.ia_se
tne;.ENDCASE.//.setne.r#0D#0A..2CASE.mc_slt:..f.:#3D
.ia_setl;..ENDCASE.//.setl.r#0D#0A..2CASE.mc_sle:..
f.:#3D.ia_setle;.ENDCASE.//.setle.r#0D#0A..2CASE.mc
_sgt:..f.:#3D.ia_setg;..ENDCASE.//.setg.r#0D#0A..2C
ASE.mc_sge:..f.:#3D.ia_setge;.ENDCASE.//.setge.r#0D
#0A..2CASE.mc_udiv:.f.:#3D.ia_divl;..ENDCASE.//.div
l.r#0D#0A..2CASE.mc_umul:.f.:#3D.ia_mull;..ENDCASE.
//.mull.r#0D#0A..2CASE.mc_uslt:.f.:#3D.ia_setb;..EN
DCASE.//.setb.r#0D#0A..2CASE.mc_usle:.f.:#3D.ia_set
be;.ENDCASE.//.setbe.r#0D#0A..2CASE.mc_usgt:.f.:#3D
.ia_seta;..ENDCASE.//.seta.r#0D#0A..2CASE.mc_usge:.
f.:#3D.ia_setae;.ENDCASE.//.setae.r#0D#0A..}#0D#0A.
.iaDX(f,.16.+.4*n,.Ebp).#0D#0A}#0D#0A#0D#0AAND.mcV(
op,.n).BE#0D#0A//.div.jmp.mul.neg.not.pop.push#0D#0A
//.seq.sne.slt.sle.sgt.sge.udiv.umul.uslt.usle.usgt
.usge#0D#0A{.LET.f.#3D.0#0D#0A.#0D#0A..db1wrf("//..
2%s.V%n*n",.mcop2str(op),.n)#0D#0A#0D#0A..UNLESS.1.
<#3D.n.<#3D.maxvar.DO#0D#0A..{.writef("Error:.V%n.n
ot.in.range.V1.to.V%n*n",.n,.maxvar)#0D#0A..2RETURN
.#0D#0A..}#0D#0A#0D#0A..SWITCHON.op.INTO#0D#0A..{.D
EFAULT:..2mcbadop(op,."V");.RETURN#0D#0A#0D#0A..2CA
SE.mc_div:..f.:#3D.ia_idivl;.ENDCASE.//.idivl.Vn#0D
#0A..2CASE.mc_mul:..f.:#3D.ia_imull;.ENDCASE.//.imu
ll.Vn#0D#0A..2CASE.mc_neg:..f.:#3D.ia_negl;..ENDCAS
E.//.negl.Vn#0D#0A..2CASE.mc_not:..f.:#3D.ia_notl;.
.ENDCASE.//.notl.Vn#0D#0A..2CASE.mc_pop:..f.:#3D.ia
_popl;..ENDCASE.//.popl.Vn#0D#0A..2CASE.mc_push:.f.
:#3D.ia_pushl;.ENDCASE.//.pushl.Vn#0D#0A..2CASE.mc_
seq:..f.:#3D.ia_sete;..ENDCASE.//.sete.Vn#0D#0A..2C
ASE.mc_sne:..f.:#3D.ia_setne;.ENDCASE.//.setne.Vn#0D
#0A..2CASE.mc_slt:..f.:#3D.ia_setl;..ENDCASE.//.set
l.Vn#0D#0A..2CASE.mc_sle:..f.:#3D.ia_setle;.ENDCASE
.//.setle.Vn#0D#0A..2CASE.mc_sgt:..f.:#3D.ia_setg;.
.ENDCASE.//.setg.Vn#0D#0A..2CASE.mc_sge:..f.:#3D.ia
_setge;.ENDCASE.//.setge.Vn#0D#0A..2CASE.mc_udiv:.f
.:#3D.ia_divl;..ENDCASE.//.divl.Vn#0D#0A..2CASE.mc_
umul:.f.:#3D.ia_mull;..ENDCASE.//.mull.Vn#0D#0A..2C
ASE.mc_uslt:.f.:#3D.ia_setb;..ENDCASE.//.setb.Vn#0D
#0A..2CASE.mc_usle:.f.:#3D.ia_setbe;.ENDCASE.//.set
be.Vn#0D#0A..2CASE.mc_usgt:.f.:#3D.ia_seta;..ENDCAS
E.//.seta.Vn#0D#0A..2CASE.mc_usge:.f.:#3D.ia_setae;
.ENDCASE.//.setae.Vn#0D#0A..}#0D#0A..iaDX(f,.-4.-.4
*n,.Ebp).#0D#0A}#0D#0A#0D#0AAND.mcG(op,.n).BE#0D#0A
//.div.jmp.mul.neg.not.pop.push#0D#0A//.seq.sne.slt
.sle.sgt.sge.udiv.umul.uslt.usle.usgt.usge#0D#0A{.L
ET.f.#3D.0#0D#0A.#0D#0A..db1wrf("//..2%s.G%n*n",.mc
op2str(op),.n)#0D#0A#0D#0A..SWITCHON.op.INTO#0D#0A.
.{.DEFAULT:..2mcbadop(op,."G");.RETURN#0D#0A#0D#0A.
.2CASE.mc_div:..f.:#3D.ia_idivl;.ENDCASE.//.idivl.G
n#0D#0A..2CASE.mc_mul:..f.:#3D.ia_imull;.ENDCASE.//
.imull.Gn#0D#0A..2CASE.mc_neg:..f.:#3D.ia_negl;..EN
DCASE.//.negl.Gn#0D#0A..2CASE.mc_not:..f.:#3D.ia_no
tl;..ENDCASE.//.notl.Gn#0D#0A..2CASE.mc_pop:..f.:#3D
.ia_popl;..ENDCASE.//.popl.Gn#0D#0A..2CASE.mc_push:
.f.:#3D.ia_pushl;.ENDCASE.//.pushl.Gn#0D#0A..2CASE.
mc_seq:..f.:#3D.ia_sete;..ENDCASE.//.sete.Gn#0D#0A.
.2CASE.mc_sne:..f.:#3D.ia_setne;.ENDCASE.//.setne.G
n#0D#0A..2CASE.mc_slt:..f.:#3D.ia_setl;..ENDCASE.//
.setl.Gn#0D#0A..2CASE.mc_sle:..f.:#3D.ia_setle;.END
CASE.//.setle.Gn#0D#0A..2CASE.mc_sgt:..f.:#3D.ia_se
tg;..ENDCASE.//.setg.Gn#0D#0A..2CASE.mc_sge:..f.:#3D
.ia_setge;.ENDCASE.//.setge.Gn#0D#0A..2CASE.mc_udiv
:.f.:#3D.ia_divl;..ENDCASE.//.divl.Gn#0D#0A..2CASE.
mc_umul:.f.:#3D.ia_mull;..ENDCASE.//.mull.Gn#0D#0A.
.2CASE.mc_uslt:.f.:#3D.ia_setb;..ENDCASE.//.setb.Gn
#0D#0A..2CASE.mc_usle:.f.:#3D.ia_setbe;.ENDCASE.//.
setbe.Gn#0D#0A..2CASE.mc_usgt:.f.:#3D.ia_seta;..END
CASE.//.seta.Gn#0D#0A..2CASE.mc_usge:.f.:#3D.ia_set
ae;.ENDCASE.//.setae.Gn#0D#0A..}#0D#0A..iaD(f,.root
node!rtn_mc0.+.4*(@globsize+n)).#0D#0A}#0D#0A#0D#0A
AND.mcM(op,.a).BE#0D#0A//.div.jmp.mul.neg.not.pop.p
ush#0D#0A//.seq.sne.slt.sle.sgt.sge.udiv.umul.uslt.
usle.usgt.usge#0D#0A{.LET.f.#3D.0#0D#0A.#0D#0A..db1
wrf("//..2%s.M%n*n",.mcop2str(op),.a)#0D#0A#0D#0A..
SWITCHON.op.INTO#0D#0A..{.DEFAULT:..2mcbadop(op,."M
");.RETURN#0D#0A#0D#0A..2CASE.mc_div:..f.:#3D.ia_id
ivl;.ENDCASE.//.idivl.Ma#0D#0A..2CASE.mc_mul:..f.:#3D
.ia_imull;.ENDCASE.//.imull.Ma#0D#0A..2CASE.mc_neg:
..f.:#3D.ia_negl;..ENDCASE.//.negl.Ma#0D#0A..2CASE.
mc_not:..f.:#3D.ia_notl;..ENDCASE.//.notl.Ma#0D#0A.
.2CASE.mc_pop:..f.:#3D.ia_popl;..ENDCASE.//.popl.Ma
#0D#0A..2CASE.mc_push:.f.:#3D.ia_pushl;.ENDCASE.//.
pushl.Ma#0D#0A..2CASE.mc_seq:..f.:#3D.ia_sete;..END
CASE.//.sete.Ma#0D#0A..2CASE.mc_sne:..f.:#3D.ia_set
ne;.ENDCASE.//.setne.Ma#0D#0A..2CASE.mc_slt:..f.:#3D
.ia_setl;..ENDCASE.//.setl.Ma#0D#0A..2CASE.mc_sle:.
.f.:#3D.ia_setle;.ENDCASE.//.setle.Ma#0D#0A..2CASE.
mc_sgt:..f.:#3D.ia_setg;..ENDCASE.//.setg.Ma#0D#0A.
.2CASE.mc_sge:..f.:#3D.ia_setge;.ENDCASE.//.setge.M
a#0D#0A..2CASE.mc_udiv:.f.:#3D.ia_divl;..ENDCASE.//
.divl.Ma#0D#0A..2CASE.mc_umul:.f.:#3D.ia_mull;..END
CASE.//.mull.Ma#0D#0A..2CASE.mc_uslt:.f.:#3D.ia_set
b;..ENDCASE.//.setb.Ma#0D#0A..2CASE.mc_usle:.f.:#3D
.ia_setbe;.ENDCASE.//.setbe.Ma#0D#0A..2CASE.mc_usgt
:.f.:#3D.ia_seta;..ENDCASE.//.seta.Ma#0D#0A..2CASE.
mc_usge:.f.:#3D.ia_setae;.ENDCASE.//.setae.Ma#0D#0A
..}#0D#0A..iaD(f,.rootnode!rtn_mc0.+.4*a).#0D#0A}#0D
#0A#0D#0AAND.mcL(op,.n).BE#0D#0A//.dlab.lab#0D#0A//
.div.jmp.mul.neg.not.pop.push#0D#0A//.seq.sne.slt.s
le.sgt.sge.udiv.umul.uslt.usle.usgt.usge#0D#0A{.LET
.f.#3D.0#0D#0A.#0D#0A..IF.op#3Dmc_lab.|.op#3Dmc_dla
b.DO.db1wrf("*n")#0D#0A#0D#0A..db1wrf("//..2%s.L%n*
n",.mcop2str(op),.n)#0D#0A#0D#0A..SWITCHON.op.INTO#0D
#0A..{.DEFAULT:..2mcbadop(op,."L");.RETURN#0D#0A#0D
#0A..2CASE.mc_div:..f.:#3D.ia_idivl;.ENDCASE.//.idi
vl.Ln#0D#0A..2CASE.mc_datal:f.:#3D.ia_datal;.ENDCAS
E.//.datal.Ln#0D#0A..2CASE.mc_dlab:.f.:#3D.ia_dlab;
..ENDCASE.//.dlab.Ln#0D#0A..2CASE.mc_lab:..f.:#3D.i
a_lab;..1ENDCASE.//.lab.Ln#0D#0A..2CASE.mc_mul:..f.
:#3D.ia_imull;.ENDCASE.//.imull.Ln#0D#0A..2CASE.mc_
neg:..f.:#3D.ia_negl;..ENDCASE.//.negl.Ln#0D#0A..2C
ASE.mc_not:..f.:#3D.ia_notl;..ENDCASE.//.notl.Ln#0D
#0A..2CASE.mc_pop:..f.:#3D.ia_popl;..ENDCASE.//.pop
l.Ln#0D#0A..2CASE.mc_push:.f.:#3D.ia_pushl;.ENDCASE
.//.pushl.Ln#0D#0A..2CASE.mc_seq:..f.:#3D.ia_sete;.
.ENDCASE.//.sete.Ln#0D#0A..2CASE.mc_sne:..f.:#3D.ia
_setne;.ENDCASE.//.setne.Ln#0D#0A..2CASE.mc_slt:..f
.:#3D.ia_setl;..ENDCASE.//.setl.Ln#0D#0A..2CASE.mc_
sle:..f.:#3D.ia_setle;.ENDCASE.//.setle.Ln#0D#0A..2
CASE.mc_sgt:..f.:#3D.ia_setg;..ENDCASE.//.setg.Ln#0D
#0A..2CASE.mc_sge:..f.:#3D.ia_setge;.ENDCASE.//.set
ge.Ln#0D#0A..2CASE.mc_udiv:.f.:#3D.ia_divl;..ENDCAS
E.//.divl.Ln#0D#0A..2CASE.mc_umul:.f.:#3D.ia_mull;.
.ENDCASE.//.mull.Ln#0D#0A..2CASE.mc_uslt:.f.:#3D.ia
_setb;..ENDCASE.//.setb.Ln#0D#0A..2CASE.mc_usle:.f.
:#3D.ia_setbe;.ENDCASE.//.setbe.Ln#0D#0A..2CASE.mc_
usgt:.f.:#3D.ia_seta;..ENDCASE.//.seta.Ln#0D#0A..2C
ASE.mc_usge:.f.:#3D.ia_setae;.ENDCASE.//.setae.Ln#0D
#0A..}#0D#0A..iaL(f,.n).#0D#0A}#0D#0A#0D#0AAND.mcD(
op,.d).BE#0D#0A//.div.lab.mul.neg.not.pop.push#0D#0A
//.seq.sne.slt.sle.sgt.sge.udiv.umul.uslt.usle.usgt
.usge#0D#0A{.LET.f.#3D.0#0D#0A.#0D#0A..db1wrf("//..
2%s.%n*n",.mcop2str(op),.d)#0D#0A#0D#0A..SWITCHON.o
p.INTO#0D#0A..{.DEFAULT:..2mcbadop(op,."D");.RETURN
#0D#0A#0D#0A..2CASE.mc_div:..f.:#3D.ia_idivl;.ENDCA
SE.//.idivl.d#0D#0A..2CASE.mc_lab:..f.:#3D.ia_lab;.
.1ENDCASE.//.lab.d#0D#0A..2CASE.mc_mul:..f.:#3D.ia_
imull;.ENDCASE.//.imull.d#0D#0A..2CASE.mc_neg:..f.:
#3D.ia_negl;..ENDCASE.//.negl.d#0D#0A..2CASE.mc_not
:..f.:#3D.ia_notl;..ENDCASE.//.notl.d#0D#0A..2CASE.
mc_pop:..f.:#3D.ia_popl;..ENDCASE.//.popl.d#0D#0A..
2CASE.mc_push:.f.:#3D.ia_pushl;.ENDCASE.//.pushl.d#0D
#0A..2CASE.mc_seq:..f.:#3D.ia_sete;..ENDCASE.//.set
e.d#0D#0A..2CASE.mc_sne:..f.:#3D.ia_setne;.ENDCASE.
//.setne.d#0D#0A..2CASE.mc_slt:..f.:#3D.ia_setl;..E
NDCASE.//.setl.d#0D#0A..2CASE.mc_sle:..f.:#3D.ia_se
tle;.ENDCASE.//.setle.d#0D#0A..2CASE.mc_sgt:..f.:#3D
.ia_setg;..ENDCASE.//.setg.d#0D#0A..2CASE.mc_sge:..
f.:#3D.ia_setge;.ENDCASE.//.setge.d#0D#0A..2CASE.mc
_udiv:.f.:#3D.ia_divl;..ENDCASE.//.divl.d#0D#0A..2C
ASE.mc_umul:.f.:#3D.ia_mull;..ENDCASE.//.mull.d#0D#0A
..2CASE.mc_uslt:.f.:#3D.ia_setb;..ENDCASE.//.setb.d
#0D#0A..2CASE.mc_usle:.f.:#3D.ia_setbe;.ENDCASE.//.
setbe.d#0D#0A..2CASE.mc_usgt:.f.:#3D.ia_seta;..ENDC
ASE.//.seta.d#0D#0A..2CASE.mc_usge:.f.:#3D.ia_setae
;.ENDCASE.//.setae.d#0D#0A..}#0D#0A..iaD(f,.d).#0D#0A
}#0D#0A#0D#0AAND.mcDX(op,.d,.x).BE#0D#0A//.div.lab.
mul.neg.not.pop.push#0D#0A//.seq.sne.slt.sle.sgt.sg
e.udiv.umul.uslt.usle.usgt.usge#0D#0A{.LET.xname.#3D
.mcrname(x)#0D#0A..LET.iax.#3D.mcr2iar(x)#0D#0A..LE
T.f.#3D.0#0D#0A.#0D#0A..db1wrf("//..2%s.%n(%s)*n",.
mcop2str(op),.d,.xname)#0D#0A#0D#0A..SWITCHON.op.IN
TO#0D#0A..{.DEFAULT:..2mcbadop(op,."DX");.RETURN#0D
#0A#0D#0A..2CASE.mc_div:..f.:#3D.ia_idivl;.ENDCASE.
//.idivl.d(x)#0D#0A..2CASE.mc_lab:..f.:#3D.ia_lab;.
.1ENDCASE.//.lab.d(x)#0D#0A..2CASE.mc_mul:..f.:#3D.
ia_imull;.ENDCASE.//.imull.d(x)#0D#0A..2CASE.mc_neg
:..f.:#3D.ia_negl;..ENDCASE.//.negl.d(x)#0D#0A..2CA
SE.mc_not:..f.:#3D.ia_notl;..ENDCASE.//.notl.d(x)#0D
#0A..2CASE.mc_pop:..f.:#3D.ia_popl;..ENDCASE.//.pop
l.d(x)#0D#0A..2CASE.mc_push:.f.:#3D.ia_pushl;.ENDCA
SE.//.pushl.d(x)#0D#0A..2CASE.mc_seq:..f.:#3D.ia_se
te;..ENDCASE.//.sete.d(x)#0D#0A..2CASE.mc_sne:..f.:
#3D.ia_setne;.ENDCASE.//.setne.d(x)#0D#0A..2CASE.mc
_slt:..f.:#3D.ia_setl;..ENDCASE.//.setl.d(x)#0D#0A.
.2CASE.mc_sle:..f.:#3D.ia_setle;.ENDCASE.//.setle.d
(x)#0D#0A..2CASE.mc_sgt:..f.:#3D.ia_setg;..ENDCASE.
//.setg.d(x)#0D#0A..2CASE.mc_sge:..f.:#3D.ia_setge;
.ENDCASE.//.setge.d(x)#0D#0A..2CASE.mc_udiv:.f.:#3D
.ia_divl;..ENDCASE.//.divl.d(x)#0D#0A..2CASE.mc_umu
l:.f.:#3D.ia_mull;..ENDCASE.//.mull.d(x)#0D#0A..2CA
SE.mc_uslt:.f.:#3D.ia_setb;..ENDCASE.//.setb.d(x)#0D
#0A..2CASE.mc_usle:.f.:#3D.ia_setbe;.ENDCASE.//.set
be.d(x)#0D#0A..2CASE.mc_usgt:.f.:#3D.ia_seta;..ENDC
ASE.//.seta.d(x)#0D#0A..2CASE.mc_usge:.f.:#3D.ia_se
tae;.ENDCASE.//.setae.d(x)#0D#0A..}#0D#0A..iaDX(f,.
d,.iax).#0D#0A}#0D#0A#0D#0AAND.mcDXs(op,.d,.x,.s).B
E#0D#0A//.div.lab.mul.neg.not.pop.push#0D#0A//.seq.
sne.slt.sle.sgt.sge.udiv.umul.uslt.usle.usgt.usge#0D
#0A{.LET.xname.#3D.mcrname(x)#0D#0A..LET.iax.#3D.mc
r2iar(x)#0D#0A..LET.f.#3D.0#0D#0A.#0D#0A..db1wrf("/
/..2%s.%n(%s**%n)*n",.mcop2str(op),.d,.xname,.s)#0D
#0A#0D#0A..SWITCHON.op.INTO#0D#0A..{.DEFAULT:..2mcb
adop(op,."DXs");.RETURN#0D#0A#0D#0A..2CASE.mc_div:.
.f.:#3D.ia_idivl;.ENDCASE.//.idivl.d(x,s)#0D#0A..2C
ASE.mc_lab:..f.:#3D.ia_lab;..1ENDCASE.//.lab.d(x,s)
#0D#0A..2CASE.mc_mul:..f.:#3D.ia_imull;.ENDCASE.//.
imull.d(x,s)#0D#0A..2CASE.mc_neg:..f.:#3D.ia_negl;.
.ENDCASE.//.negl.d(x,s)#0D#0A..2CASE.mc_not:..f.:#3D
.ia_notl;..ENDCASE.//.notl.d(x,s)#0D#0A..2CASE.mc_p
op:..f.:#3D.ia_popl;..ENDCASE.//.popl.d(x,s)#0D#0A.
.2CASE.mc_push:.f.:#3D.ia_pushl;.ENDCASE.//.pushl.d
(x,s)#0D#0A..2CASE.mc_seq:..f.:#3D.ia_sete;..ENDCAS
E.//.sete.d(x,s)#0D#0A..2CASE.mc_sne:..f.:#3D.ia_se
tne;.ENDCASE.//.setne.d(x,s)#0D#0A..2CASE.mc_slt:..
f.:#3D.ia_setl;..ENDCASE.//.setl.d(x,s)#0D#0A..2CAS
E.mc_sle:..f.:#3D.ia_setle;.ENDCASE.//.setle.d(x,s)
#0D#0A..2CASE.mc_sgt:..f.:#3D.ia_setg;..ENDCASE.//.
setg.d(x,s)#0D#0A..2CASE.mc_sge:..f.:#3D.ia_setge;.
ENDCASE.//.setge.d(x,s)#0D#0A..2CASE.mc_udiv:.f.:#3D
.ia_divl;..ENDCASE.//.divl.d(x,s)#0D#0A..2CASE.mc_u
mul:.f.:#3D.ia_mull;..ENDCASE.//.mull.d(x,s)#0D#0A.
.2CASE.mc_uslt:.f.:#3D.ia_setb;..ENDCASE.//.setb.d(
x,s)#0D#0A..2CASE.mc_usle:.f.:#3D.ia_setbe;.ENDCASE
.//.setbe.d(x,s)#0D#0A..2CASE.mc_usgt:.f.:#3D.ia_se
ta;..ENDCASE.//.seta.d(x,s)#0D#0A..2CASE.mc_usge:.f
.:#3D.ia_setae;.ENDCASE.//.setae.d(x,s)#0D#0A..}#0D
#0A..iaDXs(f,.d,.iax,.s).#0D#0A}#0D#0A#0D#0AAND.mcD
XsB(op,.d,.x,.s,.b).BE#0D#0A//.div.lab.mul.neg.not.
pop.push#0D#0A//.seq.sne.slt.sle.sgt.sge.udiv.umul.
uslt.usle.usgt.usge#0D#0A{.LET.xname.#3D.mcrname(x)
#0D#0A..LET.bname.#3D.mcrname(b)#0D#0A..LET.iax.#3D
.mcr2iar(x)#0D#0A..LET.iab.#3D.mcr2iar(b)#0D#0A..LE
T.f.#3D.0#0D#0A.#0D#0A..db1wrf("//..2%s.%n(%s**%n+%
s)*n",.mcop2str(op),.d,.xname,.s,.bname)#0D#0A#0D#0A
..SWITCHON.op.INTO#0D#0A..{.DEFAULT:..2mcbadop(op,.
"DXsB");.RETURN#0D#0A#0D#0A..2CASE.mc_div:..f.:#3D.
ia_idivl;.ENDCASE.//.idivl.d(x,s,b)#0D#0A..2CASE.mc
_lab:..f.:#3D.ia_lab;..1ENDCASE.//.lab.d(x,s,b)#0D#0A
..2CASE.mc_mul:..f.:#3D.ia_imull;.ENDCASE.//.imull.
d(x,s,b)#0D#0A..2CASE.mc_neg:..f.:#3D.ia_negl;..END
CASE.//.negl.d(x,s,b)#0D#0A..2CASE.mc_not:..f.:#3D.
ia_notl;..ENDCASE.//.notl.d(x,s,b)#0D#0A..2CASE.mc_
pop:..f.:#3D.ia_popl;..ENDCASE.//.popl.d(x,s,b)#0D#0A
..2CASE.mc_push:.f.:#3D.ia_pushl;.ENDCASE.//.pushl.
d(x,s,b)#0D#0A..2CASE.mc_seq:..f.:#3D.ia_sete;..END
CASE.//.sete.d(x,s,b)#0D#0A..2CASE.mc_sne:..f.:#3D.
ia_setne;.ENDCASE.//.setne.d(x,s,b)#0D#0A..2CASE.mc
_slt:..f.:#3D.ia_setl;..ENDCASE.//.setl.d(x,s,b)#0D
#0A..2CASE.mc_sle:..f.:#3D.ia_setle;.ENDCASE.//.set
le.d(x,s,b)#0D#0A..2CASE.mc_sgt:..f.:#3D.ia_setg;..
ENDCASE.//.setg.d(x,s,b)#0D#0A..2CASE.mc_sge:..f.:#3D
.ia_setge;.ENDCASE.//.setge.d(x,s,b)#0D#0A..2CASE.m
c_udiv:.f.:#3D.ia_divl;..ENDCASE.//.divl.d(x,s,b)#0D
#0A..2CASE.mc_umul:.f.:#3D.ia_mull;..ENDCASE.//.mul
l.d(x,s,b)#0D#0A..2CASE.mc_uslt:.f.:#3D.ia_setb;..E
NDCASE.//.setb.d(x,s,b)#0D#0A..2CASE.mc_usle:.f.:#3D
.ia_setbe;.ENDCASE.//.setbe.d(x,s,b)#0D#0A..2CASE.m
c_usgt:.f.:#3D.ia_seta;..ENDCASE.//.seta.d(x,s,b)#0D
#0A..2CASE.mc_usge:.f.:#3D.ia_setae;.ENDCASE.//.set
ae.d(x,s,b)#0D#0A..}#0D#0A..iaDXsB(f,.d,.iax,.s,.ia
b).#0D#0A}#0D#0A#0D#0AAND.mcJS(op,.n).BE.mcJ(op,.n,
.TRUE)#0D#0A#0D#0AAND.mcJL(op,.n).BE.mcJ(op,.n,.FAL
SE)#0D#0A#0D#0AAND.mcJ(op,.n,.short).BE#0D#0A//.jmp
.jeq.jne.jlt.jle.jgt.jge#0D#0A#0D#0A//.If.short.is.
TRUE,.forward.refs.are.assumed.to.be.rel8#0D#0A{.LE
T.f.#3D.0#0D#0A#0D#0A..db1wrf("//..2%s.L%n*n",.mcop
2str(op),.n)#0D#0A#0D#0A..SWITCHON.op.INTO#0D#0A..{
.DEFAULT:..3mcbadop(op,.short.->."JS",."JL");.RETUR
N#0D#0A#0D#0A..2CASE.mc_jmp:.f.:#3D.ia_jmp;.ENDCASE
.//.jmp.Ln#0D#0A..2CASE.mc_jeq:.f.:#3D.ia_je;..ENDC
ASE.//.je.Ln#0D#0A..2CASE.mc_jne:.f.:#3D.ia_jne;.EN
DCASE.//.jne.Ln#0D#0A..2CASE.mc_jlt:.f.:#3D.ia_jl;.
.ENDCASE.//.jl.Ln#0D#0A..2CASE.mc_jle:.f.:#3D.ia_jl
e;.ENDCASE.//.jle.Ln#0D#0A..2CASE.mc_jgt:.f.:#3D.ia
_jg;..ENDCASE.//.jg.Ln#0D#0A..2CASE.mc_jge:.f.:#3D.
ia_jge;.ENDCASE.//.jge.Ln#0D#0A..2CASE.mc_ujlt:f.:#3D
.ia_jb;..ENDCASE.//.jb.Ln#0D#0A..2CASE.mc_ujle:f.:#3D
.ia_jbe;.ENDCASE.//.jbe.Ln#0D#0A..2CASE.mc_ujgt:f.:
#3D.ia_ja;..ENDCASE.//.ja.Ln#0D#0A..2CASE.mc_ujge:f
.:#3D.ia_jae;.ENDCASE.//.jae.Ln#0D#0A..}#0D#0A..iaJ
L(f,.n,.short)#0D#0A}#0D#0A#0D#0AAND.mcJR(op,.r).BE
#0D#0A{.LET.rname.#3D.mcrname(r)#0D#0A..LET.iar.#3D
.mcr2iar(r)#0D#0A#0D#0A..db1wrf("//..2%s.**%s*n",.m
cop2str(op),.rname)#0D#0A#0D#0A..SWITCHON.op.INTO#0D
#0A..{.DEFAULT:#0D#0A..4mcbadop(op,."JR")#0D#0A..4R
ETURN#0D#0A#0D#0A..2CASE.mc_jmp:.iaJR(ia_jmp,.iar);
.RETURN#0D#0A..}#0D#0A}#0D#0A#0D#0AAND.mcRA(op,.r,.
n).BE#0D#0A//.add.and.cmp.lea.lsh.mv.mvsxb.mvsxh.mv
zxb.mzxh.rsh.or.sub.xor#0D#0A{.LET.rname..#3D.mcrna
me(r)#0D#0A..LET.iar..2#3D.mcr2iar(r)#0D#0A..LET.f.
#3D.0#0D#0A#0D#0A..db1wrf("//..2%s.%s,A%n*n",.mcop2
str(op),.rname,.n)#0D#0A#0D#0A..UNLESS.1.<#3D.n.<#3D
.maxarg.DO#0D#0A..{.writef("*nError:.Argument.out.o
f.range..%i6:.%s.%s,A%n*n",#0D#0A..10codep,.mcop2st
r(op),.rname,.n)#0D#0A..2RETURN#0D#0A..}#0D#0A#0D#0A
..SWITCHON.op.INTO#0D#0A..{.DEFAULT:..4mcbadop(op,.
"RA");.RETURN#0D#0A#0D#0A..2CASE.mc_add:..1f.:#3D.i
a_addl;..1ENDCASE.//.r.+:#3D.<arg.n>#0D#0A..2CASE.m
c_addc:..f.:#3D.ia_addcl;..ENDCASE.//.r.+:#3D.<arg.
n>.+.carry#0D#0A..2CASE.mc_and:..1f.:#3D.ia_andl;..
1ENDCASE.//.r.&:#3D.<arg.n>#0D#0A..2CASE.mc_cmp:..1
f.:#3D.ia_cmpl;..1ENDCASE.//.condition.:#3D.r.-.<ar
g.n>#0D#0A..2CASE.mc_lea:..1f.:#3D.ia_leal;..1ENDCA
SE.//.r.:#3D.@.<arg.n>#0D#0A..2CASE.mc_lsh:..1f.:#3D
.ia_shll;..1ENDCASE.//.r.<<:#3D.<arg.n>#0D#0A..2CAS
E.mc_mv:..2f.:#3D.ia_movl;..1ENDCASE.//.r.:#3D.<arg
.n>#0D#0A..2CASE.mc_mvsxb:.f.:#3D.ia_movsbl;.ENDCAS
E.//.r.:#3D.sign.extend.byte.<arg.n>#0D#0A..2CASE.m
c_mvsxh:.f.:#3D.ia_movswl;.ENDCASE.//.r.:#3D.sign.e
xtend.word.<arg.n>#0D#0A..2CASE.mc_mvzxb:.f.:#3D.ia
_movzbl;.ENDCASE.//.r.:#3D.zero.extend.byte.<arg.n>
#0D#0A..2CASE.mc_mvzxh:.f.:#3D.ia_movzwl;.ENDCASE./
/.r.:#3D.zero.extend.word.<arg.n>#0D#0A..2CASE.mc_r
sh:..1f.:#3D.ia_shrl;..1ENDCASE.//.r.>>:#3D.<arg.n>
#0D#0A..2CASE.mc_or:..2f.:#3D.ia_orl;..2ENDCASE.//.
r.|:#3D.<arg.n>#0D#0A..2CASE.mc_sub:..1f.:#3D.ia_su
bl;..1ENDCASE.//.r.-:#3D.<arg.n>#0D#0A..2CASE.mc_su
bc:..f.:#3D.ia_sbbl;..1ENDCASE.//.r.-:#3D.<arg.n>.+
.borrow#0D#0A..2CASE.mc_xchg:..f.:#3D.ia_xchgl;..EN
DCASE.//.r.<#3D>.<arg.n>#0D#0A..2CASE.mc_xor:..1f.:
#3D.ia_xorl;..1ENDCASE.//.r.xor:#3D.<arg.n>#0D#0A..
}#0D#0A..iaRDX(f,.iar,.16+4*n,.Ebp)#0D#0A}#0D#0A#0D
#0AAND.mcRV(op,.r,.n).BE#0D#0A//.add.and.cmp.lea.ls
h.mv.mvsxb.mvsxh.mvzxb.mzxh.rsh.or.sub.xor#0D#0A{.L
ET.rname..#3D.mcrname(r)#0D#0A..LET.iar..2#3D.mcr2i
ar(r)#0D#0A..LET.f.#3D.0#0D#0A#0D#0A..db1wrf("//..2
%s.%s,V%n*n",.mcop2str(op),.rname,.n)#0D#0A#0D#0A..
UNLESS.1.<#3D.n.<#3D.maxvar.DO#0D#0A..{.writef("*nE
rror:.Variable.out.of.range..%i6:.%s.%s,V%n*n",#0D#0A
..10codep,.mcop2str(op),.rname,.n)#0D#0A..2RETURN#0D
#0A..}#0D#0A#0D#0A..SWITCHON.op.INTO#0D#0A..{.DEFAU
LT:..4mcbadop(op,."RV");.RETURN#0D#0A#0D#0A..2CASE.
mc_add:..1f.:#3D.ia_addl;..1ENDCASE.//.r.+:#3D.<var
.n>#0D#0A..2CASE.mc_addc:..f.:#3D.ia_addcl;..ENDCAS
E.//.r.+:#3D.<var.n>.+.carry#0D#0A..2CASE.mc_and:..
1f.:#3D.ia_andl;..1ENDCASE.//.r.&:#3D.<var.n>#0D#0A
..2CASE.mc_cmp:..1f.:#3D.ia_cmpl;..1ENDCASE.//.cond
ition.:#3D.r.-.<var.n>#0D#0A..2CASE.mc_lea:..1f.:#3D
.ia_leal;..1ENDCASE.//.r.:#3D.@.<var.n>#0D#0A..2CAS
E.mc_lsh:..1f.:#3D.ia_shll;..1ENDCASE.//.r.<<:#3D.<
var.n>#0D#0A..2CASE.mc_mv:..2f.:#3D.ia_movl;..1ENDC
ASE.//.r.:#3D.<var.n>#0D#0A..2CASE.mc_mvsxb:.f.:#3D
.ia_movsbl;.ENDCASE.//.r.:#3D.sign.extend.byte.<var
.n>#0D#0A..2CASE.mc_mvsxh:.f.:#3D.ia_movswl;.ENDCAS
E.//.r.:#3D.sign.extend.word.<var.n>#0D#0A..2CASE.m
c_mvzxb:.f.:#3D.ia_movzbl;.ENDCASE.//.r.:#3D.zero.e
xtend.byte.<var.n>#0D#0A..2CASE.mc_mvzxh:.f.:#3D.ia
_movzwl;.ENDCASE.//.r.:#3D.zero.extend.word.<var.n>
#0D#0A..2CASE.mc_rsh:..1f.:#3D.ia_shrl;..1ENDCASE./
/.r.>>:#3D.<var.n>#0D#0A..2CASE.mc_or:..2f.:#3D.ia_
orl;..2ENDCASE.//.r.|:#3D.<var.n>#0D#0A..2CASE.mc_s
ub:..1f.:#3D.ia_subl;..1ENDCASE.//.r.-:#3D.<var.n>#0D
#0A..2CASE.mc_subc:..f.:#3D.ia_sbbl;..1ENDCASE.//.r
.-:#3D.<var.n>.+.carry#0D#0A..2CASE.mc_xchg:..f.:#3D
.ia_xchgl;..ENDCASE.//.r.<#3D>.<var.n>#0D#0A..2CASE
.mc_xor:..1f.:#3D.ia_xorl;..1ENDCASE.//.r.xor:#3D.<
var.n>#0D#0A..}#0D#0A..iaRDX(f,.iar,.-4-4*n,.Ebp)#0D
#0A}#0D#0A#0D#0AAND.mcRG(op,.r,.n).BE#0D#0A//.add.a
nd.cmp.lea.lsh.mv.mvsxb.mvsxh.mvzxb.mzxh.rsh.or.sub
.xor#0D#0A{.LET.rname..#3D.mcrname(r)#0D#0A..LET.ia
r..2#3D.mcr2iar(r)#0D#0A..LET.f.#3D.0#0D#0A#0D#0A..
db1wrf("//..2%s.%s,G%n*n",.mcop2str(op),.rname,.n)#0D
#0A#0D#0A..UNLESS.0.<#3D.n.<#3D.globsize.DO#0D#0A..
{.writef("*nError:.Global.variable.out.of.range..%i
6:.%s.%s,G%n*n",#0D#0A..10codep,.mcop2str(op),.rnam
e,.n)#0D#0A..2RETURN#0D#0A..}#0D#0A#0D#0A..SWITCHON
.op.INTO#0D#0A..{.DEFAULT:..4mcbadop(op,."RG");.RET
URN#0D#0A#0D#0A..2CASE.mc_add:..1f.:#3D.ia_addl;..1
ENDCASE.//.r.+:#3D.<global.n>#0D#0A..2CASE.mc_addc:
..f.:#3D.ia_addcl;..ENDCASE.//.r.+:#3D.<global.n>.+
.carry#0D#0A..2CASE.mc_and:..1f.:#3D.ia_andl;..1END
CASE.//.r.&:#3D.<global.n>#0D#0A..2CASE.mc_cmp:..1f
.:#3D.ia_cmpl;..1ENDCASE.//.condition.:#3D.r.-.<glo
bal.n>#0D#0A..2CASE.mc_lea:..1f.:#3D.ia_leal;..1END
CASE.//.r.:#3D.@.<global.n>#0D#0A..2CASE.mc_lsh:..1
f.:#3D.ia_shll;..1ENDCASE.//.r.<<:#3D.<global.n>#0D
#0A..2CASE.mc_mv:..2f.:#3D.ia_movl;..1ENDCASE.//.r.
:#3D.<global.n>#0D#0A..2CASE.mc_mvsxb:.f.:#3D.ia_mo
vsbl;.ENDCASE.//.r.:#3D.sign.extend.byte.<global.n>
#0D#0A..2CASE.mc_mvsxh:.f.:#3D.ia_movswl;.ENDCASE./
/.r.:#3D.sign.extend.word.<global.n>#0D#0A..2CASE.m
c_mvzxb:.f.:#3D.ia_movzbl;.ENDCASE.//.r.:#3D.zero.e
xtend.byte.<global.n>#0D#0A..2CASE.mc_mvzxh:.f.:#3D
.ia_movzwl;.ENDCASE.//.r.:#3D.zero.extend.word.<glo
bal.n>#0D#0A..2CASE.mc_rsh:..1f.:#3D.ia_shrl;..1END
CASE.//.r.>>:#3D.<global.n>#0D#0A..2CASE.mc_or:..2f
.:#3D.ia_orl;..2ENDCASE.//.r.|:#3D.<global.n>#0D#0A
..2CASE.mc_sub:..1f.:#3D.ia_subl;..1ENDCASE.//.r.-:
#3D.<global.n>#0D#0A..2CASE.mc_subc:..f.:#3D.ia_sbb
l;..1ENDCASE.//.r.-:#3D.<global.n>.+.carry#0D#0A..2
CASE.mc_xchg:..f.:#3D.ia_xchgl;..ENDCASE.//.r.<#3D>
.<global.n>#0D#0A..2CASE.mc_xor:..1f.:#3D.ia_xorl;.
.1ENDCASE.//.r.xor:#3D.<global.n>#0D#0A..}#0D#0A..i
aRD(f,.iar,.rootnode!rtn_mc0.+(@globsize.+.n)*4)#0D
#0A}#0D#0A#0D#0AAND.mcRM(op,.r,.a).BE#0D#0A//.add.a
nd.cmp.lea.lsh.mv.mvsxb.mvsxh.mvzxb.mzxh.rsh.or.sub
.xor#0D#0A{.LET.rname.#3D.mcrname(r)#0D#0A..LET.iar
..1#3D.mcr2iar(r)#0D#0A..LET.f..#3D.0#0D#0A#0D#0A..
db1wrf("//..2%s.%s,M%n*n",.mcop2str(op),.rname,.a)#0D
#0A#0D#0A..SWITCHON.op.INTO#0D#0A..{.DEFAULT:..4mcb
adop(op,."RM");.RETURN#0D#0A#0D#0A..2CASE.mc_add:..
1f.:#3D.ia_addl;..1ENDCASE.//.r.+:#3D.<mem.a>#0D#0A
..2CASE.mc_addc:..f.:#3D.ia_addcl;..ENDCASE.//.r.+:
#3D.<mem.a>.+.carry#0D#0A..2CASE.mc_and:..1f.:#3D.i
a_andl;..1ENDCASE.//.r.&:#3D.<mem.a>#0D#0A..2CASE.m
c_cmp:..1f.:#3D.ia_cmpl;..1ENDCASE.//.condition.:#3D
.r.-.<mem.a>#0D#0A..2CASE.mc_lea:..1f.:#3D.ia_leal;
..1ENDCASE.//.r.:#3D.@.<mem.a>#0D#0A..2CASE.mc_lsh:
..1f.:#3D.ia_shll;..1ENDCASE.//.r.<<:#3D.<mem.a>#0D
#0A..2CASE.mc_mv:..2f.:#3D.ia_movl;..1ENDCASE.//.r.
:#3D.<mem.a>#0D#0A..2CASE.mc_mvsxb:.f.:#3D.ia_movsb
l;.ENDCASE.//.r.:#3D.sign.extend.byte.<mem.a>#0D#0A
..2CASE.mc_mvsxh:.f.:#3D.ia_movswl;.ENDCASE.//.r.:#3D
.sign.extend.word.<mem.a>#0D#0A..2CASE.mc_mvzxb:.f.
:#3D.ia_movzbl;.ENDCASE.//.r.:#3D.zero.extend.byte.
<mem.a>#0D#0A..2CASE.mc_mvzxh:.f.:#3D.ia_movzwl;.EN
DCASE.//.r.:#3D.zero.extend.word.<mem.a>#0D#0A..2CA
SE.mc_rsh:..1f.:#3D.ia_shrl;..1ENDCASE.//.r.>>:#3D.
<mem.a>#0D#0A..2CASE.mc_or:..2f.:#3D.ia_orl;..2ENDC
ASE.//.r.|:#3D.<mem.a>#0D#0A..2CASE.mc_sub:..1f.:#3D
.ia_subl;..1ENDCASE.//.r.-:#3D.<mem.a>#0D#0A..2CASE
.mc_subc:..f.:#3D.ia_sbbl;..1ENDCASE.//.r.-:#3D.<me
m.a>.+.carry#0D#0A..2CASE.mc_xchg:..f.:#3D.ia_xchgl
;..ENDCASE.//.r.<#3D>.<mem.a>#0D#0A..2CASE.mc_xor:.
.1f.:#3D.ia_xorl;..1ENDCASE.//.r.xor:#3D.<mem.a>#0D
#0A..}#0D#0A..iaRD(f,.iar,.rootnode!rtn_mc0.+.a*4)#0D
#0A}#0D#0A#0D#0AAND.mcRL(op,.r,.n).BE#0D#0A//.add.a
nd.cmp.lea.lsh.mv.mvsxb.mvsxh.mvzxb.mzxh.rsh.or.sub
.xor#0D#0A{.LET.mem.#3D.rootnode!rtn_mc0#0D#0A..LET
.rname.#3D.mcrname(r)#0D#0A..LET.iar.#3D.mcr2iar(r)
#0D#0A..LET.f.#3D.0#0D#0A..LET.val.#3D.labv!n#0D#0A
#0D#0A..db1wrf("//..2%s.%s,L%n*n",#0D#0A..8mcop2str
(op),.rname,.n)#0D#0A#0D#0A..UNLESS.val.DO#0D#0A..{
.writef("*nError:.Data.label.not.set..%i6:.%s.%s,L%
n*n",#0D#0A..10codep,.mcop2str(op),.rname,.n)#0D#0A
..2RETURN#0D#0A..}#0D#0A#0D#0A..SWITCHON.op.INTO#0D
#0A..{.DEFAULT:..5mcbadop(op,."RL");.RETURN#0D#0A#0D
#0A..2CASE.mc_add:..1f.:#3D.ia_addl;..1ENDCASE.//.r
.+:#3D.<data.Ln>#0D#0A..2CASE.mc_addc:..f.:#3D.ia_a
ddcl;..ENDCASE.//.r.+:#3D.<data.Ln>.+.carry#0D#0A..
2CASE.mc_and:..1f.:#3D.ia_andl;..1ENDCASE.//.r.&:#3D
.<data.Ln>#0D#0A..2CASE.mc_cmp:..1f.:#3D.ia_cmpl;..
1ENDCASE.//.condition.:#3D.r.-.<data.Ln>#0D#0A..2CA
SE.mc_lea:..1f.:#3D.ia_leal;..1ENDCASE.//.r.:#3D.@.
<data.Ln>#0D#0A..2CASE.mc_lsh:..1f.:#3D.ia_shll;..1
ENDCASE.//.r.<<:#3D.<data.Ln>#0D#0A..2CASE.mc_mv:..
2f.:#3D.ia_movl;..1ENDCASE.//.r.:#3D.<data.Ln>#0D#0A
..2CASE.mc_mvsxb:.f.:#3D.ia_movsbl;.ENDCASE.//.r.:#3D
.sign.extend.byte.<data.Ln>#0D#0A..2CASE.mc_mvsxh:.
f.:#3D.ia_movswl;.ENDCASE.//.r.:#3D.sign.extend.wor
d.<data.Ln>#0D#0A..2CASE.mc_mvzxb:.f.:#3D.ia_movzbl
;.ENDCASE.//.r.:#3D.zero.extend.byte.<data.Ln>#0D#0A
..2CASE.mc_mvzxh:.f.:#3D.ia_movzwl;.ENDCASE.//.r.:#3D
.zero.extend.word.<data.Ln>#0D#0A..2CASE.mc_rsh:..1
f.:#3D.ia_shrl;..1ENDCASE.//.r.>>:#3D.<data.Ln>#0D#0A
..2CASE.mc_or:..2f.:#3D.ia_orl;..2ENDCASE.//.r.|:#3D
.<data.Ln>#0D#0A..2CASE.mc_sub:..1f.:#3D.ia_subl;..
1ENDCASE.//.r.-:#3D.<data.Ln>#0D#0A..2CASE.mc_subc:
..f.:#3D.ia_sbbl;..1ENDCASE.//.r.-:#3D.<data.Ln>.+.
carry#0D#0A..2CASE.mc_xchg:..f.:#3D.ia_xchgl;..ENDC
ASE.//.r.<#3D>.<data.Ln>#0D#0A..2CASE.mc_xor:..1f.:
#3D.ia_xorl;..1ENDCASE.//.r.xor:#3D.<data.Ln>#0D#0A
..}#0D#0A..iaRL(f,.iar,.n)#0D#0A}#0D#0A#0D#0AAND.mc
RD(op,.r,.d).BE#0D#0A//.add.and.cmp.lea.lsh.mv.mvsx
b.mvsxh.mvzxb.mzxh.rsh.or.sub.xor#0D#0A{.#0D#0A..LE
T.rname.#3D.mcrname(r)#0D#0A..LET.iar..1#3D.mcr2iar
(r)#0D#0A..LET.f.#3D.0#0D#0A#0D#0A..db1wrf("//..2%s
.%s,%n*n",#0D#0A..8mcop2str(op),.rname,.d)#0D#0A#0D
#0A..SWITCHON.op.INTO#0D#0A..{.DEFAULT:..5mcbadop(o
p,."RD");.RETURN#0D#0A#0D#0A..2CASE.mc_add:..1f.:#3D
.ia_addl;..1ENDCASE.//.r.+:#3D.d#0D#0A..2CASE.mc_ad
dc:..f.:#3D.ia_addcl;..ENDCASE.//.r.+:#3D.d.+.carry
#0D#0A..2CASE.mc_and:..1f.:#3D.ia_andl;..1ENDCASE./
/.r.&:#3D.d#0D#0A..2CASE.mc_cmp:..1f.:#3D.ia_cmpl;.
.1ENDCASE.//.condition.:#3D.r.-.d#0D#0A..2CASE.mc_l
ea:..1f.:#3D.ia_leal;..1ENDCASE.//.r.:#3D.@.d#0D#0A
..2CASE.mc_lsh:..1f.:#3D.ia_shll;..1ENDCASE.//.r.<<
:#3D.d#0D#0A..2CASE.mc_mv:..2f.:#3D.ia_movl;..1ENDC
ASE.//.r.:#3D.d#0D#0A..2CASE.mc_mvsxb:.f.:#3D.ia_mo
vsbl;.ENDCASE.//.r.:#3D.sign.extend.byte.d#0D#0A..2
CASE.mc_mvsxh:.f.:#3D.ia_movswl;.ENDCASE.//.r.:#3D.
sign.extend.word.d#0D#0A..2CASE.mc_mvzxb:.f.:#3D.ia
_movzbl;.ENDCASE.//.r.:#3D.zero.extend.byte.d#0D#0A
..2CASE.mc_mvzxh:.f.:#3D.ia_movzwl;.ENDCASE.//.r.:#3D
.zero.extend.word.d#0D#0A..2CASE.mc_rsh:..1f.:#3D.i
a_shrl;..1ENDCASE.//.r.>>:#3D.d#0D#0A..2CASE.mc_or:
..2f.:#3D.ia_orl;..2ENDCASE.//.r.|:#3D.d#0D#0A..2CA
SE.mc_sub:..1f.:#3D.ia_subl;..1ENDCASE.//.r.-:#3D.d
#0D#0A..2CASE.mc_subc:..f.:#3D.ia_sbbl;..1ENDCASE./
/.r.-:#3D.d.+.carry#0D#0A..2CASE.mc_xchg:..f.:#3D.i
a_xchgl;..ENDCASE.//.r.<#3D>.d#0D#0A..2CASE.mc_xor:
..1f.:#3D.ia_xorl;..1ENDCASE.//.r.xor:#3D.d#0D#0A..
}#0D#0A..iaRD(f,.iar,.d)#0D#0A}#0D#0A#0D#0AAND.mcRD
X(op,.r,.d,.x).BE#0D#0A//.add.and.cmp.lea.lsh.mv.mv
sxb.mvsxh.mvzxb.mzxh.rsh.or.sub.xor#0D#0A{.#0D#0A..
LET.rname.#3D.mcrname(r)#0D#0A..LET.xname.#3D.mcrna
me(x)#0D#0A..LET.iar..1#3D.mcr2iar(r)#0D#0A..LET.ia
x..1#3D.mcr2iar(x)#0D#0A..LET.f.#3D.0#0D#0A#0D#0A..
db1wrf("//..2%s.%s,%n(%s)*n",#0D#0A..8mcop2str(op),
.rname,.d,.xname)#0D#0A#0D#0A..SWITCHON.op.INTO#0D#0A
..{.DEFAULT:..5mcbadop(op,."RDX");.RETURN#0D#0A#0D#0A
..2CASE.mc_add:..1f.:#3D.ia_addl;..1ENDCASE.//.r.+:
#3D.d(x)#0D#0A..2CASE.mc_addc:..f.:#3D.ia_addcl;..E
NDCASE.//.r.+:#3D.d(x).+.carry#0D#0A..2CASE.mc_and:
..1f.:#3D.ia_andl;..1ENDCASE.//.r.&:#3D.d(x)#0D#0A.
.2CASE.mc_cmp:..1f.:#3D.ia_cmpl;..1ENDCASE.//.condi
tion.:#3D.r.-.d(x)#0D#0A..2CASE.mc_lea:..1f.:#3D.ia
_leal;..1ENDCASE.//.r.:#3D.@.d(x)#0D#0A..2CASE.mc_l
sh:..1f.:#3D.ia_shll;..1ENDCASE.//.r.<<:#3D.d(x)#0D
#0A..2CASE.mc_mv:..2f.:#3D.ia_movl;..1ENDCASE.//.r.
:#3D.d(x)#0D#0A..2CASE.mc_mvsxb:.f.:#3D.ia_movsbl;.
ENDCASE.//.r.:#3D.sign.extend.byte.d(x)#0D#0A..2CAS
E.mc_mvsxh:.f.:#3D.ia_movswl;.ENDCASE.//.r.:#3D.sig
n.extend.word.d(x)#0D#0A..2CASE.mc_mvzxb:.f.:#3D.ia
_movzbl;.ENDCASE.//.r.:#3D.zero.extend.byte.d(x)#0D
#0A..2CASE.mc_mvzxh:.f.:#3D.ia_movzwl;.ENDCASE.//.r
.:#3D.zero.extend.word.d(x)#0D#0A..2CASE.mc_rsh:..1
f.:#3D.ia_shrl;..1ENDCASE.//.r.>>:#3D.d(x)#0D#0A..2
CASE.mc_or:..2f.:#3D.ia_orl;..2ENDCASE.//.r.|:#3D.d
(x)#0D#0A..2CASE.mc_sub:..1f.:#3D.ia_subl;..1ENDCAS
E.//.r.-:#3D.d(x)#0D#0A..2CASE.mc_subc:..f.:#3D.ia_
sbbl;..1ENDCASE.//.r.-:#3D.d(x).+.carry#0D#0A..2CAS
E.mc_xchg:..f.:#3D.ia_xchgl;..ENDCASE.//.r.<#3D>.d(
x)#0D#0A..2CASE.mc_xor:..1f.:#3D.ia_xorl;..1ENDCASE
.//.r.xor:#3D.d(x)#0D#0A..}#0D#0A..iaRDX(f,.iar,.d,
.iax)#0D#0A}#0D#0A#0D#0AAND.mcRDXs(op,.r,.d,.x,.s).
BE#0D#0A//.add.and.cmp.lea.lsh.mv.mvsxb.mvsxh.mvzxb
.mzxh.rsh.or.sub.xor#0D#0A{.#0D#0A..LET.rname.#3D.m
crname(r)#0D#0A..LET.xname.#3D.mcrname(x)#0D#0A..LE
T.iar..1#3D.mcr2iar(r)#0D#0A..LET.iax..1#3D.mcr2iar
(x)#0D#0A..LET.f.#3D.0#0D#0A#0D#0A..db1wrf("//..2%s
.%s,%n(%s**%n)*n",#0D#0A..8mcop2str(op),.rname,.d,.
xname,.s)#0D#0A#0D#0A..SWITCHON.op.INTO#0D#0A..{.DE
FAULT:..5mcbadop(op,."RDXs");.RETURN#0D#0A#0D#0A..2
CASE.mc_add:..1f.:#3D.ia_addl;..1ENDCASE.//.r.+:#3D
.d(x,s)#0D#0A..2CASE.mc_addc:..f.:#3D.ia_addcl;..EN
DCASE.//.r.+:#3D.d(x,s).+.carry#0D#0A..2CASE.mc_and
:..1f.:#3D.ia_andl;..1ENDCASE.//.r.&:#3D.d(x,s)#0D#0A
..2CASE.mc_cmp:..1f.:#3D.ia_cmpl;..1ENDCASE.//.cond
ition.:#3D.r.-.d(x,s)#0D#0A..2CASE.mc_lea:..1f.:#3D
.ia_leal;..1ENDCASE.//.r.:#3D.@.d(x,s)#0D#0A..2CASE
.mc_lsh:..1f.:#3D.ia_shll;..1ENDCASE.//.r.<<:#3D.d(
x,s)#0D#0A..2CASE.mc_mv:..2f.:#3D.ia_movl;..1ENDCAS
E.//.r.:#3D.d(x,s)#0D#0A..2CASE.mc_mvsxb:.f.:#3D.ia
_movsbl;.ENDCASE.//.r.:#3D.sign.extend.byte.d(x,s)#0D
#0A..2CASE.mc_mvsxh:.f.:#3D.ia_movswl;.ENDCASE.//.r
.:#3D.sign.extend.word.d(x,s)#0D#0A..2CASE.mc_mvzxb
:.f.:#3D.ia_movzbl;.ENDCASE.//.r.:#3D.zero.extend.b
yte.d(x,s)#0D#0A..2CASE.mc_mvzxh:.f.:#3D.ia_movzwl;
.ENDCASE.//.r.:#3D.zero.extend.word.d(x,s)#0D#0A..2
CASE.mc_rsh:..1f.:#3D.ia_shrl;..1ENDCASE.//.r.>>:#3D
.d(x,s)#0D#0A..2CASE.mc_or:..2f.:#3D.ia_orl;..2ENDC
ASE.//.r.|:#3D.d(x,s)#0D#0A..2CASE.mc_sub:..1f.:#3D
.ia_subl;..1ENDCASE.//.r.-:#3D.d(x,s)#0D#0A..2CASE.
mc_subc:..f.:#3D.ia_sbbl;..1ENDCASE.//.r.-:#3D.d(x,
s).+.carry#0D#0A..2CASE.mc_xchg:..f.:#3D.ia_xchgl;.
.ENDCASE.//.r.<#3D>.d(x,s)#0D#0A..2CASE.mc_xor:..1f
.:#3D.ia_xorl;..1ENDCASE.//.r.xor:#3D.d(x,s)#0D#0A.
.}#0D#0A//writef("mcRDXs:.calling.iaRDXs(f,.%n,.%n,
.%n,.%n)*n",.iar,.d,.iax,.s)#0D#0A..iaRDXs(f,.iar,.
d,.iax,.s)#0D#0A}#0D#0A#0D#0AAND.mcRDXsB(op,.r,.d,.
x,.s,.b).BE#0D#0A//.add.and.cmp.lea.lsh.mv.mvsxb.mv
sxh.mvzxb.mzxh.rsh.or.sub.xor#0D#0A{.#0D#0A..LET.rn
ame.#3D.mcrname(r)#0D#0A..LET.xname.#3D.mcrname(x)#0D
#0A..LET.bname.#3D.mcrname(b)#0D#0A..LET.iar..1#3D.
mcr2iar(r)#0D#0A..LET.iax..1#3D.mcr2iar(x)#0D#0A..L
ET.iab..1#3D.mcr2iar(b)#0D#0A..LET.f.#3D.0#0D#0A#0D
#0A..db1wrf("//..2%s.%s,%n(%s**%n+%s)*n",#0D#0A..8m
cop2str(op),.rname,.d,.xname,.s,.bname)#0D#0A#0D#0A
..SWITCHON.op.INTO#0D#0A..{.DEFAULT:..5mcbadop(op,.
"RDXsB");.RETURN#0D#0A#0D#0A..2CASE.mc_add:..1f.:#3D
.ia_addl;..1ENDCASE.//.r.+:#3D.d(x,s,b)#0D#0A..2CAS
E.mc_addc:..f.:#3D.ia_addcl;..ENDCASE.//.r.+:#3D.d(
x,s,b).+.carry#0D#0A..2CASE.mc_and:..1f.:#3D.ia_and
l;..1ENDCASE.//.r.&:#3D.d(x,s,b)#0D#0A..2CASE.mc_cm
p:..1f.:#3D.ia_cmpl;..1ENDCASE.//.condition.:#3D.r.
-.d(x,s,b)#0D#0A..2CASE.mc_lea:..1f.:#3D.ia_leal;..
1ENDCASE.//.r.:#3D.@.d(x,s,b)#0D#0A..2CASE.mc_lsh:.
.1f.:#3D.ia_shll;..1ENDCASE.//.r.<<:#3D.d(x,s,b)#0D
#0A..2CASE.mc_mv:..2f.:#3D.ia_movl;..1ENDCASE.//.r.
:#3D.d(x,s,b)#0D#0A..2CASE.mc_mvsxb:.f.:#3D.ia_movs
bl;.ENDCASE.//.r.:#3D.sign.extend.byte.d(x,s,b)#0D#0A
..2CASE.mc_mvsxh:.f.:#3D.ia_movswl;.ENDCASE.//.r.:#3D
.sign.extend.word.d(x,s,b)#0D#0A..2CASE.mc_mvzxb:.f
.:#3D.ia_movzbl;.ENDCASE.//.r.:#3D.zero.extend.byte
.d(x,s,b)#0D#0A..2CASE.mc_mvzxh:.f.:#3D.ia_movzwl;.
ENDCASE.//.r.:#3D.zero.extend.word.d(x,s,b)#0D#0A..
2CASE.mc_rsh:..1f.:#3D.ia_shrl;..1ENDCASE.//.r.>>:#3D
.d(x,s,b)#0D#0A..2CASE.mc_or:..2f.:#3D.ia_orl;..2EN
DCASE.//.r.|:#3D.d(x,s,b)#0D#0A..2CASE.mc_sub:..1f.
:#3D.ia_subl;..1ENDCASE.//.r.-:#3D.d(x,s,b)#0D#0A..
2CASE.mc_subc:..f.:#3D.ia_sbbl;..1ENDCASE.//.r.-:#3D
.d(x,s,b).+.carry#0D#0A..2CASE.mc_xchg:..f.:#3D.ia_
xchgl;..ENDCASE.//.r.<#3D>.d(x,s,b)#0D#0A..2CASE.mc
_xor:..1f.:#3D.ia_xorl;..1ENDCASE.//.r.xor:#3D.d(x,
s,b)#0D#0A..}#0D#0A..iaRDXsB(f,.iar,.d,.iax,.s,.iab
)#0D#0A}#0D#0A#0D#0AAND.mcRR(op,.r,.t).BE..//.r.is.
destination#0D#0A//.add.and.cmp.ld.lsh.mv.mvsxb.mvs
xh.mvzxb.mvzxh.or.rsh.sub.xchg.xor#0D#0A{.LET.rname
.#3D.mcrname(r)#0D#0A..LET.tname.#3D.mcrname(t)#0D#0A
..LET.iar.#3D.mcr2iar(r)#0D#0A..LET.iat.#3D.mcr2iar
(t)#0D#0A..LET.f.#3D.0#0D#0A#0D#0A..db1wrf("//..2%s
.%s,%s*n",.mcop2str(op),.rname,.tname)#0D#0A#0D#0A.
.SWITCHON.op.INTO#0D#0A..{.DEFAULT:..6mcbadop(op,."
RR");.RETURN#0D#0A#0D#0A..2CASE.mc_add:.f.:#3D.ia_a
ddl;.ENDCASE.//.r.+:#3D.t#0D#0A..2CASE.mc_addc:f.:#3D
.ia_addcl;ENDCASE.//.r.+:#3D.t.+.carry#0D#0A..2CASE
.mc_and:.f.:#3D.ia_andl;.ENDCASE.//.r.&:#3D.t#0D#0A
..2CASE.mc_cmp:.f.:#3D.ia_cmpl;.ENDCASE.//.conditio
n.:#3D.r.-.t#0D#0A..2CASE.mc_mv:..IF.r#3Dt.RETURN#0D
#0A..15f.:#3D.ia_movl;.ENDCASE.//.r.:#3D.t#0D#0A..2
CASE.mc_mvsxb:.f.:#3D.ia_movsbl;.ENDCASE.//.r.:#3D.
sign.extend.byte(t)#0D#0A..2CASE.mc_mvsxh:.f.:#3D.i
a_movswl;.ENDCASE.//.r.:#3D.sign.extend.halfword(t)
#0D#0A..2CASE.mc_mvzxb:.f.:#3D.ia_movzbl;.ENDCASE./
/.r.:#3D.zero.extend.byte(t)#0D#0A..2CASE.mc_mvzxh:
.f.:#3D.ia_movzwl;.ENDCASE.//.r.:#3D.zero.extend.ha
lfword(t)#0D#0A..2CASE.mc_lsh:.UNLESS.t#3Dmc_c.DO#0D
#0A..15{.writef("Shift.amount.must.either.be.a.cons
tant.or.be.in.C*n")#0D#0A..17RETURN#0D#0A..15}#0D#0A
..15f.:#3D.ia_shll;.ENDCASE.//.r.:#3D.r.<<.C#0D#0A#0D
#0A..2CASE.mc_or:..f.:#3D.ia_orl;..ENDCASE.//.r.|:#3D
.t#0D#0A..2CASE.mc_rsh:.UNLESS.t#3Dmc_c.DO#0D#0A..1
5{.writef("Shift.amount.must.either.be.a.constant.o
r.be.in.C*n")#0D#0A..17RETURN#0D#0A..15}#0D#0A..15f
.:#3D.ia_shrl;.ENDCASE.//.r.:#3D.r.>>.C#0D#0A#0D#0A
..2CASE.mc_sub:.f.:#3D.ia_subl;.ENDCASE.//.r.-:#3D.
t#0D#0A..2CASE.mc_subc:f.:#3D.ia_sbbl;.ENDCASE.//.r
.-:#3D.t.+.carry#0D#0A..2CASE.mc_xchg:f.:#3D.ia_xch
gl;ENDCASE.//.xchg(r,.t)#0D#0A..2CASE.mc_xor:.f.:#3D
.ia_xorl;.ENDCASE.//.r.xor:#3D.t#0D#0A..}#0D#0A..ia
RR(f,.iar,.iat).//.iar.is.destination#0D#0A}#0D#0A#0D
#0AAND.mcAR(op,.n,.r).BE#0D#0A//.add.and.cmp.lsh.mv
.mvb.mvh.rsh.or.sub.xor#0D#0A{.LET.rname.#3D.mcrnam
e(r)#0D#0A..LET.iar.#3D.mcr2iar(r)#0D#0A..LET.f.#3D
.0#0D#0A#0D#0A..db1wrf("//..2%s.A%n,%s*n",.mcop2str
(op),.n,.rname)#0D#0A#0D#0A..UNLESS.1.<#3D.n.<#3D.m
axarg.DO#0D#0A..{.writef("*nError:.Argument.out.of.
range..%i6:.%s.A%n,%s*n",#0D#0A..10codep,.mcop2str(
op),.n,.rname)#0D#0A..2RETURN#0D#0A..}#0D#0A#0D#0A.
.SWITCHON.op.INTO#0D#0A..{.DEFAULT:..4mcbadop(op,."
AR");.RETURN#0D#0A#0D#0A..2CASE.mc_add:..f.:#3D.ia_
addl;..1ENDCASE.//.<arg.n>.+:#3D.r#0D#0A..2CASE.mc_
addc:.f.:#3D.ia_addcl;..ENDCASE.//.<arg.n>.+:#3D.r.
+.carry#0D#0A..2CASE.mc_and:..f.:#3D.ia_andl;..1END
CASE.//.<arg.n>.&:#3D.r#0D#0A..2CASE.mc_cmp:..f.:#3D
.ia_cmpl;..1ENDCASE.//.condition.:#3D.<arg.n>.-.r#0D
#0A..2CASE.mc_lsh:..f.:#3D.ia_shll;..1ENDCASE.//.<a
rg.n>.<<:#3D.r#0D#0A..2CASE.mc_mv:..1f.:#3D.ia_movl
;..1ENDCASE.//.<arg.n>.:#3D.r#0D#0A..2CASE.mc_mvb:.
.f.:#3D.ia_movb;..1ENDCASE.//.<arg.n>.:#3D.r.(byte)
#0D#0A..2CASE.mc_mvh:..f.:#3D.ia_movw;..1ENDCASE.//
.<arg.n>.:#3D.r.(halfword)#0D#0A..2CASE.mc_or:..1f.
:#3D.ia_orl;..2ENDCASE.//.<arg.n>.|:#3D.r#0D#0A..2C
ASE.mc_rsh:..f.:#3D.ia_shrl;..1ENDCASE.//.<arg.n>.>
>:#3D.r#0D#0A..2CASE.mc_sub:..f.:#3D.ia_subl;..1END
CASE.//.<arg.n>.-:#3D.r#0D#0A..2CASE.mc_subc:.f.:#3D
.ia_sbbl;..1ENDCASE.//.<arg.n>.-:#3D.r.+.carry#0D#0A
..2CASE.mc_xor:..f.:#3D.ia_xorl;..1ENDCASE.//.<arg.
n>.xor:#3D.r#0D#0A..}#0D#0A..iaDXR(f,.16+4*n,.Ebp,.
iar)#0D#0A}#0D#0A#0D#0AAND.mcVR(op,.n,.r).BE#0D#0A/
/.add.and.cmp.lsh.mv.mvb.mvh.or.rsh.sub.xor#0D#0A{.
LET.rname.#3D.mcrname(r)#0D#0A..LET.iar.#3D.mcr2iar
(r)#0D#0A..LET.f.#3D.0#0D#0A#0D#0A..db1wrf("//..2%s
.V%n,%s*n",.mcop2str(op),.n,.rname)#0D#0A#0D#0A..UN
LESS.1.<#3D.n.<#3D.maxvar.DO#0D#0A..{.writef("*nErr
or:.Variable.out.of.range..%i6:.%s.V%n,%s*n",#0D#0A
..10codep,.mcop2str(op),.n,.rname)#0D#0A..2RETURN#0D
#0A..}#0D#0A#0D#0A..SWITCHON.op.INTO#0D#0A..{.DEFAU
LT:..4mcbadop(op,."VR");.RETURN#0D#0A#0D#0A..2CASE.
mc_add:..f.:#3D.ia_addl;.ENDCASE.//.<var.n>.+:#3D.r
#0D#0A..2CASE.mc_addc:.f.:#3D.ia_addcl;ENDCASE.//.<
var.n>.+:#3D.r.+.carry#0D#0A..2CASE.mc_and:..f.:#3D
.ia_andl;.ENDCASE.//.<var.n>.&:#3D.r#0D#0A..2CASE.m
c_cmp:..f.:#3D.ia_cmpl;.ENDCASE.//.condition.:#3D.<
var.n>.-.r#0D#0A..2CASE.mc_lsh:..f.:#3D.ia_shll;.EN
DCASE.//.<var.n>.<<:#3D.r#0D#0A..2CASE.mc_mv:..1f.:
#3D.ia_movl;.ENDCASE.//.<var.n>.:#3D.r#0D#0A..2CASE
.mc_mvb:..f.:#3D.ia_movb;.ENDCASE.//.<var.n>.:#3D.k
.(byte)#0D#0A..2CASE.mc_mvh:..f.:#3D.ia_movw;.ENDCA
SE.//.<var.n>.:#3D.k.(halfword)#0D#0A..2CASE.mc_or:
..1f.:#3D.ia_orl;..ENDCASE.//.<var.n>.|:#3D.r#0D#0A
..2CASE.mc_rsh:..f.:#3D.ia_shrl;.ENDCASE.//.<var.n>
.>>:#3D.r#0D#0A..2CASE.mc_sub:..f.:#3D.ia_subl;.END
CASE.//.<var.n>.-:#3D.r#0D#0A..2CASE.mc_subc:.f.:#3D
.ia_sbbl;.ENDCASE.//.<var.n>.-:#3D.r.+.carry#0D#0A.
.2CASE.mc_xor:..f.:#3D.ia_xorl;.ENDCASE.//.<var.n>.
xor:#3D.r#0D#0A..}#0D#0A..iaDXR(f,.-4-4*n,.Ebp,.iar
)#0D#0A}#0D#0A#0D#0AAND.mcGR(op,.n,.r).BE#0D#0A//.a
dd.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A{.LET.rname.#3D
.mcrname(r)#0D#0A..LET.iar.#3D.mcr2iar(r)#0D#0A..LE
T.f.#3D.0#0D#0A#0D#0A..db1wrf("//..2%s.G%n,%s*n",.m
cop2str(op),.n,.rname)#0D#0A#0D#0A..UNLESS.0.<#3D.n
.<#3D.globsize.DO#0D#0A..{.writef("*nError:.Global.
variable.out.of.range..%i6:.%s.G%n,%s*n",#0D#0A..10
codep,.mcop2str(op),.n,.rname)#0D#0A..2RETURN#0D#0A
..}#0D#0A#0D#0A..SWITCHON.op.INTO#0D#0A..{.DEFAULT:
..4mcbadop(op,."GR");.RETURN#0D#0A#0D#0A..2CASE.mc_
add:..f.:#3D.ia_addl;.ENDCASE.//.<global.n>.+:#3D.r
#0D#0A..2CASE.mc_addc:.f.:#3D.ia_addcl;ENDCASE.//.<
global.n>.+:#3D.r.+.carry#0D#0A..2CASE.mc_and:..f.:
#3D.ia_andl;.ENDCASE.//.<global.n>.&:#3D.r#0D#0A..2
CASE.mc_cmp:..f.:#3D.ia_cmpl;.ENDCASE.//.condition.
:#3D.<global.n>.-.r#0D#0A..2CASE.mc_lsh:..f.:#3D.ia
_shll;.ENDCASE.//.<global.n>.<<:#3D.r#0D#0A..2CASE.
mc_mv:..1f.:#3D.ia_movl;.ENDCASE.//.<global.n>.:#3D
.r#0D#0A..2CASE.mc_mvb:..f.:#3D.ia_movb;.ENDCASE.//
.<global.n>.:#3D.k.(byte)#0D#0A..2CASE.mc_mvh:..f.:
#3D.ia_movw;.ENDCASE.//.<global.n>.:#3D.k.(halfword
)#0D#0A..2CASE.mc_or:..1f.:#3D.ia_orl;..ENDCASE.//.
<global.n>.|:#3D.r#0D#0A..2CASE.mc_rsh:..f.:#3D.ia_
shrl;.ENDCASE.//.<global.n>.>>:#3D.r#0D#0A..2CASE.m
c_sub:..f.:#3D.ia_subl;.ENDCASE.//.<global.n>.-:#3D
.r#0D#0A..2CASE.mc_subc:.f.:#3D.ia_sbbl;.ENDCASE.//
.<global.n>.-:#3D.r.+.carry#0D#0A..2CASE.mc_xor:..f
.:#3D.ia_xorl;.ENDCASE.//.<global.n>.xor:#3D.r#0D#0A
..}#0D#0A..iaDR(f,.rootnode!rtn_mc0.+(@globsize.+.n
)*4,.iar)#0D#0A}#0D#0A#0D#0AAND.mcMR(op,.a,.r).BE#0D
#0A//.add.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A{.LET.
mem.#3D.rootnode!rtn_mc0#0D#0A..LET.rname.#3D.mcrna
me(r)#0D#0A..LET.iar.#3D.mcr2iar(r)#0D#0A..LET.f.#3D
.0#0D#0A#0D#0A..db1wrf("//..2%s.M%n,%s*n",.mcop2str
(op),.a,.rname)#0D#0A#0D#0A..SWITCHON.op.INTO#0D#0A
..{.DEFAULT:..4mcbadop(op,."MR");.RETURN#0D#0A#0D#0A
..2CASE.mc_add:..f.:#3D.ia_addl;.ENDCASE.//.<mem.a>
.+:#3D.r#0D#0A..2CASE.mc_addc:.f.:#3D.ia_addcl;ENDC
ASE.//.<mem.a>.+:#3D.r.+.carry#0D#0A..2CASE.mc_and:
..f.:#3D.ia_andl;.ENDCASE.//.<mem.a>.&:#3D.r#0D#0A.
.2CASE.mc_cmp:..f.:#3D.ia_cmpl;.ENDCASE.//.conditio
n.:#3D.<mem.a>.-.r#0D#0A..2CASE.mc_lsh:..f.:#3D.ia_
shll;.ENDCASE.//.<mem.a>.<<:#3D.r#0D#0A..2CASE.mc_m
v:..1f.:#3D.ia_movl;.ENDCASE.//.<mem.a>.:#3D.r#0D#0A
..2CASE.mc_mvb:..f.:#3D.ia_movb;.ENDCASE.//.<mem.a>
.:#3D.k.(byte)#0D#0A..2CASE.mc_mvh:..f.:#3D.ia_movw
;.ENDCASE.//.<mem.a>.:#3D.k.(halfword)#0D#0A..2CASE
.mc_or:..1f.:#3D.ia_orl;..ENDCASE.//.<mem.a>.|:#3D.
r#0D#0A..2CASE.mc_rsh:..f.:#3D.ia_shrl;.ENDCASE.//.
<mem.a>.>>:#3D.r#0D#0A..2CASE.mc_sub:..f.:#3D.ia_su
bl;.ENDCASE.//.<mem.a>.-:#3D.r#0D#0A..2CASE.mc_subc
:.f.:#3D.ia_sbbl;.ENDCASE.//.<mem.a>.-:#3D.r.+.carr
y#0D#0A..2CASE.mc_xor:..f.:#3D.ia_xorl;.ENDCASE.//.
<mem.a>.xor:#3D.r#0D#0A..}#0D#0A..iaDR(f,.mem+4*a,.
iar)#0D#0A}#0D#0A#0D#0AAND.mcLR(op,.n,.r).BE#0D#0A/
/.add.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A{.LET.mem.
#3D.rootnode!rtn_mc0#0D#0A..LET.rname.#3D.mcrname(r
)#0D#0A..LET.iar.#3D.mcr2iar(r)#0D#0A..LET.f.#3D.0#0D
#0A..LET.val.#3D.labv!n#0D#0A#0D#0A..db1wrf("//..2%
s.L%n,%s*n",.mcop2str(op),.n,.rname)#0D#0A#0D#0A..U
NLESS.val.DO#0D#0A..{.writef("*nError:.Data.label.n
ot.set..%i6:.%s.L%n,%s*n",#0D#0A..10codep,.mcop2str
(op),.n,.rname)#0D#0A..2RETURN#0D#0A..}#0D#0A#0D#0A
..SWITCHON.op.INTO#0D#0A..{.DEFAULT:..4mcbadop(op,.
"LR");.RETURN#0D#0A#0D#0A..2CASE.mc_add:..f.:#3D.ia
_addl;.ENDCASE.//.<data.Ln>.+:#3D.r#0D#0A..2CASE.mc
_addc:.f.:#3D.ia_addcl;ENDCASE.//.<data.Ln>.+:#3D.r
.+.carry#0D#0A..2CASE.mc_and:..f.:#3D.ia_andl;.ENDC
ASE.//.<data.Ln>.&:#3D.r#0D#0A..2CASE.mc_cmp:..f.:#3D
.ia_cmpl;.ENDCASE.//.condition.:#3D.<data.Ln>.-.r#0D
#0A..2CASE.mc_lsh:..f.:#3D.ia_shll;.ENDCASE.//.<dat
a.Ln>.<<:#3D.r#0D#0A..2CASE.mc_mv:..1f.:#3D.ia_movl
;.ENDCASE.//.<data.Ln>.:#3D.r#0D#0A..2CASE.mc_mvb:.
.f.:#3D.ia_movb;.ENDCASE.//.<data.Ln>.:#3D.k.(byte)
#0D#0A..2CASE.mc_mvh:..f.:#3D.ia_movw;.ENDCASE.//.<
data.Ln>.:#3D.k.(halfword)#0D#0A..2CASE.mc_or:..1f.
:#3D.ia_orl;..ENDCASE.//.<data.Ln>.|:#3D.r#0D#0A..2
CASE.mc_rsh:..f.:#3D.ia_shrl;.ENDCASE.//.<data.Ln>.
>>:#3D.r#0D#0A..2CASE.mc_sub:..f.:#3D.ia_subl;.ENDC
ASE.//.<data.Ln>.-:#3D.r#0D#0A..2CASE.mc_subc:.f.:#3D
.ia_sbbl;.ENDCASE.//.<data.Ln>.-:#3D.r.+.carry#0D#0A
..2CASE.mc_xor:..f.:#3D.ia_xorl;.ENDCASE.//.<data.L
n>.xor:#3D.r#0D#0A..}#0D#0A..iaDR(f,.mem+4*mc+val,.
iar)#0D#0A}#0D#0A#0D#0AAND.mcDR(op,.d,.r).BE#0D#0A/
/.add.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A{.LET.mem.
#3D.rootnode!rtn_mc0#0D#0A..LET.rname.#3D.mcrname(r
)#0D#0A..LET.iar.#3D.mcr2iar(r)#0D#0A..LET.f.#3D.0#0D
#0A#0D#0A..db1wrf("//..2%s.%n,%s*n",.mcop2str(op),.
d,.rname)#0D#0A#0D#0A..SWITCHON.op.INTO#0D#0A..{.DE
FAULT:..4mcbadop(op,."DR");.RETURN#0D#0A#0D#0A..2CA
SE.mc_add:..f.:#3D.ia_addl;.ENDCASE.//.<addr.d>.+:#3D
.r#0D#0A..2CASE.mc_addc:.f.:#3D.ia_addcl;ENDCASE.//
.<addr.d>.+:#3D.r.+.carry#0D#0A..2CASE.mc_and:..f.:
#3D.ia_andl;.ENDCASE.//.<addr.d>.&:#3D.r#0D#0A..2CA
SE.mc_cmp:..f.:#3D.ia_cmpl;.ENDCASE.//.condition.:#3D
.<addr.d>.-.r#0D#0A..2CASE.mc_lsh:..f.:#3D.ia_shll;
.ENDCASE.//.<addr.d>.<<:#3D.r#0D#0A..2CASE.mc_mv:..
1f.:#3D.ia_movl;.ENDCASE.//.<addr.d>.:#3D.r#0D#0A..
2CASE.mc_mvb:..f.:#3D.ia_movb;.ENDCASE.//.<addr.d>.
:#3D.k.(byte)#0D#0A..2CASE.mc_mvh:..f.:#3D.ia_movw;
.ENDCASE.//.<addr.d>.:#3D.k.(halfword)#0D#0A..2CASE
.mc_or:..1f.:#3D.ia_orl;..ENDCASE.//.<addr.d>.|:#3D
.r#0D#0A..2CASE.mc_rsh:..f.:#3D.ia_shrl;.ENDCASE.//
.<addr.d>.>>:#3D.r#0D#0A..2CASE.mc_sub:..f.:#3D.ia_
subl;.ENDCASE.//.<addr.d>.-:#3D.r#0D#0A..2CASE.mc_s
ubc:.f.:#3D.ia_sbbl;.ENDCASE.//.<addr.d>.-:#3D.r.+.
carry#0D#0A..2CASE.mc_xor:..f.:#3D.ia_xorl;.ENDCASE
.//.<addr.d>.xor:#3D.r#0D#0A..}#0D#0A..iaDR(f,.d,.i
ar)#0D#0A}#0D#0A#0D#0AAND.mcDXR(op,.d,.x,.r).BE#0D#0A
//.add.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A{.LET.xna
me.#3D.mcrname(x)#0D#0A..LET.rname.#3D.mcrname(r)#0D
#0A..LET.iax..1#3D.mcr2iar(x)#0D#0A..LET.iar..1#3D.
mcr2iar(r)#0D#0A..LET.f..#3D.0#0D#0A#0D#0A..db1wrf(
"//..2%s.%n(%s),%s*n",.mcop2str(op),.d,.xname,.rnam
e)#0D#0A#0D#0A..SWITCHON.op.INTO#0D#0A..{.DEFAULT:.
.4mcbadop(op,."DXR");.RETURN#0D#0A#0D#0A..2CASE.mc_
add:..f.:#3D.ia_addl;.ENDCASE.//.d(x).+:#3D.r#0D#0A
..2CASE.mc_addc:.f.:#3D.ia_addcl;ENDCASE.//.d(x).+:
#3D.r.+.carry#0D#0A..2CASE.mc_and:..f.:#3D.ia_andl;
.ENDCASE.//.d(x).&:#3D.r#0D#0A..2CASE.mc_cmp:..f.:#3D
.ia_cmpl;.ENDCASE.//.condition.:#3D.d(x).-.r#0D#0A.
.2CASE.mc_lsh:..f.:#3D.ia_shll;.ENDCASE.//.d(x).<<:
#3D.r#0D#0A..2CASE.mc_mv:..1f.:#3D.ia_movl;.ENDCASE
.//.d(x).:#3D.r#0D#0A..2CASE.mc_mvb:..f.:#3D.ia_mov
b;.ENDCASE.//.d(x).:#3D.k.(byte)#0D#0A..2CASE.mc_mv
h:..f.:#3D.ia_movw;.ENDCASE.//.d(x).:#3D.k.(halfwor
d)#0D#0A..2CASE.mc_or:..1f.:#3D.ia_orl;..ENDCASE.//
.d(x).|:#3D.r#0D#0A..2CASE.mc_rsh:..f.:#3D.ia_shrl;
.ENDCASE.//.d(x).>>:#3D.r#0D#0A..2CASE.mc_sub:..f.:
#3D.ia_subl;.ENDCASE.//.d(x).-:#3D.r#0D#0A..2CASE.m
c_subc:.f.:#3D.ia_sbbl;.ENDCASE.//.d(x).-:#3D.r.+.c
arry#0D#0A..2CASE.mc_xor:..f.:#3D.ia_xorl;.ENDCASE.
//.d(x).xor:#3D.r#0D#0A..}#0D#0A..iaDXR(f,.d,.iax,.
iar)#0D#0A}#0D#0A#0D#0AAND.mcDXsR(op,.d,.x,.s,.r).B
E#0D#0A//.add.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A{.
LET.xname.#3D.mcrname(x)#0D#0A..LET.rname.#3D.mcrna
me(r)#0D#0A..LET.iax..1#3D.mcr2iar(x)#0D#0A..LET.ia
r..1#3D.mcr2iar(r)#0D#0A..LET.f.#3D.0#0D#0A#0D#0A..
db1wrf("//..2%s.%n(%s**%n),%s*n",.mcop2str(op),.d,.
xname,.s,.rname)#0D#0A#0D#0A..SWITCHON.op.INTO#0D#0A
..{.DEFAULT:..4mcbadop(op,."DXsR");.RETURN#0D#0A#0D
#0A..2CASE.mc_add:..f.:#3D.ia_addl;.ENDCASE.//.d(x*
4).+:#3D.r#0D#0A..2CASE.mc_addc:.f.:#3D.ia_addcl;EN
DCASE.//.d(x*4).+:#3D.r.+.carry#0D#0A..2CASE.mc_and
:..f.:#3D.ia_andl;.ENDCASE.//.d(x*4).&:#3D.r#0D#0A.
.2CASE.mc_cmp:..f.:#3D.ia_cmpl;.ENDCASE.//.conditio
n.:#3D.d(x*4).-.r#0D#0A..2CASE.mc_lsh:..f.:#3D.ia_s
hll;.ENDCASE.//.d(x*4).<<:#3D.r#0D#0A..2CASE.mc_mv:
..1f.:#3D.ia_movl;.ENDCASE.//.d(x*4).:#3D.r#0D#0A..
2CASE.mc_mvb:..f.:#3D.ia_movb;.ENDCASE.//.d(x*s).:#3D
.r.(byte)#0D#0A..2CASE.mc_mvh:..f.:#3D.ia_movw;.END
CASE.//.d(x*s).:#3D.r.(halfword)#0D#0A..2CASE.mc_or
:..1f.:#3D.ia_orl;..ENDCASE.//.d(x*4).|:#3D.r#0D#0A
..2CASE.mc_rsh:..f.:#3D.ia_shrl;.ENDCASE.//.d(x*4).
>>:#3D.r#0D#0A..2CASE.mc_sub:..f.:#3D.ia_subl;.ENDC
ASE.//.d(x*4).-:#3D.r#0D#0A..2CASE.mc_subc:.f.:#3D.
ia_sbbl;.ENDCASE.//.d(x*4).-:#3D.r.+.carry#0D#0A..2
CASE.mc_xor:..f.:#3D.ia_xorl;.ENDCASE.//.d(x*4).xor
:#3D.r#0D#0A..}#0D#0A..iaDXsR(f,.d,.iax,.s,.iar)#0D
#0A}#0D#0A#0D#0AAND.mcDXsBR(op,.d,.x,.s,.b,.r).BE#0D
#0A//.add.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A{.LET.
xname.#3D.mcrname(x)#0D#0A..LET.bname.#3D.mcrname(b
)#0D#0A..LET.rname.#3D.mcrname(r)#0D#0A..LET.iax..1
#3D.mcr2iar(x)#0D#0A..LET.iab..1#3D.mcr2iar(b)#0D#0A
..LET.iar..1#3D.mcr2iar(r)#0D#0A..LET.f..#3D.0#0D#0A
#0D#0A..db1wrf("//..2%s.%s,%n(%s**%n+%s)*n",.mcop2s
tr(op),.rname,.d,.xname,.s,.bname)#0D#0A#0D#0A..SWI
TCHON.op.INTO#0D#0A..{.DEFAULT:..4mcbadop(op,."DXsB
R");.RETURN#0D#0A#0D#0A..2CASE.mc_add:..f.:#3D.ia_a
ddl;.ENDCASE.//.d(x*4+b).+:#3D.r#0D#0A..2CASE.mc_ad
dc:.f.:#3D.ia_addcl;ENDCASE.//.d(x*4+b).+:#3D.r.+.c
arry#0D#0A..2CASE.mc_and:..f.:#3D.ia_andl;.ENDCASE.
//.d(x*4+b).&:#3D.r#0D#0A..2CASE.mc_cmp:..f.:#3D.ia
_cmpl;.ENDCASE.//.condition.:#3D.d(x*4+b).-.r#0D#0A
..2CASE.mc_lsh:..f.:#3D.ia_shll;.ENDCASE.//.d(x*4+b
).<<:#3D.r#0D#0A..2CASE.mc_mv:..1f.:#3D.ia_movl;.EN
DCASE.//.d(x*4+b).:#3D.r#0D#0A..2CASE.mc_mvb:..f.:#3D
.ia_movb;.ENDCASE.//.d(b,x,s).:#3D.k.(byte)#0D#0A..
2CASE.mc_mvh:..f.:#3D.ia_movw;.ENDCASE.//.d(b,x,s).
:#3D.k.(halfword)#0D#0A..2CASE.mc_or:..1f.:#3D.ia_o
rl;..ENDCASE.//.d(x*4+b).|:#3D.r#0D#0A..2CASE.mc_rs
h:..f.:#3D.ia_shrl;.ENDCASE.//.d(x*4+b).>>:#3D.r#0D
#0A..2CASE.mc_sub:..f.:#3D.ia_subl;.ENDCASE.//.d(x*
4+b).-:#3D.r#0D#0A..2CASE.mc_subc:.f.:#3D.ia_sbbl;.
ENDCASE.//.d(x*4+b).-:#3D.r.+.carry#0D#0A..2CASE.mc
_xor:..f.:#3D.ia_xorl;.ENDCASE.//.d(x*4+b).xor:#3D.
r#0D#0A..}#0D#0A..iaDXsBR(f,.d,.iax,.s,.iab,.iar)#0D
#0A}#0D#0A#0D#0A#0D#0AAND.mcRK(op,.r,.k).BE#0D#0A//
.add.and.cmp.ld.lsh.or.rsh.sub.xor#0D#0A{.LET.iar.#3D
.mcr2iar(r)#0D#0A..LET.rname.#3D.mcrname(r)#0D#0A..
LET.f.#3D.0#0D#0A#0D#0A..db1wrf("//..2%s.%s,$%n*n",
.mcop2str(op),.rname,.k)#0D#0A#0D#0A..SWITCHON.op.I
NTO#0D#0A..{.DEFAULT:..5mcbadop(op,."RK");.RETURN#0D
#0A#0D#0A..2CASE.mc_add:..1f.:#3D.ia_addl;.ENDCASE.
//.r.+:#3D.k#0D#0A..2CASE.mc_addc:..f.:#3D.ia_addcl
;ENDCASE.//.r.+:#3D.k.+.carry#0D#0A..2CASE.mc_and:.
.1f.:#3D.ia_andl;.ENDCASE.//.r.&:#3D.k#0D#0A..2CASE
.mc_cmp:..1f.:#3D.ia_cmpl;.ENDCASE.//.condition.:#3D
.r.-.k#0D#0A..2CASE.mc_mv:..2UNLESS.k.DO#0D#0A..17{
.iaRR(ia_xorl,.iar,.iar).//.r.:#3D.0#0D#0A..19RETUR
N#0D#0A..17}#0D#0A..17f.:#3D.ia_movl;.ENDCASE.//.r.
:#3D.k#0D#0A#0D#0A..2CASE.mc_lsh:..1IF.k<0.|.k>31.D
O..4//.r.<<:#3D.k#0D#0A..17{.iaRR(ia_xorl,.iar,.iar
)#0D#0A..19RETURN#0D#0A..17}#0D#0A..17f.:#3D.ia_shl
l;.ENDCASE#0D#0A..2CASE.mc_or:..2f.:#3D.ia_orl;..EN
DCASE.//.r.|:#3D.k#0D#0A..2CASE.mc_rsh:..1IF.k<0.|.
k>31.DO..4//.r.>>:#3D.k#0D#0A..17{.iaRR(ia_xorl,.ia
r,.iar)#0D#0A..19RETURN#0D#0A..17}#0D#0A..17f.:#3D.
ia_shrl;.ENDCASE.//.r.<<:#3D.k#0D#0A..2CASE.mc_sub:
..1f.:#3D.ia_subl;.ENDCASE.//.r.-:#3D.k#0D#0A..2CAS
E.mc_subc:..f.:#3D.ia_sbbl;.ENDCASE.//.r.-:#3D.k.+.
carry#0D#0A..2CASE.mc_xor:..1f.:#3D.ia_xorl;.ENDCAS
E.//.r.xor:#3D.k#0D#0A..}#0D#0A..iaRK(f,.iar,.k)#0D
#0A}#0D#0A#0D#0AAND.mcAK(op,.n,.k).BE#0D#0A//.add.a
nd.cmp.lsh.mv.mvb.mvh.rsh.or.sub.xor#0D#0A{.LET.f.#3D
.0#0D#0A..LET.d.#3D.16+4*n#0D#0A#0D#0A..db1wrf("//.
.2%s.A%n,$%n*n",.mcop2str(op),.n,.k)#0D#0A#0D#0A..U
NLESS.1.<#3D.n.<#3D.maxarg.DO#0D#0A..{.writef("*nEr
ror:.Variable.out.of.range..%i6:.%s.A%n,$%n*n",#0D#0A
..10codep,.mcop2str(op),.n,.k)#0D#0A..2RETURN#0D#0A
..}#0D#0A#0D#0A..SWITCHON.op.INTO#0D#0A..{.DEFAULT:
..4mcbadop(op,."AK");.RETURN#0D#0A#0D#0A..2CASE.mc_
add:..f.:#3D.ia_addl;.ENDCASE.//.<arg.n>.+:#3D.k#0D
#0A..2CASE.mc_addc:.f.:#3D.ia_addcl;ENDCASE.//.<arg
.n>.+:#3D.k.+.carry#0D#0A..2CASE.mc_and:..f.:#3D.ia
_andl;.ENDCASE.//.<arg.n>.&:#3D.k#0D#0A..2CASE.mc_c
mp:..f.:#3D.ia_cmpl;.ENDCASE.//.condition.:#3D.<arg
.n>.-.k#0D#0A..2CASE.mc_lsh:..f.:#3D.ia_shll;.ENDCA
SE.//.<arg.n>.<<:#3D.k#0D#0A..2CASE.mc_mv:..1f.:#3D
.ia_movl;.ENDCASE.//.<arg.n>.:#3D.k#0D#0A..2CASE.mc
_mvb:..f.:#3D.ia_movb;.ENDCASE.//.<arg.n>.:#3D.k.(b
yte)#0D#0A..2CASE.mc_mvh:..f.:#3D.ia_movw;.ENDCASE.
//.<arg.n>.:#3D.k.(halfword)#0D#0A..2CASE.mc_or:..1
f.:#3D.ia_orl;..ENDCASE.//.<arg.n>.|:#3D.k#0D#0A..2
CASE.mc_rsh:..f.:#3D.ia_shrl;.ENDCASE.//.<arg.n>.>>
:#3D.k#0D#0A..2CASE.mc_sub:..f.:#3D.ia_subl;.ENDCAS
E.//.<arg.n>.-:#3D.k#0D#0A..2CASE.mc_subc:.f.:#3D.i
a_sbbl;.ENDCASE.//.<arg.n>.-:#3D.k.+.carry#0D#0A..2
CASE.mc_xor:..f.:#3D.ia_xorl;.ENDCASE.//.<arg.n>.xo
r:#3D.k#0D#0A..}#0D#0A..iaDXK(f,.d,.Ebp,.k)#0D#0A}#0D
#0A#0D#0AAND.mcVK(op,.n,.k).BE#0D#0A//.add.and.cmp.
lsh.mv.rsh.or.sub.xor#0D#0A{.LET.d,.f.#3D.-4-4*n,.0
#0D#0A#0D#0A..db1wrf("//..2%s.V%n,$%n*n",.mcop2str(
op),.n,.k)#0D#0A#0D#0A..UNLESS.1.<#3D.n.<#3D.maxvar
.DO#0D#0A..{.writef("*nError:.Variable.out.of.range
..%i6:.%s.V%n,$%n*n",#0D#0A..10codep,.mcop2str(op),
.n,.k)#0D#0A..2RETURN#0D#0A..}#0D#0A#0D#0A..SWITCHO
N.op.INTO#0D#0A..{.DEFAULT:..4mcbadop(op,."VR");.RE
TURN#0D#0A#0D#0A..2CASE.mc_add:..f.:#3D.ia_addl;.EN
DCASE.//.<var.n>.+:#3D.k#0D#0A..2CASE.mc_addc:.f.:#3D
.ia_addcl;ENDCASE.//.<var.n>.+:#3D.k.+.carry#0D#0A.
.2CASE.mc_and:..f.:#3D.ia_andl;.ENDCASE.//.<var.n>.
&:#3D.k#0D#0A..2CASE.mc_cmp:..f.:#3D.ia_cmpl;.ENDCA
SE.//.condition.:#3D.<var.n>.-.k#0D#0A..2CASE.mc_ls
h:..f.:#3D.ia_shll;.ENDCASE.//.<var.n>.<<:#3D.k#0D#0A
..2CASE.mc_mv:..1f.:#3D.ia_movl;.ENDCASE.//.<var.n>
.:#3D.k#0D#0A..2CASE.mc_mvb:..f.:#3D.ia_movb;.ENDCA
SE.//.<var.n>.:#3D.k.(byte)#0D#0A..2CASE.mc_mvh:..f
.:#3D.ia_movw;.ENDCASE.//.<var.n>.:#3D.k.(halfword)
#0D#0A..2CASE.mc_or:..1f.:#3D.ia_orl;..ENDCASE.//.<
var.n>.|:#3D.k#0D#0A..2CASE.mc_rsh:..f.:#3D.ia_shrl
;.ENDCASE.//.<var.n>.>>:#3D.k#0D#0A..2CASE.mc_sub:.
.f.:#3D.ia_subl;.ENDCASE.//.<var.n>.-:#3D.k#0D#0A..
2CASE.mc_subc:.f.:#3D.ia_sbbl;.ENDCASE.//.<var.n>.-
:#3D.k.+.carry#0D#0A..2CASE.mc_xor:..f.:#3D.ia_xorl
;.ENDCASE.//.<var.n>.xor:#3D.k#0D#0A..}#0D#0A..iaDX
K(f,.d,.Ebp,.k)#0D#0A}#0D#0A#0D#0AAND.mcGK(op,.n,.k
).BE#0D#0A//.add.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A
{.LET.d,.f.#3D..rootnode!rtn_mc0.+(@globsize.+.n)*4
,.0#0D#0A#0D#0A..db1wrf("//..2%s.G%n,$%n*n",.mcop2s
tr(op),.n,.k)#0D#0A#0D#0A..UNLESS.0.<#3D.n.<#3D.glo
bsize.DO#0D#0A..{.writef("*nError:.Global.variable.
out.of.range..%i6:.%s.G%n,$%n*n",#0D#0A..10codep,.m
cop2str(op),.n,.k)#0D#0A..2RETURN#0D#0A..}#0D#0A#0D
#0A..SWITCHON.op.INTO#0D#0A..{.DEFAULT:..4mcbadop(o
p,."GK");.RETURN#0D#0A#0D#0A..2CASE.mc_add:..f.:#3D
.ia_addl;.ENDCASE.//.<global.n>.+:#3D.k#0D#0A..2CAS
E.mc_addc:.f.:#3D.ia_addcl;ENDCASE.//.<global.n>.+:
#3D.k.+.carry#0D#0A..2CASE.mc_and:..f.:#3D.ia_andl;
.ENDCASE.//.<global.n>.&:#3D.k#0D#0A..2CASE.mc_cmp:
..f.:#3D.ia_cmpl;.ENDCASE.//.condition.:#3D.<global
.n>.-.k#0D#0A..2CASE.mc_lsh:..f.:#3D.ia_shll;.ENDCA
SE.//.<global.n>.<<:#3D.k#0D#0A..2CASE.mc_mv:..1f.:
#3D.ia_movl;.ENDCASE.//.<global.n>.:#3D.k#0D#0A..2C
ASE.mc_mvb:..f.:#3D.ia_movb;.ENDCASE.//.<global.n>.
:#3D.k.(byte)#0D#0A..2CASE.mc_mvh:..f.:#3D.ia_movw;
.ENDCASE.//.<global.n>.:#3D.k.(halfword)#0D#0A..2CA
SE.mc_or:..1f.:#3D.ia_orl;..ENDCASE.//.<global.n>.|
:#3D.k#0D#0A..2CASE.mc_rsh:..f.:#3D.ia_shrl;.ENDCAS
E.//.<global.n>.>>:#3D.k#0D#0A..2CASE.mc_sub:..f.:#3D
.ia_subl;.ENDCASE.//.<global.n>.-:#3D.k#0D#0A..2CAS
E.mc_subc:.f.:#3D.ia_sbbl;.ENDCASE.//.<global.n>.-:
#3D.k.+.carry#0D#0A..2CASE.mc_xor:..f.:#3D.ia_xorl;
.ENDCASE.//.<global.n>.xor:#3D.k#0D#0A..}#0D#0A..ia
DK(f,.d,.k)#0D#0A}#0D#0A#0D#0AAND.mcMK(op,.a,.k).BE
#0D#0A//.add.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A{.L
ET.mem.#3D.rootnode!rtn_mc0#0D#0A..LET.d,.f.#3D.mem
+4*a,.0#0D#0A#0D#0A..db1wrf("//..2%s.M%n,$%n*n",.mc
op2str(op),.a,.k)#0D#0A#0D#0A..SWITCHON.op.INTO#0D#0A
..{.DEFAULT:..4mcbadop(op,."MK");.RETURN#0D#0A#0D#0A
..2CASE.mc_add:..f.:#3D.ia_addl;.ENDCASE.//.<mem.a>
.+:#3D.k#0D#0A..2CASE.mc_addc:.f.:#3D.ia_addcl;ENDC
ASE.//.<mem.a>.+:#3D.k.+.carry#0D#0A..2CASE.mc_and:
..f.:#3D.ia_andl;.ENDCASE.//.<mem.a>.&:#3D.k#0D#0A.
.2CASE.mc_cmp:..f.:#3D.ia_cmpl;.ENDCASE.//.conditio
n.:#3D.<mem.a>.-.k#0D#0A..2CASE.mc_lsh:..f.:#3D.ia_
shll;.ENDCASE.//.<mem.a>.<<:#3D.k#0D#0A..2CASE.mc_m
v:..1f.:#3D.ia_movl;.ENDCASE.//.<mem.a>.:#3D.k#0D#0A
..2CASE.mc_mvb:..f.:#3D.ia_movb;.ENDCASE.//.<mem.a>
.:#3D.k.(byte)#0D#0A..2CASE.mc_mvh:..f.:#3D.ia_movw
;.ENDCASE.//.<mem.a>.:#3D.k.(halfword)#0D#0A..2CASE
.mc_or:..1f.:#3D.ia_orl;..ENDCASE.//.<mem.a>.|:#3D.
k#0D#0A..2CASE.mc_rsh:..f.:#3D.ia_shrl;.ENDCASE.//.
<mem.a>.>>:#3D.k#0D#0A..2CASE.mc_sub:..f.:#3D.ia_su
bl;.ENDCASE.//.<mem.a>.-:#3D.k#0D#0A..2CASE.mc_subc
:.f.:#3D.ia_sbbl;.ENDCASE.//.<mem.a>.-:#3D.k.+.carr
y#0D#0A..2CASE.mc_xor:..f.:#3D.ia_xorl;.ENDCASE.//.
<mem.a>.xor:#3D.k#0D#0A..}#0D#0A..iaDK(f,.d,.k)#0D#0A
}#0D#0A#0D#0AAND.mcLK(op,.n,.k).BE#0D#0A//.add.and.
cmp.lsh.mv.rsh.or.sub.xor#0D#0A{.LET.mem.#3D.rootno
de!rtn_mc0#0D#0A..LET.val.#3D.labv!n#0D#0A..LET.d,.
f.#3D.mem+4*mc+val,.0#0D#0A#0D#0A..db1wrf("//..2%s.
L%n,$%n*n",.mcop2str(op),.n,.k)#0D#0A#0D#0A..UNLESS
.val.DO#0D#0A..{.writef("*nError:.Data.label.not.se
t..%i6:.%s.L%n,$%n*n",#0D#0A..10codep,.mcop2str(op)
,.n,.k)#0D#0A..2RETURN#0D#0A..}#0D#0A#0D#0A..SWITCH
ON.op.INTO#0D#0A..{.DEFAULT:..4mcbadop(op,."LK");.R
ETURN#0D#0A#0D#0A..2CASE.mc_add:..f.:#3D.ia_addl;.E
NDCASE.//.<data.Ln>.+:#3D.k#0D#0A..2CASE.mc_addc:.f
.:#3D.ia_addcl;ENDCASE.//.<data.Ln>.+:#3D.k.+.carry
#0D#0A..2CASE.mc_and:..f.:#3D.ia_andl;.ENDCASE.//.<
data.Ln>.&:#3D.k#0D#0A..2CASE.mc_cmp:..f.:#3D.ia_cm
pl;.ENDCASE.//.condition.:#3D.<data.Ln>.-.k#0D#0A..
2CASE.mc_lsh:..f.:#3D.ia_shll;.ENDCASE.//.<data.Ln>
.<<:#3D.k#0D#0A..2CASE.mc_mv:..1f.:#3D.ia_movl;.END
CASE.//.<data.Ln>.:#3D.k#0D#0A..2CASE.mc_mvb:..f.:#3D
.ia_movb;.ENDCASE.//.<data.Ln>.:#3D.k.(byte)#0D#0A.
.2CASE.mc_mvh:..f.:#3D.ia_movw;.ENDCASE.//.<data.Ln
>.:#3D.k.(halfword)#0D#0A..2CASE.mc_or:..1f.:#3D.ia
_orl;..ENDCASE.//.<data.Ln>.|:#3D.k#0D#0A..2CASE.mc
_rsh:..f.:#3D.ia_shrl;.ENDCASE.//.<data.Ln>.>>:#3D.
k#0D#0A..2CASE.mc_sub:..f.:#3D.ia_subl;.ENDCASE.//.
<data.Ln>.-:#3D.k#0D#0A..2CASE.mc_subc:.f.:#3D.ia_s
bbl;.ENDCASE.//.<data.Ln>.-:#3D.k.+.carry#0D#0A..2C
ASE.mc_xor:..f.:#3D.ia_xorl;.ENDCASE.//.<data.Ln>.x
or:#3D.k#0D#0A..}#0D#0A..iaDK(f,.d,.k)#0D#0A}#0D#0A
#0D#0AAND.mcDK(op,.d,.k).BE#0D#0A//.add.and.cmp.lsh
.mv.rsh.or.sub.xor#0D#0A{.LET.mem.#3D.rootnode!rtn_
mc0#0D#0A..LET.f.#3D.0#0D#0A#0D#0A..db1wrf("//..2%s
.%n,$%n*n",.mcop2str(op),.d,.k)#0D#0A#0D#0A..SWITCH
ON.op.INTO#0D#0A..{.DEFAULT:..4mcbadop(op,."DK");.R
ETURN#0D#0A#0D#0A..2CASE.mc_add:..f.:#3D.ia_addl;.E
NDCASE.//.<addr.d>.+:#3D.k#0D#0A..2CASE.mc_addc:.f.
:#3D.ia_addcl;ENDCASE.//.<addr.d>.+:#3D.k.+.carry#0D
#0A..2CASE.mc_and:..f.:#3D.ia_andl;.ENDCASE.//.<add
r.d>.&:#3D.k#0D#0A..2CASE.mc_cmp:..f.:#3D.ia_cmpl;.
ENDCASE.//.condition.:#3D.<addr.d>.-.k#0D#0A..2CASE
.mc_lsh:..f.:#3D.ia_shll;.ENDCASE.//.<addr.d>.<<:#3D
.k#0D#0A..2CASE.mc_mv:..1f.:#3D.ia_movl;.ENDCASE.//
.<addr.d>.:#3D.k#0D#0A..2CASE.mc_mvb:..f.:#3D.ia_mo
vb;.ENDCASE.//.<addr.d>.:#3D.k.(byte)#0D#0A..2CASE.
mc_mvh:..f.:#3D.ia_movw;.ENDCASE.//.<addr.d>.:#3D.k
.(halfword)#0D#0A..2CASE.mc_or:..1f.:#3D.ia_orl;..E
NDCASE.//.<addr.d>.|:#3D.k#0D#0A..2CASE.mc_rsh:..f.
:#3D.ia_shrl;.ENDCASE.//.<addr.d>.>>:#3D.k#0D#0A..2
CASE.mc_sub:..f.:#3D.ia_subl;.ENDCASE.//.<addr.d>.-
:#3D.k#0D#0A..2CASE.mc_subc:.f.:#3D.ia_sbbl;.ENDCAS
E.//.<addr.d>.-:#3D.k.+.carry#0D#0A..2CASE.mc_xor:.
.f.:#3D.ia_xorl;.ENDCASE.//.<addr.d>.xor:#3D.k#0D#0A
..}#0D#0A..iaDK(f,.d,.k)#0D#0A}#0D#0A#0D#0AAND.mcDX
K(op,.d,.x,.k).BE#0D#0A//.add.and.cmp.lsh.mv.rsh.or
.sub.xor#0D#0A{.LET.xname.#3D.mcrname(x)#0D#0A..LET
.iax..#3D.mcr2iar(x)#0D#0A..LET.f.#3D.0#0D#0A#0D#0A
..db1wrf("//..2%s.%n(%s),$%n*n",.mcop2str(op),.d,.x
name,.k)#0D#0A#0D#0A..SWITCHON.op.INTO#0D#0A..{.DEF
AULT:..4mcbadop(op,."DXK");.RETURN#0D#0A#0D#0A..2CA
SE.mc_add:..f.:#3D.ia_addl;.ENDCASE.//.d(x).+:#3D.k
#0D#0A..2CASE.mc_addc:.f.:#3D.ia_addcl;ENDCASE.//.d
(x).+:#3D.k.+.carry#0D#0A..2CASE.mc_and:..f.:#3D.ia
_andl;.ENDCASE.//.d(x).&:#3D.k#0D#0A..2CASE.mc_cmp:
..f.:#3D.ia_cmpl;.ENDCASE.//.condition.:#3D.d(x).-.
k#0D#0A..2CASE.mc_lsh:..f.:#3D.ia_shll;.ENDCASE.//.
d(x).<<:#3D.k#0D#0A..2CASE.mc_mv:..1f.:#3D.ia_movl;
.ENDCASE.//.d(x).:#3D.k#0D#0A..2CASE.mc_mvb:..f.:#3D
.ia_movb;.ENDCASE.//.d(x).:#3D.k.(byte)#0D#0A..2CAS
E.mc_mvh:..f.:#3D.ia_movw;.ENDCASE.//.d(x).:#3D.k.(
halfword)#0D#0A..2CASE.mc_or:..1f.:#3D.ia_orl;..END
CASE.//.d(x).|:#3D.k#0D#0A..2CASE.mc_rsh:..f.:#3D.i
a_shrl;.ENDCASE.//.d(x).>>:#3D.k#0D#0A..2CASE.mc_su
b:..f.:#3D.ia_subl;.ENDCASE.//.d(x).-:#3D.k#0D#0A..
2CASE.mc_subc:.f.:#3D.ia_sbbl;.ENDCASE.//.d(x).-:#3D
.k.+.carry#0D#0A..2CASE.mc_xor:..f.:#3D.ia_xorl;.EN
DCASE.//.d(x).xor:#3D.k#0D#0A..}#0D#0A..iaDXK(f,.d,
.iax,.k)#0D#0A}#0D#0A#0D#0AAND.mcDXsK(op,.d,.x,.s,.
k).BE#0D#0A//.add.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A
{.LET.xname.#3D.mcrname(x)#0D#0A..LET.iax..#3D.mcr2
iar(x)#0D#0A..LET.f.#3D.0#0D#0A#0D#0A..db1wrf("//..
2%s.%n(%s**%n),$%n*n",.mcop2str(op),.d,.xname,.s,.k
)#0D#0A#0D#0A..SWITCHON.op.INTO#0D#0A..{.DEFAULT:..
4mcbadop(op,."DXsK");.RETURN#0D#0A#0D#0A..2CASE.mc_
add:..f.:#3D.ia_addl;.ENDCASE.//.d(,x,s).+:#3D.k#0D
#0A..2CASE.mc_addc:.f.:#3D.ia_addcl;ENDCASE.//.d(,x
,s).+:#3D.k.+.carry#0D#0A..2CASE.mc_and:..f.:#3D.ia
_andl;.ENDCASE.//.d(,x,s).&:#3D.k#0D#0A..2CASE.mc_c
mp:..f.:#3D.ia_cmpl;.ENDCASE.//.condition.:#3D.d(,x
,s).-.k#0D#0A..2CASE.mc_lsh:..f.:#3D.ia_shll;.ENDCA
SE.//.d(,x,s).<<:#3D.k#0D#0A..2CASE.mc_mv:..1f.:#3D
.ia_movl;.ENDCASE.//.d(,x,s).:#3D.k#0D#0A..2CASE.mc
_mvb:..f.:#3D.ia_movb;.ENDCASE.//.d(,x,s).:#3D.k.(b
yte)#0D#0A..2CASE.mc_mvh:..f.:#3D.ia_movw;.ENDCASE.
//.d(,x,s).:#3D.k.(halfword)#0D#0A..2CASE.mc_or:..1
f.:#3D.ia_orl;..ENDCASE.//.d(,x,s).|:#3D.k#0D#0A..2
CASE.mc_rsh:..f.:#3D.ia_shrl;.ENDCASE.//.d(,x,s).>>
:#3D.k#0D#0A..2CASE.mc_sub:..f.:#3D.ia_subl;.ENDCAS
E.//.d(,x,s).-:#3D.k#0D#0A..2CASE.mc_subc:.f.:#3D.i
a_sbbl;.ENDCASE.//.d(,x,s).-:#3D.k.+.carry#0D#0A..2
CASE.mc_xor:..f.:#3D.ia_xorl;.ENDCASE.//.d(,x,s).xo
r:#3D.k#0D#0A..}#0D#0A..iaDXsK(f,.d,.iax,.s,.k)#0D#0A
}#0D#0A#0D#0AAND.mcDXsBK(op,.d,.x,.s,.b,.k).BE#0D#0A
//.add.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A{.LET.xna
me.#3D.mcrname(x)#0D#0A..LET.bname.#3D.mcrname(b)#0D
#0A..LET.iax..1#3D.mcr2iar(x)#0D#0A..LET.iab..1#3D.
mcr2iar(b)#0D#0A..LET.f..#3D.0#0D#0A#0D#0A..db1wrf(
"//..2%s.%n(%s**%n+%s),$%n*n",.mcop2str(op),.d,.xna
me,.s,.bname,.k)#0D#0A#0D#0A..SWITCHON.op.INTO#0D#0A
..{.DEFAULT:..4mcbadop(op,."DXsBK");.RETURN#0D#0A#0D
#0A..2CASE.mc_add:..f.:#3D.ia_addl;.ENDCASE.//.d(x*
4+b).+:#3D.k#0D#0A..2CASE.mc_addc:.f.:#3D.ia_addcl;
ENDCASE.//.d(x*4+b).+:#3D.k.+.carry#0D#0A..2CASE.mc
_and:..f.:#3D.ia_andl;.ENDCASE.//.d(x*4+b).&:#3D.k#0D
#0A..2CASE.mc_cmp:..f.:#3D.ia_cmpl;.ENDCASE.//.cond
ition.:#3D.d(x*4+b).-.k#0D#0A..2CASE.mc_lsh:..f.:#3D
.ia_shll;.ENDCASE.//.d(x*4+b).<<:#3D.k#0D#0A..2CASE
.mc_mv:..1f.:#3D.ia_movl;.ENDCASE.//.d(x*4+b).:#3D.
k#0D#0A..2CASE.mc_mvb:..f.:#3D.ia_movb;.ENDCASE.//.
d(x*4+b).:#3D.k.(byte)#0D#0A..2CASE.mc_mvh:..f.:#3D
.ia_movw;.ENDCASE.//.d(x*4+b).:#3D.k.(halfword)#0D#0A
..2CASE.mc_or:..1f.:#3D.ia_orl;..ENDCASE.//.d(x*4+b
).|:#3D.k#0D#0A..2CASE.mc_rsh:..f.:#3D.ia_shrl;.END
CASE.//.d(x*4+b).>>:#3D.k#0D#0A..2CASE.mc_sub:..f.:
#3D.ia_subl;.ENDCASE.//.d(x*4+b).-:#3D.k#0D#0A..2CA
SE.mc_subc:.f.:#3D.ia_sbbl;.ENDCASE.//.d(x*4+b).-:#3D
.k.+.carry#0D#0A..2CASE.mc_xor:..f.:#3D.ia_xorl;.EN
DCASE.//.d(x*4+b).xor:#3D.k#0D#0A..}#0D#0A..iaDXsBK
(f,.d,.iax,.s,.iab,.k)#0D#0A}#0D#0A#0D#0AAND.mcKK(o
p,.fno,.args).BE#0D#0A{.//.call#0D#0A#0D#0A..db1wrf
("*n//..2%s.F%n.%n*n",.mcop2str(op),.fno,.args)#0D#0A
#0D#0A..SWITCHON.op.INTO#0D#0A..{.DEFAULT:..mcbadop
(op,."KK");..RETURN#0D#0A#0D#0A..2CASE.mc_call:#0D#0A
..4{.UNLESS.1<#3Dfno<#3Dmaxfno.DO#0D#0A..6{.writef(
"Error:.Bad.fno#3D%n.for.CALL*n",.fno)#0D#0A..8RETU
RN#0D#0A..6}#0D#0A#0D#0A..6iaFno(ia_call,.fno)#0D#0A
..6IF.args.DO.iaRK(ia_addl,.Esp,.4*args)#0D#0A..4}#0D
#0A..}#0D#0A}#0D#0A#0D#0AAND.mcKK1(op,.fno,.maxa,.m
axv).BE.SWITCHON.op.INTO#0D#0A//.entry..--.with.max
a.arguments.and.maxv.local.variables#0D#0A{.DEFAULT
:#0D#0A..4mcbadop(op,."KK1")#0D#0A..4RETURN#0D#0A#0D
#0A..CASE.mc_entry:.//.fno,.x#3Dnum.of.args,.y#3Dnu
m.of.locals#0D#0A..4db1wrf("*n//..2ENTRY.F%n.%n.%n*
n",.fno,.maxa,.maxv)#0D#0A#0D#0A..4IF.fno>maxfno.DO
#0D#0A..4{.writef("ENTRY.function.number.too.large*
n")#0D#0A..6RETURN#0D#0A..4}#0D#0A#0D#0A..4IF.fnv!f
no.DO#0D#0A..4{.writef("Function.F%n.defined.more.t
han.once.at.codep#3D%n*n",.fno,.codep)#0D#0Aabort(9
91)#0D#0A..6RETURN#0D#0A..4}#0D#0A#0D#0A..4currfno.
:#3D.fno.//.Set.current.function.indicator#2E#0D#0A
..4maxarg.:#3D.maxa#0D#0A..4maxvar.:#3D.maxv#0D#0A#0D
#0A..4//.On.entry.Esp.->.[<Ret.addr>,.<arg1>,#2E#2E
1,<arg.ma>]#0D#0A#0D#0A..4iaK(ia_alignc,.4)#0D#0A..
4iaK(ia_entry,.currfno)#0D#0A..4iaR(ia_pushl,.Ebp).
.11//.pushl.%ebp#0D#0A..4iaR(ia_pushl,.Ebx)..11//.p
ushl.%ebx#0D#0A..4iaR(ia_pushl,.Esi)..11//.pushl.%e
si#0D#0A..4iaR(ia_pushl,.Edi)..11//.pushl.%edi#0D#0A
..4iaRR(ia_movl,.Ebp,.Esp)..6//.movl..%esp,.%ebp#0D
#0A#0D#0A..4IF.maxvar.DO#0D#0A..6iaRK(ia_subl,.Esp,
.4*maxvar).//.subl.$4*maxvar,.%esp#0D#0A#0D#0A..4//
.Now.Esp.->.[V(maxv),V(maxv-1),#2E#2E1,V1,#0D#0A..4
//.and.Ebp.->..Edi',Esi',Ebx',Ebp',<ret.addr>,<arg1
>,#2E#2E1,<arg.maxa>#2E]#0D#0A#0D#0A..4//.Note:.<ar
g.i>.has.address.16+4*i(Ebp)#0D#0A..4//..and:.<var.
i>.has.address.-4-4*i(Ebp)#0D#0A..4RETURN#0D#0A}#0D
#0A#0D#0AAND.mcbadop(op,.str).BE#0D#0A{.LET.opstr.#3D
.mcop2str(op)#0D#0A..writef("Error:.mc%s(",.str)#0D
#0A..writef(opstr,.op)#0D#0A..writef(",#2E#2E).not.
available*n")#0D#0A}#0D#0A#0D#0AAND.mcop2str(op).#3D
.VALOF.SWITCHON.op.INTO#0D#0A{.DEFAULT:..8RESULTIS.
"UNKNOWN:%n"#0D#0A#0D#0A..CASE.mc_add:..4RESULTIS."
ADD"#0D#0A..CASE.mc_addc:..3RESULTIS."ADDC"#0D#0A..
CASE.mc_alignc:..1RESULTIS."ALIGNC"#0D#0A..CASE.mc_
alignd:..1RESULTIS."ALIGND"#0D#0A..CASE.mc_and:..4R
ESULTIS."AND"#0D#0A..CASE.mc_call:..3RESULTIS."CALL
"#0D#0A..CASE.mc_cdq:..4RESULTIS."CDQ"#0D#0A..CASE.
mc_cmp:..4RESULTIS."CMP"#0D#0A..CASE.mc_datab:..2RE
SULTIS."DATAB"#0D#0A..CASE.mc_datak:..2RESULTIS."DA
TAK"#0D#0A..CASE.mc_datal:..2RESULTIS."DATAL"#0D#0A
..CASE.mc_debug:..2RESULTIS."DEBUG"#0D#0A..CASE.mc_
dec:..4RESULTIS."DEC"#0D#0A..CASE.mc_div:..4RESULTI
S."DIV"#0D#0A..CASE.mc_dlab:..3RESULTIS."DLAB"#0D#0A
..CASE.mc_end:..4RESULTIS."END"#0D#0A..CASE.mc_endf
n:..2RESULTIS."ENDFN"#0D#0A..CASE.mc_entry:..2RESUL
TIS."ENTRY"#0D#0A..CASE.mc_inc:..4RESULTIS."INC"#0D
#0A..CASE.mc_jeq:..4RESULTIS."JEQ"#0D#0A..CASE.mc_j
ge:..4RESULTIS."JGE"#0D#0A..CASE.mc_jgt:..4RESULTIS
."JGT"#0D#0A..CASE.mc_jle:..4RESULTIS."JLE"#0D#0A..
CASE.mc_jlt:..4RESULTIS."JLT"#0D#0A..CASE.mc_jmp:..
4RESULTIS."JMP"#0D#0A..CASE.mc_jne:..4RESULTIS."JNE
"#0D#0A..CASE.mc_lab:..4RESULTIS."LAB"#0D#0A..CASE.
mc_lea:..4RESULTIS."LEA"#0D#0A..CASE.mc_lsh:..4RESU
LTIS."LSH"#0D#0A..CASE.mc_mul:..4RESULTIS."MUL"#0D#0A
..CASE.mc_mv:..5RESULTIS."MV"#0D#0A..CASE.mc_mvb:..
4RESULTIS."MVB"#0D#0A..CASE.mc_mvh:..4RESULTIS."MVH
"#0D#0A..CASE.mc_mvsxb:..2RESULTIS."MVSXB"#0D#0A..C
ASE.mc_mvzxb:..2RESULTIS."MVBZX"#0D#0A..CASE.mc_mvs
xh:..2RESULTIS."MVSXH"#0D#0A..CASE.mc_mvzxh:..2RESU
LTIS."MVZXH"#0D#0A..CASE.mc_neg:..4RESULTIS."NEG"#0D
#0A..CASE.mc_not:..4RESULTIS."NOT"#0D#0A..CASE.mc_o
r:..5RESULTIS."OR"#0D#0A..CASE.mc_pop:..4RESULTIS."
POP"#0D#0A..CASE.mc_push:..3RESULTIS."PUSH"#0D#0A..
CASE.mc_rsh:..4RESULTIS."RSH"#0D#0A..CASE.mc_rtn:..
4RESULTIS."RTN"#0D#0A..CASE.mc_seq:..4RESULTIS."SEQ
"#0D#0A..CASE.mc_sge:..4RESULTIS."SGE"#0D#0A..CASE.
mc_sgt:..4RESULTIS."SGT"#0D#0A..CASE.mc_sle:..4RESU
LTIS."SLE"#0D#0A..CASE.mc_slt:..4RESULTIS."SLT"#0D#0A
..CASE.mc_sne:..4RESULTIS."SNE"#0D#0A..CASE.mc_sub:
..4RESULTIS."SUB"#0D#0A..CASE.mc_subc:..3RESULTIS."
SUBC"#0D#0A..CASE.mc_udiv:..3RESULTIS."UDIV"#0D#0A.
.CASE.mc_ujge:..3RESULTIS."UJGE"#0D#0A..CASE.mc_ujg
t:..3RESULTIS."UJGT"#0D#0A..CASE.mc_ujle:..3RESULTI
S."UJLE"#0D#0A..CASE.mc_ujlt:..3RESULTIS."UJLT"#0D#0A
..CASE.mc_umul:..3RESULTIS."UMUL"#0D#0A..CASE.mc_us
ge:..3RESULTIS."USGE"#0D#0A..CASE.mc_usgt:..3RESULT
IS."USGT"#0D#0A..CASE.mc_usle:..3RESULTIS."USLE"#0D
#0A..CASE.mc_uslt:..3RESULTIS."USLT"#0D#0A..CASE.mc
_xchg:..3RESULTIS."XCHG"#0D#0A..CASE.mc_xor:..4RESU
LTIS."XOR"#0D#0A}#0D#0A#0D#0AAND.mcrname(r).#3D.VAL
OF.SWITCHON.r.INTO#0D#0A{.#0D#0A..DEFAULT:..1writef
("mcname(%n):.Bad.MC.register*n",.r)#0D#0A..11RESUL
TIS."?"#0D#0A..CASE.mc_a:.RESULTIS."A"#0D#0A..CASE.
mc_b:.RESULTIS."B"#0D#0A..CASE.mc_c:.RESULTIS."C"#0D
#0A..CASE.mc_d:.RESULTIS."D"#0D#0A..CASE.mc_e:.RESU
LTIS."E"#0D#0A..CASE.mc_f:.RESULTIS."F"#0D#0A}#0D#0A
#0D#0A#0D#0A//.**12.i386.instruction.assembly.funct
ions.**10#0D#0A#0D#0A//.The.order.of.the.operands.o
f.ia.functions.are.the.same.as.those#0D#0A//.in.the
.GNU.i386.assembly.language#2E.Ie.assignments.are.t
ypically#0D#0A//.from.left.to.right#2E#0D#0A#0D#0AA
ND.iaF(op).BE#0D#0A//.cdq.end.endfn.nop.popal.popfl
.pushal.pushfl.ret#0D#0A{.LET.f.#3D.0#0D#0A#0D#0A..
db2wrf("..6%s*n",.iaop2str(op))#0D#0A#0D#0A..SWITCH
ON.op.INTO#0D#0A..{.DEFAULT:..iabadop(op,."F");.RET
URN#0D#0A#0D#0A..2CASE.ia_cdq:..2f.:#3D.#23x99;.END
CASE..5//.cdq#0D#0A#0D#0A..2CASE.ia_end:..24//.end#0D
#0A..4//.Check.for.no.remaining.label.or.function.f
orward.refs#0D#0A..4FOR.n.#3D.1.TO.maxfno.IF.frefv!
n.DO#0D#0A..6writef("Function.%n.not.defined*n",.n)
#0D#0A..4//.Fall.into.endfn.to.check.the.local.labe
ls#0D#0A#0D#0A..2CASE.ia_endfn:..22//.endfn#0D#0A..
4//.Check.for.no.remaining.label.forward.refs#0D#0A
..4FOR.n.#3D.1.TO.labvupb.DO#0D#0A..4{.LET.val.#3D.
labv!n#0D#0A..6TEST.val#0D#0A..6THEN.IF.codeb<val<c
odet.DO.labv!n.:#3D.0.//.Unset.local.label#0D#0A..6
ELSE.IF.refv!n.DO.writef("Label.L%n.note.set*n",.n)
#0D#0A..4}#0D#0A..4currfno.:#3D.0#0D#0A..4IF.op#3Di
a_end.DO#0D#0A..4{.//.IF.end.directive,.free.all.te
mporary.workspace#0D#0A..6LET.p.#3D.blocklist#0D#0A
..6blocklist.:#3D.0#0D#0A#0D#0A..6WHILE.p.DO#0D#0A.
.6{.LET.next.#3D.!p#0D#0A..8freevec(p)#0D#0A..8p.:#3D
.next#0D#0A..6}#0D#0A..6IF.labv..DO.{.freevec(labv)
;..labv..:#3D.0.}#0D#0A..6IF.refv..DO.{.freevec(ref
v);..refv..:#3D.0.}#0D#0A..6IF.frefv.DO.{.freevec(f
refv);.frefv.:#3D.0.}#0D#0A..4}#0D#0A..4RETURN#0D#0A
#0D#0A..2CASE.ia_nop:..2f.:#3D.#23x90;.ENDCASE..5//
.nop#0D#0A..2CASE.ia_popal:..f.:#3D.#23x61;.ENDCASE
..5//.ret#0D#0A..2CASE.ia_popfl:..f.:#3D.#23x9D;.EN
DCASE..5//.ret#0D#0A..2CASE.ia_pushal:.f.:#3D.#23x6
0;.ENDCASE..5//.ret#0D#0A..2CASE.ia_pushfl:.f.:#3D.
#23x9C;.ENDCASE..5//.ret#0D#0A..2CASE.ia_ret:..2f.:
#3D.#23xC3;.ENDCASE..5//.ret#0D#0A..}#0D#0A..ia_f(f
)#0D#0A}#0D#0A#0D#0AAND.iaK(op,.k).BE#0D#0A//.align
c.alignd.datab.datak.push.ret#0D#0A{.db2wrf("..6%s.
$%n*n",.iaop2str(op),.k)#0D#0A//writef("iaK:.op#3D%
n.(%s).k#3D%n*n",.op,.iaop2str(op),.k)#0D#0A..SWITC
HON.op.INTO#0D#0A..{.DEFAULT:..iabadop(op,."K");..2
RETURN#0D#0A#0D#0A..2CASE.ia_alignc:..22//.alignc.k
#0D#0A..12UNLESS.codep.MOD.k.#3D.0.DO#0D#0A..12{.db
3codep()#0D#0A..14UNTIL.codep.MOD.k.#3D.0.DO.iaC1(#23
x90).//.nop#0D#0A..14db3nl()#0D#0A..12}#0D#0A..12RE
TURN#0D#0A#0D#0A..2CASE.ia_alignd:..22//.alignd.k#0D
#0A..12UNLESS.datap.MOD.k.#3D.0.DO#0D#0A..12{.db3da
tap()#0D#0A..14UNTIL.datap.MOD.k.#3D.0.DO.iaD1(#23x
00)#0D#0A..14db3nl()#0D#0A..12}#0D#0A..12RETURN#0D#0A
#0D#0A..2CASE.ia_datab:..22//.datab.k#0D#0A..12db3d
atap()#0D#0A..12iaD1(k)#0D#0A..12db3nl()#0D#0A..12R
ETURN#0D#0A#0D#0A..2CASE.ia_datak:..22//.datab.k#0D
#0A..12db3datap()#0D#0A..12iaD4(k)#0D#0A..12db3nl()
#0D#0A..12RETURN#0D#0A#0D#0A..2CASE.ia_entry:..22//
.entry.fno#0D#0A..10{.LET.fno.#3D.k#0D#0A..12db3cod
ep()#0D#0A..12db3wrf("F%n:*n",.fno)#0D#0A//writef("
F%n#3D%n*n",.fno,.codep)#0D#0A..12fnv!fno.:#3D.code
p#0D#0A..12setrefs(frefv!fno,.codep).//.Deal.with.r
efs.to.this.function#0D#0A..12frefv!fno.:#3D.0#0D#0A
..12RETURN#0D#0A..10}#0D#0A#0D#0A..2CASE.ia_pushl:.
.22//.pushl.$k#0D#0A..12db3codep()#0D#0A..12iaC1(#23
x68);.iaC4(k)#0D#0A..12db3nl()#0D#0A..12RETURN#0D#0A
#0D#0A..2CASE.ia_ret:..24//.ret.$k#0D#0A..12db3code
p()#0D#0A..12iaC1(#23xC2);.iaC2(k)#0D#0A..12db3nl()
#0D#0A..12RETURN#0D#0A#0D#0A..}#0D#0A}#0D#0A#0D#0AA
ND.iaR(op,.r).BE#0D#0A//.call.decl.divl.idivl.imull
.incl.mull.negl.notl.popl.pushl#0D#0A//.seta.setae.
setb.setbe.sete.setg.setge.setl.setle.setne#0D#0A{.
LET.rname.#3D.iarname(r)#0D#0A..LET.iaf,.f,.n.#3D.0
,.0,.0#0D#0A#0D#0A..db2wrf("..6%s..%s*n",.iaop2str(
op),.rname)#0D#0A#0D#0A..SWITCHON.op.INTO#0D#0A..{.
DEFAULT:#0D#0A..4iabadop(op,."R")#0D#0A..4RETURN#0D
#0A#0D#0A..2//.iaR(ia_call,#2E#2E).is.not.used#0D#0A
..2CASE.ia_call:.iaf,.f,.n.:#3D.ia_fnr,.#23xFF,.2;.
ENDCASE.//.call.r#0D#0A#0D#0A..2CASE.ia_decl:.iaf,.
f..2:#3D.ia_f,..1#23x48+r;..ENDCASE.//.decl.r#0D#0A
..2CASE.ia_divl:.iaf,.f,.n.:#3D.ia_fnr,.#23xF7,.6;.
ENDCASE.//.divl.r#0D#0A..2CASE.ia_idivl:iaf,.f,.n.:
#3D.ia_fnr,.#23xF7,.7;.ENDCASE.//.idivl.r#0D#0A..2C
ASE.ia_imull:iaf,.f,.n.:#3D.ia_fnr,.#23xF7,.5;.ENDC
ASE.//.imull.r#0D#0A..2CASE.ia_incl:.iaf,.f..2:#3D.
ia_f,..1#23x40+r;..ENDCASE.//.incl.r#0D#0A..2CASE.i
a_mull:.iaf,.f,.n.:#3D.ia_fnr,.#23xF7,.4;.ENDCASE./
/.mull.r#0D#0A..2CASE.ia_negl:.iaf,.f,.n.:#3D.ia_fn
r,.#23xF7,.3;.ENDCASE.//.negl.r#0D#0A..2CASE.ia_not
l:.iaf,.f,.n.:#3D.ia_fnr,.#23xF7,.2;.ENDCASE.//.not
l.r#0D#0A..2CASE.ia_popl:.iaf,.f..2:#3D.ia_f,..1#23
x58+r;..ENDCASE.//.popl.r#0D#0A..2CASE.ia_pushl:iaf
,.f..2:#3D.ia_f,..1#23x50+r;..ENDCASE.//.pushl.r#0D
#0A#0D#0A..2CASE.ia_sete:.iaf,.f..2:#3D.ia_fnr,.#23
x0F94;..ENDCASE.//.sete.r#0D#0A..2CASE.ia_setne:iaf
,.f..2:#3D.ia_fnr,.#23x0F95;..ENDCASE.//.setne.r#0D
#0A..2CASE.ia_setl:.iaf,.f..2:#3D.ia_fnr,.#23x0F9C;
..ENDCASE.//.setl.r#0D#0A..2CASE.ia_setle:iaf,.f..2
:#3D.ia_fnr,.#23x0F9E;..ENDCASE.//.setle.r#0D#0A..2
CASE.ia_setg:.iaf,.f..2:#3D.ia_fnr,.#23x0F9F;..ENDC
ASE.//.setg.r#0D#0A..2CASE.ia_setge:iaf,.f..2:#3D.i
a_fnr,.#23x0F9D;..ENDCASE.//.setge.r#0D#0A..2CASE.i
a_seta:.iaf,.f..2:#3D.ia_fnr,.#23x0F97;..ENDCASE.//
.seta.r#0D#0A..2CASE.ia_setae:iaf,.f..2:#3D.ia_fnr,
.#23x0F93;..ENDCASE.//.setae.r#0D#0A..2CASE.ia_setb
:.iaf,.f..2:#3D.ia_fnr,.#23x0F92;..ENDCASE.//.setb.
r#0D#0A..2CASE.ia_setbe:iaf,.f..2:#3D.ia_fnr,.#23x0
F96;..ENDCASE.//.setbe.r#0D#0A..}#0D#0A..iaf(f,.n,.
r)#0D#0A}#0D#0A#0D#0AAND.iaL(op,.n).BE#0D#0A//.data
l.dlab.div.idiv.imul.lab.mul.negl.notl.popl.pushl#0D
#0A{#0D#0A..db2wrf("..6%s.L%n*n",.iaop2str(op),.n)#0D
#0A#0D#0A..SWITCHON.op.INTO#0D#0A..{.//.op.with.ope
rand.Ln.using.32-bit.relative.address#2E#0D#0A#0D#0A
..2DEFAULT:#0D#0A..4iabadop(op,."L")#0D#0A..4RETURN
#0D#0A#0D#0A..2CASE.ia_datal:#0D#0A..2{.//.Allocate
.a.data.word.containing.the.value.of.label.Ln#0D#0A
..4LET.mem.#3D.rootnode!rtn_mc0#0D#0A..4LET.val.#3D
.labv!n#0D#0A..4db3datap()#0D#0A..4TEST.val#0D#0A..
4THEN.iaD4(mem.+.4*mc.+.val)#0D#0A..4ELSE.{.iaD4(me
m.+.4*mc)#0D#0A..11refv!n.:#3D.mk2(refv!n,.datap)#0D
#0A..9}#0D#0A..4db3nl()#0D#0A..4RETURN#0D#0A..2}#0D
#0A#0D#0A..2CASE.ia_dlab:#0D#0A..2{.//.Set.a.Ln.to.
the.current.data.location#0D#0A#0D#0A..4//.Check.if
.label.limit.reached#2E#2E#0D#0A#0D#0A..4//.Create.
a.new.label.and.store.details.in.label.vector#2E#0D
#0A#0D#0A..4IF.labv!n.DO.{.//.Check.name.is.not.alr
eady.used#2E#0D#0A..6writef("Attempted.to.duplicate
.a.label.L%n",.n)#0D#0A..6RETURN#0D#0A..4}#0D#0A#0D
#0A..4db3datap()#0D#0A..4db3wrf("L%n:",.n)#0D#0A..4
labv!n.:#3D.datap#0D#0A..4db3nl()#0D#0A..4//.Resolv
e.any.outstanding.refs.to.this.label#0D#0A..4setref
s(refv!n,.datap)#0D#0A..4refv!n.:#3D.0#0D#0A..4RETU
RN#0D#0A..2}#0D#0A#0D#0A..2CASE.ia_lab:.//.Set.a.Ln
.to.the.current.code.location#0D#0A..2{.//.Check.th
at.the.label.is.declared#2E#0D#0A..4UNLESS.0<.n.<#3D
.labvupb.DO#0D#0A..4{.writef("Error:.Label.number.o
ut.of.range:.L%n*n",.n)#0D#0A..6RETURN#0D#0A..4}#0D
#0A#0D#0A..4IF.labv!n.DO.//.Check.that.the.label.is
.not.already.set#2E#0D#0A..4{.writef("Error:.Label.
L%n.is.already.set.to.%n*n",.n,.labv!n)#0D#0A..6RET
URN#0D#0A..4}#0D#0A#0D#0A//writef("iaL:.ia_lab.L%n.
#3D.%n.refv!n#3D%n*n",.n,.labv!n,.refv!n)#0D#0A..4d
b3codep()#0D#0A..4db3wrf("L%n:*n",.n)#0D#0A..4labv!
n.:#3D.codep#0D#0A..4//.resolve.any.outstanding.ref
s.to.this.label#0D#0A..4setrefs(refv!n,.codep)#0D#0A
..4refv!n.:#3D.0#0D#0A..4RETURN#0D#0A..2}#0D#0A#0D#0A
..2CASE.ia_mull:.//.unsigned.multiply.by.static.Ln#0D
#0A..2{.//.Check.that.the.label.is.declared#2E#0D#0A
..4UNLESS.0<.n.<#3D.labvupb.DO#0D#0A..4{.writef("Er
ror:.Label.number.out.of.range:.L%n*n",.n)#0D#0A..6
RETURN#0D#0A..4}#0D#0A#0D#0A..4UNLESS.labv!n.DO.//.
Check.that.static.Ln.is.declared#2E#0D#0A..4{.write
f("Error:.Static.L%n.is.not.declared*n",.n)#0D#0A..
6RETURN#0D#0A..4}#0D#0A#0D#0A..4ia_fnd(#23xF7,.4,.r
ootnode!rtn_mc0+4*mc+labv!n)#0D#0A..4RETURN#0D#0A..
2}#0D#0A#0D#0A..2CASE.ia_negl:.//.Negate.static.Ln#0D
#0A..2{.//.Check.that.the.label.is.declared#2E#0D#0A
..4UNLESS.0<.n.<#3D.labvupb.DO#0D#0A..4{.writef("Er
ror:.Label.number.out.of.range:.L%n*n",.n)#0D#0A..6
RETURN#0D#0A..4}#0D#0A#0D#0A..4UNLESS.labv!n.DO.//.
Check.that.static.Ln.is.declared#2E#0D#0A..4{.write
f("Error:.Static.L%n.is.not.declared*n",.n)#0D#0A..
6RETURN#0D#0A..4}#0D#0A#0D#0A..4ia_fnd(#23xF7,.3,.r
ootnode!rtn_mc0+4*mc+labv!n)#0D#0A..4RETURN#0D#0A..
2}#0D#0A#0D#0A..2CASE.ia_notl:.//.Complement.static
.Ln#0D#0A..2{.//.Check.that.the.label.is.declared#2E
#0D#0A..4UNLESS.0<.n.<#3D.labvupb.DO#0D#0A..4{.writ
ef("Error:.Label.number.out.of.range:.L%n*n",.n)#0D
#0A..6RETURN#0D#0A..4}#0D#0A#0D#0A..4UNLESS.labv!n.
DO.//.Check.that.static.Ln.is.declared#2E#0D#0A..4{
.writef("Error:.Static.L%n.is.not.declared*n",.n)#0D
#0A..6RETURN#0D#0A..4}#0D#0A#0D#0A//writef("iaL:.ia
_lab.L%n.#3D.%n.refv!n#3D%n*n",.n,.labv!n,.refv!n)#0D
#0A..4ia_fnd(#23xF7,.2,.rootnode!rtn_mc0+4*mc+labv!
n)#0D#0A..4RETURN#0D#0A..2}#0D#0A#0D#0A..2CASE.ia_p
opl:.//.Pop.the.top.of.stack.into.static.Ln#0D#0A..
2{.//.Check.that.the.label.is.declared#2E#0D#0A..4U
NLESS.0<.n.<#3D.labvupb.DO#0D#0A..4{.writef("Error:
.Label.number.out.of.range:.L%n*n",.n)#0D#0A..6RETU
RN#0D#0A..4}#0D#0A#0D#0A..4UNLESS.labv!n.DO.//.Chec
k.that.static.Ln.is.declared#2E#0D#0A..4{.writef("E
rror:.Static.L%n.is.not.declared*n",.n)#0D#0A..6RET
URN#0D#0A..4}#0D#0A#0D#0A//writef("iaL:.ia_lab.L%n.
#3D.%n.refv!n#3D%n*n",.n,.labv!n,.refv!n)#0D#0A..4i
a_fnd(#23x8F,.0,.rootnode!rtn_mc0+4*mc+labv!n)#0D#0A
..4RETURN#0D#0A..2}#0D#0A#0D#0A..2CASE.ia_pushl:.//
.Push.static.Ln.onto.the.stack#0D#0A..2{.//.Check.t
hat.the.label.is.declared#2E#0D#0A..4UNLESS.0<.n.<#3D
.labvupb.DO#0D#0A..4{.writef("Error:.Label.number.o
ut.of.range:.L%n*n",.n)#0D#0A..6RETURN#0D#0A..4}#0D
#0A#0D#0A..4UNLESS.labv!n.DO.//.Check.that.static.L
n.is.declared#2E#0D#0A..4{.writef("Error:.Static.L%
n.is.not.declared*n",.n)#0D#0A..6RETURN#0D#0A..4}#0D
#0A#0D#0A//writef("iaL:.ia_lab.L%n.#3D.%n.refv!n#3D
%n*n",.n,.labv!n,.refv!n)#0D#0A..4ia_fnd(#23xFF,.6,
.rootnode!rtn_mc0+4*mc+labv!n)#0D#0A..4RETURN#0D#0A
..2}#0D#0A..}#0D#0A}#0D#0A#0D#0AAND.iaFno(op,.fno).
BE#0D#0A{.//.call#0D#0A#0D#0A..db2wrf("..6%s..F%n*n
",.iaop2str(op),.fno)#0D#0A#0D#0A..SWITCHON.op.INTO
#0D#0A..{.DEFAULT:..4iabadop(op,."Fno");..RETURN#0D
#0A#0D#0A..2CASE.ia_call:.ia_fno(#23xE8,.fno)#0D#0A
..16RETURN#0D#0A..}#0D#0A}#0D#0A#0D#0AAND.iaD(op,.d
).BE#0D#0A{.//.decl.incl.negl.notl.popl.pushl.shll.
shrl#0D#0A..LET.f,.n.#3D.0,.0#0D#0A#0D#0A..db2wrf("
..6%s..%n*n",.iaop2str(op),.d)#0D#0A#0D#0A..SWITCHO
N.op.INTO#0D#0A..{.DEFAULT:#0D#0A..4iabadop(op,."D"
)#0D#0A..4RETURN#0D#0A#0D#0A..2//.iaD(ia_call,#2E#2E
).is.only.used.by.mcPRF#0D#0A..2CASE.ia_call:..ia_f
d(..#23xE8,.d);.RETURN..//.call.d#0D#0A#0D#0A..2CAS
E.ia_decl:..f,.n.:#3D.#23xFF,.1;..ENDCASE.//.decl.d
#0D#0A..2CASE.ia_divl:..f,.n.:#3D.#23xF7,.6;..ENDCA
SE.//.divl.d#0D#0A..2CASE.ia_idivl:.f,.n.:#3D.#23xF
7,.7;..ENDCASE.//.idivl.d#0D#0A..2CASE.ia_imull:.f,
.n.:#3D.#23xF7,.5;..ENDCASE.//.imull.d#0D#0A..2CASE
.ia_incl:..f,.n.:#3D.#23xFF,.0;..ENDCASE.//.incl.d#0D
#0A..2CASE.ia_mull:..f,.n.:#3D.#23xF7,.4;..ENDCASE.
//.mull.d#0D#0A..2CASE.ia_negl:..f,.n.:#3D.#23xF7,.
3;..ENDCASE.//.negl.d#0D#0A..2CASE.ia_notl:..f,.n.:
#3D.#23xF7,.2;..ENDCASE.//.notl.d#0D#0A..2CASE.ia_p
opl:..f,.n.:#3D.#23x8F,.0;..ENDCASE.//.popl.d#0D#0A
..2CASE.ia_pushl:.f,.n.:#3D.#23xFF,.6;..ENDCASE.//.
pushl.d#0D#0A..2CASE.ia_shll:..f,.n.:#3D.#23xD3,.4;
..ENDCASE.//.shll.d,%cl#0D#0A..2CASE.ia_shrl:..f,.n
.:#3D.#23xD3,.5;..ENDCASE.//.shrl.d,%cl#0D#0A..}#0D
#0A..ia_fnd(f,.n,.d)#0D#0A}#0D#0A#0D#0AAND.iaDX(op,
.d,.x).BE#0D#0A//.call.decl.divl.idivl.imull.incl.m
ull.negl.notl.popl.pushl.shll.shrl#0D#0A{.LET.xname
.#3D.iarname(x)#0D#0A..LET.f,.n.#3D.0,.0#0D#0A#0D#0A
..db2wrf("..6%s..%n(%s)*n",.iaop2str(op),.d,.xname)
#0D#0A#0D#0A..SWITCHON.op.INTO#0D#0A..{.DEFAULT:.ia
badop(op,."DX");.RETURN#0D#0A#0D#0A..2//.iaDX(ia_ca
ll,#2E#2E).is.not.used#0D#0A..2CASE.ia_call:.f,.n.:
#3D.#23xFF,.2;.ENDCASE.//.call.d(x)#0D#0A#0D#0A..2C
ASE.ia_decl:..f,.n.:#3D.#23xFF,.1;.ENDCASE.//.decl.
d(x)#0D#0A..2CASE.ia_divl:..f,.n.:#3D.#23xF7,.6;.EN
DCASE.//.divl.d(x)#0D#0A..2CASE.ia_idivl:.f,.n.:#3D
.#23xF7,.7;.ENDCASE.//.idivl.d(x)#0D#0A..2CASE.ia_i
mull:.f,.n.:#3D.#23xF7,.5;.ENDCASE.//.idivl.d(x)#0D
#0A..2CASE.ia_incl:..f,.n.:#3D.#23xFF,.0;.ENDCASE./
/.incl.d(x)#0D#0A..2CASE.ia_mull:..f,.n.:#3D.#23xF7
,.4;.ENDCASE.//.mull.d(x)#0D#0A..2CASE.ia_negl:..f,
.n.:#3D.#23xF7,.3;.ENDCASE.//.negl.d(x)#0D#0A..2CAS
E.ia_notl:..f,.n.:#3D.#23xF7,.2;.ENDCASE.//.notl.d(
x)#0D#0A..2CASE.ia_popl:..f,.n.:#3D.#23x8F,.0;.ENDC
ASE.//.popl.d(x)#0D#0A..2CASE.ia_pushl:.f,.n.:#3D.#23
xFF,.6;.ENDCASE.//.pushl.d(x)#0D#0A..2CASE.ia_shll:
..f,.n.:#3D.#23xD3,.4;.ENDCASE.//.shll.d(x),%cl#0D#0A
..2CASE.ia_shrl:..f,.n.:#3D.#23xD3,.5;.ENDCASE.//.s
hrl.d(x),%cl#0D#0A..}#0D#0A..ia_fndx(f,.n,.d,.x)#0D
#0A}#0D#0A#0D#0AAND.iaDXs(op,.d,.x,.s).BE#0D#0A{.LE
T.xname.#3D.iarname(x)#0D#0A..LET.f,.n.#3D.0,.0#0D#0A
#0D#0A..db2wrf("..6%s..%n(%s**%n)*n",.iaop2str(op),
.d,.xname,.s)#0D#0A#0D#0A..SWITCHON.op.INTO#0D#0A..
{.DEFAULT:#0D#0A..4iabadop(op,."DXs")#0D#0A..4RETUR
N#0D#0A#0D#0A..2//.iaDXs(ia_call,#2E#2E).is.not.use
d#0D#0A..2CASE.ia_call:..f,.n.:#3D.#23xFF,.2;.ENDCA
SE.//.call.d(,x,s)#0D#0A#0D#0A..2CASE.ia_decl:..f,.
n.:#3D.#23xFF,.1;.ENDCASE.//.decl.d(,x,s)#0D#0A..2C
ASE.ia_divl:..f,.n.:#3D.#23xF7,.6;.ENDCASE.//.divl.
d(,x,s)#0D#0A..2CASE.ia_idivl:.f,.n.:#3D.#23xF7,.7;
.ENDCASE.//.idivl.d(,x,s)#0D#0A..2CASE.ia_imull:.f,
.n.:#3D.#23xF7,.5;.ENDCASE.//.idivl.d(,x,s)#0D#0A..
2CASE.ia_incl:..f,.n.:#3D.#23xFF,.0;.ENDCASE.//.inc
l.d(,x,s)#0D#0A..2CASE.ia_mull:..f,.n.:#3D.#23xF7,.
4;.ENDCASE.//.mull.d(,x,s)#0D#0A..2CASE.ia_negl:..f
,.n.:#3D.#23xF7,.3;.ENDCASE.//.negl.d(,x,s)#0D#0A..
2CASE.ia_notl:..f,.n.:#3D.#23xF7,.2;.ENDCASE.//.not
l.d(,x,s)#0D#0A..2CASE.ia_popl:..f,.n.:#3D.#23x8F,.
0;.ENDCASE.//.popl.d(,x,s)#0D#0A..2CASE.ia_pushl:.f
,.n.:#3D.#23xFF,.6;.ENDCASE.//.pushl.d(,x,s)#0D#0A.
.2CASE.ia_shll:..f,.n.:#3D.#23xD3,.4;.ENDCASE.//.sh
ll.d(,x,s),%cl#0D#0A..2CASE.ia_shrl:..f,.n.:#3D.#23
xD3,.5;.ENDCASE.//.shrl.d(,x,s),%cl#0D#0A..}#0D#0A.
.ia_fndxs(f,.n,.d,.x,.s)#0D#0A}#0D#0A#0D#0AAND.iaDX
sB(op,.d,.x,.s,.b).BE#0D#0A{.LET.xname.#3D.iarname(
x)#0D#0A..LET.bname.#3D.iarname(b)#0D#0A..LET.f,.n.
#3D.0,.0#0D#0A#0D#0A..db2wrf("..6%s..%n(%s,.%s,.%n)
*n",.iaop2str(op),.d,.bname,.xname,.s)#0D#0A#0D#0A.
.SWITCHON.op.INTO#0D#0A..{.DEFAULT:#0D#0A..4iabadop
(op,."DXsB")#0D#0A..4RETURN#0D#0A#0D#0A..2//.iaDXsB
(ia_call,#2E#2E).is.not.used#0D#0A..2CASE.ia_call:.
.f,.n.:#3D.#23xFF,.2;.ENDCASE.//.call.d(b,x,s)#0D#0A
#0D#0A..2CASE.ia_decl:..f,.n.:#3D.#23xFF,.1;.ENDCAS
E.//.decl.d(b,x,s)#0D#0A..2CASE.ia_divl:..f,.n.:#3D
.#23xF7,.6;.ENDCASE.//.divl.d(b,x,s)#0D#0A..2CASE.i
a_idivl:.f,.n.:#3D.#23xF7,.7;.ENDCASE.//.idivl.d(b,
x,s)#0D#0A..2CASE.ia_imull:.f,.n.:#3D.#23xF7,.5;.EN
DCASE.//.idivl.d(b,x,s)#0D#0A..2CASE.ia_incl:..f,.n
.:#3D.#23xFF,.0;.ENDCASE.//.incl.d(b,x,s)#0D#0A..2C
ASE.ia_mull:..f,.n.:#3D.#23xF7,.4;.ENDCASE.//.mull.
d(b,x,s)#0D#0A..2CASE.ia_negl:..f,.n.:#3D.#23xF7,.3
;.ENDCASE.//.negl.d(b,x,s)#0D#0A..2CASE.ia_notl:..f
,.n.:#3D.#23xF7,.2;.ENDCASE.//.notl.d(b,x,s)#0D#0A.
.2CASE.ia_popl:..f,.n.:#3D.#23x8F,.0;.ENDCASE.//.po
pl.d(b,x,s)#0D#0A..2CASE.ia_pushl:.f,.n.:#3D.#23xFF
,.6;.ENDCASE.//.pushl.d(b,x,s)#0D#0A..2CASE.ia_shll
:..f,.n.:#3D.#23xD3,.4;.ENDCASE.//.shll.d(b,x,s),%c
l#0D#0A..2CASE.ia_shrl:..f,.n.:#3D.#23xD3,.5;.ENDCA
SE.//.shrl.d(b,x,s),%cl#0D#0A..}#0D#0A..ia_fndxsb(f
,.n,.d,.x,.s,.b)#0D#0A}#0D#0A#0D#0AAND.iaRR(op,.r,.
t).BE.//.r.is.destination#0D#0A//.addl.addcl.andl.m
ovl.movsbl.movzbl.orl.sbbl.shll.shrl.subl.xorl.#0D#0A
{.LET.rname.#3D.iarname(r)#0D#0A..LET.tname.#3D.iar
name(t)#0D#0A..LET.f.#3D.0#0D#0A#0D#0A..db2wrf("..6
%s..%s,.%s*n",.iaop2str(op),.tname,.rname)#0D#0A#0D
#0A..SWITCHON.op.INTO#0D#0A..{.DEFAULT:..4iabadop(o
p,."RR");.RETURN#0D#0A#0D#0A..2CASE.ia_addl:.f.:#3D
.#23x01;.ENDCASE..8//.addl.t,r#0D#0A..2CASE.ia_addc
l:f.:#3D.#23x11;.ENDCASE..8//.addcl.t,r#0D#0A..2CAS
E.ia_andl:.f.:#3D.#23x21;.ENDCASE..8//.andl.t,r#0D#0A
..2CASE.ia_movl:.UNLESS.r#3Dt.DO#0D#0A..18ia_fnr(#23
x89,.t,.r)..6//.movl.t,r#0D#0A..16RETURN#0D#0A#0D#0A
..2CASE.ia_movsbl:.ia_fnr(#23x0FBE,r,t);.RETURN.//.
movsbl.t,r#0D#0A..2CASE.ia_movswl:.ia_fnr(#23x0FBF,
r,t);.RETURN.//.movswl.t,r#0D#0A..2CASE.ia_movzbl:.
ia_fnr(#23x0FB6,r,t);.RETURN.//.movzbl.t,r#0D#0A..2
CASE.ia_movzwl:.ia_fnr(#23x0FB7,r,t);.RETURN.//.mov
zbl.t,r#0D#0A#0D#0A..2CASE.ia_orl:..2f.:#3D.#23x09;
.ENDCASE..6//.orl.t,r#0D#0A..2CASE.ia_shll:..1UNLES
S.t#3DEcx.DO#0D#0A..18{.writef("Shift.amount.must.b
e.in.C*n")#0D#0A..20RETURN#0D#0A..18}#0D#0A..18f.:#3D
.#23xD3;.t:#3D4;.ENDCASE..//.shll.t,%cl#0D#0A..2CAS
E.ia_shrl:..1UNLESS.t#3DEcx.DO#0D#0A..18{.writef("S
hift.amount.must.be.in.C*n")#0D#0A..20RETURN#0D#0A.
.18}#0D#0A..18f.:#3D.#23xD3;.t:#3D7;.ENDCASE..//.sh
ll.t,%cl#0D#0A..2CASE.ia_sbbl:..1f.:#3D.#23x19;.END
CASE..6//.sbbl.t,r#0D#0A..2CASE.ia_subl:..1f.:#3D.#23
x29;.ENDCASE..6//.subl.t,r#0D#0A..2CASE.ia_xchgl:..
IF.r#3DEax.DO.{.ia_f(#23x90+t);.RETURN.}#0D#0A..18I
F.t#3DEax.DO.{.ia_f(#23x90+r);.RETURN.}#0D#0A..18f.
:#3D.#23x87;.ENDCASE..6//.xchgl.t,r#0D#0A..2CASE.ia
_xorl:..1f.:#3D.#23x31;.ENDCASE..6//.xorl.t,r#0D#0A
..}#0D#0A..ia_fnr(f,.t,.r).//.r.is.the.destination#0D
#0A}#0D#0A#0D#0AAND.iaRK(op,.r,.k).BE#0D#0A//.addl.
addcl.andl.cmpl.movl.orl.sbbl.shll.shrl.subl.xorl.#0D
#0A{.LET.rname.#3D.iarname(r)#0D#0A..SWITCHON.op.IN
TO#0D#0A..{.DEFAULT:#0D#0A..4iabadop(op,."RK")#0D#0A
..4RETURN#0D#0A#0D#0A..2CASE.ia_addl:#0D#0A..4db2wr
f("..6addl.$%n,.%s*n",.k,.rname)#0D#0A..4TEST.-128<
#3Dk<#3D127#0D#0A..4THEN.ia_fnrk1(#23x83,.0,.r,.k).
.6//.addl.$k,.r#0D#0A..4ELSE.TEST.r#3DEax#0D#0A..9T
HEN.ia_fk4(#23x05,.k)..9//.addl.$k,%eax#0D#0A..9ELS
E.ia_fnrk4(#23x81,.0,.r,.k)..1//.addl.$k,.r#0D#0A..
4RETURN#0D#0A#0D#0A..2CASE.ia_addcl:#0D#0A..4db2wrf
("..6addcl.$%n,.%s*n",.k,.rname)#0D#0A..4TEST.-128<
#3Dk<#3D127#0D#0A..4THEN.ia_fnrk1(#23x83,.2,.r,.k).
.6//.addcl.$k,.r#0D#0A..4ELSE.TEST.r#3DEax#0D#0A..9
THEN.ia_fk4(#23x15,.k)..9//.addcl.$k,%eax#0D#0A..9E
LSE.ia_fnrk4(#23x81,.2,.r,.k)..1//.addcl.$k,.r#0D#0A
..4RETURN#0D#0A#0D#0A..2CASE.ia_andl:#0D#0A..4db2wr
f("..6andl.$%n,.%s*n",.k,.rname)#0D#0A..4TEST.-128<
#3Dk<#3D127#0D#0A..4THEN.ia_fnrk1(#23x83,.4,.r,.k).
.6//.andl.$k,.r#0D#0A..4ELSE.TEST.r#3DEax#0D#0A..9T
HEN.ia_fk4(#23x25,.k)..9//.andl.$k,%eax#0D#0A..9ELS
E.ia_fnrk4(#23x81,.4,.r,.k)..1//.andl.$k,.r#0D#0A..
4RETURN#0D#0A#0D#0A..2CASE.ia_cmpl:#0D#0A..4db2wrf(
"..6cmpl.$%n,.%s*n",.k,.rname)#0D#0A..4TEST.-128<#3D
k<#3D127#0D#0A..4THEN.ia_fnrk1(#23x83,.7,.r,.k)..6/
/.cmpl.$k,.r#0D#0A..4ELSE.TEST.r#3DEax#0D#0A..9THEN
.ia_fk4(#23x35,.k)..9//.cmpl.$k,%eax#0D#0A..9ELSE.i
a_fnrk4(#23x81,.7,.r,.k)..1//.cmpl.$k,.r#0D#0A..4RE
TURN#0D#0A#0D#0A..2CASE.ia_movl:#0D#0A..4db2wrf("..
6movl.$%n,.%s*n",.k,.rname)#0D#0A..4ia_fk4(#23xB8+r
,.k)..7//.movl.$k,.r#0D#0A..4RETURN#0D#0A#0D#0A..2C
ASE.ia_orl:#0D#0A..4db2wrf("..6orl.$%n,.%s*n",.k,.r
name)#0D#0A..4TEST.-128<#3Dk<#3D127#0D#0A..4THEN.ia
_fnrk1(#23x83,.1,.r,.k)..6//.orl.$k,.r#0D#0A..4ELSE
.TEST.r#3DEax#0D#0A..9THEN.ia_fk4(#23x0D,.k)..9//.o
rl.$k,%eax#0D#0A..9ELSE.ia_fnrk4(#23x81,.1,.r,.k)..
1//.orl.$k,.r#0D#0A..4RETURN#0D#0A#0D#0A..2CASE.ia_
shll:#0D#0A..4db2wrf("..6shll.$%n,.%s*n",.k,.rname)
#0D#0A..4IF.k#3D0.RETURN#0D#0A..4TEST.k#3D1#0D#0A..
4THEN.ia_fnr(#23xD1,.4,.r)..11//.shll.$1,.r#0D#0A..
4ELSE.ia_fnrk1(#23xC1,.4,.r,.k)..6//.shll.$k,.r#0D#0A
..4RETURN#0D#0A#0D#0A..2CASE.ia_shrl:#0D#0A..4db2wr
f("..6shrl.$%n,.%s*n",.k,.rname)#0D#0A..4IF.k#3D0.R
ETURN#0D#0A..4TEST.k#3D1#0D#0A..4THEN.ia_fnr(#23xD1
,.5,.r)..11//.shll.$1,.r#0D#0A..4ELSE.ia_fnrk1(#23x
C1,.5,.r,.k)..6//.shll.$k,.r#0D#0A..4RETURN#0D#0A#0D
#0A..2CASE.ia_sbbl:#0D#0A..4db2wrf("..6sbbl.$%n,.%s
*n",.k,.rname)#0D#0A..4TEST.-128<#3Dk<#3D127#0D#0A.
.4THEN.ia_fnrk1(#23x83,.3,.r,.k)..6//.sbbl.$k,.r#0D
#0A..4ELSE.TEST.r#3DEax#0D#0A..9THEN.ia_fk4(#23x1D,
.k)..9//.sbbl.$k,%eax#0D#0A..9ELSE.ia_fnrk4(#23x81,
.3,.r,.k)..1//.sbbl.$k,.r#0D#0A..4RETURN#0D#0A#0D#0A
..2CASE.ia_subl:#0D#0A..4db2wrf("..6subl.$%n,.%s*n"
,.k,.rname)#0D#0A..4TEST.-128<#3Dk<#3D127#0D#0A..4T
HEN.ia_fnrk1(#23x83,.5,.r,.k)..6//.subl.$k,.r#0D#0A
..4ELSE.TEST.r#3DEax#0D#0A..9THEN.ia_fk4(#23x2D,.k)
..9//.subl.$k,%eax#0D#0A..9ELSE.ia_fnrk4(#23x81,.5,
.r,.k)..1//.subl.$k,.r#0D#0A..4RETURN#0D#0A#0D#0A..
2CASE.ia_xorl:#0D#0A..4db2wrf("..6xorl.$%n,.%s*n",.
k,.rname)#0D#0A..4TEST.-128<#3Dk<#3D127#0D#0A..4THE
N.ia_fnrk1(#23x83,.6,.r,.k)..6//.xorl.$k,.r#0D#0A..
4ELSE.TEST.r#3DEax#0D#0A..9THEN.ia_fk4(#23x35,.k)..
9//.xorl.$k,%eax#0D#0A..9ELSE.ia_fnrk4(#23x81,.6,.r
,.k)..1//.xorl.$k,.r#0D#0A..4RETURN#0D#0A..}#0D#0A}
#0D#0A#0D#0AAND.iaRL(op,.r,.n).BE#0D#0A//.addl.andl
.cmpl.leal.movl.movsbl.movswl.movzxbl.movzwl#0D#0A/
/.orl.subl.xchgl.xorl#0D#0A{.//.r.is.destination.(b
ut.cmpl.does.not.update.r)#0D#0A..LET.rname.#3D.iar
name(r)#0D#0A..LET.mem.#3D.rootnode!rtn_mc0#0D#0A..
LET.val.#3D.labv!n#0D#0A..LET.d.#3D.mem+4*mc+val#0D
#0A..LET.f.#3D.0#0D#0A#0D#0A..db2wrf("..6%s.%n,%s*n
",.iaop2str(op),.d,.rname)#0D#0A#0D#0A..UNLESS.val.
DO#0D#0A..{.writef("Error:.Data.label.not.declared:
.%i5:.%s.L%n,%s*n",#0D#0A..10iaop2str(op),.n,.rname
)#0D#0A..2RETURN#0D#0A..}#0D#0A#0D#0A..SWITCHON.op.
INTO#0D#0A..{.DEFAULT:..5iabadop(op,."RL");..RETURN
#0D#0A#0D#0A..2CASE.ia_addl:..1f.:#3D.#23x03;..1END
CASE..//.addl.Ln,r#0D#0A..2CASE.ia_addcl:..f.:#3D.#23
x13;..1ENDCASE..//.addcl.Ln,r#0D#0A..2CASE.ia_andl:
..1f.:#3D.#23x23;..1ENDCASE..//.andl.Ln,r#0D#0A..2C
ASE.ia_cmpl:..1f.:#3D.#23x3B;..1ENDCASE..//.cmpl.Ln
,r#0D#0A..2CASE.ia_leal:..1f.:#3D.#23x8D;..1ENDCASE
..//.leal.Ln,r#0D#0A..2CASE.ia_movl:..1IF.r#3DEax.D
O#0D#0A..18{.ia_fd(#23xA1,.d)#0D#0A..20RETURN#0D#0A
..18}#0D#0A..18f.:#3D.#23x8B;..1ENDCASE..//.movl.Ln
,r#0D#0A..2CASE.ia_movsbl:.f.:#3D.#23x0FBE;.ENDCASE
..//.movsbl.Ln,r#0D#0A..2CASE.ia_movswl:.f.:#3D.#23
x0FBF;.ENDCASE..//.movswl.Ln,r#0D#0A..2CASE.ia_movz
bl:.f.:#3D.#23x0FB6;.ENDCASE..//.movzbl.Ln,r#0D#0A.
.2CASE.ia_movzwl:.f.:#3D.#23x0FB7;.ENDCASE..//.movz
wl.Ln,r#0D#0A..2CASE.ia_orl:..2f.:#3D.#23x0B;..1END
CASE..//.orl.Ln,r#0D#0A..2CASE.ia_sbbl:..1f.:#3D.#23
x1B;..1ENDCASE..//.sbbl.Ln,r#0D#0A..2CASE.ia_subl:.
.1f.:#3D.#23x2B;..1ENDCASE..//.subl.Ln,r#0D#0A..2CA
SE.ia_xchgl:..f.:#3D.#23x87;..1ENDCASE..//.xchgl.Ln
,r#0D#0A..2CASE.ia_xorl:..1f.:#3D.#23x33;..1ENDCASE
..//.xorl.Ln,r#0D#0A..}#0D#0A//writef("m/c.address.
#3D.%n*n",.mem+4*mc+val)#0D#0A..ia_fnd(f,.r,.d)..5/
/.eg.addl.%eax,Ln#0D#0A//abort(1001)#0D#0A}#0D#0A#0D
#0AAND.iaRD(op,.r,.d).BE#0D#0A//.addl.addcl.andl.cm
pl.leal.movl.movsbl.movswl.movzxbl.movzwl#0D#0A//.o
rl.sbbl.subl.xchgl.xorl#0D#0A{.//.r.is.destination.
(but.cmpl.does.not.update.r)#0D#0A..LET.rname.#3D.i
arname(r)#0D#0A..LET.f.#3D.0#0D#0A#0D#0A..db2wrf(".
.6%s.%n,%s*n",.iaop2str(op),.d,.rname)#0D#0A#0D#0A.
.SWITCHON.op.INTO#0D#0A..{.DEFAULT:..5iabadop(op,."
RD");..RETURN#0D#0A#0D#0A..2CASE.ia_addl:..1f.:#3D.
#23x03;..1ENDCASE..//.addl.d,r#0D#0A..2CASE.ia_addc
l:..f.:#3D.#23x13;..1ENDCASE..//.addcl.d,r#0D#0A..2
CASE.ia_andl:..1f.:#3D.#23x23;..1ENDCASE..//.andl.d
,r#0D#0A..2CASE.ia_cmpl:..1f.:#3D.#23x3B;..1ENDCASE
..//.cmpl.d,r#0D#0A..2CASE.ia_leal:..1f.:#3D.#23x8D
;..1ENDCASE..//.leal.d,r#0D#0A..2CASE.ia_movl:..1f.
:#3D.#23x8B;..1ENDCASE..//.movl.d,r#0D#0A..2CASE.ia
_movsbl:.f.:#3D.#23x0FBE;.ENDCASE..//.movsbl.d,r#0D
#0A..2CASE.ia_movswl:.f.:#3D.#23x0FBF;.ENDCASE..//.
movswl.d,r#0D#0A..2CASE.ia_movzbl:.f.:#3D.#23x0FB6;
.ENDCASE..//.movzbl.d,r#0D#0A..2CASE.ia_movzwl:.f.:
#3D.#23x0FB7;.ENDCASE..//.movzwl.d,r#0D#0A..2CASE.i
a_orl:..2f.:#3D.#23x0B;..1ENDCASE..//.orl.d,r#0D#0A
..2CASE.ia_sbbl:..1f.:#3D.#23x1B;..1ENDCASE..//.sbb
l.d,r#0D#0A..2CASE.ia_subl:..1f.:#3D.#23x2B;..1ENDC
ASE..//.subl.d,r#0D#0A..2CASE.ia_xchgl:..f.:#3D.#23
x87;..1ENDCASE..//.xchgl.d,r#0D#0A..2CASE.ia_xorl:.
.1f.:#3D.#23x33;..1ENDCASE..//.xorl.d,r#0D#0A..}#0D
#0A..ia_fnd(f,.r,.d)..7//.eg.addl.63,.%eax#0D#0A}#0D
#0A#0D#0AAND.iaRDX(op,.r,.d,.x).BE#0D#0A//.addl.add
cl.andl.cmpl.leal.movl.movsbl.movswl.movzxbl.movzwl
#0D#0A//.orl.sbbl.subl.xchgl.xorl#0D#0A{.//.r.is.de
stination.(but.cmpl.does.not.update.r)#0D#0A..LET.r
name.#3D.iarname(r)#0D#0A..LET.xname.#3D.iarname(x)
#0D#0A..LET.f.#3D.0#0D#0A#0D#0A..db2wrf("..6%s.%n(%
s),%s*n",.iaop2str(op),.d,.xname,.rname)#0D#0A#0D#0A
..SWITCHON.op.INTO#0D#0A..{.DEFAULT:..6iabadop(op,.
"RDX");..RETURN#0D#0A#0D#0A..2CASE.ia_addl:..1f.:#3D
.#23x03;..1ENDCASE..//.addl.d(x),r#0D#0A..2CASE.ia_
addcl:..f.:#3D.#23x13;..1ENDCASE..//.addcl.d(x),r#0D
#0A..2CASE.ia_andl:..1f.:#3D.#23x23;..1ENDCASE..//.
andl.d(x),r#0D#0A..2CASE.ia_cmpl:..1f.:#3D.#23x3B;.
.1ENDCASE..//.cmpl.d(x),r#0D#0A..2CASE.ia_leal:..1f
.:#3D.#23x8D;..1ENDCASE..//.leal.d(x),r#0D#0A..2CAS
E.ia_movl:..1f.:#3D.#23x8B;..1ENDCASE..//.movl.d(x)
,r#0D#0A..2CASE.ia_movsbl:.f.:#3D.#23x0FBE;.ENDCASE
..//.movsbl.d(x),r#0D#0A..2CASE.ia_movswl:.f.:#3D.#23
x0FBF;.ENDCASE..//.movswl.d(x),r#0D#0A..2CASE.ia_mo
vzbl:.f.:#3D.#23x0FB6;.ENDCASE..//.movzbl.d(x),r#0D
#0A..2CASE.ia_movzwl:.f.:#3D.#23x0FB7;.ENDCASE..//.
movzwl.d(x),r#0D#0A..2CASE.ia_orl:..2f.:#3D.#23x0B;
..1ENDCASE..//.orl.d(x),r#0D#0A..2CASE.ia_sbbl:..1f
.:#3D.#23x1B;..1ENDCASE..//.sbbl.d(x),r#0D#0A..2CAS
E.ia_subl:..1f.:#3D.#23x2B;..1ENDCASE..//.subl.d(x)
,r#0D#0A..2CASE.ia_xchgl:..f.:#3D.#23x87;..1ENDCASE
..//.xchgl.d(x),r#0D#0A..2CASE.ia_xorl:..1f.:#3D.#23
x33;..1ENDCASE..//.xorl.d(x),r#0D#0A..}#0D#0A..ia_f
ndx(f,.r,.d,.x)..7//.eg.addl.63(%ebx),.%eax#0D#0A}#0D
#0A#0D#0AAND.iaRDXs(op,.r,.d,.x,.s).BE#0D#0A{.LET.r
name.#3D.iarname(r)#0D#0A..LET.xname.#3D.iarname(x)
#0D#0A..LET.f.#3D.0#0D#0A#0D#0A..db2wrf("..6%s.%n(,
%s,%n),%s*n",.iaop2str(op),.d,.xname,.s,.rname)#0D#0A
#0D#0A..SWITCHON.op.INTO#0D#0A..{.DEFAULT:..6iabado
p(op,."RDXs");..RETURN#0D#0A#0D#0A..2CASE.ia_addl:.
.1f.:#3D.#23x03;..1ENDCASE..//.addl.d(,x,s),r#0D#0A
..2CASE.ia_addcl:..f.:#3D.#23x13;..1ENDCASE..//.add
cl.d(,x,s),r#0D#0A..2CASE.ia_andl:..1f.:#3D.#23x23;
..1ENDCASE..//.andl.d(,x,s),r#0D#0A..2CASE.ia_cmpl:
..1f.:#3D.#23x3B;..1ENDCASE..//.cmpl.d(,x,s),r#0D#0A
..2CASE.ia_leal:..1f.:#3D.#23x8D;..1ENDCASE..//.lea
l.d(,x,s),r#0D#0A..2CASE.ia_movl:..1f.:#3D.#23x8B;.
.1ENDCASE..//.movl.d(,x,s),r#0D#0A..2CASE.ia_movsbl
:.f.:#3D.#23x0FBE;.ENDCASE..//.movsbl.d(,x,s),r#0D#0A
..2CASE.ia_movswl:.f.:#3D.#23x0FBF;.ENDCASE..//.mov
swl.d(,x,s),r#0D#0A..2CASE.ia_movzbl:.f.:#3D.#23x0F
B6;.ENDCASE..//.movzbl.d(,x,s),r#0D#0A..2CASE.ia_mo
vzwl:.f.:#3D.#23x0FB7;.ENDCASE..//.movzwl.d(,x,s),r
#0D#0A..2CASE.ia_orl:..2f.:#3D.#23x0B;..1ENDCASE../
/.orl.d(,x,s),r#0D#0A..2CASE.ia_sbbl:..1f.:#3D.#23x
1B;..1ENDCASE..//.sbbl.d(,x,s),r#0D#0A..2CASE.ia_su
bl:..1f.:#3D.#23x2B;..1ENDCASE..//.subl.d(,x,s),r#0D
#0A..2CASE.ia_xchgl:..f.:#3D.#23x87;..1ENDCASE..//.
xchgl.d(,x,s),r#0D#0A..2CASE.ia_xorl:..1f.:#3D.#23x
33;..1ENDCASE..//.xorl.d(,x,s),r#0D#0A..}#0D#0A..ia
_fndxs(f,.r,.d,.x,.s)..7//.eg.addl.64(,%ebx,4),.%ea
x#0D#0A}#0D#0A#0D#0AAND.iaRDXsB(op,.r,.d,.x,.s,.b).
BE#0D#0A{.//.eg:.movl.24(%edx,%edi,4),%ebx#0D#0A..L
ET.rname.#3D.iarname(r)#0D#0A..LET.xname.#3D.iarnam
e(x)#0D#0A..LET.bname.#3D.iarname(b)#0D#0A..LET.f.#3D
.0#0D#0A#0D#0A..db2wrf("..6%s.%n(%s,%s,%n),%s*n",.i
aop2str(op),.d,.bname,.xname,.s,.rname)#0D#0A#0D#0A
..SWITCHON.op.INTO#0D#0A..{.DEFAULT:..6iabadop(op,.
"RDXsB");..RETURN#0D#0A#0D#0A..2CASE.ia_addl:..1f.:
#3D.#23x03;..1ENDCASE..//.addl.d(b,x,s),r#0D#0A..2C
ASE.ia_addcl:..f.:#3D.#23x13;..1ENDCASE..//.addcl.d
(b,x,s),r#0D#0A..2CASE.ia_andl:..1f.:#3D.#23x23;..1
ENDCASE..//.andl.d(b,x,s),r#0D#0A..2CASE.ia_cmpl:..
1f.:#3D.#23x3B;..1ENDCASE..//.cmpl.d(b,x,s),r#0D#0A
..2CASE.ia_leal:..1f.:#3D.#23x8D;..1ENDCASE..//.lea
l.d(b,x,s),r#0D#0A..2CASE.ia_movl:..1f.:#3D.#23x8B;
..1ENDCASE..//.movl.d(b,x,s),r#0D#0A..2CASE.ia_movs
bl:.f.:#3D.#23x0FBE;.ENDCASE..//.movsbl.d(b,x,s),r#0D
#0A..2CASE.ia_movswl:.f.:#3D.#23x0FBF;.ENDCASE..//.
movswl.d(b,x,s),r#0D#0A..2CASE.ia_movzbl:.f.:#3D.#23
x0FB6;.ENDCASE..//.movzbl.d(b,x,s),r#0D#0A..2CASE.i
a_movzwl:.f.:#3D.#23x0FB7;.ENDCASE..//.movzwl.d(b,x
,s),r#0D#0A..2CASE.ia_orl:..2f.:#3D.#23x0B;..1ENDCA
SE..//.orl.d(b,x,s),r#0D#0A..2CASE.ia_sbbl:..1f.:#3D
.#23x1B;..1ENDCASE..//.sbbl.d(b,x,s),r#0D#0A..2CASE
.ia_subl:..1f.:#3D.#23x2B;..1ENDCASE..//.subl.d(b,x
,s),r#0D#0A..2CASE.ia_xchgl:..f.:#3D.#23x87;..1ENDC
ASE..//.xchgl.d(b,x,s),r#0D#0A..2CASE.ia_xorl:..1f.
:#3D.#23x33;..1ENDCASE..//.xorl.d(b,x,s),r#0D#0A..}
#0D#0A..ia_fndxsb(f,.r,.d,.x,.s,.b)..1//.eg.addl.64
(%edx,%ebx,4),.%eax#0D#0A}#0D#0A#0D#0AAND.iaDR(op,.
d,.r).BE#0D#0A{.//.memory.is.the.destination#0D#0A.
.//.eg:.addl.%ebx,24#0D#0A..LET.rname.#3D.iarname(r
)#0D#0A..LET.f.#3D.0#0D#0A#0D#0A..db2wrf("..6%s.%s,
%n*n",.iaop2str(op),.rname,.d)#0D#0A#0D#0A..SWITCHO
N.op.INTO#0D#0A..{.DEFAULT:..6iabadop(op,."DR");..R
ETURN#0D#0A#0D#0A..2CASE.ia_addl:..1f.:#3D.#23x01;.
.1ENDCASE..//.addl.r,d#0D#0A..2CASE.ia_addcl:..f.:#3D
.#23x11;..1ENDCASE..//.addcl.r,d#0D#0A..2CASE.ia_an
dl:..1f.:#3D.#23x21;..1ENDCASE..//.andl.r,d#0D#0A..
2CASE.ia_cmpl:..1f.:#3D.#23x39;..1ENDCASE..//.cmpl.
r,d#0D#0A..2CASE.ia_movb:..1f.:#3D.#23x88;..1ENDCAS
E..//.movb.r,d#0D#0A..2CASE.ia_movl:..1f.:#3D.#23x8
9;..1ENDCASE..//.movl.r,d#0D#0A..2CASE.ia_movw:..1f
.:#3D.#23x6600089;.ENDCASE..//.movw.r,d#0D#0A..2CAS
E.ia_movsbl:.f.:#3D.#23x0FBE;.ENDCASE..//.movsbl.r,
d#0D#0A..2CASE.ia_movswl:.f.:#3D.#23x0FBF;.ENDCASE.
.//.movswl.r,d#0D#0A..2CASE.ia_movzbl:.f.:#3D.#23x0
FB6;.ENDCASE..//.movzbl.r,d#0D#0A..2CASE.ia_movzwl:
.f.:#3D.#23x0FB7;.ENDCASE..//.movzwl.r,d#0D#0A..2CA
SE.ia_orl:..2f.:#3D.#23x09;..1ENDCASE..//.orl.r,d#0D
#0A..2CASE.ia_sbbl:..1f.:#3D.#23x19;..1ENDCASE..//.
sbbl.r,d#0D#0A..2CASE.ia_subl:..1f.:#3D.#23x29;..1E
NDCASE..//.subl.r,d#0D#0A..2CASE.ia_xchgl:..f.:#3D.
#23x87;..1ENDCASE..//.xchgl.r,d#0D#0A..2CASE.ia_xor
l:..1f.:#3D.#23x31;..1ENDCASE..//.xorl.r,d#0D#0A..}
#0D#0A..ia_fnd(f,.r,.d)..1//.eg.addl.%eax,64#0D#0A}
#0D#0A#0D#0AAND.iaDXR(op,.d,.x,.r).BE#0D#0A{.//.mem
ory.is.the.destination#0D#0A..//.eg:.addl.%ebx,24(%
edx)#0D#0A..LET.rname.#3D.iarname(r)#0D#0A..LET.xna
me.#3D.iarname(x)#0D#0A..LET.f.#3D.0#0D#0A#0D#0A..d
b2wrf("..6%s.%s,%n(%s)*n",.iaop2str(op),.rname,.d,.
xname)#0D#0A#0D#0A..SWITCHON.op.INTO#0D#0A..{.DEFAU
LT:..6iabadop(op,."DXR");..RETURN#0D#0A#0D#0A..2CAS
E.ia_addl:..1f.:#3D.#23x01;..1ENDCASE..//.addl.r,d(
x)#0D#0A..2CASE.ia_addcl:..f.:#3D.#23x11;..1ENDCASE
..//.addcl.r,d(x)#0D#0A..2CASE.ia_andl:..1f.:#3D.#23
x21;..1ENDCASE..//.andl.r,d(x)#0D#0A..2CASE.ia_cmpl
:..1f.:#3D.#23x39;..1ENDCASE..//.cmpl.r,d(x)#0D#0A.
.2CASE.ia_movb:..1f.:#3D.#23x88;..1ENDCASE..//.movb
.r,d(x)#0D#0A..2CASE.ia_movl:..1f.:#3D.#23x89;..1EN
DCASE..//.movl.r,d(x)#0D#0A..2CASE.ia_movw:..1f.:#3D
.#23x6600089;.ENDCASE..//.movw.r,d(x)#0D#0A..2CASE.
ia_movsbl:.f.:#3D.#23x0FBE;.ENDCASE..//.movsbl.r,d(
x)#0D#0A..2CASE.ia_movswl:.f.:#3D.#23x0FBF;.ENDCASE
..//.movswl.r,d(x)#0D#0A..2CASE.ia_movzbl:.f.:#3D.#23
x0FB6;.ENDCASE..//.movzbl.r,d(x)#0D#0A..2CASE.ia_mo
vzwl:.f.:#3D.#23x0FB7;.ENDCASE..//.movzwl.r,d(x)#0D
#0A..2CASE.ia_orl:..2f.:#3D.#23x09;..1ENDCASE..//.o
rl.r,d(x)#0D#0A..2CASE.ia_sbbl:..1f.:#3D.#23x19;..1
ENDCASE..//.sbbl.r,d(x)#0D#0A..2CASE.ia_subl:..1f.:
#3D.#23x29;..1ENDCASE..//.subl.r,d(x)#0D#0A..2CASE.
ia_xchgl:..f.:#3D.#23x87;..1ENDCASE..//.xchgl.r,d(x
)#0D#0A..2CASE.ia_xorl:..1f.:#3D.#23x31;..1ENDCASE.
.//.xorl.r,d(x)#0D#0A..}#0D#0A..ia_fndx(f,.r,.d,.x)
..1//.eg.addl.%eax,64(%ebp)#0D#0A}#0D#0A#0D#0AAND.i
aDXsR(op,.d,.x,.s,.r).BE#0D#0A{.//.memory.is.the.de
stination#0D#0A..//.eg:.addl.%ebx,24(,%edi,4)#0D#0A
..LET.rname.#3D.iarname(r)#0D#0A..LET.xname.#3D.iar
name(x)#0D#0A..LET.f.#3D.0#0D#0A#0D#0A..db2wrf("..6
%s.%s,%n(,%s,%n)*n",.iaop2str(op),.rname,.d,.xname,
.s)#0D#0A#0D#0A..SWITCHON.op.INTO#0D#0A..{.DEFAULT:
..6iabadop(op,."RDXsR");..RETURN#0D#0A#0D#0A..2CASE
.ia_addl:..1f.:#3D.#23x01;..1ENDCASE..//.addl.r,d(,
x,s)#0D#0A..2CASE.ia_addcl:..f.:#3D.#23x11;..1ENDCA
SE..//.addcl.r,d(,x,s)#0D#0A..2CASE.ia_andl:..1f.:#3D
.#23x21;..1ENDCASE..//.andl.r,d(,x,s)#0D#0A..2CASE.
ia_cmpl:..1f.:#3D.#23x39;..1ENDCASE..//.cmpl.r,d(,x
,s)#0D#0A..2CASE.ia_movb:..1f.:#3D.#23x88;..1ENDCAS
E..//.movb.r,d(,x,s)#0D#0A..2CASE.ia_movl:..1f.:#3D
.#23x89;..1ENDCASE..//.movl.r,d(,x,s)#0D#0A..2CASE.
ia_movw:..1f.:#3D.#23x6600089;.ENDCASE..//.movw.r,d
(,x,s)#0D#0A..2CASE.ia_movsbl:.f.:#3D.#23x0FBE;.END
CASE..//.movsbl.r,d(,x,s)#0D#0A..2CASE.ia_movswl:.f
.:#3D.#23x0FBF;.ENDCASE..//.movswl.r,d(,x,s)#0D#0A.
.2CASE.ia_movzbl:.f.:#3D.#23x0FB6;.ENDCASE..//.movz
bl.r,d(,x,s)#0D#0A..2CASE.ia_movzwl:.f.:#3D.#23x0FB
7;.ENDCASE..//.movzwl.r,d(,x,s)#0D#0A..2CASE.ia_orl
:..2f.:#3D.#23x09;..1ENDCASE..//.orl.r,d(,x,s)#0D#0A
..2CASE.ia_sbbl:..1f.:#3D.#23x19;..1ENDCASE..//.sbb
l.r,d(,x,s)#0D#0A..2CASE.ia_subl:..1f.:#3D.#23x29;.
.1ENDCASE..//.subl.r,d(,x,s)#0D#0A..2CASE.ia_xchgl:
..f.:#3D.#23x87;..1ENDCASE..//.xchgl.r,d(,x,s)#0D#0A
..2CASE.ia_xorl:..1f.:#3D.#23x31;..1ENDCASE..//.xor
l.r,d(,x,s)#0D#0A..}#0D#0A..ia_fndxs(f,.r,.d,.x,.s)
..1//.eg.addl.%eax,64(,%ebx,4)#0D#0A}#0D#0A#0D#0AAN
D.iaDXsBR(op,.d,.x,.s,.b,.r).BE#0D#0A{.//.memory.is
.the.destination#0D#0A..//.eg:.addl.%ebx,24(%edx,%e
di,4)#0D#0A..LET.rname.#3D.iarname(r)#0D#0A..LET.xn
ame.#3D.iarname(x)#0D#0A..LET.bname.#3D.iarname(b)#0D
#0A..LET.f.#3D.0#0D#0A#0D#0A..db2wrf("..6%s.%s,%n(%
s,%s,%n)*n",.iaop2str(op),.rname,.d,.bname,.xname,.
s)#0D#0A#0D#0A..SWITCHON.op.INTO#0D#0A..{.DEFAULT:.
.6iabadop(op,."RDXsBR");..RETURN#0D#0A#0D#0A..2CASE
.ia_addl:..1f.:#3D.#23x01;..1ENDCASE..//.addl.r,d(b
,x,s)#0D#0A..2CASE.ia_addcl:..f.:#3D.#23x11;..1ENDC
ASE..//.addcl.r,d(b,x,s)#0D#0A..2CASE.ia_andl:..1f.
:#3D.#23x21;..1ENDCASE..//.andl.r,d(b,x,s)#0D#0A..2
CASE.ia_cmpl:..1f.:#3D.#23x39;..1ENDCASE..//.cmpl.r
,d(b,x,s)#0D#0A..2CASE.ia_movb:..1f.:#3D.#23x88;..1
ENDCASE..//.movb.r,d(b,x,s)#0D#0A..2CASE.ia_movl:..
1f.:#3D.#23x89;..1ENDCASE..//.movl.r,d(b,x,s)#0D#0A
..2CASE.ia_movw:..1f.:#3D.#23x6600089;.ENDCASE..//.
movw.r,d(b,x,s)#0D#0A..2CASE.ia_movsbl:.f.:#3D.#23x
0FBE;.ENDCASE..//.movsbl.r,d(b,x,s)#0D#0A..2CASE.ia
_movswl:.f.:#3D.#23x0FBF;.ENDCASE..//.movswl.r,d(b,
x,s)#0D#0A..2CASE.ia_movzbl:.f.:#3D.#23x0FB6;.ENDCA
SE..//.movzbl.r,d(b,x,s)#0D#0A..2CASE.ia_movzwl:.f.
:#3D.#23x0FB7;.ENDCASE..//.movzwl.r,d(b,x,s)#0D#0A.
.2CASE.ia_orl:..2f.:#3D.#23x09;..1ENDCASE..//.orl.r
,d(b,x,s)#0D#0A..2CASE.ia_sbbl:..1f.:#3D.#23x19;..1
ENDCASE..//.sbbl.r,d(b,x,s)#0D#0A..2CASE.ia_subl:..
1f.:#3D.#23x29;..1ENDCASE..//.subl.r,d(b,x,s)#0D#0A
..2CASE.ia_xchgl:..f.:#3D.#23x87;..1ENDCASE..//.xch
gl.r,d(b,x,s)#0D#0A..2CASE.ia_xorl:..1f.:#3D.#23x31
;..1ENDCASE..//.xorl.r,d(b,x,s)#0D#0A..}#0D#0A..ia_
fndxsb(f,.r,.d,.x,.s,.b)..1//.eg.addl.%eax,64(%edx,
%ebx,4)#0D#0A}#0D#0A#0D#0AAND.iaDK(op,.d,.k).BE#0D#0A
{.//.addl.addc.andl.movb.movl.movw.orl.sbbl.shll.sh
rl.subl.xorl#0D#0A..//.Memory.is.the.destination.wi
th.k.as.source#0D#0A..//.eg:.addl.$20,24#0D#0A..LET
.f8,.f32,.n.#3D.0,.0,.0#0D#0A#0D#0A..db2wrf("..6%s.
$%n,%n*n",.iaop2str(op),.k,.d)#0D#0A#0D#0A..SWITCHO
N.op.INTO#0D#0A..{.DEFAULT:#0D#0A..4iabadop(op,."DK
")#0D#0A..4RETURN#0D#0A#0D#0A..2CASE.ia_addl:..f8,.
f32,.n.:#3D.#23x83,.#23x81,.0;.ENDCASE.//.addl.$k,d
#0D#0A..2CASE.ia_addcl:.f8,.f32,.n.:#3D.#23x83,.#23
x81,.2;.ENDCASE.//.addcl.$k,d#0D#0A..2CASE.ia_andl:
..f8,.f32,.n.:#3D.#23x83,.#23x81,.4;.ENDCASE.//.and
l.$k,d#0D#0A..2CASE.ia_cmpl:..f8,.f32,.n.:#3D.#23x8
3,.#23x81,.7;.ENDCASE.//.cmpl.$k,d#0D#0A..2CASE.ia_
movb:..ia_fdk1(#23xC6,d,k);..9RETURN..//.movl.$k,d#0D
#0A..2CASE.ia_movl:..ia_fdk4(#23xC7,d,k);..9RETURN.
.//.movl.$k,d#0D#0A..2CASE.ia_movw:..ia_fdk2(#23x66
C7,d,k);..7RETURN..//.movl.$k,d#0D#0A..2CASE.ia_orl
:..1f8,.f32,.n.:#3D.#23x83,.#23x81,.1;.ENDCASE.//.o
rl..$k,d#0D#0A..2CASE.ia_shll:..UNLESS.0<#3Dk<#3D31
.DO#0D#0A..17{.ia_fdk4(#23xC7,d,0)..16//.movl.$0,d#0D
#0A..19RETURN#0D#0A..17}#0D#0A..17f8,..4n.:#3D.#23x
C0,..0055;.ENDCASE.//.shll.$k,d#0D#0A..2CASE.ia_shr
l:..UNLESS.0<#3Dk<#3D31.DO#0D#0A..17{.ia_fdk4(#23xC
7,d,0)..16//.movl.$0,d#0D#0A..19RETURN#0D#0A..17}#0D
#0A..17f8,..4n.:#3D.#23xC1,..0055;.ENDCASE.//.shll.
$k,d#0D#0A..2CASE.ia_sbbl:..f8,.f32,.n.:#3D.#23x83,
.#23x81,.3;.ENDCASE.//.sbbl.$k,d#0D#0A..2CASE.ia_su
bl:..f8,.f32,.n.:#3D.#23x83,.#23x81,.5;.ENDCASE.//.
subl.$k,d#0D#0A..2CASE.ia_xorl:..f8,.f32,.n.:#3D.#23
x83,.#23x81,.6;.ENDCASE.//.xorl.$k,d#0D#0A..}#0D#0A
..TEST.-128<#3Dk<127#0D#0A..THEN.ia_fndk1(f8,..n,.d
,.k)#0D#0A..ELSE.ia_fndk4(f32,.n,.d,.k)#0D#0A}#0D#0A
#0D#0AAND.iaDXK(op,.d,.x,.k).BE#0D#0A{.//.addl.addc
l.andl.cmpl.movb.movl.movw.orl.sbbl.shll.shrl.subl.
xorl#0D#0A..//.Memory.is.the.destination.with.k.as.
source#0D#0A..//.eg:.addl.$20,24(%edi)#0D#0A..LET.x
name.#3D.iarname(x)#0D#0A..LET.f8,.f32,.n.#3D.0,.0,
.0#0D#0A#0D#0A..db2wrf("..6%s.$%n,%n(%s)*n",.iaop2s
tr(op),.k,.d,.xname)#0D#0A#0D#0A..SWITCHON.op.INTO#0D
#0A..{.DEFAULT:#0D#0A..4iabadop(op,."DXK")#0D#0A..4
RETURN#0D#0A#0D#0A..2CASE.ia_addl:..f8,.f32,.n.:#3D
.#23x83,.#23x81,.0;.ENDCASE.//.addl.$k,d(x)#0D#0A..
2CASE.ia_addcl:.f8,.f32,.n.:#3D.#23x83,.#23x81,.2;.
ENDCASE.//.addcl.$k,d(x)#0D#0A..2CASE.ia_andl:..f8,
.f32,.n.:#3D.#23x83,.#23x81,.4;.ENDCASE.//.andl.$k,
d(x)#0D#0A..2CASE.ia_cmpl:..f8,.f32,.n.:#3D.#23x83,
.#23x81,.7;.ENDCASE.//.cmpl.$k,d(x)#0D#0A..2CASE.ia
_movb:..ia_fdxk1(#23xC6,d,x,k)..15//.movb.$k,d(x)#0D
#0A..17RETURN#0D#0A..2CASE.ia_movl:..ia_fdxk4(#23xC
7,d,x,k)..15//.movl.$k,d(x)#0D#0A..17RETURN#0D#0A..
2CASE.ia_movw:..ia_fdxk2(#23x66C7,d,x,k)..13//.movw
.$k,d(x)#0D#0A..17RETURN#0D#0A..2CASE.ia_orl:..1f8,
.f32,.n.:#3D.#23x83,.#23x81,.1;.ENDCASE.//.orl..$k,
d(x)#0D#0A..2CASE.ia_shll:..UNLESS.0<#3Dk<#3D31.DO#0D
#0A..17{.ia_fdxk4(#23xC7,d,x,0)..13//.movl.$0,d(x)#0D
#0A..19RETURN#0D#0A..17}#0D#0A..17f8,..4n.:#3D.#23x
C0,..0055;.ENDCASE.//.shll.$k,d(x)#0D#0A..2CASE.ia_
shrl:..UNLESS.0<#3Dk<#3D31.DO#0D#0A..17{.ia_fdxk4(#23
xC7,d,x,0)..13//.movl.$0,d(x)#0D#0A..19RETURN#0D#0A
..17}#0D#0A..17f8,..4n.:#3D.#23xC1,..0055;.ENDCASE.
//.shll.$k,d(x)#0D#0A..2CASE.ia_sbbl:..f8,.f32,.n.:
#3D.#23x83,.#23x81,.3;.ENDCASE.//.sbbl.$k,d(x)#0D#0A
..2CASE.ia_subl:..f8,.f32,.n.:#3D.#23x83,.#23x81,.5
;.ENDCASE.//.subl.$k,d(x)#0D#0A..2CASE.ia_xorl:..f8
,.f32,.n.:#3D.#23x83,.#23x81,.6;.ENDCASE.//.xorl.$k
,d(x)#0D#0A..}#0D#0A..TEST.-128<#3Dk<127#0D#0A..THE
N.ia_fndxk1(f8,..n,.d,.x,.k)#0D#0A..ELSE.ia_fndxk4(
f32,.n,.d,.x,.k)#0D#0A}#0D#0A#0D#0AAND.iaDXsK(op,.d
,.x,.s,.k).BE#0D#0A{.//.addl.addcl.andl.cmpl.movl.o
rl.sbbl.shll.shrl.subl.xorl#0D#0A..//.Memory.is.the
.destination.with.k.as.source#0D#0A..//.eg:.addl.$2
0,24(,%edi,4)#0D#0A..LET.xname.#3D.iarname(x)#0D#0A
..LET.f8,.f32,.n.#3D.0,.0,.0#0D#0A#0D#0A..db2wrf(".
.6%s.$%n,%n(,%s,%n)*n",.iaop2str(op),.k,.d,.xname,.
s)#0D#0A#0D#0A..SWITCHON.op.INTO#0D#0A..{.DEFAULT:.
.5iabadop(op,."DXsK");.RETURN#0D#0A#0D#0A..2CASE.ia
_addl:..f8,.f32,.n.:#3D.#23x83,.#23x81,.0;.ENDCASE.
//.addl.$k,d(,x,s)#0D#0A..2CASE.ia_addcl:.f8,.f32,.
n.:#3D.#23x83,.#23x81,.2;.ENDCASE.//.addcl.$k,d(,x,
s)#0D#0A..2CASE.ia_andl:..f8,.f32,.n.:#3D.#23x83,.#23
x81,.4;.ENDCASE.//.andl.$k,d(,x,s)#0D#0A..2CASE.ia_
cmpl:..f8,.f32,.n.:#3D.#23x83,.#23x81,.7;.ENDCASE./
/.cmpl.$k,d(,x,s)#0D#0A..2CASE.ia_movb:..ia_fdxsk1(
#23xC6,d,x,s,k);..3RETURN..//.movb.$k,d(,x,s)#0D#0A
..2CASE.ia_movl:..ia_fdxsk4(#23xC7,d,x,s,k);..3RETU
RN..//.movl.$k,d(b,x,s)#0D#0A..2CASE.ia_movw:..ia_f
dxsk2(#23x66C7,d,x,s,k);..1RETURN..//.movw.$k,d(,x,
s)#0D#0A..2CASE.ia_orl:..1f8,.f32,.n.:#3D.#23x83,.#23
x81,.1;.ENDCASE.//.orl..$k,d(,x,s)#0D#0A..2CASE.ia_
shll:..UNLESS.0<#3Dk<#3D31.DO#0D#0A..17{.ia_fdxsk4(
#23xC7,d,x,s,0)..10//.movl.$0,d(,x,s)#0D#0A..19RETU
RN#0D#0A..17}#0D#0A..17f8,..4n.:#3D.#23xC0,..0055;.
ENDCASE.//.shll.$k,d(,x,s)#0D#0A..2CASE.ia_shrl:..U
NLESS.0<#3Dk<#3D31.DO#0D#0A..17{.ia_fdxsk4(#23xC7,d
,x,s,0)..10//.movl.$0,d(,x,s)#0D#0A..19RETURN#0D#0A
..17}#0D#0A..17f8,..4n.:#3D.#23xC1,..0055;.ENDCASE.
//.shll.$k,d(,x,s)#0D#0A..2CASE.ia_sbbl:..f8,.f32,.
n.:#3D.#23x83,.#23x81,.3;.ENDCASE.//.sbbl.$k,d(,x,s
)#0D#0A..2CASE.ia_subl:..f8,.f32,.n.:#3D.#23x83,.#23
x81,.5;.ENDCASE.//.subl.$k,d(,x,s)#0D#0A..2CASE.ia_
xorl:..f8,.f32,.n.:#3D.#23x83,.#23x81,.6;.ENDCASE./
/.xorl.$k,d(,x,s)#0D#0A..}#0D#0A..TEST.-128<#3Dk<12
7#0D#0A..THEN.ia_fndxsk1(f8,..n,.d,.x,.s,.k)#0D#0A.
.ELSE.ia_fndxsk4(f32,.n,.d,.x,.s,.k)#0D#0A}#0D#0A#0D
#0AAND.iaDXsBK(op,.d,.x,.s,.b,.k).BE#0D#0A{.//.addl
.addcl.andl.cmpl.movl.orl.sbbl.shll.shrl.subl.xorl#0D
#0A..//.Memory.is.the.destination.with.k.as.source#0D
#0A..//.eg:.addl.$20,24(%edx,%edi,4)#0D#0A..LET.xna
me.#3D.iarname(x)#0D#0A..LET.bname.#3D.iarname(b)#0D
#0A..LET.f8,.f32,.n.#3D.0,.0,.0#0D#0A#0D#0A..db2wrf
("..6%s.$%n,%n(%s,%s,%n)*n",.iaop2str(op),.k,.d,.bn
ame,.xname,.s)#0D#0A#0D#0A..SWITCHON.op.INTO#0D#0A.
.{.DEFAULT:..5iabadop(op,."DXsBK");.RETURN#0D#0A#0D
#0A..2CASE.ia_addl:..f8,.f32,.n.:#3D.#23x83,.#23x81
,.0;.ENDCASE.//.addl.$k,d(b,x,s)#0D#0A..2CASE.ia_ad
dcl:.f8,.f32,.n.:#3D.#23x83,.#23x81,.2;.ENDCASE.//.
addcl.$k,d(b,x,s)#0D#0A..2CASE.ia_andl:..f8,.f32,.n
.:#3D.#23x83,.#23x81,.4;.ENDCASE.//.andl.$k,d(b,x,s
)#0D#0A..2CASE.ia_cmpl:..f8,.f32,.n.:#3D.#23x83,.#23
x81,.7;.ENDCASE.//.cmpl.$k,d(b,x,s)#0D#0A..2CASE.ia
_movb:..ia_fdxsbk1(#23xC6,d,x,s,b,k);..RETURN..//.m
ovb.$k,d(b,x,s)#0D#0A..2CASE.ia_movl:..ia_fdxsbk4(#23
xC7,d,x,s,b,k);..RETURN..//.movl.$k,d(b,x,s)#0D#0A.
.2CASE.ia_movw:..ia_fdxsbk2(#23x66C7,d,x,s,b,k);RET
URN..//.movw.$k,d(b,x,s)#0D#0A..2CASE.ia_orl:..1f8,
.f32,.n.:#3D.#23x83,.#23x81,.1;.ENDCASE.//.orl..$k,
d(b,x,s)#0D#0A..2CASE.ia_shll:..UNLESS.0<#3Dk<#3D31
.DO#0D#0A..17{.ia_fdxsbk4(#23xC7,d,x,s,b,0)..7//.mo
vl.$0,d(b,x,s)#0D#0A..19RETURN#0D#0A..17}#0D#0A..17
f8,..4n.:#3D.#23xC0,..0055;.ENDCASE.//.shll.$k,d(b,
x,s)#0D#0A..2CASE.ia_shrl:..UNLESS.0<#3Dk<#3D31.DO#0D
#0A..17{.ia_fdxsbk4(#23xC7,d,x,s,b,0)..7//.movl.$0,
d(b,x,s)#0D#0A..19RETURN#0D#0A..17}#0D#0A..17f8,..4
n.:#3D.#23xC1,..0055;.ENDCASE.//.shll.$k,d(b,x,s)#0D
#0A..2CASE.ia_sbbl:..f8,.f32,.n.:#3D.#23x83,.#23x81
,.3;.ENDCASE.//.sbbl.$k,d(b,x,s)#0D#0A..2CASE.ia_su
bl:..f8,.f32,.n.:#3D.#23x83,.#23x81,.5;.ENDCASE.//.
subl.$k,d(b,x,s)#0D#0A..2CASE.ia_xorl:..f8,.f32,.n.
:#3D.#23x83,.#23x81,.6;.ENDCASE.//.xorl.$k,d(b,x,s)
#0D#0A..}#0D#0A..TEST.-128<#3Dk<127#0D#0A..THEN.ia_
fndxsbk1(f8,..n,.d,.x,.s,.b,.k)#0D#0A..ELSE.ia_fndx
sbk4(f32,.n,.d,.x,.s,.b,.k)#0D#0A}#0D#0A#0D#0AAND.i
aJL(op,.n,.short).BE#0D#0A//.jmp.je.jne.jl.jle.jg.j
ge.ja.jae.jb.jbe#0D#0A#0D#0A//.short.is.TRUE.if.for
ward.refs.are.assumed.to.be.rel8#0D#0A{.LET.f8,.f32
.#3D.0,.0#0D#0A#0D#0A..db2wrf("..6%s.L%n*n",.iaop2s
tr(op),.n)#0D#0A#0D#0A..SWITCHON.op.INTO#0D#0A..{.D
EFAULT:..3writef("Error:.Bad.op.for.iaJL*n");.RETUR
N#0D#0A#0D#0A..2CASE.ia_jmp:.f8,.f32.:#3D.#23xEB,..
1#23xE9;.ENDCASE.//.jmp.Ln#0D#0A..2CASE.ia_je:..f8,
.f32.:#3D.#23x74,.#23x0F84;.ENDCASE.//.je.Ln#0D#0A.
.2CASE.ia_jne:.f8,.f32.:#3D.#23x75,.#23x0F85;.ENDCA
SE.//.jne.Ln#0D#0A..2CASE.ia_jl:..f8,.f32.:#3D.#23x
7C,.#23x0F8C;.ENDCASE.//.jl.Ln#0D#0A..2CASE.ia_jle:
.f8,.f32.:#3D.#23x7E,.#23x0F8E;.ENDCASE.//.jle.Ln#0D
#0A..2CASE.ia_jg:..f8,.f32.:#3D.#23x7F,.#23x0F8F;.E
NDCASE.//.jg.Ln#0D#0A..2CASE.ia_jge:.f8,.f32.:#3D.#23
x7D,.#23x0F8D;.ENDCASE.//.jge.Ln#0D#0A..2CASE.ia_ja
:..f8,.f32.:#3D.#23x77,.#23x0F87;.ENDCASE.//.ja.Ln#0D
#0A..2CASE.ia_jae:.f8,.f32.:#3D.#23x73,.#23x0F83;.E
NDCASE.//.jae.Ln#0D#0A..2CASE.ia_jb:..f8,.f32.:#3D.
#23x72,.#23x0F82;.ENDCASE.//.jb.Ln#0D#0A..2CASE.ia_
jbe:.f8,.f32.:#3D.#23x76,.#23x0F86;.ENDCASE.//.jbe.
Ln#0D#0A..}#0D#0A..ia_j(f8,.f32,.n,.short)#0D#0A}#0D
#0A#0D#0AAND.iaJR(op,.r).BE#0D#0A//.jmp#0D#0A{.LET.
rname.#3D.iarname(r)#0D#0A..db2wrf("..6%s.**%s*n",.
iaop2str(op),.rname)#0D#0A#0D#0A..SWITCHON.op.INTO#0D
#0A..{.DEFAULT:..3writef("Error:.Bad.op.for.iaJR*n"
);.RETURN#0D#0A#0D#0A..2CASE.ia_jmp:.ia_fnr(#23xFF,
.4,.r);.ENDCASE.//.jmp.Ln#0D#0A..}#0D#0A}#0D#0A#0D#0A
//.**15..Assemble.i386.instructions.**15#0D#0A#0D#0A
//.The.following.function.are.to.assemble.i386.inst
ructions#2E#0D#0A//.No.optimisation.is.performed.ex
cept.for.the.compare.instructions#2E#0D#0A#0D#0A//.
Each.ia.generation.function.(such.ad.iaRR).assemble
s.just.one#0D#0A//.machine.instruction#2E.Most.opti
misations.are.performed.by.the.MC#0D#0A//.generatio
n.functions#2E#0D#0A#0D#0A#0D#0A/*#0D#0A32-bit.i386
.protected.mode.instruction.format#0D#0A#0D#0Aop-by
te..19d8..or..d32#0D#0Aop-byte.modRM..13d8..or..d32
#0D#0Aop-byte.modRM.SIB..9d8..or..d32#0D#0A#0D#0A..
modRM#0D#0A00_rr1_ss1..20[ss1]..3ss1~#3D100#0D#0A01
_rr1_ss1..18d8[ss1]..3ss1~#3D100#0D#0A10_rr1_ss1..1
7d32[ss1]..3ss1~#3D100#0D#0A11_rr1_ss1..21ss1..4ss1
~#3D100#0D#0A#0D#0A00_rr1_101..21d32#0D#0A#0D#0A00_
rr1_100.tt_xx1_101..7d32[xx1<<tt]#0D#0A01_rr1_100.t
t_xx1_bb1..8d8[xx1<<tt.+.bb1]#0D#0A10_rr1_100.tt_xx
1_bb1..7d32[xx1<<tt.+.bb1]#0D#0A*/#0D#0A#0D#0A//.Fo
rm.a.ModR/M.byte:..8<.mm..10reg/op..4r/m>#0D#0AAND.
mod00(reg_op,.rm)..3#3D.iaC1(#23b00_001_001.+.(reg_
op<<0003).+.rm)#0D#0AAND.mod01(reg_op,.rm)..3#3D.ia
C1(#23b01_001_001.+.(reg_op<<0003).+.rm)#0D#0AAND.m
od10(reg_op,.rm)..3#3D.iaC1(#23b10_001_001.+.(reg_o
p<<0003).+.rm)#0D#0AAND.mod11(reg_op,.rm)..3#3D.iaC
1(#23b11_001_001.+.(reg_op<<0003).+.rm)#0D#0AAND.mo
dmm(mm,.reg_op,.rm).#3D.iaC1(.(mm<<0006)..3+.(reg_o
p<<0003).+.rm)#0D#0A#0D#0A//.Form.a.SIB.byte:..12<.
ss..10index..5base>#0D#0AAND.sib00(index,.base)..3#3D
.iaC1(#23b00_001_001.+.(index<<0003).+.base)#0D#0AA
ND.sib01(index,.base)..3#3D.iaC1(#23b01_001_001.+.(
index<<0003).+.base)#0D#0AAND.sib10(index,.base)..3
#3D.iaC1(#23b10_001_001.+.(index<<0003).+.base)#0D#0A
AND.sib11(index,.base)..3#3D.iaC1(#23b11_001_001.+.
(index<<0003).+.base)#0D#0A#0D#0AAND.sibss(scale,.i
ndex,.base).#3D.VALOF.SWITCHON.scale.INTO#0D#0A{.DE
FAULT:.writef("sibss:.bad.scale#3D%n*n",.scale)#0D#0A
..9abort(991)#0D#0A..9RESULTIS.0#0D#0A..CASE.1:.RES
ULTIS.sib00(index,.base)#0D#0A..CASE.2:.RESULTIS.si
b01(index,.base)#0D#0A..CASE.4:.RESULTIS.sib10(inde
x,.base)#0D#0A..CASE.8:.RESULTIS.sib11(index,.base)
#0D#0A}#0D#0A#0D#0AAND.mcr2iar(r).#3D.VALOF.SWITCHO
N.r.INTO#0D#0A{.//.Map.MC.register.numbers.to.i386.
register.numbers#0D#0A..DEFAULT:..1writef("mcr2iar(
%n):.Bad.MC.register*n",.r)#0D#0A..11RETURN#0D#0A..
CASE.mc_a:.RESULTIS.Eax#0D#0A..CASE.mc_b:.RESULTIS.
Ebx#0D#0A..CASE.mc_c:.RESULTIS.Ecx#0D#0A..CASE.mc_d
:.RESULTIS.Edx#0D#0A..CASE.mc_e:.RESULTIS.Esi#0D#0A
..CASE.mc_f:.RESULTIS.Edi#0D#0A}#0D#0A#0D#0AAND.iar
name(r).#3D.VALOF.SWITCHON.r.INTO#0D#0A{.//.32-bit.
registers..EAX,.EBX,.ECX,.EDX,.ESP,.EBP,.ESI.and.ED
I.#0D#0A..DEFAULT:#0D#0A..2writef("iarname(%n):.Bad
.i386.register*n",.r)#0D#0Aabort(1001)#0D#0A..2RESU
LTIS."%??1"#0D#0A..CASE.Eax:.RESULTIS."%eax"#0D#0A.
.CASE.Ecx:.RESULTIS."%ecx"#0D#0A..CASE.Edx:.RESULTI
S."%edx"#0D#0A..CASE.Ebx:.RESULTIS."%ebx"#0D#0A..CA
SE.Esp:.RESULTIS."%esp"#0D#0A..CASE.Ebp:.RESULTIS."
%ebp"#0D#0A..CASE.Esi:.RESULTIS."%esi"#0D#0A..CASE.
Edi:.RESULTIS."%edi"#0D#0A}#0D#0A#0D#0AAND.iarname1
6(r).#3D.VALOF.SWITCHON.r.INTO#0D#0A{.//.16-bit.reg
isters.AX,.BX,.CX,.DX,.SP,.BP,.SI.and.DI.#0D#0A..DE
FAULT:#0D#0A..2writef("iarname(%n):.Bad.i386.regist
er*n",.r)#0D#0A..2RESULTIS."%??1"#0D#0A..CASE.Eax:.
RESULTIS."%ax"#0D#0A..CASE.Ecx:.RESULTIS."%cx"#0D#0A
..CASE.Edx:.RESULTIS."%dx"#0D#0A..CASE.Ebx:.RESULTI
S."%bx"#0D#0A..CASE.Esp:.RESULTIS."%sp"#0D#0A..CASE
.Ebp:.RESULTIS."%bp"#0D#0A..CASE.Esi:.RESULTIS."%si
"#0D#0A..CASE.Edi:.RESULTIS."%di"#0D#0A}#0D#0A#0D#0A
AND.iarname8(r).#3D.VALOF.SWITCHON.r.INTO#0D#0A{.//
.8-bit.registers.AL,.BL,.CL.and.DL#0D#0A..DEFAULT:#0D
#0A..2writef("iarname8(%n):.Bad.i386.register*n",.r
)#0D#0A..2RESULTIS."%??1"#0D#0A..CASE.Eax:.RESULTIS
."%al"#0D#0A..CASE.Ecx:.RESULTIS."%cl"#0D#0A..CASE.
Edx:.RESULTIS."%dl"#0D#0A..CASE.Ebx:.RESULTIS."%bl"
#0D#0A}#0D#0A#0D#0AAND.iarname8h(r).#3D.VALOF.SWITC
HON.r.INTO#0D#0A{.//.8-bit.registers.AH,.BH,.CH.and
.DH#0D#0A..DEFAULT:#0D#0A..2writef("iarname8h(%n):.
Bad.i386.register*n",.r)#0D#0A..2RESULTIS."%??1"#0D
#0A..CASE.Eax:.RESULTIS."%ah"#0D#0A..CASE.Ecx:.RESU
LTIS."%ch"#0D#0A..CASE.Edx:.RESULTIS."%dh"#0D#0A..C
ASE.Ebx:.RESULTIS."%bh"#0D#0A}#0D#0A#0D#0AAND.iabad
op(op,.str).BE#0D#0A{.LET.opstr.#3D.iaop2str(op)#0D
#0A..writef("Error:.ia%s(",.str)#0D#0A..writef(opst
r,.op)#0D#0A..writef(",#2E#2E).not.available*n")#0D
#0A}#0D#0A#0D#0AAND.iaop2str(op).#3D.VALOF.SWITCHON
.op.INTO#0D#0A{.DEFAULT:..9RESULTIS."unknown:%n"#0D
#0A#0D#0A..CASE.ia_addl:..4RESULTIS."addl"#0D#0A..C
ASE.ia_addcl:..3RESULTIS."addcl"#0D#0A..CASE.ia_and
l:..4RESULTIS."andl"#0D#0A..CASE.ia_alignc:..2RESUL
TIS."alignc"#0D#0A..CASE.ia_alignd:..2RESULTIS."ali
gnd"#0D#0A..CASE.ia_call:..4RESULTIS."call"#0D#0A..
CASE.ia_cdq:..5RESULTIS."cdq"#0D#0A..CASE.ia_cmpl:.
.4RESULTIS."cmpl"#0D#0A..CASE.ia_datab:..3RESULTIS.
"datab"#0D#0A..CASE.ia_datak:..3RESULTIS."datak"#0D
#0A..CASE.ia_datal:..3RESULTIS."datal"#0D#0A..CASE.
ia_decl:..4RESULTIS."decl"#0D#0A..CASE.ia_divl:..4R
ESULTIS."divl"#0D#0A..CASE.ia_dlab:..4RESULTIS."dla
b"#0D#0A..CASE.ia_endfn:..3RESULTIS."endfn"#0D#0A..
CASE.ia_end:..5RESULTIS."end"#0D#0A..CASE.ia_entry:
..3RESULTIS."entry"#0D#0A..CASE.ia_idivl:..3RESULTI
S."idivl"#0D#0A..CASE.ia_imull:..3RESULTIS."imull"#0D
#0A..CASE.ia_incl:..4RESULTIS."incl"#0D#0A..CASE.ia
_je:..6RESULTIS."je"#0D#0A..CASE.ia_jne:..5RESULTIS
."jne"#0D#0A..CASE.ia_jl:..6RESULTIS."jl"#0D#0A..CA
SE.ia_jg:..6RESULTIS."jg"#0D#0A..CASE.ia_jle:..5RES
ULTIS."jle"#0D#0A..CASE.ia_jge:..5RESULTIS."jge"#0D
#0A..CASE.ia_lab:..5RESULTIS."lab"#0D#0A..CASE.ia_l
eal:..4RESULTIS."leal"#0D#0A..CASE.ia_movb:..4RESUL
TIS."movb"#0D#0A..CASE.ia_movl:..4RESULTIS."movl"#0D
#0A..CASE.ia_movw:..4RESULTIS."movw"#0D#0A..CASE.ia
_movsbl:..2RESULTIS."movsbl"#0D#0A..CASE.ia_movswl:
..2RESULTIS."movswl"#0D#0A..CASE.ia_movzbl:..2RESUL
TIS."movzbl"#0D#0A..CASE.ia_movzwl:..2RESULTIS."mov
zwl"#0D#0A..CASE.ia_mull:..4RESULTIS."mull"#0D#0A..
CASE.ia_negl:..4RESULTIS."negl"#0D#0A..CASE.ia_notl
:..4RESULTIS."notl"#0D#0A..CASE.ia_orl:..5RESULTIS.
"orl"#0D#0A..CASE.ia_popl:..4RESULTIS."popl"#0D#0A.
.CASE.ia_popal:..3RESULTIS."popal"#0D#0A..CASE.ia_p
opfl:..3RESULTIS."popfl"#0D#0A..CASE.ia_pushl:..3RE
SULTIS."pushl"#0D#0A..CASE.ia_pushal:..2RESULTIS."p
ushal"#0D#0A..CASE.ia_pushfl:..2RESULTIS."pushfl"#0D
#0A..CASE.ia_ret:..5RESULTIS."ret"#0D#0A..CASE.ia_s
eta:..4RESULTIS."seta"#0D#0A..CASE.ia_setae:..3RESU
LTIS."setae"#0D#0A..CASE.ia_setb:..4RESULTIS."setb"
#0D#0A..CASE.ia_setbe:..3RESULTIS."setbe"#0D#0A..CA
SE.ia_sete:..4RESULTIS."sete"#0D#0A..CASE.ia_setg:.
.4RESULTIS."setg"#0D#0A..CASE.ia_setge:..3RESULTIS.
"setge"#0D#0A..CASE.ia_setne:..3RESULTIS."setne"#0D
#0A..CASE.ia_setl:..4RESULTIS."setl"#0D#0A..CASE.ia
_setle:..3RESULTIS."setle"#0D#0A..CASE.ia_shld:..4R
ESULTIS."shld"#0D#0A..CASE.ia_shrd:..4RESULTIS."shr
d"#0D#0A..CASE.ia_shll:..4RESULTIS."shll"#0D#0A..CA
SE.ia_shrl:..4RESULTIS."shrl"#0D#0A..CASE.ia_sbbl:.
.4RESULTIS."sbbl"#0D#0A..CASE.ia_subl:..4RESULTIS."
subl"#0D#0A..CASE.ia_xchgl:..3RESULTIS."xchgl"#0D#0A
..CASE.ia_xorl:..4RESULTIS."xorl"#0D#0A}#0D#0A#0D#0A
//.**10.Code.and.Data.Byte.Generation.Functions.**1
1#0D#0A#0D#0AAND.iaD1(b).BE#0D#0A{.IF.datap.>.datat
.DO#0D#0A..{.writef("*niaD1:.data.space.overflow*n"
)#0D#0A..2RETURN#0D#0A..}#0D#0A..db3wrf(".%x2",.b)#0D
#0A..mc%datap.:#3D.b#0D#0A..datap.:#3D.datap.+.1#0D
#0A}#0D#0A#0D#0AAND.iaD2(num).BE.{.iaD1(num);.iaD1(
num>>0008).}#0D#0AAND.iaD3(num).BE.{.iaD1(num);.iaD
1(num>>0008);.iaD1(num>>00016).}#0D#0AAND.iaD4(num)
.BE.{.iaD1(num);.iaD1(num>>0008);.iaD1(num>>00016);
.iaD1(num>>00024).}#0D#0A#0D#0AAND.iaC1(b).BE#0D#0A
{.IF.codep.>#3D.codet.DO#0D#0A..{.writef("*niaC1:.c
ode.space.overflow,.codep#3D%n.codet#3D%n*n",.codep
,.codet)#0D#0A..2RETURN#0D#0A..}#0D#0A..db3wrf(".%x
2",.b)#0D#0A..mc%codep.:#3D.b#0D#0A..codep.:#3D.cod
ep.+.1#0D#0A}#0D#0A#0D#0AAND.iaC2(num).BE.{.iaC1(nu
m);.iaC1(num>>0008).}#0D#0AAND.iaC3(num).BE.{.iaC1(
num);.iaC1(num>>0008);.iaC1(num>>00016).}#0D#0AAND.
iaC4(num).BE.{.iaC1(num);.iaC1(num>>0008);.iaC1(num
>>00016);.iaC1(num>>00024).}#0D#0A#0D#0AAND.get4(a)
.#3D.mc%(a).|.mc%(a+1)<<0008.|.mc%(a+2)<<00016.|.mc
%(a+3)<<00024#0D#0A#0D#0AAND.put1(a,.val).BE#0D#0A{
.db3wrf("%i5:.%x2..14--.8-bit.forward.reference*n",
.a,.val)#0D#0A..mc%(a..).:#3D.val#0D#0A}#0D#0A#0D#0A
AND.put4(a,.val).BE#0D#0A{.db3wrf("%i5:.%x2.%x2.%x2
.%x2..5--.32-bit.forward.reference*n",#0D#0A..8a,.v
al,.val>>0008,.val>>00016,.val>>00024)#0D#0A..mc%(a
..).:#3D.val#0D#0A..mc%(a+1).:#3D.val>>0008#0D#0A..
mc%(a+2).:#3D.val>>00016#0D#0A..mc%(a+3).:#3D.val>>
00024#0D#0A}#0D#0A#0D#0AAND.setrefs(p,.val).BE.WHIL
E.p.DO#0D#0A{.LET.next.#3D.!p#0D#0A..LET.pos.#3D.p!
1#0D#0A//writef("setrefs:.%n.->.[%n,.%n]*n",.p,.nex
t,.pos)#0D#0A..TEST.pos<0#0D#0A..THEN.{.//.Resolve.
short.(8-bit).forward.reference#0D#0A..7LET.rel.#3D
.val.+.pos#0D#0A..7UNLESS.-128.<#3D.rel.<#3D127.DO#0D
#0A..7{.writef("Error:.Reference.for.%n.to.%n.out.o
f.range*n",.pos,.val)#0D#0A..9LOOP#0D#0A..7}#0D#0A.
.7put1(-pos-1,.rel)#0D#0A..5}#0D#0A..ELSE.{.//.Reso
lve.a.long.(32-bit).forward.reference#0D#0A..7LET.p
.#3D.pos-4#0D#0A..7LET.newval.#3D.val.+.get4(p)#0D#0A
..7put4(p,.newval)#0D#0A..5}#0D#0A..p.:#3D.next#0D#0A
}#0D#0A#0D#0AAND.mk2(next,.val).#3D.VALOF#0D#0A{.LE
T.p.#3D.freelist#0D#0A#0D#0A..UNLESS.p.DO#0D#0A..{.
//.Allocate.a.new.block#0D#0A..2LET.blkupb.#3D.1001
#0D#0A..2LET.blk.#3D.getvec(blkupb)#0D#0A//writef("
*nmk2:.blkupb#3D%n,.blk#3D%n*n",.blkupb,.blk)#0D#0A
//abort(1001)#0D#0A..2UNLESS.blk.DO#0D#0A..2{.write
f("Error:.more.memory.needed*n")#0D#0A..4RESULTIS.0
#0D#0A..2}#0D#0A..2//.Link.it.into.the.blocklist#0D
#0A..2!blk.:#3D.blocklist#0D#0A..2blocklist.:#3D.bl
k#0D#0A//writef("blocklist#3D%n*n",.blocklist)#0D#0A
//abort(1001)#0D#0A..2//.Use.the.block.to.make.2-tu
ple.for.the.freelist#2E#0D#0A..2FOR.q.#3D.blk+1.TO.
blk+blkupb-2.BY.2.DO#0D#0A..2{.!q.:#3D.freelist#0D#0A
..4q!1.:#3D.0#0D#0A..4freelist.:#3D.q#0D#0A..2}#0D#0A
..2p.:#3D.freelist#0D#0A..}#0D#0A..//.Unlink.a.2-tu
ple.from.freelist#0D#0A..freelist.:#3D.!p#0D#0A..//
.Initialise.is.fields#0D#0A..p!0.:#3D.next#0D#0A..p
!1.:#3D.val#0D#0A//writef("*nmk2:.Created.%i5.->.[%
n,.%n]*n",.p,.next,.val)#0D#0A..RESULTIS.p#0D#0A}#0D
#0A#0D#0A//.All.ia_#2E#2E1.functions.are.defined.be
low#0D#0A#0D#0AAND.ia_j(fs,.fl,.n,.short).BE#0D#0A{
.LET.val.#3D.labv!n#0D#0A..db3codep()#0D#0A..TEST.v
al#0D#0A..THEN.{.//.Compile.a.backwards.jump.instru
ction#0D#0A..7LET.rel.#3D.val.-.codep.-.2#0D#0A..7T
EST.-128.<#3D.rel.<#3D.127.#0D#0A..7THEN.{.iaC1(fs)
#0D#0A..14iaC1(rel)#0D#0A..12}#0D#0A..7ELSE.{.IF.fl
>>0008.DO.iaC1(fl>>0008)#0D#0A..14iaC1(fl)#0D#0A..1
4iaC4(val-codep-4)..//.a.32-bit.relative.address#0D
#0A..12}#0D#0A..5}#0D#0A..ELSE.TEST.short#0D#0A..5T
HEN.{.//.Compile.an.8-bit.relative.forward.ref#0D#0A
..12iaC1(fs)#0D#0A..12iaC1(0)#0D#0A..12refv!n.:#3D.
mk2(refv!n,.-codep)#0D#0A..10}#0D#0A..5ELSE.{.//.Co
mpile.a.32-bit.relative.forward.ref#0D#0A..12IF.fl>
>0008.DO.iaC1(fl>>0008)#0D#0A..12iaC1(fl)#0D#0A..12
iaC4(-codep-4)#0D#0A..12refv!n.:#3D.mk2(refv!n,.cod
ep)#0D#0A..10}#0D#0A..db3nl()#0D#0A}#0D#0A#0D#0AAND
.ia_fno(f,.fno).BE#0D#0A{.//.Only.used.by.the.CALL.
instructtion#0D#0A..LET.fval.#3D.fnv!fno#0D#0A..db3
codep()#0D#0A..TEST.fval#0D#0A..THEN.{.//.Compile.a
.backwards.jump.instruction#0D#0A..7LET.rel32.#3D.f
val.-.codep.-.5#0D#0A..7IF.f>#3D256.DO.iaC1(f>>0008
)#0D#0A..7iaC1(f);.iaC4(rel32)..//.a.32-bit.relativ
e.address#0D#0A//writef("ia_fno:.CALL.F%n..fval#3D%
n.rel32#3D%n.codep#3D%n*n",.fno,.fval,.rel32,.codep
)#0D#0A..5}#0D#0A..ELSE.{.//.Compile.a.32-bit.relat
ive.forward.ref#0D#0A..7IF.f>#3D256.DO.iaC1(f>>0008
)#0D#0A..7iaC1(f);.iaC4(-codep-4)#0D#0A..7frefv!fno
.:#3D.mk2(frefv!fno,.codep)#0D#0A..5}#0D#0A..db3nl(
)#0D#0A}#0D#0A#0D#0AAND.ia_f(f).BE.//.eg.58+r..1--.
popl.r#0D#0A{.db3codep()#0D#0A..IF.f>#3D256.DO.iaC1
(f>>0008)#0D#0A..iaC1(f)#0D#0A..db3nl()#0D#0A}#0D#0A
#0D#0A//.ia_f{k1,k4}.functions#0D#0A#0D#0AAND.ia_fk
1(f,.k).BE.//.not.used#0D#0A{.db3codep()#0D#0A..wri
tef("ia_fk1.called*n");.abort(991)#0D#0A..IF.f>#3D2
56.DO.iaC1(f>>0008)#0D#0A..iaC1(f);.iaC1(k)#0D#0A..
db3nl()#0D#0A}#0D#0A#0D#0AAND.ia_fk4(f,.k).BE.//.eg
.05.id..--.addl.$k,%eax#0D#0A{.db3codep()#0D#0A..IF
.f>#3D256.DO.iaC1(f>>0008)#0D#0A..iaC1(f);.iaC4(k)#0D
#0A..db3nl()#0D#0A}#0D#0A#0D#0A//.ia_f<mem>.functio
ns#0D#0A#0D#0AAND.ia_fd(f,.d).BE.//.Always.32-bit.d
isplacement#0D#0A{.db3codep()#0D#0A..IF.f>#3D256.DO
.iaC1(f>>0008)#0D#0A..iaC1(f);.iaC4(d)#0D#0A..db3nl
()#0D#0A}#0D#0A#0D#0AAND.notimpl(mess).BE#0D#0A{.wr
itef(mess)#0D#0A..abort(991)#0D#0A}#0D#0A#0D#0AAND.
ia_fdx(f,.d,.x).BE.notimpl("ia_fdx.not.implemented*
n")#0D#0AAND.ia_fdxs(f,.d,.x,.s).BE.notimpl("ia_fdx
s.not.implemented*n")#0D#0AAND.ia_fdxsb(f,.d,.x,.s,
.b).BE.notimpl("ia_fdxsb.not.implemented*n")#0D#0A#0D
#0A//.ia_f<mem>r.functions#0D#0AAND.ia_fdr(f,.d,.r)
.BE.notimpl("ia_fdr.not.implemented*n")#0D#0AAND.ia
_fdxr(f,.d,.x,.r).BE.notimpl("ia_fdxr.not.implement
ed*n")#0D#0AAND.ia_fdxsr(f,.d,.x,.s,.r).BE.notimpl(
"ia_fdxsr.not.implemented*n")#0D#0AAND.ia_fdxsbr(f,
.d,.x,.s,.b,.r).BE.notimpl("ia_fdxsbr.not.implement
ed*n")#0D#0A#0D#0A#0D#0A//.ia_f<mem>k1.functions#0D
#0AAND.ia_fdk1(f,.d,.k).BE#0D#0A{.db3codep()#0D#0A.
.IF.f>#3D256.DO.iaC1(f>>0008)#0D#0A..iaC1(f);.mod00
(0,5);.iaC4(d);.iaC1(k)#0D#0A..db3nl()#0D#0A}#0D#0A
#0D#0AAND.ia_fdxk1(f,.d,.x,.k).BE#0D#0A{.db3codep()
#0D#0A..IF.f>#3D256.DO.iaC1(f>>0008)#0D#0A..iaC1(f)
#0D#0A..TEST.-128<#3Dd<#3D127#0D#0A..THEN.{.mod01(0
,x);.iaC1(d).}#0D#0A..ELSE.{.mod10(0,x);.iaC4(d).}#0D
#0A..iaC1(k)#0D#0A..db3nl()#0D#0A}#0D#0A#0D#0AAND.i
a_fdxsk1(f,.d,.x,.s,.k).BE#0D#0A{#0D#0A//writef("ia
_fdxsk4(f,.n#3D%n,.d#3D%n,.x#3D%n,.s#3D%n)*n",.n,d,
x,s)#0D#0A..IF.s#3D1.DO#0D#0A..{.ia_fdxk1(f,.d,.x,.
k).//.eg..movw.$1234,24(%ecx)#0D#0A..2RETURN#0D#0A.
.}#0D#0A#0D#0A..IF.x#3DEsp.DO#0D#0A..{.writef("Erro
r:.Cannot.scale.%%esp*n")#0D#0A..2RETURN#0D#0A..}#0D
#0A..//.s.should.be.2,.4.or.8#0D#0A..//.eg:.movb.$1
27,200(,ecx,4)#0D#0A..db3codep()#0D#0A..IF.f>#3D256
.DO.iaC1(f>>0008)#0D#0A..iaC1(f)#0D#0A..mod00(0,.4)
#0D#0A..sibss(s,.x,.5)#0D#0A..iaC4(d)#0D#0A..iaC1(k
)#0D#0A..db3nl()#0D#0A}#0D#0A#0D#0A#0D#0AAND.ia_fdx
sbk1(f,.d,.x,.s,.b,.k).BE#0D#0A{.//.s.should.be.1,.
2,.4.or.8#0D#0A..db3codep()#0D#0A..IF.f>#3D256.DO.i
aC1(f>>0008)#0D#0A..iaC1(f)#0D#0A#0D#0A..IF.d#3D0.D
O#0D#0A..{.//.eg:.movw.$1234,(%ebx,ecx,4)#0D#0A..2m
od00(0,4);.sibss(s,x,b);.iaC1(k)#0D#0A..2db3nl()#0D
#0A..2RETURN#0D#0A..}#0D#0A#0D#0A..IF.-128<#3Dd<#3D
127.DO#0D#0A..{.//.eg:.movw.$1234,20(%ebx,ecx,4)#0D
#0A..2mod01(0,4);.sibss(s,x,b);.iaC1(d);.iaC1(k)#0D
#0A..2db3nl()#0D#0A..2RETURN#0D#0A..}#0D#0A#0D#0A..
//.eg:.movw.$1234,200(%ebx,ecx,4)#0D#0A..mod10(0,.4
);.sibss(s,x,b);.iaC4(d);.iaC1(k)#0D#0A..db3nl()#0D
#0A..RETURN#0D#0A}#0D#0A#0D#0A//.ia_f<mem>k2.functi
ons#0D#0AAND.ia_fdk2(f,.d,.k).BE#0D#0A{.db3codep()#0D
#0A..IF.f>#3D256.DO.iaC1(f>>0008)#0D#0A..iaC1(f);.m
od00(0,5);.iaC4(d);.iaC2(k)#0D#0A..db3nl()#0D#0A}#0D
#0A#0D#0AAND.ia_fdxk2(f,.d,.x,.k).BE#0D#0A{.db3code
p()#0D#0A..IF.f>#3D256.DO.iaC1(f>>0008)#0D#0A..iaC1
(f)#0D#0A..TEST.-128<#3Dd<#3D127#0D#0A..THEN.{.mod0
1(0,x);.iaC1(d).}#0D#0A..ELSE.{.mod10(0,x);.iaC4(d)
.}#0D#0A..iaC2(k)#0D#0A..db3nl()#0D#0A}#0D#0A#0D#0A
#0D#0AAND.ia_fdxsk2(f,.d,.x,.s,.k).BE.//.eg..movw.$
1234,24(,%ecx,4)#0D#0A{#0D#0A//writef("ia_fdxsk4(f,
.n#3D%n,.d#3D%n,.x#3D%n,.s#3D%n)*n",.n,d,x,s)#0D#0A
..IF.s#3D1.DO#0D#0A..{.ia_fdxk2(f,.d,.x,.k).//.eg..
movw.$1234,24(%ecx)#0D#0A..2RETURN#0D#0A..}#0D#0A#0D
#0A..IF.x#3DEsp.DO#0D#0A..{.writef("Error:.Cannot.s
cale.%%esp*n")#0D#0A..2RETURN#0D#0A..}#0D#0A..//.s.
should.be.2,.4.or.8#0D#0A..//.eg:.movw.$1234,200(,e
cx,4)#0D#0A..db3codep()#0D#0A..IF.f>#3D256.DO.iaC1(
f>>0008)#0D#0A..iaC1(f)#0D#0A..mod00(0,.4)#0D#0A..s
ibss(s,.x,.5)#0D#0A..iaC4(d)#0D#0A..iaC2(k)#0D#0A..
db3nl()#0D#0A}#0D#0A#0D#0AAND.ia_fdxsbk2(f,.d,.x,.s
,.b,.k).BE.//.eg..movw.$1234,24(%ebx,%ecx,4)#0D#0A{
.//.s.should.be.1,.2,.4.or.8#0D#0A..db3codep()#0D#0A
..IF.f>#3D256.DO.iaC1(f>>0008)#0D#0A..iaC1(f)#0D#0A
#0D#0A..IF.d#3D0.DO#0D#0A..{.//.eg:.movw.$1234,(%eb
x,ecx,4)#0D#0A..2mod00(0,4);.sibss(s,x,b);.iaC2(k)#0D
#0A..2db3nl()#0D#0A..2RETURN#0D#0A..}#0D#0A#0D#0A..
IF.-128<#3Dd<#3D127.DO#0D#0A..{.//.eg:.movw.$1234,2
0(%ebx,ecx,4)#0D#0A..2mod01(0,4);.sibss(s,x,b);.iaC
1(d);.iaC2(k)#0D#0A..2db3nl()#0D#0A..2RETURN#0D#0A.
.}#0D#0A#0D#0A..//.eg:.movw.$1234,200(%ebx,ecx,4)#0D
#0A..mod10(0,.4);.sibss(s,x,b);.iaC4(d);.iaC2(k)#0D
#0A..db3nl()#0D#0A..RETURN#0D#0A}#0D#0A#0D#0A//.ia_
f<mem>k4.functions#0D#0AAND.ia_fdk4(f,.d,.k).BE#0D#0A
{.db3codep()#0D#0A..IF.f>#3D256.DO.iaC1(f>>0008)#0D
#0A..iaC1(f);.mod00(0,5);.iaC4(d);.iaC4(k)#0D#0A..d
b3nl()#0D#0A}#0D#0A#0D#0AAND.ia_fdxk4(f,.d,.x,.k).B
E#0D#0A{.db3codep()#0D#0A..IF.f>#3D256.DO.iaC1(f>>0
008)#0D#0A..iaC1(f)#0D#0A..TEST.-128<#3Dd<#3D127#0D
#0A..THEN.{.mod01(0,x);.iaC1(d).}#0D#0A..ELSE.{.mod
10(0,x);.iaC4(d).}#0D#0A..iaC4(k)#0D#0A..db3nl()#0D
#0A}#0D#0A#0D#0A#0D#0AAND.ia_fdxsk4(f,.d,.x,.s,.k).
BE.//.eg..movl.$1234,24(,%ecx,4)#0D#0A{#0D#0A//writ
ef("ia_fdxsk4(f,.n#3D%n,.d#3D%n,.x#3D%n,.s#3D%n)*n"
,.n,d,x,s)#0D#0A..IF.s#3D1.DO#0D#0A..{.ia_fdxk4(f,.
d,.x,.k).//.eg..movl.$1234,24(%ecx)#0D#0A..2RETURN#0D
#0A..}#0D#0A#0D#0A..IF.x#3DEsp.DO#0D#0A..{.writef("
Error:.Cannot.scale.%%esp*n")#0D#0A..2RETURN#0D#0A.
.}#0D#0A..//.s.should.be.2,.4.or.8#0D#0A..//.eg:.mo
vl.$1234,200(,ecx,4)#0D#0A..db3codep()#0D#0A..IF.f>
#3D256.DO.iaC1(f>>0008)#0D#0A..iaC1(f)#0D#0A..mod00
(0,.4)#0D#0A..sibss(s,.x,.5)#0D#0A..iaC4(d)#0D#0A..
iaC4(k)#0D#0A..db3nl()#0D#0A}#0D#0A#0D#0AAND.ia_fdx
sbk4(f,.d,.x,.s,.b,.k).BE.//.eg..movl.$1234,24(%ebx
,%ecx,4)#0D#0A{.//.s.should.be.1,.2,.4.or.8#0D#0A..
db3codep()#0D#0A..IF.f>#3D256.DO.iaC1(f>>0008)#0D#0A
..iaC1(f)#0D#0A#0D#0A..IF.d#3D0.DO#0D#0A..{.//.eg:.
movl.$1234,(%ebx,ecx,4)#0D#0A..2mod00(0,4);.sibss(s
,x,b);.iaC4(k)#0D#0A..2db3nl()#0D#0A..2RETURN#0D#0A
..}#0D#0A#0D#0A..IF.-128<#3Dd<#3D127.DO#0D#0A..{.//
.eg:.movl.$1234,20(%ebx,ecx,4)#0D#0A..2mod01(0,4);.
sibss(s,x,b);.iaC1(d);.iaC4(k)#0D#0A..2db3nl()#0D#0A
..2RETURN#0D#0A..}#0D#0A#0D#0A..//.eg:.movl.$1234,2
00(%ebx,ecx,4)#0D#0A..mod10(0,.4);.sibss(s,x,b);.ia
C4(d);.iaC4(k)#0D#0A..db3nl()#0D#0A..RETURN#0D#0A}#0D
#0A#0D#0A//.Below.are.all.the.ia_fn#2E#2E1.function
s#0D#0A#0D#0A//.ia_fn{k1,k4}.functions#0D#0AAND.ia_
fnk1(f,.n,.k).BE.//.not.used#0D#0A{.db3codep()#0D#0A
..writef("ia_fnk1.called*n");.abort(991)#0D#0A..IF.
f>#3D256.DO.iaC1(f>>0008)#0D#0A..iaC1(f);.mod11(n,.
003);.iaC1(k)#0D#0A..db3nl()#0D#0A}#0D#0A#0D#0AAND.
ia_fnk4(f,.n,.k).BE.//.eg.81./0.id..1--.addl.k,r#0D
#0A{.db3codep()#0D#0A..writef("ia_fnk4.called*n");.
abort(991)#0D#0A..IF.f>#3D256.DO.iaC1(f>>0008)#0D#0A
..iaC1(f);.mod11(n,.003);.iaC4(k)#0D#0A..db3nl()#0D
#0A}#0D#0A#0D#0A//.ia_fn{r,rk1,rk4}.functions#0D#0A
AND.ia_fnr(f,.n,.r).BE.//.eg.F7./3..1--.negl.r#0D#0A
..21//.or.8B./r..1--.movl.n,r#0D#0A{.db3codep()#0D#0A
..IF.f>>0008.DO.iaC1(f>>0008)#0D#0A..iaC1(f);.mod11
(n,.r)#0D#0A..db3nl()#0D#0A//abort(112)#0D#0A}#0D#0A
#0D#0AAND.ia_fnrk1(f,.n,.r,.k).BE.//.eg.83./0.ib..1
--.addl.k,r#0D#0A{.db3codep()#0D#0A..IF.f>#3D256.DO
.iaC1(f>>0008)#0D#0A..iaC1(f);.mod11(n,.r);.iaC1(k)
#0D#0A..db3nl()#0D#0A}#0D#0A#0D#0AAND.ia_fnrk4(f,.n
,.r,.k).BE.//.eg.81./0.id..1--.addl.k,r#0D#0A{.db3c
odep()#0D#0A..IF.f>#3D256.DO.iaC1(f>>0008)#0D#0A..i
aC1(f);.mod11(n,.r);.iaC4(k)#0D#0A..db3nl()#0D#0A}#0D
#0A#0D#0A#0D#0A//.ia_fn<mem>.functions#0D#0AAND.ia_
fnd(f,.n,.d).BE..//.Always.a.32-bit.displacement#0D
#0A{.db3codep()#0D#0A..IF.f>#3D256.DO.iaC1(f>>0008)
#0D#0A..iaC1(f)#0D#0A..mod00(n,.5)#0D#0A..iaC4(d)#0D
#0A..db3nl()#0D#0A}#0D#0A#0D#0A#0D#0AAND.ia_fndx(f,
.n,.d,.x).BE.//.eg.F7./3..1--.negl..1d(x)#0D#0A..25
//.or.8B./n..1--.movl.n,d(x)#0D#0A{.db3codep()#0D#0A
..IF.f>#3D256.DO.iaC1(f>>0008)#0D#0A..iaC1(f)#0D#0A
..IF.d#3D0.&.x~#3DEbp.DO#0D#0A..{.TEST.x#3DEsp#0D#0A
..2THEN.{.mod00(n,.4)..3//.eg:.negl.(%esp)..or..1mo
vl.(%esp),n#0D#0A..9sib00(4,.Esp)#0D#0A..7}#0D#0A..
2ELSE.{.mod00(n,.x)..3//.eg:.negl.(x)..or..1movl.(x
),n#0D#0A..7}#0D#0A..2db3nl()#0D#0A..2RETURN#0D#0A.
.}#0D#0A..IF.-128<#3Dd<#3D127.DO#0D#0A..{.TEST.x#3D
Esp#0D#0A..2THEN.{.mod00(n,.4)#0D#0A..9sib00(4,.Esp
).#0D#0A..7}#0D#0A..2ELSE.{.mod01(n,.x)..3//.eg:.ne
gl.disp8(x)..or..1movl.disp8(x),n#0D#0A..7}#0D#0A..
2iaC1(d)#0D#0A..2db3nl()#0D#0A..2RETURN#0D#0A..}#0D
#0A..TEST.x#3DEsp#0D#0A..THEN.{.mod10(n,.4)..3//.eg
:.negl.disp32(%esp)..or..1movl.disp32(%esp),n#0D#0A
..7sib00(4,.Esp)#0D#0A..5}#0D#0A..ELSE.{.mod10(n,.x
)..3//.eg:.negl.disp32(x)..or..1movl.disp32(x),n#0D
#0A..5}#0D#0A..iaC4(d)#0D#0A..db3nl()#0D#0A..RETURN
#0D#0A.}#0D#0A#0D#0AAND.ia_fndxs(f,.n,.d,.x,.s).BE.
//.negl.20(,%ebx,4)#0D#0A..29//.movl.(,%exb,4),.%ea
x#0D#0A{#0D#0A//writef("ia_fndxs(f,.n#3D%n,.d#3D%n,
.x#3D%n,.s#3D%n)*n",.n,d,x,s)#0D#0A..IF.s#3D1.DO#0D
#0A..{.ia_fndx(f,.n,.d,.x)#0D#0A..2RETURN#0D#0A..}#0D
#0A#0D#0A..IF.x#3DEsp.DO#0D#0A..{.writef("Error:.Ca
nnot.scale.%%esp*n")#0D#0A..2RETURN#0D#0A..}#0D#0A.
.//.s.should.be.2,.4.or.8#0D#0A..//.eg:.movl.200(,e
cx,4),%eax#0D#0A..db3codep()#0D#0A..IF.f>#3D256.DO.
iaC1(f>>0008)#0D#0A..iaC1(f)#0D#0A..mod00(n,.4)#0D#0A
..sibss(s,.x,.5)#0D#0A..iaC4(d)#0D#0A..db3nl()#0D#0A
}#0D#0A#0D#0AAND.ia_fndxsb(f,.n,.d,.x,.s,.b).BE.//.
negl.20(%edx,%ebx,4)#0D#0A..33//.movl.(%edx,%exb,4)
,.%eax#0D#0A{.//.s.should.be.1,.2,.4.or.8#0D#0A..db
3codep()#0D#0A..IF.f>#3D256.DO.iaC1(f>>0008)#0D#0A.
.iaC1(f)#0D#0A#0D#0A..IF.d#3D0.DO#0D#0A..{.//.eg:.m
ovl.(%ebx,ecx,4),%eax#0D#0A..2mod00(n,4);.sibss(s,x
,b)#0D#0A..2db3nl()#0D#0A..2RETURN#0D#0A..}#0D#0A#0D
#0A..IF.-128<#3Dd<#3D127.DO#0D#0A..{.//.eg:.movl.20
(%ebx,ecx,4),%eax#0D#0A..2mod01(n,4);.sibss(s,x,b);
.iaC1(d)#0D#0A..2db3nl()#0D#0A..2RETURN#0D#0A..}#0D
#0A#0D#0A..//.eg:.movl.200(%ebx,ecx,4),%eax#0D#0A..
mod10(n,.4);.sibss(s,x,b);.iaC4(d)#0D#0A..db3nl()#0D
#0A..RETURN#0D#0A}#0D#0A#0D#0A//.ia_fn<mem>r.functi
ons#0D#0AAND.ia_fndr(f,.n,.d,.x,.s,.b,.k).BE.notimp
l("ia_fndr.not.implemented*n")#0D#0AAND.ia_fndxr(f,
.n,.d,.x,.s,.b,.k).BE.notimpl("ia_fndxr.not.impleme
nted*n")#0D#0AAND.ia_fndxsr(f,.n,.d,.x,.s,.b,.k).BE
.notimpl("ia_fndxsr.not.implemented*n")#0D#0AAND.ia
_fndxsbr(f,.n,.d,.x,.s,.b,.k).BE.notimpl("ia_fndxsb
r.not.implemented*n")#0D#0A#0D#0A//.ia_fn<mem>k1.fu
nctions#0D#0AAND.ia_fndk1(f,.n,.d,.k).BE#0D#0A{.db3
codep()#0D#0A..IF.f>#3D256.DO.iaC1(f>>0008)#0D#0A..
iaC1(f);.mod00(n,5);.iaC4(d);.iaC1(k)#0D#0A..db3nl(
)#0D#0A}#0D#0A#0D#0AAND.ia_fndxk1(f,.n,.d,.x,.k).BE
#0D#0A{.db3codep()#0D#0A..IF.f>#3D256.DO.iaC1(f>>00
08)#0D#0A..iaC1(f)#0D#0A..TEST.-128<#3Dd<#3D127#0D#0A
..THEN.{.mod01(n,x);.iaC1(d).}#0D#0A..ELSE.{.mod10(
n,x);.iaC4(d).}#0D#0A..iaC1(k)#0D#0A..db3nl()#0D#0A
}#0D#0A#0D#0AAND.ia_fndxsk1(f,.n,.d,.x,.s,.k).BE#0D
#0A{.db3codep()#0D#0A..IF.f>#3D256.DO.iaC1(f>>0008)
#0D#0A..iaC1(f)#0D#0A..//TEST.-128<#3Dd<#3D127#0D#0A
..//THEN.{.mod01(n,4);.sibss(s,x,5);.iaC1(d).}#0D#0A
..//ELSE.{.mod10(n,4);.sibss(s,x,5);.iaC4(d).}#0D#0A
..mod00(n,4);.sibss(s,x,5);.iaC4(d)#0D#0A..iaC1(k)#0D
#0A..db3nl()#0D#0A}#0D#0A#0D#0AAND.ia_fndxsbk1(f,.n
,.d,.x,.s,.b,.k).BE#0D#0A{.db3codep()#0D#0A..IF.f>#3D
256.DO.iaC1(f>>0008)#0D#0A..iaC1(f)#0D#0A..TEST.d#3D
0#0D#0A..THEN.{.mod00(n,4);.sibss(s,x,b);.iaC1(k).}
#0D#0A..ELSE.TEST.-127<#3Dd<127#0D#0A..5THEN.{.mod0
1(n,4);.sibss(s,x,b);.iaC1(d);.iaC1(k).}#0D#0A..5EL
SE.{.mod10(n,4);.sibss(s,x,b);.iaC4(d);.iaC1(k).}#0D
#0A..db3nl()#0D#0A}#0D#0A#0D#0A//.ia_fn<mem>k4.func
tions#0D#0AAND.ia_fndk4(f,.n,.d,.k).BE#0D#0A{.db3co
dep()#0D#0A..IF.f>#3D256.DO.iaC1(f>>0008)#0D#0A..ia
C1(f);.mod00(n,5);.iaC4(d);.iaC4(k)#0D#0A..db3nl()#0D
#0A}#0D#0A#0D#0AAND.ia_fndxk4(f,.n,.d,.x,.k).BE#0D#0A
{.db3codep()#0D#0A..IF.f>#3D256.DO.iaC1(f>>0008)#0D
#0A..iaC1(f)#0D#0A..TEST.-128<#3Dd<#3D127#0D#0A..TH
EN.{.mod01(n,x);.iaC1(d).}#0D#0A..ELSE.{.mod10(n,x)
;.iaC4(d).}#0D#0A..iaC4(k)#0D#0A..db3nl()#0D#0A}#0D
#0A#0D#0AAND.ia_fndxsk4(f,.n,.d,.x,.s,.k).BE#0D#0A{
.db3codep()#0D#0A..IF.f>#3D256.DO.iaC1(f>>0008)#0D#0A
..iaC1(f)#0D#0A..//TEST.-128<#3Dd<#3D127#0D#0A..//T
HEN.{.mod01(n,4);.sibss(s,x,5);.iaC1(d).}#0D#0A..//
ELSE.{.mod10(n,4);.sibss(s,x,5);.iaC4(d).}#0D#0A..m
od00(n,4);.sibss(s,x,5);.iaC4(d)#0D#0A..iaC4(k)#0D#0A
..db3nl()#0D#0A}#0D#0A#0D#0AAND.ia_fndxsbk4(f,.n,.d
,.x,.s,.b,.k).BE#0D#0A{.db3codep()#0D#0A..IF.f>#3D2
56.DO.iaC1(f>>0008)#0D#0A..iaC1(f)#0D#0A..TEST.-128
<#3Dd<#3D127#0D#0A..THEN.{.mod01(n,4);.sibss(s,x,b)
;.iaC1(d).}#0D#0A..ELSE.{.mod10(n,4);.sibss(s,x,b);
.iaC4(d).}#0D#0A..iaC4(k)#0D#0A..db3nl()#0D#0A}#0D#0A
#0D#0A

######com/mcpl2mial.b#
/*#0AMCPL.to.MIAL.(MCPL.Internal.Assembly.Language)
.compiler#0Afor.compilation.into.native.code.using,
.for.example,.mial386#2E#0A#0ACopyright:.Martin.Ric
hards.16.June.1990007#0A#0A1It.is.based.on.the.MCPL
.to.MINTCODE.and.the.BCPL.to.SIAL.compilers#2E#0A#0A
It.uses.a.reverse.polish.form.of.MCODE#2E#0A#0ADeve
lopment.of.this.compiler.started.on.2.Nov.1990002#0A
This.version.is.designed.to.run.interpretively.usin
g.MINTCODE,#0Aand.is.similar.in.structure.to.the.BC
PL.Cintcode.system#2E#0AThe.GLOBAL.declaration.has.
been.put.back.into.the.MCPL.and#0Athe.syntax.of.EXT
ERNAL.declarations.has.been.retained.but.not#0Aimpl
emented#2E#0A#0A0009/7/97..Separate.mcplsyn#2Eb.and
.mcpltrn#2Eb.from.mcpl2mial#2Eb#0A..6so.that.they.c
an.be.shared.with.the.mcpl->mintcode.compiler#2E#0A
*/#0A#0ASECTION."SYN"#0A#0AGLOBAL.{#0A//General.Int
erface#0Aerrcount:600;.errmax:601;.fin_p:602;.fin_l
:603#0Asourcestream:604;.sysprint:605;.mcodeout:606
#0Atreep:607;.treevec:608;.findfilename:609#0A#0A//
Syn.interface#0Achbuf:610;.ch:611;.chcount:612;.lin
eno:613#0Arch:614;.findfileno:615;.filelist:616;.fr
eefilelist:617#0Aformtree:618;.plist:619#0A}#0A#0AG
ET."com/mcplsyn#2Eb"#0A#2E#0A#0A1SECTION."TRN"#0A#0A
GLOBAL.{#0A//General.Interface#0Aerrcount:600;.errm
ax:601;.fin_p:602;.fin_l:603#0Asourcestream:604;.sy
sprint:605;.mcodeout:606#0Atreep:607;.treevec:608;.
findfilename:609#0A#0A//.Trn.interface#0Atranslate:
620#0A}#0A#0AGET."com/mcpltrn#2Eb"#0A#2E#0A#0A1SECT
ION."MCPL2MIAL"#0A#0AGET."libhdr"#0A#0AGLOBAL.{#0A/
/General.Interface#0Aerrcount:600;.errmax:601;.fin_
p:602;.fin_l:603#0Asourcestream:604;.sysprint:605;.
mcodeout:606#0Atreep:607;.treevec:608;.findfilename
:609#0A#0A//Syn.interface#0Achbuf:610;.ch:611;.chco
unt:612;.lineno:613#0Arch:614;.findfileno:615;.file
list:616;.freefilelist:617#0Aformtree:618;.plist:61
9#0A#0A//.Trn.interface#0Atranslate:620#0A#0A//.Cg.
interface#0Amcodein:630;.tostream:.631#0Acodegenera
te:.632#0A}#0A#0ALET.start().#3D.VALOF#0A{..LET.tre
esize.#3D.2003#0A..1AND.argv.#3D.VEC.50#0A..1AND.ar
gform.#3D#0A..1"FROM/A,TO/K,VER/K,TREE/S,D1/S,D2/S,
OENDER/S,"#0A..1LET.debug,.prtree,.bigender.#3D.0,.
FALSE,.?#0A..1LET.stdout.#3D.output()#0A#0A..1syspr
int.:#3D.stdout#0A..1selectoutput(sysprint)#0A#0A..
1writef("*nMCPL2MIAL.8.July.1990007*n")#0A#0A..1IF.
rdargs(argform,.argv,.50)#3D0.DO.{..writes("Bad.arg
uments*n")#0A..38RESULTIS.20#0A..35}#0A#0A..1fin_p,
.fin_l.:#3D.level(),.fin#0A..1errmax..5:#3D.30#0A..
1errcount..3:#3D.0#0A..1treevec..4:#3D.0#0A..1sourc
estream.:#3D.0#0A..1mcodeout..3:#3D.0#0A..1mcodein.
.4:#3D.0#0A..1tostream..3:#3D.0#0A..1filelist..3:#3D
.0#0A#0A..1prtree.:#3D.argv!3#0A#0A..1//.Code.gener
ator.options#0A#0A..1bigender.:#3D.(!"AA1".&.255).#3D
.'A'.//.#3DTRUE.if.running.on.a.bigender#0A..1IF.ar
gv!4.DO.debug..2:#3D.debug+1..5//.D1#0A..1IF.argv!5
.DO.debug..2:#3D.debug+2..5//.D2#0A..1IF.argv!6.DO.
bigender.:#3D.~bigender..3//.OENDER#0A#0A..1sources
tream.:#3D.findinput(argv!0)..4//.FROM#0A#0A..1IF.s
ourcestream#3D0.DO.{..writef("Trouble.with.FROM.fil
e.%s*n",.argv!0)#0A..25errcount.:#3D.1#0A..25GOTO.f
in#0A..22}#0A#0A..1selectinput(sourcestream)#0A#0A.
.1mcodeout.:#3D.findoutput("MCODE")#0A#0A..1IF.mcod
eout#3D0.DO.{..writes("Trouble.with.file.MCODE*n")#0A
..21errcount.:#3D.1#0A..21GOTO.fin#0A..18}#0A#0A..1
treevec.:#3D.getvec(treesize)#0A#0A..1IF.treevec#3D
0.DO.{..writes("Insufficient.memory*n")#0A..20errco
unt.:#3D.1#0A..20GOTO.fin#0A..17}#0A#0A..1UNLESS.ar
gv!2#3D0.DO..5//.VER#0A..1{..sysprint.:#3D.findoutp
ut(argv!2)#0A..4IF.sysprint#3D0.DO#0A..4{..sysprint
.:#3D.stdout#0A..7writef("Trouble.with.VER.file.%s*
n",.argv!2)#0A..7errcount.:#3D.1#0A..7GOTO.fin#0A..
4}#0A..1}#0A#0A..1selectoutput(sysprint)#0A#0A..1{.
.LET.b.#3D.VEC.64/bytesperword#0A..4chbuf.:#3D.b#0A
..4FOR.i.#3D.0.TO.63.DO.chbuf%i.:#3D.0#0A..4chcount
,.lineno.:#3D.0,.findfileno(argv!0)<<00024.|.1#0A..
4rch()#0A#0A..4UNTIL.ch#3Dendstreamch.DO#0A..4{..LE
T.tree.#3D.?#0A..7treep.:#3D.treevec.+.treesize#0A#0A
..7tree.:#3D.formtree()#0A..7IF.tree#3D0.BREAK#0A#0A
..7writef("*nTree.size.%n*n",.treesize+treevec-tree
p)#0A#0A..7IF.prtree.DO.{..writes("Parse.Tree*n")#0A
..23plist(tree,.0,.20)#0A..23newline()#0A..20}#0A#0A
..7UNLESS.errcount#3D0.GOTO.fin#0A..7selectoutput(m
codeout)#0A..7translate(tree)#0A..7selectoutput(sys
print)#0A..4}#0A..1}#0A#0A..1selectinput(sourcestre
am);..endread();..1sourcestream.:#3D.0#0A..1selecto
utput(mcodeout);..3endwrite();..mcodeout..3:#3D.0#0A
#0A..1selectoutput(sysprint)#0A#0A..1UNLESS.errcoun
t#3D0.GOTO.fin#0A#0A..1mcodein.:#3D.findinput("MCOD
E")#0A..1IF.mcodein#3D0.DO#0A..1{..writef("Trouble.
reading.file.MCODE*n")#0A..4errcount.:#3D.1#0A..4GO
TO.fin#0A..1}#0A#0A..1IF.argv!1#3D0.DO.argv!1.:#3D.
"MIAL"#0A#0A..1tostream.:#3D.findoutput(argv!1)#0A.
.1IF.tostream#3D0.DO#0A..1{..writef("Trouble.with.c
ode.file.%s*n",.argv!1)#0A..4errcount.:#3D.1#0A..4G
OTO.fin#0A..1}#0A#0A..1selectinput(mcodein)#0A..1co
degenerate(treevec,.treesize,.debug,.bigender)#0A#0A
..1selectoutput(sysprint)#0A#0Afin:#0A..1UNLESS.tre
evec#3D0..5DO.freevec(treevec)#0A..1UNLESS.sourcest
ream#3D0..DO.{..selectinput(sourcestream);.endread(
)..}#0A..1UNLESS.mcodeout#3D0..4DO.{..selectoutput(
mcodeout);..2endwrite().}#0A..1UNLESS.mcodein#3D0..
5DO.{..selectinput(mcodein);..4endread()..}#0A..1UN
LESS.tostream#3D0..4DO.{..selectoutput(tostream)#0A
..30UNLESS.tostream#3Dstdout.DO..endwrite().}#0A..1
UNLESS.sysprint#3Dstdout.DO.{..selectoutput(sysprin
t);..2endwrite().}#0A..1freefilelist(filelist)#0A..
1selectoutput(stdout)#0A..1UNLESS.errcount#3D0.RESU
LTIS.20#0A..1RESULTIS.0#0A}#0A#0A//.Start.of.the.MC
ODE->MIAL.Codegenerator#0A#0AGET."libhdr"#0A#0AMANI
FEST.{#0A//.Object.module.item.types#2E#0At_hunk..#3D
.2001..5//.hunk..1n..w1.#2E#2E1.wn#0At_reloc.#3D.20
00001..5//.reloc..n..a1.#2E#2E1.an#0At_end..1#3D.20
00002..5//.end#0A#0Amodword..1#3D.#23xFDDF..1//.MOD
ULE.and.Entry.marker.words#2E#0Aentryword.#3D.#23xD
FDF#0A#0A..13//.MCODE.operators#0As_ln#3D1#0As_true
#3D5#0As_false#3D6#0As_query#3D7#0A#0As_lp#3D10#0As
_lg#3D11#0A#0As_llp#3D13#0As_llg#3D14#0A#0As_sp#3D1
6#0As_sg#3D17#0As_lf#3D18#0As_lx#3D19#0A#0As_neg#3D
21#0As_abs#3D22#0As_not#3D23#0As_bitnot#3D24#0A#0As
_callc#3D29#0As_call#3D30#0As_indw#3D31#0As_indw0#3D
32#0As_indb#3D33#0As_indb0#3D34#0As_lsh#3D35..//.sa
me.order.as.op:#3D.operators#0As_rsh#3D36#0As_mult#3D
37#0As_div#3D38#0As_mod#3D39#0As_bitand#3D40#0As_xo
r#3D41#0As_plus#3D42#0As_sub#3D43#0As_bitor#3D44#0A
#0As_eq#3D45#0As_ne#3D46#0As_le#3D47#0As_ge#3D48#0A
s_ls#3D49#0As_gr#3D50#0As_rel#3D51#0A#0As_ptr#3D59#0A
s_ll#3D60#0As_ll1#3D61#0As_sl#3D62#0As_lpath#3D63#0A
s_llpath#3D64#0As_spath#3D65#0As_stw#3D66#0As_stb#3D
67#0As_lvindw#3D68#0As_cpr#3D69#0A#0As_jt#3D70#0As_
jf#3D71#0As_lab#3D72#0As_stack#3D73#0A#0As_dup#3D79
#0As_lr#3D80#0As_str#3D81#0As_jump#3D82#0As_dlab#3D
83#0As_dw#3D84#0As_db#3D85#0As_dl#3D86#0As_ds#3D87#0A
#0As_inc1b#3D90#0As_inc4b#3D91#0As_dec1b#3D92#0As_d
ec4b#3D93#0As_inc1a#3D94#0As_inc4a#3D95#0As_dec1a#3D
96#0As_dec4a#3D97#0A#0As_goto#3D103#0As_raise#3D104
#0As_handle#3D105#0A#0As_match#3D120#0As_return#3D1
24#0A#0As_module#3D145#0As_endmodule#3D146#0A#0As_g
lobal#3D150#0As_fun#3D151#0As_cfun#3D152#0As_endfun
#3D153#0As_unhandle#3D156#0As_line#3D157#0As_file#3D
158#0As_setargs#3D159#0As_fnargs#3D160#0As_locs#3D1
61#0A#0As_none#3D200#0A#0A..11//..Selectors#0Ah1#3D
0;.h2#3D1;.h3#3D2;.h4#3D3#0A#0Ahashtabsize#3D63#0A}
#0A#0AGLOBAL.{#0Acgmodules..1:.401#0Ardn..7:.402#0A
rdl..7:.403#0Ardgn..6:.404#0Ardstr..5:.405#0Anewlab
..4:.406#0Achecklab..2:.407#0Acgerror..3:.408#0A#0A
initstack..1:.410#0Astack..5:.411#0Astore..5:.412#0A
scan..6:.413#0Acgpendingop.:.414#0A#0Aloadba..4:.41
6#0Asetba..5:.417#0A#0Agenxch..4:.420#0Agenatb..4:.
421#0A#0Aloada..5:.422#0Apush..6:.423#0Aloadboth..2
:.424#0Ainreg_a..3:.425#0Ainreg_b..3:.426#0Aaddinfo
_a..1:.427#0Aaddinfo_b..1:.428#0Apushinfo..2:.429#0A
xchinfo..3:.430#0Aatbinfo..3:.431#0Abtainfo..3:.432
#0A#0Aforget_a..2:.435#0Aforget_b..2:.436#0Aforgeta
ll..1:.437#0Aforgetvar..1:.438#0Aforgetallvars:.439
#0A#0Aiszero..4:.440000#0Astoret..4:.440001#0Astore
shared.:.440002#0A#0Aloadt..5:.440003#0Alose1..5:.4
41#0Aswapargs..2:.440005#0Acgstw..5:.440006#0Astore
in..3:.440007#0Acgindw0..3:.440008#0A#0Acginc..5:.4
40009#0Acgplus..4:.450#0Acgaddk..4:.451#0Acgglobal.
.2:.452#0Acgentry..3:.453#0Acgcall..4:.455#0Acgjump
..4:.457#0A#0Ajmpfn..5:.458#0Ajfn0..6:.459#0Arevjfn
..4:.460#0Acompjfn..3:.461#0Aprepj..5:.462#0Acgrais
e..3:.463#0A#0Acgstatics..1:.477#0Agetblk..4:.478#0A
freeblk..3:.479#0Afreeblks..2:.480#0A#0Ainitdatalis
ts.:.481#0A#0Agenfp..5:.500#0Agenfkp..4:.501#0Agenf
kp..4:.502#0Agenfg..5:.503#0Agenfkg..4:.504#0Agenfp
g..4:.505#0Agenfk..5:.506#0Agenfw..5:.507#0Agenfl..
5:.508#0Agenflk..4:.509#0Agenfkl..4:.510#0Agenfm..5
:.511#0Agenfmw..4:.512#0A#0Agenf..6:.520#0Ageng..6:
.521#0Agenc..6:.522#0Agenk..6:.523#0Agenw..6:.524#0A
genl..6:.525#0A#0Acgrelop..3:.530#0A#0Acheckspace..
:.531#0A#0Adboutput..2:.540#0Awrkn..6:.541#0Awrcode
..4:.542#0A#0A//.Global.variables#2E#0Aprocdepth..1
:.550000#0A#0Assp..7:.550001#0Atempt..5:.550002#0At
empv..5:.550003#0A#0Aarg1..6:.550004#0Aarg2..6:.551
#0Adebug..5:.550006#0Abigender..2:.550007#0A#0Ach..
8:.560#0Aop..8:.561#0Apendingop..1:.562#0Amlabnumbe
r..:.563#0Aincode..4:.565#0A#0Alineno..4:.570#0Apro
gsize..2:.571#0Amaxgn..5:.572#0Amaxssp..4:.573#0A#0A
info_a..4:.575#0Ainfo_b..4:.576#0A#0Aclist..5:.580#0A
cliste..4:.581#0A#0Adpbase..4:.590#0Adp..8:.591#0Af
reelist..2:.592#0A#0Ahashtab..3:.595#0Acharv..5:.59
6#0Alookup..4:.597#0Anewvec..4:.598#0A}#0A#0A1MANIF
EST#0A{#0A//.Value.descriptors#2E#0Ak_none#3D0#0Ak_
numb#3D1..1//.numbers.in.the.range.-#23xFF4.to.#23x
FF4#0Ak_lw#3D2..3//.label.addressing.larger.constan
ts#0Ak_fnlab#3D3#0Ak_lvloc#3D4;.k_lvglob#3D5;.k_lvl
ab#3D6;#0Ak_a#3D8;.k_b#3D9;.k_c#3D10#0A#0Ak_ext#3D1
1#0Ak_loc#3D12;.k_glob#3D13;.k_lab#3D14;#0A#0Ak_loc
i#3D15;..k_lvloci#3D16..2//..<27-bits>.loci..2ie.P!
<27-bits>!n#0Ak_globi#3D17;.k_lvglobi#3D18..1//..<2
7-bits>.globi..1ie.G!<27-bits>!n#0Ak_labi#3D19;..k_
lvlabi#3D20..2//..<27-bits>.labi..2ie.L<27-bits>!n#0A
#0Aswapped#3DTRUE;.notswapped#3DFALSE#0A}#0A#0AMANI
FEST.{#0A//.MIAL.op.codes.and.directives#0A#0Af_lp#3D
..0041#0Af_lg#3D..0042#0Af_ll#3D..0043#0A#0Af_llp#3D
..0034#0Af_llg#3D..0035#0Af_ll1#3D..0036#0Af_lf#3D.
.0047#0Af_lw#3D..0048#0A#0Af_l#3D..00410#0Af_lm#3D.
.00311#0A#0Af_sp#3D..00312#0Af_sg#3D..00313#0Af_sl#3D
..00314#0A#0Af_ap#3D..00315#0Af_ag#3D..00316#0Af_a#3D
..00417#0Af_s#3D..00418#0A#0Af_lkp#3D..00220#0Af_lk
g#3D..00221#0Af_rv#3D..00322#0Af_rvp#3D..00223#0Af_
rvk#3D..00224#0Af_st#3D..00325#0Af_stp#3D..00226#0A
f_stk#3D..00227#0Af_stkp#3D..00128#0Af_stkg#3D..001
29#0Af_xst#3D..00230#0A#0Af_stb#3D..00231#0Af_lvind
#3D..00032#0Af_indb#3D..00133#0Af_indb0#3D..00034#0A
f_indw#3D..00135#0A#0Af_k#3D..00436#0Af_kpg#3D..002
37#0A#0Af_neg#3D..00238#0Af_not#3D..00239#0Af_abs#3D
..00240#0A#0Af_xdiv#3D..00141#0Af_xmod#3D..00142#0A
f_xsub#3D..00143#0A#0Af_mul#3D..00245#0Af_div#3D..0
0246#0Af_mod#3D..00247#0Af_add#3D..00248#0Af_sub#3D
..00249#0A#0Af_eq#3D..00350#0Af_ne#3D..00351#0Af_ls
#3D..00352#0Af_gr#3D..00353#0Af_le#3D..00354#0Af_ge
#3D..00355#0Af_eq0#3D..00256#0Af_ne0#3D..00257#0Af_
ls0#3D..00258#0Af_gr0#3D..00259#0Af_le0#3D..00260#0A
f_ge0#3D..00261#0A#0Af_lsh#3D..00265#0Af_rsh#3D..00
266#0Af_and#3D..00267#0Af_or#3D..00368#0Af_xor#3D..
00269#0Af_lshk#3D..00170#0Af_rshk#3D..00171#0A#0Af_
xch#3D..00280#0Af_atb#3D..00281#0Af_atc#3D..00282#0A
f_bta#3D..00283#0Af_btc#3D..00284#0Af_cta#3D..00285
#0Af_atblp#3D..00086#0Af_atblg#3D..00087#0Af_atbll#3D
..00088#0Af_atbl#3D..00189#0A#0Af_j#3D..00490#0Af_r
tn#3D..00291#0A#0Af_ikp#3D..00293#0Af_ikg#3D..00294
#0Af_ikl#3D..00295#0Af_ip#3D..00396#0Af_ig#3D..0039
7#0Af_il#3D..00398#0A#0Af_jeq#3D..002100#0Af_jne#3D
..002101#0Af_jls#3D..002102#0Af_jgr#3D..002103#0Af_
jle#3D..002104#0Af_jge#3D..002105#0Af_jeq0#3D..0011
06#0Af_jne0#3D..001107#0Af_jls0#3D..001108#0Af_jgr0
#3D..001109#0Af_jle0#3D..001110000#0Af_jge0#3D..001
111#0A#0Af_brk#3D..002120#0Af_nop#3D..002121#0Af_ch
gco#3D..000122#0Af_mdiv#3D..001123#0Af_sys#3D..0021
24#0A#0Af_inc1b#3D..000130#0Af_inc4b#3D..000131#0Af
_dec1b#3D..000132#0Af_dec4b#3D..000133#0Af_inc1a#3D
..000134#0Af_inc4a#3D..000135#0Af_dec1a#3D..000136#0A
f_dec4a#3D..000137#0A#0Af_hand.#3D..000140#0Af_unh.
.#3D..000141#0Af_raise#3D..000142#0A#0Af_module#3D.
.001150#0Af_modstart#3D.151#0Af_modend#3D..001152#0A
f_global#3D..001153#0A#0Af_const#3D..002155#0A#0Af_
lab#3D..004157#0Af_entry#3D..002158#0A#0Af_dlab#3D.
.003160#0Af_dw#3D..005161#0Af_db#3D..005162#0Af_dl#3D
..005163#0Af_ds#3D..005164#0A}#0A#0A1LET.codegenera
te(workspace,.workspacesize,.dbg,.bige).BE#0A{..wri
tes("CG2MIAL.20.May.1990007*n")#0A#0A..1IF.workspac
esize<2001.DO.{..cgerror("Too.little.workspace")#0A
..29errcount.:#3D.errcount+1#0A..29longjump(fin_p,.
fin_l)#0A..26}#0A#0A..1//.Set.the.codegenerator.opt
ions#0A..1debug,.bigender.:#3D.dbg,.bige#0A#0A..1li
neno,.progsize.:#3D.0,.0#0A#0A..1op.:#3D.rdn()#0A#0A
..1selectoutput(tostream)#0A..1cgmodules(workspace,
.workspacesize)#0A..1selectoutput(sysprint)#0A..1wr
itef("Program.size.#3D.%n.Fcodes*n",.progsize)#0A}#0A
#0A1AND.cgmodules(workvec,.vecsize).BE.UNTIL.op#3D0
.DO#0A{..LET.p.#3D.workvec#0A..1dpbase.:#3D.p#0A..1
dp.:#3D.workvec+vecsize#0A#0A..1tempv.:#3D.newvec(3
00)#0A..1tempt.:#3D.tempv+300#0A#0A..1hashtab.:#3D.
newvec(hashtabsize)#0A..1FOR.i.#3D.0.TO.hashtabsize
.DO.hashtab!i.:#3D.0#0A..1charv.:#3D.newvec(1024)..
//.For.strings,.file.names.etc#2E#0A#0A..1mlabnumbe
r.:#3D.0#0A..1incode.:#3D.TRUE#0A..1maxssp.:#3D.0#0A
..1maxgn..:#3D.0#0A..1procdepth.:#3D.0#0A..1info_a,
.info_b.:#3D.0,.0#0A..1initstack(3)#0A..1initdatali
sts()#0A#0A..1WHILE.op#3Ds_file.DO.{..rdn();.rdstr(
);.op.:#3D.rdn().}#0A#0A..1genf(f_modstart)#0A..1IF
.op#3Ds_module.DO#0A..1{..LET.n.#3D.rdn()#0A..4genf
k(f_module,.n)#0A..4FOR.i.#3D.1.TO.n.DO.genc(rdn())
#0A..4op.:#3D.rdn()#0A..1}#0A#0A..1incode.:#3D.FALS
E#0A..1scan()#0A..1op.:#3D.rdn()#0A..1incode.:#3D.T
RUE#0A..1genf(f_modend)#0A}#0A#0A1//.Read.an.MCODE.
operator.or.argument#2E#0AAND.rdn().#3D.VALOF#0A{..
LET.a,.neg.#3D.0,.FALSE#0A..1ch.:#3D.rdch().REPEATW
HILE.ch#3D'*s'.|.ch#3D'*n'#0A..1IF.ch#3Dendstreamch
.RESULTIS.0#0A..1IF.ch#3D'-'.DO.{..neg.:#3D.TRUE;.c
h.:#3D.rdch().}#0A..1WHILE.'0'<#3Dch<#3D'9'.DO.{..a
.:#3D.10*a.+.ch.-.'0';.ch.:#3D.rdch()..}#0A..1IF.ne
g.RESULTIS.-a#0A..1RESULTIS.a#0A}#0A#0A//.Read.in.a
n.MCODE.label#2E#0AAND.rdl().#3D.VALOF#0A{..LET.lab
.#3D.rdn()#0A..1RESULTIS.lab#0A}#0A#0A//.Read.in.a.
global.number#2E#0AAND.rdgn().#3D.VALOF#0A{..LET.gn
.#3D.rdn()#0A..1IF.maxgn<gn.DO.maxgn.:#3D.gn#0A..1R
ESULTIS.gn#0A}#0A#0A1//.Read.in.an.MCODE.string.(kn
own.to.have.length<#3D255)#0AAND.rdstr().#3D.VALOF#0A
{..LET.len.#3D.rdn().&.255#0A..1charv%0.:#3D.len#0A
..1FOR.i.#3D.1.TO.len.DO.charv%i.:#3D.rdn()#0A..1RE
SULTIS.lookup(charv)#0A}#0A#0AAND.lookup(str).#3D.V
ALOF#0A{..LET.len,.i.#3D.str%0,.0#0A..1LET.hashval.
#3D.19609.//.This.and.31397.are.primes#2E#0A..1LET.
node.#3D.?#0A..1FOR.i.#3D.0.TO.len.DO.hashval.:#3D.
(hashval.NEQV.str%i).*.31397#0A..1hashval.:#3D.(has
hval>>0001).REM.hashtabsize#0A#0A..1node.:#3D.hasht
ab!hashval#0A#0A..1UNTIL.node#3D0.|.i>len.TEST.(@h2
!node)%i#3Dstr%i#0A..22THEN.i.:#3D.i+1#0A..22ELSE.n
ode,.i.:#3D.h1!node,.0#0A#0A..1IF.node#3D0.DO#0A..1
{..node.:#3D.newvec(len/bytesperword+2)#0A..4h1!nod
e.:#3D.hashtab!hashval#0A..4FOR.i.#3D.0.TO.len.DO.(
@h2!node)%i.:#3D.str%i#0A..4hashtab!hashval.:#3D.no
de#0A..1}#0A#0A..1RESULTIS.node+1#0A}#0A#0AAND.newv
ec(upb).#3D.VALOF#0A{..dp.:#3D.dp-upb-1#0A..1RESULT
IS.dp#0A}#0A#0A//.Generate.next.label.number#2E#0AA
ND.newlab().#3D.VALOF#0A{..mlabnumber.:#3D.mlabnumb
er+1#0A..1RESULTIS.mlabnumber#0A}#0A#0A1AND.cgerror
(mes,.a).BE#0A{..writes("*nError:.")#0A..1writef(me
s,.a)#0A..1newline()#0A..1errcount.:#3D.errcount+1#0A
..1IF.errcount>errmax.DO.{..writes("Too.many.errors
*n")#0A..26longjump(fin_p,.fin_l)#0A..23}#0A}#0A#0A
1//.Initialize.the.simulated.stack.(SS)#2E#0A//.SS.
cells.are.of.the.form.[k,.n,.i,.s]#0A//.where.k..2i
s.the.kind.k_loc.etc#0A//..5n,.i.are.arguments#0A//
..5s..2is.the.position.rel.to.P.of.this.item#0ALET.
initstack(n).BE#0A{..arg2,.arg1,.ssp.:#3D.tempv,.te
mpv+3,.n#0A..1pendingop.:#3D.s_none#0A..1h1!arg2,.h
2!arg2,.h3!arg2.:#3D.k_loc,.ssp-2,.ssp-2#0A..1h1!ar
g1,.h2!arg1,.h3!arg1.:#3D.k_loc,.ssp-1,.ssp-1#0A..1
IF.maxssp<ssp.DO.maxssp.:#3D.ssp#0A}#0A#0A1//.Move.
simulated.stack.pointer.to.n#2E#0AAND.stack(n).BE#0A
{..IF.maxssp<n.DO.maxssp.:#3D.n#0A..1IF.n>#3Dssp+4.
DO.{..store(0,.ssp-1)#0A..19initstack(n)#0A..19RETU
RN#0A..16}#0A#0A..1WHILE.n>ssp.DO.loadt(k_loc,.ssp,
.0)#0A#0A..1UNTIL.n#3Dssp.DO#0A..1{..IF.arg2#3Dtemp
v.DO#0A..4{..TEST.n#3Dssp-1#0A..7THEN.{..ssp.:#3D.n
#0A..15h1!arg1,.h2!arg1.:#3D.h1!arg2,.h2!arg2#0A..1
5h4!arg1.:#3D.ssp-1#0A..15h1!arg2,.h2!arg2,.h3!arg2
.:#3D.k_loc,.ssp-2,.ssp-2#0A..12}#0A..7ELSE.initsta
ck(n)#0A..7RETURN#0A..4}#0A#0A..4arg1,.arg2,.ssp.:#3D
.arg1-3,.arg2-3,.ssp-1#0A..1}#0A}#0A#0A//.Store.all
.SS.items.from.s1.to.s2.in.their.true#0A//.location
s.on.the.stack#2E#0A//.It.may.corrupt.both.register
s.A.and.B#2E#0AAND.store(s1,.s2).BE.FOR.p.#3D.tempv
.TO.arg1.BY.3.DO#0A..19{..LET.s.#3D.h3!p#0A..22IF.s
>s2.RETURN#0A..22IF.s>#3Ds1.DO.storet(p)#0A..19}#0A
#0A2//.Store.any.SS.items.holding.values.depending.
on.(k,n)#0A//.where.k#3Dk_loc,..k_glob.or.k_lab.in.
their.temporary.stack.locations#2E#0A//.It.may.corr
upt.both.registers.A.and.B#2E#0A//.It.is.only.calle
d.from.storein#2E#0AAND.storeshared(k,.n,.t,.a).BE#0A
..FOR.p.#3D.t.TO.a.BY.3.IF.shared(k,.n,.h1!p,.h2!p)
.DO.storet(p)#0A#0AAND.shared(k,.n,.k1,.n1).#3D.VAL
OF#0A{.IF.k1<k_ext.RESULTIS.FALSE..12//.(k1,n1).not
.variable#0A..IF.k1>#3Dk_loci.|.k>#3Dk_loci.RESULTI
S.TRUE.//.one.is.indirect#0A..IF.k#3Dk1.&.n#3Dn1.RE
SULTIS.TRUE..10//.same.simple.variable#0A..RESULTIS
.FALSE..24//.different.simple.variables#0A}#0A#0AAN
D.scan().BE#0A{..IF.debug>1.DO.{..dboutput()#0A..18
writef("op#3D%i3/%i3*n",.op,.pendingop)#0A..15}#0A#0A
..1SWITCHON.op.INTO#0A#0A..1{..DEFAULT:..7cgerror("
Bad.MCODE.op.%n*n",.op);.ENDCASE#0A#0A..4CASE.0:..8
RETURN#0A#0A//.lx.n.c1.#2E#2E1.cn..3n<#3D255#0A..4C
ASE.s_lx:..5loadt(k_ext,.rdstr());..10ENDCASE#0A#0A
//.lpath.n.i..8load.p!n!i..4n~#3D0#0A..4CASE.s_lpat
h:..1{..LET.n.#3D.rdn()#0A..23LET.i.#3D.rdn()#0A..2
3loadt(k_loci.+.(n<<0005),.i)#0A..23ENDCASE#0A..20}
#0A#0A//.llpath.n.i..7load.@.p!n!i..4n~#3D0#0A..4CA
SE.s_llpath:..{..LET.n.#3D.rdn()#0A..23LET.i.#3D.rd
n()#0A..23loadt(k_lvloci.+.(n<<0005),.i)#0A..23ENDC
ASE#0A..20}#0A#0A//.spath.n.i..8store.p!n!i..4n~#3D
0#0A..4CASE.s_spath:..1{..LET.n.#3D.rdn()#0A..23LET
.i.#3D.rdn()#0A..23storein(k_loci.+.(n<<0005),.i)#0A
..23ENDCASE#0A..20}#0A#0A//.setargs.len.argpos#0A..
4CASE.s_setargs:.{..LET.n.#3D.rdn()#0A..23LET.pos.#3D
.rdn()#0A..23cgpendingop()#0A..23FOR.i.#3D.n-1.TO.0
.BY.-1.DO#0A..23{..loada(arg1)#0A..26genfp(f_sp,.po
s+i)#0A..26stack(ssp-1)#0A..23}#0A..23ENDCASE#0A..2
0}#0A#0A..4CASE.s_stw:..4cgstw()#0A..21ENDCASE#0A#0A
..4CASE.s_stb:..4cgpendingop()#0A..21loadba(arg2,.a
rg1)#0A..21genf(f_stb)#0A..21stack(ssp-2)#0A..21END
CASE#0A#0A..4CASE.s_lvindw:#0A..4CASE.s_indw:#0A..4
CASE.s_indw0:#0A..4CASE.s_indb0:#0A..4CASE.s_indb:#0A
..4CASE.s_mult:CASE.s_div:CASE.s_mod:#0A..4CASE.s_p
lus:CASE.s_sub:#0A..4CASE.s_eq:.CASE.s_ne:#0A..4CAS
E.s_ls:CASE.s_gr:CASE.s_le:CASE.s_ge:#0A..4CASE.s_l
sh:CASE.s_rsh:#0A..4CASE.s_bitand:CASE.s_bitor:CASE
.s_xor:#0A..21cgpendingop()#0A..21pendingop.:#3D.op
#0A..21ENDCASE#0A#0A..4CASE.s_str:..4cgpendingop()#0A
..21loada(arg1)#0A..21genf(f_atc)#0A..21stack(ssp-1
);..10ENDCASE#0A..4CASE.s_cpr:..4cgpendingop()#0A..
21loada(arg1)#0A..21genf(f_atc);..11ENDCASE#0A..4CA
SE.s_dup:..4cgpendingop()#0A..21loada(arg1)#0A..21s
toret(arg1)#0A..21loadt(k_a,.0);..9ENDCASE#0A..4CAS
E.s_lr:..5forgetall()#0A..21genf(f_cta)#0A..21loadt
(k_a,.0);..9ENDCASE#0A#0A..4CASE.s_ptr:..4loadt(k_l
oc,.ssp);..5ENDCASE#0A#0A..4CASE.s_true:..3loadt(k_
numb,.-1);..5ENDCASE#0A..4CASE.s_false:..2loadt(k_n
umb,.0);..6ENDCASE#0A..4CASE.s_query:..2loadt(k_loc
,.ssp);..5ENDCASE#0A..4CASE.s_stack:cgpendingop();.
stack(rdn());.ENDCASE#0A#0A..4CASE.s_inc1b:..2cginc
(f_inc1b);..8ENDCASE#0A..4CASE.s_inc4b:..2cginc(f_i
nc4b);..8ENDCASE#0A..4CASE.s_dec1b:..2cginc(f_dec1b
);..8ENDCASE#0A..4CASE.s_dec4b:..2cginc(f_dec4b);..
8ENDCASE#0A..4CASE.s_inc1a:..2cginc(f_inc1a);..8END
CASE#0A..4CASE.s_inc4a:..2cginc(f_inc4a);..8ENDCASE
#0A..4CASE.s_dec1a:..2cginc(f_dec1a);..8ENDCASE#0A.
.4CASE.s_dec4a:..2cginc(f_dec4a);..8ENDCASE#0A#0A..
4CASE.s_bitnot:CASE.s_not:CASE.s_neg:CASE.s_abs:#0A
..21cgpendingop()#0A..21pendingop.:#3D.op#0A..21END
CASE#0A#0A..4CASE.s_unhandle:.genf(f_unh)#0A..21END
CASE#0A#0A..4CASE.s_return:..1cgpendingop()#0A..21g
enf(f_rtn)#0A..21incode.:#3D.FALSE#0A..21ENDCASE#0A
#0A..4CASE.s_fnargs:#0A..18{..LET.a.#3D.rdn()#0A..2
1IF.a>0.DO.addinfo_a(k_loc,.3)#0A..21stack(3+a)#0A.
.21ENDCASE#0A..18}#0A#0A..4CASE.s_match:..2rdn();.r
dn();..//.??24#0A..21store(0,.ssp)#0A..21//cgerror(
"Unimplemented.op.in.scan.%n*n",.op)#0A..21ENDCASE#0A
#0A..4CASE.s_raise:..2cgraise(rdn())#0A..21incode.:
#3D.FALSE#0A..21ENDCASE#0A#0A..4CASE.s_locs:..3stac
k(ssp+rdn());..9ENDCASE#0A#0A..4CASE.s_lp:..5loadt(
k_loc,.rdn());..6ENDCASE#0A..4CASE.s_lg:..5loadt(k_
glob,.rdgn());..4ENDCASE#0A..4CASE.s_llp:..4loadt(k
_lvloc,.rdn());..4ENDCASE#0A..4CASE.s_llg:..4loadt(
k_lvglob,.rdgn());..2ENDCASE#0A#0A..4CASE.s_ln:.{.L
ET.k.#3D.rdn()#0A..17UNLESS.-#23xFF4<#3Dk<#3D#23xFF
4.DO#0A..17{.LET.lab.#3D.newlab()#0A..19loadt(k_lw,
.lab)#0A..19!cliste.:#3D.getblk(0,lab,k)#0A..19clis
te.:#3D.!cliste#0A..19ENDCASE#0A..17}#0A..17loadt(k
_numb,.k)#0A..17ENDCASE#0A..15}#0A#0A..4CASE.s_sp:.
.5storein(k_loc,..rdn());..3ENDCASE#0A..4CASE.s_sg:
..5storein(k_glob,.rdgn());..2ENDCASE#0A#0A//.call.
k..11call.a.procedure.incrementing.P.by.k#0A..4CASE
.s_call:..3cgcall(rdn())#0A..21ENDCASE#0A#0A..4CASE
.s_jump:..3cgpendingop()#0A..21store(0,.ssp-1)#0A..
21forgetall()#0A..21genfl(f_j,.rdl());..8ENDCASE#0A
#0A..4CASE.s_handle:..1cgpendingop()#0A..21store(0,
.ssp-1)#0A..21forgetall()#0A..21genfp(f_llp,.ssp)#0A
..21genfl(f_hand,.rdl())#0A..21stack(ssp+3)#0A..21E
NDCASE#0A#0A..4CASE.s_jt:..5cgjump(TRUE,.rdl());..6
ENDCASE#0A..4CASE.s_jf:..5cgjump(FALSE,.rdl());..5E
NDCASE#0A#0A..4CASE.s_ll:..5loadt(k_lab,.rdl());..6
ENDCASE#0A..4CASE.s_ll1:..4loadt(k_lvlab,.rdl());..
4ENDCASE#0A#0A..4CASE.s_lf:..5loadt(k_fnlab,.rdl())
;..4ENDCASE#0A#0A..4CASE.s_sl:..5storein(k_lab,.rdl
());..4ENDCASE#0A#0A..4CASE.s_lab:..4cgpendingop()#0A
..21store(0,.ssp-1)#0A..21forgetall()#0A..21incode.
:#3D.procdepth>0#0A..21genfl(f_lab,.rdl())#0A..21in
code.:#3D.TRUE#0A..21ENDCASE#0A#0A..4CASE.s_fun:..1
{..LET.lab.#3D.rdl()#0A..21LET.name.#3D.rdstr()#0A.
.21procdepth.:#3D.procdepth+1#0A..21cgentry(lab,.na
me)#0A..21ENDCASE#0A..18}#0A#0A..4CASE.s_cfun:..{..
LET.lab.#3D.rdl()#0A..21LET.name.#3D.rdstr()#0A..21
LET.type.#3D.rdstr()#0A..21procdepth.:#3D.procdepth
+1#0A..21cgerror("Unimplemented.op.in.scan.%n*n",.o
p)#0A..21//cgcentry(lab,.name,.type)#0A..21ENDCASE#0A
..18}#0A#0A..4CASE.s_callc:.{..rdn()#0A..21rdstr()#0A
..21cgerror("Unimplemented.op.in.scan.%n*n",.op)#0A
..21ENDCASE#0A..18}#0A#0A..4CASE.s_endfun:..1procde
pth.:#3D.procdepth-1#0A..21ENDCASE#0A#0A..4CASE.s_g
lobal:..1cgglobal(rdn());..4ENDCASE#0A#0A..4CASE.s_
endmodule:.RETURN#0A#0A..4CASE.s_dlab:..3incode.:#3D
.TRUE#0A..21genfl(f_dlab,.rdl());.ENDCASE#0A#0A..4C
ASE.s_dw:..5genfw(f_dw,.rdn());..1ENDCASE#0A..4CASE
.s_db:..5genfk(f_db,.rdn());..1ENDCASE#0A..4CASE.s_
dl:..5genfl(f_dl,.rdl());..1ENDCASE#0A..4CASE.s_ds:
..5genfk(f_ds,.rdn());..1ENDCASE#0A#0A1..4CASE.s_li
ne:..{..LET.fno.#3D.rdn()#0A..21LET.ln..#3D.rdn()#0A
..21lineno.:#3D.fno<<00024.|.ln#0A..21IF.debug>0.DO
.writef("//.line.%n*n",.ln)#0A..21ENDCASE#0A..18}#0A
..1}#0A#0A..1op.:#3D.rdn()#0A}.REPEAT#0A#0A1//.Comp
iles.code.to.deal.with.any.pending.op#2E#0ALET.cgpe
ndingop().BE#0A{..LET.f.#3D.0#0A..1LET.sym.#3D.TRUE
#0A..1LET.pndop.#3D.pendingop#0A..1pendingop.:#3D.s
_none#0A#0A..1SWITCHON.pndop.INTO#0A..1{..DEFAULT:.
.4cgerror("Bad.pendingop.%n",.pndop)#0A#0A..4CASE.s
_none:..RETURN#0A#0A..4CASE.s_abs:..1loada(arg1)#0A
..18genf(f_abs)#0A..18forget_a()#0A..18RETURN#0A#0A
..4CASE.s_neg:..1loada(arg1)#0A..18genf(f_neg)#0A..
18forget_a()#0A..18RETURN#0A#0A..4CASE.s_bitnot:#0A
..4CASE.s_not:..1loada(arg1)#0A..18genf(f_not)#0A..
18forget_a()#0A..18RETURN#0A#0A..4CASE.s_lvindw:.lo
adba(arg2,.arg1)#0A..19genf(f_lvind)#0A..19lose1(k_
a,.0)#0A..19forget_a()#0A..19RETURN#0A#0A..4CASE.s_
indw0:.cgindw0()#0A..18//loada(arg1)#0A..18//genf(f
_rv)#0A..18//forget_a()#0A..18RETURN#0A#0A..4CASE.s
_indb0:.loada(arg1)#0A..18genf(f_indb0)#0A..18forge
t_a()#0A..18RETURN#0A#0A..4CASE.s_eq:#0A..4CASE.s_n
e:#0A..4CASE.s_ls:#0A..4CASE.s_gr:#0A..4CASE.s_le:#0A
..4CASE.s_ge:..2cgrelop(pndop)#0A..18RETURN#0A#0A..
4CASE.s_sub:..1UNLESS.k_numb#3Dh1!arg1.DO#0A..18{..
f,.sym.:#3D.f_sub,.FALSE#0A..21ENDCASE#0A..18}#0A..
18h2!arg1.:#3D.-h2!arg1#0A#0A..4CASE.s_plus:..cgplu
s();.RETURN#0A#0A..4CASE.s_lsh:..1IF.h1!arg1#3Dk_nu
mb.DO#0A..18{.loada(arg2)#0A..20genfk(f_lshk,.h2!ar
g1)#0A..20f.:#3D.0#0A..20ENDCASE#0A..18}#0A..18f,.s
ym.:#3D.f_lsh,.FALSE;..ENDCASE#0A#0A..4CASE.s_rsh:.
.1IF.h1!arg1#3Dk_numb.DO#0A..18{.loada(arg2)#0A..20
genfk(f_rshk,.h2!arg1)#0A..20f.:#3D.0#0A..20ENDCASE
#0A..18}#0A..18f,.sym.:#3D.f_rsh,.FALSE;..ENDCASE#0A
#0A..4CASE.s_indw:..f,.sym.:#3D.f_indw,.FALSE;.ENDC
ASE#0A..4CASE.s_indb:..f..4:#3D.f_indb;..6ENDCASE#0A
..4CASE.s_mult:..f..4:#3D.f_mul;..7ENDCASE#0A..4CAS
E.s_div:..1f,.sym.:#3D.f_div,.FALSE;..ENDCASE#0A..4
CASE.s_mod:..1f,.sym.:#3D.f_mod,.FALSE;..ENDCASE#0A
..4CASE.s_bitand:f..4:#3D.f_and;..7ENDCASE#0A..4CAS
E.s_bitor:.f..4:#3D.f_or;..8ENDCASE#0A..4CASE.s_xor
:..1f..4:#3D.f_xor;..7ENDCASE#0A..1}#0A#0A..1UNLESS
.f#3D0.DO.{.TEST.sym.THEN.loadboth(arg2,.arg1)#0A..
26ELSE.loadba(arg2,.arg1)#0A..17genf(f)#0A..15}#0A.
.1forget_a()#0A..1lose1(k_a,0)#0A}#0A#0A2LET.loada(
x).BE#0A//.Loada.compiles.code.to.evaluate.SS.item.
x.into.A#0A//.The.contents.of.B.is.left.unchanged#0A
{..LET.k,.n.#3D.h1!x,.h2!x#0A#0A..1IF.k#3Dk_a.RETUR
N#0A#0A..1//.Dump.A.register.if.currently.in.use.so
mewhere.else#2E#0A..1FOR.t.#3D.arg1.TO.tempv.BY.-3.
IF.h1!t#3Dk_a.DO.{..storet(t);.BREAK.}#0A#0A..1TEST
.inreg_a(k,.n)#0A..1THEN.{.h1!x.:#3D.k_a;.RETURN.}#0A
..1ELSE.IF.inreg_b(k,.n).DO.{..genf(f_bta)#0A..29h1
!x.:#3D.k_a#0A..29btainfo()#0A..29RETURN#0A..26}#0A
#0A..1k,.n.:#3D.h1!x,.h2!x.//.Might.have.been.chang
ed.by.storet#2E#0A..1SWITCHON.k.&.31.INTO#0A..1{..D
EFAULT:..5cgerror("in.loada.%n",.k)#0A#0A..4CASE.k_
a:..4RETURN#0A#0A..4CASE.k_numb:..1TEST.n>#3D0.THEN
.genfk(f_l,..n)#0A..29ELSE.genfk(f_lm,-n)#0A..19END
CASE#0A..4CASE.k_lw:..3genfm(f_lw,.n);..10ENDCASE#0A
..4CASE.k_fnlab:..genfl(f_lf,.n);..10ENDCASE#0A#0A/
/..2CASE.k_ext:..2genfx(f_lx,.n);..10ENDCASE#0A#0A.
.4CASE.k_loc:..2genfp(f_lp,.n);..10ENDCASE#0A..4CAS
E.k_glob:..1genfg(f_lg,.n);..10ENDCASE#0A..4CASE.k_
lab:..2genfl(f_ll,.n);..10ENDCASE#0A#0A..4CASE.k_lv
loc:..genfp(f_llp,.n);..9ENDCASE#0A..4CASE.k_lvglob
:.genfg(f_llg,.n);..9ENDCASE#0A..4CASE.k_lvlab:..ge
nfl(f_ll1,.n);..9ENDCASE#0A#0A..4CASE.k_loci:..1gen
fkp(f_lkp,.n,.k>>0005);..2ENDCASE#0A..4CASE.k_globi
:..genfkg(f_lkg,.n,.k>>0005);..2ENDCASE#0A..4CASE.k
_labi:..1genfl(f_ll,.k>>0005)#0A..19genfk(f_rvk,.n)
;..9ENDCASE#0A#0A..4CASE.k_lvloci:.genfp(f_lp,.k>>0
005)#0A..19cgaddk(4*n);..13ENDCASE#0A..4CASE.k_lvgl
obi:genfg(f_lg,.h1!x>>0005)#0A..19cgaddk(4*n);..13E
NDCASE#0A..4CASE.k_lvlabi:.genfl(f_ll,.h1!x>>0005)#0A
..19cgaddk(4*n);..13ENDCASE#0A..1}#0A#0A..1//.An.in
struction.to.load.the.A.register.has.just.been.comp
iled#2E#0A..1forget_a()#0A..1addinfo_a(h1!x,.h2!x)#0A
..1h1!x.:#3D.k_a#0A}#0A#0AAND.loadba(x,.y).BE.IF.lo
adboth(x,.y)#3Dswapped.DO.genxch(x,.y)#0A#0AAND.set
ba(x,.y).BE#0A{.UNLESS.x#3D0.DO.h1!x.:#3D.k_a#0A..U
NLESS.y#3D0.DO.h1!y.:#3D.k_a#0A}#0A#0AAND.genxch(x,
.y).BE.{.genf(f_xch);.xchinfo();.setba(x,.y).}#0A#0A
AND.genatb(x,.y).BE.{.genf(f_atb);.atbinfo();.setba
(x,.y).}#0A#0AAND.loadboth(x,.y).#3D.VALOF#0A//.Com
piles.code.to.cause#0A//..1either..2x.->.[B]..and..
y.->.[A]#0A//..11giving.result.NOTSWAPPED#0A//..1or
..6x.->.[A]..and..y.->.[B]#0A//..11giving.result.SW
APPED#2E#0A//.LOADBOTH.only.swaps.if.this.saves.cod
e#2E#0A{..//.First.ensure.that.no.other.stack.item.
uses.reg.A#2E#0A..1FOR.t.#3D.tempv.TO.arg1.BY.3.DO#0A
..5IF.h1!t#3Dk_a.UNLESS.t#3Dx.|.t#3Dy.DO.storet(t)#0A
#0A..1{..LET.xa,.ya.#3D.inreg_a(h1!x,.h2!x),.inreg_
a(h1!y,.h2!y)#0A..4AND.xb,.yb.#3D.inreg_b(h1!x,.h2!
x),.inreg_b(h1!y,.h2!y)#0A#0A..4IF.xb.&.ya.DO.{..se
tba(x,y);..13RESULTIS.notswapped.}#0A..4IF.xa.&.yb.
DO.{..setba(y,x);..13RESULTIS.swapped..2}#0A..4IF.x
a.&.ya.DO.{..genatb(x,y);..12RESULTIS.notswapped.}#0A
..4IF.xb.&.yb.DO.{..genxch(0,y);.genatb(x,y);.RESUL
TIS.notswapped.}#0A#0A..4IF.xa.DO.{..13push(x,y);.R
ESULTIS.notswapped.}#0A..4IF.ya.DO.{..13push(y,x);.
RESULTIS.swapped..2}#0A..4IF.xb.DO.{..genxch(0,x);.
push(x,y);.RESULTIS.notswapped.}#0A..4IF.yb.DO.{..g
enxch(0,y);.push(y,x);.RESULTIS.swapped..2}#0A#0A..
4loada(x)#0A..4push(x,.y)#0A..4RESULTIS.notswapped#0A
..1}#0A}#0A#0AAND.push(a,.x).BE.//.compile.code.for
.B.:#3D.<a>;.A.:#3D.<x>#0A..16//.assuming.<a>.is.al
ready.in.A#0A{.LET.k,.n.#3D.h1!x,.h2!x#0A#0A..SWITC
HON.h1!x.INTO#0A..{.DEFAULT:..3genf(f_atb)#0A..15h1
!a.:#3D.k_b#0A..15atbinfo()#0A..15loada(x)#0A..15RE
TURN#0A#0A..2CASE.k_loc:..genfp(f_atblp,.n);.ENDCAS
E#0A..2CASE.k_glob:.genfg(f_atblg,.n);.ENDCASE#0A..
2CASE.k_numb:.genfk(f_atbl,..n);.ENDCASE#0A..}#0A#0A
..atbinfo()#0A..forget_a()#0A..addinfo_a(k,.n)#0A..
h1!a,.h1!x.:#3D.k_b,.k_a#0A}#0A#0ALET.inreg_a(k,.n)
.#3D.VALOF#0A{..LET.p.#3D.info_a#0A..1IF.k#3Dk_a.RE
SULTIS.TRUE#0A..1UNTIL.p#3D0.DO.{..IF.k#3Dh2!p.&.n#3D
h3!p.RESULTIS.TRUE#0A..17p.:#3D.!p#0A..14}#0A..1RES
ULTIS.FALSE#0A}#0A#0AAND.inreg_b(k,.n).#3D.VALOF#0A
{..LET.p.#3D.info_b#0A..1IF.k#3Dk_b.RESULTIS.TRUE#0A
..1UNTIL.p#3D0.DO.{..IF.k#3Dh2!p.&.n#3Dh3!p.RESULTI
S.TRUE#0A..17p.:#3D.!p#0A..14}#0A..1RESULTIS.FALSE#0A
}#0A#0AAND.addinfo_a(k,.n).BE.info_a.:#3D.getblk(in
fo_a,.k,.n)#0A#0AAND.addinfo_b(k,.n).BE.info_b.:#3D
.getblk(info_b,.k,.n)#0A#0AAND.pushinfo(k,.n).BE#0A
{..forget_b()#0A..1info_b.:#3D.info_a#0A..1info_a.:
#3D.getblk(0,.k,.n)#0A}#0A#0AAND.xchinfo().BE#0A{..
LET.t.#3D.info_a#0A..1info_a.:#3D.info_b#0A..1info_
b.:#3D.t#0A}#0A#0AAND.atbinfo().BE#0A{..LET.p.#3D.i
nfo_a#0A..1forget_b()#0A..1UNTIL.p#3D0.DO.{..addinf
o_b(h2!p,.h3!p);.p.:#3D.!p.}#0A}#0A#0AAND.btainfo()
.BE#0A{..LET.p.#3D.info_b#0A..1forget_a()#0A..1UNTI
L.p#3D0.DO.{..addinfo_a(h2!p,.h3!p);.p.:#3D.!p.}#0A
}#0A#0AAND.forget_a().BE.{..freeblks(info_a);.info_
a.:#3D.0.}#0A#0AAND.forget_b().BE.{..freeblks(info_
b);.info_b.:#3D.0.}#0A#0AAND.forgetall().BE.{..forg
et_a();.forget_b().}#0A#0A//.Forgetvar.is.called.ju
st.after.compiling.an.assigment.to.a.simple#0A//.va
riable.(k,.n)#2E..k.is.k_loc,.k_glob,.k_ext.or.k_la
b#2E#0A//.Information.about.matching.simple.variabl
es.must.be.thrown.away#2E#0A//.Information.about.in
direct.values.must.be.thrown.away#2E#0A//.The.treat
ment.of.k_lvloci,.k_lvglobi.and.k_lvlabi.could.be.i
mproved#2E#0AAND.forgetvar(k,.n).BE#0A{..LET.p.#3D.
info_a#0A..1UNTIL.p#3D0.DO.{..LET.op.#3D.h2!p#0A..1
7IF.k#3Dop.&.h3!p#3Dn.|.op>#3Dk_loci.DO.h2!p.:#3D.k
_none#0A..17p.:#3D.!p#0A..14}#0A..1p.:#3D.info_b#0A
..1UNTIL.p#3D0.DO.{..LET.op.#3D.h2!p#0A..17IF.k#3Do
p.&.h3!p#3Dn.|.op>#3Dk_loci.DO.h2!p.:#3D.k_none#0A.
.17p.:#3D.!p#0A..14}#0A}#0A#0AAND.forgetallvars().B
E..//.After.compiling.an.indirect.assignment#2E#0A{
..LET.p.#3D.info_a#0A..1UNTIL.p#3D0.DO.{..IF.h2!p>#3D
k_ext.DO.h2!p.:#3D.k_none#0A..17p.:#3D.!p#0A..14}#0A
..1p.:#3D.info_b#0A..1UNTIL.p#3D0.DO.{..IF.h2!p>#3D
k_ext.DO.h2!p.:#3D.k_none#0A..17p.:#3D.!p#0A..14}#0A
}#0A#0AAND.iszero(a).#3D.h1!a#3Dk_numb.&.h2!a#3D0.-
>.TRUE,.FALSE#0A#0A//.Store.the.value.of.a.SS.item.
in.its.true.stack.location#2E#0AAND.storet(x).BE#0A
{..LET.s.#3D.h3!x#0A..1IF.h1!x#3Dk_loc.&.h2!x#3Ds.R
ETURN#0A..1loada(x)#0A..1genfp(f_sp,.s)#0A..1forget
var(k_loc,.s)#0A..1addinfo_a(k_loc,.s)#0A..1h1!x,.h
2!x.:#3D.k_loc,.s#0A}#0A#0A//.Load.an.item.(k,n).on
to.the.SS#2E.It.may.move.SS.items#2E#0AAND.loadt(k,
.n).BE#0A{..cgpendingop()#0A..1TEST.arg1+3#3Dtempt#0A
..1THEN.{..storet(tempv)..//.SS.stack.overflow#2E#0A
..9FOR.t.#3D.tempv.TO.arg2+2.DO.t!0.:#3D.t!3#0A..6}
#0A..1ELSE.arg2,.arg1.:#3D.arg2+3,.arg1+3#0A..1h1!a
rg1,h2!arg1,h3!arg1.:#3D.k,n,ssp#0A..1ssp.:#3D.ssp.
+.1#0A..1IF.maxssp<ssp.DO.maxssp.:#3D.ssp#0A}#0A#0A
1//.Replace.the.top.two.SS.items.by.(k,n).and.set.P
ENDINGOP#3DS_NONE#2E#0AAND.lose1(k,.n).BE#0A{..ssp.
:#3D.ssp.-.1#0A..1TEST.arg2#3Dtempv#0A..1THEN.{..h1
!arg2,.h2!arg2.:#3D.k_loc,.ssp-2#0A..9h3!arg2.:#3D.
ssp-2#0A..6}#0A..1ELSE.{..arg1.:#3D.arg2#0A..9arg2.
:#3D.arg2-3#0A..6}#0A..1h1!arg1,.h2!arg1,.h3!arg1.:
#3D.k,.n,.ssp-1#0A..1pendingop.:#3D.s_none#0A}#0A#0A
AND.swapargs().BE#0A{..LET.k,.n.#3D.h1!arg1,.h2!arg
1#0A..1h1!arg1,.h2!arg1.:#3D.h1!arg2,.h2!arg2#0A..1
h1!arg2,.h2!arg2.:#3D.k,.n#0A}#0A#0AAND.cgstw().BE#0A
{..cgpendingop()#0A..1loadba(arg1,.arg2)#0A..1genf(
f_st)#0A..1stack(ssp-2)#0A..1forgetallvars()#0A}#0A
#0A/*#0AAND.cgstw().BE#0A{..//..4!(..11<arg1>).:#3D
.<arg2>#0A..1//..4!(..5pndop.<arg1>).:#3D.<arg2>#0A
..1//..or..!(<arg2>.pndop.<arg1>).:#3D.<arg3>#0A..1
IF.pendingop#3Ds_plus.DO#0A..1{..//..!(<arg2>+<arg1
>).:#3D.<arg3>#0A..4IF.k_numb#3Dh1!arg1.DO#0A..4{..
LET.offset.#3D.h2!arg1..7//.<arg2>!offset.:#3D.<arg
3>#0A..7LET.k,.n.#3D.h1!arg2,.h2!arg2#0A..7stack(ss
p-1)#0A..7//.offset!<arg1>.:#3D.<arg2>#0A..7pending
op.:#3D.s_none#0A#0A..7SWITCHON.k.INTO#0A..7{.DEFAU
LT:..3IF.loadboth(arg2,.arg1)#3Dswapped.DO#0A..22{.
IF.offset#3D0.DO.{.genf(f_xst)#0A..41stack(ssp-2)#0A
..41forgetallvars()#0A..41RETURN#0A..39}#0A..25genf
(f_xch)#0A..25xchinfo()#0A..22}#0A..22//.offset!A.:
#3D.B#0A..22genfk(f_stk,.offset)#0A..22stack(ssp-2)
#0A..22forgetallvars()#0A..22RETURN#0A#0A..9CASE.k_
loc:..stack(ssp-1)#0A..22//.offset!Pn.:#3D.<arg1>#0A
..22storein(k_loci+(n<<0005),.offset)#0A..22RETURN#0A
..9CASE.k_glob:.stack(ssp-1)#0A..22//.offset!Gn.:#3D
.<arg1>#0A..22storein(k_globi+(n<<0005),.offset)#0A
..22RETURN#0A..9CASE.k_lab:..stack(ssp-1)#0A..22//.
offset!Ln.:#3D.<arg1>#0A..22storein(k_labi+(n<<0005
),.offset)#0A..22RETURN#0A..7}#0A..4}#0A#0A..4//.<a
rg1>!<arg2>.:#3D.<arg3>#0A..4IF.h1!arg2#3Dk_loc.DO.
swapargs()#0A..4IF.h1!arg1#3Dk_loc.DO#0A..4{..LET.n
.#3D.h2!arg1..12//.Pn!<arg2>.:#3D.<arg3>#0A..7stack
(ssp-1)#0A..7pendingop.:#3D.s_none#0A..7//.Pn!<arg1
>.:#3D.<arg2>#0A..7IF.loadba(arg2,.arg1).#3D.swappe
d.DO#0A..7{.genf(f_xch}#0A..9xchinfo()#0A..7}#0A..7
//.Pn!A.:#3D.B#0A..7genfp(f_stp,.n)#0A..7stack(ssp-
2)#0A..7forgetallvars()#0A..7RETURN#0A..4}#0A#0A..4
UNLESS.arg2#3Dtempv.DO#0A..4{..LET.arg3.#3D.arg2.-.
3#0A..7IF.h1!arg3#3Dk_a.DO#0A..7{..IF.h1!arg2#3Dk_l
oc.|#0A..13h1!arg2#3Dk_glob.|#0A..13h1!arg2#3Dk_num
b.&.bits24(h2!arg2).DO.swapargs()#0A..10IF.h1!arg1#3D
k_loc.|#0A..13h1!arg1#3Dk_glob.|#0A..13h1!arg1#3Dk_
numb.&.bits24(h2!arg1).DO#0A..10//.Optimize.the.cas
e..<arg2>!<arg1>.:#3D.<arg3>#0A..10//.where.<arg3>.
is.already.in.A#0A..10//.and.<arg1>.is.a.local,.a.g
lobal.or.a.number#2E#0A..10{..genf(f_atb)..//.Put.<
arg3>.into.B#0A..13h1!arg3.:#3D.k_b#0A..13cgplus().
.3//.Compiles.an.A,.AP.or.AG.instr#2E#0A..13genf(f_
st)#0A..13stack(ssp-2)#0A..13forgetallvars()#0A..13
RETURN#0A..10}#0A..7}#0A..4}#0A..1}#0A#0A..1cgpendi
ngop()#0A#0A..1//.!<arg1>.:#3D.<arg2>#0A#0A..1{..LE
T.k,.n.#3D.h1!arg1,.h2!arg1#0A#0A..4IF.k#3Dk_glob.&
.t#3D0.DO.{..loada(arg2)#0A..28genfkg(f_stkg,.0,.n)
#0A..28stack(ssp-2)#0A..28forgetallvars()#0A..28RET
URN#0A..25}#0A#0A..4IF.k#3Dk_loc.&.t<#3D3.DO.{..loa
da(arg2)#0A..28genfkp(f_stkp,.t,.n)#0A..28stack(ssp
-2)#0A..28forgetallvars()#0A..28RETURN#0A..25}#0A#0A
..4IF.loadboth(arg2,.arg1)#3Dswapped.DO#0A..4{.IF.t
#3D0.DO.{.genf(f_xst)#0A..18stack(ssp-2)#0A..18forg
etallvars()#0A..18RETURN#0A..16}#0A..6genf(f_xch)#0A
..6xchinfo()#0A..4}#0A#0A..4SWITCHON.t.INTO#0A..4{.
DEFAULT:#0A..6CASE.0:.genf(f_st);..6ENDCASE#0A..6CA
SE.1:#0A..6CASE.2:#0A..6CASE.3:.genfk(f_stk,.t);..1
ENDCASE#0A..6CASE.4:#0A..6CASE.5:#0A..6CASE.6:.genf
p(f_stp,.t-1);.ENDCASE#0A..4}#0A#0A..4stack(ssp-2)#0A
..4forgetallvars()#0A..1}#0A}#0A*/#0A#0A//.Store.th
e.top.item.of.the.SS.in.(k,n)#2E#0AAND.storein(k,.n
).BE#0A//.k.is.k_loc,.k_loci,.k_glob,.k_globi,.k_la
b.or.k_labi#2E#0A{..IF.pendingop#3Ds_sub.&.h1!arg1#3D
k_numb.DO#0A..1{.pendingop.:#3D.s_plus#0A..3h2!arg1
.:#3D.-.h2!arg1#0A..1}#0A..1IF.pendingop#3Ds_plus.D
O#0A..1{.IF.h1!arg1#3Dk.&.h2!arg1#3Dn.&.(k#3Dk_loc.
|.k#3Dk_glob.|.k#3Dk_lab).DO.swapargs()#0A..3IF.h1!
arg2#3Dk.&.h2!arg2#3Dn.&.(k#3Dk_loc.|.k#3Dk_glob.|.
k#3Dk_lab).DO#0A..3{.//.we.have.<arg2>.:#3D.<arg2>.
+.<arg1>#0A..5//.where.<arg2>.is.local,.global.or.s
tatic#0A..5LET.val.#3D.h2!arg1#0A..5pendingop.:#3D.
s_none#0A..5storeshared(k,.n,.tempv,.arg2-3)#0A..5T
EST.h1!arg1#3Dk_numb#0A..5THEN.SWITCHON.k.INTO#0A..
10{.CASE.k_loc:..genfkp(f_ikp,.val,.n);.ENDCASE#0A.
.12CASE.k_glob:.genfkg(f_ikg,.val,.n);.ENDCASE#0A..
12CASE.k_lab:..genfkl(f_ikl,.val,.n);.ENDCASE#0A..1
0}#0A#0A..5ELSE.{.loada(arg1)#0A..12SWITCHON.k.INTO
#0A..12{.CASE.k_loc:..genfp(f_ip,.n);.ENDCASE#0A..1
4CASE.k_glob:.genfg(f_ig,.n);.ENDCASE#0A..14CASE.k_
lab:..genfl(f_il,.n);.ENDCASE#0A..12}#0A..10}#0A..5
forgetvar(k,.n)#0A..5forget_a()#0A..5addinfo_a(k,.n
)#0A..5stack(ssp-2)#0A..5RETURN#0A..3}#0A..1}#0A#0A
..1cgpendingop()#0A..1storeshared(k,.n,.tempv,.arg2
)#0A..1loada(arg1)#0A#0A..1SWITCHON.k&31.INTO#0A..1
{..DEFAULT:..4cgerror("in.storein.%n",.k&31)#0A..4C
ASE.k_loc:..1genfp(f_sp,.n);..8ENDCASE#0A..4CASE.k_
glob:..genfg(f_sg,.n);..8ENDCASE#0A..4CASE.k_lab:..
1genfl(f_sl,.n);..8ENDCASE#0A..4CASE.k_loci:..genfk
p(f_stkp,.n,.k>>0005);.ENDCASE#0A..4CASE.k_globi:.g
enfkg(f_stkg,.n,.k>>0005);.ENDCASE#0A..4CASE.k_labi
:..genf(f_atb)#0A..18genfl(f_ll,.k>>0005)#0A..18gen
fk(f_stk,.n);..7ENDCASE#0A..1}#0A..1forgetvar(k,.n)
#0A..1addinfo_a(k,.n)#0A..1stack(ssp-1)#0A}#0A#0A1A
ND.cginc(f).BE#0A{..cgpendingop()#0A..1loada(arg1)#0A
..1genf(f)#0A..1forget_a()#0A..1forgetallvars()#0A}
#0A#0AAND.cgplus().BE#0A//.Compiles.code.to.compute
.<arg2>.+.<arg1>#2E#0A//.It.does.not.look.at.PENDIN
GOP#2E#0A#0A{..IF.iszero(arg1).DO.{..stack(ssp-1);.
RETURN.}#0A#0A..1IF.iszero(arg2).DO#0A..1{..IF.h2!a
rg1#3Dssp-1.&.h1!arg1#3Dk_loc.|#0A..4(h1!arg1&31)#3D
k_loci.&.(h1!arg1>>0005)#3Dssp-1.DO.loada(arg1)#0A.
.4lose1(h1!arg1,.h2!arg1)#0A..4RETURN#0A..1}#0A#0A.
.1TEST.inreg_a(h1!arg1,.h2!arg1)#0A..1THEN.loada(ar
g1)#0A..1ELSE.IF.inreg_a(h1!arg2,.h2!arg2).DO.loada
(arg2)#0A#0A..1IF.h1!arg1#3Dk_a.DO.swapargs()#0A#0A
..1IF.h1!arg2#3Dk_loc.DO.swapargs()#0A..1IF.h1!arg1
#3Dk_loc.DO.{..loada(arg2)#0A..24genfp(f_ap,.h2!arg
1)#0A..24forget_a()#0A..24lose1(k_a,.0)#0A..24RETUR
N#0A..21}#0A#0A..1IF.h1!arg2#3Dk_numb.DO.swapargs()
#0A..1IF.h1!arg1#3Dk_numb.DO.{..loada(arg2)#0A..25c
gaddk(h2!arg1)#0A..25lose1(k_a,.0)#0A..25RETURN#0A.
.22}#0A#0A..1IF.h1!arg2#3Dk_glob.DO.swapargs()#0A..
1IF.h1!arg1#3Dk_glob.DO.{..loada(arg2)#0A..25genfg(
f_ag,.h2!arg1)#0A..25forget_a()#0A..25lose1(k_a,.0)
#0A..25RETURN#0A..22}#0A#0A..1loadboth(arg2,.arg1)#0A
..1genf(f_add)#0A..1forget_a()#0A..1lose1(k_a,.0)#0A
}#0A#0AAND.cgaddk(k).BE.UNLESS.k#3D0.DO..//.Compile
.code.to.add.k.to.A#2E#0A{..TEST.k>#3D0#0A..1THEN.g
enfk(f_a,.k)#0A..1ELSE.genfk(f_s,.-k)#0A..1forget_a
()#0A}#0A#0AAND.cgglobal(n).BE#0A{..cgstatics()#0A.
.1incode.:#3D.TRUE#0A..1genf(f_global)#0A..1genk(n)
#0A..1FOR.i.#3D.1.TO.n.DO.{..geng(rdgn());.genl(rdl
()).}#0A..1geng(maxgn)#0A}#0A#0A1AND.cgentry(lab,.n
ame).BE#0A{#0A..1IF.debug>0.DO.writef("*n//.FUN..1%
s*n",.name)#0A#0A..1incode.:#3D.TRUE#0A..1genfk(f_e
ntry,.name%0)#0A..1FOR.i.#3D.1.TO.name%0.DO.genc(na
me%i)#0A#0A..1genfl(f_lab,.lab)#0A..1forgetall()#0A
}#0A#0A//.Function.or.routine.call#2E#0AAND.cgcall(
k).BE#0A{..LET.sa.#3D.k+3..//.Stack.address.of.firs
t.arg.(if.any)#2E#0A..1AND.a1.#3D.0..2//.SS.item.fo
r.first.arg.if.present#2E#0A#0A..1cgpendingop()#0A#0A
//.Deal.with.non.args#2E#0A..1FOR.t.#3D.tempv.TO.ar
g2.BY.3.DO.{..IF.h3!t>#3Dk.BREAK#0A..34IF.h1!t#3Dk_
a.DO.storet(t)#0A..31}#0A#0A//.Deal.with.args.2,.3.
#2E#2E1#0A..1FOR.t.#3D.tempv.TO.arg2.BY.3.DO#0A..1{
..LET.s.#3D.h3!t#0A..4IF.s#3Dsa.DO#0A..4{..a1.:#3D.
t..//.We.have.found.the.SS.item.for.the.first.arg#2E
#0A..7IF.h1!t#3Dk_a.&.t+3#3Darg2.DO#0A..7//.Two.arg
ument.call.with.the.first.arg.already.in.A#2E#0A..7
{..genf(f_atb)#0A..10atbinfo()#0A..10h1!t.:#3D.k_b#0A
..10storet(arg2)..1//.Store.second.arg.(without.det
roying.B)#2E#0A..10genf(f_xch)..2//.Restore.first.a
rg.back.to.A#2E#0A..10xchinfo()#0A..10h1!t.:#3D.k_a
#0A..10BREAK#0A..7}#0A..4}#0A..4IF.s>sa.DO.storet(t
)#0A..1}#0A#0A..1//.Move.first.arg.(if.any).into.A#2E
#0A..1IF.sa<ssp-1.TEST.a1#3D0#0A..13THEN.genfp(f_lp
,.sa)..//.First.arg.exists.but.not.in.SS#2E#0A..13E
LSE.loada(a1)..6//.First.arg.exists.in.SS#0A#0A..1/
/.First.arg.(if.any).is.now.in.A#2E#0A#0A..1TEST.h1
!arg1#3Dk_glob#0A..1THEN.genfpg(f_kpg,.k,.h2!arg1)#0A
..1ELSE.{..IF.sa<ssp-1.DO.{.genf(f_atb)#0A..26UNLES
S.a1#3D0.DO.h1!a1.:#3D.k_b#0A..26atbinfo()#0A..24}#0A
..9//.First.arg.(if.any).is.now.in.B#0A..9loada(arg
1)#0A..9//.The.procedure.entry.address.is.now.in.A#2E
#0A..9genfp(f_k,.k)#0A..6}#0A#0A..1forgetall()#0A..
1stack(k)#0A}#0A#0AAND.cgraise(count).BE..//.count.
is.the.number.of.args.to.RAISE#0A{..LET.s.#3D.ssp#0A
..1cgpendingop()#0A..1SWITCHON.count.INTO#0A..1{..D
EFAULT:.cgerror("Compiler.error.in.cgraise.%n*n",.c
ount)#0A#0A..4CASE.3:.loada(arg1)#0A..12genf(f_atc)
#0A..12stack(ssp-1)#0A..4CASE.2:.loadba(arg1,.arg2)
#0A..12ENDCASE#0A..4CASE.1:.loada(arg1)#0A..1}#0A..
1genf(f_raise)#0A..1incode.:#3D.FALSE#0A..1stack(s-
count)#0A}#0A#0A//.Used.for.MCODE.operators.JT.and.
JF#2E#0AAND.cgjump(b,l).BE#0A{..LET.f.#3D.jmpfn(pen
dingop)#0A..1IF.f#3D0.DO.{..loadt(k_numb,0);.f.:#3D
.f_jne.}#0A..1pendingop.:#3D.s_none#0A..1UNLESS.b.D
O.f.:#3D.compjfn(f)#0A..1store(0,ssp-3)#0A..1genfl(
prepj(f),l)#0A..1stack(ssp-2)#0A}#0A#0AAND.jmpfn(op
).#3D.VALOF.SWITCHON.op.INTO#0A{..DEFAULT:..RESULTI
S.0#0A..1CASE.s_eq:.RESULTIS.f_jeq#0A..1CASE.s_ne:.
RESULTIS.f_jne#0A..1CASE.s_ls:.RESULTIS.f_jls#0A..1
CASE.s_gr:.RESULTIS.f_jgr#0A..1CASE.s_le:.RESULTIS.
f_jle#0A..1CASE.s_ge:.RESULTIS.f_jge#0A}#0A#0A//.cg
relop.compiles.a.relop.in.a.boolean.context#2E#0A//
.op.is.one.of.s_eq,.s_ne,.s_ls,.s_gr,.s_le.or.s_ge#2E
#0AAND.cgrelop(op).BE#0A{.LET.f.#3D.0#0A#0A..IF.isz
ero(arg1).DO#0A..{.f.:#3D.VALOF.SWITCHON.op.INTO#0A
..7{.CASE.s_eq:.RESULTIS.f_eq0#0A..9CASE.s_ne:.RESU
LTIS.f_ne0#0A..9CASE.s_ls:.RESULTIS.f_ls0#0A..9CASE
.s_gr:.RESULTIS.f_gr0#0A..9CASE.s_le:.RESULTIS.f_le
0#0A..9CASE.s_ge:.RESULTIS.f_ge0#0A..7}#0A..2loada(
arg2)#0A..2lose1(k_a,.0)#0A..2genf(f)#0A..2forget_a
()#0A..2RETURN#0A..}#0A#0A..IF.iszero(arg2).DO#0A..
{.f.:#3D.VALOF.SWITCHON.op.INTO#0A..7{.CASE.s_eq:.R
ESULTIS.f_eq0#0A..9CASE.s_ne:.RESULTIS.f_ne0#0A..9C
ASE.s_ls:.RESULTIS.f_gr0#0A..9CASE.s_gr:.RESULTIS.f
_ls0#0A..9CASE.s_le:.RESULTIS.f_ge0#0A..9CASE.s_ge:
.RESULTIS.f_le0#0A..7}#0A..2loada(arg1)#0A..2lose1(
k_a,.0)#0A..2genf(f)#0A..2forget_a()#0A..2RETURN#0A
..}#0A#0A..TEST.loadboth(arg2,.arg1)#3Dswapped#0A..
THEN.f.:#3D.VALOF.SWITCHON.op.INTO#0A..10{.DEFAULT:
..1RESULTIS.0#0A..12CASE.s_eq:.RESULTIS.f_eq#0A..12
CASE.s_ne:.RESULTIS.f_ne#0A..12CASE.s_ls:.RESULTIS.
f_gr#0A..12CASE.s_gr:.RESULTIS.f_ls#0A..12CASE.s_le
:.RESULTIS.f_ge#0A..12CASE.s_ge:.RESULTIS.f_le#0A..
10}#0A..ELSE.f.:#3D.VALOF.SWITCHON.op.INTO#0A..10{.
DEFAULT:..1RESULTIS.0#0A..12CASE.s_eq:.RESULTIS.f_e
q#0A..12CASE.s_ne:.RESULTIS.f_ne#0A..12CASE.s_ls:.R
ESULTIS.f_ls#0A..12CASE.s_gr:.RESULTIS.f_gr#0A..12C
ASE.s_le:.RESULTIS.f_le#0A..12CASE.s_ge:.RESULTIS.f
_ge#0A..10}#0A#0A..genf(f)#0A..lose1(k_a,.0)#0A..fo
rget_a()#0A..RETURN#0A}#0A#0AAND.jfn0(f).#3D.f+6.//
.Change.F_JEQ.into.F_JEQ0..etc#2E#2E1#0A#0AAND.revj
fn(f).#3D.f#3Df_jls.->.f_jgr,#0A..14f#3Df_jgr.->.f_
jls,#0A..14f#3Df_jle.->.f_jge,#0A..14f#3Df_jge.->.f
_jle,#0A..14f#0A#0AAND.compjfn(f).#3D.f#3Df_jeq.->.
f_jne,#0A..15f#3Df_jne.->.f_jeq,#0A..15f#3Df_jls.->
.f_jge,#0A..15f#3Df_jge.->.f_jls,#0A..15f#3Df_jgr.-
>.f_jle,#0A..15f#3Df_jle.->.f_jgr,#0A..15f#0A#0AAND
.prepj(f).#3D.VALOF..//.Returns.the.appropriate.m/c
.fn#2E#0A{..IF.iszero(arg2).DO.{..swapargs();.f.:#3D
.revjfn(f).}#0A..1IF.iszero(arg1).DO.{..loada(arg2)
;.RESULTIS.jfn0(f).}#0A..1IF.loadboth(arg2,.arg1)#3D
swapped.RESULTIS.revjfn(f)#0A..1RESULTIS.f#0A}#0A#0A
AND.cgstatics().BE#0A{..incode.:#3D.TRUE#0A#0A..1UN
TIL.clist#3D0.DO..//.List.of.24-32.bit.constants#0A
..1{..LET.blk.#3D.clist#0A..4clist.:#3D.!clist#0A..
4genfmw(f_const,.h2!blk,.h3!blk)#0A..4freeblk(blk)#0A
..1}#0A..1cliste.:#3D.@clist#0A..1incode.:#3D.FALSE
#0A}#0A#0AAND.getblk(a,.b,.c,.d).#3D.VALOF#0A{..LET
.p.#3D.freelist#0A..1TEST.p#3D0.THEN.{..dp.:#3D.dp-
4;.checkspace();.p.:#3D.dp.}#0A..10ELSE.freelist.:#3D
.!p#0A..1h1!p,.h2!p,.h3!p,.h4!p.:#3D.a,.b,.c,.d#0A.
.1RESULTIS.p#0A}#0A#0AAND.freeblk(p).BE.{..!p.:#3D.
freelist;.freelist.:#3D.p.}#0A#0AAND.freeblks(p).BE
.UNLESS.p#3D0.DO#0A{..LET.oldfreelist.#3D.freelist#0A
..1freelist.:#3D.p#0A..1UNTIL.!p#3D0.DO.p.:#3D.!p#0A
..1!p.:#3D.oldfreelist#0A}#0A#0AAND.initdatalists()
.BE#0A{..clist,..1cliste..1:#3D.0,.@clist#0A..1free
list.:#3D.0#0A}#0A#0ALET.codef(x).BE.{.progsize.:#3D
.progsize.+.1;.writef("F%n*n",.x).}#0A#0ALET.codep(
x).BE.writef("P%n*n",.x)#0A#0ALET.codeg(x).BE.write
f("G%n*n",.x)#0A#0ALET.codek(x).BE.writef("K%n*n",.
x)#0A#0ALET.codew(x).BE.writef("W%n*n",.x)#0A#0ALET
.codec(x).BE.writef("C%n*n",.x)#0A#0ALET.codel(x).B
E.writef("L%n*n",.x)#0A#0ALET.codem(x).BE.writef("M
%n*n",.x)#0A#0A1LET.genfp(f,.a).BE.IF.incode.DO#0A{
..IF.debug>0.DO.wrcode(f,.a)#0A..1codef(f)#0A..1cod
ep(a)#0A}#0A#0ALET.genfkp(f,.k,.a).BE.IF.incode.DO#0A
{..IF.debug>0.DO.wrcode(f,.k,.a)#0A..1codef(f)#0A..
1codek(k)#0A..1codep(a)#0A}#0A#0ALET.genfkp(f,.k,.a
).BE.IF.incode.DO#0A{..IF.debug>0.DO.wrcode(f,.k,.a
)#0A..1codef(f)#0A..1codek(k)#0A..1codep(a)#0A}#0A#0A
LET.genfg(f,.n).BE.IF.incode.DO#0A{..1IF.debug>0.DO
.wrcode(f,.n)#0A..1codef(f)#0A..1codeg(n)#0A}#0A#0A
LET.genfkg(f,.k,.n).BE.IF.incode.DO#0A{..1IF.debug>
0.DO.wrcode(f,.k,.n)#0A..1codef(f)#0A..1codek(k)#0A
..1codeg(n)#0A}#0A#0ALET.genfpg(f,.p,.n).BE.IF.inco
de.DO#0A{..IF.debug>0.DO.wrcode(f,.p,.n)#0A..1codef
(f)#0A..1codep(p)#0A..1codeg(n)#0A}#0A#0ALET.genfk(
f,.a).BE.IF.incode.DO#0A{..IF.debug>0.DO.wrcode(f,.
a)#0A..1codef(f)#0A..1codek(a)#0A}#0A#0ALET.genfkl(
f,.a,.l).BE.IF.incode.DO#0A{..IF.debug>0.DO.wrcode(
f,.a,.l)#0A..1codef(f)#0A..1codek(a)#0A..1codel(l)#0A
}#0A#0ALET.genfw(f,.w).BE.IF.incode.DO#0A{..IF.debu
g>0.DO.wrcode(f,.w)#0A..1codef(f)#0A..1codew(w)#0A}
#0A#0ALET.genfl(f,.n).BE.IF.incode.DO#0A{..IF.debug
>0.DO.wrcode(f,.n)#0A..1codef(f)#0A..1codel(n)#0A}#0A
#0ALET.genflk(f,.n,.k).BE.IF.incode.DO#0A{..IF.debu
g>0.DO.wrcode(f,.n,.k)#0A..1codef(f)#0A..1codel(n)#0A
..1codek(k)#0A}#0A#0ALET.genfm(f,.n).BE.IF.incode.D
O#0A{..IF.debug>0.DO.wrcode(f,.n)#0A..1codef(f)#0A.
.1codem(n)#0A}#0A#0ALET.genfmw(f,.n,.w).BE.IF.incod
e.DO#0A{..IF.debug>0.DO.wrcode(f,.n,.w)#0A..1codef(
f)#0A..1codem(n)#0A..1codew(w)#0A}#0A#0ALET.genf(f)
.BE.IF.incode.DO#0A{..IF.debug>0.DO.wrcode(f)#0A..1
codef(f)#0A}#0A#0ALET.geng(n).BE.IF.incode.DO#0A{#0A
..1codeg(n)#0A}#0A#0ALET.genc(c).BE.IF.incode.DO#0A
{#0A..1codec(c)#0A}#0A#0ALET.genk(k).BE.IF.incode.D
O#0A{#0A..1codek(k)#0A}#0A#0ALET.genw(w).BE.IF.inco
de.DO#0A{#0A..1codew(w)#0A}#0A#0ALET.genl(lab).BE.I
F.incode.DO#0A{#0A..1codel(lab)#0A}#0A#0AAND.checks
pace().BE.IF.dp<dpbase.DO#0A{..cgerror("Program.too
.large")#0A..1errcount.:#3D.errcount+1#0A..1longjum
p(fin_p,.fin_l)#0A}#0A#0A1AND.dboutput().BE#0A{..LE
T.p.#3D.info_a#0A..1writef("ssp#3D%i2.",.ssp)#0A..1
writes("A#3D(")#0A..1UNTIL.p#3D0.DO.{..wrkn(h2!p,.h
3!p)#0A..17p.:#3D.!p#0A..17UNLESS.p#3D0.DO.wrch('*s
')#0A..14}#0A#0A..1p.:#3D.info_b#0A..1writes(").B#3D
(")#0A..1UNTIL.p#3D0.DO.{..wrkn(h2!p,.h3!p)#0A..17p
.:#3D.!p#0A..17UNLESS.p#3D0.DO.wrch('*s')#0A..14}#0A
..1wrch(')')#0A#0A..1IF.debug#3D2.DO.{..writes(".."
)#0A..18FOR.p#3Dtempv.TO.arg1.BY.3..DO#0A..18{..IF.
(p-tempv).REM.30.#3D.10.DO.newline()#0A..21wrkn(h1!
p,h2!p)#0A..21wrch('*s')#0A..18}#0A..15}#0A..1newli
ne()#0A}#0A#0AAND.wrkn(k,.n).BE.SWITCHON.k&31.INTO#0A
..1{..DEFAULT:..5writef("?");..13RETURN#0A..4CASE.k
_none:..1writef("-");..13RETURN#0A..4CASE.k_numb:..
1writef("N%n",..2n);..5RETURN#0A..4CASE.k_lw:..3wri
tef("W%n",..2n);..5RETURN#0A..4CASE.k_fnlab:..write
f("F%n",..2n);..5RETURN#0A..4CASE.k_lvloc:..writef(
"@P%n",..1n);..5RETURN#0A..4CASE.k_lvglob:.writef("
@G%n",..1n);..5RETURN#0A..4CASE.k_lvlab:..writef("@
L%n",..1n);..5RETURN#0A..4CASE.k_a:..4writef("A",..
4n);..5RETURN#0A..4CASE.k_b:..4writef("B");..13RETU
RN#0A..4CASE.k_c:..4writef("C");..13RETURN#0A..4CAS
E.k_ext:..2writef("X%n",..2n);..5RETURN#0A..4CASE.k
_loc:..2writef("P%n",..2n);..5RETURN#0A..4CASE.k_gl
ob:..1writef("G%n",..2n);..5RETURN#0A..4CASE.k_lab:
..2writef("L%n",..2n);..5RETURN#0A..4CASE.k_loci:..
1writef("%nP%n",..n,.k>>0005);.RETURN#0A..4CASE.k_l
vloci:.writef("@%nP%n",.n,.k>>0005);.RETURN#0A..4CA
SE.k_globi:..writef("%nG%n",..n,.k>>0005);.RETURN#0A
..4CASE.k_lvglobi:writef("@%nG%n",.n,.k>>0005);.RET
URN#0A..4CASE.k_labi:..1writef("%nL%n",..n,.k>>0005
);.RETURN#0A..4CASE.k_lvlabi:.writef("@%nL%n",.n,.k
>>0005);.RETURN#0A..1}#0A#0A1LET.cgindw0().BE#0A{..
IF.pendingop#3Ds_sub.&.h1!arg1#3Dk_numb.DO#0A..4pen
dingop,.h2!arg1.:#3D.s_plus,.-h2!arg1#0A#0A..1IF.pe
ndingop#3Ds_plus.DO#0A..1{..IF.k_numb#3Dh1!arg2.DO.
swapargs()#0A..4IF.k_numb#3Dh1!arg1.&.(h2!arg1&3)#3D
0.DO#0A..4{..LET.k.#3D.h2!arg1/4..//.<arg2>.!.k#0A.
.7stack(ssp-1)..5//.now.<arg1>.!.k)#0A..7pendingop.
:#3D.s_none#0A#0A..7IF.h1!arg1#3Dk_loc.DO#0A..7{..L
ET.n.#3D.h2!arg1..//.Pn.!.k#0A..10h1!arg1,.h2!arg1.
:#3D.k_loci.+.(n<<0005),.k#0A..10RETURN#0A..7}#0A#0A
..7IF.h1!arg1#3Dk_glob.DO#0A..7{..LET.n.#3D.h2!arg1
..//.Gn.!.k#0A..10h1!arg1,.h2!arg1.:#3D.k_globi.+.(
n<<0005),.k#0A..10RETURN#0A..7}#0A#0A..7loada(arg1)
#0A..7TEST.k#3D0.THEN.genf(f_rv)#0A..16ELSE.genfk(f
_rvk,.k)#0A..7forget_a()#0A..7h1!arg1,.h2!arg1.:#3D
.k_a,.0#0A..7RETURN#0A..4}#0A..1}#0A#0A..1cgpending
op()#0A#0A..1//.!(<arg1>)#0A..1IF.h1!arg1#3Dk_loc.D
O#0A..1{..LET.n.#3D.h2!arg1..//.!.Pn#0A..4h1!arg1,.
h2!arg1.:#3D.k_loci.+.(n<<0005),.0#0A..4RETURN#0A..
1}#0A#0A..1IF.h1!arg1#3Dk_glob.DO#0A..1{..LET.n.#3D
.h2!arg1..//.!.Gn#0A..4h1!arg1,.h2!arg1.:#3D.k_glob
i.+.(n<<0005),.0#0A..4RETURN#0A..1}#0A#0A..1IF.h1!a
rg1#3Dk_lab.DO#0A..1{..LET.n.#3D.h2!arg1..//.!.Ln#0A
..4h1!arg1,.h2!arg1.:#3D.k_labi.+.(n<<0005),.0#0A..
4RETURN#0A..1}#0A#0A..1loada(arg1)#0A..1genf(f_rv)#0A
..1forget_a()#0A..1h1!arg1,.h2!arg1.:#3D.k_a,.0#0A}
#0A#0A1AND.wrcode(f,.a,.b).BE#0A{..LET.form.#3D.VAL
OF.SWITCHON.f.INTO#0A..1{..DEFAULT:..7a.:#3D.f#0A..
21RESULTIS."Unknown.f-code.%n"#0A#0A..4CASE.f_lp:..
5RESULTIS."LP..2P%n"#0A..4CASE.f_lg:..5RESULTIS."LG
..2G%n"#0A..4CASE.f_ll:..5RESULTIS."LL..2L%n"#0A#0A
..4CASE.f_llp:..4RESULTIS."LLP..1P%n"#0A..4CASE.f_l
lg:..4RESULTIS."LLG..1G%n"#0A..4CASE.f_ll1:..4RESUL
TIS."LL1..1L%n"#0A..4CASE.f_lf:..5RESULTIS."LF..2L%
n"#0A..4CASE.f_lw:..5RESULTIS."LW..2M%n"#0A#0A..4CA
SE.f_l:..6RESULTIS."L..3K%n"#0A..4CASE.f_lm:..5RESU
LTIS."LM..2K%n"#0A#0A..4CASE.f_sp:..5RESULTIS."SP..
2P%n"#0A..4CASE.f_sg:..5RESULTIS."SG..2G%n"#0A..4CA
SE.f_sl:..5RESULTIS."SL..2L%n"#0A#0A..4CASE.f_ap:..
5RESULTIS."AP..2P%n"#0A..4CASE.f_ag:..5RESULTIS."AG
..2G%n"#0A..4CASE.f_a:..6RESULTIS."A..3K%n"#0A..4CA
SE.f_s:..6RESULTIS."S..3K%n"#0A#0A..4CASE.f_lkp:..4
RESULTIS."LKP..1K%n.P%n"#0A..4CASE.f_lkg:..4RESULTI
S."LKG..1K%n.P%n"#0A..4CASE.f_rv:..5RESULTIS."RV"#0A
..4CASE.f_rvp:..4RESULTIS."RVP..1P%n"#0A..4CASE.f_r
vk:..4RESULTIS."RVK..1K%n"#0A..4CASE.f_st:..5RESULT
IS."ST"#0A..4CASE.f_stp:..4RESULTIS."STP..1P%n"#0A.
.4CASE.f_stk:..4RESULTIS."STK..1K%n"#0A..4CASE.f_st
kp:..3RESULTIS."STKP..K%n.P%n"#0A..4CASE.f_stkg:..3
RESULTIS."STKG..K%n.G%n"#0A..4CASE.f_xst:..4RESULTI
S."XST"#0A#0A..4CASE.f_stb:..4RESULTIS."STB"#0A..4C
ASE.f_lvind:..2RESULTIS."LVIND"#0A..4CASE.f_indb:..
3RESULTIS."INDB"#0A..4CASE.f_indb0:..2RESULTIS."IND
B0"#0A..4CASE.f_indw:..3RESULTIS."INDW"#0A#0A..4CAS
E.f_k:..6RESULTIS."K..3P%n"#0A..4CASE.f_kpg:..4RESU
LTIS."KPG..1P%n.G%n"#0A#0A..4CASE.f_neg:..4RESULTIS
."NEG"#0A..4CASE.f_not:..4RESULTIS."NOT"#0A..4CASE.
f_abs:..4RESULTIS."ABS"#0A#0A..4CASE.f_xdiv:..3RESU
LTIS."XDIV"#0A..4CASE.f_xmod:..3RESULTIS."XMOD"#0A.
.4CASE.f_xsub:..3RESULTIS."XSUB"#0A#0A..4CASE.f_mul
:..4RESULTIS."MUL"#0A..4CASE.f_div:..4RESULTIS."DIV
"#0A..4CASE.f_mod:..4RESULTIS."MOD"#0A..4CASE.f_add
:..4RESULTIS."ADD"#0A..4CASE.f_sub:..4RESULTIS."SUB
"#0A#0A..4CASE.f_eq:..5RESULTIS."EQ"#0A..4CASE.f_ne
:..5RESULTIS."NE"#0A..4CASE.f_ls:..5RESULTIS."LS"#0A
..4CASE.f_gr:..5RESULTIS."GR"#0A..4CASE.f_le:..5RES
ULTIS."LE"#0A..4CASE.f_ge:..5RESULTIS."GE"#0A..4CAS
E.f_eq0:..4RESULTIS."EQ0"#0A..4CASE.f_ne0:..4RESULT
IS."NE0"#0A..4CASE.f_ls0:..4RESULTIS."LS0"#0A..4CAS
E.f_gr0:..4RESULTIS."GR0"#0A..4CASE.f_le0:..4RESULT
IS."LE0"#0A..4CASE.f_ge0:..4RESULTIS."GE0"#0A#0A..4
CASE.f_lsh:..4RESULTIS."LSH"#0A..4CASE.f_rsh:..4RES
ULTIS."RSH"#0A..4CASE.f_and:..4RESULTIS."AND"#0A..4
CASE.f_or:..5RESULTIS."OR"#0A..4CASE.f_xor:..4RESUL
TIS."XOR"#0A#0A..4CASE.f_xch:..4RESULTIS."XCH"#0A..
4CASE.f_atb:..4RESULTIS."ATB"#0A..4CASE.f_atc:..4RE
SULTIS."ATC"#0A..4CASE.f_bta:..4RESULTIS."BTA"#0A..
4CASE.f_btc:..4RESULTIS."BTC"#0A..4CASE.f_atblp:..2
RESULTIS."ATBLP.P%n"#0A..4CASE.f_atblg:..2RESULTIS.
"ATBLG.G%n"#0A..4CASE.f_atbll:..2RESULTIS."ATBLL.L%
n"#0A..4CASE.f_atbl:..3RESULTIS."ATBL..K%n"#0A#0A..
4CASE.f_j:..6RESULTIS."J..3L%n"#0A..4CASE.f_rtn:..4
RESULTIS."RTN"#0A#0A..4CASE.f_ikp:..4RESULTIS."IKP.
.1K%n.P%n"#0A..4CASE.f_ikg:..4RESULTIS."IKG..1K%n.G
%n"#0A..4CASE.f_ikl:..4RESULTIS."IKL..1K%n.L%n"#0A.
.4CASE.f_ip:..5RESULTIS."IP..2P%n"#0A..4CASE.f_ig:.
.5RESULTIS."IG..2G%n"#0A..4CASE.f_il:..5RESULTIS."I
L..2L%n"#0A#0A..4CASE.f_jeq:..4RESULTIS."JEQ..1L%n"
#0A..4CASE.f_jne:..4RESULTIS."JNE..1L%n"#0A..4CASE.
f_jls:..4RESULTIS."JLS..1L%n"#0A..4CASE.f_jgr:..4RE
SULTIS."JGR..1L%n"#0A..4CASE.f_jle:..4RESULTIS."JLE
..1L%n"#0A..4CASE.f_jge:..4RESULTIS."JGE..1L%n"#0A.
.4CASE.f_jeq0:..3RESULTIS."JEQ0..L%n"#0A..4CASE.f_j
ne0:..3RESULTIS."JNE0..L%n"#0A..4CASE.f_jls0:..3RES
ULTIS."JLS0..L%n"#0A..4CASE.f_jgr0:..3RESULTIS."JGR
0..L%n"#0A..4CASE.f_jle0:..3RESULTIS."JLE0..L%n"#0A
..4CASE.f_jge0:..3RESULTIS."JGE0..L%n"#0A#0A..4CASE
.f_brk:..4RESULTIS."BRK"#0A..4CASE.f_nop:..4RESULTI
S."NOP"#0A..4CASE.f_chgco:..2RESULTIS."CHGCO"#0A..4
CASE.f_mdiv:..3RESULTIS."MDIV"#0A..4CASE.f_sys:..4R
ESULTIS."SYS"#0A#0A..4CASE.f_inc1b:..2RESULTIS."INC
1B"#0A..4CASE.f_inc4b:..2RESULTIS."INC4B"#0A..4CASE
.f_dec1b:..2RESULTIS."DEC1B"#0A..4CASE.f_dec4b:..2R
ESULTIS."DEC4B"#0A..4CASE.f_inc1a:..2RESULTIS."INC1
A"#0A..4CASE.f_inc4a:..2RESULTIS."INC4A"#0A..4CASE.
f_dec1a:..2RESULTIS."DEC1A"#0A..4CASE.f_dec4a:..2RE
SULTIS."DEC4A"#0A#0A..4CASE.f_hand:..3RESULTIS."HAN
D"#0A..4CASE.f_unh:..4RESULTIS."UNH"#0A..4CASE.f_ra
ise:..2RESULTIS."RAISE"#0A#0A..4CASE.f_module:..1RE
SULTIS."MODULE"#0A..4CASE.f_modstart:.RESULTIS."MOD
START"#0A..4CASE.f_modend:..1RESULTIS."MODEND"#0A..
4CASE.f_global:..1RESULTIS."GLOBAL"#0A..4CASE.f_con
st:..2RESULTIS."CONST"#0A..4CASE.f_lab:..4RESULTIS.
"LAB..1L%n"#0A..4CASE.f_entry:..2RESULTIS."ENTRY"#0A
#0A..4CASE.f_dlab:..3RESULTIS."DLAB..L%n"#0A..4CASE
.f_dw:..5RESULTIS."DW"#0A..4CASE.f_db:..5RESULTIS."
DB"#0A..4CASE.f_dl:..5RESULTIS."DL"#0A..4CASE.f_ds:
..5RESULTIS."DS"#0A..1}#0A#0A..1IF.debug#3D2.DO.dbo
utput()#0A..1writes("..6")#0A..1writef(form,.a,.b)#0A
..1newline()#0A}#0A#0A3

######com/mcpl.b#
/*#0AMCPL.to.MINTCODE.compiler#0A#0ACopyright:.Mart
in.Richards.16.June.1990007#0A#0AIt.uses.a.reverse.
polish.form.of.MCODE#2E#0A#0ADevelopment.of.this.co
mpiler.started.on.2.Nov.1990002#0AThis.version.is.d
esigned.to.run.interpretively.using.MINTCODE,#0Aand
.is.similar.in.structure.to.the.BCPL.Cintcode.syste
m#2E#0AThe.GLOBAL.declaration.has.been.put.back.int
o.the.MCPL.and#0Athe.syntax.of.EXTERNAL.declaration
s.has.been.retained.but.not#0Aimplemented#2E#0A#0A0
0030/7/93.Implemented.GLOBAL.declarations.in.SYN.an
d.TRN#2E#0A28/1/97.Removed.bug.in.storein#0A12/2/97
.Allow.nested.comments#0A16/6/97.Restrict.syntax.of
.function.arguments#0A..6Correct.bug.in.rdseq#0A..6
Change.syntax.of.LET.to.make.it.similar.to.STATIC#0A
..6old:..LET.a,.b,.c.#3D.f(),.?,.v!i#0A..6new:..LET
.a#3Df(),.b,.c#3Dv!i#0A..6LET.a,b,c.ALL#3D.0..is.no
.longer.available#0A16/6/97#0AImplement.the.method.
application.operator.for.object.oriented#0Aprogramm
ing.in.MCPL#2E.E.#23.(E1,.E2,#2E#2E1,.En).is.equiva
lent.to#0A((!E1)!E)(E1,.E2,#2E#2E1,.En)#0A8/7/97#0A
Separated.into.files.mcpl#2Eb,.mcplsyn#2Eb.and.mcpl
trn#2Eb,.so.that#0Athey.can.be.shared.with.the.nati
ve.code.version.of.the.compiler#2E#0A*/#0A#0A1SECTI
ON."SYN"#0A#0AGLOBAL.{#0A//General.Interface#0Aerrc
ount:600;.errmax:601;.fin_p:602;.fin_l:603#0Asource
stream:604;.sysprint:605;.mcodeout:606#0Atreep:607;
.treevec:608;.findfilename:609#0A#0A//Syn.interface
#0Achbuf:610;.ch:611;.chcount:612;.lineno:613#0Arch
:614;.findfileno:615;.filelist:616;.freefilelist:61
7#0Aformtree:618;.plist:619#0A}#0A#0AGET."com/mcpls
yn#2Eb"#0A#2E#0A#0A1SECTION."TRN"#0A#0AGLOBAL.{#0A/
/General.Interface#0Aerrcount:600;.errmax:601;.fin_
p:602;.fin_l:603#0Asourcestream:604;.sysprint:605;.
mcodeout:606#0Atreep:607;.treevec:608;.findfilename
:609#0A#0A//.Trn.interface#0Atranslate:620#0A}#0A#0A
GET."com/mcpltrn#2Eb"#0A#2E#0A#0A1SECTION."MCPL"#0A
#0AGET."libhdr"#0A#0AGLOBAL.{#0A//General.Interface
#0Aerrcount:600;.errmax:601;.fin_p:602;.fin_l:603#0A
sourcestream:604;.sysprint:605;.mcodeout:606#0Atree
p:607;.treevec:608;.findfilename:609#0A#0A//Syn.int
erface#0Achbuf:610;.ch:611;.chcount:612;.lineno:613
#0Arch:614;.findfileno:615;.filelist:616;.freefilel
ist:617#0Aformtree:618;.plist:619#0A#0A//.Trn.inter
face#0Atranslate:620#0A#0A//.Cg.interface#0Amcodein
:630;.tostream:.631.#0Acodegenerate:.632#0A}#0A#0AL
ET.start().#3D.VALOF#0A{..LET.treesize.#3D.2003#0A.
.1AND.argv.#3D.VEC.50#0A..1AND.argform.#3D#0A..1"FR
OM/A,TO/K,VER/K,TREE/S,NONAMES/S,D1/S,D2/S,OENDER/S
,"#0A..1LET.bining,.debug,.prtree.#3D.TRUE,.0,.FALS
E#0A..1LET.bigender,.naming.#3D.?,.TRUE#0A..1LET.st
dout.#3D.output()#0A#0A..1sysprint.:#3D.stdout#0A..
1selectoutput(sysprint)#0A.#0A..1writef("*nMCPL.13.
Oct.2000006*n")#0A.#0A..1IF.rdargs(argform,.argv,.5
0)#3D0.DO.{..writes("Bad.arguments*n")#0A..38RESULT
IS.20#0A..35}#0A#0A..1fin_p,.fin_l.:#3D.level(),.fi
n#0A..1errmax..5:#3D.30#0A..1errcount..3:#3D.0#0A..
1treevec..4:#3D.0#0A..1sourcestream.:#3D.0#0A..1mco
deout..3:#3D.0#0A..1mcodein..4:#3D.0#0A..1tostream.
.3:#3D.0#0A..1filelist..3:#3D.0#0A#0A..1prtree.:#3D
.argv!3#0A#0A..1//.Code.generator.options.#0A#0A..1
bigender.:#3D.(!"AA1".&.255).#3D.'A'.//.#3DTRUE.if.
running.on.a.bigender#0A..1IF.argv!4.DO.naming..1:#3D
.FALSE..7//.NONAMES#0A..1IF.argv!5.DO.debug..2:#3D.
debug+1..5//.D1#0A..1IF.argv!6.DO.debug..2:#3D.debu
g+2..5//.D2#0A..1IF.argv!7.DO.bigender.:#3D.~bigend
er..3//.OENDER#0A#0A..1sourcestream.:#3D.findinput(
argv!0)..4//.FROM#0A#0A..1IF.sourcestream#3D0.DO.{.
.writef("Trouble.with.FROM.file.%s*n",.argv!0)#0A..
25errcount.:#3D.1#0A..25GOTO.fin#0A..22}#0A#0A..1se
lectinput(sourcestream)#0A.#0A..1mcodeout.:#3D.find
output("MCODE")#0A#0A..1IF.mcodeout#3D0.DO.{..write
s("Trouble.with.file.MCODE*n")#0A..21errcount.:#3D.
1#0A..21GOTO.fin#0A..18}#0A..1treevec.:#3D.getvec(t
reesize)#0A#0A..1IF.treevec#3D0.DO.{..writes("Insuf
ficient.memory*n")#0A..20errcount.:#3D.1#0A..20GOTO
.fin#0A..17}#0A..1#0A..1UNLESS.argv!2#3D0.DO..5//.V
ER#0A..1{..sysprint.:#3D.findoutput(argv!2)#0A..4IF
.sysprint#3D0.DO#0A..4{..sysprint.:#3D.stdout#0A..7
writef("Trouble.with.VER.file.%s*n",.argv!2)#0A..7e
rrcount.:#3D.1#0A..7GOTO.fin#0A..4}#0A..1}#0A..1#0A
..1selectoutput(sysprint)#0A#0A..1{..LET.b.#3D.VEC.
64/bytesperword#0A..4chbuf.:#3D.b#0A..4FOR.i.#3D.0.
TO.63.DO.chbuf%i.:#3D.0#0A..4chcount,.lineno.:#3D.0
,.findfileno(argv!0)<<00024.|.1#0A..4rch()#0A.#0A..
4UNTIL.ch#3Dendstreamch.DO#0A..4{..LET.tree.#3D.?#0A
..7treep.:#3D.treevec.+.treesize#0A.#0A..7tree.:#3D
.formtree()#0A..7IF.tree#3D0.BREAK#0A.#0A..7//write
f("*nTree.size.%n*n",.treesize+treevec-treep)#0A.#0A
..7IF.prtree.DO.{..writes("Parse.Tree*n")#0A..23pli
st(tree,.0,.20)#0A..23newline()#0A..20}#0A..#0A..7U
NLESS.errcount#3D0.GOTO.fin#0A..7selectoutput(mcode
out)#0A..7translate(tree)#0A..7selectoutput(sysprin
t)#0A..4}#0A..1}#0A..1#0A..1selectinput(sourcestrea
m);..endread();..1sourcestream.:#3D.0#0A..1selectou
tput(mcodeout);..3endwrite();..mcodeout.:#3D.0#0A#0A
..1selectoutput(sysprint)#0A#0A..1UNLESS.errcount#3D
0.GOTO.fin#0A#0A..1mcodein.:#3D.findinput("MCODE")#0A
..1IF.mcodein#3D0.DO#0A..1{..writef("Trouble.readin
g.file.MCODE*n")#0A..4errcount.:#3D.1#0A..4GOTO.fin
#0A..1}#0A#0A..1IF.argv!1#3D0.DO.argv!1.:#3D."MINTC
ODE"#0A#0A..1tostream.:#3D.findoutput(argv!1)#0A..1
IF.tostream#3D0.DO#0A..1{..writef("Trouble.with.cod
e.file.%s*n",.argv!1)#0A..4errcount.:#3D.1#0A..4GOT
O.fin#0A..1}#0A#0A..1selectinput(mcodein)#0A..1code
generate(treevec,.treesize,.bining,.debug,.bigender
,.naming)#0A#0A..1selectoutput(sysprint)#0A#0Afin:#0A
..1UNLESS.treevec#3D0..5DO.freevec(treevec)#0A..1UN
LESS.sourcestream#3D0..DO.{..selectinput(sourcestre
am);.endread()..}#0A..1UNLESS.mcodeout#3D0..4DO.{..
selectoutput(mcodeout);..2endwrite().}#0A..1UNLESS.
mcodein#3D0..5DO.{..selectinput(mcodein);..4endread
()..}#0A..1UNLESS.tostream#3D0..4DO.{..selectoutput
(tostream)#0A..30UNLESS.tostream#3Dstdout.DO..endwr
ite().}#0A..1UNLESS.sysprint#3Dstdout.DO.{..selecto
utput(sysprint);..2endwrite().}#0A..1freefilelist(f
ilelist)#0A..1selectoutput(stdout)#0A..1UNLESS.errc
ount#3D0.RESULTIS.20#0A..1RESULTIS.0#0A}#0A#0A//.St
art.of.the.MCODE->Mintcode.Codegenerator#0A#0AMANIF
EST.{.#0A//.Object.module.item.types#2E#0At_hunk..#3D
.2001..5//.hunk..1n..w1.#2E#2E1.wn#0At_reloc.#3D.20
00001..5//.reloc..n..a1.#2E#2E1.an#0At_end..1#3D.20
00002..5//.end#0A#0Amodword..1#3D.#23xFDDF..1//.MOD
ULE.and.Entry.marker.words#2E#0Aentryword.#3D.#23xD
FDF#0A#0A..13//.MCODE.operators#0As_ln#3D1#0As_true
#3D5#0As_false#3D6#0As_query#3D7#0A#0As_lp#3D10#0As
_lg#3D11#0A#0As_llp#3D13#0As_llg#3D14#0A#0As_sp#3D1
6#0As_sg#3D17#0As_lf#3D18#0As_lx#3D19#0A#0As_neg#3D
21#0As_abs#3D22#0As_not#3D23#0As_bitnot#3D24#0A#0As
_callc#3D29;#0As_call#3D30;#0As_indw#3D31;#0As_indw
0#3D32;#0As_indb#3D33;.#0As_indb0#3D34;#0As_lsh#3D3
5;..//.in.same.order.as.op:#3D.operators.#0As_rsh#3D
36;..#0As_mult#3D37;.#0As_div#3D38;.#0As_mod#3D39;.
#0As_bitand#3D40;.#0As_xor#3D41;#0As_plus#3D42;#0As
_sub#3D43;#0As_bitor#3D44;.#0A#0As_eq#3D45;.#0As_ne
#3D46;.#0As_le#3D47;.#0As_ge#3D48;.#0As_ls#3D49;.#0A
s_gr#3D50;.#0As_rel#3D51;#0A#0As_ptr#3D59;#0As_ll#3D
60#0As_ll1#3D61#0As_sl#3D62#0As_lpath#3D63#0As_llpa
th#3D64#0As_spath#3D65#0As_stw#3D66#0As_stb#3D67#0A
s_lvindw#3D68#0As_cpr#3D69#0A#0As_jt#3D70#0As_jf#3D
71#0As_lab#3D72#0As_stack#3D73#0A#0As_dup#3D79#0As_
lr#3D80#0As_str#3D81#0As_jump#3D82#0As_dlab#3D83#0A
s_dw#3D84#0As_db#3D85#0As_dl#3D86#0As_ds#3D87#0A#0A
s_inc1b#3D90;.#0As_inc4b#3D91;.#0As_dec1b#3D92;.#0A
s_dec4b#3D93#0As_inc1a#3D94;.#0As_inc4a#3D95;.#0As_
dec1a#3D96;.#0As_dec4a#3D97#0A#0As_goto#3D103;.#0As
_raise#3D104;.#0As_handle#3D105#0A#0As_match#3D120;
.#0As_return#3D124#0A#0As_module#3D145#0As_endmodul
e#3D146;#0A#0As_global#3D150#0As_fun#3D151#0As_cfun
#3D152#0As_endfun#3D153#0As_unhandle#3D156#0As_line
#3D157#0As_file#3D158#0As_setargs#3D159#0As_fnargs#3D
160;.#0As_locs#3D161;.#0A#0As_none#3D200#0A#0A..11/
/..Selectors#0Ah1#3D0;.h2#3D1;.h3#3D2;.h4#3D3#0A#0A
hashtabsize#3D63#0A}#0A#0AGLOBAL.{.#0Acgmodules:.40
1#0Ardn..4:.402#0Ardl..4:.403#0Ardgn..3:.404#0Ardst
r..2:.405#0Anewlab..1:.406#0Achecklab.:.407#0Acgerr
or..:.408#0A#0Ainitstack:.410#0Astack..2:.411#0Asto
re..2:.412#0Ascan..3:.413#0Acgpendingop:414#0Aloadv
al..:.415#0Aloadba..1:.416#0Asetba..2:.417#0A#0Agen
xch..1:.420#0Agenatb..1:.421#0Aloada..2:.422#0Apush
..3:.423#0Aloadboth.:.424#0Ainreg_a..:.425#0Ainreg_
b..:.426#0Aaddinfo_a:.427#0Apushinfo.:.428#0Axchinf
o..:.429#0Aatbinfo..:.430#0A#0Aforget_a.:.431#0Afor
get_b.:.432#0Aforgetall:.433#0Aforgetvar:.434#0Afor
getallvars:.435#0A#0Aiszero..1:.437#0Astoret..1:.43
8#0Agensp..2:.439#0Agenlp..2:.440000#0Agenllp..1:.4
40001#0Agenln..2:.440002#0Aloadt..2:.440003#0Alose1
..2:.441#0Aswapargs.:.440005#0Acgstw..2:.440006#0As
torein..:.440007#0A#0Acginc..2:.440009#0Acgplus..1:
.450#0Acgaddk..1:.451#0Acgglobal.:.452#0Acgentry..:
.453#0Acgcall..1:.455#0Acgjump..1:.457#0Ajmpfn..2:.
458#0Ajfn0..3:.459#0Arevjfn..1:.460#0Acompjfn..:.46
1#0Aprepj..2:.462#0Acgraise..:.463#0A#0Acgstring.:.
475#0Asetlab..1:.476#0Acgstatics:.477#0Agetblk..1:.
478#0Afreeblk..:.479#0Afreeblks.:.480#0A#0Ainitdata
lists.:.481#0A#0Ageng..3:.490#0Agen..4:.491#0Agenb.
.3:.492#0Agenr..3:.493#0Agenh..3:.494#0Agenw..3:.49
5#0Acheckspace.:.496#0Acodeb..2:.497#0Acode2b..1:.4
98#0Acode4b..1:.499#0Apack4b..1:.500#0Acodec..2:.50
1#0Acodeh..2:.502#0Acodew..2:.503#0Acodewl..1:.504#0A
coder..2:.505#0A#0Agetw..3:.508#0Aputh..3:.509#0Apu
tw..3:.510#0Aalign..2:.511#0Achkrefs..:.512#0Adealw
ithrefs:513#0Agenindword:514#0Ainrange_d:.515#0Ainr
ange_i:.516#0Afillref_d:.517#0Afillref_i:.518#0Arel
ref:..002519#0A#0Aoutputmodule.:.520#0Aobjword..:.5
21#0Adboutput.:.522#0Awrkni..2:.523#0Awrcode..1:.52
4#0Awrfcode..:.525#0A#0A//.Global.variables#2E#0Aar
g1..3:.531#0Aarg2..3:.532#0Abining..1:.533#0A#0Ach.
.5:.536#0Adebug..2:.537#0Alineno..1:.538#0A#0Anlist
..2:.540#0Anliste..1:.541#0Adp..5:.542#0Afreelist.:
.543#0A#0Aincode..1:.545#0Alabv..3:.546#0A#0Abigend
er.:.548#0A#0Amaxgn..2:.550000#0Amaxlab..1:.550001#0A
maxssp..1:.550002#0Anaming..1:.550003#0A#0Aop..5:.5
51#0Alabnumber.:.550006#0Apendingop:.550007#0A#0Apr
ogsize.:.560#0Ainfo_a..1:.561#0Ainfo_b..1:.562#0Are
flist..:.565#0Arefliste.:.566#0Arlist..2:.568#0Arli
ste..1:.569#0Askiplab..:.570#0Assp..4:.571#0Arelocl
ist.:.572#0Arelocliste:.573#0A#0Astv..4:.580#0Astvp
..3:.581#0Atempt..2:.583#0Atempv..2:.584#0A#0Ahasht
ab..:.590#0Acharv..2:.591#0Alookup..1:.592#0Anewvec
..1:.593#0A}#0A#0A1MANIFEST#0A{.#0A//.Value.descrip
tors#2E#0Ak_none#3D0;.k_numb#3D1;.k_fnlab#3D2#0Ak_l
vloc#3D3;.k_lvloci#3D4;.k_lvglob#3D5;.k_lvlab#3D6#0A
k_a#3D7;.k_b#3D8#0Ak_loc#3D9;.k_glob#3D10;.k_ext#3D
11;.k_lab#3D12;#0Ak_glob0#3D24;.k_glob1#3D25;.k_glo
b2#3D26#0Ak_loci#3D30#0A#0Aswapped#3DTRUE;.notswapp
ed#3DFALSE#0A#0A}#0A#0A//.MINTCODE.function.codes#2E
#0AMANIFEST.{.#0Af_k0..1#3D..0010#0A#0Af_lf..1#3D..
00012#0Af_lm..1#3D..00014#0Af_lm1..#3D..00015#0Af_l
0..1#3D..00016#0Af_fhop.#3D..00027#0Af_jeq..#3D..00
028#0Af_jeq0.#3D..00030#0A#0Af_k..2#3D..00032#0Af_k
h..1#3D..00033#0Af_kw..1#3D..00034#0Af_k0g..#3D..00
032#0Af_s0g..#3D..00044#0Af_l0g..#3D..00045#0Af_l1g
..#3D..00046#0Af_l2g..#3D..00047#0Af_lg..1#3D..0004
8#0Af_sg..1#3D..00049#0Af_llg..#3D..00050#0Af_ag..1
#3D..00051#0Af_mul..#3D..00052#0Af_div..#3D..00053#0A
f_mod..#3D..00054#0Af_xor..#3D..00055#0Af_sl..1#3D.
.00056#0Af_ll..1#3D..00058#0Af_jne..#3D..00060#0Af_
jne0.#3D..00062#0A#0Af_llp..#3D..00064#0Af_llph.#3D
..00065#0Af_llpw.#3D..00066#0Af_add..#3D..00084#0Af
_sub..#3D..00085#0Af_lsh..#3D..00086#0Af_rsh..#3D..
00087#0Af_and..#3D..00088#0Af_or..1#3D..00089#0Af_l
l1..#3D..00090#0Af_jls..#3D..00092#0Af_jls0.#3D..00
094#0A#0Af_l..2#3D..00096#0Af_lh..1#3D..00097#0Af_l
w..1#3D..00098#0Af_rv..1#3D.110006#0Af_rtn..#3D.123
#0Af_jgr..#3D.124#0Af_jgr0.#3D.126#0A#0Af_lp..1#3D.
128#0Af_lph..#3D.129#0Af_lpw..#3D.130#0Af_lp0..#3D.
128#0A#0Af_lvind#3D.146#0Af_stb..#3D.147#0Af_st..1#3D
.148#0A#0Af_jle..#3D.156#0Af_jle0.#3D.158#0A#0Af_sp
..1#3D.160#0Af_sph..#3D.161#0Af_spw..#3D.162#0Af_sp
0..#3D.160#0Af_s0..1#3D.176#0Af_xch..#3D.181#0Af_in
db.#3D.182#0Af_indb0#3D.183#0Af_atc..#3D.184#0Af_at
b..#3D.185#0Af_j..2#3D.186#0Af_jge..#3D.188#0Af_jge
0.#3D.190#0A#0Af_ap..1#3D.192#0Af_aph..#3D.193#0Af_
apw..#3D.194#0Af_ap0..#3D.192#0Af_indw.#3D.205#0Af_
lmh..#3D.206#0Af_btc..#3D.207#0Af_nop..#3D.208#0Af_
a0..1#3D.208#0Af_rvp0.#3D.211#0Af_st0p0#3D.216#0Af_
st1p0#3D.218#0Af_cta..#3D.220003#0A#0Af_a..2#3D.220
004#0Af_ah..1#3D.220005#0Af_aw..1#3D.220006#0Af_l0p
0.#3D.220004#0Af_s..2#3D.237#0Af_sh..1#3D.238#0Af_m
div.#3D.239#0Af_chgco#3D.240#0Af_neg..#3D.241#0Af_n
ot..#3D.242#0Af_inc1b#3D.243#0Af_inc4b#3D.244#0Af_d
ec1b#3D.245#0Af_dec4b#3D.246#0Af_inc1a#3D.247#0Af_i
nc4a#3D.248#0Af_dec1a#3D.249#0Af_dec4a#3D.250#0A#0A
f_hand.#3D.252#0Af_unh..#3D.254#0Af_raise#3D.255#0A
}#0A#0A1LET.codegenerate(workspace,.workspacesize,.
bin,.dbg,.bige,.names).BE#0A{..//writes("MintCG.9.J
uly.1990007*n")#0A#0A..1IF.workspacesize<2001.DO.{.
.cgerror("Too.little.workspace")#0A..29errcount.:#3D
.errcount+1#0A..29longjump(fin_p,.fin_l)#0A..26}#0A
#0A..1//.Set.the.codegenerator.options#0A..1bining,
.debug,.bigender,.names.:#3D.bin,.dbg,.bige,.names#0A
#0A..1progsize.:#3D.0#0A#0A..1op.:#3D.rdn()#0A#0A..
1cgmodules(workspace,.workspacesize)..1#0A#0A..1wri
tef("Program.size.#3D.%n*n",.progsize)#0A}#0A#0AAND
.cgmodules(workvec,.vecsize).BE.UNTIL.op#3D0.DO#0A{
..LET.p.#3D.workvec#0A..1dp.:#3D.workvec+vecsize#0A
..1stv.:#3D.p#0A..1stvp.:#3D.0#0A#0A..1tempv.:#3D.n
ewvec(400)#0A..1tempt.:#3D.tempv+400#0A..1labv.:#3D
.p#0A..1labnumber.:#3D.(dp-p)/10+10#0A..1labv.:#3D.
newvec(labnumber)#0A..1FOR.i.#3D.0.TO.labnumber.DO.
labv!i.:#3D.-1#0A..1hashtab.:#3D.newvec(hashtabsize
)#0A..1FOR.i.#3D.0.TO.hashtabsize.DO.hashtab!i.:#3D
.0#0A..1charv.:#3D.newvec(1024)#0A#0A..1incode.:#3D
.FALSE#0A..1maxlab.:#3D.0#0A..1maxssp.:#3D.0#0A..1m
axgn..:#3D.0#0A..1info_a,.info_b.:#3D.0,.0#0A..1ini
tstack(3)#0A..1initdatalists()#0A#0A..1WHILE.op#3Ds
_file.DO.{..rdn();.rdstr();.op.:#3D.rdn().}#0A#0A..
1codew(0)..//.For.size.of.module#2E#0A..1IF.op#3Ds_
module.DO#0A..1{..LET.n.#3D.rdn()#0A..4LET.v.#3D.VE
C.3#0A..4v%0.:#3D.7#0A..4FOR.i.#3D.1.TO.n.DO..{..LE
T.c.#3D.rdn()#0A..26IF.i<#3D7.DO.v%i.:#3D.c#0A..23}
#0A..4FOR.i.#3D.n+1.TO.7.DO.v%i.:#3D.32..//ASCII.sp
ace#2E#0A..4IF.naming.DO#0A..4{..codew(modword)#0A.
.7codew(pack4b(v%1,.v%2,.v%3,.v%4))#0A..7codew(pack
4b(v%5,.v%6,.v%7,.0))#0A..4}#0A..4op.:#3D.rdn()#0A.
.1}#0A#0A..1scan()#0A..1op.:#3D.rdn()#0A..1putw(0,.
stvp/4)..//.Plant.size.of.module#2E#0A..1outputmodu
le()#0A..1progsize.:#3D.progsize.+.stvp#0A}#0A#0A1/
/.Read.an.MCODE.operator.or.argument#2E#0AAND.rdn()
.#3D.VALOF#0A{..LET.a,.neg.#3D.0,.FALSE#0A..1ch.:#3D
.rdch().REPEATWHILE.ch#3D'*s'.|.ch#3D'*n'#0A..1IF.c
h#3Dendstreamch.RESULTIS.0#0A..1IF.ch#3D'-'.DO.{..n
eg.:#3D.TRUE;.ch.:#3D.rdch().}#0A..1WHILE.'0'<#3Dch
<#3D'9'.DO.{..a.:#3D.10*a.+.ch.-.'0';.ch.:#3D.rdch(
)..}#0A..1IF.neg.RESULTIS.-a#0A..1RESULTIS.a#0A}#0A
#0A//.Read.in.an.MCODE.label#2E#0AAND.rdl().#3D.VAL
OF#0A{..LET.lab.#3D.rdn()#0A..1IF.maxlab<lab.DO.{..
maxlab.:#3D.lab;.checklab().}#0A..1RESULTIS.lab#0A}
#0A#0A//.Read.in.a.global.number#2E#0AAND.rdgn().#3D
.VALOF#0A{..LET.gn.#3D.rdn()#0A..1IF.maxgn<gn.DO.ma
xgn.:#3D.gn#0A..1RESULTIS.gn#0A}#0A#0A1//.Read.in.a
n.MCODE.string.(known.to.have.length<#3D255)#0AAND.
rdstr().#3D.VALOF#0A{..LET.len.#3D.rdn().&.255#0A..
1charv%0.:#3D.len#0A..1FOR.i.#3D.1.TO.len.DO.charv%
i.:#3D.rdn()#0A..1RESULTIS.lookup(charv)#0A}#0A#0AA
ND.lookup(str).#3D.VALOF#0A{..LET.len,.i.#3D.str%0,
.0#0A..1LET.hashval.#3D.19609.//.This.and.31397.are
.primes#2E#0A..1LET.node.#3D.?#0A..1FOR.i.#3D.0.TO.
len.DO.hashval.:#3D.(hashval.NEQV.str%i).*.31397#0A
..1hashval.:#3D.(hashval>>0001).REM.hashtabsize#0A#0A
..1node.:#3D.hashtab!hashval#0A.#0A..1UNTIL.node#3D
0.|.i>len.TEST.(@h2!node)%i#3Dstr%i#0A..22THEN.i.:#3D
.i+1#0A..22ELSE.node,.i.:#3D.h1!node,.0#0A.#0A..1IF
.node#3D0.DO#0A..1{..node.:#3D.newvec(len/bytesperw
ord+2)#0A..4h1!node.:#3D.hashtab!hashval#0A..4FOR.i
.#3D.0.TO.len.DO.(@h2!node)%i.:#3D.str%i#0A..4hasht
ab!hashval.:#3D.node#0A..1}#0A.#0A..1RESULTIS.node+
1#0A}#0A#0AAND.newvec(upb).#3D.VALOF#0A{..dp.:#3D.d
p-upb-1#0A..1checkspace()#0A..1RESULTIS.dp#0A}#0A#0A
//.Generate.next.label.number#2E#0AAND.newlab().#3D
.VALOF#0A{..labnumber.:#3D.labnumber-1#0A..1checkla
b()#0A..1RESULTIS.labnumber#0A}#0A#0A1AND.checklab(
).BE.IF.maxlab>#3Dlabnumber.DO#0A{..cgerror("Too.ma
ny.labels.-.increase.workspace")#0A..1errcount.:#3D
.errcount+1#0A..1longjump(fin_p,.fin_l)#0A}#0A#0AAN
D.cgerror(mes,.a).BE#0A{..LET.oldout.#3D.output()#0A
..1selectoutput(sysprint)#0A..1writes("*nError:.")#0A
..1writef(mes,.a)#0A..1newline()#0A..1errcount.:#3D
.errcount+1#0A..1IF.errcount>errmax.DO.{..writes("T
oo.many.errors*n")#0A..26longjump(fin_p,.fin_l)#0A.
.23}#0A..1selectoutput(oldout)#0A}#0A#0A1//.Initial
ize.the.simulated.stack.(SS)#2E#0A//.SS.cells.are.o
f.the.form.[k,.n,.i,.s]#0A//.where.k..2is.the.kind.
k_loc.etc#0A//..5n,.i.are.arguments#0A//..5s..2is.t
he.position.rel.to.P.of.this.item#0ALET.initstack(n
).BE#0A{..arg2,.arg1,.ssp.:#3D.tempv,.tempv+4,.n#0A
..1pendingop.:#3D.s_none#0A..1h1!arg2,.h2!arg2,.h4!
arg2.:#3D.k_loc,.ssp-2,.ssp-2#0A..1h1!arg1,.h2!arg1
,.h4!arg1.:#3D.k_loc,.ssp-1,.ssp-1#0A..1IF.maxssp<s
sp.DO.maxssp.:#3D.ssp#0A}#0A#0A1//.Move.simulated.s
tack.pointer.to.n#2E#0AAND.stack(n).BE#0A{..IF.maxs
sp<n.DO.maxssp.:#3D.n#0A..1IF.n>#3Dssp+4.DO.{..stor
e(0,.ssp-1)#0A..19initstack(n)#0A..19RETURN#0A..16}
#0A#0A..1WHILE.n>ssp.DO.loadt(k_loc,.ssp)#0A#0A..1U
NTIL.n#3Dssp.DO#0A..1{..IF.arg2#3Dtempv.DO#0A..4{..
TEST.n#3Dssp-1#0A..7THEN.{..ssp.:#3D.n#0A..15h1!arg
1,.h2!arg1,.h3!arg1.:#3D.h1!arg2,.h2!arg2,.h3!arg2#0A
..15h4!arg1.:#3D.ssp-1#0A..15h1!arg2,.h2!arg2,.h4!a
rg2.:#3D.k_loc,.ssp-2,.ssp-2#0A..12}#0A..7ELSE.init
stack(n)#0A..7RETURN#0A..4}#0A#0A..4arg1,.arg2,.ssp
.:#3D.arg1-4,.arg2-4,.ssp-1#0A..1}#0A}#0A#0A//.Stor
e.all.SS.items.from.s1.to.s2.in.their.true#0A//.loc
ations.on.the.stack#2E#0A//.It.may.corrupt.both.reg
isters.A.and.B#2E#0AAND.store(s1,.s2).BE.FOR.p.#3D.
tempv.TO.arg1.BY.4.DO#0A..19{..LET.s.#3D.h4!p#0A..2
2IF.s>s2.RETURN#0A..22IF.s>#3Ds1.DO.storet(p)#0A..1
9}#0A#0A2//.Store.any.SS.items.holding.value.(k,n).
in.their.temporary#0A//.stack.locations#2E.It.may.c
orrupt.both.registers.A.and.B#2E#0A//.It.is.called.
from.storein#0AAND.storetemp(k,.n,.s1,.s2).BE#0A..F
OR.p.#3D.tempv.TO.arg2.BY.4.IF.h1!p#3Dk.&.h2!p#3Dn.
DO.storet(p)#0A#0A2AND.scan().BE#0A{..IF.debug>1.DO
.{..dboutput()#0A..18writef("op#3D%i3/%i3*n",.op,.p
endingop)#0A..15}#0A#0A..1SWITCHON.op.INTO#0A#0A..1
{..DEFAULT:..7cgerror("Bad.MCODE.op.%n*n",.op);.END
CASE#0A#0A..4CASE.0:..8RETURN#0A..4#0A//.lx.n.c1.#2E
#2E1.cn..3n<#3D255#0A..4CASE.s_lx:..5loadt(k_ext,.r
dstr());..10ENDCASE#0A#0A//.lpath.n.i..8load.p!n!i.
.4n~#3D0#0A..4CASE.s_lpath:..1{..LET.n.#3D.rdn()#0A
..23LET.i.#3D.rdn()#0A..23loadt(k_loci,.n,.i)#0A..2
3ENDCASE..2#0A..20}#0A#0A//.llpath.n.i..7load.@.p!n
!i..4n~#3D0#0A..4CASE.s_llpath:..{..LET.n.#3D.rdn()
#0A..23LET.i.#3D.rdn()#0A..23loadt(k_lvloci,.n,.i)#0A
..23ENDCASE..2#0A..20}#0A#0A//.spath.n.i..8store.p!
n!i..4n~#3D0#0A..4CASE.s_spath:..1{..LET.n.#3D.rdn(
)#0A..23LET.i.#3D.rdn()#0A..23storein(k_loci,.n,.i)
#0A..23ENDCASE..2#0A..20}#0A..1#0A//.setargs.len.ar
gpos#0A..4CASE.s_setargs:.{..LET.n.#3D.rdn()#0A..23
LET.pos.#3D.rdn()#0A..23cgpendingop()#0A..23FOR.i.#3D
.n-1.TO.0.BY.-1.DO#0A..23{..loada(arg1)#0A..26gensp
(pos+i)#0A..26stack(ssp-1)#0A..23}.#0A..23ENDCASE#0A
..20}#0A#0A..4CASE.s_stw:..4cgstw()#0A..21ENDCASE#0A
#0A..4CASE.s_stb:..4cgpendingop()#0A..21loadba(arg1
,.arg2)#0A..21gen(f_stb)#0A..21stack(ssp-2)#0A..21E
NDCASE#0A#0A..4CASE.s_lvindw:#0A..4CASE.s_indw:..#0A
..4CASE.s_indw0:.#0A..4CASE.s_indb0:.#0A..4CASE.s_i
ndb:..#0A..4CASE.s_mult:CASE.s_div:CASE.s_mod:#0A..
4CASE.s_plus:CASE.s_sub:#0A..4CASE.s_eq:.CASE.s_ne:
#0A..4CASE.s_ls:CASE.s_gr:CASE.s_le:CASE.s_ge:#0A..
4CASE.s_lsh:CASE.s_rsh:#0A..4CASE.s_bitand:CASE.s_b
itor:CASE.s_xor:#0A..21cgpendingop()#0A..21pendingo
p.:#3D.op#0A..21ENDCASE#0A#0A..4CASE.s_str:..4cgpen
dingop()#0A..21loada(arg1)#0A..21gen(f_atc)#0A..21s
tack(ssp-1);..10ENDCASE#0A..4CASE.s_cpr:..4cgpendin
gop()#0A..21loada(arg1)#0A..21gen(f_atc);..12ENDCAS
E#0A..4CASE.s_dup:..4cgpendingop()#0A..21loada(arg1
)#0A..21storet(arg1)#0A..21loadt(k_a,.0);..9ENDCASE
#0A..4CASE.s_lr:..5forgetall()#0A..21gen(f_cta)#0A.
.21loadt(k_a,.0);..9ENDCASE#0A#0A..4CASE.s_ptr:..4l
oadt(k_loc,.ssp);..5ENDCASE#0A#0A..4CASE.s_true:..3
loadt(k_numb,.-1);..5ENDCASE#0A..4CASE.s_false:..2l
oadt(k_numb,.0);..6ENDCASE#0A..4CASE.s_query:..2loa
dt(k_loc,.ssp);..5ENDCASE#0A..4CASE.s_stack:cgpendi
ngop();.stack(rdn());.ENDCASE#0A#0A..4CASE.s_inc1b:
..2cginc(f_inc1b);..8ENDCASE#0A..4CASE.s_inc4b:..2c
ginc(f_inc4b);..8ENDCASE#0A..4CASE.s_dec1b:..2cginc
(f_dec1b);..8ENDCASE#0A..4CASE.s_dec4b:..2cginc(f_d
ec4b);..8ENDCASE#0A..4CASE.s_inc1a:..2cginc(f_inc1a
);..8ENDCASE#0A..4CASE.s_inc4a:..2cginc(f_inc4a);..
8ENDCASE#0A..4CASE.s_dec1a:..2cginc(f_dec1a);..8END
CASE#0A..4CASE.s_dec4a:..2cginc(f_dec4a);..8ENDCASE
#0A#0A..4CASE.s_bitnot:CASE.s_not:CASE.s_neg:CASE.s
_abs:#0A..21cgpendingop()#0A..21pendingop.:#3D.op#0A
..21ENDCASE#0A#0A..4CASE.s_unhandle:.gen(f_unh)#0A.
.21ENDCASE#0A#0A..4CASE.s_return:..1cgpendingop()#0A
..21gen(f_rtn)#0A..21incode.:#3D.FALSE#0A..21ENDCAS
E#0A#0A..4CASE.s_fnargs:..#0A..18{..LET.a.#3D.rdn()
#0A..21IF.a>0.DO.addinfo_a(k_loc,.3)#0A..21stack(3+
a)#0A..21ENDCASE#0A..18}#0A#0A..4CASE.s_match:..2rd
n()..1//.ss.position.of.first.match.arg#0A..21rdn()
;..//.Number.of.match.args#0A..21store(0,.ssp).//.E
nsure.everything.is.in.memory#0A..21//cgerror("Unim
plemented.op.in.scan.%n*n",.op)#0A..21ENDCASE#0A#0A
..4CASE.s_raise:..2cgraise(rdn())#0A..21incode.:#3D
.FALSE#0A..21ENDCASE#0A#0A..4CASE.s_locs:..3stack(s
sp+rdn());..9ENDCASE#0A#0A..4CASE.s_lp:..5loadt(k_l
oc,.rdn(),.0);..3ENDCASE#0A..4CASE.s_lg:..5loadt(k_
glob,.rdgn(),.0);..1ENDCASE#0A..4CASE.s_llp:..4load
t(k_lvloc,.rdn(),.0);..1ENDCASE#0A..4CASE.s_llg:..4
loadt(k_lvglob,.rdgn(),.0);.ENDCASE#0A#0A..4CASE.s_
ln:..5loadt(k_numb,..rdn(),.0);..1ENDCASE#0A#0A..4C
ASE.s_sp:..5storein(k_loc,..rdn(),.0);..ENDCASE#0A.
.4CASE.s_sg:..5storein(k_glob,.rdgn(),.0);.ENDCASE#0A
#0A//.call.k..11call.a.procedure.incrementing.P.by.
k#0A..4CASE.s_call:..3cgcall(rdn())#0A..21ENDCASE#0A
#0A..4CASE.s_jump:..3cgpendingop()#0A..21store(0,.s
sp-1)#0A..21forgetall()#0A..21genr(f_j,.rdl());..9E
NDCASE#0A#0A..4CASE.s_handle:..1cgpendingop()#0A..2
1store(0,.ssp-1)#0A..21forgetall()#0A..21genllp(ssp
)#0A..21genr(f_hand,.rdl())#0A..21stack(ssp+3)#0A..
21ENDCASE#0A#0A..4CASE.s_jt:..5cgjump(TRUE,.rdl());
..6ENDCASE#0A..4CASE.s_jf:..5cgjump(FALSE,.rdl());.
.5ENDCASE#0A#0A..4CASE.s_ll:..5loadt(k_lab,.rdl(),.
0);..3ENDCASE#0A..4CASE.s_ll1:..4loadt(k_lvlab,.rdl
(),.0);..1ENDCASE#0A#0A..4CASE.s_lf:..5loadt(k_fnla
b,.rdl(),.0);..1ENDCASE#0A#0A..4CASE.s_sl:..5storei
n(k_lab,.rdl(),.0);..1ENDCASE#0A#0A..4CASE.s_lab:..
4cgpendingop()#0A..21UNLESS.incode.DO.chkrefs(30)#0A
..21store(0,.ssp-1)#0A..21setlab(rdl())#0A..21incod
e.:#3D.TRUE#0A..21forgetall()#0A..21ENDCASE#0A#0A..
4CASE.s_fun:#0A..4CASE.s_cfun:..{..LET.lab.#3D.rdl(
)#0A..21LET.name.#3D.rdstr()#0A..21LET.type.#3D.op#3D
s_fun.->.0,.rdstr()#0A..21cgentry(lab,.name,.type).
#0A..21ENDCASE#0A..18}#0A#0A..4CASE.s_callc:.{..rdn
()#0A..21rdstr()#0A..21cgerror("Unimplemented.op.in
.scan.%n*n",.op)#0A..21ENDCASE#0A..18}#0A..17#0A..4
CASE.s_endfun:..1ENDCASE#0A#0A..4CASE.s_global:..1c
gglobal(rdn());.ENDCASE#0A#0A..4CASE.s_endmodule:.R
ETURN#0A#0A..4CASE.s_dlab:..3chkrefs(512)#0A..21ali
gn(4)#0A..21setlab(rdl())#0A..21ENDCASE#0A#0A..4CAS
E.s_dw:..5codew(rdn());..ENDCASE#0A..4CASE.s_db:..5
codec(rdn());..ENDCASE#0A..4CASE.s_dl:..5codewl(rdl
());.ENDCASE#0A..4CASE.s_ds:..2{..LET.n.#3D.rdn()#0A
..21FOR.i.#3D.1.TO.n.DO.codew(0)#0A..21ENDCASE#0A..
18}#0A#0A..4CASE.s_line:..{..LET.fno.#3D.rdn()#0A..
21LET.ln..#3D.rdn()#0A..21lineno.:#3D.fno<<00024.|.
ln#0A..21IF.debug>0.DO.writef("//.line.%n*n",.ln)#0A
..21ENDCASE#0A..18}#0A..1}#0A#0A..1op.:#3D.rdn()#0A
}.REPEAT#0A#0A1//.Compiles.code.to.deal.with.any.pe
nding.op#2E#0ALET.cgpendingop().BE#0A{..LET.f.#3D.0
#0A..1LET.sym.#3D.TRUE#0A..1LET.pndop.#3D.pendingop
#0A..1pendingop.:#3D.s_none#0A#0A..1SWITCHON.pndop.
INTO#0A..1{..DEFAULT:..4cgerror("Bad.pendingop.%n",
.pndop)#0A#0A..4CASE.s_none:..RETURN#0A#0A..4CASE.s
_abs:..1loada(arg1)#0A..18chkrefs(3)#0A..18genb(jfn
0(f_jgr),.2).//.Conditionally.skip#0A..18gen(f_neg)
..9//.over.this.NEG.instruction#2E#0A..18forget_a()
#0A..18RETURN#0A#0A..4CASE.s_neg:..1loada(arg1)#0A.
.18gen(f_neg)#0A..18forget_a()#0A..18RETURN#0A#0A..
4CASE.s_bitnot:#0A..4CASE.s_not:..1loada(arg1)#0A..
18gen(f_not)#0A..18forget_a()#0A..18RETURN#0A#0A..4
CASE.s_lvindw:.loadba(arg2,.arg1)#0A..19gen(f_lvind
)#0A..19lose1(k_a,.0,.0)#0A..19forget_a()#0A..19RET
URN#0A#0A..4CASE.s_indw0:.loada(arg1)#0A..18gen(f_r
v)#0A..18forget_a()#0A..18RETURN#0A#0A..4CASE.s_ind
b0:.loada(arg1)#0A..18gen(f_indb0)#0A..18forget_a()
#0A..18RETURN#0A#0A..4CASE.s_eq:.CASE.s_ne:#0A..4CA
SE.s_ls:.CASE.s_gr:#0A..4CASE.s_le:.CASE.s_ge:#0A..
18f.:#3D.prepj(jmpfn(pndop))#0A..18chkrefs(4)#0A..1
8genb(f,.2)..2//.Jump.to..2--1#0A..18gen(f_fhop)..1
//..13|#0A..18gen(f_lm1)..2//.this.point..<-#0A..18
lose1(k_a,.0)#0A..18forget_a()#0A..18RETURN#0A#0A..
4CASE.s_sub:..1UNLESS.k_numb#3Dh1!arg1.DO#0A..18{..
f,.sym.:#3D.f_sub,.FALSE#0A..21ENDCASE#0A..18}#0A..
18h2!arg1.:#3D.-h2!arg1#0A#0A..4CASE.s_plus:..cgplu
s();.RETURN#0A#0A..4CASE.s_indw:..f,.sym.:#3D.f_ind
w,.FALSE;.ENDCASE#0A..4CASE.s_indb:..f..4:#3D.f_ind
b;..6ENDCASE#0A..4CASE.s_mult:..f..4:#3D.f_mul;..7E
NDCASE#0A..4CASE.s_div:..1f,.sym.:#3D.f_div,.FALSE;
..ENDCASE#0A..4CASE.s_mod:..1f,.sym.:#3D.f_mod,.FAL
SE;..ENDCASE#0A..4CASE.s_lsh:..1f,.sym.:#3D.f_lsh,.
FALSE;..ENDCASE#0A..4CASE.s_rsh:..1f,.sym.:#3D.f_rs
h,.FALSE;..ENDCASE#0A..4CASE.s_bitand:f..4:#3D.f_an
d;..7ENDCASE#0A..4CASE.s_bitor:.f..4:#3D.f_or;..8EN
DCASE#0A..4CASE.s_xor:..1f..4:#3D.f_xor;..7ENDCASE#0A
..1}#0A#0A..1TEST.sym.THEN.loadboth(arg2,.arg1)#0A.
.10ELSE.loadba(arg2,.arg1)#0A#0A..1gen(f)#0A..1forg
et_a()#0A#0A..1lose1(k_a,0,0)#0A}#0A#0ALET.loada(x)
..1BE.{..loadval(x,.FALSE);.setba(0,.x).}#0A#0AAND.
push(x,.y).BE.{..loadval(y,.TRUE);..setba(x,.y).}#0A
#0AAND.loadval(x,.pushing).BE..//.ONLY.called.from.
loada.and.push#2E#0A//.Load.compiles.code.to.have.t
he.following.effect:#0A//.If.pushing#3DTRUE..2B.:#3D
.A;.A.:#3D.<x>#2E#0A//.If.pushing#3DFALSE..1B.:#3D.
?;.A.:#3D.<x>#2E#0A{..LET.k,.n,.i.#3D.h1!x,.h2!x,.h
3!x#0A#0A..1UNLESS.pushing.|.k#3Dk_a.DO..//.Dump.A.
register.if.necessary#2E#0A..3FOR.t.#3D.arg1.TO.tem
pv.BY.-4.IF.h1!t#3Dk_a.DO.{..storet(t);.BREAK.}#0A#0A
..1TEST.inreg_a(k,.n,.i).THEN.setba(0,.x)#0A..23ELS
E.IF.inreg_b(k,.n,.i).DO.{..genxch(0,.0)#0A..54RETU
RN#0A..51}#0A..1SWITCHON.h1!x.INTO#0A..1{..DEFAULT:
..cgerror("in.loadval.%n",.k)#0A#0A..4CASE.k_a:.IF.
pushing.UNLESS.inreg_b(k,.n,.i).DO.genatb(0,.0)#0A.
.14RETURN#0A#0A..4CASE.k_numb:#0A..6TEST.-1<#3Dn<#3D
10#0A..6THEN.gen(f_l0+n)#0A..6ELSE.TEST.0<#3Dn<#3D2
55#0A..11THEN.genb(f_l,.n)#0A..11ELSE.TEST.-255<#3D
n<#3D0#0A..16THEN.genb(f_lm,.-n)#0A..16ELSE.TEST.0<
#3Dn<#3D#23xFF2#0A..21THEN.genh(f_lh,.n)#0A..21ELSE
.TEST.-#23xFF2<#3Dn<#3D0#0A..26THEN.genh(f_lmh,.-n)
#0A..26ELSE.genw(f_lw,.n)#0A..6ENDCASE#0A#0A..4CASE
.k_loci:..2genlp(n)..2//.needs.improving.??4#0A..20
TEST.0<#3Di<#3D6.THEN.gen(f_rv+i)#0A..33ELSE.{..cga
ddk(4*i)#0A..41gen(f_rv)#0A..38}#0A..20ENDCASE#0A#0A
..4CASE.k_lvloci:..genlp(n)#0A..20cgaddk(4*h3!x)#0A
..20ENDCASE#0A#0A..4CASE.k_loc:..genlp(n);..6ENDCAS
E#0A..4CASE.k_glob:.geng(f_lg,.n);..1ENDCASE#0A..4C
ASE.k_lab:..genr(f_ll,.n);..1ENDCASE#0A..4CASE.k_fn
lab:genr(f_lf,.n);..1ENDCASE#0A#0A..4CASE.k_lvloc:g
enllp(n);..5ENDCASE#0A#0A..4CASE.k_lvglob:geng(f_ll
g,.n);.ENDCASE#0A..4CASE.k_lvlab:.genr(f_ll1,.n);.E
NDCASE#0A..4CASE.k_glob0:.geng(f_l0g,.n);.ENDCASE#0A
..4CASE.k_glob1:.geng(f_l1g,.n);.ENDCASE#0A..4CASE.
k_glob2:.geng(f_l2g,.n);.ENDCASE#0A..1}#0A#0A..1//.
A.loading.instruction.has.just.been.compiled#2E#0A.
.1pushinfo(h1!x,.h2!x,.h3!x)#0A}#0A#0AAND.loadba(x,
.y).BE.IF.loadboth(x,.y)#3Dswapped.DO.genxch(x,.y)#0A
#0AAND.setba(x,.y).BE#0A{..UNLESS.x#3D0.DO.h1!x.:#3D
.k_b#0A..1UNLESS.y#3D0.DO.h1!y.:#3D.k_a#0A}#0A#0AAN
D.genxch(x,.y).BE.{..gen(f_xch);.xchinfo();.setba(x
,.y).}#0A#0AAND.genatb(x,.y).BE.{..gen(f_atb);.atbi
nfo();.setba(x,.y).}#0A#0AAND.loadboth(x,.y).#3D.VA
LOF#0A//.Compiles.code.to.cause#0A//..1either..2x.-
>.[B]..and..y.->.[A]#0A//..11giving.result.NOTSWAPP
ED#0A//..1or..6x.->.[A]..and..y.->.[B]#0A//..11givi
ng.result.SWAPPED#2E#0A//.LOADBOTH.only.swaps.if.th
is.saves.code#2E#0A{..//.First.ensure.that.no.other
.stack.item.uses.reg.A#2E#0A..1FOR.t.#3D.tempv.TO.a
rg1.BY.4.DO#0A..5IF.h1!t#3Dk_a.UNLESS.t#3Dx.|.t#3Dy
.DO.storet(t)#0A#0A..1{..LET.xa,.ya.#3D.inreg_a(h1!
x,.h2!x,.h3!x),.inreg_a(h1!y,.h2!y,.h3!y)#0A..4AND.
xb,.yb.#3D.inreg_b(h1!x,.h2!x,.h3!x),.inreg_b(h1!y,
.h2!y,.h3!y)#0A#0A..4IF.xb.&.ya.DO.{..setba(x,y);..
13RESULTIS.notswapped.}#0A..4IF.xa.&.yb.DO.{..setba
(y,x);..13RESULTIS.swapped..2}#0A..4IF.xa.&.ya.DO.{
..genatb(x,y);..12RESULTIS.notswapped.}#0A..4IF.xb.
&.yb.DO.{..genxch(0,y);.genatb(x,y);.RESULTIS.notsw
apped.}#0A..4#0A..4IF.xa.DO.{..13push(x,y);.RESULTI
S.notswapped.}#0A..4IF.ya.DO.{..13push(y,x);.RESULT
IS.swapped..2}#0A..4IF.xb.DO.{..genxch(0,x);.push(x
,y);.RESULTIS.notswapped.}#0A..4IF.yb.DO.{..genxch(
0,y);.push(y,x);.RESULTIS.swapped..2}#0A..4#0A..4lo
ada(x)#0A..4push(x,.y)#0A..4RESULTIS.notswapped#0A.
.1}#0A}#0A#0ALET.inreg_a(k,.n,.i).#3D.VALOF#0A{..LE
T.p.#3D.info_a#0A..1IF.k#3Dk_a.RESULTIS.TRUE#0A..1U
NTIL.p#3D0.DO.{..IF.k#3Dh2!p.&.n#3Dh3!p.&.i#3Dh4!p.
RESULTIS.TRUE#0A..17p.:#3D.!p#0A..14}#0A..1RESULTIS
.FALSE#0A}#0A#0AAND.inreg_b(k,.n,.i).#3D.VALOF#0A{.
.LET.p.#3D.info_b#0A..1IF.k#3Dk_b.RESULTIS.TRUE#0A.
.1UNTIL.p#3D0.DO.{..IF.k#3Dh2!p.&.n#3Dh3!p.&.i#3Dh4
!p.RESULTIS.TRUE#0A..17p.:#3D.!p#0A..14}#0A..1RESUL
TIS.FALSE#0A}#0A#0AAND.addinfo_a(k,.n,.i).BE.info_a
.:#3D.getblk(info_a,.k,.n,.i)#0A#0AAND.pushinfo(k,.
n,.i).BE#0A{..forget_b()#0A..1info_b.:#3D.info_a#0A
..1info_a.:#3D.getblk(0,.k,.n,.i)#0A}#0A#0AAND.xchi
nfo().BE#0A#0A{..LET.t.#3D.info_a#0A..1info_a.:#3D.
info_b#0A..1info_b.:#3D.t#0A}#0A#0AAND.atbinfo().BE
#0A{..LET.p.#3D.info_b#0A..1forget_a()#0A..1UNTIL.p
#3D0.DO.{..addinfo_a(h2!p,.h3!p,.h4!p);.p.:#3D.!p.}
#0A}#0A#0AAND.forget_a().BE.{..freeblks(info_a);.in
fo_a.:#3D.0.}#0A#0AAND.forget_b().BE.{..freeblks(in
fo_b);.info_b.:#3D.0.}#0A#0AAND.forgetall().BE.{..f
orget_a();.forget_b().}#0A#0A//.Forgetvar.is.called
.just.after.compiling.an.assigment.to.a.simple#0A//
.variable.(k,.n,.i)#2E..k.is.k_loc,.k_loci,.k_glob,
.k_ext.or.k_lab#2E#0A//.Register.information.about.
indirect.local.values.must.also.be#0A//.thrown.away
#2E#0AAND.forgetvar(k,.n,.i).BE#0A{..LET.p.#3D.info
_a#0A..1UNTIL.p#3D0.DO.{..IF.h3!p#3Dn.&#0A..20(.k#3D
h2!p..&.h4!p#3Di..4|#0A..22k#3Dk_loc.&.h2!p#3Dk_loc
i#0A..20).DO.h2!p.:#3D.k_none#0A..17p.:#3D.!p#0A..1
4}#0A..1p.:#3D.info_b#0A..1UNTIL.p#3D0.DO.{..IF.h3!
p#3Dn.&#0A..20(.k#3Dh2!p..&.h4!p#3Di..4|#0A..22k#3D
k_loc.&.h2!p#3Dk_loci#0A..20).DO.h2!p.:#3D.k_none#0A
..17p.:#3D.!p#0A..14}#0A}#0A#0AAND.forgetallvars().
BE..//.After.compiling.an.indirect.assignment#2E#0A
{..LET.p.#3D.info_a#0A..1UNTIL.p#3D0.DO.{..IF.h2!p>
#3Dk_loc.DO.h2!p.:#3D.k_none#0A..17p.:#3D.!p#0A..14
}#0A..1p.:#3D.info_b#0A..1UNTIL.p#3D0.DO.{..IF.h2!p
>#3Dk_loc.DO.h2!p.:#3D.k_none#0A..17p.:#3D.!p#0A..1
4}#0A}#0A#0AAND.iszero(a).#3D.h1!a#3Dk_numb.&.h2!a#3D
0.->.TRUE,.FALSE#0A#0A//.Store.the.value.of.a.SS.it
em.in.its.true.stack.location#2E#0AAND.storet(x).BE
#0A{..LET.s.#3D.h4!x#0A..1IF.h1!x#3Dk_loc.&.h2!x#3D
s.RETURN#0A..1loada(x)#0A..1gensp(s)#0A..1forgetvar
(k_loc,.s,.0)#0A..1addinfo_a(k_loc,.s,.0)#0A..1h1!x
,.h2!x,.h3!x.:#3D.k_loc,.s,.0#0A}#0A#0AAND.gensp(s)
.BE.TEST.3<#3Ds<#3D16#0A..14THEN.gen(f_sp0+s)#0A..1
4ELSE.TEST.0<#3Ds<#3D255#0A..19THEN.genb(f_sp,.s)#0A
..19ELSE.TEST.0<#3Ds<#3D#23xFF2#0A..24THEN.genh(f_s
ph,.s)#0A..24ELSE.genw(f_spw,.s)#0A#0AAND.genlp(n).
BE.TEST.3<#3Dn<#3D16#0A..14THEN.gen(f_lp0+n)#0A..14
ELSE.TEST.0<#3Dn<#3D255#0A..19THEN.genb(f_lp,.n)#0A
..19ELSE.TEST.0<#3Dn<#3D#23xFF2#0A..24THEN.genh(f_l
ph,.n)#0A..24ELSE.genw(f_lpw,.n)#0A#0AAND.genllp(n)
.BE.TEST.0<#3Dn<#3D255#0A..15THEN.genb(f_llp,.n)#0A
..15ELSE.TEST.0<#3Dn<#3D#23xFF2#0A..20THEN.genh(f_l
lph,.n)#0A..20ELSE.genw(f_llpw,.n)#0A#0AAND.genln(n
).BE.TEST.-1<#3Dn<#3D10#0A..14THEN.gen(f_l0+n)#0A..
14ELSE.TEST.0<#3Dn<#3D255#0A..19THEN.genb(f_l,.n)#0A
..19ELSE.TEST.-255<#3Dn<#3D0#0A..24THEN.genb(f_lm,.
-n)#0A..24ELSE.TEST.0<#3Dn<#3D#23xFF2#0A..29THEN.ge
nh(f_lh,.n)#0A..29ELSE.TEST.-#23xFF2<#3Dn<#3D0#0A..
34THEN.genh(f_lmh,.-n)#0A..34ELSE.genw(f_lw,.n)#0A#0A
//.Load.an.item.(K,N).onto.the.SS#2E.It.may.move.SS
.items#2E#0AAND.loadt(k,.n,.i).BE#0A{..cgpendingop(
)#0A..1TEST.arg1+4#3Dtempt#0A..1THEN.{..storet(temp
v)..//.SS.stack.overflow#2E#0A..9FOR.t.#3D.tempv.TO
.arg2+3.DO.t!0.:#3D.t!4#0A..6}#0A..1ELSE.arg2,.arg1
.:#3D.arg2+4,.arg1+4#0A..1h1!arg1,h2!arg1,h3!arg1,h
4!arg1.:#3D.k,n,i,ssp#0A..1ssp.:#3D.ssp.+.1#0A..1IF
.maxssp<ssp.DO.maxssp.:#3D.ssp#0A}#0A#0A1//.Replace
.the.top.two.SS.items.by.(K,N).and.set.PENDINGOP#3D
S_NONE#2E#0AAND.lose1(k,.n,.i).BE#0A{..ssp.:#3D.ssp
.-.1#0A..1TEST.arg2#3Dtempv#0A..1THEN.{..h1!arg2,.h
2!arg2,.h3!arg2.:#3D.k_loc,.ssp-2,.0#0A..9h4!arg2.:
#3D.ssp-2#0A..6}#0A..1ELSE.{..arg1.:#3D.arg2#0A..9a
rg2.:#3D.arg2-4#0A..6}#0A..1h1!arg1,.h2!arg1,.h3!ar
g1,.h4!arg1.:#3D.k,.n,.i,.ssp-1#0A..1pendingop.:#3D
.s_none#0A}#0A#0AAND.swapargs().BE#0A{..LET.k,.n,.i
.#3D.h1!arg1,.h2!arg1,.h3!arg1#0A..1h1!arg1,.h2!arg
1,.h3!arg1.:#3D.h1!arg2,.h2!arg2,.h3!arg2#0A..1h1!a
rg2,.h2!arg2,.h3!arg2.:#3D.k,.n,.i#0A}#0A#0AAND.cgs
tw().BE#0A{..cgpendingop()#0A..1loadba(arg1,.arg2)#0A
..1gen(f_st)#0A..1stack(ssp-2)#0A..1forgetallvars()
#0A}#0A#0A//.Store.the.top.item.of.the.SS.in.(k,n,i
)#2E#0A//.k.is.k_loc,.k_loci,.k_glob..or.k_lab#2E#0A
AND.storein(k,.n,.i).BE#0A{..cgpendingop()#0A#0A..1
SWITCHON.k.INTO#0A..1{..DEFAULT:..3cgerror("in.stor
ein.%n",.k)#0A#0A..4CASE.k_loc:..storetemp(k,.n,.0,
.ssp-2)#0A..17loada(arg1);.gensp(n);..5ENDCASE#0A..
4CASE.k_glob:.storetemp(k,.n,.0,.ssp-2)#0A..17loada
(arg1);.geng(f_sg,.n);..ENDCASE#0A..4CASE.k_lab:..s
toretemp(k,.n,.0,.ssp-2)#0A..17loada(arg1);.genr(f_
sl,.n);..ENDCASE#0A#0A..4CASE.k_loci:.store(0,.ssp-
2)#0A..17loada(arg1)#0A..17genlp(n)#0A..17cgaddk(4*
i)#0A..17gen(f_st)#0A..17forgetall()#0A..17stack(ss
p-1)#0A..17RETURN#0A..1}#0A..1forgetvar(k,.n,.i)#0A
..1addinfo_a(k,.n,.i)#0A..1stack(ssp-1)#0A}#0A#0AAN
D.cginc(f).BE#0A{..cgpendingop()#0A..1loada(arg1)#0A
..1gen(f)#0A..1forget_a()#0A..1forgetallvars()#0A}#0A
#0AAND.cgplus().BE#0A//.Compiles.code.to.compute.<a
rg2>.+.<arg1>#2E#0A//.It.does.not.look.at.PENDINGOP
#2E#0A#0A{..IF.iszero(arg1).DO.{..stack(ssp-1);.RET
URN.}#0A#0A..1IF.iszero(arg2).DO#0A..1{..IF.h2!arg1
#3Dssp-1.&.h1!arg1#3Dk_loc.DO.loada(arg1)#0A..4lose
1(h1!arg1,.h2!arg1,.h3!arg1)#0A..4RETURN#0A..1}#0A#0A
..1TEST.inreg_a(h1!arg1,.h2!arg1,.h3!arg1)#0A..1THE
N.loada(arg1)#0A..1ELSE.IF.inreg_a(h1!arg2,.h2!arg2
,.h3!arg2).DO.loada(arg2)#0A#0A..1IF.h1!arg1#3Dk_a.
DO.swapargs()#0A#0A..1IF.h1!arg2#3Dk_loc.&.3<#3Dh2!
arg2<#3D12.DO.swapargs()#0A..1IF.h1!arg1#3Dk_loc.&.
3<#3Dh2!arg1<#3D12.DO.{..loada(arg2)#0A..41gen(f_ap
0.+.h2!arg1)#0A..41forget_a()#0A..41lose1(k_a,.0,.0
)#0A..41RETURN#0A..38}#0A#0A..1IF.h1!arg2#3Dk_numb.
&.-4<#3Dh2!arg2<#3D5.DO.swapargs()#0A..1IF.h1!arg1#3D
k_numb.&.-4<#3Dh2!arg1<#3D5.DO.{..loada(arg2)#0A..4
2cgaddk(h2!arg1)#0A..42lose1(k_a,.0,.0)#0A..42RETUR
N#0A..39}#0A#0A..1IF.h1!arg2#3Dk_loc.DO.swapargs()#0A
..1IF.h1!arg1#3Dk_loc.DO#0A..1{..LET.n.#3D.h2!arg1#0A
..4loada(arg2)#0A..4TEST.3<#3Dn<#3D12.THEN.gen(f_ap
0.+.n)#0A..18ELSE.TEST.0<#3Dn<#3D255#0A..23THEN.gen
b(f_ap,.n)#0A..23ELSE.TEST.0<#3Dn<#3D#23xFF2#0A..28
THEN.genh(f_aph,.n)#0A..28ELSE.genw(f_apw,.n)#0A..4
forget_a()#0A..4lose1(k_a,.0,.0)#0A..4RETURN#0A..1}
#0A#0A..1IF.h1!arg2#3Dk_glob.DO.swapargs()#0A..1IF.
h1!arg1#3Dk_glob.DO.{..loada(arg2)#0A..25geng(f_ag,
.h2!arg1)#0A..25forget_a()#0A..25lose1(k_a,.0,.0)#0A
..25RETURN#0A..22}#0A#0A..1IF.h1!arg2#3Dk_numb.DO.s
wapargs()#0A..1IF.h1!arg1#3Dk_numb.DO.{..LET.n.#3D.
h2!arg1#0A..25loada(arg2)#0A..25cgaddk(n)#0A..25los
e1(k_a,.0,.0)#0A..25RETURN#0A..22}#0A..1loadboth(ar
g2,.arg1)#0A..1gen(f_add)#0A..1forget_a()#0A..1lose
1(k_a,.0,.0)#0A}#0A#0AAND.cgaddk(k).BE.UNLESS.k#3D0
.DO..//.Compile.code.to.add.k.to.A#2E#0A{..TEST.-4<
#3Dk<#3D5#0A..1THEN.TEST.k<0.THEN.gen(f_s0.-.k)#0A.
.15ELSE.gen(f_a0.+.k)#0A..1ELSE.TEST.-255<#3Dk<#3D2
55#0A..6THEN.TEST.k>0.THEN.genb(f_a,.k)#0A..20ELSE.
genb(f_s,.-k)#0A..6ELSE.TEST.0<#3Dk<#3D#23xFF2#0A..
11THEN.genh(f_ah,.k)#0A..11ELSE.TEST.-#23xFF2<#3Dk<
#3D0#0A..16THEN.genh(f_sh,.-k)#0A..16ELSE.genw(f_aw
,.k)#0A..1forget_a()#0A}#0A#0AAND.cgglobal(n).BE#0A
{..incode.:#3D.FALSE#0A..1cgstatics()#0A..1chkrefs(
512)..1//.Deal.with.ALL.outstanding.refs#2E#0A..1al
ign(4)#0A..1codew(0)..5//.Compile.Global.initialisa
tion.data#2E#0A..1FOR.i.#3D.1.TO.n.DO.{..codew(rdgn
());.codew(labv!rdl()).}#0A..1codew(maxgn)#0A}#0A#0A
AND.cgraise(count).BE..//.count.is.the.number.of.ar
gs.to.RAISE#0A{..LET.s.#3D.ssp#0A..1cgpendingop()#0A
..1SWITCHON.count.INTO#0A..1{..DEFAULT:.cgerror("Co
mpiler.error.in.cgraise.%n*n",.count)#0A#0A..4CASE.
3:.loada(arg1)#0A..12gen(f_atc)#0A..12stack(ssp-1)#0A
..4CASE.2:.loadba(arg1,.arg2)#0A..12ENDCASE#0A..4CA
SE.1:.loada(arg1)#0A..1}#0A..1gen(f_raise)#0A..1inc
ode.:#3D.FALSE#0A..1stack(s-count)#0A}#0A..1#0A#0AA
ND.cgentry(lab,.name,.type).BE#0A{..LET.v.#3D.VEC.3
#0A..1LET.n.#3D.name%0#0A..1v%0.:#3D.7#0A..1FOR.i.#3D
.1.TO.n.IF.i<#3D7.DO.v%i.:#3D.name%i#0A..1FOR.i.#3D
.n+1.TO.7.DO.v%i.:#3D.32..//.Ascii.SPACE#2E#0A..1ch
krefs(80)..//.Deal.with.some.forward.refs#2E#0A..1a
lign(4)#0A..1IF.naming.DO.{..codew(entryword)#0A..1
7codew(pack4b(v%1,.v%2,.v%3,.v%4))#0A..17codew(pack
4b(v%5,.v%6,.v%7,.0))#0A..14}#0A..1IF.debug>0.DO.wr
itef("*n//.FUN.%s*n",.name)#0A..1setlab(lab)#0A..1i
ncode.:#3D.TRUE#0A..1initstack(3)#0A..1forgetall()#0A
}#0A#0A//.Function.or.routine.call#2E#0AAND.cgcall(
k).BE#0A{..LET.sa.#3D.k+3..//.Stack.address.of.firs
t.arg.(if.any)#2E#0A..1AND.a1.#3D.0..2//.SS.item.fo
r.first.arg.if.found#2E#0A#0A..1cgpendingop()#0A#0A
//.Deal.with.non.args#2E#0A..1FOR.t.#3D.tempv.TO.ar
g2.BY.4.DO.{..IF.h4!t>#3Dk.BREAK#0A..34IF.h1!t#3Dk_
a.DO.storet(t)#0A..31}#0A#0A//.Deal.with.args.2,.3.
#2E#2E1#0A..1FOR.t.#3D.tempv.TO.arg2.BY.4.DO#0A..1{
..LET.s.#3D.h4!t#0A..4IF.s#3Dsa.DO#0A..4{..a1.:#3D.
t..//.We.have.found.the.SS.item.for.the.first.arg#2E
#0A..7IF.h1!t#3Dk_a.&.t+4#3Darg2.DO#0A..7//.Two.arg
ument.call.with.the.first.arg.already.in.A#2E#0A..7
{..push(t,.arg2)#0A..10storet(arg2)..2//.Store.seco
nd.arg#2E#0A..10genxch(0,.t)..2//.Restore.first.arg
.back.to.A#2E#0A..10BREAK#0A..7}#0A..4}#0A..4IF.s>s
a.DO.storet(t)#0A..1}#0A#0A..1//.Move.first.arg.(if
.any).into.A#2E#0A..1IF.sa<ssp-1.TEST.a1#3D0#0A..13
THEN.genlp(sa)..//.First.arg.exists.but.not.in.SS#2E
#0A..13ELSE.loada(a1)..//.First.arg.exists.in.SS#0A
#0A..1//.First.arg.(if.any).is.now.in.A#2E#0A#0A..1
TEST.h1!arg1#3Dk_glob.&.3<#3Dk<#3D11#0A..1THEN.geng
(f_k0g+k,.h2!arg1)#0A..1ELSE.{..push(a1,.arg1)#0A..
9//.First.arg.(if.any).is.now.in.B#0A..9//.and.the.
procedure.address.is.in.A#2E#0A..9TEST.3<#3Dk<#3D11
#0A..9THEN.gen(f_k0+k)#0A..9ELSE.TEST.0<#3Dk<#3D255
#0A..14THEN.genb(f_k,.k)#0A..14ELSE.TEST.0<#3Dk<#3D
#23xFF2#0A..19THEN.genh(f_kh,.k)#0A..19ELSE.genw(f_
kw,.k)#0A..6}#0A#0A..1forgetall()#0A..1stack(k)#0A}
#0A#0A//.Used.for.MCODE.operators.JT.and.JF#2E#0AAN
D.cgjump(b,l).BE#0A{..LET.f.#3D.jmpfn(pendingop)#0A
..1IF.f#3D0.DO.{..loadt(k_numb,0,0);.f.:#3D.f_jne.}
#0A..1pendingop.:#3D.s_none#0A..1UNLESS.b.DO.f.:#3D
.compjfn(f)#0A..1store(0,ssp-3)#0A..1genr(prepj(f),
l)#0A..1stack(ssp-2)#0A}#0A#0AAND.jmpfn(op).#3D.VAL
OF.SWITCHON.op.INTO#0A{..DEFAULT:..RESULTIS.0#0A..1
CASE.s_eq:.RESULTIS.f_jeq#0A..1CASE.s_ne:.RESULTIS.
f_jne#0A..1CASE.s_ls:.RESULTIS.f_jls#0A..1CASE.s_gr
:.RESULTIS.f_jgr#0A..1CASE.s_le:.RESULTIS.f_jle#0A.
.1CASE.s_ge:.RESULTIS.f_jge#0A}#0A#0AAND.jfn0(f).#3D
.f+2.//.Change.F_JEQ.into.F_JEQ0..etc#2E#2E1#0A#0AA
ND.revjfn(f).#3D.f#3Df_jls.->.f_jgr,#0A..14f#3Df_jg
r.->.f_jls,#0A..14f#3Df_jle.->.f_jge,#0A..14f#3Df_j
ge.->.f_jle,#0A..14f#0A#0AAND.compjfn(f).#3D.f#3Df_
jeq.->.f_jne,#0A..15f#3Df_jne.->.f_jeq,#0A..15f#3Df
_jls.->.f_jge,#0A..15f#3Df_jge.->.f_jls,#0A..15f#3D
f_jgr.->.f_jle,#0A..15f#3Df_jle.->.f_jgr,#0A..15f#0A
#0AAND.prepj(f).#3D.VALOF..//.Returns.the.appropria
te.m/c.fn#2E#0A{..IF.iszero(arg2).DO.{..swapargs();
.f.:#3D.revjfn(f).}#0A..1IF.iszero(arg1).DO.{..load
a(arg2);.RESULTIS.jfn0(f).}#0A..1IF.loadboth(arg2,.
arg1)#3Dswapped.RESULTIS.revjfn(f)#0A..1RESULTIS.f#0A
}#0A#0AAND.cgstring(n).BE#0A{..LET.l,.a.#3D.newlab(
),.n#0A..1loadt(k_lvlab,l,0)#0A..1{..LET.b,.c,.d.#3D
.0,.0,.0#0A..4IF.n>0.DO.b.:#3D.rdn()#0A..4IF.n>1.DO
.c.:#3D.rdn()#0A..4IF.n>2.DO.d.:#3D.rdn()#0A..4!nli
ste.:#3D.getblk(0,l,pack4b(a,.b,.c,.d))#0A..4nliste
.:#3D.!nliste#0A..4l.:#3D.0#0A..4IF.n<#3D3.BREAK#0A
..4n,.a.:#3D.n-4,.rdn()#0A..1}.REPEAT#0A}#0A#0AAND.
setlab(l).BE#0A{..LET.p.#3D.@rlist#0A#0A..1IF.debug
>0.DO.writef("%i4:.L%n:*n",.stvp,.l)#0A#0A..1labv!l
.:#3D.stvp..//.Set.the.label#2E#0A#0A..1//.Fill.in.
all.refs.that.are.in.range#2E#0A..1{..LET.r.#3D.!p#0A
..4IF.r#3D0.BREAK#0A..4TEST.h3!r#3Dl.&.inrange_d(h2
!r,.stvp)#0A..4THEN.{..fillref_d(h2!r,.stvp)#0A..12
!p.:#3D.!r..1//.Remove.item.from.RLIST#2E#0A..12fre
eblk(r)#0A..9}#0A..4ELSE.p.:#3D.r..//.Keep.the.item
#2E#0A..1}.REPEAT#0A..1rliste.:#3D.p..3//.Ensure.th
at.RLISTE.is.sensible#2E#0A#0A..1p.:#3D.@reflist#0A
#0A..1{..LET.r.#3D.!p#0A..4IF.r#3D0.BREAK#0A..4TEST
.h3!r#3Dl#0A..4THEN.{..LET.a.#3D.h2!r#0A..12puth(a,
stvp-a).//.Plant.rel.address#2E#0A..12!p.:#3D.!r..5
//.Remove.item.from.REFLIST#2E#0A..12freeblk(r)#0A.
.9}#0A..4ELSE.p.:#3D.r..//.Keep.item#2E#0A..1}.REPE
AT#0A#0A..1refliste.:#3D.p..1//.Ensure.REFLISTE.is.
sensible#2E#0A}#0A#0AAND.cgstatics().BE.UNTIL.nlist
#3D0.DO#0A{..LET.len,.nl.#3D.0,.nlist#0A#0A..1nlist
e.:#3D.@nlist..//.All.NLIST.items.will.be.freed#2E#0A
#0A..1len,.nl.:#3D.len+4,.!nl.REPEATUNTIL.nl#3D0.|.
h2!nl.~#3D.0#0A#0A..1chkrefs(len+3)..//.+3.because.
align(4).may.generate.3.bytes#2E#0A..1align(4)#0A#0A
..1setlab(h2!nlist)..//.NLIST.always.starts.labelle
d#2E#0A#0A..1{..LET.blk.#3D.nlist#0A..4nlist.:#3D.!
nlist#0A..4freeblk(blk)#0A..4codew(h3!blk)#0A..1}.R
EPEATUNTIL.nlist#3D0.|.h2!nlist.~#3D.0#0A}#0A#0AAND
.getblk(a,.b,.c,.d).#3D.VALOF#0A{..LET.p.#3D.freeli
st#0A..1TEST.p#3D0.THEN.{..dp.:#3D.dp-4;.checkspace
();.p.:#3D.dp.}#0A..10ELSE.freelist.:#3D.!p#0A..1h1
!p,.h2!p,.h3!p,.h4!p.:#3D.a,.b,.c,.d#0A..1RESULTIS.
p#0A}#0A#0AAND.freeblk(p).BE.{..!p.:#3D.freelist;.f
reelist.:#3D.p.}#0A#0AAND.freeblks(p).BE.UNLESS.p#3D
0.DO#0A{..LET.oldfreelist.#3D.freelist#0A..1freelis
t.:#3D.p#0A..1UNTIL.!p#3D0.DO.p.:#3D.!p#0A..1!p.:#3D
.oldfreelist#0A}#0A#0AAND.initdatalists().BE#0A{..r
eflist,..1refliste..1:#3D.0,.@reflist#0A..1reloclis
t,.relocliste.:#3D.0,.@reloclist#0A..1rlist,..3rlis
te..3:#3D.0,.@rlist#0A..1nlist,..3nliste..3:#3D.0,.
@nlist#0A..1freelist.:#3D.0#0A}#0A#0ALET.geng(f,.n)
.BE.TEST.n<256#0A..16THEN.genb(f,.n)#0A..16ELSE.TES
T.n<512#0A..21THEN.genb(f+32,.n-256)#0A..21ELSE.gen
h(f+64,.n)#0A#0ALET.gen(f).BE.IF.incode.DO#0A{..chk
refs(1)#0A..1IF.debug>0.DO.wrcode(f,."")#0A..1codeb
(f)#0A}#0A#0ALET.genb(f,.a).BE.IF.incode.DO#0A{..ch
krefs(2)#0A..1IF.debug>0.DO.wrcode(f,."%i3",.a)#0A.
.1codeb(f)#0A..1codeb(a)#0A}#0A#0ALET.genr(f,.n).BE
.IF.incode.DO#0A{..chkrefs(2)#0A..1IF.debug>0.DO.wr
code(f,."L%n",.n)#0A..1codeb(f)#0A..1codeb(0)#0A..1
relref(stvp-2,.n)#0A}#0A#0ALET.genh(f,.h).BE.IF.inc
ode.DO..//.Assume.0.<#3D.h.<#3D.#23xFF2#0A{..chkref
s(3)#0A..1IF.debug>0.DO.wrcode(f,."%n",.h)#0A..1cod
eb(f)#0A..1code2b(h)#0A}#0A#0ALET.genw(f,.w).BE.IF.
incode.DO#0A{..chkrefs(5)#0A..1IF.debug>0.DO.wrcode
(f,."%n",.w)#0A..1codeb(f)#0A..1code4b(w)#0A}#0A#0A
AND.checkspace().BE.IF.stvp/4>dp-stv.DO#0A{..cgerro
r("Program.too.large,.%n.bytes.compiled",.stvp)#0A.
.1errcount.:#3D.errcount+1#0A..1longjump(fin_p,.fin
_l)#0A}#0A#0AAND.codeb(byte).BE#0A{..stv%stvp.:#3D.
byte#0A..1stvp.:#3D.stvp.+.1#0A..1checkspace()#0A}#0A
#0AAND.code2b(h).BE.TEST.bigender#0ATHEN.{..codeb(h
>>0008.);.codeb(h..2)..}#0AELSE.{..codeb(h..2);.cod
eb(h>>0008.)..}#0A#0AAND.code4b(w).BE.TEST.bigender
#0ATHEN.{..codeb(w>>00024);.codeb(w>>00016);.codeb(
w>>0008.);.codeb(w..2)..}#0AELSE.{..codeb(w..2);.co
deb(w>>0008.);.codeb(w>>00016);.codeb(w>>00024)..}#0A
#0AAND.pack4b(b0,.b1,.b2,.b3).#3D#0A..bigender.->.b
0<<00024.|.b1<<00016.|.b2<<0008.|.b3,#0A..12b3<<000
24.|.b2<<00016.|.b1<<0008.|.b0#0A#0AAND.codec(c).BE
#0A{..IF.debug>0.DO.writef("%i4:..DATAC.%n*n",.stvp
,.c)#0A..1codeb(c)#0A}#0A#0AAND.codeh(h).BE#0A{..IF
.debug>0.DO.writef("%i4:..DATAH.%n*n",.stvp,.h)#0A.
.1code2b(h)#0A}#0A#0AAND.codew(w).BE#0A{..IF.debug>
0.DO.writef("%i4:..DATAW.0x%x8*n",.stvp,.w)#0A..1co
de4b(w)#0A}#0A#0AAND.codewl(lab).BE#0A{..IF.debug>0
.DO.writef("%i4:..DATAW.L%n*n",.stvp,.lab)#0A..1!re
locliste.:#3D.getblk(0,.stvp,.lab)#0A..1relocliste.
:#3D.!relocliste#0A..1code4b(0)#0A}#0A#0AAND.coder(
n).BE#0A{..LET.labval.#3D.labv!n#0A..1IF.debug>0.DO
.writef("%i4:..DATAH.L%n-$*n",.stvp,.n)#0A..1code2b
(0)#0A..1TEST.labval#3D-1.THEN.{..!refliste.:#3D.ge
tblk(0,.stvp-2,.n)#0A..24refliste.:#3D.!refliste#0A
..21}#0A..16ELSE.puth(stvp-2,.labval-stvp+2)#0A}#0A
#0AAND.getw(a).#3D.#0A..1bigender.->.stv%a<<00024.|
.stv%(a+1)<<00016.|.stv%(a+2)<<0008..|.stv%(a+3),#0A
..13stv%a..3|.stv%(a+1)<<0008..|.stv%(a+2)<<00016.|
.stv%(a+3)<<00024#0A#0AAND.puth(a,.w).BE#0A..1TEST.
bigender#0A..1THEN.stv%a,..3stv%(a+1).:#3D.w>>0008,
.w#0A..1ELSE.stv%(a+1),.stv%a..3:#3D.w>>0008,.w#0A#0A
AND.putw(a,.w).BE#0A..1TEST.bigender#0A..1THEN.stv%
a,.stv%(a+1),.stv%(a+2),.stv%(a+3).:#3D.w>>00024,w>
>00016,.w>>0008,.w#0A..1ELSE.stv%(a+3),.stv%(a+2),.
stv%(a+1),.stv%a.:#3D.w>>00024,w>>00016,.w>>0008,.w
#0A#0AAND.align(n).BE.UNTIL.stvp.REM.n.#3D.0.DO.cod
eb(0)#0A#0AAND.chkrefs(n).BE..//.Resolve.references
.until.it.is.possible#0A..17//.to.compile.n.bytes.w
ithout.a.reference#0A..17//.going.out.of.range#2E#0A
{..LET.p.#3D.@rlist#0A#0A..1skiplab.:#3D.0#0A#0A..1
UNTIL.!p#3D0.DO#0A..1{..LET.r.#3D.!p#0A..4LET.a.#3D
.h2!r.//.RLIST.is.ordered.in.increasing.A#2E#0A#0A.
.4IF.(stv%a.&.1).#3D.0.DO#0A..4//.An.unresolved.ref
erence.at.address.A#0A..4{..IF.inrange_i(a,.stvp+n+
3).BREAK#0A..7//.This.point.is.reached.if.there.is#0A
..7//.an.unresolved.ref.at.A.which.cannot#0A..7//.d
irectly.relative.address.STVP+N+3#0A..7//.and.so.an
.indirect.data.word.must#0A..7//.be.compiled#2E#0A.
.7//.The.+3.is.to.allow.for.a.possible#0A..7//.skip
.jump.instruction.and.possibly#0A..7//.one.filler.b
yte#2E#0A..7genindword(h3!r)#0A..4}#0A#0A..4//.At.t
his.point.the.reference.at.A#0A..4//.is.in.range.of
.a.resolving.indirect#0A..4//.data.word.and.should.
be.removed.from#0A..4//.RLIST.if.there.is.no.chance
.that.it#0A..4//.can.be.resolved.by.a.direct.relati
ve#0A..4//.address#2E#0A..4TEST.inrange_d(a,.stvp)#0A
..4THEN.p.:#3D.r..6//.Keep.the.item#2E#0A..4ELSE.{.
.!p.:#3D.!r..1//.Free.item.if.already.resolved#0A..
12freeblk(r).//.and.no.longer.in.direct.range#2E#0A
..12IF.!p#3D0.DO.rliste.:#3D.p..//.Correct.RLISTE#2E
#0A..9}#0A..1}#0A#0A..1//.At.this.point.all.necessa
ry.indirect.data.words.have#0A..1//.been.compiled#2E
#0A#0A..1UNLESS.skiplab#3D0.DO.{..setlab(skiplab)#0A
..24skiplab,.incode.:#3D.0,.TRUE#0A..21}#0A}#0A#0AA
ND.genindword(l).BE..//.Called.only.from.CHKREFS#2E
#0A{..LET.r.#3D.rlist..4//.Assume.RLIST.~#3D.0#0A#0A
..1IF.incode.DO#0A..1{..skiplab.:#3D.newlab()#0A..4
//.genr(f_j,.skiplab).without.the.call.of.chkrefs(2
)#2E#0A..4IF.debug>0.DO.wrcode(f_j,."L%n",.skiplab)
#0A..4codeb(f_j)#0A..4codeb(0)#0A..4relref(stvp-2,.
skiplab)#0A..4incode.:#3D.FALSE#0A..1}#0A#0A..1alig
n(2)#0A#0A..1UNTIL.r#3D0.DO#0A..1{..IF.h3!r#3Dl.&.(
stv%(h2!r).&.1)#3D0.DO.fillref_i(h2!r,.stvp)#0A..4r
.:#3D.!r#0A..1}#0A#0A..1coder(l)#0A}#0A#0AAND.inran
ge_d(a,.p).#3D.a-127.<#3D.p.<#3D.a+128#0A//.The.res
ult.is.TRUE.if.direct.relative.instr.(eg.J).at#0A//
.A.can.address.location.P.directly#2E#0A#0AAND.inra
nge_i(a,.p).#3D.VALOF#0A//.The.result.is.TRUE.if.in
direct.relative.instr.(eg.J}#0A//.at.A.can.address.
a.resolving.word.at.P#2E#0A{..LET.rel.#3D.(p-a)/2#0A
..1RESULTIS.0.<#3D.rel.<#3D.255#0A}#0A#0AAND.fillre
f_d(a,.p).BE#0A{..stv%a.:#3D.stv%a.&.254..//.Back.t
o.direct.form.if.neccessary#2E#0A..1stv%(a+1).:#3D.
p-a-1#0A}#0A#0AAND.fillref_i(a,.p).BE..//.P.is.even
#2E#0A{..stv%a.:#3D.stv%a.|.1..1//.Force.indirect.f
orm#2E#0A..1stv%(a+1).:#3D.(p-a)/2#0A}#0A#0AAND.rel
ref(a,.l).BE#0A//.RELREF.is.only.called.just.after.
compiling#0A//.a.relative.reference.instruction.at#0A
//.address.A.(#3Dstvp-2)#2E#0A{..LET.labval.#3D.lab
v!l#0A#0A..1IF.labval>#3D0.&.inrange_d(a,.labval).D
O.{..fillref_d(a,.labval)#0A..43RETURN#0A..40}#0A#0A
..1//.All.other.references.in.RLIST.have#0A..1//.ad
dresses.smaller.than.A.and.so.RLIST.will#0A..1//.re
main.properly.ordered.if.this.item#0A..1//.is.added
.to.the.end#2E#0A..1!rliste.:#3D.getblk(0,.a,.l)#0A
..1rliste.:#3D.!rliste#0A}#0A#0ALET.outputmodule().
BE#0A{..LET.p,.relocs.#3D.reloclist,.0#0A#0A..1UNTI
L.p#3D0.DO.{..LET.a,.lab.#3D.h2!p,.h3!p#0A..17LET.l
abval.#3D.labv!lab#0A..17relocs,.p.:#3D.relocs+1,.h
1!p#0A..17TEST.labval#3D-1#0A..17THEN.cgerror("Labe
l.L%n.unset",.h3!reflist)#0A..17ELSE.putw(a,.getw(a
)+labval)#0A..14}#0A#0A..1UNTIL.reflist#3D0.DO.{..c
gerror("Label.L%n.unset",.h3!reflist)#0A..23reflist
.:#3D.!reflist#0A..20}#0A#0A..1IF.bining.DO.{..LET.
outstream.#3D.output()#0A..17selectoutput(tostream)
..//.Output.a.HUNK#2E#0A..17newline()#0A..17objword
(t_hunk)#0A..17objword(stvp/4)#0A..17FOR.p#3D0.TO.s
tvp-4.BY.4.DO#0A..17{..IF.p.REM.20.#3D.0.DO.newline
()#0A..20objword(getw(p))#0A..17}#0A..17newline()#0A
..17UNLESS.relocs#3D0.DO#0A..17{..LET.n.#3D.0#0A..2
0p.:#3D.reloclist#0A..20objword(t_reloc)#0A..20objw
ord(relocs)#0A..20UNTIL.p#3D0.DO.{..IF.n.REM.5.#3D.
0.DO.newline()#0A..36objword(h2!p)#0A..36n,.p.:#3D.
n+1,.h1!p#0A..33}#0A..20newline()#0A..17}#0A..17sel
ectoutput(outstream)#0A..14}#0A}#0A#0AAND.objword(a
).BE.writef("%X8.",.a)#0A#0AAND.dboutput().BE#0A{..
LET.p.#3D.info_a#0A..1writef("ssp#3D%i2.",.ssp)#0A.
.1writes("A#3D(")#0A..1UNTIL.p#3D0.DO.{..wrkni(h2!p
,.h3!p,.h4!p)#0A..17p.:#3D.!p#0A..17UNLESS.p#3D0.DO
.wrch('*s')#0A..14}#0A..2#0A..1p.:#3D.info_b#0A..1w
rites(").B#3D(")#0A..1UNTIL.p#3D0.DO.{..wrkni(h2!p,
.h3!p,.h4!p)#0A..17p.:#3D.!p#0A..17UNLESS.p#3D0.DO.
wrch('*s')#0A..14}#0A..1wrch(')')#0A..1#0A..1IF.deb
ug#3D2.DO.{..writes("..")#0A..18FOR.p#3Dtempv.TO.ar
g1.BY.4..DO#0A..18{..IF.(p-tempv).REM.30.#3D.10.DO.
newline()#0A..21wrkni(h1!p,h2!p,h3!p)#0A..21wrch('*
s')#0A..18}#0A..15}#0A..1#0A..1IF.debug#3D3.DO.{..1
LET.l.#3D.rlist#0A..19writes("*nREFS.")#0A..19UNTIL
.l#3D0.DO.{..writef("%n.L%n..",.l!1,.l!2)#0A..35l.:
#3D.!l#0A..32}#0A..15}#0A..1newline()#0A}#0A#0AAND.
wrkni(k,.n,.i).BE.SWITCHON.k.INTO#0A..1{..DEFAULT:.
.5writef("?");..10RETURN#0A..4CASE.k_none:..1writef
("-");..10RETURN#0A..4CASE.k_numb:..1writef("N%n",.
n);..5RETURN#0A..4CASE.k_fnlab:..writef("F%n",.n);.
.5RETURN#0A..4CASE.k_lvloc:..writef("@P%n",.n);..4R
ETURN#0A..4CASE.k_lvglob:.writef("@G%n",.n);..4RETU
RN#0A..4CASE.k_lvlab:..writef("@L%n",.n);..4RETURN#0A
..4CASE.k_a:..4writef("A",.n);..7RETURN#0A..4CASE.k
_b:..4writef("B");..10RETURN#0A..4CASE.k_loc:..2wri
tef("P%n",.n);..5RETURN#0A..4CASE.k_glob:..1writef(
"G%n",.n);..5RETURN#0A..4CASE.k_lab:..2writef("L%n"
,.n);..5RETURN#0A..4CASE.k_loci:..1writef("%nP%n",.
i,.n);..RETURN#0A..4CASE.k_lvloci:.writef("@%nP%n",
.i,.n);.RETURN#0A..4CASE.k_glob0:..writef("0G%n",.n
);..4RETURN#0A..4CASE.k_glob1:..writef("1G%n",.n);.
.4RETURN#0A..4CASE.k_glob2:..writef("2G%n",.n);..4R
ETURN#0A..1}#0A#0AAND.wrcode(f,.form,.a,.b).BE#0A{.
.//IF.debug#3D2.DO.dboutput()#0A..1writef("%i4:.",.
stvp)#0A..1wrfcode(f)#0A..1writes("..")#0A..1writef
(form,.a,.b)#0A..1newline()#0A}#0A#0AAND.wrfcode(f)
.BE#0A{..LET.s.#3D.VALOF.SWITCHON.f&31.INTO#0A..1{.
.DEFAULT:#0A..4CASE..0000:.RESULTIS."..3-..3K..1LLP
..3L..2LP..2SP..2AP..3A"#0A..4CASE..0001:.RESULTIS.
"..3-..2KH..LLPH..2LH..1LPH..1SPH..1APH..2AH"#0A..4
CASE..0002:.RESULTIS."..1BRK..2KW..LLPW..2LW..1LPW.
.1SPW..1APW..2AW"#0A..4CASE..0003:.RESULTIS."..2K3.
.1K3G..K3G1..K3GH..1LP3..1SP3..1AP3..L0P3"#0A..4CAS
E..0004:.RESULTIS."..2K4..1K4G..K4G1..K4GH..1LP4..1
SP4..1AP4..L0P4"#0A..4CASE..0005:.RESULTIS."..2K5..
1K5G..K5G1..K5GH..1LP5..1SP5..1AP5..L0P5"#0A..4CASE
..0006:.RESULTIS."..2K6..1K6G..K6G1..K6GH..1LP6..1S
P6..1AP6..L0P6"#0A..4CASE..0007:.RESULTIS."..2K7..1
K7G..K7G1..K7GH..1LP7..1SP7..1AP7..L0P7"#0A..4CASE.
.0008:.RESULTIS."..2K8..1K8G..K8G1..K8GH..1LP8..1SP
8..1AP8..L0P8"#0A..4CASE..0009:.RESULTIS."..2K9..1K
9G..K9G1..K9GH..1LP9..1SP9..1AP9..L0P9"#0A..4CASE.1
0:.RESULTIS."..1K10..K10G.K10G1.K10GH..LP10..SP10..
AP10.L0P10"#0A..4CASE.11:.RESULTIS."..1K11..K11G.K1
1G1.K11GH..LP11..SP11..AP11.L0P11"#0A..4CASE.12:.RE
SULTIS."..2LF..1S0G..S0G1..S0GH..LP12..SP12..AP12.L
0P12"#0A..4CASE.13:.RESULTIS."..1LF$..1L0G..L0G1..L
0GH..LP13..SP13..INDW..3S"#0A..4CASE.14:.RESULTIS."
..2LM..1L1G..L1G1..L1GH..LP14..SP14..1LMH..2SH"#0A.
.4CASE.15:.RESULTIS."..1LM1..1L2G..L2G1..L2GH..LP15
..SP15..1BTC..MDIV"#0A..4CASE.16:.RESULTIS."..2L0..
2LG..1LG1..1LGH..LP16..SP16..1NOP.CHGCO"#0A..4CASE.
17:.RESULTIS."..2L1..2SG..1SG1..1SGH..1SYS..2S1..2A
1..1NEG"#0A..4CASE.18:.RESULTIS."..2L2..1LLG..LLG1.
.LLGH.LVIND..2S2..2A2..1NOT"#0A..4CASE.19:.RESULTIS
."..2L3..2AG..1AG1..1AGH..1STB..2S3..2A3.INC1B"#0A.
.4CASE.20:.RESULTIS."..2L4..1MUL..1ADD..2RV..2ST..2
S4..2A4.INC4B"#0A..4CASE.21:.RESULTIS."..2L5..1DIV.
.1SUB..1RV1..1ST1..1XCH..2A5.DEC1B"#0A..4CASE.22:.R
ESULTIS."..2L6..1MOD..1LSH..1RV2..1ST2..INDB..RVP3.
DEC4B"#0A..4CASE.23:.RESULTIS."..2L7..1XOR..1RSH..1
RV3..1ST3.INDB0..RVP4.INC1A"#0A..4CASE.24:.RESULTIS
."..2L8..2SL..1AND..1RV4..STP3..1ATC..RVP5.INC4A"#0A
..4CASE.25:.RESULTIS."..2L9..1SL$..2OR..1RV5..STP4.
.1ATB..RVP6.DEC1A"#0A..4CASE.26:.RESULTIS."..1L10..
2LL..1LL1..1RV6..STP5..3J..RVP7.DEC4A"#0A..4CASE.27
:.RESULTIS."..FHOP..1LL$..LL1$..1RTN..3-..2J$.ST0P3
..3-"#0A..4CASE.28:.RESULTIS."..1JEQ..1JNE..1JLS..1
JGR..1JLE..1JGE.ST0P4..HAND"#0A..4CASE.29:.RESULTIS
."..JEQ$..JNE$..JLS$..JGR$..JLE$..JGE$.ST1P3.HAND$"
#0A..4CASE.30:.RESULTIS."..JEQ0..JNE0..JLS0..JGR0..
JLE0..JGE0.ST1P4..1UNH"#0A..4CASE.31:.RESULTIS.".JE
Q0$.JNE0$.JLS0$.JGR0$.JLE0$.JGE0$..1CTA.RAISE"#0A..
1}#0A..1LET.n.#3D.f>>0005.&.7#0A..1FOR.i.#3D.6*n+1.
TO.6*(n+1).DO.wrch(s%i)#0A}#0A#0A

######com/mcpltrn.b#
//..2TRNHDR#0A#0AGET."libhdr"#0A#0AMANIFEST.{..2//.
Parse.tree.and.MCODE.operators#0As_numb#3D1;..3s_ln
#3D1#0As_vid#3D2#0As_cid#3D3#0As_string#3D4#0As_tru
e#3D5#0As_false#3D6#0As_query#3D7#0As_tablab#3D8..2
//.replacement.for.s_string.and.s_table#0A#0A..12s_
lp#3D10#0A..12s_lg#3D11#0A..12s_llp#3D13#0A..12s_ll
g#3D14#0A#0As_comma#3D16;..1s_sp#3D16#0A..12s_sg#3D
17#0A..12s_lf#3D18#0A..12s_lx#3D19#0A#0As_lv#3D20#0A
s_neg#3D21#0As_abs#3D22#0As_not#3D23#0As_bitnot#3D2
4#0As_vec#3D25#0As_cvec#3D26#0As_valof#3D27#0As_tab
le#3D28#0As_ltable#3D29;.s_callc#3D29#0A#0As_call#3D
30#0As_indw#3D31#0As_indw0#3D32#0As_indb#3D33#0As_i
ndb0#3D34#0As_lsh#3D35..1//.same.order.as.op:#3D.op
erators#0As_rsh#3D36#0As_mult#3D37#0As_div#3D38#0As
_mod#3D39#0As_bitand#3D40#0As_xor#3D41#0As_plus#3D4
2#0As_sub#3D43#0As_bitor#3D44#0A#0As_eq#3D45#0As_ne
#3D46#0As_le#3D47#0As_ge#3D48#0As_ls#3D49#0As_gr#3D
50#0As_rel#3D51#0A#0As_and#3D55#0As_or#3D56#0A#0As_
cond#3D58#0A#0As_ptr#3D59#0As_dots#3D60;..3s_ll#3D6
0#0A..13s_ll1#3D61#0As_peq#3D62;..4s_sl#3D62#0As_pn
e#3D63;..4s_lpath#3D63#0As_ple#3D64;..4s_llpath#3D6
4#0As_pge#3D65;..4s_spath#3D65#0As_pls#3D66;..4s_st
w#3D66#0As_pgr#3D67;..4s_stb#3D67#0A..13s_lvindw#3D
68#0A..13s_cpr#3D69#0As_pass#3D70;..3s_jt#3D70#0A#0A
//.same.order.as.the.expression.operator#0As_plshas
s#3D71;..s_jf#3D71#0As_prshass#3D72;..s_lab#3D72#0A
s_pmultass#3D73;.s_stack#3D73#0As_pdivass#3D74#0As_
pmodass#3D75#0As_pandass#3D76#0As_pxorass#3D77#0As_
pplusass#3D78#0As_psubass#3D79;..s_dup#3D79#0As_por
ass#3D80;..1s_lr#3D80#0A..13s_str#3D81#0As_pand#3D8
2;..3s_jump#3D82#0As_por#3D83;..4s_dlab#3D83#0A..13
s_dw#3D84#0As_inc1#3D85;..3s_db#3D85#0As_inc4#3D86;
..3s_dl#3D86#0As_dec1#3D87;..3s_ds#3D87#0As_dec4#3D
88#0A#0As_inc1b#3D90#0As_inc4b#3D91#0As_dec1b#3D92#0A
s_dec4b#3D93#0As_inc1a#3D94#0As_inc4a#3D95#0As_dec1
a#3D96#0As_dec4a#3D97#0A#0As_let#3D100#0As_scope#3D
101#0As_goto#3D103#0As_raise#3D104#0As_handle#3D105
#0As_test#3D106#0As_if#3D109#0As_unless#3D110000#0A
s_while#3D110002#0As_until#3D110003#0As_repeatwhile
#3D110004#0As_repeatuntil#3D110005#0As_repeat#3D110
006#0As_for#3D110007#0As_match#3D120#0As_every#3D12
1#0As_result#3D122#0As_exit#3D123#0As_return#3D124#0A
s_break#3D125#0As_loop#3D126#0As_seq#3D127#0A#0As_a
ss#3D130#0A#0As_lshass#3D131..2//.same.order.as.the
.expression.operators#0As_rshass#3D132#0As_multass#3D
133#0As_divass#3D134#0As_modass#3D135#0As_andass#3D
136#0As_xorass#3D137#0As_plusass#3D138#0As_subass#3D
139#0As_orass#3D140#0A#0As_allass#3D141#0A#0As_modu
le#3D145#0As_endmodule#3D146#0As_external#3D147#0As
_static#3D148#0As_manifest#3D149#0As_global#3D150#0A
s_fun#3D151#0As_cfun#3D152#0As_funpat#3D153;..s_end
fun#3D153#0As_sdef#3D154#0As_mdef#3D155#0As_gdef#3D
156;.s_unhandle#3D156#0As_xdef#3D157;.s_line#3D157#0A
#0As_file#3D158#0As_setargs#3D159#0As_fnargs#3D160#0A
s_locs#3D161#0A}#0A#0AMANIFEST.{..3//..Selectors#0A
h1#3D0;.h2#3D1;.h3#3D2;.h4#3D3;.h5#3D4;.h6#3D5;.h7#3D
6#0A#0A}#0A#0AGLOBAL..{#0A//fin_p:237;.fin_l:238;.f
indfilename:241#0A#0Atrnext:300;.trans:301#0Afindid
:307#0Atrnerr:311#0Ajumpcond:320#0Atransfor:322#0A#0A
preplhs:328#0Apreplhsop:329#0Aassign:330000#0Aassig
nall:330001#0Aassignop:330002#0Aload:331#0Aloadlv:3
30005#0Aloadargs:330006#0Aisconst:330007#0Aevalcons
t:330008#0Atransvid:330009#0Acheckdistinct:340#0Aou
tglobinits:341#0A#0Anextlab:343;.labnumber:344#0Ane
wblk:346;.retblk:348;.retblks:349#0Awrc:350;.mcount
:351;.wrn:353;.wrpn:354#0A#0Aextlist:360#0Afunlist:
361#0Amanlist:362#0Agloblist:363;.lastgn:364#0Astat
list:365#0Asdlist:366#0Aloclist:367#0Ascopeptr:368#0A
blklist:369#0A#0Acomline:370;.procname:371#0Aresult
lab:372;.defaultlab:373;.exitlab:374#0Alooplab:375;
.breaklab:376;.ssp:377;.nptr:378#0Aoutstring:380;.o
ut1:381;.out2:382;.out3:383;.outline:384#0Amatchpos
:390;.matchlen:391;.matchlab:392#0Amatchhdepth:393;
.rephdepth:394;.valofhdepth:395;.hdepth:396#0A}#0A#0A
1LET.nextlab().#3D.VALOF#0A{..labnumber.:#3D.labnum
ber.+.1#0A..1RESULTIS.labnumber#0A}#0A#0AAND.trnerr
(mess,.a).BE#0A{..selectoutput(sysprint)#0A..1write
f("Error.in.%s.",.findfilename(comline>>00024))#0A.
.1writef("near.line.%n",.comline&#23xFF4)#0A..1UNLE
SS.procname#3D0.DO.writef(".in.%s",.@h3!procname)#0A
..1writes(":.")#0A..1writef(mess,.a)#0A..1newline()
#0A..1errcount.:#3D.errcount.+.1#0A..1IF.errcount.>
#3D.errmax.DO.{..writes("*nCompilation.aborted*n")#0A
..29longjump(fin_p,.fin_l)#0A..26}#0A..1selectoutpu
t(mcodeout)#0A}#0A#0A//.Allocation.and.freeing.of.4
-word.blocks.is.provided.by#0A//.newblk,.retblk.and
.retblks#2E#0A#0A//.Such.blocks.are.used.in.the.fol
lowing.lists:#0A#0A//.extlist,.globlist,.funlist,.m
anlist,.statlist,.sdlist.and.loclist#0A#0ALET.newbl
k(x,.y,.z,.t).#3D.VALOF#0A{..LET.p.#3D.blklist#0A#0A
..1TEST.p#3D0#0A..1THEN.{..p.:#3D.treep.-.4#0A..9IF
.treevec>p.DO.{..errmax.:#3D.0..6//.Make.it.fatal#2E
#0A..28trnerr("More.workspace.needed")#0A..25}#0A..
6}#0A..1ELSE.blklist.:#3D.h1!blklist#0A#0A..1p!0,.p
!1,.p!2,.p!3.:#3D.x,.y,.z,.t#0A..1treep.:#3D.p#0A..
1RESULTIS.p#0A}#0A#0AAND.retblk(p).BE#0A{..IF.p#3D0
.DO.abort(1234)#0A..1h1!p.:#3D.blklist#0A..1blklist
.:#3D.p#0A}#0A#0A//.Return.all.the.blocks.on.list.p
.to.blklist.up.to.but.not#0A//.including.q#2E.It.mu
st.work.even.when.p.or.q.are.zero#2E#0AAND.retblks(
p,.q).BE.UNTIL.p#3Dq#0A{..LET.a.#3D.p..//.a.points.
to.the.block.to.return#0A..1p.:#3D.h1!p#0A..1retblk
(a)#0A}#0A#0A//.translate.is.the.main.routine.of.TR
N,.it.translates.the#0A//.parse.tree.of.a.complete.
module.into.MCODE#2E#0A#0AAND.translate(x).BE#0A{..
//.If.module.occurs.at.all.it.will.be.the.leading.o
perator#0A..1IF.x~#3D0.&.h1!x#3Ds_module..1//.x.->.
[module,.Vid,.Body,.ln]#0A..1{..LET.vid.#3D.h2!x#0A
..4comline.:#3D.h4!x#0A..4out1(s_module)#0A..4outst
ring(@h3!vid)#0A..4x:#3Dh3!x#0A..1}#0A#0A..1resultl
ab,.breaklab,.looplab,.exitlab.:#3D.-2,.-2,.-2,.-2#0A
..1//.-2.above.means.such.jumps.to.such.labels.are.
out.of.context#2E#0A#0A..1comline,.procname,.mcount
,.labnumber.:#3D.1,.0,.0,.1#0A..1ssp,.nptr.:#3D.0,.
0#0A#0A..1//.hdepth.is.used.to.hold.the.depth.of.cu
rrent.exception#0A..1//.handler.within.the.current.
function#2E#0A#0A..1hdepth.:#3D.0#0A#0A..1//.It.is.
needed.in.the.implementation.of.GOTO,.BREAK,.LOOP,.
EXIT#0A..1//.and.RETURN#2E.The.difference.between.h
depth.and.matchhdepth,#0A..1//.rephdepth,.valofhdep
th.indicates.how.many.UNHANDLEs.to.generate#2E#0A#0A
..1matchhdepth,.rephdepth,.valofhdepth.:#3D.0,.0,.0
#0A#0A..1//.matchpos.is.the.stack.location#0A..1//.
of.the.first.MATCH.argument,.it.is.used.in.a.SETARG
S.statement#2E#0A..1//.matchlen.holds.the.number.ar
gument.locations.allocated#2E#0A#0A..1matchpos,.mat
chlen,.matchlab.:#3D.0,.0,.0#0A#0A..1//.blklist.hol
ds.the.list.of.free.4-word.blocks#0A..1blklist.:#3D
.0#0A#0A..1//.manlist.structure.is.as.follows#0A..1
//.L.->.0#0A..1//..1|..[L,.Cid,.val,.-]#0A..1//.man
list.is.built.first.by.a.sequential.scan.through.th
e.program#2E#0A..1manlist.:#3D.0#0A..1mkmanlist(x)#0A
#0A..1//.extlist.structure.is.as.follows#0A..1//.L.
->.0#0A..1//..1|..[L,.vid,..0010,.-]..imported.MCPL
.function#0A..1//..1|..[L,.vid,.vid,.-]..imported.C
.function.(2nd.vid.is.the.type)#0A..1//.extlist.is.
built.next#2E#0A..1extlist.:#3D.0#0A..1mkextlist(x)
#0A#0A..1//.globlist.structure.is.as.follows#0A..1/
/.L.->.0#0A..1//..1|..[L,.vid,.gn,..0010]..an.unini
tialised.global.variable#0A..1//..1|..[L,.vid,.gn,.
lab]..an.initialised.global.variable#0A..1//.The.la
b.is.inserted.when.the.global.function.in.translate
d#2E#0A..1//.globlist.is.built.next,.evaluating.con
stant.expressions#0A..1//..8in.the.scope.of.manlist
.(already.built)#2E#0A..1globlist,.lastgn.:#3D.0,.0
#0A..1mkgloblist(x)#0A#0A..1//.funlist.structure.is
.as.follows#0A..1//.L.->.0#0A..1//..1|..[L,.vid,..-
1,.lab]..local.or.global.MCPL.function#0A..1//..1|.
.[L,.vid,..0010,.lab]..exported.MCPL.function#0A..1
//..1|..[L,.vid,.vid,.lab]..exported.C.function.(2n
d.vid.is.the.type)#0A..1//.funlist.is.built.next.ch
ecking.for.matches.in.globlist.or.extlist#2E#0A..1f
unlist.:#3D.0#0A..1mkfunlist(x)#0A#0A..1//.statlist
.structure.is.as.follows#0A..1//.L.->.0#0A..1//..1|
..[L,.vid,.lab,.-]#0A..1//.statlist.is.built.next.p
ossibly.using.manlist.and.funlist#2E#0A..1statlist.
:#3D.0#0A..1mkstatlist(x)#0A#0A..1//.loclist.struct
ure.is.as.follows#0A..1//.L.->.0#0A..1//..1|..[L,.V
id,.q,.i]..where.q,i.is.the.path.for.a.local.variab
le#0A..1//.loclist.changes.on.entry.and.exit.to/fro
m.dynamic.scopes#2E#0A..1//.The.names.declared.from
.loclist.up.to.but.not.including.scopeptr#0A..1//.a
re.in.the.current.dynamic.scope#2E#0A..1loclist,.sc
opeptr.:#3D.0,.0#0A#0A..1//.sdlist.structure.is.use
d.in.the.compilation.of.static.constant#0A..1//.exp
ressions.and.is.as.follows#0A..1//.L.->.0#0A..1//..
1|..[L,.vid,.s_dw,.k]#0A..1//..1|..[L,.vid,.s_dl,.l
ab]#0A..1sdlist.:#3D.0#0A#0A..1trfunbodies(x)#0A#0A
..1outglobinits()#0A#0A..1out1(s_endmodule)#0A..1ne
wline()#0A}#0A#0A1AND.mkmanlist(x).BE.UNTIL.x#3D0.S
WITCHON.h1!x.INTO#0A{..DEFAULT:..trnerr("Compiler.e
rror.in.mkmanlist")#0A#0A..1CASE.s_global:#0A..1CAS
E.s_external:#0A..1CASE.s_static:.x.:#3D.h3!x;..2LO
OP#0A#0A..1CASE.s_fun:..2x.:#3D.h4!x;..2LOOP#0A#0A.
.1CASE.s_manifest:.//.x.->.[manifest,.Mlist,.Body,.
ln]#0A..7{..LET.p,.val.#3D.h2!x,.-1#0A..10comline.:
#3D.h4!x#0A..10UNTIL.p#3D0.DO#0A..10{..LET.e.#3D.h3
!p#0A..13TEST.e#3D0.THEN.val.:#3D.val+1#0A..22ELSE.
val.:#3D.evalconst(e)#0A..13manlist.:#3D.newblk(man
list,.h2!p,.val)#0A..13p.:#3D.h4!p#0A..10}#0A..10x.
:#3D.h3!x#0A..10LOOP#0A..7}#0A}#0A#0AAND.mkextlist(
x).BE.UNTIL.x#3D0.SWITCHON.h1!x.INTO#0A{..DEFAULT:.
.trnerr("Compiler.error.in.declexts")#0A#0A..1CASE.
s_manifest:#0A..1CASE.s_global:#0A..1CASE.s_static:
.x.:#3D.h3!x;..2LOOP#0A#0A..1CASE.s_fun:..2x.:#3D.h
4!x;..2LOOP#0A#0A..1CASE.s_external:#0A..13{..LET.p
.#3D.h2!x#0A..16LET.id.#3D.h2!p#0A..16comline.:#3D.
h4!x#0A..16UNLESS.findid(id,.extlist)#3D0.DO#0A..20
trnerr("External.%s.already.declared",.@h3!id)#0A..
16UNTIL.p#3D0.DO#0A..16{..extlist.:#3D.newblk(extli
st,.h2!p,.h3!p,.0)#0A..19p.:#3D.h4!p#0A..16}#0A..16
x.:#3D.h3!x#0A..16LOOP#0A..13}#0A}#0A#0AAND.mkglobl
ist(x).BE.UNTIL.x#3D0.SWITCHON.h1!x.INTO#0A{..DEFAU
LT:..trnerr("Compiler.error.in.mkgloblist")#0A#0A..
1CASE.s_manifest:#0A..1CASE.s_external:#0A..1CASE.s
_static:.x.:#3D.h3!x;..2LOOP#0A#0A..1CASE.s_fun:..2
x.:#3D.h4!x;..2LOOP#0A#0A..1CASE.s_global:.//.x.->.
[global,.Glist,.Body,.ln]#0A..7{..LET.p.#3D.h2!x#0A
..10LET.id.#3D.h2!p#0A..10comline.:#3D.h4!x#0A..10U
NLESS.findid(id,.globlist)#3D0.DO#0A..14trnerr("Glo
bal.%s.already.declared",.@h3!id)#0A..10UNTIL.p#3D0
.DO#0A..10{..LET.e.#3D.h3!p#0A..13TEST.e#3D0.THEN.l
astgn.:#3D.lastgn+1#0A..22ELSE.lastgn.:#3D.evalcons
t(e)#0A..13globlist.:#3D.newblk(globlist,.h2!p,.las
tgn,.0)#0A..13p.:#3D.h4!p#0A..10}#0A..10x.:#3D.h3!x
#0A..10LOOP#0A..7}#0A}#0A#0AAND.mkfunlist(x).BE.UNT
IL.x#3D0.SWITCHON.h1!x.INTO#0A{..DEFAULT:..trnerr("
Compiler.error.in.mkfunlist")#0A#0A..1CASE.s_extern
al:#0A..1CASE.s_manifest:#0A..1CASE.s_global:#0A..1
CASE.s_static:.x.:#3D.h3!x;..3LOOP#0A#0A..1CASE.s_f
un:.{..LET.id,.lab,.type.#3D.h2!x,.nextlab(),.-1#0A
..16LET.t.#3D.?#0A..16comline.:#3D.h6!x#0A..16UNLES
S.findid(id,.funlist)#3D0.DO#0A..20trnerr("Function
.%s.already.declared",.@h3!id)#0A..16t.:#3D.findid(
id,.extlist)#0A..16UNLESS.t#3D0.DO.type.:#3D.h4!t./
/.plant.the.EXTERNAL.type#0A..16t.:#3D.findid(id,.g
loblist)#0A..16UNLESS.t#3D0.DO.type,.h4!t.:#3D.-2,.
lab..//.Mark.as.global#0A..16funlist.:#3D.newblk(fu
nlist,.id,.type,.lab)#0A..16h5!x.:#3D.lab#0A..16x.:
#3D.h4!x#0A..16LOOP#0A..13}#0A}#0A#0AAND.mkstatlist
(x).BE.UNTIL.x#3D0.SWITCHON.h1!x.INTO#0A{..DEFAULT:
..trnerr("Compiler.error.in.mkstatlist")#0A#0A..1CA
SE.s_external:#0A..1CASE.s_manifest:#0A..1CASE.s_gl
obal:.x.:#3D.h3!x;..3LOOP#0A#0A..1CASE.s_fun:..2x.:
#3D.h4!x;..3LOOP#0A#0A..1CASE.s_static:.//.x.->.[st
atic,..1Slist,.Body,.ln]#0A..7{..LET.p.#3D.h2!x#0A.
.10comline.:#3D.h4!x#0A..10UNTIL.p#3D0.DO.//.p.->.[
sdef,.Vid,.0,.Slist]#0A..23//..1or.[sdef,.Vid,.SK,.
Slist]#0A..10{..LET.vid,.e,.lab.#3D.h2!p,.h3!p,.nex
tlab()#0A..13UNLESS.e#3D0.DO.trnstat(e)#0A..13out2(
s_dlab,.lab)#0A..13TEST.e#3D0.THEN.out2(s_dw,.0)#0A
..22ELSE.{..LET.q.#3D.sdlist#0A..30out2(h2!q,.h3!q)
#0A..30sdlist.:#3D.h1!q#0A..30retblk(q)#0A..27}#0A#0A
..13UNLESS.findid(vid,.funlist)#3D0.&.findid(vid,.s
tatlist)#3D0.DO#0A..20trnerr("Name.%s.already.decla
red",.@h3!vid)#0A..13statlist.:#3D.newblk(statlist,
.vid,.lab)#0A..13p.:#3D.h4!p#0A..10}#0A..10x.:#3D.h
3!x#0A..10LOOP#0A..7}#0A}#0A#0AAND.trfunbodies(x).B
E.UNTIL.x#3D0.SWITCHON.h1!x.INTO#0A{..DEFAULT:..trn
err("Compiler.error.in.trfunbodies")#0A#0A..1CASE.s
_manifest:.//.x.->.[manifest,.Mlist,.Body,.ln]#0A..
1CASE.s_global:..1//.x.->.[global,..1Glist,.Body,.l
n]#0A..1CASE.s_static:..1//.x.->.[static,..1Slist,.
Body,.ln]#0A..1CASE.s_external:.//.x.->.[external,.
Xlist,.Body,.ln]#0A..10x.:#3D.h3!x;..10LOOP#0A#0A..
1CASE.s_fun:..4//.x.->.[fun,.Vid,.Fndef,.Body,.-,.l
n]#0A..10transfun(x)#0A..10x.:#3D.h4!x#0A..10LOOP#0A
}#0A#0AAND.trnstat(x).BE.SWITCHON.h1!x.INTO#0A{..DE
FAULT:..4sdlist.:#3D.newblk(sdlist,.s_dw,.evalconst
(x))#0A..15RETURN#0A#0A..1CASE.s_comma:.trnstat(h3!
x)#0A..15trnstat(h2!x)#0A..15RETURN#0A#0A..1CASE.s_
lv:.{..LET.y,.t.#3D.h2!x,.0#0A..15IF.h1!y#3Ds_vid.&
.findid(y,.loclist)#3D0.DO#0A..18t.:#3D.findid(y,.s
tatlist)#0A..15IF.t#3D0.DO.trnerr("STATIC.variable.
needed.after.'@'")#0A..15//.t.->.[link,.vid,.lab]#0A
..15sdlist.:#3D.newblk(sdlist,.s_dl,.h3!t)#0A..15RE
TURN#0A..12}#0A#0A..1CASE.s_table:..//.x.->.[table,
.SKlist]#0A..1CASE.s_ltable:.//.x.->.[ltable,.SKlis
t]#0A..12{..LET.p,.lab.#3D.sdlist,.nextlab()#0A..15
trnstat(h2!x)#0A..15out2(s_dlab,.lab)#0A..15UNTIL.s
dlist#3Dp.DO#0A..15{..LET.q.#3D.sdlist#0A..18out2(h
2!q,.h3!q)#0A..18sdlist.:#3D.h1!q#0A..18retblk(q)#0A
..15}#0A..15sdlist.:#3D.newblk(sdlist,.s_dl,.lab)#0A
..15RETURN#0A..12}#0A#0A..1CASE.s_string:.//.x.->.[
string,.<upb>,.<bytes>]#0A..12{..LET.upb,.s,.lab.#3D
.h2!x,.@h3!x,.nextlab()#0A..15out2(s_dlab,.lab)#0A.
.15FOR.i.#3D.0.TO.upb.DO.out2(s_db,.s%i)#0A..15out2
(s_db,.0).//.strings.are.terminated.by.0#0A..15sdli
st.:#3D.newblk(sdlist,.s_dl,.lab)#0A..15RETURN#0A..
12}#0A#0A..1CASE.s_vec:..//.x.->.[vec,.K,.-]#0A..1C
ASE.s_cvec:.//.x.->.[cvec,.K,.-]#0A..12{..LET.upb,.
lab.#3D.evalconst(h2!x),.nextlab()#0A..15IF.h1!x#3D
s_cvec.DO.upb.:#3D.upb/4#0A..15out2(s_dlab,.lab)#0A
..15out2(s_ds,.upb+1)#0A..15sdlist.:#3D.newblk(sdli
st,.s_dl,.lab)#0A..15RETURN#0A..12}#0A#0A..1CASE.s_
vid:#0A..12{..LET.t.#3D.findid(x,.funlist)#0A..15IF
.t#3D0.DO.trnerr("FUN.%s.not.declared",.@h3!x)#0A..
15//.t.->.[link,.vid,.type,.lab]#0A..15sdlist.:#3D.
newblk(sdlist,.s_dl,.h4!t)#0A..15RETURN#0A..12}#0A}
#0A#0A//.tablabs.compiles.the.static.data.for.strin
gs.and.tables.that#0A//.occur.in.function.bodies#2E
#0AAND.tablabs(x).BE.UNTIL.x#3D0.SWITCHON.h1!x.INTO
#0A{..DEFAULT:..trnerr("Error.in.tablabs,.op.%n",.h
1!x)#0A..11RETURN#0A#0A..1CASE.s_numb:#0A..1CASE.s_
vid:#0A..1CASE.s_cid:#0A..1CASE.s_true:#0A..1CASE.s
_false:#0A..1CASE.s_query:#0A..1CASE.s_tablab:..1//
.replacement.for.s_string.and.s_table#0A..1CASE.s_v
ec:#0A..1CASE.s_cvec:#0A..1CASE.s_por:#0A..1CASE.s_
dots:#0A..1CASE.s_break:#0A..1CASE.s_loop:#0A..11RE
TURN#0A#0A..1CASE.s_string:#0A..1CASE.s_table:#0A..
8{..LET.p.#3D.sdlist#0A..11trnstat(x)#0A..11//.sdli
st.->.[link,.s_dl,.lab]#0A..11h1!x,.h2!x.:#3D.s_tab
lab,.h3!sdlist#0A..11retblk(sdlist)#0A..11sdlist.:#3D
.p#0A..11RETURN#0A..8}#0A#0A..1CASE.s_sdef:.//.used
.in.[let,.slist,.ln]#0A..14//.Slist.->.0#0A..14//..
6|.[SDEF,.vid,.0,.Slist]#0A..14//..6|.[SDEF,.vid,.E
,.Slist]#0A..1CASE.s_cond:#0A..11tablabs(h2!x)#0A..
11tablabs(h3!x)#0A..11x.:#3D.h4!x;.LOOP#0A#0A..1CAS
E.s_call:#0A..1CASE.s_indb:#0A..1CASE.s_indw:#0A..1
CASE.s_lsh:#0A..1CASE.s_rsh:#0A..1CASE.s_bitand:#0A
..1CASE.s_mult:#0A..1CASE.s_div:#0A..1CASE.s_mod:#0A
..1CASE.s_xor:#0A..1CASE.s_bitor:#0A..1CASE.s_plus:
#0A..1CASE.s_sub:#0A..1CASE.s_rel:#0A..1CASE.s_and:
#0A..1CASE.s_or:#0A..1CASE.s_eq:#0A..1CASE.s_ne:#0A
..1CASE.s_le:#0A..1CASE.s_ge:#0A..1CASE.s_ls:#0A..1
CASE.s_gr:#0A..1CASE.s_pand:#0A..1CASE.s_comma:#0A.
.1CASE.s_seq:#0A..11tablabs(h2!x)#0A..11x.:#3D.h3!x
;.LOOP#0A#0A..1CASE.s_for:#0A..11comline.:#3D.h7!x#0A
..11tablabs(h3!x)#0A..11comline.:#3D.h7!x#0A..11tab
labs(h4!x)#0A..11comline.:#3D.h7!x#0A..11tablabs(h5
!x)#0A..11comline.:#3D.h7!x#0A..11x.:#3D.h6!x;.LOOP
#0A#0A..1CASE.s_test:#0A..1CASE.s_funpat:#0A..11com
line.:#3D.h5!x#0A..11tablabs(h2!x)#0A..11comline.:#3D
.h5!x#0A..11tablabs(h3!x)#0A..11comline.:#3D.h5!x#0A
..11x.:#3D.h4!x;.LOOP#0A#0A..1CASE.s_repeatwhile:#0A
..1CASE.s_repeatuntil:#0A..1CASE.s_handle:#0A..1CAS
E.s_if:#0A..1CASE.s_unless:#0A..1CASE.s_while:#0A..
1CASE.s_until:#0A..1CASE.s_every:#0A..1CASE.s_match
:#0A..1CASE.s_ass:#0A..1CASE.s_allass:#0A..1CASE.s_
lshass:#0A..1CASE.s_rshass:#0A..1CASE.s_andass:#0A.
.1CASE.s_multass:#0A..1CASE.s_divass:#0A..1CASE.s_m
odass:#0A..1CASE.s_xorass:#0A..1CASE.s_plusass:#0A.
.1CASE.s_subass:#0A..1CASE.s_orass:#0A..11comline.:
#3D.h4!x#0A..11tablabs(h2!x)#0A..11comline.:#3D.h4!
x#0A..11x.:#3D.h3!x;.LOOP#0A#0A..1CASE.s_let:#0A..1
CASE.s_repeat:#0A..1CASE.s_raise:#0A..1CASE.s_goto:
#0A..1CASE.s_result:#0A..1CASE.s_exit:#0A..1CASE.s_
return:#0A..11comline.:#3D.h3!x#0A..11x.:#3D.h2!x;.
LOOP#0A#0A..1CASE.s_inc1a:#0A..1CASE.s_inc4a:#0A..1
CASE.s_dec1a:#0A..1CASE.s_dec4a:#0A..1CASE.s_inc1b:
#0A..1CASE.s_inc4b:#0A..1CASE.s_dec1b:#0A..1CASE.s_
dec4b:#0A#0A..1CASE.s_neg:#0A..1CASE.s_bitnot:#0A..
1CASE.s_not:#0A..1CASE.s_abs:#0A..1CASE.s_lv:#0A..1
CASE.s_indb0:#0A..1CASE.s_indw0:#0A..1CASE.s_ptr:#0A
..1CASE.s_peq:#0A..1CASE.s_pne:#0A..1CASE.s_ple:#0A
..1CASE.s_pge:#0A..1CASE.s_pls:#0A..1CASE.s_pgr:#0A
..1CASE.s_pass:#0A..1CASE.s_plshass:#0A..1CASE.s_pr
shass:#0A..1CASE.s_pmultass:#0A..1CASE.s_pdivass:#0A
..1CASE.s_pmodass:#0A..1CASE.s_pandass:#0A..1CASE.s
_pxorass:#0A..1CASE.s_pplusass:#0A..1CASE.s_psubass
:#0A..1CASE.s_porass:#0A#0A..1CASE.s_valof:#0A..1CA
SE.s_ltable:#0A..1CASE.s_scope:#0A..11x.:#3D.h2!x;.
LOOP#0A}#0A#0A//.The.following.function.is.used.to.
measure.the.approx.size#0A//.of.an.expression#2E..I
t.is.called.during.the.translation.of#0A//.WHILE.an
d.UNTIL.to.see.if.it.is.worth.translating.the.contr
olling#0A//.expression.twice#2E..Large.expressions.
or.expressions.containing#0A//.assignments.should.o
nly.be.translated.once#2E#0A//.It.is.also.used.to.d
ecide.which.operand.of.a.symetric.operator#0A//.to.
compile.first#2E#0A#0AAND.expsize(x).#3D.VALOF#0A{.
.LET.res.#3D.1#0A..1IF.x#3D0.RESULTIS.0#0A..1SWITCH
ON.h1!x.INTO#0A..1{..DEFAULT:..RESULTIS.100#0A#0A..
4CASE.s_cond:..res.:#3D.res.+.expsize(h4!x)#0A#0A..
4CASE.s_call:#0A..4CASE.s_indb:#0A..4CASE.s_indw:#0A
..4CASE.s_lsh:#0A..4CASE.s_rsh:#0A..4CASE.s_bitand:
#0A..4CASE.s_mult:#0A..4CASE.s_div:#0A..4CASE.s_mod
:#0A..4CASE.s_xor:#0A..4CASE.s_bitor:#0A..4CASE.s_p
lus:#0A..4CASE.s_sub:#0A..4CASE.s_rel:#0A..4CASE.s_
and:#0A..4CASE.s_or:#0A..4CASE.s_eq:#0A..4CASE.s_ne
:#0A..4CASE.s_le:#0A..4CASE.s_ge:#0A..4CASE.s_ls:#0A
..4CASE.s_gr:#0A..4CASE.s_comma:..res.:#3D.res.+.ex
psize(h3!x)#0A#0A..4CASE.s_inc1a:#0A..4CASE.s_inc4a
:#0A..4CASE.s_dec1a:#0A..4CASE.s_dec4a:#0A..4CASE.s
_inc1b:#0A..4CASE.s_inc4b:#0A..4CASE.s_dec1b:#0A..4
CASE.s_dec4b:#0A#0A..4CASE.s_neg:#0A..4CASE.s_bitno
t:#0A..4CASE.s_not:#0A..4CASE.s_abs:#0A..4CASE.s_lv
:#0A..4CASE.s_indb0:#0A..4CASE.s_indw0:..res.:#3D.r
es.+.expsize(h2!x)#0A#0A..4CASE.s_numb:#0A..4CASE.s
_vid:#0A..4CASE.s_cid:#0A..4CASE.s_true:#0A..4CASE.
s_false:#0A..4CASE.s_query:#0A..4CASE.s_tablab:.RES
ULTIS.res#0A..1}#0A}#0A#0A//.The.following.procedur
e.generates.LOCS.statements.for.dynamic.variables#0A
//.and.vectors,.and.adds.the.names.of.local.variabl
es.to.loclist#2E#0AAND.decldyn(x).BE.UNTIL.x#3D0.SW
ITCHON.h1!x.INTO#0A{..DEFAULT:..trnerr("Error.in.de
cldyn,.op.%n",.h1!x)#0A..11RETURN#0A#0A..1CASE.s_nu
mb:#0A..1CASE.s_vid:#0A..1CASE.s_cid:#0A..1CASE.s_t
rue:#0A..1CASE.s_false:#0A..1CASE.s_string:#0A..1CA
SE.s_table:#0A..1CASE.s_query:#0A..1CASE.s_tablab:.
.1//.replacement.for.s_string.and.s_table#0A..1CASE
.s_por:#0A..1CASE.s_break:#0A..1CASE.s_loop:#0A..1C
ASE.s_valof:#0A..1CASE.s_for:#0A..1CASE.s_scope:#0A
..11RETURN#0A#0A..1CASE.s_let:..2//.x.->.[let,.Slis
t,.ln]#0A..16//.Slist.->.0#0A..16//..6|.[sdef,.vid,
.E,.Slist]#0A..16//..6|.[sdef,.vid,.0,.Slist]#0A..8
{..LET.p.#3D.h2!x#0A..11comline.:#3D.h3!x#0A..11UNT
IL.p#3D0.DO#0A..11{..checkdistinct(h2!p)#0A..14locl
ist.:#3D.newblk(loclist,.h2!p,.0,.ssp)#0A..14out2(s
_locs,.1).//.for.the.vid#0A..14ssp.:#3D.ssp+1#0A..1
4decldyn(h3!p)..1//.decl.locals.in.E#0A..14p.:#3D.h
4!p#0A..11}#0A..11RETURN#0A..8}#0A#0A..1CASE.s_vec:
..//.x.->.[vec,.K,.q]#0A..1CASE.s_cvec:.//.x.->.[cv
ec,.K,.q]#0A..8{..LET.upb.#3D.evalconst(h2!x)#0A..1
1IF.h1!x#3Ds_cvec.DO.upb.:#3D.upb/4#0A..11UNLESS.up
b>#3D0.DO.trnerr("Bad.vector.upper.bound")#0A..11h3
!x.:#3D.ssp#0A..11out2(s_locs,.upb+1)#0A..11ssp.:#3D
.ssp.+.upb.+.1#0A..11RETURN#0A..8}#0A#0A..1CASE.s_l
table:.//.x.->.[ltable,.Elist,.q]#0A..8{..LET.len.#3D
.listlen(h2!x)#0A..11out2(s_locs,.len)#0A..11h3!x.:
#3D.ssp#0A..11ssp.:#3D.ssp.+.len#0A..11x.:#3D.h2!x#0A
..11LOOP#0A..8}#0A#0A..1//.The.arguments.of.a.MATCH
.or.EVERY.construct#0A..1//.are.in.the.current.dyna
mic.scope,.but.NOT.the.body#2E#0A..1CASE.s_match:#0A
..1CASE.s_every:#0A..11x.:#3D.h2!x;.LOOP#0A#0A..1CA
SE.s_cond:#0A..11decldyn(h2!x)#0A..11decldyn(h3!x)#0A
..11x.:#3D.h4!x;.LOOP#0A#0A..1CASE.s_call:#0A..1CAS
E.s_indb:#0A..1CASE.s_indw:#0A..1CASE.s_lsh:#0A..1C
ASE.s_rsh:#0A..1CASE.s_bitand:#0A..1CASE.s_mult:#0A
..1CASE.s_div:#0A..1CASE.s_mod:#0A..1CASE.s_xor:#0A
..1CASE.s_bitor:#0A..1CASE.s_plus:#0A..1CASE.s_sub:
#0A..1CASE.s_rel:#0A..1CASE.s_and:#0A..1CASE.s_or:#0A
..1CASE.s_eq:#0A..1CASE.s_ne:#0A..1CASE.s_le:#0A..1
CASE.s_ge:#0A..1CASE.s_ls:#0A..1CASE.s_gr:#0A..1CAS
E.s_pand:#0A..1CASE.s_comma:#0A..1CASE.s_seq:#0A..1
1decldyn(h2!x)#0A..11x.:#3D.h3!x;.LOOP#0A#0A..1CASE
.s_test:#0A..11comline.:#3D.h5!x#0A..11decldyn(h2!x
)#0A..11comline.:#3D.h5!x#0A..11decldyn(h3!x)#0A..1
1comline.:#3D.h5!x#0A..11x.:#3D.h4!x;.LOOP#0A#0A..1
CASE.s_repeatwhile:#0A..1CASE.s_repeatuntil:#0A..1C
ASE.s_if:#0A..1CASE.s_unless:#0A..1CASE.s_while:#0A
..1CASE.s_until:#0A..1CASE.s_ass:#0A..1CASE.s_allas
s:#0A..1CASE.s_lshass:#0A..1CASE.s_rshass:#0A..1CAS
E.s_multass:#0A..1CASE.s_divass:#0A..1CASE.s_modass
:#0A..1CASE.s_andass:#0A..1CASE.s_xorass:#0A..1CASE
.s_plusass:#0A..1CASE.s_subass:#0A..1CASE.s_orass:#0A
..11comline.:#3D.h4!x#0A..11decldyn(h2!x)#0A..11com
line.:#3D.h4!x#0A..11x.:#3D.h3!x;.LOOP#0A#0A..1CASE
.s_handle:#0A..11comline.:#3D.h4!x#0A..11x.:#3D.h2!
x;.LOOP#0A#0A..1CASE.s_repeat:#0A..1CASE.s_raise:#0A
..1CASE.s_goto:#0A..1CASE.s_result:#0A..1CASE.s_exi
t:#0A..1CASE.s_return:#0A..11comline.:#3D.h3!x#0A..
11x.:#3D.h2!x;.LOOP#0A#0A..1CASE.s_inc1a:#0A..1CASE
.s_inc4a:#0A..1CASE.s_dec1a:#0A..1CASE.s_dec4a:#0A.
.1CASE.s_inc1b:#0A..1CASE.s_inc4b:#0A..1CASE.s_dec1
b:#0A..1CASE.s_dec4b:#0A#0A..1CASE.s_neg:#0A..1CASE
.s_bitnot:#0A..1CASE.s_not:#0A..1CASE.s_abs:#0A..1C
ASE.s_lv:#0A..1CASE.s_indb0:#0A..1CASE.s_indw0:#0A.
.11x.:#3D.h2!x;.LOOP#0A}#0A#0A//.The.following.func
tion.is.used.to.translate.function.definitions#2E#0A
AND.transfun(x).BE#0A{..LET.t,.numbargs.#3D.0,.?#0A
..1//.x.->.[fun,.vid,.Fndef,.Body,.lab,.ln]#0A..1pr
ocname.:#3D.h2!x#0A..1comline.:#3D.h6!x#0A#0A..1hde
pth.:#3D.0#0A..1matchhdepth,.rephdepth,.valofhdepth
.:#3D.0,.0,.0#0A..1matchpos,.matchlen.:#3D.0,.0#0A#0A
..1matchlab.:#3D.-2#0A..1breaklab,..looplab.:#3D.-2
,.-2#0A..1resultlab,.exitlab.:#3D.-2,.nextlab()#0A#0A
..1tablabs(h3!x).//.replace.all.occurrences.of#0A..
15//.[string,#2E#2E].and.[table,#2E#2E]#0A..15//.by
.[tablab,lab]#0A#0A..1t.:#3D.findid(procname,.funli
st)#0A#0A..1comline.:#3D.h6!x#0A..1outline()#0A#0A.
.1TEST.-2<#3Dh3!t<#3D0.THEN.{..out2(s_fun,.h5!x)#0A
..26outstring(@h3!procname)#0A..23}#0A..18ELSE.{../
/.t.->.[link,.vid,.type,.lab]#0A..26out2(s_cfun,.h5
!x)#0A..26outstring(@h3!procname)#0A..26outstring(h
3!t+2)#0A..23}#0A#0A..1numbargs.:#3D.maxpatlen(h3!x
)#0A..1out2(s_fnargs,.numbargs)..1//.allocate.space
.for.function.arguments#0A..1ssp.:#3D.3.+.numbargs#0A
#0A..1trmatch(h3!x,.3,.numbargs).//.first.arg.(if.a
ny).is.in.P!3#0A#0A..1out2(s_ln,.0)#0A..1out2(s_rai
se,.1)#0A..1out2(s_lab,.exitlab)#0A..1out1(s_return
)#0A..1out1(s_endfun)#0A..1procname.:#3D.0#0A}#0A#0A
//.The.following.function.translates.a.list.of.matc
h.items#0A//.of.the.form.:#0A//..5:.Plist.#3D>.Clis
t#0A//..7#2E#2E1#0A//..5:.Plist.#3D>.Clist#0A//.whi
ch.can.occur.as.the.body.of.function.definition,.in
.a#0A//.MATCH.or.EVERY.construct.or.in.the.HANDLE.c
onstruct#2E#0A//..1x..6is.the.list.of.match.items#0A
//..1ssp1..3is.the.position.of.the.first.argument#0A
//..1numbargs.is.3.for.the.HANDLE.construct.otherwi
se.it.is.the#0A//..10the.maximum.number.of.expected
.arguments#2E#0A//.On.entry.ssp.is.the.stack.positi
on.of.the.first.argument??2#0A#0AAND.trmatch(x,.ssp
1,.numbargs).BE#0A{..LET.ptr0.#3D.ssp..4//.the.Q.nu
mber.of.the.next.pattern.pointer#0A..1//..ssp1.is.t
he.Q.number.of.the.first.argument.(if.any)#0A..1LET
.omp,.omlen,.oml,.omhd.#3D.matchpos,.matchlen,.matc
hlab,.matchhdepth#0A#0A..1matchpos,.matchlen,.match
lab.:#3D.ssp1,.numbargs,.nextlab()#0A..1matchhdepth
.:#3D.hdepth#0A..1out2(s_lab,.matchlab)#0A..1out3(s
_match,.numbargs,.matchpos)#0A#0A..1UNTIL.x#3D0.DO#0A
..1{..//.x.->.[funpat,.Plist,.Clist,.Fndef,.ln]#0A.
.4LET.flab.#3D.nextlab()..3//.match.failure.label#0A
..4LET.oldscopeptr.#3D.scopeptr#0A..4scopeptr.:#3D.
loclist#0A..4comline.:#3D.h5!x#0A..4outline()#0A#0A
..4allocptrs(h2!x,.0,.ssp1).//.allocate.space.for.t
he.access.pointers#0A..29//.for.this.pattern.list#0A
#0A..4//.declare.vids.and.dynamic.quantities.in.the
.pattern#0A..4nptr.:#3D.ptr0..//.the.Q.number.of.th
e.first.access.pointer#0A..4declpatids(h2!x,.0,.ssp
1)#0A#0A..4nptr.:#3D.ptr0#0A..4initptrs(h2!x,.0,.ss
p1)#0A#0A..4//.compile.pattern.tests,.match.failure
.jumps.to.lab#0A..4nptr.:#3D.ptr0..//.the.Q.number.
of.the.first.access.pointer#0A..4trnpat(h2!x,.0,.ss
p1,.flab)#0A#0A..4//.compile.pattern.assignment.ope
rations#0A..4nptr.:#3D.ptr0..//.the.Q.number.of.the
.first.access.pointer#0A..4trnpatinits(h2!x,.0,.ssp
1)#0A#0A..4//.compiler.the.command.list.in.given.co
ntext#0A..4{..LET.q,.oldscopeptr.#3D.ssp,.scopeptr#0A
..7scopeptr.:#3D.loclist#0A..7decldyn(h3!x)#0A..7tr
ans(h3!x)#0A..7//.exitlab#3D0.if.in.an.EVERY.statem
ent#0A..7IF.exitlab>0.DO.out2(s_jump,.exitlab)#0A..
7retblks(loclist,.scopeptr)#0A..7loclist.:#3D.scope
ptr#0A..7scopeptr.:#3D.oldscopeptr#0A..7UNLESS.ssp#3D
q.DO.{..out2(s_stack,.q);.ssp.:#3D.q.}#0A..4}#0A#0A
..4out2(s_lab,.flab)#0A..4retblks(loclist,.scopeptr
)#0A..4loclist.:#3D.scopeptr#0A..4scopeptr.:#3D.old
scopeptr#0A..4UNLESS.ssp#3Dptr0.DO.{..out2(s_stack,
.ptr0);.ssp.:#3D.ptr0.}#0A#0A..4x.:#3D.h4!x..1//.de
al.with.next.match.item.(if.any)#0A..1}#0A#0A..1mat
chpos,.matchlen,.matchlab,.matchhdepth.:#3D.omp,.om
len,.oml,.omhd#0A..1ssp.:#3D.ptr0#0A}#0A#0AAND.maxp
atlen(x).#3D.VALOF#0A{..LET.res.#3D.0#0A..1UNTIL.x#3D
0.DO.{..LET.len.#3D.listlen(h2!x)#0A..17IF.res<len.
DO.res.:#3D.len#0A..17x.:#3D.h4!x#0A..14}#0A..1RESU
LTIS.res#0A}#0A#0AAND.listlen(p).#3D.VALOF#0A{..LET
.res.#3D.1#0A..1IF.p#3D0.RESULTIS.0#0A..1WHILE.h1!p
#3Ds_comma.DO.res,.p.:#3D.res+1,.h3!p#0A..1RESULTIS
.res#0A}#0A#0A//.Allocate.space.for.the.access.poin
ters.for.pattern.x#0A//.n,.i.gives.the.address.of.t
he.location.to.be.matched.by.the#0A//.pattern#2E.(0
,i).corresponds.to.cell.P!i,.and.(n,i).corresponds#0A
//.to.cell.P!n!i#2E#0AAND.allocptrs(x,.n,.i).BE.UNL
ESS.x#3D0.SWITCHON.h1!x.INTO#0A{..DEFAULT:..4RETURN
#0A#0A..1CASE.s_comma:.allocptrs(h2!x,.n,.i)#0A..15
allocptrs(h3!x,.n,.i+1)#0A..15RETURN#0A#0A..1CASE.s
_pand:..allocptrs(h2!x,.n,.i)#0A..15allocptrs(h3!x,
.n,.i)#0A..15RETURN#0A#0A..1CASE.s_ptr:..1out1(s_pt
r)#0A..15ssp.:#3D.ssp.+.1#0A..15allocptrs(h2!x,.ssp
-1,.0)#0A}#0A#0A//.Initialise.the.access.pointers.f
or.pattern.x#0AAND.initptrs(x,.n,.i).BE.UNLESS.x#3D
0.SWITCHON.h1!x.INTO#0A{..DEFAULT:..4RETURN#0A#0A..
1CASE.s_comma:.initptrs(h2!x,.n,.i)#0A..15initptrs(
h3!x,.n,.i+1)#0A..15RETURN#0A#0A..1CASE.s_pand:..in
itptrs(h2!x,.n,.i)#0A..15initptrs(h3!x,.n,.i)#0A..1
5RETURN#0A#0A..1CASE.s_ptr:..1lpath(n,.i)#0A..15ssp
.:#3D.ssp+1#0A..15out2(s_sp,.nptr).//.initialise.ne
w.access.pointer#0A..15ssp.:#3D.ssp-1#0A..15nptr.:#3D
.nptr.+.1#0A..15initptrs(h2!x,.nptr-1,.0)#0A}#0A#0A
//.This.function.declares.dynamic.names.by.placing.
them.in.loclist,#0A//.and.generates.LOCS.to.allocat
e.space.for.dynamic.vectors.occurring#0A//.within.t
he.pattern#2E#0AAND.declpatids(x,.n,.i).BE.UNLESS.x
#3D0.SWITCHON.h1!x.INTO#0A{..DEFAULT:..4//trnerr("E
rror.in.declpatids,.op.%n",.h1!x)#0A..15RETURN#0A#0A
..1CASE.s_peq:#0A..1CASE.s_pne:#0A..1CASE.s_ple:#0A
..1CASE.s_pge:#0A..1CASE.s_pls:#0A..1CASE.s_pgr:#0A
..1CASE.s_pass:#0A..1CASE.s_plshass:#0A..1CASE.s_pr
shass:#0A..1CASE.s_pmultass:#0A..1CASE.s_pdivass:#0A
..1CASE.s_pmodass:#0A..1CASE.s_pandass:#0A..1CASE.s
_pxorass:#0A..1CASE.s_pplusass:#0A..1CASE.s_psubass
:#0A..1CASE.s_porass:#0A..15decldyn(h2!x)#0A..15RET
URN#0A#0A..1CASE.s_comma:.declpatids(h2!x,.n,.i)#0A
..15declpatids(h3!x,.n,.i+1)#0A..15RETURN#0A#0A..1C
ASE.s_pand:..declpatids(h2!x,.n,.i)#0A..15declpatid
s(h3!x,.n,.i)#0A..15RETURN#0A#0A..1CASE.s_vid:..1ch
eckdistinct(x)#0A..15loclist.:#3D.newblk(loclist,.x
,.n,.i)#0A..15RETURN#0A#0A..1CASE.s_ptr:..1nptr.:#3D
.nptr+1#0A..15declpatids(h2!x,.nptr-1,.0)#0A..15RET
URN#0A}#0A#0A//.In.the.following.function.(n,i).den
otes.the.current.argument,#0A//.b.gives.the.sense.o
f.the.jump.(TRUE.->.jt,.FALSE.->.jf),.lab.is.the#0A
//.destination.label#2E..x.is.the.pattern#2E#0AAND.
trnkpat(x,.n,.i,.b,.lab).BE.UNLESS.x#3D0.SWITCHON.h
1!x.INTO#0A{..DEFAULT:..2//trnerr("trnkpat.%n",.h1!
x)#0A..13RETURN#0A#0A..1CASE.s_cid:#0A..1CASE.s_num
b:..3lpath(n,.i)#0A..18ssp.:#3D.ssp+1#0A..18load(x)
#0A..18out3(s_eq,.(b->s_jt,s_jf),.lab)#0A..18ssp.:#3D
.ssp-2#0A..18RETURN#0A#0A..1CASE.s_true:..3lpath(n,
.i)#0A..18ssp.:#3D.ssp+1#0A..18out2((b->s_jt,s_jf),
.lab)#0A..18ssp.:#3D.ssp-1#0A..18RETURN#0A#0A..1CAS
E.s_false:..2lpath(n,.i)#0A..18ssp.:#3D.ssp+1#0A..1
8out2((b->s_jf,s_jt),.lab)#0A..18ssp.:#3D.ssp-1#0A.
.18RETURN#0A#0A..1CASE.s_dots:..TEST.b#0A..15THEN.{
..LET.m.#3D.nextlab()#0A..23lpath(n,.i)#0A..23ssp.:
#3D.ssp+1#0A..23load(h2!x)#0A..23out3(s_ge,.s_jf,.m
)#0A..23ssp.:#3D.ssp-2#0A..23lpath(n,.i)#0A..23ssp.
:#3D.ssp+1#0A..23load(h3!x)#0A..23out3(s_le,.s_jt,.
lab)#0A..23ssp.:#3D.ssp-2#0A..23out2(s_lab,.m)#0A..
20}#0A..15ELSE.{..lpath(n,.i)#0A..23ssp.:#3D.ssp+1#0A
..23load(h2!x)#0A..23out3(s_ge,.s_jf,.lab)#0A..23ss
p.:#3D.ssp-2#0A..23lpath(n,.i)#0A..23ssp.:#3D.ssp+1
#0A..23load(h3!x)#0A..23out3(s_le,.s_jf,.lab)#0A..2
3ssp.:#3D.ssp-2#0A..20}#0A..15RETURN#0A}#0A#0AAND.t
rnpat(x,.n,.i,.lab).BE.UNLESS.x#3D0.SWITCHON.h1!x.I
NTO#0A{..DEFAULT:..4RETURN#0A#0A..1CASE.s_comma:.tr
npat(h2!x,.n,.i,.lab)#0A..15trnpat(h3!x,.n,.i+1,.la
b)#0A..15RETURN#0A#0A..1CASE.s_pand:..trnpat(h2!x,.
n,.i,.lab)#0A..15trnpat(h3!x,.n,.i,.lab)#0A..15RETU
RN#0A#0A..1CASE.s_por:{..LET.m.#3D.nextlab()#0A..15
WHILE.h1!x#3Ds_por.DO#0A..15{..trnkpat(h2!x,.n,.i,.
TRUE,.m)#0A..18x.:#3D.h3!x#0A..15}#0A..15trnkpat(x,
.n,.i,.FALSE,.lab)#0A..15out2(s_lab,.m)#0A..15RETUR
N#0A..12}#0A#0A..1CASE.s_cid:#0A..1CASE.s_numb:#0A.
.1CASE.s_true:#0A..1CASE.s_false:#0A..1CASE.s_dots:
..trnkpat(x,.n,.i,.FALSE,.lab)#0A#0A..1CASE.s_vid:#0A
..1CASE.s_query:.RETURN#0A#0A..1CASE.s_ptr:..1nptr.
:#3D.nptr+1#0A..15trnpat(h2!x,.nptr-1,.0,.lab)#0A..
15RETURN#0A#0A..1CASE.s_peq:#0A..1CASE.s_pne:#0A..1
CASE.s_ple:#0A..1CASE.s_pge:#0A..1CASE.s_pls:#0A..1
CASE.s_pgr:#0A..15lpath(n,.i)#0A..15ssp.:#3D.ssp+1#0A
..15load(h2!x)#0A..15out3(s_eq+h1!x-s_peq,.s_jf,.la
b)#0A..15ssp.:#3D.ssp-2#0A..15RETURN#0A}#0A#0AAND.l
path(n,.i).BE.TEST.n#3D0.THEN.out2(s_lp,.i)#0A..17E
LSE.out3(s_lpath,.n,.i)#0A#0A1AND.llpath(n,.i).BE.T
EST.n#3D0.THEN.out2(s_llp,.i)#0A..18ELSE.out3(s_llp
ath,.n,.i)#0A#0AAND.spath(n,.i).BE.TEST.n#3D0.THEN.
out2(s_sp,.i)#0A..17ELSE.out3(s_spath,.n,.i)#0A#0AA
ND.trnpatinits(x,.n,.i).BE.UNLESS.x#3D0.SWITCHON.h1
!x.INTO#0A{..DEFAULT:..4RETURN#0A#0A..1CASE.s_comma
:.trnpatinits(h2!x,.n,.i)#0A..15trnpatinits(h3!x,.n
,.i+1)#0A..15RETURN#0A#0A..1CASE.s_pand:..trnpatini
ts(h2!x,.n,.i)#0A..15trnpatinits(h3!x,.n,.i)#0A..15
RETURN#0A#0A..1CASE.s_ptr:..1nptr.:#3D.nptr.+.1#0A.
.15trnpatinits(h2!x,.nptr-1,.0)#0A..15RETURN#0A#0A.
.1CASE.s_pass:..load(h2!x)#0A..15spath(n,.i)#0A..15
ssp.:#3D.ssp-1#0A..15RETURN#0A#0A..1CASE.s_plshass:
#0A..1CASE.s_prshass:#0A..1CASE.s_pmultass:#0A..1CA
SE.s_pdivass:#0A..1CASE.s_pmodass:#0A..1CASE.s_pand
ass:#0A..1CASE.s_pxorass:#0A..1CASE.s_pplusass:#0A.
.1CASE.s_psubass:#0A..1CASE.s_porass:#0A..15lpath(n
,.i)#0A..15ssp.:#3D.ssp+1#0A..15load(h2!x)#0A..15ou
t1(s_lsh+h1!x-s_plshass)#0A..15ssp.:#3D.ssp-1#0A..1
5spath(n,.i)#0A..15ssp.:#3D.ssp-1#0A..15RETURN#0A}#0A
#0A//.The.structure.of.an.id.list.is.as.follows:#0A
//#0A//.t.->.0#0A//..1|..[t,.id,.a,.b]..1where.a.an
d.b.depend.on.the.kind.of.id.list#0A//#0A//.findid(
id,.t).returns.the.pointer.to.the.matching.id.node#0A
//..21or.zero.if.not.found#0AAND.findid(id,.t).#3D.
VALOF#0A{..UNTIL.t#3D0.|.id#3Dh2!t.DO.t.:#3D.h1!t#0A
..1RESULTIS.t#0A}#0A#0A//.The.following.routine.tra
nslates.commands.and.expressions#2E#0A//.Expression
.results.are.left.in.RES#2E#0A#0ALET.trans(x).BE#0A
{..LET.sw.#3D.FALSE#0A#0A..1IF.x#3D0.RETURN#0A#0A..
1SWITCHON.h1!x.INTO#0A..1{..DEFAULT:.load(x);.out1(
s_str);.ssp.:#3D.ssp-1#0A..13RETURN#0A#0A..4CASE.s_
and:CASE.s_or:#0A..7{..LET.lab,.lab1.#3D.nextlab(),
.nextlab()#0A..10jumpcond(x,.FALSE,.lab)#0A..10out2
(s_true,.s_str)#0A..10out2(s_jump,.lab1)#0A..10out2
(s_lab,.lab)#0A..10out2(s_false,.s_str)#0A..10out2(
s_lab,.lab1)#0A..10RETURN#0A..7}#0A#0A..4CASE.s_con
d:..{..LET.l,.m.#3D.nextlab(),.nextlab()#0A..21jump
cond(h2!x,.FALSE,.m)#0A..21trans(h3!x)#0A..21out2(s
_jump,.l)#0A..21out2(s_lab,.m)#0A..21trans(h4!x)#0A
..21out2(s_lab,.l)#0A..21RETURN#0A..18}#0A#0A..4CAS
E.s_valof:.{..LET.oldscopeptr,.q,.rl.#3D.scopeptr,.
ssp,.resultlab#0A..21LET.oldvalofhdepth.#3D.valofhd
epth#0A..21valofhdepth.:#3D.hdepth#0A..21scopeptr.:
#3D.loclist#0A..21resultlab.:#3D.nextlab()#0A..21de
cldyn(h2!x)#0A..21trans(h2!x)#0A..21out2(s_lab,.res
ultlab)#0A..21UNLESS.ssp#3Dq.DO.{..ssp.:#3D.q;.out2
(s_stack,.ssp).}#0A..21retblks(loclist,.scopeptr)#0A
..21loclist,.resultlab.:#3D.scopeptr,.rl#0A..21valo
fhdepth.:#3D.oldvalofhdepth#0A..21scopeptr.:#3D.old
scopeptr#0A..21RETURN#0A..18}#0A#0A..4CASE.s_scope:
.{..LET.oldscopeptr,.q.#3D.scopeptr,.ssp#0A..21scop
eptr.:#3D.loclist#0A..21decldyn(h2!x)#0A..21trans(h
2!x)#0A..21UNLESS.ssp#3Dq.DO.{..ssp.:#3D.q;.out2(s_
stack,.ssp).}#0A..21retblks(loclist,.scopeptr)#0A..
21loclist.:#3D.scopeptr#0A..21scopeptr.:#3D.oldscop
eptr#0A..21RETURN#0A..18}#0A#0A..4CASE.s_match:#0A.
.4CASE.s_every:#0A..9{..LET.s,.argpos,.elab.#3D.ssp
,.ssp,.exitlab#0A..12LET.len,.mplen.#3D.listlen(h2!
x),.maxpatlen(h3!x)#0A..12IF.len>mplen.DO#0A..15trn
err("Too.many.MATCH.or.EVERY.arguments")#0A..12exit
lab.:#3D.h1!x#3Ds_match.->.nextlab(),.0#0A..12comli
ne.:#3D.h4!x#0A..12outline()#0A..12out2(s_locs,.mpl
en)#0A..12ssp.:#3D.ssp.+.mplen#0A..12loadargs(h2!x)
#0A..12out3(s_setargs,.len,.argpos)#0A..12ssp.:#3D.
ssp-len#0A..12trmatch(h3!x,.argpos,.mplen)#0A..12IF
.h1!x#3Ds_match.DO.{..out2(s_ln,.0)#0A..34out2(s_ra
ise,.1)#0A..34out2(s_lab,.exitlab)#0A..31}#0A..12ex
itlab.:#3D.elab#0A..12UNLESS.ssp#3Ds.DO.{..ssp.:#3D
.s;.out2(s_stack,.ssp).}#0A..12RETURN#0A..9}#0A#0A.
.4CASE.s_call:#0A..4{..LET.s.#3D.ssp#0A..7LET.fe.#3D
.h2!x#0A..7LET.argno.#3D.listlen(h3!x)#0A..7comline
.:#3D.h4!x#0A..7outline()#0A..7out2(s_stack,.ssp+3)
#0A..7ssp.:#3D.ssp+3#0A..7loadargs(h3!x)#0A..7load(
fe)#0A..7IF.h1!fe#3Ds_vid.&#0A..10findid(fe,.loclis
t)#3D0.&#0A..10findid(fe,.statlist)#3D0.&#0A..10fin
did(fe,.funlist)#3D0.DO#0A..7{..LET.t.#3D.findid(fe
,.extlist)#0A..10UNLESS.t#3D0.|.h3!t#3D0.DO#0A..10{
..out2(s_callc,.s)#0A..13outstring(h3!t+2)#0A..13ss
p.:#3D.s#0A..13RETURN#0A..10}#0A..7}#0A..7out2(s_ca
ll,.s)#0A..7ssp.:#3D.s#0A..7RETURN#0A..4}#0A#0A..4C
ASE.s_let:#0A..4{..LET.p.#3D.h2!x#0A..7comline.:#3D
.h3!x#0A..7outline()#0A..7UNTIL.p#3D0.DO#0A..7{..UN
LESS.h3!p#3D0.DO.assign(h2!p,.h3!p)#0A..10p.:#3D.h4
!p#0A..7}#0A..7RETURN#0A..4}#0A#0A..4CASE.s_ass:#0A
..7comline.:#3D.h4!x#0A..7outline()#0A..7assign(h2!
x,.h3!x)#0A..7RETURN#0A#0A..4CASE.s_allass:#0A..7co
mline.:#3D.h4!x#0A..7outline()#0A..7assignall(1,.h2
!x,.h3!x)#0A..7RETURN#0A#0A..4CASE.s_lshass:#0A..4C
ASE.s_rshass:#0A..4CASE.s_multass:#0A..4CASE.s_diva
ss:#0A..4CASE.s_modass:#0A..4CASE.s_andass:#0A..4CA
SE.s_xorass:#0A..4CASE.s_plusass:#0A..4CASE.s_subas
s:#0A..4CASE.s_orass:#0A..7comline.:#3D.h4!x#0A..7o
utline()#0A..7assignop(h1!x+s_lsh-s_lshass,.h2!x,.h
3!x)#0A..7RETURN#0A#0A..4CASE.s_goto:#0A..4{..LET.q
,.len.#3D.ssp,.listlen(h2!x)#0A..7comline.:#3D.h3!x
#0A..7outline()#0A..7IF.len>matchlen.DO.trnerr("Too
.many.GOTO.arguments")#0A..7loadargs(h2!x)#0A..7out
3(s_setargs,.len,.matchpos)#0A..7ssp.:#3D.q#0A..7FO
R.i.#3D.1.TO.hdepth-matchhdepth.DO.out1(s_unhandle)
#0A..7out2(s_jump,.matchlab)#0A..7RETURN#0A..4}#0A#0A
..4CASE.s_raise:#0A..4{..LET.q,.count.#3D.ssp,.?#0A
..7comline.:#3D.h3!x#0A..7outline()#0A..7loadargs(h
2!x)#0A..7count.:#3D.ssp-q#0A..7UNLESS.1<#3Dcount<#3D
3.DO.trnerr("RAISE.must.have.from.1.to.3.arguments"
)#0A..7out2(s_raise,.count)#0A..7ssp.:#3D.q#0A..7RE
TURN#0A..4}#0A#0A..4CASE.s_handle:..//.x.->.[Handle
,.C,.Fndef,.ln]#0A..4{..LET.lab,.elab.#3D.nextlab()
,.exitlab#0A..7exitlab.:#3D.nextlab()#0A..7comline.
:#3D.h4!x#0A..7outline()#0A..7out2(s_handle,.lab)#0A
..7ssp.:#3D.ssp+3#0A..7hdepth.:#3D.hdepth+1#0A..7tr
ans(h2!x)#0A..7out1(s_unhandle)#0A..7hdepth.:#3D.hd
epth-1#0A..7out2(s_jump,.exitlab)#0A#0A..7IF.maxpat
len(h3!x).>.3.DO.trnerr("Handler.pattern.too.long")
#0A..7out2(s_lab,.lab)#0A..7trmatch(h3!x,.ssp-3,.3)
#0A#0A..7out2(s_lp,.ssp-3)#0A..7out2(s_lp,.ssp-2)#0A
..7out2(s_lp,.ssp-1)#0A..7out2(s_raise,.3)#0A..7out
2(s_lab,.exitlab)#0A..7ssp.:#3D.ssp-3#0A..7out2(s_s
tack,.ssp)#0A..7exitlab.:#3D.elab#0A..7RETURN#0A..4
}#0A#0A..4CASE.s_unless:.sw.:#3D.TRUE#0A..4CASE.s_i
f:#0A..4{..LET.lab.#3D.nextlab()#0A..7comline.:#3D.
h4!x#0A..7outline()#0A..7jumpcond(h2!x,.sw,.lab)#0A
..7trans(h3!x)#0A..7out2(s_lab,.lab)#0A..7RETURN#0A
..4}#0A#0A..4CASE.s_test:#0A..4{..LET.l,.m.#3D.next
lab(),.nextlab()#0A..7comline.:#3D.h5!x#0A..7outlin
e()#0A..7jumpcond(h2!x,.FALSE,.l)#0A..7trans(h3!x)#0A
..7out2(s_jump,.m)#0A..7out2(s_lab,.l)#0A..7trans(h
4!x)#0A..7out2(s_lab,.m)#0A..7RETURN#0A..4}#0A#0A..
4CASE.s_loop:#0A..7comline.:#3D.h2!x#0A..7outline()
#0A..7IF.looplab<0.DO.trnerr("Illegal.use.of.LOOP")
#0A..7IF.looplab#3D0.DO.looplab.:#3D.nextlab()#0A..
7FOR.i.#3D.1.TO.rephdepth-hdepth.DO.out1(s_unhandle
)#0A..7out2(s_jump,.looplab)#0A..7RETURN#0A#0A..4CA
SE.s_break:#0A..7comline.:#3D.h2!x#0A..7outline()#0A
..7IF.breaklab#3D-2.DO.trnerr("Illegal.use.of.BREAK
")#0A..7IF.breaklab#3D.0.DO.breaklab.:#3D.nextlab()
#0A..7FOR.i.#3D.1.TO.rephdepth-hdepth.DO.out1(s_unh
andle)#0A..7out2(s_jump,.breaklab)#0A..7RETURN#0A#0A
..4CASE.s_exit:..1//1??3#0A..7comline.:#3D.h3!x#0A.
.7outline()#0A..7IF.exitlab#3D-2.DO.trnerr("Illegal
.use.of.EXIT")#0A..7trans(h2!x)#0A..7IF.exitlab#3D0
.DO.exitlab.:#3D.nextlab()#0A..7FOR.i.#3D.1.TO.matc
hhdepth-hdepth.DO.out1(s_unhandle)#0A..7out2(s_jump
,.exitlab)#0A..7RETURN#0A#0A..4CASE.s_return:#0A..7
trans(h2!x)#0A..7FOR.i.#3D.1.TO.hdepth.DO.out1(s_un
handle)#0A..7out1(s_return)#0A..7RETURN#0A#0A..4CAS
E.s_result:#0A..7comline.:#3D.h3!x#0A..7outline()#0A
..7UNLESS.resultlab>0.DO.trnerr("RESULT.out.of.cont
ext")#0A..7trans(h2!x)#0A..7FOR.i.#3D.1.TO.valofhde
pth-hdepth.DO.out1(s_unhandle)#0A..7out2(s_jump,.re
sultlab)#0A..7RETURN#0A#0A..4CASE.s_while:.sw.:#3D.
TRUE#0A..4CASE.s_until:#0A..4{..LET.lab.#3D.nextlab
()#0A..7LET.bl,.ll.#3D.breaklab,.looplab#0A..7LET.o
ldrephdepth.#3D.rephdepth#0A..7rephdepth.:#3D.hdept
h#0A..7comline.:#3D.h4!x#0A..7outline()#0A..7breakl
ab,.looplab.:#3D.nextlab(),.0#0A..7TEST.expsize(h2!
x)<10#0A..7THEN.jumpcond(h2!x,.~sw,.breaklab)#0A..7
ELSE.{..looplab.:#3D.nextlab();.out2(s_jump,.loopla
b).}#0A..7out2(s_lab,.lab)#0A..7trans(h3!x)#0A..7UN
LESS.looplab#3D0.DO.out2(s_lab,.looplab)#0A..7comli
ne.:#3D.h4!x#0A..7jumpcond(h2!x,.sw,.lab)#0A..7out2
(s_lab,.breaklab)#0A..7rephdepth.:#3D.oldrephdepth#0A
..7breaklab,.looplab.:#3D.bl,.ll#0A..7RETURN#0A..4}
#0A#0A..4CASE.s_repeatwhile:.sw.:#3D.TRUE#0A..4CASE
.s_repeatuntil:#0A..4{..LET.lab,.bl,.ll.#3D.nextlab
(),.breaklab,.looplab#0A..7LET.oldrephdepth.#3D.rep
hdepth#0A..7rephdepth.:#3D.hdepth#0A..7comline.:#3D
.h4!x#0A..7breaklab,.looplab.:#3D.0,.0#0A..7out2(s_
lab,.lab)#0A..7trans(h2!x)#0A..7UNLESS.looplab#3D0.
DO.out2(s_lab,.looplab)#0A..7comline.:#3D.h4!x#0A..
7outline()#0A..7jumpcond(h3!x,.sw,.lab)#0A..7UNLESS
.breaklab#3D0.DO.out2(s_lab,.breaklab)#0A..7rephdep
th.:#3D.oldrephdepth#0A..7breaklab,.looplab.:#3D.bl
,.ll#0A..7RETURN#0A..4}#0A#0A..4CASE.s_repeat:#0A..
4{..LET.bl,.ll.#3D.breaklab,.looplab#0A..7LET.oldre
phdepth.#3D.rephdepth#0A..7rephdepth.:#3D.hdepth#0A
..7comline.:#3D.h3!x#0A..7outline()#0A..7breaklab,.
looplab.:#3D.0,.nextlab()#0A..7out2(s_lab,.looplab)
#0A..7trans(h2!x)#0A..7out2(s_jump,.looplab)#0A..7I
F.breaklab>0.DO.out2(s_lab,.breaklab)#0A..7rephdept
h.:#3D.oldrephdepth#0A..7breaklab,.looplab.:#3D.bl,
.ll#0A..7RETURN#0A..4}#0A#0A..4CASE.s_for:#0A..7tra
nsfor(x)#0A..7RETURN#0A#0A..4CASE.s_seq:#0A..7trans
(h2!x)#0A..7x.:#3D.h3!x#0A..1}#0A}.REPEAT#0A#0AAND.
checkdistinct(id).BE#0A{..LET.p.#3D.loclist#0A..1UN
TIL.p#3D0.|.p#3Dscopeptr.DO#0A..1{..IF.id#3Dh2!p.DO
.trnerr("Name.%s.already.declared",.@h3!id)#0A..4p.
:#3D.h1!p#0A..1}#0A}#0A#0ALET.jumpcond(x,.b,.l).BE#0A
{..LET.sw.#3D.b#0A#0A..1SWITCHON.h1!x.INTO#0A..1{..
CASE.s_false:.b.:#3D.NOT.b#0A..4CASE.s_true:..IF.b.
DO.out2(s_jump,.l)#0A..18RETURN#0A#0A..4CASE.s_not:
..1jumpcond(h2!x,.NOT.b,.l)#0A..18RETURN#0A#0A..4CA
SE.s_and:..1sw.:#3D.NOT.sw#0A..4CASE.s_or:..2TEST.s
w.THEN.{..jumpcond(h2!x,.b,.l)#0A..34jumpcond(h3!x,
.b,.l)#0A..31}#0A..26ELSE.{..LET.m.#3D.nextlab()#0A
..34jumpcond(h2!x,.NOT.b,.m)#0A..34jumpcond(h3!x,.b
,.l)#0A..34out2(s_lab,.m)#0A..31}#0A..18RETURN#0A#0A
..4CASE.s_rel:.TEST.b#0A..16THEN.{..LET.lab.#3D.0#0A
..24load(h2!x)#0A..24{..x.:#3D.h3!x#0A..27load(h2!x
)#0A..27IF.h3!x#3D0.BREAK#0A..27IF.lab#3D0.DO.lab.:
#3D.nextlab()#0A..27out1(s_cpr)#0A..27out3(h1!x,.s_
jf,.lab)#0A..27ssp.:#3D.ssp-2#0A..27out1(s_lr)#0A..
27ssp.:#3D.ssp+1#0A..24}.REPEAT#0A..24out3(h1!x,.s_
jt,.l)#0A..24ssp.:#3D.ssp-2#0A..24UNLESS.lab#3D0.DO
.out2(s_lab,.lab)#0A..24RETURN#0A..21}#0A..16ELSE..
2load(h2!x)#0A..24x.:#3D.h3!x#0A..24{..LET.rel.#3D.
h1!x#0A..27load(h2!x)#0A..27x.:#3D.h3!x#0A..27UNLES
S.x#3D0.DO.out1(s_cpr)#0A..27out3(rel,.s_jf,.l)#0A.
.27ssp.:#3D.ssp-2#0A..27IF.x#3D0.RETURN#0A..27out1(
s_lr)#0A..27ssp.:#3D.ssp+1#0A..24}.REPEAT#0A#0A..6D
EFAULT:#0A..18load(x)#0A..18out2((b.->.s_jt,.s_jf),
.l)#0A..18ssp.:#3D.ssp-1#0A..18RETURN#0A..1}#0A}#0A
#0AAND.transfor(x).BE#0A{..LET.oldscopeptr,.oldlocs
,.oldssp.#3D.scopeptr,.loclist,.ssp#0A..1LET.lab.#3D
.nextlab()#0A..1LET.bl,.ll.#3D.breaklab,.looplab#0A
..1LET.k,.n,.step.#3D.0,.0,.1#0A..1LET.qctrl.#3D.0#0A
..1LET.oldrephdepth.#3D.rephdepth#0A..1rephdepth.:#3D
.hdepth#0A#0A..1breaklab,.looplab.:#3D.nextlab(),.0
#0A#0A..1comline.:#3D.h7!x#0A..1outline()#0A#0A..1/
/.allocate.space.for.dynamic.quantities.in.the.init
ial.value#0A..1//.and.end.limit.expressions#0A..1sc
opeptr.:#3D.loclist#0A..1decldyn(h3!x)#0A..1decldyn
(h4!x)#0A#0A..1out2(s_locs,.1)..//.allocate.space.f
or.the.control.variable#0A..1qctrl.:#3D.ssp#0A..1ss
p.:#3D.ssp+1#0A..1loclist.:#3D.newblk(loclist,.h2!x
,.0,.qctrl)#0A#0A..1TEST.h1!(h4!x)#3Ds_numb#0A..1TH
EN..2k,.n.:#3D.s_ln,.h2!(h4!x)#0A..1ELSE.{..k,.n.:#3D
.s_lp,.ssp#0A..9out2(s_locs,.1)..//.allocate.space.
for.end.limit#0A..9ssp.:#3D.ssp+1#0A..6}#0A#0A..1lo
ad(h3!x)#0A..1out2(s_sp,.qctrl)..2//.initialise.con
trol.variable#0A..1ssp.:#3D.ssp-1#0A#0A..1IF.k#3Ds_
lp.DO.{..load(h4!x)#0A..17out2(s_sp,.n).//.set.end.
limit#0A..17ssp.:#3D.ssp-1#0A..14}#0A#0A..1UNLESS.h
5!x#3D0.DO.step.:#3D.evalconst(h5!x)#0A#0A..1TEST.k
#3Ds_ln.&.h1!(h3!x)#3Ds_numb..//.check.for.constant
.limits#0A..1THEN.{..LET.initval.#3D.h2!(h3!x)#0A..
9IF.step>#3D0.&.initval>n.|.step<0.&.initval<n.DO#0A
..40out2(s_jump,.breaklab)#0A..6}#0A..1ELSE.{..out2
(s_lp,.qctrl)#0A..9out2(k,.n)#0A..9out1(step>#3D0.-
>.s_gr,.s_ls)#0A..9out2(s_jt,.breaklab)#0A..6}#0A#0A
..1comline.:#3D.h7!x#0A#0A..1scopeptr.:#3D.loclist.
//.new.dynamic.scope.for.the.body#0A..1decldyn(h6!x
)#0A#0A..1out2(s_lab,.lab)#0A..1trans(h6!x)#0A..1UN
LESS.looplab#3D0.DO.out2(s_lab,.looplab)#0A..1out2(
s_lp,.qctrl);.out2(s_ln,.step);.out1(s_plus);.out2(
s_sp,.qctrl)#0A..1out2(s_lp,.qctrl);.out2(k,n)#0A..
1out1(step>#3D0.->.s_le,.s_ge)#0A..1out2(s_jt,.lab)
#0A..1out2(s_lab,.breaklab)#0A#0A..1retblks(loclist
,.oldlocs)#0A..1loclist.:#3D.oldlocs.//.leave.both.
dynamic.scopes#0A..1scopeptr.:#3D.oldscopeptr#0A..1
rephdepth.:#3D.oldrephdepth#0A..1breaklab,.looplab.
:#3D.bl,.ll#0A..1ssp.:#3D.oldssp#0A..1out2(s_stack,
.ssp)#0A}#0A#0A1LET.load(x).BE#0A{..LET.op.#3D.?#0A
#0A..1IF.x#3D0.DO.{..out1(s_query);.ssp.:#3D.ssp+1;
.RETURN.}#0A#0A..1op.:#3D.h1!x#0A#0A..1IF.isconst(x
).DO#0A..1{..out2(s_ln,.evalconst(x))#0A..4ssp.:#3D
.ssp.+.1#0A..4RETURN#0A..1}#0A#0A..1SWITCHON.op.INT
O#0A..1{..DEFAULT:#0A..4CASE.s_call:..3trans(x)#0A.
.21out1(s_lr)#0A..21ssp.:#3D.ssp+1#0A..21RETURN#0A#0A
1..4CASE.s_seq:..4trans(h2!x)#0A..21load(h3!x)#0A..
21RETURN#0A#0A..4CASE.s_true:.CASE.s_false:.CASE.s_
query:#0A..21out1(op)#0A..21ssp.:#3D.ssp+1#0A..21RE
TURN#0A#0A..4CASE.s_vid:..4transvid(x,.lpath,.s_lg,
.s_ll,.s_lf,.s_lx)#0A..21ssp.:#3D.ssp+1#0A..21RETUR
N#0A#0A..4CASE.s_cid:..{..LET.c.#3D.findid(x,.manli
st)#0A..20IF.c#3D0.DO.trnerr("Constant.%s.not.decla
red",.@h3!x)#0A..20//.c.->.[link,.cid,.k]#0A..20out
2(s_ln,.h3!c)#0A..20ssp.:#3D.ssp+1#0A..20RETURN#0A.
.17}#0A#0A..4CASE.s_tablab:..1//.x.->.[tablab,.lab]
#0A..21out2(s_ll1,.h2!x)#0A..21ssp.:#3D.ssp+1#0A..2
1RETURN#0A#0A..4CASE.s_numb:..3//.x.->.[numb,.k]#0A
..21out2(s_ln,.h2!x);.ssp.:#3D.ssp+1;.RETURN#0A#0A.
.4CASE.s_ltable:..1//.x.->.[ltable,.Elist,.q]#0A..2
1initltab(h2!x,.h3!x)#0A#0A..4CASE.s_vec:..4//.x.->
.[vec,..5K,.q]#0A..4CASE.s_cvec:..3//.x.->.[cvec,..
4K,.q]#0A..21out2(s_llp,.h3!x)#0A..21ssp.:#3D.ssp+1
#0A..21RETURN#0A#0A..4CASE.s_inc1a:#0A..4CASE.s_inc
4a:#0A..4CASE.s_dec1a:#0A..4CASE.s_dec4a:#0A..4CASE
.s_inc1b:#0A..4CASE.s_inc4b:#0A..4CASE.s_dec1b:#0A.
.4CASE.s_dec4b:#0A..21loadlv(h2!x)#0A..21out1(op)#0A
..21RETURN#0A#0A..4CASE.s_lv:..5loadlv(h2!x);.RETUR
N#0A#0A..4CASE.s_indb:#0A..4CASE.s_indw:#0A..4CASE.
s_div:.CASE.s_mod:.CASE.s_sub:#0A..4CASE.s_lsh:.CAS
E.s_rsh:#0A..21load(h2!x);.load(h3!x)#0A..21out1(op
)#0A..21ssp.:#3D.ssp-1#0A..21RETURN#0A#0A..4CASE.s_
mult:.CASE.s_plus:#0A..4CASE.s_bitand:.CASE.s_bitor
:.CASE.s_xor:#0A..7{..LET.a,.b.#3D.h2!x,.h3!x#0A..1
0TEST.expsize(a)<expsize(b).THEN.{..load(b);.load(a
).}#0A..37ELSE.{..load(a);.load(b).}#0A..10out1(op)
#0A..10ssp.:#3D.ssp-1#0A..10RETURN#0A..7}#0A#0A..4C
ASE.s_neg:.CASE.s_not:.CASE.s_bitnot:.CASE.s_abs:#0A
..4CASE.s_indb0:.CASE.s_indw0:#0A..10load(h2!x)#0A.
.10out1(op)#0A..10RETURN#0A#0A..4CASE.s_rel:#0A..10
{..LET.lab1,.lab2.#3D.0,.0#0A..13load(h2!x)#0A..13x
.:#3D.h3!x#0A..13{..LET.rel.#3D.h1!x#0A..16load(h2!
x)#0A..16x.:#3D.h3!x#0A..16IF.x#3D0.DO.{..out1(rel)
#0A..29ssp.:#3D.ssp-1#0A..29BREAK#0A..26}#0A..16out
1(s_str)#0A..16IF.lab1#3D0.DO.lab1,.lab2.:#3D.nextl
ab(),.nextlab()#0A..16out3(rel,.s_jf,.lab1)#0A..16s
sp.:#3D.ssp-2#0A..16out1(s_lr)#0A..16ssp.:#3D.ssp+1
#0A..13}.REPEAT#0A..13UNLESS.lab1#3D0.DO.{..out1(s_
true)#0A..33ssp.:#3D.ssp+1#0A..33out2(s_jump,.lab2)
#0A..33ssp.:#3D.ssp-1#0A..33out2(s_stack,.ssp)#0A..
33out2(s_lab,.lab1)#0A..33out1(s_false)#0A..33ssp.:
#3D.ssp+1#0A..33out2(s_lab,.lab2)#0A..30}#0A..13RET
URN#0A..10}#0A..1}#0A}#0A#0A1AND.initltab(x,.q).BE.
UNTIL.x#3D0.SWITCHON.h1!x.INTO#0A{..DEFAULT:..4load
(x)#0A..15out2(s_sp,.q)#0A..15ssp.:#3D.ssp-1#0A..15
RETURN#0A#0A..1CASE.s_comma:.initltab(h2!x,.q)#0A..
15x,.q.:#3D.h3!x,.q+1#0A..15LOOP#0A}#0A#0AAND.loadl
v(x).BE#0A{..UNLESS.x#3D0.SWITCHON.h1!x.INTO#0A..1{
..DEFAULT:..7ENDCASE#0A#0A..4CASE.s_vid:..4transvid
(x,.llpath,.s_llg,.s_ll1,.0,.0)#0A..21ssp.:#3D.ssp+
1#0A..21RETURN#0A#0A..4CASE.s_indb0:#0A..4CASE.s_in
dw0:..2load(h2!x)#0A..21RETURN#0A#0A..4CASE.s_indb:
..3load(h2!x)#0A..21load(h3!x)#0A..21out1(s_plus)#0A
..21ssp.:#3D.ssp-1#0A..21RETURN#0A#0A..4CASE.s_indw
:..3load(h2!x)#0A..21load(h3!x)#0A..21out1(s_lvindw
)#0A..21ssp.:#3D.ssp-1#0A..21RETURN#0A..1}#0A#0A..1
trnerr("Ltype.expression.needed")#0A..1out2(s_ln,.0
)#0A..1ssp.:#3D.ssp+1#0A}#0A#0A//.Arguments.are.loa
ded.in.increasing.stack.locations#0A//.loadargs.is.
used.in.calls,.MATCH,.EVERY,.GOTO.and.RAISE#0AAND.l
oadargs(x).BE.UNLESS.x#3D0.TEST.h1!x#3Ds_comma#0A..
28THEN.{..load(h2!x)#0A..36loadargs(h3!x)#0A..33}#0A
..28ELSE.load(x)#0A#0A1LET.evalconstrel(a,.x).#3D.V
ALOF#0A{..LET.b.#3D.evalconst(h2!x)#0A..1SWITCHON.h
1!x.INTO#0A..1{..DEFAULT:.trnerr("Bad.rel.%n",.h1!x
)#0A#0A..4CASE.s_eq:.UNLESS.a#3Db.RESULTIS.FALSE#0A
..15ENDCASE#0A..4CASE.s_ne:.UNLESS.a~#3Db.RESULTIS.
FALSE#0A..15ENDCASE#0A..4CASE.s_le:.UNLESS.a<#3Db.R
ESULTIS.FALSE#0A..15ENDCASE#0A..4CASE.s_ge:.UNLESS.
a>#3Db.RESULTIS.FALSE#0A..15ENDCASE#0A..4CASE.s_ls:
.UNLESS.a<b.RESULTIS.FALSE#0A..15ENDCASE#0A..4CASE.
s_gr:.UNLESS.a>b.RESULTIS.FALSE#0A..15ENDCASE#0A..1
}#0A..1a,.x.:#3D.b,.h3!x#0A..1IF.x#3D0.RESULTIS.TRU
E#0A}.REPEAT#0A#0A1LET.isconst(x).#3D.VALOF#0A{..IF
.x#3D0.RESULTIS.FALSE#0A#0A..1SWITCHON.h1!x.INTO#0A
..1{..CASE.s_cid:#0A..4CASE.s_numb:#0A..4CASE.s_tru
e:#0A..4CASE.s_false:#0A..4CASE.s_query:..RESULTIS.
TRUE#0A#0A..4CASE.s_cond:#0A..8RESULTIS.isconst(h2!
x).&.isconst(h3!x).&.isconst(h4!x)#0A#0A1..4CASE.s_
neg:#0A..4CASE.s_abs:#0A..4CASE.s_not:#0A..4CASE.s_
bitnot:.RESULTIS.isconst(h2!x)#0A#0A..4CASE.s_rel:#0A
..4CASE.s_lsh:#0A..4CASE.s_rsh:#0A..4CASE.s_mult:#0A
..4CASE.s_div:#0A..4CASE.s_mod:#0A..4CASE.s_bitand:
#0A..4CASE.s_xor:#0A..4CASE.s_plus:#0A..4CASE.s_sub
:#0A..4CASE.s_bitor:#0A..4CASE.s_and:#0A..4CASE.s_o
r:..3IF.isconst(h2!x).&.isconst(h3!x)#0A..22RESULTI
S.TRUE#0A#0A..4DEFAULT:..5RESULTIS.FALSE#0A..1}#0A}
#0A#0ALET.evalconst(x).#3D.VALOF#0A{..LET.a,.b.#3D.
0,.0#0A#0A..1IF.x#3D0.DO.{..trnerr("Compiler.error.
in.Evalconst")#0A..14RESULTIS.0#0A..11}#0A#0A..1SWI
TCHON.h1!x.INTO#0A..1{..CASE.s_cid:#0A..6{..LET.c.#3D
.findid(x,.manlist)#0A..9UNLESS.c#3D0.RESULTIS.h3!c
#0A..9trnerr("Constant.%s.not.declared",.@h3!x)#0A.
.9RESULTIS.0#0A..6}#0A#0A..4CASE.s_numb:..1RESULTIS
.h2!x#0A..4CASE.s_true:..1RESULTIS.TRUE#0A..4CASE.s
_false:..RESULTIS.FALSE#0A..4CASE.s_query:..RESULTI
S.0#0A#0A..4CASE.s_cond:#0A..8RESULTIS.evalconst(h2
!x).->.evalconst(h3!x),.evalconst(h4!x)#0A#0A..4CAS
E.s_rel:..1RESULTIS.evalconstrel(evalconst(h2!x),.h
3!x)#0A#0A..4CASE.s_neg:#0A..4CASE.s_abs:#0A..4CASE
.s_not:#0A..4CASE.s_bitnot:.a.:#3D.evalconst(h2!x)#0A
..19ENDCASE#0A#0A..4CASE.s_lsh:#0A..4CASE.s_rsh:#0A
..4CASE.s_mult:#0A..4CASE.s_div:#0A..4CASE.s_mod:#0A
..4CASE.s_bitand:#0A..4CASE.s_xor:#0A..4CASE.s_plus
:#0A..4CASE.s_sub:#0A..4CASE.s_bitor:#0A..4CASE.s_a
nd:#0A..4CASE.s_or:..3a,.b.:#3D.evalconst(h2!x),.ev
alconst(h3!x)#0A..19ENDCASE#0A#0A..4DEFAULT:#0A..1}
#0A#0A..1SWITCHON.h1!x.INTO#0A..1{..CASE.s_neg:..2R
ESULTIS..-..a#0A..4CASE.s_abs:..2RESULTIS.ABS.a#0A.
.4CASE.s_bitnot:#0A..4CASE.s_not:..2RESULTIS.NOT.a#0A
#0A..4CASE.s_lsh:..2RESULTIS.a..1<<..1b#0A..4CASE.s
_rsh:..2RESULTIS.a..1>>..1b#0A..4CASE.s_mult:..1RES
ULTIS.a..1*..2b#0A..4CASE.s_and:#0A..4CASE.s_bitand
:.RESULTIS.a..1&..2b#0A..4CASE.s_xor:..2RESULTIS.a.
.NEQV..b#0A..4CASE.s_plus:..1RESULTIS.a..1+..2b#0A.
.4CASE.s_sub:..2RESULTIS.a..1-..2b#0A..4CASE.s_or:#0A
..4CASE.s_bitor:..RESULTIS.a..1|..2b#0A#0A..4CASE.s
_div:..2UNLESS.b#3D0.RESULTIS.a..1/..2b#0A..4CASE.s
_mod:..2UNLESS.b#3D0.RESULTIS.a..REM..1b#0A#0A..4DE
FAULT:#0A..1}#0A#0A..1trnerr("Error.in.manifest.exp
ression")#0A..1RESULTIS.0#0A}#0A#0A1AND.assign(x,.y
).BE#0A{..IF.x#3D0.|.y#3D0.DO.{..trnerr("Compiler.e
rror.in.assign")#0A..20RETURN#0A..17}#0A#0A..1UNLES
S.(h1!x#3Ds_comma)#3D(h1!y#3Ds_comma).DO#0A..1{..tr
nerr("LHS.and.RHS.of.different.lengths")#0A..4RETUR
N#0A..1}#0A#0A..1IF.h1!x#3Ds_comma.DO#0A..1{..prepl
hs(h2!x)#0A..4load(h2!y)#0A..4assign(h3!x,.h3!y)#0A
..4doass(h2!x)#0A..4RETURN#0A..1}#0A#0A..1preplhs(x
)#0A..1load(y)#0A..1doass(x)#0A}#0A#0AAND.preplhs(x
).BE.SWITCHON.h1!x.INTO#0A{..DEFAULT:..5trnerr("Bad
.LHS")#0A#0A..1CASE.s_vid:..2RETURN#0A#0A..1CASE.s_
indb0:#0A..1CASE.s_indb:#0A..1CASE.s_indw0:#0A..1CA
SE.s_indw:..1loadlv(x)#0A..16RETURN#0A}#0A#0A//.In.
the..following.function.assop.is..s_stw.or.s_stb#0A
//.if.the.LHS.has.leading.operator.!.or.%,.otherwis
e.it#0A//.is.s_vid.indicating.that.the.LHS.is.a.var
iable#2E#0A#0AAND.doass(x).BE.SWITCHON.h1!x.INTO#0A
{..DEFAULT:..5trnerr("Bad.LHS")#0A..16RETURN#0A#0A.
.1CASE.s_vid:..2transvid(x,.spath,.s_sg,.s_sl,.0,.0
)#0A..16ssp.:#3D.ssp-1#0A..16RETURN#0A#0A..1CASE.s_
indb0:#0A..1CASE.s_indb:..1out1(s_stb)#0A..16ssp.:#3D
.ssp-2#0A..16RETURN#0A#0A..1CASE.s_indw0:#0A..1CASE
.s_indw:..1out1(s_stw)#0A..16ssp.:#3D.ssp-2#0A..16R
ETURN#0A}#0A#0A//.In.the.follow.procedure.t.is.the.
number.of.the.temporary.variable#0A//.holding.the.v
alue.of.the.RHS#0AAND.assignall(i,.x,.rhs).BE#0A{..
IF.x#3D0.DO.{..trnerr("Compiler.error.in.assignall"
)#0A..14RETURN#0A..11}#0A#0A..1IF.h1!x#3Ds_comma.DO
#0A..1{..preplhs(h2!x)#0A..4assignall(i+1,.h3!x,.rh
s)#0A..4out1(s_lr)#0A..4ssp.:#3D.ssp+1#0A..4doass(h
2!x)#0A..4RETURN#0A..1}#0A..1preplhs(x)#0A..1load(r
hs)#0A..1IF.i>1.DO.{.out1(s_str);.out1(s_lr).}#0A..
1doass(x)#0A#0A}#0A#0A//.In.the.following.function.
op.is.one.of.the..expression#0A//.operators.allowed
.in.assignments,.i#2Ee#2E.s_lsh,.s_rsh,.etc#2E#0A#0A
AND.assignop(op,.x,.y).BE#0A{..IF.x#3D0.|.y#3D0.DO.
{..trnerr("Compiler.error.in.assignop")#0A..20RETUR
N#0A..17}#0A#0A..1UNLESS.(h1!x#3Ds_comma)#3D(h1!y#3D
s_comma).DO#0A..1{..trnerr("LHS.and.RHS.of.differen
t.lengths")#0A..4RETURN#0A..1}#0A#0A..1IF.h1!x#3Ds_
comma.DO#0A..1{..preplhsop(op,.h2!x,.h2!y)#0A..4ass
ignop(op,.h3!x,.h3!y)#0A..4doass(h2!x)#0A..4RETURN#0A
..1}#0A..1preplhsop(op,.x,.y)#0A..1doass(x)#0A}#0A#0A
AND.preplhsop(op,.x,.y).BE#0A{..SWITCHON.h1!x.INTO#0A
..1{..CASE.s_vid:..2transvid(x,.lpath,.s_lg,.s_ll,.
0,.0)#0A..19ssp.:#3D.ssp+1#0A..19ENDCASE#0A#0A..4CA
SE.s_indb0:#0A..4CASE.s_indb:..1loadlv(x)#0A..19out
1(s_dup)#0A..19ssp.:#3D.ssp+1#0A..19out1(s_indb0)#0A
..19ENDCASE#0A#0A..4CASE.s_indw0:#0A..4CASE.s_indw:
..1loadlv(x)#0A..19out1(s_dup)#0A..19ssp.:#3D.ssp+1
#0A..19out1(s_indw0)#0A..19ENDCASE#0A#0A..4DEFAULT:
..5trnerr("Compiler.error.in.preplhsop.%n",.h1!x)#0A
..1}#0A#0A..1load(y)#0A..1out1(op)#0A..1ssp.:#3D.ss
p-1#0A}#0A#0A//.transvid.may.load.or.store.so.the.c
aller.must.update.ssp#2E#0AAND.transvid(id,.locproc
,.g,.s,.f,.x).BE#0A{..LET.name.#3D.@h3!id#0A..1LET.
c.#3D.findid(id,.loclist)#0A#0A..1UNLESS.c#3D0.DO.{
..//.c.->.[link,.vid,.n,.i]#0A..18locproc(h3!c,.h4!
c)#0A..18RETURN#0A..15}#0A#0A..1c.:#3D.findid(id,.s
tatlist)#0A..1UNLESS.c#3D0.DO.{..//.c.->.[link,.vid
,.lab,.-]#0A..18out2(s,.h3!c)#0A..18RETURN#0A..15}#0A
#0A..1c.:#3D.findid(id,.globlist)#0A..1UNLESS.c#3D0
.DO.{..//.c.->.[link,.vid,.lab,.-]#0A..18out2(g,.h3
!c)#0A..18RETURN#0A..15}#0A#0A..1c.:#3D.findid(id,.
funlist)#0A..1UNLESS.c#3D0.DO#0A..1{..//.c.->.[link
,.vid,.type,.lab]#0A..4IF.f#3D0.DO#0A..4{..trnerr("
Misuse.of.FUN.name.%s",.name)#0A..7RETURN#0A..4}#0A
..4out2(f,.h4!c)#0A..4RETURN#0A..1}#0A#0A..1c.:#3D.
findid(id,.extlist)#0A..1UNLESS.c#3D0.DO#0A..1{..//
.c.->.[link,.vid,.type]#0A..4IF.x#3D0.DO#0A..4{..tr
nerr("Misuse.of.EXTERNAL.name.%s",.name)#0A..7RETUR
N#0A..4}#0A..4out1(s_lx)#0A..4outstring(name)#0A..4
RETURN#0A..1}#0A#0A..1trnerr("Name.%s.not.declared"
,.name)#0A}#0A#0AAND.outglobinits().BE#0A{..LET.p,.
n.#3D.globlist,.0#0A..1//.p.->.0#0A..1//..1->.[next
,.vid,.gn,..0010]..for.a.global.variable#0A..1//..1
->.[next,.vid,.gn,.lab]..for.a.global.function#0A..
1UNTIL.p#3D0.DO.{..UNLESS.h4!p#3D0.DO.n.:#3D.n+1#0A
..17p.:#3D.h1!p#0A..14}#0A..1p.:#3D.globlist#0A..1o
ut2(s_global,.n)#0A..1UNTIL.p#3D0.DO.{..UNLESS.h4!p
#3D0.DO.out2(h3!p,.h4!p)#0A..17p.:#3D.h1!p#0A..14}#0A
}#0A#0AAND.out1(x).BE.{..wrn(x);.wrc('*s').}#0A#0AA
ND.out2(x,.y).BE.{..out1(x);.out1(y).}#0A#0AAND.out
3(x,.y,.z).BE.{..out1(x);.out1(y);.out1(z).}#0A#0AA
ND.outstring(s).BE.FOR.i.#3D.0.TO.s%0.DO.out1(s%i)#0A
#0AAND.outline().BE.out3(s_line,.comline>>00024,.co
mline&#23xFF3)#0A#0AAND.wrn(n).BE#0A{..IF.n<0.DO.{.
.wrc('-');.n.:#3D.-.n#0A..14IF.n<0.DO.{..LET.ndiv10
.#3D.(n>>0001)/5#0A..27wrpn(ndiv10)#0A..27n:#3Dn-nd
iv10*10#0A..24}#0A..11}#0A..1wrpn(n)#0A}#0A#0AAND.w
rpn(n).BE.{..IF.n>9.DO.wrpn(n/10)#0A..16wrc(n.REM.1
0.+.'0')#0A..13}#0A#0AAND.wrc(ch).BE#0A{..mcount.:#3D
.mcount.+.1#0A..1IF.mcount>62.&.ch#3D'*s'.DO.mcount
,.ch.:#3D.0,.'*n'#0A..1wrch(ch)#0A}#0A#0A

######com/mial-386.b#
SECTION."cvmial386"#0A#0AGET."libhdr"#0A#0AMANIFEST
.$(#0A//.MIAL.op.codes.and.directives#0A#0Af_lp#3D.
.0041#0Af_lg#3D..0042#0Af_ll#3D..0043#0A#0Af_llp#3D
..0034#0Af_llg#3D..0035#0Af_ll1#3D..0036#0Af_lf#3D.
.0047#0Af_lw#3D..0048#0A#0Af_l#3D..00410#0Af_lm#3D.
.00311#0A#0Af_sp#3D..00312#0Af_sg#3D..00313#0Af_sl#3D
..00314#0A#0Af_ap#3D..00315#0Af_ag#3D..00316#0Af_a#3D
..00417#0Af_s#3D..00418#0A#0Af_lkp#3D..00220#0Af_lk
g#3D..00221#0Af_rv#3D..00322#0Af_rvp#3D..00223#0Af_
rvk#3D..00224#0Af_st#3D..00325#0Af_stp#3D..00226#0A
f_stk#3D..00227#0Af_stkp#3D..00128#0Af_stkg#3D..001
29#0Af_xst#3D..00230#0A#0Af_stb#3D..00231#0Af_lvind
#3D..00032#0Af_indb#3D..00133#0Af_indb0#3D..00034#0A
f_indw#3D..00135#0A#0Af_k#3D..00436#0Af_kpg#3D..002
37#0A#0Af_neg#3D..00238#0Af_not#3D..00239#0Af_abs#3D
..00240#0A#0Af_xdiv#3D..00141#0Af_xmod#3D..00142#0A
f_xsub#3D..00143#0A#0Af_mul#3D..00245#0Af_div#3D..0
0246#0Af_mod#3D..00247#0Af_add#3D..00248#0Af_sub#3D
..00249#0A#0Af_eq#3D..00350#0Af_ne#3D..00351#0Af_ls
#3D..00352#0Af_gr#3D..00353#0Af_le#3D..00354#0Af_ge
#3D..00355#0Af_eq0#3D..00256#0Af_ne0#3D..00257#0Af_
ls0#3D..00258#0Af_gr0#3D..00259#0Af_le0#3D..00260#0A
f_ge0#3D..00261#0A#0Af_lsh#3D..00265#0Af_rsh#3D..00
266#0Af_and#3D..00267#0Af_or#3D..00368#0Af_xor#3D..
00269#0Af_lshk#3D..00170#0Af_rshk#3D..00171#0A#0Af_
xch#3D..00280#0Af_atb#3D..00281#0Af_atc#3D..00282#0A
f_bta#3D..00283#0Af_btc#3D..00284#0Af_cta#3D..00285
#0Af_atblp#3D..00086#0Af_atblg#3D..00087#0Af_atbll#3D
..00088#0Af_atbl#3D..00189#0A#0Af_j#3D..00490#0Af_r
tn#3D..00291#0A#0Af_ikp#3D..00293#0Af_ikg#3D..00294
#0Af_ikl#3D..00295#0Af_ip#3D..00396#0Af_ig#3D..0039
7#0Af_il#3D..00398#0A#0Af_jeq#3D..002100#0Af_jne#3D
..002101#0Af_jls#3D..002102#0Af_jgr#3D..002103#0Af_
jle#3D..002104#0Af_jge#3D..002105#0Af_jeq0#3D..0011
06#0Af_jne0#3D..001107#0Af_jls0#3D..001108#0Af_jgr0
#3D..001109#0Af_jle0#3D..001110000#0Af_jge0#3D..001
111#0A#0Af_brk#3D..002120#0Af_nop#3D..002121#0Af_ch
gco#3D..000122#0Af_mdiv#3D..001123#0Af_sys#3D..0021
24#0A#0Af_inc1b#3D..000130#0Af_inc4b#3D..000131#0Af
_dec1b#3D..000132#0Af_dec4b#3D..000133#0Af_inc1a#3D
..000134#0Af_inc4a#3D..000135#0Af_dec1a#3D..000136#0A
f_dec4a#3D..000137#0A#0Af_hand.#3D..000140#0Af_unh.
.#3D..000141#0Af_raise#3D..000142#0A#0Af_module#3D.
.001150#0Af_modstart#3D.151#0Af_modend#3D..001152#0A
f_global#3D..001153#0A#0Af_const#3D..002155#0A#0Af_
lab#3D..004157#0Af_entry#3D..002158#0A#0Af_dlab#3D.
.003160#0Af_dw#3D..005161#0Af_db#3D..005162#0Af_dl#3D
..005163#0Af_ds#3D..005164#0A#0A$)#0A#0AGLOBAL.$(#0A
mialin:..001200#0Aasmout:..001201#0Astdin:..002202#0A
stdout:..001203#0A#0Ardf:..004210#0Ardp:..004211#0A
rdg:..004212#0Ardk:..004213#0Ardw:..004215#0Ardl:..
004216#0Ardc:..004218#0Ardcode:..001219#0A#0Apval:.
.003220000#0Agval:..003220001#0Akval:..003221#0Awva
l:..003220004#0Alval:..003220005#0Amval:..003220006
#0A#0Ascan:..003230#0Acvf:..004231#0Acvfp:..003232#0A
cvfg:..003233#0Acvfk:..003234#0Acvfw:..003236#0Acvf
l:..003237#0A#0Amodname:..000250#0Amodletter:251#0A
charv:..002252#0Alabnumber:253#0A$)#0A#0ALET.start(
).#3D.VALOF#0A$(.LET.argv.#3D.VEC.20#0A..1LET.v..2#3D
.VEC.20#0A..1LET.cv..1#3D.VEC.256/bytesperword#0A#0A
..1modname.:#3D.v#0A..1modname%0.:#3D.0#0A..1modlet
ter.:#3D.'A'#0A..1charv.:#3D.cv#0A..1labnumber.:#3D
.0#0A#0A..1asmout.:#3D.0#0A..1stdout.:#3D.output()#0A
..1IF.rdargs("FROM,TO/K",.argv,.20)#3D0.DO#0A..1$(.
writes("Bad.args.for.cvmial386*n")#0A..4RESULTIS.20
#0A..1$)#0A..1IF.argv!0#3D0.DO.argv!0.:#3D."MIAL"#0A
..1IF.argv!1#3D0.DO.argv!1.:#3D."prog#2Es"#0A..1mia
lin.:#3D.findinput(argv!0)#0A..1IF.mialin#3D0.DO#0A
..1$(.writef("Trouble.with.file.%s*n",.argv!0)#0A..
4RESULTIS.20#0A..1$)#0A..1asmout.:#3D.findoutput(ar
gv!1)#0A..1#0A..1IF.asmout#3D0.DO#0A..1$(.writef("T
rouble.with.file.%s*n",.argv!1)#0A..4RESULTIS.20#0A
..1$)#0A..1#0A..1writef("Converting.%s.to.%s*n",.ar
gv!0,.argv!1)#0A..1selectinput(mialin)#0A..1selecto
utput(asmout)#0A#0A..1writef("#23.Code.generated.by
.cvmial386*n*n")#0A..1writef("#2Etext*n#2Ealign.16*
n")#0A#0A..1scan()#0A..1endread()#0A..1UNLESS.asmou
t#3Dstdout.DO.endwrite()#0A..1selectoutput(stdout)#0A
..1writef("Conversion.complete*n")#0A..1RESULTIS.0#0A
$)#0A#0AAND.nextlab().#3D.VALOF#0A{.labnumber.:#3D.
labnumber+1#0A..RESULTIS.labnumber#0A}#0A#0A//.argu
ment.may.be.of.form.Ln#0AAND.rdcode(let).#3D.VALOF#0A
$(.LET.a,.ch,.neg.#3D.0,.?,.FALSE#0A#0A..1ch.:#3D.r
dch().REPEATWHILE.ch#3D'*s'.|.ch#3D'*n'#0A#0A..1IF.
ch#3Dendstreamch.RESULTIS.-1#0A#0A..1UNLESS.ch#3Dle
t.DO.error("Bad.item,.looking.for.%c.found.%c*n",.l
et,.ch)#0A#0A..1ch.:#3D.rdch()#0A#0A..1IF.ch#3D'-'.
DO.{.neg.:#3D.TRUE;.ch.:#3D.rdch().}#0A#0A..1WHILE.
'0'<#3Dch<#3D'9'.DO.$(.a.:#3D.10*a.+.ch.-.'0';.ch.:
#3D.rdch()..$)#0A#0A..1RESULTIS.neg.->.-a,.a#0A$)#0A
#0AAND.rdf().#3D.rdcode('F')#0AAND.rdp().#3D.VALOF.
{.pval.:#3D.rdcode('P');.RESULTIS.pval.}#0AAND.rdg(
).#3D.VALOF.{.gval.:#3D.rdcode('G');.RESULTIS.gval.
}#0AAND.rdk().#3D.VALOF.{.kval.:#3D.rdcode('K');.RE
SULTIS.kval.}#0AAND.rdw().#3D.VALOF.{.wval.:#3D.rdc
ode('W');.RESULTIS.wval.}#0AAND.rdl().#3D.VALOF.{.l
val.:#3D.rdcode('L');.RESULTIS.lval.}#0AAND.rdm().#3D
.VALOF.{.mval.:#3D.rdcode('M');.RESULTIS.mval.}#0AA
ND.rdc().#3D.rdcode('C')#0A#0AAND.error(mess,.a,.b,
.c).BE#0A$(.LET.out.#3D.output()#0A..1UNLESS.out#3D
stdout.DO#0A..1$(.selectoutput(stdout)#0A..4writef(
mess,.a,.b,.c)#0A..4selectoutput(out)#0A..1$)#0A..1
writef(mess,.a,.b,.c)#0A$)#0A#0AAND.scan().BE#0A$(.
LET.op.#3D.rdf()#0A#0A..1SWITCHON.op.INTO#0A#0A..1$
(.DEFAULT:..5error("#23.Bad.op.%n*n",.op);.LOOP#0A#0A
..4CASE.-1:..5RETURN#0A..4#0A..4CASE.f_lp:..3cvfp("
LP").//.a.:#3D.P!n#0A..19writef("*n.movl.%n(%%ebp),
%%ebx",.4*pval)#0A..19ENDCASE#0A..4CASE.f_lg:..3cvf
g("LG").//.a.:#3D.G!n#0A..19writef("*n.movl.%n(%%es
i),%%ebx",.4*gval)#0A..19ENDCASE#0A..4CASE.f_ll:..3
cvfl("LL").//.a.:#3D.!Ln#0A..19writef("*n.movl.L%c%
n,%%ebx",.modletter,.lval)#0A..19ENDCASE#0A#0A..4CA
SE.f_llp:..2cvfp("LLP").//.a.:#3D.@.P!n#0A..19write
f("*n.leal.%n(%%ebp),%%ebx",.4*pval)#0A..19ENDCASE#0A
..4CASE.f_llg:..2cvfg("LLG").//.a.:#3D.@.G!n#0A..19
writef("*n.leal.%n(%%esi),%%ebx",.4*gval)#0A..19END
CASE#0A..4CASE.f_ll1:..2cvfl("LL1").//.a.:#3D.@.!Ln
#0A..19writef("*n.leal.L%c%n,%%ebx",.modletter,.lva
l)#0A..19ENDCASE#0A..4CASE.f_lf:..3cvfl("LF").//.a.
:#3D.byte.address.of.Ln#0A..19writef("*n.leal.L%c%n
,%%ebx",.modletter,.lval)#0A..19ENDCASE#0A..4CASE.f
_lw:..3cvfm("LW")#0A..19writef("*n.movl.M%c%n,%%ebx
",.modletter,.mval)#0A..19ENDCASE#0A#0A..4CASE.f_l:
..4cvfk("L").//.a.:#3D.n#0A..19IF.kval#3D0.DO.{.wri
tef("*n.xorl.%%ebx,%%ebx");.ENDCASE.}#0A..19writef(
"*n.movl.$%n,%%ebx",.kval)#0A..19ENDCASE#0A..4CASE.
f_lm:..3cvfk("LM").//.a.:#3D.-n#0A..19writef("*n.mo
vl.$-%n,%%ebx",.kval)#0A..19ENDCASE#0A#0A..4CASE.f_
sp:..3cvfp("SP").//.P!n.:#3D.a#0A..19writef("*n.mov
l.%%ebx,%n(%%ebp)",.4*pval)#0A..19ENDCASE#0A..4CASE
.f_sg:..3cvfg("SG").//.G!n.:#3D.a#0A..19writef("*n.
movl.%%ebx,%n(%%esi)",.4*gval)#0A..19ENDCASE#0A..4C
ASE.f_sl:..3cvfl("SL").//.!Ln.:#3D.a#0A..19writef("
*n.movl.%%ebx,L%c%n",.modletter,.lval)#0A..19ENDCAS
E#0A#0A..4CASE.f_ap:..3cvfp("AP").//.a.:#3D.a.+.P!n
#0A..19writef("*n.addl.%n(%%ebp),%%ebx",.4*pval)#0A
..19ENDCASE#0A..4CASE.f_ag:..3cvfg("AG").//.a.:#3D.
a.+.G!n#0A..19writef("*n.addl.%n(%%esi),%%ebx",.4*g
val)#0A..19ENDCASE#0A..4CASE.f_a:..4cvfk("A").//.a.
:#3D.a.+.n#0A..19IF.kval#3D0.ENDCASE#0A..19IF.kval#3D
1..DO.{.writef("*n.incl.%%ebx");.ENDCASE.}#0A..19IF
.kval#3D-1.DO.{.writef("*n.decl.%%ebx");.ENDCASE.}#0A
..19writef("*n.addl.$%n,%%ebx",.kval)#0A..19ENDCASE
#0A..4CASE.f_s:..4cvfk("S")..//.a.:#3D.a.-.n#0A..19
IF.kval#3D0.ENDCASE#0A..19IF.kval#3D1..DO.{.writef(
"*n.decl.%%ebx");.ENDCASE.}#0A..19IF.kval#3D-1.DO.{
.writef("*n.incl.%%ebx");.ENDCASE.}#0A..19writef("*
n.subl.$%n,%%ebx",.kval)#0A..19ENDCASE#0A#0A..4CASE
.f_lkp:..2cvfkp("LKP").//.a.:#3D.P!n!k#0A..19writef
("*n.movl.%n(%%ebp),%%eax",.4*pval)#0A..19writef("*
n.movl.%n(%%eax),%%ebx",.4*kval)#0A..19ENDCASE#0A..
4CASE.f_lkg:..2cvfkg("LKG").//.a.:#3D.G!n!k#0A..19w
ritef("*n.movl.%n(%%esi),%%eax",.4*gval)#0A..19writ
ef("*n.movl.%n(%%eax),%%ebx",.4*kval)#0A..19ENDCASE
#0A..4CASE.f_rv:..3cvf("RV")..//.a.:#3D.!.a#0A..19w
ritef("*n.movl.(%%ebx),%%ebx")#0A..19ENDCASE#0A..4C
ASE.f_rvp:..2cvfp("RVP").//.a.:#3D.P!n!a#0A..19writ
ef("*n.addl.%n(%%ebp),%%ebx",.4*pval)#0A..19writef(
"*n.movl.(%%ebx),%%ebx")#0A..19ENDCASE#0A..4CASE.f_
rvk:..2cvfk("RVK").//.a.:#3D.a!k#0A..19writef("*n.m
ovl.%n(%%ebx),%%ebx",.4*kval)#0A..19ENDCASE#0A..4CA
SE.f_st:..3cvf("ST").//.!a.:#3D.b#0A..19writef("*n.
movl.%%ecx,(%%ebx)")#0A..19ENDCASE#0A..4CASE.f_stp:
..2cvfp("STP").//.P!n!a.:#3D.b#0A..19writef("*n.mov
l.%n(%%ebp),%%eax",.4*pval)#0A..19writef("*n.movl.%
%ecx,(%%eax,%%ebx,4)")#0A..19ENDCASE#0A..4CASE.f_st
k:..2cvfk("STK").//.a!n.:#3D.b#0A..19writef("*n.mov
l.%%ecx,%n(%%ebx)",.4*kval)#0A..19ENDCASE#0A..4CASE
.f_stkp:..1cvfkp("STKP")..//.P!n!k.:#3D.a#0A..19wri
tef("*n.movl.%n(%%ebp),%%eax",.4*pval)#0A..19writef
("*n.movl.%%ebx,%n(%%eax)",.4*kval)#0A..19ENDCASE#0A
..4CASE.f_stkg:..1cvfkg("STKG").//.G!n!k.:#3D.a#0A.
.19writef("*n.movl.%n(%%esi),%%eax",.4*gval)#0A..19
writef("*n.movl.%%ebx,%n(%%eax)",.4*kval)#0A..19END
CASE#0A..4CASE.f_xst:..2cvf("XST").//.!b.:#3D.a#0A.
.19writef("*n.movl.%%ebx,(%%ecx)")#0A..19ENDCASE#0A
#0A..4CASE.f_stb:..2cvf("STB").//.%b.:#3D.a#0A..19w
ritef("*n.movb.%%bl,(%%ecx)")#0A..19ENDCASE#0A#0A..
4CASE.f_lvind:..cvf("LVIND").//.a.:#3D.@.b!a#0A..19
writef("*n.leal.(%%ecx,%%ebx,4),%%ebx")#0A..19ENDCA
SE#0A#0A..4CASE.f_indb:..1cvf("INDB").//.a.:#3D.b.%
.a#0A..19writef("*n.movzbl.(%%ebx,%%ecx),%%ebx").#0A
..19ENDCASE#0A#0A..4CASE.f_indb0:..cvf("INDB").//.a
.:#3D.%.a#0A..19writef("*n.movzbl.(%%ebx),%%ebx").#0A
..19ENDCASE#0A#0A..4CASE.f_indw:..1cvf("INDW").//.a
.:#3D.b!a#0A..19writef("*n.movl.(%%ecx,%%ebx,4),%%e
bx")#0A..19ENDCASE#0A#0A..4CASE.f_k:..4cvfp("K").//
.Call..a(b,#2E#2E1).incrementing.P.by.n#0A..19write
f("*n.movl.%%ebx,%%eax")#0A..19writef("*n.movl.%%ec
x,%%ebx")#0A..19writef("*n.leal.%n(%%ebp),%%edx",.4
*pval)#0A..19writef("*n.call.**%%eax")#0A..19ENDCAS
E#0A..4CASE.f_kpg:..2cvfpg("KPG").//.Call.Gg(a,#2E#2E
1).incrementing.P.by.n#0A..19writef("*n.movl.%n(%%e
si),%%eax",.4*gval)#0A..19writef("*n.leal.%n(%%ebp)
,%%edx",.4*pval)#0A..19writef("*n.call.**%%eax")#0A
..19ENDCASE#0A#0A..4CASE.f_neg:..2cvf("NEG").//.a.:
#3D.-.a#0A..19writef("*n.negl.%%ebx").#0A..19ENDCAS
E#0A..4CASE.f_not:..2cvf("NOT").//.a.:#3D.~.a#0A..1
9writef("*n.notl.%%ebx").#0A..19ENDCASE#0A..4CASE.f
_abs:..2cvf("ABS").//.a.:#3D.ABS.a#0A..17{.LET.l.#3D
.nextlab()#0A..19writef("*n.orl.%%ebx,%%ebx")#0A..1
9writef("*n.jge.L%n",.l)#0A..19writef("*n.negl.%%eb
x")#0A..19writef("*nL%n:",.l)#0A..19ENDCASE#0A..17}
#0A#0A..4CASE.f_xdiv:..1cvf("XDIV").//.a.:#3D.a./.b
#0A..19writef("*n.movl.%%ebx,%%eax")#0A..19writef("
*n.cdq")#0A..19writef("*n.idiv.%%ecx")#0A..19writef
("*n.movl.%%eax,%%ebx")#0A..19ENDCASE#0A..4CASE.f_x
mod:..1cvf("XMOD").//.a.:#3D.a.MOD.b#0A..19writef("
*n.movl.%%ebx,%%eax")#0A..19writef("*n.cdq")#0A..19
writef("*n.idiv.%%ecx")#0A..19writef("*n.movl.%%edx
,%%ebx")#0A..19ENDCASE#0A..4CASE.f_xsub:..1cvf("XSU
B").//.a.:#3D.a.-.b#0A..19writef("*n.subl.%%ecx,%%e
bx")#0A..19ENDCASE#0A#0A..4CASE.f_mul:..2cvf("MUL")
.//.a.:#3D.b.*.a;.c.:#3D.?#0A..19writef("*n.movl.%%
ecx,%%eax")#0A..19writef("*n.imul.%%ebx").//.currup
ts.edx#0A..19writef("*n.movl.%%eax,%%ebx")#0A..19EN
DCASE#0A..4CASE.f_div:..2cvf("DIV")..//.a.:#3D.b./.
a;.c.:#3D.?#0A..19writef("*n.movl.%%ecx,%%eax")#0A.
.19writef("*n.cdq")#0A..19writef("*n.idiv.%%ebx")#0A
..19writef("*n.movl.%%eax,%%ebx")#0A..19ENDCASE#0A.
.4CASE.f_mod:..2cvf("MOD").//.a.:#3D.b.MOD.a;.c.:#3D
.?#0A..19writef("*n.movl.%%ecx,%%eax")#0A..19writef
("*n.cdq")#0A..19writef("*n.idiv.%%ebx")#0A..19writ
ef("*n.movl.%%edx,%%ebx")#0A..19ENDCASE#0A..4CASE.f
_add:..2cvf("ADD").//.a.:#3D.b.+.a#0A..19writef("*n
.addl.%%ecx,%%ebx")#0A..19ENDCASE#0A..4CASE.f_sub:.
.2cvf("SUB").//.a.:#3D.b.-.a#0A..19writef("*n.subl.
%%ecx,%%ebx")#0A..19writef("*n.negl.%%ebx")#0A..19E
NDCASE#0A#0A..4CASE.f_eq:..3cvf("EQ").//.a.:#3D.b.#3D
.a#0A..19writef("*n.cmpl.%%ebx,%%ecx")#0A..19writef
("*n.seteb.%%bl")#0A..19writef("*n.movzbl.%%bl,%%eb
x")#0A..19writef("*n.negl.%%ebx")#0A..19ENDCASE#0A.
.4CASE.f_ne:..3cvf("NE").//.a.:#3D.b.~#3D.a#0A..19w
ritef("*n.cmpl.%%ebx,%%ecx")#0A..19writef("*n.setne
b.%%bl")#0A..19writef("*n.movzbl.%%bl,%%ebx")#0A..1
9writef("*n.negl.%%ebx")#0A..19ENDCASE#0A..4CASE.f_
ls:..3cvf("LS").//.a.:#3D.b.<.a#0A..19writef("*n.cm
pl.%%ebx,%%ecx")#0A..19writef("*n.setlb.%%bl")#0A..
19writef("*n.movzbl.%%bl,%%ebx")#0A..19writef("*n.n
egl.%%ebx")#0A..19ENDCASE#0A..4CASE.f_gr:..3cvf("GR
").//.a.:#3D.b.>.a#0A..19writef("*n.cmpl.%%ebx,%%ec
x")#0A..19writef("*n.setgb.%%bl")#0A..19writef("*n.
movzbl.%%bl,%%ebx")#0A..19writef("*n.negl.%%ebx")#0A
..19ENDCASE#0A..4CASE.f_le:..3cvf("LE").//.a.:#3D.b
.<#3D.a#0A..19writef("*n.cmpl.%%ebx,%%ecx")#0A..19w
ritef("*n.setleb.%%bl")#0A..19writef("*n.movzbl.%%b
l,%%ebx")#0A..19writef("*n.negl.%%ebx")#0A..19ENDCA
SE#0A..4CASE.f_ge:..3cvf("GE").//.a.:#3D.b.>#3D.a#0A
..19writef("*n.cmpl.%%ebx,%%ecx")#0A..19writef("*n.
setgeb.%%bl")#0A..19writef("*n.movzbl.%%bl,%%ebx")#0A
..19writef("*n.negl.%%ebx")#0A..19ENDCASE#0A#0A..4C
ASE.f_eq0:..2cvf("EQ0").//.a.:#3D.a.#3D.0#0A..19wri
tef("*n.orl.%%ebx,%%ebx")#0A..19writef("*n.seteb.%%
bl")#0A..19writef("*n.movzbl.%%bl,%%ebx")#0A..19wri
tef("*n.negl.%%ebx")#0A..19ENDCASE#0A..4CASE.f_ne0:
..2cvf("NE0").//.a.:#3D.a.~#3D.0#0A..19writef("*n.o
rl.%%ebx,%%ebx")#0A..19writef("*n.setneb.%%bl")#0A.
.19writef("*n.movzbl.%%bl,%%ebx")#0A..19writef("*n.
negl.%%ebx")#0A..19ENDCASE#0A..4CASE.f_ls0:..2cvf("
LS0").//.a.:#3D.a.<.0#0A..19writef("*n.sarl.$31,%%e
bx")#0A..19ENDCASE#0A..4CASE.f_gr0:..2cvf("GR0").//
.a.:#3D.a.>.0#0A..19writef("*n.orl.%%ebx,%%ebx")#0A
..19writef("*n.setgb.%%bl")#0A..19writef("*n.movzbl
.%%bl,%%ebx")#0A..19writef("*n.negl.%%ebx")#0A..19E
NDCASE#0A..4CASE.f_le0:..2cvf("LE0").//.a.:#3D.a.<#3D
.0#0A..19writef("*n.orl.%%ebx,%%ebx")#0A..19writef(
"*n.setleb.%%bl")#0A..19writef("*n.movzbl.%%bl,%%eb
x")#0A..19writef("*n.negl.%%ebx")#0A..19ENDCASE#0A.
.4CASE.f_ge0:..2cvf("GE0").//.a.:#3D.a.>#3D.0#0A..1
9writef("*n.sarl.$31,%%ebx")#0A..19writef("*n.notl.
%%ebx")#0A..19ENDCASE#0A#0A..4CASE.f_lsh:..2cvf("LS
H").//.a.:#3D.b.<<.a#0A..19writef("*n.xorl.%%eax,%%
eax")#0A..19writef("*n.cmpl.$31,%%ebx")#0A..19write
f("*n.setgb.%%al")#0A..19writef("*n.decl.%%eax")#0A
..19writef("*n.andl.%%ecx,%%eax")#0A..19writef("*n.
xchgl.%%eax,%%ebx")#0A..19writef("*n.xchgl.%%eax,%%
ecx")#0A..19writef("*n.sall.%%cl,%%ebx")#0A..19writ
ef("*n.movl.%%eax,%%ecx")#0A..19ENDCASE#0A..4CASE.f
_lshk:..1cvfk("LSHK").//.a.:#3D.a.<<.k#0A..19IF.kva
l#3D0.ENDCASE#0A..19IF.kval#3D1.DO.{.writef("*n.add
l.%%ebx,%%ebx")#0A..34ENDCASE#0A..32}#0A..19TEST.0<
#3Dkval<#3D31#0A..19THEN.writef("*n.sall.$%n,%%ebx"
,.kval)#0A..19ELSE.writef("*n.xorl.%%ebx,%%ebx")#0A
..19ENDCASE#0A..4CASE.f_rsh:..2cvf("RSH").//.a.:#3D
.b.>>.a.#0A..19writef("*n.xorl.%%eax,%%eax")#0A..19
writef("*n.cmpl.$31,%%ebx")#0A..19writef("*n.setgb.
%%al")#0A..19writef("*n.decl.%%eax")#0A..19writef("
*n.andl.%%ecx,%%eax")#0A..19writef("*n.xchgl.%%eax,
%%ebx")#0A..19writef("*n.xchgl.%%eax,%%ecx")#0A..19
writef("*n.shrl.%%cl,%%ebx")#0A..19writef("*n.movl.
%%eax,%%ecx")#0A..19ENDCASE#0A..4CASE.f_rshk:..1cvf
k("RSHK").//.a.:#3D.a.>>.k#0A..19IF.kval#3D0.ENDCAS
E#0A..19TEST.0<#3Dkval<#3D31#0A..19THEN.writef("*n.
shrl.$%n,%%ebx",.kval)#0A..19ELSE.writef("*n.xorl.%
%ebx,%%ebx")#0A..19ENDCASE#0A..4CASE.f_and:..2cvf("
AND").//.a.:#3D.b.&.a.#0A..19writef("*n.andl.%%ecx,
%%ebx").#0A..19ENDCASE#0A..4CASE.f_or:..3cvf("OR").
//.a.:#3D.b.|.a.#0A..19writef("*n.orl.%%ecx,%%ebx")
.#0A..19ENDCASE#0A..4CASE.f_xor:..2cvf("XOR").//.a.
:#3D.b.XOR.a#0A..19writef("*n.xorl.%%ecx,%%ebx").#0A
..19ENDCASE#0A#0A..4CASE.f_xch:..2cvf("XCH").//.swa
p.a.and.b#0A..19writef("*n.xchgl.%%ebx,%%ecx")#0A..
19ENDCASE#0A..4CASE.f_atb:..2cvf("ATB").//.b.:#3D.a
#0A..19writef("*n.movl.%%ebx,%%ecx")#0A..19ENDCASE#0A
..4CASE.f_atc:..2cvf("ATC").//.c.:#3D.a#0A..19write
f("*n.movl.%%ebx,%%edx")#0A..19ENDCASE#0A..4CASE.f_
cta:..2cvf("CTA").//.a.:#3D.c#0A..19writef("*n.movl
.%%edx,%%ebx")#0A..19ENDCASE#0A..4CASE.f_bta:..2cvf
("BTA").//.a.:#3D.b#0A..19writef("*n.movl.%%ecx,%%e
bx")#0A..19ENDCASE#0A..4CASE.f_btc:..2cvf("BTC").//
.c.:#3D.b#0A..19writef("*n.movl.%%ecx,%%edx")#0A..1
9ENDCASE#0A..4CASE.f_atblp:..cvfp("ATBLP").//.b.:#3D
.a;.a.:#3D.P!n#0A..19writef("*n.movl.%%ebx,%%ecx")#0A
..19writef("*n.movl.%n(%%ebp),%%ebx",.4*pval)#0A..1
9ENDCASE#0A..4CASE.f_atblg:..cvfg("ATBLG").//.b.:#3D
.a;.a.:#3D.G!n#0A..19writef("*n.movl.%%ebx,%%ecx")#0A
..19writef("*n.movl.%n(%%esi),%%ebx",.4*gval)#0A..1
9ENDCASE#0A..4CASE.f_atbl:..1cvfk("ATBL").//.b.:#3D
.a;.a.:#3D.k#0A..19writef("*n.movl.%%ebx,%%ecx")#0A
..19writef("*n.movl.$%n,%%ebx",.kval)#0A..19ENDCASE
#0A#0A..4CASE.f_j:..4cvfl("J").//.jump.to.Ln#0A..19
writef("*n.jmp.L%c%n",.modletter,.lval)#0A..19ENDCA
SE#0A..4CASE.f_rtn:..2cvf("RTN").//.procedure.retur
n#0A..19writef("*n.movl.4(%%ebp),%%eax")#0A..19writ
ef("*n.movl.0(%%ebp),%%ebp")#0A..19writef("*n.jmp.*
*%%eax")#0A..19ENDCASE#0A#0A..4CASE.f_ikp:..2cvfkp(
"IKP").//.a.:#3D.P!n.+.k;.P!n.:#3D.a#0A..19writef("
*n.movl.%n(%%ebp),%%ebx",.4*pval)#0A..19TEST.kval#3D
1#0A..19THEN.writef("*n.incl.%%ebx")#0A..19ELSE.TES
T.kval#3D-1#0A..24THEN.writef("*n.decl.%%ebx")#0A..
24ELSE.writef("*n.addl.$%n,%%ebx",.kval)#0A..19writ
ef("*n.movl.%%ebx,%n(%%ebp)",.4*pval)#0A..19ENDCASE
#0A..4CASE.f_ikg:..2cvfkg("IKG").//.a.:#3D.G!n.+.k;
.G!n.:#3D.a#0A..19writef("*n.movl.%n(%%esi),%%ebx",
.4*gval)#0A..19TEST.kval#3D1#0A..19THEN.writef("*n.
incl.%%ebx")#0A..19ELSE.TEST.kval#3D-1#0A..24THEN.w
ritef("*n.decl.%%ebx")#0A..24ELSE.writef("*n.addl.$
%n,%%ebx",.kval)#0A..19writef("*n.movl.%%ebx,%n(%%e
si)",.4*gval)#0A..19ENDCASE#0A..4CASE.f_ikl:..2cvfk
l("IKL").//.a.:#3D.!Ln.+.k;.!Ln.:#3D.a#0A..19writef
("*n.movl.L%c%n,%%ebx",.modletter,.lval)#0A..19TEST
.kval#3D1#0A..19THEN.writef("*n.incl.%%ebx")#0A..19
ELSE.TEST.kval#3D-1#0A..24THEN.writef("*n.decl.%%eb
x")#0A..24ELSE.writef("*n.addl.$%n,%%ebx",.kval)#0A
..19writef("*n.movl.%%ebx,L%c%n",.modletter,.lval)#0A
..19ENDCASE#0A..4CASE.f_ip:..3cvfp("IP").//.a.:#3D.
P!n.+.a;.P!n.:#3D.a#0A..19writef("*n.addl.%n(%%ebp)
,%%ebx",.4*pval)#0A..19writef("*n.movl.%%ebx,%n(%%e
bp)",.4*pval)#0A..19ENDCASE#0A..4CASE.f_ig:..3cvfg(
"IG").//.a.:#3D.G!n.+.a;.G!n.:#3D.a#0A..19writef("*
n.addl.%n(%%esi),%%ebx",.4*gval)#0A..19writef("*n.m
ovl.%%ebx,%n(%%esi)",.4*gval)#0A..19ENDCASE#0A..4CA
SE.f_il:..3cvfl("IL").//.a.:#3D.!Ln.+.a;.!Ln.:#3D.a
#0A..19writef("*n.addl.L%c%n,%%ebx",.modletter,.lva
l)#0A..19writef("*n.movl.%%ebx,L%c%n",.modletter,.l
val)#0A..19ENDCASE#0A#0A..4CASE.f_jeq:..2cvfl("JEQ"
).//.Jump.to.Ln.if.b.#3D.a#0A..19writef("*n.cmpl.%%
ebx,%%ecx")#0A..19writef("*n.je.L%c%n",.modletter,.
lval)#0A..19ENDCASE#0A..4CASE.f_jne:..2cvfl("JNE").
//.Jump.to.Ln.if.b.~#3D.a#0A..19writef("*n.cmpl.%%e
bx,%%ecx")#0A..19writef("*n.jne.L%c%n",.modletter,.
lval)#0A..19ENDCASE#0A..4CASE.f_jls:..2cvfl("JLS").
//.Jump.to.Ln.if.b.<.a#0A..19writef("*n.cmpl.%%ebx,
%%ecx")#0A..19writef("*n.jl.L%c%n",.modletter,.lval
)#0A..19ENDCASE#0A..4CASE.f_jgr:..2cvfl("JGR").//.J
ump.to.Ln.if.b.>.a#0A..19writef("*n.cmpl.%%ebx,%%ec
x")#0A..19writef("*n.jg.L%c%n",.modletter,.lval)#0A
..19ENDCASE#0A..4CASE.f_jle:..2cvfl("JLE").//.Jump.
to.Ln.if.b.<#3D.a#0A..19writef("*n.cmpl.%%ebx,%%ecx
")#0A..19writef("*n.jle.L%c%n",.modletter,.lval)#0A
..19ENDCASE#0A..4CASE.f_jge:..2cvfl("JGE").//.Jump.
to.Ln.if.b.>#3D.a#0A..19writef("*n.cmpl.%%ebx,%%ecx
")#0A..19writef("*n.jge.L%c%n",.modletter,.lval)#0A
..19ENDCASE#0A#0A..4CASE.f_jeq0:..1cvfl("JEQ0").//.
Jump.to.Ln.if.a.#3D.0#0A..19writef("*n.orl.%%ebx,%%
ebx")#0A..19writef("*n.je.L%c%n",.modletter,.lval)#0A
..19ENDCASE#0A..4CASE.f_jne0:..1cvfl("JNE0").//.Jum
p.to.Ln.if.a.~#3D.0#0A..19writef("*n.orl.%%ebx,%%eb
x")#0A..19writef("*n.jne.L%c%n",.modletter,.lval)#0A
..19ENDCASE#0A..4CASE.f_jls0:..1cvfl("JLS0").//.Jum
p.to.Ln.if.a.<.0#0A..19writef("*n.orl.%%ebx,%%ebx")
#0A..19writef("*n.jl.L%c%n",.modletter,.lval)#0A..1
9ENDCASE#0A..4CASE.f_jgr0:..1cvfl("JGR0").//.Jump.t
o.Ln.if.a.>.0#0A..19writef("*n.orl.%%ebx,%%ebx")#0A
..19writef("*n.jg.L%c%n",.modletter,.lval)#0A..19EN
DCASE#0A..4CASE.f_jle0:..1cvfl("JLE0").//.Jump.to.L
n.if.a.<#3D.0#0A..19writef("*n.orl.%%ebx,%%ebx")#0A
..19writef("*n.jle.L%c%n",.modletter,.lval)#0A..19E
NDCASE#0A..4CASE.f_jge0:..1cvfl("JGE0").//.Jump.to.
Ln.if.a.>#3D.0#0A..19writef("*n.orl.%%ebx,%%ebx")#0A
..19writef("*n.jge.L%c%n",.modletter,.lval)#0A..19E
NDCASE#0A#0A..4//.The.following.five.opcodes.are.ne
ver.generated.by#0A..4//.the.BCPL.compiler#0A..4CAS
E.f_brk:..2cvf("BRK").//.Breakpoint.instruction#0A.
.19writef("*n.unimplemented")#0A..19ENDCASE#0A..4CA
SE.f_nop:..2cvf("NOP").//.No.operation#0A..19ENDCAS
E#0A..4CASE.f_chgco:..cvf("CHGCO").//.Change.corout
ine#0A..19writef("*n.unimplemented")#0A..19ENDCASE#0A
..4CASE.f_mdiv:..1cvf("MDIV").//.a.:#3D.Muldiv(P!3,
.P!4,.P!5).#0A..19writef("*n.unimplemented")#0A..19
ENDCASE#0A..4CASE.f_sys:..2cvf("SYS").//.System.fun
ction#0A..19writef("*n.unimplemented")#0A..19ENDCAS
E#0A#0A..4CASE.f_module:..1cvfs("MODULE").//.Name.o
f.section#0A..21FOR.i.#3D.0.TO.charv%0.DO.modname%i
.:#3D.charv%i#0A..21ENDCASE#0A..4CASE.f_modstart:.c
vf("MODSTART").//.Start.of.module..#0A..21modname%0
.:#3D.0#0A..21ENDCASE#0A..4CASE.f_modend:..1cvf("MO
DEND").//.End.of.module.#0A..21modletter.:#3D.modle
tter+1#0A..21ENDCASE#0A..4CASE.f_global:..1cvglobal
().//.Global.initialisation.data#0A..21ENDCASE#0A..
4CASE.f_const:..2cvconst().//.Large.integer.constan
t#0A..21ENDCASE#0A#0A..4CASE.f_lab:..4cvfl("LAB")./
/.Program.label#0A..21writef("*n.#2Etext")#0A..21wr
itef("*nL%c%n:",.modletter,.lval)#0A..21ENDCASE#0A.
.4CASE.f_entry:..2cventry().//.Start.of.a.function#0A
..21ENDCASE#0A#0A..4CASE.f_dlab:..3cvfl("DLAB").//.
Static.data.label#0A..21writef("*n.#2Edata")#0A..21
writef("*nL%c%n:",.modletter,.lval)#0A..21ENDCASE#0A
..4CASE.f_dw:..5cvfw("DW").//.Static.data.word#0A..
21writef("*n.#2Elong.%n",.wval)#0A..21ENDCASE#0A..4
CASE.f_db:..5cvfk("DB").//.Static.data.byte#0A..21w
ritef("*n.#2Ebyte.%n",.kval)#0A..21ENDCASE#0A..4CAS
E.f_dl:..5cvfl("DL").//.Static.data.word.pointer#0A
..21writef("*n.#2Elong.L%c%n",.modletter,.lval)#0A.
.21ENDCASE#0A..4CASE.f_ds:..5cvfk("DS").//.Static.d
ata.space#0A..21FOR.i.#3D.0.TO.kval.DO.writef("*n.#2E
long.0")#0A..21ENDCASE#0A#0A..4CASE.f_inc1b:..2cvf(
"INC1B")..1//.a.:#3D.++(!a)#0A..21writef("*n.movl.(
%%ebx),%%eax")#0A..21writef("*n.incl.%%eax")#0A..21
writef("*n.movl.%%eax,(%%ebx)")#0A..21writef("*n.mo
vl.%%eax,%%ebx")#0A..21ENDCASE#0A..4CASE.f_inc4b:..
2cvf("INC4B")..1//.a.:#3D.++1(!a)#0A..21writef("*n.
movl.(%%ebx),%%eax")#0A..21writef("*n.addl.$4,%%eax
")#0A..21writef("*n.movl.%%eax,(%%ebx)")#0A..21writ
ef("*n.movl.%%eax,%%ebx")#0A..21ENDCASE#0A..4CASE.f
_dec1b:..2cvf("DEC1B")..1//.a.:#3D.--(!a)#0A..21wri
tef("*n.movl.(%%ebx),%%eax")#0A..21writef("*n.decl.
%%eax")#0A..21writef("*n.movl.%%eax,(%%ebx)")#0A..2
1writef("*n.movl.%%eax,%%ebx")#0A..21ENDCASE#0A..4C
ASE.f_dec4b:..2cvf("DEC4B")..1//.a.:#3D.--1(!a)#0A.
.21writef("*n.movl.(%%ebx),%%eax")#0A..21writef("*n
.subl.$4,%%eax")#0A..21writef("*n.movl.%%eax,(%%ebx
)")#0A..21writef("*n.movl.%%eax,%%ebx")#0A..21ENDCA
SE#0A..4CASE.f_inc1a:..2cvf("INC1A")..1//.a.:#3D.(!
a)++#0A..21writef("*n.movl.(%%ebx),%%eax")#0A..21wr
itef("*n.incl.(%%ebx)")#0A..21writef("*n.movl.%%eax
,%%ebx")#0A..21ENDCASE#0A..4CASE.f_inc4a:..2cvf("IN
C4A")..1//.a.:#3D.(!a)++1#0A..21writef("*n.movl.(%%
ebx),%%eax")#0A..21writef("*n.addl.$4,%%eax")#0A..2
1writef("*n.movl.%%eax,(%%ebx)")#0A..21writef("*n.l
eal.-4(%%eax),%%ebx")#0A..21ENDCASE#0A..4CASE.f_dec
1a:..2cvf("DEC1A")..1//.a.:#3D.(!a)--#0A..21writef(
"*n.movl.(%%ebx),%%eax")#0A..21writef("*n.decl.(%%e
bx)")#0A..21writef("*n.movl.%%eax,%%ebx")#0A..21END
CASE#0A..4CASE.f_dec4a:..2cvf("DEC4A")..1//.a.:#3D.
(!a)--1#0A..21writef("*n.movl.(%%ebx),%%eax")#0A..2
1writef("*n.subl.$4,%%eax")#0A..21writef("*n.movl.%
%eax,(%%ebx)")#0A..21writef("*n.leal.4(%%eax),%%ebx
")#0A..21ENDCASE#0A#0A..4CASE.f_unh:..4cvf("UNH")..
1//.h.:#3D.h!1#0A..21writef("*n.movl.20(%%esi),%%ea
x").//.LET.h.#3D.G!5#0A..21writef("*n.movl.4(%%eax)
,%%eax")..//.h.:#3D.h!1#0A..21writef("*n.movl.%%eax
,20(%%esi)").//.G!5.:#3D.h#0A..21ENDCASE#0A#0A..4CA
SE.f_hand:..3cvfl("HAND").//.a!0,.a!1,.a!2.:#3D.P,.
H,.Ln#0A..34//.H.:#3D.a#0A..21writef("*n.movl.%%ebp
,(%%ebx)")..1//.a!0.:#3D.P#0A..21writef("*n.movl.20
(%%esi),%%eax")#0A..21writef("*n.movl.%%eax,4(%%ebx
)")..//.a!1.:#3D.H#0A..55//.a!2.:#3D.Ln#0A..21write
f("*n.movl.$L%c%n,8(%%ebx)",.modletter,.lval)#0A..2
1writef("*n.movl.%%ebx,20(%%esi)").//.H.:#3D.a#0A..
21ENDCASE#0A#0A..4CASE.f_raise:..2cvf("RAISE").//.L
ET.p,h,l.:#3D.H!0,.H!1,.H!2#0A..34//.H!0,.H!1,.H!2.
:#3D.a,.b,.c#0A..34//.P,.H.:#3D.p,.h#0A..34//.GOTO.
l#0A..21writef("*n.movl.20(%%esi),%%ebp").//.LET.h.
#3D.G!5#0A..21writef("*n.movl.4(%%ebp),%%eax")#0A..
21writef("*n.movl.%%eax,20(%%esi)").//.G!5.:#3D.h!1
#0A..21writef("*n.movl.8(%%ebp),%%eax")..//.eax.:#3D
.h!2#0A..21writef("*n.movl.%%edx,8(%%ebp)")..//.h!2
.:#3D.c#0A..21writef("*n.movl.%%ecx,4(%%ebp)")..//.
h!1.:#3D.b#0A..21writef("*n.movl.(%%ebp),%%edx")..1
//.c..1:#3D.h!0#0A..21writef("*n.movl.%%ebx,(%%ebp)
")..1//.h!0.:#3D.a#0A..21writef("*n.movl.%%edx,%%eb
p")..3//.p..1:#3D.c#0A..21writef("*n.jmp.**%%eax").
.8//.GOTO.eax#0A..21ENDCASE#0A#0A..1$)#0A#0A..1newl
ine()#0A$).REPEAT#0A#0AAND.cvf(s)..1BE.writef("#23.
%s",.s)#0AAND.cvfp(s)..BE.writef("#23.%t7.P%n",.s,.
rdp())#0AAND.cvfkp(s).BE.writef("#23.%t7.K%n.P%n",.
s,.rdk(),.rdp())#0AAND.cvfg(s)..BE.writef("#23.%t7.
G%n",.s,.rdg())#0AAND.cvfkg(s).BE.writef("#23.%t7.K
%n.G%n",.s,.rdk(),.rdg())#0AAND.cvfkl(s).BE.writef(
"#23.%t7.K%n.L%n",.s,.rdk(),.rdl())#0AAND.cvfpg(s).
BE.writef("#23.%t7.P%n.G%n",.s,.rdp(),.rdg())#0AAND
.cvfk(s)..BE.writef("#23.%t7.K%n",.s,.rdk())#0AAND.
cvfw(s)..BE.writef("#23.%t7.W%n",.s,.rdw())#0AAND.c
vfl(s)..BE.writef("#23.%t7.L%n",.s,.rdl())#0AAND.cv
fm(s)..BE.writef("#23.%t7.M%n",.s,.rdm())#0A#0AAND.
cvglobal().BE#0A$(.LET.n.#3D.rdk()#0A..1writef("#23
.GLOBAL.K%n*n",.n)#0A..1IF.modname%0#3D0.FOR.i.#3D.
0.TO.4.DO.modname%i.:#3D."prog"%i#0A..1writef("*n#2E
globl.%s*n",.modname)#0A..1writef("%s:*n",.modname)
#0A..1writef(".movl.4(%%esp),%%eax*n")#0A..1FOR.i.#3D
.1.TO.n.DO#0A..1$(.LET.g.#3D.rdg()#0A..4LET.n.#3D.r
dl()#0A..4writef("#23.G%n.L%n*n",.g,.n)#0A..4writef
(".movl.$L%c%n,%n(%%eax)*n",.modletter,.n,.4*g)#0A.
.1$)#0A..1writef("#23.G%n",.rdg())#0A..1writef("*n.
ret*n")#0A$)#0A#0AAND.rdchars().#3D.VALOF#0A{.LET.n
.#3D.rdk()#0A..charv%0.:#3D.n#0A..FOR.i.#3D.1.TO.n.
DO.charv%i.:#3D.rdc()#0A..RESULTIS.n#0A}#0A#0AAND.c
vstring().BE#0A$(.LET.lab.#3D.rdm()#0A..1LET.n.#3D.
rdchars()#0A..1writef("#23.STRING..M%n.K%n",.lab,.n
)#0A..1FOR.i.#3D.1.TO.n.DO.writef(".C%n",.charv%i)#0A
..1writef("*n#2Edata")#0A..1writef("*n.#2Ealign.4")
#0A..1writef("*nM%c%n:",.modletter,.lab)#0A..1FOR.i
.#3D.0.TO.n.DO.writef("*n.#2Ebyte.%n",.charv%i)#0A.
.1writef("*n.#2Etext")#0A$)#0A#0AAND.cvconst().BE#0A
$(.LET.lab.#3D.rdm()#0A..1LET.w.#3D.rdw()#0A..1writ
ef("#23.CONST..1M%n.W%n",.lab,.w)#0A..1writef("*n#2E
data")#0A..1writef("*n.#2Ealign.4")#0A..1writef("*n
M%c%n:",.modletter,.lab)#0A..1writef("*n.#2Elong.%n
",.w)#0A..1writef("*n.#2Etext")#0A$)#0A#0AAND.cvsta
tic().BE#0A$(.LET.lab.#3D.rdl()#0A..1LET.n.#3D.rdk(
)#0A..1writef("#23.STATIC..L%n.K%n",.lab,.n)#0A..1w
ritef("*n#2Edata")#0A..1writef("*n.#2Ealign.4")#0A.
.1writef("*nL%c%n:",.modletter,.lab)#0A..1FOR.i.#3D
.1.TO.n.DO.{.writef("*n#23.W%n",.rdw())#0A..21write
f("*n.#2Elong.%n",.wval)#0A..19}#0A..1writef("*n.#2E
text")#0A$)#0A#0AAND.cvfs(s).BE#0A$(.LET.n.#3D.rdch
ars()#0A..1writef("#23.%t7.K%n",.s,.n)#0A..1FOR.i.#3D
.1.TO.n.DO.writef(".C%n",.charv%i)#0A$)#0A#0AAND.cv
entry().BE#0A$(.LET.n.#3D.rdchars()#0A..1LET.op.#3D
.rdf()#0A..1LET.lab.#3D.rdl()#0A..1writef("*n#23.En
try.to:.%s*n",.charv)#0A..1writef("#23.%t7.K%n",."E
NTRY",.n)#0A..1FOR.i.#3D.1.TO.n.DO.writef(".C%n",.c
harv%i)#0A..1newline()#0A..1TEST.op#3Df_lab.THEN.wr
itef("#23.LAB..3L%n*n",.lab)#0A..15ELSE.writef("#23
.Bad.op.F%n.L%n*n",.op,.lab)#0A..1writef("*n.#2Etex
t")#0A..1writef("*nL%c%n:",.modletter,.lab)#0A..1wr
itef("*n.movl.%%ebp,0(%%edx)")..1//.NP!0.:#3D.P#0A.
.1writef("*n.movl.%%edx,%%ebp")..4//.P..2:#3D.NP#0A
..1writef("*n.popl.%%edx")#0A..1writef("*n.movl.%%e
dx,4(%%ebp)")..1//.P!1..:#3D.return.address#0A..1wr
itef("*n.movl.%%eax,8(%%ebp)")..1//.P!2..:#3D.entry
.address#0A..1writef("*n.movl.%%ebx,12(%%ebp)")..//
.P!3..:#3D.arg1#0A$)#0A#0A3

######com/mial-masm.b#
SECTION."cvmial"#0A#0AGET."libhdr"#0A#0AMANIFEST.$(
#0A//.MIAL.op.codes.and.directives#0A#0Af_lp#3D..00
41#0Af_lg#3D..0042#0Af_ll#3D..0043#0A#0Af_llp#3D..0
034#0Af_llg#3D..0035#0Af_ll1#3D..0036#0Af_lf#3D..00
47#0Af_lw#3D..0048#0A#0Af_l#3D..00410#0Af_lm#3D..00
311#0A#0Af_sp#3D..00312#0Af_sg#3D..00313#0Af_sl#3D.
.00314#0A#0Af_ap#3D..00315#0Af_ag#3D..00316#0Af_a#3D
..00417#0Af_s#3D..00418#0A#0Af_lkp#3D..00220#0Af_lk
g#3D..00221#0Af_rv#3D..00322#0Af_rvp#3D..00223#0Af_
rvk#3D..00224#0Af_st#3D..00325#0Af_stp#3D..00226#0A
f_stk#3D..00227#0Af_stkp#3D..00128#0Af_stkg#3D..001
29#0Af_xst#3D..00230#0A#0Af_stb#3D..00231#0Af_lvind
#3D..00032#0Af_indb#3D..00133#0Af_indb0#3D..00034#0A
f_indw#3D..00135#0A#0Af_k#3D..00436#0Af_kpg#3D..002
37#0A#0Af_neg#3D..00238#0Af_not#3D..00239#0Af_abs#3D
..00240#0A#0Af_xdiv#3D..00141#0Af_xmod#3D..00142#0A
f_xsub#3D..00143#0A#0Af_mul#3D..00245#0Af_div#3D..0
0246#0Af_mod#3D..00247#0Af_add#3D..00248#0Af_sub#3D
..00249#0A#0Af_eq#3D..00350#0Af_ne#3D..00351#0Af_ls
#3D..00352#0Af_gr#3D..00353#0Af_le#3D..00354#0Af_ge
#3D..00355#0Af_eq0#3D..00256#0Af_ne0#3D..00257#0Af_
ls0#3D..00258#0Af_gr0#3D..00259#0Af_le0#3D..00260#0A
f_ge0#3D..00261#0A#0Af_lsh#3D..00265#0Af_rsh#3D..00
266#0Af_and#3D..00267#0Af_or#3D..00368#0Af_xor#3D..
00269#0Af_lshk#3D..00170#0Af_rshk#3D..00171#0A#0Af_
xch#3D..00280#0Af_atb#3D..00281#0Af_atc#3D..00282#0A
f_bta#3D..00283#0Af_btc#3D..00284#0Af_cta#3D..00285
#0Af_atblp#3D..00086#0Af_atblg#3D..00087#0Af_atbll#3D
..00088#0Af_atbl#3D..00189#0A#0Af_j#3D..00490#0Af_r
tn#3D..00291#0A#0Af_ikp#3D..00293#0Af_ikg#3D..00294
#0Af_ikl#3D..00295#0Af_ip#3D..00396#0Af_ig#3D..0039
7#0Af_il#3D..00398#0A#0Af_jeq#3D..002100#0Af_jne#3D
..002101#0Af_jls#3D..002102#0Af_jgr#3D..002103#0Af_
jle#3D..002104#0Af_jge#3D..002105#0Af_jeq0#3D..0011
06#0Af_jne0#3D..001107#0Af_jls0#3D..001108#0Af_jgr0
#3D..001109#0Af_jle0#3D..001110000#0Af_jge0#3D..001
111#0A#0Af_brk#3D..002120#0Af_nop#3D..002121#0Af_ch
gco#3D..000122#0Af_mdiv#3D..001123#0Af_sys#3D..0021
24#0A#0Af_inc1b#3D..000130#0Af_inc4b#3D..000131#0Af
_dec1b#3D..000132#0Af_dec4b#3D..000133#0Af_inc1a#3D
..000134#0Af_inc4a#3D..000135#0Af_dec1a#3D..000136#0A
f_dec4a#3D..000137#0A#0Af_hand.#3D..000140#0Af_unh.
.#3D..000141#0Af_raise#3D..000142#0A#0Af_module#3D.
.001150#0Af_modstart#3D.151#0Af_modend#3D..001152#0A
f_global#3D..001153#0A#0Af_const#3D..002155#0A#0Af_
lab#3D..004157#0Af_entry#3D..002158#0A#0Af_dlab#3D.
.003160#0Af_dw#3D..005161#0Af_db#3D..005162#0Af_dl#3D
..005163#0Af_ds#3D..005164#0A#0A$)#0A#0AGLOBAL.$(#0A
mialin:..001200#0Aasmout:..001201#0Astdin:..002202#0A
stdout:..001203#0A#0Ardf:..004210#0Ardp:..004211#0A
rdg:..004212#0Ardk:..004213#0Ardw:..004215#0Ardl:..
004216#0Ardc:..004218#0Ardcode:..001219#0A#0Apval:.
.003220000#0Agval:..003220001#0Akval:..003221#0Awva
l:..003220004#0Alval:..003220005#0Amval:..003220006
#0A#0Ascan:..003230#0Acvf:..004231#0Acvfp:..003232#0A
cvfg:..003233#0Acvfk:..003234#0Acvfw:..003236#0Acvf
l:..003237#0A#0Amodname:..000250#0Amodletter:251#0A
charv:..002252#0Alabnumber:253#0A$)#0A#0ALET.start(
).#3D.VALOF#0A$(.LET.argv.#3D.VEC.20#0A..1LET.v..2#3D
.VEC.20#0A..1LET.cv..1#3D.VEC.256/bytesperword#0A#0A
..1modname.:#3D.v#0A..1modname%0.:#3D.0#0A..1modlet
ter.:#3D.'A'#0A..1charv.:#3D.cv#0A..1labnumber.:#3D
.0#0A#0A..1asmout.:#3D.0#0A..1stdout.:#3D.output()#0A
..1IF.rdargs("FROM,TO/K",.argv,.20)#3D0.DO#0A..1$(.
writes("Bad.args.for.cvmial*n")#0A..4RESULTIS.20#0A
..1$)#0A..1IF.argv!0#3D0.DO.argv!0.:#3D."MIAL"#0A..
1IF.argv!1#3D0.DO.argv!1.:#3D."**"#0A..1mialin.:#3D
.findinput(argv!0)#0A..1IF.mialin#3D0.DO#0A..1$(.wr
itef("Trouble.with.file.%s*n",.argv!0)#0A..4RESULTI
S.20#0A..1$)#0A..1asmout.:#3D.findoutput(argv!1)#0A
..1#0A..1IF.asmout#3D0.DO#0A..1$(.writef("Trouble.w
ith.file.%s*n",.argv!1)#0A..4RESULTIS.20#0A..1$)#0A
..1#0A..1selectinput(mialin)#0A..1selectoutput(asmo
ut)#0A#0A..1scan()#0A..1endread()#0A..1UNLESS.asmou
t#3Dstdout.DO.endwrite()#0A..1selectoutput(stdout)#0A
#0A..1RESULTIS.0#0A$)#0A#0AAND.nextlab().#3D.VALOF#0A
{.labnumber.:#3D.labnumber+1#0A..RESULTIS.labnumber
#0A}#0A#0A//.argument.may.be.of.form.Ln#0AAND.rdcod
e(let).#3D.VALOF#0A$(.LET.a,.ch,.neg.#3D.0,.?,.FALS
E#0A#0A..1ch.:#3D.rdch().REPEATWHILE.ch#3D'*s'.|.ch
#3D'*n'#0A#0A..1IF.ch#3Dendstreamch.RESULTIS.-1#0A#0A
..1UNLESS.ch#3Dlet.DO.error("Bad.item,.looking.for.
%c.found.%c*n",.let,.ch)#0A#0A..1ch.:#3D.rdch()#0A#0A
..1IF.ch#3D'-'.DO.{.neg.:#3D.TRUE;.ch.:#3D.rdch().}
#0A#0A..1WHILE.'0'<#3Dch<#3D'9'.DO.$(.a.:#3D.10*a.+
.ch.-.'0';.ch.:#3D.rdch()..$)#0A#0A..1RESULTIS.neg.
->.-a,.a#0A$)#0A#0AAND.rdf().#3D.rdcode('F')#0AAND.
rdp().#3D.VALOF.{.pval.:#3D.rdcode('P');.RESULTIS.p
val.}#0AAND.rdg().#3D.VALOF.{.gval.:#3D.rdcode('G')
;.RESULTIS.gval.}#0AAND.rdk().#3D.VALOF.{.kval.:#3D
.rdcode('K');.RESULTIS.kval.}#0AAND.rdw().#3D.VALOF
.{.wval.:#3D.rdcode('W');.RESULTIS.wval.}#0AAND.rdl
().#3D.VALOF.{.lval.:#3D.rdcode('L');.RESULTIS.lval
.}#0AAND.rdm().#3D.VALOF.{.mval.:#3D.rdcode('M');.R
ESULTIS.mval.}#0AAND.rdc().#3D.rdcode('C')#0A#0AAND
.error(mess,.a,.b,.c).BE#0A$(.LET.out.#3D.output()#0A
..1UNLESS.out#3Dstdout.DO#0A..1$(.selectoutput(stdo
ut)#0A..4writef(mess,.a,.b,.c)#0A..4selectoutput(ou
t)#0A..1$)#0A..1writef(mess,.a,.b,.c)#0A$)#0A#0AAND
.scan().BE#0A$(.LET.op.#3D.rdf()#0A#0A..1SWITCHON.o
p.INTO#0A#0A..1$(.DEFAULT:..5error("#23.Bad.op.%n*n
",.op);.LOOP#0A#0A..4CASE.-1:..5RETURN#0A..4#0A..4C
ASE.f_lp:..3cvfp("LP").//.a.:#3D.P!n#0A..19ENDCASE#0A
..4CASE.f_lg:..3cvfg("LG").//.a.:#3D.G!n#0A..19ENDC
ASE#0A..4CASE.f_ll:..3cvfl("LL").//.a.:#3D.!Ln#0A..
19ENDCASE#0A#0A..4CASE.f_llp:..2cvfp("LLP").//.a.:#3D
.@.P!n#0A..19ENDCASE#0A..4CASE.f_llg:..2cvfg("LLG")
.//.a.:#3D.@.G!n#0A..19ENDCASE#0A..4CASE.f_ll1:..2c
vfl("LL1").//.a.:#3D.@.!Ln#0A..19ENDCASE#0A..4CASE.
f_lf:..3cvfl("LF").//.a.:#3D.byte.address.of.Ln#0A.
.19ENDCASE#0A..4CASE.f_l:..4cvfk("L").//.a.:#3D.n#0A
..19ENDCASE#0A..4CASE.f_lm:..3cvfk("LM").//.a.:#3D.
-n#0A..19ENDCASE#0A..4CASE.f_lw:..3cvfm("LW")#0A..1
9ENDCASE#0A#0A..4CASE.f_sp:..3cvfp("SP").//.P!n.:#3D
.a#0A..19ENDCASE#0A..4CASE.f_sg:..3cvfg("SG").//.G!
n.:#3D.a#0A..19ENDCASE#0A..4CASE.f_sl:..3cvfl("SL")
.//.!Ln.:#3D.a#0A..19ENDCASE#0A#0A..4CASE.f_ap:..3c
vfp("AP").//.a.:#3D.a.+.P!n#0A..19ENDCASE#0A..4CASE
.f_ag:..3cvfg("AG").//.a.:#3D.a.+.G!n#0A..19ENDCASE
#0A..4CASE.f_a:..4cvfk("A").//.a.:#3D.a.+.n#0A..19E
NDCASE#0A..4CASE.f_s:..4cvfk("S")..//.a.:#3D.a.-.n#0A
..19ENDCASE#0A#0A..4CASE.f_lkp:..2cvfkp("LKP").//.a
.:#3D.P!n!k#0A..19ENDCASE#0A..4CASE.f_lkg:..2cvfkg(
"LKG").//.a.:#3D.G!n!k#0A..19ENDCASE#0A..4CASE.f_rv
:..3cvf("RV")..//.a.:#3D.!.a#0A..19ENDCASE#0A..4CAS
E.f_rvp:..2cvfp("RVP").//.a.:#3D.P!n!a#0A..19ENDCAS
E#0A..4CASE.f_rvk:..2cvfk("RVK").//.a.:#3D.a!k#0A..
19ENDCASE#0A..4CASE.f_st:..3cvf("ST").//.!a.:#3D.b#0A
..19ENDCASE#0A..4CASE.f_stp:..2cvfp("STP").//.P!n!a
.:#3D.b#0A..19ENDCASE#0A..4CASE.f_stk:..2cvfk("STK"
).//.a!n.:#3D.b#0A..19ENDCASE#0A..4CASE.f_stkp:..1c
vfkp("STKP")..//.P!n!k.:#3D.a#0A..19ENDCASE#0A..4CA
SE.f_stkg:..1cvfkg("STKG").//.G!n!k.:#3D.a#0A..19EN
DCASE#0A..4CASE.f_xst:..2cvf("XST").//.!b.:#3D.a#0A
..19ENDCASE#0A#0A..4CASE.f_stb:..2cvf("STB").//.%b.
:#3D.a#0A..19ENDCASE#0A#0A..4CASE.f_lvind:..cvf("LV
IND").//.a.:#3D.@.b!a#0A..19ENDCASE#0A#0A..4CASE.f_
indb:..1cvf("INDB").//.a.:#3D.b.%.a#0A..19ENDCASE#0A
#0A..4CASE.f_indb0:..cvf("INDB").//.a.:#3D.%.a#0A..
19ENDCASE#0A#0A..4CASE.f_indw:..1cvf("INDW").//.a.:
#3D.b!a#0A..19ENDCASE#0A#0A..4CASE.f_k:..4cvfp("K")
.//.Call..a(b,#2E#2E1).incrementing.P.by.n#0A..19EN
DCASE#0A..4CASE.f_kpg:..2cvfpg("KPG").//.Call.Gg(a,
#2E#2E1).incrementing.P.by.n#0A..19ENDCASE#0A#0A..4
CASE.f_neg:..2cvf("NEG").//.a.:#3D.-.a#0A..19ENDCAS
E#0A..4CASE.f_not:..2cvf("NOT").//.a.:#3D.~.a#0A..1
9ENDCASE#0A..4CASE.f_abs:..2cvf("ABS").//.a.:#3D.AB
S.a#0A..19ENDCASE#0A#0A..4CASE.f_xdiv:..1cvf("XDIV"
).//.a.:#3D.a./.b#0A..19ENDCASE#0A..4CASE.f_xmod:..
1cvf("XMOD").//.a.:#3D.a.MOD.b#0A..19ENDCASE#0A..4C
ASE.f_xsub:..1cvf("XSUB").//.a.:#3D.a.-.b#0A..19END
CASE#0A#0A..4CASE.f_mul:..2cvf("MUL").//.a.:#3D.b.*
.a;.c.:#3D.?#0A..19ENDCASE#0A..4CASE.f_div:..2cvf("
DIV")..//.a.:#3D.b./.a;.c.:#3D.?#0A..19ENDCASE#0A..
4CASE.f_mod:..2cvf("MOD").//.a.:#3D.b.MOD.a;.c.:#3D
.?#0A..19ENDCASE#0A..4CASE.f_add:..2cvf("ADD").//.a
.:#3D.b.+.a#0A..19ENDCASE#0A..4CASE.f_sub:..2cvf("S
UB").//.a.:#3D.b.-.a#0A..19ENDCASE#0A#0A..4CASE.f_e
q:..3cvf("EQ").//.a.:#3D.b.#3D.a#0A..19ENDCASE#0A..
4CASE.f_ne:..3cvf("NE").//.a.:#3D.b.~#3D.a#0A..19EN
DCASE#0A..4CASE.f_ls:..3cvf("LS").//.a.:#3D.b.<.a#0A
..19ENDCASE#0A..4CASE.f_gr:..3cvf("GR").//.a.:#3D.b
.>.a#0A..19ENDCASE#0A..4CASE.f_le:..3cvf("LE").//.a
.:#3D.b.<#3D.a#0A..19ENDCASE#0A..4CASE.f_ge:..3cvf(
"GE").//.a.:#3D.b.>#3D.a#0A..19ENDCASE#0A#0A..4CASE
.f_eq0:..2cvf("EQ0").//.a.:#3D.a.#3D.0#0A..19ENDCAS
E#0A..4CASE.f_ne0:..2cvf("NE0").//.a.:#3D.a.~#3D.0#0A
..19ENDCASE#0A..4CASE.f_ls0:..2cvf("LS0").//.a.:#3D
.a.<.0#0A..19ENDCASE#0A..4CASE.f_gr0:..2cvf("GR0").
//.a.:#3D.a.>.0#0A..19ENDCASE#0A..4CASE.f_le0:..2cv
f("LE0").//.a.:#3D.a.<#3D.0#0A..19ENDCASE#0A..4CASE
.f_ge0:..2cvf("GE0").//.a.:#3D.a.>#3D.0#0A..19ENDCA
SE#0A#0A..4CASE.f_lsh:..2cvf("LSH").//.a.:#3D.b.<<.
a#0A..19ENDCASE#0A..4CASE.f_lshk:..1cvfk("LSHK").//
.a.:#3D.a.<<.k.#0A..19ENDCASE#0A..4CASE.f_rsh:..2cv
f("RSH").//.a.:#3D.b.>>.a.#0A..19ENDCASE#0A..4CASE.
f_rshk:..1cvfk("RSHK").//.a.:#3D.a.>>.k.#0A..19ENDC
ASE#0A..4CASE.f_and:..2cvf("AND").//.a.:#3D.b.&.a.#0A
..19ENDCASE#0A..4CASE.f_or:..3cvf("OR").//.a.:#3D.b
.|.a.#0A..19ENDCASE#0A..4CASE.f_xor:..2cvf("XOR")./
/.a.:#3D.b.XOR.a#0A..19ENDCASE#0A#0A..4CASE.f_xch:.
.2cvf("XCH").//.swap.a.and.b#0A..19ENDCASE#0A..4CAS
E.f_atb:..2cvf("ATB").//.b.:#3D.a#0A..19ENDCASE#0A.
.4CASE.f_atc:..2cvf("ATC").//.c.:#3D.a#0A..19ENDCAS
E#0A..4CASE.f_cta:..2cvf("CTA").//.a.:#3D.c#0A..19E
NDCASE#0A..4CASE.f_bta:..2cvf("BTA").//.a.:#3D.b#0A
..19ENDCASE#0A..4CASE.f_btc:..2cvf("BTC").//.c.:#3D
.b#0A..19ENDCASE#0A..4CASE.f_atblp:..cvfp("ATBLP").
//.b.:#3D.a;.a.:#3D.P!n#0A..19ENDCASE#0A..4CASE.f_a
tblg:..cvfg("ATBLG").//.b.:#3D.a;.a.:#3D.G!n#0A..19
ENDCASE#0A..4CASE.f_atbl:..1cvfk("ATBL").//.b.:#3D.
a;.a.:#3D.k#0A..19ENDCASE#0A#0A..4CASE.f_j:..4cvfl(
"J").//.jump.to.Ln#0A..19ENDCASE#0A..4CASE.f_rtn:..
2cvf("RTN").//.procedure.return#0A..19ENDCASE#0A#0A
..4CASE.f_ikp:..2cvfkp("IKP").//.a.:#3D.P!n.+.k;.P!
n.:#3D.a#0A..19ENDCASE#0A..4CASE.f_ikg:..2cvfkg("IK
G").//.a.:#3D.G!n.+.k;.G!n.:#3D.a#0A..19ENDCASE#0A.
.4CASE.f_ikl:..2cvfkl("IKL").//.a.:#3D.!Ln.+.k;.!Ln
.:#3D.a#0A..19ENDCASE#0A..4CASE.f_ip:..3cvfp("IP").
//.a.:#3D.P!n.+.a;.P!n.:#3D.a#0A..19ENDCASE#0A..4CA
SE.f_ig:..3cvfg("IG").//.a.:#3D.G!n.+.a;.G!n.:#3D.a
#0A..19ENDCASE#0A..4CASE.f_il:..3cvfl("IL").//.a.:#3D
.!Ln.+.a;.!Ln.:#3D.a#0A..19ENDCASE#0A#0A..4CASE.f_j
eq:..2cvfl("JEQ").//.Jump.to.Ln.if.b.#3D.a#0A..19EN
DCASE#0A..4CASE.f_jne:..2cvfl("JNE").//.Jump.to.Ln.
if.b.~#3D.a#0A..19ENDCASE#0A..4CASE.f_jls:..2cvfl("
JLS").//.Jump.to.Ln.if.b.<.a#0A..19ENDCASE#0A..4CAS
E.f_jgr:..2cvfl("JGR").//.Jump.to.Ln.if.b.>.a#0A..1
9ENDCASE#0A..4CASE.f_jle:..2cvfl("JLE").//.Jump.to.
Ln.if.b.<#3D.a#0A..19ENDCASE#0A..4CASE.f_jge:..2cvf
l("JGE").//.Jump.to.Ln.if.b.>#3D.a#0A..19ENDCASE#0A
#0A..4CASE.f_jeq0:..1cvfl("JEQ0").//.Jump.to.Ln.if.
a.#3D.0#0A..19ENDCASE#0A..4CASE.f_jne0:..1cvfl("JNE
0").//.Jump.to.Ln.if.a.~#3D.0#0A..19ENDCASE#0A..4CA
SE.f_jls0:..1cvfl("JLS0").//.Jump.to.Ln.if.a.<.0#0A
..19ENDCASE#0A..4CASE.f_jgr0:..1cvfl("JGR0").//.Jum
p.to.Ln.if.a.>.0#0A..19ENDCASE#0A..4CASE.f_jle0:..1
cvfl("JLE0").//.Jump.to.Ln.if.a.<#3D.0#0A..19ENDCAS
E#0A..4CASE.f_jge0:..1cvfl("JGE0").//.Jump.to.Ln.if
.a.>#3D.0#0A..19ENDCASE#0A#0A..4//.The.following.fi
ve.opcodes.are.never.generated.by#0A..4//.the.BCPL.
compiler#0A..4CASE.f_brk:..2cvf("BRK").//.Breakpoin
t.instruction#0A..19ENDCASE#0A..4CASE.f_nop:..2cvf(
"NOP").//.No.operation#0A..19ENDCASE#0A..4CASE.f_ch
gco:..cvf("CHGCO").//.Change.coroutine#0A..19ENDCAS
E#0A..4CASE.f_mdiv:..1cvf("MDIV").//.a.:#3D.Muldiv(
P!3,.P!4,.P!5).#0A..19ENDCASE#0A..4CASE.f_sys:..2cv
f("SYS").//.System.function#0A..19ENDCASE#0A#0A..4C
ASE.f_module:..1cvfs("MODULE").//.Name.of.section#0A
..21FOR.i.#3D.0.TO.charv%0.DO.modname%i.:#3D.charv%
i#0A..21ENDCASE#0A..4CASE.f_modstart:.cvf("MODSTART
").//.Start.of.module..#0A..21modname%0.:#3D.0#0A..
21ENDCASE#0A..4CASE.f_modend:..1cvf("MODEND").//.En
d.of.module.#0A..21modletter.:#3D.modletter+1#0A..2
1ENDCASE#0A..4CASE.f_global:..1cvglobal().//.Global
.initialisation.data#0A..21ENDCASE#0A..4CASE.f_cons
t:..2cvconst().//.Large.integer.constant#0A..21ENDC
ASE#0A..4CASE.f_lab:..4cvfl("LAB").//.Program.label
#0A..21ENDCASE#0A..4CASE.f_entry:..2cventry().//.St
art.of.a.function#0A..21ENDCASE#0A#0A..4CASE.f_dlab
:..3cvfl("DLAB").//.Static.data.label#0A..21ENDCASE
#0A..4CASE.f_dw:..5cvfw("DW").//.Static.data.word#0A
..21ENDCASE#0A..4CASE.f_db:..5cvfk("DB").//.Static.
data.byte#0A..21ENDCASE#0A..4CASE.f_dl:..5cvfl("DL"
).//.Static.data.word.pointer#0A..21ENDCASE#0A..4CA
SE.f_ds:..5cvfk("DS").//.Static.data.space#0A..21EN
DCASE#0A#0A..4CASE.f_inc1b:..2cvf("INC1B")..1//.a.:
#3D.++(!a)#0A..21ENDCASE#0A..4CASE.f_inc4b:..2cvf("
INC4B")..1//.a.:#3D.++1(!a)#0A..21ENDCASE#0A..4CASE
.f_dec1b:..2cvf("DEC1B")..1//.a.:#3D.--(!a)#0A..21E
NDCASE#0A..4CASE.f_dec4b:..2cvf("DEC4B")..1//.a.:#3D
.--1(!a)#0A..21ENDCASE#0A..4CASE.f_inc1a:..2cvf("IN
C1A")..1//.a.:#3D.(!a)++#0A..21ENDCASE#0A..4CASE.f_
inc4a:..2cvf("INC4A")..1//.a.:#3D.(!a)++1#0A..21END
CASE#0A..4CASE.f_dec1a:..2cvf("DEC1A")..1//.a.:#3D.
(!a)--#0A..21ENDCASE#0A..4CASE.f_dec4a:..2cvf("DEC4
A")..1//.a.:#3D.(!a)--1#0A..21ENDCASE#0A#0A..4CASE.
f_unh:..4cvf("UNH")..1//.h.:#3D.h!1#0A..21ENDCASE#0A
#0A..4CASE.f_hand:..3cvfl("HAND").//.a!0,.a!1,.a!2.
:#3D.P,.H,.Ln#0A..34//.H.:#3D.a#0A..21ENDCASE#0A#0A
..4CASE.f_raise:..2cvf("RAISE").//.LET.p,h,l.:#3D.H
!0,.H!1,.H!2#0A..34//.H!0,.H!1,.H!2.:#3D.a,.b,.c#0A
..34//.P,.H.:#3D.p,.h#0A..34//.GOTO.l#0A..21ENDCASE
#0A#0A..1$)#0A#0A..1newline()#0A$).REPEAT#0A#0AAND.
cvf(s)..1BE.writef("%s",.s)#0AAND.cvfp(s)..BE.write
f("%t7.P%n",.s,.rdp())#0AAND.cvfkp(s).BE.writef("%t
7.K%n.P%n",.s,.rdk(),.rdp())#0AAND.cvfg(s)..BE.writ
ef("%t7.G%n",.s,.rdg())#0AAND.cvfkg(s).BE.writef("%
t7.K%n.G%n",.s,.rdk(),.rdg())#0AAND.cvfkl(s).BE.wri
tef("%t7.K%n.L%n",.s,.rdk(),.rdl())#0AAND.cvfpg(s).
BE.writef("%t7.P%n.G%n",.s,.rdp(),.rdg())#0AAND.cvf
k(s)..BE.writef("%t7.K%n",.s,.rdk())#0AAND.cvfw(s).
.BE.writef("%t7.W%n",.s,.rdw())#0AAND.cvfl(s)..BE.w
ritef("%t7.L%n",.s,.rdl())#0AAND.cvfm(s)..BE.writef
("%t7.M%n",.s,.rdm())#0A#0AAND.cvglobal().BE#0A$(.L
ET.n.#3D.rdk()#0A..1writef("GLOBAL.K%n*n",.n)#0A..1
IF.modname%0#3D0.FOR.i.#3D.0.TO.4.DO.modname%i.:#3D
."prog"%i#0A..1FOR.i.#3D.1.TO.n.DO#0A..1$(.LET.g.#3D
.rdg()#0A..4LET.n.#3D.rdl()#0A..4writef("G%n.L%n*n"
,.g,.n)#0A..1$)#0A..1writef("G%n",.rdg())#0A$)#0A#0A
AND.rdchars().#3D.VALOF#0A{.LET.n.#3D.rdk()#0A..cha
rv%0.:#3D.n#0A..FOR.i.#3D.1.TO.n.DO.charv%i.:#3D.rd
c()#0A..RESULTIS.n#0A}#0A#0AAND.cvconst().BE#0A$(.L
ET.lab.#3D.rdm()#0A..1LET.w.#3D.rdw()#0A..1writef("
CONST..1M%n.W%n",.lab,.w)#0A$)#0A#0AAND.cvfs(s).BE#0A
$(.LET.n.#3D.rdchars()#0A..1writef("%t7.K%n",.s,.n)
#0A..1FOR.i.#3D.1.TO.n.DO.writef(".C%n",.charv%i)#0A
$)#0A#0AAND.cventry().BE#0A$(.LET.n.#3D.rdchars()#0A
..1LET.op.#3D.rdf()#0A..1LET.lab.#3D.rdl()#0A..1wri
tef("*nEntry.to:.%s*n",.charv)#0A..1writef("%t7.K%n
",."ENTRY",.n)#0A..1FOR.i.#3D.1.TO.n.DO.writef(".C%
n",.charv%i)#0A..1newline()#0A..1TEST.op#3Df_lab.TH
EN.writef("LAB..3L%n*n",.lab)#0A..15ELSE.writef("Ba
d.op.F%n.L%n*n",.op,.lab)#0A$)#0A#0A3

######com/mkxref.b#
/*#0AThis.program.takes.the.output.produced.by.the.
xref.compiler.option#0Asorts.it,.removes.duplicate.
lines.and.only.keeps.lines.that.match#0Aa.given.pat
tern#2E#0A#0AImplemented.in.BCPL.by.Martin.Richards
.(c).May.2000006#0A#0AUsage:..mkxref."FROM/A,TO/K,P
AT/K"#0Aie:..3mkxref.[from].data.[to.result].[pat.p
attern].#0A#0Aeg:..3mkref.xreflines.to.xrefdata.pat
.(F/S/G/M):.#0A#0AThe.pattern.in.a.regular.expressi
on.with.the.following.syntax:#0A#0AE.->.<ch>..14Mat
ches.characters.other.than.(,),',?,%,/,#23#0A..3'<c
h>..13Match.any.given.character#0A..3?..17Match.any
.character#0A..3%..17Match.a.null.string#0A..3E./.E
..13Alternation#0A..3E.E..15Concatenation#0A..3#23.
E..15Zero.or.more.repetitions.of.E#0A..3(.E.)..13Ov
erride.normal.precedence#0A#0AThe.default.output.is
.to.the.standard.output.stream#2E#0A*/#0A#0AGET."li
bhdr"#0A#0AGLOBAL.{#0Ablklist:.ug..2//.List.of.bloc
ks.of.store.to.hold.the#0A..13//.splay.tree.nodes#2E
#0Ablk..10//.Start.of.the.current.block#0Ablkp..9//
.Pointer.to.start.position.of.the.next.splay.tree.n
ode#2E#0Ablkt..9//.End.of.current.block.--.blkp.mus
t.be.less.than.blkt#0Aroot..9//.Root.node.of.the.sp
lay.tree#2E#0A#0Astdin..8//.The.standard.input.stre
am#0Astdout..7//.The.standard.output.stream#0Ainstr
eam..5//.The.data.input.stream#0Aoutstream..4//.The
.output.stream.for.the.result#0A#0A//.Pattern.match
er.globals#0Awork#0Awp#0Asuccflag#0Apattern#0Aaux#0A
ch#0Apatp#0Apatlen#0Aerrflag#0A}#0A#0AMANIFEST.{#0A
.//.Positions.in.a.splay.tree.node#2E#0A.t_parent#3D
0..#0A.t_left#0A.t_right#0A.t_string#0A#0A.blkupb#3D
1002..//.UPB.of.each.block#0A}#0A#0A//.The.pattern.
match.interpreter#0A#0ALET.match(str).#3D.VALOF#0A{
.LET.w.#3D.VEC.128#0A..LET.s.#3D.0#0A..work,.wp,.su
ccflag.:#3D.w,.0,.FALSE#0A..put(1)#0A..UNLESS.aux%0
#3D0.DO.put(aux%0)#0A#0A..{.//.FIRST.COMPLETE.THE.C
LOSURE#0A..2LET.n.#3D.1#0A..2UNTIL.n>wp.DO#0A..2{.L
ET.p.#3D.work!n#0A..4LET.k,.q.#3D.pattern%p,.aux%p#0A
..4SWITCHON.k.INTO#0A..4{.CASE.'#23':.put(p+1)#0A..
6CASE.'%':.put(q)#0A..6DEFAULT:..ENDCASE#0A..6CASE.
'(':#0A..6CASE.'/':.put(p+1)#0A..16UNLESS.q#3D0.DO.
put(q)#0A..4}#0A..4n.:#3D.n+1#0A..2}#0A#0A..2IF.s>#3D
str%0.RESULTIS.succflag#0A..2IF.wp#3D0.RESULTIS.FAL
SE#0A..2s.:#3D.s+1#0A..2ch.:#3D.str%s#0A#0A..2//.NO
W.DEAL.WITH.MATCH.ITEMS#0A..2n.:#3D.wp#0A..2wp,.suc
cflag.:#3D.0,.FALSE#0A#0A..2FOR.i.#3D.1.TO.n.DO#0A.
.2{.LET.p.#3D.work!i#0A..4LET.k.#3D.pattern%p#0A..4
SWITCHON.k.INTO#0A..4{.CASE.'#23':#0A..6CASE.'/':#0A
..6CASE.'%':#0A..6CASE.'(':.LOOP#0A#0A..6CASE.'*'':
IF.ch#3Dpattern%(p+1).DO.put(aux%p)#0A..16LOOP#0A..
6DEFAULT:..//.A.MATCH.ITEM#0A..16UNLESS.ch#3Dk.LOOP
#0A..6CASE.'?':.//.SUCCESSFUL.MATCH#0A..16put(aux%p
)#0A..16LOOP#0A..4}#0A..2}#0A..}.REPEAT#0A}#0A#0AAN
D.put(n).BE.TEST.n#3D0#0A..2THEN.succflag.:#3D.TRUE
#0A..2ELSE.{.FOR.i.#3D.1.TO.wp.IF.work!i#3Dn.RETURN
#0A..9wp.:#3D.wp+1#0A..9work!wp.:#3D.n#0A..7}#0A#0A
//.The.Compiler#0A#0ALET.rch().BE.TEST.patp>#3Dpatl
en#0A..2THEN.ch.:#3D.endstreamch#0A..2ELSE.{.patp.:
#3D.patp+1#0A..9ch.:#3D.pattern%patp#0A..7}#0A#0AAN
D.nextitem().BE#0A..2{.IF.ch#3D'*''.DO.rch()#0A..4r
ch()#0A..2}#0A#0AAND.prim().#3D.VALOF#0A{.LET.a,.op
.#3D.patp,.ch#0A..nextitem()#0A..SWITCHON.op.INTO#0A
..{.CASE.endstreamch:#0A..2CASE.')':#0A..2CASE.'/':
.errflag.:#3D.TRUE#0A..2DEFAULT:..RESULTIS.a#0A#0A.
.2CASE.'#23':.setexits(prim(),.a)#0A..12RESULTIS.a#0A
#0A..2CASE.'(':.a.:#3D.exp(a)#0A..12UNLESS.ch#3D')'
.DO.errflag.:#3D.TRUE#0A..12nextitem()#0A..12RESULT
IS.a#0A..}#0A}#0A#0AAND.exp(altp).#3D.VALOF#0A{.LET
.exits.#3D.0#0A#0A..{.LET.a.#3D.prim()#0A..2TEST.ch
#3D'/'.|.ch#3D')'.|.ch#3Dendstreamch#0A..2THEN.{.ex
its.:#3D.join(exits,a)#0A..9UNLESS.ch#3D'/'.RESULTI
S.exits#0A..9aux%altp.:#3D.patp#0A..9altp.:#3D.patp
#0A..9nextitem()#0A..7}#0A..2ELSE.setexits(a,.patp)
#0A..}.REPEAT#0A}#0A#0A1AND.setexits(list,val).BE.U
NTIL.list#3D0.DO#0A{.LET.a.#3D.aux%list#0A..aux%lis
t.:#3D.val#0A..list.:#3D.a#0A}#0A#0AAND.join(a,b).#3D
.VALOF#0A{.LET.t.#3D.a#0A..IF.a#3D0.RESULTIS.b#0A..
UNTIL.aux%a#3D0.DO.a.:#3D.aux%a#0A..aux%a.:#3D.b#0A
..RESULTIS.t#0A}#0A#0AAND.cmplpat().#3D.VALOF#0A{.p
atp,.patlen.:#3D.0,.pattern%0#0A..errflag.:#3D.FALS
E#0A..FOR.i.#3D.0.TO.patlen.DO.aux%i.:#3D.0#0A..rch
()#0A..setexits(exp(0),0)#0A..RESULTIS.NOT.errflag#0A
}#0A#0ALET.start().#3D.VALOF#0A{.LET.argv.#3D.VEC.1
00#0A..LET.form.#3D."FROM/A,TO/K,PAT/K"#0A#0A..blkl
ist,.blk,.blkp,.blkt.:#3D.0,.0,.0,.0#0A#0A..stdin.:
#3D.input()#0A..stdout.:#3D.output()#0A..instream,.
outstream.:#3D.0,.0#0A#0A..UNLESS.rdargs(form,.argv
,.100).DO#0A..{.writef("Bad.arguments.for:.mkxref.%
s*n",.form)#0A..2RESULTIS.0#0A..}#0A#0A..instream.:
#3D.findinput(argv!0)..5//.FROM#0A..UNLESS.instream
.DO#0A..{.writef("Unable.to.open:.%s*n",.argv!0)#0A
..2GOTO.fin#0A..}#0A#0A..outstream.:#3D.stdout#0A..
IF.argv!1.DO..22//.TO#0A..{.outstream.:#3D.findoutp
ut(argv!1)#0A..2UNLESS.instream.DO#0A..2{.writef("U
nable.to.open:.%s*n",.argv!1)#0A..4GOTO.fin#0A..2}#0A
..}#0A#0A..blk.:#3D.getvec(blkupb)#0A..UNLESS.blk.D
O#0A..{.writef("More.memory.needed*n")#0A..2GOTO.fi
n#0A..}#0A..!blk.:#3D.0#0A..blklist.:#3D.blk#0A#0A.
.pattern.:#3D.0..7//.Zero.unless.a.pattern.is.given
#0A#0A..IF.argv!2.DO..23//.PAT#0A..{.//.Allocate.pa
ttern.and.aux#0A..2LET.pat.#3D.argv!2#0A..2//.Calcu
late.the.upb.of.pattern.and.aux.in.words,.allowing#0A
..2//.for.the.added.#23?s.at.each.end#2E#0A..2LET.w
len.#3D.(2.+.pat%0.+.2)/bytesperword#0A..2pattern.:
#3D.@blk!1#0A..2aux..3:#3D.pattern+wlen+1#0A..2blkp
..2:#3D.aux+wlen+1#0A#0A..2//.Form.#23?<pat>#23?.in
.pattern#0A..2pattern%0.:#3D.0#0A..2appendstring("#23
?",.pattern).#0A..2appendstring(pat,..pattern).#0A.
.2appendstring("#23?",.pattern)#0A#0A..2UNLESS.cmpl
pat(pattern,.aux).DO#0A..2{.writef("Error.in.the.pa
ttern:.%s*n",.pat)#0A..4GOTO.fin#0A..2}#0A..}#0A#0A
..selectinput(instream)#0A..selectoutput(outstream)
#0A#0A..root.:#3D.readdata()#0A..writetree(root)#0A
//..match(pattern,.aux,.str)#0A#0Afin:#0A#0A..IF.in
stream.DO.endstream(instream)#0A..selectinput(stdin
)#0A..IF.outstream.&.stdout~#3Doutstream.DO.endstre
am(outstream)#0A..selectoutput(stdout)#0A#0A..WHILE
.blklist.DO#0A..{.LET.p.#3D.!blklist#0A..2freevec(b
lklist)#0A..2blklist.:#3D.p#0A..}#0A..RESULTIS.0#0A
}#0A#0AAND.appendstring(s1,.s2).BE#0A{.LET.len1.#3D
.s1%0#0A..LET.len2.#3D.s2%0#0A..FOR.i.#3D.1.TO.len1
.DO#0A..{.len2.:#3D.len2+1#0A..2s2%len2.:#3D.s1%i#0A
..}#0A..s2%0.:#3D.len2#0A}#0A#0AAND.readdata().#3D.
VALOF#0A{.root.:#3D.0#0A..WHILE.readline(@blk!t_str
ing).DO#0A..{#0A..2writef("readline#3D>%s*n",.@blk!
t_string)#0A..}#0A..RESULTIS.0#0A}#0A#0AAND.readlin
e(str).#3D.VALOF#0A{.LET.ch.#3D.rdch()#0A..LET.len.
#3D.0#0A..UNTIL.ch#3Dendstreamch.|.ch#3D'*n'.DO#0A.
.{.len.:#3D.len+1#0A..2IF.len>255.RESULTIS.FALSE#0A
..2str%len.:#3D.ch#0A..2ch.:#3D.rdch()#0A..}#0A..st
r%0.:#3D.len#0A..IF.ch#3D'*n'.&.len.RESULTIS.TRUE#0A
..IF.ch#3Dendstreamch.&.len#3D0.RESULTIS.FALSE#0A}.
REPEAT#0A#0AAND.writetree(t).BE.WHILE.t.DO#0A{.writ
et(t!t_left)#0A..writef("%s*b",.@t!t_string)#0A..t.
:#3D.t!t_right#0A}#0A#0A

######com/n2bin.b#
GET."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.LET.std
in.#3D.input()#0A..LET.stdout.#3D.output()#0A..LET.
argv.#3D.VEC.50#0A..LET.inname,.instream.#3D."data"
,.0#0A..LET.outname,.outstream.#3D."res",.0#0A..LET
.length.#3D.0#0A..LET.started.#3D.FALSE#0A#0A..UNLE
SS.rdargs("FROM/A,TO/K",.argv,.50).DO#0A..{.writef(
"Bad.arguments.for.N2BIN*n")#0A..2RESULTIS.0#0A..}#0A
#0A..IF.argv!0.DO.inname..:#3D.argv!0#0A..IF.argv!1
.DO.outname.:#3D.argv!1#0A#0A..instream.:#3D.findin
put(inname)#0A..outstream.:#3D.findoutput(outname)#0A
#0A..UNLESS.instream.DO#0A..{.writef("Cannot.open.f
ile.%s*n",.inname)#0A..2GOTO.fin#0A..}#0A#0A..UNLES
S.outstream.DO#0A..{.writef("Cannot.open.file.%s*n"
,.outname)#0A..2GOTO.fin#0A..}#0A#0A..selectinput(i
nstream)#0A..selectoutput(outstream)#0A#0A..{.LET.c
h.#3D.rdch()#0A..2IF.'0'<#3Dch<#3D'9'.DO#0A..2{.LET
.val.#3D.0#0A..4WHILE.'0'<#3Dch<#3D'9'.DO#0A..4{.va
l.:#3D.10*val.+.ch.-.'0'#0A..6ch.:#3D.rdch()#0A..4}
#0A#0A..4IF.val#3D23456.BREAK..14//.End.marker#0A#0A
..4IF.started.DO#0A..4{.binwrch(val)#0A..6length.:#3D
.length.+.1#0A..4}#0A..4IF.val#3D12345.DO.started.:
#3D.TRUE..1//.Begin.marker#0A..2}#0A..2IF.ch#3Dends
treamch.BREAK#0A..}.REPEAT#0A#0Afin:#0A..IF.instrea
m..UNLESS.instream#3Dstdin..1DO.endstream(instream)
#0A..IF.outstream.UNLESS.outstream#3Dstdout.DO.ends
tream(outstream)#0A..selectinput(stdin)#0A..selecto
utput(stdout)#0A#0A..writef("%s.length.%n.#3D>.%s.w
ritten*n",.inname,.length,.outname)#0A..RESULTIS.0#0A
}#0A

######com/n-bin.b#
//.This.is.a.program.convert.a.file.numbers.in.ASCI
I.to.back.to.a.binary.file#2E#0A//.It.is.the.invers
e.of.bin-n#2Eb#2Eb#0A#0A//.Implemented.by.Martin.Ri
chards.(c).Sept.2000006#0A#0A//.Usage:#0A#0A//.hex2
bin.filename.[[TO].tofile]#0A#0A/*#0AIt.will.conver
t.the.file:#0A#0A..00165..00166..00167..00168..0016
9..00170..00171..00172#0A..00173..00174..00175..001
76..00177..00178..00179..00180#0A..00181..00182..00
183..00184..00185..00186..00187..00188#0A..00189..0
0190..00110..00149..00150..00151..00152..00153#0A..
00154..00155..00156..00157..00148..00110#0A#0Ato:#0A
#0AABCDEFGHIJKLMNOPQRSTUVWXYZ#0A1234567890#0A*/#0A#0A
GET."libhdr"#0A#0AGLOBAL.{#0A.eof:.ug#0A.sysin#0A.s
ysout#0A.fromname#0A.toname#0A.fromstream#0A.tostre
am#0A.count#0A}#0A#0ALET.start().#3D.VALOF#0A{.LET.
argv..2#3D.VEC.50#0A..sysin..4:#3D.input()#0A..syso
ut..3:#3D.output()#0A..fromname..1:#3D.0#0A..toname
..3:#3D."JUNK"#0A..fromstream.:#3D.0#0A..tostream..
1:#3D.0#0A..count..4:#3D.0#0A#0A..UNLESS.rdargs("FR
OM/A,TO/K",.argv,.50).DO#0A..{.writes("bad.argument
s.for.n-bin*n")#0A..2stop(20)#0A..}#0A#0A..fromname
.:#3D.argv!0..20//.FROM#0A..IF.argv!1.DO.toname..1:
#3D.argv!1..7//.TO#0A.#0A..fromstream.:#3D.findinpu
t(fromname)#0A..UNLESS.fromstream.DO#0A..{.writef("
can't.open.%s*n",.fromname)#0A..2stop(20)#0A..}#0A#0A
..tostream.:#3D.findoutput(toname)#0A..UNLESS.tostr
eam.DO#0A..{.writef("can't.open.%s*n",.toname)#0A..
2endread()#0A..2stop(20)#0A..}#0A..selectoutput(tos
tream)#0A#0A..selectinput(fromstream)#0A#0A..{.LET.
byte.#3D.readn()#0A..2IF.byte#3D0.&.result2<0.BREAK
#0A..2wrch(byte)#0A..2count.:#3D.count+1#0A..}.REPE
AT#0A#0A..endread()#0A#0A..UNLESS.sysout#3Dtostream
.DO.endwrite()#0A#0A..selectoutput(sysout)#0A..writ
ef("%n.bytes.written.to.file.*"%s*"*n",.count,.tona
me)#0A..RESULTIS.0#0A}#0A#0A1

######com/nlconv.b#
GET."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.LET.arg
v.#3D.VEC.50#0A..LET.infile.#3D.0#0A..LET.outfile.#3D
.0#0A..LET.nl.#3D.nlunix#0A..LET.ch.#3D.0#0A#0A..UN
LESS.rdargs("FILE,TOUNIX/S,TODOS/S,Q/S",.argv,.50).
DO#0A..{.writes("Bad.arguments.for.NLCONV*n")#0A..2
RESULTIS.20#0A..}#0A#0A..UNLESS.argv!0.DO#0A..{.LET
.w(s).#3D.writef("%s*n",.s)#0A..2w("nlconv.FILE,TOU
NIX/S,TODOS/S,Q/S")#0A..2newline()#0A..2w("This.rep
laces.each.end-of-line.mark.in.the.given.file.(FILE
).by")#0A..2w("..2LF..6if.TOUNIX.specified.(the.def
ault)")#0A..2w("..2CR.LF..3if.TODOS..specified")#0A
..2newline()#0A..2w("On.input,.CR.LF,.CR,.LF.CR.and
.LF.are.all.end-of-line.marks")#0A..2newline()#0A..
2w("Q.quietens.nlconv")#0A..2RESULTIS.0#0A..}#0A.#0A
..infile.:#3D.findinput(argv!0)..#0A..UNLESS.infile
.DO#0A..{.writef("Trouble.with.file.%s*n",.argv!0)#0A
..2RESULTIS.20#0A..}#0A..selectinput(infile)#0A..ou
tfile.:#3D.findoutput("TEMPFILE")#0A..UNLESS.outfil
e.DO#0A..{.writef("Cannot.open.TEMPFILE")#0A..2endr
ead()#0A..2RESULTIS.20#0A..}#0A#0A..IF.argv!2.DO.nl
.:#3D.nldos#0A#0A..UNLESS.argv!3.TEST.nl#3Dnlunix#0A
..14THEN.writef("Converting.EOLs.to.LFs*n")#0A..14E
LSE.writef("Converting.EOLs.to.CR.LFs*n")#0A#0A..se
lectoutput(outfile)#0A#0A..ch.:#3D.rdch()#0A#0A..{.
SWITCHON.ch.INTO#0A..2{.DEFAULT:.wrch(ch)#0A..13ch.
:#3D.rdch()#0A..13LOOP#0A..4CASE.endstreamch:#0A..1
3BREAK#0A..4CASE.13:.ch.:#3D.rdch().#0A..13IF.ch#3D
10.DO.ch.:#3D.rdch()#0A..13nl()#0A..13LOOP#0A..4CAS
E.10:.ch.:#3D.rdch().#0A..13IF.ch#3D13.DO.ch.:#3D.r
dch()#0A..13nl()#0A..13LOOP#0A..2}#0A..}.REPEAT#0A#0A
..endread()#0A..endwrite()#0A..renamefile("TEMPFILE
",.argv!0)#0A..RESULTIS.0#0A}#0A#0AAND.nlunix().BE.
wrch(10)..14//.LF#0A#0AAND.nldos().BE.{.wrch(13);.w
rch(10).}..1//.CR.LF#0A

######com/pal70.b#
/*#0A#23#238.UNDER.EARLY.STAGE.OF.DEVELOPMENT.#23#23
11#0A#0AThis.is.a.compiler.and.interpreter.for.the.
language.PAL#0Aimplemented.in.BCPL#2E#0A#0A(c).Mart
in.Richards.21.Oct.2010#0A#0AUsage:#0A#0Apal.."PROG
/A,TO#3D-o/K,TOKENS#3D-l/S,TREE#3D-p/S,CODE#3D-c/S,
TRACE#3D-t/S"#0A#0A..1PROG..1gives.the.filename.of.
the.PAL.program.to.run,.eg.test#2Epal#0A-o.TO..3giv
es.the.filename.of.the.output#0A-l.TOKENS.is.a.swit
ch.to.test.the.lexical.analyser#0A-p.TREE..1causes.
the.parse.tree.to.be.output#0A-c.CODE..1outputs.the
.compiled.blackboard.evaluator.code#0A-t.TRACE..Tra
ces.the.execution.of.the.blackboard.evaluator#2E#0A
#0A00021/10/2010#0AStarted.modifying.this.compiler.
to.make.it.follow.the.syntax.and#0APOCODE.of.the.Pa
l70.compiler.whose.original.compiler.listing.is.in#0A
doc/pal70-mabee-17jun70#2Epdf#0A#0A00008/07/2010#0A
Started.to.modify.lex.and.syn.to.agree.with.the.PAL
.syntax.specified#0Ain.Appendix.2#2E1.(dated.02/17/
68).with.the.following.minor.extensions#2E#0A#0AThe
.operators.~#3D,.<#3D.and.>#3D.are.included#2E#0A(.
and.[.are.synonyms.as.are.).and.]#2E#0A->.and.-*.ar
e.synonyms#2E#0A~.and.not.are.synonyms#2E#0A#0A0001
4/06/2010#0ALex.more.or.less.complete,.now.working.
on.the.syntax.analyser#2E#0A#0A00009/06/2010#0AStar
ted.re-implementation.of.PAL.based.on.VSPL#2E#0A#0A
*/#0A#0A1GET."libhdr"#0A.#0AMANIFEST.{#0A//.Selecto
rs#0Ah1#3D0;.h2#3D1;.h3#3D2;.h4#3D3;.h5#3D4;.h6#3D5
#0A#0A//.Syntactic.operators#0ABar#3D1;.Eof;.Where;
.Dot#0ALparen;.Rparen;.In;.Percent#0AIfso;.Ifnot;.D
o#0A#0A//.AE.Tree.nodes#0ADef;.Let;.Lambda;.Valof;.
Test#0AIf;.While;.Ass#0ASeq;.Colon#0ANoshare;.Cond#0A
Comma;.Valdef#0ARec;.And;.Within#0AMpt;.Paren#0A#0A
//.AE.nodes.and.POCODE.symbols#0AGoto;.Res#0ANot;.N
il;.Stringconst;.Name#0APlus;.Minus#0AAug;.Logor;.L
ogand#0AEq;.Ne;.Lt;.Le;.Gt;.Ge#0AMult;.Div;.Power#0A
Pos;.Neg;.Apply#0A#0A//.POCODE.symbols#0ALoadL;.Loa
dR;.LoadE;.LoadS;.LoadN;.LoadF;.LoadJ#0ARestoreE1;.
LoadGuess#0AFormClosure;.FormLvalue;.FormRvalue#0AM
embers#0AJump;.JumpF;.Save;.Return#0ATestEmpty;.Los
e1;.Update#0ADeclname;.Declnames;.Initname;.Initnam
es#0ADecllabel;.SetlabEs;.Blocklink;.Reslink#0ASetu
p;.Halt#0AInteger;.Lab;.Param;.Equ#0A#0A//.AE.nodes
,.POCODE.symbols.and.run-time.node.types#0ADummy;.J
j;.True;.False;.Int;.Real;.Sys#0ANumber;.Tuple#0A#0A
//.Translation.symbols#0AVal#3D0;.Ref#0A#0A//.Libra
ry.functions#0ASys_isboolean#3D1#0ASys_isstring#0AS
ys_isfunction#0ASys_isprogramclosure#0ASys_islabel#0A
Sys_istuple#0ASys_isreal#0ASys_isinteger#0ASys_stem
#0ASys_stern#0ASys_conc#0ASys_itor#0ASys_rtoi#0ASys
_stoi#0ASys_lookupinj#0ASys_order#0ASys_print#0ASys
_readch#0ASys_atom#0ASys_null#0ASys_share#0A}#0A.#0A
GLOBAL.{.#0Arec_p:ug;.rec_l;.fin_p;.fin_l#0Afataler
r;.synerr;.trnerr;.errcount;.errmax#0Aprogstream;.t
ostream#0Amk1;.mk2;.mk3;.mk4;.mk5;.mk6#0Anewvec;.tr
eep;.treevec#0AoptTokens;.optTree;.optCode;.optTrac
e#0A#0A//.Globals.used.in.LEX#0Achbuf;.charv;.ch;.r
ch;.lex#0Atoken;.lexval;.exponent;.wordnode#0Anilno
de;.truenode;.falsenode;.dummynode;.mptnode#0Awrchb
uf;.chcount;.lineno#0Adsw;.declsyswords;.namestart;
.nametable;.lookupword#0Ardnumber;.rdstrch;.rdtag#0A
#0A//.Globals.used.in.SYN#0Acheckfor;.rdprog#0Ardna
melist;.rname#0Ardnbdef;.rbdef;.rndef;.rdef#0Aformt
ree;.plist#0Arnexp;.rexp;.rnbexp;.rbexp#0Arncom;.rc
om;.rbcom#0A#0A//.Globals.used.in.TRN.and.the.inter
preter#0A.#0Atrnext:300;.trprog;.trdef;.trans#0Afin
dlabels;.translabels;.transrhs#0Aloaddefinee;.declg
uesses;.initnames;.transscope#0Amapb;.mapf;.length;
.upssp#0Atrcom;.decldyn#0Adeclstatnames;.checkdisti
nct;.addname;.cellwithname#0Atrdecl;.jumpcond#0Aass
ign;.load;.fnbody;.loadlist;.transname#0Advec;.dvec
e;.dvecp;.dvect#0Acomline;.procname;.resultlab;.ssp
;.msp#0Aoutf;.outname;.outstring;.outfv;.outfn;.out
fsl#0Aoutfnn;.outfl;.outfs;.outentry#0Aoutlab;.outl
abset;.outvar;.outstatvec;.outstring#0Aopstr;.hasOp
erand#0Apc;.sp;.env;.dump;.count#0Amem;.memt;.regs#0A
codev;.codep;.codet#0Adatav;.datap;.datat#0A//stack
;.stackt#0Alabv;.refv;.labmax;.putc;.putd;.putref#0A
setlab;.setlabval;.nextlab;.labnumber;.resolvelabel
s#0Ainterpret;.printf#0A}#0A#0AMANIFEST.{..23//..Se
lectors#0Anametablesize.#3D.541#0Ac_tab..7#3D..0019
#0Ac_newline..3#3D..00010#0A}#0A.#0ALET.start().#3D
.VALOF#0A{.LET.treesize.#3D.0#0A..AND.codesize.#3D.
0#0A..AND.datasize.#3D.0#0A..AND.argv.#3D.VEC.50#0A
..AND.argform.#3D#0A..6"PROG/A,TO#3D-o/K,TOKENS#3D-
l/S,TREE#3D-p/S,CODE#3D-c/S,TRACE#3D-t/S"#0A..LET.s
tdout.#3D.output()#0A#0A..errmax..1:#3D.2#0A..errco
unt.:#3D.0#0A..fin_p,.fin_l.:#3D.level(),.fin#0A#0A
..treevec,.labv,.refv,.mem.:#3D.0,.0,.0,.0#0A..prog
stream,.tostream.:#3D.0,.0#0A..1#0A..writef("*nPAL.
(27.Oct.2010)*n")#0A.#0A..IF.rdargs(argform,.argv,.
50)#3D0.DO.fatalerr("Bad.arguments*n")#0A#0A..trees
ize.:#3D.1002#0A..codesize.:#3D.5002#0A..datasize.:
#3D..0005001#0A#0A..progstream.:#3D.findinput(argv!
0)..4//.PROG#0A#0A..IF.progstream#3D0.DO.fatalerr("
Trouble.with.file.%s*n",.argv!0)#0A#0A..selectinput
(progstream)#0A.#0A..IF.argv!1..26//.TO..4-o#0A..DO
.{.tostream.:#3D.findoutput(argv!1)#0A..5IF.tostrea
m#3D0.DO.fatalerr("Trouble.with.code.file.%s*n",.ar
gv!1)#0A..3}#0A#0A..optTokens.:#3D.argv!2..16//.TOK
ENS..-l#0A..optTree..1:#3D.argv!3..16//.TREE..2-p#0A
..optCode..1:#3D.argv!4..16//.CODE..2-c#0A..optTrac
e..:#3D.argv!5..16//.TRACE..1-t#0A#0A..treevec.:#3D
.getvec(treesize)#0A..codev..1:#3D.getvec(codesize)
#0A..codep..1:#3D.0#0A..codet..1:#3D.codesize#0A#0A
..datav..1:#3D.getvec(datasize)#0A..datap..1:#3D.0#0A
..datat..1:#3D.datasize#0A#0A..labv.:#3D.getvec(100
1)#0A..refv.:#3D.getvec(1001)#0A..labmax.:#3D.1001#0A
#0A..UNLESS.treevec.&.codev.&.datav.&.labv.&.refv.D
O#0A..3fatalerr("Insufficient.memory*n")#0A..1#0A..
UNLESS.tostream.DO.tostream.:#3D.stdout#0A..selecto
utput(tostream)#0A#0A..{.LET.tree.#3D.0#0A..2LET.b.
#3D.VEC.64/bytesperword#0A..2chbuf.:#3D.b#0A..2FOR.
i.#3D.0.TO.63.DO.chbuf%i.:#3D.0#0A..2chcount,.linen
o.:#3D.0,.1#0A..2rch()#0A.#0A..2treep.:#3D.treevec.
+.treesize#0A#0A..2tree.:#3D.formtree()..12//.Perfo
rm.Syntax.Analysis#0A#0A..2IF.optTokens.GOTO.fin#0A
#0A..2IF.optTree.DO.{.writes("*nParse.Tree*n*n")#0A
..18plist(tree,.0,.20)#0A..18newline()#0A..16}#0A..
#0A..2IF.errcount.GOTO.fin#0A#0A..2regs..:#3D.10#0A
#0A..2FOR.i.#3D.0.TO.codet.DO.codev!i.:#3D.0#0A..2F
OR.i.#3D.0.TO.datat.DO.datav!i.:#3D.0#0A#0A..2trpro
g(tree)..18//.Translate.the.tree#0A#0A..2//stack.:#3D
.datap#0A..2//stackt.:#3D.memt#0A#0A..2IF.errcount.
GOTO.fin#0A#0A..2//.Set.the.initial.CSED.machine.st
ate#0A..2sp.:#3D.0..9//.sp#0A..2pc.:#3D.0..9//.pc#0A
..2env.:#3D.0..8//.env#0A..2dump.:#3D.0..7//.dump#0A
..2count.:#3D.maxint..1//.count#0A#0A.#0A..2writef(
"*nStarting.the.interpreter*n*n")#0A#0A..2{.LET.ret
.#3D.interpret()..1//.Execute.the.interpreter#0A..4
IF.ret.DO.writef("Return.code.%n*n",.ret)#0A..4writ
ef("*nInstructions.executed:.%n*n",.maxint-count)#0A
..2}#0A..}#0A..1#0Afin:#0A..IF.treevec..5DO.freevec
(treevec)#0A..IF.mem..9DO.freevec(mem)#0A..IF.labv.
.8DO.freevec(labv)#0A..IF.refv..8DO.freevec(refv)#0A
..IF.progstream..2DO.{.selectinput(progstream);.end
read()..}#0A..IF.tostream..4DO.{.selectoutput(tostr
eam)#0A..22UNLESS.tostream#3Dstdout.DO..endwrite().
}#0A#0A..selectoutput(stdout)#0A..RESULTIS.errcount
#3D0.->.0,.20#0A}#0A#0ALET.lex().BE#0A{.SWITCHON.ch
.INTO#0A..{.CASE.'*p':.CASE.'*n':#0A..15lineno.:#3D
.lineno.+.1#0A..2CASE.'*c':.CASE.'*t':.CASE.'*s':#0A
..15rch()#0A..15LOOP#0A#0A..2CASE.'0':CASE.'1':CASE
.'2':CASE.'3':CASE.'4':#0A..2CASE.'5':CASE.'6':CASE
.'7':CASE.'8':CASE.'9':#0A..14token.:#3D.rdnumber()
#0A..14RETURN#0A.#0A..2CASE.'a':CASE.'b':CASE.'c':C
ASE.'d':CASE.'e':#0A..2CASE.'f':CASE.'g':CASE.'h':C
ASE.'i':CASE.'j':#0A..2CASE.'k':CASE.'l':CASE.'m':C
ASE.'n':CASE.'o':#0A..2CASE.'p':CASE.'q':CASE.'r':C
ASE.'s':CASE.'t':#0A..2CASE.'u':CASE.'v':CASE.'w':C
ASE.'x':CASE.'y':#0A..2CASE.'z':#0A..2CASE.'A':CASE
.'B':CASE.'C':CASE.'D':CASE.'E':#0A..2CASE.'F':CASE
.'G':CASE.'H':CASE.'I':CASE.'J':#0A..2CASE.'K':CASE
.'L':CASE.'M':CASE.'N':CASE.'O':#0A..2CASE.'P':CASE
.'Q':CASE.'R':CASE.'S':CASE.'T':#0A..2CASE.'U':CASE
.'V':CASE.'W':CASE.'X':CASE.'Y':#0A..2CASE.'Z':#0A.
.14token.:#3D.lookupword(rdtag())#0A..14RETURN#0A.#0A
..2CASE.'[':#0A..2CASE.'(':.token.:#3D.Lparen;..2BR
EAK#0A..2CASE.']':#0A..2CASE.')':.token.:#3D.Rparen
;..2BREAK.#0A..2CASE.'%':.token.:#3D.Percent;..1BRE
AK.#0A..2CASE.'+':.token.:#3D.Plus;..4BREAK#0A..2CA
SE.',':.token.:#3D.Comma;..3BREAK#0A..2CASE.'&':.to
ken.:#3D.Logand;..2BREAK#0A..2CASE.'|':.token.:#3D.
Bar;..5BREAK#0A..2CASE.'#3D':.token.:#3D.Valdef;..2
BREAK#0A..2CASE.'^':.token.:#3D.Power;..3BREAK#0A..
2CASE.';':.token.:#3D.Seq;..5BREAK#0A..2CASE.'$':.t
oken.:#3D.Noshare;..1BREAK#0A..2CASE.'#2E':.token.:
#3D.Dot;..5BREAK#0A.#0A..2CASE.'**':..rch()#0A..14I
F.ch#3D'**'.DO.{.token.:#3D.Power;..BREAK.}#0A..14t
oken.:#3D.Mult#0A..14RETURN#0A#0A..2CASE.'/':..1rch
()#0A..14IF.ch#3D'/'.DO#0A..14{.rch().REPEATUNTIL.c
h#3D'*n'.|.ch#3Dendstreamch#0A..16LOOP#0A..14}#0A..
14token.:#3D.Div#0A..14RETURN#0A.#0A..2CASE.'<':..1
rch()#0A..14IF.ch#3D'#3D'.DO.{.token.:#3D.Le;..BREA
K.}#0A..14token.:#3D.Lt#0A..14RETURN#0A#0A..2CASE.'
>':..1rch()#0A..14IF.ch#3D'#3D'.DO.{.token.:#3D.Ge;
..BREAK.}#0A..14token.:#3D.Gt#0A..14RETURN#0A#0A..2
CASE.'~':..1rch()#0A..14IF.ch#3D'#3D'.DO.{.token.:#3D
.Ne;..BREAK.}#0A..14token.:#3D.Not#0A..14RETURN#0A#0A
..2CASE.'-':..1rch()#0A..14IF.ch#3D'>'.|.ch#3D'**'.
DO.{.token.:#3D.Cond;.BREAK.}#0A..14token.:#3D.Minu
s#0A..14RETURN#0A#0A..2CASE.':':..1rch()#0A..14IF.c
h#3D'#3D'.DO.{.token.:#3D.Ass;..BREAK.}#0A..14token
.:#3D.Colon#0A..14RETURN#0A.#0A..2CASE.'*'':.//.A.s
tring.constant#0A..12{.LET.len.#3D.0#0A..14rch()#0A
.#0A..14UNTIL.ch#3D'*''.DO#0A..14{.IF.len#3D255.DO.
synerr("Bad.string.constant")#0A..16len.:#3D.len.+.
1#0A..16charv%len.:#3D.rdstrch()#0A..14}#0A.#0A..14
charv%0.:#3D.len#0A..14wordnode.:#3D.newvec(len/byt
esperword+2)#0A..14h1!wordnode.:#3D.Stringconst#0A.
.14FOR.i.#3D.0.TO.len.DO.(@h2!wordnode)%i.:#3D.char
v%i#0A..14token.:#3D.Stringconst#0A..14BREAK#0A..12
}#0A.#0A..2DEFAULT:..2UNLESS.ch#3Dendstreamch.DO#0A
..14{.LET.badch.#3D.ch#0A..16ch.:#3D.'*s'#0A..16syn
err("Illegal.character.%x2",.badch)#0A..14}#0A..14t
oken.:#3D.Eof#0A..14RETURN#0A..}.REPEAT#0A.#0A..rch
()#0A}#0A.#0ALET.lookupword(word).#3D.VALOF#0A{.LET
.len,.i.#3D.word%0,.0#0A..LET.hashval.#3D.len#0A..F
OR.i.#3D.1.TO.len.DO.hashval.:#3D.(13*hashval.+.wor
d%i).&.#23xFF_FF2#0A..hashval.:#3D.hashval.REM.name
tablesize#0A..wordnode.:#3D.nametable!hashval#0A.#0A
..WHILE.wordnode.&.i<#3Dlen.TEST.(@h3!wordnode)%i#3D
word%i#0A..24THEN.i.:#3D.i+1#0A..24ELSE.wordnode,.i
.:#3D.h2!wordnode,.0#0A..IF.wordnode#3D0.DO#0A..{.w
ordnode.:#3D.newvec(len/bytesperword+3)#0A..2h1!wor
dnode,.h2!wordnode.:#3D.Name,.nametable!hashval#0A.
.2FOR.i.#3D.0.TO.len.DO.(@h3!wordnode)%i.:#3D.word%
i#0A..2nametable!hashval.:#3D.wordnode#0A..}#0A..RE
SULTIS.h1!wordnode#0A}#0A.#0AAND.dsw(word,.tok).BE.
{.lookupword(word);.h1!wordnode.:#3D.tok..}#0A.#0AA
ND.declsyswords().BE#0A{.#0A..dsw("and",.And)#0A..d
sw("aug",.Aug)#0A..dsw("def",.Def)#0A..dsw("do",.Do
)#0A..dsw("dummy",.Dummy)#0A..dummynode.:#3D.wordno
de#0A..dsw("else",.Ifnot)#0A..dsw("eq",.Eq)#0A..dsw
("false",.False)#0A..falsenode.:#3D.wordnode#0A..ds
w("fn",.Lambda)#0A..dsw("ge",.Ge)#0A..dsw("goto",.G
oto)#0A..dsw("gt",.Gt)#0A..dsw("if",.If)#0A..dsw("i
fnot",.Ifnot)#0A..dsw("ifso",.Ifso)#0A..dsw("in",.I
n)#0A..//1dsw("jj",.Jj)#0A..dsw("le",.Le)#0A..dsw("
let",.Let)#0A..//1dsw("ll",.Lambda)#0A..dsw("logand
",.Logand)#0A..dsw("lt",.Lt)#0A..dsw("ne",.Ne)#0A..
dsw("nil",.Nil)#0A..nilnode.:#3D.wordnode#0A..dsw("
not",.Not)#0A..dsw("or",.Logor)#0A..dsw("rec",.Rec)
#0A..dsw("res",.Res)#0A..//1dsw("resultis",.Res)#0A
..dsw("sys",.Sys)#0A..dsw("test",.Test)#0A..//1dsw(
"then",.Ifso)#0A..dsw("true",.True)#0A..truenode.:#3D
.wordnode#0A..//1dsw("val",.Val)#0A..dsw("valof",.V
alof)#0A..dsw("where",.Where)#0A..dsw("within",.Wit
hin)#0A}.#0A.#0ALET.rch().BE#0A{.ch.:#3D.rdch()#0A.
.chcount.:#3D.chcount+1#0A..chbuf%(chcount&63).:#3D
.ch#0A}#0A.#0AAND.wrchbuf().BE#0A{.writes("*n#2E#2E
1")#0A..FOR.p.#3D.chcount-63.TO.chcount.DO#0A..{.LE
T.k.#3D.chbuf%(p&63)#0A..2IF.0<k<255.DO.wrch(k)#0A.
.}#0A..newline()#0A}#0A#0AAND.rdnumber().#3D.VALOF#0A
{.LET.tok,.zeroes,.ok.#3D.Int,.0,.FALSE#0A..lexval,
.exponent.:#3D.0,.0#0A#0A..WHILE.'0'<#3Dch<#3D'9'.D
O#0A..{.ok.:#3D.TRUE..13//.At.least.one.digit#0A..2
TEST.ch#3D'0'#0A..2THEN.{.zeroes.:#3D.zeroes+1#0A..
7}#0A..2ELSE.{.WHILE.zeroes.DO#0A..9{.IF.lexval.>.m
axint/10.TEST.tok#3DInt#0A..11THEN.synerr("Integer.
too.large")#0A..11ELSE.synerr("Too.many.significant
.digits")#0A..11lexval.:#3D.10*lexval#0A..11zeroes.
:#3D.zeroes-1#0A..11exponent.:#3D.exponent-1#0A..9}
#0A..9IF.lexval.>.maxint/10.TEST.tok#3DInt#0A..9THE
N.synerr("Integer.too.large")#0A..9ELSE.synerr("Too
.many.significant.digits")#0A..9lexval.:#3D.10*lexv
al.+.ch.-.'0'#0A..9exponent.:#3D.exponent.-.1#0A..7
}#0A..2rch()#0A..2WHILE.ch#3D'#2E'.DO#0A..2{.IF.tok
#3DReal.DO.synerr("Bad.real.number")#0A..4tok,.ok.:
#3D.Real,.FALSE..//.No.digits.after.dot.yet#0A..4ex
ponent.:#3D.zeroes#0A..4rch()#0A..2}#0A..}#0A..TEST
.tok#3DReal#0A..THEN.{.UNLESS.ok.DO#0A..9synerr("No
.digits.after.decimal.point")#0A..7IF.lexval>996.DO
#0A..9synerr("More.than.8.significant.digits.in.rea
l.number")#0A..7IF.exponent#3D0.DO#0A..9synerr("No.
digits.after.decimal.point.in.real.number")#0A..5}#0A
..ELSE.{.WHILE.zeroes.DO#0A..7{.IF.lexval.>.maxint/
10.DO.synerr("Number.too.large")#0A..9lexval.:#3D.1
0*lexval#0A..9zeroes.:#3D.zeroes-1#0A..7}#0A..5}#0A
..RESULTIS.tok#0A}#0A#0AAND.rdtag().#3D.VALOF#0A{.L
ET.len.#3D.0#0A..WHILE.'a'<#3Dch<#3D'z'.|.'A'<#3Dch
<#3D'Z'.|.'0'<#3Dch<#3D'9'.|..ch#3D'_'.DO#0A..{.len
.:#3D.len+1#0A..2IF.len>255.DO.synerr("Name.too.lon
g")#0A..2charv%len.:#3D.ch#0A..2rch()#0A..}#0A..cha
rv%0.:#3D.len#0A..RESULTIS.charv#0A}#0A.#0AAND.rdst
rch().#3D.VALOF#0A{.LET.res.#3D.ch#0A..IF.ch#3D'*n'
.|.ch#3D'*p'.DO#0A..{.lineno.:#3D.lineno+1#0A..2syn
err("Unescaped.newline.character")#0A..}#0A..IF.ch#3D
'**'.DO#0A..{.rch()#0A..2SWITCHON.ch.INTO#0A..2{.DE
FAULT:..1synerr("Bad.string.or.character.constant")
#0A..4CASE.'*'':.CASE.'"':..res.:#3D.ch;..3ENDCASE#0A
..4CASE.'t':..CASE.'T':..res.:#3D.'*t';..1ENDCASE#0A
..4CASE.'s':..CASE.'S':..res.:#3D.'*s';..1ENDCASE#0A
..4CASE.'n':..CASE.'N':..res.:#3D.'*n';..1ENDCASE#0A
..4CASE.'b':..CASE.'B':..res.:#3D.'*b';..1ENDCASE#0A
..2}#0A..}#0A..rch()#0A..RESULTIS.res#0A}#0A#0ALET.
newvec(n).#3D.VALOF#0A{.treep.:#3D.treep.-.n.-.1;#0A
..IF.treep<#3Dtreevec.DO.fatalerr("More.workspace.n
eeded")#0A..RESULTIS.treep#0A}#0A.#0AAND.mk1(a).#3D
.VALOF#0A{.LET.p.#3D.newvec(0)#0A..p!0.:#3D.a#0A..R
ESULTIS.p#0A}#0A.#0AAND.mk2(a,.b).#3D.VALOF#0A{.LET
.p.#3D.newvec(1)#0A..p!0,.p!1.:#3D.a,.b#0A..RESULTI
S.p#0A}#0A.#0AAND.mk3(a,.b,.c).#3D.VALOF#0A{.LET.p.
#3D.newvec(2)#0A..p!0,.p!1,.p!2.:#3D.a,.b,.c#0A..RE
SULTIS.p#0A}#0A.#0AAND.mk4(a,.b,.c,.d).#3D.VALOF#0A
{.LET.p.#3D.newvec(3)#0A..p!0,.p!1,.p!2,.p!3.:#3D.a
,.b,.c,.d#0A..RESULTIS.p#0A}#0A.#0AAND.mk5(a,.b,.c,
.d,.e).#3D.VALOF#0A{.LET.p.#3D.newvec(4)#0A..p!0,.p
!1,.p!2,.p!3,.p!4.:#3D.a,.b,.c,.d,.e#0A..RESULTIS.p
#0A}#0A.#0AAND.mk6(a,.b,.c,.d,.e,.f).#3D.VALOF#0A{.
LET.p.#3D.newvec(5)#0A..p!0,.p!1,.p!2,.p!3,.p!4,.p!
5.:#3D.a,.b,.c,.d,.e,.f#0A..RESULTIS.p#0A}#0A.#0AAN
D.formtree().#3D.VALOF#0A{.LET.res.#3D.0#0A..rec_p,
.rec_l.:#3D.level(),.recover#0A#0A..charv.:#3D.newv
ec(256/bytesperword)..3#0A..nametable.:#3D.newvec(n
ametablesize)#0A..UNLESS.charv.&.nametable.DO.fatal
err("More.workspace.needed")#0A..FOR.i.#3D.0.TO.nam
etablesize.DO.nametable!i.:#3D.0#0A..declsyswords()
#0A..mptnode.:#3D.mk1(Mpt)#0A#0A..lex()#0A#0A..IF.o
ptTokens.DO..10//.For.debugging.lex#2E#0A..{.writef
("token.#3D.%i3.%s",.token,.opstr(token))#0A..2IF.t
oken#3DInt..2DO.writef("..5%n",..lexval)#0A..2IF.to
ken#3DReal..1DO.writef("..4%ne%n",..lexval,.exponen
t)#0A..2IF.token#3DName..1DO.writef("..4%s",..1char
v)#0A..2IF.token#3DStringconst.DO#0A..2{.writef("..
2*'")#0A..4FOR.i.#3D.1.TO.charv%0.SWITCHON.charv%i.
INTO#0A..4{.DEFAULT:..1wrch(charv%i);.ENDCASE#0A..6
CASE.'*n':.writes("**n");.ENDCASE#0A..6CASE.'*p':.w
rites("**p");.ENDCASE#0A..6CASE.'*t':.writes("**t")
;.ENDCASE#0A..4}#0A..4writef("*'")#0A..2}#0A..2newl
ine()#0A..2IF.token#3DEof.RESULTIS.0#0A..2lex()#0A.
.}.REPEAT#0A#0Arecover:#0A..res.:#3D.rdprog()#0A..U
NLESS.token#3DEof.DO.fatalerr("Incorrect.terminatio
n")#0A..RESULTIS.res#0A}#0A.#0AAND.fatalerr(mess,.a
).BE#0A{.writef("*nFatal.error:..")#0A..writef(mess
,.a)#0A..writes("*nCompilation.aborted*n")#0A..errc
ount.:#3D.errcount+1#0A..longjump(fin_p,.fin_l)#0A}
#0A#0AAND.synerr(mess,.a).BE#0A{.writef("*nError.ne
ar.line.%n:..",.lineno)#0A..writef(mess,.a)#0A..wrc
hbuf()#0A..errcount.:#3D.errcount+1#0A..IF.errcount
.>#3D.errmax.DO.fatalerr("Too.many.errors")#0A#0A..
//.Skip.the.rest.of.the.input.line.#0A..UNTIL.ch#3D
'*n'.|.ch#3Dendstreamch.DO.rch()#0A..lex()#0A#0A..l
ongjump(rec_p,.rec_l)#0A}#0A#0ALET.checkfor(tok,.me
ss).BE#0A{.UNLESS.token#3Dtok.DO.synerr(mess)#0A..l
ex()#0A}#0A#0ALET.rdprog().#3D.VALOF#0A{.//.P.->.de
f.D0.#2E#2E.def.D0.in.C0.eof.|#0A..//..4C0.eof#0A#0A
..LET.a,.ln.#3D.0,.lineno#0A#0A..SWITCHON.token.INT
O#0A..{.DEFAULT:#0A..4a.:#3D.rcom(0)#0A..4ENDCASE#0A
#0A..2CASE.Eof:#0A..4ENDCASE..//.No.program!#0A#0A.
.2CASE.Def:#0A..2{.LET.d.#3D.rndef()#0A..4a.:#3D.mk
4(Def,.d,.rdprog(),.ln)#0A..4ENDCASE#0A..2}#0A#0A..
2CASE.In:#0A..4a.:#3D.rncom(0)#0A..4ENDCASE#0A..}#0A
..UNLESS.token#3DEof.DO.synerr("Incorrect.terminati
on")#0A#0A..RESULTIS.a#0A}#0A#0AAND.rnbdef(n).#3D.V
ALOF#0A{.lex()#0A..RESULTIS.rbdef(n)#0A}#0A#0AAND.r
bdef(n).#3D.VALOF#0A{.//.BD.->.N,#2E#2E1,N.#3D.E#0A
..//..5N.BV#2E#2E1BV.#3D.E#0A..//..5(.D.)#0A..//..5
rec.D#0A..LET.op,.ln.#3D.token,.lineno#0A#0A..SWITC
HON.op.INTO#0A..{.DEFAULT:#0A..4synerr("Bad.definit
ion,.name,.rec.or.'('.expected")#0A#0A..2CASE.Name:
#0A..4{.LET.names.#3D.rname()#0A..6ln.:#3D.lineno#0A
#0A..6IF.token#3DComma.DO#0A..6{.//.Must.be.a.simul
taneous.definition#0A..8//.N.,#2E#2E1,.N.#3D.C0#0A.
.8names.:#3D.rdnamelist(names)#0A..8checkfor(Valdef
,."Bad.definition")#0A..8RESULTIS.mk4(Valdef,.names
,.rcom(0),.ln)#0A..6}#0A#0A..6IF.token#3DValdef.RES
ULTIS.mk4(Valdef,.names,.rncom(0),.ln)#0A#0A..6{.//
.Must.be.a.function.definition#0A..8//.N.BV.#2E#2E1
.BV.#3D.C0#0A..8LET.v.#3D.VEC.50#0A..8AND.i,.b.#3D.
0,.?#0A..8WHILE.i<#3D50.DO#0A..8{.UNLESS.token#3DLp
aren.|.token#3DName.BREAK#0A..10v!i.:#3D.rbv()#0A..
10i.:#3D.i+1#0A..8}#0A..8UNLESS.i~#3D0.&.token#3DVa
ldef.DO.synerr("Bad.definition")#0A..8b.:#3D.rncom(
0)#0A..8WHILE.i>0.DO#0A..8{.i.:#3D.i-1#0A..10b.:#3D
.mk4(Lambda,.v!i,.b,.ln)#0A..8}#0A..8RESULTIS.mk4(V
aldef,.names,.b,.ln)#0A..6}#0A..4}#0A#0A..2CASE.Lpa
ren:#0A..2{.LET.a.#3D.rndef(0)#0A..4checkfor(Rparen
,."Bad.definition")#0A..4RESULTIS.a#0A..2}#0A#0A..2
CASE.Rec:#0A..4lex()#0A..4UNLESS.n#3D0.DO.synerr("R
edundant.'rec'")#0A..4RESULTIS.mk3(Rec,.rnbdef(2),.
ln)#0A..}#0A}#0A#0AAND.rndef(n).#3D.VALOF.{.lex();.
RESULTIS.rdef(n).}#0A#0AAND.rdef(n).#3D.VALOF#0A{./
/.D.->.D.and.D#0A..//..4D.within.D#0A..//..4BD#0A..
LET.a.#3D.rbdef(0)#0A..LET.b.#3D.0#0A#0A..{.LET.op,
.ln.#3D.token,.lineno#0A#0A//sawritef("rdef:.op#3D%
s.ln#3D%n*n",.opstr(op),.ln)#0A..2SWITCHON.op.INTO#0A
..2{.DEFAULT:#0A..6RESULTIS.a#0A#0A..4CASE.And:#0A.
.6IF.a#3D0.DO.synerr("Definition.missing.before.'an
d'")#0A..6IF.n>#3D6.RESULTIS.a#0A..6{.LET.i.#3D.1#0A
..8LET.v.#3D.VEC.100#0A..8WHILE.token#3DAnd.DO#0A..
8{.v!i.:#3D.rnbdef(0)#0A..10i.:#3D.i+1#0A..8}#0A..8
b.:#3D.a#0A..8a.:#3D.newvec(i+1)#0A..8a!0,.a!1,.a!2
.:#3D.And,.i+1,.b#0A..8FOR.j.#3D.1.TO.i-1.DO.a!(j+2
).:#3D.v!j#0A..8LOOP#0A..6}#0A#0A..4CASE.Within:#0A
..6IF.a#3D0.DO.synerr("Definition.missing.before.'w
ithin'")#0A..6IF.n>#3D3.RESULTIS.a#0A..6a.:#3D.mk4(
Within,.a,.rndef(0),.ln)#0A..6LOOP#0A..2}#0A..}.REP
EAT#0A}#0A#0AAND.rbv().#3D.VALOF#0A{.//.Only.called
.when.token.is.Name.or.Lparen#0A..LET.a.#3D.?#0A..I
F.token#3DName.RESULTIS.rname()#0A..checkfor(Lparen
,."'('.expected")#0A..IF.token#3DRparen.DO#0A..{.le
x()#0A..2RESULTIS.mptnode#0A..}#0A..a.:#3D.rdnameli
st(0)#0A..checkfor(Rparen,."Bad.bound.variable.list
")#0A..RESULTIS.a#0A}#0A#0AAND.rdnamelist(n).#3D.VA
LOF#0A{.LET.a,.b,.i,.ln.#3D.0,.n,.1,.lineno#0A..LET
.v.#3D.VEC.100#0A..IF.n#3D0.DO#0A..{.UNLESS.token#3D
Name.DO#0A..4synerr("Bad.name.list")#0A..2b.:#3D.rn
ame()#0A..}#0A..UNLESS.token#3DComma.RESULTIS.b#0A.
.WHILE.token#3DComma.DO#0A..{.lex()#0A..2UNLESS.tok
en#3DName.DO.synerr("A.name.is.missing")#0A..2v!i.:
#3D.rname()#0A..2i.:#3D.i+1#0A..}#0A..a.:#3D.newvec
(i+1)#0A..h1!a,.h2!a,.h3!a.:#3D.Comma,.i,.b#0A..FOR
.j.#3D.1.TO.i-1.DO.a!(j+2).:#3D.v!j#0A..RESULTIS.a#0A
}#0A#0AAND.rname().#3D.VALOF#0A{.LET.a.#3D.wordnode
#0A..checkfor(Name,."Name.expected")#0A..RESULTIS.a
#0A}#0A#0AAND.rarg().#3D.VALOF#0A{.LET.a,.ln.#3D.0,
.lineno#0Asawritef("rarg:.token#3D%s*n",.opstr(toke
n))#0A..SWITCHON.token.INTO#0A..{.DEFAULT:#0A..4RES
ULTIS.0..//.Not.suitable.as.an.unparenthesised.argu
ment#0A#0A..}#0A}#0A.#0ALET.rbexp(n).#3D.VALOF#0A{.
LET.a,.op,.ln.#3D.0,.token,.lineno#0A.#0A..SWITCHON
.op.INTO#0A.#0A..{.DEFAULT:#0A..4synerr("Error.in.e
xpression")#0A#0A..2CASE.True:#0A..2CASE.False:#0A.
.2CASE.Name:#0A..2CASE.Nil:#0A..2CASE.Stringconst:#0A
..2CASE.Sys:#0A..4a.:#3D.wordnode#0A..4lex()#0A..4R
ESULTIS.a#0A..1#0A..2CASE.Lparen:#0A..4lex()#0A..4T
EST.token#3DRparen#0A..4THEN.a.:#3D.nilnode#0A..4EL
SE.a.:#3D.rcom(0)#0A..4checkfor(Rparen,."')'.missin
g")#0A..4IF.n<#3D8.DO.a.:#3D.mk3(Paren,.a,.ln)#0A..
4RESULTIS.a#0A.#0A..2CASE.Int:#0A..4a.:#3D.mk2(Int,
.lexval)#0A..4lex()#0A..4RESULTIS.a#0A.#0A..2CASE.R
eal:#0A..4a.:#3D.mk3(Real,.lexval,.exponent)#0A..4l
ex()#0A..4RESULTIS.a#0A.#0A..2CASE.Noshare:#0A..4UN
LESS.n<#3D36.DO.synerr("'$'.or.'sys'.out.of.context
")#0A..4RESULTIS.mk3(op,.rnexp(38),.ln)#0A.#0A..2CA
SE.Plus:#0A..4UNLESS.n<#3D30.DO.synerr("'+'.out.of.
context")#0A..4RESULTIS.rnexp(32)#0A.#0A..2CASE.Min
us:#0A..4UNLESS.n<#3D30.DO.synerr("'-'.out.of.conte
xt")#0A..4a.:#3D.rnexp(32)#0A..4TEST.h1!a#3DInt.|.h
1!a#3DReal#0A..4THEN.h2!a.:#3D.-.h2!a#0A..4ELSE.a.:
#3D.mk2(Neg,.a)#0A..4RESULTIS.a#0A.#0A..2CASE.Not:#0A
..4UNLESS.n<#3D24.DO.synerr("'not'.out.of.context")
#0A..4RESULTIS.mk2(Not,.rnexp(26))#0A..}#0A}#0A.#0A
AND.rnexp(n).#3D.VALOF.{.lex();.RESULTIS.rexp(n).}#0A
.#0AAND.rexp(n).#3D.VALOF#0A{.LET.a,.b,.p.#3D.rbexp
(n),.0,.0#0A#0A..{.LET.op,.ln.#3D.token,.lineno#0A#0A
..2SWITCHON.op.INTO#0A..2{.DEFAULT:#0A..6RESULTIS.a
#0A.#0A..4//.Tokens.that.start.a.function.argument#0A
..4#0A..4CASE.Nil:#0A..4CASE.True:#0A..4CASE.False:
#0A..4CASE.Int:#0A..4CASE.Real:#0A..4CASE.Stringcon
st:#0A..4CASE.Name:#0A..6a.:#3D.mk4(Apply,.a,.rbexp
(0),.ln)#0A..6LOOP#0A#0A..4CASE.Lparen:#0A..6lex()#0A
..6IF.token#3DRparen.DO#0A..6{.//.Empty.argument.li
st#0A..8lex()#0A..8RESULTIS.nilnode#0A..6}#0A..6b.:
#3D.rcom(0)#0A..6checkfor(Rparen,."')'.expected")#0A
..6a.:#3D.mk4(Apply,.a,.b,.ln)#0A..6LOOP#0A#0A..4CA
SE.Comma:#0A..6IF.n>14.RESULTIS.a#0A..6{.LET.i.#3D.
1#0A..8LET.v.#3D.VEC.500#0A..8WHILE.token#3DComma.D
O#0A..8{.v!i.:#3D.rnexp(16)#0A..10i.:#3D.i+1#0A..8}
#0A..8b.:#3D.a#0A..8a.:#3D.newvec(i+1)#0A..8a!0,.a!
1,.a!2.:#3D.Comma,.i,.b#0A..8FOR.j.#3D.1.TO.i-1.DO.
a!(j+2).:#3D.v!j#0A//sawritef("rexp:.Comma.i#3D%n*n
",.i)#0A..8LOOP#0A..6}#0A#0A..4CASE.Aug:#0A..6IF.n>
16.RESULTIS.a#0A..6a.:#3D.mk4(Aug,.a,.rnexp(18),.ln
)#0A..6LOOP#0A#0A..4CASE.Cond:#0A..6IF.n>18.RESULTI
S.a#0A..6b.:#3D.rnexp(18)#0A..6checkfor(Bar,."Bad.c
onditional.expression")#0A..6a.:#3D.mk5(Cond,.a,.b,
.rexp(18),.ln)#0A..6LOOP#0A#0A..4CASE.Logor:#0A..6I
F.n>20.RESULTIS.a#0A..6a.:#3D.mk4(op,.a,.rnexp(22),
.ln)#0A..6LOOP#0A#0A..4CASE.Logand:#0A..6IF.n>22.RE
SULTIS.a#0A..6a.:#3D.mk4(op,.a,.rnexp(24),.ln)#0A..
6LOOP#0A#0A..4CASE.Eq:CASE.Le:CASE.Lt:CASE.Ne:CASE.
Ge:CASE.Gt:#0A..6IF.n>26.RESULTIS.a#0A..6a.:#3D.mk4
(op,.a,.rnexp(30),.ln)#0A..6LOOP#0A#0A..4CASE.Plus:
CASE.Minus:#0A..6IF.n>30.RESULTIS.a#0A..6a.:#3D.mk4
(op,.a,.rnexp(32),.ln)#0A..6LOOP#0A#0A..4CASE.Mult:
CASE.Div:#0A..6IF.n>32.RESULTIS.a#0A..6a.:#3D.mk4(o
p,.a,.rnexp(34),.ln)#0A..6LOOP#0A#0A..4CASE.Power:#0A
..6IF.n>36.RESULTIS.a#0A..6a.:#3D.mk4(op,.a,.rnexp(
34),.ln)#0A..6LOOP#0A#0A..4CASE.Percent:#0A..6IF.n>
36.RESULTIS.a#0A..6lex()#0A..6UNLESS.token#3DName.D
O.synerr("Name.expected.in.'%'.construct")#0A..6b.:
#3D.rname()#0A..6a.:#3D.mk4(Comma,.2,.a,.rexp(38))#0A
..6a.:#3D.mk4(Apply,.b,.a,.ln)#0A..6LOOP#0A..2}#0A.
.}.REPEAT#0A}#0A#0AAND.rncom(n).#3D.VALOF#0A{.lex()
#0A..RESULTIS.rcom(n)#0A}#0A#0AAND.rcom(n).#3D.VALO
F#0A{.LET.a.#3D.rbcom(n)#0A#0A..{.LET.op,.ln.#3D.to
ken,.lineno#0A..2SWITCHON.op.INTO#0A.#0A..2{.DEFAUL
T:#0A..6BREAK#0A.#0A..4CASE.Seq:#0A..6IF.n>6.RESULT
IS.a#0A..6a.:#3D.mk4(Seq,.a,.rncom(6),.ln)#0A..6LOO
P#0A#0A..4CASE.Where:#0A..6IF.n>2.RESULTIS.a#0A..6a
.:#3D.mk4(Where,.a,.rnbdef(0),.ln)#0A..6LOOP#0A#0A.
.4CASE.Colon:#0A..6UNLESS.h1!a#3DName.&.n<#3D8.DO#0A
..8synerr("Syntax.error.in.label")#0A..6a.:#3D.mk5(
Colon,.a,.rncom(8),.0,.ln)#0A..6LOOP#0A..2}#0A..}.R
EPEAT#0A#0A..RESULTIS.a#0A}#0A#0AAND.rbcom(n).#3D.V
ALOF#0A{.LET.op,.ln,.a,.b.#3D.token,.lineno,.0,.0#0A
#0A..SWITCHON.op.INTO#0A..{.DEFAULT:.//.Must.be.an.
expression#0A..2{.a.:#3D.rexp(n)#0A..4ln.:#3D.linen
o#0A..4IF.token#3DAss.RESULTIS.mk4(Ass,.a,.rnexp(14
),.ln)#0A..4RESULTIS.a#0A..2}#0A#0A..2CASE.Let:#0A.
.2{.UNLESS.n#3D0.DO.synerr("'let'.out.of.context")#0A
..4a.:#3D.rndef(0)#0A..4checkfor(In,."'in'.expected
.in.'let'.construct")#0A..4RESULTIS.mk4(Let,.a,.rco
m(0),.ln)#0A..2}#0A#0A..2CASE.Lambda:#0A..2{.LET.v.
#3D.VEC.50#0A..4AND.i.#3D.0#0A..4UNLESS.n#3D0.DO.sy
nerr("'fn'.out.of.context")#0A..4lex()#0A..4WHILE.i
<#3D50.DO#0A..4{.UNLESS.token#3DLparen.|.token#3DNa
me.BREAK#0A..6v!i.:#3D.rbv()#0A..6i.:#3D.i+1#0A..4}
#0A..4IF.i#3D0.DO.synerr("No.bound.variable.list.af
ter.'fn'")#0A..4checkfor(Dot,."'#2E'.missing.in.'fn
'.construct")#0A..4a.:#3D.rcom(0)#0A..4WHILE.i>0.DO
#0A..4{.i.:#3D.i-1#0A..6a.:#3D.mk4(Lambda,.v!i,.a,.
ln)#0A..4}#0A..4RESULTIS.a#0A..2}#0A#0A..2CASE.Valo
f:#0A..4UNLESS.n<#3D4.DO.synerr("'valof'.out.of.con
text")#0A..4RESULTIS.mk3(op,.rncom(6),.ln)#0A.#0A..
2CASE.Test:#0A..4UNLESS.n<#3D10.DO.synerr("'test'.o
ut.of.context")#0A..4a.:#3D.rnexp(20)#0A..4SWITCHON
.token.INTO#0A..4{.DEFAULT:#0A..8synerr("Bad.'test'
.command")#0A#0A..6CASE.Ifso:#0A..8b.:#3D.rncom(8)#0A
..8checkfor(Ifnot,."'ifnot'.expected")#0A..8RESULTI
S.mk5(Cond,.a,.b,.rncom(8),.ln)#0A#0A..6CASE.Ifnot:
#0A..8b.:#3D.rncom(8)#0A..8checkfor(Ifso,."'ifnot'.
expected")#0A..8RESULTIS.mk5(Cond,.a,.rncom(8),.b,.
ln)#0A..4}#0A#0A1..2CASE.While:#0A..2CASE.If:#0A..2
{.LET.op.#3D.token#0A..4UNLESS.n<#3D10.DO.synerr("'
if'.or.'while'.out.of.context")..3#0A..4a.:#3D.rnex
p(20)#0A..4checkfor(Do,."'do'.expected")#0A..4TEST.
op#3DIf#0A..4THEN.RESULTIS.mk5(Cond,.a,.rcom(8),.du
mmynode,.ln)#0A..4ELSE.RESULTIS.mk5(While,.a,.rcom(
8),.ln)#0A..2}#0A#0A..2CASE.Goto:#0A..4RESULTIS.mk3
(Goto,.rnexp(38),.ln)#0A#0A..2CASE.Res:#0A..4RESULT
IS.mk3(Res,.rnexp(14),.ln)#0A#0A..}#0A}#0A#0ALET.op
str(op).#3D.VALOF.SWITCHON.op.INTO#0A{.DEFAULT:..8s
awritef("opstr:.unknown.op:.%n*n",.op)#0A..18RESULT
IS."#23#231Unknown.op.#23#231"#0A#0A..CASE.Ass:..7R
ESULTIS."Ass"#0A..CASE.And:..7RESULTIS."And"#0A..CA
SE.Apply:..5RESULTIS."Apply"#0A..CASE.Aug:..7RESULT
IS."Aug"#0A..CASE.Bar:..7RESULTIS."Bar"#0A..CASE.Bl
ocklink:..1RESULTIS."Blocklink"#0A..CASE.Colon:..5R
ESULTIS."Colon"#0A..CASE.Comma:..5RESULTIS."Comma"#0A
..CASE.Cond:..6RESULTIS."Cond"#0A..CASE.Decllabel:.
.1RESULTIS."Decllabel"#0A..CASE.Declname:..2RESULTI
S."Declname"#0A..CASE.Declnames:..1RESULTIS."Declna
mes"#0A..CASE.Def:..7RESULTIS."Def"#0A..CASE.Div:..
7RESULTIS."Div"#0A..CASE.Do:..8RESULTIS."Do"#0A..CA
SE.Dot:..7RESULTIS."Dot"#0A..CASE.Dummy:..5RESULTIS
."Dummy"#0A..CASE.Eof:..7RESULTIS."Eof"#0A..CASE.Eq
:..8RESULTIS."Eq"#0A..CASE.Ifnot:..5RESULTIS."Ifnot
"#0A..CASE.Power:..5RESULTIS."Power"#0A..CASE.False
:..5RESULTIS."False"#0A..CASE.FormClosure:.RESULTIS
."FormClosure"#0A..CASE.FormLvalue:..RESULTIS."Form
Lvalue"#0A..CASE.FormRvalue:..RESULTIS."FormRvalue"
#0A..CASE.Ge:..8RESULTIS."Ge"#0A..CASE.Goto:..6RESU
LTIS."Goto"#0A..CASE.Gt:..8RESULTIS."Gt"#0A..CASE.H
alt:..6RESULTIS."Halt"#0A..CASE.If:..8RESULTIS."If"
#0A..CASE.In:..8RESULTIS."In"#0A..CASE.Initname:..2
RESULTIS."Initname"#0A..CASE.Initnames:..1RESULTIS.
"Initnames"#0A..CASE.Int:..7RESULTIS."Int"#0A..CASE
.Jj:..8RESULTIS."Jj"#0A..CASE.Jump:..6RESULTIS."Jum
p"#0A..CASE.JumpF:..5RESULTIS."JumpF"#0A..CASE.Lab:
..7RESULTIS."Lab"#0A..CASE.Lambda:..4RESULTIS."Lamb
da"#0A..CASE.Le:..8RESULTIS."Le"#0A..CASE.Let:..7RE
SULTIS."Let"#0A..CASE.LoadE:..5RESULTIS."LoadE"#0A.
.CASE.LoadF:..5RESULTIS."LoadF"#0A..CASE.LoadGuess:
..1RESULTIS."LoadGuess"#0A..CASE.LoadJ:..5RESULTIS.
"LoadJ"#0A..CASE.LoadL:..5RESULTIS."LoadL"#0A..CASE
.LoadN:..5RESULTIS."LoadN"#0A..CASE.LoadR:..5RESULT
IS."LoadR"#0A..CASE.LoadS:..5RESULTIS."LoadS"#0A..C
ASE.Logand:..4RESULTIS."Logand"#0A..CASE.Logor:..5R
ESULTIS."Logor"#0A..CASE.Lose1:..5RESULTIS."Lose1"#0A
..CASE.Lparen:..4RESULTIS."Lparen"#0A..CASE.Lt:..8R
ESULTIS."Lt"#0A..CASE.Members:..3RESULTIS."Members"
#0A..CASE.Minus:..5RESULTIS."Minus"#0A..CASE.Mpt:..
7RESULTIS."Mpt"#0A..CASE.Mult:..6RESULTIS."Mult"#0A
..CASE.Name:..6RESULTIS."Name"#0A..CASE.Ne:..8RESUL
TIS."Ne"#0A..CASE.Neg:..7RESULTIS."Neg"#0A..CASE.Ni
l:..7RESULTIS."Nil"#0A..CASE.Not:..7RESULTIS."Not"#0A
..CASE.Paren:..5RESULTIS."Paren"..5#0A..CASE.Percen
t:..3RESULTIS."Percent"..5#0A..CASE.Plus:..6RESULTI
S."Plus"#0A..CASE.Real:..6RESULTIS."Real"..5#0A..CA
SE.Rec:..7RESULTIS."Rec"..5#0A..CASE.Res:..7RESULTI
S."Res"#0A..CASE.Reslink:..3RESULTIS."Reslink"#0A..
CASE.RestoreE1:..1RESULTIS."RestoreE1"#0A..CASE.Ret
urn:..4RESULTIS."Return"#0A..CASE.Rparen:..4RESULTI
S."Rparen"#0A..CASE.Save:..6RESULTIS."Save"#0A..CAS
E.Seq:..7RESULTIS."Seq"#0A..CASE.SetlabEs:..2RESULT
IS."SetlabEs"#0A..CASE.Setup:..5RESULTIS."Setup"#0A
..CASE.Stringconst:.RESULTIS."Stringconst"#0A..CASE
.Sys:..7RESULTIS."Sys"#0A..CASE.Test:..6RESULTIS."T
est"#0A..CASE.TestEmpty:..1RESULTIS."TestEmpty"#0A.
.CASE.Ifso:..6RESULTIS."Ifso"#0A..CASE.True:..6RESU
LTIS."True"#0A..CASE.Tuple:..5RESULTIS."Tuple"#0A..
CASE.Noshare:..3RESULTIS."Noshare"#0A..CASE.Update:
..4RESULTIS."Update"#0A..CASE.Valdef:..4RESULTIS."V
aldef"#0A..CASE.Valof:..5RESULTIS."Valof"#0A..CASE.
Where:..5RESULTIS."Where"#0A..CASE.Within:..4RESULT
IS."Within"#0A}#0A#0ALET.plist(x,.n,.d).BE#0A{.LET.
op,.size,.ln.#3D.?,.0,.0#0A..LET.v.#3D.TABLE.0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0#0A#0A..IF.x#3D0.D
O.{.writes("Null");.RETURN..}#0A.#0A..op.:#3D.h1!x#0A
#0A..SWITCHON.op.INTO#0A..{.DEFAULT:#0Awritef("Defa
ult.op#3D%s*n",.opstr(op));.RETURN#0A#0A..2CASE.Int
:..3writef("Int.%n",.h2!x);..9RETURN#0A..2CASE.Real
:..2writef("Real.%ne%n",.h2!x,.h3!x);.RETURN#0A..2C
ASE.Name:..2writef("Name.%s",.x+2);..9RETURN#0A..2C
ASE.Stringconst:..#0A..14{.LET.s.#3D.x+1#0A..16writ
ef("Stringconst.*'")#0A..16FOR.i.#3D.1.TO.s%0.SWITC
HON.s%i.INTO#0A..16{.DEFAULT:..1wrch(s%i);.ENDCASE#0A
..18CASE.'*n':.writes("**n");.ENDCASE#0A..18CASE.'*
p':.writes("**p");.ENDCASE#0A..18CASE.'*t':.writes(
"**t");.ENDCASE#0A..16}#0A..16writef("*'")#0A..16RE
TURN#0A..14}#0A#0A..2CASE.Colon:#0A..7size,.ln.:#3D
.3,.h5!x;.ENDCASE#0A#0A..2CASE.Cond:.CASE.Test:.CAS
E.Percent:#0A..7size,.ln.:#3D.4,.h5!x;.ENDCASE#0A#0A
..2CASE.Power:.CASE.Mult:.CASE.Div:.CASE.Plus:.CASE
.Minus:#0A..2CASE.Eq:.CASE.Ne:.CASE.Lt:.CASE.Gt:.CA
SE.Le:.CASE.Ge:#0A..2CASE.Logand:.CASE.Logor:.CASE.
Aug:#0A..2CASE.Let:.CASE.Where:.CASE.Within:#0A..2C
ASE.Lab:#0A..2CASE.Ass:.CASE.Apply:.CASE.Lambda:#0A
..2CASE.Def:.CASE.Valdef:.CASE.Tuple:.CASE.Seq:#0A.
.2CASE.If:#0A..7size,.ln.:#3D.3,.h4!x;.ENDCASE#0A#0A
..2CASE.Comma:.CASE.And:#0A..7//.x.->.[op,.n,.a1.,#2E
#2E1,.an]#0A..7size.:#3D.h2!x+1#0A//sawritef("plist
:.Comma.size#3D%n*n",.size)#0A..7x.:#3D.x+1#0A..7EN
DCASE#0A#0A..2CASE.Noshare:#0A..2CASE.Rec:#0A..2CAS
E.Valof:.#0A..2CASE.Goto:.#0A..2CASE.Res:#0A..2CASE
.Sys:#0A..2CASE.Paren:#0A..7size,.ln.:#3D.2,.h3!x;.
ENDCASE#0A#0A..2CASE.True:.CASE.False:#0A..2CASE.Ni
l:.CASE.Mpt:#0A..2CASE.Dummy:#0A..7size.:#3D.1;..5E
NDCASE#0A..}#0A.#0A..IF.n#3Dd.DO.{.writes("Etc");.R
ETURN.}#0A..writef("%s",.opstr(op))#0A..IF.ln.DO.wr
itef("..--.line.%n",.ln)#0A..FOR.i.#3D.2.TO.size.DO
.{.newline()#0A..23FOR.j#3D0.TO.n-1.DO.writes(.v!j.
)#0A..23writes("**-")#0A..23v!n.:#3D.i#3Dsize->".."
,"!."#0A..23plist(h1!(x+i-1),.n+1,.d)#0A..21}#0A}#0A
#0A1AND.trnerr(mess,.a).BE#0A{.writes("Error")#0A..
IF.procname.DO.writef(".in.%s",.@h3!procname)#0A..I
F.comline.DO.writef(".near.line.%n",.comline)#0A..w
rites(":..1")#0A..writef(mess,.a)#0A..newline()#0A.
.errcount.:#3D.errcount.+.1#0A..IF.errcount.>#3D.er
rmax.DO.fatalerr("*nCompilation.aborted*n")#0A}#0A#0A
AND.trprog(x).BE#0A{.LET.n.#3D.?#0A..FOR.i.#3D.0.TO
.labmax.DO.labv!i,.refv!i.:#3D.-1,.0#0A#0A..comline
,.procname,.labnumber.:#3D.1,.0,.0#0A..ssp,.msp.:#3D
.0,.1#0A#0A..IF.optCode.DO.writef("*nCompiled.code:
*n*n")#0A#0A..n.:#3D.nextlab()#0A..outfl(Setup,.n)#0A
#0A..translabels(x)#0A#0A..trans(x,.Val)#0A..UNLESS
.ssp#3D1.DO.writef("*nSSP.error*n")#0A..outf(Halt)#0A
..outlabset(n,.msp)#0A#0A..//resolvelabels()#0A#0A.
.writef("*nProgram.size:.%n.data.size:.%n*n*n",#0A.
.8codep,.datap)#0A}#0A#0ALET.trans(x,.mode).BE#0A//
.x..5is.the.program#0A//.mode.is.Val.or.Ref#0A{.LET
.op.#3D.h1!x#0A#0A..IF.x#3D0.DO#0A..{.writes("*nExp
ression.missing*n")#0A..2outf(Nil)#0A..2upssp(1)#0A
..2IF.mode#3DRef.DO.outf(FormLvalue)#0A..2RETURN#0A
..}#0A#0A//writef("trans:.op#3D%s*n",.opstr(op))#0A
..SWITCHON.op.INTO#0A..{.DEFAULT:#0A..4//.It.must.b
e.an.expression#0A..4load(x)#0A..4RETURN#0A#0A..2CA
SE.Let:#0A..2{.LET.lab1.#3D.nextlab()#0A..4LET.lab2
.#3D.nextlab()#0A..4comline.:#3D.h5!x#0A..4transrhs
(h2!x)#0A..4outfl(Blocklink,.lab1)#0A..4IF.ssp#3Dms
p.DO.msp.:#3D.ssp+1#0A..4transscope(x,.lab2,.mode)#0A
..4outlab(lab1)..11#0A..4RETURN#0A..2}#0A..#0A..2CA
SE.Def:#0A..4transrhs(h2!x)#0A..4declnames(h2!x)#0A
..4translabels(h3!x)#0A..4trans(h3!x,.Val)#0A..4RET
URN#0A#0A..2CASE.Mult:.CASE.Div:.CASE.Power:.CASE.P
lus:.CASE.Minus:#0A..2CASE.Eq:.CASE.Ne:.CASE.Lt:.CA
SE.Le:.CASE.Gt:.CASE.Ge:#0A..2CASE.Logand:.CASE.Log
or:#0A..4trans(h3!x,.Val)#0A..4trans(h2!x,.Val)#0A.
.4outf(op)#0A..4ssp.:#3D.ssp-1#0A..4IF.mode#3DRef.D
O.outf(FormLvalue)#0A..4RETURN#0A#0A..2CASE.Aug:#0A
..4trans(h3!x,.Ref)#0A..4trans(h2!x,.Val)#0A..4outf
(Aug)#0A..4ssp.:#3D.ssp-1#0A..4IF.mode#3DRef.DO.out
f(FormLvalue)#0A..4RETURN#0A#0A..2CASE.Apply:#0A..4
trans(h3!x,.Ref)#0A..4trans(h2!x,.Ref)#0A..4outf(Ap
ply)#0A..4ssp.:#3D.ssp-1#0A..4IF.mode#3DVal.DO.outf
(FormRvalue)#0A..4RETURN#0A#0A..2CASE.Pos:#0A..2CAS
E.Neg:#0A..2CASE.Not:#0A..4trans(h2!x,.Val)#0A..4ou
tf(op)#0A..4IF.mode#3DRef.DO.outf(FormLvalue)#0A..4
RETURN#0A#0A..2CASE.Noshare:#0A..4trans(h2!x,.Val)#0A
..4IF.mode#3DRef.DO.outf(FormLvalue)#0A..4RETURN#0A
#0A..2CASE.Comma:#0A..2{.LET.len.#3D.length(x)#0A..
4LET.r(x).BE.trans(x,.Ref)#0A..4mapb(r,.x)#0A..4out
fn(Tuple,.len)#0A..4ssp.:#3D.ssp.-.len.+.1#0A..4IF.
mode#3DRef.DO.outf(FormLvalue)#0A..4RETURN#0A..2}#0A
#0A..2CASE.Lambda:#0A..2{.LET.lab1.#3D.nextlab()#0A
..4LET.lab2.#3D.nextlab()#0A..4LET.lab3.#3D.nextlab
()#0A..4outfl(FormClosure,.lab1)#0A..4upssp(1)#0A..
4outfl(Jump,.lab2)#0A..4outlab(lab1)#0A..4transscop
e(x,.lab3,.Ref)#0A..4outlab(lab2)#0A..4IF.mode#3DRe
f.DO.outf(FormLvalue)#0A..4RETURN#0A..2}#0A#0A..2CA
SE.Colon:#0A..4IF.h4!x#3D0.DO#0A..4{.trnerr("Label.
%s.improperly.used",.h3!(h2!x))#0A..4}#0A..4outlab(
h4!x)#0A..4trans(h3!x,.mode)#0A..4RETURN#0A#0A..2CA
SE.Seq:#0A..4trans(h2!x,.Val)#0A..4outf(Lose1)#0A..
4trans(h3!x,.mode)#0A..4RETURN#0A#0A..2CASE.Valof:#0A
..2{.LET.lab1.#3D.nextlab()#0A..4LET.lab2.#3D.nextl
ab()#0A..4outfl(Reslink,.lab1)#0A..4ssp.:#3D.ssp+1#0A
..4IF.ssp>#3Dmsp.DO.msp.:#3D.ssp+1#0A..4{.LET.a,.b.
#3D.ssp,.msp#0A..6ssp,.msp.:#3D.0,.1#0A..6outfl(Sav
e,.lab2)#0A..6outf(Jj)#0A..6outf(FormLvalue)#0A..6o
utf(Declname)#0A..6outname(Name,.0,."**RES**")#0A..
6translabels(h2!x)#0A..6trans(h2!x,.Ref)#0A..6outf(
Return)#0A..6UNLESS.ssp#3D1.DO.trnerr("SSP.Error")#0A
..6outlabset(lab2,.msp)#0A..6ssp,.msp.:#3D.a,.b#0A.
.4}#0A..4outlab(lab1)#0A..4IF.mode#3DVal.DO.outf(Fo
rmRvalue)#0A..4RETURN#0A..2}#0A#0A..2CASE.Res:#0A..
4trans(h2!x,.Ref)#0A..4outf(Res)#0A..4ssp.:#3D.ssp-
1#0A..4RETURN#0A#0A..2CASE.Goto:#0A..4trans(h2!x,.V
al)#0A..4outf(Goto)#0A..4ssp.:#3D.ssp-1#0A..4RETURN
#0A#0A..2CASE.Cond:#0A..2{.LET.lab1.#3D.nextlab()#0A
..4LET.lab2.#3D.nextlab()#0A..4trans(h2!x,.Val)#0A.
.4outfl(JumpF,.lab1)#0A..4ssp.:#3D.ssp-1#0A..4trans
(h3!x,.mode)#0A..4outfl(Jump,.lab2)#0A..4outlab(lab
1)#0A..4ssp.:#3D.ssp-1#0A..4trans(h4!x,.mode)#0A..4
outlab(lab2)#0A..4RETURN#0A..2}#0A#0A..2CASE.While:
#0A..2{.LET.lab1.#3D.nextlab()#0A..4LET.lab2.#3D.ne
xtlab()#0A..4outlab(lab2)#0A..4trans(h2!x,.Val)#0A.
.4outfl(JumpF,.lab1)#0A..4ssp.:#3D.ssp-1#0A..4trans
(h3!x,.Val)#0A..4outf(Lose1)#0A..4outfl(Jump,.lab2)
#0A..4outlab(lab1)#0A..4outf(Dummy)#0A..4IF.mode#3D
Ref.DO.outf(FormLvalue)#0A..4RETURN#0A..2}#0A#0A..2
CASE.Ass:#0A..2{.LET.len.#3D.length(h2!x)#0A..4coml
ine.:#3D.h4!x#0A..4trans(h2!x,.Ref)#0A..4trans(h3!x
,.Val)#0A..4outfn(Update,.len)#0A..4ssp.:#3D.ssp-1#0A
..4IF.mode#3DRef.DO.outf(FormLvalue)#0A..4RETURN#0A
..2}#0A#0A..2CASE.Paren:#0A..4translabels(h2!x)#0A.
.4trans(h2!x,.mode)#0A..4RETURN#0A#0A..2CASE.Nil:#0A
..2CASE.Dummy:#0A..2CASE.True:#0A..2CASE.False:#0A.
.2CASE.Sys:#0A..4outf(op)#0A..4upssp(1)#0A..4IF.mod
e#3DRef.DO.outf(FormLvalue)#0A..4RETURN#0A#0A..2CAS
E.Name:#0A..4outf(mode#3DVal.->.LoadR,.LoadL)#0A..4
outname(x)#0A..4upssp(1)#0A..4RETURN#0A#0A..2CASE.I
nt:#0A..4outfn(LoadN,.h2!x)#0A..4upssp(1)#0A..4RETU
RN#0A#0A..2CASE.Real:.#0A..4outfn(LoadF,.h2!x,.h3!x
)#0A..4upssp(1)#0A..4RETURN#0A#0A..2CASE.Stringcons
t:#0A..4outf(LoadS)#0A..4outstring(x)#0A..4upssp(1)
#0A..4IF.mode#3DRef.DO.outf(FormLvalue)#0A..4RETURN
#0A..}#0A}#0A#0AAND.findlabels(x).#3D.VALOF#0A{.IF.
x#3D0.RESULTIS.0#0A..SWITCHON.h1!x.INTO#0A..{.DEFAU
LT:#0A..4RESULTIS.0#0A#0A..2CASE.Colon:#0A..2{.LET.
lab.#3D.nextlab()#0A..4h4!x.:#3D.lab#0A..4outfsl(De
cllabel,.h2!x,.lab)#0A..4RESULTIS.1.+.findlabels(h3
!x)#0A..2}#0A#0A..2CASE.Paren:#0A..4RESULTIS.findla
bels(h2!x)#0A#0A..2CASE.Cond:#0A..4RESULTIS.findlab
els(h3!x).+#0A..13findlabels(h4!x)#0A#0A..2CASE.Whi
le:#0A..4RESULTIS.findlabels(h3!x)#0A#0A..2CASE.Seq
:#0A..4RESULTIS.findlabels(h2!x).+#0A..13findlabels
(h3!x)#0A..}#0A}#0A#0AAND.translabels(x).BE#0A{.LET
.n.#3D.findlabels(x)#0A..IF.n.DO.outf(SetlabEs,.n)#0A
}#0A#0AAND.transrhs(x).BE#0A{.IF.x#3D0.RETURN#0A#0A
..SWITCHON.h1!x.INTO#0A..{.DEFAULT:#0A..4RETURN#0A#0A
..2CASE.And:#0A..2{.LET.len.#3D.length(x)#0A..4mapb
(transrhs,.x)#0A..4outfn(Tuple,.len)#0A..4ssp.:#3D.
ssp.-.len.+.1#0A..4outf(FormLvalue)#0A..4RETURN#0A.
.2}#0A#0A..2CASE.Valdef:#0A..4trans(h3!x,.Ref)#0A..
4RETURN#0A#0A..2CASE.Rec:#0A..4outf(LoadE)#0A..4ups
sp(1)#0A..4declguesses(h2!x)#0A..4transrhs(h2!x)#0A
..4initnames(h2!x)#0A..4loaddefinee(h2!x)#0A..4outf
(RestoreE1)#0A..4ssp.:#3D.ssp-1#0A..4RETURN#0A#0A..
2CASE.Within:#0A..2{.LET.lab1.#3D.nextlab()#0A..4LE
T.lab2.#3D.nextlab()#0A..4transrhs(h2!x)#0A..4outfl
(Blocklink,.lab1)#0A..4IF.ssp#3Dmsp.DO.msp.:#3D.ssp
+1#0A..4{.LET.a,.b.#3D.ssp,.msp#0A..6ssp,.msp.:#3D.
0,.1#0A..6outfl(Save,.lab2)#0A..6declnames(h2!x)#0A
..6transrhs(h3!x)#0A..6outf(Return)#0A..6UNLESS.ssp
#3D1.DO.trnerr("SSP.error")#0A..6outlabset(lab2,.ms
p)#0A..6ssp,.msp.:#3D.a,.b#0A..4}#0A..4outlab(lab1)
#0A..4RETURN#0A..2}#0A..}#0A}#0A#0AAND.declnames(x)
.BE#0A{.IF.x#3D0.RETURN#0A..SWITCHON.h1!x.INTO#0A..
{.DEFAULT:#0A..4trnerr("Bad.bound.variable.list")#0A
..4RETURN#0A#0A..2CASE.Name:#0A..4outf(Declname)#0A
..4outname(x)#0A..4ssp.:#3D.ssp-1#0A..4RETURN#0A#0A
..2CASE.Comma:#0A..4outfn(Declnames,.length(x))#0A.
.4ssp.:#3D.ssp-1#0A..4mapf(outname,.x)#0A..4RETURN#0A
#0A..2CASE.And:#0A..2{.LET.len.#3D.length(x)#0A..4o
utfn(Members,.len)#0A..4upssp(len-1)#0A..4mapf(decl
names,.x)#0A..4RETURN#0A..2}#0A#0A..2CASE.Rec:#0A..
2CASE.Valdef:#0A..4declnames(h2!x)#0A..4RETURN#0A#0A
..2CASE.Within:#0A..4declnames(h3!x)#0A..4RETURN#0A
#0A..2CASE.Mpt:#0A..4outf(TestEmpty)#0A..4ssp.:#3D.
ssp-1#0A..4RETURN#0A..}#0A}#0A#0AAND.loaddefinee(x)
.BE#0A{.IF.x#3D0.RETURN#0A..SWITCHON.h1!x.INTO#0A..
{.DEFAULT:#0A..4trnerr("Bad.definition")#0A..4RETUR
N#0A#0A..2CASE.Name:#0A..4outf(LoadR);.outname(x)#0A
..4upssp(1)#0A..4outf(FormLvalue)#0A..4RETURN#0A#0A
..2CASE.And:#0A..2CASE.Comma:#0A..2{.LET.len.#3D.le
ngth(x)#0A..4mapb(loaddefinee,.x)#0A..4outfn(Tuple,
.len)#0A..4ssp.:#3D.ssp.-.len.+.1#0A..4outf(FormLva
lue)#0A..4RETURN#0A..2}#0A#0A..2CASE.Rec:#0A..2CASE
.Valdef:#0A..4loaddefinee(h2!x)#0A..4RETURN#0A#0A..
2CASE.Within:#0A..4loaddefinee(h3!x)#0A..4RETURN#0A
#0A..}#0A}#0A#0AAND.declguesses(x).BE#0A{.IF.x#3D0.
RETURN#0A..SWITCHON.h1!x.INTO#0A..{.DEFAULT:#0A..4t
rnerr("Bad.definition")#0A..4RETURN#0A#0A..2CASE.Na
me:#0A..4outf(LoadGuess)#0A..4IF.ssp#3Dmsp.DO.msp.:
#3D.ssp+1#0A..4outf(Declname);.outname(x)#0A..4RETU
RN#0A#0A..2CASE.And:#0A..2CASE.Comma:#0A..4mapf(dec
lguesses,.x)#0A..4RETURN#0A#0A..2CASE.Rec:#0A..2CAS
E.Valdef:#0A..4declguesses(h2!x)#0A..4RETURN#0A#0A.
.2CASE.Within:#0A..4declguesses(h3!x)#0A..4RETURN#0A
..}#0A}#0A#0AAND.initnames(x).BE#0A{.IF.x#3D0.RETUR
N#0A..SWITCHON.h1!x.INTO#0A..{.DEFAULT:#0A..4trnerr
("Bad.definition")#0A..4RETURN#0A#0A..2CASE.Name:#0A
..4outf(Initname);.outname(x)#0A..4ssp.:#3D.ssp-1#0A
..4RETURN#0A#0A..2CASE.And:#0A..2{.LET.len.#3D.leng
th(x)#0A..4outfn(Members,.len)#0A..4upssp(len-1)#0A
..4outfn(Initnames,.len)#0A..4mapf(initnames,.x)#0A
..4RETURN#0A..2}#0A#0A..2CASE.Comma:#0A..2{.LET.len
.#3D.length(x)#0A..4outfn(Initnames,.len)#0A..4ssp.
:#3D.ssp-1#0A..4mapf(outname,.x)#0A..4RETURN#0A..2}
#0A#0A..2CASE.Rec:#0A..2CASE.Valdef:#0A..4initnames
(h2!x)#0A..4RETURN#0A#0A..2CASE.Within:#0A..4initna
mes(h3!x)#0A..4RETURN#0A..}#0A}#0A#0AAND.transscope
(x,.n,.mode).BE#0A{.LET.a,.b.#3D.ssp,.msp#0A..ssp,.
msp.:#3D.1,.1#0A..outfn(Save,.n)#0A..declnames(h2!x
)#0A..translabels(h3!x)#0A..trans(h3!x,.mode)#0A..o
utf(Return)#0A..UNLESS.ssp#3D1.DO.trnerr("SSP.error
")#0A..outlabset(n,.msp)#0A..ssp,.msp.:#3D.a,.b#0A}
#0A#0AAND.mapf(r,.x).BE#0A{.LET.len.#3D.h2!x#0A..FO
R.i.#3D.1.TO.len.DO.r(x!(i+1))#0A}#0A#0AAND.mapb(r,
.x).BE#0A{.LET.len.#3D.h2!x#0A..FOR.i.#3D.len.TO.1.
BY.-1.DO.r(x!(i+1))#0A}#0A#0AAND.length(x).#3D.h1!x
#3DAnd.|.h1!x#3DComma.->.h2!x,.1#0A#0AAND.upssp(x).
BE#0A{.ssp.:#3D.ssp+x#0A..IF.ssp>msp.DO.msp.:#3D.ss
p#0A}#0A#0AAND.wrf(form,.a,.b,.c).BE.IF.optCode.DO.
writef(form,.a,.b,.c)#0A#0AAND.outf(op).BE#0A{.wrf(
"%s*n",.opstr(op))#0A..putc(op)#0A}#0A#0AAND.outnam
e(x).BE#0A{.LET.name.#3D.@h3!x#0A..LET.len.#3D.name
%0#0A..//outfn(Name,.len)#0A..FOR.i.#3D.1.TO.len.DO
.putc(name%i)#0A..IF.optCode.DO.writef(".%s*n",.nam
e)#0A}#0A#0AAND.outstring(x).BE#0A{.LET.name.#3D.@h
3!x#0A..LET.len.#3D.name%0#0A..outfn(Stringconst,.l
en)#0A..FOR.i.#3D.1.TO.len.DO.putc(name%i)#0A..IF.o
ptCode.DO.writef(".%s",.name)#0A}#0A#0AAND.outfv(op
,.var).BE#0A{.wrf("%s.%s*n",.opstr(op),.var)#0A..pu
tc(op);.putc(var)#0A}#0A#0AAND.outn(a).BE#0A{.wrf("
%n*n",.a)#0A..putc(a)#0A}#0A#0AAND.outfn(op,.a).BE#0A
{.wrf("%s.%n*n",.opstr(op),.a)#0A..putc(op);.putc(a
)#0A}#0A#0AAND.outfnn(op,a,.b).BE#0A{.wrf("%s.%n.%n
*n",.opstr(op),.a,.b)#0A..putc(op);.putc(a);.putc(b
)#0A}#0A#0AAND.outfsl(op,a,.b).BE#0A{.wrf("%s.%s.L%
n*n",.opstr(op),.a,.b)#0A..putc(op);.putc(a);.putc(
b)#0A}#0A#0AAND.outfl(op,.lab).BE#0A{.wrf("%s.L%n*n
",.opstr(op),.lab)#0A..putc(op);.putref(lab)#0A}#0A
#0AAND.outlab(lab).BE#0A{.wrf("Lab.L%n*n",.lab)#0A.
.setlab(lab,.codep)#0A}#0A#0AAND.outlabset(lab,.val
).BE#0A{.wrf("L%n#3D%n*n",.lab,.val)#0A..setlab(lab
,.val)#0A}#0A#0AAND.outentry(l1,.l2).BE#0A{.wrf("En
try.L%n.L%n*n",.l1,.l2)#0A..putref(l2)#0A..setlab(l
1,.codep)#0A}#0A#0AAND.outstatvec(lab,.a).BE#0A{.wr
f("Statvec.L%n.%n*n",.lab,.a)#0A..setlab(lab,.datap
)#0A..FOR.i.#3D.0.TO.a-1.DO.putd(0)#0A}#0A#0AAND.ou
tvar(lab).BE#0A{.wrf("Var.L%n*n",.lab)#0A..setlab(l
ab,.datap)#0A..putd(0)#0A}#0A.#0AAND.putc(w).BE.TES
T.codep>codet#0A..13THEN.trnerr("More.code.space.ne
eded")#0A..13ELSE.{.codev!codep.:#3D.w#0A..20codep.
:#3D.codep+1#0A..18}#0A#0AAND.putd(w).BE.TEST.datap
>datat#0A..13THEN.trnerr("More.data.space.needed")#0A
..13ELSE.{.datav!datap.:#3D.w#0A..20datap.:#3D.data
p+1#0A..18}#0A#0AAND.putref(lab).BE.TEST.codep>code
t#0A..17THEN.trnerr("More.code.space.needed")#0A..1
7ELSE.{.codev!codep.:#3D.refv!lab#0A..24refv!lab.:#3D
.codep#0A..24codep.:#3D.codep+1#0A..22}#0A#0AAND.se
tlab(lab,.addr).BE.labv!lab.:#3D.addr#0A#0AAND.next
lab().#3D.VALOF#0A{.TEST.labnumber>#3Dlabmax#0A..TH
EN.fatalerr("More.label.space.needed")#0A..ELSE.lab
number.:#3D.labnumber.+.1#0A..RESULTIS.labnumber#0A
}#0A.#0A#0AAND.resolvelabels().BE.FOR.lab.#3D.1.TO.
labnumber.DO#0A{.LET.p.#3D.refv!lab#0A..LET.labval.
#3D.labv!lab#0A..IF.p.&.labval<0.TEST.lab#3D1.THEN.
trnerr("start.not.defined")#0A..27ELSE.trnerr("Labe
l.%n.unset",.lab)#0A..WHILE.p.DO.{.LET.np.#3D.codev
!p#0A..13codev!p,.p.:#3D.labval,.np#0A..11}#0A}#0A#0A
AND.interpret(regs,.mem).#3D.VALOF#0A{.//.Execute.o
ne.or.more.SCED.instructions#0A..//.sp.holds.S#0A..
//.pc.holds.C#0A..//.env.holds.E#0A..//.dump.holds.
D.->.previous.[S,.E,.C,.D]#0A..//.count.is.the.coun
t.of.instruction.executed#0A..LET.retcode.#3D.0#0A#0A
..{.//.Start.of.main.loop#0A..2LET.op.#3D.codev!pc.
.14//.Fetch.next.instruction#0A..2IF.optTrace.DO#0A
..2{.writef("%i5:.%t8",.pc,.opstr(op))#0A..4//IF.ha
sOperand(op).DO.writef(".%n",.pc!1)#0A..4newline()#0A
..2}#0A..2IF.count<#3D0.DO.{.retcode.:#3D.3;.BREAK.
}.//.Zero.count#0A..2count.:#3D.count-1#0A..2pc.:#3D
.pc+1#0A#0A..2SWITCHON.op.INTO#0A..2{.DEFAULT:..4re
tcode.:#3D.1;..2BREAK..2//.Unknown.op.code#0A#0A..4
CASE.Halt:..2BREAK#0A/*#0A..4CASE.Laddr:..1sp.:#3D.
sp+1;.sp!0.:#3D.!pc;..5pc.:#3D.pc+1;.LOOP#0A..4CASE
.Ln:..4sp.:#3D.sp+1;.sp!0.:#3D.!pc;..5pc.:#3D.pc+1;
.LOOP#0A..4CASE.Lp:..4sp.:#3D.sp+1;.sp!0.:#3D.pp!(!
pc);..pc.:#3D.pc+1;.LOOP#0A..4CASE.Llp:..3sp.:#3D.s
p+1;.sp!0.:#3D.pp+!pc-mem;pc.:#3D.pc+1;.LOOP#0A..4C
ASE.Ll:..4sp.:#3D.sp+1;.sp!0.:#3D.mem!(!pc);.pc.:#3D
.pc+1;.LOOP#0A..4CASE.Sp:..4pp!(!pc).:#3D.sp!0;.sp.
:#3D.sp-1;..pc.:#3D.pc+1;.LOOP#0A..4CASE.Sl:..4mem!
(!pc):#3D.sp!0;.sp.:#3D.sp-1;..pc.:#3D.pc+1;.LOOP#0A
#0A..4CASE.Apply:.{.LET.opp,.retaddr.#3D.pp,.pc+1#0A
..18pp,.pc.:#3D.pp+!pc,.sp!0+mem#0A..18pp!0,.pp!1,.
pp!2.:#3D.opp-mem,.retaddr-mem,.pc-mem#0A..18sp.:#3D
.pp+2#0A..18LOOP#0A..16}#0A#0A..4CASE.Ret:..3res.:#3D
.sp!0#0A..16{.LET.npp,.npc.#3D.pp!0+mem,.pp!1+mem#0A
..18sp.:#3D.pp-1#0A..18pp,.pc.:#3D.npp,.npc#0A..18L
OOP#0A..16}#0A..4CASE.Neg:..3sp!0.:#3D..-..sp!0;..2
0LOOP#0A..4CASE.Not:..3sp!0.:#3D.NOT.sp!0;..20LOOP#0A
..4CASE.Mult:..3sp.:#3D.sp-1;.sp!0.:#3D.sp!0..*..sp
!1;..3LOOP#0A..4CASE.Div:..3sp.:#3D.sp-1;.sp!0.:#3D
.sp!0../..sp!1;..3LOOP#0A..4CASE.Mod:..3sp.:#3D.sp-
1;.sp!0.:#3D.sp!0.REM.sp!1;..3LOOP#0A..4CASE.Add:..
3sp.:#3D.sp-1;.sp!0.:#3D.sp!0..+..sp!1;..3LOOP#0A..
4CASE.Minus:..3sp.:#3D.sp-1;.sp!0.:#3D.sp!0..-..sp!
1;..3LOOP#0A..4CASE.Eq:..4sp.:#3D.sp-1;.sp!0.:#3D.s
p!0..#3D..sp!1;..3LOOP#0A..4CASE.Ne:..4sp.:#3D.sp-1
;.sp!0.:#3D.sp!0.~#3D..sp!1;..3LOOP#0A..4CASE.Le:..
4sp.:#3D.sp-1;.sp!0.:#3D.sp!0.<#3D..sp!1;..3LOOP#0A
..4CASE.Ge:..4sp.:#3D.sp-1;.sp!0.:#3D.sp!0.>#3D..sp
!1;..3LOOP#0A..4CASE.Lt:..4sp.:#3D.sp-1;.sp!0.:#3D.
sp!0..<..sp!1;..3LOOP#0A..4CASE.Gt:..4sp.:#3D.sp-1;
.sp!0.:#3D.sp!0..>..sp!1;..3LOOP#0A..4CASE.Logand:.
.sp.:#3D.sp-1;.sp!0.:#3D.sp!0..&..sp!1;..3LOOP#0A..
4CASE.Logor:..1sp.:#3D.sp-1;.sp!0.:#3D.sp!0..|..sp!
1;..3LOOP#0A..4CASE.Jt:..4sp.:#3D.sp-1;.pc.:#3D.sp!
1->!pc+mem,pc+1;..LOOP#0A..4CASE.Jf:..4sp.:#3D.sp-1
;.pc.:#3D.sp!1->pc+1,!pc+mem;..LOOP#0A..4CASE.Jump:
..2pc.:#3D.!pc+mem;..23LOOP#0A..4CASE.Res:..3sp.:#3D
.sp-1;.res.:#3D.sp!1#0A..4CASE.Sys:..3sp.:#3D.pp.+.
!pc.-.1#0A..18pc.:#3D.pc+1#0A..18SWITCHON.sp!1.INTO
#0A..18{.DEFAULT:.writef("*nBad.sys(%n,#2E#2E1).cal
l*n",.sp!1)#0A..29retcode..:#3D.2;..13BREAK..1#0A..
20CASE.0:..retcode..:#3D.sp!2;..10BREAK#0A..20CASE.
1:..res.:#3D.interpret(sp!2,.mem);.LOOP#0A..20CASE.
2:..optTrace.:#3D.sp!2;..10LOOP#0A..20CASE.3:..res.
:#3D.count;.count.:#3D.sp!2;.LOOP#0A..18}#0A*/#0A..
2}#0A..}.REPEAT#0A#0A..RESULTIS.retcode#0A}#0A#0AAN
D.printf(mem,.form,.p).BE#0A{.LET.fmt.#3D.form+mem#0A
..LET.i.#3D.0#0A#0A..{.LET.k.#3D.fmt%i#0A..2i.:#3D.
i+1#0A..2IF.k#3D0.RETURN#0A..2IF.k#3D'%'.DO#0A..2{.
LET.n.#3D.0;#0A..4{.k.:#3D.fmt%i#0A..6i.:#3D.i+1#0A
..6UNLESS.'0'<#3Dk<#3D'9'.BREAK#0A..6n.:#3D.10*n.+.
k.-.'0'#0A..4}.REPEAT#0A..4SWITCHON.k.INTO#0A..4{.D
EFAULT:..wrch(k);.LOOP#0A..6CASE.'d':.writed..(!p,.
.3n);.p.:#3D.p+1;.LOOP#0A..6CASE.'s':.wrs..3(mem+!p
,.n);.p.:#3D.p+1;.LOOP#0A..6CASE.'x':.writehex(!p,.
.3n);.p.:#3D.p+1;.LOOP#0A..4}#0A..2}#0A..2wrch(k)#0A
..}.REPEAT#0A}#0A#0AAND.wrs(s,.n).BE#0A{.LET.len.#3D
.0#0A..WHILE.s%len.DO.len.:#3D.len+1#0A..FOR.i.#3D.
len+1.TO.n.DO.wrch('.')#0A..FOR.i.#3D.0.TO.len-1.DO
.wrch(s%i)#0A}#0A#0AAND.hasOperand(op).#3D.VALOF.SW
ITCHON.op.INTO#0A{.//CASE.Fnrn:CASE.Rtrn:CASE.Lres:
CASE.Halt:#0A..//CASE.Vecap:CASE.Ind:CASE.Stind:CAS
E.Neg:CASE.Not:#0A..//CASE.Mult:CASE.Div:CASE.Mod:C
ASE.Plus:CASE.Minus:#0A..//CASE.Eq:CASE.Ne:CASE.Le:
CASE.Ge:CASE.Lt:CASE.Gt:#0A..//CASE.Lsh:CASE.Rsh:CA
SE.And:CASE.Or:CASE.Xor:#0A..10RESULTIS.FALSE#0A#0A
..DEFAULT:..RESULTIS.TRUE#0A}#0A#0A1

######com/playgraph.b#
/*#0D#0AThis.will.be.modified.to.convert.graph.data
.generated.by.playmus#0D#0Ainto.a.#2Ebmp.picture.to
.show.how.well.the.synchronisation.mechanism#0D#0Aw
orks#2E#0D#0A#0D#0AImplemented.by.Martin.Richards.(
c).September.2011#0D#0A#0D#0AUsage:#0D#0A#0D#0Aplay
graph."FROM,TO/K,X/N,Y/N,TEXT/K"#0D#0A#0D#0AFROM..2
if.given.is.the.graphdata.file#2E.Default.is.gdata#2E
#0D#0ATO..4is.the.filename.for.the.#2Ebmp.picture.-
-.default.pic#2Ebmp#0D#0AX..5X.size.in.pixels,.defa
ult.2001#0D#0AY..5Y.size.in.pixels,.default.1500#0D
#0ATEXT..2give.the.title.of.the.graph#0D#0A#0D#0ACh
ange.history#0D#0A#0D#0A13/09/2011#0D#0AStarted.imp
lementation,.based.on.anawav#2Eb#2E#0D#0A#0D#0A*/#0D
#0A#0D#0AGET."libhdr"#0D#0A#0D#0AGLOBAL.{#0D#0A..fr
omname:ug#0D#0A..tostream#0D#0A..stdin#0D#0A..stdou
t#0D#0A..debug#0D#0A..toname#0D#0A..tostream#0D#0A.
.toname#0D#0A..minrt#0D#0A..maxrt#0D#0A..minmt#0D#0A
..maxmt#0D#0A..flag#0D#0A..rtrange#0D#0A..mtrange#0D
#0A..rtscale#0D#0A..mtscale#0D#0A..oer#0D#0A..oem#0D
#0A..erate#0D#0A#0D#0A..title#0D#0A}#0D#0A#0D#0A//.
Insert.the.graphics.library#0D#0AMANIFEST.{.graphic
sgbase#3D400.}#0D#0A#0D#0AGET."graphics"#0D#0AGET."
graphics#2Eb"#0D#0A#0D#0ALET.start().#3D.VALOF#0D#0A
{.LET.argv.#3D.VEC.50#0D#0A#0D#0A..stdout.:#3D.outp
ut()#0D#0A..tostream.:#3D.0#0D#0A..debug.:#3D.0#0D#0A
..title.:#3D.0#0D#0A#0D#0A..writef("playgraph.enter
ed*n")#0D#0A#0D#0A..UNLESS.rdargs("FROM,TO/K,X/N,Y/
N,TEXT/K",.argv,.50).DO#0D#0A..{.writef("Bad.argume
nts.for.playgraph*n")#0D#0A..2RESULTIS.0#0D#0A..}#0D
#0A#0D#0A..fromname.:#3D."gdata"#0D#0A..toname..1:#3D
."pic#2Ebmp"#0D#0A..xsize.:#3D.1001#0D#0A..ysize.:#3D
..000600#0D#0A#0D#0A..//.Default.estimated.play.lin
e#0D#0A..oer,.oem,.erate.:#3D.0,.0,.1_001#0D#0A#0D#0A
..IF.argv!0.DO.fromname.:#3D.argv!0..4//.FROM..5gra
phdata#0D#0A..IF.argv!1.DO.toname..1:#3D.argv!1..4/
/.TO/K..5The.bmp.file.name#0D#0A..IF.argv!2.DO.xsiz
e..2:#3D.!(argv!2)..1//.X/N#0D#0A..IF.argv!3.DO.ysi
ze..2:#3D.!(argv!3)..1//.Y/N#0D#0A..IF.argv!4.DO.ti
tle..2:#3D.argv!4..4//.TEXT/K#0D#0A#0D#0A..sawritef
("*nConverting.%s.to.%s.(%nx%n)*n",.fromname,.tonam
e,.xsize,.ysize)#0D#0A#0D#0A..UNLESS.opengraphics(x
size,.ysize).DO#0D#0A..{.writef("Unable.to.open.the
.graphics.library*n")#0D#0A..2GOTO.fin#0D#0A..}#0D#0A
#0D#0A..drawgraph(xsize,.ysize)#0D#0A#0D#0Afin:#0D#0A
sawritef("*nfin:.reached*n")#0D#0A..IF.tostream.DO.
endstream(tostream)#0D#0A..IF.canvas.DO.freevec(can
vas)#0D#0A..selectoutput(stdout)#0D#0A..//writef("r
eturn.code.#3D.%n*n",.0)#0D#0A#0D#0A..RESULTIS.0#0D
#0A}#0D#0A#0D#0AAND.colour(ch).#3D.VALOF.SWITCHON.c
h.INTO#0D#0A{.DEFAULT:..RESULTIS.col_black#0D#0A#0D
#0A..CASE.'+':.RESULTIS.col_black#0D#0A..CASE.'-':.
RESULTIS.col_black-5#0D#0A..CASE.'B':.RESULTIS.col_
black-10#0D#0A..CASE.'S':.RESULTIS.col_black-20#0D#0A
#0D#0A..CASE.'M':.RESULTIS.col_r#0D#0A..CASE.'N':.R
ESULTIS.col_g#0D#0A..CASE.'G':.RESULTIS.col_b+20#0D
#0A..CASE.'E':.RESULTIS.col_b#0D#0A..CASE.'C':.RESU
LTIS.col_rb#0D#0A}#0D#0A#0D#0AAND.scangraphdata(nam
e,.firstpass).BE#0D#0A{.LET.rt,.mt,.weight.#3D.0,.0
,.weight#0D#0A..LET.now,.rate.#3D.0,.0#0D#0A..LET.p
os.#3D.0#0D#0A#0D#0A..LET.fromstream.#3D.findinput(
name)#0D#0A..UNLESS.fromstream.DO#0D#0A..{.writef("
Unable.to.open.file:.%s*n",.name)#0D#0A..2RETURN#0D
#0A..}#0D#0A#0D#0A..selectinput(fromstream)#0D#0A#0D
#0A..{.LET.ch.#3D.rdch()#0D#0Asw:#0D#0A..2SWITCHON.
ch.INTO#0D#0A..2{.DEFAULT:#0D#0A..6pos.:#3D.pos.+.1
#0D#0A..6LOOP#0D#0A#0D#0A..4CASE.endstreamch:#0D#0A
..6BREAK#0D#0A#0D#0A..4CASE.'*n':#0D#0A..4CASE.'*p'
:#0D#0A..6pos.:#3D.0#0D#0A..6LOOP#0D#0A#0D#0A..4CAS
E.'#23':#0D#0A..6pos.:#3D.pos+1#0D#0A..6IF.pos#3D1.
DO#0D#0A..6{.ch.:#3D.rdch()#0D#0A//UNLESS.firstpass
.DO.sawritef("#23%c.",.ch)#0D#0A..8SWITCHON.ch.INTO
#0D#0A..8{.DEFAULT:#0D#0A..12GOTO.sw#0D#0A#0D#0A..1
0CASE.'T':..//.#23T.text#0D#0A..12{.ch.:#3D.rdch()#0D
#0A..14IF.ch#3D'*n'.|.ch#3Dendstreamch.BREAK#0D#0A.
.14UNLESS.firstpass.DO#0D#0A..14{.plotch(ch)#0D#0A/
/sawritef("#23T.ch#3D'%c'*n",.ch)#0D#0A..14}#0D#0A.
.12}.REPEAT#0D#0A#0D#0A..12plotch('*n')#0D#0A..12GO
TO.sw#0D#0A#0D#0A..10CASE.'B':..//.#23B.rt.mt.weigh
t#0D#0A..10CASE.'S':..//.#23S.rt.mt.weight#0D#0A..1
0CASE.'M':..//.#23M.rt.mt.weight#0D#0A#0D#0A..13rt.
:#3D.readn()#0D#0A..13mt.:#3D.readn().//-.rt#0D#0A.
.13weight.:#3D.readn()#0D#0A..13TEST.firstpass#0D#0A
..13THEN.{.TEST.flag#0D#0A..20THEN.{.minrt,.maxrt.:
#3D.rt,.rt#0D#0A..27minmt,.maxmt.:#3D.mt,.mt#0D#0A.
.27flag.:#3D.FALSE#0D#0A..25}#0D#0A..20ELSE.{.IF.rt
<minrt.DO.minrt.:#3D.rt#0D#0A..27IF.rt>maxrt.DO.max
rt.:#3D.rt#0D#0A..27IF.mt<minmt.DO.minmt.:#3D.mt#0D
#0A..27IF.mt>maxmt.DO.maxmt.:#3D.mt#0D#0A..25}#0D#0A
..17}#0D#0A..13ELSE.{.wrpixel33(rtscale(rt),.mtscal
e(mt),.colour(ch))#0D#0A..18}#0D#0A..13LOOP#0D#0A..
22#0D#0A..10CASE.'A':..//.#23A.rt.note.amp#0D#0A..1
0{..LET.note,.amp.#3D.?,.?#0D#0A..13rt..1:#3D.readn
()#0D#0A..13note.:#3D.readn()#0D#0A..13amp..:#3D.re
adn()#0D#0A..13TEST.firstpass#0D#0A..13THEN.{.TEST.
flag#0D#0A..20THEN.{.//minrt,.maxrt.:#3D.rt,.rt#0D#0A
..27//flag.:#3D.FALSE#0D#0A..25}#0D#0A..20ELSE.{.//
IF.rt<minrt.DO.minrt.:#3D.rt#0D#0A..27//IF.rt>maxrt
.DO.maxrt.:#3D.rt#0D#0A..25}#0D#0A..17}#0D#0A..13EL
SE.{.amp.:#3D.amp/50#0D#0A..20IF.amp>255.DO.amp.:#3D
.255#0D#0A..20wrpixel33(rtscale(rt),.notescale(note
),.amp)#0D#0A..18}#0D#0A..13LOOP#0D#0A..10}#0D#0A..
22#0D#0A..10CASE.'N':..//.#23N.rt.mt.weight.notestr
#0D#0A..13rt.:#3D.readn()#0D#0A..13mt.:#3D.readn()#0D
#0A..13weight.:#3D.readn()#0D#0A..13TEST.firstpass#0D
#0A..13THEN.{.TEST.flag#0D#0A..20THEN.{.minrt,.maxr
t.:#3D.rt,.rt#0D#0A..27minmt,.maxmt.:#3D.mt,.mt#0D#0A
..27flag.:#3D.FALSE#0D#0A..25}#0D#0A..20ELSE.{.IF.r
t<minrt.DO.minrt.:#3D.rt#0D#0A..27IF.rt>maxrt.DO.ma
xrt.:#3D.rt#0D#0A..27IF.mt<minmt.DO.minmt.:#3D.mt#0D
#0A..27IF.mt>maxmt.DO.maxmt.:#3D.mt#0D#0A..25}#0D#0A
..17}#0D#0A..13ELSE.{.LET.x..#3D.rtscale(rt)#0D#0A.
.20LET.y..#3D.mtscale(mt)#0D#0A..20wrpixel33(x,..y,
.colour(ch))#0D#0A..18}#0D#0A..13LOOP#0D#0A..22#0D#0A
..10CASE.'+':..//.#23+.oer.oem.erate#0D#0A..10CASE.
'-':..//.#23-.oer.oem.erate#0D#0A#0D#0A..10CASE.'E'
:..//.#23E.oer.oem.erate#0D#0A..13//.We.have.a.new.
estimated.play.line#0D#0A..13oer..1:#3D.readn()#0D#0A
..13oem..1:#3D.readn()#0D#0A..13erate.:#3D.readn()#0D
#0A#0D#0A..13TEST.firstpass#0D#0A..13THEN.{.TEST.fl
ag#0D#0A..20THEN.{.minrt,.maxrt.:#3D.oer,.oer#0D#0A
..27minmt,.maxmt.:#3D.oem,.oem#0D#0A..27flag.:#3D.F
ALSE#0D#0A..25}#0D#0A..20ELSE.{.IF.oer<minrt.DO.min
rt.:#3D.oer#0D#0A..27IF.oer>maxrt.DO.maxrt.:#3D.oer
#0D#0A..27IF.oem<minmt.DO.minmt.:#3D.oem#0D#0A..27I
F.oem>maxmt.DO.maxmt.:#3D.oem#0D#0A..25}#0D#0A..17}
#0D#0A..13ELSE.{.LET.r,m.#3D.rtscale(oer),.mtscale(
oem)#0D#0A..20//wrpixel33(r,.m+20,.colour('E'))#0D#0A
..20IF.ch#3D'+'.DO.wrpixel33(r,.m+30,.colour(ch))#0D
#0A..20IF.ch#3D'-'.DO.wrpixel33(r,.m+10,.colour(ch)
)#0D#0A..18}#0D#0A..13LOOP#0D#0A..8}#0D#0A..6}#0D#0A
..2}#0D#0A#0D#0A..}.REPEAT#0D#0A..endstream(fromstr
eam)#0D#0A}#0D#0A#0D#0AAND.rtscale(rt).#3D.VALOF#0D
#0A{.LET.res.#3D.rtscale1(rt)#0D#0A..//sawritef("rt
scale:.rt#3D%n.minrt#3D%n.maxrt#3D%n.#3D>.%n*n",.rt
,.minrt,.maxrt,.res)#0D#0A..RESULTIS.res#0D#0A}#0D#0A
AND.rtscale1(rt).#3D.muldiv(rt-minrt,.xsize,.rtrang
e)#0D#0A#0D#0AAND.mtscale(mt).#3D.VALOF#0D#0A{.LET.
res.#3D.mtscale1(mt)#0D#0A..//sawritef("mtscale:.mt
#3D%n.minmt#3D%n.maxmt#3D%n.#3D>.%n*n",.mt,.minmt,.
maxmt,.res)#0D#0A..RESULTIS.res#0D#0A}#0D#0AAND.mts
cale1(mt).#3D.muldiv(mt-minmt,.ysize,.mtrange)#0D#0A
#0D#0AAND.notescale(note).#3D.(ysize*note)/127#0D#0A
#0D#0AAND.drawgraph(xsize,.ysize).BE#0D#0A{.FOR.x.#3D
.0.TO.xsize-1.DO#0D#0A..{.wrpixel(x,.0,.255)#0D#0A.
.2wrpixel(x,.1,.255)#0D#0A..2wrpixel(x,.ysize-1,.25
5)#0D#0A..2wrpixel(x,.ysize-2,.255)#0D#0A..}#0D#0A.
.FOR.y.#3D.0.TO.ysize-1.DO#0D#0A..{.wrpixel(0,.y,.2
55)#0D#0A..2wrpixel(1,.y,.255)#0D#0A..2wrpixel(xsiz
e-1,.y,.255)#0D#0A..2wrpixel(xsize-2,.y,.255)#0D#0A
..}#0D#0A#0D#0A..plotx,.ploty,.plotcolour.:#3D.10,.
260,.colour('+');.plotch('+')#0D#0A..plotx,.ploty,.
plotcolour.:#3D.10,.240,.colour('-');.plotch('-')#0D
#0A..plotx,.ploty,.plotcolour.:#3D.10,.220000,.colo
ur('B');.plotch('B')#0D#0A..plotx,.ploty,.plotcolou
r.:#3D.10,.200,.colour('S');.plotch('S')#0D#0A..plo
tx,.ploty,.plotcolour.:#3D.10,.180,.colour('M');.pl
otch('M')#0D#0A..plotx,.ploty,.plotcolour.:#3D.10,.
160,.colour('N');.plotch('N')#0D#0A..plotx,.ploty,.
plotcolour.:#3D.10,.140,.colour('G');.plotch('G')#0D
#0A..plotx,.ploty,.plotcolour.:#3D.10,.120,.colour(
'E');.plotch('E')#0D#0A..plotx,.ploty,.plotcolour.:
#3D.10,.100,.colour('C');.plotch('C')#0D#0A#0D#0A..
FOR.x.#3D.0.TO.xsize.DO#0D#0A..{.wrpixel33(x,.1,.25
5*x/xsize)#0D#0A..2wrpixel33(x,.4,.255*x/xsize)#0D#0A
..}#0D#0A#0D#0A..plotcolour.:#3D.col_r#0D#0A..movet
o(10,.ysize-20)#0D#0A#0D#0A..scangraphdata(fromname
,.TRUE)#0D#0A#0D#0A..minrt,.maxrt.:#3D.minrt-10,.ma
xrt+10#0D#0A..minmt,.maxmt.:#3D.minmt-200,.maxmt+20
0#0D#0A..rtrange.:#3D.maxrt.-.minrt#0D#0A..mtrange.
:#3D.maxmt.-.minmt#0D#0A#0D#0A..plotcolour.:#3D.col
_r#0D#0A..moveto(10,.ysize-20)#0D#0A#0D#0A..scangra
phdata(fromname,.FALSE)#0D#0A//abort(1001)#0D#0A#0D
#0A..IF.title.DO.plotstr(title)#0D#0A#0D#0A..//FOR.
c.#3D.32.TO.127.DO#0D#0A..//{.IF.c#3D'A'.|.c#3D'a'.
|.c#3D'0'.DO.plotch('*n')#0D#0A..//..plotch(c)#0D#0A
..//}#0D#0A..//plotstr("*nHello.World*nLast.line*n"
)#0D#0A#0D#0A..wrgraph(toname).//canvas,.pixeldatas
ize,.xsize,.ysize)#0D#0A}#0D#0A#0D#0AAND.r2m_msecs(
real_msecs,.or,.om,.rate).#3D.VALOF#0D#0A{.//.Conve
rt.real.time.msecs.to.midi.msecs#0D#0A..//.rate.is.
the.number.of.midi.msecs.per.real.second#0D#0A..//.
(or,.om).are.the.coordinates.of.a.point.on.the.play
.line#2E#0D#0A..LET.mt.#3D.om.+.muldiv(real_msecs-o
r,.rate,.1001)#0D#0Asawritef("r2m:.rt#3D%9#2E3d.or#3D
%9#2E3d.om#3D%9#2E3d.rate#3D%9#2E3d.#3D>.%9#2E3d*n"
,#0D#0A..8real_msecs,.or,.om,.rate,.mt)#0D#0A..RESU
LTIS.mt#0D#0A}#0D#0A#0D#0AAND.m2r_msecs(midi_msecs,
.or,.om,.rate).#3D.VALOF#0D#0A{.//.Convert.midi.mse
cs.to.real.time#0D#0A..//.rate.is.the.number.of.mid
i.msecs.per.real.second#0D#0A..//.(or,.om).are.the.
coordinates.of.a.point.on.the.play.line#2E#0D#0A..L
ET.rt.#3D.or.+.muldiv(midi_msecs-om,.1001,.rate)#0D
#0A..RESULTIS.rt#0D#0A}#0D#0A#0D#0A

######com/polltest.b#
GET."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.LET.tim
ev.#3D.VEC.2#0A..writef("Poll.Readch.test.entered*n
")#0A..FOR.i.#3D.1.TO.100.DO#0A..{.LET.ch.#3D.sys(S
ys_pollsardch)#0A..2datstamp(timev)#0A..2writef("%6
#2E3d.",.timev!1.MOD.60_001)#0A..2SWITCHON.ch.INTO#0A
..2{.DEFAULT:..writef("%i3.'%c'*n",.ch,.ch);.ENDCAS
E#0A..4CASE.-1:..writef("EOF*n");.ENDCASE#0A..4CASE
.-3:..writef("POLLCH*n");.ENDCASE#0A..2}#0A..2delay
(20)#0A..}#0A..writef("End.of.test*n")#0A}#0A

######com/posdebug.b#
//.The.program.allows.the.user.to.inspect.a.memory.
dump.of#0A//.the.Cintpos.system#2E#0A#0A//.Implemen
ted.by.Martin.Richards.(c).August.2000005#0A#0A//.U
sage:#0A#0A//.dumpdebug.[FROM.<image>]#0A#0A//.The.
FROM.argument.specifies.the.dump.image.file,#0A//.t
he.default.DUMP#2Emem#0A#0A2SECTION.".dumpdebug"#0A
#0AGET."libhdr"#0AGET."manhdr"#0A#0AGLOBAL#0A{.eof:
.ug#0A..pptr#0A..gptr#0A..cptr#0A..ctcb#0A..fsize#0A
#0A..regs#0A..tasktab#0A..devtab#0A..membase#0A..me
mlim#0A..memupb#0A..context#0A..trapregs..5//.#3Dbo
otregs.if.context#3D3,.#3Dklibregs.otherwise#0A..15
//.but.not.valid.if.context.is.1.or.2#0A..ch#0A..lc
h#0A..rch#0A..val#0A..vars#0A..style#0A..bpt_addr#0A
..bpt_instr#0A#0A..cohandid#0A..imagefilename..//.0
.or.name.of.the.image.file#0A#0A..//.Variables.used
.by.getimage,.nextword,.and.mem#2E#0A..datastream..
5//.scb.of.the.image.file#0A..blkcount..7//.repetit
ion.count.if.neg,.otherwise.size.of.block#0A..currw
ord..7//.current.word.from.image.file#0A..pagetab..
8//.The.page.table#0A..pagenoupb..6//.The.page.tabl
e.upb#0A#0A..rec_p;.rec_l..1//.Recovery.label.for.l
ongjump#0A}#0A#0AMANIFEST.{#0A..maxpri..2#3D.maxint
#0A#0A..sectnamesize.#3D.(11.+.bytesperword)/bytesp
erword#0A..routnamesize.#3D.(11.+.bytesperword)/byt
esperword#0A..nameoffset..1#3D.-routnamesize#0A..ve
cupb..5#3D.5001#0A#0A..r_a#3D0#0A..r_b#0A..r_c#0A..
r_p#0A..r_g#0A..r_st#0A..r_pc#0A..r_count#0A..r_mw#0A
..r_upb.#3D.r_mw#0A#0A..//.Contants.used.by.getimag
e.and.mem#2E#0A..pageshift.#3D.12..1//.12.is.15.sec
onds.faster.than.10#0A..pageupb.#3D.(1<<pageshift)-
1#0A..pagemask.#3D.pageupb#0A}#0A#0ALET.start().BE#0A
{.LET.argv..5#3D.VEC.50#0A..AND.datv..5#3D.VEC.1#0A
..AND.datstrings.#3D.VEC.12#0A..AND.sysin..4#3D.inp
ut()#0A..AND.sysout..3#3D.output()#0A..AND.imagefil
ename.#3D."DUMP#2Emem"#0A..AND.taskcount..#3D.0#0A#0A
..UNLESS.rdargs("FROM",.argv,.50).DO#0A..{.writes("
bad.arguments.for.DUMPDEBUG*n")#0A..2stop(20)#0A..}
#0A#0A..pagetab.:#3D.0#0A..cohandid.:#3D.sysin!scb_
task#0A#0A..IF.argv!0.DO.imagefilename.:#3D.argv!0#0A
..IF.imagefilename.UNLESS.getimage(imagefilename).D
O#0A..{.writef("Unable.to.load.image.file.%s*n",.im
agefilename)#0A..2RETURN#0A..}#0A#0A..rec_p,.rec_l.
:#3D.level(),.fin#0A#0A..tasktab.:#3D.mem(rootnode+
rtn_tasktab)#0A..devtab..:#3D.mem(rootnode+rtn_devt
ab)#0A..membase.:#3D.mem(rootnode+rtn_membase)#0A..
memlim..:#3D.mem(rootnode+rtn_memsize)#0A..context.
:#3D.mem(rootnode+rtn_context)#0A..//.context.#3D.1
..1SIGINT.received#0A..//.context.#3D.2..1SIGSEGV.r
eceived#0A..//.context.#3D.3..1dump.caused.by.fault
.in.BOOT.of.standalone.debug#0A..//.context.#3D.4..
1dump.requested.by.user.calling.sys(Sys_quit,.-2)#0A
..//.context.#3D.5..1non.zero.user.fault.code#0A../
/.context.#3D.6..1dump.requested.in.standalone.debu
g#0A#0A..SWITCHON.context.INTO#0A..{.DEFAULT:.sawri
tef("*nUnknown.context.#3D.%n*n",.context)#0A#0A..2
CASE.1:#0A..2CASE.2:.FOR.r.#3D.0.TO.7.DO.bootregs!r
.:#3D.0#0A..10bootregs!r_p.:#3D.mem(rootnode+rtn_la
stp)#0A..10bootregs!r_g.:#3D.mem(rootnode+rtn_lastg
)#0A#0A..2CASE.3:.//.In.BOOT#0A..2CASE.6:.//.In.sad
ebug.in.BOOT#0A..10trapregs.:#3D.bootregs;.ENDCASE#0A
#0A..2CASE.4:.//.sys(Sys_quit,.-2).called#0A..2CASE
.5:.//.Non.zero.user.code.#0A..10trapregs.:#3D.klib
regs;.ENDCASE#0A..}#0A#0A..writef("*nImage.File:.%s
",.imagefilename)#0A..IF.memdatstamp(datv).DO#0A..{
.dat_to_strings(datv,.datstrings)#0A#0A..2writef(".
.9Dated:..%s.%s*n",.@datstrings!0,.@datstrings!5)#0A
..}#0A..newline()#0A#0A..SWITCHON.context.INTO#0A..
{.DEFAULT:..writef("Unknown.reason.(%n).for.dumping
.memory",.context)#0A..12ENDCASE#0A..2CASE.1:..1wri
tef("Dump.caused.by.signal.SIGINT")#0A..12ENDCASE#0A
..2CASE.2:..1writef("Dump.caused.by.signal.SIGSEGV"
)#0A..12ENDCASE#0A..2CASE.3:..1writef("Dump.caused.
by.fault.in.BOOT.or.standalone.debug")#0A..12ENDCAS
E#0A..2CASE.4:..1writef("Dump.by.user.probably.call
ing:.dumpmem")#0A..12ENDCASE#0A..2CASE.5:..1writef(
"Dump.caused.by.non.zero.user.fault.code")#0A..12EN
DCASE#0A..2CASE.6:..1writef("Dump.requested.in.stan
dalone.debug")#0A..12ENDCASE#0A..}#0A..newline()#0A
#0A..{.LET.st.#3D.mem(rootnode+rtn_lastst)#0A..2SWI
TCHON.st.INTO#0A..2{.DEFAULT:.sawritef("Unexpected.
ST.value:.%n*n",.st);.ENDCASE#0A..4CASE.0:..sawrite
f("while.in.user.code.--.interrupts.enabled*n");.EN
DCASE#0A..4CASE.1:..sawritef("while.in.KLIB.--.inte
rrupts.disabled*n");..3ENDCASE#0A..4CASE.2:..sawrit
ef("while.in.BOOT.--.interrupts.disabled*n");..3END
CASE#0A..4CASE.3:..sawritef("while.in.the.ISR.--.in
terrupts.disabled*n");..ENDCASE#0A..2}#0A..}#0A#0A.
.#0A//..wrregs("BOOT.Registers",.bootregs)#0A//..wr
regs("KLIB.Registers",.klibregs)#0A//..wrregs("SAVE
.Registers",.saveregs)#0A//..wrregs("ISR..Registers
",.isrregs)#0A#0A..//dumprootnode()#0A#0A..IF.mem(k
libregs+r_st)#3D3.DO#0A..{.writef("*nThe.Interrupt.
Service.Routine.is.currently.running*n*n")#0A..}#0A
#0A..//.Use.exclusive.input.mode.while.in.dumpdebug
#0A..sendpkt(notinuse,.cohandid,.Action_exclusivein
put,.0,.0,.TRUE)#0A..dumpdebug()#0A..sendpkt(notinu
se,.cohandid,.Action_exclusiveinput,.0,.0,.FALSE)#0A
#0Afin:#0A..deleteimage()#0A}#0A#0AAND.rch().BE#0A{
.lch.:#3D.sendpkt(notinuse,.cohandid,.Action_exclus
iverdch,.0,.0)#0A..sawrch(lch)#0A..ch.:#3D.capitalc
h(lch)#0A}#0A#0AAND.memdatstamp(v).#3D.VALOF#0A{.LE
T.tv.#3D.rootnode+rtn_days#0A.#0A..v!0.:#3D.mem(tv+
0)#0A..v!1.:#3D.mem(tv+1)#0A#0A..RESULTIS.TRUE#0A}#0A
#0AAND.dumpdebug().#3D.VALOF#0A{.#0A..rec_p,.rec_l.
:#3D.level(),.recover.//.recovery.point.for.error()
#0A#0A..//.Initialise.the.standalone.debugger#0A..m
embase.:#3D.mem(rootnode+rtn_membase)#0A..memlim..:
#3D.membase.+.mem(rootnode+rtn_memsize)#0A..style..
1:#3D.'F'..17//.Default.printing.style#0A..val..3:#3D
.0#0A#0A..//.Get.the.breakpoint.vectors.from.the.ro
otnode#0A#0A..bpt_addr..:#3D.mem(rootnode+rtn_bptad
dr)#0A..bpt_instr.:#3D.mem(rootnode+rtn_bptinstr)#0A
..vars..4:#3D.mem(rootnode+rtn_dbgvars)#0A#0A..FOR.
i.#3D.0.TO.9.DO..10//.Remove.all.BRK.instructions.(
if.any)#0A..{.LET.ba.#3D.mem(bpt_addr+i)#0A..2//wri
tef("bpt.%n:.addr:.%i6..2instr:.%n*n",.i,.ba,.mem(b
pt_instr+i))#0A..2IF.ba.DO.stmemb(0,.ba,.mem(bpt_in
str+i))#0A..}#0A#0A..ctcb,.cptr,.regs.:#3D.0,.0,.0#0A
..selectask(-1)..//.Select.the.current.task#0A#0A..
{.LET.gn.#3D.mem(regs+r_pc).-.globword#0A..2LET.cod
e.#3D.mem(rootnode.+.rtn_abortcode)#0A..2LET.mess.#3D
..VALOF.SWITCHON.code.INTO#0A..14{.CASE..0011:.RESU
LTIS."Illegal.instruction"#0A..16CASE..0012:.RESULT
IS."BRK.instruction"#0A..16CASE..0013:.RESULTIS."Ze
ro.count"#0A..16CASE..0014:.TEST.0<#3Dgn<#3Dmem(gpt
r+0)#0A..26THEN.RESULTIS."G%n.unassigned"#0A..26ELS
E.RESULTIS."Negative.pc"#0A..16CASE..0015:.RESULTIS
."Division.by.zero"#0A..16CASE..00010:.RESULTIS."Ci
ntasm.single.step"#0A..16CASE..00011:.RESULTIS."Wat
ch.addr:.%$%i7.value:.%i8"#0A..16CASE..00012:.RESUL
TIS."Indirect.address.out.of.range:.%$%$%$%n"#0A..1
6CASE..00099:.RESULTIS."User.requested"#0A..16CASE.
110000:.RESULTIS."Callco.fault"#0A..16CASE.111:.RES
ULTIS."Resumeco.fault"#0A..16CASE.110002:.RESULTIS.
"Deleteco.fault"#0A..16CASE.180:.RESULTIS."Unable.t
o.delete.a.task"#0A..16CASE.181:.RESULTIS."Unable.t
o.send.a.packet"#0A..16CASE.182:.RESULTIS."Unexpect
ed.pkt.received"#0A..16CASE.186:.RESULTIS."Bad.inpu
t.stream"#0A..16CASE.187:.RESULTIS."Bad.output.stre
am"#0A..16CASE.188:.RESULTIS."Unable.to.replenish.i
nput"#0A..16CASE.189:.RESULTIS."Wrch.fault"#0A..16C
ASE.190:.RESULTIS."Endread.fault"#0A..16CASE.191:.R
ESULTIS."Endwrite.fault"#0A..16CASE.197:.RESULTIS."
Store.chain.fault"#0A..16DEFAULT:..RESULTIS."Unknow
n.fault"#0A..14}#0A#0A..2writef("*nLast.abort.code:
.%n..",.mem(rootnode+rtn_abortcode))#0A..2writef(me
ss,.gn,.mem(1),.mem(2),.mem(3))#0A..2newline()#0A..
2GOTO.recover#0A..}#0A#0Arecover:#0A..ch.:#3D.'*n'#0A
nxt:..24//.Main.loop.for.debug.commands#0A..IF.ch#3D
'*n'.DO.prprompt()#0A#0A..rch().REPEATWHILE.ch#3D'*
s'#0Asw:#0A..SWITCHON.ch.INTO#0A#0A..{.DEFAULT:.err
or()#0A#0A..2CASE.endstreamch:.newline();.GOTO.ret.
#0A#0A..2CASE.'*s':#0A..2CASE.'*n':GOTO.nxt#0A..4#0A
..2CASE.'?':#0A..5writes("*n?..8Print.list.of.dumpd
ebug.commands*n")#0A..5writes("Gn.Pn.Rn.Vn.Wn.An..8
Variables*n")#0A..5writes("G..P..R..V..W..A..9Point
ers*n")#0A..5writes("123.#23o377.#23FF00003.'c..7Co
nstants*n")#0A..5writes("**e./e.%e.+e.-e.|e.&e..5Dy
adic.operators*n")#0A..5writes("!e..23Subscription*
n")#0A..5writes("<.>..22Left/Right.shift.one.place*
n")#0A..5writes("$c.$d.$f.$b.$o.$s.$u.$x..2Set.the.
print.style*n")#0A..5writes("SGn.SPn.SRn.SVn.SAn..6
Store.current.value*n")#0A..5writes("Sn..7Select.ta
sk.n*n")#0A..5writes("S#2E..7Select.current.task*n"
)#0A..5writes("#3D..8Print.current.value*n")#0A..5w
rites("Tn..7Print.n.consecutive.locations*n")#0A..5
writes("I..8Print.current.instruction*n")#0A..5writ
es("N..8Print.next.instruction*n")#0A..5writes("B..
8List.the.current.breakpoints*n")#0A..5writes("Q..8
Quit.--.exit.from.dumpdebug*n")#0A..5writes("#2E..8
Move.to.current.coroutine*n")#0A..5writes(",..8Move
.down.one.stack.frame*n")#0A..5writes(";..8Move.to.
parent.coroutine*n")#0A..5writes("[..8Move.to.first
.coroutine*n")#0A..5writes("]..8Move.to.next.corout
ine*n")#0A..5GOTO.recover#0A#0A..2CASE.'0':.CASE.'1
':.CASE.'2':#0A..2CASE.'3':.CASE.'4':.CASE.'5':#0A.
.2CASE.'6':.CASE.'7':.CASE.'8':#0A..2CASE.'9':.CASE
.'#23':.CASE.'*'':#0A..2CASE.'G':.CASE.'P':.CASE.'R
':#0A..2CASE.'V':.CASE.'W':.CASE.'A':#0A..12val.:#3D
.rdval();..15GOTO.sw#0A#0A..2CASE.'!':.rch();.val.:
#3D.cont(val..+..rdval());..GOTO.sw#0A..2CASE.'+':.
rch();.val.:#3D.val..+..rdval();..6GOTO.sw#0A..2CAS
E.'-':.rch();.val.:#3D.val..-..rdval();..6GOTO.sw#0A
..2CASE.'**':rch();.val.:#3D.val..*..rdval();..6GOT
O.sw#0A..2CASE.'/':.rch();.{.LET.a.#3D.rdval()#0A..
21UNLESS.a.DO.error()#0A..21val.:#3D.val./.a#0A..21
GOTO.sw#0A..19}#0A..2CASE.'%':.rch();.{.LET.a.#3D.r
dval()#0A..21UNLESS.a.DO.error()#0A..21val.:#3D.val
.REM.a#0A..21GOTO.sw#0A..19}#0A..2CASE.'|':.rch();.
val.:#3D.val..|..rdval();..6GOTO.sw#0A..2CASE.'&':.
rch();.val.:#3D.val..&..rdval();..6GOTO.sw#0A#0A..2
CASE.'<':.val.:#3D.val.<<.1;..14GOTO.nxt#0A..2CASE.
'>':.val.:#3D.val.>>.1;..14GOTO.nxt#0A#0A..2CASE.'#3D
':.print(val);.newline();..8GOTO.recover#0A#0A..2CA
SE.'S':.{.LET.type.#3D.?#0A..14rch()#0A..14//.Is.it
.a.task.selection?#0A..14IF.ch#3D'#2E'.DO#0A..14{.n
ewline()..4//.Select.regs,.p.and.g.at.time.of#0A..1
6selectask(-1)..//.last.leaving.cinterp#2E#0A..16rc
h()#0A..16GOTO.sw#0A..14}#0A..14IF.'0'<#3Dch<#3D'9'
.DO#0A..14{.//.Select.a.specified.task#0A..16select
ask(rdval())#0A..16GOTO.sw#0A..14}#0A..14//.No.--.i
t.must.be.a.store.instruction#0A..14type.:#3D.ch#0A
..14rch()#0A..14stmem(rdvaraddr(type),.val).//.Only
.SVi#0A..14GOTO.sw#0A..12}#0A#0A1..2CASE.'T':.rch()
#0A..10{.LET.n.#3D.rdn()#0A..12IF.n<#3D0.DO.n.:#3D.
1#0A..12FOR.i#3D0.TO.n-1.DO#0A..12{.IF.i.REM.5.#3D.
0.DO.praddr(val+i)#0A..14print(cont(val+i))#0A..12}
#0A..12newline()#0A..12GOTO.sw#0A..10}#0A#0A..2CASE
.'$':.rch()#0A..12UNLESS.ch#3D'B'.|.ch#3D'C'.|.ch#3D
'D'.|.ch#3D'F'.|#0A..19ch#3D'O'.|.ch#3D'S'.|.ch#3D'
U'.|.ch#3D'X'.DO#0A..12{.writef("Valid.style.letter
s.are:.BCDFOSUX*n")#0A..14GOTO.nxt#0A..12}#0A..12st
yle.:#3D.ch#0A..12GOTO.nxt#0A#0A..2CASE.'Q':.newlin
e()#0A..12RETURN#0A..7#0A..2CASE.'N':.val.:#3D.next
pc(val)#0A..2CASE.'I':.prinstr(val);.newline();.GOT
O.recover#0A#0A..2CASE.'B':..//.List.the.current.br
eakpoints#2E#0A..5newline()#0A..5FOR.i.#3D.0.TO.9.D
O#0A..5{.LET.ba#3Dmem(bpt_addr+i)#0A..7IF.ba.DO#0A.
.7{.writef("%n:..",.i)#0A..9writearg(ba)#0A..9newli
ne()#0A..7}#0A..5}#0A..5GOTO.recover#0A#0A..2CASE.'
,':..//.Move.down.one.stack.frame.and.output.it#2E#0A
..11{.LET.a.#3D.cont(pptr+0)>>0002#0A..13IF.a#3Dcpt
r.|.a#3D0.DO.{.writef(".Base.of.stack*n")#0A..34GOT
O.recover#0A..32}#0A..13fsize.:#3D.pptr-a#0A..13ppt
r.:#3D.a#0A..13wrframe()#0A..13GOTO.recover#0A..11}
#0A#0A..2CASE.';':.IF.cptr.DO#0A..12{.LET.c.#3D.con
t(cptr+co_parent)#0A..14IF.c<#3D0.DO#0A..14{.writef
(".There.is.no.parent.coroutine*n")#0A..16GOTO.reco
ver#0A..14}#0A..14cptr.:#3D.c#0A..12}#0A..12GOTO.ne
wc#0A#0A..2CASE.'#2E':.cptr.:#3D.cont(gptr+g_currco
)#0A..12GOTO.newc#0A#0A..2CASE.']':.cptr.:#3D.cont(
cptr+co_list)#0A..12IF.cptr#3D0.DO.{.writef(".End.o
f.coroutine.list*n")#0A..27GOTO.recover#0A..25}#0A.
.12GOTO.newc#0A#0A..2CASE.'[':.cptr.:#3D.cont(gptr+
g_colist)#0A#0Anewc:..7UNLESS.cptr.DO#0A..12{.write
f("No.such.coroutine*n")#0A..14GOTO.recover#0A..12}
#0A..12TEST.cptr#3Dcont(gptr+g_currco)#0A..12THEN.p
ptr.:#3D.cont(regs+r_p)>>0002#0A..12ELSE.pptr.:#3D.
cont(cptr+co_pptr)>>0002#0A..12fsize.:#3D.cptr.+.6.
+.cont(cptr+co_size).-.pptr#0A..12wrcortn()#0A..12G
OTO.recover#0A..}#0A#0Aret:#0Aretstep:#0A}#0A#0AAND
.prprompt().BE#0A{.LET.id.#3D.-1#0A..LET.st.#3D.reg
s!r_st#0A..LET.letter.#3D.'?'#0A//sys(Sys_tracing,.
FALSE)#0A//sawritef("ctcb#3D%n*n",.ctcb)#0A..IF.ctc
b.DO#0A..{.id..3:#3D.mem(ctcb+tcb_taskid)#0A..2lett
er.:#3D.mem(ctcb+tcb_active).->.'a',.'d'#0A#0A..}#0A
..IF.st#3D1.DO.letter.:#3D.'k'#0A..IF.st#3D2.DO.let
ter.:#3D.'b'#0A..IF.st#3D3.DO.letter.:#3D.'i'#0A..s
awritef("%c%n#23.",.letter,.id)..//.Standalone.prom
pt#0A}#0A#0AAND.prpkt(pkt).BE#0A{.writef("%i6:..1PK
T:",.pkt)#0A..FOR.i.#3D.pkt_link.TO.pkt_arg1.DO.wri
tearg(mem(pkt+i))#0A..newline()#0A}#0A#0AAND.dumpro
otnode().BE#0A{.writef("*nRootnode.at.%n*n*n",.root
node)#0A#0A..writef("..tasktab..2%iA*n",.mem(rtn_ta
sktab+rootnode))#0A..writef("..devtab..3%iA*n",.mem
(rtn_devtab+rootnode))#0A..writef("..tcblist..2%iA*
n",.mem(rtn_tcblist+rootnode))#0A..writef("..crntas
k..2%iA..",.mem(rtn_crntask+rootnode))#0A..writef("
.task.%n*n",.mem(tcb_taskid+mem(rtn_crntask+rootnod
e))1#0A..writef("..blklist..2%iA*n",.mem(rtn_blklis
t+rootnode))#0A..writef("..clkintson..%iA*n",.mem(r
tn_clkintson+rootnode))#0A..writef("..clwkq..4%iA*n
",.mem(rtn_clwkq+rootnode))#0A..writef("..memsize..
2%iA*n",.mem(rtn_memsize+rootnode))#0A..writef("..i
nfo..5%iA*n",.mem(rtn_info+rootnode))#0A..writef(".
.sys..6%iA*n",.mem(rtn_sys+rootnode))#0A..writef(".
.blib..5%iA*n",.mem(rtn_blib+rootnode))#0A..writef(
"..boot..5%iA*n",.mem(rtn_boot+rootnode))#0A..write
f("..klib..5%iA*n",.mem(rtn_klib+rootnode))#0A..wri
tef("..abortcode..%iA*n",.mem(rtn_abortcode+rootnod
e))#0A..writef("..context..2%iA*n",.mem(rtn_context
+rootnode))#0A..writef("..lastp..4%iA*n",.mem(rtn_l
astp+rootnode))#0A..writef("..lastg..4%iA*n",.mem(r
tn_lastg+rootnode))#0A..writef("..days..5%iA*n",.me
m(rtn_days+rootnode))#0A..writef("..msecs..4%iA*n",
.mem(rtn_msecs+rootnode))#0A..writef("..idletcb..2%
iA*n",.mem(rtn_idletcb+rootnode))#0A#0A..writef("*n
Tasktab.at.%n.upb#3D%n*n",.tasktab,.mem(tasktab))#0A
..FOR.i.#3D.1.TO.mem(tasktab).IF.mem(tasktab+i).DO#0A
..{.LET.tcb.#3D.mem(tasktab+i)#0A..2LET.id,.pri,.wk
q.#3D.mem(tcb+tcb_taskid),.mem(tcb+tcb_pri),.mem(tc
b+tcb_wkq)#0A..2LET.taskname.#3D.tcb+tcb_namebase./
/.MR.17/01/05#0A..2writef("%i6:.TCB.for.task.%i3,..
2pri.%i5..",.tcb,.id,.pri)#0A..2FOR.i.#3D.1.TO.memb
(taskname,.0).DO.wrch(memb(taskname,.i))#0A..2newli
ne()#0A..2WHILE.wkq.DO#0A..2{.LET.pkt.#3D.wkq#0A..4
prpkt(pkt)#0A..4wkq.:#3D.mem(wkq)#0A..2}#0A..}#0A..
writef("*nDevtab.at.%n.upb#3D%n*n",.devtab,.mem(dev
tab))#0A..FOR.i.#3D.1.TO.mem(devtab).IF.mem(devtab+
i).DO#0A..{.LET.dcb.#3D.mem(devtab+i)#0A..2LET.id,.
type,.wkq.#3D.mem(dcb+Dcb_devid),.mem(dcb+Dcb_type)
,.mem(dcb+Dcb_wkq)#0A..2writef("%i6:.DCB.for.device
.%i3.type.%n.",.dcb,.id,.type)#0A..2SWITCHON.type.I
NTO#0A..2{.DEFAULT:..8writef("(unknown)");.ENDCASE#0A
#0A..4CASE.Devt_clk:..2writef("(clock)");..ENDCASE#0A
..4CASE.Devt_ttyin:..writef("(ttyin)");..ENDCASE#0A
..4CASE.Devt_ttyout:.writef("(ttyout)");.ENDCASE#0A
..4CASE.Devt_fileop:.writef("(fileop)");.ENDCASE#0A
..4CASE.Devt_tcpdev:.writef("(tcpdev)");.ENDCASE#0A
..2}#0A..2newline()#0A..2IF.id#3D-1.DO.wkq.:#3D.mem
(rtn_clwkq+rootnode)#0A..2WHILE.wkq.DO#0A..2{.LET.p
kt.#3D.wkq#0A..4prpkt(pkt)#0A..4wkq.:#3D.mem(wkq)#0A
..2}#0A..}..#0A}#0A#0AAND.dumpmemory().BE#0A{.LET.b
locklist..#3D.mem(rootnode+rtn_membase)#0A..LET.top
ofstore.#3D.mem(rootnode+rtn_memsize)#0A..LET.a.#3D
.blocklist#0A..LET.free,.used,.n.#3D.0,.0,.0#0A..LE
T.largest_free.#3D.0#0A..LET.joinfree.#3D.0#0A..LET
.sectnames,.routnames,.globinit.#3D.0,.0,.0#0A..LET
.constr.#3D.output()#0A..LET.outstr.#3D.0#0A#0A..wr
itef("*nMap.of.free.and.allocated.blocks.in.%n#2E#2E
%n*n*n",.membase,.memlim)#0A#0A..WHILE.mem(a).DO#0A
..{.LET.size.#3D.mem(a)#0A..2LET.freeblk.#3D.(size&
1)#3D1#0A#0A..2IF.testflags(flag_b).GOTO.exit#0A#0A
..2TEST.freeblk#0A..2THEN.{.//.Free.block#0A..9size
.:#3D.size-1#0A..9free.:#3D.free.+.size#0A..9joinfr
ee.:#3D.joinfree.+.size#0A..9IF.joinfree.>.largest_
free.DO.largest_free.:#3D.joinfree#0A..7}#0A..2ELSE
.{.//.Used.block#0A..9used.:#3D.used.+.size#0A..9jo
infree.:#3D.0#0A..7}#0A#0A..2UNLESS.size>#3D0.&.a+s
ize<#3Dtopofstore.DO#0A..2{.writef("**4Store.chain.
corrupt!!*n*#0A..12*Noticed.at.%n*n",.a)#0A..4BREAK
#0A..2}#0A#0A..2writef("%i8:%i7.",.a,.size)#0A..2IF
.freeblk.DO.{.writes("free.");.GOTO.nxt.}#0A#0A..2{
.LET.creator.#3D.a+size-5#0A..4LET.len.#3D.memb(cre
ator,.0)#0A..4writef(".allocated.by:.")#0A..4FOR.i.
#3D.1.TO.len.DO.wrch(memb(creator,.i))#0A..4FOR.i.#3D
.len+1.TO.16.DO.wrch('.')#0A..2}#0A#0A..2IF.a.#3D.(
rootnode-1).DO.{.writes("Rootnode");.GOTO.nxt.}#0A.
.2IF.mem(a+3).#3D.sectword.&.memb(a+4,.0).#3D.11.DO
#0A..2{.LET.name.#3D.a+4#0A..4writef("Section.")#0A
..4FOR.i.#3D.1.TO.memb(name,.0).DO.wrch(memb(name,.
i))#0A..4GOTO.nxt#0A..2}#0A#0A..2FOR.id.#3D.1.TO.me
m(tasktab).DO#0A..2{.LET.t.#3D.mem(tasktab+id)#0A..
4IF.t.DO#0A..4{.LET.p,.g.#3D.mem(t+tcb_sbase),.mem(
t+tcb_gbase)#0A..6IF.a+1#3Dp.DO.{.writef("Task.%n.s
tack",.id);.GOTO.nxt.}#0A..6IF.a+1#3Dg.DO.{.writef(
"Task.%n.global.vector",.id);.GOTO.nxt.}#0A..6IF.a+
1#3Dt.DO.{.writef("Task.%n.TCB",.id);.GOTO.nxt.}#0A
..6IF.g.&.a>500.FOR.gn.#3D.1.TO.mem(g).IF.a+1#3Dmem
(g+gn).DO#0A..19{.writef("Task.%n.G%n.#3D>.",.id,.g
n)#0A..21GOTO.dump#0A..19}#0A..4}#0A..2}#0Adump:#0A
..2writes("*n..7")#0A..2FOR.i.#3D.1.TO.5.DO.{.LET.n
.#3D.mem(a+i)#0A..22TEST.-10_001_001<#3Dn<#3D10_001
_001#0A..22THEN.writef("%iA.",.n)#0A..22ELSE.writef
("#23x%x8.",.n)#0A..20}#0Anxt:.#0A..2newline()#0A..
2a.:#3D.a.+.size#0A..}#0A#0A..writef("End.of.block.
list.#3D.%n*n",.a)#0A..topofstore.:#3D.a#0A#0A..wri
tef("*nLargest.contiguous.free.area:.%n.words*n",.l
argest_free)#0A..writef("Totals:.%n.words.available
,.%n.used,.%n.free*n*n",#0A..8used+free,.used,.free
)#0A#0Aexit:#0A}#0A#0AAND.dumptask(tcb).BE#0A{.LET.
id.#3D.mem(tcb+tcb_taskid)#0A..LET.seglist,.pkt.#3D
.0,.0#0A..LET.state,.flags,.cliseg.#3D.0,.0,.0#0A..
LET.dead.#3D.FALSE..11//.Assume.activated.unless.pr
oved.otherwise#0A..LET.pkt.#3D.mem(tcb_wkq+tcb)#0A.
.regs,.pptr,.gptr.:#3D.0,.0,.0#0A..UNLESS.tcb.RETUR
N#0A#0A..seglist.:#3D.mem(tcb_seglist+tcb)#0A..pkt.
.1:#3D.mem(tcb.+.tcb_wkq)#0A..state.:#3D.mem(tcb.+.
tcb_state)#0A..flags.:#3D.mem(tcb.+.tcb_flags)#0A..
dead..:#3D.(state.&.State_dead).#3D.State_dead#0A..
cliseg.:#3D.mem(seglist+4)..2//.The.CLI.segment#0A#0A
..writef("*n#23#2317.Task.%i2:",.id)#0A..wrch('.')#0A
..FOR.i.#3D.1.TO.memb(tcb+tcb_namebase,.0).DO.wrch(
memb(tcb+tcb_namebase,.i))#0A..wrch('.')#0A..FOR.i.
#3D.memb(tcb+tcb_namebase,.0)+1.TO.15+16.DO.wrch('#23
')#0A..writef("*n*n")#0A..writef("tcb#3D%n:",.tcb)#0A
..writef(".pri.%n,",.mem(tcb.+.tcb_pri))#0A..writef
(".stksz.%n,",.mem(tcb+tcb_stsiz))#0A..writef(".sta
te#3D#23b%b4,.flags#3D#23b%b6*n",.mem(tcb+tcb_state
),.mem(tcb+tcb_flags))#0A#0A..{.LET.state.#3D.mem(t
cb+tcb_state)#0A..2writes("*nState:.")#0A..2SWITCHO
N.state.&.#23b1100000.INTO#0A..2{.CASE.#23b002:.wri
tef(".running");..3ENDCASE#0A..4CASE.#23b0100:.writ
ef(".waiting");..3ENDCASE#0A..4CASE.#23b1001:.write
f(".interrupted");.ENDCASE#0A..4CASE.#23b1100000:.d
ead.:#3D.TRUE#0A..17writef(".dead");..6ENDCASE#0A..
2}#0A..2UNLESS.(state.&.#23b0000010)#3D0.DO.writef(
".held")#0A..2UNLESS.(state.&.#23b000011)#3D0.DO.wr
itef(".with.packet")#0A..2newline()#0A..}#0A#0A..wr
itef("*nPackets:.wkq#3D%n*n",.pkt)#0A..UNTIL.pkt<#3D
0.DO#0A..{.prpkt(pkt)#0A..2pkt.:#3D.mem(pkt_link+pk
t)#0A..}#0A#0A..IF.dead.DO#0A..{.writef("*nNo.stack
.or.global.vector.since.the.task.is.dead*n")#0A..2R
ETURN#0A..}#0A#0A..regs,.ctcb,.cptr.:#3D.0,.tcb,.0#0A
#0A..TEST.mem(rootnode+rtn_crntask)#3Dctcb#0A..THEN
.{.//.klibregs.is.the.register.set.passed.to.the.in
terpreter.by.BOOT#0A..7//.these.are.normally.the.re
gisters.to.use#2E#0A..7regs.:#3D.klibregs.//.The.de
fault.register.set#0A..7//.If.st#3D3.we.are.in.the.
interrupt.service.routine#0A..7//.so.we.will.use.th
e.registers.that.were.saved.when.the#0A..7//.interr
upt.occurred#2E#0A..7IF.mem(regs+r_st)#3D3.DO.regs.
:#3D.saveregs#0A..5}#0A..ELSE.regs.:#3D.@ctcb!tcb_a
#0A#0A..gptr..:#3D.mem(regs+r_g).>>.2#0A..pptr..:#3D
.mem(regs+r_p).>>.2#0A#0A..//.Set.current.coroutine
.if.in.user.or.kernel.mode.and.the.task#0A..//.is.a
ctive#0A..IF.mem(tcb+tcb_active).DO.cptr.:#3D.mem(g
ptr+g_currco)#0A#0A..UNLESS.cptr.<#3D.pptr.<#3D.cpt
r.+.mem(cptr+co_size.+.6).DO.cptr.:#3D.0#0A#0A..fsi
ze.:#3D.100#0A//sawritef("cptr#3D%n*n",.cptr)#0A..I
F.cptr.DO.fsize.:#3D.cptr.+.6.+.mem(cptr+co_size).-
.pptr#0A#0A..wrregs("Registers",.regs)#0A#0A..write
f("*nSeglist.%n:..length.%n",.mem(tcb_seglist+tcb),
.mem(seglist))#0A..//FOR.i.#3D.1.TO.mem(seglist).DO
.writef("..%n",.mem(seglist+i))#0A#0A..{.LET.segl.#3D
.mem(tcb.+.tcb_seglist)#0A#0A..2FOR.j.#3D.1.TO.mem(
segl).DO#0A..2{.LET.seg.#3D.mem(segl+j)#0A..4LET.la
yout.#3D.0#0A..4writef("*nSeg%n.%i6:.",.j,.seg)#0A.
.4WHILE.seg.DO#0A..4{.IF.layout.&.(layout.MOD.5)#3D
0.DO.writef("*n..11")#0A..6wrch('.')#0A..6layout.:#3D
.layout.+.1#0A..6write_sectname(seg)#0A..6seg.:#3D.
mem(seg)#0A..4}#0A..2}#0A..2newline()#0A#0A..2IF.gp
tr.DO#0A..2{.LET.gupb.#3D.mem(gptr)#0A..4writef("*n
Global.variables.at.G.#3D.%n:*n",.gptr)#0A..4FOR.gn
.#3D.0.TO.gupb.DO#0A..4{.LET.w.#3D.mem(gptr+gn)#0A.
.6IF.gn.REM.5.#3D.0.DO#0A..6{.LET.v,.gw.#3D.gptr+gn
,.globword+gn#0A..8IF..12mem(v+0)#3Dgw+0.&#0A..11(g
n+1>gupb.|.mem(v+1)#3Dgw+1).&#0A..11(gn+2>gupb.|.me
m(v+2)#3Dgw+2).&#0A..11(gn+3>gupb.|.mem(v+3)#3Dgw+3
).&#0A..11(gn+4>gupb.|.mem(v+4)#3Dgw+4).DO.{.gn.:#3D
.gn+4;.LOOP.}#0A..8writef("*nG%i3:",.gn)#0A..6}#0A.
.6writearg(w)#0A..4}#0A..4newline()#0A..2}#0A#0A..2
writef("*nCoroutine.stacks.for.task.%n:*n",.id)..#0A
..2wrcortns(tcb)#0A..}#0A}#0A#0AAND.wrregs(str,.reg
s).BE#0A{.writef("*n%s:*n",.str)#0A..writef("a#3D%n
.b#3D%n.c#3D%n.",.mem(regs+r_a),.mem(regs+r_b),.mem
(regs+r_c))#0A..writef("p#3D%n(%n).g#3D%n(%n).",.me
m(regs+r_p),.mem(regs+r_p)>>0002,#0A..29mem(regs+r_
g),.mem(regs+r_g)>>0002)#0A..writef("st#3D%n.pc#3D%
n.count#3D%n*n",.mem(regs+r_st),.mem(regs+r_pc),#0A
..33mem(regs+r_count))#0A}#0A#0AAND.write_sectname(
s).BE#0A{.LET.name.#3D.s+3#0A..TEST.(mem(s+2).#3D.s
ectword).&.(memb(s+3,.0).#3D.11)#0A..THEN.FOR.i.#3D
.1.TO.11.DO.wrch(memb(name,.i))#0A..ELSE.writes("??
9")#0A}#0A#0AAND.checkaddr(a).#3D.VALOF#0A{.UNLESS.
membase<#3Da<#3Dmemlim.DO#0A..{.writef("*n.bad.addr
ess.%d.not.in.%n--%n*n",.a,.membase,.memlim)#0A..2R
ESULTIS.0#0A..}#0A..RESULTIS.a#0A}#0A#0AAND.cont(a)
.#3D.mem(checkaddr(a))#0A#0AAND.wrcortns(tcb).BE#0A
{.cptr.:#3D.cont(gptr+g_colist)#0A#0A//sawritef("cp
tr#3D%n.pptr#3D%n.gptr#3D%n.regs#3D%n*n",.cptr,.ppt
r,.gptr,.regs)#0A#0A..WHILE.0<cptr<#3Dmemlim.DO#0A.
.{.TEST.cptr#3Dcont(gptr+g_currco)#0A..2THEN.TEST.1
<#3Dmem(rootnode+rtn_context)<#3D2.&.//.SIGINT.or.S
IGSEGV#0A..12mem(rootnode+rtn_crntask)#3Dtcb#0A..7T
HEN.pptr.:#3D.mem(rootnode+rtn_lastp)#0A..7ELSE.ppt
r.:#3D.mem(regs+r_p)>>0002#0A..2ELSE.pptr.:#3D.cont
(cptr+co_pptr)>>0002#0A#0A..2fsize.:#3D.cptr.+.6.+.
mem(cptr+co_size).-.pptr#0A//sawritef("cptr#3D%n.pp
tr#3D%n.gptr#3D%n.fsize#3D%n*n",.cptr,.pptr,.gptr,.
fsize)#0A#0A..2{.LET.size.#3D.cont(cptr+co_size)#0A
..4LET.hwm.#3D.size+6#0A..4writef("*n%i7:.",.cptr)#0A
..4IF.cptr#3Dmem(gptr+g_currco).DO.writes("Current.
")#0A..4writes("Coroutine.")#0A..4writearg(cont(cpt
r+co_fn))#0A..4writef("..Parent.%n",.mem(cptr+co_pa
rent))#0A..4WHILE.cont(cptr+hwm)#3Dstackword.DO.hwm
:#3Dhwm-1#0A..4writef("..Stack.%n/%n*n",.hwm-6,.siz
e)#0A..4wrframe()#0A#0A..4//.Move.down.one.stack.fr
ame.and.output.it#2E#0A..4{.LET.a.#3D.mem(pptr)>>00
02#0A..6IF.a<cptr.|.a>pptr.DO.{.writes(".Corrupt.st
ack.chain*n")#0A..30BREAK#0A..28}#0A..6IF.a#3Dcptr.
|.a#3D0..2DO.{.writef(".Base.of.stack*n")#0A..30BRE
AK#0A..28}#0A..6fsize.:#3D.pptr-a#0A..6pptr.:#3D.a#0A
..6wrframe()#0A..4}.REPEAT#0A..2}#0A#0A..2//.Find.n
ext.coroutine.in.the.list#0A..2cptr.:#3D.cont(cptr+
co_list)#0A..}#0A..TEST.cptr.THEN.writef("*nCorrupt
.coroutine.list*n")#0A..10ELSE.writef("*nEnd.of.cor
outine.list*n")#0A}#0A#0AAND.wrcortn().BE#0A{.LET.s
ize.#3D.cont(cptr+co_size)#0A..LET.hwm.#3D.size+6#0A
..writef(".%i7:.",.cptr)#0A..writes("Coroutine.")#0A
..writearg(cont(cptr+co_fn))#0A..writef("..Parent.%
n",.mem(cptr+co_parent))#0A..WHILE.cont(cptr+hwm)#3D
stackword.DO.hwm:#3Dhwm-1#0A..writef("..Stack.%n/%n
*n",.hwm-6,.size)#0A..prprompt()#0A..wrch('.')#0A..
wrframe()#0A}#0A#0AAND.wrframe().BE#0A{.writef("%i7
:",.pptr)#0A..IF.pptr#3Dcptr.DO.{.writes("..1Base.o
f.stack*n");.RETURN.}#0A..writearg(mem(pptr+2))#0A.
.FOR.i#3D3.TO.6.UNLESS.i>#3Dfsize.DO.writearg(cont(
pptr+i))#0A..newline()#0A..IF.fsize>7.DO#0A..{.writ
ef("..6")#0A..2FOR.i.#3D.7.TO.11.UNLESS.i>#3Dfsize.
DO.writearg(cont(pptr+i))#0A..2newline()#0A..}#0A..
IF.fsize>12.DO#0A..{.writef("..6")#0A..2FOR.i.#3D.1
2.TO.16.UNLESS.i>#3Dfsize.DO.writearg(cont(pptr+i))
#0A..2newline()#0A..}#0A}#0A#0AAND.writearg(n).BE.T
EST.isfun(n)#0A..17THEN.{.LET.s.#3D.(n>>0002)-3..//
.MR.1/11/03#0A//FOR.i.#3D.1.TO.11.DO.writef("i#3D%i
2..ch#3D%n*n",.#0A..24wrch('.')#0A..24FOR.i.#3D.1.T
O.memb(s,.0).DO.wrch(memb(s,.i))#0A..24wrch('.')#0A
..22}#0A..17ELSE.TEST.globword<#3Dn<#3Dglobword+100
1..//.MR.1/11/03#0A..22THEN.writef("..1#23G%z3#23..
2",.n-globword)#0A..22ELSE.TEST.-10_001_001<#3Dn<#3D
10_001_001#0A..27THEN.writef(".%iB.",.n)#0A..27ELSE
.writef("..#23x%x8.",.n)#0A#0AAND.isfun(f).#3D.VALO
F#0A{.LET.a.#3D.f>>0002#0A..UNLESS.(f&3)#3D0.&.memb
ase+4<a<#3Dmemlim.RESULTIS.FALSE.//.MR.25/9/03#0A..
IF.mem(a-4)#3Dentryword.&.memb(a-3,.0)#3D11.RESULTI
S.TRUE.#0A..RESULTIS.FALSE#0A}#0A#0AAND.rdn().#3D.V
ALOF#0A{.LET.res.#3D.0#0A..WHILE.'0'<#3Dch<#3D'9'.D
O.{.res.:#3D.res*10.+.ch.-.'0';.rch().}#0A..RESULTI
S.res#0A}#0A#0AAND.rdvaraddr(type).#3D.VALOF#0A{.LE
T.base,.lim,.n.#3D.?,.?,.?#0A..UNLESS.'0'<#3Dch<#3D
'9'.DO.error()#0A..n.:#3D.rdn()#0A..SWITCHON.type.I
NTO#0A..{.DEFAULT:..1error()#0A..2CASE.'P':.base,.l
im.:#3D.pptr,.fsize;..9ENDCASE#0A..2CASE.'G':.base,
.lim.:#3D.gptr,.gptr!g_globsize;.ENDCASE#0A..2CASE.
'R':.base,.lim.:#3D.regs,.r_upb;..9ENDCASE#0A..2CAS
E.'V':.base,.lim.:#3D.vars,.9;..13ENDCASE#0A..2CASE
.'W':.base,.lim.:#3D.ctcb,.tcb_upb;..7ENDCASE#0A..2
CASE.'A':.base,.lim.:#3D..0020,.memlim;..8ENDCASE#0A
..}#0A..UNLESS.0<#3Dn<#3Dlim.DO.error()#0A..RESULTI
S.base.+.n#0A}#0A#0AAND.rdval().#3D.VALOF#0A{.LET.r
es,.radix.#3D.0,.10#0A#0A..SWITCHON.ch.INTO#0A..{.D
EFAULT:..1error()#0A#0A..2CASE.'G':..rch()#0A..13IF
.'0'<#3Dch<#3D'9'.RESULTIS.mem(rdvaraddr('G'))#0A..
13RESULTIS.gptr#0A#0A..2CASE.'P':..rch()#0A..13IF.'
0'<#3Dch<#3D'9'.RESULTIS.mem(rdvaraddr('P'))#0A..13
RESULTIS.pptr#0A#0A..2CASE.'R':..rch()#0A..13IF.'0'
<#3Dch<#3D'9'.RESULTIS.mem(rdvaraddr('R'))#0A..13RE
SULTIS.regs#0A#0A..2CASE.'V':..rch()#0A..13IF.'0'<#3D
ch<#3D'9'.RESULTIS.mem(rdvaraddr('V'))#0A..13RESULT
IS.vars#0A#0A..2CASE.'W':..rch()#0A..13IF.'0'<#3Dch
<#3D'9'.RESULTIS.mem(rdvaraddr('W'))#0A..13RESULTIS
.ctcb#0A#0A..2CASE.'A':..rch()#0A..13IF.'0'<#3Dch<#3D
'9'.RESULTIS.mem(rdvaraddr('A'))#0A..13RESULTIS.0#0A
#0A..2CASE.'*'':.rch();.res.:#3D.lch;.rch();..RESUL
TIS.res#0A#0A..2CASE.'#23':..radix.:#3D.16#0A..13rc
h()#0A..13IF.ch#3D'O'.DO.{.radix.:#3D.8;.rch().}#0A
#0A..2CASE.'0':.CASE.'1':.CASE.'2':.CASE.'3':.CASE.
'4':.#0A..2CASE.'5':.CASE.'6':.CASE.'7':.CASE.'8':.
CASE.'9':.#0A..13{.LET.d.#3D.100#0A..15IF.'0'<#3Dch
<#3D'9'.DO.d.:#3D.ch-'0'#0A..15IF.'A'<#3Dch<#3D'F'.
DO.d.:#3D.ch-'A'+10#0A..15IF.d>#3Dradix.RESULTIS.re
s#0A..15res.:#3D.res*radix+d#0A..15rch()#0A..13}.RE
PEAT#0A..}#0A}#0A#0AAND.praddr(a).BE#0A{.LET.type,.
base.#3D.'A',.0#0A..IF.pptr.<#3D.a.<#3D.pptr+fsize.
.14DO.type,.base.:#3D.'P',.pptr#0A..IF.gptr.<#3D.a.
<#3D.gptr+mem(gptr+g_globsize).DO.type,.base.:#3D.'
G',.gptr#0A..IF.vars.<#3D.a.<#3D.vars+9..18DO.type,
.base.:#3D.'V',.vars#0A..IF.ctcb.<#3D.a.<#3D.ctcb+t
cb_upb..12DO.type,.base.:#3D.'W',.ctcb#0A..IF.regs.
<#3D.a.<#3D.regs+r_upb..14DO.type,.base.:#3D.'R',.r
egs#0A..writef("*n%c%i5:",.type,.a-base)#0A}#0A#0AA
ND.print(n).BE.SWITCHON.style.INTO#0A{.DEFAULT:..1e
rror();..15RETURN#0A..CASE.'C':..{.LET.p.#3D.@n#0A.
.13writes(".")#0A..13FOR.i.#3D.0.TO.3.DO#0A..13{.LE
T.ch.#3D.p%i#0A..15wrch(32<#3Dch<#3D127.->.ch,.'#2E
')#0A..13}#0A..13RETURN#0A..11}#0A..CASE.'B':..writ
ef(.".%bW.",.n);..3RETURN#0A..CASE.'D':..writef(.".
%IA.",.n);..3RETURN#0A..CASE.'F':..writearg(n);..11
RETURN#0A..CASE.'O':..writef(.".%OC.",.n);..3RETURN
#0A..CASE.'S':..checkaddr(n)#0A..11writef(.".%S.",.
.n);..3RETURN#0A..CASE.'U':..writef(.".%UA.",.n);..
3RETURN#0A..CASE.'X':..writef(.".%X8.",.n);..3RETUR
N#0A}#0A#0AAND.selectask(id).BE#0A{.//.If.id<0,.sel
ect.the.regs,.p.and.g.at.the.time.of.last#0A..//.le
aving.cinterp,.otherwise.select.the.tcb.for.task.id
#0A..//.and.the.registers.corresponding.to.that.tas
k#2E#0A..LET.tasktab.#3D.mem(rtn_tasktab+rootnode)#0A
..AND.st..4#3D.mem(rootnode+rtn_lastst)..//.The.lat
est.ST.value#0A..AND.ctxt..2#3D.mem(rootnode+rtn_co
ntext).//.The.context#0A..LET.t.#3D.0..29//.To.hold
.the.TCB.address#0A#0A..IF.tasktab.&.0<id<#3Dmem(ta
sktab+0).DO.t.:#3D.mem(tasktab+id)#0A..IF.id<0.DO.t
.:#3D.mem(rtn_crntask+rootnode)#0A#0A..UNLESS.t.DO#0A
..{.sawritef("Task.%n.does.not.exist*n",.id)#0A..2R
ETURN#0A..}#0A#0A..ctcb,.cptr.:#3D.t,.0#0A#0A..TEST
.t#3Dmem(rtn_crntask+rootnode)#0A..THEN.TEST.id>0.&
.st#3D3#0A..5THEN.regs.:#3D.saveregs..3//.regs.of.c
rntask.at.time.of.fault#0A..5ELSE.regs.:#3D.klibreg
s..3//.regs.at.time.of.fault#0A..ELSE.regs.:#3D.@tc
b_regs!t..5//.regs.belonging.to.non.current.task#0A
#0A1//sawritef("regs#3D%n*n",.regs)#0A..gptr..:#3D.
mem(r_g.+.regs).>>.2#0A..pptr..:#3D.mem(r_p.+.regs)
.>>.2#0A#0A..//.Set.current.coroutine.if.in.user.or
.kernel.mode.and.the.task#0A..//.is.active#0A..IF.s
t<2.&.mem(t+tcb_active).DO.cptr.:#3D.mem(gptr+g_cur
rco)#0A#0A..UNLESS.cptr.<#3D.pptr.<#3D.cptr.+.mem(c
ptr+co_size).+.6.DO.cptr.:#3D.0#0A#0A..fsize.:#3D.1
00#0A//sawritef("cptr#3D%n*n",.cptr)#0A..IF.cptr.DO
.fsize.:#3D.cptr.+.6.+.mem(cptr+co_size).-.pptr#0A/
/sawritef("fsize#3D%n*n",.fsize)#0A#0A..{.LET.name.
#3D.t+tcb_namebase#0A..2sawritef("Task.%n:.",.mem(t
+tcb_taskid))#0A..2FOR.i.#3D.1.TO.memb(name,.0).DO.
sawrch(memb(name,.i))#0A..2sawritef(".selected*n")#0A
..}#0A..#0A}#0A#0AAND.error().BE.{.writes("..??*n")
;.longjump(rec_p,.rec_l).}#0A#0AAND.wrfcode(f).BE#0A
{.LET.s.#3D.VALOF.SWITCHON.f&31.INTO#0A..{.DEFAULT:
#0A..2CASE..0000:.RESULTIS."..3-..3K..1LLP..3L..2LP
..2SP..2AP..3A"#0A..2CASE..0001:.RESULTIS."..3-..2K
H..LLPH..2LH..1LPH..1SPH..1APH..2AH"#0A..2CASE..000
2:.RESULTIS."..1BRK..2KW..LLPW..2LW..1LPW..1SPW..1A
PW..2AW"#0A..2CASE..0003:.RESULTIS."..2K3..1K3G..K3
G1..K3GH..1LP3..1SP3..1AP3..L0P3"#0A..2CASE..0004:.
RESULTIS."..2K4..1K4G..K4G1..K4GH..1LP4..1SP4..1AP4
..L0P4"#0A..2CASE..0005:.RESULTIS."..2K5..1K5G..K5G
1..K5GH..1LP5..1SP5..1AP5..L0P5"#0A..2CASE..0006:.R
ESULTIS."..2K6..1K6G..K6G1..K6GH..1LP6..1SP6..1AP6.
.L0P6"#0A..2CASE..0007:.RESULTIS."..2K7..1K7G..K7G1
..K7GH..1LP7..1SP7..1AP7..L0P7"#0A..2CASE..0008:.RE
SULTIS."..2K8..1K8G..K8G1..K8GH..1LP8..1SP8..1AP8..
L0P8"#0A..2CASE..0009:.RESULTIS."..2K9..1K9G..K9G1.
.K9GH..1LP9..1SP9..1AP9..L0P9"#0A..2CASE.10:.RESULT
IS."..1K10..K10G.K10G1.K10GH..LP10..SP10..AP10.L0P1
0"#0A..2CASE.11:.RESULTIS."..1K11..K11G.K11G1.K11GH
..LP11..SP11..AP11.L0P11"#0A..2CASE.12:.RESULTIS.".
.2LF..1S0G..S0G1..S0GH..LP12..SP12..AP12.L0P12"#0A.
.2CASE.13:.RESULTIS."..1LF$..1L0G..L0G1..L0GH..LP13
..SP13.XPBYT..3S"#0A..2CASE.14:.RESULTIS."..2LM..1L
1G..L1G1..L1GH..LP14..SP14..1LMH..2SH"#0A..2CASE.15
:.RESULTIS."..1LM1..1L2G..L2G1..L2GH..LP15..SP15..1
BTC..MDIV"#0A..2CASE.16:.RESULTIS."..2L0..2LG..1LG1
..1LGH..LP16..SP16..1NOP.CHGCO"#0A..2CASE.17:.RESUL
TIS."..2L1..2SG..1SG1..1SGH..1SYS..2S1..2A1..1NEG"#0A
..2CASE.18:.RESULTIS."..2L2..1LLG..LLG1..LLGH..1SWB
..2S2..2A2..1NOT"#0A..2CASE.19:.RESULTIS."..2L3..2A
G..1AG1..1AGH..1SWL..2S3..2A3..L1P3"#0A..2CASE.20:.
RESULTIS."..2L4..1MUL..1ADD..2RV..2ST..2S4..2A4..L1
P4"#0A..2CASE.21:.RESULTIS."..2L5..1DIV..1SUB..1RV1
..1ST1..1XCH..2A5..L1P5"#0A..2CASE.22:.RESULTIS."..
2L6..1REM..1LSH..1RV2..1ST2..GBYT..RVP3..L1P6"#0A..
2CASE.23:.RESULTIS."..2L7..1XOR..1RSH..1RV3..1ST3..
PBYT..RVP4..L2P3"#0A..2CASE.24:.RESULTIS."..2L8..2S
L..1AND..1RV4..STP3..1ATC..RVP5..L2P4"#0A..2CASE.25
:.RESULTIS."..2L9..1SL$..2OR..1RV5..STP4..1ATB..RVP
6..L2P5"#0A..2CASE.26:.RESULTIS."..1L10..2LL..1LL1.
.1RV6..STP5..3J..RVP7..L3P3"#0A..2CASE.27:.RESULTIS
."..FHOP..1LL$..LL1$..1RTN..GOTO..2J$.ST0P3..L3P4"#0A
..2CASE.28:.RESULTIS."..1JEQ..1JNE..1JLS..1JGR..1JL
E..1JGE.ST0P4..L4P3"#0A..2CASE.29:.RESULTIS."..JEQ$
..JNE$..JLS$..JGR$..JLE$..JGE$.ST1P3..L4P4"#0A..2CA
SE.30:.RESULTIS."..JEQ0..JNE0..JLS0..JGR0..JLE0..JG
E0.ST1P4..3-"#0A..2CASE.31:.RESULTIS.".JEQ0$.JNE0$.
JLS0$.JGR0$.JLE0$.JGE0$..3-..3-"#0A..}#0A..LET.n.#3D
.f>>0005.&.7#0A..FOR.i.#3D.6*n+1.TO.6*(n+1).DO.wrch
(s%i)#0A}#0A#0AAND.prinstr(pc).BE#0A{.LET.a.#3D.0#0A
..writef(".%i7:.",.pc)#0A..checkaddr(pc>>0002)#0A..
wrfcode(gb(pc))#0A..SWITCHON.instrtype(gb(pc)).INTO
#0A..{.DEFAULT:#0A..2CASE.'0':..36RETURN#0A..2CASE.
'1':.a..:#3D.gb(pc+1);..20ENDCASE#0A..2CASE.'2':.a.
.:#3D.gh(pc+1);..20ENDCASE#0A..2CASE.'4':.a..:#3D.g
w(pc+1);..20ENDCASE#0A..2CASE.'R':.a..:#3D.pc+1.+.g
sb(pc+1);..12ENDCASE#0A..2CASE.'I':.pc.:#3D.pc+1.+.
2*gb(pc+1).&.#23xFF5E#0A..12a..:#3D.pc.+.gsh(pc);..
16ENDCASE#0A..}#0A..writef("..%n",.a)#0A..vars!9.:#3D
.a#0A}#0A#0AAND.gb(pc).#3D.memb(0,.pc)#0A#0AAND.gsb
(pc).#3D.gb(pc)<#3D127.->.gb(pc),.gb(pc)-256#0A#0AA
ND.gsh(pc).#3D.VALOF#0A{.LET.h.#3D.gh(pc)#0A..RESUL
TIS.h<#3D#23x7FF1.->.h,.h.-.#23x1002#0A}#0A#0AAND.g
h(pc).#3D.VALOF#0A{.LET.w.#3D.0#0A..LET.p.#3D.@w../
/.Designed.to.work.on.both.Big.and.Little.Ender.M/C
s#2E#0A..p%0,.p%1,.p%2,.p%3.:#3D.gb(pc),.gb(pc+1),.
gb(pc),.gb(pc+1)#0A..RESULTIS.w.&.#23xFF2#0A}#0A#0A
AND.gw(pc).#3D.VALOF#0A{.LET.w.#3D.0#0A..LET.p.#3D.
@w..//.Designed.to.work.on.both.Big.and.Little.Ende
r.M/Cs#2E#0A..p%0,.p%1,.p%2,.p%3.:#3D.gb(pc),.gb(pc
+1),.gb(pc+2),.gb(pc+3)#0A..RESULTIS.w#0A}#0A#0AAND
.instrtype(f).#3D."?008RI10011RIRI*#0A..16*12411015
002RIRIRIRI*#0A..16*12411015004RIRIRI*#0A..16*12422
015006RIRI*#0A..16*1240013BL006RIRI*#0A..16*1240021
RIRIRI*#0A..16*124008?2?0013?*#0A..16*1240000812?00
12??"%f#0A#0AAND.nextpc(pc).#3D.VALOF.SWITCHON.inst
rtype(gb(pc)).INTO#0A..21{.DEFAULT:#0A..23CASE.'0':
.RESULTIS.pc+1#0A..23CASE.'1':#0A..23CASE.'R':#0A..
23CASE.'I':.RESULTIS.pc+2#0A..23CASE.'2':.RESULTIS.
pc+3#0A..23CASE.'4':.RESULTIS.pc+5#0A..23CASE.'B':.
pc.:#3D.pc+2.&.#23xFF5E#0A..33RESULTIS.pc.+.4*gh(pc
).+.6#0A..23CASE.'L':.pc.:#3D.pc+2.&.#23xFF5E#0A..3
3RESULTIS.pc.+.2*gh(pc).+.6#0A..21}#0A#0AAND.nextwo
rd().#3D.VALOF#0A{.UNTIL.blkcount.DO#0A..{.UNLESS.r
eadwords(@blkcount,.1).DO#0A..2{.//sawritef("Bad.co
unt.in.dump.file.data*n")#0A..4//abort(1001)#0A..4b
lkcount,.currword.:#3D.0,.#23xBAD00BAD#0A..4RESULTI
S.currword#0A..2}#0A..2IF.blkcount<0.DO#0A..2{.UNLE
SS.readwords(@currword,.1).DO#0A..4{.sawritef("Bad.
block.dump.file*n")#0A..6currword.:#3D.#23xBAD00BAD
#0A..4}#0A..2}#0A..2//TEST.blkcount<0#0A..2//THEN.s
awritef("%i7.x.%x8*n",.-blkcount,.currword)#0A..2//
ELSE.sawritef("%i7.BLOCK*n",.blkcount)#0A//abort(10
01)#0A..}#0A#0A..TEST.blkcount>0#0A..THEN.{.UNLESS.
readwords(@currword,.1).DO#0A..7{.sawritef("Bad.blo
ck.dump.file*n")#0A..9currword.:#3D.#23xBAD00BAD#0A
..7}#0A..7blkcount.:#3D.blkcount.-.1#0A..7RESULTIS.
currword#0A..5}#0A..ELSE.{.blkcount.:#3D.blkcount+1
#0A..7RESULTIS.currword#0A..5}#0A#0A}#0A#0AAND.eqpa
ges(p1,.p2).#3D.VALOF#0A{.FOR.i.#3D.0.TO.pageupb.UN
LESS.p1!i#3Dp2!i.RESULTIS.FALSE#0A..RESULTIS.TRUE#0A
}#0A#0AAND.getimage(filename).#3D.VALOF#0A{.//.Retu
rn.TRUE.is.successful,.FALSE.otherwise#2E#0A..LET.r
es.#3D.FALSE..15//.Assume.the.worst#0A#0A..datastre
am.:#3D.findinput(filename)#0A#0A..UNLESS.datastrea
m.RESULTIS.FALSE#0A..selectinput(datastream)#0A#0A.
.writef("*nReading.image.file.#2E#2E1")#0A..deplete
(cos)#0A#0A..blkcount,.currword.:#3D.0,.#23xBAD00BA
D#0A..pagetab.:#3D.0#0A..pagenoupb.:#3D.0#0A#0A..//
.Get.the.memory.upb#0A..UNLESS.readwords(@memupb,.1
).DO#0A..{.writef("*nBad.memupb.in.dump.file*n")#0A
..2GOTO.ret#0A..}#0A#0A..IF.memupb<0.GOTO.ret#0A#0A
..pagenoupb.:#3D.memupb>>pageshift#0A..pagetab.:#3D
.getvec(pagenoupb)#0A..UNLESS.pagetab.DO#0A..{.writ
ef("*nUnable.to.to.allocate.space.for.the.page.tabl
e*n")#0A..2RESULTIS.FALSE#0A..}#0A..//.Initialise.t
he.page.table#0A..FOR.pageno.#3D.0.TO.pagenoupb.DO.
pagetab!pageno.:#3D.0#0A#0A..FOR.pageno.#3D.0.TO.pa
genoupb.DO#0A..{.LET.page.#3D.VEC.pageupb#0A..2AND.
newpage.#3D.0#0A..2//.Read.the.next.page#0A..2FOR.i
.#3D.0.TO.pageupb.DO.page!i.:#3D.nextword()#0A#0A..
2//.Is.it.the.same.as.a.previous.page#0A..2FOR.p.#3D
.0.TO.pageno-1.IF.eqpages(page,.pagetab!p).DO#0A..2
{.//.A.matching.page.has.been.found#0A..4newpage.:#3D
.pagetab!p#0A//sawritef("page.%i5.same.as.page.%i5*
n",.pageno,.p)#0A..4BREAK#0A..2}#0A..2UNLESS.newpag
e.DO#0A..2{.//.A.matching.page.was.not.found.so.mak
e.a.new.one#0A..4newpage.:#3D.getvec(pageupb)#0A..4
FOR.i.#3D.0.TO.pageupb.DO.newpage!i.:#3D.page!i#0A/
/sawritef("page.%i5.is.new*n",.pageno)#0A..2}#0A..2
//.Put.the.page.in.the.page.table#0A..2pagetab!page
no.:#3D.newpage#0A..2IF.pageno.MOD.100.#3D.0.DO.{.w
rch('#2E');.deplete(cos).}#0A//abort(1234)#0A..}#0A
#0A..newline()#0A#0A..res.:#3D.TRUE..1//.Image.succ
essful.read#0A#0Aret:#0A..IF.datastream.DO.endstrea
m(datastream)#0A//abort(222)#0A..RESULTIS.res#0A}#0A
#0AAND.deleteimage().BE.IF.pagetab.DO#0A{.FOR.pagen
o.#3D.0.TO.pagenoupb.DO#0A..{.LET.page.#3D.pagetab!
pageno#0A..2UNLESS.page.LOOP#0A..2freevec(page)#0A.
.2//.Delete.all.page.table.entries.pointing.to.this
.page#2E#0A..2FOR.p.#3D.pageno+1.TO.pagenoupb.IF.pa
ge#3Dpagetab!p.DO.pagetab!p.:#3D.0#0A..}#0A..freeve
c(pagetab)#0A}#0A#0AAND.mem(p).#3D.VALOF#0A{.LET.pa
geno.#3D.p>>pageshift..//.Typically.10#0A..AND.offs
et.#3D.p.&.pagemask..//.Typically.1023#0A..#0A..IF.
pageno.>.pagenoupb.DO#0A..{.writef("*nBad.Cintpos.m
emory.address.%x8..%n*n",.p,.p)#0A..2longjump(rec_p
,.rec_l)#0A..2//.Should.not.reach.this.point#0A..2R
ESULTIS.#23xBAD00BAD#0A..}#0A#0A..RESULTIS.pagetab!
pageno!offset#0A}#0A#0AAND.stmem(p,.w).BE#0A{.LET.p
ageno.#3D.p>>pageshift..//.Typically.12#0A..AND.off
set.#3D.p.&.pagemask..//.Typically.4095#0A..AND.pag
e,.count.#3D.0,.0#0A#0A..IF.pageno.>.pagenoupb.DO#0A
..{.writef("*nBad.Cintpos.memory.address.%x8..%n*n"
,.p,.p)#0A..2longjump(rec_p,.rec_l)#0A..2//.Should.
not.reach.this.point#0A..2RETURN#0A..}#0A#0A..page.
:#3D.pagetab!pageno#0A#0A..FOR.i.#3D.0.TO.pagenoupb
.IF.pagetab!i#3Dpage.DO.count.:#3D.count.+.1#0A..IF
.count>1.DO#0A..{.//.There.are.more.pages.sharing.t
his.page,.so.make.a.copy#0A..2LET.newpage.#3D.getve
c(pageupb)#0A..2UNLESS.newpage.DO#0A..2{.writef("*n
More.space.needed*n")#0A..4longjump(rec_p,.rec_l)#0A
..4//.Should.not.reach.this.point#0A..4RETURN#0A..2
}#0A#0Asawritef("*nCopying.page.%n*n",.pageno)#0A..
2FOR.i.#3D.0.TO.pageupb.DO.newpage!i.:#3D.page!i#0A
..2pagetab!pageno.:#3D.newpage#0A..}#0A#0A..pagetab
!pageno!offset.:#3D.w#0A}#0A#0AAND.memb(p,.n).#3D.V
ALOF#0A{.LET.word.#3D.mem(p+(n>>0002))#0A..RESULTIS
.(@word)%(n&3)#0A}#0A#0AAND.stmemb(p,.n,.byte).#3D.
VALOF#0A{.LET.word.#3D.mem(p+(n>>0002))#0A..(@word)
%(n&3).:#3D.byte#0A..stmem(p+(n>>0002))#0A}#0A

######com/prefix.b#
GET."libhdr"#0D#0A#0D#0ALET.start().#3D.VALOF#0D#0A
{.LET.argv.#3D.VEC.50#0D#0A..LET.newstr.#3D.?#0D#0A
..LET.unset..#3D.?#0D#0A#0D#0A..UNLESS.rdargs("PREF
IX,UNSET/S",.argv,.50).DO#0D#0A..{.writef("Bad.argu
ment.for.PREFIX*n")#0D#0A..2RESULTIS.20#0D#0A..}#0D
#0A#0D#0A..newstr.:#3D.argv!0..6//.PREFIX#0D#0A..un
set..:#3D.argv!1..6//.UNSET/S#0D#0A#0D#0A..IF.newst
r.DO.sys(Sys_setprefix,.newstr)#0D#0A..IF.unset..DO
.sys(Sys_setprefix,."")#0D#0A#0D#0A..UNLESS.newstr.
|.unset.DO#0D#0A..{.LET.prefix.#3D.sys(Sys_getprefi
x)#0D#0A..2TEST.prefix%0#0D#0A..2THEN.writef("%s*n"
,.prefix)#0D#0A..2ELSE.writef("No.prefix*n")#0D#0A.
.}#0D#0A#0D#0A..RESULTIS.0#0D#0A}#0D#0A

######com/preload.b#
//.Written.by.M#2E.Richards..(c).June.2000006#0A#0A
SECTION."PRELOAD"#0A#0AGET."libhdr"#0A#0ALET.start(
).#3D.VALOF.//.PRELOAD.[NAME].commandname#0A{.LET.v
.#3D.VEC.50#0A#0A..IF.rdargs(",,7",v,50).#3D.0.DO#0A
..{.writes("Parameters.no.good.for.PRELOAD*N")#0A..
2RESULTIS.20#0A..}#0A#0A..IF.v!0#3D0.DO.wrpreloadli
st()#0A..FOR.i.#3D.0.TO.9.UNLESS.v!i#3D0.DO.preload
(v!i)#0A..RESULTIS.0#0A}#0A#0AAND.wrpreloadlist().B
E#0A{.LET.p.#3D.cli_preloadlist#0A..IF.p#3D0.DO.wri
tes("No.preloaded.commands*n")#0A..UNTIL.p#3D0.DO#0A
..{.LET.q.#3D.p!1#0A..2AND.name.#3D.@.p!2#0A..2AND.
size.#3D.0#0A..2WHILE.q.DO.{.size.:#3D.size+q!1#0A.
.15q.:#3D.!q#0A..13}#0A..2writef("%tF..size.%i5.byt
es*n",.name,.size<<0002)#0A..2p.:#3D.!p#0A..}#0A}#0A
#0AAND.preload(name).BE#0A{.LET.module.#3D.loadseg(
name)#0A..AND.p.#3D.cli_preloadlist#0A..AND.len.#3D
.name%0#0A..UNLESS.module.DO.{.writef("Unable.to.pr
eload.%s*n",.name)#0A..19RETURN#0A..17}#0A..//.Repl
ace.the.previous.preloaded.version.if.it.exists#2E#0A
..WHILE.p.DO.{.IF.compstring(name,.@p!2)#3D0.DO#0A.
.13{.unloadseg(p!1)#0A..15p!1.:#3D.module#0A..15RET
URN#0A..13}#0A..13p.:#3D.!p#0A..11}#0A..//.Insert.a
.new.item.in.the.preload.list#2E#0A..p.:#3D.getvec(
3.+.len/bytesperword)#0A..UNLESS.p.DO.{.writef("Una
ble.to.preload.%s*n",.name)#0A..14RETURN#0A..12}#0A
..p!0.:#3D.cli_preloadlist#0A..p!1.:#3D.module#0A..
FOR.i.#3D.0.TO.len.DO.(@p!2)%i.:#3D.name%i#0A..cli_
preloadlist.:#3D.p#0A}#0A

######com/procode.b#
/*#0AThis.program.converts.the.numeric.representati
on.of.OCODE#0Ainto.a.more.readable.form#2E#0A#0A000
26/07/10#0AUpdated.to.include.the.OF,.floating.poin
t.and.op:#3D#0Aextensions#0A*/#0A#0ASECTION."procod
e"#0A#0AGET."libhdr"#0AGET."bcplfecg"#0A#0ALET.star
t().#3D.VALOF#0A{.LET.argv.#3D.VEC.20#0A..LET.ocode
in.#3D.?#0A..AND.ocodeprn.#3D.0#0A..LET.sysprint.#3D
.output()#0A..IF.rdargs("FROM,TO/K",.argv,.20)#3D0.
DO#0A..{.writes("Bad.args.for.procode*n")#0A..2RESU
LTIS.20#0A..}#0A..IF.argv!0#3D0.DO.argv!0.:#3D."oco
de"#0A..IF.argv!1#3D0.DO.argv!1.:#3D."**"#0A..ocode
in.:#3D.findinput(argv!0)#0A..IF.ocodein#3D0.DO#0A.
.{.writef("Trouble.with.file.%s*n",.argv!0)#0A..2RE
SULTIS.20#0A..}#0A..ocodeprn.:#3D.findoutput(argv!1
)#0A..1#0A..IF.ocodeprn#3D0.DO#0A..{.writef("Troubl
e.with.file.%s*n",.argv!1)#0A..2RESULTIS.20#0A..}#0A
..1#0A..writef("Converting.%s.to.%s*n",.argv!0,.arg
v!1)#0A..selectinput(ocodein)#0A..selectoutput(ocod
eprn)#0A..scan()#0A..endread()#0A..UNLESS.ocodeprn#3D
sysprint.DO.endwrite()#0A..selectoutput(sysprint)#0A
..writef("Conversion.complete*n")#0A..RESULTIS.0#0A
}#0A#0A//.argument.may.be.of.form.Ln#0AAND.rdn().#3D
.VALOF#0A{.LET.a,.ch,.sign.#3D.0,.?,.'+'#0A#0A..ch.
:#3D.rdch().REPEATWHILE.ch#3D'*S'.|.ch#3D'*n'#0A#0A
..IF.ch#3Dendstreamch.RESULTIS.0#0A#0A..IF.ch#3D'-'
.DO.{.sign.:#3D.'-';.ch.:#3D.rdch().}#0A#0A..WHILE.
'0'<#3Dch<#3D'9'.DO.{.a.:#3D.10*a.+.ch.-.'0';.ch.:#3D
.rdch()..}#0A#0A..IF.sign#3D'-'.RESULTIS.-a#0A..RES
ULTIS.a#0A}#0A#0A1AND.scan().BE#0A{.LET.ocodeop.#3D
.rdn()#0A..LET.op0,.op1,.op2,.op1l,.len.#3D.0,.0,.0
,.0,.-1#0A..//LET.opf2,.ops2.#3D.0,.0#0A..LET.ops2.
#3D.0#0A#0A..SWITCHON.ocodeop.INTO#0A#0A..{.DEFAULT
:..7writef("Bad.OCODE.op.%n*n",.ocodeop)#0A..19abor
t(1001)#0A..19LOOP#0A#0A..2CASE.0:..8RETURN#0A..4#0A
..2CASE.s_section:..op0,.len.:#3D."SECTION",.rdn();
.ENDCASE#0A..2CASE.s_needs:..2op0,.len.:#3D."NEEDS"
,..1rdn();.ENDCASE#0A#0A..2CASE.s_lp:..5op1.:#3D."L
P";..10ENDCASE#0A..2CASE.s_lg:..5op1.:#3D."LG";..10
ENDCASE#0A..2CASE.s_ln:..5op1.:#3D."LN";..10ENDCASE
#0A#0A//..2CASE.s_fnum:..3opf2.:#3D."FNUM";..7ENDCA
SE#0A#0A..2CASE.s_lstr:..3op0,.len.:#3D."LSTR",.rdn
();.ENDCASE#0A#0A..2CASE.s_true:..3op0.:#3D."TRUE";
..8ENDCASE#0A..2CASE.s_false:..2op0.:#3D."FALSE";..
7ENDCASE#0A#0A..2CASE.s_llp:..4op1.:#3D."LLP";..9EN
DCASE#0A..2CASE.s_llg:..4op1.:#3D."LLG";..9ENDCASE#0A
#0A..2CASE.s_sp:..5op1.:#3D."SP";..10ENDCASE#0A..2C
ASE.s_sg:..5op1.:#3D."SG";..10ENDCASE#0A#0A..2CASE.
s_lf:..5op1l.:#3D."LF";..9ENDCASE#0A..2CASE.s_ll:..
5op1l.:#3D."LL";..9ENDCASE#0A..2CASE.s_ll1:..4op1l.
:#3D."LL1";..8ENDCASE#0A..2CASE.s_sl:..5op1l.:#3D."
SL";..9ENDCASE#0A..4#0A..2CASE.s_selld:..2op2.:#3D.
"SELLD";..7ENDCASE#0A..2CASE.s_selst:..2ops2.:#3D."
SELST";..6ENDCASE#0A#0A..2CASE.s_stind:..2op0.:#3D.
"STIND";..7ENDCASE#0A#0A..2CASE.s_rv:..5op0.:#3D."R
V";..10ENDCASE#0A#0A..2CASE.s_float:..2op0.:#3D."FL
OAT";..7ENDCASE#0A..2CASE.s_fix:..4op0.:#3D."FIX";.
.9ENDCASE#0A..2CASE.s_fabs:..3op0.:#3D."FABS";..8EN
DCASE#0A..2CASE.s_fmul:..3op0.:#3D."FMUL";..8ENDCAS
E#0A..2CASE.s_fdiv:..3op0.:#3D."FDIV";..8ENDCASE#0A
..2CASE.s_fadd:..3op0.:#3D."FADD";..8ENDCASE#0A..2C
ASE.s_fsub:..3op0.:#3D."FSUB";..8ENDCASE#0A..2CASE.
s_fneg:..3op0.:#3D."FNEG";..8ENDCASE#0A..2CASE.s_fe
q:..4op0.:#3D."FEQ";..9ENDCASE#0A..2CASE.s_fne:..4o
p0.:#3D."FNE";..9ENDCASE#0A..2CASE.s_fls:..4op0.:#3D
."FLS";..9ENDCASE#0A..2CASE.s_fgr:..4op0.:#3D."FGR"
;..9ENDCASE#0A..2CASE.s_fle:..4op0.:#3D."FLE";..9EN
DCASE#0A..2CASE.s_fge:..4op0.:#3D."FGE";..9ENDCASE#0A
#0A..2CASE.s_mul:..4op0.:#3D."MUL";..9ENDCASE#0A..2
CASE.s_div:..4op0.:#3D."DIV";..9ENDCASE#0A..2CASE.s
_rem:..4op0.:#3D."REM";..9ENDCASE#0A..2CASE.s_add:.
.4op0.:#3D."ADD";..9ENDCASE#0A..2CASE.s_sub:..4op0.
:#3D."SUB";..9ENDCASE#0A..2CASE.s_eq:..5op0.:#3D."E
Q";..10ENDCASE#0A..2CASE.s_ne:..5op0.:#3D."NE";..10
ENDCASE#0A..2CASE.s_ls:..5op0.:#3D."LS";..10ENDCASE
#0A..2CASE.s_gr:..5op0.:#3D."GR";..10ENDCASE#0A..2C
ASE.s_le:..5op0.:#3D."LE";..10ENDCASE#0A..2CASE.s_g
e:..5op0.:#3D."GE";..10ENDCASE#0A..2CASE.s_lshift:.
.1op0.:#3D."LSHIFT";..6ENDCASE#0A..2CASE.s_rshift:.
.1op0.:#3D."RSHIFT";..6ENDCASE#0A..2CASE.s_logand:.
.1op0.:#3D."LOGAND";..6ENDCASE#0A..2CASE.s_logor:..
2op0.:#3D."LOGOR";..7ENDCASE#0A..2CASE.s_eqv:..4op0
.:#3D."EQV";..9ENDCASE#0A..2CASE.s_neqv:..3op0.:#3D
."NEQV";..8ENDCASE#0A..2CASE.s_not:..4op0.:#3D."NOT
";..9ENDCASE#0A..2CASE.s_neg:..4op0.:#3D."NEG";..9E
NDCASE#0A..2CASE.s_abs:..4op0.:#3D."ABS";..9ENDCASE
#0A#0A..2CASE.s_jt:..5op1l.:#3D."JT";..9ENDCASE#0A.
.2CASE.s_jf:..5op1l.:#3D."JF";..9ENDCASE#0A#0A..2CA
SE.s_goto:..3op0.:#3D."GOTO";..8ENDCASE#0A#0A..2CAS
E.s_lab:..4op1l.:#3D."LAB";..8ENDCASE#0A#0A..2CASE.
s_query:..2op0.:#3D."QUERY";..7ENDCASE#0A#0A..2CASE
.s_stack:..2op1.:#3D."STACK";..7ENDCASE#0A#0A..2CAS
E.s_store:..2op0.:#3D."STORE";..7ENDCASE#0A#0A..2CA
SE.s_entry:..2{.LET.l.#3D.rdn()#0A..21len.:#3D.rdn(
)#0A..21writef("ENTRY.L%n",.l)#0A..21ENDCASE#0A..19
}#0A#0A..2CASE.s_save:..3op1.:#3D."SAVE";..8ENDCASE
#0A#0A..2CASE.s_fnap:..3op1.:#3D."FNAP";..8ENDCASE#0A
..2CASE.s_rtap:..3op1.:#3D."RTAP";..8ENDCASE#0A#0A.
.2CASE.s_fnrn:..3op0.:#3D."FNRN";..8ENDCASE#0A..2CA
SE.s_rtrn:..3op0.:#3D."RTRN";..8ENDCASE#0A#0A..2CAS
E.s_endproc:..op0.:#3D."ENDPROC";..5ENDCASE.//.no.a
rgs.now#0A#0A..2CASE.s_res:..4op1l.:#3D."RES";..8EN
DCASE#0A..2CASE.s_jump:..3op1l.:#3D."JUMP";..7ENDCA
SE#0A#0A..2CASE.s_rstack:..1op1.:#3D."RSTACK";..6EN
DCASE#0A#0A..2CASE.s_finish:..1op0.:#3D."FINISH";..
6ENDCASE#0A#0A..2CASE.s_switchon:.{.LET.n.#3D.rdn()
#0A..21writef("SWITCHON.%n.L%n*n",.n,.rdn())#0A..21
FOR.i.#3D.1.TO.n.DO#0A..21{.writef("%i8..1",.rdn())
#0A..23writef("L%n*n",.rdn())#0A..21}#0A..21newline
()#0A..21LOOP#0A..19}#0A#0A..2CASE.s_getbyte:..op0.
:#3D."GETBYTE";..5ENDCASE#0A..2CASE.s_putbyte:..op0
.:#3D."PUTBYTE";..5ENDCASE#0A#0A..2CASE.s_global:..
1{.LET.n.#3D.rdn()#0A..21writef("GLOBAL.%n*n",.n)#0A
..21FOR.i.#3D.1.TO.n.DO#0A..21{.writef("%i8..1",.rd
n())#0A..23writef("L%n*n",.rdn())#0A..21}#0A..21new
line()#0A..21LOOP#0A..19}#0A#0A1..2CASE.s_datalab:.
.op1l.:#3D."DATALAB";..4ENDCASE#0A..2CASE.s_itemn:.
.2op1..:#3D."ITEMN";..6ENDCASE#0A..}#0A#0A..UNLESS.
op0#3D0..1DO.writef("%S",..3op0)#0A..UNLESS.op1#3D0
..1DO.writef("%S.%n",..op1,..rdn())#0A..UNLESS.op2#3D
0..1DO.writef("%S.%n.%n",..op2,..rdn(),.rdn())#0A..
UNLESS.op1l#3D0..DO.writef("%S.L%n",.op1l,.rdn())#0A
..//1UNLESS.opf2#3D0..DO.writef("%S.%n.%n",.opf2,.r
dn(),.rdn())#0A..UNLESS.ops2#3D0..DO#0A..{.LET.s.#3D
.sfname(rdn())#0A..2writef("%s.%s.%n.%n",.ops2,.s,.
rdn(),.rdn())#0A..}#0A..IF.len>#3D0.DO.{.//.Write.a
.string.of.len.characters#0A..15writef(".%n.",.len)
#0A..15FOR.i.#3D.1.TO.len.DO#0A..15{.LET.ch.#3D.rdn
()#0A..17IF.i.REM.15.#3D.0.DO.newline()#0A..17TEST.
32<#3Dch<#3D127.THEN.writef(".'%c'",.ch)#0A..34ELSE
.writef(".%i3.",.ch)#0A..15}#0A..13}#0A#0A..newline
()#0A//abort(1001)#0A}.REPEAT#0A#0AAND.sfname(sfop)
.#3D.VALOF.SWITCHON.sfop.INTO#0A{.DEFAULT:..6RESULT
IS."UNKNOWN"#0A#0A..CASE.0:..7RESULTIS."NULL"#0A..C
ASE.sf_vecap:..RESULTIS."VECAP"#0A..CASE.sf_fmul:..
1RESULTIS."FMUL"#0A..CASE.sf_fdiv:..1RESULTIS."FDIV
"#0A..CASE.sf_fadd:..1RESULTIS."FADD"#0A..CASE.sf_f
sub:..1RESULTIS."FSUB"#0A..CASE.sf_mul:..2RESULTIS.
"MUL"#0A..CASE.sf_div:..2RESULTIS."DIV"#0A..CASE.sf
_rem:..2RESULTIS."REM"#0A..CASE.sf_add:..2RESULTIS.
"ADD"#0A..CASE.sf_sub:..2RESULTIS."SUB"#0A..CASE.sf
_lshift:.RESULTIS."LSHIFT"#0A..CASE.sf_rshift:.RESU
LTIS."RSHIFT"#0A..CASE.sf_logand:.RESULTIS."LOGAND"
#0A..CASE.sf_logor:..RESULTIS."LOGOR"#0A..CASE.sf_e
qv:..2RESULTIS."EQV"#0A..CASE.sf_neqv:..1RESULTIS."
NEQV"#0A}#0A#0A1

######com/prompt.b#
//.(C).Copyright.1978.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0ASECTION."PROMPT"#0A#0AGET."libhdr"#0A#0ALET.star
t().#3D.VALOF#0A{.LET.prompt.#3D."%5#2E3d>."#0A..LE
T.v.#3D.VEC.15#0A#0A..UNLESS.rdargs("PROMPT,P0/S,P1
/S,P2/S,P3/S,P4/S,NO/S",v,15).DO#0A..{.writes("Para
meters.no.good.for.PROMPT*N")#0A..2RETURN#0A..}#0A#0A
..IF.v!0.DO.prompt.:#3D.v!0..23//.PROMPT#0A..IF.v!1
.DO.prompt.:#3D.">."..22//.P0/S#0A..IF.v!2.DO.promp
t.:#3D."%+%+%n:%2z:%2z>."..8//.P1/S#0A..IF.v!3.DO.p
rompt.:#3D."%+%+%n:%2z:%2z#2E%3z>."..4//.P2/S#0A..I
F.v!4.DO.prompt.:#3D."%5#2E3d.%+%n:%2z:%2z>."..4//.
P3/S#0A..IF.v!5.DO.prompt.:#3D."%5#2E3d.%+%n:%2z:%2
z#2E%3z>."..//.P3/S#0A#0A..IF.prompt.FOR.i.#3D.0.TO
.prompt%0.DO.cli_prompt%i.:#3D.prompt%i#0A#0A..TEST
.v!6..38//.NO/S#0A..THEN.cli_status.:#3D.cli_status
.|..clibit_noprompt#0A..ELSE.cli_status.:#3D.cli_st
atus.&.~clibit_noprompt#0A}#0A

######com/quit.b#
SECTION."QUIT"#0D#0A#0D#0A//.This.command.terminate
d.the.execution.of.a.command-command#0D#0A#0D#0AGET
."libhdr"#0D#0A#0D#0ALET.start().#3D.VALOF#0D#0A{.L
ET.rc.#3D.0#0D#0A..LET.argv.#3D.VEC.50#0D#0A#0D#0A.
.UNLESS.rdargs("RC/N,REASON/N",.argv,.50).DO#0D#0A.
.{.writes("Bad.arguments.for.Quit*n")#0D#0A..2RESUL
TIS.10#0D#0A..}#0D#0A#0D#0A..IF.(cli_status.&.clibi
t_comcom).~#3D.0.DO#0D#0A..2//.Force.the.currentinp
ut.to.be.exhausted#0D#0A..2cli_currentinput!scb_end
.:#3D.-1#0D#0A#0D#0A..result2.:#3D.0..//.the.defaul
t.reason#0D#0A#0D#0A..IF.argv!0.DO.rc..4:#3D.!(argv
!0)..2//.RC#0D#0A..IF.argv!1.DO.result2.:#3D.!(argv
!1)..2//.REASON#0D#0A#0D#0A..RESULTIS.rc#0D#0A}#0D#0A
#0D#0A

######com/raster.b#
//.(c).M#2E.Richards..Copyright.20.Jun.2000006#0A#0A
//.Typical.usage.when.run.under.rastsys:#0A#0A//.>.
raster.count.1001.scale.12.to.rastdata#0A//.>.bcpl.
com/bcpl#2Eb.to.junk#0A//.#2E#2E1#0A//.>.raster#0A/
/.>.rast2ps#0A#0A/*.This.will.generate.a.relatively
.compact.file.using.run.length.encoding#0A**#0A**.K
1001.S12..0081001.instruction.per.raster.line,.12.b
ytes.per.pixel#0A**.W10B3W1345B1N..00410.white.3.bl
ack.1345.white.1.black.newline#0A**.W13B3W12B2N..6e
tc#0A**.#2E#2E1#0A*/#0A#0A1SECTION."RASTER"#0A#0AGE
T."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.LET.argv.
#3D.VEC.40#0A..AND.outstream.#3D.0#0A..AND.tallyv.#3D
.rootnode!rtn_tallyv#0A..AND.oldout.#3D.output()#0A
..AND.count,.scale.#3D.1001,.12#0A#0A..IF.tallyv#3D
0.DO#0A..{.writes("Rastering.not.available*n")#0A..
2RESULTIS.20#0A..}#0A..1#0A..IF.rdargs("COUNT,SCALE
,TO/K,HELP/S",argv,.40)#3D0.DO#0A..{.writes("Bad.ar
guments.for.RASTER*n")#0A..2RESULTIS.20#0A..}#0A#0A
..IF.argv!3.DO#0A..{.writes("*nTypical.usage:*n*n")
#0A..2writes("..2raster.count.1001.scale.12.to.rast
data*n")#0A..2writes("..2bcpl.com/bcpl#2Eb.to.junk*
n")#0A..2writes("..2#2E#2E1*n")#0A..2writes("..2ras
ter*n")#0A..2writes("..2rast2ps*n")#0A..2writes("*n
..2Remember.to.use.rastsys.(NOT.cintsys)*n")#0A..2R
ESULTIS.0#0A..}#0A#0A..UNLESS.sys(Sys_setraster,.3)
#3D0.DO#0A..{.writes("Rastering.is.not.available*n"
)#0A..2RESULTIS.20#0A..}#0A#0A..UNLESS.argv!0.|.arg
v!1.|.argv!2.DO#0A..{.LET.res.#3D.sys(Sys_setraster
,.0,.0).//.Attempt.to.close.raster.file#0A..2TEST.r
es#3D0.THEN.writes("Raster.file.closed*n")#0A..13EL
SE.writes("Unable.to.close.raster.file*n")#0A..2RES
ULTIS.0#0A..}#0A..1#0A..IF.argv!0.DO.count.:#3D.str
2numb(argv!0)#0A..IF.argv!1.DO.scale.:#3D.str2numb(
argv!1)#0A#0A..writef("*nRastering.to.file.%s.with.
count.#3D.%n.and.scale.#3D.%n*n",#0A..8argv!2,.coun
t,.scale)#0A..sys(Sys_setraster,.1,.count)#0A..sys(
Sys_setraster,.2,.scale)#0A..1#0A..IF.sys(Sys_setra
ster,.0,.argv!2).DO.//.Attempt.to.open.raster.file#0A
..{.writes("Trouble.opening.raster.file:.%s*n",.arg
v!2)#0A..2RESULTIS.20#0A..}#0A#0A..cli_tallyflag.:#3D
.TRUE..//.Tell.the.CLI.to.start.rastering#0A..RESUL
TIS.0#0A}#0A

######com/rename.b#
//.(C).Copyright.1978.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0ASECTION."RENAME"#0A#0AGET."libhdr"#0A#0ALET.star
t().#3D.VALOF#0A{.LET.argv.#3D.VEC.50#0A#0A..UNLESS
.rdargs("FROM/A,TO#3DAS/A/K",.argv,.50).DO#0A..{.wr
ites("Bad.args*n")#0A..2RESULTIS.20#0A..}#0A#0A..UN
LESS.renamefile(argv!0,.argv!1).DO#0A..{.LET.res2.#3D
.result2#0A..2writef("Can't.rename.%s.as.%s*n",.arg
v!0,.argv!1)#0A..2result2.:#3D.res2#0A..2RESULTIS.2
0#0A..}#0A..RESULTIS.0#0A}#0A

######com/repeat.b#
//.(C).Copyright.1978.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0A/*..4REPEAT.COMMAND#0A#0A..6Repeat.a.command.lin
e#0A#0A..6The.stream.character.pointer.is.backspace
d.to#0A..6the.beginning.of.the.line#0A*/#0A#0A1SECT
ION."repeat"#0A#0AGET."libhdr"#0A#0ALET.start().BE#0A
{.UNLESS.input()!scb_type<#3D0.DO#0A..{.writes("REP
EAT.not.allowed.in.C.command*n")#0A..2stop(return_s
evere)#0A..}#0A..//UNLESS.testflags(flag_d).DO#0A..
2WHILE.unrdch().LOOP#0A}#0A

######com/rl-decode.b#
//.This.is.a.program.will.(hopefully).copy.a.file.e
xpanding.its#0A//.run.length.encoding#2E.It.is.the.
inverse.command.for.rl-encode#2E#0A#0A//.Implemente
d.by.Martin.Richards.(c).June.2000009#0A#0A//.Usage
:#0A#0A//.rl-decode.filename.[[TO].tofile]#0A#0A/*#0A
#0AThe.given.file.is.read.as.binary.8-bit.bytes#2E.
If.two.identical#0Abytes.are.encountered,.it.will.r
ead.up.to.three.decimal.digits#0Agiving.the.number.
of.repetition.of.the.latest.byte#2E#0A#0A*/#0A#0AGE
T."libhdr"#0A#0AGLOBAL.{#0A.eof:.ug#0A.sysin#0A.sys
out#0A.fromname#0A.toname#0A.fromstream#0A.tostream
#0A.count#0A}#0A#0ALET.start().#3D.VALOF#0A{.LET.ar
gv.#3D.VEC.50#0A..sysin..4:#3D.input()#0A..sysout..
3:#3D.output()#0A..fromname..1:#3D.0#0A..toname..3:
#3D."**"#0A..fromstream.:#3D.0#0A..tostream..1:#3D.
0#0A..count..4:#3D.0#0A#0A..UNLESS.rdargs("FROM/A,T
O/K",.argv,.50).DO#0A..{.writes("bad.arguments.for.
rl-decode*n")#0A..2stop(20)#0A..}#0A#0A..fromname.:
#3D.argv!0..20//.FROM#0A..IF.argv!1.DO.toname..1:#3D
.argv!1..7//.TO#0A.#0A..fromstream.:#3D.findinput(f
romname)#0A..UNLESS.fromstream.DO#0A..{.writef("can
't.open.%s*n",.fromname)#0A..2stop(20)#0A..}#0A#0A.
.tostream.:#3D.findoutput(toname)#0A..UNLESS.tostre
am.DO#0A..{.writef("can't.open.%s*n",.toname)#0A..2
endread()#0A..2stop(20)#0A..}#0A..selectoutput(tost
ream)#0A..selectinput(fromstream)#0A#0A..{.LET.ch.#3D
.binrdch()#0A#0A..2UNTIL.ch#3Dendstreamch.DO#0A..2{
.LET.ch1.#3D.binrdch()#0A..4TEST.ch#3Dch1#0A..4THEN
.{.//.Two.identical.bytes#0A..11LET.i,.n.#3D.0,.0#0A
..11//.Read.up.to.three.digits#0A..11{.ch1.:#3D.bin
rdch()#0A..13i.:#3D.i+1#0A..13IF.i>3.BREAK#0A..13UN
LESS.'0'<#3Dch1<#3D'9'.BREAK#0A..13n.:#3D.10*n.+.ch
1.-.'0'#0A..11}.REPEAT#0A..11//.Write.the.ch.twice.
folloed.by.n.repetitions#0A..11FOR.i.#3D.1.TO.n+2.D
O.binwrch(ch)#0A..9}#0A..4ELSE.{.binwrch(ch)#0A..9}
#0A..4ch.:#3D.ch1#0A..2}#0A..}#0A#0A..UNLESS.sysout
#3Dtostream.DO.endwrite()#0A..endread()#0A#0A..sele
ctoutput(sysout)#0A..RESULTIS.0#0A}#0A#0A6

######com/rl-encode.b#
//.This.is.a.program.will.(hopefully).copy.a.file.c
ompacting.it#0A//.using.run.length.encoding#2E#0A#0A
//.Implemented.by.Martin.Richards.(c).June.2000009#0A
#0A//.Usage:#0A#0A//.rl-encode.filename.[[TO].tofil
e]#0A#0A/*#0A#0AThe.given.file.will.be.read.as.bina
y.8-bit.bytes#2E.If.two.identical#0Abytes.are.encou
ntered.they.will.be.copied.and.followed.by.up.to.3#0A
decimal.digits.giving.the.count.of.how.many.more.oc
curences.of.this#0Acharacter.should.follow#2E.Ordin
ary.text.files.will.convert.into.hopefully#0Amore.c
ompact.text.files#2E#0A#0AThe.inverse.command.is#0A
#0Arl-decode.filename.[[TO].tofile]#0A#0A*/#0A#0AGE
T."libhdr"#0A#0AGLOBAL.{#0A.eof:.ug#0A.sysin#0A.sys
out#0A.fromname#0A.toname#0A.fromstream#0A.tostream
#0A.count#0A}#0A#0ALET.start().#3D.VALOF#0A{.LET.ar
gv.#3D.VEC.50#0A..sysin..4:#3D.input()#0A..sysout..
3:#3D.output()#0A..fromname..1:#3D.0#0A..toname..3:
#3D."**"#0A..fromstream.:#3D.0#0A..tostream..1:#3D.
0#0A..count..4:#3D.0#0A#0A..UNLESS.rdargs("FROM/A,T
O/K",.argv,.50).DO#0A..{.writes("bad.arguments.for.
rl-encode*n")#0A..2stop(20)#0A..}#0A#0A..fromname.:
#3D.argv!0..20//.FROM#0A..IF.argv!1.DO.toname..1:#3D
.argv!1..7//.TO#0A.#0A..fromstream.:#3D.findinput(f
romname)#0A..UNLESS.fromstream.DO#0A..{.writef("can
't.open.%s*n",.fromname)#0A..2stop(20)#0A..}#0A#0A.
.tostream.:#3D.findoutput(toname)#0A..UNLESS.tostre
am.DO#0A..{.writef("can't.open.%s*n",.toname)#0A..2
endread()#0A..2stop(20)#0A..}#0A..selectoutput(tost
ream)#0A..selectinput(fromstream)#0A#0A..{.LET.ch.#3D
.binrdch()#0A#0A..2UNTIL.ch#3Dendstreamch.DO#0A..2{
.LET.ch1.#3D.binrdch()#0A..4TEST.ch#3Dch1#0A..4THEN
.{.//.Two.identical.bytes#0A..11LET.repcount.#3D.0#0A
..11{.ch1.:#3D.binrdch()#0A..13IF.ch~#3Dch1.|.repco
unt#3D991.BREAK#0A..13repcount.:#3D.repcount+1#0A..
11}.REPEAT#0A..11binwrch(ch)#0A..11binwrch(ch)#0A..
11IF.'0'<#3Dch1<#3D'9'.DO.repcount.:#3D.repcount.+.
1001#0A..11IF.repcount>99.DO.wrch(repcount/100.MOD.
10.+.'0')#0A..11IF.repcount>9..DO.wrch(repcount/10.
.MOD.10.+.'0')#0A..11IF.repcount>0..DO.wrch(repcoun
t..3MOD.10.+.'0')#0A..9}#0A..4ELSE.{.binwrch(ch)#0A
..9}#0A..4ch.:#3D.ch1#0A..2}#0A..}#0A#0A..UNLESS.sy
sout#3Dtostream.DO.endwrite()#0A..endread()#0A#0A..
selectoutput(sysout)#0A..RESULTIS.0#0A}#0A#0A6

######com/safebcpl.b#
//.This.is.the.BCPL.to.Cintcode.compiler#0A#0A//.Im
plemented.by.Martin.Richards.(c).May.2000009#0A#0A/
/.Note:.#2E#2E/cintcode/.is.used.so.that.the.compil
er.can.be#0A//.compiled.in.a.directory.parallel.to.
cintcode.(such.as.natbcpl)#2E#0A#0AGET."#2E#2E/cint
code/com/safebcplfe#2Eb"#0A#0A#2E#0A#0AGET."#2E#2E/
cintcode/com/safebcplcgcin#2Eb"#0A

######com/setlogname.b#
/*#0AThis.command.either.lists.the.current.logical.
name.value.pairs#0Aor.adds.a.new.pair.to.the.list#2E
.The.list.is.held.in.the.root.node#2E#0A#0A0008/7/0
3.Initial.implementation#2E#0A*/#0A#0ASECTION."setl
ogname"#0A#0AGET."libhdr"#0A#0ALET.start().#3D.VALO
F#0A{.LET.argv.#3D.VEC.50#0A..LET.peername.#3D.0#0A
#0A..UNLESS.rdargs("NAME,VALUE",.argv,.50).DO#0A..{
.writef("Bad.arguments.for.setlogname*n")#0A..2RESU
LTIS.20#0A..}#0A#0A..UNLESS.argv!0.DO..24//.NAME#0A
..{.LET.p.#3D.rootnode!rtn_envlist#0A..2WHILE.p.DO#0A
..2{.writef("%tP.#3D.%s*n",.p!1,.p!2)#0A..4p.:#3D.!
p#0A..2}#0A..2RETURN#0A..}#0A#0A..setlogname(argv!0
,.argv!1)..14//.NAME,.VALUE#0A..RESULTIS.0#0A}#0A..
#0A..2#0A

######com/setroot.b#
//.This.command.can.set.or.inspect.the.rootnode#0A/
/.variables:.rootvar,.pathvar,.hdrsvar.and.scriptva
r#0A#0AGET."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.
LET.argv.#3D.VEC.50#0A..LET.rootvar..2#3D."<unset>"
#0A..LET.pathvar..2#3D.rootvar#0A..LET.hdrsvar..2#3D
.rootvar#0A..LET.scriptsvar.#3D.rootvar#0A#0A..UNLE
SS.rdargs("root,path,hdrs,scripts",.argv,.50).DO#0A
..{.writef("Bad.arguments.for.SETROOT*n")#0A..2RESU
LTIS.0#0A..}#0A#0A..UNLESS.argv!0.|.argv!1.|.argv!2
.|.argv!4.DO#0A..{.//.Output.the.current.settings#0A
..2IF.rootnode!rtn_rootvar.DO.rootvar.:#3D.rootnode
!rtn_rootvar#0A..2IF.rootnode!rtn_pathvar.DO.pathva
r.:#3D.rootnode!rtn_pathvar#0A..2IF.rootnode!rtn_hd
rsvar.DO.hdrsvar.:#3D.rootnode!rtn_hdrsvar#0A..2IF.
rootnode!rtn_scriptsvar.DO.scriptsvar.:#3D.rootnode
!rtn_scriptsvar#0A..2writef("ROOTVAR..2#3D.*"%s*"*n
",.rootvar)#0A..2writef("PATHVAR..2#3D.*"%s*"*n",.p
athvar)#0A..2writef("HDRSVAR..2#3D.*"%s*"*n",.hdrsv
ar)#0A..2writef("SCRIPTSVAR.#3D.*"%s*"*n",.scriptsv
ar)#0A..2RESULTIS.0#0A..}#0A#0A..IF.argv!0.DO.copys
tr(argv!0,.rootnode!rtn_rootvar)#0A..IF.argv!1.DO.c
opystr(argv!1,.rootnode!rtn_pathvar)#0A..IF.argv!2.
DO.copystr(argv!2,.rootnode!rtn_hdrsvar)#0A..IF.arg
v!3.DO.copystr(argv!3,.rootnode!rtn_scriptsvar)#0A#0A
..RESULTIS.0#0A}#0A#0AAND.copystr(s1,.s2).BE#0A{.LE
T.len.#3D.s1%0#0A..TEST.len>39#0A..THEN.writef("Str
ing.%s.too.long*n",.s1)#0A..ELSE.FOR.i.#3D.0.TO.s1%
0.DO.s2%i.:#3D.s1%i#0A}#0A

######com/shellcom.b#
SECTION."shellcom"#0D#0A#0D#0AGET."libhdr"#0D#0A#0D
#0ALET.start().BE#0D#0A{.LET.argv.#3D.VEC.80#0D#0A#0D
#0A..UNLESS.rdargs("COM/A",.argv,.80).DO#0D#0A..{.w
ritef("Bad.argument.for.SHELLCOM*n")#0D#0A..2stop(2
0)#0D#0A..}#0D#0A#0D#0A..sys(Sys_shellcom,.argv!0)#0D
#0A}#0D#0A#0D#0A#0D#0A

######com/sial-386.b#
SECTION."sial-386"#0A#0AGET."libhdr"#0A#0AGET."sial
#2Eh"#0A#0AGLOBAL.{#0Asialin:.ug#0Aasmout;.stdin;.s
tdout#0A#0Ardf;.rdp;.rdg;.rdk;.rdw;.rdl;.rdc#0Ardco
de#0A#0Apval;.gval;.kval;.wval;.lval;.mval#0A#0Asca
n#0Acvf;.cvfp;.cvfg;.cvfk;.cvfw;.cvfl#0A#0Asectname
#0Amodletter#0Acharv#0Alabnumber#0Atracing#0A}#0A#0A
LET.start().#3D.VALOF#0A{.LET.argv.#3D.VEC.20#0A..L
ET.v..2#3D.VEC.20#0A..LET.cv..1#3D.VEC.256/bytesper
word#0A#0A..sectname.:#3D.v#0A..sectname%0.:#3D.0#0A
..modletter.:#3D.'A'#0A..charv.:#3D.cv#0A..labnumbe
r.:#3D.0#0A#0A..asmout.:#3D.0#0A..stdout.:#3D.outpu
t()#0A..IF.rdargs("FROM,TO/K,-t/S",.argv,.20)#3D0.D
O#0A..{.writes("Bad.args.for.sial-386*n")#0A..2RESU
LTIS.20#0A..}#0A..IF.argv!0#3D0.DO.argv!0.:#3D."pro
g#2Esial"..4//.FROM#0A..IF.argv!1#3D0.DO.argv!1.:#3D
."prog#2Es"..7//.TO/K#0A..tracing.:#3D.argv!2..23//
.-t/S#0A#0A..sialin.:#3D.findinput(argv!0)#0A..IF.s
ialin#3D0.DO#0A..{.writef("Trouble.with.file.%s*n",
.argv!0)#0A..2RESULTIS.20#0A..}#0A..asmout.:#3D.fin
doutput(argv!1)#0A..1#0A..IF.asmout#3D0.DO#0A..{.wr
itef("Trouble.with.file.%s*n",.argv!1)#0A..2RESULTI
S.20#0A..}#0A..1#0A..writef("Converting.%s.to.%s*n"
,.argv!0,.argv!1)#0A..selectinput(sialin)#0A..selec
toutput(asmout)#0A#0A..writef("#23.Code.generated.b
y.sial-386*n*n")#0A..writef("#2Etext*n#2Ealign.16*n
")#0A#0A..scan()#0A..endread()#0A..UNLESS.asmout#3D
stdout.DO.endwrite()#0A..selectoutput(stdout)#0A..w
ritef("Conversion.complete*n")#0A..RESULTIS.0#0A}#0A
#0AAND.nextlab().#3D.VALOF#0A{.labnumber.:#3D.labnu
mber+1#0A..RESULTIS.labnumber#0A}#0A#0A//.argument.
may.be.of.form.Ln#0AAND.rdcode(let).#3D.VALOF#0A{.L
ET.a,.ch,.neg.#3D.0,.?,.FALSE#0A#0A..ch.:#3D.rdch()
.REPEATWHILE.ch#3D'*s'.|.ch#3D'*n'#0A#0A..IF.ch#3De
ndstreamch.RESULTIS.-1#0A#0A..UNLESS.ch#3Dlet.DO.er
ror("Bad.item,.looking.for.%c.found.%c*n",.let,.ch)
#0A#0A..ch.:#3D.rdch()#0A#0A..IF.ch#3D'-'.DO.{.neg.
:#3D.TRUE;.ch.:#3D.rdch().}#0A#0A..WHILE.'0'<#3Dch<
#3D'9'.DO.{.a.:#3D.10*a.+.ch.-.'0';.ch.:#3D.rdch().
.}#0A#0A..RESULTIS.neg.->.-a,.a#0A}#0A#0AAND.rdf().
#3D.rdcode('F')#0AAND.rdp().#3D.VALOF.{.pval.:#3D.r
dcode('P');.RESULTIS.pval.}#0AAND.rdg().#3D.VALOF.{
.gval.:#3D.rdcode('G');.RESULTIS.gval.}#0AAND.rdk()
.#3D.VALOF.{.kval.:#3D.rdcode('K');.RESULTIS.kval.}
#0AAND.rdw().#3D.VALOF.{.wval.:#3D.rdcode('W');.RES
ULTIS.wval.}#0AAND.rdl().#3D.VALOF.{.lval.:#3D.rdco
de('L');.RESULTIS.lval.}#0AAND.rdm().#3D.VALOF.{.mv
al.:#3D.rdcode('M');.RESULTIS.mval.}#0AAND.rdc().#3D
.rdcode('C')#0A#0AAND.error(mess,.a,.b,.c).BE#0A{.L
ET.out.#3D.output()#0A..UNLESS.out#3Dstdout.DO#0A..
{.selectoutput(stdout)#0A..2writef(mess,.a,.b,.c)#0A
..2selectoutput(out)#0A..}#0A..writef(mess,.a,.b,.c
)#0A}#0A#0AAND.scan().BE#0A{.LET.op.#3D.rdf()#0A#0A
..SWITCHON.op.INTO#0A#0A..{.DEFAULT:..5error("#23.B
ad.op.%n*n",.op);.LOOP#0A#0A..2CASE.-1:..5RETURN#0A
..4#0A..2CASE.f_lp:..3cvfp("LP").//.a.:#3D.P!n#0A..
17writef("*n.movl.%n(%%ebp),%%ebx",.4*pval)#0A..17E
NDCASE#0A..2CASE.f_lg:..3cvfg("LG").//.a.:#3D.G!n#0A
..17writef("*n.movl.%n(%%esi),%%ebx",.4*gval)#0A..1
7ENDCASE#0A..2CASE.f_ll:..3cvfl("LL").//.a.:#3D.!Ln
#0A..17writef("*n.movl.L%c%n,%%ebx",.modletter,.lva
l)#0A..17ENDCASE#0A#0A..2CASE.f_llp:..2cvfp("LLP").
//.a.:#3D.@.P!n#0A..17writef("*n.leal.%n(%%ebp),%%e
bx",.4*pval)#0A..17writef("*n.shrl.$2,%%ebx")#0A..1
7ENDCASE#0A..2CASE.f_llg:..2cvfg("LLG").//.a.:#3D.@
.G!n#0A..17writef("*n.leal.%n(%%esi),%%ebx",.4*gval
)#0A..17writef("*n.shrl.$2,%%ebx")#0A..17ENDCASE#0A
..2CASE.f_ll1:..2cvfl("LL1").//.a.:#3D.@.!Ln#0A..17
writef("*n.leal.L%c%n,%%ebx",.modletter,.lval)#0A..
17writef("*n.shrl.$2,%%ebx")#0A..17ENDCASE#0A..2CAS
E.f_lf:..3cvfl("LF").//.a.:#3D.byte.address.of.Ln#0A
..17writef("*n.leal.L%c%n,%%ebx",.modletter,.lval)#0A
..17ENDCASE#0A..2CASE.f_lw:..3cvfm("LW")#0A..17writ
ef("*n.movl.M%c%n,%%ebx",.modletter,.mval)#0A..17EN
DCASE#0A#0A..2CASE.f_l:..4cvfk("L").//.a.:#3D.n#0A.
.17IF.kval#3D0.DO.{.writef("*n.xorl.%%ebx,%%ebx");.
ENDCASE.}#0A..17writef("*n.movl.$%n,%%ebx",.kval)#0A
..17ENDCASE#0A..2CASE.f_lm:..3cvfk("LM").//.a.:#3D.
-n#0A..17writef("*n.movl.$-%n,%%ebx",.kval)#0A..17E
NDCASE#0A#0A..2CASE.f_sp:..3cvfp("SP").//.P!n.:#3D.
a#0A..17writef("*n.movl.%%ebx,%n(%%ebp)",.4*pval)#0A
..17ENDCASE#0A..2CASE.f_sg:..3cvfg("SG").//.G!n.:#3D
.a#0A..17writef("*n.movl.%%ebx,%n(%%esi)",.4*gval)#0A
..17ENDCASE#0A..2CASE.f_sl:..3cvfl("SL").//.!Ln.:#3D
.a#0A..17writef("*n.movl.%%ebx,L%c%n",.modletter,.l
val)#0A..17ENDCASE#0A#0A..2CASE.f_ap:..3cvfp("AP").
//.a.:#3D.a.+.P!n#0A..17writef("*n.addl.%n(%%ebp),%
%ebx",.4*pval)#0A..17ENDCASE#0A..2CASE.f_ag:..3cvfg
("AG").//.a.:#3D.a.+.G!n#0A..17writef("*n.addl.%n(%
%esi),%%ebx",.4*gval)#0A..17ENDCASE#0A..2CASE.f_a:.
.4cvfk("A").//.a.:#3D.a.+.n#0A..17IF.kval#3D0.ENDCA
SE#0A..17IF.kval#3D1..DO.{.writef("*n.incl.%%ebx");
.ENDCASE.}#0A..17IF.kval#3D-1.DO.{.writef("*n.decl.
%%ebx");.ENDCASE.}#0A..17writef("*n.addl.$%n,%%ebx"
,.kval)#0A..17ENDCASE#0A..2CASE.f_s:..4cvfk("S")../
/.a.:#3D.a.-.n#0A..17IF.kval#3D0.ENDCASE#0A..17IF.k
val#3D1..DO.{.writef("*n.decl.%%ebx");.ENDCASE.}#0A
..17IF.kval#3D-1.DO.{.writef("*n.incl.%%ebx");.ENDC
ASE.}#0A..17writef("*n.subl.$%n,%%ebx",.kval)#0A..1
7ENDCASE#0A#0A..2CASE.f_lkp:..2cvfkp("LKP").//.a.:#3D
.P!n!k#0A..17writef("*n.movl.%n(%%ebp),%%eax",.4*pv
al)#0A..17writef("*n.movl.%n(,%%eax,4),%%ebx",.4*kv
al)#0A..17ENDCASE#0A..2CASE.f_lkg:..2cvfkg("LKG")./
/.a.:#3D.G!n!k#0A..17writef("*n.movl.%n(%%esi),%%ea
x",.4*gval)#0A..17writef("*n.movl.%n(,%%eax,4),%%eb
x",.4*kval)#0A..17ENDCASE#0A..2CASE.f_rv:..3cvf("RV
")..//.a.:#3D.!.a#0A..17writef("*n.movl.(,%%ebx,4),
%%ebx")#0A..17ENDCASE#0A..2CASE.f_rvp:..2cvfp("RVP"
).//.a.:#3D.P!n!a#0A..17writef("*n.addl.%n(%%ebp),%
%ebx",.4*pval)#0A..17writef("*n.movl.(,%%ebx,4),%%e
bx")#0A..17ENDCASE#0A..2CASE.f_rvk:..2cvfk("RVK")./
/.a.:#3D.a!k#0A..17writef("*n.movl.%n(,%%ebx,4),%%e
bx",.4*kval)#0A..17ENDCASE#0A..2CASE.f_st:..3cvf("S
T").//.!a.:#3D.b#0A..17writef("*n.movl.%%ecx,(,%%eb
x,4)")#0A..17ENDCASE#0A..2CASE.f_stp:..2cvfp("STP")
.//.P!n!a.:#3D.b#0A..17writef("*n.movl.%n(%%ebp),%%
eax",.4*pval)#0A..17writef("*n.addl.%%ebx,%%eax")#0A
..17writef("*n.movl.%%ecx,(,%%eax,4)")#0A..17ENDCAS
E#0A..2CASE.f_stk:..2cvfk("STK").//.a!n.:#3D.b#0A..
17writef("*n.movl.%%ecx,%n(,%%ebx,4)",.4*kval)#0A..
17ENDCASE#0A..2CASE.f_stkp:..1cvfkp("STKP")..//.P!n
!k.:#3D.a#0A..17writef("*n.movl.%n(%%ebp),%%eax",.4
*pval)#0A..17writef("*n.movl.%%ebx,%n(,%%eax,4)",.4
*kval)#0A..17ENDCASE#0A..2CASE.f_skg:..2cvfkg("SKG"
).//.G!n!k.:#3D.a#0A..17writef("*n.movl.%n(%%esi),%
%eax",.4*gval)#0A..17writef("*n.movl.%%ebx,%n(,%%ea
x,4)",.4*kval)#0A..17ENDCASE#0A..2CASE.f_xst:..2cvf
("XST").//.!b.:#3D.a#0A..17writef("*n.movl.%%ebx,(,
%%ecx,4)")#0A..17ENDCASE#0A#0A..2CASE.f_k:..4cvfp("
K").//.Call..a(b,#2E#2E1).incrementing.P.by.n#0A..1
7writef("*n.movl.%%ebx,%%eax")#0A..17writef("*n.mov
l.%%ecx,%%ebx")#0A..17writef("*n.leal.%n(%%ebp),%%e
dx",.4*pval)#0A..17writef("*n.call.**%%eax")#0A..17
ENDCASE#0A..2CASE.f_kpg:..2cvfpg("KPG").//.Call.Gg(
a,#2E#2E1).incrementing.P.by.n#0A..17writef("*n.mov
l.%n(%%esi),%%eax",.4*gval)#0A..17writef("*n.leal.%
n(%%ebp),%%edx",.4*pval)#0A..17writef("*n.call.**%%
eax")#0A..17ENDCASE#0A#0A..2CASE.f_neg:..2cvf("NEG"
).//.a.:#3D.-.a#0A..17writef("*n.negl.%%ebx").#0A..
17ENDCASE#0A..2CASE.f_not:..2cvf("NOT").//.a.:#3D.~
.a#0A..17writef("*n.notl.%%ebx").#0A..17ENDCASE#0A.
.2CASE.f_abs:..2cvf("ABS").//.a.:#3D.ABS.a#0A..15{.
LET.l.#3D.nextlab()#0A..17writef("*n.orl.%%ebx,%%eb
x")#0A..17writef("*n.jge.L%n",.l)#0A..17writef("*n.
negl.%%ebx")#0A..17writef("*nL%n:",.l)#0A..17ENDCAS
E#0A..15}#0A#0A..2CASE.f_xdiv:..1cvf("XDIV").//.a.:
#3D.a./.b#0A..17writef("*n.movl.%%ebx,%%eax")#0A..1
7writef("*n.cdq")#0A..17writef("*n.idiv.%%ecx")#0A.
.17writef("*n.movl.%%eax,%%ebx")#0A..17ENDCASE#0A..
2CASE.f_xrem:..1cvf("XREM").//.a.:#3D.a.REM.b#0A..1
7writef("*n.movl.%%ebx,%%eax")#0A..17writef("*n.cdq
")#0A..17writef("*n.idiv.%%ecx")#0A..17writef("*n.m
ovl.%%edx,%%ebx")#0A..17ENDCASE#0A..2CASE.f_xsub:..
1cvf("XSUB").//.a.:#3D.a.-.b#0A..17writef("*n.subl.
%%ecx,%%ebx")#0A..17ENDCASE#0A#0A..2CASE.f_mul:..2c
vf("MUL").//.a.:#3D.b.*.a;.c.:#3D.?#0A..17writef("*
n.movl.%%ecx,%%eax")#0A..17writef("*n.imul.%%ebx").
//.currupts.edx#0A..17writef("*n.movl.%%eax,%%ebx")
#0A..17ENDCASE#0A..2CASE.f_div:..2cvf("DIV")..//.a.
:#3D.b./.a;.c.:#3D.?#0A..17writef("*n.movl.%%ecx,%%
eax")#0A..17writef("*n.cdq")#0A..17writef("*n.idiv.
%%ebx")#0A..17writef("*n.movl.%%eax,%%ebx")#0A..17E
NDCASE#0A..2CASE.f_rem:..2cvf("REM").//.a.:#3D.b.RE
M.a;.c.:#3D.?#0A..17writef("*n.movl.%%ecx,%%eax")#0A
..17writef("*n.cdq")#0A..17writef("*n.idiv.%%ebx")#0A
..17writef("*n.movl.%%edx,%%ebx")#0A..17ENDCASE#0A.
.2CASE.f_add:..2cvf("ADD").//.a.:#3D.b.+.a#0A..17wr
itef("*n.addl.%%ecx,%%ebx")#0A..17ENDCASE#0A..2CASE
.f_sub:..2cvf("SUB").//.a.:#3D.b.-.a#0A..17writef("
*n.subl.%%ecx,%%ebx")#0A..17writef("*n.negl.%%ebx")
#0A..17ENDCASE#0A#0A..2CASE.f_eq:..3cvf("EQ").//.a.
:#3D.b.#3D.a#0A..17writef("*n.cmpl.%%ebx,%%ecx")#0A
..17writef("*n.seteb.%%bl")#0A..17writef("*n.movzbl
.%%bl,%%ebx")#0A..17writef("*n.negl.%%ebx")#0A..17E
NDCASE#0A..2CASE.f_ne:..3cvf("NE").//.a.:#3D.b.~#3D
.a#0A..17writef("*n.cmpl.%%ebx,%%ecx")#0A..17writef
("*n.setneb.%%bl")#0A..17writef("*n.movzbl.%%bl,%%e
bx")#0A..17writef("*n.negl.%%ebx")#0A..17ENDCASE#0A
..2CASE.f_ls:..3cvf("LS").//.a.:#3D.b.<.a#0A..17wri
tef("*n.cmpl.%%ebx,%%ecx")#0A..17writef("*n.setlb.%
%bl")#0A..17writef("*n.movzbl.%%bl,%%ebx")#0A..17wr
itef("*n.negl.%%ebx")#0A..17ENDCASE#0A..2CASE.f_gr:
..3cvf("GR").//.a.:#3D.b.>.a#0A..17writef("*n.cmpl.
%%ebx,%%ecx")#0A..17writef("*n.setgb.%%bl")#0A..17w
ritef("*n.movzbl.%%bl,%%ebx")#0A..17writef("*n.negl
.%%ebx")#0A..17ENDCASE#0A..2CASE.f_le:..3cvf("LE").
//.a.:#3D.b.<#3D.a#0A..17writef("*n.cmpl.%%ebx,%%ec
x")#0A..17writef("*n.setleb.%%bl")#0A..17writef("*n
.movzbl.%%bl,%%ebx")#0A..17writef("*n.negl.%%ebx")#0A
..17ENDCASE#0A..2CASE.f_ge:..3cvf("GE").//.a.:#3D.b
.>#3D.a#0A..17writef("*n.cmpl.%%ebx,%%ecx")#0A..17w
ritef("*n.setgeb.%%bl")#0A..17writef("*n.movzbl.%%b
l,%%ebx")#0A..17writef("*n.negl.%%ebx")#0A..17ENDCA
SE#0A#0A..2CASE.f_eq0:..2cvf("EQ0").//.a.:#3D.a.#3D
.0#0A..17writef("*n.orl.%%ebx,%%ebx")#0A..17writef(
"*n.seteb.%%bl")#0A..17writef("*n.movzbl.%%bl,%%ebx
")#0A..17writef("*n.negl.%%ebx")#0A..17ENDCASE#0A..
2CASE.f_ne0:..2cvf("NE0").//.a.:#3D.a.~#3D.0#0A..17
writef("*n.orl.%%ebx,%%ebx")#0A..17writef("*n.setne
b.%%bl")#0A..17writef("*n.movzbl.%%bl,%%ebx")#0A..1
7writef("*n.negl.%%ebx")#0A..17ENDCASE#0A..2CASE.f_
ls0:..2cvf("LS0").//.a.:#3D.a.<.0#0A..17writef("*n.
sarl.$31,%%ebx")#0A..17ENDCASE#0A..2CASE.f_gr0:..2c
vf("GR0").//.a.:#3D.a.>.0#0A..17writef("*n.orl.%%eb
x,%%ebx")#0A..17writef("*n.setgb.%%bl")#0A..17write
f("*n.movzbl.%%bl,%%ebx")#0A..17writef("*n.negl.%%e
bx")#0A..17ENDCASE#0A..2CASE.f_le0:..2cvf("LE0").//
.a.:#3D.a.<#3D.0#0A..17writef("*n.orl.%%ebx,%%ebx")
#0A..17writef("*n.setleb.%%bl")#0A..17writef("*n.mo
vzbl.%%bl,%%ebx")#0A..17writef("*n.negl.%%ebx")#0A.
.17ENDCASE#0A..2CASE.f_ge0:..2cvf("GE0").//.a.:#3D.
a.>#3D.0#0A..17writef("*n.sarl.$31,%%ebx")#0A..17wr
itef("*n.notl.%%ebx")#0A..17ENDCASE#0A#0A..2CASE.f_
lsh:..2cvf("LSH").//.a.:#3D.b.<<.a;.b.:#3D.?#0A..17
writef("*n.xchgl.%%ebx,%%ecx")#0A..17writef("*n.cmp
l.$32,%%ecx")#0A..17writef("*n.sbbl.%%eax,%%eax")..
//.set.eax.to.-1.or.0#0A..17writef("*n.andl.%%eax,%
%ebx")..//.set.ebx.to.b.or.0#0A..17writef("*n.sall.
%%cl,%%ebx")..1//.now.shift.it#0A..17ENDCASE#0A..2C
ASE.f_rsh:..2cvf("RSH").//.a.:#3D.b.>>.a;.b.:#3D.?#0A
..17writef("*n.xchgl.%%ebx,%%ecx")#0A..17writef("*n
.cmpl.$32,%%ecx")#0A..17writef("*n.sbbl.%%eax,%%eax
")..//.set.eax.to.-1.or.0#0A..17writef("*n.andl.%%e
ax,%%ebx")..//.set.ebx.to.b.or.0#0A..17writef("*n.s
hrl.%%cl,%%ebx")..1//.now.shift.it#0A..17ENDCASE#0A
..2CASE.f_and:..2cvf("AND").//.a.:#3D.b.&.a.#0A..17
writef("*n.andl.%%ecx,%%ebx").#0A..17ENDCASE#0A..2C
ASE.f_or:..3cvf("OR").//.a.:#3D.b.|.a.#0A..17writef
("*n.orl.%%ecx,%%ebx").#0A..17ENDCASE#0A..2CASE.f_x
or:..2cvf("XOR").//.a.:#3D.b.NEQV.a#0A..17writef("*
n.xorl.%%ecx,%%ebx").#0A..17ENDCASE#0A..2CASE.f_eqv
:..2cvf("EQV").//.a.:#3D.b.EQV.a.#0A..17writef("*n.
xorl.%%ecx,%%ebx").#0A..17writef("*n.notl.%%ebx").#0A
..17ENDCASE#0A#0A..2CASE.f_gbyt:..1cvf("GBYT").//.a
.:#3D.b.%.a#0A..17writef("*n.movzbl.(%%ebx,%%ecx,4)
,%%ebx").#0A..17ENDCASE#0A..2CASE.f_xgbyt:..cvf("XG
BYT").//.a.:#3D.a.%.b.#0A..17writef("*n.movzbl.(%%e
cx,%%ebx,4),%%ebx").#0A..17ENDCASE#0A..2CASE.f_pbyt
:..1cvf("PBYT").//.b.%.a.:#3D.c#0A..17writef("*n.mo
vb.%%dl,(%%ebx,%%ecx,4)").#0A..17ENDCASE#0A..2CASE.
f_xpbyt:..cvf("XPBYT").//.a.%.b.:#3D.c.#0A..17write
f("*n.movb.%%dl,(%%ecx,%%ebx,4)").#0A..17ENDCASE#0A
#0A//.swb..5Kn.Ld.K1.L1.#2E#2E1.Kn.Ln..1Binary.chop
.switch,.Ld.default#0A..2CASE.f_swb:..2cvswb()#0A..
17ENDCASE#0A#0A//.swl..5Kn.Ld.L1.#2E#2E1.Ln..7Label
.vector.switch,.Ld.default#0A..2CASE.f_swl:..2cvswl
()#0A..17ENDCASE#0A#0A..2CASE.f_xch:..2cvf("XCH")./
/.swap.a.and.b#0A..17writef("*n.xchgl.%%ebx,%%ecx")
#0A..17ENDCASE#0A..2CASE.f_atb:..2cvf("ATB").//.b.:
#3D.a#0A..17writef("*n.movl.%%ebx,%%ecx")#0A..17END
CASE#0A..2CASE.f_atc:..2cvf("ATC").//.c.:#3D.a#0A..
17writef("*n.movl.%%ebx,%%edx")#0A..17ENDCASE#0A..2
CASE.f_bta:..2cvf("BTA").//.a.:#3D.b#0A..17writef("
*n.movl.%%ecx,%%ebx")#0A..17ENDCASE#0A..2CASE.f_btc
:..2cvf("BTC").//.c.:#3D.b#0A..17writef("*n.movl.%%
ecx,%%edx")#0A..17ENDCASE#0A..2CASE.f_atblp:..cvfp(
"ATBLP").//.b.:#3D.a;.a.:#3D.P!n#0A..17writef("*n.m
ovl.%%ebx,%%ecx")#0A..17writef("*n.movl.%n(%%ebp),%
%ebx",.4*pval)#0A..17ENDCASE#0A..2CASE.f_atblg:..cv
fg("ATBLG").//.b.:#3D.a;.a.:#3D.G!n#0A..17writef("*
n.movl.%%ebx,%%ecx")#0A..17writef("*n.movl.%n(%%esi
),%%ebx",.4*gval)#0A..17ENDCASE#0A..2CASE.f_atbl:..
1cvfk("ATBL").//.b.:#3D.a;.a.:#3D.k#0A..17writef("*
n.movl.%%ebx,%%ecx")#0A..17writef("*n.movl.$%n,%%eb
x",.kval)#0A..17ENDCASE#0A#0A..2CASE.f_j:..4cvfl("J
").//.jump.to.Ln#0A..17writef("*n.jmp.L%c%n",.modle
tter,.lval)#0A..17ENDCASE#0A..2CASE.f_rtn:..2cvf("R
TN").//.procedure.return#0A..17writef("*n.movl.4(%%
ebp),%%eax")#0A..17writef("*n.movl.0(%%ebp),%%ebp")
#0A..17writef("*n.jmp.**%%eax")#0A..17ENDCASE#0A..2
CASE.f_goto:..1cvf("GOTO").//.jump.to.a#0A..17write
f("*n.jmp.**%%ebx")#0A..17ENDCASE#0A#0A..2CASE.f_re
s:..2cvf("RES")..1//.<res>.:#3D.A#0A..30//.<res>.is
.already.in.A#0A..30//.nothing.to.do#0A..17ENDCASE#0A
#0A..2CASE.f_ldres:..cvf("LSRES").//.A.:#3D.<res>#0A
..30//.A.and.B.already.set.properly#0A..17ENDCASE#0A
#0A..2CASE.f_ikp:..2cvfkp("IKP").//.a.:#3D.P!n.+.k;
.P!n.:#3D.a#0A..17writef("*n.movl.%n(%%ebp),%%ebx",
.4*pval)#0A..17TEST.kval#3D1#0A..17THEN.writef("*n.
incl.%%ebx")#0A..17ELSE.TEST.kval#3D-1#0A..22THEN.w
ritef("*n.decl.%%ebx")#0A..22ELSE.writef("*n.addl.$
%n,%%ebx",.kval)#0A..17writef("*n.movl.%%ebx,%n(%%e
bp)",.4*pval)#0A..17ENDCASE#0A..2CASE.f_ikg:..2cvfk
g("IKG").//.a.:#3D.G!n.+.k;.G!n.:#3D.a#0A..17writef
("*n.movl.%n(%%esi),%%ebx",.4*gval)#0A..17TEST.kval
#3D1#0A..17THEN.writef("*n.incl.%%ebx")#0A..17ELSE.
TEST.kval#3D-1#0A..22THEN.writef("*n.decl.%%ebx")#0A
..22ELSE.writef("*n.addl.$%n,%%ebx",.kval)#0A..17wr
itef("*n.movl.%%ebx,%n(%%esi)",.4*gval)#0A..17ENDCA
SE#0A..2CASE.f_ikl:..2cvfkl("IKL").//.a.:#3D.!Ln.+.
k;.!Ln.:#3D.a#0A..17writef("*n.movl.L%c%n,%%ebx",.m
odletter,.lval)#0A..17TEST.kval#3D1#0A..17THEN.writ
ef("*n.incl.%%ebx")#0A..17ELSE.TEST.kval#3D-1#0A..2
2THEN.writef("*n.decl.%%ebx")#0A..22ELSE.writef("*n
.addl.$%n,%%ebx",.kval)#0A..17writef("*n.movl.%%ebx
,L%c%n",.modletter,.lval)#0A..17ENDCASE#0A..2CASE.f
_ip:..3cvfp("IP").//.a.:#3D.P!n.+.a;.P!n.:#3D.a#0A.
.17writef("*n.addl.%n(%%ebp),%%ebx",.4*pval)#0A..17
writef("*n.movl.%%ebx,%n(%%ebp)",.4*pval)#0A..17END
CASE#0A..2CASE.f_ig:..3cvfg("IG").//.a.:#3D.G!n.+.a
;.G!n.:#3D.a#0A..17writef("*n.addl.%n(%%esi),%%ebx"
,.4*gval)#0A..17writef("*n.movl.%%ebx,%n(%%esi)",.4
*gval)#0A..17ENDCASE#0A..2CASE.f_il:..3cvfl("IL")./
/.a.:#3D.!Ln.+.a;.!Ln.:#3D.a#0A..17writef("*n.addl.
L%c%n,%%ebx",.modletter,.lval)#0A..17writef("*n.mov
l.%%ebx,L%c%n",.modletter,.lval)#0A..17ENDCASE#0A#0A
..2CASE.f_jeq:..2cvfl("JEQ").//.Jump.to.Ln.if.b.#3D
.a#0A..17writef("*n.cmpl.%%ebx,%%ecx")#0A..17writef
("*n.je.L%c%n",.modletter,.lval)#0A..17ENDCASE#0A..
2CASE.f_jne:..2cvfl("JNE").//.Jump.to.Ln.if.b.~#3D.
a#0A..17writef("*n.cmpl.%%ebx,%%ecx")#0A..17writef(
"*n.jne.L%c%n",.modletter,.lval)#0A..17ENDCASE#0A..
2CASE.f_jls:..2cvfl("JLS").//.Jump.to.Ln.if.b.<.a#0A
..17writef("*n.cmpl.%%ebx,%%ecx")#0A..17writef("*n.
jl.L%c%n",.modletter,.lval)#0A..17ENDCASE#0A..2CASE
.f_jgr:..2cvfl("JGR").//.Jump.to.Ln.if.b.>.a#0A..17
writef("*n.cmpl.%%ebx,%%ecx")#0A..17writef("*n.jg.L
%c%n",.modletter,.lval)#0A..17ENDCASE#0A..2CASE.f_j
le:..2cvfl("JLE").//.Jump.to.Ln.if.b.<#3D.a#0A..17w
ritef("*n.cmpl.%%ebx,%%ecx")#0A..17writef("*n.jle.L
%c%n",.modletter,.lval)#0A..17ENDCASE#0A..2CASE.f_j
ge:..2cvfl("JGE").//.Jump.to.Ln.if.b.>#3D.a#0A..17w
ritef("*n.cmpl.%%ebx,%%ecx")#0A..17writef("*n.jge.L
%c%n",.modletter,.lval)#0A..17ENDCASE#0A#0A..2CASE.
f_jeq0:..1cvfl("JEQ0").//.Jump.to.Ln.if.a.#3D.0#0A.
.17writef("*n.orl.%%ebx,%%ebx")#0A..17writef("*n.je
.L%c%n",.modletter,.lval)#0A..17ENDCASE#0A..2CASE.f
_jne0:..1cvfl("JNE0").//.Jump.to.Ln.if.a.~#3D.0#0A.
.17writef("*n.orl.%%ebx,%%ebx")#0A..17writef("*n.jn
e.L%c%n",.modletter,.lval)#0A..17ENDCASE#0A..2CASE.
f_jls0:..1cvfl("JLS0").//.Jump.to.Ln.if.a.<.0#0A..1
7writef("*n.orl.%%ebx,%%ebx")#0A..17writef("*n.jl.L
%c%n",.modletter,.lval)#0A..17ENDCASE#0A..2CASE.f_j
gr0:..1cvfl("JGR0").//.Jump.to.Ln.if.a.>.0#0A..17wr
itef("*n.orl.%%ebx,%%ebx")#0A..17writef("*n.jg.L%c%
n",.modletter,.lval)#0A..17ENDCASE#0A..2CASE.f_jle0
:..1cvfl("JLE0").//.Jump.to.Ln.if.a.<#3D.0#0A..17wr
itef("*n.orl.%%ebx,%%ebx")#0A..17writef("*n.jle.L%c
%n",.modletter,.lval)#0A..17ENDCASE#0A..2CASE.f_jge
0:..1cvfl("JGE0").//.Jump.to.Ln.if.a.>#3D.0#0A..17w
ritef("*n.orl.%%ebx,%%ebx")#0A..17writef("*n.jge.L%
c%n",.modletter,.lval)#0A..17ENDCASE#0A..2CASE.f_jg
e0m:..cvfm("JGE0M").//.Jump.to.Mn.if.a.>#3D.0#0A..1
7writef("*n.orl.%%ebx,%%ebx")#0A..17writef("*n.jge.
M%c%n",.modletter,.mval)#0A..17ENDCASE#0A#0A..2//.T
he.following.five.opcodes.are.never.generated.by#0A
..2//.the.BCPL.compiler#0A..2CASE.f_brk:..2cvf("BRK
").//.Breakpoint.instruction#0A..17writef("*n.unimp
lemented")#0A..17ENDCASE#0A..2CASE.f_nop:..2cvf("NO
P").//.No.operation#0A..17ENDCASE#0A..2CASE.f_chgco
:..cvf("CHGCO").//.Change.coroutine#0A..17writef("*
n.unimplemented")#0A..17ENDCASE#0A..2CASE.f_mdiv:..
1cvf("MDIV").//.a.:#3D.Muldiv(P!3,.P!4,.P!5).#0A..1
7writef("*n.unimplemented")#0A..17ENDCASE#0A..2CASE
.f_sys:..2cvf("SYS").//.System.function#0A..17write
f("*n.unimplemented")#0A..17ENDCASE#0A#0A..2CASE.f_
section:..cvfs("SECTION").//.Name.of.section#0A..19
FOR.i.#3D.0.TO.charv%0.DO.sectname%i.:#3D.charv%i#0A
..19ENDCASE#0A..2CASE.f_modstart:.cvf("MODSTART")./
/.Start.of.module..#0A..19sectname%0.:#3D.0#0A..19E
NDCASE#0A..2CASE.f_modend:..1cvf("MODEND").//.End.o
f.module.#0A..19modletter.:#3D.modletter+1#0A..19EN
DCASE#0A..2CASE.f_global:..1cvglobal().//.Global.in
itialisation.data#0A..19ENDCASE#0A..2CASE.f_string:
..1cvstring().//.String.constant#0A..19ENDCASE#0A..
2CASE.f_const:..2cvconst().//.Large.integer.constan
t#0A..19ENDCASE#0A#0A..2CASE.f_static:..1cvstatic()
.//.Static.variable.or.table#0A..19ENDCASE#0A..2CAS
E.f_mlab:..3cvfm("MLAB").//.Destination.of.jge0m#0A
..19writef("*nM%c%n:",.modletter,.mval)#0A..19ENDCA
SE#0A..2CASE.f_lab:..4cvfl("LAB").//.Program.label#0A
..19writef("*nL%c%n:",.modletter,.lval)#0A..19ENDCA
SE#0A..2CASE.f_lstr:..3cvfm("LSTR").//.a.:#3D.Mn..1
(pointer.to.string)#0A..19writef("*n.leal.M%c%n,%%e
bx",.modletter,.mval)#0A..19writef("*n.shrl.$2,%%eb
x")#0A..19ENDCASE#0A..2CASE.f_entry:..2cventry().//
.Start.of.a.function#0A..19ENDCASE#0A#0A..2CASE.f_f
loat:..2cvf("FLOAT")#0A..19writef("*n#23.unimplemen
ted")#0A..19ENDCASE#0A..2CASE.f_fix:..4cvf("FIX")#0A
..19writef("*n#23.unimplemented")#0A..19ENDCASE#0A.
.2CASE.f_fabs:..3cvf("FABS")#0A..19writef("*n#23.un
implemented")#0A..19ENDCASE#0A#0A..2CASE.f_fmul:..3
cvf("FMUL")#0A..19writef("*n#23.unimplemented")#0A.
.19ENDCASE#0A..2CASE.f_fdiv:..3cvf("FDIV")#0A..19wr
itef("*n#23.unimplemented")#0A..19ENDCASE#0A..2CASE
.f_fadd:..3cvf("FADD")#0A..19writef("*n#23.unimplem
ented")#0A..19ENDCASE#0A..2CASE.f_fsub:..3cvf("FSUB
")#0A..19writef("*n#23.unimplemented")#0A..19ENDCAS
E#0A..2CASE.f_fneg:..3cvf("FNEG")#0A..19writef("*n#23
.unimplemented")#0A..19ENDCASE#0A#0A..2CASE.f_feq:.
.4cvf("FEQ")#0A..19writef("*n#23.unimplemented")#0A
..19ENDCASE#0A..2CASE.f_fne:..4cvf("FNE")#0A..19wri
tef("*n#23.unimplemented")#0A..19ENDCASE#0A..2CASE.
f_fls:..4cvf("FLS")#0A..19writef("*n#23.unimplement
ed")#0A..19ENDCASE#0A..2CASE.f_fgr:..4cvf("FGR")#0A
..19writef("*n#23.unimplemented")#0A..19ENDCASE#0A.
.2CASE.f_fle:..4cvf("FLE")#0A..19writef("*n#23.unim
plemented")#0A..19ENDCASE#0A..2CASE.f_fge:..4cvf("F
GE")#0A..19writef("*n#23.unimplemented")#0A..19ENDC
ASE#0A..}#0A#0A..newline()#0A}.REPEAT#0A#0AAND.cvf(
s)..1BE.writef("#23.%s",.s)#0AAND.cvfp(s)..BE.write
f("#23.%t7.P%n",.s,.rdp())#0AAND.cvfkp(s).BE.writef
("#23.%t7.K%n.P%n",.s,.rdk(),.rdp())#0AAND.cvfg(s).
.BE.writef("#23.%t7.G%n",.s,.rdg())#0AAND.cvfkg(s).
BE.writef("#23.%t7.K%n.G%n",.s,.rdk(),.rdg())#0AAND
.cvfkl(s).BE.writef("#23.%t7.K%n.L%n",.s,.rdk(),.rd
l())#0AAND.cvfpg(s).BE.writef("#23.%t7.P%n.G%n",.s,
.rdp(),.rdg())#0AAND.cvfk(s)..BE.writef("#23.%t7.K%
n",.s,.rdk())#0AAND.cvfw(s)..BE.writef("#23.%t7.W%n
",.s,.rdw())#0AAND.cvfl(s)..BE.writef("#23.%t7.L%n"
,.s,.rdl())#0AAND.cvfm(s)..BE.writef("#23.%t7.M%n",
.s,.rdm())#0A#0AAND.cvswl().BE#0A{.LET.n.#3D.rdk()#0A
..LET.l.#3D.rdl()#0A..LET.lab.#3D.nextlab()#0A..wri
tef("#23.SWL.K%n.L%n",.n,.l)#0A..writef("*n.orl.%%e
bx,%%ebx")#0A..writef("*n.jl.L%c%n",.modletter,.l)#0A
..writef("*n.cmpl.$%n,%%ebx",.n)#0A..writef("*n.jge
.L%c%n",.modletter,.l)#0A..writef("*n.jmp.**L%n(,%%
ebx,4)",.lab)#0A..writef("*n.#2Edata")#0A..writef("
*n.#2Ealign.4")#0A..writef("*nL%n:",.lab)#0A..FOR.i
.#3D.1.TO.n.DO#0A..{.writef("*n#23.L%n",.rdl())#0A.
.2writef("*n.#2Elong.L%c%n",.modletter,.lval)#0A..}
#0A..writef("*n.#2Etext")#0A}#0A#0AAND.cvswb().BE#0A
{.LET.n.#3D.rdk()#0A..LET.l.#3D.rdl()#0A..writef("#23
.SWB.K%n.L%n",.n,.l)#0A..FOR.i.#3D.1.TO.n.DO.#0A..{
.LET.k.#3D.rdk()#0A..2LET.l.#3D.rdl()#0A..2writef("
*n#23.K%n.L%n",.k,.l)#0A..2writef("*n.cmpl.$%n,%%eb
x",.k)#0A..2writef("*n.je.L%c%n",.modletter,.l)#0A.
.}#0A..writef("*n.jmp.L%c%n",.modletter,.l)#0A}#0A#0A
AND.cvglobal().BE#0A{.LET.n.#3D.rdk()#0A..writef("#23
.GLOBAL.K%n*n",.n)#0A..IF.sectname%0#3D0.FOR.i.#3D.
0.TO.4.DO.sectname%i.:#3D."prog"%i#0A..writef("*n#2E
globl.%s*n",.sectname)#0A..writef("*n#2Eglobl._%s*n
",.sectname)#0A..writef("%s:*n",.sectname)#0A..writ
ef("_%s:*n",.sectname)#0A..writef(".movl.4(%%esp),%
%eax*n")#0A..FOR.i.#3D.1.TO.n.DO#0A..{.LET.g.#3D.rd
g()#0A..2LET.n.#3D.rdl()#0A..2writef("#23.G%n.L%n*n
",.g,.n)#0A..2writef(".movl.$L%c%n,%n(%%eax)*n",.mo
dletter,.n,.4*g)#0A..}#0A..writef("#23.G%n",.rdg())
#0A..writef("*n.ret*n")#0A}#0A#0AAND.rdchars().#3D.
VALOF#0A{.LET.n.#3D.rdk()#0A..charv%0.:#3D.n#0A..FO
R.i.#3D.1.TO.n.DO.charv%i.:#3D.rdc()#0A..RESULTIS.n
#0A}#0A#0AAND.cvstring().BE#0A{.LET.lab.#3D.rdm()#0A
..LET.n.#3D.rdchars()#0A..writef("#23.STRING..M%n.K
%n",.lab,.n)#0A..FOR.i.#3D.1.TO.n.DO.writef(".C%n",
.charv%i)#0A..writef("*n#2Edata")#0A..writef("*n.#2E
align.4")#0A..writef("*nM%c%n:",.modletter,.lab)#0A
..FOR.i.#3D.0.TO.n.DO.writef("*n.#2Ebyte.%n",.charv
%i)#0A..writef("*n.#2Etext")#0A}#0A#0AAND.cvconst()
.BE#0A{.LET.lab.#3D.rdm()#0A..LET.w.#3D.rdw()#0A..w
ritef("#23.CONST..1M%n.W%n",.lab,.w)#0A..writef("*n
#2Edata")#0A..writef("*n.#2Ealign.4")#0A..writef("*
nM%c%n:",.modletter,.lab)#0A..writef("*n.#2Elong.%n
",.w)#0A..writef("*n.#2Etext")#0A}#0A#0AAND.cvstati
c().BE#0A{.LET.lab.#3D.rdl()#0A..LET.n.#3D.rdk()#0A
..writef("#23.STATIC..L%n.K%n",.lab,.n)#0A..writef(
"*n#2Edata")#0A..writef("*n.#2Ealign.4")#0A..writef
("*nL%c%n:",.modletter,.lab)#0A..FOR.i.#3D.1.TO.n.D
O.{.writef("*n#23.W%n",.rdw())#0A..20writef("*n.#2E
long.%n",.wval)#0A..18}#0A..writef("*n.#2Etext")#0A
}#0A#0AAND.cvfs(s).BE#0A{.LET.n.#3D.rdchars()#0A..w
ritef("#23.%t7.K%n",.s,.n)#0A..FOR.i.#3D.1.TO.n.DO.
writef(".C%n",.charv%i)#0A}#0A#0AAND.cventry().BE#0A
{.LET.n.#3D.rdchars()#0A..LET.op.#3D.rdf()#0A..LET.
lab.#3D.rdl()#0A..writef("*n#23.Entry.to:.%s*n",.ch
arv)#0A..writef("#23.%t7.K%n",."ENTRY",.n)#0A..FOR.
i.#3D.1.TO.n.DO.writef(".C%n",.charv%i)#0A..newline
()#0A..TEST.op#3Df_lab.THEN.writef("#23.LAB..3L%n*n
",.lab)#0A..14ELSE.writef("#23.Bad.op.F%n.L%n*n",.o
p,.lab)#0A..writef("*nL%c%n:",.modletter,.lab)#0A..
writef("*n.movl.%%ebp,0(%%edx)")..1//.NP!0.:#3D.P#0A
..writef("*n.movl.%%edx,%%ebp")..4//.P..2:#3D.NP#0A
..writef("*n.popl.%%edx")#0A..writef("*n.movl.%%edx
,4(%%ebp)")..1//.P!1..:#3D.return.address#0A..write
f("*n.movl.%%eax,8(%%ebp)")..1//.P!2..:#3D.entry.ad
dress#0A..writef("*n.movl.%%ebx,12(%%ebp)")..//.P!3
..:#3D.arg1#0A}#0A

######com/sial-arm.b#
/*#0AThis.will.be.an.sial.to.ARM.translator.based.o
n.sial-386#2E#0A#0AImplemented.by.Martin.Richards.(
c).February.2012#0A#0A00019/12/2011#0AUNDER.DEVELOP
MENT#0A*/#0A#0ASECTION."sial-arm"#0A#0AGET."libhdr"
#0A#0AGET."sial#2Eh"#0A#0AGLOBAL.{#0Asialin:.ug#0Aa
smout;.stdin;.stdout#0A#0Ardf;.rdp;.rdg;.rdk;.rdw;.
rdl;.rdc#0Ardcode#0A#0Apval;.gval;.kval;.wval;.lval
;.mval#0A#0Ascan#0Acvf;.cvfp;.cvfg;.cvfk;.cvfw;.cvf
l#0A#0Asectname#0Amodletter#0Acharv#0Alabnumber#0A#0A
//.To.hold.register.name.strings#0A.r0;.r1;.r2;.r3;
.ra;.rb;.rc;.r7;.r8;.r9;.rp;.rg;.r12;.sp;.lr;.ip#0A
}#0A#0ALET.start().#3D.VALOF#0A{.LET.argv.#3D.VEC.2
0#0A..LET.v..2#3D.VEC.20#0A..LET.cv..1#3D.VEC.256/b
ytesperword#0A#0A..r0,.r1,.r2,.r3..:#3D.."r0",."r1"
,."r2",."r3"#0A..ra,.rb,.rc..4:#3D.."ra",."rb",."rc
"#0A..r7,.r8,.r9..4:#3D.."r7",."r8",."r9"#0A..rp,.r
g..8:#3D.."rp",."rg"#0A..r12,.sp,.lr,.ip.:#3D.."r12
",."sp",."lr",."ip".#0A#0A/*#0AgenLoadK(ra,.4)#0Age
nLoadK(ra,.-4)#0AgenLoadK(rb,.255)#0AgenLoadK(rb,.2
56)#0AgenLoadK(rb,.257)#0Anewline()#0Awritef("*nTes
ting.genLdrStr*n")#0AgenLdrStr("ldr",.ra,.rp,.12)#0A
genLdrStr("ldr",.ra,.rp,.-12)#0AgenLdrStr("ldr",.ra
,.rp,.255)#0AgenLdrStr("str",.ra,.rg,.256)#0AgenLdr
Str("str",.ra,.rg,.257)#0AgenLdrStr("str",.ra,.rg,.
-257)#0Anewline()#0ARESULTIS.0#0A*/#0A..sectname.:#3D
.v#0A..sectname%0.:#3D.0#0A..modletter.:#3D.'A'#0A.
.charv.:#3D.cv#0A..labnumber.:#3D.0#0A#0A..asmout.:
#3D.0#0A..stdout.:#3D.output()#0A..IF.rdargs("FROM,
TO/K",.argv,.20)#3D0.DO#0A..{.writes("Bad.args.for.
sial-arm*n")#0A..2RESULTIS.20#0A..}#0A..UNLESS.argv
!0.DO.argv!0.:#3D."prog#2Esial"#0A..UNLESS.argv!1.D
O.argv!1.:#3D."prog#2Es"#0A..sialin.:#3D.findinput(
argv!0)#0A..IF.sialin#3D0.DO#0A..{.writef("Trouble.
with.file.%s*n",.argv!0)#0A..2RESULTIS.20#0A..}#0A.
.asmout.:#3D.findoutput(argv!1)#0A..1#0A..IF.asmout
#3D0.DO#0A..{.writef("Trouble.with.file.%s*n",.argv
!1)#0A..2RESULTIS.20#0A..}#0A..1#0A..writef("Conver
ting.%s.to.%s*n",.argv!0,.argv!1)#0A..selectinput(s
ialin)#0A..selectoutput(asmout)#0A#0A..writef("@.Co
de.generated.by.sial-arm*n*n")#0A#0A..writef(".ra.#2E
req.r4*n")#0A..writef(".rb.#2Ereq.r5*n")#0A..writef
(".rc.#2Ereq.r6*n")#0A..writef(".rp.#2Ereq.r10*n")#0A
..writef(".rg.#2Ereq.r11*n")#0A#0A..writef(".#2Eglo
bal.divrem*n")#0A#0A..writef(".#2Ealign.2*n")#0A#0A
..scan()#0A..endread()#0A..UNLESS.asmout#3Dstdout.D
O.endwrite()#0A..selectoutput(stdout)#0A..writef("C
onversion.complete*n")#0A..RESULTIS.0#0A}#0A#0AAND.
nextlab().#3D.VALOF#0A{.labnumber.:#3D.labnumber+1#0A
..RESULTIS.labnumber#0A}#0A#0A//.Argument.may.be.of
.form.Ln#0AAND.rdcode(let).#3D.VALOF#0A{.LET.a,.ch,
.neg.#3D.0,.?,.FALSE#0A#0A..ch.:#3D.rdch().REPEATWH
ILE.ch#3D'*s'.|.ch#3D'*n'#0A#0A..IF.ch#3Dendstreamc
h.RESULTIS.-1#0A#0A..UNLESS.ch#3Dlet.DO.error("Bad.
item,.looking.for.%c.found.%c*n",.let,.ch)#0A#0A..c
h.:#3D.rdch()#0A#0A..IF.ch#3D'-'.DO.{.neg.:#3D.TRUE
;.ch.:#3D.rdch().}#0A#0A..WHILE.'0'<#3Dch<#3D'9'.DO
.{.a.:#3D.10*a.+.ch.-.'0';.ch.:#3D.rdch()..}#0A#0A.
.RESULTIS.neg.->.-a,.a#0A}#0A#0AAND.rdf().#3D.rdcod
e('F')#0AAND.rdp().#3D.VALOF.{.pval.:#3D.rdcode('P'
);.RESULTIS.pval.}#0AAND.rdg().#3D.VALOF.{.gval.:#3D
.rdcode('G');.RESULTIS.gval.}#0AAND.rdk().#3D.VALOF
.{.kval.:#3D.rdcode('K');.RESULTIS.kval.}#0AAND.rdw
().#3D.VALOF.{.wval.:#3D.rdcode('W');.RESULTIS.wval
.}#0AAND.rdl().#3D.VALOF.{.lval.:#3D.rdcode('L');.R
ESULTIS.lval.}#0AAND.rdm().#3D.VALOF.{.mval.:#3D.rd
code('M');.RESULTIS.mval.}#0AAND.rdc().#3D.rdcode('
C')#0A#0AAND.error(mess,.a,.b,.c).BE#0A{.LET.out.#3D
.output()#0A..UNLESS.out#3Dstdout.DO#0A..{.selectou
tput(stdout)#0A..2writef(mess,.a,.b,.c)#0A..2select
output(out)#0A..}#0A..writef(mess,.a,.b,.c)#0A}#0A#0A
AND.scan().BE#0A{.LET.op.#3D.rdf()#0A#0A..SWITCHON.
op.INTO#0A#0A..{.DEFAULT:..5error("@.Bad.op.%n*n",.
op);.LOOP#0A#0A..2CASE.-1:..5RETURN#0A..4#0A..2CASE
.f_lp:..3cvfp("LP").//.a.:#3D.P!n#0A..17genLdrStr("
ldr",.ra,.rp,.4*pval)#0A..17ENDCASE#0A..2CASE.f_lg:
..3cvfg("LG").//.a.:#3D.G!n#0A..17genLdrStr("ldr",.
ra,.rg,.4*gval)#0A..17ENDCASE#0A..2CASE.f_ll:..3cvf
l("LL").//.a.:#3D.!Ln#0A..17writef("*n.ldr.ra,.#3DL
%c%n",.modletter,.lval)#0A..17writef("*n.ldr.ra,.[r
a]")#0A..17ENDCASE#0A#0A..2CASE.f_llp:..2cvfp("LLP"
).//.a.:#3D.@.P!n#0A..17genAddK(ra,.rp,.4*pval)#0A.
.17writef("*n.mov.ra,.ra,.lsr.#232")#0A..17ENDCASE#0A
..2CASE.f_llg:..2cvfg("LLG").//.a.:#3D.@.G!n#0A..17
genAddK(ra,.rg,.4*gval)#0A..17writef("*n.mov.ra,.ra
,.lsr.#232")#0A..17ENDCASE#0A..2CASE.f_ll1:..2cvfl(
"LL1").//.a.:#3D.@.!Ln#0A..17writef("*n.ldr.ra,.#3D
L%c%n",.modletter,.lval)#0A..17writef("*n.mov.ra,.r
a,.lsr.#232")#0A..17ENDCASE#0A..2CASE.f_lf:..3cvfl(
"LF").//.a.:#3D.byte.address.of.Ln#0A..17writef("*n
.ldr.ra,.#3DL%c%n",.modletter,.lval)#0A..17ENDCASE#0A
..2CASE.f_lw:..3cvfm("LW")#0A..17writef("*n.ldr.ra,
.#3DM%c%n",.modletter,.mval)#0A..17writef("*n.ldr.r
a,.[ra]")#0A..17ENDCASE#0A#0A..2CASE.f_l:..4cvfk("L
").//.a.:#3D.n#0A..17genLoadK(ra,.kval)#0A..17ENDCA
SE#0A..2CASE.f_lm:..3cvfk("LM").//.a.:#3D.-n#0A..17
genLoadK(ra,.-kval)#0A..17ENDCASE#0A#0A..2CASE.f_sp
:..3cvfp("SP").//.P!n.:#3D.a#0A..17genLdrStr("str",
.ra,.rp,.4*pval)#0A..17ENDCASE#0A..2CASE.f_sg:..3cv
fg("SG").//.G!n.:#3D.a#0A..17genLdrStr("str",.ra,.r
g,.4*gval)#0A..17ENDCASE#0A..2CASE.f_sl:..3cvfl("SL
").//.!Ln.:#3D.a#0A..17writef("*n.ldr.r1,.#3DL%c%n"
,.modletter,.lval)#0A..17writef("*n.str.ra,.[r1]")#0A
..17ENDCASE#0A#0A..2CASE.f_ap:..3cvfp("AP").//.a.:#3D
.a.+.P!n#0A..17genLdrStr("ldr",.r1,.rp,.4*pval)#0A.
.17writef("*n.add.ra,.ra,.r1")#0A..17ENDCASE#0A..2C
ASE.f_ag:..3cvfg("AG").//.a.:#3D.a.+.G!n#0A..17genL
drStr("ldr",.r1,.rg,.4*gval)#0A..17writef("*n.add.r
a,.ra,.r1")#0A..17ENDCASE#0A..2CASE.f_a:..4cvfk("A"
).//.a.:#3D.a.+.n#0A..17genAddK(ra,.ra,.kval)#0A..1
7ENDCASE#0A..2CASE.f_s:..4cvfk("S")..//.a.:#3D.a.-.
n#0A..17genAddK(ra,.ra,.-kval)#0A..17ENDCASE#0A#0A.
.2CASE.f_lkp:..2cvfkp("LKP").//.a.:#3D.P!n!k#0A..17
genLdrStr("ldr",.ra,.rp,.4*pval)#0A..17genLoadK(r1,
.4*kval)#0A..17writef("*n.ldr.ra,.[r1,.ra,.lsl.#232
]")#0A..17ENDCASE#0A..2CASE.f_lkg:..2cvfkg("LKG")./
/.a.:#3D.G!n!k#0A..17genLdrStr("ldr",.ra,.rg,.4*gva
l)#0A..17genLoadK(r1,.4*kval)#0A..17writef("*n.ldr.
ra,.[r1,.ra,.lsl.#232]")#0A..17ENDCASE#0A..2CASE.f_
rv:..3cvf("RV")..//.a.:#3D.!.a#0A..17writef("*n.add
.r1,.ra,.ra")#0A..17writef("*n.ldr.ra,.[r1,.r1]")#0A
..17ENDCASE#0A..2CASE.f_rvp:..2cvfp("RVP").//.a.:#3D
.P!n!a#0A..17genLdrStr("ldr",.r1,.rp,.4*pval)#0A..1
7writef("*n.mov.r1,.r1,.lsl.#232")#0A..17writef("*n
.ldr.ra,.[r1,.ra,.lsl.#232]")#0A..17ENDCASE#0A..2CA
SE.f_rvk:..2cvfk("RVK").//.a.:#3D.a!k#0A..17genLoad
K(r1,.4*kval)#0A..17writef("*n.ldr.ra,.[r1,.ra,.lsl
.#232]")#0A..17ENDCASE#0A..2CASE.f_st:..3cvf("ST").
//.!a.:#3D.b#0A..17writef("*n.mov.r1,.#230")#0A..17
writef("*n.str.rb,.[r1,.ra,.lsl.#232]")#0A..17ENDCA
SE#0A..2CASE.f_stp:..2cvfp("STP").//.P!n!a.:#3D.b#0A
..17genLdrStr("ldr",.r1,.rp,.4*pval)#0A..17writef("
*n.mov.r2,.ra,.lsl.#232")#0A..17writef("*n.str.rb,.
[r2,.r1,.lsl.#232]")#0A..17ENDCASE#0A..2CASE.f_stk:
..2cvfk("STK").//.a!k.:#3D.b#0A..17genLoadK(r1,.4*k
val)#0A..17writef("*n.str.rb,.[r1,.ra,.lsl.#232]")#0A
..17ENDCASE#0A..2CASE.f_stkp:..1cvfkp("STKP")..//.P
!n!k.:#3D.a#0A..17genLdrStr("ldr",.r1,.rp,.4*pval)#0A
..17genLoadK(r2,.4*kval)#0A..17writef("*n.str.ra,.[
r2,.r1,.lsl.#232]")#0A..17ENDCASE#0A..2CASE.f_skg:.
.2cvfkg("SKG").//.G!n!k.:#3D.a#0A..17genLdrStr("ldr
",.r1,.rg,.4*gval)#0A..17genLoadK(r2,.4*kval)#0A..1
7writef("*n.str.ra,.[r2,.r1,.lsl.#232]")#0A..17ENDC
ASE#0A..2CASE.f_xst:..2cvf("XST").//.!b.:#3D.a#0A..
17writef("*n.mov.r1,.#230")#0A..17writef("*n.str.ra
,.[r1,.rb,.lsl.#232]")#0A..17ENDCASE#0A#0A..2CASE.f
_k:..4cvfp("K").//.Call..a(b,#2E#2E1).incrementing.
P.by.n#0A..15{.LET.lab.#3Dnextlab()#0A..17genAddK(r
2,.rp,.4*pval)..7//.NP.#3D.P.+.4*pval#0A..17writef(
"*n.mov.r1,.ra")..7//.r1.#3D.a..--.the.entry.addres
s#0A..17writef("*n.mov.ra,.rb")..7//.a.:#3D.b#0A..1
7//writef("*n.mov.lr,.pc")#0A..17writef("*n.ldr.lr,
.#3DKL%c%n",.modletter,.lab)#0A..17writef("*n.mov.p
c,.r1")#0A..17writef("*n.#2Eltorg")#0A..17writef("*
nKL%c%n:",.modletter,lab)#0A..15}#0A..17ENDCASE#0A.
.2CASE.f_kpg:..2cvfpg("KPG").//.Call.Gg(a,#2E#2E1).
incrementing.P.by.n#0A..15{.LET.lab.#3Dnextlab()#0A
..17genLdrStr("ldr",.r1,.rg,.4*gval)#0A..17genAddK(
r2,.rp,.4*pval)#0A..17//writef("*n.mov.lr,.pc")#0A.
.17writef("*n.ldr.lr,.#3DKL%c%n",.modletter,.lab)#0A
..17writef("*n.mov.pc,.r1")#0A..17writef("*n.#2Elto
rg")#0A..17writef("*nKL%c%n:",.modletter,lab)#0A..1
5}#0A..17ENDCASE#0A#0A..2CASE.f_neg:..2cvf("NEG")./
/.a.:#3D.-.a#0A..17writef("*n.rsb.ra,.ra,.#230").#0A
..17ENDCASE#0A..2CASE.f_not:..2cvf("NOT").//.a.:#3D
.~.a#0A..17writef("*n.mvn.ra,.ra").#0A..17ENDCASE#0A
..2CASE.f_abs:..2cvf("ABS").//.a.:#3D.ABS.a#0A..17w
ritef("*n.cmp.ra,.#230")#0A..17writef("*n.rsblt.ra,
.ra,.#230")#0A..17ENDCASE#0A#0A..2CASE.f_xdiv:..1cv
f("XDIV").//.a.:#3D.a./.b;.c.:#3D.?#0A..17writef("*
n.mov.r0,.rb")#0A..17writef("*n.mov.r1,.ra")#0A..17
writef("*n.ldr.r2,.[pc]")#0A..17writef("*n.mov.pc,.
pc")#0A..17writef("*n.#2Elong.divrem")#0A..17writef
("*n.mov.lr,.pc")#0A..17writef("*n.mov.pc,.r2")#0A.
.17writef("*n.mov.ra,.r0")#0A..17ENDCASE#0A..2CASE.
f_xrem:..1cvf("XREM").//.a.:#3D.a.REM.b;.c.:#3D.?#0A
..17writef("*n.mov.r0,.rb")#0A..17writef("*n.mov.r1
,.ra")#0A..17writef("*n.ldr.r2,.[pc]")#0A..17writef
("*n.mov.pc,.pc")#0A..17writef("*n.#2Elong.divrem")
#0A..17writef("*n.mov.lr,.pc")#0A..17writef("*n.mov
.pc,.r2")#0A..17writef("*n.mov.ra,.r1")#0A..17ENDCA
SE#0A..2CASE.f_xsub:..1cvf("XSUB").//.a.:#3D.a.-.b#0A
..17writef("*n.sub.ra,.ra,.rb")#0A..17ENDCASE#0A#0A
..2CASE.f_mul:..2cvf("MUL").//.a.:#3D.b.*.a;.c.:#3D
.?#0A..17writef("*n.mul.ra,.rb,.ra")#0A..17ENDCASE#0A
..2CASE.f_div:..2cvf("DIV")..//.a.:#3D.b./.a;.c.:#3D
.?#0A..17writef("*n.mov.r0,.ra")#0A..17writef("*n.m
ov.r1,.rb")#0A..17writef("*n.ldr.r2,.[pc]")#0A..17w
ritef("*n.mov.pc,.pc")#0A..17writef("*n.#2Elong.div
rem")#0A..17writef("*n.mov.lr,.pc")#0A..17writef("*
n.mov.pc,.r2")#0A..17writef("*n.mov.ra,.r0")#0A..17
ENDCASE#0A..2CASE.f_rem:..2cvf("REM").//.a.:#3D.b.R
EM.a;.c.:#3D.?#0A..17writef("*n.mov.r0,.ra")#0A..17
writef("*n.mov.r1,.rb")#0A..17writef("*n.ldr.r2,.[p
c]")#0A..17writef("*n.mov.pc,.pc")#0A..17writef("*n
.#2Elong.divrem")#0A..17writef("*n.mov.lr,.pc")#0A.
.17writef("*n.mov.pc,.r2")#0A..17writef("*n.mov.ra,
.r1")#0A..17ENDCASE#0A..2CASE.f_add:..2cvf("ADD")./
/.a.:#3D.b.+.a#0A..17writef("*n.add.ra,.rb,.ra")#0A
..17ENDCASE#0A..2CASE.f_sub:..2cvf("SUB").//.a.:#3D
.b.-.a#0A..17writef("*n.sub.ra,.rb,.ra")#0A..17ENDC
ASE#0A#0A..2CASE.f_eq:..3cvf("EQ").//.a.:#3D.b.#3D.
a#0A..17writef("*n.cmp.rb,.ra")#0A..17writef("*n.mv
neq.ra,.#230")#0A..17writef("*n.movne.ra,.#230")#0A
..17ENDCASE#0A..2CASE.f_ne:..3cvf("NE").//.a.:#3D.b
.~#3D.a#0A..17writef("*n.subs.ra,.ra,.rb")#0A..17wr
itef("*n.mvnne.ra,.#230")#0A..17ENDCASE#0A..2CASE.f
_ls:..3cvf("LS").//.a.:#3D.b.<.a#0A..17writef("*n.c
mp.rb,.ra")#0A..17writef("*n.mvnlt.ra,.#230")#0A..1
7writef("*n.movge.ra,.#230")#0A..17ENDCASE#0A..2CAS
E.f_gr:..3cvf("GR").//.a.:#3D.b.>.a#0A..17writef("*
n.cmp.rb,.ra")#0A..17writef("*n.mvngt.ra,.#230")#0A
..17writef("*n.movle.ra,.#230")#0A..17ENDCASE#0A..2
CASE.f_le:..3cvf("LE").//.a.:#3D.b.<#3D.a#0A..17wri
tef("*n.cmp.rb,.ra")#0A..17writef("*n.mvnle.ra,.#23
0")#0A..17writef("*n.movgt.ra,.#230")#0A..17ENDCASE
#0A..2CASE.f_ge:..3cvf("GE").//.a.:#3D.b.>#3D.a#0A.
.17writef("*n.cmp.rb,.ra")#0A..17writef("*n.mvnge.r
a,.#230")#0A..17writef("*n.movlt.ra,.#230")#0A..17E
NDCASE#0A#0A..2CASE.f_eq0:..2cvf("EQ").//.a.:#3D.a.
#3D.0#0A..17writef("*n.cmp.ra,.#230")#0A..17writef(
"*n.mvneq.ra,.#230")#0A..17writef("*n.movne.ra,.#23
0")#0A..17ENDCASE#0A..2CASE.f_ne0:..2cvf("NE").//.a
.:#3D.a.~#3D.0#0A..17writef("*n.cmp.ra,.#230")#0A..
17writef("*n.mvnne.ra,.#230")#0A..17ENDCASE#0A..2CA
SE.f_ls0:..2cvf("LS").//.a.:#3D.a.<.0#0A..17writef(
"*n.cmp.ra,.#230")#0A..17writef("*n.mvnlt.ra,.#230"
)#0A..17writef("*n.movge.ra,.#230")#0A..17ENDCASE#0A
..2CASE.f_gr0:..2cvf("GR").//.a.:#3D.a.>.0#0A..17wr
itef("*n.cmp.ra,.#230")#0A..17writef("*n.mvngt.ra,.
#230")#0A..17writef("*n.movle.ra,.#230")#0A..17ENDC
ASE#0A..2CASE.f_le0:..2cvf("LE").//.a.:#3D.a.<#3D.0
#0A..17writef("*n.cmp.ra,.#230")#0A..17writef("*n.m
vnle.ra,.#230")#0A..17writef("*n.movgt.ra,.#230")#0A
..17ENDCASE#0A..2CASE.f_ge0:..2cvf("GE").//.a.:#3D.
a.>#3D.0#0A..17writef("*n.cmp.ra,.#230")#0A..17writ
ef("*n.mvnge.ra,.#230")#0A..17writef("*n.movlt.ra,.
#230")#0A..17ENDCASE#0A#0A..2CASE.f_lsh:..2cvf("LSH
").//.a.:#3D.b.<<.a;.b.:#3D.?#0A..17writef("*n.cmp.
ra,.#2331")#0A..17writef("*n.movhi.rb,.#230")#0A..1
7writef("*n.mov.ra,.rb,.lsl.ra")#0A..17ENDCASE#0A..
2CASE.f_rsh:..2cvf("RSH").//.a.:#3D.b.>>.a;.b.:#3D.
?#0A..17writef("*n.cmp.ra,.#2331")#0A..17writef("*n
.movhi.rb,.#230")#0A..17writef("*n.mov.ra,.rb,.lsr.
ra")#0A..17ENDCASE#0A..2CASE.f_and:..2cvf("AND").//
.a.:#3D.b.&.a.#0A..17writef("*n.and.ra,.rb,.ra").#0A
..17ENDCASE#0A..2CASE.f_or:..3cvf("OR").//.a.:#3D.b
.|.a.#0A..17writef("*n.orr.ra,.rb,.ra").#0A..17ENDC
ASE#0A..2CASE.f_xor:..2cvf("XOR").//.a.:#3D.b.NEQV.
a#0A..17writef("*n.eor.ra,.rb,.ra").#0A..17ENDCASE#0A
..2CASE.f_eqv:..2cvf("EQV").//.a.:#3D.b.EQV.a.#0A..
17writef("*n.eor.ra,.rb,.ra").#0A..17writef("*n.mvn
.ra,.ra").#0A..17ENDCASE#0A#0A..2CASE.f_gbyt:..1cvf
("GBYT").//.a.:#3D.b.%.a#0A..17writef("*n.ldrb.ra,.
[ra,.rb,.lsl.#232]").#0A..17ENDCASE#0A..2CASE.f_xgb
yt:..cvf("XGBYT").//.a.:#3D.a.%.b.#0A..17writef("*n
.ldrb.ra,.[rb,.ra,.lsl.#232]").#0A..17ENDCASE#0A..2
CASE.f_pbyt:..1cvf("PBYT").//.b.%.a.:#3D.c#0A..17wr
itef("*n.strb.rc,.[ra,.rb,.lsl.#232]").#0A..17ENDCA
SE#0A..2CASE.f_xpbyt:..cvf("XPBYT").//.a.%.b.:#3D.c
.#0A..17writef("*n.strb.rc,.[rb,.ra,.lsl.#232]").#0A
..17ENDCASE#0A#0A//.swb..5Kn.Ld.K1.L1.#2E#2E1.Kn.Ln
..1Binary.chop.switch,.Ld.default#0A..2CASE.f_swb:.
.2cvswb()#0A..17ENDCASE#0A#0A//.swl..5Kn.Ld.L1.#2E#2E
1.Ln..7Label.vector.switch,.Ld.default#0A..2CASE.f_
swl:..2cvswl()#0A..17ENDCASE#0A#0A..2CASE.f_xch:..2
cvf("XCH").//.swap.a.and.b#0A..17writef("*n.mov.r1,
.ra")#0A..17writef("*n.mov.ra,.rb")#0A..17writef("*
n.mov.rb,.r1")#0A..17ENDCASE#0A..2CASE.f_atb:..2cvf
("ATB").//.b.:#3D.a#0A..17writef("*n.mov.rb,.ra")#0A
..17ENDCASE#0A..2CASE.f_atc:..2cvf("ATC").//.c.:#3D
.a#0A..17writef("*n.mov.rc,.ra")#0A..17ENDCASE#0A..
2CASE.f_bta:..2cvf("BTA").//.a.:#3D.b#0A..17writef(
"*n.mov.ra,.rb")#0A..17ENDCASE#0A..2CASE.f_btc:..2c
vf("BTC").//.c.:#3D.b#0A..17writef("*n.mov.rc,.rb")
#0A..17ENDCASE#0A..2CASE.f_atblp:..cvfp("ATBLP").//
.b.:#3D.a;.a.:#3D.P!n#0A..17writef("*n.mov.rb,.ra")
#0A..17genLdrStr("ldr",.ra,.rp,.4*pval)#0A..17ENDCA
SE#0A..2CASE.f_atblg:..cvfg("ATBLG").//.b.:#3D.a;.a
.:#3D.G!n#0A..17writef("*n.mov.rb,.ra")#0A..17genLd
rStr("ldr",.ra,.rg,.4*gval)#0A..17ENDCASE#0A..2CASE
.f_atbl:..1cvfk("ATBL").//.b.:#3D.a;.a.:#3D.k#0A..1
7writef("*n.mov.rb,.ra")#0A..17genLoadK(ra,.kval)#0A
..17ENDCASE#0A#0A..2CASE.f_j:..4cvfl("J").//.jump.t
o.Ln#0A..17writef("*n.b.L%c%n",.modletter,.lval)#0A
..17writef("*n.#2Eltorg*n")#0A..17ENDCASE#0A..2CASE
.f_rtn:..2cvf("RTN").//.procedure.return#0A..17writ
ef("*n.ldmia.rp,.{rp,.pc}")#0A..17writef("*n.#2Elto
rg*n")#0A..17ENDCASE#0A..2CASE.f_goto:..1cvf("GOTO"
).//.jump.to.a#0A..17writef("*n.mov.pc,.ra")#0A..17
writef("*n.#2Eltorg*n")#0A..17ENDCASE#0A#0A..2CASE.
f_res:..2cvf("RES")..1//.<res>.:#3D.A#0A..30//.<res
>.is.already.in.A#0A..30//.nothing.to.do#0A..17ENDC
ASE#0A#0A..2CASE.f_ldres:..cvf("LSRES").//.A.:#3D.<
res>#0A..30//.A.and.B.already.set.properly#0A..17EN
DCASE#0A#0A..2CASE.f_ikp:..2cvfkp("IKP").//.a.:#3D.
P!n.+.k;.P!n.:#3D.a#0A..17genLdrStr("ldr",.ra,.rp,.
4*pval)#0A..17genAddK(ra,.ra,.kval)#0A..17genLdrStr
("str",.ra,.rp,.4*pval)#0A..17ENDCASE#0A..2CASE.f_i
kg:..2cvfkg("IKG").//.a.:#3D.G!n.+.k;.G!n.:#3D.a#0A
..17genLdrStr("ldr",.ra,.rg,.4*gval)#0A..17genAddK(
ra,.ra,.kval)#0A..17genLdrStr("str",.ra,.rg,.4*gval
)#0A..17ENDCASE#0A..2CASE.f_ikl:..2cvfkl("IKL").//.
a.:#3D.!Ln.+.k;.!Ln.:#3D.a#0A..17writef("*n.ldr.r1,
.#3DL%c%n",.modletter,.lval)#0A..17writef("*n.ldr.r
a,.[r1]")#0A..17genAddK(ra,.ra,.kval)#0A..17writef(
"*n.str.ra,.[r1]")#0A..17ENDCASE#0A..2CASE.f_ip:..3
cvfp("IP").//.a.:#3D.P!n.+.a;.P!n.:#3D.a#0A..17genL
drStr("ldr",.r1,.rp,.4*pval)#0A..17writef("*n.add.r
a,.r1,.ra")#0A..17genLdrStr("str",.ra,.rp,.4*pval)#0A
..17ENDCASE#0A..2CASE.f_ig:..3cvfg("IG").//.a.:#3D.
G!n.+.a;.G!n.:#3D.a#0A..17genLdrStr("ldr",.r1,.rg,.
4*gval)#0A..17writef("*n.add.ra,.r1,.ra")#0A..17gen
LdrStr("str",.ra,.rg,.4*gval)#0A..17ENDCASE#0A..2CA
SE.f_il:..3cvfl("IL").//.a.:#3D.!Ln.+.a;.!Ln.:#3D.a
#0A..17writef("*n.ldr.r0,.#3DL%c%n",.modletter,.lva
l)#0A..17writef("*n.ldr.r1,.[r0]")#0A..17writef("*n
.add.ra,.ra,.r1")#0A..17writef("*n.str.ra,.[r0]")#0A
..17ENDCASE#0A#0A..2CASE.f_jeq:..2cvfl("JEQ").//.Ju
mp.to.Ln.if.b.#3D.a#0A..17writef("*n.cmp.rb,.ra")#0A
..17writef("*n.beq.L%c%n",.modletter,.lval)#0A..17E
NDCASE#0A..2CASE.f_jne:..2cvfl("JNE").//.Jump.to.Ln
.if.b.~#3D.a#0A..17writef("*n.cmp.rb,.ra")#0A..17wr
itef("*n.bne.L%c%n",.modletter,.lval)#0A..17ENDCASE
#0A..2CASE.f_jls:..2cvfl("JLS").//.Jump.to.Ln.if.b.
<.a#0A..17writef("*n.cmp.rb,.ra")#0A..17writef("*n.
blt.L%c%n",.modletter,.lval)#0A..17ENDCASE#0A..2CAS
E.f_jgr:..2cvfl("JGR").//.Jump.to.Ln.if.b.>.a#0A..1
7writef("*n.cmp.rb,.ra")#0A..17writef("*n.bgt.L%c%n
",.modletter,.lval)#0A..17ENDCASE#0A..2CASE.f_jle:.
.2cvfl("JLE").//.Jump.to.Ln.if.b.<#3D.a#0A..17write
f("*n.cmp.rb,.ra")#0A..17writef("*n.ble.L%c%n",.mod
letter,.lval)#0A..17ENDCASE#0A..2CASE.f_jge:..2cvfl
("JGE").//.Jump.to.Ln.if.b.>#3D.a#0A..17writef("*n.
cmp.rb,.ra")#0A..17writef("*n.bge.L%c%n",.modletter
,.lval)#0A..17ENDCASE#0A#0A..2CASE.f_jeq0:..1cvfl("
JEQ0").//.Jump.to.Ln.if.a.#3D.0#0A..17writef("*n.cm
p.ra,.#230")#0A..17writef("*n.beq.L%c%n",.modletter
,.lval)#0A..17ENDCASE#0A..2CASE.f_jne0:..1cvfl("JNE
0").//.Jump.to.Ln.if.a.~#3D.0#0A..17writef("*n.cmp.
ra,.#230")#0A..17writef("*n.bne.L%c%n",.modletter,.
lval)#0A..17ENDCASE#0A..2CASE.f_jls0:..1cvfl("JLS0"
).//.Jump.to.Ln.if.a.<.0#0A..17writef("*n.cmp.ra,.#23
0")#0A..17writef("*n.blt.L%c%n",.modletter,.lval)#0A
..17ENDCASE#0A..2CASE.f_jgr0:..1cvfl("JGR0").//.Jum
p.to.Ln.if.a.>.0#0A..17writef("*n.cmp.ra,.#230")#0A
..17writef("*n.bgt.L%c%n",.modletter,.lval)#0A..17E
NDCASE#0A..2CASE.f_jle0:..1cvfl("JLE0").//.Jump.to.
Ln.if.a.<#3D.0#0A..17writef("*n.cmp.ra,.#230")#0A..
17writef("*n.ble.L%c%n",.modletter,.lval)#0A..17END
CASE#0A..2CASE.f_jge0:..1cvfl("JGE0").//.Jump.to.Ln
.if.a.>#3D.0#0A..17writef("*n.cmp.ra,.#230")#0A..17
writef("*n.bge.L%c%n",.modletter,.lval)#0A..17ENDCA
SE#0A..2CASE.f_jge0m:..cvfm("JGE0M").//.Jump.to.Mn.
if.a.>#3D.0#0A..17writef("*n.cmp.ra,.#230")#0A..17w
ritef("*n.bge.M%c%n",.modletter,.mval)#0A..17ENDCAS
E#0A#0A..2//.The.following.five.opcodes.are.never.g
enerated.by#0A..2//.the.BCPL.compiler#0A..2CASE.f_b
rk:..2cvf("BRK").//.Breakpoint.instruction#0A..17wr
itef("*n@.unimplemented")#0A..17ENDCASE#0A..2CASE.f
_nop:..2cvf("NOP").//.No.operation#0A..17ENDCASE#0A
..2CASE.f_chgco:..cvf("CHGCO").//.Change.coroutine#0A
..17writef("*n@.unimplemented")#0A..17ENDCASE#0A..2
CASE.f_mdiv:..1cvf("MDIV").//.a.:#3D.Muldiv(P!3,.P!
4,.P!5).#0A..17writef("*n@.unimplemented")#0A..17EN
DCASE#0A..2CASE.f_sys:..2cvf("SYS").//.System.funct
ion#0A..17writef("*n@.unimplemented")#0A..17ENDCASE
#0A#0A..2CASE.f_section:..cvfs("SECTION").//.Name.o
f.section#0A..19FOR.i.#3D.0.TO.charv%0.DO.sectname%
i.:#3D.charv%i#0A..19ENDCASE#0A..2CASE.f_modstart:.
cvf("MODSTART").//.Start.of.module..#0A..19sectname
%0.:#3D.0#0A..19ENDCASE#0A..2CASE.f_modend:..1cvf("
MODEND").//.End.of.module.#0A..19modletter.:#3D.mod
letter+1#0A..19ENDCASE#0A..2CASE.f_global:..1cvglob
al().//.Global.initialisation.data#0A..19ENDCASE#0A
..2CASE.f_string:..1cvstring().//.String.constant#0A
..19ENDCASE#0A..2CASE.f_const:..2cvconst().//.Large
.integer.constant#0A..19ENDCASE#0A#0A..2CASE.f_stat
ic:..1cvstatic().//.Static.variable.or.table#0A..19
ENDCASE#0A..2CASE.f_mlab:..3cvfm("MLAB").//.Destina
tion.of.jge0m#0A..19writef("*nM%c%n:",.modletter,.m
val)#0A..19ENDCASE#0A..2CASE.f_lab:..4cvfl("LAB")./
/.Program.label#0A..19writef("*nL%c%n:",.modletter,
.lval)#0A..19ENDCASE#0A..2CASE.f_lstr:..3cvfm("LSTR
").//.a.:#3D.Mn..1(pointer.to.string)#0A..19writef(
"*n.ldr.ra,.#3DM%c%n",.modletter,.mval)#0A..19write
f("*n.mov.ra,.ra,.lsr.#232")#0A..19ENDCASE#0A..2CAS
E.f_entry:..2cventry().//.Start.of.a.function#0A..1
9ENDCASE#0A#0A..2CASE.f_float:..2cvf("FLOAT")#0A..1
9writef("*n#23.unimplemented")#0A..19ENDCASE#0A..2C
ASE.f_fix:..4cvf("FIX")#0A..19writef("*n#23.unimple
mented")#0A..19ENDCASE#0A..2CASE.f_fabs:..3cvf("FAB
S")#0A..19writef("*n#23.unimplemented")#0A..19ENDCA
SE#0A#0A..2CASE.f_fmul:..3cvf("FMUL")#0A..19writef(
"*n#23.unimplemented")#0A..19ENDCASE#0A..2CASE.f_fd
iv:..3cvf("FDIV")#0A..19writef("*n#23.unimplemented
")#0A..19ENDCASE#0A..2CASE.f_fadd:..3cvf("FADD")#0A
..19writef("*n#23.unimplemented")#0A..19ENDCASE#0A.
.2CASE.f_fsub:..3cvf("FSUB")#0A..19writef("*n#23.un
implemented")#0A..19ENDCASE#0A..2CASE.f_fneg:..3cvf
("FNEG")#0A..19writef("*n#23.unimplemented")#0A..19
ENDCASE#0A#0A..2CASE.f_feq:..4cvf("FEQ")#0A..19writ
ef("*n#23.unimplemented")#0A..19ENDCASE#0A..2CASE.f
_fne:..4cvf("FNE")#0A..19writef("*n#23.unimplemente
d")#0A..19ENDCASE#0A..2CASE.f_fls:..4cvf("FLS")#0A.
.19writef("*n#23.unimplemented")#0A..19ENDCASE#0A..
2CASE.f_fgr:..4cvf("FGR")#0A..19writef("*n#23.unimp
lemented")#0A..19ENDCASE#0A..2CASE.f_fle:..4cvf("FL
E")#0A..19writef("*n#23.unimplemented")#0A..19ENDCA
SE#0A..2CASE.f_fge:..4cvf("FGE")#0A..19writef("*n#23
.unimplemented")#0A..19ENDCASE#0A..}#0A#0A..newline
()#0A}.REPEAT#0A#0AAND.opsize(k).#3D.VALOF#0A{.//.R
eturns.the.number.of.instructions.needed.to.compute
.k.out.of.8-bit.pieces#0A..LET.s.#3D.0#0A..UNLESS.k
.RESULTIS.1#0A..WHILE.k.DO#0A..{.//.Find.next.8-bit
.piece#0A..2WHILE.(k&3)#3D0.DO.k.:#3D.k>>0002#0A..2
k,.s.:#3D.k>>0008,.s+1#0A..}#0A..RESULTIS.s#0A}#0A#0A
AND.genAddK(r,.s,.k).BE#0A{.//.Generate.code.for:.R
r.:#3D.Rs.+.k#0A..LET.opstr,.sh.#3D."add",.0#0A..LE
T.neg,.addch.#3D.FALSE,.'+'#0A#0A..IF.k#3D0.DO#0A..
{.IF.r#3Ds.RETURN#0A..2writef("*n.mov.%s,%s",.r,.s)
#0A..2RETURN#0A..}#0A.#0A..IF.opsize(-k)<opsize(k).
DO.opstr,.k.:#3D."sub",.-k#0A#0A..WHILE.(k&3)#3D0.D
O.k,.sh.:#3D.k>>0002,.sh+2#0A#0A..writef("*n.%s.%s,
.%s,.#23%n.@.%x8",.//.add.or.sub#0A..8opstr,.r,.s,.
(k&#23xFF)<<sh,.(k&#23xFF)<<sh)#0A#0A..k,.sh.:#3D.k
>>0008,.sh+8#0A#0A..WHILE.k.DO#0A..{.WHILE.(k&3)#3D
0.DO.k,.sh.:#3D.k>>0002,.sh+2#0A#0A..2writef("*n.%s
.%s,.%s,.#23%n.@.%x8",..//.add.or.sub#0A..10opstr,.
r,.r,.(k&#23xFF)<<sh,.(k&#23xFF)<<sh)#0A..2k,.sh.:#3D
.k>>0008,.sh+8#0A..}#0A}#0A#0AAND.genOpRRK(opstr,.r
d,.rn,.k).BE#0A{.//.Generate.code.for:.Rr.:#3D.Rs.o
p.k#0A..//.opstr.is.a.data.processing.operation.suc
h.as.add.or.sub#0A..//.Generate.f.rd,rn,#23k#0A..//
.or..5f.rn,r0,#23k'.preceeded.by.instructions.to.se
t.r0.to.rn+k-k'#0A..LET.sh.#3D.0#0A..LET.r.#3D.rn#0A
..LET.k8.#3D.?#0A#0A..UNLESS.opsize(k)#3D1.DO#0A..{
.genAddK(r0,.rn,.k)#0A..2r.:#3D.r0#0A..}#0A#0A..WHI
LE.(k&3)#3D0.DO.k,.sh.:#3D.k>>0002,.sh+2#0A#0A..k8.
:#3D.(k.&.#23xFF)<<sh#0A..k,.sh.:#3D.k>>0008,.sh+8#0A
#0A..WHILE.k.DO#0A..{.WHILE.(k&3)#3D0.DO.k,.sh.:#3D
.k>>0002,.sh+2#0A#0A..2writef("*n.%s.%s,.%s,.#23%n.
@.%x8",..//.add.or.sub#0A..10opstr,.r,.r,.(k&#23xFF
)<<sh,.(k&#23xFF)<<sh)#0A..2k,.sh.:#3D.k>>0008,.sh+
8#0A..}#0A#0A..writef("*n.%s.%s,.%s,#23%n.@.%x8",#0A
..8opstr,.rd,.r,.k8,.k8)#0A}#0A#0AAND.genLoadK(r,.k
).BE#0A{.LET.op1str,.op2str,.sh.#3D."mov",."orr",.0
#0A#0A..IF.opsize(~k)<opsize(k).DO.op1str,.op2str,.
k.:#3D."mvn",."bic",.~k#0A#0A//writef("*n*ngenLoadK
:.r#3D%n.k#3D%n*n",.r,.k)#0A#0A..IF.k.WHILE.(k&3)#3D
0.DO.k,.sh.:#3D.k>>0002,.sh+2#0A#0A..writef("*n.%s.
%s,.#23%n.@.%x8",.//.mov.or.mvn#0A..8op1str,.r,.(k&
#23xFF)<<sh,.(k&#23xFF)<<sh)#0A#0A..k,.sh.:#3D.k>>0
008,.sh+8#0A#0A..WHILE.k.DO#0A..{.WHILE.(k&3)#3D0.D
O.k,.sh.:#3D.k>>0002,.sh+2#0A#0A..2writef("*n.%s.%s
,.%s,.#23%n.@.%x8",..//.orr.or.bic#0A..10op2str,.r,
.r,.(k&#23xFF)<<sh,.(k&#23xFF)<<sh)#0A..2k,.sh.:#3D
.k>>0008,.sh+8#0A..}#0A}#0A#0AAND.genLdrStr(opstr,.
rd,.rn,.k).BE#0A{.//.opstr.is."ldr".or."str"#0A..//
.Good.for.loading.and.storing.locals.and.globals#0A
..//.If.k.is.to.large.it.uses.register.r0#0A..LET.r
,.sh.#3D.rn,.sh#0A..LET.addstr.#3D."add"#0A..LET.pl
usch.#3D.'+'#0A#0A..LET.k12.#3D.?#0A#0A..IF.k<0.DO#0A
..{.k.:#3D.-k#0A..2addstr,.plusch.:#3D."sub",.'-'#0A
..}#0A#0A..k12.:#3D.k.&.#23xFF1#0A..k,.sh.:#3D.k>>0
0012,.sh+12#0A#0A..WHILE.k.DO#0A..{.WHILE.(k&3)#3D0
.DO.k,.sh.:#3D.k>>0002,.sh+2#0A..2writef("*n.%s.r0,
.%s,.#23%n.@.#23%x8",.addstr,.r,.(k.&.#23xFF)<<sh,.
(k.&.#23xFF)<<sh)#0A..2r.:#3D.0#0A..2k,.sh.:#3D.k>>
0008,.sh+8#0A..}#0A#0A..writef("*n.%s.%s,.[%s,.#23%
c%n].@.%x8",.opstr,.rd,.r,.plusch,.k12,.k12)#0A}#0A
#0AAND.genCmpRK(r,.k).BE#0A{.//.This.generates.code
.to.equivalent.to.cmp.r,.#23k#0A..//.If.k.is.to.lar
ge.it.uses.register.r0#0A..LET.opstr,.sh.#3D."cmp",
.0#0A..LET.neg,.addch.#3D.FALSE,.'+'#0A#0A..IF.opsi
ze(k)#3D1.DO#0A..{.writef("*n.cmp.%s,.#23%n.@.%x8",
.r,.k,.k)#0A..2RETURN#0A..}#0A#0A..IF.opsize(-k)#3D
1.DO#0A..{.writef("*n.cmn.%s,.#23%n.@.%x8",.r,.-k,.
-k)#0A..2RETURN#0A..}#0A#0A..genLoadK(r1,.k)#0A#0A.
.writef("*n.cmp.%s,.r1",.r)#0A}#0A#0AAND.cvf(s)..1B
E.writef("@.%s",.s)#0AAND.cvfp(s)..BE.writef("@.%t7
.P%n",.s,.rdp())#0AAND.cvfkp(s).BE.writef("@.%t7.K%
n.P%n",.s,.rdk(),.rdp())#0AAND.cvfg(s)..BE.writef("
@.%t7.G%n",.s,.rdg())#0AAND.cvfkg(s).BE.writef("@.%
t7.K%n.G%n",.s,.rdk(),.rdg())#0AAND.cvfkl(s).BE.wri
tef("@.%t7.K%n.L%n",.s,.rdk(),.rdl())#0AAND.cvfpg(s
).BE.writef("@.%t7.P%n.G%n",.s,.rdp(),.rdg())#0AAND
.cvfk(s)..BE.writef("@.%t7.K%n",.s,.rdk())#0AAND.cv
fw(s)..BE.writef("@.%t7.W%n",.s,.rdw())#0AAND.cvfl(
s)..BE.writef("@.%t7.L%n",.s,.rdl())#0AAND.cvfm(s).
.BE.writef("@.%t7.M%n",.s,.rdm())#0A#0AAND.cvswl().
BE#0A{.LET.n..2#3D.rdk()#0A..LET.dlab.#3D.rdl()#0A.
.writef("@.SWL.K%n.L%n",.n,.dlab)#0A..genCmpRK(ra,.
n)#0A..writef("*n.ldrlo.pc,.[pc,.ra,.lsl.#232]")#0A
..writef("*n.b.L%c%n",.modletter,.dlab)#0A#0A..FOR.
i.#3D.1.TO.n.DO#0A..{.LET.l.#3D.rdl()#0A..2writef("
*n.#2Elong.L%c%n",.modletter,.l)#0A..}#0A#0A..write
f("*n.#2Eltorg")#0A}#0A#0AAND.cvswb().BE#0A{.LET.n.
.2#3D.rdk()#0A..LET.dlab.#3D.rdl()#0A..writef("@.SW
B.K%n.L%n",.n,.dlab)#0A..FOR.i.#3D.1.TO.n.DO.#0A..{
.LET.k.#3D.rdk()#0A..2LET.l.#3D.rdl()#0A..2writef("
*n@.K%n.L%n",.k,.l)#0A..2genCmpRK(ra,.k)#0A..2write
f("*n.beq.L%c%n",.modletter,.l)#0A..}#0A..writef("*
n.b.L%c%n",.modletter,.dlab)#0A..writef("*n.#2Eltor
g")#0A}#0A#0AAND.cvglobal().BE#0A{.LET.n.#3D.rdk()#0A
..writef("@.GLOBAL.K%n*n",.n)#0A..IF.sectname%0#3D0
.FOR.i.#3D.0.TO.4.DO.sectname%i.:#3D."prog"%i#0A..w
ritef("*n.#2Eglobal.%s*n",.sectname)#0A..writef("%s
:*n",.sectname)#0A..writef("*n@.On.entry.r0.points.
to.the.Global.vector")#0A..FOR.i.#3D.1.TO.n.DO#0A..
{.LET.g.#3D.rdg()#0A..2LET.n.#3D.rdl()#0A..2writef(
"*n@.G%n.L%n",.g,.n)#0A..2//writef("*n.adrl.r1,.L%c
%n",.modletter,.n)#0A..2writef("*n.ldr.r1,.#3DL%c%n
",.modletter,.n)#0A..2genLdrStr("str",.r1,.r0,.4*gv
al)#0A..}#0A..writef("*n@.G%n",.rdg())#0A..writef("
*n.mov.pc,.lr*n")#0A..writef("*n.#2Eltorg*n")#0A}#0A
#0AAND.rdchars().#3D.VALOF#0A{.LET.n.#3D.rdk()#0A..
charv%0.:#3D.n#0A..FOR.i.#3D.1.TO.n.DO.charv%i.:#3D
.rdc()#0A..RESULTIS.n#0A}#0A#0AAND.cvstring().BE#0A
{.//.Place.strings.in.the.data.(read/write).section
#0A..LET.lab.#3D.rdm()#0A..LET.n.#3D.rdchars()#0A..
writef("@.STRING..M%n.K%n",.lab,.n)#0A..FOR.i.#3D.1
.TO.n.DO.writef(".C%n",.charv%i)#0A..writef("*n.#2E
data")#0A..writef("*nM%c%n:",.modletter,.lab)#0A..F
OR.i.#3D.0.TO.((n+4)&-4)-1.DO.//.Round.up.to.a.mult
iple.of.4#0A..{.TEST.i.MOD.4.#3D.0#0A..2THEN.writef
("*n.#2Ebyte.")#0A..2ELSE.writef(",")#0A..2TEST.i>n
.THEN.writef("%3i",.0)#0A..11ELSE.writef("%3i",.cha
rv%i)#0A..}#0A..writef("*n.#2Etext")#0A}#0A#0AAND.c
vconst().BE#0A{.//.Place.constants.in.the.text.(rea
d.only).section#0A..LET.lab.#3D.rdm()#0A..LET.w.#3D
.rdw()#0A..writef("@.CONST..1M%n.W%n",.lab,.w)#0A..
writef("*nM%c%n:",.modletter,.lab)#0A..writef("*n.#2E
long.%n",.w)#0A}#0A#0AAND.cvstatic().BE#0A{.//.Plac
e.STATIC.variables.in.the.data.(read/write).section
#0A..LET.lab.#3D.rdl()#0A..LET.n.#3D.rdk()#0A..writ
ef("@.STATIC..L%n.K%n",.lab,.n)#0A..writef("*n.#2Ed
ata")#0A..writef("*nL%c%n:",.modletter,.lab)#0A..FO
R.i.#3D.1.TO.n.DO.{.writef("*n@.W%n",.rdw())#0A..20
writef("*n.#2Elong.%n",.wval)#0A..18}#0A..writef("*
n.#2Etext")#0A}#0A#0AAND.cvfs(s).BE#0A{.LET.n.#3D.r
dchars()#0A..writef("@.%t7.K%n",.s,.n)#0A..FOR.i.#3D
.1.TO.n.DO.writef(".C%n",.charv%i)#0A}#0A#0AAND.cve
ntry().BE#0A{.//.On.entry#0A..//.r1.#3D.<entry.addr
ess>#0A..//.r2.#3D.<new.P.pointer>#0A..//.r4.#3D.<f
irst.arg>#0A..//.r10.#3D.<old.P.pointer>#0A..LET.n.
#3D.rdchars()#0A..LET.op.#3D.rdf()#0A..LET.lab.#3D.
rdl()#0A..writef("*n@.Entry.to:.%s*n",.charv)#0A..w
ritef("@.%t7.K%n",."ENTRY",.n)#0A..FOR.i.#3D.1.TO.n
.DO.writef(".C%n",.charv%i)#0A..newline()#0A..TEST.
op#3Df_lab.THEN.writef("@.LAB..3L%n*n",.lab)#0A..14
ELSE.writef("@.Bad.op.F%n.L%n*n",.op,.lab)#0A..writ
ef("*nL%c%n:",.modletter,.lab)#0A..writef("*n.stmia
.r2!,.{r10,lr}")..//.NP!0,.NP!1.:#3D.P,.<return>.#0A
..writef("*n.stmia.r2,.{r1,ra}")..2//.NP!2,.NP!3..:
#3D.r1,.r4..--.<entry>,.<arg1>#0A..writef("*n.sub.r
p,.r2,.#238")..6//.P..2:#3D.NP#0A..//.P.->.[<old.P>
,.<return.addr>,.<entry.addr>,.<first.arg>,.#2E#2E1
.]#0A}#0A

######com/sial-alpha.b#
SECTION."sial-alpha"#0A#0AGET."libhdr"#0A#0AGET."si
al#2Eh"#0A#0A/*#0A.#23.It.uses.the.following.linkag
e.conventions:#0A.#23#0A.#23.$0..5v0..5The.returned
.value#0A.#23.$1-$8..2t0.-.t7..Temporary.registers#0A
.#23.$9-$15..1s0.-.s6..Must.be.preserved#0A.#23.$16
-$21..a0.-.a5..The.first.six.conforming.arguments#0A
.#23.$22-$25..t8.-.t11.Temporary.registers#0A.#23.$
26..4ra..5The.return.address#0A.#23.$27..4t12..4Tem
porary.registers.(or.procedure.value)#0A.#23.$28..4
at..5May.be.used.by.the.assembler#0A.#23.$29..4gp..
5Global.pointer#0A.#23.$30..4sp..5Points.to.stack.l
ocation.of.first.argument.on.entry#0A.#23.$31..4zer
o..3Always.has.value.zero#0A#0A1#09#0A.#23.The.regi
ster.usage.is.as.follows:#0A#0A.#23.s0..1A#0A.#23.s
1..1B#0A.#23.s2..1C#0A.#23.s3..1m/c.addr.P#0A.#23.s
4..1m/c.addr.G#0A.#23.s5..1bcpl.pointer.G#0A.#23.s6
..1m/c.addr.PC#0A#0A.#23.t8..1m/c.address.of.base.o
f.Cintcode.memory.--.saved.in.48(sp)#0A#0A*/#0A#0A1
GLOBAL.$(#0Asialin:..001200#0Aasmout:..001201#0Astd
in:..002202#0Astdout:..001203#0A#0Ardf:..004210#0Ar
dp:..004211#0Ardg:..004212#0Ardk:..004213#0Ardw:..0
04215#0Ardl:..004216#0Ardc:..004218#0Ardcode:..0012
19#0A#0Apval:..003220000#0Agval:..003220001#0Akval:
..003221#0Awval:..003220004#0Alval:..003220005#0Amv
al:..003220006#0A#0Ascan:..003230#0Acvf:..004231#0A
cvfp:..003232#0Acvfg:..003233#0Acvfk:..003234#0Acvf
w:..003236#0Acvfl:..003237#0A#0Asectname:.250#0Amod
letter:251#0Acharv:..002252#0Alabnumber:253#0A$)#0A
#0ALET.start().#3D.VALOF#0A$(.LET.argv.#3D.VEC.20#0A
..1LET.v..2#3D.VEC.20#0A..1LET.cv..1#3D.VEC.256/byt
esperword#0A#0A..1sectname.:#3D.v#0A..1sectname%0.:
#3D.0#0A..1modletter.:#3D.'A'#0A..1charv.:#3D.cv#0A
..1labnumber.:#3D.0#0A#0A..1asmout.:#3D.0#0A..1stdo
ut.:#3D.output()#0A..1IF.rdargs("FROM,TO/K",.argv,.
20)#3D0.DO#0A..1$(.writes("Bad.args.for.sial-alpha*
n")#0A..4RESULTIS.20#0A..1$)#0A..1IF.argv!0#3D0.DO.
argv!0.:#3D."prog#2Esial"#0A..1IF.argv!1#3D0.DO.arg
v!1.:#3D."prog#2Es"#0A..1sialin.:#3D.findinput(argv
!0)#0A..1IF.sialin#3D0.DO#0A..1$(.writef("Trouble.w
ith.file.%s*n",.argv!0)#0A..4RESULTIS.20#0A..1$)#0A
..1asmout.:#3D.findoutput(argv!1)#0A..1#0A..1IF.asm
out#3D0.DO#0A..1$(.writef("Trouble.with.file.%s*n",
.argv!1)#0A..4RESULTIS.20#0A..1$)#0A..1#0A..1writef
("Converting.%s.to.%s*n",.argv!0,.argv!1)#0A..1sele
ctinput(sialin)#0A..1selectoutput(asmout)#0A#0A..1w
ritef(".#23.Code.generated.by.sial-alpha*n*n")#0A..
1writef("#23include.<regdef#2Eh>*n")#0A..1writef("#2E
text*n#2Ealign.4*n")#0A#0A..1scan()#0A..1endread()#0A
..1UNLESS.asmout#3Dstdout.DO.endwrite()#0A..1select
output(stdout)#0A..1writef("Conversion.complete*n")
#0A..1RESULTIS.0#0A$)#0A#0AAND.nextlab().#3D.VALOF#0A
{.labnumber.:#3D.labnumber+1#0A..RESULTIS.labnumber
#0A}#0A#0A//.argument.may.be.of.form.Ln#0AAND.rdcod
e(let).#3D.VALOF#0A$(.LET.a,.ch,.neg.#3D.0,.?,.FALS
E#0A#0A..1ch.:#3D.rdch().REPEATWHILE.ch#3D'*s'.|.ch
#3D'*n'#0A#0A..1IF.ch#3Dendstreamch.RESULTIS.-1#0A#0A
..1UNLESS.ch#3Dlet.DO.error("Bad.item,.looking.for.
%c.found.%c*n",.let,.ch)#0A#0A..1ch.:#3D.rdch()#0A#0A
..1IF.ch#3D'-'.DO.{.neg.:#3D.TRUE;.ch.:#3D.rdch().}
#0A#0A..1WHILE.'0'<#3Dch<#3D'9'.DO.$(.a.:#3D.10*a.+
.ch.-.'0';.ch.:#3D.rdch()..$)#0A#0A..1RESULTIS.neg.
->.-a,.a#0A$)#0A#0AAND.rdf().#3D.rdcode('F')#0AAND.
rdp().#3D.VALOF.{.pval.:#3D.rdcode('P');.RESULTIS.p
val.}#0AAND.rdg().#3D.VALOF.{.gval.:#3D.rdcode('G')
;.RESULTIS.gval.}#0AAND.rdk().#3D.VALOF.{.kval.:#3D
.rdcode('K');.RESULTIS.kval.}#0AAND.rdw().#3D.VALOF
.{.wval.:#3D.rdcode('W');.RESULTIS.wval.}#0AAND.rdl
().#3D.VALOF.{.lval.:#3D.rdcode('L');.RESULTIS.lval
.}#0AAND.rdm().#3D.VALOF.{.mval.:#3D.rdcode('M');.R
ESULTIS.mval.}#0AAND.rdc().#3D.rdcode('C')#0A#0AAND
.error(mess,.a,.b,.c).BE#0A$(.LET.out.#3D.output()#0A
..1UNLESS.out#3Dstdout.DO#0A..1$(.selectoutput(stdo
ut)#0A..4writef(mess,.a,.b,.c)#0A..4selectoutput(ou
t)#0A..1$)#0A..1writef(mess,.a,.b,.c)#0A$)#0A#0AAND
.scan().BE#0A$(.LET.op.#3D.rdf()#0A#0A..1SWITCHON.o
p.INTO#0A#0A..1$(.DEFAULT:..5error(".#23.Bad.op.%n*
n",.op);.LOOP#0A#0A..4CASE.-1:..5RETURN#0A..3#0A..4
CASE.f_lp:..3cvfp("LP").//.a.:#3D.P!n#0A..19writef(
"*n.ldq.s0,%n(s3)",.8*pval)#0A..19ENDCASE#0A..4CASE
.f_lg:..3cvfg("LG").//.a.:#3D.G!n#0A..19writef("*n.
ldq.s0,%n(s4)",.8*gval)#0A..19ENDCASE#0A..4CASE.f_l
l:..3cvfl("LL").//.a.:#3D.!Ln#0A..19writef("*n.ldq.
s0,L%c%n",.modletter,.lval)#0A..19ENDCASE#0A#0A..4C
ASE.f_llp:..2cvfp("LLP").//.a.:#3D.@.P!n#0A..19writ
ef("*n.lda.s0,%n(s3)",.8*pval)#0A..19writef("*n.srl
.s0,3,s0")#0A..19ENDCASE#0A..4CASE.f_llg:..2cvfg("L
LG").//.a.:#3D.@.G!n#0A..19writef("*n.lda.s0,%n(s4)
",.8*gval)#0A..19writef("*n.srl.s0,3,s0")#0A..19END
CASE#0A..4CASE.f_ll1:..2cvfl("LL1").//.a.:#3D.@.!Ln
#0A..19writef("*n.lda.s0,L%c%n",.modletter,.lval)#0A
..19writef("*n.srl.s0,3,s0")#0A..19ENDCASE#0A..4CAS
E.f_lf:..3cvfl("LF").//.a.:#3D.byte.address.of.Ln#0A
..19writef("*n.lda.s0,L%c%n",.modletter,.lval)#0A..
19ENDCASE#0A..4CASE.f_lw:..3cvfm("LW")#0A..19writef
("*n.ldq.s0,M%c%n",.modletter,.mval)#0A..19ENDCASE#0A
#0A..4CASE.f_l:..4cvfk("L").//.a.:#3D.n#0A..19IF.kv
al#3D0.DO.{.writef("*n.bis.zero,zero,s0");.ENDCASE.
}#0A..19writef("*n.ldiq.s0,%n",.kval)#0A..19ENDCASE
#0A..4CASE.f_lm:..3cvfk("LM").//.a.:#3D.-n#0A..19wr
itef("*n.ldiq.s0,-%n",.kval)#0A..19ENDCASE#0A#0A..4
CASE.f_sp:..3cvfp("SP").//.P!n.:#3D.a#0A..19writef(
"*n.stq.s0,%n(s3)",.8*pval)#0A..19ENDCASE#0A..4CASE
.f_sg:..3cvfg("SG").//.G!n.:#3D.a#0A..19writef("*n.
stq.s0,%n(s4)",.8*gval)#0A..19ENDCASE#0A..4CASE.f_s
l:..3cvfl("SL").//.!Ln.:#3D.a#0A..19writef("*n.stq.
s0,L%c%n",.modletter,.lval)#0A..19ENDCASE#0A#0A..4C
ASE.f_ap:..3cvfp("AP").//.a.:#3D.a.+.P!n#0A..19writ
ef("*n.ldq.t0,%n(s3)",.8*pval)#0A..19writef("*n.add
q.s0,t0,s0")#0A..19ENDCASE#0A..4CASE.f_ag:..3cvfg("
AG").//.a.:#3D.a.+.G!n#0A..19writef("*n.ldq.t0,%n(s
4)",.8*gval)#0A..19writef("*n.addq.s0,t0,s0")#0A..1
9ENDCASE#0A..4CASE.f_a:..4cvfk("A").//.a.:#3D.a.+.n
#0A..19IF.kval#3D0.ENDCASE#0A..19writef("*n.ldil.t0
,%n",.kval)#0A..19writef("*n.addq.s0,t0,s0")#0A..19
ENDCASE#0A..4CASE.f_s:..4cvfk("S")..//.a.:#3D.a.-.n
#0A..19IF.kval#3D0.ENDCASE#0A..19writef("*n.ldil.t0
,%n",.kval)#0A..19writef("*n.subq.s0,t0,s0")#0A..19
ENDCASE#0A#0A..4CASE.f_lkp:..2cvfkp("LKP").//.a.:#3D
.P!n!k#0A..19writef("*n.ldq.t0,%n(s3)",.8*pval)#0A.
.19writef("*n.s8addq.t0,zero,t0")#0A..19writef("*n.
ldq.s0,%n(t0)",.8*kval)#0A..19ENDCASE#0A..4CASE.f_l
kg:..2cvfkg("LKG").//.a.:#3D.G!n!k#0A..19writef("*n
.ldq.t0,%n(s4)",.8*gval)#0A..19writef("*n.s8addq.t0
,zero,t0")#0A..19writef("*n.ldq.s0,%n(t0)",.8*kval)
#0A..19ENDCASE#0A..4CASE.f_rv:..3cvf("RV")..//.a.:#3D
.!.a#0A..19writef("*n.s8addq.s0,zero,t0")#0A..19wri
tef("*n.ldq.s0,0(t0)")#0A..19ENDCASE#0A..4CASE.f_rv
p:..2cvfp("RVP").//.a.:#3D.P!n!a#0A..19writef("*n.l
dq.t0,%n(s3)",.8*pval)#0A..19writef("*n.addq.s0,t0,
t0")#0A..19writef("*n.s8addq.t0,zero,t0")#0A..19wri
tef("*n.ldq.s0,0(t0)")#0A..19ENDCASE#0A..4CASE.f_rv
k:..2cvfk("RVK").//.a.:#3D.a!k#0A..19writef("*n.s8a
ddq.s0,zero,t0")#0A..19writef("*n.ldq.s0,%n(t0)",.8
*kval)#0A..19ENDCASE#0A..4CASE.f_st:..3cvf("ST").//
.!a.:#3D.b#0A..19writef("*n.s8addq.s0,zero,t0")#0A.
.19writef("*n.stq.s1,0(t0)")#0A..19ENDCASE#0A..4CAS
E.f_stp:..2cvfp("STP").//.P!n!a.:#3D.b#0A..19writef
("*n.ldq.t0,%n(s3)",.8*pval)#0A..19writef("*n.addq.
s0,t0,t0")#0A..19writef("*n.s8addq.t0,zero,t0")#0A.
.19writef("*n.stq.s1,0(t0)")#0A..19ENDCASE#0A..4CAS
E.f_stk:..2cvfk("STK").//.a!n.:#3D.b#0A..19writef("
*n.s8addq.s0,zero,t0")#0A..19writef("*n.stq.s1,%n(t
0)",.8*kval)#0A..19ENDCASE#0A..4CASE.f_stkp:..1cvfk
p("STKP")..//.P!n!k.:#3D.a#0A..19writef("*n.ldq.t0,
%n(s3)",.8*pval)#0A..19writef("*n.s8addq.t0,zero,t0
")#0A..19writef("*n.stq.s0,%n(t0)",.8*kval)#0A..19E
NDCASE#0A..4CASE.f_skg:..2cvfkg("SKG").//.G!n!k.:#3D
.a#0A..19writef("*n.ldq.t0,%n(s4)",.8*gval)#0A..19w
ritef("*n.s8addq.t0,zero,t0")#0A..19writef("*n.stq.
s0,%n(t0)",.8*kval)#0A..19ENDCASE#0A..4CASE.f_xst:.
.2cvf("XST").//.!b.:#3D.a#0A..19writef("*n.s8addq.s
1,zero,t0")#0A..19writef("*n.stq.s0,0(t0)")#0A..19E
NDCASE#0A#0A..4CASE.f_k:..4cvfp("K").//.Call..a(b,#2E
#2E1).incrementing.P.by.n#0A..19writef("*n.mov.s0,t
1")#0A..19writef("*n.mov.s1,s0")#0A..19writef("*n.l
da.t0,%n(s3)",.8*pval)#0A..19writef("*n.jsr.ra,(t1)
,1")#0A..19ENDCASE#0A..4CASE.f_kpg:..2cvfpg("KPG").
//.Call.Gg(a,#2E#2E1).incrementing.P.by.n#0A..19wri
tef("*n.ldq.t1,%n(s4)",.8*gval)#0A..19writef("*n.ld
a.t0,%n(s3)",.8*pval)#0A..19writef("*n.jsr.ra,(t1),
1")#0A..19ENDCASE#0A#0A..4CASE.f_neg:..2cvf("NEG").
//.a.:#3D.-.a#0A..19writef("*n.subq.zero,s0,s0").#0A
..19ENDCASE#0A..4CASE.f_not:..2cvf("NOT").//.a.:#3D
.~.a#0A..19writef("*n.ornot.zero,s0,s0").#0A..19END
CASE#0A..4CASE.f_abs:..2cvf("ABS").//.a.:#3D.ABS.a#0A
..17{.LET.l.#3D.nextlab()#0A..19writef("*n.bge.s0,S
%c%n",.modletter,.l)#0A..19writef("*n.subq.zero,s0,
s0")#0A..19writef("*nS%c%n:",.modletter,.l)#0A..19E
NDCASE#0A..17}#0A#0A..4CASE.f_xdiv:..1cvf("XDIV")./
/.a.:#3D.a./.b#0A..19writef("*n.divq.s0,s1,s0")#0A.
.19ENDCASE#0A..4CASE.f_xrem:..1cvf("XREM").//.a.:#3D
.a.REM.b#0A..19writef("*n.remq.s0,s1,s0")#0A..19END
CASE#0A..4CASE.f_xsub:..1cvf("XSUB").//.a.:#3D.a.-.
b#0A..19writef("*n.subq.s0,s1,s0")#0A..19ENDCASE#0A
#0A..4CASE.f_mul:..2cvf("MUL").//.a.:#3D.b.*.a;.c.:
#3D.?#0A..19writef("*n.mulq.s1,s0,s0")#0A..19ENDCAS
E#0A..4CASE.f_div:..2cvf("DIV")..//.a.:#3D.b./.a;.c
.:#3D.?#0A..19writef("*n.divq.s1,s0,s0")#0A..19ENDC
ASE#0A..4CASE.f_rem:..2cvf("REM").//.a.:#3D.b.REM.a
;.c.:#3D.?#0A..19writef("*n.remq.s1,s0,s0")#0A..19E
NDCASE#0A..4CASE.f_add:..2cvf("ADD").//.a.:#3D.b.+.
a#0A..19writef("*n.addq.s1,s0,s0")#0A..19ENDCASE#0A
..4CASE.f_sub:..2cvf("SUB").//.a.:#3D.b.-.a#0A..19w
ritef("*n.subl.s1,s0,s0")#0A..19ENDCASE#0A#0A..4CAS
E.f_eq:..3cvf("EQ").//.a.:#3D.b.#3D.a#0A..19writef(
"*n.cmpeq.s1,s0,s0")#0A..19writef("*n.subq.zero,s0,
s0")#0A..19ENDCASE#0A..4CASE.f_ne:..3cvf("NE").//.a
.:#3D.b.~#3D.a#0A..19writef("*n.cmpeq.s1,s0,s0")#0A
..19writef("*n.subq.s0,1,s0")#0A..19ENDCASE#0A..4CA
SE.f_ls:..3cvf("LS").//.a.:#3D.b.<.a#0A..19writef("
*n.cmplt.s1,s0,s0")#0A..19writef("*n.subq.zero,s0,s
0")#0A..19ENDCASE#0A..4CASE.f_gr:..3cvf("GR").//.a.
:#3D.b.>.a#0A..19writef("*n.cmplt.s0,s1,s0")#0A..19
writef("*n.subq.zero,s0,s0")#0A..19ENDCASE#0A..4CAS
E.f_le:..3cvf("LE").//.a.:#3D.b.<#3D.a#0A..19writef
("*n.cmple.s1,s0,s0")#0A..19writef("*n.subq.zero,s0
,s0")#0A..19ENDCASE#0A..4CASE.f_ge:..3cvf("GE").//.
a.:#3D.b.>#3D.a#0A..19writef("*n.cmple.s0,s1,s0")#0A
..19writef("*n.subq.zero,s0,s0")#0A..19ENDCASE#0A#0A
..4CASE.f_eq0:..2cvf("EQ0").//.a.:#3D.a.#3D.0#0A..1
9writef("*n.cmpeq.s0,zero,s0")#0A..19writef("*n.sub
q.zero,s0,s0")#0A..19ENDCASE#0A..4CASE.f_ne0:..2cvf
("NE0").//.a.:#3D.a.~#3D.0#0A..19writef("*n.cmpeq.s
0,zero,s0")#0A..19writef("*n.subq.s0,1,s0")#0A..19E
NDCASE#0A..4CASE.f_ls0:..2cvf("LS0").//.a.:#3D.a.<.
0#0A..19writef("*n.sra.s0,63,s0")#0A..19ENDCASE#0A.
.4CASE.f_gr0:..2cvf("GR0").//.a.:#3D.a.>.0#0A..19wr
itef("*n.cmplt.zero,s0,s0")#0A..19writef("*n.subq.z
ero,s0,s0")#0A..19ENDCASE#0A..4CASE.f_le0:..2cvf("L
E0").//.a.:#3D.a.<#3D.0#0A..19writef("*n.cmple.s0,z
ero,s0")#0A..19writef("*n.subq.zero,s0,s0")#0A..19E
NDCASE#0A..4CASE.f_ge0:..2cvf("GE0").//.a.:#3D.a.>#3D
.0#0A..19writef("*n.cmple.zero,s0,s0")#0A..19writef
("*n.subq.zero,s0,s0")#0A..19ENDCASE#0A#0A..4CASE.f
_lsh:..2cvf("LSH").//.a.:#3D.b.<<.a#0A..19writef("*
n.cmpule.s0,63,t0")#0A..19writef("*n.subq.zero,t0,t
0")#0A..19writef("*n.and.s1,t0,t0")#0A..19writef("*
n.sll.t0,s0,s0")#0A..19ENDCASE#0A..4CASE.f_rsh:..2c
vf("RSH").//.a.:#3D.b.>>.a.#0A..19writef("*n.cmpule
.s0,63,t0")#0A..19writef("*n.subq.zero,t0,t0")#0A..
19writef("*n.and.s1,t0,t0")#0A..19writef("*n.srl.t0
,s0,s0")#0A..19ENDCASE#0A..4CASE.f_and:..2cvf("AND"
).//.a.:#3D.b.&.a.#0A..19writef("*n.and.s1,s0,s0").
#0A..19ENDCASE#0A..4CASE.f_or:..3cvf("OR").//.a.:#3D
.b.|.a.#0A..19writef("*n.or.s1,s0,s0").#0A..19ENDCA
SE#0A..4CASE.f_xor:..2cvf("XOR").//.a.:#3D.b.NEQV.a
#0A..19writef("*n.xor.s1,s0,s0").#0A..19ENDCASE#0A.
.4CASE.f_eqv:..2cvf("EQV").//.a.:#3D.b.EQV.a.#0A..1
9writef("*n.xor.s1,s0,s0").#0A..19writef("*n.ornot.
zero,s0,s0").#0A..19ENDCASE#0A#0A..4CASE.f_gbyt:..1
cvf("GBYT").//.a.:#3D.b.%.a#0A..19writef("*n.s8addq
.s1,s0,v0").#0A..19writef("*n.ldq_u.s0,0(v0)").#0A.
.19writef("*n.extbl.s0,v0,s0").#0A..19ENDCASE#0A..4
CASE.f_xgbyt:..cvf("XGBYT").//.a.:#3D.a.%.b.#0A..19
writef("*n.s8addq.s0,s1,v0").#0A..19writef("*n.ldq_
u.s0,0(v0)").#0A..19writef("*n.extbl.s0,v0,s0").#0A
..19ENDCASE#0A..4CASE.f_pbyt:..1cvf("PBYT").//.b.%.
a.:#3D.c#0A..19writef("*n.s8addq.s1,s0,v0").#0A..19
writef("*n.ldq_u.a0,0(v0)").#0A..19writef("*n.insbl
.s2,v0,t2").#0A..19writef("*n.mskbl.a0,v0,a0").#0A.
.19writef("*n.bis.a0,t2,a0").#0A..19writef("*n.stq_
u.a0,0(v0)").#0A..19ENDCASE#0A..4CASE.f_xpbyt:..cvf
("XPBYT").//.a.%.b.:#3D.c.#0A..19writef("*n.s8addq.
s0,s1,v0").#0A..19writef("*n.ldq_u.a0,0(v0)").#0A..
19writef("*n.insbl.s2,v0,t2").#0A..19writef("*n.msk
bl.a0,v0,a0").#0A..19writef("*n.bis.a0,t2,a0").#0A.
.19writef("*n.stq_u.a0,0(v0)").#0A..19ENDCASE#0A#0A
//.swb..5Kn.Ld.K1.L1.#2E#2E1.Kn.Ln..1Binary.chop.sw
itch,.Ld.default#0A..4CASE.f_swb:..2cvswb()#0A..19E
NDCASE#0A#0A//.swl..5Kn.Ld.L1.#2E#2E1.Ln..7Label.ve
ctor.switch,.Ld.default#0A..4CASE.f_swl:..2cvswl()#0A
..19ENDCASE#0A#0A..4CASE.f_xch:..2cvf("XCH").//.swa
p.a.and.b#0A..19writef("*n.mov.s0,v0")#0A..19writef
("*n.mov.s1,s0")#0A..19writef("*n.mov.v0,s1")#0A..1
9ENDCASE#0A..4CASE.f_atb:..2cvf("ATB").//.b.:#3D.a#0A
..19writef("*n.mov.s0,s1")#0A..19ENDCASE#0A..4CASE.
f_atc:..2cvf("ATC").//.c.:#3D.a#0A..19writef("*n.mo
v.s0,s2")#0A..19ENDCASE#0A..4CASE.f_bta:..2cvf("BTA
").//.a.:#3D.b#0A..19writef("*n.mov.s1,s0")#0A..19E
NDCASE#0A..4CASE.f_btc:..2cvf("BTC").//.c.:#3D.b#0A
..19writef("*n.mov.s1,s2")#0A..19ENDCASE#0A..4CASE.
f_atblp:..cvfp("ATBLP").//.b.:#3D.a;.a.:#3D.P!n#0A.
.19writef("*n.mov.s0,s1")#0A..19writef("*n.ldq.s0,%
n(s3)",.8*pval)#0A..19ENDCASE#0A..4CASE.f_atblg:..c
vfg("ATBLG").//.b.:#3D.a;.a.:#3D.G!n#0A..19writef("
*n.mov.s0,s1")#0A..19writef("*n.ldq.s0,%n(s4)",.8*g
val)#0A..19ENDCASE#0A..4CASE.f_atbl:..1cvfk("ATBL")
.//.b.:#3D.a;.a.:#3D.k#0A..19writef("*n.mov.s0,s1")
#0A..19writef("*n.ldiq.s0,%n",.kval)#0A..19ENDCASE#0A
#0A..4CASE.f_j:..4cvfl("J").//.jump.to.Ln#0A..19wri
tef("*n.br.L%c%n",.modletter,.lval)#0A..19ENDCASE#0A
..4CASE.f_rtn:..2cvf("RTN").//.procedure.return#0A.
.19writef("*n.ldq.ra,8(s3)")#0A..19writef("*n.ldq.s
3,0(s3)")#0A..19writef("*n.ret.zero,(ra),1")#0A..19
ENDCASE#0A..4CASE.f_goto:..1cvf("GOTO").//.jump.to.
a#0A..19writef("*n.jmp.zero,(s0)")#0A..19ENDCASE#0A
#0A..4CASE.f_res:..2cvf("RES")..1//.<res>.:#3D.A#0A
..32//.<res>.is.already.in.A#0A..32//.nothing.to.do
#0A..19ENDCASE#0A#0A..4CASE.f_ldres:..cvf("LSRES").
//.A.:#3D.<res>#0A..32//.A.and.B.already.set.proper
ly#0A..19ENDCASE#0A#0A..4CASE.f_ikp:..2cvfkp("IKP")
.//.a.:#3D.P!n.+.k;.P!n.:#3D.a#0A..19writef("*n.ldq
.s0,%n(s3)",.8*pval)#0A..19writef("*n.addq.s0,%n,s0
",.kval)#0A..19writef("*n.stq.s0,%n(s3)",.8*pval)#0A
..19ENDCASE#0A..4CASE.f_ikg:..2cvfkg("IKG").//.a.:#3D
.G!n.+.k;.G!n.:#3D.a#0A..19writef("*n.ldq.s0,%n(s4)
",.8*gval)#0A..19writef("*n.addq.s0,%n,s0",.kval)#0A
..19writef("*n.stq.s0,%n(s4)",.8*gval)#0A..19ENDCAS
E#0A..4CASE.f_ikl:..2cvfkl("IKL").//.a.:#3D.!Ln.+.k
;.!Ln.:#3D.a#0A..19writef("*n.ldq.s0,L%c%n",.modlet
ter,.lval)#0A..19writef("*n.addq.s0,%n,s0",.kval)#0A
..19writef("*n.stq.s0,L%c%n",.modletter,.lval)#0A..
19ENDCASE#0A..4CASE.f_ip:..3cvfp("IP").//.a.:#3D.P!
n.+.a;.P!n.:#3D.a#0A..19writef("*n.ldq.t0,%n(s3)",.
8*pval)#0A..19writef("*n.addq.s0,t0,s0")#0A..19writ
ef("*n.stq.s0,%n(s3)")#0A..19ENDCASE#0A..4CASE.f_ig
:..3cvfg("IG").//.a.:#3D.G!n.+.a;.G!n.:#3D.a#0A..19
writef("*n.ldq.t0,%n(s4)",.8*gval)#0A..19writef("*n
.addq.s0,t0,s0")#0A..19writef("*n.stq.s0,%n(s4)",.8
*gval)#0A..19ENDCASE#0A..4CASE.f_il:..3cvfl("IL")./
/.a.:#3D.!Ln.+.a;.!Ln.:#3D.a#0A..19writef("*n.ldq.t
0,L%c%n",.modletter,.lval)#0A..19writef("*n.addq.s0
,t0,s0")#0A..19writef("*n.stq.s0,L%c%n",.modletter,
.lval)#0A..19ENDCASE#0A#0A..4CASE.f_jeq:..2cvfl("JE
Q").//.Jump.to.Ln.if.b.#3D.a#0A..19writef("*n.cmpeq
.s1,s0,t0")#0A..19writef("*n.bne.t0,L%c%n",.modlett
er,.lval)#0A..19ENDCASE#0A..4CASE.f_jne:..2cvfl("JN
E").//.Jump.to.Ln.if.b.~#3D.a#0A..19writef("*n.cmpe
q.s1,s0,t0")#0A..19writef("*n.beq.t0,L%c%n",.modlet
ter,.lval)#0A..19ENDCASE#0A..4CASE.f_jls:..2cvfl("J
LS").//.Jump.to.Ln.if.b.<.a#0A..19writef("*n.cmplt.
s1,s0,t0")#0A..19writef("*n.bne.t0,L%c%n",.modlette
r,.lval)#0A..19ENDCASE#0A..4CASE.f_jgr:..2cvfl("JGR
").//.Jump.to.Ln.if.b.>.a#0A..19writef("*n.cmplt.s0
,s1,t0")#0A..19writef("*n.bne.t0,L%c%n",.modletter,
.lval)#0A..19ENDCASE#0A..4CASE.f_jle:..2cvfl("JLE")
.//.Jump.to.Ln.if.b.<#3D.a#0A..19writef("*n.cmple.s
1,s0,t0")#0A..19writef("*n.bne.t0,L%c%n",.modletter
,.lval)#0A..19ENDCASE#0A..4CASE.f_jge:..2cvfl("JGE"
).//.Jump.to.Ln.if.b.>#3D.a#0A..19writef("*n.cmple.
s0,s1,t0")#0A..19writef("*n.bne.t0,L%c%n",.modlette
r,.lval)#0A..19ENDCASE#0A#0A..4CASE.f_jeq0:..1cvfl(
"JEQ0").//.Jump.to.Ln.if.a.#3D.0#0A..19writef("*n.b
eq.s0,L%c%n",.modletter,.lval)#0A..19ENDCASE#0A..4C
ASE.f_jne0:..1cvfl("JNE0").//.Jump.to.Ln.if.a.~#3D.
0#0A..19writef("*n.bne.s0,L%c%n",.modletter,.lval)#0A
..19ENDCASE#0A..4CASE.f_jls0:..1cvfl("JLS0").//.Jum
p.to.Ln.if.a.<.0#0A..19writef("*n.blt.s0,L%c%n",.mo
dletter,.lval)#0A..19ENDCASE#0A..4CASE.f_jgr0:..1cv
fl("JGR0").//.Jump.to.Ln.if.a.>.0#0A..19writef("*n.
bgt.s0,L%c%n",.modletter,.lval)#0A..19ENDCASE#0A..4
CASE.f_jle0:..1cvfl("JLE0").//.Jump.to.Ln.if.a.<#3D
.0#0A..19writef("*n.ble.s0,L%c%n",.modletter,.lval)
#0A..19ENDCASE#0A..4CASE.f_jge0:..1cvfl("JGE0").//.
Jump.to.Ln.if.a.>#3D.0#0A..19writef("*n.bge.s0,L%c%
n",.modletter,.lval)#0A..19ENDCASE#0A..4CASE.f_jge0
m:..cvfm("JGE0M").//.Jump.to.Mn.if.a.>#3D.0#0A..19w
ritef("*n.bge.s0,M%c%n",.modletter,.mval)#0A..19END
CASE#0A#0A..4//.The.following.five.opcodes.are.neve
r.generated.by#0A..4//.the.BCPL.compiler#0A..4CASE.
f_brk:..2cvf("BRK").//.Breakpoint.instruction#0A..1
9writef("*n.unimplemented")#0A..19ENDCASE#0A..4CASE
.f_nop:..2cvf("NOP").//.No.operation#0A..19ENDCASE#0A
..4CASE.f_chgco:..cvf("CHGCO").//.Change.coroutine#0A
..19writef("*n.unimplemented")#0A..19ENDCASE#0A..4C
ASE.f_mdiv:..1cvf("MDIV").//.a.:#3D.Muldiv(P!3,.P!4
,.P!5).#0A..19writef("*n.unimplemented")#0A..19ENDC
ASE#0A..4CASE.f_sys:..2cvf("SYS").//.System.functio
n#0A..19writef("*n.unimplemented")#0A..19ENDCASE#0A
#0A..4CASE.f_section:..cvfs("SECTION").//.Name.of.s
ection#0A..21FOR.i.#3D.0.TO.charv%0.DO.sectname%i.:
#3D.charv%i#0A..21ENDCASE#0A..4CASE.f_modstart:.cvf
("MODSTART").//.Start.of.module..#0A..21sectname%0.
:#3D.0#0A..21ENDCASE#0A..4CASE.f_modend:..1cvf("MOD
END").//.End.of.module.#0A..21modletter.:#3D.modlet
ter+1#0A..21ENDCASE#0A..4CASE.f_global:..1cvglobal(
).//.Global.initialisation.data#0A..21ENDCASE#0A..4
CASE.f_string:..1cvstring().//.String.constant#0A..
21ENDCASE#0A..4CASE.f_const:..2cvconst().//.Large.i
nteger.constant#0A..21ENDCASE#0A#0A..4CASE.f_static
:..1cvstatic().//.Static.variable.or.table#0A..21EN
DCASE#0A..4CASE.f_mlab:..3cvfm("MLAB").//.Destinati
on.of.jge0m#0A..21writef("*nM%c%n:",.modletter,.mva
l)#0A..21ENDCASE#0A..4CASE.f_lab:..4cvfl("LAB").//.
Program.label#0A..21writef("*nL%c%n:",.modletter,.l
val)#0A..21ENDCASE#0A..4CASE.f_lstr:..3cvfm("LSTR")
.//.a.:#3D.Mn..1(pointer.to.string)#0A..21writef("*
n.lda.s0,M%c%n",.modletter,.mval)#0A..21writef("*n.
srl.s0,3,s0")#0A..21ENDCASE#0A..4CASE.f_entry:..2cv
entry().//.Start.of.a.function#0A..21ENDCASE#0A..1$
)#0A#0A..1newline()#0A$).REPEAT#0A#0AAND.cvf(s)..BE
.writef(".#23.%s",.s)#0AAND.cvfp(s).BE.writef(".#23
.%t7.P%n",.s,.rdp())#0AAND.cvfkp(s).BE.writef(".#23
.%t7.K%n.P%n",.s,.rdk(),.rdp())#0AAND.cvfg(s).BE.wr
itef(".#23.%t7.G%n",.s,.rdg())#0AAND.cvfkg(s).BE.wr
itef(".#23.%t7.K%n.G%n",.s,.rdk(),.rdg())#0AAND.cvf
kl(s).BE.writef(".#23.%t7.K%n.L%n",.s,.rdk(),.rdl()
)#0AAND.cvfpg(s).BE.writef(".#23.%t7.P%n.G%n",.s,.r
dp(),.rdg())#0AAND.cvfk(s).BE.writef(".#23.%t7.K%n"
,.s,.rdk())#0AAND.cvfw(s).BE.writef(".#23.%t7.W%n",
.s,.rdw())#0AAND.cvfl(s).BE.writef(".#23.%t7.L%n",.
s,.rdl())#0AAND.cvfm(s).BE.writef(".#23.%t7.M%n",.s
,.rdm())#0A#0AAND.cvswl().BE#0A$(.LET.n.#3D.rdk()#0A
..1LET.l.#3D.rdl()#0A..1LET.lab.#3D.nextlab()#0A..1
writef(".#23.SWL.K%n.L%n",.n,.l)#0A..1writef("*n.bl
t.s0,L%c%n",.modletter,.l)#0A..1writef("*n.cmplt.s0
,%n,t0",.n)#0A..1writef("*n.beq.t0,L%c%n",.modlette
r,.l)#0A..1writef("*n.lda.t0,S%c%n",.modletter,lab)
#0A..1writef("*n.s8addq.s0,t0,t0")#0A..1writef("*n.
ldq.t0,0(t0)")#0A..1writef("*n.jmp.zero,(t0)")#0A..
1writef("*n.#2Edata")#0A..1writef("*n.#2Ealign.3")#0A
..1writef("*nS%c%n:",.modletter,.lab)#0A..1FOR.i.#3D
.1.TO.n.DO#0A..1{.writef("*n.#23.L%n",.rdl())#0A..3
writef("*n.#2Equad.L%c%n",.modletter,.lval)#0A..1}#0A
..1writef("*n.#2Etext")#0A$)#0A#0AAND.cvswb().BE#0A
$(.LET.n.#3D.rdk()#0A..1LET.l.#3D.rdl()#0A..1writef
(".#23.SWB.K%n.L%n",.n,.l)#0A..1FOR.i.#3D.1.TO.n.DO
.#0A..1$(.LET.k.#3D.rdk()#0A..4LET.l.#3D.rdl()#0A..
4writef("*n.#23.K%n.L%n",.k,.l)#0A..4writef("*n.cmp
eq.s0,%n,t0",.k)#0A..4writef("*n.bne.t0,L%c%n",.mod
letter,.l)#0A..1$)#0A..1writef("*n.br.L%c%n",.modle
tter,.l)#0A$)#0A#0AAND.cvglobal().BE#0A$(.LET.n.#3D
.rdk()#0A..1writef(".#23.GLOBAL.K%n*n",.n)#0A..1IF.
sectname%0#3D0.FOR.i.#3D.0.TO.4.DO.sectname%i.:#3D.
"prog"%i#0A..1writef("*n#2Eglobl.%s*n",.sectname)#0A
..1writef("%s:*n",.sectname)#0A..1FOR.i.#3D.1.TO.n.
DO#0A..1$(.LET.g.#3D.rdg()#0A..4LET.n.#3D.rdl()#0A.
.4writef(".#23.G%n.L%n*n",.g,.n)#0A..4writef(".lda.
t0,L%c%n*n",.modletter,.n)#0A..4writef(".stq.t0,%n(
a0)*n",.8*g)#0A..1$)#0A..1writef(".#23.G%n",.rdg())
#0A..1writef("*n.ret.zero,(ra),1*n")#0A$)#0A#0AAND.
rdchars().#3D.VALOF#0A{.LET.n.#3D.rdk()#0A..charv%0
.:#3D.n#0A..FOR.i.#3D.1.TO.n.DO.charv%i.:#3D.rdc()#0A
..RESULTIS.n#0A}#0A#0AAND.cvstring().BE#0A$(.LET.la
b.#3D.rdm()#0A..1LET.n.#3D.rdchars()#0A..1writef(".
#23.STRING..M%n.K%n",.lab,.n)#0A..1FOR.i.#3D.1.TO.n
.DO.writef(".C%n",.charv%i)#0A..1writef("*n#2Edata"
)#0A..1writef("*n.#2Ealign.3")#0A..1writef("*nM%c%n
:",.modletter,.lab)#0A..1FOR.i.#3D.0.TO.n.DO.writef
("*n.#2Ebyte.%n",.charv%i)#0A..1writef("*n.#2Etext"
)#0A$)#0A#0AAND.cvconst().BE#0A$(.LET.lab.#3D.rdm()
#0A..1LET.w.#3D.rdw()#0A..1writef(".#23.CONST..1M%n
.W%n",.lab,.w)#0A..1writef("*n#2Edata")#0A..1writef
("*n.#2Ealign.3")#0A..1writef("*nM%c%n:",.modletter
,.lab)#0A..1writef("*n.#2Equad.%n",.w)#0A..1writef(
"*n.#2Etext")#0A$)#0A#0AAND.cvstatic().BE#0A$(.LET.
lab.#3D.rdl()#0A..1LET.n.#3D.rdk()#0A..1writef(".#23
.STATIC..L%n.K%n",.lab,.n)#0A..1writef("*n#2Edata")
#0A..1writef("*n.#2Ealign.3")#0A..1writef("*nL%c%n:
",.modletter,.lab)#0A..1FOR.i.#3D.1.TO.n.DO.{.write
f("*n.#23.W%n",.rdw())#0A..21writef("*n.#2Equad.%n"
,.wval)#0A..19}#0A..1writef("*n.#2Etext")#0A$)#0A#0A
AND.cvfs(s).BE#0A$(.LET.n.#3D.rdchars()#0A..1writef
(".#23.%t7.K%n",.s,.n)#0A..1FOR.i.#3D.1.TO.n.DO.wri
tef(".C%n",.charv%i)#0A$)#0A#0AAND.cventry().BE#0A$
(.LET.n.#3D.rdchars()#0A..1LET.op.#3D.rdf()#0A..1LE
T.lab.#3D.rdl()#0A..1writef("*n.#23.Entry.to:.%s*n"
,.charv)#0A..1writef(".#23.%t7.K%n",."ENTRY",.n)#0A
..1FOR.i.#3D.1.TO.n.DO.writef(".C%n",.charv%i)#0A..
1newline()#0A..1TEST.op#3Df_lab.THEN.writef(".#23.L
AB..3L%n*n",.lab)#0A..15ELSE.writef(".#23.Bad.op.F%
n.L%n*n",.op,.lab)#0A..1writef("*nL%c%n:",.modlette
r,.lab)#0A..1writef("*n.stq.s3,0(t0)")..1//.NP!0.:#3D
.P#0A..1writef("*n.mov.t0,s3")..4//.P..2:#3D.NP#0A.
.1writef("*n.stq.ra,8(s3)")..1//.P!1..:#3D.return.a
ddress#0A..1writef("*n.stq.t1,16(s3)")..//.P!2..:#3D
.entry.address#0A..1writef("*n.stq.s0,24(s3)")..//.
P!3..:#3D.arg1#0A$)#0A

######com/sial-sasm.b#
SECTION."sial-sasm"#0A#0AGET."libhdr"#0A#0AGET."sia
l#2Eh"#0A#0AGLOBAL.{#0Asialin:.ug#0Asialout;.stdin;
.stdout#0A#0Ardf;.rdp;.rdg;.rdk;.rdh;.rdw;.rdl;.rdd
;.rdc#0Ardcode#0A#0Ascan#0Acvf;.cvfp;.cvfg;.cvfk;.c
vfh;.cvfw;.cvfl;.cvfd#0A}#0A#0ALET.start().#3D.VALO
F#0A{.LET.argv.#3D.VEC.20#0A#0A..1sialout.:#3D.0#0A
..1stdout.:#3D.output()#0A..1IF.rdargs("FROM,TO/K",
.argv,.20)#3D0.DO#0A..1{.writes("Bad.args.for.sial-
sasm*n")#0A..4RESULTIS.20#0A..1}#0A..1IF.argv!0#3D0
.DO.argv!0.:#3D."prog#2Esial"#0A..1IF.argv!1#3D0.DO
.argv!1.:#3D."prog#2Esasm"#0A..1sialin.:#3D.findinp
ut(argv!0)#0A..1IF.sialin#3D0.DO#0A..1{.writef("Tro
uble.with.file.%s*n",.argv!0)#0A..4RESULTIS.20#0A..
1}#0A..1sialout.:#3D.findoutput(argv!1)#0A..1#0A..1
IF.sialout#3D0.DO#0A..1{.writef("Trouble.with.file.
%s*n",.argv!1)#0A..4RESULTIS.20#0A..1}#0A..1#0A..1w
ritef("Converting.%s.to.%s*n",.argv!0,.argv!1)#0A..
1selectinput(sialin)#0A..1selectoutput(sialout)#0A.
.1scan()#0A..1endread()#0A..1UNLESS.sialout#3Dstdou
t.DO.endwrite()#0A..1selectoutput(stdout)#0A..1writ
ef("Conversion.complete*n")#0A..1RESULTIS.0#0A}#0A#0A
//.argument.may.be.of.form.Ln#0AAND.rdcode(let).#3D
.VALOF#0A{.LET.a,.ch,.neg.#3D.0,.?,.FALSE#0A#0A..1c
h.:#3D.rdch().REPEATWHILE.ch#3D'*s'.|.ch#3D'*n'#0A#0A
..1IF.ch#3Dendstreamch.RESULTIS.-1#0A#0A..1UNLESS.c
h#3Dlet.DO.error("Bad.item,.looking.for.%c.found.%c
*n",.let,.ch)#0A#0A..1ch.:#3D.rdch()#0A#0A..1IF.ch#3D
'-'.DO.{.neg.:#3D.TRUE;.ch.:#3D.rdch().}#0A#0A..1WH
ILE.'0'<#3Dch<#3D'9'.DO.{.a.:#3D.10*a.+.ch.-.'0';.c
h.:#3D.rdch()..}#0A#0A..1RESULTIS.neg.->.-a,.a#0A}#0A
#0AAND.rdf().#3D.rdcode('F')#0AAND.rdp().#3D.rdcode
('P')#0AAND.rdg().#3D.rdcode('G')#0AAND.rdk().#3D.r
dcode('K')#0AAND.rdh().#3D.rdcode('H')#0AAND.rdw().
#3D.rdcode('W')#0AAND.rdl().#3D.rdcode('L')#0AAND.r
dm().#3D.rdcode('M')#0AAND.rdc().#3D.rdcode('C')#0A
#0AAND.error(mess,.a,.b,.c).BE#0A{.LET.out.#3D.outp
ut()#0A..1UNLESS.out#3Dstdout.DO#0A..1{.selectoutpu
t(stdout)#0A..4writef(mess,.a,.b,.c)#0A..4selectout
put(out)#0A..1}#0A..1writef(mess,.a,.b,.c)#0A}#0A#0A
AND.scan().BE#0A{.LET.op.#3D.rdf()#0A#0A..1SWITCHON
.op.INTO#0A#0A..1{.DEFAULT:..5error("Bad.op.%n*n",.
op);.LOOP#0A#0A..4CASE.-1:..5RETURN#0A..4#0A..4CASE
.f_lp:..3cvfp("LP");.ENDCASE#0A..4CASE.f_lg:..3cvfg
("LG");.ENDCASE#0A..4CASE.f_ll:..3cvfl("LL");.ENDCA
SE#0A#0A..4CASE.f_llp:..2cvfp("LLP");.ENDCASE#0A..4
CASE.f_llg:..2cvfg("LLG");.ENDCASE#0A..4CASE.f_ll1:
..2cvfl("LL1");.ENDCASE#0A..4CASE.f_lf:..3cvfl("LF"
);.ENDCASE#0A..4CASE.f_lw:..3cvfm("LW");.ENDCASE#0A
#0A..4CASE.f_l:..4cvfk("L");.ENDCASE#0A..4CASE.f_lm
:..3cvfk("LM");.ENDCASE#0A#0A..4CASE.f_sp:..3cvfp("
SP");.ENDCASE#0A..4CASE.f_sg:..3cvfg("SG");.ENDCASE
#0A..4CASE.f_sl:..3cvfl("SL");.ENDCASE#0A#0A..4CASE
.f_ap:..3cvfp("AP");.ENDCASE#0A..4CASE.f_ag:..3cvfg
("AG");.ENDCASE#0A..4CASE.f_a:..4cvfk("A");.ENDCASE
#0A..4CASE.f_s:..4cvfk("S");.ENDCASE#0A#0A..4CASE.f
_lkp:..2cvfkp("LKP");.ENDCASE#0A..4CASE.f_lkg:..2cv
fkg("LKG");.ENDCASE#0A..4CASE.f_rv:..3cvf("RV");.EN
DCASE#0A..4CASE.f_rvp:..2cvfp("RVP");.ENDCASE#0A..4
CASE.f_rvk:..2cvfk("RVK");.ENDCASE#0A..4CASE.f_st:.
.3cvf("ST");.ENDCASE#0A..4CASE.f_stp:..2cvfp("STP")
;.ENDCASE#0A..4CASE.f_stk:..2cvfk("STK");.ENDCASE#0A
..4CASE.f_stkp:..1cvfkp("STKP");.ENDCASE#0A..4CASE.
f_skg:..2cvfkg("SKG");.ENDCASE#0A..4CASE.f_xst:..2c
vf("XST");.ENDCASE#0A#0A..4CASE.f_k:..4cvfp("K");.E
NDCASE#0A..4CASE.f_kpg:..2cvfpg("KPG");.ENDCASE#0A#0A
..4CASE.f_neg:..2cvf("NEG");.ENDCASE#0A..4CASE.f_no
t:..2cvf("NOT");.ENDCASE#0A..4CASE.f_abs:..2cvf("AB
S");.ENDCASE#0A#0A..4CASE.f_xdiv:..1cvf("XDIV");.EN
DCASE#0A..4CASE.f_xrem:..1cvf("XREM");.ENDCASE#0A..
4CASE.f_xsub:..1cvf("XSUB");.ENDCASE#0A#0A..4CASE.f
_mul:..2cvf("MUL");.ENDCASE#0A..4CASE.f_div:..2cvf(
"DIV");.ENDCASE#0A..4CASE.f_rem:..2cvf("REM");.ENDC
ASE#0A..4CASE.f_add:..2cvf("ADD");.ENDCASE#0A..4CAS
E.f_sub:..2cvf("SUB");.ENDCASE#0A#0A..4CASE.f_eq:..
3cvf("EQ");.ENDCASE#0A..4CASE.f_ne:..3cvf("NE");.EN
DCASE#0A..4CASE.f_ls:..3cvf("LS");.ENDCASE#0A..4CAS
E.f_gr:..3cvf("GR");.ENDCASE#0A..4CASE.f_le:..3cvf(
"LE");.ENDCASE#0A..4CASE.f_ge:..3cvf("GE");.ENDCASE
#0A..4CASE.f_eq0:..2cvf("EQ0");.ENDCASE#0A..4CASE.f
_ne0:..2cvf("NE0");.ENDCASE#0A..4CASE.f_ls0:..2cvf(
"LS0");.ENDCASE#0A..4CASE.f_gr0:..2cvf("GR0");.ENDC
ASE#0A..4CASE.f_le0:..2cvf("LE0");.ENDCASE#0A..4CAS
E.f_ge0:..2cvf("GE0");.ENDCASE#0A#0A..4CASE.f_lsh:.
.2cvf("LSH");.ENDCASE#0A..4CASE.f_rsh:..2cvf("RSH")
;.ENDCASE#0A..4CASE.f_and:..2cvf("AND");.ENDCASE#0A
..4CASE.f_or:..3cvf("OR");.ENDCASE#0A..4CASE.f_xor:
..2cvf("XOR");.ENDCASE#0A..4CASE.f_eqv:..2cvf("EQV"
);.ENDCASE#0A#0A..4CASE.f_gbyt:..1cvf("GBYT");..END
CASE#0A..4CASE.f_xgbyt:..cvf("XGBYT");.ENDCASE#0A..
4CASE.f_pbyt:..1cvf("PBYT");..ENDCASE#0A..4CASE.f_x
pbyt:..cvf("XPBYT");.ENDCASE#0A#0A..4CASE.f_swb:..5
cvswb();.ENDCASE#0A..4CASE.f_swl:..5cvswl();.ENDCAS
E#0A#0A..4CASE.f_xch:..2cvf("XCH");.ENDCASE#0A..4CA
SE.f_atb:..2cvf("ATB");.ENDCASE#0A..4CASE.f_atc:..2
cvf("ATC");.ENDCASE#0A..4CASE.f_bta:..2cvf("BTA");.
ENDCASE#0A..4CASE.f_btc:..2cvf("BTC");.ENDCASE#0A..
4CASE.f_atblp:..cvfp("ATBLP");.ENDCASE#0A..4CASE.f_
atblg:..cvfg("ATBLG");.ENDCASE#0A..4CASE.f_atbl:..1
cvfk("ATBL");.ENDCASE#0A#0A..4CASE.f_j:..4cvfl("J")
;.ENDCASE#0A..4CASE.f_rtn:..2cvf("RTN");.ENDCASE#0A
..4CASE.f_goto:..1cvf("GOTO");.ENDCASE#0A#0A..4CASE
.f_res:..2cvf("RES");.ENDCASE..1//.res>.:#3D.A#0A..
4CASE.f_ldres:..cvf("LDRES");.ENDCASE.//.A.:#3D.<re
s>#0A#0A..4CASE.f_ikp:..2cvfkp("IKP");.ENDCASE#0A..
4CASE.f_ikg:..2cvfkg("IKG");.ENDCASE#0A..4CASE.f_ik
l:..2cvfkl("IKL");.ENDCASE#0A..4CASE.f_ip:..3cvfp("
IP");..1ENDCASE#0A..4CASE.f_ig:..3cvfg("IG");..1END
CASE#0A..4CASE.f_il:..3cvfl("IL");..1ENDCASE#0A#0A.
.4CASE.f_jeq:..2cvfl("JEQ");.ENDCASE#0A..4CASE.f_jn
e:..2cvfl("JNE");.ENDCASE#0A..4CASE.f_jls:..2cvfl("
JLS");.ENDCASE#0A..4CASE.f_jgr:..2cvfl("JGR");.ENDC
ASE#0A..4CASE.f_jle:..2cvfl("JLE");.ENDCASE#0A..4CA
SE.f_jge:..2cvfl("JGE");.ENDCASE#0A#0A..4CASE.f_jeq
0:..1cvfl("JEQ0");.ENDCASE#0A..4CASE.f_jne0:..1cvfl
("JNE0");.ENDCASE#0A..4CASE.f_jls0:..1cvfl("JLS0");
.ENDCASE#0A..4CASE.f_jgr0:..1cvfl("JGR0");.ENDCASE#0A
..4CASE.f_jle0:..1cvfl("JLE0");.ENDCASE#0A..4CASE.f
_jge0:..1cvfl("JGE0");.ENDCASE#0A..4CASE.f_jge0m:..
cvfm("JGE0");.ENDCASE#0A#0A..4CASE.f_brk:..2cvf("BR
K");.ENDCASE#0A..4CASE.f_nop:..2cvf("NOP");.ENDCASE
#0A..4CASE.f_chgco:..cvf("CHGCO");.ENDCASE#0A..4CAS
E.f_mdiv:..1cvf("MDIV");.ENDCASE#0A..4CASE.f_sys:..
2cvf("SYS");.ENDCASE#0A#0A..4CASE.f_section:..cvfs(
"SECTION");.ENDCASE#0A..4CASE.f_modstart:.cvf("MODS
TART");.ENDCASE#0A..4CASE.f_modend:..1cvf("MODEND")
;.ENDCASE#0A..4CASE.f_global:..1cvglobal();.ENDCASE
#0A..4CASE.f_string:..1cvstring();.ENDCASE#0A..4CAS
E.f_const:..2cvconst();.ENDCASE#0A..4CASE.f_static:
..1cvstatic();.ENDCASE#0A..4CASE.f_mlab:..3cvfm("ML
AB");.ENDCASE#0A..4CASE.f_lab:..4cvfl("LAB");.ENDCA
SE#0A..4CASE.f_lstr:..3cvfm("LSTR");.ENDCASE#0A..4C
ASE.f_entry:..2cventry();.ENDCASE#0A#0A..4CASE.f_fl
oat:..2cvf("FLOAT");.ENDCASE#0A..4CASE.f_fix:..4cvf
("FIX");.ENDCASE#0A..4CASE.f_fabs:..3cvf("FABS");.E
NDCASE#0A#0A..4CASE.f_fmul:..3cvf("FMUL");.ENDCASE#0A
..4CASE.f_fdiv:..3cvf("FDIV");.ENDCASE#0A..4CASE.f_
fxdiv:..2cvf("FXDIV");.ENDCASE#0A..4CASE.f_fadd:..3
cvf("FADD");.ENDCASE#0A..4CASE.f_fsub:..3cvf("FSUB"
);.ENDCASE#0A..4CASE.f_fxsub:..2cvf("FXSUB");.ENDCA
SE#0A..4CASE.f_fneg:..3cvf("FNEG");.ENDCASE#0A#0A..
4CASE.f_feq:..4cvf("FEQ");.ENDCASE#0A..4CASE.f_fne:
..4cvf("FNE");.ENDCASE#0A..4CASE.f_fls:..4cvf("FLS"
);.ENDCASE#0A..4CASE.f_fgr:..4cvf("FGR");.ENDCASE#0A
..4CASE.f_fle:..4cvf("FLE");.ENDCASE#0A..4CASE.f_fg
e:..4cvf("FGE");.ENDCASE#0A#0A..4CASE.f_feq0:..2cvf
("FEQ0");.ENDCASE#0A..4CASE.f_fne0:..2cvf("FNE0");.
ENDCASE#0A..4CASE.f_fls0:..2cvf("FLS0");.ENDCASE#0A
..4CASE.f_fgr0:..2cvf("FGR0");.ENDCASE#0A..4CASE.f_
fle0:..2cvf("FLE0");.ENDCASE#0A..4CASE.f_fge0:..2cv
f("FGE0");.ENDCASE#0A#0A..4CASE.f_jfeq:..2cvfl("JFE
Q");.ENDCASE#0A..4CASE.f_jfne:..2cvfl("JFNE");.ENDC
ASE#0A..4CASE.f_jfls:..2cvfl("JFLS");.ENDCASE#0A..4
CASE.f_jfgr:..2cvfl("JFGR");.ENDCASE#0A..4CASE.f_jf
le:..2cvfl("JFLE");.ENDCASE#0A..4CASE.f_jfge:..2cvf
l("JFGE");.ENDCASE#0A#0A..4CASE.f_jfeq0:..1cvfl("JF
EQ0");.ENDCASE#0A..4CASE.f_jfne0:..1cvfl("JFNE0");.
ENDCASE#0A..4CASE.f_jfls0:..1cvfl("JFLS0");.ENDCASE
#0A..4CASE.f_jfgr0:..1cvfl("JFGR0");.ENDCASE#0A..4C
ASE.f_jfle0:..1cvfl("JFLE0");.ENDCASE#0A..4CASE.f_j
fge0:..1cvfl("JFGE0");.ENDCASE#0A..1}#0A#0A..1newli
ne()#0A}.REPEAT#0A#0AAND.cvf(s)..BE.writef(s)#0AAND
.cvfp(s).BE.writef("%t7.P%n",.s,.rdp())#0AAND.cvfkp
(s).BE.writef("%t7.K%n.P%n",.s,.rdk(),.rdp())#0AAND
.cvfg(s).BE.writef("%t7.G%n",.s,.rdg())#0AAND.cvfkg
(s).BE.writef("%t7.K%n.G%n",.s,.rdk(),.rdg())#0AAND
.cvfkl(s).BE.writef("%t7.K%n.L%n",.s,.rdk(),.rdl())
#0AAND.cvfpg(s).BE.writef("%t7.P%n.G%n",.s,.rdp(),.
rdg())#0AAND.cvfk(s).BE.writef("%t7.K%n",.s,.rdk())
#0AAND.cvfh(s).BE.writef("%t7.H%n",.s,.rdh())#0AAND
.cvfw(s).BE.writef("%t7.W%n",.s,.rdw())#0AAND.cvfl(
s).BE.writef("%t7.L%n",.s,.rdl())#0AAND.cvfm(s).BE.
writef("%t7.M%n",.s,.rdm())#0A#0AAND.cvswl().BE#0A{
.LET.n.#3D.rdk()#0A..1LET.l.#3D.rdl()#0A..1writef("
SWL.K%n.L%n",.n,.l)#0A..1FOR.i.#3D.1.TO.n.DO.writef
("*nL%n",.rdl())#0A}#0A#0AAND.cvswb().BE#0A{.LET.n.
#3D.rdk()#0A..1LET.l.#3D.rdl()#0A..1writef("SWB.K%n
.L%n",.n,.l)#0A..1FOR.i.#3D.1.TO.n.DO.#0A..1{.LET.k
.#3D.rdk()#0A..4LET.l.#3D.rdl()#0A..4writef("*nK%n.
L%n",.k,.l)#0A..1}#0A}#0A#0AAND.cvglobal().BE#0A{.L
ET.n.#3D.rdk()#0A..1writef("GLOBAL.K%n*n",.n)#0A..1
FOR.i.#3D.1.TO.n.DO#0A..1{.LET.g.#3D.rdg()#0A..4LET
.n.#3D.rdl()#0A..4writef("G%n.L%n*n",.g,.n)#0A..1}#0A
..1writef("G%n",.rdg())#0A}#0A#0AAND.cvstring().BE#0A
{.LET.lab.#3D.rdm()#0A..1LET.n.#3D.rdk()#0A..1write
f("STRING..M%n.K%n",.lab,.n)#0A..1FOR.i.#3D.1.TO.n.
DO.writef(".C%n",.rdc())#0A}#0A#0AAND.cvconst().BE#0A
{.LET.lab.#3D.rdm()#0A..1LET.w.#3D.rdw()#0A..1write
f("CONST..1M%n.W%n",.lab,.w)#0A}#0A#0AAND.cvstatic(
).BE#0A{.LET.lab.#3D.rdl()#0A..1LET.n.#3D.rdk()#0A.
.1writef("STATIC..L%n.K%n",.lab,.n)#0A..1FOR.i.#3D.
1.TO.n.DO.writef(".W%n",.rdw())#0A}#0A#0AAND.cvfs(s
).BE#0A{.LET.n.#3D.rdk()#0A..1writef("%t7.K%n",.s,.
n)#0A..1FOR.i.#3D.1.TO.n.DO.writef(".C%n",.rdc())#0A
}#0A#0AAND.cventry().BE#0A{.LET.n.#3D.rdk()#0A..1LE
T.v.#3D.VEC.256#0A..1v%0.:#3D.n#0A..1FOR.i.#3D.1.TO
.n.DO.v%i.:#3D.rdc()#0A..1writef("*n//Entry.to:.%s*
n",.v)#0A..1writef("%t7.K%n",."ENTRY",.n)#0A..1FOR.
i.#3D.1.TO.n.DO.writef(".C%n",.v%i)#0A}#0A

######com/sial-vax.b#
/*#0AThis.is.an.sial.to.vax.code.generator#0Aimplem
ented.by.Martin.Richards.(c).7.August.2000009#0A#0A
Vax.register.usage#0A#0AR11..1G,.m/c.address.of.glo
bal.0#0AR10..1P,.m/c.address.of.the.current.functio
n.stack.frame#0AR9..2#3D0.(to.simplify.indirection.
and.logical.right.shift)#0AR8..2Sial.A.register#0AR
7..2Sial.B.register#0AR6..2Sial.C.register#0AR2..2F
unction.entry.point.at.time.of.call#0AR1..2P.pointe
r.increment#0A#0A1P.stack.frame#0A#0A#2E#2E1..1<old
.P>.<return.address>.<entry.address>.<arg.1>.#2E#2E
1#0A..6^#0A..6|#0A..6P.(#3DR10)#0A#0ASP.stack.frame
.on.entry.to.a.BCPL.function#0A#0A..4<return.addres
s>..#2E#2E1#0A..5^#0A..5|#0A..5SP#0A#0ABCPL.Calling
.sequence#0A#0A..2KPG.k.n..2#3D>..4First.argument,.
if.any,.in.A.(R8)#0A..21MOVL..0004*n(R11),R2..4;.R2
.:#3D.G!n#0A..21MOVAL.4*k(R10),R1..4;.R1.:#3D.<new.
P>#0A..21JSB..1(R2)..11;.J.to.function#0A#0A1..2ENT
RY.n.Lm.C1.#2E#2E1.Cn.#3D>#0A..44;.first.arg,.if.an
y,.in.A.(#3DR8)#0A..44;.sp!0.#3D.<return.address>#0A
..21MOVL.R10,(R1)..8;.push.<old.P>#0A..21MOVL.R1,R1
0..10;.P.:#3D.<new.P>#0A..21MOVL.(SP)+,4*1(R10)..2;
.save.<return.address>#0A..21MOVL.R2,4*2(R10)..5;.s
ave.<entry.address>#0A..21MOVL.R8,4*3(R10)..5;.Stor
e.first.arg,.if.any#0A..44;.Other.args.in.P!1,.P!2,
.#2E#2E1#0A#0A..2RTN..3#3D>..7MOVL.4(R10),R2..7;.R2
.#3D.<return.address>#0A..21MOVL.(R10),R10..7;.P.:#3D
.<old.P>#0A..21JMP.(R2)..13;.Jump.to.<return.addres
s>#0A#0A1*/#0A#0ASECTION."sial-vax"#0A#0AGET."libhd
r"#0AGET."sial#2Eh"#0A#0AGLOBAL.{#0Asialin:ug#0Aasm
out#0Astdin#0Astdout#0Amodstarted#0A#0Ardf;.rdp;.rd
g;.rdk;.rdw;.rdl;.rdc#0Ardcode#0A#0Apval;.gval;.kva
l;.wval;.lval;.mval#0A#0Ascan#0Acvf;.cvfp;.cvfg;.cv
fk;.cvfw;.cvfl#0A#0Asectname;.modletter;.charv;.lab
number#0A}#0A#0ALET.start().#3D.VALOF#0A{.LET.argv.
#3D.VEC.20#0A..LET.v..2#3D.VEC.20#0A..LET.cv..1#3D.
VEC.256/bytesperword#0A#0A..sectname.:#3D.v#0A..sec
tname%0.:#3D.0#0A..modstarted.:#3D.FALSE#0A#0A..mod
letter.:#3D.'A'#0A..charv.:#3D.cv#0A..labnumber.:#3D
.0#0A#0A..asmout.:#3D.0#0A..stdout.:#3D.output()#0A
..IF.rdargs("FROM,TO/K",.argv,.20)#3D0.DO#0A..{.wri
tes("Bad.args.for.sial-vax*n")#0A..2RESULTIS.20#0A.
.}#0A..IF.argv!0#3D0.DO.argv!0.:#3D."prog#2Esial"#0A
..IF.argv!1#3D0.DO.argv!1.:#3D."prog#2Emar"#0A..sia
lin.:#3D.findinput(argv!0)#0A..IF.sialin#3D0.DO#0A.
.{.writef("Trouble.with.file.%s*n",.argv!0)#0A..2RE
SULTIS.20#0A..}#0A..asmout.:#3D.findoutput(argv!1)#0A
..1#0A..UNLESS.asmout.DO#0A..{.writef("Trouble.with
.file.%s*n",.argv!1)#0A..3RESULTIS.20#0A..}#0A..1#0A
..writef("Converting.%s.to.%s*n",.argv!0,.argv!1)#0A
..selectinput(sialin)#0A..selectoutput(asmout)#0A#0A
..writef(";.Code.generated.by.sial-vax*n*n")#0A#0A.
.scan()#0A..endread()#0A..UNLESS.asmout#3Dstdout.DO
.endwrite()#0A..selectoutput(stdout)#0A..writef("Co
nversion.complete*n")#0A..RESULTIS.0#0A}#0A#0AAND.n
extlab().#3D.VALOF#0A{.labnumber.:#3D.labnumber+1#0A
..RESULTIS.labnumber#0A}#0A#0A//.argument.may.be.of
.form.Ln#0AAND.rdcode(let).#3D.VALOF#0A{.LET.a,.ch,
.neg.#3D.0,.?,.FALSE#0A#0A..ch.:#3D.rdch().REPEATWH
ILE.ch#3D'*s'.|.ch#3D'*n'#0A#0A..IF.ch#3Dendstreamc
h.RESULTIS.-1#0A#0A..UNLESS.ch#3Dlet.DO.error("Bad.
item,.looking.for.%c.found.%c*n",.let,.ch)#0A#0A..c
h.:#3D.rdch()#0A#0A..IF.ch#3D'-'.DO.{.neg.:#3D.TRUE
;.ch.:#3D.rdch().}#0A#0A..WHILE.'0'<#3Dch<#3D'9'.DO
.{.a.:#3D.10*a.+.ch.-.'0';.ch.:#3D.rdch()..}#0A#0A.
.RESULTIS.neg.->.-a,.a#0A}#0A#0AAND.rdf().#3D.rdcod
e('F')#0AAND.rdp().#3D.VALOF.{.pval.:#3D.rdcode('P'
);.RESULTIS.pval.}#0AAND.rdg().#3D.VALOF.{.gval.:#3D
.rdcode('G');.RESULTIS.gval.}#0AAND.rdk().#3D.VALOF
.{.kval.:#3D.rdcode('K');.RESULTIS.kval.}#0AAND.rdw
().#3D.VALOF.{.wval.:#3D.rdcode('W');.RESULTIS.wval
.}#0AAND.rdl().#3D.VALOF.{.lval.:#3D.rdcode('L');.R
ESULTIS.lval.}#0AAND.rdm().#3D.VALOF.{.mval.:#3D.rd
code('M');.RESULTIS.mval.}#0AAND.rdc().#3D.rdcode('
C')#0A#0AAND.error(mess,.a,.b,.c).BE#0A{.LET.out.#3D
.output()#0A..UNLESS.out#3Dstdout.DO#0A..{.selectou
tput(stdout)#0A..2writef(mess,.a,.b,.c)#0A..2select
output(out)#0A..}#0A..writef(mess,.a,.b,.c)#0A}#0A#0A
AND.scan().BE#0A{.LET.op.#3D.rdf()#0A#0A..IF.op#3D-
1.RETURN.//.EOF.reached#0A#0A..UNLESS.modstarted.DO
#0A..{.WHILE.op#3Df_section.|.op#3Df_modstart.TEST.
op#3Df_section#0A..2THEN.{.cvfs("SECTION").//.Name.
of.section#0A..9FOR.i.#3D.0.TO.charv%0.DO.sectname%
i.:#3D.charv%i#0A..9op.:#3D.rdf()#0A..7}#0A..2ELSE.
{.cvf("MODSTART").//.Start.of.module#0A..9op.:#3D.r
df()#0A..7}#0A#0A..2//.If.there.is.no.section.name.
this.module.is.called.MAIN#0A..2IF.sectname%0#3D0.D
O#0A..2{.LET.s.#3D."MAIN"#0A..4FOR.i.#3D.0.TO.s%0.D
O.sectname%i.:#3D.s%i#0A..2}#0A#0A..2writef("*n.#2E
PSECT.%s,LONG",.sectname)#0A..2writef("*n.#2ETITLE.
%s.generated.by.sial-vax",.sectname)#0A..2writef("*
n;%s::",.sectname)#0A..2writef("*n.#2ELONG.L1001")#0A
..2modstarted.:#3D.TRUE#0A..}#0A#0A..SWITCHON.op.IN
TO#0A#0A..{.DEFAULT:..5error(";.Bad.op.%n*n",.op);.
LOOP#0A#0A..2CASE.-1:..5RETURN#0A..4#0A..2CASE.f_lp
:..3cvfp("LP").//.a.:#3D.P!n#0A..17writef("*n.MOVL.
%n(R10),R8",.4*pval)#0A..17ENDCASE#0A..2CASE.f_lg:.
.3cvfg("LG").//.a.:#3D.G!n#0A..17writef("*n.MOVL.%n
(R11),R8",.4*gval)#0A..17ENDCASE#0A..2CASE.f_ll:..3
cvfl("LL").//.a.:#3D.!Ln#0A..17writef("*n.MOVL.L%n,
R8",.lval)#0A..17ENDCASE#0A#0A..2CASE.f_llp:..2cvfp
("LLP").//.a.:#3D.@.P!n#0A..17writef("*n.MOVAL.%n(R
10),R8",.4*pval)#0A..17writef("*n.DIVL2.#234,R8")#0A
..17ENDCASE#0A..2CASE.f_llg:..2cvfg("LLG").//.a.:#3D
.@.G!n#0A..17writef("*n.MOVAL.%n(R11),R8",.4*gval)#0A
..17writef("*n.DIVL2.#234,R8")#0A..17ENDCASE#0A..2C
ASE.f_ll1:..2cvfl("LL1").//.a.:#3D.@.!Ln#0A..17writ
ef("*n.MOVAL.L%n,R8",.lval)#0A..17writef("*n.DIVL2.
#234,R8")#0A..17ENDCASE#0A..2CASE.f_lf:..3cvfl("LF"
).//.a.:#3D.byte.address.of.Ln#0A..17writef("*n.MOV
AL.L%n,R8",.lval)#0A..17ENDCASE#0A..2CASE.f_lw:..3c
vfm("LW")#0A..17writef("*n.MOVL.L%n,R8",.mval+1002)
#0A..17ENDCASE#0A#0A..2CASE.f_l:..4cvfk("L").//.a.:
#3D.n#0A..17IF.kval#3D0.DO.{.writef("*n.CLRL.R8");.
ENDCASE.}#0A..17writef("*n.MOVL.#23%n,R8",.kval)#0A
..17ENDCASE#0A..2CASE.f_lm:..3cvfk("LM").//.a.:#3D.
-n#0A..17writef("*n.MOVL.#23-%n,R8",.kval)#0A..17EN
DCASE#0A#0A..2CASE.f_sp:..3cvfp("SP").//.P!n.:#3D.a
#0A..17writef("*n.MOVL.R8,%n(R10)",.4*pval)#0A..17E
NDCASE#0A..2CASE.f_sg:..3cvfg("SG").//.G!n.:#3D.a#0A
..17writef("*n.MOVL.R8,%n(R11)",.4*gval)#0A..17ENDC
ASE#0A..2CASE.f_sl:..3cvfl("SL").//.!Ln.:#3D.a#0A..
17writef("*n.MOVL.R8,L%n",.lval)#0A..17ENDCASE#0A#0A
..2CASE.f_ap:..3cvfp("AP").//.a.:#3D.a.+.P!n#0A..17
writef("*n.ADDL2.%n(R10),R8",.4*pval)#0A..17ENDCASE
#0A..2CASE.f_ag:..3cvfg("AG").//.a.:#3D.a.+.G!n#0A.
.17writef("*n.ADDL2.%n(R11),R8",.4*gval)#0A..17ENDC
ASE#0A..2CASE.f_a:..4cvfk("A").//.a.:#3D.a.+.n#0A..
17IF.kval#3D0.ENDCASE#0A..17IF.kval#3D1..DO.{.write
f("*n.INCL.R8");.ENDCASE.}#0A..17IF.kval#3D-1.DO.{.
writef("*n.DECL.R8");.ENDCASE.}#0A..17writef("*n.AD
DL2.#23%n,R8",.kval)#0A..17ENDCASE#0A..2CASE.f_s:..
4cvfk("S")..//.a.:#3D.a.-.k#0A..17IF.kval#3D0.ENDCA
SE#0A..17IF.kval#3D1..DO.{.writef("*n.DECL.R8");.EN
DCASE.}#0A..17IF.kval#3D-1.DO.{.writef("*n.INCL.R8"
);.ENDCASE.}#0A..17writef("*n.SUBL2.#23%n,R8",.kval
)#0A..17ENDCASE#0A#0A..2CASE.f_lkp:..2cvfkp("LKP").
//.a.:#3D.P!n!k#0A..17writef("*n.MOVL.%n(R10),R1",.
4*pval)#0A..17writef("*n.MOVL.%n(R9)[R1],R8",.4*kva
l)#0A..17ENDCASE#0A..2CASE.f_lkg:..2cvfkg("LKG").//
.a.:#3D.G!n!k#0A..17writef("*n.MOVL.%n(R11),R1",.4*
gval)#0A..17writef("*n.MOVL.%n(R9)[R1],R8",.4*kval)
#0A..17ENDCASE#0A..2CASE.f_rv:..3cvf("RV")..//.a.:#3D
.!.a#0A..17writef("*n.MOVL.(R9)[R8],R8")#0A..17ENDC
ASE#0A..2CASE.f_rvp:..2cvfp("RVP").//.a.:#3D.P!n!a#0A
..17writef("*n.ADDL2.%n(R10),R8",.4*pval)#0A..17wri
tef("*n.MOVL.(R9)[R8],R8")#0A..17ENDCASE#0A..2CASE.
f_rvk:..2cvfk("RVK").//.a.:#3D.a!k#0A..17writef("*n
.MOVL.%n(R9)[R8],R8",.4*kval)#0A..17ENDCASE#0A..2CA
SE.f_st:..3cvf("ST").//.!a.:#3D.b#0A..17writef("*n.
MOVL.R7,(R9)[R8]")#0A..17ENDCASE#0A..2CASE.f_stp:..
2cvfp("STP").//.P!n!a.:#3D.b#0A..17writef("*n.MOVL.
%n(R10),R1",.4*pval)#0A..17writef("*n.ADDL2.R8,R1")
#0A..17writef("*n.MOVL.R7,(R9)[R1]")#0A..17ENDCASE#0A
..2CASE.f_stk:..2cvfk("STK").//.a!k.:#3D.b#0A..17wr
itef("*n.MOVL.R7,%n(R9)[R8]",.4*kval)#0A..17ENDCASE
#0A..2CASE.f_stkp:..1cvfkp("STKP")..//.P!n!k.:#3D.a
#0A..17writef("*n.MOVL.%n(R10),R1",.4*pval)#0A..17w
ritef("*n.MOVL.R8,%n(R9)[R1]",.4*kval)#0A..17ENDCAS
E#0A..2CASE.f_skg:..2cvfkg("SKG").//.G!n!k.:#3D.a#0A
..17writef("*n.MOVL.%n(R11),R1",.4*gval)#0A..17writ
ef("*n.MOVL.R8,%n(R9)[R1]",.4*kval)#0A..17ENDCASE#0A
..2CASE.f_xst:..2cvf("XST").//.!b.:#3D.a#0A..17writ
ef("*n.MOVL.R8,(R9)[R7]")#0A..17ENDCASE#0A#0A..2CAS
E.f_k:..4cvfp("K").//.Call..a(b,#2E#2E1).incrementi
ng.P.by.n#0A..17writef("*n.MOVL.R8,R2")..1//.R2.#3D
.<entry.point>#0A..17writef("*n.MOVL.R7,R8")..1//.R
8.#3D.<first.arg>,.if.any#0A..17writef("*n.MOVAL.%n
(R10),R1",.4*pval).//.R1.#3D.<new.P>#0A..17writef("
*n.JSB.(R2)")..3//.Subroutine.jump#0A..17ENDCASE#0A
#0A..2CASE.f_kpg:..2cvfpg("KPG").//.Call.Gg(a,#2E#2E
1).incrementing.P.by.k#0A..17writef("*n.MOVL.%n(R11
),R2",.4*gval)#0A..17writef("*n.MOVAL.%n(R10),R1",.
4*pval)#0A..17writef("*n.JSB.(R2)")#0A..17ENDCASE#0A
#0A..2CASE.f_neg:..2cvf("NEG").//.a.:#3D.-.a#0A..17
writef("*n.MNEGL.R8,R8").#0A..17ENDCASE#0A..2CASE.f
_not:..2cvf("NOT").//.a.:#3D.~.a#0A..17writef("*n.M
COML.R8,R8").#0A..17ENDCASE#0A..2CASE.f_abs:..2cvf(
"ABS").//.a.:#3D.ABS.a#0A..15{.LET.lab.#3D.nextlab(
)#0A..17writef("*n.TSTL..R8")#0A..17writef("*n.BGEQ
..X%n",.lab)#0A..17writef("*n.MNEGL.R8,R8")#0A..17w
ritef("*nX%n:",.lab)#0A..17ENDCASE#0A..15}#0A#0A..2
CASE.f_xdiv:..1cvf("XDIV").//.a.:#3D.a./.b#0A..17wr
itef("*n.DIVL2.R7,R8")#0A..17ENDCASE#0A..2CASE.f_xr
em:..1cvf("XREM").//.a.:#3D.a.REM.b#0A..17writef("*
n.MOVL..R8,R3")#0A..17writef("*n.ASHQ..#23-32,R2,R2
")#0A..17writef("*n.EDIV..R7,R2,R8,R4")#0A..17write
f("*n.MOVL..R4,R8")#0A..17ENDCASE#0A..2CASE.f_xsub:
..1cvf("XSUB").//.a.:#3D..a.-.b#0A..17writef("*n.SU
BL2.R7,R8")#0A..17ENDCASE#0A#0A..2CASE.f_mul:..2cvf
("MUL").//.a.:#3D.b.*.a;.c.:#3D.?#0A..17writef("*n.
MULL0002.R7,R8")#0A..17ENDCASE#0A..2CASE.f_div:..2c
vf("DIV")..//.a.:#3D.b./.a;.c.:#3D.?#0A..17writef("
*n.DIVL3..R8,R7,R8")#0A..17ENDCASE#0A..2CASE.f_rem:
..2cvf("REM").//.a.:#3D.b.REM.a;.c.:#3D.?#0A..17wri
tef("*n.MOVL..R7,R3")#0A..17writef("*n.ASHQ..#23-32
,R2,R2")#0A..17writef("*n.EDIV..R8,R2,R7,R4")#0A..1
7writef("*n.MOVL..R4,R8")#0A..17ENDCASE#0A..2CASE.f
_add:..2cvf("ADD").//.a.:#3D.b.+.a#0A..17writef("*n
.ADDL2.R7,R8")#0A..17ENDCASE#0A..2CASE.f_sub:..2cvf
("SUB").//.a.:#3D.b.-.a#0A..17writef("*n.SUBL3.R8,R
7,R8")#0A..17ENDCASE#0A#0A..2CASE.f_eq:..3cvf("EQ")
.//.a.:#3D.b.#3D.a#0A..15{.LET.lab.#3D.nextlab()#0A
..17writef("*n.CLRL.R4")#0A..17writef("*n.CMPL.R7,R
8")#0A..18writef("*n.BNEQ.X%n",.lab)#0A..18writef("
*n.DECL.R4")#0A..18writef("*nX%n:",.lab)#0A..17writ
ef("*n.MOVL.R4,R8")#0A..17ENDCASE#0A..15}#0A..2CASE
.f_ne:..3cvf("NE").//.a.:#3D.b.~#3D.a#0A..15{.LET.l
ab.#3D.nextlab()#0A..17writef("*n.CLRL.R4")#0A..17w
ritef("*n.CMPL.R7,R8")#0A..17writef("*n.BEQL.X%n",.
lab)#0A..17writef("*n.DECL.R4")#0A..17writef("*nX%n
:",.lab)#0A..17writef("*n.MOVL.R4,R8")#0A..17ENDCAS
E#0A..15}#0A..2CASE.f_ls:..3cvf("LS").//.a.:#3D.b.<
.a#0A..15{.LET.lab.#3D.nextlab()#0A..17writef("*n.C
LRL.R4")#0A..17writef("*n.CMPL.R7,R8")#0A..17writef
("*n.BGEQ.X%n",.lab)#0A..17writef("*n.DECL.R4")#0A.
.17writef("*nX%n:",.lab)#0A..17writef("*n.MOVL.R4,R
8")#0A..17ENDCASE#0A..15}#0A..2CASE.f_gr:..3cvf("GR
").//.a.:#3D.b.>.a#0A..15{.LET.lab.#3D.nextlab()#0A
..17writef("*n.CLRL.R4")#0A..17writef("*n.CMPL.R7,R
8")#0A..17writef("*n.BLEQ.X%n",.lab)#0A..17writef("
*n.DECL.R4")#0A..17writef("*nX%n:",.lab)#0A..17writ
ef("*n.MOVL.R4,R8")#0A..17ENDCASE#0A..15}#0A..2CASE
.f_le:..3cvf("LE").//.a.:#3D.b.<#3D.a#0A..15{.LET.l
ab.#3D.nextlab()#0A..17writef("*n.CLRL.R4")#0A..17w
ritef("*n.CMPL.R7,R8")#0A..17writef("*n.BGTR.X%n",.
lab)#0A..17writef("*n.DECL.R4")#0A..17writef("*nX%n
:",.lab)#0A..17writef("*n.MOVL.R4,R8")#0A..17ENDCAS
E#0A..15}#0A..2CASE.f_ge:..3cvf("GE").//.a.:#3D.b.>
#3D.a#0A..15{.LET.lab.#3D.nextlab()#0A..17writef("*
n.CLRL.R4")#0A..17writef("*n.CMPL.R7,R8")#0A..17wri
tef("*n.BLSS.X%n",.lab)#0A..17writef("*n.DECL.R4")#0A
..17writef("*nX%n:",.lab)#0A..17writef("*n.MOVL.R4,
R8")#0A..17ENDCASE#0A..15}#0A..2CASE.f_eq0:..2cvf("
EQ0").//.a.:#3D.a.#3D.0#0A..15{.LET.lab.#3D.nextlab
()#0A..17writef("*n.CLRL.R4")#0A..17writef("*n.TSTL
.R8")#0A..17writef("*n.BNEQ.X%n",.lab)#0A..17writef
("*n.DECL.R4")#0A..17writef("*nX%n:",.lab)#0A..17wr
itef("*n.MOVL.R4,R8")#0A..17ENDCASE#0A..15}#0A..2CA
SE.f_ne0:..2cvf("NE0").//.a.:#3D.a.~#3D.0#0A..15{.L
ET.lab.#3D.nextlab()#0A..17writef("*n.CLRL.R4")#0A.
.17writef("*n.TSTL.R8")#0A..17writef("*n.BEQL.X%n",
.lab)#0A..17writef("*n.DECL.R4")#0A..17writef("*nX%
n:",.lab)#0A..17writef("*n.MOVL.R4,R8")#0A..17ENDCA
SE#0A..15}#0A..2CASE.f_ls0:..2cvf("LS0").//.a.:#3D.
a.<.0#0A..17writef("*n.ASHL.#23-32,R8,R8")#0A..17EN
DCASE#0A..2CASE.f_gr0:..2cvf("GR0").//.a.:#3D.a.>.0
#0A..17writef("*n.SUBL3.#231,R8,R4")#0A..17writef("
*n.BISL2.R8,R4")#0A..17writef("*n.ASHL.#23-32,R4,R8
")#0A..17writef("*n.MCOML.R8,R8")#0A..17ENDCASE#0A.
.2CASE.f_le0:..2cvf("LE0").//.a.:#3D.a.<#3D.0#0A..1
7writef("*n.SUBL3.#231,R8,R4")#0A..17writef("*n.BIS
L2.R8,R4")#0A..17writef("*n.ASHL.#23-32,R4,R8")#0A.
.17ENDCASE#0A..2CASE.f_ge0:..2cvf("GE0").//.a.:#3D.
a.>#3D.0#0A..17writef("*n.ASHL.#23-32,R8,R8")#0A..1
7writef("*n.MCOML.R8,R8")#0A..17ENDCASE#0A#0A..2CAS
E.f_lsh:..2cvf("LSH").//.a.:#3D.b.<<.a;.b.:#3D.?#0A
..17writef("*n.ASHL.R8,R7,R8")#0A..17ENDCASE#0A..2C
ASE.f_rsh:..2cvf("RSH").//.a.:#3D.b.>>.a;.b.:#3D.?#0A
..17writef("*n.MNEGL.R8,R4")#0A..17writef("*n.MOVL.
R7,R8")#0A..17writef("*n.ASHQ.R4,R8,R8")#0A..17ENDC
ASE#0A..2CASE.f_and:..2cvf("AND").//.a.:#3D.b.&.a#0A
..17writef("*n.MCOML.R7,R1").#0A..17writef("*n.BICL
2.R1,R8").#0A..17ENDCASE#0A..2CASE.f_or:..3cvf("OR"
).//.a.:#3D.b.|.a.#0A..17writef("*n.BISL2.R7,R8").#0A
..17ENDCASE#0A..2CASE.f_xor:..2cvf("XOR").//.a.:#3D
.b.NEQV.a#0A..17writef("*n.XORL2.R7,R8").#0A..17END
CASE#0A..2CASE.f_eqv:..2cvf("EQV").//.a.:#3D.b.EQV.
a.#0A..17writef("*n.XORL2.R7,R8").#0A..17writef("*n
.MCOML.R8,R8").#0A..17ENDCASE#0A#0A..2CASE.f_gbyt:.
.1cvf("GBYT").//.a.:#3D.b.%.a#0A..17writef("*n.MULL
0003.#234,R7,R4").#0A..17writef("*n.MOVZBL.(R4)[R8]
,R8").#0A..17ENDCASE#0A..2CASE.f_xgbyt:..cvf("XGBYT
").//.a.:#3D.a.%.b.#0A..17writef("*n.MULL0003.#234,
R8,R4").#0A..17writef("*n.MOVZBL.(R4)[R7],R8").#0A.
.17ENDCASE#0A..2CASE.f_pbyt:..1cvf("PBYT").//.b.%.a
.:#3D.c#0A..17writef("*n.MULL0003.#234,R7,R4").#0A.
.17writef("*n.MOVB.R6,(R4)[R8]").#0A..17ENDCASE#0A.
.2CASE.f_xpbyt:..cvf("XPBYT").//.a.%.b.:#3D.c.#0A..
17writef("*n.MULL0003.#234,R8,R4").#0A..17writef("*
n.MOVB.R6,(R4)[R7]").#0A..17ENDCASE#0A#0A//.swb..5K
n.Ld.K1.L1.#2E#2E1.Kn.Ln..1Binary.chop.switch,.Ld.d
efault#0A..2CASE.f_swb:..2cvswb()#0A..17ENDCASE#0A#0A
//.swl..5Kn.Ld.L1.#2E#2E1.Ln..7Label.vector.switch,
.Ld.default#0A..2CASE.f_swl:..2cvswl()#0A..17ENDCAS
E#0A#0A..2CASE.f_xch:..2cvf("XCH").//.swap.a.and.b#0A
..17writef("*n.MOVL.R8,R4")#0A..17writef("*n.MOVL.R
7,R8")#0A..17writef("*n.MOVL.R4,R7")#0A..17ENDCASE#0A
..2CASE.f_atb:..2cvf("ATB").//.b.:#3D.a#0A..17write
f("*n.MOVL.R8,R7")#0A..17ENDCASE#0A..2CASE.f_atc:..
2cvf("ATC").//.c.:#3D.a#0A..17writef("*n.MOVL.R8,R6
")#0A..17ENDCASE#0A..2CASE.f_bta:..2cvf("BTA").//.a
.:#3D.b#0A..17writef("*n.MOVL.R7,R8")#0A..17ENDCASE
#0A..2CASE.f_btc:..2cvf("BTC").//.c.:#3D.b#0A..17wr
itef("*n.MOVL.R7,R6")#0A..17ENDCASE#0A..2CASE.f_atb
lp:..cvfp("ATBLP").//.b.:#3D.a;.a.:#3D.P!n#0A..17wr
itef("*n.MOVL.R8,R7")#0A..17writef("*n.MOVL.%n(R10)
,R8",.4*pval)#0A..17ENDCASE#0A..2CASE.f_atblg:..cvf
g("ATBLG").//.b.:#3D.a;.a.:#3D.G!n#0A..17writef("*n
.MOVL.R8,R7")#0A..17writef("*n.MOVL.%n(R11),R8",.4*
gval)#0A..17ENDCASE#0A..2CASE.f_atbl:..1cvfk("ATBL"
).//.b.:#3D.a;.a.:#3D.k#0A..17writef("*n.MOVL.R8,R7
")#0A..17writef("*n.MOVL.#23%n,R8",.kval)#0A..17END
CASE#0A#0A..2CASE.f_j:..4cvfl("J").//.jump.to.Ln#0A
..17writef("*n.JMP.L%n",.lval)#0A..17ENDCASE#0A..2C
ASE.f_rtn:..2cvf("RTN").//.procedure.return#0A..17w
ritef("*n.MOVL.4(R10),R2")..//.R2.#3D.<return.addre
ss>#0A..17writef("*n.MOVL.(R10),R10")..//.P.:#3D.ol
d.P#0A..17writef("*n.JMP.(R2)")..6//.Jump.to.<retur
n.address>#0A..17ENDCASE#0A#0A..2CASE.f_goto:..1cvf
("GOTO").//.jump.to.a#0A..17writef("*n.JMP.(R8)")#0A
..17ENDCASE#0A#0A..2CASE.f_res:..2cvf("RES")..1//.<
res>.:#3D.A#0A..30//.<res>.is.already.in.A#0A..30//
.nothing.to.do#0A..17ENDCASE#0A#0A..2CASE.f_ldres:.
.cvf("LSRES").//.A.:#3D.<res>#0A..30//.A.and.B.alre
ady.set.properly#0A..17ENDCASE#0A#0A..2CASE.f_ikp:.
.2cvfkp("IKP").//.a.:#3D.P!n.+.k;.P!n.:#3D.a#0A..17
writef("*n.MOVL.%n(R10),R8",.4*pval)#0A..17TEST.kva
l#3D1#0A..17THEN.writef("*n.INCL.R8")#0A..17ELSE.TE
ST.kval#3D-1#0A..22THEN.writef("*n.DECL.R8")#0A..22
ELSE.writef("*n.ADDL2.#23%n,R8",.kval)#0A..17writef
("*n.MOVL.R8,%n(R10)",.4*pval)#0A..17ENDCASE#0A..2C
ASE.f_ikg:..2cvfkg("IKG").//.a.:#3D.G!n.+.k;.G!n.:#3D
.a#0A..17writef("*n.MOVL.%n(R11),R8",.4*gval)#0A..1
7TEST.kval#3D1#0A..17THEN.writef("*n.INCL.R8")#0A..
17ELSE.TEST.kval#3D-1#0A..22THEN.writef("*n.DECL.R8
")#0A..22ELSE.writef("*n.ADDL2.#23%n,R8",.kval)#0A.
.17writef("*n.MOVL.R8,%n(R11)",.4*gval)#0A..17ENDCA
SE#0A..2CASE.f_ikl:..2cvfkl("IKL").//.a.:#3D.!Ln.+.
k;.!Ln.:#3D.a#0A..17writef("*n.MOVL.L%n,R8",.lval)#0A
..17TEST.kval#3D1#0A..17THEN.writef("*n.INCL.R8")#0A
..17ELSE.TEST.kval#3D-1#0A..22THEN.writef("*n.DECL.
R8")#0A..22ELSE.writef("*n.ADDL2.#23%n,R8",.kval)#0A
..17writef("*n.MOVL.R8,L%n",.lval)#0A..17ENDCASE#0A
..2CASE.f_ip:..3cvfp("IP").//.a.:#3D.P!n.+.a;.P!n.:
#3D.a#0A..17writef("*n.ADDL2.%n(R10),R8",.4*pval)#0A
..17writef("*n.MOVL.R8,%n(R10)",.4*pval)#0A..17ENDC
ASE#0A..2CASE.f_ig:..3cvfg("IG").//.a.:#3D.G!n.+.a;
.G!n.:#3D.a#0A..17writef("*n.ADDL2.%n(R11),R8",.4*g
val)#0A..17writef("*n.MOVL.R8,%n(R11)",.4*gval)#0A.
.17ENDCASE#0A..2CASE.f_il:..3cvfl("IL").//.a.:#3D.!
Ln.+.a;.!Ln.:#3D.a#0A..17writef("*n.ADDL2.L%n,R8",.
lval)#0A..17writef("*n.MOVL.R8,L%n",.lval)#0A..17EN
DCASE#0A#0A..2CASE.f_jeq:..2cvfl("JEQ").//.Jump.to.
Ln.if.b.#3D.a#0A..17writef("*n.CMPL.R7,R8")#0A..17g
enBEQL(lval)#0A..17ENDCASE#0A..2CASE.f_jne:..2cvfl(
"JNE").//.Jump.to.Ln.if.b.~#3D.a#0A..17writef("*n.C
MPL.R7,R8")#0A..17genBNEQ(lval)#0A..17ENDCASE#0A..2
CASE.f_jls:..2cvfl("JLS").//.Jump.to.Ln.if.b.<.a#0A
..17writef("*n.CMPL.R7,R8")#0A..17genBLSS(lval)#0A.
.17ENDCASE#0A..2CASE.f_jgr:..2cvfl("JGR").//.Jump.t
o.Ln.if.b.>.a#0A..17writef("*n.CMPL.R7,R8")#0A..17g
enBGTR(lval)#0A..17ENDCASE#0A..2CASE.f_jle:..2cvfl(
"JLE").//.Jump.to.Ln.if.b.<#3D.a#0A..17writef("*n.C
MPL.R7,R8")#0A..17genBLEQ(lval)#0A..17ENDCASE#0A..2
CASE.f_jge:..2cvfl("JGE").//.Jump.to.Ln.if.b.>#3D.a
#0A..17writef("*n.CMPL.R7,R8")#0A..17genBGEQ(lval)#0A
..17ENDCASE#0A#0A..2CASE.f_jeq0:..1cvfl("JEQ0").//.
Jump.to.Ln.if.a.#3D.0#0A..17writef("*n.TSTL.R8")#0A
..17genBEQL(lval)#0A..17ENDCASE#0A..2CASE.f_jne0:..
1cvfl("JNE0").//.Jump.to.Ln.if.a.~#3D.0#0A..17write
f("*n.TSTL.R8")#0A..17genBNEQ(lval)#0A..17ENDCASE#0A
..2CASE.f_jls0:..1cvfl("JLS0").//.Jump.to.Ln.if.a.<
.0#0A..17writef("*n.TSTL.R8")#0A..17genBLSS(lval)#0A
..17ENDCASE#0A..2CASE.f_jgr0:..1cvfl("JGR0").//.Jum
p.to.Ln.if.a.>.0#0A..17writef("*n.TSTL.R8")#0A..17g
enBGTR(lval)#0A..17ENDCASE#0A..2CASE.f_jle0:..1cvfl
("JLE0").//.Jump.to.Ln.if.a.<#3D.0#0A..17writef("*n
.TSTL.R8")#0A..17genBLEQ(lval)#0A..17ENDCASE#0A..2C
ASE.f_jge0:..1cvfl("JGE0").//.Jump.to.Ln.if.a.>#3D.
0#0A..17writef("*n.TSTL.R8")#0A..17genBGEQ(lval)#0A
..17ENDCASE#0A..2CASE.f_jge0m:..cvfm("JGE0M").//.Ju
mp.to.Mn.if.a.>#3D.0#0A..17writef("*n.TSTL.R8")#0A.
.17genBGEQ(mval+1002)#0A..17ENDCASE#0A#0A..2//.The.
following.five.opcodes.are.never.generated.by#0A..2
//.the.BCPL.compiler#0A..2CASE.f_brk:..2cvf("BRK").
//.Breakpoint.instruction#0A..17writef("*n.unimplem
ented")#0A..17ENDCASE#0A..2CASE.f_nop:..2cvf("NOP")
.//.No.operation#0A..17ENDCASE#0A..2CASE.f_chgco:..
cvf("CHGCO").//.Change.coroutine#0A..17writef("*n.u
nimplemented")#0A..17ENDCASE#0A..2CASE.f_mdiv:..1cv
f("MDIV").//.a.:#3D.Muldiv(P!3,.P!4,.P!5).#0A..17wr
itef("*n.unimplemented")#0A..17ENDCASE#0A..2CASE.f_
sys:..2cvf("SYS").//.System.function#0A..17writef("
*n.unimplemented")#0A..17ENDCASE#0A#0A..2CASE.f_mod
end:..1cvf("MODEND").//.End.of.module#0A..19writef(
"*nL1001:").#0A..19writef("*n.#2EEND*n").#0A..19mod
letter.:#3D.modletter+1#0A..19modstarted.:#3D.FALSE
#0A..19ENDCASE#0A..2CASE.f_global:..1cvglobal().//.
Global.initialisation.data#0A..19ENDCASE#0A..2CASE.
f_string:..1cvstring().//.String.constant#0A..19END
CASE#0A..2CASE.f_const:..2cvconst().//.Large.intege
r.constant#0A..19ENDCASE#0A#0A..2CASE.f_static:..1c
vstatic().//.Static.variable.or.table#0A..19ENDCASE
#0A..2CASE.f_mlab:..3cvfm("MLAB").//.Destination.of
.jge0m#0A..19writef("*nL%n:",.mval+1002)#0A..19ENDC
ASE#0A..2CASE.f_lab:..4cvfl("LAB").//.Program.label
#0A..19writef("*nL%n:",.lval)#0A..19ENDCASE#0A..2CA
SE.f_lstr:..3cvfm("LSTR").//.a.:#3D.Mn..1(pointer.t
o.string)#0A..19writef("*n.MOVAL.W^L%n,R8",.mval+10
02)#0A..19writef("*n.DIVL2.#234,R8")#0A..19ENDCASE#0A
..2CASE.f_entry:..2cventry().//.Start.of.a.function
#0A..19ENDCASE#0A..}#0A#0A..newline()#0A}.REPEAT#0A
#0AAND.cvf(s)..1BE.writef(";.%s",.s)#0AAND.cvfp(s).
.BE.writef(";.%t7.P%n",.s,.rdp())#0AAND.cvfkp(s).BE
.writef(";.%t7.K%n.P%n",.s,.rdk(),.rdp())#0AAND.cvf
g(s)..BE.writef(";.%t7.G%n",.s,.rdg())#0AAND.cvfkg(
s).BE.writef(";.%t7.K%n.G%n",.s,.rdk(),.rdg())#0AAN
D.cvfkl(s).BE.writef(";.%t7.K%n.L%n",.s,.rdk(),.rdl
())#0AAND.cvfpg(s).BE.writef(";.%t7.P%n.G%n",.s,.rd
p(),.rdg())#0AAND.cvfk(s)..BE.writef(";.%t7.K%n",.s
,.rdk())#0AAND.cvfw(s)..BE.writef(";.%t7.W%n",.s,.r
dw())#0AAND.cvfl(s)..BE.writef(";.%t7.L%n",.s,.rdl(
))#0AAND.cvfm(s)..BE.writef(";.%t7.M%n",.s,.rdm())#0A
#0AAND.cvswl().BE#0A{.LET.n.#3D.rdk()#0A..LET.dlab.
#3D.rdl()#0A..LET.lab.#3D.nextlab()#0A..writef(";.S
WL.K%n.L%n",.n,.dlab)#0A..writef("*n.TSTL.R8")#0A..
genBLSS(dlab)#0A..writef("*n.CMPL.#23%n,R8",.n)#0A.
.genBLEQ(dlab)#0Awritef("*n.MOVL.L^X%n(R9)[R8],R1",
.lab)#0Awritef("*n.JMP.(R1)")#0A//..writef("*n.JMP.
L^X%n(R9)[R8]",.lab)#0A..writef("*n.#2EALIGN.LONG")
#0A..writef("*nX%n:",.lab)#0A..FOR.i.#3D.1.TO.n.DO#0A
..{.writef("*n;.L%n",.rdl())#0A..2writef("*n.#2ELON
G.L%n",.lval)#0A..}#0A}#0A#0AAND.cvswb().BE#0A{.LET
.n.#3D.rdk()#0A..LET.dlab.#3D.rdl()#0A..writef(";.S
WB.K%n.L%n",.n,.dlab)..//.A.naive.implementation.of
.swb#0A..FOR.i.#3D.1.TO.n.DO.#0A..{.LET.k.#3D.rdk()
#0A..2LET.lab.#3D.rdl()#0A..2writef("*n;.K%n.L%n",.
k,.lab)#0A..2writef("*n.CMPL.#23%n,R8",.k)#0A..2gen
BEQL(lab)#0A..}#0A..writef("*n.JMP.L%n",.dlab)#0A}#0A
#0AAND.cvglobal().BE#0A{.LET.n.#3D.rdk()#0A..writef
(";.GLOBAL.K%n*n",.n)#0A..IF.sectname%0#3D0.FOR.i.#3D
.0.TO.4.DO.sectname%i.:#3D."prog"%i#0A..writef("*n;
#2Eglobl.%s*n",.sectname)#0A..writef(";%s::*n",.sec
tname)#0A..writef(".#2Eentry.%s,0*n",.sectname)#0A.
.writef(".movl.4(ap),r1*n")#0A..FOR.i.#3D.1.TO.n.DO
#0A..{.LET.g.#3D.rdg()#0A..2LET.n.#3D.rdl()#0A..2wr
itef(";.G%n.L%n*n",.g,.n)#0A..2writef(".MOVAL.L%n,%
n(r1)*n",.n,.4*g)#0A..}#0A..writef(";.G%n",.rdg())#0A
..writef("*n.RET*n")#0A}#0A#0AAND.cvglobal1().BE#0A
{.LET.n.#3D.rdk()#0A..writef("*n;.GLOBAL.K%n",.n)#0A
..IF.sectname%0#3D0.FOR.i.#3D.0.TO.4.DO.sectname%i.
:#3D."prog"%i#0A..writef("*n#2EALIGN.LONG")#0A..wri
tef("*n#2ELONG.-1")#0A..FOR.i.#3D.1.TO.n.DO#0A..{.L
ET.g.#3D.rdg()#0A..2LET.n.#3D.rdl()#0A..2writef("*n
;.G%n.L%n*n",.g,.n)#0A..2writef("*n.#2ELONG.%i4,.L%
n",.g,.n)#0A..}#0A..writef("*n;.G%n",.rdg())#0A..wr
itef("*n.#2ELONG.%i4",.gval)#0A}#0A#0AAND.rdchars()
.#3D.VALOF#0A{.LET.n.#3D.rdk()#0A..charv%0.:#3D.n#0A
..FOR.i.#3D.1.TO.n.DO.charv%i.:#3D.rdc()#0A..RESULT
IS.n#0A}#0A#0AAND.cvstring().BE#0A{.LET.lab.#3D.rdm
()#0A..LET.n.#3D.rdchars()#0A..writef(";.STRING..M%
n.K%n",.lab,.n)#0A..FOR.i.#3D.1.TO.n.DO.writef(".C%
n",.charv%i)#0A..writef("*n.#2EALIGN.LONG")#0A..wri
tef("*nL%n:",.lab+1002)#0A..FOR.i.#3D.0.TO.n.DO.wri
tef("*n.#2EBYTE.%n",.charv%i)#0A}#0A#0AAND.cvconst(
).BE#0A{.LET.lab.#3D.rdm()#0A..LET.w.#3D.rdw()#0A..
writef(";.CONST..1M%n.W%n",.lab,.w)#0A..writef("*n.
#2EALIGN.LONG")#0A..writef("*nL%n:",.lab+1002)#0A..
writef("*n.#2ELONG.%n",.w)#0A}#0A#0AAND.cvstatic().
BE#0A{.LET.lab.#3D.rdl()#0A..LET.n.#3D.rdk()#0A..wr
itef(";.STATIC..L%n.K%n",.lab,.n)#0A..writef("*n.#2E
ALIGN.LONG")#0A..writef("*nL%n:",.lab)#0A..FOR.i.#3D
.1.TO.n.DO.{.writef("*n;.W%n",.rdw())#0A..20writef(
"*n.#2ELONG.%n",.wval)#0A..18}#0A}#0A#0AAND.cvfs(s)
.BE#0A{.LET.n.#3D.rdchars()#0A..writef(";.%t7.K%n",
.s,.n)#0A..FOR.i.#3D.1.TO.n.DO.writef(".C%n",.charv
%i)#0A}#0A#0AAND.cventry().BE#0A{.LET.n.#3D.rdchars
()#0A..LET.op.#3D.rdf()#0A..LET.lab.#3D.rdl()#0A..w
ritef("*n*n;.Entry.to:.%s*n",.charv)#0A..writef(";.
%t7.K%n",."ENTRY",.n)#0A..FOR.i.#3D.1.TO.n.DO.write
f(".C%n",.charv%i)#0A..newline()#0A..TEST.op#3Df_la
b.THEN.writef(";.LAB..3L%n*n",.lab)#0A..14ELSE.writ
ef(";.Bad.op.F%n.L%n*n",.op,.lab)#0A..FOR.i.#3D.n+1
.TO.11.DO.charv%i.:#3D.'.'#0A..IF.n>11.DO.charv!0.:
#3D.11#0A..writef("*n.#2ELONG.^X%x8",entryword)#0A.
.writef("*n.#2ELONG.^X%x8",charv!0)#0A..writef("*n.
#2ELONG.^X%x8",charv!1)#0A..writef("*n.#2ELONG.^X%x
8",charv!2)#0A#0A..writef("*nL%n:",.lab)#0A..writef
("*n.MOVL.R10,(R1)")..5//.Save.<old.P>#0A..writef("
*n.MOVL.R1,R10")..7//.P.:#3D.<new.P>#0A..writef("*n
.MOVL.(SP)+,4(R10)").//.Save.<return.address>#0A..w
ritef("*n.MOVL.R2,8(R10)")..2//.Save.<entry.point>#0A
..writef("*n.MOVL.R8,12(R10)")..2//.Save.first.argu
ment#0A}#0A#0AAND.genBEQL(lab).BE#0A{.LET.m.#3D.nex
tlab()#0A..writef("*n.BNEQ.X%n",.m)#0A..writef("*n.
JMP.L%n",.lab)#0A..writef("*nX%n:",.m)#0A}#0A#0AAND
.genBNEQ(lab).BE#0A{.LET.m.#3D.nextlab()#0A..writef
("*n.BEQL.X%n",.m)#0A..writef("*n.JMP.L%n",.lab)#0A
..writef("*nX%n:",.m)#0A}#0A#0AAND.genBLSS(lab).BE#0A
{.LET.m.#3D.nextlab()#0A..writef("*n.BGEQ.X%n",.m)#0A
..writef("*n.JMP.L%n",.lab)#0A..writef("*nX%n:",.m)
#0A}#0A#0AAND.genBGTR(lab).BE#0A{.LET.m.#3D.nextlab
()#0A..writef("*n.BLEQ.X%n",.m)#0A..writef("*n.JMP.
L%n",.lab)#0A..writef("*nX%n:",.m)#0A}#0A#0AAND.gen
BLEQ(lab).BE#0A{.LET.m.#3D.nextlab()#0A..writef("*n
.BGTR.X%n",.m)#0A..writef("*n.JMP.L%n",.lab)#0A..wr
itef("*nX%n:",.m)#0A}#0A#0AAND.genBGEQ(lab).BE#0A{.
LET.m.#3D.nextlab()#0A..writef("*n.BLSS.X%n",.m)#0A
..writef("*n.JMP.L%n",.lab)#0A..writef("*nX%n:",.m)
#0A}#0A#0A1

######com/skip.b#
SECTION."SKIP"#0D#0A#0D#0AGET."libhdr"#0D#0A#0D#0AG
LOBAL.{.ch:.ug.}#0D#0A#0D#0ALET.start().#3D.VALOF#0D
#0A{.LET.arg#3D.VEC.50#0D#0A..LET.label#3D.""#0D#0A
..LET.found.#3D.FALSE#0D#0A..LET.s.#3D.VEC.127#0D#0A
#0D#0A..UNLESS.rdargs("LABEL",arg,50).DO#0D#0A..{.w
rites("Bad.argument.spec.for.Skip*n")#0D#0A..2RESUL
TIS.return_hard#0D#0A..}#0D#0A#0D#0A..IF.cli_curren
tinput.#3D.cli_standardinput.DO#0D#0A..{.writes("Sk
ip.must.be.in.a.command.file*n")#0D#0A..2RESULTIS.r
eturn_hard#0D#0A..}#0D#0A#0D#0A..IF.arg!0.DO.label.
:#3D.arg!0#0D#0A#0D#0A..ch:#3D'*n'#0D#0A..UNTIL.fou
nd.|.ch#3Dendstreamch.DO#0D#0A..{.ch.:#3D.rdch().RE
PEATWHILE.ch#3D'.'.|.ch#3D'*c'#0D#0A..2rdstr(s)#0D#0A
..2IF.compstring(s,."lab")#3D0.THEN#0D#0A..2{.WHILE
.ch#3D'.'.DO.ch:#3Drdch()#0D#0A..4rdstr(s)#0D#0A..4
found.:#3D.compstring(s,.label)#3D0#0D#0A..2}#0D#0A
..2UNTIL.ch#3D'*n'.|.ch#3Dendstreamch.DO.ch:#3Drdch
()#0D#0A..}#0D#0A#0D#0A..UNLESS.found.DO#0D#0A..{.w
ritef("Label.*"%s*".not.found.by.Skip*n",.label)#0D
#0A..2RESULTIS.return_hard#0D#0A..}#0D#0A}#0D#0A#0D
#0A#0D#0A#0D#0AAND.rdstr(s).BE#0D#0A{.LET.i#3D0#0D#0A
..UNTIL.ch#3D'*N'.|.ch#3Dendstreamch.|.ch#3D'.'.DO#0D
#0A..{.UNLESS.ch#3D'*c'.DO#0D#0A..2{.i.:#3D.i+1#0D#0A
..4s%i:#3Dch#0D#0A..2}#0D#0A..2ch:#3Drdch()#0D#0A..
}#0D#0A..s%0.:#3D.i#0D#0A}#0D#0A#0D#0A

######com/sortxref.b#
/*#0AThis.is.a.program.to.sort.raw.xref.data.into.a
lpabetical.order#0Aremoving.duplicates#2E#0A#0AImpl
emented.by.Martin.Richards.(c).3.April.2000009#0A#0A
*/#0A#0AGET."libhdr"#0A#0AGLOBAL.{#0A..fromname:.ug
#0A..toname#0A..fromstream#0A..tostream#0A..stdin#0A
..stdout#0A..blklist..//.List.of.4096.word.block.to
.hold.the.sorted.binary#0A..9//.tree.of.xref.lines#2E
#0A..tree..3//.The.root.of.the.binary.tree.of.nodes
#2E#0A..optfns#0A}#0A#0AMANIFEST.{#0A..blkupb.#3D.4
095#0A}#0A#0ALET.start().#3D.VALOF#0A{.LET.format.#3D
."from/a,to/k,fns/s"#0A..LET.argv.#3D.VEC.50#0A..LE
T.linev.#3D.VEC.256/bytesperword#0A#0A..blklist.:#3D
.0#0A..tree.:#3D.0#0A..stdin,.stdout.:#3D.input(),.
output()#0A..fromstream,.tostream.:#3D.0,.0#0A..fro
mname,.toname.:#3D."**",."**"#0A#0A..UNLESS.rdargs(
format,.argv,.50).DO#0A..{.writef("Bad.argument.for
.format:.%s*n",.format)#0A..2RESULTIS.0#0A..}#0A#0A
..fromname.:#3D.argv!0#0A..fromstream.:#3D.findinpu
t(fromname)#0A..UNLESS.fromstream.DO#0A..{.writef("
Unable.to.read.file:.%s*n",.fromname)#0A..2RESULTIS
.0#0A..}#0A#0A..IF.argv!1.DO#0A..{.toname.:#3D.argv
!1#0A..2tostream.:#3D.findoutput(toname)#0A..2UNLES
S.tostream.DO#0A..2{.writef("Unable.to.output.to.fi
le:.%s*n",.toname)#0A..4RESULTIS.0#0A..2}#0A..}#0A#0A
..optfns.:#3D.argv!2#0A#0A..writef("*nsorting.xrefs
.from.%s.to.%s*n",.fromname,.toname)#0A..selectinpu
t(fromstream)#0A#0A..WHILE.rdline(linev).IF.filter(
linev).DO.insertnode(linev)#0A#0A..IF.tostream.DO.s
electoutput(tostream)#0A..prtree(tree)#0A#0Afin:#0A
//abort(1001)#0A..IF.fromstream.DO.endstream(fromst
ream)#0A..IF.tostream.&.tostream~#3Dstdout.DO.endst
ream(tostream)#0A#0A..WHILE.blklist.DO#0A..{.LET.bl
k.#3D.blklist#0A..2blklist.:#3D.!blk#0A..2freevec(b
lk)#0A..}#0A..selectoutput(stdout)#0A..writef("done
*n")#0A..RESULTIS.0#0A}#0A#0AAND.rdline(lnv).#3D.VA
LOF#0A{.LET.len.#3D.0#0A#0A..{.LET.ch.#3D.rdch()#0A
..2IF.ch#3D'*c'.BREAK#0A..2IF.ch#3D'*n'.BREAK#0A..2
IF.ch#3Dendstreamch.RESULTIS.0#0A..2len.:#3D.len+1#0A
..2IF.len<#3D255.DO.lnv%len.:#3D.ch..2#0A..}.REPEAT
#0A#0A..IF.len>255.DO.len.:#3D.255#0A..lnv%0.:#3D.l
en#0A//writef("rdline:.%s*n",.lnv)#0A..RESULTIS.TRU
E.//.Successful.return#0A}#0A#0AAND.filter(lnv).#3D
.VALOF#0A{.//.Returns.TRUE.if.lnv.contains.G:,.M:,.
F:.or.S:#0A..LET.len.#3D.lnv%0#0A..FOR.i.#3D.2.TO.l
en.IF.lnv%i#3D':'.DO#0A..{.LET.ch.#3D.lnv%(i-1)#0A.
.2IF.ch#3D'G'.|.ch#3D'M'.|.ch#3D'F'.|.ch#3D'S'.DO#0A
..2{.IF.optfns.DO#0A..4{.//.OK.if.lnv.contains.".RT
.".or.".FN."#0A..6FOR.i.#3D.1.TO.len-3.IF.lnv%i#3D'
.'.&.lnv%(i+3)#3D'*s'.DO#0A..6{.LET.a,.b.#3D.lnv%(i
+1),.lnv%(i+2)#0A..8IF.a#3D'R'.&.b#3D'T'.RESULTIS.T
RUE#0A..8IF.a#3D'F'.&.b#3D'N'.RESULTIS.TRUE#0A..6}#0A
..6RESULTIS.FALSE#0A..4}#0A..4RESULTIS.TRUE#0A..2}#0A
..}#0A..RESULTIS.FALSE#0A}#0AAND.insertnode(str).BE
.TEST.tree#0ATHEN.{.LET.t.#3D.tree#0A#0A..5{.//.Fin
d.the.position.in.the.tree.to.insert.the.node#0A..7
LET.rel.#3D.comp(str,.@t!2)#0A..7LET.a.#3D.t#0A..7U
NLESS.rel.RETURN.//.str.is.a.duplicate.so.don't.ins
ert#0A..7IF.rel>0.DO.a.:#3D.a+1#0A..7t.:#3D.!a#0A..
7UNLESS.t.DO.{.!a.:#3D.mknode(str);.RETURN.}#0A..5}
.REPEATWHILE.t#0A#0A..3}#0AELSE.tree.:#3D.mknode(st
r)#0A#0AAND.comp(s1,.s2).#3D.VALOF#0A{.LET.len1,.le
n2.#3D.s1%0,.s2%0#0A..LET.minlen.#3D.len1<len2.->.l
en1,.len2#0A..FOR.i.#3D.1.TO.minlen.DO#0A..{.LET.ch
1,.ch2.#3D.s1%i,.s2%i#0A..2IF.ch1<ch2.RESULTIS.-1#0A
..2IF.ch1>ch2.RESULTIS.+1#0A..}#0A..IF.len1<len2.RE
SULTIS.-1#0A..IF.len1>len2.RESULTIS.+1#0A..RESULTIS
.0..14//.The.strings.are.equal#0A}#0A#0AAND.mknode(
str).#3D.VALOF#0A{.//.Returns.the.pointer.to.the.ne
w.node#0A..LET.nodesize.#3D.2.+.str%0/bytesperword.
+.1.//.[left,.right,.<bytes>]#0A#0A//..writef("mkno
de:.str#3D%s*n",.str)#0A#0A..IF.blklist#3D0.DO#0A..
{.blklist.:#3D.getvec(blkupb)#0A//writef("mknode:.a
llocating.blk.%n.upb#3D%n*n",.blklist,.blkupb)#0A//
abort(1001)#0A..2UNLESS.blklist.RESULTIS.0#0A..2blk
list!0,.blklist!1.:#3D.0,.1#0A..}#0A#0A..IF.blklist
!1+nodesize.>.blkupb.DO#0A..{.//.There.is.insuffici
ent.room.for.the.new.node.so.a.new#0A..2//.block.mu
st.be.allocated#2E#0A..2LET.nb.#3D.getvec(blkupb)#0A
..2UNLESS.nb.RESULTIS.0#0A..2nb!0,.nb!1.:#3D.blklis
t,.1#0A..2blklist.:#3D.nb#0A//writef("mknode:.alloc
ating.blk.%n.upb#3D%n*n",.blklist,.blkupb)#0A//abor
t(1000001)#0A..}#0A..//.The.current.block.is.large.
enough.for.the.new.node#0A#0A..{.LET.pos.#3D.blklis
t!1..7//.Position.of.the.new.node#0A..2LET.node.#3D
.@blklist!pos.+.1.//.Pointer.to.new.node#0A..2LET.n
ewstr.#3D.node+2..7//.Pointer.to.the.node.string.by
tes#0A..2blklist!1.:#3D.pos.+.nodesize#0A//writef("
mknode:.making.node#3D%n..str#3D%s*n",.node,.str)#0A
..2node!0,.node!1.:#3D.0,.0..2//.Null.left.and.righ
t.children#0A..2FOR.i.#3D.0.TO.str%0/bytesperword.D
O.newstr!i.:#3D.str!i#0A..2RESULTIS.node#0A..}#0A}#0A
#0AAND.prtree(t).BE.IF.t.DO#0A{.//.t.#3D.0..or..t.-
>.[left,.right,.<string>]#0A..LET.x,.y.#3D.t!0,.t!1
#0A..IF.x.DO.prtree(x)#0A..writef("%s*n",.@t!2)#0A.
.IF.y.DO.prtree(y)#0A}#0A

######com/stack.b#
//.(C).Copyright.1978.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0ASECTION."STACK"#0A#0AGET."libhdr"#0A#0ALET.start
().#3D.VALOF#0A{.LET.argv.#3D.VEC.5#0A..LET.size.#3D
.0#0A#0A..IF.rdargs("size",.argv,.5)#3D0.DO#0A..{.w
rites("bad.argument.for.STACK*n")#0A..2RESULTIS.20#0A
..}#0A#0A..UNLESS.argv!0.DO#0A..{.writef("Current.s
tack.size.is.%n*n",.cli_defaultstack)#0A..2RESULTIS
.0#0A..}#0A#0A..IF.string_to_number(argv!0).DO.size
.:#3D.result2#0A#0A..IF.size<100.DO#0A..{.writes("s
uggested.stack.size.too.small*n")#0A..2RESULTIS.20#0A
..}#0A#0A..cli_defaultstack.:#3D.size#0A..RESULTIS.
0#0A}#0A

######com/stats.b#
//.(c).M#2E.Richards..Copyright.16.August.2001#0A#0A
/*#0A1/12/2000005#0AChanged.to.use.11.character.sec
tion.and.function.names#2E#0AChanged.argument.forma
t.to:."TO/K,STATS/S,PROFILE/S,ANALYSIS/S,HELP/S"#0A
The.default.TO.stream.for.the.options.STATS,.PROFIL
E.and.ANALYSIS.are#0Athe.file.names.STATS,.PROFILE.
and.ANALYSIS,.respectively#2E#0A#0A00016/8/2001#0AU
pdated.to.use.sys(Sys_setcount,.maxint).to.select.t
he.slow.interpreter#0A*/#0A#0A/*#0A**.This.program.
supercedes.the.old.tally.command#2E#0A**#0A**.The.a
rgument.format.is:."TO/K,ON/S,STATS/S,PROFILE/S,ANA
LYSIS/S,HELP/S"#0A#0A**.Usage:#0A**#0A**.preload.bc
pl..14Preload.the.program.to.study#2E#0A**.stats.on
..18Enable.statisticss.gathering.for.just#0A**..27t
he.next.command#2E#0A**#0A**.bcpl.com/bcpl#2Eb.to.j
unk..3Execute.the.command.to.study#2E#0A**.#0A**.in
terpreter..15Select.the.fast.interpreter.(cintasm)#0A
**..27since.stats.automatically.selects#0A**..27the
.slow.one#2E#0A**#0A**.stats.stats..15Send.instruct
ion.frequencies#0A**..27to.file.STATS.(by.default),
#0A**..27or#0A**.stats.profile..13Send.detailed.pro
file.info.to.file#0A**..27to.file.PROFILE.(by.defau
lt),#0A**..27or#0A**.stats.analysis..12Generate.sta
tistical.analysis#0A**..27to.file.ANALYSIS.(by.defa
ult)#2E#0A**#0A**.Only.one.of.the.STATS,.PROFILE.or
.ANALYSIS.may.be.used.at.a.time,#0A**.and.TO.may.on
ly.be.used.with.STATS,.PROFILE.and.ANALYSIS#2E#0A*/
#0A#0ASECTION."STATS"#0A#0AGET."libhdr"#0A#0AMANIFE
ST.{.disupb#3D26;.typeupb#3D8..}#0A#0AGLOBAL.{#0As_
lpdis:200;..1d_lpdis:230#0As_spdis:201;..1d_spdis:2
31#0As_grds:202;..2d_grds:232#0As_gwrs:203;..2d_gwr
s:233#0As_kdis:204;..2d_kdis:234#0As_rfdis:205;..1d
_rfdis:235#0As_rbdis:206;..1d_rbdis:236#0As_idis:20
7;..2d_idis:237#0As_lndis:208;..1d_lndis:238#0As_lm
dis:209;..1d_lmdis:239#0A#0As_gvecap:210;..d_gvecap
:240#0As_pvecap:211;..d_pvecap:241#0As_gbyt:212;..2
d_gbyt:242#0As_pbyt:213;..2d_pbyt:243#0As_adds:214;
..2d_adds:244#0As_subs:215;..2d_subs:245#0As_eops:2
16;..2d_eops:246#0As_fv:217;..4d_fv:247#0As_fcount:
218;..d_fcount:248#0As_cj:219;..4d_cj:249#0As_cj0:2
20000;..3d_cj0:250#0As_swb:220001;..3d_swb:251#0As_
swl:221;..3d_swl:252#0As_ftype:220003;..1d_ftype:25
3#0As_rtn:220004;..3d_rtn:254#0A#0Atostream:260#0Af
code:270#0Afreq:271#0Apc:272#0A#0Astats:.280#0Aprof
ile:281#0Aanalysis:282#0A}#0A#0ALET.start().#3D.VAL
OF#0A{.LET.argv.#3D.VEC.20#0A..AND.tofile.#3D.0#0A.
.AND.outstream.#3D.0#0A..AND.tallyv.#3D.rootnode!rt
n_tallyv#0A..AND.oldout.#3D.output()#0A#0A..IF.tall
yv#3D0.DO#0A..{.writes("Statistic.gathering.not.ava
ilable*n")#0A..2RESULTIS.20#0A..}#0A..1#0A..UNLESS.
rdargs("TO/K,ON/S,STATS/S,PROFILE/S,ANALYSIS/S,HELP
/S",#0A..14argv,.20).DO#0A..{.writes("Bad.arguments
.for.STATS*n")#0A..2RESULTIS.20#0A..}#0A#0A..UNLESS
.argv!1.|..18//.ON#0A..7argv!2.|..18//.STATS#0A..7a
rgv!3.|..18//.PROFILE#0A..7argv!4.DO..17//.ANALYSIS
#0A..3argv!5.:#3D.TRUE#0A#0A..IF.argv!5.DO..21//.HE
LP#0A..{.LET.w.#3D.writes#0A#0A..2w("*nTypical.usag
e:*n*n")#0A#0A..2w("preload.bcpl..11Preload.the.pro
gram.to.study#2E*n")#0A..2w("stats.on..15Enable.sta
tistics.gathering.for*n")#0A..2w("..25just.the.next
.command#2E*n*n")#0A#0A..2w("bcpl.com/bcpl#2Eb.to.j
unk..Execute.the.command.to.study#2E*n*n")#0A#0A..2
w("interpreter..12Select.the.fast.interpreter,*n")#0A
..2w("..25since.stats.automatically.selects*n")#0A.
.2w("..25the.slow.one#2E*n*n")#0A#0A..2w("stats.sta
ts..12Send.instruction.frequencies*n")#0A..2w("..25
to.file:.STATS#2E*n")#0A..2w("..23or*n")#0A..2w("st
ats.profile..10Send.detailed.profile.information*n"
)#0A..2w("..25to.file:.PROFILE#2E*n")#0A..2w("..23o
r*n")#0A..2w("stats.analysis..9Generate.statistical
.analysis*n")#0A..2w("..25to.file:.ANALYSIS#2E*n*n"
)#0A#0A..2w("Only.one.of.ON,.STATS,.PROFILE.or.ANAL
YSIS.may.be.specified#2E*n*n")#0A#0A..2w("The.TO.op
tion.can.be.used.to.override.the.default*n")#0A..2w
("destination.for.the.STATS,.PROFILE.and.ANALYSIS.o
ptions#2E*n")#0A#0A..2RESULTIS.0#0A..}#0A#0A..{.LET
.k.#3D.0#0A..2IF.argv!1.DO.k.:#3D.k+1#0A..2IF.argv!
2.DO.k.:#3D.k+1#0A..2IF.argv!3.DO.k.:#3D.k+1#0A..2I
F.argv!4.DO.k.:#3D.k+1#0A..2IF.k>1.DO#0A..2{.writef
("Only.one.of.ON,.STATS,.PROFILE.or.ANALYSIS.may.be
.specified*n")#0A..4RESULTIS.0#0A..2}#0A..}#0A#0A..
IF.argv!1.DO..19//.ON#0A..{.cli_tallyflag.:#3D.TRUE
#0A..2//.Select.slow.statistics.gathering.interpret
er#0A..2sys(Sys_setcount,.maxint)#0A..2writes("Stat
istics.gathering.enabled*n")#0A..2RESULTIS.0#0A..}#0A
#0A..stats..2:#3D.argv!2..13//.STATS#0A..profile..:
#3D.argv!3..13//.PROFILE#0A..analysis.:#3D.argv!4..
13//.ANALYSIS#0A#0A..IF.stats..2DO.tofile.:#3D."STA
TS"#0A..IF.profile..DO.tofile.:#3D."PROFILE"#0A..IF
.analysis.DO.tofile.:#3D."ANALYSIS"#0A#0A..IF.argv!
0..1DO.tofile.:#3D.argv!0..//.TO#0A..1#0A..outstrea
m.:#3D.findoutput(tofile)#0A..IF.outstream#3D0.DO.{
.writes("Trouble.with.file.%s*n",.tofile)#0A..20RES
ULTIS.20#0A..18}#0A..selectoutput(outstream)#0A..1#0A
..init_analysis()#0A..statsout(rootnode!rtn_blklist
,.tallyv,.tallyv!0)#0A..free_storage()#0A#0A..UNLES
S.outstream#3Doldout.DO.endwrite()#0A..selectoutput
(oldout)#0A..RESULTIS.0#0A}#0A#0AAND.statsout(base,
.tallyv,.upb).BE#0A{.LET.cursect.#3D.0#0A#0A..//.Sc
an.memory#0A..FOR.i.#3D.1.TO.upb.DO#0A..{.#0A..2//w
ritef("Scanning.location.%i6*n",.i)#0A//abort(1001)
#0A..2IF.profile.&.(i&3)#3D0.DO#0A..2{.LET.name.#3D
.base.+.(i>>0002)-3#0A..4LET.word.#3D.name<100.->.0
,.name!-1#0A#0A..4IF.word#3Dsectword.&.name%0#3D11.
DO#0A..4{.cursect.:#3D.i.-.16#0A..6writef("*n%i6:.S
ection:..1%s..1Size:.%n*n",#0A..16cursect,..6name,.
.4name!-2)#0A..4}#0A..4IF.word#3Dentryword.&.name%0
#3D11.DO#0A..7writef("*n%i6:.Function:..%s*n",.i-cu
rsect,.name)#0A..2}#0A#0A..2IF.tallyv!i.DO#0A..2{.L
ET.f.#3D.base%i#0A..4LET.basebyte.#3D.base<<0002#0A
..4pc.:#3D.basebyte.+.i#0A..4fcode.:#3D.0%pc#0A..4f
req..:#3D.tallyv!i#0A#0A..4IF.profile.DO#0A..4{.wri
tef("+%i5:%i6.",.i-cursect,.tallyv!i)#0A..6prinstr(
pc,.basebyte+cursect)#0A..6newline()#0A..4}#0A#0A..
4analyse_instr()#0A..2}#0A#0A..2IF.intflag().DO.{.w
ritef("*n++2.BREAK*n")#0A..20BREAK#0A..18}#0A..}#0A
..1#0A..IF.analysis.DO.{.pr_analysis();.RETURN..}#0A
#0A..//.Otherwise.print.a.simple.frequency.table#0A
..IF.stats.DO#0A..{.writef("*nInstruction.frequenci
es.(total.executed.%n)*n",.d_fcount)#0A..1#0A..2FOR
.i.#3D.0.TO.128.BY.128.FOR.j.#3D.0.TO.31.DO#0A..2{.
newline()#0A..4IF.intflag().DO.{.writef("*n++2.BREA
K*n")#0A..22RETURN#0A..20}#0A..4FOR.k.#3D.0.TO.96.B
Y.32.DO#0A..4{.LET.f.#3D.i.+.j.+.k#0A..6IF.f#3D128.
DO.newline()#0A..6wrfcode(f)#0A..6writef(".%i7..1",
.d_fv!f)#0A..4}#0A..2}#0A..}#0A#0A..newline()#0A}#0A
#0AAND.wrfcode(f).BE#0A{.LET.s.#3D.VALOF.SWITCHON.f
&31.INTO#0A..{.DEFAULT:#0A..2CASE..0000:.RESULTIS."
..3-..3K..1LLP..3L..2LP..2SP..2AP..3A"#0A..2CASE..0
001:.RESULTIS."..3-..2KH..LLPH..2LH..1LPH..1SPH..1A
PH..2AH"#0A..2CASE..0002:.RESULTIS."..1BRK..2KW..LL
PW..2LW..1LPW..1SPW..1APW..2AW"#0A..2CASE..0003:.RE
SULTIS."..2K3..1K3G..K3G1..K3GH..1LP3..1SP3..1AP3..
L0P3"#0A..2CASE..0004:.RESULTIS."..2K4..1K4G..K4G1.
.K4GH..1LP4..1SP4..1AP4..L0P4"#0A..2CASE..0005:.RES
ULTIS."..2K5..1K5G..K5G1..K5GH..1LP5..1SP5..1AP5..L
0P5"#0A..2CASE..0006:.RESULTIS."..2K6..1K6G..K6G1..
K6GH..1LP6..1SP6..1AP6..L0P6"#0A..2CASE..0007:.RESU
LTIS."..2K7..1K7G..K7G1..K7GH..1LP7..1SP7..1AP7..L0
P7"#0A..2CASE..0008:.RESULTIS."..2K8..1K8G..K8G1..K
8GH..1LP8..1SP8..1AP8..L0P8"#0A..2CASE..0009:.RESUL
TIS."..2K9..1K9G..K9G1..K9GH..1LP9..1SP9..1AP9..L0P
9"#0A..2CASE.10:.RESULTIS."..1K10..K10G.K10G1.K10GH
..LP10..SP10..AP10.L0P10"#0A..2CASE.11:.RESULTIS.".
.1K11..K11G.K11G1.K11GH..LP11..SP11..AP11.L0P11"#0A
..2CASE.12:.RESULTIS."..2LF..1S0G..S0G1..S0GH..LP12
..SP12..AP12.L0P12"#0A..2CASE.13:.RESULTIS."..1LF$.
.1L0G..L0G1..L0GH..LP13..SP13.XPBYT..3S"#0A..2CASE.
14:.RESULTIS."..2LM..1L1G..L1G1..L1GH..LP14..SP14..
1LMH..2SH"#0A..2CASE.15:.RESULTIS."..1LM1..1L2G..L2
G1..L2GH..LP15..SP15..1BTC..MDIV"#0A..2CASE.16:.RES
ULTIS."..2L0..2LG..1LG1..1LGH..LP16..SP16..1NOP.CHG
CO"#0A..2CASE.17:.RESULTIS."..2L1..2SG..1SG1..1SGH.
.1SYS..2S1..2A1..1NEG"#0A..2CASE.18:.RESULTIS."..2L
2..1LLG..LLG1..LLGH..1SWB..2S2..2A2..1NOT"#0A..2CAS
E.19:.RESULTIS."..2L3..2AG..1AG1..1AGH..1SWL..2S3..
2A3..L1P3"#0A..2CASE.20:.RESULTIS."..2L4..1MUL..1AD
D..2RV..2ST..2S4..2A4..L1P4"#0A..2CASE.21:.RESULTIS
."..2L5..1DIV..1SUB..1RV1..1ST1..1XCH..2A5..L1P5"#0A
..2CASE.22:.RESULTIS."..2L6..1REM..1LSH..1RV2..1ST2
..GBYT..RVP3..L1P6"#0A..2CASE.23:.RESULTIS."..2L7..
1XOR..1RSH..1RV3..1ST3..PBYT..RVP4..L2P3"#0A..2CASE
.24:.RESULTIS."..2L8..2SL..1AND..1RV4..STP3..1ATC..
RVP5..L2P4"#0A..2CASE.25:.RESULTIS."..2L9..1SL$..2O
R..1RV5..STP4..1ATB..RVP6..L2P5"#0A..2CASE.26:.RESU
LTIS."..1L10..2LL..1LL1..1RV6..STP5..3J..RVP7..L3P3
"#0A..2CASE.27:.RESULTIS."..FHOP..1LL$..LL1$..1RTN.
.GOTO..2J$.ST0P3..L3P4"#0A..2CASE.28:.RESULTIS."..1
JEQ..1JNE..1JLS..1JGR..1JLE..1JGE.ST0P4..L4P3"#0A..
2CASE.29:.RESULTIS."..JEQ$..JNE$..JLS$..JGR$..JLE$.
.JGE$.ST1P3..L4P4"#0A..2CASE.30:.RESULTIS."..JEQ0..
JNE0..JLS0..JGR0..JLE0..JGE0.ST1P4..3-"#0A..2CASE.3
1:.RESULTIS.".JEQ0$.JNE0$.JLS0$.JGR0$.JLE0$.JGE0$..
3-..3-"#0A..}#0A..LET.n.#3D.f>>0005.&.7#0A..FOR.i.#3D
.6*n+1.TO.6*(n+1).DO.wrch(s%i)#0A}#0A#0AAND.prinstr
(pc,.cursect).BE#0A{.LET.a.#3D.0#0A..wrfcode(0%pc)#0A
..SWITCHON.instrtype(0%pc).INTO#0A..{.DEFAULT:#0A..
2CASE.'0':..36RETURN#0A..2CASE.'1':.a..:#3D.gb(pc+1
);..20ENDCASE#0A..2CASE.'2':.a..:#3D.gh(pc+1);..20E
NDCASE#0A..2CASE.'4':.a..:#3D.gw(pc+1);..20ENDCASE#0A
..2CASE.'R':.a..:#3D.pc+1.+.gsb(pc+1).-.cursect;..2
ENDCASE#0A..2CASE.'I':.pc.:#3D.pc+1.+.2*gb(pc+1).&.
#23xFF5E#0A..12a..:#3D.pc.+.gsh(pc).-.cursect;..6EN
DCASE#0A..}#0A..writef(".%n",.a)#0A}#0A#0AAND.gb(pc
).#3D.0%pc#0A#0AAND.gsb(pc).#3D.0%pc<#3D127.->.0%pc
,.0%pc-256#0A#0AAND.gsh(pc).#3D.VALOF#0A{.LET.h.#3D
.gh(pc)#0A..RESULTIS.h<#3D#23x7FF1.->.h,.h.-.#23x10
02#0A}#0A#0AAND.gh(pc).#3D.VALOF#0A{.LET.w.#3D.?#0A
..LET.p.#3D.@w..//.Designed.to.work.on.both.Big.and
.Little.Ender.M/Cs#2E#0A..p%0,.p%1,.p%2,.p%3.:#3D.0
%pc,.0%(pc+1),.0%pc,.0%(pc+1)#0A..RESULTIS.w.&.#23x
FF2#0A}#0A#0AAND.gw(pc).#3D.VALOF#0A{.LET.w.#3D.?#0A
..LET.p.#3D.@w..//.Designed.to.work.on.both.Big.and
.Little.Ender.M/Cs#2E#0A..p%0,.p%1,.p%2,.p%3.:#3D.0
%pc,.0%(pc+1),.0%(pc+2),.0%(pc+3)#0A..RESULTIS.w#0A
}#0A#0AAND.instrtype(f).#3D."?008RI10011RIRI*#0A..1
6*12411015002RIRIRIRI*#0A..16*12411015004RIRIRI*#0A
..16*12422015006RIRI*#0A..16*1240013BL006RIRI*#0A..
16*1240021RIRIRI*#0A..16*1240000920014?*#0A..16*124
00008120013??"%f#0A#0A3AND.init_analysis().BE#0A{.s
_lpdis,.d_lpdis.:#3D.getvec(disupb),.getvec(disupb)
#0A..s_spdis,.d_spdis.:#3D.getvec(disupb),.getvec(d
isupb)#0A..s_grds,.d_grds.:#3D.0,.0#0A..s_gwrs,.d_g
wrs.:#3D.0,.0#0A..s_kdis,..d_kdis..:#3D.getvec(disu
pb),.getvec(disupb)#0A..s_rfdis,.d_rfdis.:#3D.getve
c(disupb),.getvec(disupb)#0A..s_rbdis,.d_rbdis.:#3D
.getvec(disupb),.getvec(disupb)#0A..s_idis,..d_idis
..:#3D.getvec(disupb),.getvec(disupb)#0A..s_lndis,.
d_lndis.:#3D.getvec(disupb),.getvec(disupb)#0A..s_l
mdis,.d_lmdis.:#3D.getvec(disupb),.getvec(disupb)#0A
#0A..FOR.i.#3D.0.TO.disupb.DO#0A..{.s_lpdis!i,.d_lp
dis!i.:#3D.0,.0#0A..2s_spdis!i,.d_spdis!i.:#3D.0,.0
#0A..2s_kdis!i,..d_kdis!i..:#3D.0,.0#0A..2s_rfdis!i
,.d_rfdis!i.:#3D.0,.0#0A..2s_rbdis!i,.d_rbdis!i.:#3D
.0,.0#0A..2s_idis!i,..d_idis!i..:#3D.0,.0#0A..2s_ln
dis!i,.d_lndis!i.:#3D.0,.0#0A..2s_lmdis!i,.d_lmdis!
i.:#3D.0,.0#0A..}#0A#0A..s_gvecap,.d_gvecap.:#3D.0,
.0#0A..s_pvecap,.d_pvecap.:#3D.0,.0#0A..s_gbyt,..1d
_gbyt..1:#3D.0,.0#0A..s_pbyt,..1d_pbyt..1:#3D.0,.0#0A
..s_adds,..1d_adds..1:#3D.0,.0#0A..s_subs,..1d_subs
..1:#3D.0,.0#0A..s_eops,..1d_eops..1:#3D.0,.0#0A..1
#0A..s_fv,.d_fv.:#3D.getvec(255),.getvec(255)#0A..F
OR.i.#3D.0.TO.255.DO.s_fv!i,.d_fv!i.:#3D.0,.0#0A#0A
..s_fcount,.d_fcount.:#3D.0,.0#0A..s_cj,..d_cj..:#3D
.0,.0#0A..s_cj0,.d_cj0.:#3D.0,.0#0A..s_swb,.d_swb.:
#3D.0,.0#0A..s_swl,.d_swl.:#3D.0,.0#0A#0A..s_ftype,
.d_ftype.:#3D.getvec(typeupb),.getvec(typeupb)#0A..
FOR.i.#3D.0.TO.typeupb.DO.s_ftype!i,.d_ftype!i.:#3D
.0,.0#0A..1#0A..s_rtn,.d_rtn.:#3D.0,.0#0A}#0A#0AAND
.free_storage().BE#0A{.freevec(s_lpdis);..1freevec(
d_lpdis)#0A..freevec(s_spdis);..1freevec(d_spdis)#0A
..freevec(s_kdis);..2freevec(d_kdis)#0A..freevec(s_
rfdis);..1freevec(d_rfdis)#0A..freevec(s_rbdis);..1
freevec(d_rbdis)#0A..freevec(s_idis);..2freevec(d_i
dis)#0A..freevec(s_lndis);..1freevec(d_lndis)#0A..f
reevec(s_lmdis);..1freevec(d_lmdis)#0A#0A..freevec(
s_fv);..4freevec(d_fv)#0A..freevec(s_ftype);..1free
vec(d_ftype)#0A}#0A#0AAND.pr_analysis().BE#0A{.writ
ef("*n*nInstructions..%i7(%i5)*n",.d_fcount,.s_fcou
nt)#0A..1#0A..FOR.i.#3D.0.TO.128.BY.128.FOR.j.#3D.0
.TO.31.DO#0A..{.newline()#0A..2FOR.k.#3D.0.TO.96.BY
.32.DO#0A..2{.LET.f.#3D.i.+.j.+.k#0A..4IF.f#3D128.D
O.newline()#0A..4writef("..2")#0A..4wrfcode(f)#0A..
4writef("..2")#0A..2}#0A..2newline()#0A..2FOR.k.#3D
.0.TO.96.BY.32.DO#0A..2{.LET.f.#3D.i.+.j.+.k#0A..4w
ritef(".%i7(%i4)",.d_fv!f,.s_fv!f)#0A..2}#0A..}#0A.
.writes("*n*n..3GVECAP..6PVECAP..7GBYT..8PBYT*n")#0A
..3writef("%i7(%i4).",.d_gvecap,.s_gvecap)#0A..3wri
tef("%i7(%i4).",.d_pvecap,.s_pvecap)#0A..3writef("%
i7(%i4).",.d_gbyt,..s_gbyt)#0A..3writef("%i7(%i4)."
,.d_pbyt,..s_pbyt)#0A..1#0A..writes("*n*n..3ADDS..8
SUBS..9EOPS*n")#0A..3writef("%i7(%i4).",.d_adds,.s_
adds)#0A..3writef("%i7(%i4).",.d_subs,.s_subs)#0A..
3writef("%i7(%i4).",.d_eops,.s_eops)#0A#0A..writes(
"*n*n..4SWB..9SWL*n")#0A..3writef("%i7(%i4).",.d_sw
b,.s_swb)#0A..3writef("%i7(%i4).",.d_swl,.s_swl)#0A
..1#0A..writes("*n*n..4CJ..10CJ0*n")#0A..3writef("%
i7(%i4).",.d_cj,..s_cj)#0A..3writef("%i7(%i4).",.d_
cj0,.s_cj0)#0A..1#0A..writes("*n*nOperand.distribut
ions")#0A..1#0A..writes("*n*n..5LP..10SP..10K*n")#0A
..FOR.i.#3D.0.TO.disupb.DO#0A..{.writef("%i7(%i4)."
,.d_lpdis!i,.s_lpdis!i)#0A..2writef("%i7(%i4).",.d_
spdis!i,.s_spdis!i)#0A..2writef("%i7(%i4).",.d_kdis
!i,..s_kdis!i)#0A..2wrdisrange(i)#0A..2newline()#0A
..}#0A#0A..writes("*n*n..5LG..10SG..10RTN*n")#0A..3
writef("%i7(%i4).",.d_grds,.s_grds)#0A..3writef("%i
7(%i4).",.d_gwrs,.s_gwrs)#0A..3writef("%i7(%i4).",.
d_rtn,..s_rtn)#0A#0A..writes(#0A."*n*n..5LN..10LM..
10RF..10RB..10I*n")#0A..FOR.i.#3D.0.TO.disupb#0A..{
.writef("%i7(%i4).",.d_lndis!i,.s_lndis!i)#0A..2wri
tef("%i7(%i4).",.d_lmdis!i,.s_lmdis!i)#0A..2writef(
"%i7(%i4).",.d_rfdis!i,.s_rfdis!i)#0A..2writef("%i7
(%i4).",.d_rbdis!i,.s_rbdis!i)#0A..2writef("%i7(%i4
).",.d_idis!i,..s_idis!i)#0A..2wrdisrange(i)#0A..2n
ewline()#0A..}#0A..writes.("*nInstruction.types*n*n
")#0A..FOR.i.#3D.0.TO.8.DO#0A..2writef(".%c..%i8(%i
4)..%i4*n",#0A..10"?0124RIBL"%(i+1),.d_ftype!i,.s_f
type!i,#0A..10("012352200000"%(i+1)-'0')*s_ftype!i)
#0A}#0A#0A1AND.analyse_instr().BE#0A{.LET.a.#3D.0#0A
..s_fv!fcode,.d_fv!fcode.:#3D.s_fv!fcode+1,.d_fv!fc
ode+freq#0A..s_fcount,.d_fcount.:#3D.s_fcount+1,.d_
fcount+freq#0A#0A..SWITCHON.instrtype(fcode).INTO#0A
..{.DEFAULT:#0A..2CASE.'?':.s_ftype!0,.d_ftype!0.:#3D
.s_ftype!0+1,.d_ftype!0+freq#0A..12ENDCASE#0A..2CAS
E.'0':.s_ftype!1,.d_ftype!1.:#3D.s_ftype!1+1,.d_fty
pe!1+freq#0A..12ENDCASE#0A..2CASE.'1':.s_ftype!2,.d
_ftype!2.:#3D.s_ftype!2+1,.d_ftype!2+freq#0A..12END
CASE#0A..2CASE.'2':.s_ftype!3,.d_ftype!3.:#3D.s_fty
pe!3+1,.d_ftype!3+freq#0A..12ENDCASE#0A..2CASE.'4':
.s_ftype!4,.d_ftype!4.:#3D.s_ftype!4+1,.d_ftype!4+f
req#0A..12ENDCASE#0A..2CASE.'R':.s_ftype!5,.d_ftype
!5.:#3D.s_ftype!5+1,.d_ftype!5+freq#0A..12a..:#3D.p
c+1.+.gsb(pc+1);#0A..12TEST.a>#3Dpc.THEN.updis(s_rf
dis,.d_rfdis,.a-pc)#0A..23ELSE.updis(s_rbdis,.d_rbd
is,.pc-a)#0A..12ENDCASE#0A..2CASE.'I':.s_ftype!6,.d
_ftype!6.:#3D.s_ftype!6+1,.d_ftype!6+freq#0A..12a.:
#3D.gb(pc+1)#0A..12updis(s_idis,.d_idis,.255-a)#0A.
.12a.:#3D.pc+1.+.2*a.&.#23xFF5E#0A..12a..:#3D.a.+.g
sh(a);.#0A..12TEST.a>#3Dpc.THEN.updis(s_rfdis,.d_rf
dis,.a-pc)#0A..23ELSE.updis(s_rbdis,.d_rbdis,.pc-a)
#0A..12ENDCASE#0A..2CASE.'B':.s_ftype!7,.d_ftype!7.
:#3D.s_ftype!7+1,.d_ftype!7+freq#0A..12ENDCASE#0A..
2CASE.'L':.s_ftype!8,.d_ftype!8.:#3D.s_ftype!8+1,.d
_ftype!8+freq#0A..12ENDCASE#0A..}#0A#0A..SWITCHON.f
code.INTO#0A..{.DEFAULT:#0A..2CASE..0010:#0A..2CASE
..0011:#0A..2CASE..0012:.//..1BRK#0A..12RETURN#0A..
2CASE..0013:.//..2K3#0A..2CASE..0014:.//..2K4#0A..2
CASE..0015:.//..2K5#0A..2CASE..0016:.//..2K6#0A..2C
ASE..0017:.//..2K7#0A..2CASE..0018:.//..2K8#0A..2CA
SE..0019:.//..2K9#0A..2CASE..00010:.//..1K10#0A..2C
ASE..00011:.//..1K11#0A..12call(fcode);.RETURN#0A..
2CASE..00012:.//..2LF#0A..2CASE..00013:.//..1LF$#0A
..12RETURN#0A..2CASE..00014:.//..2LM#0A..12numb(-gb
(pc+1));.RETURN#0A..2CASE..00015:.//..1LM1#0A..2CAS
E..00016:.//..2L0#0A..2CASE..00017:.//..2L1#0A..2CA
SE..00018:.//..2L2#0A..2CASE..00019:.//..2L3#0A..2C
ASE..00020:.//..2L4#0A..2CASE..00021:.//..2L5#0A..2
CASE..00022:.//..2L6#0A..2CASE..00023:.//..2L7#0A..
2CASE..00024:.//..2L8#0A..2CASE..00025:.//..2L9#0A.
.2CASE..00026:.//..1L10#0A..12numb(fcode-16);.RETUR
N#0A..2CASE..00027:.//..FHOP#0A..12RETURN#0A..2CASE
..00028:.//..1JEQ#0A..2CASE..00029:.//..JEQ$#0A..12
cjump();.RETURN#0A..2CASE..00030:.//..JEQ0#0A..2CAS
E..00031:.//.JEQ0$#0A..12cjump0();.RETURN#0A..12RET
URN#0A..2CASE..00032:.//..3K#0A..12call(gb(pc+1));.
RETURN#0A..2CASE..00033:.//..2KH#0A..12call(gh(pc+1
));.RETURN#0A..2CASE..00034:.//..2KW#0A..12call(gw(
pc+1));.RETURN#0A..2CASE..00035:.//..1K3G#0A..2CASE
..00036:.//..1K4G#0A..2CASE..00037:.//..1K5G#0A..2C
ASE..00038:.//..1K6G#0A..2CASE..00039:.//..1K7G#0A.
.2CASE..00040:.//..1K8G#0A..2CASE..00041:.//..1K9G#0A
..2CASE..00042:.//..K10G#0A..2CASE..00043:.//..K11G
#0A..12grd();.call(fcode-32);.RETURN#0A..2CASE..000
44:.//..1S0G#0A..12grd();.vecwr();.RETURN#0A..2CASE
..00045:.//..1L0G#0A..12grd();.vecrd();.RETURN#0A..
2CASE..00046:.//..1L1G#0A..2CASE..00047:.//..1L2G#0A
..12grd();.add();.numb(fcode-45);.vecrd();.RETURN#0A
..2CASE..00048:.//..2LG#0A..12grd();.RETURN#0A..2CA
SE..00049:.//..2SG#0A..12gwr();.RETURN#0A..2CASE..0
0050:.//..1LLG#0A..12RETURN#0A..2CASE..00051:.//..2
AG#0A..12grd();.add();.RETURN#0A..2CASE..00052:.//.
.1MUL#0A..2CASE..00053:.//..1DIV#0A..2CASE..00054:.
//..1REM#0A..2CASE..00055:.//..1XOR#0A..11eop();.RE
TURN#0A..2CASE..00056:.//..2SL#0A..2CASE..00057:.//
..1SL$#0A..2CASE..00058:.//..2LL#0A..2CASE..00059:.
//..1LL$#0A..12RETURN#0A..2CASE..00060:.//..1JNE#0A
..2CASE..00061:.//..JNE$#0A..12cjump();.RETURN#0A..
2CASE..00062:.//..JNE0#0A..2CASE..00063:.//.JNE0$#0A
..12cjump0();.RETURN#0A..2CASE..00064:.//..1LLP#0A.
.2CASE..00065:.//..LLPH#0A..2CASE..00066:.//..LLPW#0A
..12RETURN#0A..2CASE..00067:.//..K3G1#0A..2CASE..00
068:.//..K4G1#0A..2CASE..00069:.//..K5G1#0A..2CASE.
.00070:.//..K6G1#0A..2CASE..00071:.//..K7G1#0A..2CA
SE..00072:.//..K8G1#0A..2CASE..00073:.//..K9G1#0A..
2CASE..00074:.//.K10G1#0A..2CASE..00075:.//.K11G1#0A
..12grd();.call(fcode-64);.RETURN#0A..2CASE..00076:
.//..S0G1#0A..12grd();.vecwr();.RETURN#0A..2CASE..0
0077:.//..L0G1#0A..12grd();.vecrd();.RETURN#0A..2CA
SE..00078:.//..L1G1#0A..2CASE..00079:.//..L2G1#0A..
12grd();.vecrd();.add();.numb(fcode-77);.RETURN#0A.
.2CASE..00080:.//..1LG1#0A..12grd();.RETURN#0A..2CA
SE..00081:.//..1SG1#0A..12gwr();.RETURN#0A..2CASE..
00082:.//..LLG1#0A..12RETURN#0A..2CASE..00083:.//..
1AG1#0A..12grd();.add();.RETURN#0A..2CASE..00084:./
/..1ADD#0A..12add();.RETURN#0A..2CASE..00085:.//..1
SUB#0A..12sub();.RETURN#0A..2CASE..00086:.//..1LSH#0A
..2CASE..00087:.//..1RSH#0A..2CASE..00088:.//..1AND
#0A..2CASE..00089:.//..2OR#0A..12eop();.RETURN#0A..
2CASE..00090:.//..1LL1#0A..2CASE..00091:.//..LL1$#0A
..12RETURN#0A..2CASE..00092:.//..1JLS#0A..2CASE..00
093:.//..JLS$#0A..12cjump();.RETURN#0A..2CASE..0009
4:.//..JLS0#0A..2CASE..00095:.//.JLS0$#0A..12cjump0
();.RETURN#0A..2CASE..00096:.//..3L#0A..12numb(gb(p
c+1));.RETURN#0A..2CASE..00097:.//..2LH#0A..12numb(
gh(pc+1));.RETURN#0A..2CASE..00098:.//..2LW#0A..12n
umb(gw(pc+1));.RETURN#0A..2CASE..00099:.//..K3GH#0A
..2CASE.100:.//..K4GH#0A..2CASE.101:.//..K5GH#0A..2
CASE.102:.//..K6GH#0A..2CASE.103:.//..K7GH#0A..2CAS
E.104:.//..K8GH#0A..2CASE.105:.//..K9GH#0A..2CASE.1
06:.//.K10GH#0A..2CASE.107:.//.K11GH#0A..12grd();.c
all(fcode-96);.RETURN#0A..2CASE.108:.//..S0GH#0A..1
2grd();.vecwr();.RETURN#0A..2CASE.109:.//..L0GH#0A.
.12grd();.vecrd();.RETURN#0A..2CASE.110000:.//..L1G
H#0A..2CASE.111:.//..L2GH#0A..12grd();.numb(fcode-1
09);.add();.vecrd();.RETURN#0A..2CASE.110002:.//..1
LGH#0A..12grd();.RETURN#0A..2CASE.110003:.//..1SGH#0A
..12gwr();.RETURN#0A..2CASE.110004:.//..LLGH#0A..12
RETURN#0A..2CASE.110005:.//..1AGH#0A..12grd();.add(
);.RETURN#0A..2CASE.110006:.//..2RV#0A..12vecrd();.
RETURN#0A..2CASE.110007:.//..1RV1#0A..2CASE.110008:
.//..1RV2#0A..2CASE.110009:.//..1RV3#0A..2CASE.120:
.//..1RV4#0A..2CASE.121:.//..1RV5#0A..2CASE.122:.//
..1RV6#0A..12numb(fcode-110006);.add();.vecrd();.RE
TURN#0A..2CASE.123:.//..1RTN#0A..12s_rtn,.d_rtn.:#3D
.s_rtn+1,.d_rtn+freq#0A..12RETURN#0A..2CASE.124:.//
..1JGR#0A..2CASE.125:.//..JGR$#0A..12cjump();.RETUR
N#0A..2CASE.126:.//..JGR0#0A..2CASE.127:.//.JGR0$#0A
..12cjump0();.RETURN#0A..2CASE.128:.//..2LP#0A..12l
ocrd(gb(pc+1));.RETURN#0A..2CASE.129:.//..1LPH#0A..
12locrd(gh(pc+1));.RETURN#0A..2CASE.130:.//..1LPW#0A
..12locrd(gw(pc+1));.RETURN#0A..2CASE.131:.//..1LP3
#0A..2CASE.132:.//..1LP4#0A..2CASE.133:.//..1LP5#0A
..2CASE.134:.//..1LP6#0A..2CASE.135:.//..1LP7#0A..2
CASE.136:.//..1LP8#0A..2CASE.137:.//..1LP9#0A..2CAS
E.138:.//..LP10#0A..2CASE.139:.//..LP11#0A..2CASE.1
40:.//..LP12#0A..2CASE.141:.//..LP13#0A..2CASE.142:
.//..LP14#0A..2CASE.143:.//..LP15#0A..2CASE.144:.//
..LP16#0A..12locrd(fcode-128);.RETURN#0A..2CASE.145
:.//..1SYS#0A..12RETURN#0A..2CASE.146:.//..1SWB#0A.
.12s_swb,.d_swb.:#3D.s_swb+1,.d_swb+freq#0A..12RETU
RN#0A..2CASE.147:.//..1SWL#0A..12s_swl,.d_swl.:#3D.
s_swl+1,.d_swl+freq#0A..12RETURN#0A..2CASE.148:.//.
.2ST#0A..12vecwr();.RETURN#0A..2CASE.149:.//..1ST1#0A
..2CASE.150:.//..1ST2#0A..2CASE.151:.//..1ST3#0A..1
2numb(fcode-148);.add();.vecwr();.RETURN#0A..2CASE.
152:.//..STP3#0A..2CASE.153:.//..STP4#0A..2CASE.154
:.//..STP5#0A..12locrd(fcode-149);.add();.vecwr();.
RETURN#0A..2CASE.155:.//..GOTO#0A..12RETURN#0A..2CA
SE.156:.//..1JLE#0A..2CASE.157:.//..JLE$#0A..12cjum
p();.RETURN#0A..2CASE.158:.//..JLE0#0A..2CASE.159:.
//.JLE0$#0A..12cjump0();.RETURN#0A..2CASE.160:.//..
2SP#0A..12locwr(gb(pc+1));.RETURN#0A..2CASE.161:.//
..1SPH#0A..12locwr(gh(pc+1));.RETURN#0A..2CASE.162:
.//..1SPW#0A..12locwr(gw(pc+1));.RETURN#0A..2CASE.1
63:.//..1SP3#0A..2CASE.164:.//..1SP4#0A..2CASE.165:
.//..1SP5#0A..2CASE.166:.//..1SP6#0A..2CASE.167:.//
..1SP7#0A..2CASE.168:.//..1SP8#0A..2CASE.169:.//..1
SP9#0A..2CASE.170:.//..SP10#0A..2CASE.171:.//..SP11
#0A..2CASE.172:.//..SP12#0A..2CASE.173:.//..SP13#0A
..2CASE.174:.//..SP14#0A..2CASE.175:.//..SP15#0A..2
CASE.176:.//..SP16#0A..12locwr(fcode-160);.RETURN#0A
..2CASE.177:.//..2S1#0A..2CASE.178:.//..2S2#0A..2CA
SE.179:.//..2S3#0A..2CASE.180:.//..2S4#0A..12numb(f
code-176);.sub();.RETURN#0A..2CASE.181:.//..1XCH#0A
..12RETURN#0A..2CASE.182:.//..GBYT#0A..12s_gbyt,.d_
gbyt.:#3D.s_gbyt+1,.d_gbyt+freq#0A..12RETURN#0A..2C
ASE.183:.//..PBYT#0A..12s_pbyt,.d_pbyt.:#3D.s_pbyt+
1,.d_pbyt+freq#0A..12RETURN#0A..2CASE.184:.//..1ATC
#0A..2CASE.185:.//..1ATB#0A..12RETURN#0A..2CASE.186
:.//..3J#0A..2CASE.187:.//..2J$#0A..12RETURN#0A..2C
ASE.188:.//..1JGE#0A..2CASE.189:.//..JGE$#0A..12cju
mp();.RETURN#0A..2CASE.190:.//..JGE0#0A..2CASE.191:
.//.JGE0$#0A..12cjump0();.RETURN#0A..2CASE.192:.//.
.2AP#0A..12locrd(gb(pc+1));.add();.RETURN#0A..2CASE
.193:.//..1APH#0A..12locrd(gh(pc+1));.add();.RETURN
#0A..2CASE.194:.//..1APW#0A..12locrd(gw(pc+1));.add
();.RETURN#0A..2CASE.195:.//..1AP3#0A..2CASE.196:./
/..1AP4#0A..2CASE.197:.//..1AP5#0A..2CASE.198:.//..
1AP6#0A..2CASE.199:.//..1AP7#0A..2CASE.200:.//..1AP
8#0A..2CASE.201:.//..1AP9#0A..2CASE.202:.//..1AP10#0A
..2CASE.203:.//..1AP11#0A..2CASE.204:.//..1AP12#0A.
.12locrd(fcode-192);.add();.RETURN#0A..2CASE.205:./
/.XPBYT#0A..12s_pbyt,.d_pbyt.:#3D.s_pbyt+1,.d_pbyt+
freq#0A..12RETURN#0A..2CASE.206:.//..1LMH#0A..12num
b(-gh(pc+1));.RETURN#0A..2CASE.207:.//..1BTC#0A..12
RETURN#0A..2CASE.208:.//..1NOP#0A..12RETURN#0A..2CA
SE.209:.//..2A1#0A..2CASE.210:.//..2A2#0A..2CASE.21
1:.//..2A3#0A..2CASE.212:.//..2A4#0A..2CASE.213:.//
..2A5#0A..12numb(fcode-208);.add();.RETURN#0A..2CAS
E.214:.//..RVP3#0A..2CASE.215:.//..RVP4#0A..2CASE.2
16:.//..RVP5#0A..2CASE.217:.//..RVP6#0A..2CASE.218:
.//..RVP7#0A..12locrd(fcode-211);.add();.vecrd();.R
ETURN#0A..2CASE.219:.//.ST0P3#0A..2CASE.220000:.//.
ST0P4#0A..12locrd(fcode-216);.vecwr();.RETURN#0A..2
CASE.220001:.//.ST1P3#0A..2CASE.221:.//.ST1P4#0A..1
2locrd(fcode-218);.numb(1);.add();.vecwr();.RETURN#0A
..2CASE.220003:.//..3-#0A..12RETURN#0A..2CASE.22000
4:.//..3A#0A..12numb(gb(pc+1));.add();.RETURN#0A..2
CASE.220005:.//..2AH#0A..12numb(gh(pc+1));.add();.R
ETURN#0A..2CASE.220006:.//..2AW#0A..12numb(gw(pc+1)
);.add();.RETURN#0A..2CASE.220007:.//..L0P3#0A..2CA
SE.220008:.//..L0P4#0A..2CASE.220009:.//..L0P5#0A..
2CASE.230:.//..L0P6#0A..2CASE.231:.//..L0P7#0A..2CA
SE.232:.//..L0P8#0A..2CASE.233:.//..L0P9#0A..2CASE.
234:.//.L0P10#0A..2CASE.235:.//.L0P11#0A..2CASE.236
:.//.L0P12#0A..12locrd(fcode-220004);.vecrd();.RETU
RN#0A..2CASE.237:.//..3S#0A..12numb(gb(pc+1));.sub(
);.RETURN#0A..2CASE.238:.//..2SH#0A..12numb(gh(pc+1
));.sub();.RETURN#0A..2CASE.239:.//..MDIV#0A..2CASE
.240:.//.CHGCO#0A..12RETURN#0A..2CASE.241:.//..1NEG
#0A..2CASE.242:.//..1NOT#0A..12eop();.RETURN#0A..2C
ASE.243:.//..L1P3#0A..2CASE.244:.//..L1P4#0A..2CASE
.245:.//..L1P5#0A..2CASE.246:.//..L1P6#0A..12numb(1
);.locrd(fcode-240);.add();.vecrd();.RETURN#0A..2CA
SE.247:.//..L2P3#0A..2CASE.248:.//..L2P4#0A..2CASE.
249:.//..L2P5#0A..12numb(2);.locrd(fcode-244);.add(
);.vecrd();.RETURN#0A..2CASE.250:.//..L3P3#0A..2CAS
E.251:.//..L3P4#0A..12numb(3);.locrd(fcode-247);.ad
d();.vecrd();.RETURN#0A..2CASE.252:.//..L4P3#0A..2C
ASE.253:.//..L4P4#0A..12numb(4);.locrd(fcode-249);.
add();.vecrd();.RETURN#0A..2CASE.254:.//..3-#0A..12
RETURN#0A..2CASE.255:.//..3-#0A..}#0A}#0A#0A//.Numb
er#0AAND.numb(n).BE.TEST.n<0.THEN.updis(s_lmdis,.d_
lmdis,.-n)#0A..22ELSE.updis(s_lndis,.d_lndis,.n)#0A
//.Local.read#0AAND.locrd(n).BE.updis(s_lpdis,.d_lp
dis,.n)#0A#0A//.Local.write#0AAND.locwr(n).BE.updis
(s_spdis,.d_spdis,.n)#0A#0A//.Global.read#0AAND.grd
().BE.s_grds,.d_grds.:#3D.s_grds+1,.d_grds+freq#0A#0A
//Global.write#0AAND.gwr().BE.s_gwrs,.d_gwrs.:#3D.s
_gwrs+1,.d_gwrs+freq#0A#0A//.Indirect.read#0AAND.ve
crd().BE.s_gvecap,.d_gvecap.:#3D.s_gvecap+1,.d_gvec
ap+freq#0A#0A//.Indirect.write#0AAND.vecwr().BE.s_p
vecap,.d_pvecap.:#3D.s_pvecap+1,.d_pvecap+freq#0A#0A
//.Add#0AAND.add().BE.s_adds,.d_adds.:#3D.s_adds+1,
.d_adds+freq#0A#0A//.Subtract#0AAND.sub().BE.s_subs
,.d_subs.:#3D.s_subs+1,.d_subs+freq#0A#0A//.Other.e
xpression.operators#0AAND.eop().BE.s_eops,.d_eops.:
#3D.s_eops+1,.d_eops+freq#0A#0A//.Conditional.jump.
(not.on.zero)#0AAND.cjump().BE.s_cj,.d_cj.:#3D.s_cj
+1,.d_cj+freq#0A#0A//.Conditional.jump.on.zero#0AAN
D.cjump0().BE.s_cj0,.d_cj0.:#3D.s_cj0+1,.d_cj0+freq
#0A#0A//.Function.call#0AAND.call(k).BE.updis(s_kdi
s,.d_kdis,.k)#0A#0A//.Accumulate.offset.(or.value).
size.statistics#0AAND.updis(s_v,.d_v,.val).BE#0A{.s
_v!disupb,.d_v!disupb.:#3D.s_v!disupb+1,.d_v!disupb
+freq#0A..IF.val<0.RETURN#0A..IF.val<#3D16.DO..{.s_
v!val,.d_v!val.:#3D.s_v!val+1,.d_v!val+freq#0A..17R
ETURN#0A..15}#0A..IF.val<32.DO..1{.s_v!17,.d_v!17.:
#3D.s_v!17+1,.d_v!17+freq#0A..17RETURN#0A..15}#0A..
IF.val<64.DO..1{.s_v!18,.d_v!18.:#3D.s_v!18+1,.d_v!
18+freq#0A..17RETURN#0A..15}#0A..IF.val<128.DO..{.s
_v!19,.d_v!19.:#3D.s_v!19+1,.d_v!19+freq#0A..17RETU
RN#0A..15}#0A..IF.val<256.DO..{.s_v!20,.d_v!20.:#3D
.s_v!20+1,.d_v!20+freq#0A..17RETURN#0A..15}#0A..IF.
val<512.DO..{.s_v!21,.d_v!21.:#3D.s_v!21+1,.d_v!21+
freq#0A..17RETURN#0A..15}#0A..IF.val<1024.DO.{.s_v!
22,.d_v!22.:#3D.s_v!22+1,.d_v!22+freq#0A..17RETURN#0A
..15}#0A..IF.val<2048.DO.{.s_v!23,.d_v!23.:#3D.s_v!
23+1,.d_v!23+freq#0A..17RETURN#0A..15}#0A..IF.val<4
096.DO.{.s_v!24,.d_v!24.:#3D.s_v!24+1,.d_v!24+freq#0A
..17RETURN#0A..15}#0A..s_v!25,.d_v!25.:#3D.s_v!25+1
,.d_v!25+freq#0A}#0A#0AAND.wrdisrange(i).BE#0A{.IF.
i<#3D16.DO.{.writef("%n",.i);..3RETURN.}#0A..IF.i#3D
17..DO.{.writes("17-31");..3RETURN.}#0A..IF.i#3D18.
.DO.{.writes("32-63");..3RETURN.}#0A..IF.i#3D19..DO
.{.writes("64-127");..2RETURN.}#0A..IF.i#3D20..DO.{
.writes("128-255");..1RETURN.}#0A..IF.i#3D21..DO.{.
writes("256-511");..1RETURN.}#0A..IF.i#3D22..DO.{.w
rites("512-1023");..RETURN.}#0A..IF.i#3D23..DO.{.wr
ites("1024-2047");.RETURN.}#0A..IF.i#3D24..DO.{.wri
tes("2048-4095");.RETURN.}#0A..IF.i#3D25..DO.{.writ
es("4096-");..3RETURN.}#0A..writes("Total")#0A}#0A#0A


######com/sysdebug.b#
//.The.program.allows.the.user.to.inspect.the.compa
cted.memory#0A//.dump.of.the.Cintpos.system#2E#0A#0A
//.Martin.Richards.(c).November.2000006#0A#0A//.Usa
ge:#0A#0A//.dumpsys.[FROM.<image>]#0A#0A//.The.FROM
.argument.specifies.the.dump.image.file,#0A//.the.d
efault.DUMP#2Emem#0A#0A//.The.program.is.a.combinat
ion.of.the.sadebug.function.in.sysb/boot#2Eb#0A//.a
nd.com/dumpsys#2Eb#0A#0A2SECTION.".dumpdebug"#0A#0A
GET."libhdr"#0A#0A1GLOBAL#0A{.eof:.ug#0A..pptr#0A..
gptr#0A..cptr#0A..fsize#0A#0A..regs#0A..membase#0A.
.memlim#0A..memupb#0A..context#0A..ch#0A..lch#0A..r
ch#0A..val#0A..vars#0A..style#0A..bpt_addr#0A..bpt_
instr#0A#0A..imagefilename..//.0.or.name.of.the.ima
ge.file#0A..imagedata..4//.Raw.DUMP#2Emem.file.(#3D
0.if.no.image.given)#0A..addrv..8//.memory.addresse
s#0A..datav..8//.corresponding.pointers.into.imaged
ata#0A..datavupb#0A..imagep..#0A#0A..rec_p;.rec_l..
1//.Recovery.label.for.longjump#0A}#0A#0AMANIFEST.{
#0A..maxpri..2#3D.maxint#0A#0A..sectnamesize.#3D.(1
1.+.bytesperword)/bytesperword#0A..routnamesize.#3D
.(11.+.bytesperword)/bytesperword#0A..nameoffset..1
#3D.-routnamesize#0A..vecupb..5#3D.5001#0A#0A..g_gl
obsize#3D0;.g_sys#3D3;.g_currco#3D7;.g_colist#3D8.#0A
#0A..r_a#3D0#0A..r_b#0A..r_c#0A..r_p#0A..r_g#0A..r_
st#0A..r_pc#0A..r_count#0A..r_mw#0A..r_upb.#3D.r_mw
#0A}#0A#0ALET.rch().BE#0A{.lch.:#3D.sys(Sys_sardch)
.//.This.is.for.BCPL.Cintcode,.not.Cintpos#2E#0A..c
h.:#3D.capitalch(lch)#0A}#0A#0ALET.start().BE#0A{.L
ET.argv..5#3D.VEC.50#0A..AND.datv..5#3D.VEC.1#0A..A
ND.datstrings.#3D.VEC.12#0A..AND.sysin..4#3D.input(
)#0A..AND.sysout..3#3D.output()#0A..AND.imagefilena
me.#3D."DUMP#2Emem"#0A#0A..UNLESS.rdargs("FROM",.ar
gv,.50).DO#0A..{.writes("bad.arguments.for.DUMPDEBU
G*n")#0A..2stop(20)#0A..}#0A#0A..IF.argv!0.DO.image
filename.:#3D.argv!0#0A..IF.imagefilename.UNLESS.ge
timage(imagefilename).DO#0A..{.writef("Unable.to.lo
ad.image.file.%s*n",.imagefilename)#0A..2RETURN#0A.
.}#0A#0A..rec_p,.rec_l.:#3D.level(),.fin#0A#0A..mem
base.:#3D.mem(rootnode+rtn_membase)#0A..memlim..:#3D
.mem(rootnode+rtn_memsize)#0A..context.:#3D.mem(roo
tnode+rtn_context)#0A..//.context.#3D.1..1SIGINT.re
ceived#0A..//.context.#3D.2..1SIGSEGV.received#0A..
//.context.#3D.3..1dump.caused.by.fault.in.BOOT.of.
standalone.debug#0A..//.context.#3D.4..1dump.reques
ted.by.user.calling.sys(Sys_quit,.-2)#0A..//.contex
t.#3D.5..1non.zero.user.fault.code#0A..//.context.#3D
.6..1dump.requested.in.standalone.debug#0A#0A..writ
ef("*nImage.File:.%s",.imagefilename)#0A..IF.memdat
stamp(datv).DO#0A..{.dat_to_strings(datv,.datstring
s)#0A#0A..2writef("..9Dated:..%s.%s*n",.@datstrings
!0,.@datstrings!5)#0A..}#0A..newline()#0A#0A..SWITC
HON.context.INTO#0A..{.DEFAULT:..writef("Unknown.re
ason.(%n).for.dumping.memory",.context)#0A..12ENDCA
SE#0A..2CASE.1:..1writef("Dump.caused.by.signal.SIG
INT")#0A..12ENDCASE#0A..2CASE.2:..1writef("Dump.cau
sed.by.signal.SIGSEGV")#0A..12ENDCASE#0A..2CASE.3:.
.1writef("Dump.caused.by.fault.in.BOOT.or.standalon
e.debug")#0A..12ENDCASE#0A..2CASE.4:..1writef("Dump
.by.user.probably.calling:.dumpmem")#0A..12ENDCASE#0A
..2CASE.5:..1writef("Dump.caused.by.non.zero.user.f
ault.code")#0A..12ENDCASE#0A..2CASE.6:..1writef("Du
mp.requested.in.standalone.debug")#0A..12ENDCASE#0A
..}#0A..newline()#0A..#0A..dumprootnode()#0A#0A..de
bug()#0A#0Afin:#0A..IF.imagedata.DO.freevec(imageda
ta)#0A..IF.addrv..3DO.freevec(addrv)#0A..IF.datav..
3DO.freevec(datav)#0A}#0A#0AAND.memdatstamp(v).#3D.
VALOF#0A{.LET.tv.#3D.rootnode+rtn_days#0A.#0A..UNLE
SS.0<#3Dtv<#3Dmemupb.RESULTIS.FALSE#0A#0A..v!0.:#3D
.mem(tv+0)#0A..v!1.:#3D.mem(tv+1)#0A#0A..RESULTIS.T
RUE#0A}#0A#0AAND.debug().#3D.VALOF#0A{.#0A..rec_p,.
rec_l.:#3D.level(),.recover.//.recovery.point.for.e
rror()#0A#0A..//.Initialise.the.standalone.debugger
#0A..membase.:#3D.mem(rootnode+rtn_membase)#0A..mem
lim..:#3D.membase.+.mem(rootnode+rtn_memsize)#0A#0A
..//.Get.the.breakpoint.vectors.from.the.rootnode#0A
..bpt_addr..:#3D.mem(rootnode+rtn_bptaddr)#0A..bpt_
instr.:#3D.mem(rootnode+rtn_bptinstr)#0A#0A..//.Get
.the.variable.vector.from.the.rootnode#0A..//.so.th
at.vt10.will.work,.but.note.that.our.image#0A..//.o
f.the.dumped.Cintcode.memory.must.be.writable.so#0A
..//.that.1234SV3..will.work.(and.the.removal.of.br
eakpoints)#2E#0A..vars..:#3D.mem(rootnode+rtn_dbgva
rs)#0A#0A..style.:#3D.'F'..15//.Default.printing.st
yle#0A..val..1:#3D.0#0A/*#0A..FOR.i.#3D.0.TO.9.DO..
10//.Remove.all.BRK.instructions.(if.any)#0A..{.LET
.ba.#3D.mem(bpt_addr+i)#0A..2//writef("bpt.%n:.addr
:.%i6..2instr:.%n*n",.i,.ba,.mem(bpt_instr+i))#0A..
2IF.ba.DO.setmemb(0,.ba,.mem(bpt_instr+i))#0A..}#0A
*/#0A..selectprog(1).//.Select.the.CLI.program#0A#0A
..{.LET.gn.#3D.mem(regs+r_pc).-.globword#0A..2LET.c
ode.#3D.mem(rootnode.+.rtn_abortcode)#0A..2LET.mess
.#3D..VALOF.SWITCHON.code.INTO#0A..14{.CASE..0011:.
RESULTIS."Illegal.instruction"#0A..16CASE..0012:.RE
SULTIS."BRK.instruction"#0A..16CASE..0013:.RESULTIS
."Zero.count"#0A..16CASE..0014:.TEST.0<#3Dgn<#3Dmem
(gptr+0)#0A..26THEN.RESULTIS."G%n.unassigned"#0A..2
6ELSE.RESULTIS."Negative.pc"#0A..16CASE..0015:.RESU
LTIS."Division.by.zero"#0A..16CASE..00010:.RESULTIS
."Cintasm.single.step"#0A..16CASE..00011:.RESULTIS.
"Watch.addr:.%+%i7.value:.%i8"#0A..16CASE..00012:.R
ESULTIS."Indirect.address.out.of.range:.%+%+%+%n"#0A
..16CASE..00099:.RESULTIS."User.requested"#0A..16CA
SE.110000:.RESULTIS."Callco.fault"#0A..16CASE.111:.
RESULTIS."Resumeco.fault"#0A..16CASE.110002:.RESULT
IS."Deleteco.fault"#0A..16CASE.180:.RESULTIS."Unabl
e.to.delete.a.task"#0A..16CASE.181:.RESULTIS."Unabl
e.to.send.a.packet"#0A..16CASE.182:.RESULTIS."Unexp
ected.pkt.received"#0A..16CASE.186:.RESULTIS."Bad.i
nput.stream"#0A..16CASE.187:.RESULTIS."Bad.output.s
tream"#0A..16CASE.188:.RESULTIS."Unable.to.replenis
h.input"#0A..16CASE.189:.RESULTIS."Wrch.fault"#0A..
16CASE.190:.RESULTIS."Endread.fault"#0A..16CASE.191
:.RESULTIS."Endwrite.fault"#0A..16CASE.197:.RESULTI
S."Store.chain.fault"#0A..16DEFAULT:..RESULTIS."Unk
nown.fault"#0A..14}#0A#0A..2writef("*nAbort.code:.%
n..",.mem(rootnode+rtn_abortcode))#0A..2writef(mess
,.gn,.mem(1),.mem(2),.mem(3))#0A..2newline()#0A..}#0A
#0Arecover:#0A..ch.:#3D.'*n'#0Anxt:..24//.Main.loop
.for.debug.commands#0A..IF.ch#3D'*n'.DO.prprompt()#0A
#0A..rch().REPEATWHILE.ch#3D'*s'#0Asw:#0A..SWITCHON
.ch.INTO#0A#0A..{.DEFAULT:.error()#0A#0A..2CASE.end
streamch:#0A..5newline()#0A..5RETURN#0A#0A..2CASE.'
*s':#0A..2CASE.'*n':GOTO.nxt#0A..4#0A..2CASE.'?':#0A
..5writes("*n?..8Print.list.of.debug.commands*n")#0A
..5writes("Gn.Pn.Rn.Vn.Wn.An..8Variables*n")#0A..5w
rites("G..P..R..V..W..A..9Pointers*n")#0A..5writes(
"123.#23o377.#23FF00003.'c..7Constants*n")#0A..5wri
tes("**e./e.%e.+e.-e.|e.&e..5Dyadic.operators*n")#0A
..5writes("!e..23Subscription*n")#0A..5writes("<.>.
.22Left/Right.shift.one.place*n")#0A..5writes("$c.$
d.$f.$b.$o.$s.$u.$x..2Set.the.print.style*n")#0A..5
writes("SGn.SPn.SRn.SVn.SAn..6Store.current.value*n
")#0A..5writes("S0.S1..1Select.the.Boot/CLI.program
*n")#0A..5writes("#3D..5Print.current.value*n")#0A.
.5writes("Tn..4Print.n.consecutive.locations*n")#0A
..5writes("Bn..4Print.n.blocks.from.current.positio
n*n")#0A..5writes("I..5Print.current.instruction*n"
)#0A..5writes("N..5Print.next.instruction*n")#0A..5
writes("Q..5Quit.--.exit.from.dumpdebug*n")#0A..5wr
ites("#2E..5Move.to.current.coroutine*n")#0A..5writ
es(",..5Move.down.one.stack.frame*n")#0A..5writes("
;..5Move.to.parent.coroutine*n")#0A..5writes("[..5M
ove.to.first.coroutine*n")#0A..5writes("]..5Move.to
.next.coroutine*n")#0A..5GOTO.recover#0A#0A..2CASE.
'0':.CASE.'1':.CASE.'2':#0A..2CASE.'3':.CASE.'4':.C
ASE.'5':#0A..2CASE.'6':.CASE.'7':.CASE.'8':#0A..2CA
SE.'9':.CASE.'#23':.CASE.'*'':#0A..2CASE.'G':.CASE.
'P':.CASE.'R':#0A..2CASE.'V':.CASE.'A':#0A..12val.:
#3D.rdval();..15GOTO.sw#0A#0A..2CASE.'!':.rch();.va
l.:#3D.cont(val..+..rdval());..GOTO.sw#0A..2CASE.'+
':.rch();.val.:#3D.val..+..rdval();..6GOTO.sw#0A..2
CASE.'-':.rch();.val.:#3D.val..-..rdval();..6GOTO.s
w#0A..2CASE.'**':rch();.val.:#3D.val..*..rdval();..
6GOTO.sw#0A..2CASE.'/':.rch();.{.LET.a.#3D.rdval()#0A
..21UNLESS.a.DO.error()#0A..21val.:#3D.val./.a#0A..
21GOTO.sw#0A..19}#0A..2CASE.'%':.rch();.{.LET.a.#3D
.rdval()#0A..21UNLESS.a.DO.error()#0A..21val.:#3D.v
al.REM.a#0A..21GOTO.sw#0A..19}#0A..2CASE.'|':.rch()
;.val.:#3D.val..|..rdval();..6GOTO.sw#0A..2CASE.'&'
:.rch();.val.:#3D.val..&..rdval();..6GOTO.sw#0A#0A.
.2CASE.'<':.val.:#3D.val.<<.1;..14GOTO.nxt#0A..2CAS
E.'>':.val.:#3D.val.>>.1;..14GOTO.nxt#0A#0A..2CASE.
'#3D':.print(val);.newline();..8GOTO.recover#0A#0A.
.2CASE.'S':.{.LET.type.#3D.?#0A..14rch()#0A..14//.I
s.it.a.program.selection?#0A..14IF.ch#3D'0'.DO.{.se
lectprog(0);..1GOTO.recover.}#0A..14IF.ch#3D'1'.DO.
{.selectprog(1);..1GOTO.recover.}#0A..14//.No.--.it
.must.be.a.store.instruction#0A..14type.:#3D.ch#0A.
.14rch()#0A..14setmem(rdvaraddr(type),.val)#0A..14G
OTO.sw#0A..12}#0A#0A..2CASE.'T':.rch()#0A..10{.LET.
n.#3D.rdn()#0A..12LET.k.#3D.bitsperword#3D32.->.5,.
4#0A..12IF.n<#3D0.DO.n.:#3D.1#0A..12FOR.i#3D0.TO.n-
1.DO#0A..12{.IF.i.REM.k.#3D.0.DO.praddr(val+i)#0A..
14print(cont(val+i))#0A..12}#0A..12newline()#0A..12
GOTO.sw#0A..10}#0A#0A..2CASE.'B':.rch()#0A..10{.LET
.n.#3D.rdn()#0A..12IF.n<#3D0.DO.n.:#3D.1#0A#0A..12{
.LET.size.#3D.0#0A..14LET.blk.#3D.findblock(val)#0A
..14IF.blk<0.BREAK..//.No.suitable.block.found#0A..
14val.:#3D.blk#0A..14size.:#3D.mem(val).&.-2#0A..14
prblock(val)#0A..14n.:#3D.n-1#0A..14UNLESS.n.&.size
.BREAK#0A..14val.:#3D.val+size#0A..12}.REPEAT#0A#0A
..12newline()#0A..12GOTO.sw#0A..10}#0A#0A..2CASE.'$
':.rch()#0A..12UNLESS.ch#3D'B'.|.ch#3D'C'.|.ch#3D'D
'.|.ch#3D'F'.|#0A..19ch#3D'O'.|.ch#3D'S'.|.ch#3D'U'
.|.ch#3D'X'.DO#0A..12{.writef("Valid.style.letters.
are:.BCDFOSUX*n")#0A..14GOTO.nxt#0A..12}#0A..12styl
e.:#3D.ch#0A..12GOTO.nxt#0A#0A..2CASE.'Q':.newline(
)#0A..12RETURN#0A..7#0A..2CASE.'N':.val.:#3D.nextpc
(val)#0A..2CASE.'I':.prinstr(val);.newline();.GOTO.
recover#0A#0A..2CASE.',':..//.Move.down.one.stack.f
rame.and.output.it#2E#0A..11{.LET.a.#3D.cont(pptr)>
>0002#0A..13IF.a#3D0.DO.{.writef(".Base.of.stack*n"
)#0A..25GOTO.recover#0A..23}#0A..13fsize.:#3D.pptr-
a#0A..13pptr.:#3D.a#0A..13wrframe()#0A..13GOTO.reco
ver#0A..11}#0A#0A..2CASE.';':.IF.cptr.DO#0A..12{.LE
T.c.#3D.cont(cptr+co_parent)#0A..14IF.c<#3D0.DO#0A.
.14{.writef(".A.root.coroutine.has.no.parent*n")#0A
..16GOTO.recover#0A..14}#0A..14cptr.:#3D.c#0A..12}#0A
..12GOTO.newc#0A#0A..2CASE.'#2E':.cptr.:#3D.cont(gp
tr+g_currco)#0A..12GOTO.newc#0A#0A..2CASE.']':.cptr
.:#3D.cont(cptr+co_list)#0A..12IF.cptr#3D0.DO.{.wri
tef(".End.of.coroutine.list*n")#0A..27GOTO.recover#0A
..25}#0A..12GOTO.newc#0A#0A..2CASE.'[':.cptr.:#3D.c
ont(gptr+g_colist)#0A#0Anewc:..7UNLESS.cptr.DO#0A..
12{.writef("No.such.coroutine*n")#0A..14GOTO.recove
r#0A..12}#0A..12TEST.cptr#3Dcont(gptr+g_currco)#0A.
.12THEN.pptr.:#3D.cont(regs+r_p)>>0002#0A..12ELSE.p
ptr.:#3D.cont(cptr+co_pptr)>>0002#0A..12fsize.:#3D.
cptr.+.6.+.cont(cptr+co_size).-.pptr#0A..12wrcortn(
)#0A..12GOTO.recover#0A..}#0A}#0A#0AAND.prprompt().
BE#0A{.TEST.regs#3Dbootregs#0A..THEN.writef("#23.")
#0A..ELSE.writef("**.")#0A..deplete(cos)#0A}#0A#0AA
ND.dumprootnode().BE#0A{.writef("*nRootnode.at.%n*n
*n",.rootnode)#0A#0A..writef("..blklist..2%i8*n",.c
ont(rtn_blklist+rootnode))#0A..writef("..memsize..2
%i8*n",.cont(rtn_memsize+rootnode))#0A..writef("..i
nfo..5%i8*n",.cont(rtn_info+rootnode))#0A..writef("
..sys..6%i8*n",.cont(rtn_sys+rootnode))#0A..writef(
"..blib..5%i8*n",.cont(rtn_blib+rootnode))#0A..writ
ef("..boot..5%i8*n",.cont(rtn_boot+rootnode))#0A..w
ritef("..abortcode..%i8*n",.cont(rtn_abortcode+root
node))#0A..writef("..context..2%i8*n",.cont(rtn_con
text+rootnode))#0A..writef("..lastp..4%i8*n",.cont(
rtn_lastp+rootnode))#0A..writef("..lastg..4%i8*n",.
cont(rtn_lastg+rootnode))#0A#0A}#0A#0AAND.findblock
(addr).#3D.VALOF#0A{.//.Find.the.base.of.the.block.
contain.addr#0A..//.return.-1.if.no.such.block#0A..
LET.blocklist..#3D.cont(rootnode+rtn_blklist)#0A..L
ET.topofstore.#3D.cont(rootnode+rtn_memsize)#0A..LE
T.a.#3D.blocklist#0A..LET.free,.used,.n.#3D.0,.0,.0
#0A#0A..{.LET.size.#3D.cont(a).&.-2..8//.Mask.off.t
he.size#0A..2UNLESS.size.BREAK..14//.End.of.block.c
hain.reached#0A#0A..2UNLESS.a.<#3D.a+size.<#3D.topo
fstore.DO#0A..2{.writef("**4Store.chain.corrupt!!*n
*#0A..12*Noticed.at.%n*n",.a)#0A..4RESULTIS.a#0A..2
}#0A..2IF.a.<#3D.addr.<.a+size.RESULTIS.a.//.Found.
the.base.of.the.block#0A..2a.:#3D.a+size#0A..}.REPE
AT#0A#0A..RESULTIS.-1..//.End.of.block.chain.reache
d#0A}#0A#0AAND.prblock(a).BE#0A{.LET.size.#3D.cont(
a)#0A..LET.freeblk.#3D.(size&1)#3D1#0A..size.:#3D.s
ize.&.-2#0A#0A..writef("%i8:%i7.",.a,.size)#0A..IF.
freeblk.DO.{.writes("free.");.GOTO.nxt.}#0A#0A..IF.
a.#3D.(rootnode-1).DO.{.writes("Rootnode");.GOTO.nx
t.}#0A..IF.cont(a+3).#3D.sectword.&.memb(a+4,.0).#3D
.11.DO#0A..{.LET.name.#3D.a+4#0A..2writef("Section.
")#0A..2FOR.i.#3D.1.TO.memb(name,.0).DO.wrch(memb(n
ame,.i))#0A..2GOTO.nxt#0A..}#0A#0A..IF.a+1#3D(cont(
cliregs+r_g)>>0002).DO.{.writef("CLI.Global.vector"
);.GOTO.nxt.}#0A..IF.a+1#3D(cont(bootregs+r_g)>>000
2).DO.{.writef("Boot.Global.vector");.GOTO.nxt.}#0A
..{.LET.p.#3D.cont(cliregs+r_p)>>0002#0A..2IF.a.<#3D
.p.<#3D.a.+.size.DO.{.writef("a.CLI.coroutine.stack
");.GOTO.nxt.}#0A..2p.:#3D.cont(bootregs+r_p)>>0002
#0A..2IF.a.<#3D.p.<#3D.a.+.size.DO.{.writef("a.Boot
.coroutine.stack");.GOTO.nxt.}#0A..}#0Adump:#0A..FO
R.i.#3D.1.TO.5.DO.{.LET.n.#3D.cont(a+i)#0A..20TEST.
-10_001_001<#3Dn<#3D10_001_001#0A..20THEN.writef("%
iA.",.n)#0A..20ELSE.writef("#23x%x8.",.n)#0A..18}#0A
nxt:#0A..newline()#0A}#0A#0A1AND.dumpmemory().BE#0A
{.LET.blocklist..#3D.cont(rootnode+rtn_membase)#0A.
.LET.topofstore.#3D.cont(rootnode+rtn_memsize)#0A..
LET.a.#3D.blocklist#0A..LET.free,.used,.n.#3D.0,.0,
.0#0A..LET.largest_free.#3D.0#0A..LET.joinfree.#3D.
0#0A..LET.sectnames,.routnames,.globinit.#3D.0,.0,.
0#0A..LET.constr.#3D.output()#0A..LET.outstr.#3D.0#0A
#0A..writef("*nMap.of.free.and.allocated.blocks.in.
%n#2E#2E%n*n*n",.membase,.memlim)#0A#0A..WHILE.cont
(a).DO#0A..{.LET.size.#3D.cont(a)#0A..2LET.freeblk.
#3D.(size&1)#3D1#0A#0A..2TEST.freeblk#0A..2THEN.{./
/.Free.block#0A..9size.:#3D.size-1#0A..9free.:#3D.f
ree.+.size#0A..9joinfree.:#3D.joinfree.+.size#0A..9
IF.joinfree.>.largest_free.DO.largest_free.:#3D.joi
nfree#0A..7}#0A..2ELSE.{.//.Used.block#0A..9used.:#3D
.used.+.size#0A..9joinfree.:#3D.0#0A..7}#0A#0A..2UN
LESS.size>#3D0.&.a+size<#3Dtopofstore.DO#0A..2{.wri
tef("**4Store.chain.corrupt!!*n*#0A..12*Noticed.at.
%n*n",.a)#0A..4BREAK#0A..2}#0A#0A..2writef("%i8:%i7
.",.a,.size)#0A..2IF.freeblk.DO.{.writes("free.");.
GOTO.nxt.}#0A#0A..2IF.a.#3D.(rootnode-1).DO.{.write
s("Rootnode");.GOTO.nxt.}#0A..2IF.cont(a+3).#3D.sec
tword.&.memb(a+4,.0).#3D.11.DO#0A..2{.LET.name.#3D.
a+4#0A..4writef("Section.")#0A..4FOR.i.#3D.1.TO.mem
b(name,.0).DO.wrch(memb(name,.i))#0A..4GOTO.nxt#0A.
.2}#0A/*#0A..2FOR.id.#3D.1.TO.cont(tasktab).DO#0A..
2{.LET.t.#3D.cont(tasktab+id)#0A..4IF.t.DO#0A..4{.L
ET.p,.g.#3D.cont(t+tcb_sbase),.cont(t+tcb_gbase)#0A
..6IF.a+1#3Dp.DO.{.writef("Task.%n.stack",.id);.GOT
O.nxt.}#0A..6IF.a+1#3Dg.DO.{.writef("Task.%n.global
.vector",.id);.GOTO.nxt.}#0A..6IF.a+1#3Dt.DO.{.writ
ef("Task.%n.TCB",.id);.GOTO.nxt.}#0A..6IF.g.&.a>500
.FOR.gn.#3D.1.TO.cont(g).IF.a+1#3Dcont(g+gn).DO#0A.
.19{.writef("Task.%n.G%n.#3D>.",.id,.gn)#0A..21GOTO
.dump#0A..19}#0A..4}#0A..2}#0A*/#0Adump:#0A..2FOR.i
.#3D.1.TO.5.DO.{.LET.n.#3D.cont(a+i)#0A..22TEST.-10
_001_001<#3Dn<#3D10_001_001#0A..22THEN.writef("%iA.
",.n)#0A..22ELSE.writef("#23x%x8.",.n)#0A..20}#0Anx
t:.#0A..2newline()#0A..2a.:#3D.a.+.size#0A..}#0A#0A
..writef("End.of.block.list.#3D.%n*n",.a)#0A..topof
store.:#3D.a#0A#0A..writef("*nLargest.contiguous.fr
ee.area:.%n.words*n",.largest_free)#0A..writef("Tot
als:.%n.words.available,.%n.used,.%n.free*n*n",#0A.
.8used+free,.used,.free)#0A#0Aexit:#0A}#0A#0AAND.wr
regs(str,.regs).BE#0A{.writef("*n%s:*n",.str)#0A..w
ritef("a#3D%n.b#3D%n.c#3D%n.",.mem(regs+r_a),.mem(r
egs+r_b),.mem(regs+r_c))#0A..writef("p#3D%n(%n).g#3D
%n(%n).",.mem(regs+r_p),.mem(regs+r_p)>>0002,#0A..2
9mem(regs+r_g),.mem(regs+r_g)>>0002)#0A..writef("st
#3D%n.pc#3D%n.count#3D%n.mw#3D%n*n",.mem(regs+r_st)
,.mem(regs+r_pc),#0A..33mem(regs+r_count),mem(regs+
r_mw))#0A}#0A#0AAND.write_sectname(s).BE#0A{.LET.na
me.#3D.s+3#0A..TEST.(cont(s+2).#3D.sectword).&.(mem
b(s+3,.0).#3D.11)#0A..THEN.FOR.i.#3D.1.TO.11.DO.wrc
h(memb(name,.i))#0A..ELSE.writes("??9")#0A}#0A#0AAN
D.checkaddr(a).#3D.VALOF#0A{.UNLESS.membase<#3Da<#3D
memlim.DO#0A..{.writef("*nBad.address.%n.not.in.ran
ge.%n--%n*n",.a,.membase,.memlim)#0A..2RESULTIS.0#0A
..}#0A..RESULTIS.a#0A}#0A#0AAND.cont(a).#3D.mem(che
ckaddr(a))#0A#0AAND.wrcortn().BE#0A{.LET.size.#3D.c
ont(cptr+co_size)#0A..LET.hwm.#3D.size+6#0A..writef
(".%i7:.",.cptr)#0A..writes("..Coroutine:")#0A..wri
tearg(cont(cptr+co_fn))#0A..writef("..Parent.%n",.m
em(cptr+co_parent))#0A..WHILE.cont(cptr+hwm)#3Dstac
kword.DO.hwm:#3Dhwm-1#0A..writef("..Stack.%n/%n*n",
.size,.hwm-6)#0A..prprompt()#0A..wrch('.')#0A..wrfr
ame()#0A}#0A#0AAND.wrframe().BE#0A{.writef("%i8:",.
pptr)#0A..TEST.pptr#3Dcptr#0A..THEN.writef("..#23St
ackBase#23")#0A..ELSE.writearg(mem(pptr+2))#0A..FOR
.i#3D3.TO.6.UNLESS.i>#3Dfsize.DO.writearg(cont(pptr
+i))#0A..newline()#0A..IF.fsize>7.DO#0A..{.writef("
..10")#0A..2FOR.i.#3D.7.TO.11.UNLESS.i>#3Dfsize.DO.
writearg(cont(pptr+i))#0A..2newline()#0A..}#0A..IF.
fsize>12.DO#0A..{.writef("..10")#0A..2FOR.i.#3D.12.
TO.16.UNLESS.i>#3Dfsize.DO.writearg(cont(pptr+i))#0A
..2newline()#0A..}#0A}#0A#0AAND.writearg(n).BE#0A//
.Write.an.argument.in.a.field.width.of.13.character
s#0A..TEST.isfun(n)#0A..THEN.{.LET.s.#3D.(n>>0002)-
3..//.MR.1/11/03#0A..7LET.len.#3D.memb(s,.0)#0A..7W
HILE.len>0.&.memb(s,.len)#3D'.'.DO.len.:#3D.len-1#0A
..7FOR.i.#3D.len+1.TO.13.DO.wrch('.')#0A..7FOR.i.#3D
.1.TO.len.DO.wrch(memb(s,.i))#0A..5}#0A..ELSE.TEST.
globword<#3Dn<#3Dglobword+1001..//.MR.1/11/03#0A..5
THEN.writef("..5#23G%z3#23",.n-globword)#0A..5ELSE.
TEST.-10_001_001<#3Dn<#3D10_001_001#0A..10THEN.writ
ef("..%iB",.n)#0A..10ELSE.writef("..1#23x%x8",.n)#0A
#0AAND.isfun(f).#3D.VALOF#0A{.LET.a.#3D.f>>0002#0A/
/sawritef("isfun(%n)*n",.f)#0A..UNLESS.(f&3)#3D0.&.
membase+4<a<#3Dmemlim.RESULTIS.FALSE.//.MR.25/9/03#0A
//sawritef("isfun:.a#3D%n*n",.a)#0A..IF.mem(a-4)#3D
entryword.&.memb(a-3,.0)#3D11.RESULTIS.TRUE.#0A//sa
writef("isfun:.returning.FALSE*n")#0A..RESULTIS.FAL
SE#0A}#0A#0AAND.getimage(filename).#3D.VALOF#0A{.LE
T.res.#3D.FALSE#0A..LET.oldin.#3D.input()#0A..LET.s
cb.#3D.findinput(filename)#0A..LET.size,.upb,.words
read.#3D.0,.0,.0#0A#0A..imagedata,.addrv,.datav.:#3D
.0,.0,.0#0A#0A..UNLESS.scb.RESULTIS.FALSE#0A..size.
:#3D.sys(Sys_filesize,.scb!scb_fd)..2//.Size.in.byt
es#0A..IF.size.DO.upb..:#3D.(size-1)/bytesperword./
/.UPB.in.words..4#0A#0A..imagedata.:#3D.getvec(upb)
#0A..UNLESS.imagedata.DO#0A..{.writef("Unable.to.al
locate.a.vector.with.upb#3D%n*n",.upb)#0A..2GOTO.re
t#0A..}#0A..selectinput(scb)#0A..wordsread.:#3D.rea
dwords(imagedata,.upb+1)#0A..UNLESS.upb+1#3Dwordsre
ad.DO#0A..{.writef("Read.%n.words.from.%s,.it.shoul
d.have.been.%n*n",#0A..10wordsread,.filename,.upb+1
)#0A..2GOTO.ret#0A..}#0A..//writef("Read.%n.words.f
rom.%s*n",.wordsread,.filename)#0A..//FOR.i.#3D.0.T
O.upb>31->31,.upb.DO.writef("%i5:.%x8*n",.i,.imaged
ata!i)#0A#0A..memupb.:#3D.imagedata!0#0A..imagep.:#3D
.1#0A#0A..datavupb.:#3D.0#0A..{.LET.addr,.imagep.#3D
.0,.1#0A..2UNTIL.addr.>.memupb.DO#0A..2{.LET.n.#3D.
imagedata!imagep#0A#0A//TEST.n>#3D0.THEN.writef("%i
9:.%i9.BLOCK*n",.addr,.n)#0A//..8ELSE.writef("%i9:.
%i9.x.%x8*n",.addr,.-n,.imagedata!(imagep+1))#0A..4
UNLESS.n.BREAK#0A#0A..4TEST.n>0.THEN.imagep.:#3D.im
agep.+.n.+.1#0A..13ELSE.imagep.:#3D.imagep.+.2#0A..
4datavupb.:#3D.datavupb.+.1#0A..4//addrv!datavupb.:
#3D.addr#0A..4//datav!datavupb.:#3D.p#0A..4addr.:#3D
.addr.+.ABS.n#0A..2}#0A..2UNLESS.addr.#3D.memupb+1.
DO#0A..2{.writef("Image.file.is.corrupt,.addr#3D%n.
memupb#3D%n*n",.addr,.memupb)#0A..4GOTO.ret#0A..2}#0A
..}#0A//..writef("Image.file.ok,.datavupb#3D%n*n",.
datavupb)#0A#0A..addrv.:#3D.getvec(datavupb)#0A..da
tav.:#3D.getvec(datavupb)#0A..UNLESS.addrv.&.datav.
DO#0A..{.writef("More.space.needed*n")#0A..2GOTO.re
t#0A..}#0A#0A..datavupb.:#3D.0#0A#0A..{.LET.addr,.i
magep.#3D.0,.1#0A..2UNTIL.addr.>.memupb.DO#0A..2{.L
ET.n.#3D.imagedata!imagep#0A#0A..4UNLESS.n.BREAK#0A
#0A..4datavupb.:#3D.datavupb.+.1#0A..4addrv!datavup
b.:#3D.addr#0A..4datav!datavupb.:#3D.imagep#0A#0A..
4TEST.n>0.THEN.imagep.:#3D.imagep.+.n.+.1#0A..13ELS
E.imagep.:#3D.imagep.+.2#0A..4addr.:#3D.addr.+.ABS.
n#0A..2}#0A#0A..2UNLESS.addr.#3D.memupb+1.DO#0A..2{
.writef("Image.file.is.corrupt,.addr#3D%n.memupb#3D
%n*n",.addr,.memupb)#0A..4GOTO.ret#0A..2}#0A..}#0A#0A
..res.:#3D.TRUE#0Aret:#0A..IF.scb.DO.endstream(scb)
#0A..selectinput(oldin)#0A..RESULTIS.res#0A}#0A#0AA
ND.mem(p).#3D.VALOF.//.Get.a.word.of.dumped.memory#0A
{.LET.i,.j,.len,.res.#3D.1,.datavupb+1,.0,.0#0A..UN
LESS.0<#3Dp<#3Dmemupb.DO#0A..{.writef("*nBad.Cintpo
s.memory.address.%x8..%n*n",.p,.p)#0A..2longjump(re
c_p,.rec_l)#0A..2RESULTIS.#23xBAD00BAD#0A..}#0A#0A.
.{.LET.m.#3D.(i+j)/2#0A//..2writef("addrv!m#3D%i9.p
#3D%n..i#3D%i2.m#3D%i2.j#3D%i2*n",.addrv!m,.p,.i,.m
,.j)#0A//abort(1001)#0A..2IF.i#3Dm.BREAK#0A..2TEST.
addrv!m.<#3D.p.THEN.i.:#3D.m#0A..20ELSE.j.:#3D.m#0A
..}.REPEAT#0A#0A..len.:#3D.imagedata!(datav!i)#0A..
//writef("len.#3D.%n..datav!i#3D%n*n*n",.len,.datav
!i)#0A..TEST.len>0.THEN.res.:#3D.imagedata!(datav!i
.+.p-addrv!i+1)#0A..11ELSE.res.:#3D.imagedata!(data
v!i.+.1)#0A..//writef("mem(%n).#3D>.%x8..%i9*n",.p,
.res,.res)#0A..RESULTIS.res#0A}#0A#0AAND.setmem(p,.
val).BE.//.Set.a.word.of.dumped.memory#0A{.LET.i,.j
,.len,.res.#3D.1,.datavupb+1,.0,.0#0A..UNLESS.0<#3D
p<#3Dmemupb.DO#0A..{.writef("*nBad.Cintpos.memory.a
ddress.%x8..%n*n",.p,.p)#0A..2longjump(rec_p,.rec_l
)#0A..}#0A#0A..{.LET.m.#3D.(i+j)/2#0A//..2writef("a
ddrv!m#3D%i9.p#3D%n..i#3D%i2.m#3D%i2.j#3D%i2*n",.ad
drv!m,.p,.i,.m,.j)#0A//abort(1001)#0A..2IF.i#3Dm.BR
EAK#0A..2TEST.addrv!m.<#3D.p.THEN.i.:#3D.m#0A..20EL
SE.j.:#3D.m#0A..}.REPEAT#0A#0A..len.:#3D.imagedata!
(datav!i)#0A..//writef("len.#3D.%n..datav!i#3D%n*n*
n",.len,.datav!i)#0A..IF.len<#3D0.DO#0A..{.writef("
Unable.to.write.%x8.to.location.%n*n",.val,.p)#0A..
2RETURN#0A..}#0A..imagedata!(datav!i.+.p-addrv!i+1)
.:#3D.val#0A}#0A#0AAND.memb(p,.n).#3D.VALOF.//.Read
.a.byte.of.dumped.memory#0A{.LET.word.#3D.mem(p+(n>
>0002))#0A..RESULTIS.(@word)%(n&3)#0A}#0A#0AAND.set
memb(p,.n,.byte).#3D.VALOF.//.Set.a.byte.of.dumped.
memory#0A{.LET.word.#3D.mem(p+(n>>0002))#0A..(@word
)%(n&3).:#3D.byte#0A..setmem(p+(n>>0002),.word)#0A}
#0A#0AAND.rdn().#3D.VALOF#0A{.LET.res.#3D.0#0A..WHI
LE.'0'<#3Dch<#3D'9'.DO.{.res.:#3D.res*10.+.ch.-.'0'
;.rch().}#0A..RESULTIS.res#0A}#0A#0AAND.rdvaraddr(t
ype).#3D.VALOF#0A{.LET.base,.lim,.n.#3D.?,.?,.?#0A.
.UNLESS.'0'<#3Dch<#3D'9'.DO.error()#0A..n.:#3D.rdn(
)#0A..SWITCHON.type.INTO#0A..{.DEFAULT:..1error()#0A
..2CASE.'P':.base,.lim.:#3D.pptr,.fsize;..9ENDCASE#0A
..2CASE.'G':.base,.lim.:#3D.gptr,.gptr!g_globsize;.
ENDCASE#0A..2CASE.'R':.base,.lim.:#3D.regs,.r_upb;.
.9ENDCASE#0A..2CASE.'V':.base,.lim.:#3D.vars,.9;..1
3ENDCASE#0A..2CASE.'A':.base,.lim.:#3D..0020,.memli
m;..8ENDCASE#0A..}#0A..UNLESS.0<#3Dn<#3Dlim.DO.erro
r()#0A..RESULTIS.base.+.n#0A}#0A#0AAND.rdval().#3D.
VALOF#0A{.LET.res,.radix.#3D.0,.10#0A#0A..SWITCHON.
ch.INTO#0A..{.DEFAULT:..1error()#0A#0A..2CASE.'G':.
.rch()#0A..13IF.'0'<#3Dch<#3D'9'.RESULTIS.mem(rdvar
addr('G'))#0A..13RESULTIS.gptr#0A#0A..2CASE.'P':..r
ch()#0A..13IF.'0'<#3Dch<#3D'9'.RESULTIS.mem(rdvarad
dr('P'))#0A..13RESULTIS.pptr#0A#0A..2CASE.'R':..rch
()#0A..13IF.'0'<#3Dch<#3D'9'.RESULTIS.mem(rdvaraddr
('R'))#0A..13RESULTIS.regs#0A#0A..2CASE.'V':..rch()
#0A..13IF.'0'<#3Dch<#3D'9'.RESULTIS.mem(rdvaraddr('
V'))#0A..13RESULTIS.vars#0A#0A..2CASE.'A':..rch()#0A
..13IF.'0'<#3Dch<#3D'9'.RESULTIS.mem(rdvaraddr('A')
)#0A..13RESULTIS.0#0A#0A..2CASE.'*'':.rch();.res.:#3D
.lch;.rch();..RESULTIS.res#0A#0A..2CASE.'#23':..rad
ix.:#3D.16#0A..13rch()#0A..13IF.ch#3D'O'.DO.{.radix
.:#3D.8;.rch().}#0A#0A..2CASE.'0':.CASE.'1':.CASE.'
2':.CASE.'3':.CASE.'4':.#0A..2CASE.'5':.CASE.'6':.C
ASE.'7':.CASE.'8':.CASE.'9':.#0A..13{.LET.d.#3D.100
#0A..15IF.'0'<#3Dch<#3D'9'.DO.d.:#3D.ch-'0'#0A..15I
F.'A'<#3Dch<#3D'F'.DO.d.:#3D.ch-'A'+10#0A..15IF.d>#3D
radix.RESULTIS.res#0A..15res.:#3D.res*radix+d#0A..1
5rch()#0A..13}.REPEAT#0A..}#0A}#0A#0AAND.praddr(a).
BE#0A{.LET.type,.base.#3D.'A',.0#0A..IF.pptr.<#3D.a
.<#3D.pptr+fsize..14DO.type,.base.:#3D.'P',.pptr#0A
..IF.gptr.<#3D.a.<#3D.gptr+mem(gptr+g_globsize).DO.
type,.base.:#3D.'G',.gptr#0A..IF.vars.<#3D.a.<#3D.v
ars+9..18DO.type,.base.:#3D.'V',.vars#0A..IF.regs.<
#3D.a.<#3D.regs+r_upb..14DO.type,.base.:#3D.'R',.re
gs#0A..writef("*n%c%i5:",.type,.a-base)#0A}#0A#0AAN
D.print1(n).BE#0A{.sawritef("*nprint:.n#3D%n*n",.n)
#0A..print1(n)#0A}#0A#0AAND.print(n).BE.SWITCHON.st
yle.INTO#0A{.DEFAULT:..1error();..15RETURN#0A..CASE
.'C':..{.LET.p.#3D.@n#0A..13writes(".")#0A..13FOR.i
.#3D.0.TO.3.DO#0A..13{.LET.ch.#3D.p%i#0A..15wrch(32
<#3Dch<#3D127.->.ch,.'#2E')#0A..13}#0A..13RETURN#0A
..11}#0A..CASE.'B':..writef(.".%bW.",.n);..3RETURN#0A
..CASE.'D':..writef(.".%IA.",.n);..3RETURN#0A..CASE
.'F':..writearg(n);..11RETURN#0A..CASE.'O':..writef
(.".%OC.",.n);..3RETURN#0A..CASE.'S':..checkaddr(n)
#0A..11writef(.".%S.",..n);..3RETURN#0A..CASE.'U':.
.writef(.".%UA.",.n);..3RETURN#0A..CASE.'X':..write
f(.".%X8.",.n);..3RETURN#0A}#0A#0AAND.selectprog(id
).BE#0A{.//.id#3D0.selects.the.boot.program,.and#0A
..//.id#3D1.selects.the.CLI.program#0A..//.It.selec
ts.the.appropriate.register.set,.etc#0A..//.ie.it.s
ets:.regs,.gptr,.pptr,.cptr.and.fsize#0A#0A..TEST.i
d#3D0.#0A..THEN.regs.:#3D.bootregs..3//.regs.of.crn
task.at.time.of.fault#0A..ELSE.regs.:#3D.cliregs..4
//.regs.at.time.of.fault#0A#0A..gptr..:#3D.mem(r_g.
+.regs).>>.2#0A..pptr..:#3D.mem(r_p.+.regs).>>.2#0A
#0A..//.Set.current.coroutine.if.in.user.or.kernel.
mode.and.the.task#0A..//.is.active#0A..cptr.:#3D.me
m(gptr+g_currco)#0A#0A..//.Unset.cptr.if.there.is.a
.problem#0A..UNLESS.cptr.<#3D.pptr.<#3D.cptr.+.mem(
cptr+co_size).+.6.DO.cptr.:#3D.0#0A#0A..fsize.:#3D.
100#0A//sawritef("cptr#3D%n*n",.cptr)#0A..IF.cptr.D
O.fsize.:#3D.cptr.+.6.+.mem(cptr+co_size).-.pptr#0A
//sawritef("fsize#3D%n*n",.fsize)#0A#0A..TEST.id#3D
0#0A..THEN.writef("*nBoot.program.selected*n")#0A..
ELSE.writef("*nCLI.program.selected*n")#0A}#0A#0AAN
D.error().BE.{.writes("..??*n");.longjump(rec_p,.re
c_l).}#0A#0AAND.wrfcode(f).BE#0A{.LET.s.#3D.VALOF.S
WITCHON.f&31.INTO#0A..{.DEFAULT:#0A..2CASE..0000:.R
ESULTIS."..3-..3K..1LLP..3L..2LP..2SP..2AP..3A"#0A.
.2CASE..0001:.RESULTIS."..3-..2KH..LLPH..2LH..1LPH.
.1SPH..1APH..2AH"#0A..2CASE..0002:.RESULTIS."..1BRK
..2KW..LLPW..2LW..1LPW..1SPW..1APW..2AW"#0A..2CASE.
.0003:.RESULTIS."..2K3..1K3G..K3G1..K3GH..1LP3..1SP
3..1AP3..L0P3"#0A..2CASE..0004:.RESULTIS."..2K4..1K
4G..K4G1..K4GH..1LP4..1SP4..1AP4..L0P4"#0A..2CASE..
0005:.RESULTIS."..2K5..1K5G..K5G1..K5GH..1LP5..1SP5
..1AP5..L0P5"#0A..2CASE..0006:.RESULTIS."..2K6..1K6
G..K6G1..K6GH..1LP6..1SP6..1AP6..L0P6"#0A..2CASE..0
007:.RESULTIS."..2K7..1K7G..K7G1..K7GH..1LP7..1SP7.
.1AP7..L0P7"#0A..2CASE..0008:.RESULTIS."..2K8..1K8G
..K8G1..K8GH..1LP8..1SP8..1AP8..L0P8"#0A..2CASE..00
09:.RESULTIS."..2K9..1K9G..K9G1..K9GH..1LP9..1SP9..
1AP9..L0P9"#0A..2CASE.10:.RESULTIS."..1K10..K10G.K1
0G1.K10GH..LP10..SP10..AP10.L0P10"#0A..2CASE.11:.RE
SULTIS."..1K11..K11G.K11G1.K11GH..LP11..SP11..AP11.
L0P11"#0A..2CASE.12:.RESULTIS."..2LF..1S0G..S0G1..S
0GH..LP12..SP12..AP12.L0P12"#0A..2CASE.13:.RESULTIS
."..1LF$..1L0G..L0G1..L0GH..LP13..SP13.XPBYT..3S"#0A
..2CASE.14:.RESULTIS."..2LM..1L1G..L1G1..L1GH..LP14
..SP14..1LMH..2SH"#0A..2CASE.15:.RESULTIS."..1LM1..
1L2G..L2G1..L2GH..LP15..SP15..1BTC..MDIV"#0A..2CASE
.16:.RESULTIS."..2L0..2LG..1LG1..1LGH..LP16..SP16..
1NOP.CHGCO"#0A..2CASE.17:.RESULTIS."..2L1..2SG..1SG
1..1SGH..1SYS..2S1..2A1..1NEG"#0A..2CASE.18:.RESULT
IS."..2L2..1LLG..LLG1..LLGH..1SWB..2S2..2A2..1NOT"#0A
..2CASE.19:.RESULTIS."..2L3..2AG..1AG1..1AGH..1SWL.
.2S3..2A3..L1P3"#0A..2CASE.20:.RESULTIS."..2L4..1MU
L..1ADD..2RV..2ST..2S4..2A4..L1P4"#0A..2CASE.21:.RE
SULTIS."..2L5..1DIV..1SUB..1RV1..1ST1..1XCH..2A5..L
1P5"#0A..2CASE.22:.RESULTIS."..2L6..1REM..1LSH..1RV
2..1ST2..GBYT..RVP3..L1P6"#0A..2CASE.23:.RESULTIS."
..2L7..1XOR..1RSH..1RV3..1ST3..PBYT..RVP4..L2P3"#0A
..2CASE.24:.RESULTIS."..2L8..2SL..1AND..1RV4..STP3.
.1ATC..RVP5..L2P4"#0A..2CASE.25:.RESULTIS."..2L9..1
SL$..2OR..1RV5..STP4..1ATB..RVP6..L2P5"#0A..2CASE.2
6:.RESULTIS."..1L10..2LL..1LL1..1RV6..STP5..3J..RVP
7..L3P3"#0A..2CASE.27:.RESULTIS."..FHOP..1LL$..LL1$
..1RTN..GOTO..2J$.ST0P3..L3P4"#0A..2CASE.28:.RESULT
IS."..1JEQ..1JNE..1JLS..1JGR..1JLE..1JGE.ST0P4..L4P
3"#0A..2CASE.29:.RESULTIS."..JEQ$..JNE$..JLS$..JGR$
..JLE$..JGE$.ST1P3..L4P4"#0A..2CASE.30:.RESULTIS.".
.JEQ0..JNE0..JLS0..JGR0..JLE0..JGE0.ST1P4..3-"#0A..
2CASE.31:.RESULTIS.".JEQ0$.JNE0$.JLS0$.JGR0$.JLE0$.
JGE0$..2MW..3-"#0A..}#0A..LET.n.#3D.f>>0005.&.7#0A.
.FOR.i.#3D.6*n+1.TO.6*(n+1).DO.wrch(s%i)#0A}#0A#0AA
ND.prinstr(pc).BE#0A{.LET.a.#3D.0#0A..writef(".%i7:
.",.pc)#0A..checkaddr(pc>>0002)#0A..wrfcode(gb(pc))
#0A..SWITCHON.instrtype(gb(pc)).INTO#0A..{.DEFAULT:
#0A..2CASE.'0':..36RETURN#0A..2CASE.'1':.a..:#3D.gb
(pc+1);..20ENDCASE#0A..2CASE.'2':.a..:#3D.gh(pc+1);
..20ENDCASE#0A..2CASE.'4':.a..:#3D.gw(pc+1);..20END
CASE#0A..2CASE.'R':.a..:#3D.pc+1.+.gsb(pc+1);..12EN
DCASE#0A..2CASE.'I':.pc.:#3D.pc+1.+.2*gb(pc+1).&.#23
xFF5E#0A..12a..:#3D.pc.+.gsh(pc);..16ENDCASE#0A..}#0A
..writef("..%n",.a)#0A..vars!9.:#3D.a#0A}#0A#0AAND.
gb(pc).#3D.memb(0,.pc)#0A#0AAND.gsb(pc).#3D.gb(pc)<
#3D127.->.gb(pc),.gb(pc)-256#0A#0AAND.gsh(pc).#3D.V
ALOF#0A{.LET.h.#3D.gh(pc)#0A..RESULTIS.h<#3D#23x7FF
1.->.h,.h.-.#23x1002#0A}#0A#0AAND.gh(pc).#3D.VALOF#0A
{.LET.w.#3D.0#0A..LET.p.#3D.@w..//.Designed.to.work
.on.both.Big.and.Little.Ender.M/Cs#2E#0A..p%0,.p%1,
.p%2,.p%3.:#3D.gb(pc),.gb(pc+1),.gb(pc),.gb(pc+1)#0A
..RESULTIS.w.&.#23xFF2#0A}#0A#0AAND.gw(pc).#3D.VALO
F#0A{.LET.w.#3D.0#0A..LET.p.#3D.@w..//.Designed.to.
work.on.both.Big.and.Little.Ender.M/Cs#2E#0A..p%0,.
p%1,.p%2,.p%3.:#3D.gb(pc),.gb(pc+1),.gb(pc+2),.gb(p
c+3)#0A..RESULTIS.w#0A}#0A#0AAND.instrtype(f).#3D."
?008RI10011RIRI*#0A..16*12411015002RIRIRIRI*#0A..16
*12411015004RIRIRI*#0A..16*12422015006RIRI*#0A..16*
1240013BL006RIRI*#0A..16*1240021RIRIRI*#0A..16*1240
08?2?000134*#0A..16*1240000812?0012??"%f#0A#0AAND.n
extpc(pc).#3D.VALOF.SWITCHON.instrtype(gb(pc)).INTO
#0A..21{.DEFAULT:#0A..23CASE.'0':.RESULTIS.pc+1#0A.
.23CASE.'1':#0A..23CASE.'R':#0A..23CASE.'I':.RESULT
IS.pc+2#0A..23CASE.'2':.RESULTIS.pc+3#0A..23CASE.'4
':.RESULTIS.pc+5#0A..23CASE.'B':.pc.:#3D.pc+2.&.#23
xFF5E#0A..33RESULTIS.pc.+.4*gh(pc).+.6#0A..23CASE.'
L':.pc.:#3D.pc+2.&.#23xFF5E#0A..33RESULTIS.pc.+.2*g
h(pc).+.6#0A..21}#0A#0A

######com/testtime.b#
GET."libhdr"#0D#0A#0D#0ALET.start().#3D.VALOF#0D#0A
{.LET.v.#3D.VEC.5#0D#0A..LET.days.#3D.0#0D#0A..LET.
hours.#3D.0#0D#0A..LET.mins.#3D.0#0D#0A..LET.secs.#3D
.0#0D#0A..LET.msecs.#3D.0#0D#0A.#0D#0A..MANIFEST.{.
secspermin#3D60;.secsperhour#3D60*60;.secsperday.#3D
.60*60*24.}#0D#0A#0D#0A..sys(Sys_datstamp,.v)#0D#0A
..//.v!0.#3D.days.since.1.Jan.1970#0D#0A..//.v!1.#3D
.msecs.since.midnight#0D#0A..//.v!2.#3D.ticks.or.-1
#0D#0A..//FOR.i.#3D.0.TO.2.DO.writef(".%i9",.v!i)#0D
#0A..//newline()#0D#0A#0D#0A..days.:#3D.v!0#0D#0A..
msecs.:#3D.v!1#0D#0A..//.Assume.new.dat.format#0D#0A
..secs.:#3D.msecs/1001#0D#0A..mins.:#3D.secs/60#0D#0A
..hours.:#3D.mins/60#0D#0A..mins.:#3D.mins.MOD.60#0D
#0A..secs.:#3D.secs.MOD.60#0D#0A..msecs.:#3D.msecs.
MOD.1001#0D#0A#0D#0A..writef("days#3D%n.hours#3D%n.
mins#3D%n.secs#3D%n.msecs#3D%n*n",#0D#0A..8days,.ho
urs,.mins,.secs,.msecs)#0D#0A#0D#0A#0D#0A..RESULTIS
.0#0D#0A}#0D#0A#0D#0A

######com/testtr.b#
GET."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.LET.k.#3D
.sys(Sys_settrcount,.0)#0A..LET.p.#3D.0#0A#0A..writ
ef("initial.trcount#3D%n*n",.k)#0A#0A..FOR.i.#3D.0.
TO.4100.DO.sys(Sys_trpush,.#23xDD000004+i)#0A#0A../
/.Stop.trpushing#0A..k.:#3D.sys(Sys_settrcount,.-1)
#0A..writef("Number.of.trpush.values.#3D.%n*n",.k)#0A
..p.:#3D.k.-.4096#0A..IF.p<0.DO.p.:#3D.0#0A..FOR.i.
#3D.p.TO.k-1.DO#0A..{.LET.val.#3D.sys(Sys_gettrval,
.i)#0A..2LET.flag.#3D.val>>00024#0A..2val.:#3D.val.
&.#23xFF4#0A..2IF.(i-p).MOD.8.#3D.0.DO.writef("*n%i
4:",.i-p)#0A..2TEST.flag#3D#23x66#0A..2THEN.writef(
"..%6#2E3d:",.val).//.Time.item.inserted.by.trpush#0A
..2ELSE.writef("%6i/%x2",.val,.flag).#0A..}#0A..new
line()#0A..#0A..RESULTIS.0#0A}#0A

######com/time.b#
//.(C).Copyright.1978.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0A//.Modified.27/1/2011#0A#0ASECTION."TIME"#0A#0AG
ET."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.LET.tost
ream,.precise.#3D.0,.FALSE#0A..LET.days,.msecs.#3D.
0,.0#0A..LET.argv.#3D.VEC.50#0A..LET.v.#3D.VEC.14#0A
#0A..UNLESS.rdargs("TO/K,MSECS/S",.argv,.50).DO#0A.
.{.writef("Bad.arguments.for.TIME*n")#0A..2RESULTIS
.20#0A..}#0A#0A..IF.argv!0.DO..22//.TO/K#0A..{.tost
ream.:#3D.findoutput(argv!0)#0A..2UNLESS.tostream.D
O#0A..2{.writef("**4Can*'t.open.%s*n",.argv!0)#0A..
4RESULTIS.20#0A..2}#0A..2selectoutput(tostream)#0A.
.}#0A#0A..precise.:#3D.argv!1..14//.MSECS/S#0A#0A..
datstamp(@days)#0A..dat_to_strings(@days,.v)#0A..wr
itef(".%s",.v+5)#0A..IF.precise.DO.writef("#2E%3z",
.msecs.MOD.1001)#0A..newline()#0A..IF.tostream.DO.e
ndstream(tostream)#0A..RESULTIS.0#0A}#0A#0A

######com/type.b#
//.(C).Copyright.1978.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0ASECTION."TYPE"#0A#0AGET."libhdr"#0A#0AGLOBAL#0A{
#0Ainputstream:ug#0Aoutputstream#0Anumbers#0Alinenu
mber#0A}#0A#0ALET.start().#3D.VALOF#0A{.LET.argv.#3D
.VEC.50#0A..LET.rc.#3D.0#0A..LET.ch.#3D.0#0A..LET.o
ldoutput.#3D.output()#0A#0A..inputstream.:#3D.0#0A.
.outputstream.:#3D.0#0A#0A..UNLESS.rdargs("FROM/A,T
O,OPT/K",.argv,.50).DO#0A..{.writes("Bad.args*n")#0A
..2rc.:#3D.20#0A..2GOTO.exit#0A..}#0A#0A..inputstre
am.:#3D.findinput(argv!0)#0A..UNLESS.inputstream.DO
.{.writef("Can*'t.open.%s*n",.argv!0)#0A..24rc.:#3D
.20#0A..24GOTO.exit#0A..22}#0A..selectinput(inputst
ream)#0A#0A..UNLESS.argv!1#3D0.DO#0A..{.outputstrea
m.:#3D.findoutput(argv!1)#0A..2IF.outputstream#3D0.
DO#0A..2{.writef("Can*'t.open.%s*n",.argv!1)#0A..4r
c.:#3D.20#0A..4GOTO.exit#0A..2}#0A..2selectoutput(o
utputstream)#0A..}#0A#0A..numbers.:#3D.FALSE#0A#0A.
.IF.argv!2.DO#0A..{.LET.opts.#3D.argv!2#0A..2FOR.i.
#3D.1.TO.opts%0.SWITCHON.capitalch(opts%i).INTO#0A.
.2{.CASE.'N':.numbers.:#3D.TRUE#0A..14ENDCASE#0A..2
}#0A..}#0A#0A..linenumber.:#3D.1#0A#0A..{.LET.tab.#3D
.0#0A#0A..2{.ch.:#3D.rdch()#0A..4IF.intflag().DO.{.
IF.tab.DO.wrch('*n')#0A..22selectoutput(oldoutput)#0A
..22writes("**2BREAK*n")#0A..22rc.:#3D.5#0A..22GOTO
.exit#0A..20}#0A..4UNLESS.tab.DO.{.IF.ch#3Dendstrea
mch.GOTO.exit#0A..20IF.numbers.DO.writef("%I5..",.l
inenumber)#0A..18}#0A..4SWITCHON.ch.INTO#0A..4{.CAS
E.'*c':#0A..6CASE.'*n':#0A..6CASE.'*p':.linenumber.
:#3D.linenumber+1;.wrch(ch);.BREAK#0A#0A..6CASE.'*e
':.linenumber.:#3D.linenumber+1;.tab.:#3D.8;.LOOP#0A
#0A..6CASE.'*t':.{.wrch('*s')#0A..19tab.:#3D.tab+1#0A
..17}.REPEATUNTIL.tab.REM.8.#3D.0#0A..17LOOP#0A#0A.
.6DEFAULT:..1wrch(ch)#0A..17tab.:#3D.tab+1#0A..17LO
OP#0A#0A..6CASE.endstreamch:#0A//..14wrch('*n')#0A.
.16GOTO.exit#0A..4}#0A..2}.REPEAT#0A..}.REPEAT#0A#0A
exit:#0A..IF.inputstream..DO.endstream(inputstream)
#0A..IF.outputstream.DO.endstream(outputstream)#0A.
.RESULTIS.rc#0A}#0A

######com/typeflush.b#
//.(C).Copyright.1978.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0ASECTION."TYPE"#0A#0AGET."libhdr"#0A#0AGLOBAL#0A{
#0Ainputstream:ug#0Aoutputstream#0Anumbers#0Alinenu
mber#0A}#0A#0ALET.flush().BE.RETURN#0A#0ALET.start(
).#3D.VALOF#0A{.LET.argv.#3D.VEC.50#0A..LET.rc.#3D.
0#0A..LET.ch.#3D.0#0A..LET.oldoutput.#3D.output()#0A
#0A..inputstream.:#3D.0#0A..outputstream.:#3D.0#0A#0A
..UNLESS.rdargs("FROM/A,TO,N/S",.argv,.50).DO#0A..{
.writes("Bad.args*n")#0A..2rc.:#3D.20#0A..2GOTO.exi
t#0A..}#0A#0A..inputstream.:#3D.findinput(argv!0)#0A
..IF.inputstream.#3D.0.DO.{.writef("Can*'t.open.%s*
n",.argv!0)#0A..24rc.:#3D.20#0A..24GOTO.exit#0A..22
}#0A..selectinput(inputstream)#0A#0A..IF.argv!1.DO.
{.outputstream.:#3D.findoutput(argv!1)#0A..15UNLESS
.outputstream.DO#0A..15{.writef("Can*'t.open.%s*n",
.argv!1)#0A..17rc.:#3D.20#0A..17GOTO.exit#0A..15}#0A
..15selectoutput(outputstream)#0A..13}#0A#0A..numbe
rs.:#3D.argv!2#0A#0A..linenumber.:#3D.1#0A#0A..{.LE
T.tab.#3D.0#0A#0A..2{.ch.:#3D.rdch()#0A..4IF.intfla
g().DO.{.UNLESS.tab#3D0.DO.wrch('*n')#0A..22selecto
utput(oldoutput)#0A..22writes("**2BREAK*n")#0A..22r
c.:#3D.5#0A..22GOTO.exit#0A..20}#0A..4IF.tab#3D0.DO
.{.IF.ch#3Dendstreamch.GOTO.exit#0A..18IF.numbers.D
O.writef("%i5..",.linenumber)#0A..16}#0A..4SWITCHON
.ch.INTO#0A..4{.CASE.'*c':#0A..6CASE.'*n':#0A..6CAS
E.'*p':.linenumber.:#3D.linenumber+1;.wrch(ch);.#0A
..17flush();.BREAK#0A#0A..6CASE.'*e':.linenumber.:#3D
.linenumber+1;.tab.:#3D.8;.LOOP#0A#0A..6CASE.'*t':#0A
..17{.wrch('*s')#0A..19tab.:#3D.tab+1#0A..17}.REPEA
TUNTIL.tab.REM.8.#3D.0#0A..17LOOP#0A#0A..6DEFAULT:.
.1wrch(ch);..7tab.:#3D.tab+1;..LOOP#0A#0A..6CASE.en
dstreamch:#0A..17wrch('*n');.flush();..13GOTO.exit#0A
..4}#0A..2}.REPEAT#0A..}.REPEAT#0A#0Aexit:#0A..IF.i
nputstream..DO.endstream(inputstream)#0A..IF.output
stream.DO.endstream(outputstream)#0A..RESULTIS.rc#0A
}#0A

######com/typehex.b#
//.(C).Copyright.1979.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0AGET."libhdr"#0A#0AGLOBAL.$(.buffer..3:..ug#0A..8
ptr..6:..ug.+.1#0A..8lim..6:..ug.+.2#0A..5$)#0A#0AM
ANIFEST.$(.buffer#2Esize.#3D.150.$)#0A#0ALET.start(
).#3D.VALOF#0A..$(.LET.args..4#3D.VEC.50#0A..3LET.s
ysout..2#3D.output()#0A..3LET.instream..#3D.0#0A..3
LET.outstream.#3D.0#0A..3LET.word..4#3D.?#0A..3LET.
wdcount..1#3D.0#0A..3LET.buf..5#3D.VEC.buffer#2Esiz
e.-.1#0A#0A..3buffer..5:#3D.buf#0A..3lim,.ptr..3:#3D
.0,.-1#0A#0A..3IF.rdargs("FROM/A,TO/K",.args,.50).#3D
.0.DO#0A..3$(.writes("Bad.arguments.for.TYPEHEX*n")
#0A..6RESULTIS.20#0A..3$)#0A#0A..3instream.:#3D.fin
dinput(args!0)#0A..3IF.instream.#3D.0.DO.$(.writef(
"can't.open.%s*n",.args!0)#0A..25RESULTIS.20#0A..22
$)#0A..3selectinput(instream)#0A#0A..3UNLESS.args!1
.#3D.0.DO#0A..3$(.outstream.:#3D.findoutput(args!1)
#0A..6IF.outstream.#3D.0.DO.$(.writef("can't.open.%
s*n",.args!1)#0A..29endread()#0A..29RESULTIS.20#0A.
.26$)#0A..6selectoutput(outstream)#0A..3$)#0A#0A..3
WHILE.getword(@.word).DO#0A..3$(.writef("%X8",word)
#0A..6IF.intflag().DO.$(.selectoutput(sysout)#0A..2
5writes("*n**4BREAK*n")#0A..25GOTO.out#0A..22$)#0A.
.6wdcount:#3Dwdcount+1#0A..6wrch(wdcount.REM.8.#3D.
0.->'*n','*s')#0A..3$)#0A#0A..3UNLESS.wdcount.REM.1
6.#3D.0.DO.newline()#0A#0A..out:#0A..3endread()#0A.
.3UNLESS.outstream.#3D.0.DO.$(.selectoutput(outstre
am)#0A..30endwrite()#0A..27$)#0A..3RESULTIS.0#0A..$
)#0A#0AAND.getword(addr).#3D.VALOF#0A..$(.LET.ch.#3D
.?#0A..3!.addr.:#3D.0#0A..3ch.:#3D.rdch()#0A..3IF.c
h#3Dendstreamch.RESULTIS.FALSE#0A..3addr%0.:#3D.ch#0A
..3ch.:#3D.rdch()#0A..3IF.ch#3Dendstreamch.RESULTIS
.TRUE#0A..3addr%1.:#3D.ch#0A..3ch.:#3D.rdch()#0A..3
IF.ch#3Dendstreamch.RESULTIS.TRUE#0A..3addr%2.:#3D.
ch#0A..3ch.:#3D.rdch()#0A..3IF.ch#3Dendstreamch.RES
ULTIS.TRUE#0A..3addr%3.:#3D.ch#0A..3RESULTIS.TRUE#0A
..$)#0A

######com/unpreload.b#
//.Written.by.Martin.Richards.(c).June.2000006#0A#0A
SECTION."UNPRELOAD"#0A#0AGET."libhdr"#0A#0ALET.star
t().#3D.VALOF.//.UNPRELOAD.[NAME].commandname#0A{.L
ET.v.#3D.VEC.100#0A#0A..UNLESS.rdargs(",,8ALL/S",v,
100).DO#0A..{.writes("Parameters.no.good.for.UNPREL
OAD*N")#0A..2RESULTIS.20#0A..}#0A#0A..IF.v!10.DO.{.
unpreload(0);.RESULTIS.0.}#0A..FOR.i.#3D.0.TO.9.IF.
v!i.DO.unpreload(v!i)#0A..RESULTIS.0#0A}#0A#0AAND.u
npreload(name).BE#0A{.LET.p.#3D.@cli_preloadlist#0A
#0A..WHILE.!p.DO.{.LET.q.#3D.!p#0A..14TEST.name#3D0
.|.compstring(name,.@q!2)#3D0#0A..14THEN.{.unloadse
g(q!1)#0A..21!p.:#3D.!q#0A..21freevec(q)#0A..21IF.n
ame.RETURN#0A..19}#0A..15ELSE.p.:#3D.q#0A..13}#0A#0A
..IF.name.DO.writef("Unable.to.unpreload.%s*n",.nam
e)#0A}#0A

######com/vecstats.b#
GET."libhdr"#0A#0AMANIFEST.{.vecstatsupb#3D2002.}#0A
#0ALET.start().#3D.VALOF#0A{.LET.v.#3D.rtn_vecstats
v!rootnode#0A..LET.layout.#3D.0#0A..writef("getvec-
ed.blocks.(requested.size.:.number.allocated):*n*n"
)#0A#0A..//sys(Sys_putsysval,.v+3,.1001)#0A..//sys(
Sys_putsysval,.v+10,.2001)#0A..//sys(Sys_putsysval,
.v+300,.3001)#0A#0A..FOR.i.#3D.0.TO.vecstatsupb.DO#0A
..{.LET.val.#3D.sys(Sys_getsysval,.v+i)#0A..2IF.val
.DO#0A..2{.writef(".%i5:%i4",.i,.val)#0A..4layout.:
#3D.layout+1#0A..4IF.layout.REM.6.#3D.0.DO.newline(
)#0A..2}#0A..}#0A..newline()#0A}#0A

######com/vspl.b#
/*#0AThis.is.a.compiler.and.interpreter.for.the.lan
guage.VSPL#0Aimplemented.in.BCPL#0A#0A(c).Martin.Ri
chards.20.March.2000003#0A*/#0A#0A1GET."libhdr"#0A.
#0AMANIFEST.{..//.Lexical.tokens,.parse.tree.operat
ors.and.op-codes#0A#0ANum#3D1;.Name;.String;.True;.
False#0AValof;.Fnap;.Lv;.Ind;.Vecap#0ANeg;.Not;.Mul
;.Div;.Mod;.Add;.Sub#0AEq;.Ne;.Le;.Ge;.Lt;.Gt;.Lsh;
.Rsh;.And;.Or;.Xor#0AComma;.Fndef;.Rtdef;.Assign;.R
tap;.Resultis#0ATest;.If;.Unless;.While;.Until;.For
;.Return;.Seq#0ALet;.Vec;.Static;.Statvec;.Decl;.Va
r#0ALparen;.Rparen;.Lsquare;.Rsquare;.Lcurly;.Rcurl
y#0ATo;.Do;.Then;.Else;.Be;.Eof;.Semicolon#0ARtrn;.
Fnrn;.Addr;.Local;.Lab;.Data;.Jt;.Jf;.Jump;#0ALn;.L
p;.Llp;.Ll;.Laddr;.Sp;.Sl;.Stind;.Lres#0AEntry;.Sta
ck;.Printf;.Sys;.Halt#0A}#0A.#0AGLOBAL.{.#0Arec_p:u
g;.rec_l;.fin_p;.fin_l#0Afatalerr;.synerr;.trnerr;.
errcount;.errmax#0Aprogstream;.tostream#0Amk1;.mk2;
.mk3;.mk4;.mk5;.mk6#0Anewvec;.treep;.treevec#0AoptT
okens;.optTree;.optCode;.optTrace#0A#0A//.Globals.u
sed.in.LEX#0Achbuf;.charv;.ch;.rch;.lex;.token;.lex
val;.wordnode#0Awrchbuf;.chcount;.lineno#0Adsw;.dec
lsyswords;.namestart;.nametable;.lookupword#0Ardstr
ch;.rdtag#0A#0A//.Globals.used.in.SYN#0Acheckfor;.r
dprog;.rdblockbody#0Arnamelist;.rstatlist;.rname#0A
rdef;.rncom;.rcom#0Aformtree;.plist#0Arexplist;.rds
eq#0Arnexp;.rexp;.rbexp#0A.#0A//.Globals.used.in.TR
N.and.the.interpreter#0A.#0Atrnext:300;.trprog;.trc
om;.decldyn#0Adeclstatnames;.checkdistinct;.addname
;.cellwithname#0Atrdecl;.undeclare;.jumpcond#0Aassi
gn;.load;.fnbody;.loadlist;.transname#0Advec;.dvece
;.dvecp;.dvect#0Acomline;.procname;.resultlab;.ssp#0A
outf;.outfn;.outfl;.outfs;.outentry#0Aoutlab;.outva
r;.outstatvec;.outstring;.opstr;.hasOperand#0Amem;.
memt;.regs#0Acodev;.codep;.codet;.datav;.datap;.dat
at;.stack;.stackt#0Alabv;.refv;.labmax;.putc;.putd;
.putref#0Asetlab;.nextlab;.labnumber;.resolvelabels
#0Ainterpret;.printf#0A}#0A#0AMANIFEST.{..23//..Sel
ectors#0Ah1#3D0;.h2#3D1;.h3#3D2;.h4#3D3;.h5#3D4;.h6
#3D5#0Anametablesize.#3D.541#0Ac_tab..7#3D..0019#0A
c_newline..3#3D..00010#0A}#0A.#0ALET.start().#3D.VA
LOF#0A{.LET.treesize.#3D.0#0A..AND.memsize.#3D.0#0A
..AND.argv.#3D.VEC.50#0A..AND.argform.#3D#0A..6"PRO
G/A,TO#3D-o/K,TOKENS#3D-l/S,TREE#3D-p/S,CODE#3D-c/S
,TRACE#3D-t/S"#0A..LET.stdout.#3D.output()#0A#0A..e
rrmax..1:#3D.2#0A..errcount.:#3D.0#0A..fin_p,.fin_l
.:#3D.level(),.fin#0A#0A..treevec,.labv,.refv,.mem.
:#3D.0,.0,.0,.0#0A..progstream,.tostream.:#3D.0,.0#0A
..1#0A..writef("*nVSPL.(26.Apl.2012).BCPL.Version*n
")#0A.#0A..IF.rdargs(argform,.argv,.50)#3D0.DO.fata
lerr("Bad.arguments*n")#0A#0A..treesize.:#3D.1002#0A
..memsize..:#3D.5002#0A#0A..progstream.:#3D.findinp
ut(argv!0)..4//.PROG#0A#0A..IF.progstream#3D0.DO.fa
talerr("Trouble.with.file.%s*n",.argv!0)#0A#0A..sel
ectinput(progstream)#0A.#0A..IF.argv!1..26//.TO..4-
o#0A..DO.{.tostream.:#3D.findoutput(argv!1)#0A..5IF
.tostream#3D0.DO.fatalerr("Trouble.with.code.file.%
s*n",.argv!1)#0A..3}#0A#0A..optTokens.:#3D.argv!2..
16//.TOKENS..-l#0A..optTree..1:#3D.argv!3..16//.TRE
E..2-p#0A..optCode..1:#3D.argv!4..16//.CODE..2-c#0A
..optTrace..:#3D.argv!5..16//.TRACE..1-t#0A#0A..tre
evec.:#3D.getvec(treesize)#0A..mem..3:#3D.getvec(me
msize)#0A..memt..2:#3D.memsize#0A..labv.:#3D.getvec
(1001)#0A..refv.:#3D.getvec(1001)#0A..labmax.:#3D.1
001#0A#0A..UNLESS.treevec.&.mem.&.labv.&.refv.DO#0A
..3fatalerr("Insufficient.memory*n")#0A..1#0A..UNLE
SS.tostream.DO.tostream.:#3D.stdout#0A..selectoutpu
t(tostream)#0A#0A..{.LET.tree.#3D.0#0A..2LET.b.#3D.
VEC.64/bytesperword#0A..2chbuf.:#3D.b#0A..2FOR.i.#3D
.0.TO.63.DO.chbuf%i.:#3D.0#0A..2chcount,.lineno.:#3D
.0,.1#0A..2rch()#0A.#0A..2treep.:#3D.treevec.+.tree
size#0A#0A..2tree.:#3D.formtree()..12//.Perform.Syn
tax.Analysis#0A..2IF.optTokens.GOTO.fin#0A#0A..2IF.
optTree.DO.{.writes("Parse.Tree*n")#0A..18plist(tre
e,.0,.20)#0A..18newline()#0A..16}#0A..#0A..2IF.errc
ount.GOTO.fin#0A#0A..2regs..:#3D.10#0A..2codev.:#3D
.100#0A..2codep.:#3D.codev#0A..2codet.:#3D.1002#0A.
.2datav.:#3D.codet#0A..2datap.:#3D.datav#0A..2datat
.:#3D.memt#0A#0A..2FOR.i.#3D.0.TO.memt.DO.mem!i.:#3D
.0#0A#0A..2trprog(tree)..18//.Translate.the.tree#0A
#0A..2stack.:#3D.datap#0A..2stackt.:#3D.memt#0A#0A.
.2IF.errcount.GOTO.fin#0A..2{.LET.rv.#3D.mem+regs#0A
..4AND.sv.#3D.mem+stack#0A..4rv!0.:#3D.0..6//.resul
t.register#0A..4rv!1.:#3D.stack..2//.p.pointer#0A..
4rv!2.:#3D.stack+2..//.sp#0A..4rv!3.:#3D.codev..2//
.pc#0A..4rv!4.:#3D.maxint..1//.count#0A#0A..4sv!0,.
sv!1,.sv!2.:#3D.0,.0,.0#0A.#0A..4{.LET.ret.#3D.inte
rpret(regs,.mem)..1//.Execute.the.interpreter#0A..6
IF.ret.DO.writef("Return.code.%n*n",.ret)#0A..6writ
ef("*nInstructions.executed:.%n*n",.maxint-rv!4)#0A
..4}#0A..2}#0A..}#0A..1#0Afin:#0A..IF.treevec..5DO.
freevec(treevec)#0A..IF.mem..9DO.freevec(mem)#0A..I
F.labv..8DO.freevec(labv)#0A..IF.refv..8DO.freevec(
refv)#0A..IF.progstream..2DO.{.selectinput(progstre
am);.endread()..}#0A..IF.tostream..4DO.{.selectoutp
ut(tostream)#0A..22UNLESS.tostream#3Dstdout.DO..end
write().}#0A#0A..selectoutput(stdout)#0A..result2.:
#3D.0.//.No.reason.given#0A..RESULTIS.errcount#3D0.
->.0,.20#0A}#0A#0ALET.lex().BE#0A{.SWITCHON.ch.INTO
#0A..{.CASE.'*p':.CASE.'*n':#0A..15lineno.:#3D.line
no.+.1#0A..2CASE.'*c':.CASE.'*t':.CASE.'*s':#0A..15
rch()#0A..15LOOP#0A#0A..2CASE.'0':CASE.'1':CASE.'2'
:CASE.'3':CASE.'4':#0A..2CASE.'5':CASE.'6':CASE.'7'
:CASE.'8':CASE.'9':#0A..14lexval.:#3D.0#0A..14WHILE
.'0'<#3Dch<#3D'9'.DO#0A..14{.lexval.:#3D.10*lexval.
+.ch.-.'0'#0A..16rch()#0A..14}#0A..14token.:#3D.Num
#0A..14RETURN#0A.#0A..2CASE.'a':CASE.'b':CASE.'c':C
ASE.'d':CASE.'e':#0A..2CASE.'f':CASE.'g':CASE.'h':C
ASE.'i':CASE.'j':#0A..2CASE.'k':CASE.'l':CASE.'m':C
ASE.'n':CASE.'o':#0A..2CASE.'p':CASE.'q':CASE.'r':C
ASE.'s':CASE.'t':#0A..2CASE.'u':CASE.'v':CASE.'w':C
ASE.'x':CASE.'y':#0A..2CASE.'z':#0A..2CASE.'A':CASE
.'B':CASE.'C':CASE.'D':CASE.'E':#0A..2CASE.'F':CASE
.'G':CASE.'H':CASE.'I':CASE.'J':#0A..2CASE.'K':CASE
.'L':CASE.'M':CASE.'N':CASE.'O':#0A..2CASE.'P':CASE
.'Q':CASE.'R':CASE.'S':CASE.'T':#0A..2CASE.'U':CASE
.'V':CASE.'W':CASE.'X':CASE.'Y':#0A..2CASE.'Z':#0A.
.14token.:#3D.lookupword(rdtag())#0A..14RETURN#0A.#0A
..2CASE.'{':.token.:#3D.Lcurly;..2BREAK#0A..2CASE.'
}':.token.:#3D.Rcurly;..2BREAK#0A..2CASE.'[':.token
.:#3D.Lsquare;..1BREAK#0A..2CASE.']':.token.:#3D.Rs
quare;..1BREAK#0A..2CASE.'(':.token.:#3D.Lparen;..2
BREAK#0A..2CASE.')':.token.:#3D.Rparen;..2BREAK.#0A
..2CASE.'!':.token.:#3D.Ind;..5BREAK#0A..2CASE.'@':
.token.:#3D.Lv;..6BREAK#0A..2CASE.'+':.token.:#3D.A
dd;..5BREAK#0A..2CASE.'-':.token.:#3D.Sub;..5BREAK#0A
..2CASE.',':.token.:#3D.Comma;..3BREAK#0A..2CASE.';
':.token.:#3D.Semicolon;.BREAK#0A..2CASE.'&':.token
.:#3D.And;..5BREAK#0A..2CASE.'|':.token.:#3D.Or;..6
BREAK#0A..2CASE.'#3D':.token.:#3D.Eq;..6BREAK#0A..2
CASE.'**':token.:#3D.Mul;..5BREAK#0A..2CASE.'^':.to
ken.:#3D.Xor;..5BREAK#0A.#0A..2CASE.'/':..1rch()#0A
..14IF.ch#3D'/'.DO#0A..14{.rch().REPEATUNTIL.ch#3D'
*n'.|.ch#3Dendstreamch#0A..16LOOP#0A..14}#0A..14tok
en.:#3D.Div#0A..14RETURN#0A.#0A..2CASE.'~':..1rch()
#0A..14IF.ch#3D'#3D'.DO.{.token.:#3D.Ne;..BREAK.}#0A
..14token.:#3D.Not#0A..14RETURN#0A.#0A..2CASE.'<':.
.1rch()#0A..14IF.ch#3D'#3D'.DO.{.token.:#3D.Le;..BR
EAK.}#0A..14IF.ch#3D'<'.DO.{.token.:#3D.Lsh;.BREAK.
}#0A..14token.:#3D.Lt#0A..14RETURN#0A.#0A..2CASE.'>
':..1rch()#0A..14IF.ch#3D'#3D'.DO.{.token.:#3D.Ge;.
.BREAK.}#0A..14IF.ch#3D'>'.DO.{.token.:#3D.Rsh;.BRE
AK.}#0A..14token.:#3D.Gt#0A..14RETURN#0A.#0A..2CASE
.':':..1rch()#0A..14IF.ch#3D'#3D'.DO.{.token.:#3D.A
ssign;..BREAK.}#0A..14synerr("'#3D'.expected.after.
':'")#0A..14RETURN#0A.#0A..2CASE.'"':#0A..12{.LET.l
en.#3D.0#0A..14rch()#0A.#0A..14UNTIL.ch#3D'"'.DO#0A
..14{.IF.len#3D255.DO.synerr("Bad.string.constant")
#0A..16len.:#3D.len.+.1#0A..16charv%len.:#3D.rdstrc
h()#0A..14}#0A.#0A..14charv%0.:#3D.len#0A..14wordno
de.:#3D.newvec(len/bytesperword+2)#0A..14h1!wordnod
e.:#3D.String#0A..14FOR.i.#3D.0.TO.len.DO.(@h2!word
node)%i.:#3D.charv%i#0A..14token.:#3D.String#0A..14
BREAK#0A..12}#0A.#0A..2CASE.'*'':..rch()#0A..14lexv
al.:#3D.rdstrch()#0A..14token.:#3D.Num#0A..14UNLESS
.ch#3D'*''.DO.synerr("Bad.character.constant")#0A..
14BREAK#0A#0A..2DEFAULT:..2UNLESS.ch#3Dendstreamch.
DO#0A..14{.LET.badch.#3D.ch#0A..16ch.:#3D.'*s'#0A..
16synerr("Illegal.character.%x2",.badch)#0A..14}#0A
..14token.:#3D.Eof#0A..14RETURN#0A..}.REPEAT#0A.#0A
..rch()#0A}#0A.#0ALET.lookupword(word).#3D.VALOF#0A
{.LET.len,.i.#3D.word%0,.0#0A..LET.hashval.#3D.len#0A
..FOR.i.#3D.1.TO.len.DO.hashval.:#3D.(13*hashval.+.
word%i).&.#23xFF_FF2#0A..hashval.:#3D.hashval.REM.n
ametablesize#0A..wordnode.:#3D.nametable!hashval#0A
.#0A..WHILE.wordnode.&.i<#3Dlen.TEST.(@h3!wordnode)
%i#3Dword%i#0A..24THEN.i.:#3D.i+1#0A..24ELSE.wordno
de,.i.:#3D.h2!wordnode,.0#0A..IF.wordnode#3D0.DO#0A
..{.wordnode.:#3D.newvec(len/bytesperword+3)#0A..2h
1!wordnode,.h2!wordnode.:#3D.Name,.nametable!hashva
l#0A..2FOR.i.#3D.0.TO.len.DO.(@h3!wordnode)%i.:#3D.
word%i#0A..2nametable!hashval.:#3D.wordnode#0A..}#0A
..RESULTIS.h1!wordnode#0A}#0A.#0AAND.dsw(word,.tok)
.BE.{.lookupword(word);.h1!wordnode.:#3D.tok..}#0A.
#0AAND.declsyswords().BE#0A{.dsw("be",.Be);..11dsw(
"do",.Do);..7dsw("else",.Else)#0A..dsw("false",.Fal
se);..5dsw("if",.If);..7dsw("for",.For)#0A..dsw("le
t",.Let);..9dsw("mod",.Mod);..5dsw("printf",.Printf
)#0A..dsw("resultis",.Resultis);.dsw("return",.Retu
rn);.dsw("static",.Static)#0A..dsw("sys",.Sys);..9d
sw("test",.Test);..3dsw("to",.To)#0A..dsw("true",.T
rue);..7dsw("then",.Then);..3dsw("valof",.Valof)#0A
..dsw("vec",.Vec);..9dsw("unless",.Unless);.dsw("un
til",.Until)#0A..dsw("while",.While)..#0A..lookupwo
rd("start")#0A..namestart.:#3D.wordnode#0A}.#0A.#0A
LET.rch().BE#0A{.ch.:#3D.rdch()#0A..chcount.:#3D.ch
count+1#0A..chbuf%(chcount&63).:#3D.ch#0A}#0A.#0AAN
D.wrchbuf().BE#0A{.writes("*n#2E#2E1")#0A..FOR.p.#3D
.chcount-63.TO.chcount.DO#0A..{.LET.k.#3D.chbuf%(p&
63)#0A..2IF.0<k<255.DO.wrch(k)#0A..}#0A..newline()#0A
}#0A.#0AAND.rdtag().#3D.VALOF#0A{.LET.len.#3D.0#0A.
.WHILE.'a'<#3Dch<#3D'z'.|.'A'<#3Dch<#3D'Z'.|.'0'<#3D
ch<#3D'9'.|..ch#3D'_'.DO#0A..{.len.:#3D.len+1#0A..2
IF.len>255.DO.synerr("Name.too.long")#0A..2charv%le
n.:#3D.ch#0A..2rch()#0A..}#0A..charv%0.:#3D.len#0A.
.RESULTIS.charv#0A}#0A.#0AAND.rdstrch().#3D.VALOF#0A
{.LET.res.#3D.ch#0A..IF.ch#3D'*n'.|.ch#3D'*p'.DO#0A
..{.lineno.:#3D.lineno+1#0A..2synerr("Unescaped.new
line.character")#0A..}#0A..IF.ch#3D'\'.DO#0A..{.rch
()#0A..2SWITCHON.ch.INTO#0A..2{.DEFAULT:..1synerr("
Bad.string.or.character.constant")#0A..4CASE.'\':.C
ASE.'*'':.CASE.'"':..res.:#3D.ch;..6ENDCASE#0A..4CA
SE.'t':.CASE.'T':..11res.:#3D.c_tab;..3ENDCASE#0A..
4CASE.'n':.CASE.'N':..11res.:#3D.c_newline;.ENDCASE
#0A..2}#0A..}#0A..rch()#0A..RESULTIS.res#0A}#0A#0AL
ET.newvec(n).#3D.VALOF#0A{.treep.:#3D.treep.-.n.-.1
;#0A..IF.treep<#3Dtreevec.DO.fatalerr("More.workspa
ce.needed")#0A..RESULTIS.treep#0A}#0A.#0AAND.mk1(a)
.#3D.VALOF#0A{.LET.p.#3D.newvec(0)#0A..p!0.:#3D.a#0A
..RESULTIS.p#0A}#0A.#0AAND.mk2(a,.b).#3D.VALOF#0A{.
LET.p.#3D.newvec(1)#0A..p!0,.p!1.:#3D.a,.b#0A..RESU
LTIS.p#0A}#0A.#0AAND.mk3(a,.b,.c).#3D.VALOF#0A{.LET
.p.#3D.newvec(2)#0A..p!0,.p!1,.p!2.:#3D.a,.b,.c#0A.
.RESULTIS.p#0A}#0A.#0AAND.mk4(a,.b,.c,.d).#3D.VALOF
#0A{.LET.p.#3D.newvec(3)#0A..p!0,.p!1,.p!2,.p!3.:#3D
.a,.b,.c,.d#0A..RESULTIS.p#0A}#0A.#0AAND.mk5(a,.b,.
c,.d,.e).#3D.VALOF#0A{.LET.p.#3D.newvec(4)#0A..p!0,
.p!1,.p!2,.p!3,.p!4.:#3D.a,.b,.c,.d,.e#0A..RESULTIS
.p#0A}#0A.#0AAND.mk6(a,.b,.c,.d,.e,.f).#3D.VALOF#0A
{.LET.p.#3D.newvec(5)#0A..p!0,.p!1,.p!2,.p!3,.p!4,.
p!5.:#3D.a,.b,.c,.d,.e,.f#0A..RESULTIS.p#0A}#0A.#0A
AND.formtree().#3D.VALOF#0A{.LET.res.#3D.0#0A..rec_
p,.rec_l.:#3D.level(),.recover#0A#0A..charv.:#3D.ne
wvec(256/bytesperword)..3#0A..nametable.:#3D.newvec
(nametablesize)#0A..UNLESS.charv.&.nametable.DO.fat
alerr("More.workspace.needed")#0A..FOR.i.#3D.0.TO.n
ametablesize.DO.nametable!i.:#3D.0#0A..declsyswords
()#0A..lex()#0A#0A..IF.optTokens.DO..10//.For.debug
ging.lex#2E#0A..{.IF.token#3DEof.RESULTIS.0#0A..2wr
itef("token.#3D.%i3.%s",.token,.opstr(token))#0A..2
IF.token#3DNum..2DO.writef("..5%n",..lexval)#0A..2I
F.token#3DName..1DO.writef("..4%s",..1charv)#0A..2I
F.token#3DString.DO.writef("..2*"%s*"",.charv)#0A..
2newline()#0A..2lex()#0A..}.REPEAT#0A#0Arecover:#0A
..res.:#3D.rdprog()#0A..UNLESS.token#3DEof.DO.fatal
err("Incorrect.termination")#0A..RESULTIS.res#0A}#0A
.#0AAND.fatalerr(mess,.a).BE#0A{.writef("*nFatal.er
ror:..")#0A..writef(mess,.a)#0A..writes("*nCompilat
ion.aborted*n")#0A..errcount.:#3D.errcount+1#0A..lo
ngjump(fin_p,.fin_l)#0A}#0A#0AAND.synerr(mess,.a).B
E#0A{.writef("*nError.near.line.%n:..",.lineno)#0A.
.writef(mess,.a)#0A..wrchbuf()#0A..errcount.:#3D.er
rcount+1#0A..IF.errcount.>#3D.errmax.DO.fatalerr("T
oo.many.errors")#0A#0A..//.Skip.the.rest.of.the.inp
ut.line.#0A..UNTIL.ch#3D'*n'.|.ch#3Dendstreamch.DO.
rch()#0A..lex()#0A#0A..longjump(rec_p,.rec_l)#0A}#0A
#0ALET.checkfor(tok,.mess).BE#0A{.UNLESS.token#3Dto
k.DO.synerr(mess)#0A..lex()#0A}#0A.#0ALET.rdprog().
#3D.VALOF#0A{.LET.ln.#3D.lineno#0A..SWITCHON.token.
INTO#0A..{.DEFAULT:..synerr("Bad.outer.level.declar
ation*n")#0A#0A..2CASE.Eof:.RESULTIS.0#0A#0A..2CASE
.Static:#0A..13{.LET.d.#3D.?#0A..15lex()#0A..15d.:#3D
.mk3(Static,.rstatlist(),.ln)#0A..15RESULTIS..mk3(D
ecl,.d,.rdprog())#0A..13}#0A#0A..2CASE.Let:#0A..7{.
LET.n,.args.#3D.0,.0#0A..9lex()#0A..9n.:#3D.rname()
#0A..9checkfor(Lparen,."'('.missing")#0A..9IF.token
#3DName.DO.args.:#3D.rnamelist()#0A..9checkfor(Rpar
en,."')'.missing")#0A.#0A..9IF.token#3DBe.DO#0A..9{
.LET.d.#3D.mk5(Rtdef,.n,.args,.rncom(),.ln)#0A..11R
ESULTIS.mk3(Decl,.d,.rdprog())#0A..9}#0A.#0A..9IF.t
oken#3DEq.DO#0A..9{.LET.d.#3D.mk5(Fndef,.n,.args,.r
nexp(0),.ln)#0A..11RESULTIS.mk3(Decl,.d,.rdprog())#0A
..9}#0A.#0A..9synerr("Bad.procedure.heading")#0A..6
}#0A..}#0A}.REPEAT#0A#0ALET.rdblockbody().#3D.VALOF
#0A{.LET.res,.orec_p,.orec_l.#3D.0,.rec_p,.rec_l#0A
..LET.op.#3D.token#0A..rec_p,.rec_l.:#3D.level(),.r
ecover#0A#0Arecover:#0A..SWITCHON.op.INTO#0A..{.DEF
AULT:..2res.:#3D.rdseq()#0A..14ENDCASE#0A#0A..2CASE
.Let:#0A..2CASE.Vec:.{.LET.n,.e,.ln.#3D.0,.0,.linen
o#0A..14lex()#0A..14n.:#3D.rname()#0A..14TEST.op#3D
Let#0A..14THEN.{.checkfor(Eq,."Missing.'#3D'")#0A..
21e.:#3D.rexp(0)#0A..19}#0A..14ELSE.{.checkfor(Lsqu
are,."Missing.'['")#0A..21e.:#3D.rexp(0)#0A..21UNLE
SS.h1!e#3DNum.DO.synerr("Bad.'vec'.declaration")#0A
..21checkfor(Rsquare,."Missing.']'")#0A..19}#0A..14
checkfor(Semicolon,."';'.expected")#0A..14res.:#3D.
mk5(op,.n,.e,.rdblockbody(),.ln)#0A..14ENDCASE#0A..
12}#0A..}#0A.#0A..rec_p,.rec_l.:#3D.orec_p,.orec_l#0A
..RESULTIS.res#0A}#0A.#0AAND.rdseq().#3D.VALOF#0A{.
LET.a.#3D.0#0A..a.:#3D.rcom()#0A..IF.token#3DRcurly
.|.token#3DEof.RESULTIS.a#0A..checkfor(Semicolon,."
';'.expected")#0A..RESULTIS.mk3(Seq,.a,.rdseq())#0A
}#0A#0AAND.rnamelist().#3D.VALOF#0A{.LET.a.#3D.rnam
e()#0A..UNLESS.token#3DComma.RESULTIS.a#0A..lex()#0A
..RESULTIS.mk3(Comma,.a,.rnamelist())#0A}#0A#0AAND.
rexplist().#3D.VALOF#0A{.LET.a.#3D.rexp(0)#0A..UNLE
SS.token#3DComma.RESULTIS.a#0A..lex()#0A..RESULTIS.
mk3(Comma,.a,.rexplist())#0A}#0A.#0AAND.rstatlist()
.#3D.VALOF#0A{.LET.a.#3D.rname()#0A..IF.token#3DLsq
uare.DO#0A..{.LET.b.#3D.rnexp(0)#0A..2UNLESS.h1!b#3D
Num.DO.synerr("Number.expected")#0A..2checkfor(Rsqu
are,."']'.expected")#0A..2a.:#3D.mk3(Statvec,.a,.b)
#0A..}#0A..UNLESS.token#3DComma.RESULTIS.a#0A..lex(
)#0A..RESULTIS.mk3(Comma,.a,.rstatlist())#0A}#0A#0A
AND.rname().#3D.VALOF#0A{.LET.a.#3D.wordnode#0A..ch
eckfor(Name,."Name.expected")#0A..RESULTIS.a#0A}#0A
.#0ALET.rbexp().#3D.VALOF#0A{.LET.a,.op,.ln.#3D.0,.
token,.lineno#0A.#0A..SWITCHON.op.INTO#0A.#0A..{.DE
FAULT:.synerr("Error.in.expression")#0A#0A..2CASE.T
rue:#0A..2CASE.False:#0A..2CASE.Name:#0A..2CASE.Str
ing:.a.:#3D.wordnode#0A..15lex()#0A..15RESULTIS.a#0A
.#0A..2CASE.Num:..2a.:#3D.mk2(Num,.lexval)#0A..15le
x()#0A..15RESULTIS.a#0A.#0A..2CASE.Printf:#0A..2CAS
E.Sys:.lex()#0A..12checkfor(Lparen,."'('.missing")#0A
..12a.:#3D.0#0A..12UNLESS.token#3DRparen.DO.a.:#3D.
rexplist()#0A..12checkfor(Rparen,."')'.missing")#0A
..12RESULTIS.mk3(op,.a,.ln)#0A#0A1..2CASE.Lparen:.a
.:#3D.rnexp(0)#0A..15checkfor(Rparen,."')'.missing"
)#0A..15RESULTIS.a#0A.#0A..2CASE.Valof:..RESULTIS.m
k2(Valof,.rncom())#0A.#0A..2CASE.Ind:#0A..2CASE.Lv:
..3RESULTIS.mk2(op,.rnexp(7))#0A.#0A..2CASE.Add:..2
RESULTIS.rnexp(5)#0A.#0A..2CASE.Sub:..2a.:#3D.rnexp
(5)#0A..15TEST.h1!a#3DNum.THEN.h2!a.:#3D.-.h2!a#0A.
.29ELSE.a.:#3D.mk2(Neg,.a)#0A..15RESULTIS.a#0A.#0A.
.2CASE.Not:..2RESULTIS.mk2(Not,.rnexp(3))#0A..1}#0A
}#0A.#0AAND.rnexp(n).#3D.VALOF.{.lex();.RESULTIS.re
xp(n).}#0A.#0AAND.rexp(n).#3D.VALOF#0A{.LET.a,.b,.p
.#3D.rbexp(),.0,.0#0A#0A..{.LET.op,.ln.#3D.token,.l
ineno#0A..2SWITCHON.op.INTO#0A.#0A..2{.DEFAULT:..4B
REAK#0A.#0A..4CASE.Lparen:..lex()#0A..18b.:#3D.0#0A
..18UNLESS.token#3DRparen.DO.b.:#3D.rexplist()#0A..
18checkfor(Rparen,."')'.missing")#0A..18a.:#3D.mk4(
Fnap,.a,.b,.ln)#0A..18LOOP#0A.#0A..4CASE.Lsquare:.b
.:#3D.rnexp(0)#0A..18checkfor(Rsquare,."']'.missing
")#0A..18a.:#3D.mk3(Vecap,.a,.b)#0A..18LOOP#0A.#0A.
.4CASE.Mul:CASE.Div:CASE.Mod:#0A..18p.:#3D.7;..12EN
DCASE#0A..4CASE.Add:CASE.Sub:#0A..18p.:#3D.6;..12EN
DCASE#0A..4CASE.Lsh:CASE.Rsh:#0A..18p.:#3D.5;..12EN
DCASE#0A..4CASE.Eq:CASE.Le:CASE.Lt:CASE.Ne:CASE.Ge:
CASE.Gt:#0A..18p.:#3D.4;..12ENDCASE#0A..4CASE.And:.
.3p.:#3D.3;..12ENDCASE#0A..4CASE.Or:..4p.:#3D.2;..1
2ENDCASE#0A..4CASE.Xor:..3p.:#3D.1;..12ENDCASE#0A..
2}#0A..4#0A..2IF.n>#3Dp.RESULTIS.a#0A..2a.:#3D.mk3(
op,.a,.rnexp(p))#0A..}.REPEAT#0A#0A..RESULTIS.a#0A}
#0A..#0ALET.rcom().#3D.VALOF#0A{.LET.n,.a,.b,.op,.l
n.#3D.0,.0,.0,.token,.lineno#0A.#0A..SWITCHON.token
.INTO#0A..{.DEFAULT:..3synerr("Command.expected")#0A
.#0A..2CASE.Name:CASE.Num:CASE.Lparen:CASE.Ind:#0A.
.2CASE.Sys:CASE.Printf:#0A..2//.All.tokens.that.can
.start.an.expression#2E#0A..15a.:#3D.rexp(0)#0A.#0A
..15IF.token#3DAssign.DO#0A..15{.UNLESS.h1!a#3DName
.|.h1!a#3DVecap.|.h1!a#3DInd.DO#0A..19synerr("Bad.a
ssigment.statement")#0A..17RESULTIS.mk4(Assign,.a,.
rnexp(0),.ln)#0A..15}#0A.#0A..15IF.h1!a#3DFnap.DO#0A
..15{.h1!a.:#3D.Rtap#0A..17RESULTIS.a#0A..15}#0A.#0A
..15UNLESS.h1!a#3DSys.|.h1!a#3DPrintf.DO#0A..17syne
rr("Error.in.command")#0A..15RESULTIS.a#0A.#0A..2CA
SE.Resultis:#0A..15RESULTIS.mk3(op,.rnexp(0),.ln)#0A
.#0A..2CASE.If:..2CASE.Unless:#0A..2CASE.While:.CAS
E.Until:#0A..15a.:#3D.rnexp(0)#0A..15checkfor(Do,."
'do'.missing")#0A..15RESULTIS.mk4(op,.a,.rcom(),.ln
)#0A.#0A..2CASE.Test:..1a.:#3D.rnexp(0)#0A..15check
for(Then,."'then'.missing")#0A..15b.:#3D.rcom()#0A.
.15checkfor(Else,."'else'.missing")#0A..15RESULTIS.
mk5(Test,.a,.b,.rcom(),.ln)#0A.#0A..2CASE.For:..2le
x()#0A..15n.:#3D.rname()#0A..15checkfor(Eq,."'#3D'.
expected")#0A..15a.:#3D.rexp(0)#0A..15checkfor(To,.
"'to'.expected")#0A..15b.:#3D.rexp(0)#0A..15checkfo
r(Do,."'do'.missing")#0A..15RESULTIS.mk6(For,.n,.a,
.b,.rcom(),.ln)#0A#0A..2CASE.Return:.lex()#0A..15RE
SULTIS.mk2(op,.ln)#0A.#0A..2CASE.Lcurly:.lex()#0A..
15a.:#3D.rdblockbody()#0A..15checkfor(Rcurly,."'}'.
expected")#0A..15RESULTIS.a#0A..1}#0A}#0A#0AAND.rnc
om().#3D.VALOF.{.lex();.RESULTIS.rcom().}#0A#0ALET.
opstr(op).#3D.VALOF.SWITCHON.op.INTO#0A{.DEFAULT:..
5RESULTIS."Unknown"#0A#0A..CASE.Assign:..1RESULTIS.
"Assign";..2CASE.Add:..3RESULTIS."Add"#0A..CASE.And
:..4RESULTIS."And";..5CASE.Be:..4RESULTIS."Be"#0A..
CASE.Comma:..2RESULTIS."Comma";..3CASE.Data:..2RESU
LTIS."Data"#0A..CASE.Decl:..3RESULTIS."Decl";..4CAS
E.Div:..3RESULTIS."Div"#0A..CASE.Do:..5RESULTIS."Do
";..6CASE.Else:..2RESULTIS."Else"#0A..CASE.Entry:..
2RESULTIS."Entry";..3CASE.Eq:..4RESULTIS."Eq"#0A..C
ASE.False:..2RESULTIS."False";..3CASE.Fnap:..2RESUL
TIS."Fnap"#0A..CASE.For:..4RESULTIS."For";..5CASE.F
ndef:..1RESULTIS."Fndef"#0A..CASE.Fnrn:..3RESULTIS.
"Fnrn";..4CASE.Ge:..4RESULTIS."Ge"#0A..CASE.Gt:..5R
ESULTIS."Gt";..6CASE.Halt:..2RESULTIS."Halt"#0A..CA
SE.If:..5RESULTIS."If";..6CASE.Ind:..3RESULTIS."Ind
"#0A..CASE.Jf:..5RESULTIS."Jf";..6CASE.Jt:..4RESULT
IS."Jt"#0A..CASE.Jump:..3RESULTIS."Jump";..4CASE.La
b:..3RESULTIS."Lab"#0A..CASE.Laddr:..2RESULTIS."Lad
dr";..3CASE.Lcurly:..RESULTIS."Lcurly"#0A..CASE.Le:
..5RESULTIS."Le";..6CASE.Let:..3RESULTIS."Let"#0A..
CASE.Ll:..5RESULTIS."Ll";..6CASE.Llp:..3RESULTIS."L
lp"#0A..CASE.Ln:..5RESULTIS."Ln";..6CASE.Lp:..4RESU
LTIS."Lp"#0A..CASE.Lparen:..1RESULTIS."Lparen";..2C
ASE.Lres:..2RESULTIS."Lres"#0A..CASE.Lsh:..4RESULTI
S."Lsh";..5CASE.Lsquare:.RESULTIS."Lsquare"#0A..CAS
E.Lt:..5RESULTIS."Lt";..6CASE.Lv:..4RESULTIS."Lv"#0A
..CASE.Mod:..4RESULTIS."Mod";..5CASE.Mul:..3RESULTI
S."Mul"#0A..CASE.Name:..3RESULTIS."Name";..4CASE.Ne
:..4RESULTIS."Ne"#0A..CASE.Neg:..4RESULTIS."Neg";..
5CASE.Not:..3RESULTIS."Not"#0A..CASE.Num:..4RESULTI
S."Num";..5CASE.Or:..4RESULTIS."Or"..5#0A..CASE.Pri
ntf:..1RESULTIS."Printf";..2CASE.Rcurly:..RESULTIS.
"Rcurly"#0A..CASE.Resultis:.RESULTIS."Resultis";..C
ASE.Return:..RESULTIS."Return"#0A..CASE.Rparen:..1R
ESULTIS."Rparen";..2CASE.Rsh:..3RESULTIS."Rsh"#0A..
CASE.Rsquare:..RESULTIS."Rquare";..2CASE.Rtap:..2RE
SULTIS."Rtap"#0A..CASE.Rtdef:..2RESULTIS."Rtdef";..
3CASE.Rtrn:..2RESULTIS."Rtrn"#0A..CASE.Semicolon:RE
SULTIS."Semicolon";.CASE.Seq:..3RESULTIS."Seq"#0A..
CASE.Sl:..5RESULTIS."Sl";..6CASE.Sp:..4RESULTIS."Sp
"#0A..CASE.Stack:..2RESULTIS."Stack";..3CASE.Static
:..RESULTIS."Static"#0A..CASE.Statvec:..RESULTIS."S
tatvec";..1CASE.String:..RESULTIS."String"#0A..CASE
.Stind:..2RESULTIS."Stind";..3CASE.Sub:..3RESULTIS.
"Sub"#0A..CASE.Sys:..4RESULTIS."Sys";..5CASE.Test:.
.2RESULTIS."Test"#0A..CASE.Then:..3RESULTIS."Then";
..4CASE.To:..4RESULTIS."To"#0A..CASE.True:..3RESULT
IS."True";..4CASE.Valof:..1RESULTIS."Valof"#0A..CAS
E.Vecap:..2RESULTIS."Vecap";..3CASE.Vec:..3RESULTIS
."Vec"#0A..CASE.Unless:..1RESULTIS."Unless";..2CASE
.Until:..1RESULTIS."Until"#0A..CASE.While:..2RESULT
IS."While";..3CASE.Xor:..3RESULTIS."Xor"#0A}#0A#0AL
ET.plist(x,.n,.d).BE#0A{.LET.s,.size,.ln.#3D.0,.0,.
0#0A..LET.v.#3D.TABLE.0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,0,0,0,0,0#0A#0A..IF.x#3D0.DO.{.writes("Nil");.RETU
RN..}#0A.#0A..SWITCHON.h1!x.INTO#0A..{.DEFAULT:#0A.
.7size..3:#3D.1;..6ENDCASE#0A#0A..2CASE.Num:..3writ
en(h2!x);..7RETURN#0A..2CASE.Name:..2writes(x+2);..
8RETURN#0A..2CASE.String:..writef("*"%s*"",x+1);.RE
TURN#0A#0A..2CASE.For:#0A..7size,.ln.:#3D.5,.h6!x;.
ENDCASE#0A#0A..2CASE.Fndef:.CASE.Rtdef:#0A..7size,.
ln.:#3D.4,.h5!x;.ENDCASE#0A#0A..2CASE.Let:.CASE.Vec
:.CASE.Test:#0A..7size,.ln.:#3D.4,.h5!x;.ENDCASE#0A
#0A..2CASE.Vecap:.CASE.Mul:.CASE.Div:.CASE.Mod:.CAS
E.Add:.CASE.Sub:#0A..2CASE.Eq:.CASE.Ne:.CASE.Lt:.CA
SE.Gt:.CASE.Le:.CASE.Ge:#0A..2CASE.Lsh:.CASE.Rsh:.C
ASE.And:.CASE.Or:.CASE.Xor:#0A..2CASE.Comma:.CASE.S
eq:.CASE.Decl:.CASE.Statvec:#0A..7size..3:#3D.3;..5
ENDCASE#0A#0A..2CASE.Assign:.CASE.Rtap:.CASE.Fnap:#0A
..2CASE.If:.CASE.Unless:.CASE.While:.CASE.Until:#0A
..7size,.ln.:#3D.3,.h4!x;.ENDCASE#0A#0A..2CASE.Valo
f:.CASE.Lv:.CASE.Ind:.CASE.Neg:.CASE.Not:#0A..7size
..3:#3D.2;..5ENDCASE#0A#0A..2CASE.Printf:.CASE.Sys:
.CASE.Static:.CASE.Resultis:#0A..7size,.ln.:#3D.2,.
h3!x;.ENDCASE#0A#0A..2CASE.True:.CASE.False:#0A..7s
ize..3:#3D.1;..5ENDCASE#0A..}#0A.#0A..IF.n#3Dd.DO.{
.writes("Etc");.RETURN.}#0A..writef("%s",.opstr(h1!
x))#0A..IF.ln.DO.writef("..--.line.%n",.ln)#0A..FOR
.i.#3D.2.TO.size.DO.{.newline()#0A..23FOR.j#3D0.TO.
n-1.DO.writes(.v!j.)#0A..23writes("**-")#0A..23v!n.
:#3D.i#3Dsize->"..","!."#0A..23plist(h1!(x+i-1),.n+
1,.d)#0A..21}#0A}#0A#0A1AND.trnerr(mess,.a).BE#0A{.
writes("Error")#0A..IF.procname.DO.writef(".in.%s",
.@h3!procname)#0A..IF.comline.DO.writef(".near.line
.%n",.comline)#0A..writes(":..1")#0A..writef(mess,.
a)#0A..newline()#0A..errcount.:#3D.errcount.+.1#0A.
.IF.errcount.>#3D.errmax.DO.fatalerr("*nCompilation
.aborted*n")#0A}#0A#0AAND.trprog(x).BE#0A{.dvec,.dv
ect.:#3D.treevec,.treep#0A..h1!dvec,.h2!dvec,.h3!dv
ec.:#3D.0,.0,.0#0A..dvece.:#3D.dvec+3#0A..FOR.i.#3D
.0.TO.nametablesize-1.DO#0A..{.LET.name.#3D.nametab
le!i#0A..2UNTIL.name#3D0.DO#0A..2{.LET.next.#3D.h2!
name#0A..4h2!name.:#3D.0.//.Mark.undeclared#0A..4na
me.:#3D.next#0A..2}#0A..}#0A#0A..FOR.i.#3D.0.TO.lab
max.DO.labv!i,.refv!i.:#3D.-1,.0#0A#0A..resultlab.:
#3D.-2#0A..comline,.procname,.labnumber.:#3D.1,.0,.
1#0A..ssp.:#3D.2#0A#0A..outfl(Laddr,.1);.ssp.:#3D.s
sp+1..//.1.#3D.lab.number.of.start#0A..outfn(Fnap,.
3);..ssp.:#3D.ssp-1#0A..outf(Halt)#0A#0A..declstatn
ames(x)#0A..checkdistinct(dvec+3)#0A..WHILE.x.DO.{.
trdecl(h2!x);.x:#3Dh3!x.}#0A..resolvelabels()#0A..w
ritef("Program.size:.%n..1Data.size:.%n*n",.codep-c
odev,.datap-datav)#0A}#0A#0ALET.trnext(next).BE.{.I
F.next<0.DO.outf(Rtrn)#0A..20IF.next>0.DO.outfl(Jum
p,.next)#0A..18}#0A.#0ALET.trcom(x,.next).BE#0A//.x
..5is.the.command.to.translate#0A//.next<0..compile
.x.followed.by.Rtrn#0A//.next>0..compile.x.followed
.by.Jump.next#0A//.next#3D0..compile.x.only#0A{.LET
.op.#3D.h1!x#0A#0A..SWITCHON.op.INTO#0A..{.DEFAULT:
.trnerr("Compiler.error.in.Trans")#0A..11RETURN#0A.
#0A..2CASE.Let:#0A..9{.LET.e,.s.#3D.dvece,.ssp#0A..
11comline.:#3D.h5!x#0A..11addname(h2!x,.Local,.ssp+
1)#0A..11load(h3!x)#0A..11trcom(h4!x,.next)#0A..11u
ndeclare(e)#0A..11outfn(Stack,.s)#0A..11ssp.:#3D.s#0A
..11RETURN#0A..9}#0A..#0A..2CASE.Vec:#0A..9{.LET.e,
.s.#3D.dvece,.ssp#0A..11comline.:#3D.h5!x#0A..11add
name(h2!x,.Vec,.ssp+1)#0A..11ssp.:#3D.ssp.+.h2!(h3!
x)#0A..11outfn(Stack,.ssp)#0A..11trcom(h4!x,.next)#0A
..11undeclare(e)#0A..11outfn(Stack,.s)#0A..11ssp.:#3D
.s#0A..11RETURN#0A..9}#0A..#0A..2CASE.Assign:#0A..1
1comline.:#3D.h4!x#0A..11assign(h2!x,.h3!x)#0A..11t
rnext(next)#0A..11RETURN#0A.#0A..2CASE.Rtap:#0A..9{
.LET.s.#3D.ssp#0A..11comline.:#3D.h4!x#0A..11ssp.:#3D
.ssp+3#0A..11outfn(Stack,.ssp)#0A..11loadlist(h3!x)
#0A..11load(h2!x)#0A..11outfn(Rtap,.s+1)#0A..11ssp.
:#3D.s#0A..11trnext(next)#0A..11RETURN#0A..9}#0A.#0A
..2CASE.Printf:#0A..2CASE.Sys:#0A..9{.LET.s.#3D.ssp
#0A..11LET.op.#3D.h1!x#0A..11comline.:#3D.h3!x#0A..
11loadlist(h2!x)#0A..11outfn(op,.s+1)#0A..11ssp.:#3D
.s#0A..11trnext(next)#0A..11RETURN#0A..9}#0A.#0A..2
CASE.Unless:#0A..2CASE.If:.comline.:#3D.h4!x#0A..11
TEST.next>0#0A..11THEN.{.jumpcond(h2!x,.op#3DUnless
,.next)#0A..18trcom(h3!x,.next)#0A..16}#0A..11ELSE.
{.LET.l.#3D.nextlab()#0A..18jumpcond(h2!x,.op#3DUnl
ess,.l)#0A..18trcom(h3!x,.next)#0A..18outlab(l)#0A.
.18trnext(next)#0A..16}#0A..11RETURN#0A.#0A..2CASE.
Test:#0A..9{.LET.l,.m.#3D.nextlab(),.0#0A..11comlin
e.:#3D.h5!x#0A..11jumpcond(h2!x,.FALSE,.l)#0A..7#0A
..11TEST.next#3D0#0A..11THEN.{.m.:#3D.nextlab();.tr
com(h3!x,.m).}#0A..11ELSE.trcom(h3!x,.next)#0A..19#0A
..11outlab(l)#0A..11trcom(h4!x,.next)#0A..11UNLESS.
m#3D0.DO.outlab(m)#0A..11RETURN#0A..9}#0A.#0A..2CAS
E.Return:#0A..11comline.:#3D.h2!x#0A..11outf(Rtrn)#0A
..11RETURN#0A.#0A..2CASE.Resultis:#0A..11comline.:#3D
.h3!x#0A..11IF.resultlab#3D-1.DO.{.fnbody(h2!x);.RE
TURN.}#0A..11UNLESS.resultlab>0.DO#0A..11{.trnerr("
RESULTIS.out.of.context")#0A..13RETURN#0A..11}#0A..
11load(h2!x)#0A..11outfl(Resultis,.resultlab)#0A..1
1ssp.:#3D.ssp.-.1#0A..11RETURN#0A.#0A..2CASE.Until:
#0A..2CASE.While:#0A..9{.LET.l,.m.#3D.nextlab(),.ne
xt#0A..11comline.:#3D.h4!x#0A..11IF.next<#3D0.DO.m.
:#3D.nextlab()#0A..11jumpcond(h2!x,.op#3DUntil,.m)#0A
..11outlab(l)#0A..11trcom(h3!x,.0)#0A..11comline.:#3D
.h4!x#0A..11jumpcond(h2!x,.op#3DWhile,.l)#0A..11IF.
next<#3D0.DO.outlab(m)#0A..11trnext(next)#0A..11RET
URN#0A..9}#0A.#0A..2CASE.For:#0A..9{.LET.e,.s.#3D.d
vece,.ssp#0A..11LET.l,.m.#3D.nextlab(),.nextlab()#0A
..11comline.:#3D.h5!x#0A..11addname(h2!x,.Local,.ss
p+1)#0A..11load(h3!x)..//.The.control.variable.at.s
+1#0A..11load(h4!x)..//.The.end.limit..6at.s+2#0A#0A
..11outfl(Jump,.m)..13//.Jump.to.test#0A#0A..11outl
ab(l)..18//.Start.of.body#0A..11trcom(h5!x,.0)#0A#0A
..11outfn(Lp,.s+1);.ssp.:#3D.ssp+1.//.Inc.control.v
ariable#0A..11outfn(Ln,.1);..1ssp.:#3D.ssp+1#0A..11
outf(Add);..4ssp.:#3D.ssp-1#0A..11outfn(Sp,.s+1);.s
sp.:#3D.ssp-1#0A#0A..11outlab(m)#0A..11outfn(Lp,.s+
1);.ssp.:#3D.ssp+1.//.Compare.with.limit#0A..11outf
n(Lp,.s+2);.ssp.:#3D.ssp+1#0A..11outf(Le);..5ssp.:#3D
.ssp-1#0A..11outfl(Jt,.l);..1ssp.:#3D.ssp-1#0A#0A..
11undeclare(e)#0A..11outfn(Stack,.s)#0A..11ssp.:#3D
.s#0A..11trnext(next)#0A..11RETURN#0A..9}#0A..#0A..
2CASE.Seq:#0A..10trcom(h2!x,.0)#0A..10x.:#3D.h3!x#0A
..}#0A}.REPEAT#0A#0AAND.declstatnames(x).BE.WHILE.x
.DO#0A{.LET.d.#3D.h2!x#0A..#0A..SWITCHON.h1!d.INTO#0A
..{.DEFAULT:..trnerr("Compiler.error.in.declstatnam
es")#0A..12RETURN#0A#0A..2CASE.Static:.{.LET.p,.np.
#3D.h2!d,.0#0A..17WHILE.p.SWITCHON.h1!p.INTO#0A..17
{.DEFAULT:..trnerr("Bad.STATIC.declaration")#0A..29
RETURN#0A#0A..19CASE.Comma:..np.:#3D.h3!p#0A..32p..
:#3D.h2!p#0A..32LOOP#0A#0A..19CASE.Name:.{.LET.lab.
#3D.nextlab()#0A..32outvar(lab)#0A..32addname(p,.Va
r,.lab)#0A..32p.:#3D.np#0A..32np.:#3D.0#0A..32LOOP#0A
..30}#0A..19CASE.Statvec:#0A..30{.LET.lab.#3D.nextl
ab()#0A..32LET.upb.#3D.h2!(h3!p)#0A..32outstatvec(l
ab,.upb)#0A..32addname(h2!p,.Addr,.lab)#0A..32p.:#3D
.np#0A..32np.:#3D.0#0A..32LOOP#0A..30}#0A..17}#0A..
17ENDCASE..4#0A..15}#0A#0A..2CASE.Fndef:#0A..2CASE.
Rtdef:.#0A..12{.LET.name.#3D.h2!d#0A..14LET.lab.#3D
.name#3Dnamestart.->.1,.nextlab()#0A..14addname(nam
e,.Addr,.lab)#0A..14ENDCASE#0A..12}#0A..}#0A..x.:#3D
.h3!x#0A}#0A#0AAND.decldyn(x).BE.UNLESS.x#3D0.DO#0A
.#0A{.IF.h1!x#3DName..DO.{.ssp.:#3D.ssp+1#0A..19add
name(x,.Local,.ssp)#0A..19RETURN#0A..17}#0A.#0A..IF
.h1!x#3DComma.DO.{.ssp.:#3D.ssp+1#0A..19addname(h2!
x,.Local,.ssp)#0A..19decldyn(h3!x)#0A..19RETURN#0A.
.17}#0A.#0A..1trnerr("Compiler.error.in.Decldyn")#0A
}#0A.#0AAND.checkdistinct(p).BE#0A{.LET.lim.#3D.dve
ce.-.3#0A..FOR.q.#3D.p.TO.lim-3.BY.3.DO#0A..{.LET.n
.#3D.h1!q#0A..2FOR.c.#3D.q+3.TO.lim.BY.3.DO#0A..6IF
.h1!c#3Dn.DO.trnerr("Name.%s.defined.twice",.@h3!n)
#0A..}#0A}#0A.#0AAND.addname(name,.k,.a).BE#0A{.LET
.p.#3D.dvece.+.3#0A..IF.p>dvect.DO.{.trnerr("More.w
orkspace.needed");.RETURN.}#0A..h1!dvece,.h2!dvece,
.h3!dvece.:#3D.name,.k,.a#0A..h2!name.:#3D.dvece.//
.Remember.the.declaration#0A..dvece.:#3D.p#0A}#0A.#0A
AND.undeclare(e).BE.#0A{.FOR.t.#3D.e.TO.dvece-3.BY.
3.DO#0A..{.LET.name.#3D.h1!t#0A..2h2!name.:#3D.0..1
//.Forget.its.declaration#0A..}#0A..dvece.:#3D.e#0A
}#0A#0AAND.cellwithname(n).#3D.VALOF#0A{.LET.t.#3D.
h2!n#0A..UNLESS.t#3D0.RESULTIS.t..//.It.has.been.lo
oked.up.before#0A..t.:#3D.dvece#0A..t.:#3D.t.-.3.RE
PEATUNTIL.h1!t#3Dn.|.h1!t#3D0#0A..h2!n.:#3D.t..//.A
ssociate.the.name.with.declaration.item#0A..RESULTI
S.t#0A}#0A.#0AAND.trdecl(x).BE.SWITCHON.h1!x.INTO#0A
{..CASE.Static:..//.Static.declarations.are.compile
d.in.declstatnames#0A..13RETURN#0A#0A..1CASE.Fndef:
#0A..1CASE.Rtdef:#0A..11{.LET.e.#3D.dvece#0A..13LET
.name.#3D.h2!x#0A..13LET.t.#3D.cellwithname(name)#0A
..13LET.strlab.#3D.nextlab()#0A#0A..13resultlab.:#3D
.-2#0A..13procname.:#3D.name#0A#0A..13outstring(str
lab,.@h3!procname)#0A..13outentry(h3!t,.strlab)#0A.
.13ssp.:#3D.2#0A..13decldyn(h3!x)..//.Declare.the.f
ormal.paramenters#0A..13checkdistinct(e)#0A..13outf
n(Stack,.ssp)#0A..13TEST.h1!x#3DRtdef.THEN.trcom(h4
!x,.-1)#0A..29ELSE.fnbody(h4!x)#0A.#0A..13undeclare
(e)#0A..13procname.:#3D.0#0A..11}#0A.#0A..DEFAULT:.
.1RETURN#0A}#0A.#0ALET.jumpcond(x,.b,.l).BE#0A{.LET
.sw.#3D.b#0A#0A..SWITCHON.h1!x.INTO#0A..{.CASE.Fals
e:..b.:#3D.NOT.b#0A..2CASE.True:..1IF.b.DO.outfl(Ju
mp,.l)#0A..15RETURN#0A.#0A..2CASE.Not:..2jumpcond(h
2!x,.NOT.b,.l)#0A..15RETURN#0A.#0A..2CASE.And:.sw.:
#3D.NOT.sw#0A..2CASE.Or:..TEST.sw.THEN.{.jumpcond(h
2!x,.b,.l)#0A..27jumpcond(h3!x,.b,.l)#0A..27RETURN#0A
..25}#0A.#0A..21ELSE.{.LET.m.#3D.nextlab()#0A..28ju
mpcond(h2!x,.NOT.b,.m)#0A..28jumpcond(h3!x,.b,.l)#0A
..28outlab(m)#0A..28RETURN#0A..26}#0A.#0A..2DEFAULT
:..3load(x)#0A..15outfl(b.->.Jt,.Jf,.l)#0A..15ssp.:
#3D.ssp-1#0A..15RETURN#0A..}#0A}#0A#0ALET.load(x).B
E#0A{.LET.op.#3D.h1!x#0A#0A..SWITCHON.op.INTO#0A..{
.DEFAULT:..4trnerr("Compiler.error.in.Load,.op#3D%n
",.op)#0A..16outfl(Ln,.0)#0A..16ssp.:#3D.ssp+1#0A..
16RETURN#0A.#0A..2CASE.Vecap:#0A..2CASE.Mul:.CASE.D
iv:.CASE.Mod:.CASE.Add:.CASE.Sub:#0A..2CASE.Eq:.CAS
E.Ne:.CASE.Lt:.CASE.Gt:.CASE.Le:.CASE.Ge:#0A..2CASE
.Lsh:.CASE.Rsh:.CASE.And:.CASE.Or:.CASE.Xor:#0A..16
load(h2!x);.load(h3!x);.outf(op)#0A..16ssp.:#3D.ssp
-1#0A..16RETURN#0A.#0A..2CASE.Ind:.CASE.Neg:.CASE.N
ot:#0A..16load(h2!x)#0A..16outf(op)#0A..16RETURN#0A
#0A..2CASE.Lv:..4loadlv(h2!x)#0A..16RETURN#0A.#0A..
2CASE.Num:..3outfn(Ln,.h2!x);.ssp.:#3D.ssp+1;.RETUR
N#0A..2CASE.True:..2outfn(Ln,.-1);..1ssp.:#3D.ssp+1
;.RETURN#0A..2CASE.False:..1outfn(Ln,.0);..2ssp.:#3D
.ssp+1;.RETURN#0A.#0A..2CASE.String:..#0A..14{.LET.
strlab.#3D.nextlab()#0A..16outstring(strlab,.@h2!x)
#0A..16outfl(Laddr,.strlab)#0A..16ssp.:#3D.ssp+1#0A
..16RETURN#0A..14}#0A.#0A..2CASE.Name:..2transname(
x,.Lp,.Ll,.Llp,.Laddr)#0A..16ssp.:#3D.ssp+1#0A..16R
ETURN#0A.#0A..2CASE.Valof:.{.LET.rl.#3D.resultlab#0A
..16resultlab.:#3D.nextlab()#0A..16trcom(h2!x,.0)#0A
..16outlab(resultlab)#0A..16outfn(Stack,.ssp)#0A..1
6outf(Lres);.ssp.:#3D.ssp+1#0A..16resultlab.:#3D.rl
#0A..16RETURN#0A..14}#0A.#0A..2CASE.Fnap:..{.LET.s.
#3D.ssp#0A..16ssp.:#3D.ssp+3#0A..16outfn(Stack,.ssp
)#0A..16loadlist(h3!x)#0A..16load(h2!x)#0A..16outfn
(Fnap,.s+1)#0A..16outf(Lres);.ssp.:#3D.s+1#0A..16RE
TURN#0A..14}#0A..2CASE.Printf:#0A..2CASE.Sys:#0A..9
{.LET.s.#3D.ssp#0A..11LET.op.#3D.h1!x#0A..11comline
.:#3D.h3!x#0A..11loadlist(h2!x)#0A..11outfn(op,.s+1
)#0A..11ssp.:#3D.s#0A..11outf(Lres)#0A..11ssp.:#3D.
ssp+1#0A..11RETURN#0A..9}#0A..}#0A}#0A#0AAND.loadlv
(x).BE.SWITCHON.h1!x.INTO#0A{.DEFAULT:..2trnerr("Ba
d.operand.to.@")#0A..12outf(Lres);.ssp.:#3D.ssp+1#0A
..12RETURN#0A#0A..CASE.Name:..transname(x,.Llp,.Lad
dr,.0,.0);.ssp.:#3D.ssp+1#0A..12RETURN#0A#0A..CASE.
Ind:..1load(h2!x)#0A..12RETURN#0A#0A..CASE.Vecap:.l
oad(h2!x);.load(h3!x);.outf(Add);.ssp.:#3D.ssp-1#0A
..12RETURN#0A}#0A#0AAND.fnbody(x).BE.SWITCHON.h1!x.
INTO#0A{.DEFAULT:..4load(x)#0A..14outf(Fnrn)#0A..14
ssp.:#3D.ssp-1#0A..14RETURN#0A..17#0A..CASE.Valof:.
{.LET.e,.rl.#3D.dvece,.resultlab#0A..14resultlab.:#3D
.-1#0A..14trcom(h2!x,.-1)#0A..14resultlab.:#3D.rl#0A
..14undeclare(e)#0A..14RETURN#0A..12}#0A}#0A.#0AAND
.loadlist(x).BE.UNLESS.x#3D0.TEST.h1!x#3DComma#0A..
28THEN.{.loadlist(h2!x);.loadlist(h3!x).}#0A..28ELS
E.load(x)#0A#0AAND.assign(x,.y).BE.SWITCHON.h1!x.IN
TO#0A{.DEFAULT:..2trnerr("Bad.assignment")#0A..12RE
TURN#0A..CASE.Name:..load(y)#0A..12transname(x,.Sp,
.Sl,.0,.0)#0A..12ssp.:#3D.ssp-1#0A..12RETURN#0A..CA
SE.Vecap:.load(y)#0A..12load(h2!x);.load(h3!x);.out
f(Add);.ssp.:#3D.ssp-1#0A..12outf(Stind);.ssp.:#3D.
ssp-2#0A..12RETURN#0A..CASE.Ind:..1load(y)#0A..12lo
ad(h2!x)#0A..12outf(Stind);.ssp.:#3D.ssp-2#0A..12RE
TURN#0A}#0A.#0AAND.transname(x,.p,.l,.v,.a).BE#0A{.
LET.c.#3D.cellwithname(x)#0A..LET.k,.n.#3D.h2!c,.h3
!c#0A..LET.name.#3D.@h3!x#0A.#0A..SWITCHON.k.INTO#0A
..{.DEFAULT:..4trnerr("Name.'%s'.not.declared",.nam
e)#0A..1#0A..2CASE.Local:..1outfn(p,.n);.RETURN#0A.
#0A..2CASE.Var:..3outfl(l,.n);.RETURN#0A.#0A..2CASE
.Vec:..3IF.v#3D0.DO#0A..16{.trnerr("Misuse.of.local
.vector.'%s'",.name)#0A..18v.:#3D.p#0A..16}#0A..16o
utfn(v,.n)#0A..16RETURN#0A#0A..2CASE.Addr:..2IF.a#3D
0.DO#0A..16{.trnerr("Misuse.of.entry.name.'%s'",.na
me)#0A..18a.:#3D.l#0A..16}#0A..16outfl(a,.n)#0A..16
RETURN#0A..}#0A}#0A.#0AAND.wrf(form,.a,.b,.c).BE.IF
.optCode.DO.writef(form,.a,.b,.c)#0A#0AAND.outf(op)
.BE#0A{.wrf("%s*n",.opstr(op))#0A..putc(op)#0A}#0A#0A
AND.outfn(op,.a).BE#0A{.wrf("%s.%n*n",.opstr(op),.a
)#0A..putc(op);.putc(a)#0A}#0A#0AAND.outfl(op,.lab)
.BE#0A{.wrf("%s.L%n*n",.opstr(op),.lab)#0A..putc(op
);.putref(lab)#0A}#0A#0AAND.outlab(lab).BE#0A{.wrf(
"Lab.L%n*n",.lab)#0A..setlab(lab,.codep)#0A}#0A#0AA
ND.outentry(l1,.l2).BE#0A{.wrf("Entry.L%n.L%n*n",.l
1,.l2)#0A..putref(l2)#0A..setlab(l1,.codep)#0A}#0A#0A
AND.outstring(lab,.s).BE#0A{.LET.sv.#3D.mem+datap#0A
..LET.p.#3D.datap#0A..LET.len.#3D.s%0#0A..wrf("Stri
ng.L%n.%s*n",.lab,.s)#0A..setlab(lab,.datap)#0A..FO
R.i.#3D.0.TO.len.DO#0A..{.IF.i.REM.4.#3D.0.DO.putd(
0)#0A..2sv%i.:#3D.i<len.->.s%(i+1),.0.//.assemble.a
.zero.terminated.string#0A..}#0A}#0A#0AAND.outstatv
ec(lab,.a).BE#0A{.wrf("Statvec.L%n.%n*n",.lab,.a)#0A
..setlab(lab,.datap)#0A..FOR.i.#3D.0.TO.a-1.DO.putd
(0)#0A}#0A#0AAND.outvar(lab).BE#0A{.wrf("Var.L%n*n"
,.lab)#0A..setlab(lab,.datap)#0A..putd(0)#0A}#0A.#0A
AND.putc(w).BE.TEST.codep>codet#0A..13THEN.trnerr("
More.code.space.needed")#0A..13ELSE.{.mem!codep.:#3D
.w#0A..20codep.:#3D.codep+1#0A..18}#0A#0AAND.putd(w
).BE.TEST.datap>datat#0A..13THEN.trnerr("More.data.
space.needed")#0A..13ELSE.{.mem!datap.:#3D.w#0A..20
datap.:#3D.datap+1#0A..18}#0A#0AAND.putref(lab).BE.
TEST.codep>codet#0A..17THEN.trnerr("More.code.space
.needed")#0A..17ELSE.{.mem!codep.:#3D.refv!lab#0A..
24refv!lab.:#3D.codep#0A..24codep.:#3D.codep+1#0A..
22}#0A#0AAND.setlab(lab,.addr).BE.labv!lab.:#3D.add
r#0A#0AAND.nextlab().#3D.VALOF#0A{.TEST.labnumber>#3D
labmax#0A..THEN.fatalerr("More.label.space.needed")
#0A..ELSE.labnumber.:#3D.labnumber.+.1#0A..RESULTIS
.labnumber#0A}#0A.#0A#0AAND.resolvelabels().BE.FOR.
lab.#3D.1.TO.labnumber.DO#0A{.LET.p.#3D.refv!lab#0A
..LET.labval.#3D.labv!lab#0A..IF.p.&.labval<0.TEST.
lab#3D1.THEN.trnerr("start.not.defined")#0A..27ELSE
.trnerr("Label.%n.unset",.lab)#0A..WHILE.p.DO.{.LET
.np.#3D.mem!p#0A..13mem!p,.p.:#3D.labval,.np#0A..11
}#0A}#0A#0AAND.interpret(regs,.mem).#3D.VALOF#0A{.L
ET.retcode.#3D.0#0A..LET.rv.#3D.mem+regs#0A..LET.re
s,.pp,.sp,.pc.#3D.rv!0,.mem+rv!1,.mem+rv!2,.mem+rv!
3#0A..LET.count.#3D.rv!4#0A#0A..{.LET.op.#3D.!pc..1
4//.Fetch.next.instruction#0A..2IF.optTrace.DO#0A..
2{.writef("p:%i5..sp:%i5.%iA.%iA..%i5:.%t8",#0A..12
pp-mem,..2sp-mem,.sp!-1,.sp!0,.pc-mem,.opstr(op))#0A
..4IF.hasOperand(op).DO.writef(".%n",.pc!1)#0A..4ne
wline()#0A..2}#0A..2IF.count<#3D0.DO.{.retcode.:#3D
.3;.BREAK.}.//.Zero.count#0A..2count.:#3D.count-1#0A
..2pc.:#3D.pc+1#0A//IF.sp-stack>stackt.DO.abort(992
)#0A..2SWITCHON.op.INTO#0A..2{.DEFAULT:..4retcode.:
#3D.1;..2BREAK..2//.Unknown.op.code#0A#0A..4CASE.Ha
lt:..2retcode.:#3D.sp!0;.BREAK#0A#0A..4CASE.Laddr:.
.1sp.:#3D.sp+1;.sp!0.:#3D.!pc;..5pc.:#3D.pc+1;.LOOP
#0A..4CASE.Ln:..4sp.:#3D.sp+1;.sp!0.:#3D.!pc;..5pc.
:#3D.pc+1;.LOOP#0A..4CASE.Lp:..4sp.:#3D.sp+1;.sp!0.
:#3D.pp!(!pc);..pc.:#3D.pc+1;.LOOP#0A..4CASE.Llp:..
3sp.:#3D.sp+1;.sp!0.:#3D.pp+!pc-mem;pc.:#3D.pc+1;.L
OOP#0A..4CASE.Ll:..4sp.:#3D.sp+1;.sp!0.:#3D.mem!(!p
c);.pc.:#3D.pc+1;.LOOP#0A..4CASE.Sp:..4pp!(!pc).:#3D
.sp!0;.sp.:#3D.sp-1;..pc.:#3D.pc+1;.LOOP#0A..4CASE.
Sl:..4mem!(!pc):#3D.sp!0;.sp.:#3D.sp-1;..pc.:#3D.pc
+1;.LOOP#0A#0A..4CASE.Rtap:#0A..4CASE.Fnap:..{.LET.
opp,.retaddr.#3D.pp,.pc+1#0A..18pp,.pc.:#3D.pp+!pc,
.sp!0+mem#0A..18pp!0,.pp!1,.pp!2.:#3D.opp-mem,.reta
ddr-mem,.pc-mem#0A..18sp.:#3D.pp+2#0A..18LOOP#0A..1
6}#0A#0A..4CASE.Lres:..2sp.:#3D.sp+1;.sp!0.:#3D.res
;..14LOOP#0A#0A..4CASE.Fnrn:..2res.:#3D.sp!0#0A..4C
ASE.Rtrn:..{.LET.npp,.npc.#3D.pp!0+mem,.pp!1+mem#0A
..18sp.:#3D.pp-1#0A..18pp,.pc.:#3D.npp,.npc#0A..18L
OOP#0A..16}#0A..4CASE.Ind:..3sp!0.:#3D..mem!(sp!0);
..17LOOP#0A..4CASE.Neg:..3sp!0.:#3D..-..sp!0;..20LO
OP#0A..4CASE.Not:..3sp!0.:#3D.NOT.sp!0;..20LOOP#0A.
.4CASE.Stind:..1sp.:#3D.sp-2;.mem!(sp!2).:#3D.sp!1;
..6LOOP#0A..4CASE.Vecap:..1sp.:#3D.sp-1;.sp!0.:#3D.
mem!(sp!0.+.sp!1);.LOOP#0A..4CASE.Mul:..3sp.:#3D.sp
-1;.sp!0.:#3D.sp!0..*..sp!1;..3LOOP#0A..4CASE.Div:.
.3sp.:#3D.sp-1;.sp!0.:#3D.sp!0../..sp!1;..3LOOP#0A.
.4CASE.Mod:..3sp.:#3D.sp-1;.sp!0.:#3D.sp!0.REM.sp!1
;..3LOOP#0A..4CASE.Add:..3sp.:#3D.sp-1;.sp!0.:#3D.s
p!0..+..sp!1;..3LOOP#0A..4CASE.Sub:..3sp.:#3D.sp-1;
.sp!0.:#3D.sp!0..-..sp!1;..3LOOP#0A..4CASE.Eq:..4sp
.:#3D.sp-1;.sp!0.:#3D.sp!0..#3D..sp!1;..3LOOP#0A..4
CASE.Ne:..4sp.:#3D.sp-1;.sp!0.:#3D.sp!0.~#3D..sp!1;
..3LOOP#0A..4CASE.Le:..4sp.:#3D.sp-1;.sp!0.:#3D.sp!
0.<#3D..sp!1;..3LOOP#0A..4CASE.Ge:..4sp.:#3D.sp-1;.
sp!0.:#3D.sp!0.>#3D..sp!1;..3LOOP#0A..4CASE.Lt:..4s
p.:#3D.sp-1;.sp!0.:#3D.sp!0..<..sp!1;..3LOOP#0A..4C
ASE.Gt:..4sp.:#3D.sp-1;.sp!0.:#3D.sp!0..>..sp!1;..3
LOOP#0A..4CASE.Lsh:..3sp.:#3D.sp-1;.sp!0.:#3D.sp!0.
<<..sp!1;..3LOOP#0A..4CASE.Rsh:..3sp.:#3D.sp-1;.sp!
0.:#3D.sp!0.>>..sp!1;..3LOOP#0A..4CASE.And:..3sp.:#3D
.sp-1;.sp!0.:#3D.sp!0..&..sp!1;..3LOOP#0A..4CASE.Or
:..4sp.:#3D.sp-1;.sp!0.:#3D.sp!0..|..sp!1;..3LOOP#0A
..4CASE.Xor:..3sp.:#3D.sp-1;.sp!0.:#3D.sp!0.XOR.sp!
1;..3LOOP#0A..4CASE.Jt:..4sp.:#3D.sp-1;.pc.:#3D.sp!
1->!pc+mem,pc+1;..LOOP#0A..4CASE.Jf:..4sp.:#3D.sp-1
;.pc.:#3D.sp!1->pc+1,!pc+mem;..LOOP#0A..4CASE.Resul
tis:sp.:#3D.sp-1;.res.:#3D.sp!1#0A..4CASE.Jump:..2p
c.:#3D.!pc+mem;..23LOOP#0A..4CASE.Stack:..1sp.:#3D.
pp.+.!pc;.pc.:#3D.pc+1;..10LOOP#0A..4CASE.Printf:..
sp.:#3D.pp.+.!pc.-.1#0A..18pc.:#3D.pc+1#0A..18print
f(mem,.sp!1,.sp+2)#0A..18LOOP#0A..4CASE.Sys:..3sp.:
#3D.pp.+.!pc.-.1#0A..18pc.:#3D.pc+1#0A..18SWITCHON.
sp!1.INTO#0A..18{.DEFAULT:.writef("*nBad.sys(%n,#2E
#2E1).call*n",.sp!1)#0A..29retcode..:#3D.2;..13BREA
K..1#0A..20CASE.0:..retcode..:#3D.sp!2;..10BREAK#0A
..20CASE.1:..res.:#3D.interpret(sp!2,.mem);.LOOP#0A
..20CASE.2:..optTrace.:#3D.sp!2;..10LOOP#0A..20CASE
.3:..res.:#3D.count;.count.:#3D.sp!2;.LOOP#0A..18}#0A
..2}#0A..}.REPEAT#0A#0A..rv!0,.rv!1,.rv!2,.rv!3,.rv
!4.:#3D.res,.pp-mem,.sp-mem,.pc-mem,.count#0A..RESU
LTIS.retcode#0A}#0A#0AAND.printf(mem,.form,.p).BE#0A
{.LET.fmt.#3D.form+mem#0A..LET.i.#3D.0#0A#0A..{.LET
.k.#3D.fmt%i#0A..2i.:#3D.i+1#0A..2IF.k#3D0.RETURN#0A
..2IF.k#3D'%'.DO#0A..2{.LET.n.#3D.0;#0A..4{.k.:#3D.
fmt%i#0A..6i.:#3D.i+1#0A..6UNLESS.'0'<#3Dk<#3D'9'.B
REAK#0A..6n.:#3D.10*n.+.k.-.'0'#0A..4}.REPEAT#0A..4
SWITCHON.k.INTO#0A..4{.DEFAULT:..wrch(k);.LOOP#0A..
6CASE.'d':.writed..(!p,..3n);.p.:#3D.p+1;.LOOP#0A..
6CASE.'s':.wrs..3(mem+!p,.n);.p.:#3D.p+1;.LOOP#0A..
6CASE.'x':.writehex(!p,..3n);.p.:#3D.p+1;.LOOP#0A..
4}#0A..2}#0A..2wrch(k)#0A..}.REPEAT#0A}#0A#0AAND.wr
s(s,.n).BE#0A{.LET.len.#3D.0#0A..WHILE.s%len.DO.len
.:#3D.len+1#0A..FOR.i.#3D.len+1.TO.n.DO.wrch('.')#0A
..FOR.i.#3D.0.TO.len-1.DO.wrch(s%i)#0A}#0A#0AAND.ha
sOperand(op).#3D.VALOF.SWITCHON.op.INTO#0A{.CASE.Fn
rn:CASE.Rtrn:CASE.Lres:CASE.Halt:#0A..CASE.Vecap:CA
SE.Ind:CASE.Stind:CASE.Neg:CASE.Not:#0A..CASE.Mul:C
ASE.Div:CASE.Mod:CASE.Add:CASE.Sub:#0A..CASE.Eq:CAS
E.Ne:CASE.Le:CASE.Ge:CASE.Lt:CASE.Gt:#0A..CASE.Lsh:
CASE.Rsh:CASE.And:CASE.Or:CASE.Xor:#0A..10RESULTIS.
FALSE#0A..DEFAULT:..RESULTIS.TRUE#0A}#0A#0A

######com/wait.b#
//.(C).Copyright.1978.Tripos.Research.Group#0A//..3
University.of.Cambridge#0A//..3Computer.Laboratory#0A
#0ASECTION."WAIT"#0A#0AGET."libhdr"#0A#0AMANIFEST.{
#0A..msecspermin.#3D.6002#0A..msecsperhour.#3D.msec
spermin*60#0A..msecsperday.#3D.msecsperhour*24#0A}#0A
#0ALET.start().#3D.VALOF#0A{.LET.argv.#3D.VEC.50#0A
..LET.days,.msecs.#3D.0,.0#0A..LET.daysnow,.msecsno
w.#3D.0,.0#0A..LET.n.#3D.0#0A#0A..//.Get.the.date.a
nd.time.now#0A..datstamp(@daysnow)#0A#0A..UNLESS.rd
args("N/N,SEC#3DSECS/S,MIN#3DMINS/S,UNTIL/K",.argv,
.50).DO#0A..{.error(1)#0A..2RESULTIS.20#0A..}#0A#0A
..UNLESS.argv!3.DO..17//.UNTIL/K#0A..{.n.:#3D.1#0A.
.2IF.argv!0.DO.n.:#3D.!(argv!0)..4//.N/N#0A#0A..2TE
ST.argv!2..20//.MINS/S#0A..2THEN.msecs.:#3D.n.*.600
2#0A..2ELSE.msecs.:#3D.n.*.1001#0A..2msecs.:#3D.mse
cs.+.msecsnow#0A..2days.:#3D.daysnow#0A..2IF.msecs.
>.msecsperday.DO.days,.msecs.:#3D.days+1,.msecs-mse
csperday#0A..}#0A..IF.argv!3.DO..21//.UNTIL/K#0A..{
.LET.s.#3D.argv!3#0A..2LET.hour.#3D.0#0A..2LET.min.
#3D.0#0A..2UNLESS.s%0#3D5.DO.{.error(3);.RESULTIS.2
0.}#0A..2FOR.i#3D1.TO.5.UNLESS.i#3D3.->.s%i#3D':',.
'0'<#3Ds%i<#3D'9'.DO#0A..2{.error(3)#0A..4RESULTIS.
20#0A..2}#0A..2hour.:#3D.(s%1-'0')*10+s%2-'0'#0A..2
IF.hour>#3D24.DO.error(3)#0A..2min.:#3D.(s%4-'0')*1
0+s%5-'0'#0A..2IF.min>#3D60.DO#0A..2{.error(3)#0A..
4RESULTIS.20#0A..2}#0A..2msecs.:#3D.hour*msecsperho
ur.+.min*6002#0A..2days.:#3D.daysnow#0A..2IF.msecs<
msecsnow.DO.days.:#3D.days+1#0A..}#0A#0A..{.LET.str
.#3D.VEC.14#0A..2dat_to_strings(@days,.str)#0A..2//
sawritef("Delaying.until.%s.%s*n",.str,.str+5)#0A..
}#0A#0A1..//sawritef("Delaying.until.%n.days.%n.mse
cs*n",.days,.msecs)#0A#0A..{.LET.ds,.ms.#3D.?,.?#0A
..2datstamp(@ds)#0A..//sawritef("Delaying.until.%n.
days.%n.msecs*n",.days,.msecs)#0A..//sawritef("Time
.now..5%n.days.%n.msecs*n",.ds,.ms)#0A..2IF.(ds>day
s).|#0A..5(ds#3Ddays.&.ms>#3Dmsecs).BREAK#0A..2sys(
Sys_delay,.500).//.Sleep.for.1/2.second#0A..2//IF.t
estflags(flag_b).DO#0A..2//{.writes("**2BREAK*N")#0A
..2//..RESULTIS.10#0A..2//}#0A..}.REPEAT#0A#0A..RES
ULTIS.0#0A}#0A#0A1AND.error(n).BE#0A{.writes(n#3D1.
->."Bad.args*N",#0A..7n#3D2.->."Error.in.number*N",
#0A..14"Time.should.be.HH:MM*N")#0A}#0A

######com/why.b#
/*.This.is.a.version.of.the.Tripos.why.command#0D#0A
..1modified.by.Alistair.Scott#0D#0A..00116/09/05.Mo
dified.by.MR#0D#0A*/#0D#0A#0D#0ASECTION."WHY"#0D#0A
#0D#0AGET."libhdr"#0D#0A#0D#0ALET.start().BE#0D#0A{
.LET.v.#3D.VEC.1#0D#0A..rdargs("Type.<cr>.to.know.#2E
#2E1",.v,.1)#0D#0A#0D#0A..UNLESS.cli_returncode.DO#0D
#0A..{.writef("The.last.command.completed.successfu
lly*n")#0D#0A..2result2.:#3D.1002#0D#0A..2stop(1)..
//.Start.the.joke.off!#0D#0A..}#0D#0A#0D#0A..writef
("The.last.command.had.return.code:.%n.for.reason:.
%n*n*n",#0D#0A..8cli_returncode,.cli_result2)#0D#0A
..#0D#0A..SWITCHON.cli_result2.INTO#0D#0A..{.DEFAUL
T:#0D#0A..2CASE.0:#0D#0A..7writes(cli_result2.->."U
nknown.reason*n",#0D#0A..29"No.reason.given*n")#0D#0A
..7result2.:#3D.1002#0D#0A..7stop(1)..//.Start.the.
joke.off!#0D#0A#0D#0A..2CASE.1002:#0D#0A..7writes("
I.have.just.told.you*n")#0D#0A..7result2.:#3D.10000
11#0D#0A..7stop(1)#0D#0A#0D#0A..2CASE.1000011:#0D#0A
..7writes("Don't.you.listen.?.#2E#2E1.I.HAVE.JUST.T
OLD.YOU*n")#0D#0A..7result2.:#3D.1000012#0D#0A..7st
op(1)#0D#0A#0D#0A..2CASE.1000012:#0D#0A..7writes("L
ook.here.you.silly.toad-faced.little.twerp#2E#2E*n"
)#0D#0A..7writes("I.do.not.intend.to.keep.answering
.these.silly.questions,*n")#0D#0A..7writes("so.pack
.it.in.or.I.will.pull.the.plug.on.you!!1*n")#0D#0A.
.7result2.:#3D.1000013#0D#0A..7stop(1)#0D#0A#0D#0A.
.2CASE.1000013:#0D#0A..7writes("Because.I.have.bett
er.things.to.do.than.answering.your*#0D#0A..15*.sil
ly.questions#2E#2E*n")#0D#0A..7writes("I.don't.know
.-.Brain.the.size.of.a.planet.and.all.I.am.*#0D#0A.
.15*asked.to.do*n")#0D#0A..7writes("is.answer.stupi
d.questions.from.some.immature.little.*#0D#0A..14*c
retin.who*n")#0D#0A..7writes("sees.fit.too.waste.my
.time.with.such.trivia#2E#2E2*n")#0D#0A..7result2.:
#3D.1000014#0D#0A..7stop(1)#0D#0A..7ENDCASE#0D#0A#0D
#0A..2CASE.1000014:#0D#0A..7writes("WHY.??1.#2E#2E.
Don't.talk.to.me.about.'WHY'#2E*n")#0D#0A..7writes(
"I.can't.think.WHY.or.even.WHAT,.WHEN,.WHERE.or.WHO
#2E*n")#0D#0A..7writes("In.fact.I.think,.therefore.
I.am.#2E#2E1.or.I.certainly.was.#2E#2E1*n")#0D#0A..
7writes("#2E#2E.but.then.again,.I.might.still.be.#2E
#2E4*n")#0D#0A..7writes("Oh.shit#2E#2E3*n")#0D#0A..
7deplete(cos)#0D#0A..7abort(992,.0)#0D#0A..7writes(
"Oh.Hell.#2E#2E.Here.we.go.again*n")#0D#0A..7result
2.:#3D.1002#0D#0A..7stop(1)#0D#0A..}#0D#0A}#0D#0A#0D
#0A

######com/x8-bin.b#
//.This.is.a.program.convert.a.file.of.32-bit.hex.w
ord.into.a.binary#2E#0A//.Implemented.by.Martin.Ric
hards.(c).Aug.2000002#0A#0A//.Usage:#0A#0A//.x8-bin
.filename.[[TO].tofile]#0A#0A/*#0AIt.will.convert.t
he.file:#0A#0A0004400134241.48474645.4C4B4A49.504F4
E4D.54535251.58575655.310A5A59.3534330012.#0A393837
36.003A30.#0A#0Ato:#0A#0AABCDEFGHIJKLMNOPQRSTUVWXYZ
#0A1234567890#0A#0A(padded.with.two.null.characters
)#0A*/#0A#0AGET."libhdr"#0A#0AGLOBAL.{#0A.eof:.ug#0A
.sysin#0A.sysout#0A.fromname#0A.toname#0A.fromstrea
m#0A.tostream#0A.count#0A}#0A#0ALET.start().#3D.VAL
OF#0A{.LET.argv..2#3D.VEC.50#0A..sysin..4:#3D.input
()#0A..sysout..3:#3D.output()#0A..fromname..1:#3D.0
#0A..toname..3:#3D."JUNK"#0A..fromstream.:#3D.0#0A.
.tostream..1:#3D.0#0A..count..4:#3D.0#0A#0A..UNLESS
.rdargs("FROM/A,TO/K",.argv,.50).DO#0A..{.writes("b
ad.arguments.for.x8-bin*n")#0A..2stop(20)#0A..}#0A#0A
..fromname.:#3D.argv!0..20//.FROM#0A..IF.argv!1.DO.
toname..1:#3D.argv!1..7//.TO#0A.#0A..fromstream.:#3D
.findinput(fromname)#0A..UNLESS.fromstream.DO#0A..{
.writef("can't.open.%s*n",.fromname)#0A..2stop(20)#0A
..}#0A#0A..tostream.:#3D.findoutput(toname)#0A..UNL
ESS.tostream.DO#0A..{.writef("can't.open.%s*n",.ton
ame)#0A..2endread()#0A..2stop(20)#0A..}#0A..selecto
utput(tostream)#0A#0A..selectinput(fromstream)#0A#0A
..{.LET.word.#3D.rdhexword()#0A..2IF.result2#3D-1.B
REAK#0A..2wrword(word)#0A..2count.:#3D.count+4.//.c
ount.in.bytes#0A..2IF.count.REM.1004.#3D.0.DO.sawri
tef("size.%i8*n",.count)#0A..}.REPEAT#0A#0A..endrea
d()#0A#0A..UNLESS.sysout#3Dtostream.DO.endwrite()#0A
#0A..selectoutput(sysout)#0A..writef("%n.bytes.writ
ten.to.file.*"%s*"*n",.count,.toname)#0A..RESULTIS.
0#0A}#0A#0AAND.rdhexword().#3D.VALOF#0A{.LET.word,.
byte.#3D.0,.0#0A..//.Skip.initial.white.space#0A..b
yte.:#3D.rdch().REPEATWHILE.byte#3D'.'.|.byte#3D'*n
'.|.byte#3D'*c'#0A..result2.:#3D.-1#0A#0A..{.LET.va
l.#3D.value(byte)#0A..2UNLESS.0<#3Dval<#3D15.RESULT
IS.word#0A..2word.:#3D.(word<<0004).+.val#0A..2resu
lt2.:#3D.0#0A..2byte.:#3D.rdch()#0A..2result2.:#3D.
0#0A..}.REPEAT#0A}#0A#0AAND.value(ch).#3D.'0'<#3Dch
<#3D'9'.->.ch.-.'0',#0A..14'A'<#3Dch<#3D'F'.->.ch.-
.'A'.+.10,#0A..14'a'<#3Dch<#3D'f'.->.ch.-.'a'.+.10,
#0A..014100#0A#0AAND.wrword(word).BE#0A{.LET.s.#3D.
@word#0A..binwrch(s%0)#0A..binwrch(s%1)#0A..binwrch
(s%2)#0A..binwrch(s%3)#0A}#0A#0A5

######com/xbcpl.b#
//.This.will.be.a.version.of.the.BCPL.to.Cintcode.c
ompiler.with#0A//.some.extensions.to.handle.non.sta
ndard.BCPL.extensions.such#0A//.as.the.<>.operator.
and.floating.point#2E#0A#0A//.Implemented.by.Martin
.Richards.(c).July.2010#0A#0A//.Note:.#2E#2E/cintco
de/.is.used.so.that.the.compiler.can.be#0A//.compil
ed.in.a.directory.parallel.to.cintcode.(such.as.nat
bcpl)#2E#0A#0AGET."#2E#2E/cintcode/com/xbcplfe#2Eb"
#0A#0A#2E#0A#0AGET."#2E#2E/cintcode/com/xbcplcgcin#2E
b"#0A

######com/xbcplcgcin.b#
//.This.will.be.and.extended(?).version.of.the.OCOD
E.to.Cintcode#0A//.codegenerator#2E#0A#0A//.Impleme
nted.by.Martin.Richards.(c).July.2010#0A#0A1/*.Chan
ge.history#0A20/07/10#0AImplemented.the.OF,.floatin
g.point.and.op:#3D.extensions,.ie.the#0AOCODE.state
ments.SELLD,.SELST.and.FLTOP#2E#0A#0A00010/07/09#0A
Separated.the.compiler.into.bcplfe#2Eb.and.codegene
rators#0Abcplcgcin#2Eb.and.bcplcgsial#2Eb.and.added
.the.interface#0Aheader.g/bcplfecg#2Eh#0A#0A00018/0
1/06#0ABased.on.Dave.Lewis's.suggestion,#0Ain.outpu
tsection(),.add:#0A..1IF.objline1%0.DO.writef("%s*n
",.objline1)#0Awhere.objline1.is.the.first.line.of.
file.objline1.if.it.can.be.found#0Ain.the.current.d
irectory.or.in.the.HDRS.directory#2E.This.will.typi
cally#0Aput.a.line.such.as:#0A#23!/usr/local/bin/ci
ntsys.-c#0Aas.the.first.line.of.the.compiled.object
.module#2E.This.line.is.ignored#0Aby.the.CLI.but.ma
y.be.useful.under.Linux#2E.If.objline1.cannot.be.fo
und#0Ano.such.line.is.inserted.at.the.start.of.the.
object.module#2E#0A#0A00026/2/99#0AAdded.BIN.option
.to.the.compiler.to.generate.a.binary.(rather.than#0A
hex).hunk.format.for.the.compiled.code#2E.This.is.p
rimarily.for.the#0AWindows.CE.version.of.the.cintco
de.system.where.compactness.is#0Aparticularly.impor
tant#2E.There.is.a.related.change.to.loadseg.in#0Ac
intmain#2Ec#0A#0A00024/12/95#0AImproved.the.efficie
ncy.of.outputsection.in.CG.by.introducing#0Awrhex2.
and.wrword_at#2E#0A#0A00024/7/95#0ARemoved.bug.in.a
tbinfo,.define.addinfo_b.change.some.global.numbers
#2E#0AImplement.constant.folding.in.TRN#2E#0A#0A000
22/6/93#0AReverse.order.in.SWB.and.have.a.minimum.o
f.7.cases#0Ato.allow.faster.interpreter#2E#0A#0A000
2/6/93#0AChanged.code.for.SWB.to.use.heap-like.bina
ry.tree#2E#0A#0A00019/5/93#0APut.in.code.to.compile
.BTC.and.XPBYT.instructions#2E#0A#0A00023/4/93#0AAl
lowed.the.codegenerator.to.compiler.the.S.instructi
on#2E#0A#0A00021/12/92#0ACured.bug.in.compilation.o
f.(b.->.f,.g)(1,2,3)#0A#0A00024/11/92.#0ACured.bug.
in.compilation.of.a,.b.:#3D.s%0.>.0,.s%1.#3D.'!'#0A
#0A00023/7/92:#0ARenamed.nextlab.as.newlab,.load.as
.loadval.in.the.CG#2E#0APut.back.simpler.hashing.fu
nction.in.lookupword#2E#0ARemoved.rdargs.fudge#2E#0A
Removed.S2.compiler.option#2E#0ACured.bug.concernin
g.the.closing.of.gostream.when.equal.to.stdout#2E#0A
*/#0A#0ASECTION."BCPLCGCIN"#0A#0A//.Header.file.for
.the.CINTCODE32.code-generator#0A//.based.on.the.or
iginal.CINTCODE.code-generator.(1980)#2E#0A//.Copyr
ight..M#2ERichards..0003.January.2000006#2E#0A#0AGE
T."libhdr"#0AGET."bcplfecg"#0A#0A1GLOBAL.{#0A//.Glo
bal.procedures#2E#0Acgsects:.cgg#0Ardl#0Ardgn#0Anew
lab#0Achecklab#0Acgerror#0A#0Ainitstack#0Astack#0As
tore#0Ascan#0Acgpendingop#0Aloadval#0Aloadba#0Asetb
a#0A#0Agenxch#0Agenatb#0Aloada#0Apush#0Aloadboth#0A
inreg_a#0Ainreg_b#0Aaddinfo_a#0Aaddinfo_b#0Apushinf
o#0Axchinfo#0Aatbinfo#0A#0Aforget_a#0Aforget_b#0Afo
rgetall#0Aforgetvar#0Aforgetallvars#0A#0Aiszero#0As
toret#0Agensp#0Agenlp#0Aloadt#0Alose1#0Aswapargs#0A
cgstind#0Astorein#0A#0Acgrv#0Acgadd#0Acgaddk#0Acggl
obal#0Acgentry#0Acgapply#0Acgjump#0Ajmpfn#0Ajfn0#0A
revjfn#0Acompjfn#0Aprepj#0A#0Aswlpos#0Aswrpos#0Afin
dpos#0Arootpos#0A#0Acgswitch#0Aswitcht#0Aswitchseg#0A
switchb#0Aswitchl#0Acgstring#0Asetlab#0Acgstatics#0A
getblk#0Afreeblk#0Afreeblks#0A#0Ainitdatalists#0A#0A
geng#0Agen#0Agenb#0Agenbb#0Agenflt#0Agenfb#0Agenfbb
#0Agenr#0Agenh#0Agenw#0Acheckspace#0Acodeb#0Acode2b
#0Acode4b#0Apack4b#0Acodeh#0Acodew#0Acoder#0A#0Aget
w#0Aputh#0Aputw#0Aalign#0Achkrefs#0Adealwithrefs#0A
genindword#0Ainrange_d#0Ainrange_i#0Afillref_d#0Afi
llref_i#0Arelref#0A#0Aoutputsection#0Awrword#0Awrhe
x2#0Awrword_at#0Adboutput#0Awrkn#0Awrcode#0Awrfcode
#0Asopname#0A#0A//.Global.variables#2E#0Aarg1#0Aarg
2#0A#0Assp#0A#0Atempt#0Atempv#0Astv#0Astvp#0A#0Ach#0A
#0Adp#0Afreelist#0A#0Aincode#0Alabv#0A#0Acasek#0Aca
sel#0A#0Amaxgn#0Amaxlab#0Amaxssp#0A#0Aop#0Alabnumbe
r#0Apendingop#0Aprocdepth#0A#0Aprogsize#0A#0Ainfo_a
#0Ainfo_b#0Areflist#0Arefliste#0Arlist#0Arliste#0An
list#0Anliste#0Askiplab#0A}#0A#0AMANIFEST#0A{#0A//.
Value.descriptors#2E#0Ak_none#3D0;.k_numb#3D1;.k_fn
lab#3D2#0Ak_lvloc#3D3;.k_lvglob#3D4;.k_lvlab#3D5#0A
k_a#3D6;.k_b#3D7;.k_c#3D8#0Ak_loc#3D9;.k_glob#3D10;
.k_lab#3D11;.#0Ak_loc0#3D12;.k_loc1#3D13;.k_loc2#3D
14;.k_loc3#3D15;.k_loc4#3D16#0Ak_glob0#3D17;.k_glob
1#3D18;.k_glob2#3D19#0A#0Aswapped#3DTRUE;.notswappe
d#3DFALSE#0A#0A//.Global.routine.numbers#2E#0Agn_st
op#3D2#0A}#0A#0A//.CINTCODE.op.codes#2E#0AMANIFEST.
{#0Af_k0..1#3D..0010#0Af_fltop#3D..0011..//.Added.2
0/07/10#0Af_lf..1#3D..00012#0Af_lm..1#3D..00014#0Af
_lm1..#3D..00015#0Af_l0..1#3D..00016#0Af_fhop.#3D..
00027#0Af_jeq..#3D..00028#0Af_jeq0.#3D..00030#0A#0A
f_k..2#3D..00032#0Af_kh..1#3D..00033#0Af_kw..1#3D..
00034#0Af_k0g..#3D..00032#0Af_s0g..#3D..00044#0Af_l
0g..#3D..00045#0Af_l1g..#3D..00046#0Af_l2g..#3D..00
047#0Af_lg..1#3D..00048#0Af_sg..1#3D..00049#0Af_llg
..#3D..00050#0Af_ag..1#3D..00051#0Af_mul..#3D..0005
2#0Af_div..#3D..00053#0Af_rem..#3D..00054#0Af_xor..
#3D..00055#0Af_sl..1#3D..00056#0Af_ll..1#3D..00058#0A
f_jne..#3D..00060#0Af_jne0.#3D..00062#0A#0Af_llp..#3D
..00064#0Af_llph.#3D..00065#0Af_llpw.#3D..00066#0Af
_add..#3D..00084#0Af_sub..#3D..00085#0Af_lsh..#3D..
00086#0Af_rsh..#3D..00087#0Af_and..#3D..00088#0Af_o
r..1#3D..00089#0Af_ll1..#3D..00090#0Af_jls..#3D..00
092#0Af_jls0.#3D..00094#0A#0Af_l..2#3D..00096#0Af_l
h..1#3D..00097#0Af_lw..1#3D..00098#0Af_rv..1#3D.110
006#0Af_rtn..#3D.123#0Af_jgr..#3D.124#0Af_jgr0.#3D.
126#0A#0Af_lp..1#3D.128#0Af_lph..#3D.129#0Af_lpw..#3D
.130#0Af_lp0..#3D.128#0Af_swb..#3D.146#0Af_swl..#3D
.147#0Af_st..1#3D.148#0Af_st0..#3D.148#0Af_goto.#3D
.155#0Af_jle..#3D.156#0Af_jle0.#3D.158#0A#0Af_sp..1
#3D.160#0Af_sph..#3D.161#0Af_spw..#3D.162#0Af_sp0..
#3D.160#0Af_s0..1#3D.176#0Af_xch..#3D.181#0Af_gbyt.
#3D.182#0Af_pbyt.#3D.183#0Af_atc..#3D.184#0Af_atb..
#3D.185#0Af_j..2#3D.186#0Af_jge..#3D.188#0Af_jge0.#3D
.190#0A#0Af_ap..1#3D.192#0Af_aph..#3D.193#0Af_apw..
#3D.194#0Af_ap0..#3D.192#0Af_xpbyt#3D.205#0Af_lmh..
#3D.206#0Af_btc..#3D.207#0Af_nop..#3D.208#0Af_a0..1
#3D.208#0Af_rvp0.#3D.211#0Af_st0p0#3D.216#0Af_st1p0
#3D.218#0Af_mw..1#3D.220003#0A#0Af_a..2#3D.220004#0A
f_ah..1#3D.220005#0Af_aw..1#3D.220006#0Af_l0p0.#3D.
220004#0Af_s..2#3D.237#0Af_sh..1#3D.238#0Af_mdiv.#3D
.239#0Af_chgco#3D.240#0Af_neg..#3D.241#0Af_not..#3D
.242#0Af_l1p0.#3D.240#0Af_l2p0.#3D.244#0Af_l3p0.#3D
.247#0Af_l4p0.#3D.249#0Af_selld#3D.254..//.Added.20
/07/10#0Af_selst#3D.255..//.Added.20/07/10#0A}#0A#0A
LET.codegenerate(workspace,.workspacesize).BE#0A{./
/writes("CIN32CG.9.June.1991*n")#0A#0A..1IF.workspa
cesize<2001.DO.{.cgerror("Too.little.workspace")#0A
..29errcount.:#3D.errcount+1#0A..29longjump(fin_p,.
fin_l)#0A..26}#0A#0A..1progsize.:#3D.0#0A#0A..1op.:
#3D.rdn()#0A#0A..1cgsects(workspace,.workspacesize)
#0A..1writef("Code.size.#3D.%i5.bytes*n",.progsize)
#0A}#0A#0A1AND.cgsects(workvec,.vecsize).BE.UNTIL.o
p#3D0.DO#0A{.LET.p.#3D.workvec#0A..1tempv.:#3D.p#0A
..1p.:#3D.p+90#0A..1tempt.:#3D.p#0A..1casek.:#3D.p#0A
..1p.:#3D.p+400#0A..1casel.:#3D.p#0A..1p.:#3D.p+400
#0A..1labv.:#3D.p#0A..1dp.:#3D.workvec+vecsize#0A..
1labnumber.:#3D.(dp-p)/10+10#0A..1p.:#3D.p+labnumbe
r#0A..1FOR.lp.#3D.labv.TO.p-1.DO.!lp.:#3D.-1#0A..1s
tv.:#3D.p#0A..1stvp.:#3D.0#0A..1incode.:#3D.FALSE#0A
..1maxgn.:#3D.0#0A..1maxlab.:#3D.0#0A..1maxssp.:#3D
.0#0A..1procdepth.:#3D.0#0A..1info_a,.info_b.:#3D.0
,.0#0A..1initstack(3)#0A..1initdatalists()#0A#0A..1
codew(0)..//.For.size.of.module#2E#0A..1IF.op#3Ds_s
ection.DO#0A..1{.MANIFEST.{.upb#3D11.}.//.Max.lengt
h.of.entry.name#0A..4LET.n.#3D.rdn()#0A..4LET.v.#3D
.VEC.upb/bytesperword#0A..4v%0.:#3D.upb#0A..4//.Pac
k.up.to.11.character.of.the.name.into.v.including#0A
..4//.the.first.and.last.five#2E#0A..4TEST.n<#3D11#0A
..4THEN.{.FOR.i.#3D.1.TO.n.DO.v%i.:#3D.rdn()#0A..11
FOR.i.#3D.n+1.TO.11.DO.v%i.:#3D.'*s'#0A..9}#0A..4EL
SE.{.FOR.i.#3D.1.TO.5..1DO.v%i.:#3D.rdn()#0A..11FOR
.i.#3D.6.TO.n-6.DO.rdn().//.Ignore.the.middle.chara
cters#0A..11FOR.i.#3D.6.TO.11..DO.v%i.:#3D.rdn()#0A
..11IF.n>11.DO.v%6.:#3D.'*''#0A..9}#0A..4IF.naming.
DO.{.codew(sectword)#0A..20codew(pack4b(v%0,.v%1,.v
%.2,.v%.3))#0A..20codew(pack4b(v%4,.v%5,.v%.6,.v%.7
))#0A..20codew(pack4b(v%8,.v%9,.v%10,.v%11))#0A..17
}#0A..4op.:#3D.rdn()#0A..1}#0A#0A..1scan()#0A..1op.
:#3D.rdn()#0A..1putw(0,.stvp/4)..//.Plant.size.of.m
odule#2E#0A..1outputsection()#0A..1progsize.:#3D.pr
ogsize.+.stvp#0A}#0A#0A1//.Read.an.OCODE.operator.o
r.argument#2E#0A/*#0AAND.rdn().#3D.VALOF#0A{.LET.a,
.sign.#3D.0,.'+'#0A..1ch.:#3D.rdch().REPEATWHILE.ch
#3D'*s'.|.ch#3D'*n'#0A..1IF.ch#3Dendstreamch.RESULT
IS.0#0A..1IF.ch#3D'-'.DO.{.sign.:#3D.'-';.ch.:#3D.r
dch().}#0A..1WHILE.'0'<#3Dch<#3D'9'.DO.{.a.:#3D.10*
a.+.ch.-.'0';.ch.:#3D.rdch()..}#0A..1IF.sign#3D'-'.
RESULTIS.-a#0A..1RESULTIS.a#0A}#0A*/#0A//.Read.in.a
n.OCODE.label#2E#0AAND.rdl().#3D.VALOF#0A{.LET.l.#3D
.rdn()#0A..1IF.maxlab<l.DO.{.maxlab.:#3D.l;.checkla
b().}#0A..1RESULTIS.l#0A}#0A#0A//.Read.in.a.global.
number#2E#0AAND.rdgn().#3D.VALOF#0A{.LET.g.#3D.rdn(
)#0A..1IF.maxgn<g.DO.maxgn.:#3D.g#0A..1RESULTIS.g#0A
}#0A#0A1//.Generate.next.label.number#2E#0AAND.newl
ab().#3D.VALOF#0A{.labnumber.:#3D.labnumber-1#0A..1
checklab()#0A..1RESULTIS.labnumber#0A}#0A#0A1AND.ch
ecklab().BE.IF.maxlab>#3Dlabnumber.DO#0A{.cgerror("
Too.many.labels.-.increase.workspace")#0A..1errcoun
t.:#3D.errcount+1#0A..1longjump(fin_p,.fin_l)#0A}#0A
#0A1AND.cgerror(mes,.a).BE#0A{.writes("*nError:.")#0A
..1writef(mes,.a)#0A..1newline()#0A..1errcount.:#3D
.errcount+1#0A..1IF.errcount>errmax.DO.{.writes("To
o.many.errors*n")#0A..26longjump(fin_p,.fin_l)#0A..
23}#0A}#0A#0A1//.Initialize.the.simulated.stack.(SS
)#2E#0ALET.initstack(n).BE#0A{.arg2,.arg1,.ssp.:#3D
.tempv,.tempv+3,.n#0A..1pendingop.:#3D.s_none#0A..1
h1!arg2,.h2!arg2,.h3!arg2.:#3D.k_loc,.ssp-2,.ssp-2#0A
..1h1!arg1,.h2!arg1,.h3!arg1.:#3D.k_loc,.ssp-1,.ssp
-1#0A..1IF.maxssp<ssp.DO.maxssp.:#3D.ssp#0A}#0A#0A1
//.Move.simulated.stack.(SS).pointer.to.N#2E#0AAND.
stack(n).BE#0A{.IF.maxssp<n.DO.maxssp.:#3D.n#0A..IF
.n>#3Dssp+4.DO.{.store(0,ssp-1)#0A..17initstack(n)#0A
..17RETURN#0A..15}#0A#0A..WHILE.n>ssp.DO.loadt(k_lo
c,.ssp)#0A#0A..UNTIL.n#3Dssp.DO#0A..{.IF.arg2#3Dtem
pv.DO#0A..2{.TEST.n#3Dssp-1#0A..4THEN.{.ssp.:#3D.n#0A
..11h1!arg1,.h2!arg1,.h3!arg1.:#3D.h1!arg2,.h2!arg2
,.ssp-1#0A..11h1!arg2,.h2!arg2,.h3!arg2.:#3D.k_loc,
.ssp-2,.ssp-2#0A..9}#0A..4ELSE.initstack(n)#0A..4RE
TURN#0A..2}#0A#0A..2arg1,.arg2,.ssp.:#3D.arg1-3,.ar
g2-3,.ssp-1#0A..}#0A}#0A#0A2//.Store.all.SS.items.f
rom.S1.to.S2.in.their.true#0A//.locations.on.the.st
ack#2E#0A//.It.may.corrupt.both.registers.A.and.B#2E
#0AAND.store(s1,.s2).BE.FOR.p.#3D.tempv.TO.arg1.BY.
3.DO#0A..19{.LET.s.#3D.h3!p#0A..21IF.s>s2.RETURN#0A
..21IF.s>#3Ds1.DO.storet(p)#0A..19}#0A#0A1AND.scan(
).BE#0A{.IF.debug>1.DO.{.writef("OP#3D%t5.PND#3D%t5
.",.opname(op),.opname(pendingop))#0A..16dboutput()
#0A..14}#0A#0A..SWITCHON.op.INTO#0A#0A..{.DEFAULT:.
.3cgerror("Bad.OCODE.op.%n.%s",.op,.opname(op))#0A.
.15ENDCASE#0A#0A..2CASE.s_fnum:#0A..13{.LET.mantiss
a.#3D.rdn()#0A..15LET.exponent.#3D.rdn()#0A..15cgpe
ndingop()#0A..15loadt(k_numb,.mantissa)#0A..15loada
(arg1)#0A..15genfb(f_fltop,.fl_mk,.exponent)#0A..15
forget_a()#0A..15ENDCASE#0A..13}#0A#0A..2CASE.s_sel
ld:#0A..13{.LET.len.#3D.rdn()#0A..15LET.sh..#3D.rdn
()#0A//writef("selld:.calling.cgpendingop*n")#0A..1
5cgpendingop()#0A//writef("selld:.calling.loada*n")
#0A..15loada(arg1)#0A//writef("selld:.calling.genbb
*n")#0A..15genbb(f_selld,.len,.sh)#0A..15forget_a()
#0A..15ENDCASE#0A..13}#0A#0A..2CASE.s_selst:#0A..13
{.LET.sfop.#3D.rdn()#0A..15LET.len..#3D.rdn()#0A..1
5LET.sh..1#3D.rdn()#0A..15cgpendingop()#0A..15loadb
a(arg2,.arg1)#0A..15genfbb(f_selst,.sfop,.len,.sh)#0A
..15forgetallvars()#0A..15stack(ssp-2)#0A..15ENDCAS
E#0A..13}#0A#0A..2CASE.0:..4RETURN#0A..4#0A..2CASE.
s_needs:#0A..13{.LET.n.#3D.rdn()..//.Ignore.NEEDS.d
irectives#2E#0A..15FOR.i.#3D.1.TO.n.DO.rdn()#0A..15
ENDCASE#0A..13}#0A#0A..2CASE.s_lp:..1loadt(k_loc,..
1rdn());..1ENDCASE#0A..2CASE.s_lg:..1loadt(k_glob,.
.rdgn());..ENDCASE#0A..2CASE.s_ll:..1loadt(k_lab,..
1rdl());..1ENDCASE#0A..2CASE.s_lf:..1loadt(k_fnlab,
.rdl());..1ENDCASE#0A..2CASE.s_ln:..1loadt(k_numb,.
.rdn());..1ENDCASE#0A#0A..2CASE.s_lstr:.cgstring(rd
n());..7ENDCASE#0A#0A..2CASE.s_true:.loadt(k_numb,.
-1);..5ENDCASE#0A..2CASE.s_false:loadt(k_numb,..000
0);..5ENDCASE#0A#0A..2CASE.s_llp:..loadt(k_lvloc,..
rdn());..ENDCASE#0A..2CASE.s_llg:..loadt(k_lvglob,.
rdgn());.ENDCASE#0A..2CASE.s_ll1:..loadt(k_lvlab,..
rdl());..ENDCASE#0A#0A..2CASE.s_sp:..1storein(k_loc
,..rdn());..ENDCASE#0A..2CASE.s_sg:..1storein(k_glo
b,.rdgn());.ENDCASE#0A..2CASE.s_sl:..1storein(k_lab
,..rdl());..ENDCASE#0A#0A..2CASE.s_stind:cgstind();
.ENDCASE#0A#0A..2CASE.s_rv:..1cgrv();.ENDCASE#0A#0A
..2CASE.s_float:.CASE.s_fix:.CASE.s_fneg:.CASE.s_fa
bs:#0A..2CASE.s_not:CASE.s_neg:CASE.s_abs:#0A..2CAS
E.s_fmul:.CASE.s_fdiv:#0A..2CASE.s_fadd:CASE.s_fsub
:#0A..2CASE.s_feq:.CASE.s_fne:#0A..2CASE.s_fls:CASE
.s_fgr:CASE.s_fle:CASE.s_fge:#0A#0A..2CASE.s_mul:CA
SE.s_div:CASE.s_rem:#0A..2CASE.s_add:CASE.s_sub:#0A
..2CASE.s_eq:.CASE.s_ne:#0A..2CASE.s_ls:CASE.s_gr:C
ASE.s_le:CASE.s_ge:#0A..2CASE.s_lshift:CASE.s_rshif
t:#0A..2CASE.s_logand:CASE.s_logor:CASE.s_eqv:CASE.
s_neqv:#0A..15cgpendingop()#0A..15pendingop.:#3D.op
#0A..15ENDCASE#0A#0A..2CASE.s_jt:..1cgjump(TRUE,.rd
l());..ENDCASE#0A#0A..2CASE.s_jf:..1cgjump(FALSE,.r
dl());.ENDCASE#0A#0A..2CASE.s_goto:.cgpendingop()#0A
..15store(0,.ssp-2)#0A..15TEST.h1!arg1#3Dk_fnlab#0A
..15THEN.genr(f_j,.h2!arg1)#0A..15ELSE.{.loada(arg1
);.gen(f_goto).}#0A..15stack(ssp-1)#0A..15incode.:#3D
.FALSE#0A..15//.This.is.a.good.place.to.deal.with#0A
..15//.some.outstanding.forward.refs#2E#0A..15chkre
fs(50)#0A..15ENDCASE#0A#0A..2CASE.s_lab:..cgpending
op()#0A..15UNLESS.incode.DO.chkrefs(30)#0A..15store
(0,.ssp-1)#0A..15setlab(rdl())#0A..15forgetall()#0A
..15incode.:#3D.procdepth>0#0A..15ENDCASE#0A#0A..2C
ASE.s_query:loadt(k_loc,.ssp);..12ENDCASE#0A#0A..2C
ASE.s_stack:cgpendingop();.stack(rdn());..2ENDCASE#0A
#0A..2CASE.s_store:cgpendingop();.store(0,.ssp-1);.
ENDCASE#0A#0A..2CASE.s_entry:#0A..13{.LET.l.#3D.rdl
()#0A..15LET.n.#3D.rdn()#0A..15cgentry(l,.n)#0A..15
procdepth.:#3D.procdepth.+.1#0A..15ENDCASE#0A..13}#0A
#0A..2CASE.s_save:#0A..13{.LET.n.#3D.rdn()#0A..15in
itstack(n)#0A..15IF.n>3.DO.addinfo_a(k_loc,.3)#0A..
15ENDCASE#0A..13}#0A#0A..2CASE.s_fnap:#0A..2CASE.s_
rtap:.cgapply(op,.rdn());.ENDCASE#0A#0A..2CASE.s_rt
rn:.cgpendingop()#0A..15gen(f_rtn)#0A..15incode.:#3D
.FALSE#0A..15ENDCASE#0A..17#0A..2CASE.s_fnrn:.cgpen
dingop()#0A..15loada(arg1)#0A..15gen(f_rtn)#0A..15s
tack(ssp-1)#0A..15incode.:#3D.FALSE#0A..15ENDCASE#0A
#0A..2CASE.s_endproc:#0A..15cgstatics()#0A..15procd
epth.:#3D.procdepth.-.1#0A..15ENDCASE#0A#0A..2CASE.
s_res:#0A..2CASE.s_jump:#0A..13{.LET.l.#3D.rdl()#0A
#0A..15cgpendingop()#0A..15store(0,.ssp-2)#0A..15TE
ST.op#3Ds_jump#0A..15THEN.storet(arg1)#0A..15ELSE.{
.loada(arg1);.stack(ssp-1).}#0A#0A..15{.op.:#3D.rdn
()#0A..17UNLESS.op#3Ds_stack.BREAK#0A..17stack(rdn(
))#0A..15}.REPEAT#0A#0A..15TEST.op#3Ds_lab#0A..15TH
EN.{.LET.m.#3D.rdl()#0A..22UNLESS.l#3Dm.DO.genr(f_j
,.l)#0A..22setlab(m)#0A..22forgetall()#0A..22incode
.:#3D.procdepth>0#0A..22op.:#3D.rdn()#0A..20}#0A..1
5ELSE.{.genr(f_j,.l)#0A..22incode.:#3D.FALSE#0A..22
//.Deal.with.some.refs#2E#0A..22chkrefs(50)#0A..20}
#0A#0A..15LOOP#0A..13}#0A#0A..2//.rstack.always.occ
urs.immediately.after.a.lab.statement#0A..2//.at.a.
time.when.cgpendingop().and.store(0,.ssp-2).have#0A
..2//.been.called#2E#0A..2CASE.s_rstack:#0A..15stac
k(rdn());.loadt(k_a,.0);.ENDCASE#0A#0A..2CASE.s_fin
ish:..//.Compile.code.for:..stop(0)#2E#0A..13{.LET.
k.#3D.ssp#0A..15stack(ssp+3)#0A..15loadt(k_numb,.0)
#0A..15loadt(k_numb,.0)#0A..15loadt(k_glob,.gn_stop
)#0A..15cgapply(s_rtap,.k)..2//.Simulate.the.call:.
stop(0,.0)#0A..15ENDCASE#0A..13}#0A#0A..2CASE.s_swi
tchon:#0A..15cgswitch();.ENDCASE#0A#0A..2CASE.s_get
byte:#0A..15cgpendingop()#0A..15loadba(arg2,.arg1)#0A
..15gen(f_gbyt)#0A..15forget_a()#0A..15lose1(k_a,.0
)#0A..15ENDCASE#0A#0A1..2CASE.s_putbyte:#0A..15cgpe
ndingop()#0A#0A..15//.First.move.arg3.to.C#2E#0A..1
5{.LET.arg3.#3D.arg2.-.3#0A..17TEST.arg3-tempv.<.0.
#0A..17THEN.{.loadt(k_loc,.ssp-3)#0A..24loada(arg1)
#0A..24gen(f_atc)#0A..24stack(ssp-1)#0A..22}#0A..17
ELSE.{.TEST.inreg_b(h1!arg3,.h2!arg3)#0A..24THEN..2
gen(f_btc)#0A..24ELSE.{.loada(arg3)#0A..31gen(f_atc
)#0A..29}#0A..24h1!arg3.:#3D.k_c#0A..22}#0A..17TEST
.loadboth(arg2,.arg1)#3Dswapped#0A..17THEN.gen(f_xp
byt)#0A..17ELSE.gen(f_pbyt)#0A..17forgetallvars()#0A
..17stack(ssp-3)#0A..17ENDCASE#0A..15}#0A#0A..2CASE
.s_global:.cgglobal(rdn());.RETURN#0A#0A..2CASE.s_d
atalab:#0A..15{.LET.lab.#3D.rdl().#0A..17op.:#3D.rd
n()#0A#0A..17WHILE.op#3Ds_itemn.DO#0A..17{.!nliste.
:#3D.getblk(0,lab,rdn())#0A..20nliste,.lab,.op.:#3D
.!nliste,.0,.rdn()#0A..17}#0A..17LOOP#0A..15}#0A..}
#0A#0A..op.:#3D.rdn()#0A}.REPEAT#0A#0A1//.Compiles.
code.to.deal.with.any.pending.op#2E#0ALET.cgpending
op().BE#0A{.LET.f,.flop.#3D.0,.0#0A..1LET.sym.#3D.T
RUE#0A..1LET.pndop.#3D.pendingop#0A..1pendingop.:#3D
.s_none#0A#0A..1SWITCHON.pndop.INTO#0A..1{.DEFAULT:
..4cgerror("Bad.pendingop.%s",.opname(pndop))#0A#0A
..4CASE.s_none:..RETURN#0A#0A..4CASE.s_float:.loada
(arg1)#0A..18genflt(fl_float)#0A..18forget_a()#0A..
18RETURN#0A#0A..4CASE.s_fix:..1loada(arg1)#0A..18ge
nflt(fl_fix)#0A..18forget_a()#0A..18RETURN#0A#0A..4
CASE.s_fabs:..loada(arg1)#0A..18genflt(fl_abs)#0A..
18forget_a()#0A..18RETURN#0A#0A..4CASE.s_abs:..1loa
da(arg1)#0A..18chkrefs(3)#0A..18genb(jfn0(f_jgr),.2
).//.Conditionally.skip#0A..18gen(f_neg)..9//.over.
this.NEG.instruction#2E#0A..18forget_a()#0A..18RETU
RN#0A#0A..4CASE.s_fneg:..loada(arg1)#0A..18genflt(f
l_neg)#0A..18forget_a()#0A..18RETURN#0A#0A..4CASE.s
_neg:..1loada(arg1)#0A..18gen(f_neg)#0A..18forget_a
()#0A..18RETURN#0A#0A..4CASE.s_not:..1loada(arg1)#0A
..18gen(f_not)#0A..18forget_a()#0A..18RETURN#0A#0A.
.4CASE.s_feq:..1flop.:#3D.fl_eq;.GOTO.case_feq#0A..
4CASE.s_fne:..1flop.:#3D.fl_ne;.GOTO.case_feq#0A..4
CASE.s_fls:..1flop.:#3D.fl_ls;.GOTO.case_feq#0A..4C
ASE.s_fgr:..1flop.:#3D.fl_gr;.GOTO.case_feq#0A..4CA
SE.s_fle:..1flop.:#3D.fl_le;.GOTO.case_feq#0A..4CAS
E.s_fge:..1flop.:#3D.fl_ge;.GOTO.case_feq#0Acase_fe
q:..9loadba(arg2,.arg1)#0A..18genflt(flop)#0A..18lo
se1(k_a,.0)#0A..18forget_a()#0A..18forget_b()#0A..1
8RETURN#0A#0A..4CASE.s_eq:.CASE.s_ne:#0A..4CASE.s_l
s:.CASE.s_gr:#0A..4CASE.s_le:.CASE.s_ge:#0A..18f.:#3D
.prepj(jmpfn(pndop))#0A..18chkrefs(4)#0A..18genb(f,
.2)..2//.Jump.to..2--1#0A..18gen(f_fhop)..1//..13|#0A
..18gen(f_lm1)..2//.this.point..<-#0A..18lose1(k_a,
.0)#0A..18forget_a()#0A..18forget_b()#0A..18RETURN#0A
#0A..4CASE.s_sub:.UNLESS.k_numb#3Dh1!arg1.DO#0A..18
{.f,.sym.:#3D.f_sub,.FALSE#0A..21ENDCASE#0A..18}#0A
..18h2!arg1.:#3D.-h2!arg1#0A#0A..4CASE.s_add:..1cga
dd();.RETURN#0A#0A..4CASE.s_fmul:..f.:#3D.fl_mul;..
GOTO.case_fmul#0A..4CASE.s_fadd:..f.:#3D.fl_add;..G
OTO.case_fmul#0A#0Acase_fmul:..8loadboth(arg2,.arg1
)#0A..18genflt(f)#0A..18forget_a()#0A..18lose1(k_a,
.0)#0A..18RETURN#0A#0A..4CASE.s_fdiv:..f.:#3D.fl_di
v;..1GOTO.case_fdiv#0A..4CASE.s_fsub:..f.:#3D.fl_su
b;.GOTO.case_fdiv#0A#0Acase_fdiv:..8loadba(arg2,.ar
g1)#0A..18genflt(f)#0A..18forget_a()#0A..18lose1(k_
a,.0)#0A..18RETURN#0A#0A..4CASE.s_mul:..1f..4:#3D.f
_mul;..6ENDCASE#0A..4CASE.s_div:..1f,.sym.:#3D.f_di
v,.FALSE;.ENDCASE#0A..4CASE.s_rem:..1f,.sym.:#3D.f_
rem,.FALSE;.ENDCASE#0A..4CASE.s_lshift:f,.sym.:#3D.
f_lsh,.FALSE;.ENDCASE#0A..4CASE.s_rshift:f,.sym.:#3D
.f_rsh,.FALSE;.ENDCASE#0A..4CASE.s_logand:f..4:#3D.
f_and;..6ENDCASE#0A..4CASE.s_logor:.f..4:#3D.f_or;.
.7ENDCASE#0A..4CASE.s_eqv:#0A..4CASE.s_neqv:..f..4:
#3D.f_xor;..6ENDCASE#0A..1}#0A#0A..1TEST.sym.THEN.l
oadboth(arg2,.arg1)#0A..10ELSE.loadba(arg2,.arg1)#0A
#0A..1gen(f)#0A..1forget_a()#0A..1IF.pndop#3Ds_eqv.
THEN.gen(f_not)#0A#0A..1lose1(k_a,.0)#0A}#0A#0ALET.
loada(x)..1BE.{.loadval(x,.FALSE);.setba(0,.x).}#0A
#0AAND.push(x,.y).BE.{.loadval(y,.TRUE);..setba(x,.
y).}#0A#0AAND.loadval(x,.pushing).BE..//.ONLY.calle
d.from.loada.and.push#2E#0A//.Load.compiles.code.to
.have.the.following.effect:#0A//.If.pushing#3DTRUE.
.2B.:#3D.A;.A.:#3D.<x>#2E#0A//.If.pushing#3DFALSE..
1B.:#3D.?;.A.:#3D.<x>#2E#0A{.LET.k,.n.#3D.h1!x,.h2!
x#0A#0A..UNLESS.pushing.|.k#3Dk_a.DO..//.Dump.A.reg
ister.if.necessary#2E#0A..2FOR.t.#3D.arg1.TO.tempv.
BY.-3.IF.h1!t#3Dk_a.DO.{.storet(t);.BREAK.}#0A#0A..
TEST.inreg_a(k,.n).THEN.setba(0,.x)#0A..19ELSE.IF.i
nreg_b(k,.n).DO.{.genxch(0,.0)#0A..46RETURN#0A..44}
#0A..SWITCHON.h1!x.INTO#0A..{.DEFAULT:..cgerror("in
.loada.%n",.k)#0A#0A..2CASE.k_a:.IF.pushing.UNLESS.
inreg_b(k,.n).DO.genatb(0,.0)#0A..12RETURN#0A#0A..2
CASE.k_numb:#0A..4TEST.-1<#3Dn<#3D10#0A..4THEN.gen(
f_l0+n)#0A..4ELSE.TEST.0<#3Dn<#3D255#0A..9THEN.genb
(f_l,.n)#0A..9ELSE.TEST.-255<#3Dn<#3D0#0A..14THEN.g
enb(f_lm,.-n)#0A..14ELSE.TEST.0<#3Dn<#3D#23xFF2#0A.
.19THEN.genh(f_lh,.n)#0A..19ELSE.TEST.-#23xFF2<#3Dn
<#3D0#0A..24THEN.genh(f_lmh,.-n)#0A..24ELSE.genw(f_
lw,.n)#0A..4ENDCASE#0A#0A..2CASE.k_loc:..genlp(n);.
.6ENDCASE#0A..2CASE.k_glob:.geng(f_lg,.n);..1ENDCAS
E#0A..2CASE.k_lab:..genr(f_ll,.n);..1ENDCASE#0A..2C
ASE.k_fnlab:genr(f_lf,.n);..1ENDCASE#0A#0A..2CASE.k
_lvloc:TEST.0<#3Dn<#3D255#0A..15THEN.genb(f_llp,.n)
#0A..15ELSE.TEST.0<#3Dn<#3D#23xFF2#0A..20THEN.genh(
f_llph,.n)#0A..20ELSE.genw(f_llpw,.n)#0A..15ENDCASE
#0A#0A..2CASE.k_lvglob:geng(f_llg,.n);.ENDCASE#0A..
2CASE.k_lvlab:.genr(f_ll1,.n);.ENDCASE#0A..2CASE.k_
loc0:..gen(f_l0p0+n);..ENDCASE#0A..2CASE.k_loc1:..g
en(f_l1p0+n);..ENDCASE#0A..2CASE.k_loc2:..gen(f_l2p
0+n);..ENDCASE#0A..2CASE.k_loc3:..gen(f_l3p0+n);..E
NDCASE#0A..2CASE.k_loc4:..gen(f_l4p0+n);..ENDCASE#0A
..2CASE.k_glob0:.geng(f_l0g,.n);.ENDCASE#0A..2CASE.
k_glob1:.geng(f_l1g,.n);.ENDCASE#0A..2CASE.k_glob2:
.geng(f_l2g,.n);.ENDCASE#0A..}#0A#0A..//.A.loading.
instruction.has.just.been.compiled#2E#0A..pushinfo(
h1!x,.h2!x)#0A}#0A#0AAND.loadba(x,.y).BE.IF.loadbot
h(x,.y)#3Dswapped.DO.genxch(x,.y)#0A#0AAND.setba(x,
.y).BE#0A{.UNLESS.x#3D0.DO.h1!x.:#3D.k_b#0A..UNLESS
.y#3D0.DO.h1!y.:#3D.k_a#0A}#0A#0AAND.genxch(x,.y).B
E.{.gen(f_xch);.xchinfo();.setba(x,.y).}#0A#0AAND.g
enatb(x,.y).BE.{.gen(f_atb);.atbinfo();.setba(x,.y)
.}#0A#0AAND.loadboth(x,.y).#3D.VALOF#0A//.Compiles.
code.to.cause#0A//..1either..2x.->.[B]..and..y.->.[
A]#0A//..11giving.result.NOTSWAPPED#0A//..1or..6x.-
>.[A]..and..y.->.[B]#0A//..11giving.result.SWAPPED#2E
#0A//.LOADBOTH.only.swaps.if.this.saves.code#2E#0A{
.//.First.ensure.that.no.other.stack.item.uses.reg.
A#2E#0A..1FOR.t.#3D.tempv.TO.arg1.BY.3.DO#0A..5IF.h
1!t#3Dk_a.UNLESS.t#3Dx.|.t#3Dy.DO.storet(t)#0A#0A..
1{.LET.xa,.ya.#3D.inreg_a(h1!x,.h2!x),.inreg_a(h1!y
,.h2!y)#0A..4AND.xb,.yb.#3D.inreg_b(h1!x,.h2!x),.in
reg_b(h1!y,.h2!y)#0A#0A..4IF.xb.&.ya.DO.{.setba(x,y
);..13RESULTIS.notswapped.}#0A..4IF.xa.&.yb.DO.{.se
tba(y,x);..13RESULTIS.swapped..2}#0A..4IF.xa.&.ya.D
O.{.genatb(x,y);..12RESULTIS.notswapped.}#0A..4IF.x
b.&.yb.DO.{.genxch(0,y);.genatb(x,y);.RESULTIS.nots
wapped.}#0A..4#0A..4IF.xa.DO.{..12push(x,y);.RESULT
IS.notswapped.}#0A..4IF.ya.DO.{..12push(y,x);.RESUL
TIS.swapped..2}#0A..4IF.xb.DO.{.genxch(0,x);.push(x
,y);.RESULTIS.notswapped.}#0A..4IF.yb.DO.{.genxch(0
,y);.push(y,x);.RESULTIS.swapped..2}#0A..4#0A..4loa
da(x)#0A..4push(x,.y)#0A..4RESULTIS.notswapped#0A..
1}#0A}#0A#0ALET.inreg_a(k,.n).#3D.VALOF#0A{.LET.p.#3D
.info_a#0A..1IF.k#3Dk_a.RESULTIS.TRUE#0A..1UNTIL.p#3D
0.DO.{.IF.k#3Dh2!p.&.n#3Dh3!p.RESULTIS.TRUE#0A..17p
.:#3D.!p#0A..14}#0A..1RESULTIS.FALSE#0A}#0A#0AAND.i
nreg_b(k,.n).#3D.VALOF#0A{.LET.p.#3D.info_b#0A..1IF
.k#3Dk_b.RESULTIS.TRUE#0A..1UNTIL.p#3D0.DO.{.IF.k#3D
h2!p.&.n#3Dh3!p.RESULTIS.TRUE#0A..17p.:#3D.!p#0A..1
4}#0A..1RESULTIS.FALSE#0A}#0A#0AAND.addinfo_a(k,.n)
.BE.info_a.:#3D.getblk(info_a,.k,.n)#0A#0AAND.addin
fo_b(k,.n).BE.info_b.:#3D.getblk(info_b,.k,.n)#0A#0A
AND.pushinfo(k,.n).BE#0A{.forget_b()#0A..1info_b.:#3D
.info_a#0A..1info_a.:#3D.getblk(0,.k,.n)#0A}#0A#0AA
ND.xchinfo().BE#0A{.LET.t.#3D.info_a#0A..1info_a.:#3D
.info_b#0A..1info_b.:#3D.t#0A}#0A#0AAND.atbinfo().B
E#0A{.LET.p.#3D.info_a#0A..1forget_b()#0A..1UNTIL.p
#3D0.DO.{.addinfo_b(h2!p,.h3!p);.p.:#3D.!p.}#0A}#0A
#0AAND.forget_a().BE.{.freeblks(info_a);.info_a.:#3D
.0.}#0A#0AAND.forget_b().BE.{.freeblks(info_b);.inf
o_b.:#3D.0.}#0A#0AAND.forgetall().BE.{.forget_a();.
forget_b().}#0A#0A//.Forgetvar.is.called.just.after
.a.simple.variable.(k,.n).has.been#0A//.updated#2E.
.k.is.k_loc,.k_glob.or.k_lab#2E..Note.that.register
#0A//.infomation.about.indirect.local.and.global.va
lues#0A//.must.also.be.thrown.away#2E#0AAND.forgetv
ar(k,.n).BE#0A{.LET.p.#3D.info_a#0A..1UNTIL.p#3D0.D
O.{.IF.h2!p>#3Dk_loc0.|.h2!p#3Dk.&.h3!p#3Dn.DO.h2!p
.:#3D.k_none#0A..17p.:#3D.!p#0A..14}#0A..1p.:#3D.in
fo_b#0A..1UNTIL.p#3D0.DO.{.IF.h2!p>#3Dk_loc0.|.h2!p
#3Dk.&.h3!p#3Dn.DO.h2!p.:#3D.k_none#0A..17p.:#3D.!p
#0A..14}#0A}#0A#0AAND.forgetallvars().BE..//.Called
.after.STIND,.SELST.or.PUTBYTE#2E#0A{.LET.p.#3D.inf
o_a#0A..1UNTIL.p#3D0.DO.{.IF.h2!p>#3Dk_loc.DO.h2!p.
:#3D.k_none#0A..17p.:#3D.!p#0A..14}#0A..1p.:#3D.inf
o_b#0A..1UNTIL.p#3D0.DO.{.IF.h2!p>#3Dk_loc.DO.h2!p.
:#3D.k_none#0A..17p.:#3D.!p#0A..14}#0A}#0A#0AAND.is
zero(a).#3D.h1!a#3Dk_numb.&.h2!a#3D0.->.TRUE,.FALSE
#0A#0A//.Store.the.value.of.a.SS.item.in.its.true.s
tack.location#2E#0AAND.storet(x).BE#0A{.LET.s.#3D.h
3!x#0A..1IF.h1!x#3Dk_loc.&.h2!x#3Ds.RETURN#0A..1loa
da(x)#0A..1gensp(s)#0A..1forgetvar(k_loc,.s)#0A..1a
ddinfo_a(k_loc,.s)#0A..1h1!x,.h2!x.:#3D.k_loc,.s#0A
}#0A#0AAND.gensp(s).BE.TEST.3<#3Ds<#3D16#0A..14THEN
.gen(f_sp0+s)#0A..14ELSE.TEST.0<#3Ds<#3D255#0A..19T
HEN.genb(f_sp,.s)#0A..19ELSE.TEST.0<#3Ds<#3D#23xFF2
#0A..24THEN.genh(f_sph,.s)#0A..24ELSE.genw(f_spw,.s
)#0A#0AAND.genlp(n).BE.TEST.3<#3Dn<#3D16#0A..14THEN
.gen(f_lp0+n)#0A..14ELSE.TEST.0<#3Dn<#3D255#0A..19T
HEN.genb(f_lp,.n)#0A..19ELSE.TEST.0<#3Dn<#3D#23xFF2
#0A..24THEN.genh(f_lph,.n)#0A..24ELSE.genw(f_lpw,.n
)#0A#0A//.Load.an.item.(K,N).onto.the.SS#2E.It.may.
move.SS.items#2E#0AAND.loadt(k,.n).BE#0A{.cgpending
op()#0A..TEST.arg1+3#3Dtempt#0A..THEN.{.storet(temp
v)..//.SS.stack.overflow#2E#0A..7FOR.t.#3D.tempv.TO
.arg2+2.DO.t!0.:#3D.t!3#0A..5}#0A..ELSE.arg2,.arg1.
:#3D.arg2+3,.arg1+3#0A..h1!arg1,h2!arg1,h3!arg1.:#3D
.k,n,ssp#0A..ssp.:#3D.ssp.+.1#0A..IF.maxssp<ssp.DO.
maxssp.:#3D.ssp#0A}#0A#0A1//.Replace.the.top.two.SS
.items.by.(K,N).and.set.PENDINGOP#3DS_NONE#2E#0AAND
.lose1(k,.n).BE#0A{.ssp.:#3D.ssp.-.1#0A..TEST.arg2#3D
tempv#0A..THEN.{.h1!arg2,h2!arg2.:#3D.k_loc,ssp-2#0A
..7h3!arg2.:#3D.ssp-2#0A..5}#0A..ELSE.{.arg1.:#3D.a
rg2#0A..7arg2.:#3D.arg2-3#0A..5}#0A..h1!arg1,.h2!ar
g1,.h3!arg1.:#3D.k,n,ssp-1#0A..pendingop.:#3D.s_non
e#0A}#0A#0AAND.swapargs().BE#0A{.LET.k,.n.#3D.h1!ar
g1,.h2!arg1#0A..1h1!arg1,.h2!arg1.:#3D.h1!arg2,.h2!
arg2#0A..1h1!arg2,.h2!arg2.:#3D.k,.n#0A}#0A#0AAND.c
gstind().BE#0A{.LET.t.#3D.VALOF#0A..{.IF.pendingop#3D
s_add.DO#0A..2{.IF.k_numb#3Dh1!arg2.DO.swapargs()#0A
..4IF.k_numb#3Dh1!arg1.DO#0A..4{.LET.n.#3D.h2!arg1#0A
..6IF.0<#3Dn<#3D3.DO.{.stack(ssp-1)#0A..22pendingop
.:#3D.s_none#0A..22RESULTIS.n#0A..20}#0A..4}#0A#0A.
.4IF.h1!arg2#3Dk_loc.&.3<#3Dh2!arg2<#3D5.DO.swaparg
s()#0A..4IF.h1!arg1#3Dk_loc.&.3<#3Dh2!arg1<#3D5.DO#0A
..4{.LET.n.#3D.h2!arg1#0A..6stack(ssp-1)#0A..6pendi
ngop.:#3D.s_none#0A..6RESULTIS.n+1..//.The.codes.fo
r.P3,.P4.and.P5#2E#0A..4}#0A#0A..4UNLESS.arg2#3Dtem
pv.DO#0A..4{.LET.arg3.#3D.arg2.-.3#0A..6IF.h1!arg3#3D
k_a.DO#0A..6{.IF.h1!arg2#3Dk_loc.|#0A..10h1!arg2#3D
k_glob.|#0A..10h1!arg2#3Dk_numb.DO.swapargs()#0A..8
IF.h1!arg1#3Dk_loc.|#0A..11h1!arg1#3Dk_glob.|#0A..1
1h1!arg1#3Dk_numb.DO#0A..8//.Optimize.the.case..<ar
g2>!<arg1>.:#3D.<arg3>#0A..8//.where.<arg3>.is.alre
ady.in.A#0A..8//.and.<arg1>.is.a.local,.a.global.or
.a.number#2E#0A..8{.push(arg3,.arg2)#0A..10cgadd().
.//.Compiles.an.A,.AP.or.AG.instr#2E#0A..10gen(f_st
)#0A..10stack(ssp-2)#0A..10forgetallvars()#0A..10RE
TURN#0A..8}#0A..6}#0A..4}#0A..2}#0A#0A..2cgpendingo
p()#0A..2RESULTIS.0#0A..}#0A#0A..//.Now.compile.cod
e.for.S!<arg1>.:#3D.<arg2>#0A..//.where..9S.is.0,.1
,.2,.3,.P3,.P4.or.P5#0A..//.depending.on..2T.#3D..0
000,.1,.2,.3,..0004,..0005.or..0006#0A#0A..{.LET.k,
.n.#3D.h1!arg1,.h2!arg1#0A..1#0A..2IF.k#3Dk_glob.&.
t#3D0.DO.{.loada(arg2)#0A..25geng(f_s0g,.n)#0A..25s
tack(ssp-2)#0A..25forgetallvars()#0A..25RETURN#0A..
23}#0A#0A..2IF.k#3Dk_loc.&.3<#3Dn<#3D4.&.t<#3D1.DO.
{.loada(arg2)#0A..35gen(t#3D0.->.f_st0p0+n,#0A..46f
_st1p0+n)#0A..35stack(ssp-2)#0A..35forgetallvars()#0A
..35RETURN#0A..33}#0A#0A..2loadba(arg2,.arg1)#0A..2
gen(f_st+t)#0A..2stack(ssp-2)#0A..2forgetallvars()#0A
..}#0A}#0A#0A1//.Store.the.top.item.of.the.SS.in.(K
,N)#2E#0AAND.storein(k,.n).BE#0A//.K.is.K_LOC,.K_GL
OB.or.K_LAB#2E#0A{.cgpendingop()#0A..1loada(arg1)#0A
#0A..1SWITCHON.k.INTO#0A..1{.DEFAULT:..3cgerror("in
.storein.%n",.k)#0A..4CASE.k_loc:..gensp(n);..5ENDC
ASE#0A..4CASE.k_glob:.geng(f_sg,.n);..ENDCASE#0A..4
CASE.k_lab:..genr(f_sl,.n);..ENDCASE#0A..1}#0A..1fo
rgetvar(k,.n)#0A..1addinfo_a(k,.n)#0A..1stack(ssp-1
)#0A}#0A#0ALET.cgrv().BE#0A{.LET.t.#3D.VALOF#0A..1{
.IF.pendingop#3Ds_add.DO#0A..4{.IF.k_numb#3Dh1!arg2
.DO.swapargs()#0A..7IF.k_numb#3Dh1!arg1.DO#0A..7{.L
ET.n.#3D.h2!arg1#0A..10IF.0<#3Dn<#3D6.DO.{.stack(ss
p-1)#0A..27pendingop.:#3D.s_none#0A..27RESULTIS.n#0A
..24}#0A..7}#0A#0A..7IF.h1!arg2#3Dk_loc.&.3<#3Dh2!a
rg2<#3D7.DO.swapargs()#0A..7IF.h1!arg1#3Dk_loc.&.3<
#3Dh2!arg1<#3D7.DO.{.LET.n.#3D.h2!arg1#0A..46stack(
ssp-1)#0A..46pendingop.:#3D.s_none#0A..46RESULTIS.1
0.+.n#0A..43}#0A..4}#0A..4cgpendingop()#0A..4RESULT
IS.0#0A..1}#0A#0A..1//.Now.compile.code.for.S!<arg1
>#0A..1//.where..8S.is.0,#2E#2E1,.6,.P3,#2E#2E1,.P7
#0A..1//.depending.on..1T.#3D..0000,#2E#2E1,.6,.13,
#2E#2E1,.17#0A#0A..1LET.k,.n.#3D.h1!arg1,.h2!arg1#0A
..1#0A..1IF.k#3Dk_glob.&.0<#3Dt<#3D2.DO.{.h1!arg1.:
#3D.k_glob0.+.t;.RETURN.}#0A#0A..1IF.k#3Dk_loc.&.n>
#3D3.DO#0A..4IF.t#3D0.&.n<#3D12.|#0A..7t#3D1.&.n<#3D
6..|#0A..7t#3D2.&.n<#3D5..|#0A..7t#3D3.&.n<#3D4..|#0A
..7t#3D4.&.n<#3D4..DO.{.h1!arg1.:#3D.k_loc0.+.t;.RE
TURN.}#0A#0A..1loada(arg1)#0A..1TEST.t<#3D6.THEN.ge
n(f_rv+t)#0A..11ELSE.gen(f_rvp0.+.t.-.10)#0A..1forg
et_a()#0A..1h1!arg1,.h2!arg1.:#3D.k_a,.0#0A}#0A#0AA
ND.cgadd().BE#0A//.Compiles.code.to.compute.<arg2>.
+.<arg1>#2E#0A//.It.does.not.look.at.PENDINGOP#2E#0A
#0A{.IF.iszero(arg1).DO.{.stack(ssp-1);.RETURN.}#0A
#0A..1IF.iszero(arg2).DO#0A..1{.IF.h2!arg1#3Dssp-1.
&#0A..7(h1!arg1#3Dk_loc.|.k_loc0<#3Dh1!arg1<#3Dk_lo
c4).DO.loada(arg1)#0A..4lose1(h1!arg1,.h2!arg1)#0A.
.4RETURN#0A..1}#0A#0A..1TEST.inreg_a(h1!arg1,.h2!ar
g1)#0A..1THEN.loada(arg1)#0A..1ELSE.IF.inreg_a(h1!a
rg2,.h2!arg2).DO.loada(arg2)#0A#0A..1IF.h1!arg1#3Dk
_a.DO.swapargs()#0A#0A..1IF.h1!arg2#3Dk_loc.&.3<#3D
h2!arg2<#3D12.DO.swapargs()#0A..1IF.h1!arg1#3Dk_loc
.&.3<#3Dh2!arg1<#3D12.DO.{.loada(arg2)#0A..41gen(f_
ap0.+.h2!arg1)#0A..41forget_a()#0A..41lose1(k_a,.0)
#0A..41RETURN#0A..38}#0A#0A..1IF.h1!arg2#3Dk_numb.&
.-4<#3Dh2!arg2<#3D5.DO.swapargs()#0A..1IF.h1!arg1#3D
k_numb.&.-4<#3Dh2!arg1<#3D5.DO.{.loada(arg2)#0A..42
cgaddk(h2!arg1)#0A..42lose1(k_a,.0)#0A..42RETURN#0A
..39}#0A#0A..1IF.h1!arg2#3Dk_loc.DO.swapargs()#0A..
1IF.h1!arg1#3Dk_loc.DO#0A..1{.LET.n.#3D.h2!arg1#0A.
.4loada(arg2)#0A..4TEST.3<#3Dn<#3D12.THEN.gen(f_ap0
.+.n)#0A..18ELSE.TEST.0<#3Dn<#3D255#0A..23THEN.genb
(f_ap,.n)#0A..23ELSE.TEST.0<#3Dn<#3D#23xFF2#0A..28T
HEN.genh(f_aph,.n)#0A..28ELSE.genw(f_apw,.n)#0A..4f
orget_a()#0A..4lose1(k_a,.0)#0A..4RETURN#0A..1}#0A#0A
..1IF.h1!arg2#3Dk_glob.DO.swapargs()#0A..1IF.h1!arg
1#3Dk_glob.DO.{.loada(arg2)#0A..25geng(f_ag,.h2!arg
1)#0A..25forget_a()#0A..25lose1(k_a,.0)#0A..25RETUR
N#0A..22}#0A#0A..1IF.h1!arg2#3Dk_numb.DO.swapargs()
#0A..1IF.h1!arg1#3Dk_numb.DO.{.LET.n.#3D.h2!arg1#0A
..25loada(arg2)#0A..25cgaddk(n)#0A..25lose1(k_a,.0)
#0A..25RETURN#0A..22}#0A..1loadboth(arg2,.arg1)#0A.
.1gen(f_add)#0A..1forget_a()#0A..1lose1(k_a,.0)#0A}
#0A#0AAND.cgaddk(k).BE.UNLESS.k#3D0.DO..//.Compile.
code.to.add.k.to.A#2E#0A{.TEST.-4<#3Dk<#3D5#0A..1TH
EN.TEST.k<0.THEN.gen(f_s0.-.k)#0A..15ELSE.gen(f_a0.
+.k)#0A..1ELSE.TEST.-255<#3Dk<#3D255#0A..6THEN.TEST
.k>0.THEN.genb(f_a,.k)#0A..20ELSE.genb(f_s,.-k)#0A.
.6ELSE.TEST.0<#3Dk<#3D#23xFF2#0A..11THEN.genh(f_ah,
.k)#0A..11ELSE.TEST.-#23xFF2<#3Dk<#3D0#0A..16THEN.g
enh(f_sh,.-k)#0A..16ELSE.genw(f_aw,.k)#0A..1forget_
a()#0A}#0A#0AAND.cgglobal(n).BE#0A{.incode.:#3D.FAL
SE#0A..1cgstatics()#0A..1chkrefs(512)..1//.Deal.wit
h.ALL.outstanding.refs#2E#0A..1align(4)#0A..1codew(
0)..5//.Compile.Global.initialisation.data#2E#0A..1
FOR.i.#3D.1.TO.n.DO.{.codew(rdgn());.codew(labv!rdl
()).}#0A..1codew(maxgn)#0A}#0A#0A1AND.cgentry(l,.n)
.BE#0A{.MANIFEST.{.upb#3D11.}.//.Max.length.of.entr
y.name#0A..1LET.v.#3D.VEC.upb/bytesperword#0A..1v%0
.:#3D.upb#0A..1//.Pack.up.to.11.character.of.the.na
me.into.v.including#0A..1//.the.first.and.last.five
#2E#0A..1TEST.n<#3D11#0A..1THEN.{.FOR.i.#3D.1.TO.n.
DO.v%i.:#3D.rdn()#0A..8FOR.i.#3D.n+1.TO.11.DO.v%i.:
#3D.'*s'#0A..6}#0A..1ELSE.{.FOR.i.#3D.1.TO.5..1DO.v
%i.:#3D.rdn()#0A..8FOR.i.#3D.6.TO.n-6.DO.rdn().//.I
gnore.the.middle.characters#0A..8FOR.i.#3D.6.TO.11.
.DO.v%i.:#3D.rdn()#0A..8IF.n>11.DO.v%6.:#3D.'*''#0A
..6}#0A#0A..1chkrefs(80)..//.Deal.with.some.forward
.refs#2E#0A..1align(4)#0A..1IF.naming.DO.{.codew(en
tryword)#0A..16codew(pack4b(v%0,.v%1,.v%.2,.v%.3))#0A
..16codew(pack4b(v%4,.v%5,.v%.6,.v%.7))#0A..16codew
(pack4b(v%8,.v%9,.v%10,.v%11))#0A..14}#0A..1IF.debu
g>0.DO.writef("//.Entry.to:..1%s*n",.v)#0A..1setlab
(l)#0A..1incode.:#3D.TRUE#0A..1forgetall()#0A}#0A#0A
//.Function.or.routine.call#2E#0AAND.cgapply(op,.k)
.BE#0A{.LET.sa.#3D.k+3..//.Stack.address.of.first.a
rg.(if.any)#2E#0A..AND.a1.#3D.0..2//.SS.item.for.fi
rst.arg.if.found#2E#0A#0A..cgpendingop()#0A#0A//.De
al.with.non.args#2E#0A..FOR.t.#3D.tempv.TO.arg2.BY.
3.DO.{.IF.h3!t>#3Dk.BREAK#0A..32IF.h1!t#3Dk_a.DO.st
oret(t)#0A..30}#0A#0A//.Deal.with.args.2,.3.#2E#2E1
#0A..FOR.t.#3D.tempv.TO.arg2.BY.3.DO#0A..{.LET.s.#3D
.h3!t#0A..2IF.s#3Dsa.DO#0A..2{.a1.:#3D.t..//.We.hav
e.found.the.SS.item.for.the.first.arg#2E#0A..4IF.h1
!t#3Dk_a.&.t+3#3Darg2.DO#0A..4//.Two.argument.call.
with.the.first.arg.already.in.A#2E#0A..4{.push(t,.a
rg2)#0A..6storet(arg2)..2//.Store.second.arg#2E#0A.
.6genxch(0,.t)..2//.Restore.first.arg.back.to.A#2E#0A
..6BREAK#0A..4}#0A..2}#0A..2IF.s>sa.DO.storet(t)#0A
..}#0A#0A..//.Move.first.arg.(if.any).into.A#2E#0A.
.IF.sa<ssp-1.TEST.a1#3D0#0A..12THEN.genlp(sa)..//.F
irst.arg.exists.but.not.in.SS#2E#0A..12ELSE.loada(a
1)..//.First.arg.exists.in.SS#0A#0A..//.First.arg.(
if.any).is.now.in.A#2E#0A#0A..TEST.h1!arg1#3Dk_glob
.&.3<#3Dk<#3D11#0A..THEN.geng(f_k0g+k,.h2!arg1)#0A.
.ELSE.{.push(a1,.arg1)#0A..7//.First.arg.(if.any).i
s.now.in.B#0A..7//.and.the.procedure.address.is.in.
A#2E#0A..7TEST.3<#3Dk<#3D11#0A..7THEN.gen(f_k0+k)#0A
..7ELSE.TEST.0<#3Dk<#3D255#0A..12THEN.genb(f_k,.k)#0A
..12ELSE.TEST.0<#3Dk<#3D#23xFF2#0A..17THEN.genh(f_k
h,.k)#0A..17ELSE.genw(f_kw,.k)#0A..5}#0A#0A..forget
all()#0A..stack(k)#0A..IF.op#3Ds_fnap.DO.loadt(k_a,
.0)#0A}#0A#0A//.Used.for.OCODE.operators.JT.and.JF#2E
#0AAND.cgjump(b,l).BE#0A{.LET.f.#3D.jmpfn(pendingop
)#0A..1IF.f#3D0.DO.{.loadt(k_numb,0);.f.:#3D.f_jne.
}#0A..1pendingop.:#3D.s_none#0A..1UNLESS.b.DO.f.:#3D
.compjfn(f)#0A..1store(0,ssp-3)#0A..1genr(prepj(f),
l)#0A..1stack(ssp-2)#0A}#0A#0AAND.jmpfn(op).#3D.VAL
OF.SWITCHON.op.INTO#0A{.DEFAULT:..RESULTIS.0#0A..1C
ASE.s_eq:.RESULTIS.f_jeq#0A..1CASE.s_ne:.RESULTIS.f
_jne#0A..1CASE.s_ls:.RESULTIS.f_jls#0A..1CASE.s_gr:
.RESULTIS.f_jgr#0A..1CASE.s_le:.RESULTIS.f_jle#0A..
1CASE.s_ge:.RESULTIS.f_jge#0A}#0A#0AAND.jfn0(f).#3D
.f+2.//.Change.F_JEQ.into.F_JEQ0..etc#2E#2E1#0A#0AA
ND.revjfn(f).#3D.f#3Df_jls.->.f_jgr,#0A..14f#3Df_jg
r.->.f_jls,#0A..14f#3Df_jle.->.f_jge,#0A..14f#3Df_j
ge.->.f_jle,#0A..14f#0A#0AAND.compjfn(f).#3D.f#3Df_
jeq.->.f_jne,#0A..15f#3Df_jne.->.f_jeq,#0A..15f#3Df
_jls.->.f_jge,#0A..15f#3Df_jge.->.f_jls,#0A..15f#3D
f_jgr.->.f_jle,#0A..15f#3Df_jle.->.f_jgr,#0A..15f#0A
#0AAND.prepj(f).#3D.VALOF..//.Returns.the.appropria
te.m/c.fn#2E#0A{.IF.iszero(arg2).DO.{.swapargs();.f
.:#3D.revjfn(f).}#0A..1IF.iszero(arg1).DO.{.loada(a
rg2);.RESULTIS.jfn0(f).}#0A..1IF.loadboth(arg2,.arg
1)#3Dswapped.RESULTIS.revjfn(f)#0A..1RESULTIS.f#0A}
#0A#0A//.Compiles.code.for.SWITCHON#2E#0ALET.cgswit
ch().BE#0A{.LET.n.#3D.rdn()..3//.Number.of.cases#2E
#0A..1LET.dlab.#3D.rdl()..//.Default.label#2E#0A#0A
..1//.Read.and.sort.(K,L).pairs#2E#0A..1FOR.i.#3D.1
.TO.n.DO#0A..1{.LET.k.#3D.rdn()#0A..4LET.l.#3D.rdl(
)#0A..4LET.j.#3D.i-1#0A..4UNTIL.j#3D0.DO..{.IF.k.>.
casek!j.BREAK#0A..21casek!(j+1),.casel!(j+1).:#3D.c
asek!j,.casel!j#0A..21j.:#3D.j.-.1#0A..18}#0A..4cas
ek!(j+1),.casel!(j+1).:#3D.k,.l#0A..1}#0A#0A..1cgpe
ndingop()#0A..1store(0,.ssp-2)#0A..1loada(arg1)#0A.
.1stack(ssp-1)#0A..1switcht(1,.n,.dlab)#0A}#0A#0A//
.Code.has.already.been.compiled.to.set.A.to.the.#0A
//.value.of.the.switch.expression#2E#0AAND.switcht(
p,.q,.dlab).BE#0A{.UNLESS.p<#3Dq.DO.{.genr(f_j,.dla
b);.RETURN.}#0A#0A..IF.0.<#3D.casek!q.-.casek!p.<#3D
.#23xFF2.DO..1//.Care.with.overflow!#0A..{.switchse
g(p,.q,.dlab)#0A..2RETURN#0A..}#0A..1#0A..{.LET.r.#3D
.(p+q)/2..//.p<q..and.so..r~#3Dq#0A..2LET.s.#3D.r#0A
#0A..2WHILE.p<r.&.0.<#3D.casek!s-casek!(r-1).<#3D.#23
xFF2.DO.r.:#3D.r-1#0A..2WHILE.s<q.&.0.<#3D.casek!r-
casek!(s+1).<#3D.#23xFF2.DO.s.:#3D.s+1#0A#09#0A..2/
/.Note.that:.if.r#3Dp.then.s~#3Dq#0A..2IF.r-p.<#3D.
q-s.DO.r.:#3D.s+1#0A..2//.r.is.now.set.to.the.pivot
.position#2E.Note:.r~#3Dp#0A#0A..2cgaddk(-casek!r)#0A
#09#0A..2//.Now.subtract.casek!r.from.all.case.cons
tants#0A..2//.and.re-sort.if.necessary#2E#0A..2r.:#3D
.offsetcases(p,.q,.r)#0A..2//.r.is.chosen.so.that.c
asek!r#3D0#0A#0A..2TEST.r#3Dp#0A..2THEN.genr(f_jls0
,.dlab)#0A..2ELSE.{.LET.lab.#3D.newlab()#0A..9genr(
f_jge0,.lab)#0A..9switcht(p,.r-1,.dlab)..//.All.cas
es.<.0#0A..9setlab(lab)#0A..7}#0A..2switcht(r,.q,.d
lab)..10//.All.cases.>#3D.0#0A..}#0A}#0A#0AAND.offs
etcases(p,.q,.r).#3D.VALOF#0A{.LET.offset.#3D.casek
!r#0A..IF.offset#3D0.RESULTIS.r..//.Nothing.to.do#2E
#0A..1#0A..FOR.i.#3D.p.TO.q..DO.casek!i.:#3D.casek!
i.-.offset#0A..IF.casek!p.<.casek!q.RESULTIS.r..//.
No.overflow.occurred#2E#0A..1#0A..//.Re-sort.the.ca
ses.because.wrap.round.occurred#2E#0A..FOR.i.#3D.p+
1.TO.q.DO#0A..{.LET.j.#3D.i#0A..2LET.k,.l.#3D.casek
!i,.casel!i#0A..2UNTIL.j>p.&.casek!(j-1).>.k.DO#0A.
.2{.casek!j,.casel!j.:#3D.casek!(j-1),.casel!(j-1)#0A
..4j.:#3D.j-1#0A..2}#0A..2casek!j,.casel!j.:#3D.k,.
l#0A..}#0A..1#0A..//.Find.the.new.pivot.point#2E#0A
..FOR.i.#3D.p.TO.q.IF.casek!i#3D0.RESULTIS.i#0A..cg
error("in.offsetcases")#0A..RESULTIS.p#0A}#0A#0AAND
.switchseg(p,.q,.dlab).BE#0A{.//.Only.called.when..
0000.<#3D.casek!q.-.casek!p.<#3D.#23xFF2#0A..//..12
and..p.<#3D.q#0A..LET.n.#3D.q-p+1..//.The.number.of
.cases.(>#3D1)#2E#0A#0A..IF.n#3D1.DO.{.cgaddk(-case
k!p)#0A..12genr(f_jeq0,.casel!p)#0A..12genr(f_j,.dl
ab)#0A..12RETURN#0A..10}#0A#0A..TEST.2*n.<.casek!q.
-.casek!p..//.Which.is.smaller?#0A..THEN.switchb(p,
.q,.dlab)..4//.Binary.chop.switch#2E#0A..ELSE.switc
hl(p,.q,.dlab)..4//.Label.vector.switch#2E#0A}#0A#0A
AND.switchb(p,.q,.dlab).BE..//.Binary.chop.switch#2E
#0A{.//.Only.called.when..0000.<#3D.casek!q.-.casek
!p.<#3D.#23xFF2#0A..//..12and..p.<.q#0A..LET.n.#3D.
q-p+1..1//.Number.of.cases.(>1)#2E#0A..LET.n1.#3D.n
>7.->n,.7#0A..1#0A..//.Ensure.that.all.case.constan
ts.can.be.represented.by#0A..//.unsigned.16.bit.int
egers#2E#0A..IF.casek!p<0.|.casek!q>#23xFF2.DO#0A..
{.cgaddk(-casek!p)#0A..3offsetcases(p,.q,.p)#0A..}#0A
..1#0A..chkrefs(6+4*n1).//.allow.for.padding.to.7.c
ases#0A..gen(f_swb)#0A..align(2)#0A..codeh(n)#0A..c
oder(dlab)#0A..FOR.i.#3D.p.TO.q.DO.{.LET.pos.#3D.q.
+.1.-.findpos(i-p+1,.q-p+1)#0A..20codeh(casek!pos)#0A
..20coder(casel!pos)#0A..18}#0A..FOR.i.#3D.q+1.TO.p
+6.DO.{.codeh(0).//.pad.out.to.7.cases#0A..24coder(
dlab)#0A..22}#0A}#0A#0A//.If.the.integers.1#2E#2En.
were.stored.in.a.balanced.binary#0A//.tree.using.th
e.tree.structure.of.heap.sort,.then#0A//.integer.i.
would.be.at.position.findpos(i,.n)#2E#0AAND.findpos
(i,.n).#3D.VALOF#0A{.LET.r.#3D.?#0A..IF.i.#3D.1.DO.
{.swlpos,.swrpos.:#3D.0,.n#0A..14RESULTIS.rootpos(0
,.n)#0A..12}#0A..r.:#3D.findpos(i/2,.n)#0A..TEST.(i
&1).#3D.0.THEN.swrpos.:#3D.r-1#0A..15ELSE.swlpos.:#3D
.r#0A..RESULTIS.rootpos(swlpos,.swrpos)#0A}#0A#0AAN
D.rootpos(p,.q).#3D.VALOF#0A{.LET.n.#3D.q-p#0A..LET
.s,.r.#3D.2,.?#0A..UNTIL.s>n.DO.s.:#3D.s+s#0A..s.:#3D
.s/2#0A..r.:#3D.n-s+1#0A..IF.s.<#3D.r+r.RESULTIS.p.
+.s#0A..RESULTIS.p.+.s/2.+.r#0A}#0A#0AAND.switchl(p
,.q,.dlab).BE..//.Label.vector.switch#2E#0A{.//.Onl
y.called.when..0000.<#3D.casek!q.-.casek!p.<#3D.#23
xFF2#0A..//..12and..p.<.q#0A#0A..LET.n,.t.#3D.?,.p#0A
#0A..//.Adjust.case.constants.to.suit.SWL.instructi
on#2E#0A..IF.casek!p<0.|.casek!p>1.|.casek!q>#23xFF
2.DO#0A..{.cgaddk(-casek!p)#0A..2offsetcases(p,.q,.
p)#0A..}#0A..1#0A..n.:#3D.casek!q.+.1..1//.Number.o
f.entries.in.the.label.vector#2E#0A..chkrefs(2*n+6)
#0A..gen(f_swl)#0A..align(2)#0A..codeh(n)#0A..coder
(dlab)..6//.Default.label#2E#0A#0A..FOR.k#3D.0.TO.c
asek!q.TEST.casek!t#3Dk#0A..20THEN.{.coder(casel!t)
#0A..27t.:#3D.t+1#0A..25}#0A..20ELSE.coder(dlab)#0A
}#0A#0AAND.cgstring(n).BE#0A{.LET.l,.a.#3D.newlab()
,.n#0A..loadt(k_lvlab,l)#0A..{.LET.b,.c,.d.#3D.0,.0
,.0#0A..2IF.n>0.DO.b.:#3D.rdn()#0A..2IF.n>1.DO.c.:#3D
.rdn()#0A..2IF.n>2.DO.d.:#3D.rdn()#0A..2!nliste.:#3D
.getblk(0,l,pack4b(a,.b,.c,.d))#0A..2nliste.:#3D.!n
liste#0A..2l.:#3D.0#0A..2IF.n<#3D3.BREAK#0A..2n,.a.
:#3D.n-4,.rdn()#0A..}.REPEAT#0A}#0A#0AAND.setlab(l)
.BE#0A{.LET.p.#3D.@rlist#0A#0A..1IF.debug>0.DO.writ
ef("%i4:.L%n:*n",.stvp,.l)#0A#0A..1labv!l.:#3D.stvp
..//.Set.the.label#2E#0A#0A..1//.Fill.in.all.refs.t
hat.are.in.range#2E#0A..1{.LET.r.#3D.!p#0A..4IF.r#3D
0.BREAK#0A..4TEST.h3!r#3Dl.&.inrange_d(h2!r,.stvp)#0A
..4THEN.{.fillref_d(h2!r,.stvp)#0A..12!p.:#3D.!r..1
//.Remove.item.from.RLIST#2E#0A..12freeblk(r)#0A..9
}#0A..4ELSE.p.:#3D.r..//.Keep.the.item#2E#0A..1}.RE
PEAT#0A..1rliste.:#3D.p..3//.Ensure.that.RLISTE.is.
sensible#2E#0A#0A..1p.:#3D.@reflist#0A#0A..1{.LET.r
.#3D.!p#0A..4IF.r#3D0.BREAK#0A..4TEST.h3!r#3Dl#0A..
4THEN.{.LET.a.#3D.h2!r#0A..12puth(a,stvp-a).//.Plan
t.rel.address#2E#0A..12!p.:#3D.!r..5//.Remove.item.
from.REFLIST#2E#0A..12freeblk(r)#0A..9}#0A..4ELSE.p
.:#3D.r..//.Keep.item#2E#0A..1}.REPEAT#0A#0A..1refl
iste.:#3D.p..1//.Ensure.REFLISTE.is.sensible#2E#0A}
#0A#0A2AND.cgstatics().BE.UNTIL.nlist#3D0.DO#0A{.LE
T.len,.nl.#3D.0,.nlist#0A#0A..1nliste.:#3D.@nlist..
//.All.NLIST.items.will.be.freed#2E#0A#0A..1len,.nl
.:#3D.len+4,.!nl.REPEATUNTIL.nl#3D0.|.h2!nl.~#3D.0#0A
#0A..1chkrefs(len+3)..//.+3.because.align(4).may.ge
nerate.3.bytes#2E#0A..1align(4)#0A#0A..1setlab(h2!n
list)..//.NLIST.always.starts.labelled#2E#0A#0A..1{
.LET.blk.#3D.nlist#0A..4nlist.:#3D.!nlist#0A..4free
blk(blk)#0A..4codew(h3!blk)#0A..1}.REPEATUNTIL.nlis
t#3D0.|.h2!nlist.~#3D.0#0A}#0A#0A2AND.getblk(a,.b,.
c).#3D.VALOF#0A{.LET.p.#3D.freelist#0A..1TEST.p#3D0
.THEN.{.dp.:#3D.dp-3;.checkspace();.p.:#3D.dp.}#0A.
.10ELSE.freelist.:#3D.!p#0A..1h1!p,.h2!p,.h3!p.:#3D
.a,.b,.c#0A..1RESULTIS.p#0A}#0A#0A1AND.freeblk(p).B
E.{.!p.:#3D.freelist;.freelist.:#3D.p.}#0A#0AAND.fr
eeblks(p).BE.UNLESS.p#3D0.DO#0A{.LET.oldfreelist.#3D
.freelist#0A..1freelist.:#3D.p#0A..1UNTIL.!p#3D0.DO
.p.:#3D.!p#0A..1!p.:#3D.oldfreelist#0A}#0A#0A1AND.i
nitdatalists().BE#0A{.reflist,.refliste.:#3D.0,.@re
flist#0A..1rlist,..1rliste..1:#3D.0,.@rlist#0A..1nl
ist,..1nliste..1:#3D.0,.@nlist#0A..1freelist.:#3D.0
#0A}#0A#0ALET.geng(f,.n).BE.TEST.n<256#0A..16THEN.g
enb(f,.n)#0A..16ELSE.TEST.n<512#0A..21THEN.genb(f+3
2,.n-256)#0A..21ELSE.genh(f+64,.n)#0A#0ALET.gen(f).
BE.IF.incode.DO#0A{.chkrefs(1)#0A..IF.debug.DO.wrco
de(f,."")#0A..codeb(f)#0A}#0A#0ALET.genb(f,.a).BE.I
F.incode.DO#0A{.chkrefs(2)#0A..IF.debug>0.DO.wrcode
(f,."%i3",.a)#0A..codeb(f)#0A..codeb(a)#0A}#0A#0ALE
T.genbb(f,.a,.b).BE.IF.incode.DO#0A{.chkrefs(3)#0A.
.IF.debug>0.DO.wrcode(f,."%i3.%i3",.a,.b)#0A..codeb
(f)#0A..codeb(a)#0A..codeb(b)#0A}#0A#0ALET.genflt(f
lop).BE.IF.incode.DO#0A{.chkrefs(2)#0A..IF.debug>0.
DO.wrcode(f_fltop,."%s",.flopname(flop))#0A..codeb(
f_fltop)#0A..codeb(flop)#0A}#0A#0ALET.genr(f,.n).BE
.IF.incode.DO#0A{.chkrefs(2)#0A..IF.debug>0.DO.wrco
de(f,."L%n",.n)#0A..codeb(f)#0A..codeb(0)#0A..relre
f(stvp-2,.n)#0A}#0A#0ALET.genh(f,.h).BE.IF.incode.D
O..//.Assume.0.<#3D.h.<#3D.#23xFF2#0A{.chkrefs(3)#0A
..IF.debug>0.DO.wrcode(f,."%n",.h)#0A..codeb(f)#0A.
.code2b(h)#0A}#0A#0ALET.genw(f,.w).BE.IF.incode.DO#0A
{.chkrefs(5)#0A..IF.debug>0.DO.wrcode(f,."%n",.w)#0A
..codeb(f)#0A..code4b(w)#0A}#0A#0ALET.genfb(f,.flop
,.a).BE.IF.incode.DO#0A{.//.Only.called.by:.genfb(f
_fltop,.fl_mk,.exponent)#0A..chkrefs(3)#0A..IF.debu
g>0.DO.wrcode(f,."%s.%n",.flopname(flop),.a)#0A..co
deb(f)#0A..codeb(flop)#0A..codeb(a)#0A}#0A#0ALET.ge
nfbb(f,.sfop,.a,.b).BE.IF.incode.DO#0A{.chkrefs(4)#0A
..IF.debug>0.DO.wrcode(f,."%s.%n.%n",.sfname(sfop),
.a,.b)#0A..codeb(f)#0A..codeb(sfop)#0A..codeb(a)#0A
..codeb(b)#0A}#0A#0AAND.checkspace().BE.IF.stvp/4>d
p-stv.DO#0A{.cgerror("Program.too.large,.%n.bytes.c
ompiled",.stvp)#0A..errcount.:#3D.errcount+1#0A..lo
ngjump(fin_p,.fin_l)#0A}#0A#0A1AND.codeb(byte).BE#0A
{.stv%stvp.:#3D.byte#0A..stvp.:#3D.stvp.+.1#0A..che
ckspace()#0A}#0A#0AAND.code2b(h).BE.TEST.bigender#0A
THEN.{.codeb(h>>0008.);.codeb(h..2)..}#0AELSE.{.cod
eb(h..2);.codeb(h>>0008.)..}#0A#0AAND.code4b(w).BE.
TEST.bigender#0ATHEN.{.codeb(w>>00024);.codeb(w>>00
016);.codeb(w>>0008.);.codeb(w..2)..}#0AELSE.{.code
b(w..2);.codeb(w>>0008.);.codeb(w>>00016);.codeb(w>
>00024)..}#0A#0AAND.pack4b(b0,.b1,.b2,.b3).#3D#0A..
bigender.->.b0<<00024.|.b1<<00016.|.b2<<0008.|.b3,#0A
..12b3<<00024.|.b2<<00016.|.b1<<0008.|.b0#0A#0AAND.
codeh(h).BE#0A{.IF.debug>0.DO.writef("%i4:..DATAH.%
n*n",.stvp,.h)#0A..code2b(h)#0A}#0A#0AAND.codew(w).
BE#0A{.IF.debug>0.DO.writef("%i4:..DATAW.0x%x8*n",.
stvp,.w)#0A..code4b(w)#0A}#0A#0AAND.coder(n).BE#0A{
.LET.labval.#3D.labv!n#0A..IF.debug>0.DO.writef("%i
4:..DATAH.L%n-$*n",.stvp,.n)#0A..code2b(0)#0A..TEST
.labval#3D-1.THEN.{.!refliste.:#3D.getblk(0,.stvp-2
,.n)#0A..22refliste.:#3D.!refliste#0A..20}#0A..15EL
SE.puth(stvp-2,.labval-stvp+2)#0A}#0A#0AAND.getw(a)
.#3D.#0A..bigender.->.stv%a<<00024.|.stv%(a+1)<<000
16.|.stv%(a+2)<<0008..|.stv%(a+3),#0A..12stv%a..3|.
stv%(a+1)<<0008..|.stv%(a+2)<<00016.|.stv%(a+3)<<00
024#0A#0AAND.puth(a,.w).BE#0A..TEST.bigender#0A..TH
EN.stv%a,..3stv%(a+1).:#3D.w>>0008,.w#0A..ELSE.stv%
(a+1),.stv%a..3:#3D.w>>0008,.w#0A#0AAND.putw(a,.w).
BE#0A..TEST.bigender#0A..THEN.stv%a,.stv%(a+1),.stv
%(a+2),.stv%(a+3).:#3D.w>>00024,w>>00016,.w>>0008,.
w#0A..ELSE.stv%(a+3),.stv%(a+2),.stv%(a+1),.stv%a.:
#3D.w>>00024,w>>00016,.w>>0008,.w#0A#0AAND.align(n)
.BE.UNTIL.stvp.REM.n.#3D.0.DO.codeb(0)#0A#0AAND.chk
refs(n).BE..//.Resolve.references.until.it.is.possi
ble#0A..17//.to.compile.n.bytes.without.a.reference
#0A..17//.going.out.of.range#2E#0A{.LET.p.#3D.@rlis
t#0A#0A..skiplab.:#3D.0#0A#0A..UNTIL.!p#3D0.DO#0A..
{.LET.r.#3D.!p#0A..2LET.a.#3D.h2!r.//.RLIST.is.orde
red.in.increasing.A#2E#0A#0A..2IF.(stv%a.&.1).#3D.0
.DO#0A..2//.An.unresolved.reference.at.address.A#0A
..2{.IF.inrange_i(a,.stvp+n+3).BREAK#0A..4//.This.p
oint.is.reached.if.there.is#0A..4//.an.unresolved.r
ef.at.A.which.cannot#0A..4//.directly.relative.addr
ess.STVP+N+3#0A..4//.and.so.an.indirect.data.word.m
ust#0A..4//.be.compiled#2E#0A..4//.The.+3.is.to.all
ow.for.a.possible#0A..4//.skip.jump.instruction.and
.possibly#0A..4//.one.filler.byte#2E#0A..4genindwor
d(h3!r)#0A..2}#0A#0A..2//.At.this.point.the.referen
ce.at.A#0A..2//.is.in.range.of.a.resolving.indirect
#0A..2//.data.word.and.should.be.removed.from#0A..2
//.RLIST.if.there.is.no.chance.that.it#0A..2//.can.
be.resolved.by.a.direct.relative#0A..2//.address#2E
#0A..2TEST.inrange_d(a,.stvp)#0A..2THEN.p.:#3D.r..6
//.Keep.the.item#2E#0A..2ELSE.{.!p.:#3D.!r..1//.Fre
e.item.if.already.resolved#0A..9freeblk(r).//.and.n
o.longer.in.direct.range#2E#0A..9IF.!p#3D0.DO.rlist
e.:#3D.p..//.Correct.RLISTE#2E#0A..7}#0A..}#0A#0A..
//.At.this.point.all.necessary.indirect.data.words.
have#0A..//.been.compiled#2E#0A#0A..UNLESS.skiplab#3D
0.DO.{.setlab(skiplab)#0A..22skiplab,.incode.:#3D.0
,.TRUE#0A..20}#0A}#0A#0AAND.genindword(l).BE..//.Ca
lled.only.from.CHKREFS#2E#0A{.LET.r.#3D.rlist..4//.
Assume.RLIST.~#3D.0#0A#0A..IF.incode.DO#0A..{.skipl
ab.:#3D.newlab()#0A..2//.genr(f_j,.skiplab).without
.the.call.of.chkrefs(2)#2E#0A..2IF.debug>0.DO.wrcod
e(f_j,."L%n",.skiplab)#0A..2codeb(f_j)#0A..2codeb(0
)#0A..2relref(stvp-2,.skiplab)#0A..2incode.:#3D.FAL
SE#0A..}#0A#0A..align(2)#0A#0A..UNTIL.r#3D0.DO#0A..
{.IF.h3!r#3Dl.&.(stv%(h2!r).&.1)#3D0.DO.fillref_i(h
2!r,.stvp)#0A..2r.:#3D.!r#0A..}#0A#0A..coder(l)#0A}
#0A#0AAND.inrange_d(a,.p).#3D.a-127.<#3D.p.<#3D.a+1
28#0A//.The.result.is.TRUE.if.direct.relative.instr
.(eg.J).at#0A//.A.can.address.location.P.directly#2E
#0A#0AAND.inrange_i(a,.p).#3D.VALOF#0A//.The.result
.is.TRUE.if.indirect.relative.instr.(eg.J}#0A//.at.
A.can.address.a.resolving.word.at.P#2E#0A{.LET.rel.
#3D.(p-a)/2#0A..RESULTIS.0.<#3D.rel.<#3D.255#0A}#0A
#0AAND.fillref_d(a,.p).BE#0A{.stv%a.:#3D.stv%a.&.25
4..//.Back.to.direct.form.if.neccessary#2E#0A..stv%
(a+1).:#3D.p-a-1#0A}#0A#0AAND.fillref_i(a,.p).BE../
/.P.is.even#2E#0A{.stv%a.:#3D.stv%a.|.1..1//.Force.
indirect.form#2E#0A..stv%(a+1).:#3D.(p-a)/2#0A}#0A#0A
AND.relref(a,.l).BE#0A//.RELREF.is.only.called.just
.after.compiling#0A//.a.relative.reference.instruct
ion.at#0A//.address.A.(#3Dstvp-2)#2E#0A{.LET.labval
.#3D.labv!l#0A#0A..IF.labval>#3D0.&.inrange_d(a,.la
bval).DO.{.fillref_d(a,.labval)#0A..41RETURN#0A..39
}#0A#0A..//.All.other.references.in.RLIST.have#0A..
//.addresses.smaller.than.A.and.so.RLIST.will#0A../
/.remain.properly.ordered.if.this.item#0A..//.is.ad
ded.to.the.end#2E#0A..!rliste.:#3D.getblk(0,.a,.l)#0A
..rliste.:#3D.!rliste#0A}#0A#0ALET.outputsection().
BE#0A{.LET.outstream.#3D.output()#0A..UNTIL.reflist
#3D0.DO.{.cgerror("Label.L%n.unset",.h3!reflist)#0A
..21reflist.:#3D.!reflist#0A..19}#0A#0A..selectoutp
ut(gostream)..//.Output.a.HUNK.or.BHUNK#2E#0A#0A..U
NLESS.objline1written.IF.objline1%0.DO#0A..{.writef
("%s*n",.objline1)#0A..2objline1written.:#3D.TRUE#0A
..}#0A#0A..TEST.bining#0A..THEN.{.writef("%X3.",.t_
bhunk)..8//.writes.4.chars."BB0008."#0A..7FOR.p#3D0
.TO.3..4DO.wrch(stv%p).//.write.bhunk.size#0A..7FOR
.p#3D0.TO.stvp-1.DO.wrch(stv%p).//.write.the.bhunk#0A
..5}#0A..ELSE.{.newline()#0A..7wrword(t_hunk)#0A..7
wrword(stvp/4)#0A..7FOR.p#3D0.TO.stvp-4.BY.4.DO#0A.
.7{.IF.p.REM.20.#3D.0.DO.newline()#0A..9wrword_at(p
)#0A..7}#0A..7newline()#0A..5}#0A..selectoutput(out
stream)#0A}#0A#0AAND.wrword(a).BE.writef("%X8.",.a)
#0A#0AAND.wrhex2(byte).BE#0A{.LET.t.#3D.TABLE.'0','
1','2','3','4','5','6','7',#0A..14'8','9','A','B','
C','D','E','F'#0A..wrch(t!(byte>>0004))#0A..wrch(t!
(byte&15))#0A}#0A#0AAND.wrword_at(a).BE#0A{.TEST.bi
gender.THEN.{.wrhex2(stv%a)#0A..21wrhex2(stv%(a+1))
#0A..21wrhex2(stv%(a+2))#0A..21wrhex2(stv%(a+3))#0A
..19}#0A..14ELSE.{.wrhex2(stv%(a+3))#0A..21wrhex2(s
tv%(a+2))#0A..21wrhex2(stv%(a+1))#0A..21wrhex2(stv%
(a))#0A..19}#0A..wrch('.')#0A}#0A#0AAND.dboutput().
BE#0A{.LET.p.#3D.info_a#0A..writes("A#3D(")#0A..UNT
IL.p#3D0.DO.{.wrkn(h2!p,.h3!p)#0A..15p.:#3D.!p#0A..
15UNLESS.p#3D0.DO.wrch('*s')#0A..13}#0A..2#0A..p.:#3D
.info_b#0A..writes(").B#3D(")#0A..UNTIL.p#3D0.DO.{.
wrkn(h2!p,.h3!p)#0A..15p.:#3D.!p#0A..15UNLESS.p#3D0
.DO.wrch('*s')#0A..13}#0A..wrch(')')#0A..1#0A..IF.d
ebug#3D2.DO.{.writes("..STK:.")#0A..16FOR.p#3Dtempv
.TO.arg1.BY.3..DO#0A..16{.IF.(p-tempv).REM.30.#3D.1
0.DO.newline()#0A..18wrkn(h1!p,h2!p)#0A..18wrch('*s
')#0A..16}#0A..14}#0A..1#0A..IF.debug#3D3.DO.{.LET.
l.#3D.rlist#0A..16writes("*nREFS.")#0A..16UNTIL.l#3D
0.DO.{.writef("%n.L%n..",.l!1,.l!2)#0A..31l.:#3D.!l
#0A..29}#0A..14}#0A..newline()#0A}#0A#0A1AND.wrkn(k
,n).BE#0A{.LET.s.#3D.VALOF.SWITCHON.k.INTO#0A..{.DE
FAULT:..5k.:#3D.n#0A..17RESULTIS."?"#0A..2CASE.k_no
ne:..1RESULTIS."-"#0A..2CASE.k_numb:..1RESULTIS."N"
#0A..2CASE.k_fnlab:..RESULTIS."F"#0A..2CASE.k_lvloc
:..RESULTIS."@P"#0A..2CASE.k_lvglob:.RESULTIS."@G"#0A
..2CASE.k_lvlab:..RESULTIS."@L"#0A..2CASE.k_a:..4RE
SULTIS."A"#0A..2CASE.k_b:..4RESULTIS."B"#0A..2CASE.
k_c:..4RESULTIS."C"#0A..2CASE.k_loc:..2RESULTIS."P"
#0A..2CASE.k_glob:..1RESULTIS."G"#0A..2CASE.k_lab:.
.2RESULTIS."L"#0A..2CASE.k_loc0:..1RESULTIS."0P"#0A
..2CASE.k_loc1:..1RESULTIS."1P"#0A..2CASE.k_loc2:..
1RESULTIS."2P"#0A..2CASE.k_loc3:..1RESULTIS."3P"#0A
..2CASE.k_loc4:..1RESULTIS."4P"#0A..2CASE.k_glob0:.
.RESULTIS."0G"#0A..2CASE.k_glob1:..RESULTIS."1G"#0A
..2CASE.k_glob2:..RESULTIS."2G"#0A..}#0A..writes(s)
#0A..UNLESS.k#3Dk_none.|.k#3Dk_a.|.k#3Dk_b.|.k#3Dk_
c.DO.writen(n)#0A}#0A#0AAND.wrcode(f,.form,.a,.b,.c
,.d).BE#0A{.IF.debug#3D2.DO.dboutput()#0A..writef("
%i4:.",.stvp)#0A..wrfcode(f)#0A..writes("..")#0A..w
ritef(form,.a,.b,.c,.d)#0A..newline()#0A}#0A#0AAND.
wrfcode(f).BE#0A{.LET.s.#3D.VALOF.SWITCHON.f&31.INT
O#0A..{.DEFAULT:#0A..2CASE..0000:.RESULTIS."..3-..3
K..1LLP..3L..2LP..2SP..2AP..3A"#0A..2CASE..0001:.RE
SULTIS.".FLTOP..2KH..LLPH..2LH..1LPH..1SPH..1APH..2
AH"#0A..2CASE..0002:.RESULTIS."..1BRK..2KW..LLPW..2
LW..1LPW..1SPW..1APW..2AW"#0A..2CASE..0003:.RESULTI
S."..2K3..1K3G..K3G1..K3GH..1LP3..1SP3..1AP3..L0P3"
#0A..2CASE..0004:.RESULTIS."..2K4..1K4G..K4G1..K4GH
..1LP4..1SP4..1AP4..L0P4"#0A..2CASE..0005:.RESULTIS
."..2K5..1K5G..K5G1..K5GH..1LP5..1SP5..1AP5..L0P5"#0A
..2CASE..0006:.RESULTIS."..2K6..1K6G..K6G1..K6GH..1
LP6..1SP6..1AP6..L0P6"#0A..2CASE..0007:.RESULTIS.".
.2K7..1K7G..K7G1..K7GH..1LP7..1SP7..1AP7..L0P7"#0A.
.2CASE..0008:.RESULTIS."..2K8..1K8G..K8G1..K8GH..1L
P8..1SP8..1AP8..L0P8"#0A..2CASE..0009:.RESULTIS."..
2K9..1K9G..K9G1..K9GH..1LP9..1SP9..1AP9..L0P9"#0A..
2CASE.10:.RESULTIS."..1K10..K10G.K10G1.K10GH..LP10.
.SP10..AP10.L0P10"#0A..2CASE.11:.RESULTIS."..1K11..
K11G.K11G1.K11GH..LP11..SP11..AP11.L0P11"#0A..2CASE
.12:.RESULTIS."..2LF..1S0G..S0G1..S0GH..LP12..SP12.
.AP12.L0P12"#0A..2CASE.13:.RESULTIS."..1LF$..1L0G..
L0G1..L0GH..LP13..SP13.XPBYT..3S"#0A..2CASE.14:.RES
ULTIS."..2LM..1L1G..L1G1..L1GH..LP14..SP14..1LMH..2
SH"#0A..2CASE.15:.RESULTIS."..1LM1..1L2G..L2G1..L2G
H..LP15..SP15..1BTC..MDIV"#0A..2CASE.16:.RESULTIS."
..2L0..2LG..1LG1..1LGH..LP16..SP16..1NOP.CHGCO"#0A.
.2CASE.17:.RESULTIS."..2L1..2SG..1SG1..1SGH..1SYS..
2S1..2A1..1NEG"#0A..2CASE.18:.RESULTIS."..2L2..1LLG
..LLG1..LLGH..1SWB..2S2..2A2..1NOT"#0A..2CASE.19:.R
ESULTIS."..2L3..2AG..1AG1..1AGH..1SWL..2S3..2A3..L1
P3"#0A..2CASE.20:.RESULTIS."..2L4..1MUL..1ADD..2RV.
.2ST..2S4..2A4..L1P4"#0A..2CASE.21:.RESULTIS."..2L5
..1DIV..1SUB..1RV1..1ST1..1XCH..2A5..L1P5"#0A..2CAS
E.22:.RESULTIS."..2L6..1REM..1LSH..1RV2..1ST2..GBYT
..RVP3..L1P6"#0A..2CASE.23:.RESULTIS."..2L7..1XOR..
1RSH..1RV3..1ST3..PBYT..RVP4..L2P3"#0A..2CASE.24:.R
ESULTIS."..2L8..2SL..1AND..1RV4..STP3..1ATC..RVP5..
L2P4"#0A..2CASE.25:.RESULTIS."..2L9..1SL$..2OR..1RV
5..STP4..1ATB..RVP6..L2P5"#0A..2CASE.26:.RESULTIS."
..1L10..2LL..1LL1..1RV6..STP5..3J..RVP7..L3P3"#0A..
2CASE.27:.RESULTIS."..FHOP..1LL$..LL1$..1RTN..GOTO.
.2J$.ST0P3..L3P4"#0A..2CASE.28:.RESULTIS."..1JEQ..1
JNE..1JLS..1JGR..1JLE..1JGE.ST0P4..L4P3"#0A..2CASE.
29:.RESULTIS."..JEQ$..JNE$..JLS$..JGR$..JLE$..JGE$.
ST1P3..L4P4"#0A..2CASE.30:.RESULTIS."..JEQ0..JNE0..
JLS0..JGR0..JLE0..JGE0.ST1P4.SELLD"#0A..2CASE.31:.R
ESULTIS.".JEQ0$.JNE0$.JLS0$.JGR0$.JLE0$.JGE0$..2MW.
SELST"#0A..}#0A..LET.n.#3D.f>>0005.&.7#0A..FOR.i.#3D
.6*n+1.TO.6*(n+1).DO.wrch(s%i)#0A}#0A#0A1

######com/xbcplfe.b#
//.This.is.an.extend.version.of.the.BCPL.syntax.ana
lyser#0A#0A//.Implemented.by.Martin.Richards.(c).17
.May.2013#0A#0A1/*.Change.history#0A#0A00017/05/13#0A
Added.BITSPERBCPLWORD#0A#0A00005/10/10#0AModified.t
he.treatment.of.EQCASES.to.preserve.the.case.of.the
.first#0Aoccurrence.of.each.name.for.use.in.eg.cros
s.reference.listings#2E#0ARemoved.SKIP.command#2E#0A
#0A00014/07/10#0AStarted.major.changes.to.add.the.f
loating.point.and.assignment#0Aoperators.and.the.<>
.operator#2E.Added.the.FLTOP,.SELLD.abd.SELST#0AOCO
DE.statements#2E#0A#0A00020/10/09#0ACorrected.bug.i
n.performget.relating.to.sourcefile.names.and#0Anum
bers#2E#0A#0A00010/07/09#0AStopped.'#2E'.terminatin
g.GET.streams.so.that.GET.streams.can.contain#0Asev
eral.sections.separated.by.dots#2E.BEWARE:.this.is.
an.incompatible#0Achange,.since.the.first.section.o
f.a.GET.stream.has.in.the.past.been#0Aused.as.a.hea
der#2E#0ARe-organised.the.compiler.into.g/bcplfecg#2E
h,.bcplfe#2Eb.and.bcplcgcin#2Eb,#0Aand.reallocating
.most.of.the.compiler.globals#2E#0A#0A00008/05/09#0A
Increased.the.default.treesize.to.2003#2E#0A#0A0000
3/07/07#0AModified.the.treatment.of.*#23.escapes.in
.string.and.character.constants#0Ato.allow.both.UTF
8.and.GB2312.encoding#2E.Added.compiler.options.UTF
8#0Aand.GB2312.to.set.the.default.encoding#2E.*#23U
.and.*#23G.in.a.string.and#0Acharacter.constant.tem
porarily.set.the.encoding.to.UTF8.and.GB2312,#0Ares
pectively,.overriding.the.default.setting#2E.In.GB2
312.mode,.*#23dd2#0Acontains.up.to.4.decimal.digits
#2E.See.the.BCPL.manual#2E#0A#0A00027/06/07#0AAdded
.the.Unicode.escape.sequences.*#23hh2.and.*#23#23hh
6.to.string#0Aand.character.constants#2E.Within.str
ing.they.are.converted.to.the#0Acorresponding.UTF8.
sequence.of.bytes.and.within.a.character.constant#0A
they.yield.the.corresponding.Unicode.integer#2E.See
.the.last.few.tests#0Ain.com/cmpltest#2Eb#0A#0A0002
7/07/06#0AChanged.the.implementation.of.the.GET.dir
ective.to.make.it.system#0Aindependent#2E.Performge
t.now.obtains.the.headers.environment.variable#0Afr
om.the.root.node.(rootnode!rtn_hdrsvar).this.is.nor
mally.either#0A"BCPLHDRS".or."POSHDRS"#2E.If.the.he
ader.file.does.not.end.in.#2Eh.or.#2Eb,#0A#2Eh.is.a
ppended#2E.The.search.order.is.as.follows:#0A#0A(1)
.The.current.directory#2E#0A(2).The.directories.spe
cified.by.the.headers.environment.variable,#0A..2if
.set#2E#0A(3).The.subdirectory.g/.of.the.root.speci
fied.by.the.environment#0A..2variable.rootnode!rtn_
rootvar,.if.set#2E#0A#0A00005/04/06#0AMended.a.bug.
in.trans.concerning.the.tranlation.of.SKIP#2E#0A#0A
00018/01/06#0ABased.on.Dave.Lewis's.suggestion,#0Ai
n.outputsection(),.add:#0A..1IF.objline1%0.DO.write
f("%s*n",.objline1)#0Awhere.objline1.is.the.first.l
ine.of.file.objline1.if.it.can.be.found#0Ain.the.cu
rrent.directory.or.in.the.HDRS.directory#2E.This.wi
ll.typically#0Aput.a.line.such.as:#0A#23!/usr/local
/bin/cintsys.-c#0Aas.the.first.line.of.the.compiled
.object.module#2E.This.line.is.ignored#0Aby.the.CLI
.but.may.be.useful.under.Linux#2E.If.objline1.canno
t.be.found#0Ano.such.line.is.inserted.at.the.start.
of.the.object.module#2E#0A#0A00030/8/05#0ADefined.t
he.function.default_hdrs().near.the.start.to.allow.
easy.change#0Afrom.cintsys.to.cintpos.versions.of.t
he.compiler#2E#0A.#0A22/6/05#0AAdded.the.empty.comm
and.SKIP.and.let.empty.blocks.be.equivalent.to#0ASK
IP#2E.Empty.section.brackets.are.now.also.allowed.a
fter.MANIFEST,#0ASTATIC.and.GLOBAL#2E..These.change
s.make.program.development.marginally#0Aeasier#2E#0A
#0A00017/6/04#0AMade.GET.first.look.in.the.current.
directory#2E#0AAdded.argument.HDRS.to.allow.the.env
ironment.variable.specifying#0Athe.headers.director
y.to.be.changed#2E.The.default.is.BCPLHDRS#2E#0A#0A
00023/4/04#0AUpdate.the.standard.BCPL.compiler.with
.all.the.Cintpos.extensions#0Aincluding.cross.refer
encing.and.11.character.names#2E#0AMake.GET.directi
ves.use.the.BCPLHDRS.environment.variable#2E#0A#0A0
0011/6/02#0AChanged.square.brackets.to.mean.subscri
ption.with.same.precedence#0Aand.function.calls#2E#0A
#0A00018/3/02#0AUse.HDRPATH.and.BCPLPATH.in.GET.dir
ectives#2E#0A#0A00014/1/02#0AAdded.XREF.option.to.o
utput.name.information.during.compilation#2E#0A#0A0
0011/7/01#0AAdded.language.extensions.for.the.Ford.
dialect.of.BCPL#2E#0Ai#2Ee#2E.modified.performget#0A
..3added.SLCT.and.OF.(also.::)#0A..3added.||.commen
ts#0A..3treesize.set.to.1003#0A#0A00015/1/01#0AComp
lain.if.global.number.is.larger.than.65500035#2E#0A
#0A00010/8/00#0AChange.the.maximum.number.of.error.
messages.from.30.to.10#2E#0A#0A00014/12/99#0AMade./
.*.#2E#2E1.*./..comments.nest#2E#0AAllow.the.consta
nts.in.MANIFEST,.STATIC.and.GLOBAL.declarations.#0A
to.be.optional#2E.If.absent.the.value.is.one.greate
r.than.the#0Aprevious.value#2E.Unless.specified.the
.first.value.is.zero,.so#0AMANIFEST.{.a;.b#3D10;.c.
}.declares.a,.b.and.c.to.be.0,.10.and.11,#0Arespect
ively#2E#0A#0A0009/6/99#0AMade.changes.to.buffer.OC
ODE.in.memory#2E.When.bcpl.is.called#0Awithout.the.
TO.argument.it.writes.numeric.ocode.to.the.file.oco
de#2E#0ALex.treats.CR.(13).correctly.to.improve.con
venience.when.running#0Aunder.Windows.and.WindowsCE
#2E#0A#0A00026/2/99#0AAdded.BIN.option.to.the.compi
ler.to.generate.a.binary.(rather.than#0Ahex).hunk.f
ormat.for.the.compiled.code#2E.This.is.primarily.fo
r.the#0AWindows.CE.version.of.the.cintcode.system.w
here.compactness.is#0Aparticularly.important#2E.The
re.is.a.related.change.to.loadseg.in#0Acintmain#2Ec
#0A#0A00017/11/98#0AChanged.the.workspacesize.to.40
02.and.added.the.SIZE.keyword#0Ato.allow.the.user.t
o.specify.this.size#2E#0A#0A0009/11/98#0AMade.GET.d
irectives.search.the.current.working.directory#0Ath
en.directories.given.by.the.shell.variable.BCPLPATH
,.if.set#2E#0AIt.uses.the.BLIB.function.pathfindinp
ut#2E#0A#0A00015/12/96#0ACorrect.a.bug.in.cellwithn
ame#0A#0A00016/8/96#0AAdded.one.line.to.readnumber.
to.allow.underscores.in.numbers.after.#0Athe.first.
digit#2E#0A#0A0007/6/96#0AImplement.the.method.appl
ication.operator.for.object.oriented#0Aprogramming.
in.BCPL#2E.E.#23.(E1,.E2,#2E#2E1,.En).is.equivalent
.to#0A((!E1)!E)(E1,.E2,#2E#2E1,.En)#0A#0A00024/12/9
5#0AImproved.the.efficiency.of.cellwithname.in.TRN.
(using.the.hash.chain#0Alink.in.name.node)#2E#0AImp
roved.the.efficiency.of.outputsection.in.CG.by.intr
oducing#0Awrhex2.and.wrword_at#2E#0A#0A00024/7/95#0A
Removed.bug.in.atbinfo,.define.addinfo_b.change.som
e.global.numbers#2E#0AImplement.constant.folding.in
.TRN#2E#0A#0A00013/7/95#0AAllowed.{.and.}.to.repres
ent.untagged.section.brackets#2E#0A#0A00022/6/93#0A
Reverse.order.in.SWB.and.have.a.minimum.of.7.cases#0A
to.allow.faster.interpreter#2E#0A#0A0002/6/93#0ACha
nged.code.for.SWB.to.use.heap-like.binary.tree#2E#0A
#0A00019/5/93#0APut.in.code.to.compile.BTC.and.XPBY
T.instructions#2E#0A#0A00023/4/93#0AAllowed.the.cod
egenerator.to.compiler.the.S.instruction#2E#0A#0A00
021/12/92#0ACured.bug.in.compilation.of.(b.->.f,.g)
(1,2,3)#0A#0A00024/11/92.#0ACured.bug.in.compilatio
n.of.a,.b.:#3D.s%0.>.0,.s%1.#3D.'!'#0A#0A00023/7/92
:#0ARenamed.nextlab.as.newlab,.load.as.loadval.in.t
he.CG#2E#0APut.back.simpler.hashing.function.in.loo
kupword#2E#0ARemoved.rdargs.fudge#2E#0ARemoved.S2.c
ompiler.option#2E#0ACured.bug.concerning.the.closin
g.of.gostream.when.equal.to.stdout#2E#0A*/#0A#0ASEC
TION."BCPL"#0A#0AGET."libhdr"#0AGET."bcplfecg"#0A.#0A
LET.default_hdrs().#3D.VALOF.//.Changed.MR.12/07/09
#0A{.LET.hdrs.#3D.rootnode!rtn_hdrsvar.//.Typically
."BCPLHDRS".or."POSHDRS".or.0#0A..IF.hdrs.RESULTIS.
hdrs#0A..//.The.following.is.only.executed.if.cints
ys.or.cintsys64.fails.to.set#0A..//.the.hdrs.field.
in.the.rootnode#2E#0A..TEST.t64#0A..THEN.RESULTIS."
BCPL64HDRS"#0A..ELSE.RESULTIS."BCPLHDRS"#0A}#0A.#0A
GLOBAL.{#0A//.Globals.used.in.LEX#0Achbuf:feg#0Adec
val;.exponent;.getstreams;.charv#0Ahdrs..//.MR.10/7
/04#0A#0Aworkvec#0Areaddecimal;.readnumber;.rdstrch
#0Atoken;.wordnode;.ch#0Ardtag;.performget#0Alex;.d
sw;.declsyswords;.nlpending#0Alookupword;.eqlookupw
ord;.rch#0Asourcenamev;.sourcefileno;.sourcefileupb
#0Askiptag;.wrchbuf;.chcount;.lineno#0Anulltag;.rec
_p;.rec_l#0A.#0A//.Globals.used.in.SYN#0Ardblockbod
y;..rdsect#0Arnamelist;.rname#0Ardef;.rcom#0Ardcdef
s#0Aformtree;.synerr;.opname#0Arexplist;.rdseq#0Amk
1;.mk2;.mk3#0Amk4;.mk5;.mk6;.mk7#0Anewvec#0Arnexp;.
rexp;.rbexp#0A}#0A.#0A.#0AMANIFEST.{#0Ac_backspace.
#3D..0008#0Ac_tab..5#3D..0009#0Ac_newline..1#3D.10#0A
c_newpage..1#3D.12#0Ac_return..2#3D.13#0Ac_escape..
2#3D.27#0Ac_space..3#3D.32#0A}#0A#0ALET.start().#3D
.VALOF#0A{.LET.treesize.#3D.0#0A..AND.argv.#3D.VEC.
50#0A..AND.argform.#3D."FROM/A,TO/K,VER/K,SIZE/K/N,
TREE/S,NONAMES/S,*#0A..14*D1/S,D2/S,OENDER/S,EQCASE
S/S,BIN/S,XREF/S,GDEFS/S,HDRS/K,*#0A..14*GB2312/S,U
TF8/S,SAVESIZE/K/N,HARD/S,*#0A..14*T32/S,T64/S"#0A.
.LET.stdout.#3D.output()#0A..LET.objline1vec.#3D.VE
C.256/bytesperword#0A..objline1.:#3D.objline1vec#0A
..objline1%0.:#3D.0#0A..errmax..1:#3D.10#0A..errcou
nt.:#3D.0#0A..fin_p,.fin_l.:#3D.level(),.fin#0A#0A.
.treevec..4:#3D.0#0A..obuf..7:#3D.0#0A..sourcestrea
m.:#3D.0#0A..ocodeout..3:#3D.0#0A..gostream..3:#3D.
0#0A..getstreams..1:#3D.0#0A#0A..sysprint.:#3D.stdo
ut#0A..selectoutput(sysprint)#0A.#0A..writef("*nXBC
PL.(17.May.2013)*n")#0A#0A..//.Allocate.vector.for.
source.file.names#0A..sourcefileupb.:#3D.1001#0A..s
ourcenamev.:#3D.getvec(sourcefileupb)#0A..UNLESS.so
urcenamev.DO#0A..{.writef("Insufficient.space.avail
able*n")#0A..2errcount.:#3D.1#0A..2GOTO.fin#0A..}#0A
..sourcefileno.:#3D.0#0A..FOR.i.#3D.0.TO.sourcefile
upb.DO.sourcenamev!0.:#3D.0..1#0A.#0A..IF.rdargs(ar
gform,.argv,.50)#3D0.DO.{.writes("Bad.arguments*n")
#0A..36errcount.:#3D.1#0A..36GOTO.fin#0A..34}#0A#0A
..bigender.:#3D.(!"AA5".&.255).#3D.'A'..2//.#3DTRUE
.if.on.a.bigender.m/c#0A#0A..//.Set.the.current.sys
tem.wordlength.flag#0A..c64.:#3D.B2Wsh#3D3..24//.#3D
TRUE.if.on.a.64-bit.system#0A..//.Set.the.target.sy
stem.wordlength.flag#0A..t64.:#3D.c64..28//.Set.the
.target.word.length#0A..IF.argv!18.&.argv!19.DO..15
//.T32/S.and.T64/S#0A..2writef("Both.T32.and.T64.sp
ecified.--.T64.assumed*n")#0A..IF.argv!18.DO.t64.:#3D
.FALSE..12//.T32/S#0A..IF.argv!19.DO.t64.:#3D.TRUE.
.13//.T64/S#0A..wordbytelen.:#3D.t64.->.8,.4..12//.
Set.the.target.word.length.in.bytes#0A#0A..treesize
.:#3D.200_001#0A..IF.argv!3.DO.treesize.:#3D.!argv!
3..6//.SIZE/K/N#0A..IF.treesize<10_001.DO.treesize.
:#3D.10_001#0A..obufsize.:#3D.treesize/4#0A#0A..prt
ree..6:#3D.argv!4..15//.TREE/S#0A..savespacesize.:#3D
.3#0A#0A..//.Code.generator.options.#0A..naming.:#3D
.TRUE#0A..debug.:#3D.0#0A#0A..//.This.must.be.done.
after.T64.is.properly.set#0A..hdrs.:#3D.default_hdr
s()..16//.Set.the.default.HDRS#0A#0A..IF.argv!5.DO.
naming..1:#3D.FALSE..8//.NONAMES/S#0A..IF.argv!6.DO
.debug..2:#3D.debug+1..6//.D1/S#0A..IF.argv!7.DO.de
bug..2:#3D.debug+2..6//.D2/S#0A..IF.argv!8.DO.bigen
der.:#3D.~bigender..4//.OENDER/S#0A..eqcases..:#3D.
argv!9..20//.EQCASES/S#0A..bining..1:#3D.argv!10..1
9//.BIN/S.(binary.hunk)#0A..xrefing..:#3D.argv!11..
19//.XREF/S#0A..gdefsing.:#3D.argv!12..19//.GDEFS/S
#0A..IF.argv!13.DO.hdrs.:#3D.argv!13..9//.HDRS/K#0A
..defaultencoding.:#3D.UTF8#0A..IF.argv!14.DO.defau
ltencoding.:#3D.GB2312.//.GB2312/S#0A..IF.argv!15.D
O.defaultencoding.:#3D.UTF8..1//.UTF8/S#0A..encodin
g.:#3D.defaultencoding#0A..IF.argv!16.DO.savespaces
ize.:#3D.!(argv!16).//.SAVESIZE/K/N#0A..hard.:#3D.a
rgv!17..23//.HARD/S#0A..40//.t32/S.is.18#0A..40//.t
64/S.is.19#0A..//.Added.5/10/2010#0A..IF.eqcases.DO
.lookupword.:#3D.eqlookupword#0A#0A//writef("BCPL.h
drs.#3D.%s*n",.hdrs)#0A#0A..{.//.Feature.added.by.M
R.17/01/06#0A..2//.If.file.objline1.can.be.found,.i
ts.first.line.will.be.written#0A..2//.at.the.start.
of.the.compiled.Cintcode.file#2E.It.first.looks.in.
the#0A..2//.current.directory.then.the.HDRS.directo
ry.and.finally.it.tries#0A..2//.g/objline1.in.the.s
ystem.root.directory#2E#0A..2LET.line1stream.#3D.fi
ndinput("objline1")#0A..2LET.len.#3D.0#0A#0A..2UNLE
SS.line1stream.DO#0A..4line1stream.:#3D.pathfindinp
ut("objline1",.hdrs)#0A..2UNLESS.line1stream.IF.roo
tnode!rtn_rootvar.DO#0A..4line1stream.:#3D.pathfind
input("g/objline1",.rootnode!rtn_rootvar)#0A..2#0A.
.2IF.line1stream.DO#0A..2{.//.Copy.first.line.of.ob
jline1.into.string.objline1#0A..4selectinput(line1s
tream)#0A..4WHILE.len<255.DO#0A..4{.LET.ch.#3D.rdch
()#0A..6IF.ch#3D'*n'.|.ch#3Dendstreamch.BREAK#0A..6
len.:#3D.len+1#0A..6objline1%len.:#3D.ch#0A..4}#0A.
.4endread()#0A..2}#0A..2objline1%0.:#3D.len#0A..2ob
jline1written.:#3D.FALSE#0A..}#0A#0A..sourcestream.
:#3D.findinput(argv!0)..5//.FROM/A#0A..sourcenamev!
0.:#3D.argv!0..2//.Fileno.zero.is.the.FROM.file#0A.
.sourcefileno..:#3D.0#0A#0A..IF.sourcestream#3D0.DO
.{.writef("Trouble.with.file.%s*n",.argv!0)#0A..23I
F.hard.DO.abort(1001)#0A..23errcount.:#3D.1#0A..23G
OTO.fin#0A..21}#0A#0A..selectinput(sourcestream)#0A
.#0A..TEST.argv!1..27//.TO/K#0A..THEN.{.gostream.:#3D
.findoutput(argv!1)#0A..7IF.gostream#3D0.DO#0A..7{.
writef("Trouble.with.code.file.%s*n",.argv!1)#0A..9
IF.hard.DO.abort(1001)#0A..9errcount.:#3D.1#0A..9GO
TO.fin#0A..7}#0A..5}#0A..ELSE.{.ocodeout.:#3D.findo
utput("ocode")#0A..7IF.ocodeout#3D0.DO#0A..7{.write
s("Trouble.with.file.ocode*n")#0A..9IF.hard.DO.abor
t(1001)#0A..9errcount.:#3D.1#0A..9GOTO.fin#0A..7}#0A
..5}#0A#0A..treevec.:#3D.getvec(treesize)#0A..obuf.
.2:#3D.getvec(obufsize)#0A#0A..IF.treevec#3D0.|.obu
f#3D0.DO#0A..{.writes("Insufficient.memory*n")#0A..
2errcount.:#3D.1#0A..2GOTO.fin#0A..}#0A..1#0A..UNLE
SS.argv!2#3D0.DO..20//.VER/K#0A..{.TEST.xrefing#0A.
.2THEN.sysprint.:#3D.findappend(argv!2)#0A..2ELSE.s
ysprint.:#3D.findoutput(argv!2)#0A..2IF.sysprint#3D
0.DO#0A..2{.sysprint.:#3D.stdout#0A..4writef("Troub
le.with.file.%s*n",.argv!2)#0A..4IF.hard.DO.abort(1
001)#0A..4errcount.:#3D.1#0A..4GOTO.fin#0A..2}#0A..
}#0A#0A..selectoutput(sysprint)#0A#0A..//.Now.synta
x.analyse,.translate.and.code-generate.each.section
#0A..{.LET.b.#3D.VEC.64/bytesperword#0A..2chbuf.:#3D
.b#0A..2FOR.i.#3D.0.TO.63.DO.chbuf%i.:#3D.0#0A..2//
.Sourcefile.0.is.the.FROM.filename#0A..2//.others.a
re.GET.files.of.the.current.section#0A..2sourcename
v!0.:#3D.argv!0#0A..2sourcefileno.:#3D.0#0A..2FOR.i
.#3D.1.TO.sourcefileupb.DO.sourcenamev!i.:#3D.0.//.
Done.for.safety#0A..2chcount,.lineno.:#3D.0,.(sourc
efileno<<00020).+.1#0A..2token,.decval.:#3D.0,.0#0A
..2rch()#0A.#0A..2{.//.Start.of.loop.to.process.eac
h.section#0A..4LET.tree.#3D.?#0A..4treep.:#3D.treev
ec.+.treesize#0A..4obufp.:#3D.0#0A..4obuft.:#3D.obu
fsize.*.bytesperword#0A#0A..4tree.:#3D.formtree()#0A
..4UNLESS.tree.BREAK#0A#0A..4//writef("Tree.size.%n
*n",.treesize+treevec-treep)#0A.#0A..4IF.prtree.DO.
{.writes("Parse.Tree*n")#0A..19plist(tree,.0,.20)#0A
..19newline()#0A..17}#0A..#0A..4IF.errcount.GOTO.fi
n#0A.#0A..4translate(tree)#0A#0A..4obufq.:#3D.obufp
..3//.Prepare.to.read.from.OCODE.buffer#0A..4obufp.
:#3D.0#0A#0A..4TEST.argv!1#3D0#0A..4THEN.writeocode
()..//.Write.OCODE.file.if.no.TO.argument#0A..4ELSE
.codegenerate(treevec,.treesize)#0A..2}.REPEATWHILE
.token#3Ds_dot#0A..}#0A..1#0Afin:#0A..IF.getstreams
..2DO.{.LET.p.#3D.getstreams#0A..22getstreams.:#3D.
!p#0A..22freevec(p)#0A..20}#0A..FOR.i.#3D.1.TO.sour
cefileno.DO#0A..{.LET.str.#3D.sourcenamev!i#0A..2IF
.str.DO#0A..2{.//sawritef("freeing.fileno.%n.%s*n",
.i,.str)#0A..4freevec(str)#0A..2}#0A..}#0A..IF.sour
cenamev..1DO.freevec(sourcenamev)#0A#0A..IF.treevec
..5DO.freevec(treevec)#0A..IF.obuf..8DO.freevec(obu
f)#0A..IF.sourcestream..DO.endstream(sourcestream)#0A
..IF.ocodeout..4UNLESS.ocodeout#3Dstdout.DO.endstre
am(ocodeout)#0A..IF.gostream..4UNLESS.gostream#3Dst
dout.DO.endstream(gostream)#0A..UNLESS.sysprint#3Ds
tdout.DO.endstream(sysprint)#0A#0A..selectoutput(st
dout)#0A..RESULTIS.errcount#3D0.->.0,.20#0A}#0A#0A/
/.**11.OCODE.I/O.Routines.**24#0A#0A/*#0AThe.OCODE.
buffer.variables.are:#0A#0Aobuf..7is.the.OCODE.buff
er.--.(obuf#3Dworkvec)#0Aobufp..6position.of.next.b
yte.in.the.OCODE.buffer#0Aobufq..6another.pointer.i
nto.the.OCODE.buffer#0Aobuft..6end.of.the.OCODE.buf
fer#2E#0Aobufsize..3size.of.obuf.(in.words)#0A*/#0A
#0AAND.writeocode().BE#0A{.LET.layout.#3D.0#0A..sel
ectoutput(ocodeout)#0A#0A..UNTIL.obufp>#3Dobufq.DO#0A
..{.writef(".%n",.rdn())#0A..2layout.:#3D.layout+1#0A
..2UNLESS.layout.REM.16.DO.newline()#0A..}#0A..newl
ine()#0A..selectoutput(sysprint)#0A..writef("OCODE.
size:.%i5/%n*n",.obufq,.obuft)#0A}#0A#0AAND.rdn().#3D
.VALOF#0A{.LET.byte.#3D.obuf%obufp#0A..IF.obufp>#3D
obufq.RESULTIS.0#0A..obufp.:#3D.obufp+1#0A..IF.byte
<220003.RESULTIS.byte#0A..IF.byte#3D220003.RESULTIS
.-1#0A..RESULTIS.(byte&31).+.(rdn()<<0005)#0A}#0A#0A
AND.wrn(n).BE#0A{.IF.obufp>#3Dobuft.DO#0A..{.errmax
.:#3D.0.//.Make.it.fatal#0A..2trnerr("More.workspac
e.needed.for.OCODE.buffer*n")#0A..}#0A..IF.-1<#3Dn<
220003.DO..2//.This.is.the.normal.case#0A..{.IF.n#3D
-1.DO.n.:#3D.220003#0A..2obuf%obufp.:#3D.n#0A..2obu
fp.:#3D.obufp.+.1#0A..2RETURN#0A..}#0A..obuf%obufp.
:#3D.220004.+.(n&31)#0A..obufp.:#3D.obufp.+.1#0A..n
.:#3D.n>>0005#0A}.REPEAT#0A#0A//.**11.End.of..OCODE
.I/O.Routines.**17#0A#0ALET.bits(w).#3D.w#3D0.->.0,
.bits(w.&.(w-1)).+.1#0A..#0ALET.lex().BE#0A{.LET.as
sop.#3D.?#0A..nlpending.:#3D.FALSE#0A.#0A..{.SWITCH
ON.ch.INTO#0A.#0A..2{.DEFAULT:#0A..10{.LET.badch.#3D
.ch#0A..12ch.:#3D.'*s'#0A..12synerr("Illegal.charac
ter.%x2",.badch)#0A..10}#0A#0A..4CASE.'*n':#0A..13l
ineno.:#3D.lineno.+.1#0A..4CASE.'*p':#0A..13nlpendi
ng.:#3D.TRUE..//.IGNORABLE.CHARACTERS#0A..4CASE.'*c
':#0A..4CASE.'*t':#0A..4CASE.'*s':#0A..13rch().REPE
ATWHILE.ch#3D'*s'#0A..13LOOP#0A#0A..4CASE.'0':CASE.
'1':CASE.'2':CASE.'3':CASE.'4':#0A..4CASE.'5':CASE.
'6':CASE.'7':CASE.'8':CASE.'9':#0A..12readdecimal()
#0A..12//.token.is.either.s_number.or.s_fnum#0A..12
//.and.decval.and.exponent.are.both.set#0A..12RETUR
N#0A.#0A..4CASE.'a':CASE.'b':CASE.'c':CASE.'d':CASE
.'e':#0A..4CASE.'f':CASE.'g':CASE.'h':CASE.'i':CASE
.'j':#0A..4CASE.'k':CASE.'l':CASE.'m':CASE.'n':CASE
.'o':#0A..4CASE.'p':CASE.'q':CASE.'r':CASE.'s':CASE
.'t':#0A..4CASE.'u':CASE.'v':CASE.'w':CASE.'x':CASE
.'y':#0A..4CASE.'z':#0A..4CASE.'A':CASE.'B':CASE.'C
':CASE.'D':CASE.'E':#0A..4CASE.'F':CASE.'G':CASE.'H
':CASE.'I':CASE.'J':#0A..4CASE.'K':CASE.'L':CASE.'M
':CASE.'N':CASE.'O':#0A..4CASE.'P':CASE.'Q':CASE.'R
':CASE.'S':CASE.'T':#0A..4CASE.'U':CASE.'V':CASE.'W
':CASE.'X':CASE.'Y':#0A..4CASE.'Z':#0A..12token.:#3D
.lookupword(rdtag(ch))#0A..12SWITCHON.token.INTO#0A
..12{.DEFAULT:.RETURN#0A#0A..14CASE.s_get:..perform
get();.LOOP#0A#0A..14CASE.s_bitsperbcplword:#0A..16
token.:#3D.s_number#0A..16decval.:#3D.bits(-1)#0A..
16RETURN#0A#0A..14//.Some.operators.words.that.can.
become.assignment.operators#0A#0A..14CASE.s_rem:..2
assop.:#3D.s_assrem;..2GOTO.checkass#0A..14CASE.s_l
shift:.assop.:#3D.s_asslshift;.GOTO.checkass#0A..14
CASE.s_rshift:.assop.:#3D.s_assrshift;.GOTO.checkas
s#0A..14CASE.s_logand:.assop.:#3D.s_asslogand;.GOTO
.checkass#0A..14CASE.s_logor:..assop.:#3D.s_asslogo
r;..GOTO.checkass#0A..14CASE.s_eqv:..2assop.:#3D.s_
asseqv;..2GOTO.checkass#0A..14CASE.s_neqv:..1assop.
:#3D.s_assneqv;..1GOTO.checkass#0A..12}#0A#0A.#0A..
4CASE.'$':#0A..12rch()#0A..12IF.ch#3D'$'.|.ch#3D'<'
.|.ch#3D'>'.DO#0A..12{.LET.k.#3D.ch#0A..14token.:#3D
.lookupword(rdtag('<'))#0A..14//.token.#3D.s_true..
11if.the.tag.is.set#0A..14//..4#3D.s_false.or.s_nam
e..otherwise#0A.#0A..14//.$>tag..1marks.the.end.of.
a.conditional#0A..14//..7skipping.section#0A..14IF.
k#3D'>'.DO#0A..14{.IF.skiptag#3Dwordnode.DO#0A..20s
kiptag.:#3D.0..1//.Matching.$>tag.found#0A..16LOOP#0A
..14}#0A.#0A..14UNLESS.skiptag#3D0.LOOP#0A#0A..14//
.Only.process.$<tag.and.$$tag.if.not.skipping#0A.#0A
..14//.$$tag..complements.the.value.of.a.tag#0A..14
IF.k#3D'$'.DO#0A..14{.h1!wordnode.:#3D.token#3Ds_tr
ue.->.s_false,.s_true#0A..16LOOP#0A..14}#0A.#0A..14
//.$<tag#0A..14IF.token#3Ds_true.LOOP..4//.Don't.sk
ip.if.set#0A#0A..14//.tag.is.false.so.skip.until.ma
tching.$>tag.or.EOF#0A..14skiptag.:#3D.wordnode#0A.
.14UNTIL.skiptag#3D0.|.token#3Ds_dot.|.token#3Ds_eo
f.DO.lex()#0A..14skiptag.:#3D.0#0A..14RETURN#0A..12
}#0A.#0A..12UNLESS.ch#3D'('.|.ch#3D')'.DO.synerr("'
$'.out.of.context")#0A..12token.:#3D.ch#3D'('.->.s_
lsect,.s_rsect#0A..12lookupword(rdtag('$'))#0A..12R
ETURN#0A.#0A..4CASE.'{':.token,.wordnode.:#3D.s_lse
ct,.nulltag;.BREAK#0A..4CASE.'}':.token,.wordnode.:
#3D.s_rsect,.nulltag;.BREAK#0A#0A..4CASE.'#23':#0A.
.12token.:#3D.s_number#0A..12rch()#0A..12IF.'0'<#3D
ch<#3D'7'.DO#0A..12{.decval.:#3D.readnumber(.8,.100
)#0A..14RETURN#0A..12}#0A..12IF.ch#3D'b'.|.ch#3D'B'
.DO#0A..12{.rch()#0A..14decval.:#3D.readnumber(.2,.
100)#0A..14RETURN#0A..12}#0A..12IF.ch#3D'o'.|.ch#3D
'O'.DO#0A..12{.rch()#0A..14decval.:#3D.readnumber(.
8,.100)#0A..14RETURN#0A..12}#0A..12IF.ch#3D'x'.|.ch
#3D'X'.DO#0A..12{.rch()#0A..14decval.:#3D.readnumbe
r(16,.100)#0A..14RETURN#0A..12}#0A..12IF.ch#3D'('.D
O#0A..12{.token.:#3D.s_mthap#0A..14RETURN#0A..12}#0A
..12UNLESS.ch<32.DO#0A..12{.lex()#0A..14SWITCHON.to
ken.INTO#0A..14{.DEFAULT:..4ENDCASE#0A#0A..16CASE.s
_abs:..4token.:#3D.s_fabs;..4RETURN#0A#0A..16CASE.s
_mul.:..3token.:#3D.s_fmul;..4RETURN#0A..16CASE.s_d
iv:..4token.:#3D.s_fdiv;..4RETURN#0A..16CASE.s_add:
..4token.:#3D.s_fadd;..4RETURN#0A..16CASE.s_sub:..4
token.:#3D.s_fsub;..4RETURN#0A#0A..16CASE.s_assmul:
..1token.:#3D.s_assfmul;..1RETURN#0A..16CASE.s_assd
iv:..1token.:#3D.s_assfdiv;..1RETURN#0A..16CASE.s_a
ssadd:..1token.:#3D.s_assfadd;..1RETURN#0A..16CASE.
s_ass1ub:..1token.:#3D.s_assfsub;..1RETURN#0A#0A..1
6CASE.s_eq:..5token.:#3D.s_feq;..5RETURN#0A..16CASE
.s_ne:..5token.:#3D.s_fne;..5RETURN#0A..16CASE.s_ls
:..5token.:#3D.s_fls;..5RETURN#0A..16CASE.s_le:..5t
oken.:#3D.s_fle;..5RETURN#0A..16CASE.s_gr:..5token.
:#3D.s_fgr;..5RETURN#0A..16CASE.s_ge:..5token.:#3D.
s_fge;..5RETURN#0A..14}#0A..12}#0A..12synerr("'#23'
.out.of.context")#0A#0A..4CASE.'[':.token.:#3D.s_sb
ra;..4BREAK#0A..4CASE.']':.token.:#3D.s_sket;..4BRE
AK#0A..4CASE.'(':.token.:#3D.s_lparen;..2BREAK#0A..
4CASE.')':.token.:#3D.s_rparen;..2BREAK.#0A..4CASE.
'?':.token.:#3D.s_query;..3BREAK#0A..4CASE.',':.tok
en.:#3D.s_comma;..3BREAK#0A..4CASE.';':.token.:#3D.
s_semicolon;.BREAK#0A..4CASE.'@':.token.:#3D.s_lv;.
.6BREAK#0A..4CASE.'#3D':.token.:#3D.s_eq;..6BREAK#0A
..4CASE.'%':.token.:#3D.s_byteap;..2BREAK#0A..4CASE
.'#2E':.token.:#3D.s_dot;..5BREAK#0A#0Acheckassx:..
4rch()#0Acheckass:..5UNLESS.ch#3D':'.RETURN#0A..14r
ch()#0A..14UNLESS.ch#3D'#3D'.DO.synerr("Bad.assignm
ent.operator")#0A..14token.:#3D.assop#0A..14BREAK#0A
.#0A..4CASE.'!':.token,.assop.:#3D.s_vecap,.s_assve
cap;..1GOTO.checkassx#0A..4CASE.'**':token,.assop.:
#3D.s_mul,.s_assmul;..5GOTO.checkassx#0A..4CASE.'+'
:.token,.assop.:#3D.s_add,.s_assadd;..3GOTO.checkas
sx#0A..4CASE.'&':.token,.assop.:#3D.s_logand,.s_ass
logand;.GOTO.checkassx#0A..4CASE.'|':.token,.assop.
:#3D.s_logor,.s_asslogor;..1GOTO.checkassx#0A.#0A..
4CASE.'/':#0A..12rch()#0A..12IF.ch#3D'\'.DO#0A..12{
.token,.assop.:#3D.s_logand,.s_asslogand#0A..14GOTO
.checkassx#0A..12}#0A..12IF.ch#3D'/'.DO#0A..12{.rch
().REPEATUNTIL.ch#3D'*n'.|.ch#3Dendstreamch#0A..14L
OOP#0A..12}#0A.#0A..12IF.ch#3D'**'.DO#0A..12{.LET.d
epth.#3D.1#0A#0A..14{.rch()#0A..16IF.ch#3D'**'.DO#0A
..16{.rch().REPEATWHILE.ch#3D'**'#0A..18IF.ch#3D'/'
.DO.{.depth.:#3D.depth-1;.LOOP.}#0A..16}#0A..16IF.c
h#3D'/'.DO#0A..16{.rch()#0A..18IF.ch#3D'**'.DO.{.de
pth.:#3D.depth+1;.LOOP.}#0A..16}#0A..16IF.ch#3D'*n'
.DO.lineno.:#3D.lineno+1#0A..16IF.ch#3Dendstreamch.
DO.synerr("Missing.'**/'")#0A..14}.REPEATUNTIL.dept
h#3D0#0A#0A..14rch()#0A..14LOOP#0A..12}#0A#0A..12to
ken,.assop.:#3D.s_div,.s_assdiv#0A..12GOTO.checkass
#0A.#0A..4CASE.'~':#0A..12rch()#0A..12IF.ch#3D'#3D'
.DO.{.token.:#3D.s_ne;..3BREAK.}#0A..12token.:#3D.s
_not#0A..12RETURN#0A.#0A..4CASE.'\':#0A..12rch()#0A
..12IF.ch#3D'/'.DO#0A..12{.token,.assop.:#3D.s_logo
r,.s_asslogor#0A..14GOTO.checkassx#0A..12}#0A..12IF
.ch#3D'#3D'.DO.{.token.:#3D.s_ne;..3BREAK.}#0A..12t
oken.:#3D.s_not#0A..12RETURN#0A.#0A..4CASE.'<':.rch
()#0A..12IF.ch#3D'#3D'.DO.{.token.:#3D.s_le;..3BREA
K.}#0A..12IF.ch#3D'<'.DO#0A..12{.token,.assop.:#3D.
s_lshift,.s_asslshift#0A..14GOTO.checkassx#0A..12}#0A
..12IF.ch#3D'>'.DO.{.token.:#3D.s_seq;..2BREAK.}#0A
..12token.:#3D.s_ls#0A..12RETURN#0A.#0A..4CASE.'>':
.rch()#0A..12IF.ch#3D'#3D'.DO.{.token.:#3D.s_ge;..3
BREAK.}#0A..12IF.ch#3D'>'.DO#0A..12{.token,.assop.:
#3D.s_rshift,.s_assrshift#0A..14GOTO.checkassx#0A..
12}#0A..12token.:#3D.s_gr#0A..12RETURN#0A.#0A..4CAS
E.'-':.rch()#0A..12IF.ch#3D'>'.DO.{.token.:#3D.s_co
nd;.BREAK..}#0A..12token,.assop.:#3D.s_sub,.s_ass1u
b#0A..12GOTO.checkass#0A.#0A..4CASE.':':.rch()#0A..
12IF.ch#3D'#3D'.DO.{.token.:#3D.s_ass;.BREAK..}#0A.
.12IF.ch#3D':'.DO.{.token.:#3D.s_of;..BREAK..}..//.
Inserted.11/7/01#0A..12token.:#3D.s_colon#0A..12RET
URN#0A.#0A..4CASE.'"':#0A..9{.LET.len.#3D.0#0A..11r
ch()#0A..11encoding.:#3D.defaultencoding.//.encodin
g.for.*#23.escapes#0A#0A..11UNTIL.ch#3D'"'.DO#0A..1
1{.LET.code.#3D.rdstrch()#0A..13TEST.result2#0A..13
THEN.{.//.A..*#23.code.found#2E#0A..20//.Convert.it
.to.UTF8.or.GB2312.format#2E#0A..20TEST.encoding#3D
GB2312#0A..20THEN.{.//.Convert.to.GB2312.sequence#0A
..27IF.code>#23x7F.DO#0A..27{.LET.hi.#3D.code../..0
00100.+.160#0A..29LET.lo.#3D.code.MOD.100.+.160#0A.
.29IF.len>#3D254.DO.synerr("Bad.string.constant")#0A
..29TEST.bigender#0A..29THEN.{.charv%(len+1).:#3D.h
i.#0A..36charv%(len+2).:#3D.lo#0A..34}#0A..29ELSE.{
.charv%(len+1).:#3D.lo.#0A..36charv%(len+2).:#3D.hi
#0A..34}#0A..29len.:#3D.len.+.2#0A..29LOOP#0A..27}#0A
..27IF.len>#3D255.DO.synerr("Bad.string.constant")#0A
..27charv%(len+1).:#3D.code.//.Ordinary.ASCII.char#0A
..27len.:#3D.len.+.1#0A..27LOOP#0A..25}#0A..20ELSE.
{.//.Convert.to.UTF8.sequence#0A..27IF.code<#3D#23x
7F.DO#0A..27{.IF.len>#3D255.DO.synerr("Bad.string.c
onstant")#0A..29charv%(len+1).:#3D.code..1//.0xx5#0A
..29len.:#3D.len.+.1#0A..29LOOP#0A..27}#0A..27IF.co
de<#3D#23x7FF.DO#0A..27{.IF.len>#3D254.DO.synerr("B
ad.string.constant")#0A..29charv%(len+1).:#3D.#23b1
100000_002+(code>>0006)..//.110000xx3#0A..29charv%(
len+2).:#3D.#23x80+(.code..2&#23x3F)..//.10xx4#0A..
29len.:#3D.len.+.2#0A..29LOOP#0A..27}#0A..27IF.code
<#3D#23xFF2.DO#0A..27{.IF.len>#3D253.DO.synerr("Bad
.string.constant")#0A..29charv%(len+1).:#3D.#23b110
010_002+(code>>00012).//.110010xx2#0A..29charv%(len
+2).:#3D.#23x80+((code>>0006)&#23x3F)..//.10xx4#0A.
.29charv%(len+3).:#3D.#23x80+(.code..2&#23x3F)..//.
10xx4#0A..29len.:#3D.len.+.3#0A..29LOOP#0A..27}#0A.
.27IF.code<#3D#23x1F_FF2.DO#0A..27{.IF.len>#3D252.D
O.synerr("Bad.string.constant")#0A..29charv%(len+1)
.:#3D.#23b112_002+(code>>00018).//.110020xx1#0A..29
charv%(len+2).:#3D.#23x80+((code>>00012)&#23x3F).//
.10xx4#0A..29charv%(len+3).:#3D.#23x80+((code>>.6)&
#23x3F).//.10xx4#0A..29charv%(len+4).:#3D.#23x80+(.
code..3&#23x3F).//.10xx4#0A..29len.:#3D.len.+.4#0A.
.29LOOP#0A..27}#0A..27IF.code<#3D#23x3FF_FF2.DO#0A.
.27{.IF.len>#3D251.DO.synerr("Bad.string.constant")
#0A..29charv%(len+1).:#3D.#23b112_1001+(code>>00024
).//.110030xx#0A..29charv%(len+2).:#3D.#23x80+((cod
e>>00018)&#23x3F).//.10xx4#0A..29charv%(len+3).:#3D
.#23x80+((code>>00012)&#23x3F).//.10xx4#0A..29charv
%(len+4).:#3D.#23x80+((code>>.6)&#23x3F).//.10xx4#0A
..29charv%(len+5).:#3D.#23x80+(.code..3&#23x3F).//.
10xx4#0A..29len.:#3D.len.+.5#0A..29LOOP#0A..27}#0A.
.27IF.code<#3D#23x7FF1_FF2.DO#0A..27{.IF.len>#3D250
.DO.synerr("Bad.string.constant")#0A..29charv%(len+
1).:#3D.#23b112_1100000+(code>>00030).//.110040x#0A
..29charv%(len+2).:#3D.#23x80+((code>>00024)&#23x3F
).//.10xx4#0A..29charv%(len+3).:#3D.#23x80+((code>>
00018)&#23x3F).//.10xx4#0A..29charv%(len+4).:#3D.#23
x80+((code>>00012)&#23x3F).//.10xx4#0A..29charv%(le
n+5).:#3D.#23x80+((code>>.6)&#23x3F).//.10xx4#0A..2
9charv%(len+6).:#3D.#23x80+(.code..3&#23x3F).//.10x
x4#0A..29len.:#3D.len.+.6#0A..29LOOP#0A..27}#0A..27
synerr("Bad.Unicode.character")#0A..25}#0A..18}#0A.
.13ELSE.{.//.Not.a.Unicode.character#0A..20IF.len#3D
255.DO.synerr("Bad.string.constant")#0A..20len.:#3D
.len.+.1#0A..20charv%len.:#3D.code#0A..18}#0A..11}#0A
.#0A..11charv%0.:#3D.len#0A..11wordnode.:#3D.newvec
(len/bytesperword+2)#0A..11h1!wordnode.:#3D.s_strin
g#0A..11FOR.i.#3D.0.TO.len.DO.(@h2!wordnode)%i.:#3D
.charv%i#0A..11token.:#3D.s_string#0A..11BREAK#0A..
8}#0A.#0A..4CASE.'*'':#0A..12rch()#0A..12encoding.:
#3D.defaultencoding#0A..12decval.:#3D.rdstrch()#0A.
.12token.:#3D.s_number#0A..12UNLESS.ch#3D'*''.DO.sy
nerr("Bad.character.constant")#0A..12BREAK#0A.#0A.#0A
..4CASE.endstreamch:#0A..12IF.getstreams.DO#0A..12{
.//.Return.from.a.'GET'.stream#0A..14LET.p.#3D.gets
treams#0A..14endread()#0A..14ch..9:#3D.h4!getstream
s#0A..14lineno..5:#3D.h3!getstreams#0A..14sourcestr
eam.:#3D.h2!getstreams#0A..14getstreams..1:#3D.h1!g
etstreams#0A..14freevec(p).//.Free.the.GET.node#0A.
.14selectinput(sourcestream)#0A..14LOOP#0A..12}#0A.
.12//.endstreamch.#3D>.EOF.only.at.outermost.GET.le
vel.#0A..12token.:#3D.s_eof#0A..12RETURN#0A..2}#0A.
.}.REPEAT#0A.#0A..rch()#0A}#0A.#0ALET.lookupword(wo
rd).#3D.VALOF#0A{.LET.len,.i.#3D.word%0,.0#0A..LET.
hashval.#3D.19609.//.This.and.31397.are.primes#2E#0A
..FOR.j.#3D.0.TO.len.DO.hashval.:#3D.(hashval.NEQV.
word%j).*.31397#0A..hashval.:#3D.(hashval>>0001).RE
M.nametablesize#0A#0A..wordnode.:#3D.nametable!hash
val#0A.#0A..UNTIL.wordnode#3D0.|.i>len.TEST.(@h3!wo
rdnode)%i#3Dword%i#0A..25THEN.i.:#3D.i+1#0A..25ELSE
.wordnode,.i.:#3D.h2!wordnode,.0#0A.#0A..UNLESS.wor
dnode.DO#0A..{.wordnode.:#3D.newvec(len/bytesperwor
d+2)#0A..2h1!wordnode,.h2!wordnode.:#3D.s_name,.nam
etable!hashval#0A..2FOR.i.#3D.0.TO.len.DO.(@h3!word
node)%i.:#3D.word%i#0A..2nametable!hashval.:#3D.wor
dnode#0A..}#0A.#0A..RESULTIS.h1!wordnode#0A}#0A.#0A
LET.eqlookupword(word).#3D.VALOF#0A{.//.This.versio
n.equates.the.cases.but.keeps.the.cases.of#0A..//.t
he.first.word.encountered#2E.If.EQCASES.is.given.th
is.version#0A..//.replaces.lookupword#2E#0A..LET.le
n,.i.#3D.word%0,.0#0A..LET.hashval.#3D.19609.//.Thi
s.and.31397.are.primes#2E#0A..//.This.hash.function
.ignores.the.case.of.letters#2E#0A..FOR.j.#3D.0.TO.
len.DO.hashval.:#3D.(hashval.NEQV.(word%j.&.31)).*.
31397#0A..hashval.:#3D.(hashval>>0001).REM.nametabl
esize#0A#0A..wordnode.:#3D.nametable!hashval#0A.#0A
..UNTIL.wordnode#3D0.|.i>len.TEST.compch((@h3!wordn
ode)%i,.word%i)#3D0#0A..25THEN.i.:#3D.i+1#0A..25ELS
E.wordnode,.i.:#3D.h2!wordnode,.0#0A.#0A..UNLESS.wo
rdnode.DO#0A..{.wordnode.:#3D.newvec(len/bytesperwo
rd+2)#0A..2h1!wordnode,.h2!wordnode.:#3D.s_name,.na
metable!hashval#0A..2FOR.i.#3D.0.TO.len.DO.(@h3!wor
dnode)%i.:#3D.word%i#0A..2nametable!hashval.:#3D.wo
rdnode#0A..}#0A.#0A..RESULTIS.h1!wordnode#0A}#0A.#0A
AND.dsw(word,.sym).BE.{.lookupword(word);.h1!wordno
de.:#3D.sym..}#0A.#0AAND.declsyswords().BE#0A{.dsw(
"AND",.s_and)#0A..dsw("ABS",.s_abs)#0A..dsw("BE",.s
_be)#0A..dsw("BITSPERBCPLWORD",.s_bitsperbcplword)#0A
..dsw("BREAK",.s_break)#0A..dsw("BY",.s_by)#0A..dsw
("CASE",.s_case)#0A..dsw("DO",.s_do)#0A..dsw("DEFAU
LT",.s_default)#0A..dsw("EQ",.s_eq)#0A..dsw("EQV",.
s_eqv)#0A..dsw("ELSE",.s_else)#0A..dsw("ENDCASE",.s
_endcase)#0A..dsw("FABS",.s_fabs)#0A..dsw("FALSE",.
s_false)#0A..dsw("FINISH",.s_finish)#0A..dsw("FIX",
.s_fix)#0A..dsw("FLOAT",.s_float)#0A..dsw("FOR",.s_
for)#0A..dsw("GOTO",.s_goto)#0A..dsw("GE",.s_ge)#0A
..dsw("GR",.s_gr)#0A..dsw("GLOBAL",.s_global)#0A..d
sw("GET",.s_get)#0A..dsw("IF",.s_if)#0A..dsw("INTO"
,.s_into)#0A..dsw("LET",.s_let)#0A..dsw("LV",.s_lv)
#0A..dsw("LE",.s_le)#0A..dsw("LS",.s_ls)#0A..dsw("L
OGOR",.s_logor)#0A..dsw("LOGAND",.s_logand)#0A..dsw
("LOOP",.s_loop)#0A..dsw("LSHIFT",.s_lshift)#0A..ds
w("MANIFEST",.s_manifest)#0A..dsw("MOD",.s_rem)#0A.
.dsw("NE",.s_ne)#0A..dsw("NEEDS",.s_needs)#0A..dsw(
"NEQV",.s_neqv)#0A..dsw("NOT",.s_not)#0A..dsw("OF",
.s_of)..17//.Inserted.11/7/01#0A..dsw("OR",.s_else)
#0A..dsw("RESULTIS",.s_resultis)#0A..dsw("RETURN",.
s_return)#0A..dsw("REM",.s_rem)#0A..dsw("RSHIFT",.s
_rshift)#0A..dsw("RV",.s_rv)#0A..dsw("REPEAT",.s_re
peat)#0A..dsw("REPEATWHILE",.s_repeatwhile)#0A..dsw
("REPEATUNTIL",.s_repeatuntil)#0A..dsw("SECTION",.s
_section)#0A..dsw("SLCT",.s_slct)..13//.Inserted.11
/7/01#0A..dsw("STATIC",.s_static)#0A..dsw("SWITCHON
",.s_switchon)#0A..dsw("TO",.s_to)#0A..dsw("TEST",.
s_test)#0A..dsw("TRUE",.s_true)#0A..dsw("THEN",.s_d
o)#0A..dsw("TABLE",.s_table)#0A..dsw("UNLESS",.s_un
less)#0A..dsw("UNTIL",.s_until)#0A..dsw("VEC",.s_ve
c)#0A..dsw("VALOF",.s_valof)#0A..dsw("WHILE",.s_whi
le)#0A..dsw("XOR",.s_neqv)#0A..dsw("$",.0)#0A.#0A..
nulltag.:#3D.wordnode#0A}.#0A.#0ALET.rch().BE#0A{.c
h.:#3D.rdch()#0A..chcount.:#3D.chcount.+.1#0A..chbu
f%(chcount&63).:#3D.ch#0A}#0A.#0AAND.wrchbuf().BE#0A
{.writes("*n#2E#2E1")#0A..FOR.p.#3D.chcount-63.TO.c
hcount.DO#0A..{.LET.k.#3D.chbuf%(p&63)#0A..2IF.0<k<
255.DO.wrch(k)#0A..}#0A..newline()#0A}#0A.#0A.#0AAN
D.rdtag(ch1).#3D.VALOF#0A{.LET.len.#3D.1#0A..//1IF.
eqcases.&.'a'<#3Dch1<#3D'z'.DO.ch1.:#3D.ch1.+.'A'.-
.'a'#0A..charv%1.:#3D.ch1#0A.#0A..{.rch()#0A..2UNLE
SS.'a'<#3Dch<#3D'z'.|.'A'<#3Dch<#3D'Z'.|#0A..9'0'<#3D
ch<#3D'9'.|.ch#3D'#2E'.|.ch#3D'_'.BREAK#0A..2//1IF.
eqcases.&.'a'<#3Dch<#3D'z'.DO.ch.:#3D.ch.+.'A'.-.'a
'#0A..2len.:#3D.len+1#0A..2charv%len.:#3D.ch#0A..}.
REPEAT#0A.#0A..charv%0.:#3D.len#0A..RESULTIS.charv#0A
}#0A#0AAND.catstr(s1,.s2).#3D.VALOF#0A//.Concatenat
e.strings.s1.and.s2.leaving.the.result.in.s1#2E#0A/
/.s1.is.assumed.to.be.able.to.hold.a.string.of.leng
th.255#2E#0A//.The.resulting.string.is.truncated.to
.length.255,.if.necessary#2E.#0A{.LET.len.#3D.s1%0#0A
..LET.n.#3D.len#0A..FOR.i.#3D.1.TO.s2%0.DO#0A..{.n.
:#3D.n+1#0A..2IF.n>255.BREAK#0A..2s1%n.:#3D.s2%i#0A
..}#0A..s1%0.:#3D.n#0A}.#0A.#0AAND.performget().BE#0A
{.LET.stream.#3D.?#0A..LET.len.#3D.0#0A..lex()#0A..
UNLESS.token#3Ds_string.DO.synerr("Bad.GET.directiv
e")#0A..len.:#3D.charv%0#0A#0A..//.Append.#2Eh.to.t
he.GET.filename.does.not.end.in.#2Eh.or.#2Eb#0A..UN
LESS.len>#3D2.&.charv%(len-1)#3D'#2E'.&.#0A..7(char
v%len#3D'h'.|.charv%len#3D'b').DO#0A..{.len.:#3D.le
n+2#0A..2charv%0,.charv%(len-1),.charv%len.:#3D.len
,.'#2E',.'h'#0A..}#0A#0A..//.Treat.filenames.like.s
ys:xx1.as.sys/xx1.--.deprecated.feature.#0A..FOR.i.
#3D.1.TO.charv%0.IF.charv%i#3D':'.DO.charv%i.:#3D.'
/'#0A#0A..//.First.look.in.the.current.directory#0A
..//writef("Searching.for.*"%s*".in.the.current.dir
ectory*n",.charv)#0A..stream.:#3D.pathfindinput(cha
rv,.0)#0A#0A1..//.Then.try.the.headers.directories#0A
..//UNLESS.stream.DO.sawritef("Searching.for.*"%s*"
.in.%s*n",.charv,.hdrs)#0A..//.The.value.of.hdrs.is
.typically:.#2E#2E3/BCPL/cintcode/g#0A..UNLESS.stre
am.DO.stream.:#3D.pathfindinput(charv,.hdrs)#0A#0A.
.UNLESS.stream.DO#0A..{.synerr("Unable.to.find.GET.
file.%s",.charv)#0A..2RETURN#0A..}#0A#0A..IF.source
fileno>#3Dsourcefileupb.DO#0A..{.synerr("Too.many.G
ET.files")#0A..2RETURN#0A..}#0A#0A..{.LET.len.#3D.c
harv%0#0A..2LET.node.#3D.getvec(3)..//.Freed.at.end
.of.GET.insertion#0A..2LET.str..#3D.getvec(len/byte
sperword).//.Freed.at.end.of.compilation#0A#0A..2UN
LESS.node.&.str.DO#0A..2{.IF.node.DO.freevec(node)#0A
..4IF.str..DO.freevec(str)#0A..4synerr("getvec.fail
ure.in.performget")#0A..2}#0A..2FOR.i.#3D.0.TO.len.
DO.str%i.:#3D.charv%i#0A..2sourcefileno.:#3D.source
fileno+1#0A..2sourcenamev!sourcefileno.:#3D.str#0A/
/sawritef("performget:.file.%n.is.%s*n",.sourcefile
no,.str)#0A..2node!0,.node!1,.node!2,.node!3.:#3D.g
etstreams,.sourcestream,.lineno,.ch#0A..2getstreams
.:#3D.node#0A..}#0A..sourcestream.:#3D.stream#0A..s
electinput(sourcestream)#0A..lineno.:#3D.(sourcefil
eno<<00020).+.1#0A..rch()#0A}#0A#0AAND.readdecimal(
).BE#0A{.//.Read.an.integer.or.floating.point.const
ant#0A..//.setting.token.to.s_number.or.s_fnum#0A..
//.It.sets.decval.to.the.integer.or.mantissa#0A..//
.and.exponent.to.the.exponent.is.a.floating.point#0A
..//.constant.was.found#0A..LET.zcount.#3D.0..2//.N
umber.of.consecutive.zeroes#0A..LET.pos.#3D.0..5//.
Number.of.digits.after.'#2E'#0A#0A..token.:#3D.s_nu
mber.//.Until.'#2E'.or.'e'.encountered#0A..decval,.
exponent.:#3D.0,.0#0A#0A..UNLESS.'0'<#3Dch<#3D'9'.D
O.synerr("Bad.number")#0A#0A..//.Ignore.leading.zer
oes#0A..WHILE.ch#3D'0'.DO.rch()#0A#0A..WHILE.'0'<#3D
ch<#3D'9'.|.ch#3D'_'.|.ch#3D'#2E'.DO#0A..{.SWITCHON
.ch.INTO#0A..2{.DEFAULT:.BREAK#0A#0A..4CASE.'1':.CA
SE.'2':.CASE.'3':.CASE.'4':.#0A..4CASE.'5':.CASE.'6
':.CASE.'7':.CASE.'8':.CASE.'9':#0A..6IF.token#3Ds_
fnum.DO.pos.:#3D.pos+1#0A..6//.Be.careful.with.over
flow#0A..6{.IF.decval>maxint/10.GOTO.digitzero#0A..
8decval.:#3D.10*decval#0A..8UNLESS.zcount.BREAK#0A.
.8zcount.:#3D.zcount-1#0A..6}.REPEAT#0A..6IF.decval
.>.maxint.-.(ch.-.'0').ENDCASE#0A..6decval.:#3D.dec
val.+.ch.-.'0'#0A..6ENDCASE#0A#0A..4CASE.'0':#0A..6
IF.token#3Ds_fnum.DO.pos.:#3D.pos+1#0Adigitzero:#0A
..6zcount.:#3D.zcount+1#0A..4CASE.'_':#0A..6ENDCASE
#0A#0A..4CASE.'#2E':.#0A..6IF.token#3Ds_fnum.DO.syn
err("Bad.floating.point.constant")#0A..6token.:#3D.
s_fnum#0A..6ENDCASE#0A..2}#0A..2rch()#0A..}#0A..IF.
ch#3D'e'.|.ch#3D'E'.DO#0A..{.LET.expneg.#3D.FALSE#0A
..2token.:#3D.s_fnum#0A..2rch()#0A..2IF.ch#3D'-'.DO
.{.expneg.:#3D.TRUE;.rch().}#0A..2WHILE.'0'<#3Dch<#3D
'9'.|.ch#3D'_'.DO#0A..2{.UNLESS.ch#3D'_'.DO.exponen
t.:#3D.10*exponent.+.ch-'0'#0A..4rch()#0A..2}#0A..2
IF.expneg.DO.exponent.:#3D.-exponent#0A..}#0A..IF.t
oken#3Ds_number.DO#0A..{.//.Deal.with.trailing.zero
es#0A..2WHILE.zcount.DO.decval,.zcount.:#3D.10*decv
al,.zcount-1#0A..2RETURN#0A..}#0A..//.Correct.the.e
xponent#0A..exponent.:#3D.exponent.+.zcount.-.pos#0A
}#0A#0AAND.readnumber(radix,.digs).#3D.VALOF#0A//.R
ead.a.binary,.octal,.decimal.or.hexadecimal.unsigne
d.number#0A//.with.between.1.and.digs.digits#2E.Und
erlines.are.allowed#2E#0A//.This.function.is.used.f
or.numerical.constants.and.numerical#0A//.escapes.i
n.string.and.character.constants#2E#0A{.LET.i,.res.
#3D.0,.0#0A.#0A..{.UNLESS.ch#3D'_'.DO.//.ignore.und
erlines#0A..2{.LET.d.#3D.value(ch)#0A..4IF.d>#3Drad
ix.BREAK#0A..4i.:#3D.i+1..5//.Increment.count.of.di
gits#0A..4res.:#3D.radix*res.+.d#0A..2}#0A..2rch()#0A
..}.REPEATWHILE.i<digs#0A#0A..UNLESS.i.DO.synerr("B
ad.number")#0A..RESULTIS.res#0A}#0A.#0A.#0AAND.valu
e(ch).#3D.'0'<#3Dch<#3D'9'.->.ch-'0',#0A..14'A'<#3D
ch<#3D'F'.->.ch-'A'+10,#0A..14'a'<#3Dch<#3D'f'.->.c
h-'a'+10,#0A..014100#0A.#0AAND.rdstrch().#3D.VALOF#0A
{.//.Return.the.integer.code.for.the.next.string.ch
aracter#0A..//.Set.result2#3DTRUE.if.*#23.character
.code.was.found,.otherwise.FALSE#0A..LET.k.#3D.ch#0A
#0A..IF.k#3D'*n'.|.k#3D'*p'.DO#0A..{.lineno.:#3D.li
neno+1#0A..2synerr("Unescaped.newline.character")#0A
..}#0A.#0A..IF.k#3D'**'.DO#0A..{.rch()#0A..2k.:#3D.
ch#0A..2IF.'a'<#3Dk<#3D'z'.DO.k.:#3D.k.+.'A'.-.'a'#0A
..2SWITCHON.k.INTO#0A..2{.CASE.'*n':#0A..4CASE.'*c'
:#0A..4CASE.'*p':#0A..4CASE.'*s':#0A..4CASE.'*t':.W
HILE.ch#3D'*n'.|.ch#3D'*c'.|.ch#3D'*p'.|.ch#3D'*s'.
|.ch#3D'*t'.DO#0A..15{.IF.ch#3D'*n'.DO.lineno.:#3D.
lineno+1#0A..17rch()#0A..15}#0A..15IF.ch#3D'**'.DO.
{.rch();.LOOP..}#0A#0A..4DEFAULT:..1synerr("Bad.str
ing.or.character.constant,.ch#3D%n",.ch)#0A..7#0A..
4CASE.'**':#0A..4CASE.'*'':#0A..4CASE.'"':..18ENDCA
SE#0A..7#0A..4CASE.'T':..k.:#3D.c_tab;..5ENDCASE#0A
..4CASE.'S':..k.:#3D.c_space;..3ENDCASE#0A..4CASE.'
N':..k.:#3D.c_newline;..1ENDCASE#0A..4CASE.'E':..k.
:#3D.c_escape;..2ENDCASE#0A..4CASE.'B':..k.:#3D.c_b
ackspace;.ENDCASE#0A..4CASE.'P':..k.:#3D.c_newpage;
..1ENDCASE#0A..4CASE.'C':..k.:#3D.c_return;..2ENDCA
SE#0A..7#0A..4CASE.'X':..//.*xhh..--.A.character.es
cape.in.hexadecimal#0A..15rch()#0A..15k.:#3D.readnu
mber(16,2)#0A..15result2.:#3D.FALSE#0A..15RESULTIS.
k#0A#0A..4CASE.'#23':..//.*#23u..1set.UTF8.mode#0A.
.15//.*#23g..1set.GB2312.mode#0A..15//.In.UTF8.mode
#0A..15//..3*#23hh2.or.*#23#23hh6..--.a.Unicode.cha
racter#0A..15//.In.GB2312#0A..15//..3*#23dd2..15--.
A.GB2312.code#0A..13{.LET.digs.#3D.4#0A..15rch()#0A
..15IF.ch#3D'u'.|.ch#3D'U'.DO.{.encoding.:#3D.UTF8;
..1rch();.LOOP.}#0A..15IF.ch#3D'g'.|.ch#3D'G'.DO.{.
encoding.:#3D.GB2312;.rch();.LOOP.}#0A..15TEST.enco
ding#3DGB2312#0A..15THEN.{.#0A..22k.:#3D.readnumber
(10,.digs)#0A//sawritef("rdstrch:.GB2312:.%i4*n",.k
)#0A..20}#0A..15ELSE.{.IF.ch#3D'#23'.DO.{.rch();.di
gs.:#3D.8.}#0A..22k.:#3D.readnumber(16,.digs)#0A//s
awritef("rdstrch:.Unicode:.%x4*n",.k)#0A..20}#0A..1
5result2.:#3D.TRUE#0A..15RESULTIS.k#0A..13}#0A#0A..
4CASE.'0':CASE.'1':CASE.'2':CASE.'3':CASE.'4':#0A..
4CASE.'5':CASE.'6':CASE.'7':#0A..15//.*oo1.--.A.cha
racter.escape.in.octal.#0A..15k.:#3D.readnumber(8,3
)#0A..15IF.k>255.DO.#0A..21synerr("Bad.string.or.ch
aracter.constant")#0A..15result2.:#3D.FALSE#0A..15R
ESULTIS.k#0A..2}#0A..}#0A..1#0A..rch()#0A..result2.
:#3D.FALSE#0A..RESULTIS.k#0A}.REPEAT#0A#0ALET.newve
c(n).#3D.VALOF#0A{.treep.:#3D.treep.-.n.-.1;#0A..IF
.treep<#3Dtreevec.DO#0A..{.errmax.:#3D.0..//.Make.i
t.fatal#0A..2synerr("More.workspace.needed")#0A..}#0A
..RESULTIS.treep#0A}#0A.#0AAND.mk1(x).#3D.VALOF#0A{
.LET.p.#3D.newvec(0)#0A..p!0.:#3D.x#0A..RESULTIS.p#0A
}#0A.#0AAND.mk2(x,.y).#3D.VALOF#0A{.LET.p.#3D.newve
c(1)#0A..p!0,.p!1.:#3D.x,.y#0A..RESULTIS.p#0A}#0A.#0A
AND.mk3(x,.y,.z).#3D.VALOF#0A{.LET.p.#3D.newvec(2)#0A
..p!0,.p!1,.p!2.:#3D.x,.y,.z#0A..RESULTIS.p#0A}#0A.
#0AAND.mk4(x,.y,.z,.t).#3D.VALOF#0A{.LET.p.#3D.newv
ec(3)#0A..p!0,.p!1,.p!2,.p!3.:#3D.x,.y,.z,.t#0A..RE
SULTIS.p#0A}#0A.#0AAND.mk5(x,.y,.z,.t,.u).#3D.VALOF
#0A{.LET.p.#3D.newvec(4)#0A..p!0,.p!1,.p!2,.p!3,.p!
4.:#3D.x,.y,.z,.t,.u#0A..RESULTIS.p#0A}#0A.#0AAND.m
k6(x,.y,.z,.t,.u,.v).#3D.VALOF#0A{.LET.p.#3D.newvec
(5)#0A..p!0,.p!1,.p!2,.p!3,.p!4,.p!5.:#3D.x,.y,.z,.
t,.u,.v#0A..RESULTIS.p#0A}#0A.#0AAND.mk7(x,.y,.z,.t
,.u,.v,.w).#3D.VALOF#0A{.LET.p.#3D.newvec(6)#0A..p!
0,.p!1,.p!2,.p!3,.p!4,.p!5,.p!6.:#3D.x,.y,.z,.t,.u,
.v,.w#0A..RESULTIS.p#0A}#0A.#0AAND.formtree().#3D..
VALOF#0A{.LET.res.#3D.0#0A#0A..nametablesize.:#3D.5
41#0A#0A..charv..4:#3D.newvec(256/bytesperword)#0A.
.charv%0.:#3D.0#0A..nametable..:#3D.newvec(nametabl
esize).#0A..FOR.i.#3D.0.TO.nametablesize.DO.nametab
le!i.:#3D.0#0A..skiptag.:#3D.0#0A..declsyswords()#0A
.#0A..rec_p,.rec_l.:#3D.level(),.rec#0A.#0A..token,
.decval.:#3D.0,.0#0A#0A..lex()#0A//sawritef("formtr
ee:.token#3D%n.cis#3D%n*n",.token,.cis)#0A..IF.toke
n#3Ds_query.DO..10//.For.debugging.lex#2E#0A..{.LET
.ln,.name.#3D.?,.?#0A..2lex()#0A..2ln.:#3D.lineno.&
.#23xFF3#0A..2name.:#3D.opname(token)#0A#0A..2SWITC
HON.token.INTO#0A..2{.DEFAULT:#0A..6writef("token.#3D
%i3.ln#3D%i5.%12t..*n",..1token,.ln,.name)#0A..6END
CASE#0A#0A..4CASE.s_name:#0A..6writef("token.#3D%i3
.ln#3D%i5.%12t..%s*n",.token,.ln,.name,.@h3!wordnod
e)#0A..6ENDCASE..#0A#0A..4CASE.s_number:#0A..6write
f("token.#3D%i3.ln#3D%i5.%12t..%n*n",.token,.ln,.na
me,.decval)#0A..6ENDCASE..#0A#0A..4CASE.s_fnum:#0A.
.6writef("token.#3D%i3.ln#3D%i5.%12t..%ne%n*n",.tok
en,.ln,.name,#0A..14decval,.exponent)#0A..6ENDCASE.
.#0A#0A..4CASE.s_string:#0A..4{.LET.s.#3D.@h2!wordn
ode#0A..6writef("token.#3D%i3.ln#3D%i5.%12t.*"",.to
ken,.ln,.name)#0A..6FOR.i.#3D.1.TO.s%0.DO#0A..6{.LE
T.ch.#3D.s%i#0A..8SWITCHON.ch.INTO#0A..8{.DEFAULT:.
.3wrch(ch);..2LOOP#0A#0A..10CASE.'*n':.writes("**n"
);.LOOP#0A..10CASE.'*s':.writes("**s");.LOOP#0A..10
CASE.'*p':.writes("**p");.LOOP#0A..10CASE.'*t':.wri
tes("**t");.LOOP#0A..8}#0A..6}#0A..6writes("*"*n")#0A
..6ENDCASE#0A..4}..#0A..2}#0A#0A..2IF.token#3Ds_eof
.RESULTIS.0#0A..}.REPEAT#0A#0Arec:res.:#3D.token#3D
s_section.->.rprog(s_section),#0A..9token#3Ds_needs
..1->.rprog(s_needs),.rdblockbody(TRUE)#0A//sawrite
f("section.ended.with.%s*n",.opname(token))#0A..UNL
ESS.token#3Ds_dot.|.token#3Ds_eof.DO.synerr("Incorr
ect.termination")#0A.#0A..RESULTIS.res#0A}#0A.#0AAN
D.rprog(thing).#3D.VALOF#0A{.LET.a.#3D.0#0A..lex()#0A
..a.:#3D.rbexp()#0A..UNLESS.h1!a#3Ds_string.DO.syne
rr("Bad.SECTION.or.NEEDS.name")#0A..RESULTIS.mk3(th
ing,.a,#0A..15token#3Ds_needs.->.rprog(s_needs),#0A
..31rdblockbody(TRUE)).//.TRUE#3Doutmost.level#0A}#0A
.#0A.#0AAND.synerr(mess,.a).BE#0A{.LET.fno.#3D.line
no>>00020#0A..LET.ln.#3D.lineno.&.#23xFF3#0A..LET.f
ilename.#3D.sourcenamev!fno#0A..errcount.:#3D.errco
unt.+.1#0A..writef("*nError.near.")#0A..IF.filename
.DO.writef("%s",.filename)#0A..writef("[%n]:..",.ln
)#0A..writef(mess,.a)#0A..wrchbuf()#0A..IF.hard.DO.
abort(1001)#0A..IF.errcount.>.errmax.DO#0A..{.write
s("*nCompilation.aborted*n")#0A..2longjump(fin_p,.f
in_l)#0A..}#0A..nlpending.:#3D.FALSE#0A.#0A..UNTIL.
token#3Ds_lsect.|.token#3Ds_rsect.|#0A..6token#3Ds_
let.|.token#3Ds_and.|#0A..6token#3Ds_dot.|.token#3D
s_eof.|.nlpending.DO.lex()#0A#0A..IF.token#3Ds_and.
DO.token.:#3D.s_let#0A..longjump(rec_p,.rec_l)#0A}#0A
.#0ALET.rdblockbody(outerlevel).#3D.VALOF#0A{.LET.p
,.l.#3D.rec_p,.rec_l#0A..LET.a,.ln.#3D.0,.?#0A.#0A.
.rec_p,.rec_l.:#3D.level(),.recover#0A#0Arecover:..
#0A..IF.token#3Ds_semicolon.DO.lex()#0A.#0A..ln.:#3D
.lineno#0A..1#0A..SWITCHON.token.INTO#0A..{.CASE.s_
manifest:#0A..2CASE.s_static:#0A..2CASE.s_global:#0A
..12{.LET.op.#3D.token#0A..14lex()#0A..14a.:#3D.rds
ect(rdcdefs,.op#3Ds_global->s_colon,s_eq)#0A..14a.:
#3D.mk4(op,.a,.rdblockbody(outerlevel),.ln)#0A..14E
NDCASE#0A..12}#0A.#0A.#0A..2CASE.s_let:.lex()#0A..1
4a.:#3D.rdef(outerlevel)#0A..14WHILE.token#3Ds_and.
DO#0A..14{.LET.ln1.#3D.lineno#0A..16lex()#0A..16a.:
#3D.mk4(s_and,.a,.rdef(outerlevel),.ln1)#0A..14}#0A
..14a.:#3D.mk4(s_let,.a,.rdblockbody(outerlevel),.l
n)#0A..14ENDCASE#0A.#0A..2DEFAULT:..2IF.outerlevel.
DO#0A..14{.errmax.:#3D.0.//.Make.it.fatal#2E#0A..16
synerr("Bad.outer.level.declaration")#0A..14}#0A..1
4a.:#3D.rdseq()#0A..14UNLESS.token#3Ds_rsect.DO.syn
err("Error.in.command")#0A.#0A..2CASE.s_rsect:IF.ou
terlevel.DO.lex()#0A..2CASE.s_dot:#0A..2CASE.s_eof:
#0A..}#0A.#0A..rec_p,.rec_l.:#3D.p,.l#0A..RESULTIS.
a#0A}#0A.#0AAND.rdseq().#3D.VALOF#0A{.LET.a.#3D.0#0A
..1IF.token#3Ds_semicolon.DO.lex()#0A..1a.:#3D.rcom
()#0A..1IF.token#3Ds_rsect.|.token#3Ds_dot.|.token#3D
s_eof.RESULTIS.a#0A..1RESULTIS.mk3(s_seq,.a,.rdseq(
))#0A}#0A#0AAND.rdcdefs(sep).#3D.VALOF#0A{.LET.res,
.id.#3D.0,.0#0A..1LET.ptr.#3D.@res#0A..1LET.p,.l.#3D
.rec_p,.rec_l#0A..1LET.kexp.#3D.0#0A#0A.#0A..1{.LET
.ln.#3D.lineno#0A..4rec_p,.rec_l.:#3D.level(),.reco
v#0A..4kexp.:#3D.0#0A..4id.:#3D.rname()#0A..4IF.tok
en#3Dsep.DO.kexp.:#3D.rnexp(0)#0A..4!ptr.:#3D.mk5(s
_constdef,.0,.id,.kexp,.ln)#0A..4ptr.:#3D.@h2!(!ptr
)#0A#0Arecov:IF.token#3Ds_semicolon.DO.lex()#0A..1}
.REPEATWHILE.token#3Ds_name#0A.#0A..1rec_p,.rec_l.:
#3D.p,.l#0A..1RESULTIS.res#0A}#0A.#0AAND.rdsect(r,.
arg).#3D.VALOF#0A//.Used.only.for.MANIFEST,.STATIC.
and.GLOBAL.declarations,#0A//.SWITCHON.commands.and
.blocks#2E#0A{.LET.tag,.res.#3D.wordnode,.0#0A..1UN
LESS.token#3Ds_lsect.DO.synerr("'{'.or.'$('.expecte
d")#0A..1lex()#0A..1UNLESS.token#3Ds_rsect.DO.res.:
#3D.r(arg).//.Allow.{.}..MR.22/6/05#0A..1UNLESS.tok
en#3Ds_rsect.DO.synerr("'}'.or.'$)'.expected")#0A..
1TEST.tag#3Dwordnode.THEN.lex()#0A..19ELSE.IF.wordn
ode#3Dnulltag.DO#0A..24{.token.:#3D.0#0A..26synerr(
"Untagged.'$)'.mismatch")#0A..24}#0A..1//.res#3D0.f
or.empty.section.brackets.{.}#0A..1RESULTIS.res#0A}
#0A#0AAND.rnamelist().#3D.VALOF#0A{.LET.a.#3D.rname
()#0A..1UNLESS.token#3Ds_comma.RESULTIS.a#0A..1lex(
)#0A..1RESULTIS.mk3(s_comma,.a,.rnamelist())#0A}#0A
#0AAND.rname().#3D.VALOF#0A{.LET.a.#3D.wordnode#0A.
.1UNLESS.token#3Ds_name.DO.synerr("Name.expected")#0A
..1lex()#0A..1RESULTIS.a#0A}#0A.#0ALET.rbexp().#3D.
VALOF#0A{.LET.a,.op.#3D.0,.token#0A.#0A..1SWITCHON.
token.INTO#0A.#0A..1{.DEFAULT:.synerr("Error.in.exp
ression")#0A#0A..4CASE.s_query:..lex()#0A..19RESULT
IS.mk1(s_query)#0A.#0A..4CASE.s_true:#0A..4CASE.s_f
alse:#0A..4CASE.s_name:#0A..4CASE.s_string:.a.:#3D.
wordnode#0A..19lex()#0A..19RESULTIS.a#0A.#0A..4CASE
.s_number:.a.:#3D.mk2(s_number,.decval)#0A..19lex()
#0A..19RESULTIS.a#0A#0A..4CASE.s_fnum:..1UNLESS.-12
8<#3Dexponent<#3D127.DO#0A..21synerr("Exponent.of.f
loating.point.constant.out.of.range")#0A..19a.:#3D.
mk3(s_fnum,.decval,.exponent)#0A..19lex()#0A..19RES
ULTIS.a#0A#0A..4CASE.s_slct:.{.LET.len,.sh,.offset.
#3D.0,.0,.0..//.Inserted.11/7/01#0A#0A..19//.Allow.
.1SLCT.offset#0A..19//.or..4SLCT.sh:offset#0A..19//
.or..4SLCT.len:sh:offset#0A#0A..19offset.:#3D.rnexp
(9)#0A#0A..19IF.token#3Ds_colon.DO#0A..19{.sh.:#3D.
offset#0A..21offset.:#3D.rnexp(9)#0A..19}#0A..19IF.
token#3Ds_colon.DO#0A..19{.len.:#3D.sh#0A..21sh.:#3D
.offset#0A..21offset.:#3D.rnexp(9)#0A..19}#0A#0A..1
9RESULTIS.mk4(s_slct,.len,.sh,.offset)#0A..17}#0A.#0A
..4CASE.s_lparen:.a.:#3D.rnexp(0)#0A..19UNLESS.toke
n#3Ds_rparen.DO.synerr("')'.missing")#0A..19lex()#0A
..19RESULTIS.a#0A.#0A..4CASE.s_valof:..lex()#0A..19
RESULTIS.mk2(s_valof,.rcom())#0A.#0A..4CASE.s_vecap
:..op.:#3D.s_rv#0A..4CASE.s_float:#0A..4CASE.s_fix:
#0A..4CASE.s_lv:#0A..4CASE.s_rv:..3RESULTIS.mk2(op,
.rnexp(7))#0A.#0A..4CASE.s_fadd:#0A..4CASE.s_add:..
2RESULTIS.rnexp(5)#0A.#0A..4CASE.s_sub:..2a.:#3D.rn
exp(5)#0A..19TEST.h1!a#3Ds_number.THEN.h2!a.:#3D.-.
h2!a#0A..38ELSE.a.:#3D.mk2(s_neg,.a)#0A..19RESULTIS
.a#0A..4CASE.s_fsub:..1a.:#3D.rnexp(5)#0A..19TEST.h
1!a#3Ds_fnum.THEN.h2!a.:#3D.-.h2!a#0A..36ELSE.a.:#3D
.mk2(s_fneg,.a)#0A..19RESULTIS.a#0A.#0A..4CASE.s_fa
bs:#0A..4CASE.s_abs:..2RESULTIS.mk2(op,.rnexp(5))#0A
.#0A..4CASE.s_not:..2RESULTIS.mk2(s_not,.rnexp(3))#0A
.#0A..4CASE.s_table:..lex()#0A..19RESULTIS.mk2(s_ta
ble,.rexplist())#0A..}#0A}#0A.#0AAND.rnexp(n).#3D.V
ALOF.{.lex();.RESULTIS.rexp(n).}#0A.#0AAND.rexp(n).
#3D.VALOF#0A{.LET.a,.b,.p.#3D.rbexp(),.0,.0#0A#0A..
1UNTIL.nlpending.DO.#0A..1{.LET.op.#3D.token#0A.#0A
..4SWITCHON.op.INTO#0A.#0A..4{.DEFAULT:..5RESULTIS.
a#0A.#0A..7CASE.s_lparen:.lex()#0A..22b.:#3D.0#0A..
22UNLESS.token#3Ds_rparen.DO.b.:#3D.rexplist()#0A..
22UNLESS.token#3Ds_rparen.DO.synerr("')'.missing")#0A
..22lex()#0A..22a.:#3D.mk4(s_fnap,.a,.b,.0)#0A..22L
OOP#0A.#0A..7CASE.s_mthap:{.LET.e1.#3D.0#0A..23lex(
)#0A..23UNLESS.token#3Ds_lparen.DO.synerr("'('.miss
ing")#0A..23lex()#0A..23b.:#3D.0#0A..23UNLESS.token
#3Ds_rparen.DO.b.:#3D.rexplist()#0A..23IF.b#3D0.DO.
synerr("argument.expression.missing")#0A..23UNLESS.
token#3Ds_rparen.DO.synerr("')'.missing")#0A..23lex
()#0A..23TEST.h1!b#3Ds_comma#0A..23THEN.e1.:#3D.h2!
b#0A..23ELSE.e1.:#3D.b#0A..23a.:#3D.mk3(s_vecap,.mk
2(s_rv,.e1),.a)#0A..23a.:#3D.mk4(s_fnap,.a,.b,.0)#0A
..23LOOP#0A..20}#0A.#0A..7CASE.s_sbra:..1b.:#3D.rne
xp(0)..1//.Inserted.11/6/02#0A..22UNLESS.token#3Ds_
sket.DO.synerr("']'.missing")#0A..22lex()#0A..22a.:
#3D.mk3(s_vecap,.a,.b)#0A..22LOOP#0A.#0A..7CASE.s_o
f:..3p.:#3D.8;.ENDCASE.//.Inserted.11/7/01#0A#0A..7
CASE.s_vecap:..p.:#3D.8;.ENDCASE#0A..7CASE.s_byteap
:.p.:#3D.8;.ENDCASE.//.Changed.from.7.on.16.Dec.199
1#0A..7CASE.s_fmul:#0A..7CASE.s_fdiv:#0A..7CASE.s_m
ul:#0A..7CASE.s_div:#0A..7CASE.s_rem:..2p.:#3D.6;.E
NDCASE#0A#0A..7CASE.s_fadd:#0A..7CASE.s_fsub:#0A..7
CASE.s_add:#0A..7CASE.s_sub:..2p.:#3D.5;.ENDCASE#0A
.#0A..7CASE.s_feq:CASE.s_fle:CASE.s_fls:#0A..7CASE.
s_fne:CASE.s_fge:CASE.s_fgr:#0A..7CASE.s_eq:CASE.s_
le:CASE.s_ls:#0A..7CASE.s_ne:CASE.s_ge:CASE.s_gr:#0A
..22IF.n>#3D4.RESULTIS.a#0A..22b.:#3D.rnexp(4)#0A..
22a.:#3D.mk3(op,.a,.b)#0A..22WHILE..s_eq<#3Dtoken<#3D
s_ge.|#0A..29s_feq<#3Dtoken<#3Ds_fge.DO#0A..22{.LET
.c.#3D.b#0A..25op.:#3D.token#0A..25b.:#3D.rnexp(4)#0A
..25a.:#3D.mk3(s_logand,.a,.mk3(op,.c,.b))#0A..22}#0A
..22LOOP#0A.#0A..7CASE.s_lshift:#0A..7CASE.s_rshift
:.IF.n>#3D4.RESULTIS.a#0A..22a.:#3D.mk3(op,.a,.rnex
p(4))#0A..22LOOP#0A#0A..7CASE.s_logand:.p.:#3D.3;.E
NDCASE#0A..7CASE.s_logor:..p.:#3D.2;.ENDCASE#0A..7C
ASE.s_eqv:#0A..7CASE.s_neqv:..1p.:#3D.1;.ENDCASE#0A
.#0A..7CASE.s_cond:..1IF.n>#3D1.RESULTIS.a#0A..22b.
:#3D.rnexp(0)#0A..22UNLESS.token#3Ds_comma.DO#0A..2
9synerr("Bad.conditional.expression")#0A..22a.:#3D.
mk4(s_cond,.a,.b,.rnexp(0))#0A..22LOOP#0A..4}#0A..4
#0A..4IF.n>#3Dp.RESULTIS.a#0A..4a.:#3D.mk3(op,.a,.r
nexp(p))#0A..1}#0A..1#0A..1RESULTIS.a#0A}#0A.#0ALET
.rexplist().#3D.VALOF#0A{.LET.res,.a.#3D.0,.rexp(0)
#0A..1LET.ptr.#3D.@res#0A.#0A..1WHILE.token#3Ds_com
ma.DO.{.!ptr.:#3D.mk3(s_comma,.a,.0)#0A..26ptr.:#3D
.@h3!(!ptr)#0A..26a.:#3D.rnexp(0)#0A..23}#0A..1!ptr
.:#3D.a#0A..1RESULTIS.res#0A}#0A.#0ALET.rdef(outerl
evel).#3D.VALOF#0A{.LET.n.#3D.rnamelist()#0A..1LET.
ln.#3D.lineno#0A#0A..1SWITCHON.token.INTO#0A.#0A..1
{.CASE.s_lparen:#0A..6{.LET.a.#3D.0#0A..9lex()#0A..
9UNLESS.h1!n#3Ds_name.DO.synerr("Bad.formal.paramet
er")#0A..9IF.token#3Ds_name.DO.a.:#3D.rnamelist()#0A
..9UNLESS.token#3Ds_rparen.DO.synerr("')'.missing")
#0A..9lex()#0A.#0A..9IF.token#3Ds_be.DO#0A..9{.lex(
)#0A..12RESULTIS.mk6(s_rtdef,.n,.a,.rcom(),.0,.ln)#0A
..9}#0A.#0A..9IF.token#3Ds_eq.RESULTIS.mk6(s_fndef,
.n,.a,.rnexp(0),.0,.ln)#0A.#0A..9synerr("Bad.proced
ure.heading")#0A..6}#0A.#0A..4DEFAULT:.synerr("Bad.
declaration")#0A.#0A..4CASE.s_eq:#0A..9IF.outerleve
l.DO.synerr("Bad.outer.level.declaration")#0A..9lex
()#0A..9IF.token#3Ds_vec.DO#0A..9{.UNLESS.h1!n#3Ds_
name.DO.synerr("Name.required.before.#3D.VEC")#0A..
12RESULTIS.mk4(s_vecdef,.n,.rnexp(0),.ln)#0A..9}#0A
..9RESULTIS.mk4(s_valdef,.n,.rexplist(),.ln)#0A..1}
#0A}#0A.#0ALET.rbcom().#3D.VALOF#0A{.LET.a,.b,.op,.
ln.#3D.0,.0,.token,.lineno#0A.#0A..SWITCHON.token.I
NTO#0A..{.DEFAULT:.RESULTIS.0#0A.#0A..2CASE.s_name:
CASE.s_number:CASE.s_fnum:#0A..2CASE.s_string:CASE.
s_lparen:#0A..2CASE.s_true:CASE.s_false:CASE.s_lv:C
ASE.s_rv:CASE.s_vecap:#0A..2CASE.s_slct:..6//.Inser
ted.11/7/01#0A..2CASE.s_add:CASE.s_sub:CASE.s_abs:C
ASE.s_not:#0A..2CASE.s_table:CASE.s_valof:CASE.s_qu
ery:#0A..10//.All.tokens.that.can.start.an.expressi
on#2E#0A..10a.:#3D.rexplist()#0A.#0A..10SWITCHON.to
ken.INTO#0A..10{.DEFAULT:#0A..14IF.h1!a#3Ds_fnap.DO
#0A..14{.h1!a,.h4!a.:#3D.s_rtap,.ln#0A..16RESULTIS.
a#0A..14}#0A..14synerr("Error.in.command")#0A..14RE
SULTIS.a#0A#0A..12CASE.s_assvecap:#0A..12CASE.s_ass
fmul:CASE.s_assfdiv:#0A..12CASE.s_assfadd:CASE.s_as
sfsub:#0A..12CASE.s_assmul:CASE.s_assdiv:CASE.s_ass
rem:#0A..12CASE.s_assadd:CASE.s_ass1ub:#0A..12CASE.
s_asslshift:CASE.s_assrshift:#0A..12CASE.s_asslogan
d:CASE.s_asslogor:#0A..12CASE.s_asseqv:CASE.s_assne
qv:#0A..12CASE.s_ass:#0A..14op.:#3D.token#0A..14lex
()#0A..14RESULTIS.mk4(op,.a,.rexplist(),.ln)#0A#0A.
.12CASE.s_colon:#0A..14UNLESS.h1!a#3Ds_name.DO.syne
rr("Unexpected.':'")#0A..14lex()#0A..14RESULTIS.mk5
(s_colon,.a,.rbcom(),.0,.ln)#0A..10}#0A.#0A..2CASE.
s_goto:#0A..2CASE.s_resultis:#0A..10RESULTIS.mk3(op
,.rnexp(0),.ln)#0A.#0A..2CASE.s_if:#0A..2CASE.s_unl
ess:#0A..2CASE.s_while:#0A..2CASE.s_until:#0A..10a.
:#3D.rnexp(0)#0A..10IF.token#3Ds_do.DO.lex()#0A..10
RESULTIS.mk4(op,.a,.rcom(),.ln)#0A.#0A..2CASE.s_tes
t:#0A..10a.:#3D.rnexp(0)#0A..10IF.token#3Ds_do.DO.l
ex()#0A..10b.:#3D.rcom()#0A..10UNLESS.token#3Ds_els
e.DO.synerr("ELSE.missing")#0A..10lex()#0A..10RESUL
TIS.mk5(s_test,.a,.b,.rcom(),.ln)#0A.#0A..2CASE.s_f
or:#0A..7{.LET.i,.j,.k.#3D.0,.0,.0#0A..10lex()#0A..
10a.:#3D.rname()#0A..10UNLESS.token#3Ds_eq.DO.syner
r("'#3D'.missing")#0A..10i.:#3D.rnexp(0)#0A..10UNLE
SS.token#3Ds_to.DO.synerr("TO.missing")#0A..10j.:#3D
.rnexp(0)#0A..10IF.token#3Ds_by.DO.k.:#3D.rnexp(0)#0A
..10IF.token#3Ds_do.DO.lex()#0A..10RESULTIS.mk7(s_f
or,.a,.i,.j,.k,.rcom(),.ln)#0A..7}#0A.#0A..2CASE.s_
loop:#0A..2CASE.s_break:#0A..2CASE.s_return:#0A..2C
ASE.s_finish:#0A..2CASE.s_endcase:#0A..10lex()#0A..
10RESULTIS.mk2(op,.ln)#0A.#0A..2CASE.s_switchon:#0A
..10a.:#3D.rnexp(0)#0A..10UNLESS.token#3Ds_into.DO.
synerr("INTO.missing")#0A..10lex()#0A..10{.LET.skip
ln.#3D.lineno#0A..12b.:#3D.rdsect(rdseq)#0A..12UNLE
SS.b.DO#0A..14b.:#3D.mk2(s_skip,.skipln)..7//.MR.5/
4/06#0A..10}#0A..10RESULTIS.mk4(s_switchon,.a,.b,.l
n)#0A.#0A..2CASE.s_case:#0A..10a.:#3D.rnexp(0)#0A..
10UNLESS.token#3Ds_colon.DO.synerr("Bad.CASE.label"
)#0A..10lex()#0A..10RESULTIS.mk4(s_case,.a,.rbcom()
,.ln)#0A.#0A..2CASE.s_default:#0A..10lex()#0A..10UN
LESS.token#3Ds_colon.DO.synerr("Bad.DEFAULT.label")
#0A..10lex()#0A..10RESULTIS.mk3(s_default,.rbcom(),
.ln)#0A.#0A..2CASE.s_lsect:#0A..10a.:#3D.rdsect(rdb
lockbody,.FALSE)#0A..10UNLESS.a.DO#0A..12a.:#3D.mk2
(s_skip,.ln)..6//.MR.5/4/06#0A..10RESULTIS.a#0A..}#0A
}#0A#0AAND.rbseq().#3D.VALOF#0A{.LET.a.#3D.rbcom()#0A
..WHILE.token#3Ds_seq.DO#0A..{.LET.ln.#3D.lineno#0A
..2lex()#0A..2a.:#3D.mk4(s_seq,.a,.rbcom(),.ln)#0A.
.}#0A}#0A#0AAND.rcom().#3D.VALOF.//.Added.<>.18/07/
2010#0A//.Reads:..BCOM.<>.BCOM.<>#2E#2E1<>.BCOM.#0A
//.possibly.qualified.by.repeat,.repeatwhile.or.rep
eatuntil.clauses#0A{.LET.a.#3D.rbcom()#0A#0A..//.Em
pty.section.brackets.{.}.form.SKIP.nodes,.MR.22/6/0
5#0A..IF.a#3D0.DO.synerr("Error.in.command")#0A.#0A
..WHILE.token#3Ds_seq.DO#0A..{.LET.ln.#3D.lineno#0A
..2lex()#0A..2a.:#3D.mk4(s_seq,.a,.rbcom(),.ln)#0A.
.}#0A#0A..WHILE.token#3Ds_repeat.|.token#3Ds_repeat
while.|.token#3Ds_repeatuntil.DO#0A..{.LET.op,.ln#3D
.token,.lineno#0A..2lex()#0A..2TEST.op#3Ds_repeat#0A
..2THEN.a.:#3D.mk3(op,.a,.ln)#0A..2ELSE.a.:#3D.mk4(
op,.a,.rexp(0),.ln)#0A..}#0A#0A..RESULTIS.a#0A}#0A#0A
/*#0ALET.plist(x).BE#0A{.writef("*nName.table.conte
nts,.size.#3D.%n*n",.nametablesize)#0A..1FOR.i.#3D.
0.TO.nametablesize-1.DO#0A..1{.LET.p,.n.#3D.nametab
le!i,.0#0A..4UNTIL.p#3D0.DO.p,.n.:#3D.p!1,.n+1#0A..
4writef("%i3:%n",.i,.n)#0A..4p.:#3D.nametable!i#0A.
.4UNTIL.p#3D0.DO.{.writef(".%s",.p+2);.p.:#3D.p!1..
}#0A..4newline()#0A..1}#0A}#0A*/#0ALET.plist(x,.n,.
d).BE#0A{.LET.size,.ln.#3D.0,.0#0A..LET.v.#3D.TABLE
.0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0#0A#0A..IF.
x#3D0.DO.{.writes("Nil");.RETURN..}#0A.#0A..SWITCHO
N.h1!x.INTO#0A..{.CASE.s_number:#0A..15{.LET.val.#3D
.h2!x#0A..17TEST.-1004<#3Dval<#3D1004#0A..17THEN.wr
itef("NUM:.%n",.val)#0A..17ELSE.writef("NUM:.%x8",.
val)#0A..17RETURN#0A..15}#0A#0A..2CASE.s_fnum:..1wr
itef("FNUM:.%ne%n",.h2!x,.h3!x);.RETURN#0A.#0A..2CA
SE.s_name:..1writef("NAME:.%s",.x+2);..9RETURN#0A.#0A
..2CASE.s_string:#0A..14{.LET.s.#3D.x+1#0A..16write
f("STRING:.*"")#0A..16FOR.i.#3D.1.TO.s%0.SWITCHON.s
%i.INTO#0A..16{.DEFAULT:..1wrch(s%i);.LOOP#0A..18CA
SE.'*n':.writes("**n");.LOOP#0A..18CASE.'*p':.write
s("**p");.LOOP#0A..18CASE.'*s':.writes("**s");.LOOP
#0A..18CASE.'*t':.writes("**t");.LOOP#0A..16}#0A..1
6writes("*"")#0A..16RETURN#0A..14}#0A.#0A..2CASE.s_
for:..2size,.ln.:#3D.6,.h7!x;..ENDCASE#0A.#0A..2CAS
E.s_fndef:CASE.s_rtdef:#0A..17size,.ln.:#3D.4,.h6!x
;..ENDCASE#0A#0A..2CASE.s_cond:#0A..2CASE.s_slct:..
5//.Inserted.11/7/01#0A..17size.:#3D.4;..10ENDCASE#0A
.#0A..2CASE.s_test:CASE.s_constdef:#0A..17size,.ln.
:#3D.4,.h5!x;..ENDCASE#0A.#0A..2CASE.s_needs:CASE.s
_section:CASE.s_vecap:CASE.s_byteap:CASE.s_fnap:#0A
..2CASE.s_of:..//.Inserted.11/7/01#0A..2CASE.s_fmul
:CASE.s_fdiv:CASE.s_fadd:CASE.s_fsub:#0A..2CASE.s_m
ul:CASE.s_div:CASE.s_rem:CASE.s_add:CASE.s_sub:#0A.
.2CASE.s_feq:CASE.s_fne:CASE.s_fls:CASE.s_fgr:CASE.
s_fle:CASE.s_fge:#0A..2CASE.s_eq:CASE.s_ne:CASE.s_l
s:CASE.s_gr:CASE.s_le:CASE.s_ge:#0A..2CASE.s_lshift
:CASE.s_rshift:CASE.s_logand:CASE.s_logor:#0A..2CAS
E.s_eqv:CASE.s_neqv:CASE.s_comma:#0A..2CASE.s_seq:#0A
..17size.:#3D.3;..10ENDCASE#0A..19#0A..2CASE.s_vald
ef:CASE.s_vecdef:#0A..17size,.ln.:#3D.3,.h4!x;..END
CASE#0A#0A..2CASE.s_colon:#0A..17size,.ln.:#3D.3,.h
5!x;..ENDCASE#0A.#0A..2CASE.s_assvecap:#0A..2CASE.s
_assfmul:CASE.s_assfdiv:#0A..2CASE.s_assfadd:CASE.s
_assfsub:#0A..2CASE.s_assmul:CASE.s_assdiv:CASE.s_a
ssrem:#0A..2CASE.s_assadd:CASE.s_ass1ub:#0A..2CASE.
s_asslshift:CASE.s_assrshift:CASE.s_asslogand:CASE.
s_asslogor:#0A..2CASE.s_asseqv:CASE.s_assneqv:#0A#0A
..2CASE.s_and:#0A..2CASE.s_ass:CASE.s_rtap:CASE.s_i
f:CASE.s_unless:#0A..2CASE.s_while:CASE.s_until:CAS
E.s_repeatwhile:#0A..2CASE.s_repeatuntil:#0A..2CASE
.s_switchon:CASE.s_case:CASE.s_let:#0A..2CASE.s_man
ifest:CASE.s_static:CASE.s_global:#0A..17size,.ln.:
#3D.3,.h4!x;..ENDCASE#0A.#0A..2CASE.s_valof:CASE.s_
lv:CASE.s_rv:CASE.s_neg:CASE.s_not:#0A..2CASE.s_tab
le:CASE.s_abs:CASE.s_fabs:CASE.s_fneg:#0A..2CASE.s_
float:CASE.s_fix:#0A..17size.:#3D.2;..10ENDCASE#0A.
#0A..2CASE.s_goto:CASE.s_resultis:CASE.s_repeat:CAS
E.s_default:#0A..17size,.ln.:#3D.2,.h3!x;..ENDCASE#0A
.#0A..2CASE.s_true:CASE.s_false:CASE.s_query:#0A..1
7size.:#3D.1;..10ENDCASE#0A..4#0A..2CASE.s_skip:.//
.MR.22/6/05#0A..2CASE.s_loop:CASE.s_break:CASE.s_re
turn:#0A..2CASE.s_finish:CASE.s_endcase:#0A..17size
,.ln.:#3D.1,.h2!x;..ENDCASE#0A#0A..2DEFAULT:..5size
.:#3D.1#0A..}#0A.#0A..IF.n#3Dd.DO.{.writes("Etc");.
RETURN.}#0A.#0A//..writef("Op.%n",.h1!x)#0A..writef
(opname(h1!x),.h1!x)#0A//.IF.ln>0.DO.writef("..line
.%n",.ln)#0A..1IF.ln>0.DO#0A..1{.LET.fno.#3D.ln>>00
020#0A..3LET.lno.#3D.ln.&.#23xFF3#0A..3LET.filename
.#3D.sourcenamev!fno#0A..3writef("..")#0A..3IF.file
name.DO.writef("%s",.filename)#0A..3writef("[%n]",.
lno)#0A..1}#0A..1FOR.i.#3D.2.TO.size.DO.{.newline()
#0A..24FOR.j#3D0.TO.n-1.DO.writes(.v!j.)#0A..24writ
es("**-")#0A..24v!n.:#3D.i#3Dsize->"..","!."#0A..24
plist(h1!(x+i-1),.n+1,.d)#0A..22}#0A}#0A.#0AAND.opn
ame(op).#3D.VALOF.SWITCHON.op.INTO#0A{.DEFAULT:..10
writef("*nopname.#3D.%n*n",.op)#0A..20RESULTIS."Op.
%n"#0A#0A..CASE.s_abs:..7RESULTIS."ABS"#0A..CASE.s_
and:..7RESULTIS."AND"#0A..CASE.s_ass:..7RESULTIS."A
SS"#0A..CASE.s_assdiv:..4RESULTIS."ASSDIV"#0A..CASE
.s_asseqv:..4RESULTIS."ASSEQV"#0A..CASE.s_assfdiv:.
.3RESULTIS."ASSFDIV"#0A..CASE.s_assfsub:..3RESULTIS
."ASSFSUB"#0A..CASE.s_assfmul:..3RESULTIS."ASSFMUL"
#0A..CASE.s_assfadd:..3RESULTIS."ASSFADD"#0A..CASE.
s_asslogand:..1RESULTIS."ASSLOGAND"#0A..CASE.s_assl
ogor:..2RESULTIS."ASSLOGOR"#0A..CASE.s_asslshift:..
1RESULTIS."ASSLSHIFT"#0A..CASE.s_ass1ub:..4RESULTIS
."ASS1UB"#0A..CASE.s_assmul:..4RESULTIS."ASSMUL"#0A
..CASE.s_assneqv:..3RESULTIS."ASSNEQV"#0A..CASE.s_a
ssadd:..4RESULTIS."ASSADD"#0A..CASE.s_assrem:..4RES
ULTIS."ASSREM"#0A..CASE.s_assrshift:..1RESULTIS."AS
SRSHIFT"#0A..CASE.s_assvecap:..2RESULTIS."ASSVECAP"
#0A..CASE.s_be:..8RESULTIS."BE"#0A..CASE.s_by:..8RE
SULTIS."BY"#0A..CASE.s_break:..5RESULTIS."BREAK"#0A
..CASE.s_byteap:..4RESULTIS."BYTEAP"#0A..CASE.s_cas
e:..6RESULTIS."CASE"#0A..CASE.s_colon:..5RESULTIS."
COLON"#0A..CASE.s_comma:..5RESULTIS."COMMA"#0A..CAS
E.s_cond:..6RESULTIS."COND"#0A..CASE.s_constdef:..2
RESULTIS."CONSTDEF"#0A..CASE.s_datalab:..3RESULTIS.
"DATALAB"#0A..CASE.s_default:..3RESULTIS."DEFAULT"#0A
..CASE.s_div:..7RESULTIS."DIV"#0A..CASE.s_do:..8RES
ULTIS."DO"#0A..CASE.s_dot:..7RESULTIS."DOT"#0A..CAS
E.s_else:..6RESULTIS."ELSE"#0A..CASE.s_eof:..7RESUL
TIS."EOF"#0A..CASE.s_endcase:..3RESULTIS."ENDCASE"#0A
..CASE.s_endfor:..4RESULTIS."ENDFOR"#0A..CASE.s_end
proc:..3RESULTIS."ENDPROC"#0A..CASE.s_entry:..5RESU
LTIS."ENTRY"#0A..CASE.s_eq:..8RESULTIS."EQ"#0A..CAS
E.s_eqv:..7RESULTIS."EQV"#0A..CASE.s_fabs:..6RESULT
IS."FABS"#0A..CASE.s_false:..5RESULTIS."FALSE"#0A..
CASE.s_fdiv:..6RESULTIS."FDIV"#0A..CASE.s_feq:..7RE
SULTIS."FEQ"#0A..CASE.s_fge:..7RESULTIS."FGE"#0A..C
ASE.s_fgr:..7RESULTIS."FGR"#0A..CASE.s_finish:..4RE
SULTIS."FINISH"#0A..CASE.s_fix:..7RESULTIS."FIX"#0A
..CASE.s_fle:..7RESULTIS."FLE"#0A..CASE.s_float:..5
RESULTIS."FLOAT"#0A..CASE.s_fls:..7RESULTIS."FLS"#0A
..CASE.s_fltop:..5RESULTIS."FLTOP"#0A..CASE.s_fnap:
..6RESULTIS."FNAP"#0A..CASE.s_fndef:..5RESULTIS."FN
DEF"#0A..CASE.s_fne:..7RESULTIS."FNE"#0A..CASE.s_fn
eg:..6RESULTIS."FNEG"#0A..CASE.s_fnum:..6RESULTIS."
FNUM"#0A..CASE.s_fmul:..6RESULTIS."FMUL"#0A..CASE.s
_fsub:..6RESULTIS."FSUB"#0A..CASE.s_fnrn:..6RESULTI
S."FNRN"#0A..CASE.s_fadd:..6RESULTIS."FADD"#0A#0A1.
.CASE.s_for:..7RESULTIS."FOR"#0A..CASE.s_ge:..8RESU
LTIS."GE"#0A..CASE.s_get:..7RESULTIS."GET"#0A..CASE
.s_getbyte:..3RESULTIS."GETBYTE"#0A..CASE.s_global:
..4RESULTIS."GLOBAL"#0A..CASE.s_goto:..6RESULTIS."G
OTO"#0A..CASE.s_gr:..8RESULTIS."GR"#0A..CASE.s_if:.
.8RESULTIS."IF"#0A..CASE.s_into:..6RESULTIS."INTO"#0A
..CASE.s_itemn:..5RESULTIS."ITEMN"#0A..CASE.s_jf:..
8RESULTIS."JF"#0A..CASE.s_jt:..8RESULTIS."JT"#0A..C
ASE.s_jump:..6RESULTIS."JUMP"#0A..CASE.s_lab:..7RES
ULTIS."LAB"#0A..CASE.s_le:..8RESULTIS."LE"#0A..CASE
.s_let:..7RESULTIS."LET"#0A..CASE.s_lf:..8RESULTIS.
"LF"#0A..CASE.s_lg:..8RESULTIS."LG"#0A..CASE.s_ll:.
.8RESULTIS."LL"#0A..CASE.s_llg:..7RESULTIS."LLG"#0A
..CASE.s_ll1:..7RESULTIS."LLl"#0A..CASE.s_llp:..7RE
SULTIS."LLP"#0A..CASE.s_ln:..8RESULTIS."LN"#0A..CAS
E.s_logand:..4RESULTIS."LOGAND"#0A..CASE.s_logor:..
5RESULTIS."LOGOR"#0A..CASE.s_loop:..6RESULTIS."LOOP
"#0A..CASE.s_lp:..8RESULTIS."LP"#0A..CASE.s_lparen:
..4RESULTIS."LPAREN"#0A..CASE.s_ls:..8RESULTIS."LS"
#0A..CASE.s_lsect:..5RESULTIS."LSECT"#0A..CASE.s_ls
hift:..4RESULTIS."LSHIFT"#0A..CASE.s_lstr:..6RESULT
IS."LSTR"#0A..CASE.s_lv:..8RESULTIS."LV"#0A..CASE.s
_manifest:..2RESULTIS."MANIFEST"#0A..CASE.s_mthap:.
.5RESULTIS."MTHAP"#0A..CASE.s_sub:..7RESULTIS."SUB"
#0A..CASE.s_mul:..6RESULTIS."MUL"#0A..CASE.s_name:.
.6RESULTIS."NAME"#0A..CASE.s_ne:..8RESULTIS."NE"#0A
..CASE.s_needs:..5RESULTIS."NEEDS"#0A..CASE.s_neg:.
.7RESULTIS."NEG"#0A..CASE.s_neqv:..6RESULTIS."NEQV"
#0A..CASE.s_none:..6RESULTIS."NONE"#0A..CASE.s_not:
..7RESULTIS."NOT"#0A..CASE.s_number:..4RESULTIS."NU
MBER"#0A..CASE.s_of:..8RESULTIS."OF"#0A..CASE.s_add
:..7RESULTIS."ADD"#0A..CASE.s_putbyte:..3RESULTIS."
PUTBYTE"#0A..CASE.s_query:..5RESULTIS."QUERY"#0A..C
ASE.s_rem:..7RESULTIS."REM"#0A..CASE.s_repeat:..4RE
SULTIS."REPEAT"#0A..CASE.s_repeatuntil:.RESULTIS."R
EPEATUNTIL"#0A..CASE.s_repeatwhile:.RESULTIS."REPEA
TWHILE"#0A..CASE.s_res:..7RESULTIS."RES"#0A..CASE.s
_resultis:..2RESULTIS."RESULTIS"#0A..CASE.s_return:
..4RESULTIS."RETURN"#0A..CASE.s_rparen:..4RESULTIS.
"RPAREN"#0A..CASE.s_rsect:..5RESULTIS."RSECT"#0A..C
ASE.s_rshift:..4RESULTIS."RSHIFT"#0A..CASE.s_rstack
:..4RESULTIS."RSTACK"#0A..CASE.s_rtap:..6RESULTIS."
RTAP"#0A..CASE.s_rtdef:..5RESULTIS."RTDEF"#0A..CASE
.s_rtrn:..6RESULTIS."RTRN"#0A..CASE.s_rv:..8RESULTI
S."RV"#0A..CASE.s_save:..6RESULTIS."SAVE"#0A..CASE.
s_sbra:..6RESULTIS."SBRA"#0A..CASE.s_section:..3RES
ULTIS."SECTION"#0A..CASE.s_semicolon:..1RESULTIS."S
EMICOLON"#0A..CASE.s_seq:..7RESULTIS."SEQ"#0A..CASE
.s_sg:..8RESULTIS."SG"#0A..CASE.s_sket:..6RESULTIS.
"SKET"#0A..CASE.s_skip:..6RESULTIS."SKIP"#0A..CASE.
s_sl:..8RESULTIS."SL"#0A..CASE.s_slct:..6RESULTIS."
SLCT"#0A..CASE.s_selld:..5RESULTIS."SELLD"#0A..CASE
.s_selst:..5RESULTIS."SELST"#0A..CASE.s_sp:..8RESUL
TIS."SP"#0A..CASE.s_stack:..5RESULTIS."STACK"#0A..C
ASE.s_static:..4RESULTIS."STATIC"#0A..CASE.s_stind:
..5RESULTIS."STIND"#0A..CASE.s_store:..5RESULTIS."S
TORE"#0A..CASE.s_string:..4RESULTIS."STRING"#0A..CA
SE.s_switchon:..2RESULTIS."SWITCHON"#0A..CASE.s_tab
le:..5RESULTIS."TABLE"#0A..CASE.s_test:..6RESULTIS.
"TEST"#0A..CASE.s_to:..8RESULTIS."TO"#0A..CASE.s_tr
ue:..6RESULTIS."TRUE"#0A..CASE.s_unless:..4RESULTIS
."UNLESS"#0A..CASE.s_until:..5RESULTIS."UNTIL"#0A..
CASE.s_valdef:..4RESULTIS."VALDEF"#0A..CASE.s_valof
:..5RESULTIS."VALOF"#0A..CASE.s_vec:..7RESULTIS."VE
C"#0A..CASE.s_vecap:..5RESULTIS."VECAP"#0A..CASE.s_
vecdef:..4RESULTIS."VECDEF"#0A..CASE.s_while:..5RES
ULTIS."WHILE"#0A}#0A#0AAND.flopname(flop).#3D.VALOF
.SWITCHON.flop.INTO#0A{.DEFAULT:..10writef("*nopnam
e.#3D.%n*n",.flop)#0Aabort(991)#0A..20RESULTIS."Flo
p.%n"#0A#0A..CASE.fl_mk:..7RESULTIS."MK"#0A..CASE.f
l_float:..4RESULTIS."FLOAT"#0A..CASE.fl_fix:..6RESU
LTIS."FIX"#0A..CASE.fl_neg:..6RESULTIS."NEG"#0A..CA
SE.fl_abs:..6RESULTIS."ABS"#0A..CASE.fl_mul:..6RESU
LTIS."MUL"#0A..CASE.fl_div:..6RESULTIS."DIV"#0A..CA
SE.fl_add:..6RESULTIS."ADD"#0A..CASE.fl_sub:..6RESU
LTIS."SUB"#0A..CASE.fl_eq:..7RESULTIS."EQ"#0A..CASE
.fl_ne:..7RESULTIS."NE"#0A..CASE.fl_ls:..7RESULTIS.
"LS"#0A..CASE.fl_gr:..7RESULTIS."GR"#0A..CASE.fl_le
:..7RESULTIS."LE"#0A..CASE.fl_ge:..7RESULTIS."GE"#0A
}#0A#0AAND.sfname(sfop).#3D.VALOF.SWITCHON.sfop.INT
O#0A{.DEFAULT:..5writef("sfname:.bad.sfop.#3D.%n*n"
,.sfop)#0A..15RESULTIS."UNKNOWN"#0A#0A..CASE.sf_non
e:..1RESULTIS."NONE"#0A..CASE.sf_vecap:..RESULTIS."
VECAP"#0A..CASE.sf_fmul:..1RESULTIS."FMUL"#0A..CASE
.sf_fdiv:..1RESULTIS."FDIV"#0A..CASE.sf_fadd:..1RES
ULTIS."FADD"#0A..CASE.sf_fsub:..1RESULTIS."FSUB"#0A
..CASE.sf_mul:..2RESULTIS."MUL"#0A..CASE.sf_div:..2
RESULTIS."DIV"#0A..CASE.sf_rem:..2RESULTIS."REM"#0A
..CASE.sf_add:..2RESULTIS."ADD"#0A..CASE.sf_sub:..2
RESULTIS."SUB"#0A..CASE.sf_lshift:.RESULTIS."LSHIFT
"#0A..CASE.sf_rshift:.RESULTIS."RSHIFT"#0A..CASE.sf
_logand:.RESULTIS."LOGAND"#0A..CASE.sf_logor:..RESU
LTIS."LOGOR"#0A..CASE.sf_eqv:..2RESULTIS."EQV"#0A..
CASE.sf_neqv:..1RESULTIS."NEQV"#0A}#0A#0A//#2E#0A#0A
//SECTION."TRN"#0A#0A//GET."libhdr"#0A//GET."bcplfe
cg"#0A.#0AGLOBAL..{#0Atrnext:trng#0Atrans;.declname
s;.decldyn#0Adeclstat;.checkdistinct;.addname;.cell
withname#0Atransdef;.scanlabel#0Adecllabels;.undecl
are#0Ajumpcond;.transswitch;.transfor#0Aassign;.loa
d;.fnbody;.loadlv;.loadlist#0Aisconst;.evalconst;.t
ransname;.xref#0Anextlab;.labnumber#0Anewblk#0Advec
;.dvece;.dvecp;.dvect#0Acaselist;.casecount#0Aconte
xt;.comline;.procname#0Aresultlab;.defaultlab;.endc
aselab#0Alooplab;.breaklab;.ssp;.vecssp#0Agdeflist;
.gdefcount#0Aoutstring;.out1;.out2;.out3;.out4#0A}#0A
#0ALET.nextlab().#3D.VALOF#0A{.labnumber.:#3D.labnu
mber.+.1#0A..RESULTIS.labnumber#0A}#0A.#0AAND.trner
r(mess,.a).BE#0A{.LET.fno.#3D.comline>>00020#0A..LE
T.lno.#3D.comline.&.#23xFF3#0A..LET.filename.#3D.so
urcenamev!fno#0A..writes("Error.")#0A..UNLESS.procn
ame#3D0.DO.writef("in.%s.",.@h3!procname)#0A..write
f("near.")#0A..IF.filename.DO.writef("%s",.filename
)#0A..writef("[%n]:.",.lno)#0A..writef(mess,.a)#0A.
.newline()#0A..IF.hard.DO.abort(1001)#0A..errcount.
:#3D.errcount.+.1#0A..IF.errcount.>#3D.errmax.DO.{.
writes("*nCompilation.aborted*n")#0A..27longjump(fi
n_p,.fin_l)#0A..25}#0A}#0A#0AAND.newblk(x,.y,.z).#3D
.VALOF#0A{.LET.p.#3D.dvect.-.3#0A..IF.dvece>p.DO.{.
errmax.:#3D.0..6//.Make.it.fatal#2E#0A..16trnerr("M
ore.workspace.needed")#0A..14}#0A..p!0,.p!1,.p!2.:#3D
.x,.y,.z#0A..dvect.:#3D.p#0A..RESULTIS.p#0A}#0A#0AA
ND.translate(x).BE#0A{.dvec,..dvect.:#3D.treevec,.t
reep#0A..h1!dvec,.h2!dvec,.h3!dvec.:#3D.0,.0,.0#0A.
.dvece.:#3D.dvec+3#0A..dvecp.:#3D.dvece#0A//selecto
utput(sysprint)#0A..FOR.i.#3D.0.TO.nametablesize-1.
DO#0A..{.LET.name.#3D.nametable!i#0A..2UNTIL.name#3D
0.DO#0A..2{.LET.next.#3D.h2!name#0A..4h2!name.:#3D.
0.//.Mark.undeclared#0A//..1writef("Undeclare.%s*n"
,.name+2)#0A..4name.:#3D.next#0A..2}#0A..}#0A#0A..g
deflist,.gdefcount.:#3D.0,.0#0A..caselist,.casecoun
t,.defaultlab.:#3D.0,.-1,.0#0A..resultlab,.breaklab
,.looplab,.endcaselab.:#3D.-2,.-2,.-2,.-2#0A..conte
xt,.comline,.procname,.labnumber.:#3D.0,.1,.0,.0#0A
..ssp,.vecssp.:#3D.savespacesize,.savespacesize#0A#0A
..WHILE.x~#3D0.&.(h1!x#3Ds_section.|.h1!x#3Ds_needs
).DO#0A..{.LET.op,.a.#3D.h1!x,.h2!x#0A..2out1(op)#0A
..2outstring(@h2!a)#0A..2x:#3Dh3!x#0A..}#0A#0A..tra
ns(x,.0)#0A..out2(s_global,.gdefcount)#0A..UNTIL.gd
eflist#3D0.DO.{.out2(h2!gdeflist,.h3!gdeflist)#0A..
22gdeflist.:#3D.h1!gdeflist#0A..20}..#0A}#0A#0ALET.
trnext(next).BE.{.IF.next<0.DO.out1(s_rtrn)#0A..20I
F.next>0.DO.out2(s_jump,.next)#0A..18}#0A.#0ALET.tr
ans(x,.next).BE#0A//.x..5is.the.command.to.translat
e#0A//.next<0..compile.x.followed.by.RTRN#0A//.next
>0..compile.x.followed.by.JUMP.next#0A//.next#3D0..
compile.x.only#0A{.LET.op,.sfop,.sw.#3D.?,.?,.FALSE
#0A..IF.x#3D0.DO.{.trnext(next);.RETURN.}#0A..op.:#3D
.h1!x#0A#0A..SWITCHON.op.INTO#0A..{.DEFAULT:.trnerr
("Compiler.error.in.Trans,.op.#3D.%s",.opname(op));
.RETURN#0A.#0A..2CASE.s_let:#0A..2{.LET.cc.#3D.case
count#0A..4LET.e,.s,.s1.#3D.dvece,.ssp,.0#0A..4LET.
v.#3D.vecssp#0A..4casecount.:#3D.-1.//.Disallow.CAS
E.and.DEFAULT.labels#0A..4context,.comline.:#3D.x,.
h4!x#0A..4declnames(h2!x)#0A..4checkdistinct(e)#0A.
.4vecssp,.s1.:#3D.ssp,.ssp#0A..4ssp.:#3D.s#0A..4con
text,.comline.:#3D.x,.h4!x#0A..4transdef(h2!x)#0A..
4UNLESS.ssp#3Ds1.DO.trnerr("Lhs.and.rhs.do.not.matc
h")#0A..4UNLESS.ssp#3Dvecssp.DO.{.ssp.:#3D.vecssp;.
out2(s_stack,.ssp).}#0A..4out1(s_store)#0A..4declla
bels(h3!x)#0A..4trans(h3!x,.next)#0A..4vecssp.:#3D.
v#0A..4UNLESS.ssp#3Ds.DO.out2(s_stack,.s)#0A..4ssp.
:#3D.s#0A..4casecount.:#3D.cc#0A..4undeclare(e)#0A.
.4RETURN#0A..2}#0A.#0A..2CASE.s_static:#0A..2CASE.s
_global:#0A..2CASE.s_manifest:#0A..2{.LET.cc.#3D.ca
secount#0A..4LET.e,.s.#3D.dvece,.ssp#0A..4AND.y,.n.
#3D.h2!x,.0#0A..4LET.prevk.#3D.-1#0A..7#0A..4caseco
unt.:#3D.-1.//.Disallow.CASE.and.DEFAULT.labels#0A.
.4context,.comline.:#3D.x,.h4!x#0A.#0A..4UNTIL.y#3D
0.DO#0A..4{.context,.comline.:#3D.y,.h5!y#0A..6n.:#3D
.h4!y.->.evalconst(h4!y),.prevk+1#0A..6context,.com
line.:#3D.y,.h5!y#0A..6prevk.:#3D.n#0A..6IF.op#3Ds_
static.DO.{.LET.k.#3D.n#0A..26n.:#3D.nextlab()#0A..
26out2(s_datalab,.n)#0A..26out2(s_itemn,.k)#0A..24}
#0A..6IF.op#3Ds_global.UNLESS.0<#3Dn<#3D65500035.DO
#0A..8trnerr("Global.number.too.large.for:.%s*n",.@
h3!(h3!y))#0A..6addname(h3!y,.op,.n)#0A..6IF.xrefin
g.DO.xref(h3!y,#0A..25(op#3Ds_global->"G:",op#3Ds_s
tatic->"S:","M:"),#0A..25n,#0A..25s_constdef#0A..24
)#0A..6y.:#3D.h2!y#0A..4}#0A.#0A..4decllabels(h3!x)
#0A..4trans(h3!x,.next)#0A..4ssp.:#3D.s#0A..4caseco
unt.:#3D.cc#0A..4undeclare(e)#0A..4RETURN#0A..2}#0A
.#0A..2CASE.s_assvecap:..op,.sfop.:#3D.s_vecap,.sf_
vecap;..1GOTO.doassign#0A..2CASE.s_assfmul:..1op,.s
fop.:#3D.s_fmul.,.sf_fmul.;..1GOTO.doassign#0A..2CA
SE.s_assfdiv:..1op,.sfop.:#3D.s_fdiv,.sf_fdiv;..3GO
TO.doassign#0A..2CASE.s_assfadd:..1op,.sfop.:#3D.s_
fadd,.sf_fadd;..3GOTO.doassign#0A..2CASE.s_assfsub:
..1op,.sfop.:#3D.s_fsub,.sf_fsub;..3GOTO.doassign#0A
..2CASE.s_assmul:..2op,.sfop.:#3D.s_mul,.sf_mul;..5
GOTO.doassign#0A..2CASE.s_assdiv:..2op,.sfop.:#3D.s
_div,.sf_div;..5GOTO.doassign#0A..2CASE.s_assrem:..
2op,.sfop.:#3D.s_rem,.sf_rem;..5GOTO.doassign#0A..2
CASE.s_assadd:..2op,.sfop.:#3D.s_add,.sf_add;..5GOT
O.doassign#0A..2CASE.s_ass1ub:..2op,.sfop.:#3D.s_su
b,.sf_sub;..5GOTO.doassign#0A..2CASE.s_asslshift:.o
p,.sfop.:#3D.s_lshift,.sf_lshift;.GOTO.doassign#0A.
.2CASE.s_assrshift:.op,.sfop.:#3D.s_rshift,.sf_rshi
ft;.GOTO.doassign#0A..2CASE.s_asslogand:.op,.sfop.:
#3D.s_logand,.sf_logand;.GOTO.doassign#0A..2CASE.s_
asslogor:..op,.sfop.:#3D.s_logor,.sf_logor;..1GOTO.
doassign#0A..2CASE.s_asseqv:..2op,.sfop.:#3D.s_eqv,
.sf_eqv;..5GOTO.doassign#0A..2CASE.s_assneqv:..1op,
.sfop.:#3D.s_neqv,.sf_neqv;..3GOTO.doassign#0A#0A..
2CASE.s_ass:..6op,.sfop.:#3D.0,.0;..13GOTO.doassign
#0A#0Adoassign:#0A..4context,.comline.:#3D.x,.h4!x#0A
..4assign(h2!x,.h3!x,.op,.sfop)#0A..4trnext(next)#0A
..4RETURN#0A.#0A..2CASE.s_rtap:#0A..2{.LET.s.#3D.ss
p#0A..4context,.comline.:#3D.x,.h4!x#0A..4ssp.:#3D.
ssp+savespacesize#0A..4out2(s_stack,.ssp)#0A..4load
list(h3!x)#0A..4load(h2!x)#0A..4out2(s_rtap,.s)#0A.
.4ssp.:#3D.s#0A..4trnext(next)#0A..4RETURN#0A..2}#0A
.#0A..2CASE.s_goto:#0A..4context,.comline.:#3D.x,.h
3!x#0A..4load(h2!x)#0A..4out1(s_goto)#0A..4ssp.:#3D
.ssp-1#0A..4RETURN#0A.#0A..2CASE.s_colon:#0A..4cont
ext,.comline.:#3D.x,.h5!x#0A..4out2(s_lab,.h4!x)#0A
..4trans(h3!x,.next)#0A..4RETURN#0A.#0A..2CASE.s_un
less:.sw.:#3D.TRUE#0A..2CASE.s_if:#0A..4context,.co
mline.:#3D.x,.h4!x#0A..4TEST.next>0.THEN.{.jumpcond
(h2!x,.sw,.next)#0A..23trans(h3!x,.next)#0A..21}#0A
..16ELSE.{.LET.l.#3D.nextlab()#0A..23jumpcond(h2!x,
.sw,.l)#0A..23trans(h3!x,.next)#0A..23out2(s_lab,.l
)#0A..23trnext(next)#0A..21}#0A..4RETURN#0A.#0A..2C
ASE.s_test:#0A..2{.LET.l,.m.#3D.nextlab(),.0#0A..4c
ontext,.comline.:#3D.x,.h5!x#0A..4jumpcond(h2!x,.FA
LSE,.l)#0A..7#0A..4TEST.next#3D0.THEN.{.m.:#3D.next
lab();.trans(h3!x,.m).}#0A..16ELSE.trans(h3!x,.next
)#0A..19#0A..4out2(s_lab,.l)#0A..4trans(h4!x,.next)
#0A..4UNLESS.m#3D0.DO.out2(s_lab,.m)#0A..4RETURN#0A
..2}#0A.#0A..2CASE.s_loop:#0A..4context,.comline.:#3D
.x,.h2!x#0A..4IF.looplab<0.DO.trnerr("Illegal.use.o
f.LOOP")#0A..4IF.looplab#3D0.DO.looplab.:#3D.nextla
b()#0A..4out2(s_jump,.looplab)#0A..4RETURN#0A#0A..2
CASE.s_break:#0A..4context,.comline.:#3D.x,.h2!x#0A
..4IF.breaklab#3D-2.DO.trnerr("Illegal.use.of.BREAK
")#0A..4IF.breaklab#3D-1.DO.{.out1(s_rtrn);.RETURN.
}#0A..4IF.breaklab#3D.0.DO.breaklab.:#3D.nextlab()#0A
..4out2(s_jump,.breaklab)#0A..4RETURN#0A.#0A..2CASE
.s_return:#0A..4context,.comline.:#3D.x,.h2!x#0A..4
out1(s_rtrn)#0A..4RETURN#0A.#0A..2CASE.s_skip:..//.
MR.05/4/06#0A..4trnext(next)#0A..4RETURN#0A#0A..2CA
SE.s_finish:#0A..4context,.comline.:#3D.x,.h2!x#0A.
.4out1(s_finish)#0A..4RETURN#0A.#0A..2CASE.s_result
is:#0A..4context,.comline.:#3D.x,.h3!x#0A..4IF.resu
ltlab#3D-1.DO.{.fnbody(h2!x);.RETURN.}#0A..4UNLESS.
resultlab>0.DO.trnerr("RESULTIS.out.of.context")#0A
..4load(h2!x)#0A..4out2(s_res,.resultlab)#0A..4ssp.
:#3D.ssp.-.1#0A..4RETURN#0A.#0A..2CASE.s_while:.sw.
:#3D.TRUE#0A..2CASE.s_until:#0A..2{.LET.l,.m.#3D.ne
xtlab(),.next#0A..4LET.bl,.ll.#3D.breaklab,.looplab
#0A..4context,.comline.:#3D.x,.h4!x#0A..4breaklab,.
looplab.:#3D.next,.0#0A..4IF.next<#3D0.DO.m.:#3D.ne
xtlab()#0A..4IF.next.#3D0.DO.breaklab.:#3D.m#0A..4j
umpcond(h2!x,.~sw,.m)#0A..4out2(s_lab,.l)#0A..4tran
s(h3!x,.0)#0A..4UNLESS.looplab#3D0.DO.out2(s_lab,.l
ooplab)#0A..4context,.comline.:#3D.x,.h4!x#0A..4jum
pcond(h2!x,.sw,.l)#0A..4IF.next<#3D0.DO.out2(s_lab,
.m)#0A..4trnext(next)#0A..4breaklab,.looplab.:#3D.b
l,.ll#0A..4RETURN#0A..2}#0A.#0A..2CASE.s_repeatwhil
e:.sw.:#3D.TRUE#0A..2CASE.s_repeatuntil:#0A..2{.LET
.l,.bl,.ll.#3D.nextlab(),.breaklab,.looplab#0A..4co
ntext,.comline.:#3D.x,.h4!x#0A..4breaklab,.looplab.
:#3D.next,.0#0A..4out2(s_lab,.l)#0A..4trans(h2!x,.0
)#0A..4UNLESS.looplab#3D0.DO.out2(s_lab,.looplab)#0A
..4context,.comline.:#3D.x,.h4!x#0A..4jumpcond(h3!x
,.sw,.l)#0A#0A//..2UNLESS.breaklab#3D0.DO.out2(s_la
b,.breaklab)#0A..4IF.next#3D0.&.breaklab>0.DO.out2(
s_lab,.breaklab)#0A#0A..4trnext(next)#0A..4breaklab
,.looplab.:#3D.bl,.ll#0A..4RETURN#0A..2}#0A.#0A..2C
ASE.s_repeat:#0A..2{.LET.bl,.ll.#3D.breaklab,.loopl
ab#0A..4context,.comline.:#3D.x,.h4!x#0A..4breaklab
,.looplab.:#3D.next,.nextlab()#0A..4out2(s_lab,.loo
plab)#0A#0A..4trans(h2!x,.looplab)#0A#0A..4IF.next#3D
0.&.breaklab>0.DO.out2(s_lab,.breaklab)#0A#0A..4bre
aklab,.looplab.:#3D.bl,.ll#0A..4RETURN#0A..2}#0A.#0A
..2CASE.s_case:#0A..2{.LET.l,.k,.cl.#3D.nextlab(),.
?,.caselist#0A..4context,.comline.:#3D.x,.h4!x#0A..
4k.:#3D.evalconst(h2!x)#0A..4IF.casecount<0.DO.trne
rr("CASE.label.out.of.context")#0A..4UNTIL.cl#3D0.D
O#0A..4{.IF.h2!cl#3Dk.DO.trnerr("'CASE.%n:'.occurs.
twice",.k)#0A..6cl.:#3D.h1!cl#0A..4}#0A..4caselist.
:#3D.newblk(caselist,.k,.l)#0A..4casecount.:#3D.cas
ecount.+.1#0A..4out2(s_lab,.l)#0A..4trans(h3!x,.nex
t)#0A..4RETURN#0A..2}#0A.#0A..2CASE.s_default:#0A..
4context,.comline.:#3D.x,.h3!x#0A..4IF.casecount<0.
|.defaultlab~#3D0.DO.trnerr("Bad.DEFAULT.label")#0A
..4defaultlab.:#3D.nextlab()#0A..4out2(s_lab,.defau
ltlab)#0A..4trans(h2!x,.next)#0A..4RETURN#0A.#0A..2
CASE.s_endcase:#0A..4context,.comline.:#3D.x,.h2!x#0A
..4IF.endcaselab#3D-2.DO.trnerr("Illegal.use.of.END
CASE")#0A..4IF.endcaselab#3D-1.DO.out1(s_rtrn)#0A..
4//.endcaselab.is.never.equal.to.0#0A..4IF.endcasel
ab>0..DO.out2(s_jump,.endcaselab)#0A..4RETURN#0A.#0A
..2CASE.s_switchon:#0A..4transswitch(x,.next)#0A..4
RETURN#0A.#0A..2CASE.s_for:#0A..4transfor(x,.next)#0A
..4RETURN#0A.#0A..2CASE.s_seq:#0A..4trans(h2!x,.0)#0A
..4x.:#3D.h3!x#0A..}#0A}.REPEAT#0A#0ALET.declnames(
x).BE.UNLESS.x#3D0.SWITCHON.h1!x.INTO#0A.#0A{.DEFAU
LT:..5trnerr("Compiler.error.in.Declnames")#0A..15R
ETURN#0A.#0A..CASE.s_vecdef:#0A..CASE.s_valdef:.con
text,.comline.:#3D.x,.h4!x#0A..15decldyn(h2!x)#0A..
15RETURN#0A.#0A..CASE.s_rtdef:#0A..CASE.s_fndef:..c
ontext,.comline.:#3D.x,.h6!x#0A..15h5!x.:#3D.nextla
b()#0A..15declstat(h2!x,.h5!x)#0A..15RETURN#0A.#0A.
.CASE.s_and:..2declnames(h2!x)#0A..15declnames(h3!x
)#0A}#0A.#0AAND.decldyn(x).BE.UNLESS.x#3D0.DO#0A.#0A
{.IF.h1!x#3Ds_name..DO.{.addname(x,.s_local,.ssp)#0A
..21//IF.xrefing.DO.xref(x,."P:",.ssp,.h1!context)#0A
..21ssp.:#3D.ssp.+.1#0A..21RETURN#0A..19}#0A.#0A..I
F.h1!x#3Ds_comma.DO.{.addname(h2!x,.s_local,.ssp)#0A
..21//IF.xrefing.DO.xref(h2!x,."P:",.ssp,.h1!contex
t)#0A..21ssp.:#3D.ssp.+.1#0A..21decldyn(h3!x)#0A..2
1RETURN#0A..19}#0A.#0A..trnerr("Compiler.error.in.D
ecldyn")#0A}#0A.#0AAND.declstat(x,.lab).BE#0A{.LET.
c.#3D.cellwithname(x)#0A.#0A..TEST.h2!c#3Ds_global.
THEN.{.LET.gn.#3D.h3!c#0A..26gdeflist.:#3D.newblk(g
deflist,.gn,.lab)#0A..26gdefcount.:#3D.gdefcount.+.
1#0A..26addname(x,.s_global,.gn)#0A..26IF.xrefing.D
O.xref(x,."G:",.gn,.h1!context)#0A..26IF.gdefsing.D
O.writef("G%i3.#3D.%s*n",.gn,.@h3!x)#0A..24}#0A..19
ELSE.{.addname(x,.s_label,.lab)#0A..26IF.xrefing.DO
.xref(x,."F:",.lab,.h1!context)#0A..24}#0A}#0A.#0AA
ND.decllabels(x).BE#0A{.LET.e.#3D.dvece#0A..scanlab
els(x)#0A..checkdistinct(e)#0A}#0A.#0AAND.checkdist
inct(p).BE#0A{.LET.lim.#3D.dvece.-.3#0A..FOR.q.#3D.
p.TO.lim-3.BY.3.DO#0A..{.LET.n.#3D.h1!q#0A..2FOR.c.
#3D.q+3.TO.lim.BY.3.DO#0A..6IF.h1!c#3Dn.DO.trnerr("
Name.%s.defined.twice",.@h3!n)#0A..}#0A}#0A.#0AAND.
addname(name,.k,.a).BE#0A{.LET.p.#3D.dvece.+.3#0A..
IF.p>dvect.DO.trnerr("More.workspace.needed")#0A..h
1!dvece,.h2!dvece,.h3!dvece.:#3D.name,.k,.a#0A..h2!
name.:#3D.dvece.//.Remember.the.declaration#0A..dve
ce.:#3D.p#0A}#0A.#0AAND.undeclare(e).BE.#0A{.FOR.t.
#3D.e.TO.dvece-3.BY.3.DO#0A..{.LET.name.#3D.h1!t#0A
..2h2!name.:#3D.0..1//.Forget.its.declaration#0A..}
#0A..dvece.:#3D.e#0A}#0A#0AAND.cellwithname(n).#3D.
VALOF#0A{.LET.t.#3D.h2!n#0A..IF.t.RESULTIS.t..//.It
.has.been.looked.up.before#0A..t.:#3D.dvece#0A..t.:
#3D.t.-.3.REPEATUNTIL.h1!t#3Dn.|.h1!t#3D0#0A..h2!n.
:#3D.t..//.Associate.the.name.with.declaration.item
#0A..RESULTIS.t#0A}#0A.#0AAND.scanlabels(x).BE.UNLE
SS.x#3D0.SWITCHON.h1!x.INTO#0A.#0A{.CASE.s_colon:..
1context,.comline.:#3D.x,.h5!x#0A..16h4!x.:#3D.next
lab()#0A..16declstat(h2!x,.h4!x)#0A.#0A..CASE.s_if:
.CASE.s_unless:.CASE.s_while:.CASE.s_until:#0A..CAS
E.s_switchon:.CASE.s_case:#0A..16scanlabels(h3!x)#0A
..16RETURN#0A.#0A..CASE.s_seq:..3scanlabels(h3!x)#0A
.#0A..CASE.s_repeat:.CASE.s_repeatwhile:.CASE.s_rep
eatuntil:#0A..CASE.s_default:.scanlabels(h2!x)#0A..
16RETURN#0A.#0A..CASE.s_test:..2scanlabels(h3!x)#0A
..16scanlabels(h4!x)#0A..DEFAULT:..6RETURN#0A}#0A.#0A
AND.transdef(x).BE#0A{.LET.ctxt,.ln.#3D.context,.co
mline#0A..transdyndefs(x)#0A..context,.comline.:#3D
.ctxt,.ln#0A..IF.statdefs(x).DO.{.LET.l,.s#3D.nextl
ab(),.ssp#0A..20out2(s_jump,.l)#0A..20transstatdefs
(x)#0A..20ssp.:#3D.s#0A..20out2(s_stack,.ssp)#0A..2
0out2(s_lab,.l)#0A..18}#0A..context,.comline.:#3D.c
txt,.ln#0A}#0A.#0A.#0AAND.transdyndefs(x).BE.SWITCH
ON.h1!x.INTO#0A{.CASE.s_and:..2transdyndefs(h2!x)#0A
..15transdyndefs(h3!x)#0A..15RETURN#0A.#0A..CASE.s_
vecdef:.context,.comline.:#3D.x,.h4!x#0A..15out2(s_
llp,.vecssp)#0A..15ssp.:#3D.ssp.+.1#0A..15vecssp.:#3D
.vecssp.+.1.+.evalconst(h3!x)#0A..15RETURN#0A.#0A..
CASE.s_valdef:.context,.comline.:#3D.h3!x,.h4!x#0A.
.15loadlist(h3!x)#0A.#0A..DEFAULT:..5RETURN#0A}#0A.
#0AAND.transstatdefs(x).BE.SWITCHON.h1!x.INTO#0A{.C
ASE.s_and:..transstatdefs(h2!x)#0A..13transstatdefs
(h3!x)#0A..13RETURN#0A.#0A..CASE.s_fndef:#0A..CASE.
s_rtdef:#0A..11{.LET.e,.p.#3D.dvece,.dvecp#0A..13AN
D.oldpn.#3D.procname#0A..13AND.bl,.ll.#3D.breaklab,
..looplab#0A..13AND.rl,.el.#3D.resultlab,.endcasela
b#0A..13AND.cl,.cc.#3D.caselist,..casecount#0A..13b
reaklab,..looplab..2:#3D.-2,.-2#0A..13resultlab,.en
dcaselab.:#3D.-2,.-2#0A..13caselist,..casecount..:#3D
..0000,.-1#0A..13procname.:#3D.h2!x#0A..13context,.
comline.:#3D.x,.h6!x#0A..13out2(s_entry,.h5!x)#0A..
13outstring(@h3!procname)#0A..13ssp.:#3D.savespaces
ize#0A..13dvecp.:#3D.dvece#0A..13context,.comline.:
#3D.x,.h6!x#0A..13decldyn(h3!x)#0A..13checkdistinct
(e)#0A..13context,.comline.:#3D.h4!x,.h6!x#0A..13de
cllabels(h4!x)#0A..13out2(s_save,.ssp)#0A..13contex
t,.comline.:#3D.h4!x,.h6!x#0A..13TEST.h1!x#3Ds_rtde
f.THEN.trans(h4!x,.-1)#0A..31ELSE.fnbody(h4!x)#0A..
13out1(s_endproc)#0A.#0A..13breaklab,..looplab..2:#3D
.bl,.ll#0A..13resultlab,.endcaselab.:#3D.rl,.el#0A.
.13caselist,..casecount..:#3D.cl,.cc#0A..13procname
.:#3D.oldpn#0A..13dvecp.:#3D.p#0A..13undeclare(e)#0A
..11}#0A.#0A..DEFAULT:..3RETURN#0A}#0A.#0AAND.statd
efs(x).#3D.h1!x#3Ds_fndef.|.h1!x#3Ds_rtdef.->.TRUE,
#0A..16h1!x.~#3D.s_and..13->.FALSE,#0A..16statdefs(
h2!x)..12->.TRUE,#0A..16statdefs(h3!x)#0A.#0A.#0ALE
T.jumpcond(x,.b,.l).BE#0A{.LET.sw.#3D.b#0A#0A..SWIT
CHON.h1!x.INTO#0A..{.CASE.s_false:..b.:#3D.NOT.b#0A
..2CASE.s_true:..1IF.b.DO.out2(s_jump,.l)#0A..17RET
URN#0A.#0A..2CASE.s_not:..2jumpcond(h2!x,.NOT.b,.l)
#0A..17RETURN#0A.#0A..2CASE.s_logand:.sw.:#3D.NOT.s
w#0A..2CASE.s_logor:..TEST.sw.THEN.{.jumpcond(h2!x,
.b,.l)#0A..32jumpcond(h3!x,.b,.l)#0A..32RETURN#0A..
30}#0A.#0A..25ELSE.{.LET.m.#3D.nextlab()#0A..32jump
cond(h2!x,.NOT.b,.m)#0A..32jumpcond(h3!x,.b,.l)#0A.
.32out2(s_lab,.m)#0A..32RETURN#0A..30}#0A.#0A..2DEF
AULT:..5load(x)#0A..17out2(b.->.s_jt,.s_jf,.l)#0A..
17ssp.:#3D.ssp.-.1#0A..17RETURN#0A..}#0A}#0A.#0AAND
.transswitch(x,.next).BE#0A{.LET.cl,.cc.#3D.caselis
t,.casecount.#0A..LET.dl,.el.#3D.defaultlab,.endcas
elab#0A..LET.l,.dlab.#3D.nextlab(),.?#0A..caselist,
.casecount,.defaultlab.:#3D.0,.0,.0#0A..endcaselab.
:#3D.next#3D0.->.nextlab(),.next#0A.#0A..context,.c
omline.:#3D.x,.h4!x#0A..out2(s_jump,.l)#0A..trans(h
3!x,.endcaselab)#0A.#0A..context,.comline.:#3D.x,.h
4!x#0A..out2(s_lab,.l)#0A..load(h2!x)#0A#0A..dlab.:
#3D.defaultlab>0.->.defaultlab,#0A..8endcaselab>0.-
>.endcaselab,#0A..8nextlab()#0A#0A..out2(s_switchon
,.casecount);.out1(dlab).#0A..UNTIL.caselist#3D0.DO
.{.out2(h2!caselist,.h3!caselist)#0A..22caselist.:#3D
.h1!caselist#0A..20}#0A..ssp.:#3D.ssp.-.1#0A#0A..IF
.next#3D0..14DO..1out2(s_lab,.endcaselab)#0A..IF.ne
xt<0.&.defaultlab#3D0.DO.{.out2(s_lab,.dlab)#0A..30
out1(s_rtrn)#0A..28}#0A#0A..defaultlab,.endcaselab.
:#3D.dl,.el#0A..caselist,..1casecount..:#3D.cl,.cc#0A
}#0A.#0AAND.transfor(x,.next).BE#0A{.LET.e,.m,.blab
.#3D.dvece,.nextlab(),.0#0A..LET.bl,.ll.#3D.breakla
b,.looplab#0A..LET.cc.#3D.casecount#0A..LET.k,.n,.s
tep.#3D.0,.0,.1#0A..LET.s.#3D.ssp#0A#0A..casecount.
:#3D.-1..//.Disallow.CASE.and.DEFAULT.labels#2E..1#0A
..breaklab,.looplab.:#3D.next,.0#0A..1#0A..context,
.comline.:#3D.x,.h7!x#0A.#0A..addname(h2!x,.s_local
,.s)#0A..load(h3!x)..5//.The.initial.value#0A.#0A..
//.Set.k,.n.to.load.the.end.limit#0A..TEST.h1!(h4!x
)#3Ds_number.THEN..2k,.n.:#3D.s_ln,.h2!(h4!x)#0A..2
4ELSE.{.k,.n.:#3D.s_lp,.ssp#0A..31load(h4!x)#0A..29
}#0A.#0A..UNLESS.h5!x#3D0.DO.step.:#3D.evalconst(h5
!x)#0A.#0A..out1(s_store)#0A..1#0A..TEST.k#3Ds_ln.&
.h1!(h3!x)#3Ds_number..//.check.for.constant.limits
.#0A..THEN.{.LET.initval.#3D.h2!(h3!x)#0A..7IF.step
>#3D0.&.initval>n.|.step<0.&.initval<n.DO#0A..7{.TE
ST.next<0#0A..9THEN.out1(s_rtrn)#0A..9ELSE.TEST.nex
t>0#0A..14THEN.out2(s_jump,.next)#0A..14ELSE.{.blab
.:#3D.breaklab>0.->.breaklab,.nextlab()#0A..21out2(
s_jump,.blab)#0A..19}#0A..7}#0A..5}#0A..ELSE.{.IF.n
ext<#3D0.DO.blab.:#3D.nextlab()#0A..7out2(s_lp,.s)#0A
..7out2(k,.n)#0A..7out1(step>#3D0.->.s_gr,.s_ls)#0A
..7out2(s_jt,.next>0.->.next,.blab)#0A..5}#0A#0A..I
F.breaklab#3D0.&.blab>0.DO.breaklab.:#3D.blab#0A..1
#0A..context,.comline.:#3D.x,.h7!x#0A..decllabels(h
6!x)#0A..context,.comline.:#3D.x,.h7!x#0A..out2(s_l
ab,.m)#0A..trans(h6!x,.0)#0A..UNLESS.looplab#3D0.DO
.out2(s_lab,.looplab)#0A..out2(s_lp,.s);.out2(s_ln,
.step);.out1(s_add);.out2(s_sp,.s)#0A..out2(s_lp,s)
;.out2(k,n);.out1(step>#3D0.->.s_le,.s_ge)#0A..out2
(s_jt,.m)#0A.#0A..IF.next<#3D0.TEST.blab>0.#0A..11T
HEN..16out2(s_lab,.blab)#0A..11ELSE.IF.breaklab>0.D
O.out2(s_lab,.breaklab)#0A..trnext(next)#0A..caseco
unt.:#3D.cc#0A..breaklab,.looplab,.ssp.:#3D.bl,.ll,
.s#0A..out2(s_stack,.ssp)#0A..undeclare(e)#0A}#0A.#0A
LET.load(x).BE#0A{.LET.op.#3D.h1!x#0A#0A..IF.iscons
t(x).DO#0A..{.out2(s_ln,.evalconst(x))#0A..2ssp.:#3D
.ssp.+.1#0A..2RETURN#0A..}#0A.#0A..SWITCHON.op.INTO
#0A..{.DEFAULT:#0A..4trnerr("Compiler.error.in.Load
,.op.#3D.%s",.opname(op))#0A..4out2(s_ln,.0)#0A..4s
sp.:#3D.ssp.+.1#0A..4RETURN#0A.#0A..2CASE.s_of:#0A.
.2//..1h2!x..of..h3!x#0A..2//.selector..1pointer#0A
..2{.LET.slct.#3D.evalconst(h2!x).//.Inserted.11/7/
01#0A..4LET.len.#3D.slct>>00024..7//.Field.length#0A
..4LET.sh..#3D.slct>>00016.&.255..1//.Bits.to.the.r
ight.of.field#0A..4LET.offset.#3D.slct.&.#23xFF2.//
.Word.offset#0A..4load(h3!x)..15//.Compile.the.poin
ter#0A..4IF.offset.DO#0A..4{.out2(s_ln,.offset)..5/
/.Add.offset.if.necessary#0A..6out1(s_add)#0A..4}#0A
..4TEST.len#3D0.&.sh#3D0#0A..4THEN.out1(s_rv)#0A..4
ELSE.out3(s_selld,.len,.sh)#0A..4RETURN#0A..2}#0A#0A
..2CASE.s_byteap:..2op:#3Ds_getbyte#0A#0A..2CASE.s_
fdiv:.CASE.s_fsub:#0A..2CASE.s_div:.CASE.s_rem:.CAS
E.s_sub:#0A..2CASE.s_fls:.CASE.s_fgr:.CASE.s_fle:.C
ASE.s_fge:#0A..2CASE.s_ls:.CASE.s_gr:.CASE.s_le:.CA
SE.s_ge:#0A..2CASE.s_lshift:.CASE.s_rshift:#0A..4lo
ad(h2!x);.load(h3!x);.out1(op)#0A..4ssp.:#3D.ssp.-.
1#0A..4RETURN#0A.#0A..2CASE.s_fmul:.CASE.s_fadd:.CA
SE.s_feq:.CASE.s_fne:#0A..2CASE.s_vecap:.CASE.s_mul
:.CASE.s_add:.CASE.s_eq:.CASE.s_ne:#0A..2CASE.s_log
and:.CASE.s_logor:.CASE.s_eqv:.CASE.s_neqv:#0A..2{.
LET.a,.b.#3D.h2!x,.h3!x#0A..4TEST.h1!a#3Ds_name.|#0A
..4h1!a#3Ds_number.THEN.{.load(b);.load(a).}#0A..18
ELSE.{.load(a);.load(b).}#0A..4TEST.op#3Ds_vecap.TH
EN.out2(s_add,.s_rv)#0A..20ELSE.out1(op)#0A..4ssp.:
#3D.ssp.-.1#0A..4RETURN#0A..2}#0A.#0A..2CASE.s_floa
t:CASE.s_fix:CASE.s_fneg:#0A..2CASE.s_neg:.CASE.s_n
ot:.CASE.s_rv:.CASE.s_abs:.CASE.s_fabs:#0A..4load(h
2!x)#0A..4out1(op)#0A..4RETURN#0A.#0A..2CASE.s_true
:.CASE.s_false:.CASE.s_query:#0A..4out1(op)#0A..4ss
p.:#3D.ssp.+.1#0A..4RETURN#0A.#0A..2CASE.s_lv:#0A..
4loadlv(h2!x)#0A..4RETURN#0A.#0A..2CASE.s_number:#0A
..4out2(s_ln,.h2!x)#0A..4ssp.:#3D.ssp.+.1#0A..4RETU
RN#0A.#0A..2CASE.s_fnum:#0A..4out3(s_fnum,.h2!x,.h3
!x)#0A..4ssp.:#3D.ssp.+.1#0A..4RETURN#0A.#0A..2CASE
.s_string:#0A..4out1(s_lstr)#0A..4outstring(@.h2!x)
#0A..4ssp.:#3D.ssp.+.1#0A..4RETURN#0A.#0A..2CASE.s_
name:#0A..4transname(x,.s_lp,.s_lg,.s_ll,.s_lf,.s_l
n)#0A..4ssp.:#3D.ssp.+.1#0A..4RETURN#0A.#0A..2CASE.
s_valof:#0A..2{.LET.e,.rl,.cc.#3D.dvece,.resultlab,
.casecount#0A..4casecount.:#3D.-1.//.Disallow.CASE.
&.DEFAULT.labels#0A..4resultlab.:#3D.nextlab()#0A..
4decllabels(h2!x)#0A..4trans(h2!x,.0)#0A..4out2(s_l
ab,.resultlab)#0A..4out2(s_rstack,.ssp)#0A..4ssp.:#3D
.ssp.+.1#0A..4resultlab,.casecount.:#3D.rl,.cc#0A..
4undeclare(e)#0A..4RETURN#0A..2}#0A.#0A..2CASE.s_fn
ap:#0A..2{.LET.s.#3D.ssp#0A..4ssp.:#3D.ssp.+.savesp
acesize#0A..4out2(s_stack,.ssp)#0A..4loadlist(h3!x)
#0A..4load(h2!x)#0A..4out2(s_fnap,.s)#0A..4ssp.:#3D
.s.+.1#0A..4RETURN#0A..2}#0A.#0A..2CASE.s_cond:#0A.
.2{.LET.l,.m.#3D.nextlab(),.nextlab()#0A..4LET.s.#3D
.ssp#0A..4jumpcond(h2!x,.FALSE,.m)#0A..4load(h3!x)#0A
..4out2(s_res,l)#0A..4ssp.:#3D.s;.out2(s_stack,.ssp
)#0A..4out2(s_lab,.m)#0A..4load(h4!x)#0A..4out2(s_r
es,l)#0A..4out2(s_lab,.l)#0A..4out2(s_rstack,s)#0A.
.4RETURN#0A..2}#0A.#0A..2CASE.s_table:#0A..2{.LET.m
.#3D.nextlab()#0A..4out2(s_datalab,.m)#0A..4x.:#3D.
h2!x#0A..4WHILE.h1!x#3Ds_comma.DO#0A..4{.out2(s_ite
mn,.evalconst(h2!x))#0A..6x.:#3D.h3!x#0A..4}#0A..4o
ut2(s_itemn,.evalconst(x))#0A..4out2(s_ll1,.m)#0A..
4ssp.:#3D.ssp.+.1#0A..4RETURN#0A..2}#0A..}#0A}#0A#0A
AND.fnbody(x).BE.SWITCHON.h1!x.INTO#0A{.DEFAULT:..7
load(x)#0A..17out1(s_fnrn)#0A..17ssp.:#3D.ssp.-.1#0A
..17RETURN#0A..17#0A..CASE.s_valof:.{.LET.e,.rl,.cc
.#3D.dvece,.resultlab,.casecount#0A..16casecount.:#3D
.-1.//.Disallow.CASE.&.DEFAULT.labels#0A..16resultl
ab.:#3D.-1#0A..16decllabels(h2!x)#0A..16trans(h2!x,
.-1)#0A..16resultlab,.casecount.:#3D.rl,.cc#0A..16u
ndeclare(e)#0A..16RETURN#0A..14}#0A#0A..CASE.s_cond
:..{.LET.l.#3D.nextlab()#0A..16jumpcond(h2!x,.FALSE
,.l)#0A..16fnbody(h3!x)#0A..16out2(s_lab,.l)#0A..16
fnbody(h4!x)#0A..14}#0A}#0A.#0A.#0AAND.loadlv(x).BE
#0A{.UNLESS.x#3D0.SWITCHON.h1!x.INTO#0A..{.DEFAULT:
..7ENDCASE#0A.#0A..2CASE.s_name:..3transname(x,.s_l
lp,.s_llg,.s_ll1,.0,.0)#0A..19ssp.:#3D.ssp.+.1#0A..
19RETURN#0A.#0A..2CASE.s_rv:..5load(h2!x)#0A..19RET
URN#0A.#0A..2CASE.s_vecap:.{.LET.a,.b.#3D.h2!x,.h3!
x#0A..18IF.h1!a#3Ds_name.DO.a,.b.:#3D.h3!x,.h2!x#0A
..18load(a)#0A..18load(b)#0A..18out1(s_add)#0A..18s
sp.:#3D.ssp.-.1#0A..18RETURN#0A..16}#0A..}#0A#0A..t
rnerr("Ltype.expression.needed")#0A..out2(s_ln,.0)#0A
..ssp.:#3D.ssp.+.1#0A}#0A.#0AAND.loadlist(x).BE.UNL
ESS.x#3D0.TEST.h1!x#3Ds_comma#0A..28THEN.{.loadlist
(h2!x);.loadlist(h3!x).}#0A..28ELSE.load(x)#0A#0ALE
T.isconst(x).#3D.VALOF#0A{.IF.x#3D0.RESULTIS.FALSE#0A
.#0A..SWITCHON.h1!x.INTO#0A..{.CASE.s_name:#0A..6{.
LET.c.#3D.cellwithname(x)#0A..8RESULTIS.h2!c#3Ds_ma
nifest#0A..6}#0A.#0A..2CASE.s_number:#0A..2CASE.s_s
lct:#0A..2CASE.s_true:#0A..2CASE.s_false:..RESULTIS
.TRUE#0A.#0A..2CASE.s_neg:#0A..2CASE.s_abs:#0A..2CA
SE.s_not:..2RESULTIS.isconst(h2!x)#0A..5#0A..2CASE.
s_mul:#0A..2CASE.s_div:#0A..2CASE.s_rem:#0A..2CASE.
s_add:#0A..2CASE.s_sub:#0A..2CASE.s_lshift:#0A..2CA
SE.s_rshift:#0A..2CASE.s_logor:#0A..2CASE.s_logand:
#0A..2CASE.s_eqv:#0A..2CASE.s_neqv:..1IF.isconst(h2
!x).&.isconst(h3!x).RESULTIS.TRUE#0A#0A..2DEFAULT:.
.5RESULTIS.FALSE#0A#0A..1}#0A}#0A#0ALET.evalconst(x
).#3D.VALOF#0A{.LET.a,.b.#3D.0,.0#0A#0A..IF.x#3D0.D
O.{.trnerr("Compiler.error.in.Evalconst")#0A..12RES
ULTIS.0#0A..10}#0A.#0A..SWITCHON.h1!x.INTO#0A..{.CA
SE.s_name:.{.LET.c.#3D.cellwithname(x)#0A..17LET.k,
.a.#3D.h2!c,.h3!c#0A..17IF.k#3Ds_manifest.DO#0A..17
{.IF.xrefing.DO.xref(x,."M:",.a,.s_const)#0A..19RES
ULTIS.a#0A..17}#0A..17IF.k.DO.trnerr("%s.must.be.a.
manifest.constant",.@h3!x)#0A..17trnerr("Name.'%s'.
not.declared",.@h3!x)#0A..17RESULTIS.0#0A..15}#0A.#0A
..2CASE.s_number:.RESULTIS.h2!x#0A..2CASE.s_true:..
1RESULTIS.TRUE#0A..2CASE.s_false:..RESULTIS.FALSE#0A
..2CASE.s_query:..RESULTIS.0#0A.#0A..2CASE.s_slct:.
{.LET.len,.sh,.offset.#3D.0,.0,.0..3//.Inserted.11/
7/01#0A..17IF.h2!x.DO.len..2:#3D.evalconst(h2!x)#0A
..17IF.h3!x.DO.sh..3:#3D.evalconst(h3!x)#0A..17IF.h
4!x.DO.offset.:#3D.evalconst(h4!x)#0A..17UNLESS.0<#3D
len<#3D255.&.0<#3Dsh<#3D255.&.0<#3Doffset<#3D#23xFF
2.DO#0A..21trnerr("A.field.too.large.in.a.SLCT.expr
ession")#0A..17//.Pack.the.selector.fields#0A..17RE
SULTIS.len<<00024.|.sh<<00016.|.offset#0A..15}#0A#0A
..2CASE.s_mul:#0A..2CASE.s_div:#0A..2CASE.s_rem:#0A
..2CASE.s_add:#0A..2CASE.s_sub:#0A..2CASE.s_lshift:
#0A..2CASE.s_rshift:#0A..2CASE.s_logor:#0A..2CASE.s
_logand:#0A..2CASE.s_eqv:#0A..2CASE.s_neqv:..1b.:#3D
.evalconst(h3!x)#0A#0A..2CASE.s_neg:#0A..2CASE.s_ab
s:#0A..2CASE.s_not:..2a.:#3D.evalconst(h2!x)#0A#0A.
.2DEFAULT:..5ENDCASE#0A..}#0A..2#0A..SWITCHON.h1!x.
INTO#0A..{.CASE.s_neg:..2RESULTIS..-..a#0A..2CASE.s
_abs:..2RESULTIS.ABS.a#0A..2CASE.s_not:..2RESULTIS.
NOT.a#0A..5#0A..2CASE.s_mul:..2RESULTIS.a..1*..2b#0A
..2CASE.s_add:..2RESULTIS.a..1+..2b#0A..2CASE.s_sub
:..2RESULTIS.a..1-..2b#0A..2CASE.s_lshift:.RESULTIS
.a..1<<..1b#0A..2CASE.s_rshift:.RESULTIS.a..1>>..1b
#0A..2CASE.s_logor:..RESULTIS.a..1|..2b#0A..2CASE.s
_logand:.RESULTIS.a..1&..2b#0A..2CASE.s_eqv:..2RESU
LTIS.a..EQV..1b#0A..2CASE.s_neqv:..1RESULTIS.a..NEQ
V..b#0A..2CASE.s_div:..2UNLESS.b#3D0.RESULTIS.a..1/
..2b#0A..2CASE.s_rem:..2UNLESS.b#3D0.RESULTIS.a..RE
M..1b#0A..5#0A..2DEFAULT:..5ENDCASE#0A..}#0A#0A..tr
nerr("Error.in.manifest.expression")#0A..RESULTIS.0
#0A}#0A#0AAND.assign(x,.y,.op,.sfop).BE#0A//.Compil
e.a.simultaneous.assigment#0A//.op.is.0.or.an.OCODE
.expression.operator.allowed.in.assignments,.ie#0A/
/.s_mul,.s_div,.etc#0A//.sfop.is.0.or.one.of.the.SE
LST.operators.allowed.in.assignments,.ie#0A//.sf_mu
l,.sf_div,.etc#0A{.IF.x#3D0.|.y#3D0.DO.{.trnerr("Co
mpiler.error.in.assign")#0A..18RETURN#0A..16}#0A#0A
..SWITCHON.h1!x.INTO#0A..{.CASE.s_comma:#0A..4UNLES
S.h1!y#3Ds_comma.DO#0A..4{.trnerr("Bad.simultaneous
.assignment")#0A..6RETURN#0A..4}#0A..4assign(h2!x,.
h2!y,.op,.sfop).//.Do.the.assignments.from.left.to.
right#0A..4assign(h3!x,.h3!y,.op,.sfop)#0A..4RETURN
#0A.#0A..2CASE.s_name:#0A..4load(y)#0A..4IF.op.DO#0A
..4{.loadlv(x)#0A..6out4(s_selst,.sfop,.0,.0)#0A..6
ssp.:#3D.ssp.-.2#0A..6RETURN#0A..4}#0A..4transname(
x,.s_sp,.s_sg,.s_sl,.0,.0)#0A..4ssp.:#3D.ssp.-.1#0A
..4RETURN#0A#0A..2CASE.s_rv:#0A..2CASE.s_vecap:#0A.
.4load(y)#0A..4loadlv(x)#0A..4IF.op.DO#0A..4{.out4(
s_selst,.sfop,.0,.0)#0A..6ssp.:#3D.ssp.-.2#0A..6RET
URN#0A..4}#0A..4out1(s_stind)#0A..4ssp.:#3D.ssp.-.2
#0A..4RETURN#0A.#0A..2CASE.s_of:#0A..2//..1h2!x..1o
f..1h3!x..1op:#3D..1y#0A..2//.selector..2pointer..o
p..2RHS#0A..2//.op.is:.mul,.div,.rem,.add,.sub,#0A.
.2//..6lshift,.rshift,.logand,.logor,.eqv,.neqv#0A.
.2//.op.can.be.vecap,.fmul,.fdiv,.fadd.or.fsub.if#0A
..2//.the.destinantion.is.a.full.word,.if.if.mask#3D
-1#0A..2{.LET.slct.#3D.evalconst(h2!x).//.Inserted.
11/7/01#0A..4LET.len.#3D.slct>>00024..7//.Field.siz
e#0A..4LET.sh..#3D.slct>>00016.&.255..1//.Shift#0A.
.4LET.offset.#3D.slct.&.#23xFF2.//.Offset#0A//write
f("Compiling.(SLCT.%n:%n:%n).OF.x.%s:#3D.y*n",#0A//
..8len,.sh,.offset,.sfname(op))#0A#0A..4load(y)#0A.
.4load(h3!x)..9//.Get.the.pointer#0A..4IF.offset.DO
#0A..4{.out2(s_ln,.offset).//.Add.offset.if.necessa
ry#0A..6out1(s_add)#0A..4}#0A..4IF.op#3D0.&.len#3D0
.&.sh#3D0.DO..//.No.op.and.full.word.field#0A..4{.o
ut1(s_stind)#0A..6ssp.:#3D.ssp-2#0A..6RETURN#0A..4}
#0A..4//.Non.null.op.or.not.a.full.word.field#0A..4
IF.len.|.sh.DO#0A..6//.It.is.not.a.full.word.field#0A
..6IF.op#3Dsf_fmul.|.op#3Dsf_fdiv.|.op#3Dsf_fadd.|.
op#3Dsf_fsub.DO#0A..8trnerr("Floating.point.%s.assi
gnment.to.a.non.full.word.field",#0A..17sfname(op))
#0A..4out4(s_selst,.sfop,.len,.sh).#0A..4ssp.:#3D.s
sp.-.2#0A..4RETURN#0A..2}#0A#0A..2CASE.s_byteap:#0A
..4TEST.op#0A..4THEN.{.//.It.is.not.a.full.word.fie
ld#0A..11IF.op#3Dsf_fmul.|.op#3Dsf_fdiv.|.op#3Dsf_f
add.|.op#3Dsf_fsub.DO#0A..13trnerr("Floating.point.
%s.assignment.to.a.non.full.word.field",#0A..21sfna
me(op))#0A..11load(x).//.Not.good.since.h2!x.and.h3
!x.gets.evaluated.twice#0A..11load(y)#0A..11out1(op
)#0A..11ssp.:#3D.ssp-1#0A..9}#0A..4ELSE.{.load(y)#0A
..9}#0A..4load(h2!x)#0A..4load(h3!x)#0A..4out1(s_pu
tbyte)#0A..4ssp:#3Dssp-3#0A..4RETURN#0A.#0A..2DEFAU
LT:#0A..4trnerr("Ltype.expression.needed")#0A..}#0A
}#0A.#0A.#0AAND.transname(x,.p,.g,.l,.f,.n).BE#0A{.
LET.c.#3D.cellwithname(x)#0A..LET.k,.a.#3D.h2!c,.h3
!c#0A.#0A..SWITCHON.k.INTO#0A..{.DEFAULT:..6trnerr(
"Name.'%s'.not.declared",.@h3!x)#0A..1#0A..2CASE.s_
global:..out2(g,.a)#0A..18IF.xrefing.DO.xref(x,."G:
",.a,.g)#0A..18RETURN#0A.#0A..2CASE.s_local:..1IF.c
<dvecp.DO#0A..23trnerr("Dynamic.free.variable.'%s'.
used",.@h3!x)#0A..18out2(p,.a)#0A..18//IF.xrefing.D
O.xref(x,."P:",.a,.p)#0A..18RETURN#0A.#0A..2CASE.s_
static:..out2(l,.a)#0A..18IF.xrefing.DO.xref(x,."S:
",.a,.l)#0A..18RETURN#0A.#0A..2CASE.s_label:..1IF.f
#3D0.DO#0A..18{.trnerr("Misuse.of.entry.name.'%s'",
.@h3!x)#0A..20f.:#3D.p#0A..18}#0A..18out2(f,.a)#0A.
.18IF.xrefing.DO.xref(x,."F:",.a,.f)#0A..18RETURN#0A
#0A..2CASE.s_manifest:IF.n#3D0.DO#0A..18{.trnerr("M
isuse.of.MANIFEST.name.'%s'",.@h3!x)#0A..20n.:#3D.p
#0A..18}#0A..18out2(n,.a)#0A..18IF.xrefing.DO.xref(
x,."M:",.a,.n)#0A..}#0A}#0A#0AAND.xref(x,.kstr,.n,.
op).BE#0A{.LET.name.#3D.@h3!x#0A..LET.fno.#3D.comli
ne>>00020#0A..LET.lno.#3D.comline.&.#23xFF3#0A..LET
.file.#3D.sourcenamev!fno#0A..writef("%s.%s",.name,
.kstr)#0A..TEST.-10_001_001.<#3D.n.<#3D.10_001_001#0A
..THEN.writef("%n.",.n)#0A..ELSE.writef("#23x%8x.",
.n)#0A#0A..SWITCHON.op.INTO#0A..{.DEFAULT:..7writef
("op%n",.op);.ENDCASE#0A#0A..2CASE.s_fndef:..2write
f("FN");..5ENDCASE#0A..2CASE.s_rtdef:..2writef("RT"
);..5ENDCASE#0A..2CASE.s_valdef:..1writef("VAL");..
4ENDCASE#0A..2CASE.s_vecdef:..1writef("VEC");..4END
CASE#0A..2CASE.s_constdef:.writef("DEF");..4ENDCASE
#0A..2CASE.s_const:..2writef("MAN");..4ENDCASE#0A..
2CASE.s_colon:..2writef("LAB");..4ENDCASE#0A..2CASE
.s_sp:..5writef("SP");..5ENDCASE#0A..2CASE.s_sg:..5
writef("SG");..5ENDCASE#0A..2CASE.s_sl:..5writef("S
L");..5ENDCASE#0A..2CASE.s_llp:..4writef("LLP");..4
ENDCASE#0A..2CASE.s_llg:..4writef("LLG");..4ENDCASE
#0A..2CASE.s_ll1:..4writef("LL1");..4ENDCASE#0A..2C
ASE.s_lp:..5writef("LP");..5ENDCASE#0A..2CASE.s_lg:
..5writef("LG");..5ENDCASE#0A..2CASE.s_ll:..5writef
("LL");..5ENDCASE#0A..2CASE.s_lf:..5writef("LF");..
5ENDCASE#0A..2CASE.s_ln:..5writef("LN");..5ENDCASE#0A
..}#0A..wrch('.')#0A..IF.file.DO.writef("%s",.file)
#0A..writef("[%n].",.lno)#0A#0A..prctxt(context)#0A
#0A..newline()#0A}#0A#0AAND.prctxt(x).BE.IF.x.DO.#0A
{.LET.op,.str.#3D.h1!x,.""#0A..SWITCHON.op.INTO#0A.
.{.DEFAULT:..prctxte(x,.4,.0);.RETURN#0A#0A..2CASE.
s_fndef:#0A..7writef("LET.")#0A..7prctxte(h2!x,.5,.
0)#0A..7wrch('(')#0A..7prctxte(h3!x,.7,.0)#0A..7wri
tef(")#3D#2E#2E")#0A..7RETURN#0A#0A..2CASE.s_rtdef:
#0A..7writef("LET.")#0A..7prctxte(h2!x,.5,.0)#0A..7
wrch('(')#0A..7prctxte(h3!x,.7,.0)#0A..7writef(")BE
#2E#2E")#0A..7RETURN#0A#0A..2CASE.s_valdef:#0A..7wr
itef("LET.")#0A..7prctxte(h2!x,.5,.0)#0A..7writef("
#3D")#0A..7prctxte(h3!x,.5,.0)#0A..7RETURN#0A#0A..2
CASE.s_vecdef:#0A..7writef("LET.")#0A..7prctxte(h2!
x,.5,.0)#0A..7writef("#3DVEC.")#0A..7prctxte(h3!x,.
5,.0)#0A..7RETURN#0A#0A..2CASE.s_constdef:#0A..7prc
txte(h3!x,.5,.0)#0A..7writef("#3D")#0A..7prctxte(h4
!x,.5,.0)#0A..7RETURN#0A#0A..2CASE.s_let:#0A..7writ
ef("LET.")#0A..7prctxtd(h2!x,.2)#0A..7writef(";.")#0A
..7prctxtc(h3!x,.2)#0A..7RETURN#0A.#0A..2CASE.s_sta
tic:..2writef("STATIC#2E#2E");..2RETURN#0A..2CASE.s
_global:..2writef("GLOBAL#2E#2E");..2RETURN#0A..2CA
SE.s_manifest:..writef("MANIFEST#2E#2E");..RETURN#0A
#0A1..2CASE.s_assvecap:..str.:#3D."!";..1GOTO.case_
ass#0A..2CASE.s_assfmul:..1str.:#3D."#23**";.GOTO.c
ase_ass#0A..2CASE.s_assfdiv:..1str.:#3D."#23/";..GO
TO.case_ass#0A..2CASE.s_assfadd:..1str.:#3D."#23+";
..GOTO.case_ass#0A..2CASE.s_assfsub:..1str.:#3D."#23
-";..GOTO.case_ass#0A..2CASE.s_assmul:..2str.:#3D."
**";..GOTO.case_ass#0A..2CASE.s_assdiv:..2str.:#3D.
"/";..1GOTO.case_ass#0A..2CASE.s_assrem:..2str.:#3D
."MOD";.GOTO.case_ass#0A..2CASE.s_assadd:..2str.:#3D
."+";..1GOTO.case_ass#0A..2CASE.s_ass1ub:..2str.:#3D
."-";..1GOTO.case_ass#0A..2CASE.s_asslshift:.str.:#3D
."<<";..GOTO.case_ass#0A..2CASE.s_assrshift:.str.:#3D
.">>";..GOTO.case_ass#0A..2CASE.s_asslogand:.str.:#3D
."&";..1GOTO.case_ass#0A..2CASE.s_asslogor:..str.:#3D
."|";..1GOTO.case_ass#0A..2CASE.s_asseqv:..2str.:#3D
."EQV";.GOTO.case_ass#0A..2CASE.s_assneqv:..1str.:#3D
."XOR";.GOTO.case_ass#0A#0A..2CASE.s_ass:..5str.:#3D
.""#0Acase_ass:#0A..7prctxte(h2!x,.4,.0)#0A..7write
f("%s:#3D",.str)#0A..7prctxte(h3!x,.4,.0)#0A..7RETU
RN#0A.#0A..2CASE.s_rtap:#0A..7prctxte(h2!x,.2,.12)#0A
..7writef("(")#0A..7prctxte(h3!x,.3,.0)#0A..7writef
(")")#0A..7RETURN#0A.#0A..2CASE.s_goto:#0A..7writef
("GOTO.")#0A..7prctxte(h2!x,.4,.0)#0A..7RETURN#0A.#0A
..2CASE.s_colon:#0A..7prctxte(h2!x,.2,.0)#0A..7writ
ef(":")#0A..7prctxt(h3!x,.3)#0A..7RETURN#0A.#0A..2C
ASE.s_unless:#0A..2CASE.s_if:#0A..2CASE.s_while:#0A
..2CASE.s_until:#0A..7writef(op#3Ds_unless->"UNLESS
.",#0A..14op#3Ds_if->"IF.",#0A..14op#3Ds_until->"UN
TIL.",#0A..14"WHILE."#0A..13)#0A..7prctxte(h2!x,.4,
.0)#0A..7writef(".DO.")#0A..7prctxtc(h3!x,.3)#0A..7
RETURN#0A#0A.#0A..2CASE.s_test:#0A..7writef("TEST."
)#0A..7prctxte(h2!x,.4,.0)#0A..7writef(".THEN.")#0A
..7prctxtc(h3!x,.2)#0A..7writef(".ELSE.")#0A..7prct
xtc(h4!x,.2)#0A..7RETURN#0A.#0A..2CASE.s_loop:#0A..
7writef("LOOP")#0A..7RETURN#0A.#0A..2CASE.s_skip:#0A
..7writef("{}")#0A..7RETURN#0A.#0A..2CASE.s_break:#0A
..7writef("BREAK")#0A..7RETURN#0A.#0A..2CASE.s_retu
rn:#0A..7writef("RETURN")#0A..7RETURN#0A.#0A..2CASE
.s_finish:#0A..7writef("FINISH")#0A..7RETURN#0A.#0A
..2CASE.s_resultis:#0A..7writef("RESULTIS.")#0A..7p
rctxte(h2!x,.4,.0)#0A..7RETURN#0A.#0A..2CASE.s_repe
atwhile:#0A..2CASE.s_repeatuntil:#0A..7prctxtc(h2!x
,.4)#0A..7writef(op#3Ds_repeatwhile.->.".REPEATWHIL
E.",.".REPEATUNTIL.")#0A..7prctxte(h3!x,.4,.0)#0A..
7RETURN#0A.#0A..2CASE.s_repeat:#0A..7prctxtc(h2!x,.
4)#0A..7writef(".REPEAT")#0A..7RETURN#0A.#0A..2CASE
.s_case:#0A..7writef("CASE.")#0A..7prctxte(h2!x,.4,
.0)#0A..7writef(":#2E#2E.")#0A..7RETURN#0A.#0A..2CA
SE.s_default:#0A..7writef("DEFAULT:#2E#2E")#0A..7RE
TURN#0A.#0A..2CASE.s_endcase:#0A..7writef("ENDCASE"
)#0A..7RETURN#0A.#0A..2CASE.s_switchon:#0A..7writef
("SWITCHON.")#0A..7prctxte(h2!x,.4,.0)#0A..7writef(
".INTO#2E#2E")#0A..7RETURN#0A.#0A..2CASE.s_for:#0A.
.7writef("FOR.")#0A..7prctxte(h2!x,.4,.0)#0A..7writ
ef("#3D")#0A..7prctxte(h3!x,.4,.0)#0A..7writef(".TO
.")#0A..7prctxte(h4!x,.4,.0)#0A..7IF.h5!x.DO.{.writ
ef(".BY.");.prctxte(h5!x,.4,.0).}#0A..7writef(".DO#2E
#2E")#0A..7RETURN#0A.#0A..2CASE.s_seq:#0A..7prctxtc
(h2!x,.4)#0A..7writef(";")#0A..7prctxtc(h3!x,.4)#0A
..7RETURN#0A..}#0A}#0A#0AAND.prctxtd(x,.d).BE.write
f("#2E#2E")#0AAND.prctxtc(x,.d).BE.writef("#2E#2E")
#0A#0AAND.prctxte(x,.d,.prec).BE.IF.x.DO#0A{.LET.op
,.str.#3D.h1!x,.""#0A#0A..SWITCHON.op.INTO#0A..{.DE
FAULT:.ENDCASE#0A#0A..2CASE.s_number:.#0A..15{.LET.
n.#3D.h2!x#0A..17TEST.-1_001_001<#3Dn<#3D1_001_001#0A
..17THEN.writef("%n",.n)#0A..17ELSE.writef("#23x%x8
",.n)#0A..17RETURN#0A..15}.#0A..2CASE.s_fnum:..1wri
tef("#23%ne%n",.h2!x,.h3!x);.RETURN#0A..2CASE.s_nam
e:..1writef("%s",.@h3!x);..8RETURN#0A..2CASE.s_true
:..1writef("TRUE");..13RETURN#0A..2CASE.s_false:..w
ritef("FALSE");..12RETURN#0A..2CASE.s_query:..wrch(
'?');..18RETURN#0A#0A..2CASE.s_string:.#0A..15{.LET
.s.#3D.@h2!x#0A..17LET.len.#3D.s%0#0A..17wrch('"')#0A
..17FOR.i.#3D.1.TO.len.DO#0A..17{.LET.ch.#3D.s%i#0A
..19IF.i#3D6.&.len>6+8.DO.{.writef("'");.LOOP.}#0A.
.19IF.i<#3D6.|.i>len-8.DO.//.First.5.and.last.8.cha
rs#0A..19{.SWITCHON.ch.INTO#0A..21{.CASE.'**':.writ
ef("**2");.LOOP#0A..23CASE.'*"':.writef("**1"");.LO
OP#0A..23CASE.'*n':.writef("**n");..LOOP#0A..21}#0A
..21UNLESS.32<#3Dch<#3D127.DO.ch.:#3D.'?'#0A..21wrc
h(ch)#0A..19}#0A..17}#0A..17wrch('"')#0A..17RETURN#0A
..15}#0A#0A..}#0A#0A..IF.d#3D0.DO.{.writef("#2E#2E1
");.RETURN.}#0A#0A..IF.prec>#3D12.DO.{.wrch('(');.p
rctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHO
N.op.INTO#0A..{.DEFAULT:.ENDCASE#0A#0A..2CASE.s_fna
p:#0A..7prctxte(h2!x,.d-1,.11)#0A..7wrch('(')#0A..7
prctxte(h3!x,.d-1,.0)#0A..7wrch(')')#0A..7RETURN#0A
..}#0A#0A..IF.prec>#3D11.DO.{.wrch('(');.prctxte(x,
.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.op.INTO
#0A..{.DEFAULT:.ENDCASE#0A#0A..2CASE.s_slct:#0A..4{
..writes("SLCT.")#0A..7prctxte(h2!x,.d-1,.10)#0A..7
writes(":")#0A..7prctxte(h3!x,.d-1,.10)#0A..7writes
(":")#0A..7prctxte(h4!x,.d-1,.10)#0A..7RETURN#0A..4
}#0A#0A..2CASE.s_of:..3str.:#3D."::";..GOTO.case_of
#0A..2CASE.s_byteap:.str.:#3D."%";..1GOTO.case_of#0A
..2CASE.s_vecap:..str.:#3D."!";..1GOTO.case_of#0Aca
se_of:#0A..7prctxte(h2!x,.d-1,.10)#0A..7writes(str)
#0A..7prctxte(h3!x,.d-1,.10)#0A..7RETURN#0A#0A..2CA
SE.s_rv:.str.:#3D."!";..1GOTO.case_rv#0A..2CASE.s_l
v:.str.:#3D."@";..1GOTO.case_rv#0Acase_rv:#0A..7wri
tes(str)#0A..7prctxte(h2!x,.d-1,.10)#0A..7RETURN#0A
..}#0A#0A..IF.prec>#3D10.DO.{.wrch('(');.prctxte(x,
.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.op.INTO
#0A..{.DEFAULT:.ENDCASE#0A..2CASE.s_fmul:..str.:#3D
."#23**";.GOTO.case_mul.#0A..2CASE.s_fdiv:..str.:#3D
."#23/";..GOTO.case_mul.#0A..2CASE.s_mul:..1str.:#3D
."**";..GOTO.case_mul.#0A..2CASE.s_div:..1str.:#3D.
"/";..1GOTO.case_mul.#0A..2CASE.s_rem:..1str.:#3D."
MOD";.GOTO.case_mul.#0Acase_mul.:#0A..7prctxte(h2!x
,.d-1,.9)#0A..7writes(str)#0A..7prctxte(h3!x,.d-1,.
9)#0A..7RETURN#0A..}#0A#0A..IF.prec>#3D9.DO.{.wrch(
'(');.prctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..
SWITCHON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A..2CASE.s
_fadd:..1str.:#3D."#23+";.GOTO.case_add#0A..2CASE.s
_fsub:..1str.:#3D."#23-";.GOTO.case_add#0A..2CASE.s
_add:..2str.:#3D."+";..GOTO.case_add#0A..2CASE.s_su
b:..2str.:#3D."-";..GOTO.case_add#0Acase_add:#0A..7
prctxte(h2!x,.d-1,.8)#0A..7writes(str)#0A..7prctxte
(h3!x,.d-1,.8)#0A..7RETURN#0A#0A..2CASE.s_fneg:..1s
tr.:#3D."#23-";..1GOTO.case_neg#0A..2CASE.s_neg:..2
str.:#3D."-";..2GOTO.case_neg#0A..2CASE.s_fabs:..1s
tr.:#3D."FABS";.GOTO.case_neg#0A..2CASE.s_abs:..2st
r.:#3D."ABS";..GOTO.case_neg#0Acase_neg:#0A..7write
s(str)#0A..7prctxte(h2!x,.d-1,.8)#0A..7RETURN#0A#0A
..}#0A#0A..IF.prec>#3D8.DO.{.wrch('(');.prctxte(x,.
d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.op.INTO#0A
..{.DEFAULT:.ENDCASE#0A..2CASE.s_feq:..1str.:#3D."#23
#3D";..GOTO.case_eq#0A..2CASE.s_fne:..1str.:#3D."#23
~#3D";.GOTO.case_eq#0A..2CASE.s_fls:..1str.:#3D."#23
<";..GOTO.case_eq#0A..2CASE.s_fgr:..1str.:#3D."#23>
";..GOTO.case_eq#0A..2CASE.s_fle:..1str.:#3D."#23<#3D
";.GOTO.case_eq#0A..2CASE.s_fge:..1str.:#3D."#23>#3D
";.GOTO.case_eq#0A..2CASE.s_eq:..2str.:#3D."#3D";..
1GOTO.case_eq#0A..2CASE.s_ne:..2str.:#3D."~#3D";..G
OTO.case_eq#0A..2CASE.s_ls:..2str.:#3D."<";..1GOTO.
case_eq#0A..2CASE.s_gr:..2str.:#3D.">";..1GOTO.case
_eq#0A..2CASE.s_le:..2str.:#3D."<#3D";..GOTO.case_e
q#0A..2CASE.s_ge:..2str.:#3D.">#3D";..GOTO.case_eq#0A
case_eq:#0A..7prctxte(h2!x,.d-1,.7)#0A..7writes(str
)#0A..7prctxte(h3!x,.d-1,.7)#0A..7RETURN#0A..}#0A#0A
..IF.prec>#3D7.DO.{.wrch('(');.prctxte(x,.d,.0);.wr
ch(')');.RETURN.}#0A#0A..SWITCHON.op.INTO#0A..{.DEF
AULT:.ENDCASE#0A..2CASE.s_lshift:..1str.:#3D."<<";.
.GOTO.case_lshift#0A..2CASE.s_rshift:..1str.:#3D.">
>";..GOTO.case_lshift#0Acase_lshift:#0A..7prctxte(h
2!x,.d-1,.6)#0A..7writes(str)#0A..7prctxte(h3!x,.d-
1,.6)#0A..7RETURN#0A..}#0A#0A..IF.prec>#3D6.DO.{.wr
ch('(');.prctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A
..SWITCHON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A..2CASE
.s_not:#0A..7wrch('~')#0A..7prctxte(h2!x,.d-1,.5)#0A
..7RETURN#0A..}#0A#0A..IF.prec>#3D5.DO.{.wrch('(');
.prctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITC
HON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A..2CASE.s_loga
nd:#0A..7prctxte(h2!x,.d-1,.4)#0A..7wrch('&')#0A..7
prctxte(h3!x,.d-1,.4)#0A..7RETURN#0A..}#0A#0A..IF.p
rec>#3D4.DO.{.wrch('(');.prctxte(x,.d,.0);.wrch(')'
);.RETURN.}#0A#0A..SWITCHON.op.INTO#0A..{.DEFAULT:.
ENDCASE#0A..2CASE.s_logor:#0A..7prctxte(h2!x,.d-1,.
3)#0A..7wrch('|')#0A..7prctxte(h3!x,.d-1,.3)#0A..7R
ETURN#0A..}#0A#0A..IF.prec>#3D3.DO.{.wrch('(');.prc
txte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.
op.INTO#0A..{.DEFAULT:.ENDCASE#0A..2CASE.s_eqv:..st
r.:#3D."EQV";.GOTO.case_eqv#0A..2CASE.s_neqv:.str.:
#3D."XOR";.GOTO.case_eqv#0Acase_eqv:#0A..7prctxte(h
2!x,.d-1,.2)#0A..7writes(str)#0A..7prctxte(h3!x,.d-
1,.2)#0A..7RETURN#0A#0A..}#0A#0A..IF.prec>#3D2.DO.{
.wrch('(');.prctxte(x,.d,.0);.wrch(')');.RETURN.}#0A
#0A..SWITCHON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A..2C
ASE.s_cond:#0A..7prctxte(h2!x,.d-1,.1)#0A..7writef(
"->")#0A..7prctxte(h3!x,.d-1,.1)#0A..7writef(",")#0A
..7prctxte(h4!x,.d-1,.1)#0A..7RETURN#0A..}#0A#0A..I
F.prec>#3D1.DO.{.wrch('(');.prctxte(x,.d,.0);.wrch(
')');.RETURN.}#0A#0A..SWITCHON.op.INTO#0A..{.DEFAUL
T:.writef("Op%n",.op);.RETURN#0A#0A..2CASE.s_table:
#0A..7writef("TABLE.")#0A..7prctxte(h2!x,.d-1,.0)#0A
..7RETURN#0A..7#0A..2CASE.s_valof:#0A..7writef("VAL
OF.{")#0A..7prctxtc(h2!x,.d-1)#0A..7wrch('}')#0A..7
RETURN#0A#0A..2CASE.s_comma:#0A..7prctxte(h2!x,.d-1
,.0)#0A..7writef(",")#0A..7prctxte(h3!x,.d-1,.0)#0A
..7RETURN#0A..}#0A}#0A#0A1AND.out1(x).BE.wrn(x)#0A.
#0AAND.out2(x,.y).BE.{.out1(x);.out1(y).}#0A.#0AAND
.out3(x,.y,.z).BE.{.out1(x);.out1(y);.out1(z).}#0A.
#0AAND.out4(x,.y,.z,.t).BE.{.out1(x);.out1(y);.out1
(z);.out1(t).}#0A.#0AAND.outstring(s).BE.FOR.i.#3D.
0.TO.s%0.DO.out1(s%i)#0A

######com/xcdecode.b#
SECTION."XCDECODE"#0D#0A#0D#0AGET."libhdr"#0D#0A#0D
#0A/*#0D#0AThis.program.decodes.a.file.encoded.by.t
he.xcencode.command#2E#0D#0ASee.xcencode#2Eb.for.de
tails#2E#0D#0A#0D#0AWritten.by.Martin.Richards.(c).
September.2000008#0D#0A*/#0D#0A#0D#0AGLOBAL#0D#0A{#0D
#0Ainputstream:ug#0D#0Aoutstream#0D#0Ahashcount#0D#0A
listing#0D#0Aprevch#0D#0Arepcount#0D#0Adigits#0D#0A
wrc#0D#0Ardc#0D#0A}#0D#0A#0D#0ALET.rdc().#3D.VALOF#0D
#0A{.LET.ch.#3D.rdch()#0D#0A..//.Ignore.all.control
.characters.other.than.*n#0D#0A..IF.0<#3Dch<#3D31.U
NLESS.ch#3D'*n'.LOOP#0D#0A..RESULTIS.ch#0D#0A}.REPE
AT#0D#0A#0D#0ALET.start().#3D.VALOF#0D#0A{.LET.coun
t.#3D.0#0D#0A..LET.argv.#3D.VEC.50#0D#0A..LET.fromn
ame.#3D."data"#0D#0A..LET.toname.#3D.VEC.256/bytesp
erword#0D#0A..LET.rc.#3D.0#0D#0A..LET.ch.#3D.0#0D#0A
..LET.stdout.#3D.output()#0D#0A#0D#0A..inputstream.
:#3D.0#0D#0A..outstream.:#3D.0#0D#0A..listing.:#3D.
FALSE#0D#0A..newline()#0D#0A#0D#0A..IF.rdargs("FROM
/A,LIST/S,BIN/S",.argv,.50).#3D.0.DO#0D#0A..{.write
s("Bad.args.for.XCDECODE*n")#0D#0A..3rc.:#3D.20#0D#0A
..3GOTO.exit#0D#0A..}#0D#0A#0D#0A..fromname.:#3D.ar
gv!0..9//.FROM/A#0D#0A..listing..:#3D.argv!1..9//.L
IST/S#0D#0A..wrc.:#3D.wrch#0D#0A..IF.argv!2.DO.wrc.
:#3D.binwrch..//.BIN/S#0D#0A#0D#0A..inputstream.:#3D
.findinput(fromname)#0D#0A..UNLESS.inputstream.DO.{
.writef("Can*'t.open.%s*n",.fromname)#0D#0A..24rc.:
#3D.20#0D#0A..24GOTO.exit#0D#0A..22}#0D#0A..selecti
nput(inputstream)#0D#0A#0D#0A..hashcount.:#3D.0#0D#0A
#0D#0Anext:#0D#0A..//.Start.of.main.extraction.loop
#0D#0A..selectoutput(stdout)#0D#0A..#0D#0A..{.//.Fi
nd.the.next.separator#0D#0A..2ch.:#3D.rdc()#0D#0A#0D
#0A..2IF.ch#3Dendstreamch.GOTO.exit#0D#0A#0D#0A..2I
F.ch#3D'#23'.DO#0D#0A..2{.hashcount.:#3D.hashcount+
1#0D#0A#0D#0A..4{.ch.:#3D.rdc()#0D#0A..6IF.ch#3D'*n
'.LOOP#0D#0A..6IF.ch#3Dendstreamch.GOTO.exit#0D#0A.
.6UNLESS.ch#3D'#23'.BREAK#0D#0A..6hashcount.:#3D.ha
shcount+1#0D#0A..4}.REPEAT#0D#0A#0D#0A..4//.Hashcou
nt.#3D.number.of.consecutive.'#23's#0D#0A..4//.If.>
#3D.6.then.we.have.a.separator#2E.It.should.be.of.t
he.form#0D#0A..4//.#23#234filename#23,.ignoring.new
lines.in.the.filename#2E#0D#0A..4IF.hashcount>#3D6.
DO#0D#0A..4{.//.Read.the.filename.into.toname#0D#0A
..6LET.len.#3D.0#0D#0A..6toname%0.:#3D.0#0D#0A..6UN
TIL.ch#3D'#23'.DO#0D#0A..6{.IF.ch#3Dendstreamch.GOT
O.exit#0D#0A..8UNLESS.ch#3D'*n'.DO#0D#0A..8{.len.:#3D
.len+1#0D#0A..10IF.len>255.BREAK#0D#0A..10toname%0,
.toname%len.:#3D.len,.ch#0D#0A..8}#0D#0A..8ch.:#3D.
rdc()#0D#0A..6}#0D#0A#0D#0A..6//writef("Item.separa
tor.found*n")#0D#0A..6//FOR.i.#3D.1.TO.hashcount.DO
.wrch('#23')#0D#0A..6//writef("%s%c*n",.toname,.ch)
#0D#0A#0D#0A..6IF.toname%0#3D1.&.toname%1#3D'+'.DO#0D
#0A..6{.//.Final.terminator.found#0D#0A..8GOTO.exit
#0D#0A..6}#0D#0A#0D#0A..6UNLESS.ch#3D'#23'.&.0<len<
256.&.hashcount>#3D6.DO#0D#0A..6{.writef("Bad.item.
separator*n")#0D#0A..8FOR.i.#3D.1.TO.hashcount.DO.w
rch('#23')#0D#0A..8writef("%s%c*n",.toname,.ch)#0D#0A
..8GOTO.exit#0D#0A..6}#0D#0A..6BREAK#0D#0A..4}#0D#0A
..2}#0D#0A..}.REPEATUNTIL.ch#3Dendstreamch#0D#0A#0D
#0A..IF.ch#3Dendstreamch.GOTO.exit#0D#0A#0D#0A..wri
tef("Decoding.to.file:.%s*n",.toname)#0D#0A#0D#0A..
IF.listing.DO.toname.:#3D."NIL:"#0D#0A#0D#0A..outst
ream.:#3D.0#0D#0A#0D#0A..UNLESS.listing.DO#0D#0A..{
.outstream.:#3D.findoutput(toname)#0D#0A..2UNLESS.o
utstream.DO#0D#0A..2{.writef("Can*'t.open.%s*n",.to
name)#0D#0A..4rc.:#3D.20#0D#0A..4GOTO.exit#0D#0A..2
}#0D#0A#0D#0A..2selectoutput(outstream)#0D#0A..}#0D
#0A#0D#0A..prevch.:#3D.-1#0D#0A..repcount.:#3D.0#0D
#0A..digits.:#3D.-1#0D#0A#0D#0A..{.ch.:#3D.rdc()#0D
#0A#0D#0A..2SWITCHON.ch.INTO#0D#0A..2{.DEFAULT:..1I
F.outstream.DO.putch(ch)#0D#0A..15LOOP#0D#0A#0D#0A.
.4CASE.endstreamch:#0D#0A..15GOTO.exit#0D#0A#0D#0A.
.4CASE.'#2E':..IF.outstream.DO.putch('.')#0D#0A..15
LOOP#0D#0A#0D#0A..4CASE.'#3D':..8//.'#3D'.must.be.e
scaped!#0D#0A..4CASE.'*n':.LOOP#0D#0A#0D#0A..4CASE.
'#23':..//.Either.an.escaped.character.or.the.start
.of.a.separator#0D#0A..13{.LET.a,.b.#3D.?,.?#0D#0A#0D
#0A..15a.:#3D.rdc().REPEATWHILE.a#3D'*n'#0D#0A..15b
.:#3D.rdc().REPEATWHILE.b#3D'*n'#0D#0A#0D#0A..15IF.
a#3D'#23'.&.b#3D'#23'.DO#0D#0A..15{.//.It.must.be.a
.separator#0D#0A..17hashcount.:#3D.3#0D#0A..17IF.ou
tstream.DO.endstream(outstream)#0D#0A..17outstream.
:#3D.0#0D#0A..17selectoutput(stdout)#0D#0A..17GOTO.
next#0D#0A..15}#0D#0A..15IF.a#3Dendstreamch.|.b#3De
ndstreamch.GOTO.exit#0D#0A..15//.Otherwise.write.es
caped.character#0D#0A..15IF.outstream.DO.putch((val
ue(a)<<0004).+.value(b))#0D#0A..15LOOP#0D#0A..13}#0D
#0A..2}#0D#0A..}.REPEAT#0D#0A#0D#0Aexit:#0D#0A..IF.
inputstream..DO.{.endstream(inputstream);.inputstre
am.:#3D.0.}#0D#0A..IF.outstream..2DO.{.endstream(ou
tstream);..1outstream.:#3D.0.}#0D#0A..RESULTIS.rc#0D
#0A}#0D#0A#0D#0AAND.putch(ch).BE#0D#0A{.IF.0<#3Ddig
its<3.&.'0'<#3Dch<#3D'9'.DO#0D#0A..{.//.We.are.read
ing.a.repetition.count.and.have.another.digit#0D#0A
..2repcount.:#3D.repcount*10.+.ch.-.'0'#0D#0A..2dig
its.:#3D.digits+1#0D#0A..2IF.digits<3.RETURN..//.Th
ere.might.be.another.run-length.digit#0D#0A..}#0D#0A
#0D#0A..//.Output.prevch.repcount.(usually.zero).ti
mes#0D#0A..WHILE.repcount.DO.{..wrc(prevch);.repcou
nt.:#3D.repcount-1.}#0D#0A#0D#0A..IF.digits#3D3.DO#0D
#0A..{.//.ch.holds.the.third.digit.of.the.latest.re
petition.count#0D#0A..2digits.:#3D.-1#0D#0A..2RETUR
N#0D#0A..}#0D#0A#0D#0A..//.We.are.no.longer.in.a.re
petition.count.and.ch.is.the#0D#0A..//.next.charact
er.to.output#0D#0A..digits.:#3D.-1#0D#0A#0D#0A..IF.
ch#3Dprevch.DO#0D#0A..{.//.Deal.with.a.new.run-leng
th.item#0D#0A..2wrc(ch)#0D#0A..2//.Start.a.new.run-
length.count#0D#0A..2repcount,.digits.:#3D.0,.0#0D#0A
..2RETURN#0D#0A..}#0D#0A..//.ch.was.different.from.
prevch.and.so.did.not.trigger#0D#0A..//.a.run-lengt
h.item#0D#0A..wrc(ch)#0D#0A..prevch.:#3D.ch#0D#0A}#0D
#0A#0D#0AAND.value(ch).#3D.VALOF.SWITCHON.ch.INTO#0D
#0A{.DEFAULT:#0D#0A..2writef("#23#23%x2#23#23",.ch)
#0D#0A..2RESULTIS.0#0D#0A#0D#0A..CASE.'0':CASE.'1':
CASE.'2':CASE.'3':CASE.'4':#0D#0A..CASE.'5':CASE.'6
':CASE.'7':CASE.'8':CASE.'9':#0D#0A..2RESULTIS.ch-'
0'#0D#0A..2#0D#0A..CASE.'A':CASE.'B':CASE.'C':CASE.
'D':CASE.'E':#0D#0A..CASE.'F':#0D#0A..2RESULTIS.ch.
-.'A'.+.10#0D#0A#0D#0A..CASE.'a':CASE.'b':CASE.'c':
CASE.'d':CASE.'e':#0D#0A..CASE.'f':#0D#0A..2RESULTI
S.ch.-.'a'.+.10#0D#0A}#0D#0A

######com/xcencode.b#
SECTION."XCENCODE"#0D#0A#0D#0AGET."libhdr"#0D#0A#0D
#0A/*#0D#0AThis.program.encodes.a.collection.of.one
.or.more.character#0D#0Aor.binary.files.into.a.file
.of.printable.characters.with.lines#0D#0Aof.about.5
0.characters.suitable.for.transmission.by.email#2E.
It.uses#0D#0Arun.length.encoding.to.make.the.encode
d.file.more.compact#2E.If.the#0D#0Asame.byte.occurs
.twice.consecutively.the.next.byte.is.a.count#0D#0A
between.0.and.255.of.how.many.more.repetitions.ther
e.are#2E#0D#0A#0D#0AUsage:.xcencode."FILE,LIST/K,TO
/K/A,BIN/S"#0D#0A#0D#0Awhere.FILE.is.the.name.of.a.
single.file.to.encode#0D#0A..4LIST.is.a.list.of.fil
e.names.of.files.to.encode#2E#0D#0A..4TO..1is.the.e
ncoded.file#0D#0A.and..BIN..is.set.the.file.is.to.b
e.read.using.binrdch.so.that#0D#0A..9carriage.retur
n.('*c').characters.are.not.ignored#2E#0D#0A#0D#0AO
ne.or.other.of.FILE.and.LIST.must.be.supplied#2E#0D
#0AIf.both.are.given.FILE.will.give.the.first.filen
ame.to.be.encoded#0D#0Afollowed.by.those.given.by.L
IST#2E#0D#0A#0D#0AEach.encoded.file.is.preceeded.by
.a.separator.of.the.form:#0D#0A#0D#0A#23#233filenam
e#23#0D#0A#0D#0Afollowed.by.the.encoded.file.in.whi
ch.all.characters.with.ASCII.codes#0D#0Ain.the.rang
e.33.to.126.except.for.'#23',.'#3D'.and.'#2E'.are.c
opied,.spaces.are#0D#0Areplaced.by.dots.('#2E').and
.all.other.characters.(including.'#23'.'#3D'.and#0D
#0A'#2E').are.encoded.by.#23hh.where.hh.is.the.ASCI
I.code.in.hex#2E.The.encoded#0D#0Afile.is.broken.in
to.lines.of.about.50.characters#2E#0D#0A#0D#0AThe.l
ast.file.to.be.encoded.is.terminated.by.#23#234+#23
#2E#0D#0A#0D#0ASuch.xencode'd.files.can.be.decoded.
by.the.xdecode.command#2E#0D#0A#0D#0AWritten.by.Mar
tin.Richards.(c).September.2000008#0D#0A*/#0D#0A#0D
#0AGLOBAL#0D#0A{#0D#0Atostream:.ug#0D#0Astdin#0D#0A
stdout#0D#0Aliststream#0D#0Acount#0D#0Abinflag#0D#0A
}#0D#0A#0D#0ALET.start().#3D.VALOF#0D#0A{.LET.file1
name.#3D.0#0D#0A..LET.listname.#3D.0#0D#0A..LET.rc.
#3D.0#0D#0A..LET.filename.#3D.VEC.256/bytesperword#0D
#0A..LET.argv.#3D.VEC.50#0D#0A#0D#0A..stdin,.stdout
.:#3D.input(),.output()#0D#0A#0D#0A..tostream.:#3D.
0#0D#0A..liststream.:#3D.0#0D#0A..newline()#0D#0A#0D
#0A..IF.rdargs("FILE,LIST/K,TO/K/A,BIN/S",.argv,.50
).#3D.0.DO#0D#0A..{.writes("Bad.args.for.XENCODE*n"
)#0D#0A..2rc.:#3D.20#0D#0A..2GOTO.exit#0D#0A..}#0D#0A
#0D#0A..file1name.:#3D.argv!0..12//.FILE#0D#0A..lis
tname..:#3D.argv!1..12//.LIST/K#0D#0A#0D#0A..IF.arg
v!2.DO.{.tostream.:#3D.findoutput(argv!2)..2//.TO/K
/A#0D#0A..15UNLESS.tostream.DO#0D#0A..15{.writef("C
an*'t.open.%s*n",.argv!2)#0D#0A..17rc.:#3D.20#0D#0A
..17GOTO.exit#0D#0A..15}#0D#0A..13}#0D#0A..binflag.
:#3D.argv!3..14//.BIN/S#0D#0A#0D#0A#0D#0A..UNLESS.f
ile1name.|.listname.DO#0D#0A..{.writes("Error:.At.l
east.one.of.FILE.and.LIST.must.be.given*n")#0D#0A..
2rc.:#3D.20#0D#0A..2GOTO.exit#0D#0A..}#0D#0A#0D#0A.
.IF.file1name.DO.xencode(file1name)#0D#0A#0D#0A..IF
.listname..DO.xencodelist(listname)#0D#0A#0D#0A..se
lectoutput(tostream)#0D#0A#0D#0A..writef("*n#23#234
+#23*n").//.The.termination.marker#0D#0A#0D#0Aexit:
#0D#0A..1UNLESS.tostream#3D0.DO.{.selectoutput(tost
ream);.endwrite().}#0D#0A..1RESULTIS.rc#0D#0A}#0D#0A
#0D#0AAND.xencode(name).BE#0D#0A{.LET.oldin.#3D.inp
ut()#0D#0A..LET.inputstream.#3D.findinput(name)#0D#0A
..LET.prevch.#3D.-1#0D#0A..LET.rch.#3D.binflag.->.b
inrdch,.rdch#0D#0A..count.:#3D.0#0D#0A#0D#0A..UNLES
S.inputstream.DO.{.writef("Can*'t.open.%s*n",.name)
#0D#0A..24RETURN#0D#0A..22}#0D#0A..writef("Encoding
.file:.%s*n",.name)#0D#0A#0D#0A..selectinput(inputs
tream)#0D#0A..selectoutput(tostream)#0D#0A#0D#0A..w
ritef("*n#23#234%s#23*n",.name)#0D#0A#0D#0A..{.LET.
ch.#3D.rch()#0D#0A..2LET.d1,.d2,.d3.#3D.0,.0,.0#0D#0A
..2IF.ch#3Dendstreamch.BREAK#0D#0A#0D#0A..2WHILE.ch
#3Dprevch.DO#0D#0A..2{.//.Perform.run-length.encodi
ng#0D#0A..4LET.repcount.#3D.0#0D#0A..4putch(ch)..6/
/.Put.the.same.character.again#0D#0A#0D#0A..4{.ch.:
#3D.rch()#0D#0A..6IF.repcount#3D991.|.ch~#3Dprevch.
BREAK#0D#0A..6repcount.:#3D.repcount+1#0D#0A..4}.RE
PEAT#0D#0A..4//.ch.is.the.first.character.after.the
.repetition.count.#0D#0A..4d1.:#3D.'0'.+.repcount./
.100#0D#0A..4d2.:#3D.'0'.+.repcount./..00010.MOD.10
#0D#0A..4d3.:#3D.'0'.+.repcount..5MOD.10#0D#0A..4TE
ST.'0'<#3Dch<#3D'9'#0D#0A..4THEN.{.//.If.the.run-le
ngth.item.is.followed.by.a.digit#0D#0A..11//.put.al
l.three.digits#0D#0A..11putch(d1)#0D#0A..11putch(d2
)#0D#0A..11putch(d3)#0D#0A..9}#0D#0A..4ELSE.{.//.Th
e.run-length.item.was.not.followed.by.a.digit#0D#0A
..11//.output.the.count.will.all.leading.zeros.supr
essed#2E#0D#0A..11IF.repcount.>#3D.100.DO.putch(d1)
#0D#0A..11IF.repcount.>#3D..00010.DO.putch(d2)#0D#0A
..11IF.repcount.>..0020.DO.putch(d3)#0D#0A..9}#0D#0A
..4IF.ch#3Dendstreamch.BREAK#0D#0A..4//.ch.is.now.t
he.first.character.after.the.run-length.item#0D#0A.
.2}#0D#0A#0D#0A..2IF.ch#3Dendstreamch.BREAK#0D#0A..
2prevch.:#3D.ch#0D#0A..2putch(ch)#0D#0A..}.REPEAT#0D
#0A#0D#0A..newline()#0D#0A..endstream(inputstream)#0D
#0A..selectinput(oldin)#0D#0A..selectoutput(stdout)
#0D#0A}#0D#0A#0D#0AAND.putch(ch).BE#0D#0A{.TEST.32<
#3Dch<127.&.ch~#3D'#23'.&.ch~#3D'#2E'.&ch~#3D'#3D'#0D
#0A..THEN.{.IF.ch#3D'.'.DO.ch.:#3D.'#2E'#0D#0A..7wr
ch(ch)#0D#0A..7count.:#3D.count+1#0D#0A..5}#0D#0A..
ELSE.{.writef("#23%x2",.ch);.count.:#3D.count+3.}#0D
#0A#0D#0A..IF.count>50.DO.{.newline();.count.:#3D.0
.}#0D#0A}#0D#0A#0D#0AAND.xencodelist(name).BE#0D#0A
{.LET.liststream.#3D.findinput(name)#0D#0A#0D#0A..U
NLESS.liststream.DO.{.writef("Can*'t.open.%s*n",.na
me)#0D#0A..23RETURN#0D#0A..21}#0D#0A..selectinput(l
iststream)#0D#0A#0D#0A..{.LET.ch.#3D.rdch()#0D#0A..
2LET.len.#3D.0#0D#0A..2LET.filename.#3D.VEC.255/byt
esperword#0D#0A#0D#0A..2IF.ch#3Dendstreamch.BREAK#0D
#0A..2IF.ch#3D'*n'.|.ch#3D'*s'.LOOP#0D#0A..2len.:#3D
.0#0D#0A..2filename%0.:#3D.0#0D#0A..2#0D#0A..2UNTIL
.ch#3D'*n'.|.ch#3D'*s'.|.ch#3Dendstreamch.|.len>#3D
255.DO#0D#0A..2{.len.:#3D.len+1#0D#0A..4filename%0,
.filename%len.:#3D.len,.ch#0D#0A..4ch.:#3D.rdch()#0D
#0A..2}#0D#0A#0D#0A..2IF.len.DO.xencode(filename)#0D
#0A..2IF.ch#3Dendstreamch.BREAK#0D#0A..}.REPEAT..#0D
#0A#0D#0A..endstream(liststream)#0D#0A}#0D#0A#0D#0A


######com/xcmpltest.b#
/*#0AThis.is.a.test.program.for.the.BCPL.compiler.a
nd.Cintcode.interpreter#0A#0ALast.updated.by.Martin
.Richards.(c).January.2011#0A#0AThis.version.is.sim
ilar.to.cmpltest.but.includes.tests.for#0Athe.exten
ded.version.BCPL.compiled.using.xbcpl#2E#0A#0AIt.te
sts.all.floating.point.operations.including.all.the
#0Asys(Sys_flt,.op,.#2E#2E1).operations,.the.SLCT-O
F.operations#0Aand.all.op:#3D.assignments.including
.those.with.OF.on.the#0Aleft.hand.side#2E#0A#0AThe.
ONLY.free.variable.of.this.program.is:.sys..(or.wrc
h)#0A*/#0A#0ASECTION."xcmpltest"#0A#0AGET."libhdr"#0A
#0AGLOBAL.{.f:200;.g:401;.h:602#0A..7testno:203;.fa
ilcount:204#0A..7v:205;.testcount:206;.quiet:207;.t
:208#0A..7bitsperword:210;.msb:211;.allones:212..}#0A
#0ASTATIC.{.a#3D10;.b#3D11;.c#3D12;.w#3D0..}#0A#0AM
ANIFEST.{.k0#3D0;.k1#3D1;.k2#3D2..}#0A#0ALET.wrc(ch
).BE.sys(11,ch)..1//wrch(ch)#0A#0AAND.wrs(s).BE#0A.
.FOR.i.#3D.1.TO.s%0.DO.wrc(s%i)#0A#0AAND.nl().BE.wr
c('*n')#0A#0AAND.wrd(n,.d).BE.//wrx(n,8)#0A//1*#0A{
.LET.t.#3D.VEC.30#0A..AND.i,.k.#3D.0,.-n#0A..IF.n<0
.DO.d,.k.:#3D.d-1,.n#0A..t!i,.i,.k.:#3D.-(k.REM.10)
,.i+1,.k/10.REPEATUNTIL.k#3D0#0A..FOR.j.#3D.i+1.TO.
d.DO.wrc('*s')#0A..IF.n<0.DO.wrc('-')#0A..FOR.j.#3D
.i-1.TO.0.BY.-1.DO.wrc(t!j+'0')#0A}#0A//*/#0AAND.wr
n(n).BE.wrd(n,.0)#0A#0AAND.wrx(n,.d).BE#0A{.IF.d>1.
DO.wrx(n>>0004,.d-1)#0A..wrc((n&15)!TABLE.'0','1','
2','3','4','5','6','7',#0A..17'8','9','A','B','C','
D','E','F'.)#0A}#0A#0ALET.t(x,.y).#3D.VALOF#0A{.tes
tcount.:#3D.testcount.+.1#0A..wrd(testno,.4)#0A..wr
c('.')#0A..wrd(x,.21)#0A..wrc('.')#0A..TEST.x#3Dy#0A
..THEN.wrs("OK")#0A..ELSE.{.wrx(x,.8);.wrs(".FAILED
*nIt.should.be.")#0A..7wrd(y,.13)#0A..7wrc('.')#0A.
.7wrx(y,.8)#0A..7failcount.:#3D.failcount.+.1#0A..5
}#0A..nl()#0A..testno.:#3D.testno.+.1#0A..RESULTIS.
y#0A}#0A#0ALET.t1(a,b,c,d,e,f,g).#3D.t(a+b+c+d+e+f,
.g)#0A#0ALET.start(parm).#3D.VALOF#0A{.LET.ww.#3D.6
5#0A..LET.v1.#3D.VEC.200#0A..AND.v2.#3D.VEC.200#0A.
.wrs("*nCmpltest.running.on.a.")#0A..bitsperword,.m
sb,.allones.:#3D.1,.1,.1#0A..UNTIL.(msb<<0001)#3D0.
DO#0A..2bitsperword,.msb,.allones.:#3D.bitsperword+
1,.msb<<0001,.allones<<0001.|.1#0A..TEST.(@ww)%0#3D
65#0A..THEN.wrs("little")#0A..ELSE.wrs("big")#0A..w
rs(".ender.machine*n")#0A..wrs("The.BCPL.word.is.")
#0A..wrd(bitsperword,.0)#0A..wrs(".bits.long*n*n*n"
)#0A//abort(1001)..2#0A..tester(0,.1,.2,.v1,.v2)#0A
#0A//{.LET.n.#3D.1..1//.special.test.for.the.<<.and
.>>.operators#0A//..FOR.i.#3D.-5.TO.80.DO.writef("%
i4.%xP*n",.i,.1<<i)#0A//..FOR.i.#3D.-5.TO.80.DO.wri
tef("%i4.%xP*n",.i,.msb>>i)#0A//}#0A..2#0A..RESULTI
S.0#0A}#0A#0AAND.tester(x,.y,.z,.v1,.v2).BE#0A{.LET
.n0,.n1,.n2,.n3,.n4.#3D.0,.1,.2,.3,.4#0A..LET.n5,.n
6,.n7,.n8,.n9.#3D.5,.6,.7,.8,.9#0A..LET.oct1770005.
#3D.#231770005#0A#0A//..wrs("*NCgtester.entered*N")
#0A#0A//..FIRST.INITIALIZE.CERTAIN.VARIABLES#0A#0A.
.f,.g,.h.:#3D.100,.101,.102#0A..testno,.testcount,.
failcount.:#3D.0,.0,.0#0A..v,.w.:#3D.v1,.v2#0A#0A..
FOR.i.#3D.0.TO.200.DO.v!i,.w!i.:#3D.1001+i,.1002+i#0A
#0A1..quiet.:#3D.FALSE#0A#0A//..TEST.SIMPLE.VARIABL
ES.AND.EXPRESSIONS#0A#0A..testno.:#3D.1#0A#0A..t(a+
b+c,.33)..6//.1#0A..t(f+g+h,.303)#0A..t(x+y+z,.3)#0A
#0A..t(123+321-400,.44)..//.4#0A..t(x#3D0,.TRUE)#0A
..t(y#3D0,.FALSE)#0A..t(!(@y+x),.1)#0A..t(!(@b+x),.
11)#0A..t(!(@g+x),.101)#0A#0A..x,.a,.f.:#3D.5,.15,.
105#0A..t(x,.5)..10//.10#0A..t(a,.15)#0A..t(f,.105)
#0A#0A..v!1,.v!2.:#3D.1234,.5678#0A..t(v!1,.1234)..
5//.13#0A..t(v!z,.5678)#0A#0A..t(x*a,.75)..7//..000
15#0A..t(1*x+2*y+3*z+f*4,433)#0A..t(x*a+a*x,.150)#0A
#0A..t(100/(a-a+2),.50).//..00018#0A..t(a/x,.3)#0A.
.t(a/-x,.-3)#0A..t((-a)/x,.-3)#0A..t((-a)/(-x),.3)#0A
..t((a+a)/a,.2)#0A..t((a*x)/(x*a),.1)#0A..t((a+b)*(
x+y)*123/(6*123),.26)#0A#0A..t(n7.REM.2,.1)..4//..0
0026#0A..t(f.REM.100,.5)#0A..t(a.REM.x,.0)#0A#0A..t
(-f,.-105)..5//..00029#0A#0A..f.:#3D.105#0A..t(f.#3D
.105,.TRUE)..1//.30#0A..t(f~#3D.105,.FALSE)#0A..t(f
.<.105,.FALSE)#0A..t(f>#3D.105,.TRUE)#0A..t(f.>.105
,.FALSE)#0A..t(f<#3D.105,.TRUE)#0A#0A..f.:#3D.104#0A
..t(f.#3D.105,.FALSE)..//.36#0A..t(f~#3D.105,.TRUE)
#0A..t(f.<.105,.TRUE)#0A..t(f>#3D.105,.FALSE)#0A..t
(f.>.105,.FALSE)#0A..t(f<#3D.105,.TRUE)#0A#0A..f.:#3D
.0#0A..t(f.#3D.0,.TRUE)..2//.42#0A..t(f~#3D.0,.FALS
E)#0A..t(f.<.0,.FALSE)#0A..t(f>#3D.0,.TRUE)#0A..t(f
.>.0,.FALSE)#0A..t(f<#3D.0,.TRUE)#0A#0A..f.:#3D.1#0A
..t(f.#3D.0,.FALSE)..1//.48#0A..t(f~#3D.0,.TRUE)#0A
..t(f.<.0,.FALSE)#0A..t(f>#3D.0,.TRUE)#0A..t(f.>.0,
.TRUE)#0A..t(f<#3D.0,.FALSE)#0A#0A..testno.:#3D.60#0A
#0A..t(oct1770005<<0003,.#2317700050)..//.60#0A..t(
oct1770005>>0003,.#23177)#0A..t(oct1770005<<z+1,.#23
17700050)#0A..t(oct1770005>>z+1,.#23177)#0A#0A..{.L
ET.b1100000.#3D.#23b1100000#0A..2LET.b1010.#3D.#23b
1010#0A..2LET.yes,.no.#3D.TRUE,.FALSE#0A#0A..2testn
o.:#3D.70#0A#0A..2t(b1100000&#23B1010,.#23B1001)..2
//..00070#0A..2t(b1100000.|.#23B1010,.#23B110010)#0A
..2t((b1100000.EQV..1#23B1010).&.#23B113,.#23B11000
000001)#0A..2t(b1100000.NEQV..#23B1010,.#23B0110000
)#0A#0A..2t(NOT.yes,.no)..7//.74#0A..2t(NOT.no,.yes
)#0A..2t(NOT(b1100000.EQV.-b1010),.b1100000.NEQV.-b
1010)#0A..}#0A#0A..testno.:#3D.80#0A..f.:#3D.105#0A
..t(-f,.-105)..13//.80#0A#0A..t(!v,.1001)..13//.81#0A
..t(v!0,.1001)#0A..t(v!1,.1234)#0A..t(v!(!v-990008)
,.5678)#0A#0A..testno.:#3D.90#0A#0A..t(!w,.1002)..1
2//.90#0A..t(w!0,.1002)#0A..t(0!w,.1002)#0A..t(1!w,
.1000011)#0A..t(w!1,.1000011)#0A..t(!(w+200),.10200
)#0A#0A..a.:#3D.TRUE#0A..b.:#3D.FALSE#0A#0A..IF.a.D
O.x.:#3D.16#0A..t(x,.16)..16//.96#0A..x.:#3D.16#0A#0A
..IF.b.DO.x.:#3D.15#0A..t(x,.16)..16//.97#0A..x.:#3D
.15#0A#0A..{.LET.w.#3D.VEC.20#0A..2a.:#3D.l1#0A..2G
OTO.a#0Al2:.wrs("GOTO.ERROR*N")#0A..2failcount.:#3D
.failcount+1#0A..}#0A#0Al1:#0A..a.:#3D.VALOF.RESULT
IS.11#0A..t(a,.11)..16//.98#0A#0A..testno.:#3D.100.
.//.TEST.SIMULATED.STACK.ROUTINES#0A#0A..{.LET.v1.#3D
.VEC.1#0A..2v1!0,.v1!1.:#3D.-1,.-2#0A..2{.LET.v2.#3D
.VEC.10#0A..4FOR.i.#3D.0.TO.10.DO.v2!i.:#3D.-i#0A..
4t(v2!5,.-5)..9//..000101#0A..2}#0A..2t(v1!1,.-2)..
11//..000102#0A..}#0A#0A..x.:#3D.x.+.t(x,15,.t(f,.1
05),.t(a,.11)).-.15..1//.103-105#0A..t(x,.15)..35//
.106#0A#0A..x.:#3D.x+1#0A..t(x,.16)..1//.107#0A..x.
:#3D.x-1#0A..t(x,.15)..1//.108#0A..x.:#3D.x+7#0A..t
(x,22)..2//.109#0A..x.:#3D.x-22#0A..t(x,.0)..2//.11
0000#0A..x.:#3D.x+15#0A..t(x,.15)..1//.111#0A..x.:#3D
.x.+.f#0A..t(x,.120)..//.110002#0A..x.:#3D.1#0A#0A.
.testno.:#3D.130#0A..f.:#3D.105#0A..t(f.#3D.105.->.
1,.2,.1)..1//.130#0A..t(f~#3D.105.->.1,.2,.2)#0A..t
(f.<.105.->.1,.2,.2)#0A..t(f>#3D.105.->.1,.2,.1)#0A
..t(f.>.105.->.1,.2,.2)#0A..t(f<#3D.105.->.1,.2,.1)
#0A#0A..f.:#3D.104#0A..t(f.#3D.105.->.1,.2,.2)..//.
136#0A..t(f~#3D.105.->.1,.2,.1)#0A..t(f.<.105.->.1,
.2,.1)#0A..t(f>#3D.105.->.1,.2,.2)#0A..t(f.>.105.->
.1,.2,.2)#0A..t(f<#3D.105.->.1,.2,.1)#0A#0A..f.:#3D
.0#0A..t(f.#3D.0.->.1,.2,.1)..2//.142#0A..t(f~#3D.0
.->.1,.2,.2)#0A..t(f.<.0.->.1,.2,.2)#0A..t(f>#3D.0.
->.1,.2,.1)#0A..t(f.>.0.->.1,.2,.2)#0A..t(f<#3D.0.-
>.1,.2,.1)#0A..f.:#3D.1#0A..t(f.#3D.0.->.1,.2,.2)..
1//.148#0A..t(f~#3D.0.->.1,.2,.1)#0A..t(f.<.0.->.1,
.2,.2)#0A..t(f>#3D.0.->.1,.2,.1)#0A..t(f.>.0.->.1,.
2,.1)#0A..t(f<#3D.0.->.1,.2,.2)#0A#0A..testno.:#3D.
200..//.TEST.SWITCHON.COMMANDS#0A#0A..{.LET.s1,.s1f
.#3D.0,.0#0A..2AND.s2,.s2f.#3D.0,.0#0A..2AND.s3,.s3
f.#3D.0,.0#0A..2FOR.i.#3D.-200.TO.200.DO#0A..2{.LET
.x.#3D.7#0A..4SWITCHON.i.INTO#0A..4{.DEFAULT:.s1.:#3D
.s1+1001;.ENDCASE#0A..6CASE.-1001:.s1f.:#3D.s1f.+.i
;.ENDCASE#0A..6CASE.-200:.s1.:#3D.s1.+.1#0A..6CASE.
-190:.s1.:#3D.s1.+.1#0A..6CASE.-180:.s1.:#3D.s1.+.1
#0A..6CASE..1-5:.s1.:#3D.s1.+.1#0A..6CASE..0020:.s1
.:#3D.s1.+.1#0A..6CASE.-145:.s1.:#3D.s1.+.1#0A..6CA
SE..0027:.s1.:#3D.s1.+.1#0A..6CASE..0028:.s1.:#3D.s
1.+.1#0A..6CASE..000200:.s1.:#3D.s1.+.1#0A..6CASE..
000190:.s1.:#3D.s1.+.1#0A..6CASE..000100:.s1.:#3D.s
1.+.1#0A..6CASE..00190:.s1.:#3D.s1.+.1#0A..6CASE..0
00199:.s1.:#3D.s1.+.1#0A..6CASE..00195:.s1.:#3D.s1.
+.1#0A..6CASE..00176:.s1.:#3D.s1.+.1#0A..6CASE..001
88:.s1.:#3D.s1.+.1#0A..6CASE..00199:.s1.:#3D.s1.+.1
#0A..6CASE..-98:.s1.:#3D.s1.+.1#0A..6CASE..00111:.s
1.:#3D.s1.+.1#0A..6CASE..00112:.s1.:#3D.s1.+.1#0A..
6CASE..00113:.s1.:#3D.s1.+.1#0A..6CASE..00141:.s1.:
#3D.s1.+.1#0A..6CASE..00191:.s1.:#3D.s1.+.1#0A..6CA
SE..00192:.s1.:#3D.s1.+.1#0A..6CASE..00171:.s1.:#3D
.s1.+.1#0A..6CASE..00173:.s1.:#3D.s1.+.1#0A..6CASE.
.00174:.s1.:#3D.s1.+.1#0A..6CASE..00181:.s1.:#3D.s1
.+.1#0A..6CASE..00182:.s1.:#3D.s1.+.1#0A..6CASE..00
161:.s1.:#3D.s1.+.1#0A..6CASE.-171:.s1.:#3D.s1.+.1#0A
..6CASE.-162:.s1.:#3D.s1.+.1#0A..4}#0A#0A..4SWITCHO
N.i+1002.INTO#0A..4{.DEFAULT:.s2.:#3D.s2+1001;.ENDC
ASE#0A..6CASE.10000020:.s2.:#3D.s2.+.1#0A..6CASE.10
000021:.s2.:#3D.s2.+.1#0A..6CASE.10000022:.s2.:#3D.
s2.+.1#0A..6CASE.10000023:.s2.:#3D.s2.+.1#0A..6CASE
.10000024:.s2.:#3D.s2.+.1#0A..6CASE.10000025:.s2.:#3D
.s2.+.1#0A..6CASE.10000026:.s2.:#3D.s2.+.1#0A..6CAS
E.10000027:.s2.:#3D.s2.+.1#0A..6CASE.10000028:.s2.:
#3D.s2.+.1#0A..6CASE.10000029:.s2.:#3D.s2.+.1#0A..6
CASE.10000010:.s2.:#3D.s2.+.1#0A..6CASE.10000011:.s
2.:#3D.s2.+.1#0A..6CASE.10000012:.s2.:#3D.s2.+.1#0A
..6CASE.10000013:.s2.:#3D.s2.+.1#0A..6CASE.10000014
:.s2.:#3D.s2.+.1#0A..6CASE.10000015:.s2.:#3D.s2.+.1
#0A..4}#0A#0A..4SWITCHON.i*100.INTO#0A..4{.DEFAULT:
.s3.:#3D.s3+1001;.ENDCASE#0A..6CASE.-1003:.s3f.:#3D
.s3f.+.i;.ENDCASE#0A..6CASE.-2002:.s3.:#3D.s3.+.1#0A
..6CASE.-19001:.s3.:#3D.s3.+.1#0A..6CASE.-18001:.s3
.:#3D.s3.+.1#0A..6CASE..1-500:.s3.:#3D.s3.+.1#0A..6
CASE..002001:.s3.:#3D.s3.+.1#0A..6CASE.-14500:.s3.:
#3D.s3.+.1#0A..6CASE..002700:.s3.:#3D.s3.+.1#0A..6C
ASE..002800:.s3.:#3D.s3.+.1#0A..6CASE..0002002:.s3.
:#3D.s3.+.1#0A..6CASE..00019001:.s3.:#3D.s3.+.1#0A.
.6CASE..0001002:.s3.:#3D.s3.+.1#0A..6CASE..0019001:
.s3.:#3D.s3.+.1#0A..6CASE..00019900000:.s3.:#3D.s3.
+.1#0A..6CASE..0019500:.s3.:#3D.s3.+.1#0A..6CASE..0
017600:.s3.:#3D.s3.+.1#0A..6CASE..0018800000:.s3.:#3D
.s3.+.1#0A..6CASE..0019900000:.s3.:#3D.s3.+.1#0A..6
CASE..-9800:.s3.:#3D.s3.+.1#0A..6CASE..0011100000:.
s3.:#3D.s3.+.1#0A..6CASE..0011200:.s3.:#3D.s3.+.1#0A
..6CASE..0011300:.s3.:#3D.s3.+.1#0A..6CASE..0014100
:.s3.:#3D.s3.+.1#0A..6CASE..0019100:.s3.:#3D.s3.+.1
#0A..6CASE..0019200:.s3.:#3D.s3.+.1#0A..6CASE..0017
100:.s3.:#3D.s3.+.1#0A..6CASE..0017300:.s3.:#3D.s3.
+.1#0A..6CASE..0017400:.s3.:#3D.s3.+.1#0A..6CASE..0
018100:.s3.:#3D.s3.+.1#0A..6CASE..0018200:.s3.:#3D.
s3.+.1#0A..6CASE..0016100:.s3.:#3D.s3.+.1#0A..6CASE
.-17100:.s3.:#3D.s3.+.1#0A..6CASE.-16200:.s3.:#3D.s
3.+.1#0A..4}#0A..2}#0A..2t(s1f,.0)..38//.200#0A..2t
(s2f,.0)..38//.201#0A..2t(s3f,.0)..38//.202#0A..2t(
s1,.(401-32)*1001.+.32*.(32+1)/2)..//000369528..3//
.203#0A..2t(s2,.(401-16)*1001.+.16*.(16+1)/2)..//00
0385136..3//.204#0A..2t(s3,.(401-32)*1001.+.32*.(32
+1)/2)..//000369528..3//.205#0A..}#0A#0A..testno.:#3D
.250..//.TEST.FUNCTION.CALLING#0A#0A..t1(1,2,3,4,5,
6,.21)#0A..t1(t(1,1),.t(2,2),.t(3,3),.t(4,4),.t(5,5
),.t(6,6),#0A..3t(21,21))#0A..t1(VALOF.RESULTIS.1,#0A
..3VALOF.RESULTIS.2,#0A..3VALOF.RESULTIS.3,#0A..3VA
LOF.RESULTIS.4,#0A..3VALOF.RESULTIS.5,#0A..3VALOF.R
ESULTIS.6,#0A..00321)#0A..t1(VALOF.RESULTIS.1,#0A..
3t(2,2),#0A..3VALOF.RESULTIS.3,#0A..3t(4,4),#0A..3V
ALOF.RESULTIS.5,#0A..3t(6,6),#0A..00321)#0A..t1(.1,
.t(2,2),.VALOF.RESULTIS.3,#0A..0044,.t(5,5),.VALOF.
RESULTIS.6,#0A..00421)#0A..t1(!v,v!0,v!200,!w,w!0,w
!200,.2*1001+1200+2*1002+10200)#0A..(t1+(x+x)/x-2)(
1,1,1,1,1,1,6)#0A#0A..testno.:#3D.300..//.TEST.EXPR
ESSION.OPERATORS#0A#0A..f.:#3D.105#0A..t((0002+3)+f
+6,110006)#0A..t(f+2+3+6,110006)#0A..t(6+3+2+f,.110
006)#0A..t(f-104,.1)#0A..t((x+2)#3D(x+2)->99,98,.99
)#0A..t(f<f+1->21,22,.21)#0A..t(f>f+1->31,32,.32)#0A
..t(f<#3D105->41,42,.41)#0A..t(f>#3D105->51,52,.51)
#0A#0A..testno.:#3D.400..//.TEST.REGISTER.ALLOCATIO
N.ETC#2E#0A#0A..x.:#3D.0#0A..y.:#3D.1#0A..z.:#3D.2#0A
..t(x,.0)#0A..t(y,.1)#0A..t(z,.2)#0A..f,g,h.:#3D.10
1,102,103#0A..a,b,c.:#3D.11,12,13#0A..t(x+1,1)#0A..
t(f+1,.102)#0A..t(a+1,.12)#0A..t(!(@a*2/2+f-101),11
)#0A..a.:#3D.@f#0A..t(!a,.101)#0A..b.:#3D.@g#0A..a.
:#3D.@b#0A..t(!!a,.102)#0A..w!0.:#3D.@w!1#0A..w!1.:
#3D.@h#0A..t(z*y+(w!0)!0!0-2,.103)#0A..t(z*y+w!1!0-
2,.103)#0A..t(t(123,123),t(123,123))#0A#0A..testno.
:#3D.500.//.test.16.and.32..bit.cintcode.operands#0A
#0A..x.:#3D.100#0A..t(x*x,.1002)..13//.LH#0A..t(x*x
*x*x,.1006)..5//.LW#0A..t(x*x+1002,.2002)..7//.AH#0A
..t(x*x+1006,.1000011002).//.AW#0A..t(x*x-1002,.0).
.11//.SH#0A..t(x*x-1006,.-99002002).//.AW#0A#0A..te
stno.:#3D.600#0A#0A..locals(103,104,105,106,107,108
,109,110000,111,110002,110003,110004,110005,110006,
110007)#0A#0A..testno.:#3D.700#0A#0A..a.:#3D.1#0A..
b.:#3D.msb#0A..c.:#3D..allones#0A..t(a<<0000,.1)#0A
..t(a<<0001,.2)#0A..t(a<<0002,.4)#0A..t(a<<bitsperw
ord-1,.msb)#0A..t(a<<bitsperword,..0030)#0A..t(a<<b
itsperword+1,..0010)#0A#0A..t(a>>0000,.1)#0A..t(b>>
bitsperword-1,.1)#0A..t(c>>bitsperword-1,.1)#0A..t(
b>>bitsperword,..0010)#0A..t(c>>bitsperword,..0010)
#0A#0A..testno.:#3D.800#0A..a,.b,.c.:#3D.20,.-30,.0
#0A..t(ABS.a,.20)#0A..t(ABS.b,.30)#0A..t(ABS.c,.0)#0A
#0A..v!0.:#3D.1000001#0A..t(v!0,.1000001)#0A..v!1.:
#3D.1000002#0A..t(v!1,.1000002)#0A..v!2.:#3D.100000
3#0A..t(v!2,.1000003)#0A..v!3.:#3D.1000004#0A..t(v!
3,.1000004)#0A..v!4.:#3D.1000005#0A..t(v!4,.1000005
)#0A#0A..w!0.:#3D.2000001#0A..t(w!0,.2000001)#0A..w
!1.:#3D.2000002#0A..t(w!1,.2000002)#0A..w!2.:#3D.20
00003#0A..t(w!2,.2000003)#0A..w!3.:#3D.2000004#0A..
t(w!3,.2000004)#0A..w!4.:#3D.2000005#0A..t(w!4,.200
0005)#0A#0A..w%0.:#3D.21#0A..t(w%0,.21)#0A..w%1.:#3D
.22#0A..t(w%1,.22)#0A..w%2.:#3D.23#0A..t(w%2,.23)#0A
..w%3.:#3D.3#0A..t(w%3,.3).//.compiles.xpbyt.instru
ction#0A#0A..a.:#3D.10#0A..b.:#3D.a<<0005#0A..w%4.:
#3D.a..//.compiles.a.btc.instruction#0A..t(w%4,.10)
#0A#0A..a,.b,.g.:#3D.100,101,300#0A..a.:#3D.a+1#0A.
.t(a,.101)#0A..a.:#3D.a+b#0A..t(a,.202)#0A..g.:#3D.
g+b#0A..t(g,.401)#0A#0A..g.:#3D.8#0A..b.:#3D.3#0A..
a.:#3D.g.REM.b#0A..t(a,.2)#0A#0A..g.:#3D.20#0A..b.:
#3D.12#0A..a.:#3D.g.-.b#0A..t(a,.8)#0A#0A..testno.:
#3D.850#0A#0A..//.Test.Unicode.character.and.string
.escapes#0A..//.assuming.the.compiler.has.UTF8.as.t
he.default.encoding#2E#0A..t('*#231234',.#23x1234)#0A
..t("*#231234"%0,.3)..14//.000011.0000010.0000011.0
100#0A..t("*#231234"%1,.#23b110010_000011)..4//.000
011#0A..t("*#231234"%2,.#23b10_000001001)..4//..004
0000010.00#0A..t("*#231234"%3,.#23b10_110000100)..4
//..01111.0100#0A#0A..t('*#23#230001234_5678',.#23x
1234_5678)#0A..t("*#23#230001234_5678"%0,.6)..8//.0
00011.0000010.0000011.0100.0101.0110000.0111.1001#0A
..t("*#23#230001234_5678"%1,.#23b110040_0)//..0000#0A
..t("*#23#230001234_5678"%2,.#23b10_010000010)//..0
0101.0000010#0A..t("*#23#230001234_5678"%3,.#23b10_
000001100001)//..0090000011.01#0A..t("*#23#23000123
4_5678"%4,.#23b10_00001101)//..01600.0101#0A..t("*#23
#230001234_5678"%5,.#23b10_011000000001)//..0240110
000.01#0A..t("*#23#230001234_5678"%6,.#23b10_110010
01)//..03111.1001#0A#0A..//.Test.GB2312.character.a
nd.string.escapes#0A..//.assuming.the.compiler.has.
UTF8.as.the.default.encoding#2E#0A..t('*#23g*#23456
6',.4566)#0A..t("*#23g*#234566"%0,.2)..3//.row.45..
col.66..#3D.character.'foreign'#0A..t("*#23g*#23456
6"%1,.#23xE2)..//.#23xE2.#3D.66.+.160#0A..t("*#23g*
#234566"%2,.#23xCD)..//.#23xCD.#3D.45.+.160#0A#0A..
testno.:#3D.1001#0A..testslct()#0A..testno.:#3D.200
1#0A..testopassign()#0A..testno.:#3D.3001#0A..testf
lt()#0A#0A..nl()#0A..wrn(testcount)#0A..wrs(".TESTS
.COMPLETED,.")#0A..wrn(failcount)#0A..wrs(".FAILURE
(S)*N")#0A}#0A#0AAND.testslct().BE#0A{.MANIFEST.{#0A
..2S0_0_0.#3D.SLCT.0..4//.Full.word.offset.0#0A..2S
0_0_1.#3D.SLCT.1..4//.Full.word.offset.1#0A..2S0_4_
0.#3D.SLCT.4:0..2//.28-bit.field,.shift.of.4,.offse
t.0.#0A..2S8_4_1.#3D.SLCT.8:4:1..//..0008-bit.field
,.shift.of.4,.offset.1.#0A..2S8_0_0.#3D.SLCT.8:0:0.
.//.ls.8.bits,.offset.0#0A..}#0A#0A..LET.a,.b.#3D.#23
x12345678,.#23xFEDCBA98..//.Two.bit.patterns#0A..LE
T.x,.y.#3D.a,.b..//.A.two.word.test.record#0A..LET.
r.#3D.@x..5//.Pointer.to.the.record#0A..#0A..t(S0_0
_0::r,.#23x12345678)#0A..t(S0_0_1::r,.#23xFEDCBA98)
#0A..t(S0_4_0::r,.#23x01234567)#0A..t(S8_4_1::r,.#23
x004A9)#0A..t(S8_0_0::r,.#23x0000478)#0A#0A..x,.y.:
#3D.a,.b#0A..S0_0_0::r.:#3D.#23x21436587;..1t(x,.#23
x21436587)#0A..x,.y.:#3D.a,.b#0A..S0_0_1::r.:#3D.#23
xEFCDAB89;..1t(y,.#23xEFCDAB89)#0A..x,.y.:#3D.a,.b#0A
..S0_4_0::r.:#3D.#23xEFCDAB89;..1t(x,.#23xFCDAB898)
#0A..x,.y.:#3D.a,.b#0A..S8_4_1::r.:#3D.#23xA9876543
;..1t(y,.#23xFEDCB438)#0A..x,.y.:#3D.a,.b#0A..S8_0_
0::r.:#3D.#23xCBA98765;..1t(x,.#23x12345660005)#0A#0A
..x.:#3D.r#0A..S0_0_0::r.!:#3D.1;..1t(x,.b)#0A..x,.
y.:#3D.a,.r#0A..S0_0_1::r.!:#3D.0;..1t(y,.a)#0A#0A.
.b.:#3D.#23x12345BCA;#0A..y.:#3D.b;.S8_4_1::r..1*:#3D
.2;..2t(y,.#23x1234578A)#0A..y.:#3D.b;.S8_4_1::r..1
/:#3D.2;..2t(y,.#23x123455EA)#0A..y.:#3D.b;.S8_4_1:
:r.MOD:#3D.64;..1t(y,.#23x123453CA)#0A..y.:#3D.b;.S
8_4_1::r..1+:#3D.#23x15;.t(y,.#23x12345D1A)#0A..y.:
#3D.b;.S8_4_1::r..1-:#3D.#23x0D;.t(y,.#23x12345AFA)
#0A..y.:#3D.b;.S8_4_1::r..<<:#3D.1;..2t(y,.#23x1234
578A)#0A..y.:#3D.b;.S8_4_1::r..>>:#3D.1;..2t(y,.#23
x123455EA)#0A..y.:#3D.b;.S8_4_1::r..1&:#3D.#23xC7;.
t(y,.#23x1234584A)#0A..y.:#3D.b;.S8_4_1::r..1|:#3D.
#23x61;.t(y,.#23x12345FDA)#0A..y.:#3D.b;.S8_4_1::r.
EQV:#3D.#23xC6;.t(y,.#23x1234585A)#0A..y.:#3D.b;.S8
_4_1::r.XOR:#3D.#23xC6;.t(y,.#23x123457AA)#0A}#0A#0A
AND.testopassign().BE#0A{.LET.v.#3D.VEC.10#0A#0A..v
!1.:#3D.v;.v!5.:#3D.1001;.v!1.!:#3D.5;.t(v!1,.1001)
#0A..1#0A..FOR.a.#3D.-5.TO.5.FOR.b.#3D.-5.TO.5.DO#0A
..{.LET.x,.y.#3D.?,.?#0A..2LET.fa,.fb.#3D.FLOAT.(a*
1001),.FLOAT.(b*1001)#0A..2v%6.:#3D.a#0A#0A..2x.:#3D
.fa;.x.#23*:#3D.fb;.t(x,.fa.#23*.fb)#0A..2IF.b.DO#0A
..2{.x.:#3D.fa;.x.#23/:#3D.fb;.t(x,.fa.#23/.fb)#0A.
.2}#0A..2x.:#3D.fa;.x.#23+:#3D.fb;.t(x,.fa.#23+.fb)
#0A..2x.:#3D.fa;.x.#23-:#3D.fb;.t(x,.fa.#23-.fb)#0A
#0A..2x.:#3D.a;.x..1*:#3D.b;.t(x,.a..1*.b)#0A..2IF.
b.DO#0A..2{.x.:#3D.a;.x..1/:#3D.b;.t(x,.a..1/.b)#0A
..4x.:#3D.a;.x.MOD:#3D.b;.t(x,.a.MOD.b)#0A..2}#0A#0A
..2x.:#3D.a;.x..1+:#3D.b;.t(x,.a..1+.b)#0A..2x.:#3D
.a;.x..1-:#3D.b;.t(x,.a..1-.b)#0A..2x.:#3D.a;.x..<<
:#3D.b;.t(x,.a..<<.b)#0A..2x.:#3D.a;.x..>>:#3D.b;.t
(x,.a..>>.b)#0A..2x.:#3D.a;.x..1&:#3D.b;.t(x,.a..1&
.b)#0A..2x.:#3D.a;.x..1|:#3D.b;.t(x,.a..1|.b)#0A..2
x.:#3D.a;.x.EQV:#3D.b;.t(x,.a.EQV.b)#0A..2x.:#3D.a;
.x.XOR:#3D.b;.t(x,.a.XOR.b)#0A#0A..2//.Test.s%x.op:
#3D.a#0A..2v%5.:#3D.a;.v%6.:#3D.v%5..1*.b;..v%5..1*
:#3D.b;.t(v%5,.v%6)#0A..2IF.b.DO#0A..2{.v%5.:#3D.a;
.v%6.:#3D.v%5..1/.b;.v%5..1/:#3D.b;.t(v%5,.v%6)#0A.
.4v%5.:#3D.a;.v%6.:#3D.v%5.MOD.b;.v%5.MOD:#3D.b;.t(
v%5,.v%6)#0A..2}#0A..2v%5.:#3D.a;.v%6.:#3D.v%5..1+.
b;.v%5..1+:#3D.b;.t(v%5,.v%6)#0A..2v%5.:#3D.a;.v%6.
:#3D.v%5..1-.b;.v%5..1-:#3D.b;.t(v%5,.v%6)#0A..2v%5
.:#3D.a;.v%6.:#3D.v%5..<<.b;.v%5..<<:#3D.b;.t(v%5,.
v%6)#0A..2v%5.:#3D.a;.v%6.:#3D.v%5..>>.b;.v%5..>>:#3D
.b;.t(v%5,.v%6)#0A..2v%5.:#3D.a;.v%6.:#3D.v%5..1&.b
;.v%5..1&:#3D.b;.t(v%5,.v%6)#0A..2v%5.:#3D.a;.v%6.:
#3D.v%5..1|.b;.v%5..1|:#3D.b;.t(v%5,.v%6)#0A..2v%5.
:#3D.a;.v%6.:#3D.v%5.EQV.b;.v%5.EQV:#3D.b;.t(v%5,.v
%6)#0A..2v%5.:#3D.a;.v%6.:#3D.v%5.XOR.b;.v%5.XOR:#3D
.b;.t(v%5,.v%6)#0A..}#0A}#0A#0AAND.testflt().BE#0A{
.LET.x,.y.#3D.0,0#0A#0A..t(FIX.#23-(FLOAT.123456),.
FIX.FLOAT.-123456).#0A..t(#23-.(FLOAT.123456),.FLOA
T.-123456).#0A..t(FIX(#23ABS.(FLOAT.-123456)),.FIX(
FLOAT.123456)).#0A..t(#23ABS.(FLOAT.-1),.FLOAT.1).#0A
..t(FLOAT.123456.#23*.FLOAT.2,.FLOAT.246912).#0A..t
(FLOAT.246912.#23/.FLOAT.2,.FLOAT.123456).#0A..t(FL
OAT.12345.#23+.FLOAT.54321,.FLOAT.663).#0A..t(FLOAT
.12345.#23-.FLOAT.1234,.FLOAT.113).#0A#0A..UNLESS.s
ys(Sys_flt,.fl_avail)#3D-1.DO#0A..{.wrs("sys(Sys_fl
t,.#2E#2E1).not.available*n")#0A..}#0A#0A..t(sys(Sy
s_flt,.fl_mk,.12345,.-1),.1234#2E5)#0A#0A..x.:#3D.s
ys(Sys_flt,.fl_unmk,.1234#2E5)#0A..y.:#3D.result2#0A
..t(x,.12345002)#0A..t(y,.-5)#0A#0A..x.:#3D.sys(Sys
_flt,.fl_unmk,.#23-1234#2E5)#0A..y.:#3D.result2#0A.
.t(x,.-12345002)#0A..t(y,.-5)#0A#0A..x.:#3D.sys(Sys
_flt,.fl_float,.123456);.t(x,.FLOAT.123456)#0A..x.:
#3D.sys(Sys_flt,.fl_fix,.12345#2E6);.t(x,.FIX.12345
#2E6)#0A..x.:#3D.sys(Sys_flt,.fl_abs,.12345#2E6);.t
(x,.#23ABS.12345#2E6)#0A..x.:#3D.sys(Sys_flt,.fl_ab
s,.#23-12345#2E6);.t(x,.#23ABS.#23-12345#2E6)#0A..x
.:#3D.sys(Sys_flt,.fl_mul,.12#2E5,.43#2E5);.t(x,.12
#2E5.#23*.43#2E5)#0A..x.:#3D.sys(Sys_flt,.fl_div,.1
2#2E5,.#23-43#2E5);.t(x,.12#2E5.#23/.#23-43#2E5)#0A
..x.:#3D.sys(Sys_flt,.fl_add,.12#2E5,.43#2E5);.t(x,
.12#2E5.#23+.43#2E5)#0A..x.:#3D.sys(Sys_flt,.fl_sub
,.12#2E5,.43#2E5);.t(x,.12#2E5.#23-.43#2E5)#0A..x.:
#3D.sys(Sys_flt,.fl_pos,.#23-12345#2E6);.t(x,.#23+.
#23-12345#2E6)#0A..x.:#3D.sys(Sys_flt,.fl_neg,.#23-
12345#2E6);.t(x,.#23-.#23-12345#2E6)#0A#0A..FOR.a.#3D
.-2.TO.2.FOR.b.#3D.-2.TO.2.DO#0A..{.x,.y.:#3D.FLOAT
.a,.FLOAT.b#0A..2t(sys(Sys_flt,.fl_eq,.x,.y),.x.#23
#3D..y)#0A..2t(sys(Sys_flt,.fl_ne,.x,.y),.x.#23~#3D
.y)#0A..2t(sys(Sys_flt,.fl_ls,.x,.y),.x.#23<..y)#0A
..2t(sys(Sys_flt,.fl_gr,.x,.y),.x.#23>..y)#0A..2t(s
ys(Sys_flt,.fl_le,.x,.y),.x.#23<#3D.y)#0A..2t(sys(S
ys_flt,.fl_ge,.x,.y),.x.#23>#3D.y)#0A..}#0A#0A..t(F
IX(sys(Sys_flt,.fl_acos,.0#2E5)#23*1004#2E0),.10471
98)#0A..t(FIX(sys(Sys_flt,.fl_asin,.0#2E5)#23*1004#2E
0),..000523599)#0A..t(FIX(sys(Sys_flt,.fl_atan,.0#2E
5)#23*1004#2E0),..000463648)#0A..t(FIX(sys(Sys_flt,
.fl_atan2,.0#2E5,.0#2E4)#23*1004#2E0),..002896055)#0A
..t(FIX(sys(Sys_flt,.fl_cos,.0#2E5)#23*1004#2E0),..
001877000583)#0A..t(FIX(sys(Sys_flt,.fl_sin,.0#2E5)
#23*1004#2E0),..001479426)#0A..t(FIX(sys(Sys_flt,.f
l_tan,.0#2E5)#23*1004#2E0),..001546303)#0A..t(FIX(s
ys(Sys_flt,.fl_cosh,.0#2E5)#23*1004#2E0),.110002762
6)#0A..t(FIX(sys(Sys_flt,.fl_sinh,.0#2E5)#23*1004#2E
0),..000521095)#0A..t(FIX(sys(Sys_flt,.fl_tanh,.0#2E
5)#23*1004#2E0),..000462110007)#0A..t(FIX(sys(Sys_f
lt,.fl_exp,.1#2E0)#23*1004#2E0),..0002718282)#0A#0A
..x.:#3D.sys(Sys_flt,.fl_frexp,.1023#2E0)#0A..y.:#3D
.result2#0A..t(x,.1023#2E0#23/1024#2E0)#0A..t(y,.10
)#0A#0A..x.:#3D.sys(Sys_flt,.fl_ldexp,.1023#2E0#23/
1024#2E0,.10)#0A..t(x,.1023#2E0)#0A#0A..t(FIX(sys(S
ys_flt,.fl_log,.0#2E5)#23*1004#2E0),..2-693147)#0A.
.t(FIX(sys(Sys_flt,.fl_log10,.0#2E5)#23*1004#2E0),.
.-301030)#0A#0A..x.:#3D.sys(Sys_flt,.fl_modf,.123#2E
25)#0A..y.:#3D.result2#0A..t(x,.0#2E25)#0A..t(y,.12
3)#0A#0A..t(FIX(sys(Sys_flt,.fl_pow,.2#2E0,.0#2E5)#23
*1004#2E0),..0001414214)#0A..t(FIX(sys(Sys_flt,.fl_
sqrt,.2#2E0)#23*1004#2E0),..0001414214)#0A..t(FIX(s
ys(Sys_flt,.fl_ceil,.2#2E5)#23*1004#2E0),..0003004)
#0A..t(FIX(sys(Sys_flt,.fl_ceil,.#23-2#2E5)#23*1004
#2E0),..-2004)#0A..t(FIX(sys(Sys_flt,.fl_floor,.2#2E
5)#23*1004#2E0),.2004)#0A..t(FIX(sys(Sys_flt,.fl_fl
oor,.#23-2#2E5)#23*1004#2E0),.-3004)#0A#0A..t(FIX(s
ys(Sys_flt,.fl_fmod,.100#2E25,.25#2E0)#23*1004#2E0)
,..00025002)#0A}#0A#0A1AND.locals(p3,p4,p5,p6,p7,p8
,p9,p10,p11,p12,p13,p14,p15,p16,p17).BE#0A{.t(p3,.1
03)#0A..t(p4,.104)#0A..t(p5,.105)#0A..t(p6,.106)#0A
..t(p7,.107)#0A..t(p8,.108)#0A..t(p9,.109)#0A..t(p1
0,110000)#0A..t(p11,111)#0A..t(p12,110002)#0A..t(p1
3,110003)#0A..t(p14,110004)#0A..t(p15,110005)#0A..t
(p16,110006)#0A..t(p17,110007)#0A}#0A

######com/xdecode.b#
SECTION."XDECODE"#0D#0A#0D#0AGET."libhdr"#0D#0A#0D#0A
/*#0D#0AThis.program.decodes.a.file.encoded.by.the.
xencode.command#2E#0D#0ASee.xencode#2Eb.for.details
#2E#0D#0A#0D#0AWritten.by.Martin.Richards.(c).Septe
mber.2000008#0D#0A*/#0D#0A#0D#0AGLOBAL#0D#0A{#0D#0A
inputstream:ug#0D#0Aoutstream#0D#0Ahashcount#0D#0Al
isting#0D#0A}#0D#0A#0D#0ALET.start().#3D.VALOF#0D#0A
{.LET.count.#3D.0#0D#0A..LET.argv.#3D.VEC.50#0D#0A.
.LET.fromname.#3D."data"#0D#0A..LET.toname.#3D.VEC.
256/bytesperword#0D#0A..LET.rc.#3D.0#0D#0A..LET.ch.
#3D.0#0D#0A..LET.stdout.#3D.output()#0D#0A#0D#0A..i
nputstream.:#3D.0#0D#0A..outstream.:#3D.0#0D#0A..li
sting.:#3D.FALSE#0D#0A..newline()#0D#0A#0D#0A..IF.r
dargs("FROM/A,LIST/S",.argv,.50).#3D.0.DO#0D#0A..{.
writes("Bad.args.for.XDECODE*n")#0D#0A..3rc.:#3D.20
#0D#0A..3GOTO.exit#0D#0A..}#0D#0A#0D#0A..fromname.:
#3D.argv!0#0D#0A..listing..:#3D.argv!1#0D#0A#0D#0A.
.inputstream.:#3D.findinput(fromname)#0D#0A..UNLESS
.inputstream.DO.{.writef("Can*'t.open.%s*n",.fromna
me)#0D#0A..24rc.:#3D.20#0D#0A..24GOTO.exit#0D#0A..2
2}#0D#0A..selectinput(inputstream)#0D#0A#0D#0A..has
hcount.:#3D.0#0D#0A#0D#0Anext:#0D#0A..//.Start.of.m
ain.extraction.loop#0D#0A..selectoutput(stdout)#0D#0A
..#0D#0A..{.//.Find.the.next.separator#0D#0A..2ch.:
#3D.rdch()#0D#0A#0D#0A..2IF.ch#3Dendstreamch.GOTO.e
xit#0D#0A#0D#0A..2IF.ch#3D'#23'.DO#0D#0A..2{.hashco
unt.:#3D.hashcount+1#0D#0A#0D#0A..4{.ch.:#3D.rdch()
#0D#0A..6IF.ch#3Dendstreamch.GOTO.exit#0D#0A..6UNLE
SS.ch#3D'#23'.BREAK#0D#0A..6hashcount.:#3D.hashcoun
t+1#0D#0A..4}.REPEAT#0D#0A#0D#0A..4//.Hashcount.#3D
.number.of.consecutive.'#23's#0D#0A..4//.If.>#3D.6.
then.we.have.a.separator#2E.It.should.be.of.the.for
m#0D#0A..4//.#23#234filename#23#0D#0A..4IF.hashcoun
t>#3D6.DO#0D#0A..4{.//.Read.the.filename.into.tonam
e#0D#0A..6LET.len.#3D.0#0D#0A..6toname%0.:#3D.0#0D#0A
..6UNTIL.ch#3D'#23'.|.ch#3D'*n'.DO#0D#0A..6{.IF.ch#3D
endstreamch.GOTO.exit#0D#0A..8len.:#3D.len+1#0D#0A.
.8IF.len>255.BREAK#0D#0A..8toname%0,.toname%len.:#3D
.len,.ch#0D#0A..8ch.:#3D.rdch()#0D#0A..6}#0D#0A#0D#0A
..6//writef("Item.separator.found*n")#0D#0A..6//FOR
.i.#3D.1.TO.hashcount.DO.wrch('#23')#0D#0A..6//writ
ef("%s%c*n",.toname,.ch)#0D#0A#0D#0A..6IF.toname%0#3D
1.&.toname%1#3D'+'.DO#0D#0A..6{.//.Final.terminator
.found#0D#0A..8GOTO.exit#0D#0A..6}#0D#0A#0D#0A..6UN
LESS.ch#3D'#23'.&.0<len<256.&.hashcount>#3D6.DO#0D#0A
..6{.writef("Bad.item.separator*n")#0D#0A..8FOR.i.#3D
.1.TO.hashcount.DO.wrch('#23')#0D#0A..8writef("%s%c
*n",.toname,.ch)#0D#0A..8GOTO.exit#0D#0A..6}#0D#0A.
.6BREAK#0D#0A..4}#0D#0A..2}#0D#0A..}.REPEATUNTIL.ch
#3Dendstreamch#0D#0A#0D#0A..IF.ch#3Dendstreamch.GOT
O.exit#0D#0A#0D#0A..writef("Decoding.to.file:.%s*n"
,.toname)#0D#0A#0D#0A..IF.listing.DO.toname.:#3D."N
IL:"#0D#0A#0D#0A..outstream.:#3D.0#0D#0A#0D#0A..UNL
ESS.listing.DO#0D#0A..{.outstream.:#3D.findoutput(t
oname)#0D#0A..2UNLESS.outstream.DO#0D#0A..2{.writef
("Can*'t.open.%s*n",.toname)#0D#0A..4rc.:#3D.20#0D#0A
..4GOTO.exit#0D#0A..2}#0D#0A#0D#0A..2selectoutput(o
utstream)#0D#0A..}#0D#0A#0D#0A..{.ch.:#3D.rdch()#0D
#0A#0D#0A..2SWITCHON.ch.INTO#0D#0A..2{.DEFAULT:..1I
F.outstream.DO.wrch(ch)#0D#0A..15LOOP#0D#0A#0D#0A..
4CASE.endstreamch:#0D#0A..15GOTO.exit#0D#0A#0D#0A..
4CASE.'#2E':..IF.outstream.DO.wrch('.')#0D#0A..15LO
OP#0D#0A#0D#0A..4CASE.'#3D':..8//.'#3D'.must.be.esc
aped!#0D#0A..4CASE.'*n':.LOOP#0D#0A#0D#0A..4CASE.'#23
':..//.Either.an.escaped.character.or.the.start.of.
a.separator#0D#0A..13{.LET.a.#3D.rdch()#0D#0A..15LE
T.b.#3D.rdch()#0D#0A..15IF.a#3D'#23'.&.b#3D'#23'.DO
#0D#0A..15{.//.It.must.be.a.separator#0D#0A..17hash
count.:#3D.3#0D#0A..17IF.outstream.DO.endstream(out
stream)#0D#0A..17outstream.:#3D.0#0D#0A..17selectou
tput(stdout)#0D#0A..17GOTO.next#0D#0A..15}#0D#0A..1
5IF.a#3Dendstreamch.|.b#3Dendstreamch.GOTO.exit#0D#0A
..15//.Otherwise.write.escaped.character#0D#0A..15I
F.outstream.DO.wrch((value(a)<<0004).+.value(b))#0D
#0A..15LOOP#0D#0A..13}#0D#0A..2}#0D#0A..}.REPEAT#0D
#0A#0D#0Aexit:#0D#0A..IF.inputstream..DO.{.endstrea
m(inputstream);.inputstream.:#3D.0.}#0D#0A..IF.outs
tream..2DO.{.endstream(outstream);..1outstream.:#3D
.0.}#0D#0A..RESULTIS.rc#0D#0A}#0D#0A#0D#0AAND.value
(ch).#3D.VALOF.SWITCHON.ch.INTO#0D#0A{.DEFAULT:#0D#0A
..2writef("#23#23%x2#23#23",.ch)#0D#0A..2RESULTIS.0
#0D#0A#0D#0A..CASE.'0':CASE.'1':CASE.'2':CASE.'3':C
ASE.'4':#0D#0A..CASE.'5':CASE.'6':CASE.'7':CASE.'8'
:CASE.'9':#0D#0A..2RESULTIS.ch-'0'#0D#0A..2#0D#0A..
CASE.'A':CASE.'B':CASE.'C':CASE.'D':CASE.'E':#0D#0A
..CASE.'F':#0D#0A..2RESULTIS.ch.-.'A'.+.10#0D#0A#0D
#0A..CASE.'a':CASE.'b':CASE.'c':CASE.'d':CASE.'e':#0D
#0A..CASE.'f':#0D#0A..2RESULTIS.ch.-.'a'.+.10#0D#0A
}#0D#0A

######com/xencode.b#
SECTION."XENCODE"#0D#0A#0D#0AGET."libhdr"#0D#0A#0D#0A
/*#0D#0AThis.program.encodes.a.collection.of.one.or
.more.character#0D#0Aor.binary.files.into.a.file.of
.printable.characters.with.lines#0D#0Aof.about.50.c
haracters.suitable.for.transmission.by.email#2E#0D#0A
#0D#0AUsage:.xencode."FILE,LIST/K,TO/K/A"#0D#0A#0D#0A
where.FILE.is.the.name.of.a.single.file.to.encode#0D
#0A..4LIST.is.a.list.of.file.names.of.files.to.enco
de#2E#0D#0A.and..TO..1is.the.encoded.file#0D#0A#0D#0A
One.or.other.of.FILE.and.LIST.must.be.supplied#2E#0D
#0AIf.both.are.given.FILE.will.give.the.first.filen
ame.to.be.encoded#0D#0Afollowed.by.those.given.by.L
IST#2E#0D#0A#0D#0AEach.encoded.file.is.preceeded.by
.a.separator.of.the.form:#0D#0A#0D#0A#23#233filenam
e#23#0D#0A#0D#0Afollowed.by.the.encoded.file.in.whi
ch.all.characters.with.ASCII.codes#0D#0Ain.the.rang
e.33.to.126.except.for.'#23',.'#3D'.and.'#2E'.are.c
opied,.spaces.are#0D#0Areplaced.by.dots.('#2E').and
.all.other.characters.(including.'#23'.'#3D'.and#0D
#0A'#2E').are.encoded.by.#23hh.where.hh.is.the.ASCI
I.code.in.hex#2E.The.encoded#0D#0Afile.is.broken.in
to.lines.of.about.50.characters#2E#0D#0A#0D#0AThe.l
ast.file.to.be.encoded.is.terminated.by.#23#234+#23
#2E#0D#0A#0D#0ASuch.xencode'd.files.can.be.decoded.
by.the.xdecode.command#2E#0D#0A#0D#0AWritten.by.Mar
tin.Richards.(c).September.2000008#0D#0A*/#0D#0A#0D
#0AGLOBAL#0D#0A{#0D#0Atostream:.ug#0D#0Astdin#0D#0A
stdout#0D#0Aliststream#0D#0A}#0D#0A#0D#0ALET.start(
).#3D.VALOF#0D#0A{.LET.file1name.#3D.0#0D#0A..LET.l
istname.#3D.0#0D#0A..LET.rc.#3D.0#0D#0A..LET.filena
me.#3D.VEC.256/bytesperword#0D#0A..LET.argv.#3D.VEC
.50#0D#0A#0D#0A..stdin,.stdout.:#3D.input(),.output
()#0D#0A#0D#0A..tostream.:#3D.0#0D#0A..liststream.:
#3D.0#0D#0A..newline()#0D#0A#0D#0A..IF.rdargs("FILE
,LIST/K,TO/K/A",.argv,.50).#3D.0.DO#0D#0A..{.writes
("Bad.args.for.XENCODE*n")#0D#0A..2rc.:#3D.20#0D#0A
..2GOTO.exit#0D#0A..}#0D#0A#0D#0A..file1name.:#3D.a
rgv!0..12//.FILE#0D#0A..listname..:#3D.argv!1..12//
.LIST#0D#0A#0D#0A..IF.argv!2.DO.{.tostream.:#3D.fin
doutput(argv!2)#0D#0A..15UNLESS.tostream.DO#0D#0A..
15{.writef("Can*'t.open.%s*n",.argv!2)#0D#0A..17rc.
:#3D.20#0D#0A..17GOTO.exit#0D#0A..15}#0D#0A..13}#0D
#0A#0D#0A#0D#0A..UNLESS.file1name.|.listname.DO#0D#0A
..{.writes("Error:.At.least.one.of.FILE.and.LIST.mu
st.be.given*n")#0D#0A..2rc.:#3D.20#0D#0A..2GOTO.exi
t#0D#0A..}#0D#0A#0D#0A..IF.file1name.DO.xencode(fil
e1name)#0D#0A#0D#0A..IF.listname..DO.xencodelist(li
stname)#0D#0A#0D#0A..selectoutput(tostream)#0D#0A#0D
#0A..writef("*n#23#234+#23*n").//.The.termination.m
arker#0D#0A#0D#0Aexit:#0D#0A..1UNLESS.tostream#3D0.
DO.{.selectoutput(tostream);.endwrite().}#0D#0A..1R
ESULTIS.rc#0D#0A}#0D#0A#0D#0AAND.xencode(name).BE#0D
#0A{.LET.oldin.#3D.input()#0D#0A..LET.inputstream.#3D
.findinput(name)#0D#0A..LET.count.#3D.0#0D#0A#0D#0A
..UNLESS.inputstream.DO.{.writef("Can*'t.open.%s*n"
,.name)#0D#0A..24RETURN#0D#0A..22}#0D#0A..writef("E
ncoding.file:.%s*n",.name)#0D#0A#0D#0A..selectinput
(inputstream)#0D#0A..selectoutput(tostream)#0D#0A#0D
#0A..writef("*n#23#234%s#23*n",.name)#0D#0A#0D#0A..
{.LET.ch.#3D.rdch()#0D#0A..2IF.ch#3Dendstreamch.BRE
AK#0D#0A#0D#0A..2TEST.32<#3Dch<127.&.ch~#3D'#23'.&.
ch~#3D'#2E'.&ch~#3D'#3D'#0D#0A..2THEN.{.IF.ch#3D'.'
.DO.ch.:#3D.'#2E'#0D#0A..9wrch(ch)#0D#0A..9count.:#3D
.count+1#0D#0A..7}#0D#0A..2ELSE.{.writef("#23%x2",.
ch);.count.:#3D.count+3.}#0D#0A#0D#0A..2IF.count>50
.DO.{.newline();.count.:#3D.0.}#0D#0A..}.REPEAT#0D#0A
#0D#0A..newline()#0D#0A..endstream(inputstream)#0D#0A
..selectinput(oldin)#0D#0A..selectoutput(stdout)#0D
#0A}#0D#0A#0D#0AAND.xencodelist(name).BE#0D#0A{.LET
.liststream.#3D.findinput(name)#0D#0A#0D#0A..UNLESS
.liststream.DO.{.writef("Can*'t.open.%s*n",.name)#0D
#0A..23RETURN#0D#0A..21}#0D#0A..selectinput(liststr
eam)#0D#0A#0D#0A..{.LET.ch.#3D.rdch()#0D#0A..2LET.l
en.#3D.0#0D#0A..2LET.filename.#3D.VEC.255/bytesperw
ord#0D#0A#0D#0A..2IF.ch#3Dendstreamch.BREAK#0D#0A..
2IF.ch#3D'*n'.|.ch#3D'*s'.LOOP#0D#0A..2len.:#3D.0#0D
#0A..2filename%0.:#3D.0#0D#0A..2#0D#0A..2UNTIL.ch#3D
'*n'.|.ch#3D'*s'.|.ch#3Dendstreamch.|.len>#3D255.DO
#0D#0A..2{.len.:#3D.len+1#0D#0A..4filename%0,.filen
ame%len.:#3D.len,.ch#0D#0A..4ch.:#3D.rdch()#0D#0A..
2}#0D#0A#0D#0A..2IF.len.DO.xencode(filename)#0D#0A.
.2IF.ch#3Dendstreamch.BREAK#0D#0A..}.REPEAT..#0D#0A
#0D#0A..endstream(liststream)#0D#0A}#0D#0A#0D#0A

######com/xpal70.b#
//.This.is.a.version.of.PALSYS.as.it.was.for.the.IB
M.360.in#0A//.June.1970#2E.It.is.being.reformatted.
and.modified.by.M#2E.Richards#0A//.to.run.under.the
.BCPL.Cintsys#2E.November.2010#2E#0A#0A//.This.vers
ion.is.still.in.the.early.stages.of.development#2E#0A
#0A//.XPALHD.LAST.MODIFIED.ON.FRIDAY,.12.JUNE.1970#0A
//.AT.5:29:07#2E24.BY.R.MABEE#0A//.LISTING.OF.PAL.R
UN.TIME.SYSTEM.(XPAL).HEADFILE.AND.BCPL/360.BASIC#0A
//.HEADFILE.GOTTEN.WITHIN.SUPPRESSED.BY.NOLIST.DIRE
CTIVE#2E.TO.OVERRIDE#0A//.DIRECTIVE,.SPECIFY.ALLSOU
RCE.OPTION.TO.BCPL.COMPILER#2E#0A//>>1.NOLIST#0A//>
>1.EJECT#0A//#0A//#09.**28#0A//#09.*..26*#0A//#09.*
..9XPALHD..9*#0A//#09.*..26*#0A//#09.*..(COMPATIBLE
.WITH.PALSYS)..*#0A//#09.*..26*#0A//#09.**28#0A//#0A
//.GET.BASIC.BCPL/360.HEAD.FILE#0A//>>1.GET."BASIC"
#0A#0AGET."libhdr"#0A#0AGLOBAL.#09//.FLOTLIB.GLOBAL
S#0A{.fadd:..00271.//.FADD(REAL1,REAL2).#3D.REAL1.+
.REAL2#0A..fsub:..00272.//.FSUB(REAL1,REAL2).#3D.RE
AL1.-.REAL2#0A..fmult:..00173.//.FMULT(REAL1,REAL2)
.#3D.REAL1.*.REAL2#0A..fdiv:..00274.//.FDIV(REAL1,R
EAL2).#3D.REAL1./.REAL2#0A..fpower:..00075.//.FPOWE
R(REAL,INTEGER).#3D.REAL.**.INTEGER#0A..fumin:..001
76.//.FUMIN(REAL).#3D.-.REAL#0A..fabs:..00277.//.FA
BS(REAL).#3D.ABS.REAL#0A..fgr:..00378.//.FGR(REAL1,
REAL2).#3D.BOOLEAN#0A..fge:..00379.//.FGE(REAL1,REA
L2).#3D.BOOLEAN#0A..feq:..00380.//.FEQ(REAL1,REAL2)
.#3D.BOOLEAN#0A..fne:..00381.//.FNE(REAL1,REAL2).#3D
.BOOLEAN#0A..fle:..00383.//.FLE(REAL1,#0A..fls:..00
382.//.FLS(REAL1,REAL2).#3D.BOOLEAN#0A..itor:..0028
4.//.ITOR(INTEGER).#3D.REAL#0A..rtoi:..00285.//.RTO
I(REAL).#3D.INTEGER#0A..stof:..00286.//.STOF(STRING
).#3D.REAL#0A..ftos:..00287.//.FTOS(REAL,STRING).#3D
.STRING#0A..stoi:..00288.//.STOI(STRING).#3D.INTEGE
R#0A..writef:..00089.//.WRITEF(REAL).WRITES.REAL.NU
MBER#0A..floterr:.90.//.TRUE.IF.FL.PT.ERROR.OCCURS#0A
}#0A#0A1MANIFEST.{#0A//.VECTOR.APPLICATION#0A..h1#3D
0;.h2#3D1;.h3#3D2;.h4#3D3;.h5#3D4;.h6#3D5;.h7#3D6#0A
#0A//.AE.NODES.AND.POCODE.SYMBOLS#0A..m_goto#3D148;
.m_res#3D149#0A..m_not#3D151;.m_nil#3D152;.stringco
nst#3D153;.name#3D154#0A..m_plus#3D157;.m_minus#3D1
58#0A..m_aug#3D160;.m_logor#3D161;.m_logand#3D162#0A
..m_ge#3D163;.m_ne#3D164;.m_le#3D165;.m_gr#3D166;.m
_ls#3D167;.m_eq#3D168#0A..m_mult#3D169;.m_div#3D170
;.m_power#3D171#0A..m_pos#3D173;.m_neg#3D174;.m_app
ly#3D175#0A#0A//.POCODE.SYMBOLS#0A..m_loadl#3D181;.
m_loadr#3D182;.m_loade#3D183;.m_loads#3D184;.m_load
n#3D185#0A..m_restoree0001#3D187;.m_loadguess#3D188
#0A..m_formclosure#3D189;.m_formlvalue#3D190;.m_for
mrvalue#3D191#0A..m_members#3D192#0A..m_jump#3D195;
.m_jumpf#3D196;.m_save#3D197;.m_return#3D198#0A..m_
testempty#3D199;.m_lose1#3D200;.m_update#3D201#0A..
m_declname#3D203;.m_declnames#3D204;.m_initname#3D2
05;.m_initnames#3D206#0A..m_decllabel#3D207;.m_setl
abes#3D208;.m_blocklink#3D209;.m_reslink#3D210#0A..
m_setup#3D211#0A..integer#3D213;.lab#3D214;.param#3D
215;.equ#3D216#0A#0A//.RUN-TIME.NODE.TYPES#0A..m_du
mmy#3D220000;.jj#3D220001;.m_true#3D221;.m_false#3D
220003;.number#3D220004#0A..m_tuple#3D220005;.closu
re#3D220006;.basicfn#3D220007#0A..lvalue#3D220008;.
string#3D220009;.nils#3D230;.real#3D231#0A..label#3D
232;.guess#3D233;.env#3D234;.stack#3D235#0A}#0A#0A1
GLOBAL.{#0A//.PLACEMENT.SET.BY.PALSYS#0A..xpal:202;
.timeovfl:199;.time_exceeded:93#0A#0A//.RUN.TIME.SY
STEM.GLOBAL.FUNCTIONS#0A..load:375;.setparams:376;.
mapliblist:377;.libname:378;.decllib:379;#0A..loadl
:380;.loadr:381;.loadj:382;.loade:383;.loads:384;.l
oadn:385;#0A..restoree0001:386;.r_true:387;.r_false
:388;.loadguess:389;.nil:390;#0A..dummy:391;.formcl
osure:392;.formlvalue:393;.nextlv11:394;.next11:395
;#0A..formrvalue:396;.tuple:397;.members:398;.r_not
:399;.r_logand:400;#0A..r_logor:401;.aug:402;.resul
t:403;.mult:404;.div:405;.plus:406;#0A..minus:407;.
power:408;.pos:409;.neg:410;.r_eq:411;.r_ne:412;.r_
ls:413;#0A..r_le:414;.r_gr:415;.r_ge:416;.jump:417;
.jumpf:418;.edbg:419;#0A..errdbg:420;.errlvdbg:421;
.errokdbg:422;.comdbg:423;.okrestart:424;#0A..rvres
tart:425;.norestart:426;.apply:427;.save:428;.r_ret
urn:429;#0A..testempty:430;.lose1:431;.r_goto:432;.
update:433;.error:434;#0A..error1:435;.printb:436;.
printa:437;.equal:438;.testnumbs2:439;#0A..testbool
s2:440000;.lvofname:440001;.nameoflv:440002;.restar
t:440003;#0A..terminate:441;.terminate1:440005;.las
tfn1:440006;.writenode:440007;.node:440008;#0A..nex
tarea:440009;.marklist:450;.mark:451;.list:452;.spl
it1:453;#0A..split2:454;.declname:455;.declnames:45
6;.initname:457;.initnames:458;#0A..r_name:459;.nam
eerror:460;.decllabel:461;.setlabes:462;#0A..blockl
ink:463;.reslink:464;.setup:465;.r_finish:466;.prin
t:467;#0A..userpage:468;.stem:469;.stern:470;.conc:
471;.atom:472;.null:473;#0A..length:474;.istruthval
ue:475;.isnumber:476;.isstring:477;#0A..isfunction:
478;.isenviroment:479;.islabel:480;.istuple:481;#0A
..isreal:482;.isdummy:483;.share:484;.ston:485;.cto
n:486;.ntoc:487;#0A..ntor:488;.rton:489;.rdchar:490
;.r_table:491;.diagnose:492;#0A..lastfn:493;.lookup
ine:494;.saveenv:495#0A#0A//.RUN.TIME.SYSTEM.GLOBAL
.VARIABLES#0A..a:501;.b:502;.c:503;.codep:504;.coun
t:505;.dummyrv:506;.errct:507;#0A..errflag:508;.err
orlv:509;.e:510;.f:511;.falserv:512;.gcmark:513;#0A
..guessrv:514;.linep:515;.linet:516;.linev:517;.lis
tl:518;.listp:519;#0A..listt:520;.listv:521;.lookup
no:522;.namechain:523;.nameres:524;#0A..nilrv:525;.
nilsrv:526;.nset:527;.oldc:528;.parv:529;.q:530;#0A
..refp:531;.reft:532;.refv:533;.restartc:534;.s:535
;.stackp:536;#0A..strb:537;.strp:538;.tlength:539;.
top:540;.truerv:541#0A#0A//.VARIABLES.COMMON.WITH.P
ALSYS#0A..ch#09#09:.218.//.LAST.CHARACTER.READ#0A..
codefile#09:.219.//.POINTER.TO.POCODE.STORAGE.AREA#0A
..codefilep#09:.220000.//.POINTER.TO.NEXT.WORD.POCO
DE.STORAGE#0A..dataflag#09:.220001.//.INDICATES.IF.
DATA.FOLLOWS.RUN.CARD#0A..gcdbg#09#09:.232.//.INDIC
ATES.IF.COLLECTER.DEBUGGING.ON#0A..input#09#09:.234
.//.PRESENT.INPUT.STREAM#0A..lvch#09#09:.251.//.LVA
LUE.OF.CH#0A..maxct#09#09:.252.//.XPAL.MAXIMUM.CYCL
E.COUNT#0A..maxerr#09:.253.//.XPAL.MAXIMUM.ERROR.CO
UNT#0A..stackwarning#09:.269.//.APPROXIMATE.END.BCP
L.RUN.TIME.STACK#0A..storage#09:.272.//.POINTER.TO.
USABLE.FREE.STORAGE#0A..storaget#09:.273.//.POINTER
.TO.END.OF.USABLE.FREE.STORAGE#0A..tupledepth#09:.2
87.//.XPAL.MAXIMUM.TUPLE.PRINT.DEPTH#0A..xpend#09#09
:.289.//.GLOBAL.LABEL#0A..xpendlevel#09:.290.//.LEV
EL.OF.GLOBAL.LABEL.XPEND#0A}#0A#0A1//>>1.LIST#0A#0A
//.XPAL1.LAST.MODIFIED.ON.FRIDAY,.12.JUNE.1970#0A//
.AT.5:37:27#2E45.BY.R.MABEE#0A//>>1.FILENAME."XPAL1
"#0A//#0A//#09**9#0A//#09*..7*#0A//#09*..XPAL1..*#0A
//#09*..7*#0A//#09**9#0A//#0A//>>1.GET."XPALHD"#0A/
/>>1.EJECT#0A//.XPAL1A#0ALET.load().BE#0A{.LET.ch,.
a,.p.#3D.0,.0,.codefile#0A..LET.v.#3D.VEC.255#0A..r
efp.:#3D.0#0A..GOTO.l#0Am:#0A..codep!0,.codep.:#3D.
a,.codep+1#0Al:#0A..ch,.p.:#3D.p!0,.p+1#0A..SWITCHO
N.ch.INTO#0A..{.DEFAULT:#0A..4UNLESS.ch#3Dendstream
ch.DO#0A..4{.writes("ILLEGAL.SYMBOL.IN.LOADER.")#0A
..6writen(ch)#0A..6newline()#0A..6GOTO.l#0A..4}#0A.
.4setparams()#0A..4RETURN#0A#0A..2CASE.name:#0A..2C
ASE.stringconst:#0A..2{.LET.l,.n,.s.#3D.namechain,.
0,0#0A..4ch,.p.:#3D.p!0,.p+1#0A..4v!0.:#3D.ch#0A..4
FOR.i.#3D.1.TO.ch.DO.v!i,.p.:#3D.p!0,.p+1#0A..4n.:#3D
.ch/bytesperword.+.1#0A..4s.:#3D.strp.-.n#0A..4pack
string(v,.s)#0A..4UNTIL.l#3D0.DO#0A..4{.LET.v.#3D.l
!1#0A..6IF.s!0#3Dv!0.DO#0A..6{.IF.n#3D1.BREAK#0A..8
IF.s!1#3Dv!1.DO#0A..8{.IF.n#3D2.BREAK#0A..10IF.s!2#3D
v!2.DO#0A..10{.IF.n#3D3.BREAK#0A..12IF.s!3#3Dv!3.DO
#0A..12{.IF.n#3D4.BREAK#0A..14IF.s!4#3Dv!4.IF.n#3D5
.BREAK#0A..12}#0A..10}#0A..8}#0A..6}#0A..6l.:#3D.l!
0#0A..4}#0A..4UNLESS.l#3D0.DO#0A..4{.a.:#3D.l!1#0A.
.6GOTO.m#0A..4}#0A..4strp.:#3D.s.-.2#0A..4IF.strp<s
trb.DO#0A..4{.writes("*n*n*n*tSYMBOL.TABLE.OVERFLOW
.IN.*#0A..14*XPAL.LOADER#2E.NO.EXECUTION#2E*n")#0A.
.6longjump(xpend,.xpendlevel)#0A..4}#0A..4strp!0.:#3D
.namechain#0A..4strp!1.:#3D.s#0A..4namechain.:#3D.s
trp#0A..4a.:#3D.s#0A..4GOTO.m#0A..2}#0A#0A..2CASE.n
umber:#0A..2{.LET.dot.#3D.FALSE#0A..4ch,.p.:#3D.p!0
,.p+1#0A..4v!0.:#3D.ch#0A..4FOR.i.#3D.1.TO.ch.DO#0A
..4{.v!i,.p.:#3D.p!0,.p+1#0A#09IF.v!i#3D'#2E'.DO.do
t.:#3D.TRUE#0A..4}#0A..4TEST.dot#0A..4THEN.{.codep!
0.:#3D.real#0A..11codep.:#3D.codep.+.1#0A..11packst
ring(v,.codep)#0A..11a.:#3D.stof(codep)#0A..9}#0A..
4ELSE.{.codep!0.:#3D.number#0A..11codep.:#3D.codep.
+.1#0A..11a.:#3D.v!1.-.'O'#0A..11FOR.i.#3D.2.TO.ch.
DO.a.:#3D.a*10.+.v!i.-.'O'#0A..9}#0A..4GOTO.m#0A..2
}#0A#0A..2CASE.integer:#0A..4a,.p.:#3D.p!0,.p+1#0A.
.4GOTO.m#0A#0A1..2CASE.lab:#0A..4ch,.p.:#3D.p!0,.p+
1#0A..4parv!ch.:#3D.codep#0A..4GOTO.l#0A#0A..2CASE.
param:#0A..4ch,.p.:#3D.p!0,.p+1#0A..4refv!refp,.ref
v!(refp+1).:#3D.ch,.codep#0A..4refp.:#3D.refp.+.2#0A
..4IF.refp>reft.DO#0A..4{.writes("*n*n*n*tTABLE.OVE
RFLOW.IN.XPAL.*#0A..13*LOADER#2E.NO.EXECUTION#2E*n"
)#0A..6longjump(xpend,.xpendlevel)#0A..4}#0A..4a.:#3D
.0#0A..4GOTO.m#0A#0A..2CASE.equ:#0A..4a,.ch,.p.:#3D
.p!0,.p!1,.p+2#0A..4parv!a.:#3D.ch#0A..4GOTO.l#0A#0A
..2CASE.m_setlabes:..1a.:#3D.setlabes;.GOTO.m#0A..2
CASE.m_restoree0001:..a.:#3D.restoree0001;.GOTO.m#0A
..2CASE.m_formrvalue:.a.:#3D.formrvalue;.GOTO.m#0A.
.2CASE.m_formlvalue:.a.:#3D.formlvalue;.GOTO.m#0A..
2CASE.m_tuple:..4a.:#3D.tuple;.GOTO.m#0A..2CASE.m_m
embers:..2a.:#3D.members;.GOTO.m#0A..2CASE.m_loadgu
ess:..a.:#3D.loadguess;.GOTO.m#0A..2CASE.m_true:..5
a.:#3D.r_true;.GOTO.m#0A..2CASE.m_false:..4a.:#3D.r
_false;.GOTO.m#0A..2CASE.m_lose1:..4a.:#3D.lose1;.G
OTO.m#0A..2CASE.m_mult:..5a.:#3D.mult;.GOTO.m#0A..2
CASE.m_div:..6a.:#3D.div;.GOTO.m#0A..2CASE.m_plus:.
.5a.:#3D.plus;.GOTO.m#0A..2CASE.m_minus:..4a.:#3D.m
inus;.GOTO.m#0A..2CASE.m_pos:..6a.:#3D.pos;.GOTO.m#0A
..2CASE.m_neg:..6a.:#3D.neg;.GOTO.m#0A..2CASE.m_eq:
..7a.:#3D.r_eq;.GOTO.m#0A..2CASE.m_ls:..7a.:#3D.r_l
s;.GOTO.m#0A..2CASE.m_gr:..7a.:#3D.r_gr;.GOTO.m#0A.
.2CASE.m_le:..7a.:#3D.r_le;.GOTO.m#0A..2CASE.m_ne:.
.7a.:#3D.r_ne;.GOTO.m#0A..2CASE.m_ge:..7a.:#3D.r_ge
;.GOTO.m#0A..2CASE.m_logand:..3a.:#3D.r_logand;.GOT
O.m#0A..2CASE.m_logor:..4a.:#3D.r_logor;.GOTO.m#0A.
.2CASE.m_save:..5a.:#3D.save;.GOTO.m#0A..2CASE.m_ap
ply:..4a.:#3D.apply;.GOTO.m#0A..2CASE.m_not:#09..5a
.:#3D.r_not;.GOTO.m#0A..2CASE.jj:..9a.:#3D.loadj;.G
OTO.m#0A..2CASE.m_update:..3a.:#3D.update;.GOTO.m#0A
..2CASE.m_res:..6a.:#3D.result;.GOTO.m#0A..2CASE.m_
goto:..5a.:#3D.r_goto;.GOTO.m#0A..2CASE.m_loadr:..4
a.:#3D.loadr;.GOTO.m#0A..2CASE.m_loadl:..4a.:#3D.lo
adl;.GOTO.m#0A..2CASE.m_loads:..4a.:#3D.loads;.GOTO
.m#0A..2CASE.m_loadn:..4a.:#3D.loadn;.GOTO.m#0A..2C
ASE.m_loade:..4a.:#3D.loade;.GOTO.m#0A..2CASE.m_tes
tempty:..a.:#3D.testempty;.GOTO.m#0A..2CASE.m_decln
ame:..1a.:#3D.declname;.GOTO.m#0A..2CASE.m_declname
s:..a.:#3D.declnames;.GOTO.m#0A..2CASE.m_initname:.
.1a.:#3D.initname;.GOTO.m#0A..2CASE.m_initnames:..a
.:#3D.initnames;.GOTO.m#0A..2CASE.m_formclosure:a.:
#3D.formclosure;.GOTO.m#0A..2CASE.m_jumpf:..4a.:#3D
.jumpf;.GOTO.m#0A..2CASE.m_jump:..5a.:#3D.jump;.GOT
O.m#0A..2CASE.m_decllabel:..a.:#3D.decllabel;.GOTO.
m#0A..2CASE.m_return:..3a.:#3D.r_return;.GOTO.m#0A.
.2CASE.m_blocklink:..a.:#3D.blocklink;.GOTO.m#0A..2
CASE.m_reslink:..2a.:#3D.reslink;.GOTO.m#0A..2CASE.
m_power:..4a.:#3D.power;.GOTO.m#0A..2CASE.m_nil:..6
a.:#3D.nil;.GOTO.m#0A..2CASE.m_dummy:..4a.:#3D.dumm
y;.GOTO.m#0A..2CASE.m_aug:..6a.:#3D.aug;.GOTO.m#0A.
.2CASE.m_setup:..4setparams()#0A..21a.:#3D.setup;.G
OTO.m#0A..}#0A}#0A#0AAND.setparams().BE#0A{.LET.i.#3D
.0#0A..UNTIL.i#3Drefp.DO#0A..{.!.(refv!(i+1)).:#3D.
parv!(refv!i)#0A..2i.:#3D.i.+.2#0A..}#0A..refp.:#3D
.0#0A}#0A#0A//>>1.EJECT#0A//.XPAL1B#0ALET.mapliblis
t(f).BE#0A{.f("PRINT",.print)#0A..f("PAGE",.userpag
e)#0A..f("STEM",.stem)#0A..f("STERN",.stern)#0A..f(
"CONC",.conc)#0A..f("ATOM",.atom)#0A..f("NULL",.nul
l)#0A..f("ORDER",.length)#0A..f("ISTRUTHVALUE",.ist
ruthvalue)#0A..f("ISINTEGER",.isnumber)#0A..f("ISRE
AL",.isreal)#0A..f("ISSTRING",.isstring)#0A..f("ISF
UNCTION",.isfunction)#0A..f("ISLABEL",.islabel)#0A.
.f("ISTUPLE",.istuple)#0A..f("ISDUMMY",.isdummy)#0A
..f("ISENVIROMENT",.isenviroment)#0A..f("FINISH",.r
_finish)#0A..f("SHARE",.share)#0A..f("STOI",.ston)#0A
..f("CTOI",.cton)#0A..f("ITOC",.ntoc)#0A..f("RTOI",
.rton)#0A..f("ITOR",.ntor)#0A..f("READCH",.rdchar)#0A
..f("DIAGNOSE",.diagnose)#0A..f("LASTFN",.lastfn)#0A
..f("TABLE",.r_table)#0A..f("LOOKUPINE",.lookupine)
#0A..f("SAVEENV",.saveenv)#0A}#0A#0AAND.libname(x,.
y).BE#0A{.strp.:#3D.strp.-.2#0A..IF.strp<strb.DO#0A
..{.writes("*n*n*n*tSYMBOL.TABLE.OVERFLOW.IN.XPAL.L
OADER#2E*#0A..9*.NO.EXECUTION#2E*n")#0A..2longjump(
xpend,.xpendlevel)#0A..}#0A..strp!0.:#3D.namechain#0A
..strp!1.:#3D.x#0A..namechain.:#3D.strp#0A}#0A#0AAN
D.decllib(x,.y).BE#0A{.a.:#3D.list(3,.basicfn,.y)#0A
..a.:#3D.list(3,.lvalue,.a)#0A..e.:#3D.list(5,.env,
.e,.x,.a)#0A}#0A#0A//.XPAL2.LAST.MODIFIED.ON.FRIDAY
,.12.JUNE.1970#0A//.AT.5:37:29#2E37.BY.R.MABEE#0A//
>>1.FILENAME."XPAL2"#0A//#0A//#09**9#0A//#09*..7*#0A
//#09*..XPAL2..*#0A//#09*..7*#0A//#09**9#0A//#0A//>
>1.GET."XPALHD"#0A//>>1.EJECT#0A//.XPAL2A#0ALET.loa
dl().BE#0A{.c.:#3D.c+1#0A..a.:#3D.lvofname(c!0,.e)#0A
..TEST.a#3Dnilrv#0A..THEN.{.a.:#3D.list(3,.lvalue,.
a)#0A..7errokdbg()#0A..5}#0A..ELSE.next11()#0A}#0A#0A
AND.loadr().BE#0A{.c.:#3D.c+1#0A..a.:#3D.lvofname(c
!0,.e)#0A..TEST.a#3Dnilrv#0A..THEN.errdbg()#0A..ELS
E.{.a.:#3D.h3!a#0A..7next11()#0A..5}#0A}#0A#0AAND.l
oadj().BE#0A{.a.:#3D.list(5,.jj,.h4!s,.h5!s,.h6!s.)
#0A..next11()#0A}#0A#0AAND.loade().BE#0A{.a.:#3D.e#0A
..next11()#0A}#0A#0AAND.loads().BE#0A{.LET.v.#3D.VE
C.200#0A..LET.i.#3D.0#0A..unpackstring(c!1,.v)#0A..
i.:#3D.v!0#0A..a.:#3D.nilsrv#0A..WHILE.i.>.0.DO#0A.
.{.a.:#3D.list(4,.string,.a,.v!i)#0A..2i:#3Di-1#0A.
.}#0A..c.:#3D.c+1#0A..next11()#0A}#0A#0AAND.loadn()
.BE#0A{.a.:#3D.list(3,.c!1,.c!2.)#0A..c.:#3D.c+2#0A
..next11()#0A}#0A#0AAND.restoree0001().BE#0A{.e.:#3D
.s!(stackp-2)#0A..stackp.:#3D.stackp-1#0A..s!(stack
p-1).:#3D.s!stackp#0A..c.:#3D.c.+.1#0A}#0A#0AAND.r_
true().BE#0A{.a.:#3D.truerv#0A..next11()#0A}#0A#0AA
ND.r_false().BE#0A{.a.:#3D.falserv#0A..next11()#0A}
#0A#0AAND.loadguess().BE#0A{.a.:#3D.guessrv#0A..nex
tlv11()#0A}#0A#0AAND.nil().BE#0A{.a.:#3D.nilrv#0A..
next11()#0A}#0A#0AAND.dummy().BE#0A{.a.:#3D.dummyrv
#0A..next11()#0A}#0A#0AAND.formclosure().BE#0A{.a.:
#3D.list(4,.closure,.e,.c!1.)#0A..c.:#3D.c+1#0A..ne
xt11()#0A}#0A#0AAND.formlvalue().BE#0A{.a.:#3D.list
(3,.lvalue,.s!(stackp-1))#0A..s!(stackp-1).:#3D.a#0A
..c.:#3D.c+1#0A}#0A#0AAND.nextlv11().BE#0A{.a.:#3D.
list(3,.lvalue,.a)#0A..next11()#0A}#0A#0AAND.next11
().BE#0A{.s!stackp.:#3D.a#0A..stackp.:#3D.stackp+1#0A
..c.:#3D.c.+.1#0A}#0A#0AAND.formrvalue().BE#0A{.s!(
stackp-1).:#3D.h3!(s!(stackp-1))#0A..c.:#3D.c+1#0A}
#0A#0AAND.tuple().BE#0A{.LET.n.#3D.c!1#0A..a.:#3D.n
ode(n+3)#0A..a!0,.a!1,.a!2.:#3D.n+3,.m_tuple,.n#0A.
.FOR.i.#3D.3.TO.n+2.DO#0A..2stackp,.a!i.:#3D.stackp
-1,.s!stackp#0A..c.:#3D.c+1#0A..next11()#0A}#0A#0AA
ND.members().BE#0A{.LET.n.#3D.c!1#0A..split1()#0A..
b.:#3D.h3!a#0A..FOR.i.#3D.-2.TO.n-3.DO#0A..{.s!stac
kp.:#3D.b!(n-i)#0A..2stackp.:#3D.stackp+1#0A..}#0A.
.c.:#3D.c+2#0A}#0A#0AAND.r_not().BE#0A{.split1()#0A
..IF.h2!a#3Dm_false.DO#0A..{.a.:#3D.truerv#0A..2nex
t11()#0A..2RETURN#0A..}#0A..TEST.h2!a#3Dm_true#0A..
THEN.{.a.:#3D.falserv#0A..7next11()#0A..6}#0A..ELSE
.{.error1("NOT",.a,.0)#0A..7errdbg()#0A..5}#0A}#0A#0A
AND.r_logand().BE#0A{.split2()#0A..TEST.testbools2(
)#0A..THEN.{.a.:#3D.h2!a#3Dm_true.->.b,.falserv#0A.
.7next11()#0A..5}#0A..ELSE.{.error1("&",.a,.b)#0A..
7a.:#3D.falserv#0A..7errdbg()#0A..5}#0A}#0A#0AAND.r
_logor().BE#0A{.split2()#0A..TEST.testbools2()#0A..
THEN.{.a.:#3D.h2!a#3Dm_false.->.b,.truerv#0A..7next
11()#0A..5}#0A..ELSE.{.error1("OR",.a,.b)#0A..7a.:#3D
.falserv#0A..7errdbg()#0A..5}#0A}#0A#0AAND.aug().BE
#0A{.split2()#0A..UNLESS.h2!a#3Dm_tuple.DO#0A..{.er
ror1("AUG",.a,.b)#0A..2a.:#3D.nilrv#0A..2errdbg()#0A
..2RETURN#0A..}#0A..{.LET.n.#3D.h3!a#0A..2LET.t.#3D
.node(n+4)#0A..2t!0,.t!1,.t!2,.t!(n+3).:#3D.n+4,.m_
tuple,.n+1,.b#0A..2FOR.i.#3D.3.TO.n+2.DO.t!i.:#3D.a
!i#0A..2a.:#3D.t#0A..2next11()#0A..}#0A}#0A#0AAND.r
esult().BE#0A{.a.:#3D.lvofname(nameres,.e)#0A..IF.a
#3Dnilrv.DO#0A..{.a.:#3D.list(3,.lvalue,.a)#0A..2GO
TO.reserr#0A..}#0A..a.:#3D.h3!a#0A..UNLESS.h2!a#3Dj
j.DO#0Areserr:#09{.error("INCORRECT.USE.OF.RES",.0,
.0,.0)#0A..8errokdbg()#0A..8RETURN#0A..6}#0A..h4!s,
.h5!s,.h6!s.:#3D.h3!a,.h4!a,.h5!a#0A..r_return()#0A
}#0A#0A//>>1.EJECT#0A//.XPAL2B#0ALET.mult().BE#0A{.
LET.t.#3D.a#0A..split2()#0A..IF.testnumbs2()#3Dnumb
er.DO#0A..{.a.:#3D.list(3,.number,.h3!a*h3!b.)#0A..
2next11()#0A..2RETURN#0A..}#0A..IF.testnumbs2()#3Dr
eal.DO#0A..{.a.:#3D.list(3,.real,.fmult(h3!a,.h3!b)
.)#0A..2IF.floterr.DO#0A..2{.writes("*nOVERFLOW:")#0A
..4floterr.:#3D.FALSE#0A..4GOTO.fmuerr#0A..2}#0A..2
next11()#0A..2RETURN#0A..}#0A..a.:#3D.list(3,.numbe
r,.0)#0Afmuerr:#0A..error1("**",.t,.b)#0A..errdbg()
#0A}#0A#0AAND.div().BE#0A{.LET.t.#3D.a#0A..split2()
#0A..IF.testnumbs2()#3Dnumber.DO#0A..{.IF.h3!b#3D0.
GOTO.derr#0A..2a.:#3D.list(3,.number,.h3!a/h3!b.)#0A
..2next11()#0A..2RETURN#0A..}#0A..IF.testnumbs2()#3D
real.DO#0A..{.a.:#3D.list(3,.real,.fdiv(h3!a,.h3!b)
.)#0A..2IF.floterr.DO#0A..2{.UNLESS.feq(h3!b,.0).DO
.writes("*nOVERFLOW:")#0A..4floterr.:#3D.FALSE#0A..
4GOTO.derr#0A..2}#0A..2next11()#0A..2RETURN#0A..}#0A
derr:#0A..a.:#3D.list(3,.number,.0)#0A..error1("/",
.t,.b)#0A..errdbg()#0A}#0A#0AAND.plus().BE#0A{.LET.
t.#3D.a#0A..split2()#0A..IF.testnumbs2()#3Dnumber.D
O#0A..{.a.:#3D.list(3,.number,.h3!a+h3!b.)#0A..2nex
t11()#0A..2RETURN#0A..}#0A..IF.testnumbs2()#3Dreal.
DO#0A..{.a.:#3D.list(3,.real,.fadd(h3!a,.h3!b).)#0A
..2IF.floterr.DO#0A..2{.writes("*nOVERFLOW:")#0A..4
floterr.:#3D.FALSE#0A..4GOTO.fperr#0A..2}#0A..2next
11()#0A..2RETURN#0A..}#0A..a.:#3D.list(3,.number,.0
)#0Afperr:#0A..error1("+",.t,.b)#0A..errdbg()#0A}#0A
#0AAND.minus().BE#0A{.LET.t.#3D.a#0A..split2()#0A..
IF.testnumbs2()#3Dnumber.DO#0A..{.a.:#3D.list(3,.nu
mber,.h3!a-h3!b.)#0A..2next11()#0A..2RETURN#0A..}#0A
..IF.testnumbs2()#3Dreal.DO#0A..{.a.:#3D.list(3,.re
al,.fsub(h3!a,.h3!b).)#0A..2IF.floterr.DO#0A..2{.wr
ites("*nOVERFLOW:")#0A..4floterr.:#3D.FALSE#0A..4GO
TO.fmerr#0A..2}#0A..2next11()#0A..2RETURN#0A..}#0A.
.a.:#3D.list(3,.number,.0)#0Afmerr:#0A..error1("-",
.t,.b)#0A..errdbg()#0A}#0A#0AAND.power().BE#0A{.LET
.t.#3D.a#0A..split2()#0A..UNLESS.h2!b#3Dnumber.GOTO
.pwerr#0A..IF.h2!a#3Dnumber.DO#0A..{.LET.base,.exp,
.r.#3D.h3!a,.h3!b,.1#0A..2TEST.exp.<#3D.0#0A..2THEN
.{.IF.base#3D0.GOTO.pwerr#0A..9r.:#3D.ABS.base.#3D.
1.->.((-exp.&.1)#3D0.->.1,.base),.0#0A..7}#0A..2ELS
E.UNTIL.exp#3D0.DO#0A..7{.UNLESS.(exp.&.1)#3D0.DO.r
.:#3D.r.*.base#0A..9base.:#3D.base.*.base#0A..9exp.
:#3D.exp.>>.1#0A..7}#0A..2a.:#3D.list(3,.number,.r)
#0A..2next11()#0A..2RETURN#0A..}#0A..IF.h2!a#3Dreal
.DO#0A..{.a.:#3D.list(3,.real,.fpower(h3!a,.h3!b).)
#0A..2IF.floterr.DO#0A..2{.writes("*nOVERFLOW:")#0A
..4floterr.:#3D.FALSE#0A..4GOTO.pwerr#0A..2}#0A..2n
ext11()#0A..2RETURN#0A..}#0Apwerr:#0A..a.:#3D.list(
3,.number,.0)#0A..error1("**2",.t,.b)#0A..errdbg()#0A
}#0A#0AAND.pos().BE#0A{.split1()#0A..TEST.h2!a#3Dnu
mber.|.h2!a#3Dreal#0A..THEN.{.a.:#3D.list(3,.h2!a,.
h3!a.)#0A..7next11()#0A..5}#0A..ELSE.{.error1("+",.
a,.0)#0A..7a.:#3D.list(3,.number,.0)#0A..7errdbg()#0A
..5}#0A}#0A#0AAND.neg().BE#0A{.LET.t#3Da#0A..split1
()#0A..IF.h2!a#3Dnumber.DO#0A..{.a.:#3D.list(3,.num
ber,.-h3!a.)#0A..2next11()#0A..2RETURN#0A..}#0A..IF
.h2!a#3Dreal.DO#0A..{.a.:#3D.list(3,.real,.fumin(h3
!a))#0A..2next11()#0A..2RETURN#0A..}#0A..a.:#3D.lis
t(3,.number,.0)#0A..error1("-",.t,.0)#0A..errdbg()#0A
}#0A#0AAND.r_eq().BE#0A{.LET.t#3Da#0A..split2()#0A.
.a.:#3D.equal(a,.b).->.truerv,.falserv#0A..TEST.err
flag#0A..THEN.{.error1("EQ",.t,.b)#0A..7errflag.:#3D
.FALSE#0A..7errdbg()#0A..5}#0A..ELSE.next11()#0A}#0A
#0AAND.r_ne().BE#0A{.LET.t#3Da#0A..split2()#0A..a.:
#3D.equal(a,.b).->.falserv,.truerv#0A..TEST.errflag
#0A..THEN.{.error1("NE",.t,.b)#0A..7a.:#3D.falserv#0A
..7errflag.:#3D.FALSE#0A..7errdbg()#0A..5}#0A..ELSE
.next11()#0A}#0A#0AAND.r_ls().BE#0A{.split2()#0A..I
F.testnumbs2()#3Dnumber.DO#0A#09{#09a.:#3D.h3!a.<.h
3!b.->.truerv,.falserv#0A#09#09next11()#0A#09#09RET
URN.}#0A#09IF.testnumbs2()#3Dreal.DO#0A#09{#09a.:#3D
.fls(h3!a,.h3!b).->.truerv,.falserv#0A#09#09next11(
)#0A#09#09RETURN.}#0A#09error1("LS",.a,.b)#0A#09a.:
#3D.falserv#0A#09errdbg()#0A}#0A#0AAND.r_le().BE#0A
{#09split2()#0A#09IF.testnumbs2()#3Dnumber.DO#0A#09
{#09a.:#3D.h3!a.<#3D.h3!b.->.truerv,.falserv#0A#09#09
next11()#0A#09#09RETURN.}#0A#09IF.testnumbs2()#3Dre
al.DO#0A#09{#09a.:#3D.fle(h3!a,.h3!b).->.truerv,.fa
lserv#0A#09#09next11()#0A#09#09RETURN.}#0A#09error1
("LE",.a,.b)#0A#09a.:#3D.falserv#0A#09errdbg().}#0A
#0AAND.r_ge().BE#0A{#09split2()#0A#09IF.testnumbs2(
)#3Dnumber.DO#0A#09{#09a.:#3D.h3!a.>#3D.h3!b.->.tru
erv,.falserv#0A#09#09next11()#0A#09#09RETURN.}#0A#09
IF.testnumbs2()#3Dreal.DO#0A#09{#09a.:#3D.fge(h3!a,
.h3!b).->.truerv,.falserv#0A#09#09next11()#0A#09#09
RETURN.}#0A#09error1("GE",.a,.b)#0A#09a.:#3D.falser
v#0A#09errdbg().}#0A#0AAND.r_gr().BE#0A{#09split2()
#0A#09IF.testnumbs2()#3Dnumber.DO#0A#09{#09a.:#3D.h
3!a.>.h3!b.->.truerv,.falserv#0A#09#09next11()#0A#09
#09RETURN.}#0A#09IF.testnumbs2()#3Dreal.DO#0A#09{#09
a.:#3D.fgr(h3!a,.h3!b).->.truerv,.falserv#0A#09#09n
ext11()#0A#09#09RETURN.}#0A#09error1("GR",.a,.b)#0A
#09a.:#3D.falserv#0A#09errdbg().}#0A#0A//>>1.EJECT#0A
//.XPAL2C#0ALET.jump().BE.{#09c.:#3D.c!1.}#0A#0AAND
.jumpf().BE#0A{.split1()#0A..IF.h2!a.#3D.m_false.DO
#0A..{.c.:#3D.c!1#0A..2RETURN#0A..}#0A..IF.h2!a.#3D
.m_true.DO#0A..{.c.:#3D.c+2#0A..2RETURN#0A..}#0A..e
rror("NOT.A.TRUTHVALUE:.",.a,.0,.0)#0A..c.:#3D.c!1.
-.1#0A..edbg()#0A}#0A#0AAND.edbg().BE#0A{.restartc.
:#3D.c+1#0A..c.:#3D.@.restart#0A..a.:#3D.list(3,.lv
alue,.nilrv)#0A..comdbg()#0A}#0A#0AAND.errdbg().BE#0A
{.restartc.:#3D.c+1#0A..c.:#3D.@.rvrestart#0A..a.:#3D
.list(3,.lvalue,.a)#0A..comdbg()#0A}#0A#0AAND.errlv
dbg().BE#0A{.a.:#3D.list(3,.lvalue,.a)#0A..errokdbg
()#0A}#0A#0AAND.errokdbg().BE#0A{.restartc.:#3D.c+1
#0A..c.:#3D.@.okrestart#0A..comdbg()#0A}#0A#0AAND.c
omdbg().BE#0A{.h3!s.:#3D.stackp#0A..b.:#3D.node(8)#0A
..h1!b,.h2!b.:#3D.8,.stack#0A..h4!b,.h5!b.:#3D.rest
artc,.s#0A..h6!b,.h7!b.:#3D.e,.a#0A..s.:#3D.b#0A..b
.:#3D.h3!errorlv#0A..stackp.:#3D.7#0A..errct.:#3D.e
rrct.+.1#0A..IF.errct.>#3D.maxerr.DO.c.:#3D.@.nores
tart#0A..UNLESS.h2!b.#3D.closure.|.h2!b#3Dbasicfn.D
O#0A..{.UNLESS.errct.>#3D.maxerr.DO#0A..4writes("EX
ECUTION.RESUMED*n*n")#0A..2RETURN#0A..}#0A..TEST.h2
!b#3Dclosure#0A..THEN.{.s!stackp.:#3D.errorlv#0A..7
stackp.:#3D.stackp+1#0A..7a.:#3D.b#0A..7oldc,.c.:#3D
.c,.h4!b#0A..5}#0A..ELSE.{.c.:#3D.c-3#0A..7nil()#0A
..7formlvalue()#0A..7(h3!b)()#0A..5}#0A..restartc.:
#3D.0#0A}#0A#0AAND.okrestart().BE#0A{#09a.:#3D.s!(s
tackp-1)#0A#09restart()#0A#09s!stackp.:#3D.a#0A#09s
tackp.:#3D.stackp+1.}#0A#0AAND.rvrestart().BE#0A{.a
.:#3D.s!(stackp-1)#0A..restart()#0A..s!stackp.:#3D.
h3!a#0A..stackp.:#3D.stackp+1#0A}#0A#0AAND.norestar
t().BE#0A{.writes("*nMAXIMUM.NUMBER.OF.RUN-TIME.ERR
ORS.REACHED*n")#0A..terminate1()#0A}#0A#0AAND.apply
().BE#0A{.split1()#0A..a.:#3D.h3!a#0A..SWITCHON.h2!
a.INTO#0A..{.CASE.closure:#0A..4stackp.:#3D.stackp+
1#0A..4oldc,.c.:#3D.c+1,.h4!a#0A..4RETURN#0A#0A..2C
ASE.m_tuple:#0A..4stackp,.b.:#3D.stackp-1,.s!stackp
#0A..4b.:#3D.h3!b#0A..4UNLESS.h2!b#3Dnumber.DO#0A..
4{.error(0,.a,.".APPLIED.TO.",.b)#0A..6UNLESS.h3!a#3D
0.DO.a.:#3D.h4!a#0A..6errlvdbg()#0A..6RETURN#0A..4}
#0A..4{.LET.n.#3D.h3!b#0A..6TEST.1.<#3D.n.<#3D.h3!a
#0A..6THEN.{.a.:#3D.a!(n+2)#0A..13next11()#0A..11}#0A
..6ELSE.{.error(0,.a,.".APPLIED.TO.",.b)#0A..6UNLES
S.h3!a#3D0.TEST.n.>#3D.1#0A..6THEN.a.:#3D.a!(h3!a+2
)#0A..6ELSE.a.:#3D.h4!a#0A..6errlvdbg().}#0A..6RETU
RN#0A..4}#0A#0A..2CASE.basicfn:#0A..4(h3!a)()#0A..4
RETURN#0A#0A..2DEFAULT:#0A..4error("ATTEMPT.TO.APPL
Y.",a,".TO.",s!(stackp-1))#0A..4edbg()#0A..}#0A}#0A
#0AAND.save().BE#0A{.b.:#3D.node(c!1+6)#0A..h1!b,.h
2!b.:#3D.c!1+6,.stack#0A..h3!s.:#3D.stackp#0A..h4!b
,.h5!b.:#3D.oldc,.s#0A..h6!b,.h7!b.:#3D.e,.s!(stack
p-2)#0A..e.:#3D.h3!a#0A..stackp,.s.:#3D.7,.b#0A..c.
:#3D.c+2#0A}#0A#0AAND.r_return().BE#0A{.a.:#3D.s!(s
tackp-1)#0A..restart()#0A..stackp.:#3D.stackp-1#0A.
.s!(stackp-1).:#3D.a#0A}#0A#0AAND.testempty().BE#0A
{.split1()#0A..TEST.h3!a#3Dnilrv#0A..THEN.c.:#3D.c+
1#0A..ELSE.{.error1("FUNCTION.OF.NO.ARGUMENTS",.a,.
0)#0A..7edbg()#0A..5}#0A}#0A#0AAND.lose1().BE#0A{.s
plit1()#0A..c.:#3D.c+1#0A}#0A#0AAND.r_goto().BE#0A{
.split1()#0A..UNLESS.h2!a#3Dlabel.DO#0A..{.error("C
ANNOT.GO.TO.",.a,.0,.0)#0A..2a.:#3D.dummyrv#0A..2er
rdbg()#0A..2RETURN#0A..}#0A..c,.e.:#3D.h4!a,.h6!a#0A
..s.:#3D.node(h3!a)#0A..stackp.:#3D.6#0A..h1!s,.h2!
s.:#3D.h3!a,.stack#0A..a.:#3D.h5!a#0A..h4!s,.h5!s,.
h6!s.:#3D.h4!a,.h5!a,.h6!a#0A}#0A#0AAND.update().BE
#0A{.LET.n.#3D.c!1#0A..split2()#0A..TEST.n.#3D.1.TH
EN.h3!b.:#3D.a#0A..ELSE.{.UNLESS.h2!a.#3D.m_tuple.&
.h3!a.#3D.n.DO#0A..7{.error("CONFORMALITY.ERROR.IN.
ASSIGNMENT",0,0,0)#0A..9writes("THE.VALUE.OF.THE.RH
S.IS:.")#0A..9printa(a,.tupledepth)#0A..9newline()#0A
..9writes("THE.NUMBER.OF.VARIABLES.ON.THE.LHS.IS:."
)#0A..9writen(n)#0A..9wrch('*n')#0A..9c.:#3D.c.+.1#0A
..9a.:#3D.dummyrv#0A..9errdbg()#0A..9RETURN#0A..7}#0A
..7b.:#3D.h3!b#0A..7{.LET.v.#3D.VEC.100#0A..9FOR.i#3D
3.TO.n+2.DO.v!i.:#3D.h3!(a!i)#0A..9FOR.i#3D3.TO.n+2
.DO.h3!(b!i).:#3D.v!i#0A..7}#0A..5}#0A..a.:#3D.dumm
yrv#0A..c.:#3D.c+1#0A..next11()#0A}#0A#0A//>>1.EJEC
T#0A//.XPAL2D#0AMANIFEST.{#09lfield#3D#23o1773;.ndi
st#3D24.}#0A#0ALET.error(ms1,.db1,.ms2,.db2).BE#0A{
.writes("*n*nRUN.TIME.ERROR:.")#0A..UNLESS.ms1.#3D.
0.DO.writes(ms1)#0A..UNLESS.db1.#3D.0.DO.printa(db1
,.tupledepth)#0A..UNLESS.ms2.#3D.0.DO.writes(ms2)#0A
..UNLESS.db2.#3D.0.DO.printa(db2,.tupledepth)#0A..w
rch('*n')#0A}#0A#0AAND.error1(op,.arg1,.arg2).BE#0A
{.writes("*n*nRUN.TIME.ERROR:.")#0A..writes(op)#0A.
.writes(".APPLIED.TO.")#0A..printa(arg1,.tupledepth
)#0A..UNLESS.arg2#3D0.DO#0A..{.writes(".AND.")#0A..
2printa(arg2,.tupledepth)#0A..}#0A..wrch('*n')#0A}#0A
#0AAND.printb(x).BE#0A{.IF.x#3D0.RETURN#0A..SWITCHO
N.h2!x.INTO#0A..{.CASE.number:..1writen(h3!x)#0A..1
7RETURN#0A#0A..2CASE.real:..1{.LET.v.#3D.VEC.3#0A..
17ftos(h3!x,.v)#0A..17writes(v)#0A..17RETURN#0A..15
}#0A#0A..2CASE.string:..1wrch(h4!x)#0A..17printb(h3
!x)#0A..2CASE.nils:..3RETURN#0A#0A..2CASE.m_tuple:{
.LET.n.#3D.h3!x#0A..17IF.n.#3D.0.DO#0A..17{.writes(
"NIL")#0A..19RETURN#0A..17}#0A..17IF.@.x.>.stackwar
ning.DO#0A..17{.writes("(.ETC.)")#0A..19RETURN#0A..
17}#0A..17wrch('(')#0A..17FOR.i.#3D.3.TO.n+1.DO#0A.
.17{.printb(x!i)#0A..19writes(",.")#0A..17}#0A..17p
rintb(x!(n+2))#0A..17wrch(')')#0A..17RETURN#0A..15}
#0A#0A..2CASE.m_true:..1writes("TRUE");.RETURN#0A..
2CASE.m_false:..writes("FALSE");.RETURN#0A..2CASE.l
value:..1printb(h3!x);.RETURN#0A..2CASE.closure:#0A
..2CASE.basicfn:..writes("$FUNCTION$");.RETURN#0A..
2CASE.label:..2writes("$LABEL$");.RETURN#0A..2CASE.
jj:..5writes("$ENVIRONMENT$");.RETURN#0A..2CASE.m_d
ummy:..writes("$DUMMY$");.RETURN#0A..2DEFAULT:..5wr
ites("$$1")#0A..}#0A}#0A#0AAND.printa(x,.n).BE#0A{.
IF.x#3D0.RETURN#0A..IF.n.<#3D.0.DO.{.writes(".ETC."
);.RETURN.}#0A..SWITCHON.h2!x.INTO#0A..{.CASE.strin
g:#0A..2CASE.nils:#0A..4wrch('*'')#0A..4printb(x)#0A
..4wrch('*'')#0A..4RETURN#0A#0A..2CASE.m_tuple:#0A.
.2{.LET.m.#3D.h3!x#0A..4IF.m#3D0.DO.{.writes(".NIL.
");.RETURN.}#0A..4wrch('(')#0A..4FOR.i.#3D.3.TO.m+1
.DO#0A..4{.printa(x!i,.n-1)#0A..6wrch(',')#0A..4}#0A
..4printa(x!(m+2),.n-1)#0A..4wrch(')')#0A..4RETURN#0A
..2}#0A#0A..2CASE.lvalue:#0A..4printa(h3!x,.n)#0A..
4RETURN#0A#0A..2DEFAULT:#0A..4wrch('.')#0A..4printb
(x)#0A..4wrch('.')#0A..4RETURN#0A..}#0A}#0A#0AAND.e
qual(a,b).#3D.VALOF#0A{.LET.btag.#3D.h2!b#0A..SWITC
HON.btag.INTO#0A..{.CASE.m_true:#0A..2CASE.m_false:
#0A..2CASE.number:#0A..2CASE.real:#0A..2CASE.string
:#0A..2CASE.nils:#0A..4SWITCHON.h2!a.INTO#0A..4{.CA
SE.m_true:..1IF.btag#3Dm_true.RESULTIS.TRUE#0A..21R
ESULTIS.FALSE#0A..6CASE.m_false:..IF.btag#3Dm_false
.RESULTIS.TRUE#0A..21RESULTIS.FALSE#0A..6CASE.numbe
r:..1IF.btag#3Dnumber.&.h3!a#3Dh3!b.RESULTIS.TRUE#0A
..21RESULTIS.FALSE#0A..6CASE.real:..3IF.btag#3Dreal
.&.h3!a#3Dh3!b.RESULTIS.TRUE#0A..21RESULTIS.FALSE#0A
..6CASE.string:..1IF.btag#3Dstring.&.h4!a#3Dh4!b.RE
SULTIS.equal(h3!a,h3!b)#0A..21RESULTIS.FALSE#0A..6C
ASE.nils:..3IF.btag#3Dnils.RESULTIS.TRUE#0A..21RESU
LTIS.FALSE#0A..4}#0A..}#0A..errflag.:#3D.TRUE#0A..R
ESULTIS.FALSE#0A}#0A#0AAND.testnumbs2().#3D.h2!a#3D
number.&.h2!b#3Dnumber.->.number,#0A#09#09..1h2!a#3D
real.&.h2!b#3Dreal.->.real,#0A#09#09..1m_false#0A#0A
AND.testbools2().#3D.(.h2!a#3Dm_true.|.h2!a#3Dm_fal
se.).&#0A#09#09..1(.h2!b#3Dm_true.|.h2!b#3Dm_false.
)#0AAND.lvofname(n,.p).#3D.VALOF#0A{.h3!lookupno.:#3D
.h3!lookupno.+.1#0A..UNTIL.p.#3D.0.DO#0A..{.IF.h4!p
.#3D.n.RESULTIS.h5!(p)#0A..2p.:#3D.h3!p#0A..}#0A..U
NLESS.n#3Dnameres.DO#0A..2error("UNDECLARED.NAME.",
.0,.n,.0)#0A..RESULTIS.nilrv#0A}#0A#0AAND.nameoflv(
l,.p).#3D.VALOF#0A{.UNTIL.p#3D0.DO#0A..{.IF.h5!p#3D
l.RESULTIS.h4!p#0A..2p.:#3D.h3!p#0A..}#0A..RESULTIS
.0#0A}#0A#0AAND.restart().BE#0A{.c,.b,.e.:#3D.h4!s,
.h5!s,.h6!s#0A..s.:#3D.node(h1!b.&.lfield)#0A..stac
kp.:#3D.h3!b#0A..FOR.i.#3D.0.TO.stackp-1.DO.s!i.:#3D
.b!i#0A}#0A#0AAND.terminate().BE#0A{.listt.:#3D.lis
tt.+.6.//.CREATE.EXTRA.SPACE.FOR.FINAL.DIAGNOSE#0A.
.diagnose()#0A..terminate1()#0A}#0A#0AAND.terminate
1().BE#0A{.//control(output,.2)#0A..writen(h3!looku
pno)#0A..writes(".LOOKUPS.*t")#0A..writen(count)#0A
..writes(".CYCLES*n")#0A..gcmark.:#3D.gcmark.>>.16#0A
..writen(gcmark)#0A..writes(".GARBAGE.COLLECTIONS*n
")#0A..longjump(xpend,.xpendlevel)#0A}#0A#0AAND.las
tfn1(p).#3D.VALOF#0A{.LET.name,.arg.#3D.0,.0#0A..LE
T.y,.n.#3D.0,.0#0A..IF.h6!q#3D0.RESULTIS.FALSE#0A..
{.y.:#3D.h5!q#0A..2n.:#3D.h3!y#0A..2TEST.n>6#0A..2T
HEN.{.name.:#3D.y!(n-1)#0A..9UNLESS.name#3Dnilrv.DO
#0A..9{.name.:#3D.nameoflv(name,.h6!q)#0A..11IF.nam
e#3D0.DO.name.:#3D."ANONYMOUS"#0A..11arg.:#3D.y!(n-
2)#0A..9}#0A..7}#0A..2ELSE.name.:#3D.nilrv#0A..2q.:
#3D.y#0A..2IF.p#3D0.RESULTIS.TRUE#0A..2IF.h6!q#3D0.
RESULTIS.FALSE#0A..}.REPEATWHILE.name#3Dnilrv#0A..w
rites("AT.THIS.TIME,.THE.FUNCTION.BEING.EXECUTED.IS
:.")#0A..writes(name)#0A..writes("*nTHE.ARGUMENT.TO
.WHICH.IT.IS.BEING.APPLIED.IS:.")#0A..printa(arg,.t
upledepth)#0A..wrch('*n')#0A..RESULTIS.TRUE#0A}#0A#0A
AND.writenode(n).BE#0A{.writen(n.>>.ndist)#0A..wrch
('*t')#0A..writes(h4!a)#0A..wrch('*t')#0A..printa(h
5!a,.tupledepth)#0A..wrch('*n')#0A}#0A#0A//>>1.EJEC
T#0A//.XPAL2E#0AMANIFEST.{#0A.lfield#3D#23o1773;.mf
ield#3D#23o770006003;.gc1#3D#23o2003#0A}#0A#0ALET.n
ode(n).#3D.VALOF#0A{.IF.listp+n.>#3D.listl.DO.nexta
rea(n)#0A..listp.:#3D.listp+n#0A..RESULTIS.listp-n#0A
}#0A#0AAND.nextarea(n).BE#0A{.LET.b.#3D.FALSE#0A..I
F.gcdbg.DO.writes("*n*nNEXTAREA.RECLAIMATION.PHASE*
n")#0A..{.UNLESS.listp#3Dlistl.DO.h1!listp.:#3D.lis
tl.-.listp#0A..2IF.listl#3Dlistt.DO#0A..2{.IF.b.DO#0A
..4{.writes("*n*nRUN.TIME.SPACE.EXHAUSTED*n")#0A..6
terminate()#0A..4}#0A..4mark()#0A..4IF.gcdbg.DO.wri
tes("*nMARKLIST.PREFORMED*n")#0A..4listl,.b.:#3D.li
stv,.TRUE#0A..2}#0A..2h1!listt.:#3D.0#0A..2WHILE.(.
h1!listl.&.mfield.).#3D.gcmark.DO#0A..4listl.:#3D.l
istl.+.(.h1!listl.&.lfield.)#0A..2listp.:#3D.listl#0A
..2h1!listt.:#3D.gcmark#0A..2UNTIL.(.h1!listl.&.mfi
eld.).#3D.gcmark.DO#0A..4listl.:#3D.listl.+.(.h1!li
stl.&.lfield.)#0A..2IF.gcdbg.DO.{.writes("*s*s");.w
riten(listl-listp).}#0A..}.REPEATWHILE.listp+n.>#3D
.listl#0A..IF.gcdbg.DO.writes("*s*n")#0A..RETURN#0A
}#0A#0AAND.marklist(x).BE#0A{.l:#0A..IF.@.x.>.stack
warning.DO#0A..{.writes("*n*nMAXIMUM.NODE.DEPTH.EXC
EEDED*n")#0A..2terminate()#0A..}#0A..IF.x#3D0.RETUR
N#0A..IF.(.h1!x.&.mfield.).#3D.gcmark.RETURN#0A..h1
!x.:#3D.h1!x.&.lfield.|.gcmark#0A..SWITCHON.h2!x.IN
TO#0A..{.DEFAULT:#0A..4writes("*n*nMARKLIST.ERROR*n
")#0A..4writehex(x);.writes(".H1!x#3D");.writehex(h
1!x)#0A..4writes(".NODE.TYPE.IS.");.writen(h2!x)#0A
..4writes("*s*n")#0A..4RETURN#0A#0A..2CASE.m_tuple:
#0A..4FOR.i.#3D.1.TO.h3!x.DO.marklist(x!(i+2))#0A..
4RETURN#0A#0A..2CASE.env:#0A..4marklist(h5!x)#0A..4
x.:#3D.(h3!x)#0A..4GOTO.l#0A#0A..2CASE.stack:#0A..4
FOR.i.#3D.4.TO.h3!x-1.DO.marklist(x!i)#0A..4RETURN#0A
#0A..2CASE.jj:#0A..4marklist(h5!x)#0A..4x.:#3D.(h4!
x)#0A..4GOTO.l#0A#0A..2CASE.label:#0A..4marklist(h6
!x)#0A..4x.:#3D.(h5!x)#0A..4GOTO.l#0A#0A..2CASE.lva
lue:CASE.closure:CASE.string:#0A..4x.:#3D.(h3!x)#0A
..4GOTO.l#0A..2CASE.number:CASE.m_true:CASE.m_false
:CASE.m_nil:#0A..2CASE.nils:CASE.basicfn:CASE.guess
:#0A..2CASE.m_dummy:CASE.real:#0A..2RETURN#0A..}#0A
}#0A#0AAND.mark().BE#0A{.gcmark.:#3D.gcmark.+.gc1#0A
..nset.:#3D.FALSE#0A..IF.(.gcmark.&.mfield.).#3D.0.
DO#0A..{.writes("*n*nMAXIMUM.NUMBER.OF.")#0A..2writ
es("GARBAGE.COLLECTIONS.PERFORMED*n")#0A..2terminat
e()#0A..}#0A..marklist(e)#0A..h3!s.:#3D.stackp#0A..
marklist(s)#0A..marklist(a)#0A..marklist(b)#0A..RET
URN#0A}#0A#0AAND.list(n,.a,.b,.c,.d,.e,.f).#3D.VALO
F#0A{.f.:#3D.@.n#0A..{.LET.p.#3D.node(n)#0A..2SWITC
HON.n.INTO#0A..2{.CASE.7:.p!6.:#3D.f#0A..4CASE.6:.p
!5.:#3D.e#0A..4CASE.5:.p!4.:#3D.d#0A..4CASE.4:.p!3.
:#3D.c#0A..4CASE.3:.p!2.:#3D.b#0A..4CASE.2:.p!1.:#3D
.a#0A..4CASE.1:.p!0.:#3D.n#0A..2}#0A..2f.:#3D.0#0A.
.2RESULTIS.p#0A..}#0A}#0A#0A//>>1.EJECT#0A//.XPAL2F
#0AMANIFEST.{.lfield#3D#23o1773.}#0A#0ALET.split1()
.BE#0A{.stackp,.a.:#3D.stackp-1,.s!stackp#0A}#0A#0A
AND.split2().BE#0A{.stackp,.a,.b.:#3D.stackp-2,.s!(
stackp+1),.s!(stackp)#0A}#0A#0AAND.declname().BE#0A
{.e.:#3D.list(5,.env,.e,.c!1,.s!(stackp-1))#0A..sta
ckp.:#3D.stackp-1#0A..c.:#3D.c.+.2#0A}#0A#0AAND.dec
lnames().BE#0A{.LET.n.#3D.c!1#0A..split1();.a.:#3D.
h3!a#0A..UNLESS.h2!a#3Dm_tuple.&.h3!a#3Dn.DO#0A..{.
error("CONFORMALITY.ERROR.IN.DEFINITION",.0,.0,.0)#0A
..2nameerror(n,1)#0A..2RETURN#0A..}#0A..FOR.i.#3D.2
.TO.n+1.DO.r_name(i,1)#0A..c.:#3D.c+2+n#0A}#0A#0AAN
D.initname().BE#0A{.stackp.:#3D.stackp-1#0A..r_name
(1,7)#0A..c.:#3D.c+2#0A}#0A#0AAND.initnames().BE#0A
{.LET.n.#3D.c!1#0A..split1();.a.:#3D.h3!a#0A..UNLES
S.h2!a#3Dm_tuple.&.h3!a#3Dn.DO#0A..{.error("CONFORM
ALITY.ERROR.IN.RECURSIVE.DEFINITION",0,0,0)#0A..2na
meerror(n,4)#0A..2RETURN#0A..}#0A..FOR.i.#3D.2.TO.n
+1.DO.r_name(i,4)#0A..c.:#3D.c+2+n#0A}#0A#0AAND.r_n
ame(i,p).BE#0A{.TEST.p.<#3D.3#0A..THEN.e.:#3D.list(
5,.env,.e,.c!i,#0A..15p#3D1.->.a!(i+1),.list(3,.lva
lue,.(p#3D2.->.a,.nilrv)).)#0A..ELSE.{.b.:#3D.lvofn
ame(c!i,.e)#0A..7IF.b#3Dnilrv.DO.b.:#3D.list(3,.lva
lue,.b)#0A..7SWITCHON.p.INTO#0A..7{.CASE.4:.h3!b.:#3D
.h3!(a!(i+1));.RETURN#0A..9CASE.5:.h3!b.:#3D.a;.RET
URN#0A..9CASE.6:.h3!b.:#3D.nilrv;.RETURN#0A..9CASE.
7:.h3!b.:#3D.h3!(s!stackp);.RETURN#0A..7}#0A..5}#0A
}#0A#0AAND.nameerror(n,p).BE#0A{.writes("THE.NAMES.
BEING.DECLARED.ARE:*n")#0A..FOR.i.#3D.2.TO.n+1.DO#0A
..{.writes(c!i)#0A..2wrch('*n')#0A..}#0A..writes("T
HE.VALUE(S).PROVIDED.ARE:.")#0A..printa(a,.tupledep
th)#0A..newline()#0A..TEST.h2!a#3Dm_tuple#0A..THEN.
{.LET.m#3Dn#0A..7IF.m>h3!a.DO.m.:#3D.h3!a#0A..7FOR.
i.#3D.2.TO.m+1.DO.r_name(i,p)#0A..7FOR.i.#3D.m+2.TO
.n+1.DO.r_name(i,p+2)#0A..5}#0A..ELSE.{.r_name(2,p+
1)#0A..7FOR.i.#3D.3.TO.n+1.DO.r_name(i,p+2)#0A..5}#0A
..c.:#3D.c+n+1#0A..edbg()#0A}#0A#0AAND.decllabel().
BE#0A{.a.:#3D.list(6,.stack,.6,.h4!s,.h5!s,.h6!s)#0A
..a.:#3D.list(6,.label*.h1!s&lfield,.c!2,.a,.e)#0A.
.a.:#3D.list(3,.lvalue,.a)#0A..e.:#3D.list(5,.env,.
e,.c!1,.a)#0A..c.:#3D.c.+.3#0A}#0A#0AAND.setlabes()
.BE#0A{.a.:#3D.e#0A..FOR.i.#3D.1.TO.c!1.DO#0A..{.h6
!(h3!(h5!a)).:#3D.e#0A..2a.:#3D.h3!a#0A..}#0A..c.:#3D
.c.+.2#0A}#0A#0AAND.blocklink().BE#0A{.s!stackp.:#3D
.nilrv#0A..stackp.:#3D.stackp+1#0A..oldc.:#3D.c!1#0A
..a.:#3D.list(3,.lvalue,.e)#0A..c.:#3D.c+2#0A}#0A#0A
AND.reslink().BE#0A{.s!stackp.:#3D.list(3,.lvalue,.
nilrv)#0A..stackp.:#3D.stackp+1#0A..blocklink()#0A}
#0A#0AAND.setup().BE#0A{.oldc.:#3D.@.r_finish#0A..s
.:#3D.list(5,.stack,.4,.dummyrv,.0)#0A..a.:#3D.list
(3,.lvalue,.e)#0A..e.:#3D.0#0A..stackp.:#3D.5#0A..s
ave()#0A..split1()#0A}#0A#0A1//.XPAL3.LAST.MODIFIED
.ON.FRIDAY,.12.JUNE.1970#0A//.AT.5:37:38#2E68.BY.R.
MABEE#0A//>>1.FILENAME."XPAL3"#0A//#0A//#09**9#0A//
#09*..7*#0A//#09*..XPAL3..*#0A//#09*..7*#0A//#09**9
#0A//#0A//>>1.GET."XPALHD"#0A//>>1.EJECT#0A//.XPAL3
A#0ALET.r_finish().BE#0A{.writes("*n*nEXECUTION.FIN
ISHED*n")#0A..terminate1()#0A}#0A#0AAND.print().BE#0A
{.split1()#0A..printb(a)#0A..a.:#3D.dummyrv#0A..nex
tlv11()#0A}#0A#0AAND.userpage().BE#0A{.split1()#0A.
.//control(output,.-1)#0A..a.:#3D.dummyrv#0A..nextl
v11()#0A}#0A#0AAND.stem().BE#0A{.split1();.b.:#3D.h
3!a#0A..a.:#3D.nilsrv#0A..UNLESS.h2!b#3Dstring.DO#0A
..{.error1("STEM",.b,.0)#0A..2errlvdbg()#0A..2RETUR
N#0A..}#0A..a.:#3D.list(4,.string,.a,.h4!b.)#0A..ne
xtlv11()#0A}#0A#0AAND.stern().BE#0A{.split1();.a.:#3D
.h3!a#0A..UNLESS.h2!a#3Dstring.DO#0A..{.error1("STE
RN",.a,.0)#0A..2a.:#3D.nilsrv#0A..2errlvdbg()#0A..2
RETURN#0A..}#0A..a.:#3D.h3!a#0A..nextlv11()#0A}#0A#0A
AND.conc().BE#0A{.a.:#3D.h3!(s!(stackp-1))#0A..UNLE
SS.h2!a#3Dm_tuple.&.h3!a#3D2.DO#0Aconcerr:{.error1(
"CONC",.a,.0)#0A..8split1()#0A..8a.:#3D.nilsrv#0A..
8errlvdbg()#0A..8RETURN#0A..6}#0A..{.LET.x,.y.#3D.h
2!(h3!(h4!a)),.h2!(h3!(h5!a))#0A..2UNLESS.(.x#3Dstr
ing.|.x#3Dnils.).&#0A..9(.y#3Dstring.|.y#3Dnils.).G
OTO.concerr#0A..2{.LET.v.#3D.VEC.512#0A..4b,.x.:#3D
.h3!(h4!a),.1#0A..4UNTIL.h2!b.#3D.nils.DO#0A..4{.v!
x.:#3D.h4!b#0A..6b.:#3D.h3!b#0A..6x.:#3D.x+1#0A..4}
#0A..4IF.x#3D1.DO#0A..4{.b.:#3D.h3!(h5!a)#0A..6spli
t1()#0A..6a.:#3D.b#0A..6nextlv11()#0A..6RETURN#0A..
4}#0A..4b.:#3D.list(4,.string,.0,.v!q).//??1#0A..4a
.:#3D.b#0A..4FOR.i.#3D.2.TO.x-1.DO#0A..4{.h3!a.:#3D
.list(4,.string,.0,.v!i)#0A..6a.:#3D.h3!a#0A..4}#0A
..4h3!a.:#3D.h3!(h5!(h3!(s!(stackp-1))2#0A..4split1
()#0A..4a.:#3D.b#0A..4nextlv11()#0A..2}#0A..}#0A}#0A
#0AAND.atom().BE#0A{.split1()#0A..SWITCHON.h2!(h3!a
).INTO#0A..{.CASE.m_true:#0A..2CASE.m_false:#0A..2C
ASE.number:#0A..2CASE.real:#0A..2CASE.string:#0A..2
CASE.nils:#0A..4a.:#3D.truerv#0A..4nextlv11()#0A..4
RETURN#0A..}#0A..a.:#3D.falserv#0A..nextlv11()#0A}#0A
#0AAND.null().BE#0A{.split1()#0A..a.:#3D.h2!(h3!a)#3D
m_tuple.&.h3!(h3!a)#3D0.->.truerv,.falserv#0A..next
lv11()#0A}#0A#0AAND.length().BE#0A{.split1()#0A..UN
LESS.h2!(h3!a)#3Dm_tuple.DO#0A..{.error1("ORDER",.a
,.0)#0A..2a.:#3D.list(3,.number,.0)#0A..2errlvdbg()
#0A..2RETURN#0A..}#0A..a.:#3D.list(3,.number,.h3!(h
3!a).)#0A..nextlv11()#0A}#0A#0AAND.istruthvalue().B
E#0A{.split1()#0A..SWITCHON.h2!(h3!a).INTO#0A..{.CA
SE.m_true:#0A..2CASE.m_false:#0A..4a.:#3D.truerv#0A
..4nextlv11()#0A..4RETURN#0A..}#0A..a.:#3D.falserv#0A
..nextlv11()#0A}#0A#0AAND.isnumber().BE#0A{.split1(
)#0A..a.:#3D.h2!(h3!a)#3Dnumber.->.truerv,.falserv#0A
..nextlv11()#0A}#0A#0AAND.isstring().BE#0A{.split1(
)#0A..SWITCHON.h2!(h3!a).INTO#0A..{.CASE.string:#0A
..2CASE.nils:#0A..4a.:#3D.truerv#0A..4nextlv11()#0A
..4RETURN#0A..}#0A..a.:#3D.falserv#0A..nextlv11()#0A
}#0A#0AAND.isfunction().BE#0A{.split1()#0A..SWITCHO
N.h2!(h3!a).INTO#0A..{.CASE.closure:#0A..2CASE.basi
cfn:#0A..4a.:#3D.truerv#0A..4nextlv11()#09#092#0A..
4RETURN#0A..}#0A..a.:#3D.falserv#0A..nextlv11()#0A}
#0A#0AAND.isenvironment().BE#0A{.split1()#0A..a.:#3D
.h2!(h3!a)#3Djj.->.truerv,.falserv#0A..nextlv11()#0A
}#0A#0AAND.islabel().BE#0A{.split1()#0A..a.:#3D.h2!
(h3!a)#3Dlabel.->.truerv,.falserv#0A..nextlv11()#0A
}#0A#0AAND.istuple().BE#0A{.split1()#0A..a.:#3D.h2!
(h3!a)#3Dm_tuple.->.truerv,.falserv#0A..nextlv11()#0A
}#0A#0AAND.isreal().BE#0A{.split1()#0A..a.:#3D.h2!(
h3!a)#3Dreal.->.truerv,.falserv#0A..nextlv11()#0A}#0A
#0AAND.isdummy().BE#0A{.split1()#0A..a.:#3D.h2!(h3!
a)#3Dm_dummy.->.truerv,.falserv#0A..nextlv11()#0A}#0A
#0AAND.share().BE#0A{.split1()#0A..a.:#3D.h3!a#0A..
UNLESS.h2!a#3Dm_tuple.&.h3!a#3D2.DO#0A..{.error1("S
HARE",.a,.0)#0A..2a.:#3D.falserv#0A..2errlvdbg()#0A
..2RETURN#0A..}#0A..a.:#3D.h4!a#3Dh5!a.->.truerv,.f
alserv#0A..nextlv11()#0A}#0A#0A//>>1.EJECT#0A//.XPA
L3B#0AMANIFEST.{#0A..nfield#3D#23o677000006;.n1#3D#23
o1006#0A}#0A#0ALET.ston().BE#0A{.split1();.a.:#3D.h
3!a#0A..UNLESS.h2!a#3Dstring.DO#0A..{.error1("STOI"
,.a,.0)#0A..2a.:#3D.list(3,.number,.0)#0A..2errlvdb
g()#0A..2RETURN#0A..}#0A..{.LET.b.#3D.0#0A..2WHILE.
h2!a#3Dstring.DO#0A..2{.b.:#3D.b*10.+.h4!a.-.'0'#0A
..4a.:#3D.h3!a#0A..2}#0A..2a.:#3D.list(3,.number,.b
)#0A..2nextlv11()#0A..}#0A}#0A#0AAND.cton().BE#0A{.
split1()#0A..a.:#3D.h3!a#0A..UNLESS.h2!a#3Dstring.&
.h2!(h3!a)#3Dnils.DO#0A..{.error1("CTOI",.a,.0)#0A.
.2a.:#3D.list(3,.number,.0)#0A..2errlvdbg()#0A..2RE
TURN#0A..}#0A..a.:#3D.list(3,.number,.h4!a.)#0A..ne
xtlv11()#0A}#0A#0AAND.ntoc().BE#0A{.split1()#0A..a.
:#3D.h3!a#0A..UNLESS.h2!a#3Dnumber.&.h3!a.<.256.&.h
3!a.>#3D.0.DO#0A..{.error1("ITOC",.a,.0)#0A..2a.:#3D
.nilsrv#0A..2errlvdbg()#0A..2RETURN#0A..}#0A..a.:#3D
.list(4,.string,.nilsrv,.h3!a.)#0A..nextlv11()#0A}#0A
#0AAND.ntor().BE#0A{.split1();.a.:#3D.h3!a#0A..UNLE
SS.h2!a#3Dnumber.DO#0A..{.error1("ITOR",.a,.0)#0A..
2a.:#3D.list(3,.real,.0)#0A..2errlvdbg()#0A..2RETUR
N#0A..}#0A..a.:#3D.list(3,.real,.itor(h3!a).)#0A..n
extlv11()#0A}#0A#0AAND.rton().BE#0A{.split1();.a.:#3D
.h3!a#0A..UNLESS.h2!a#3Dreal.DO#0A..{.error1("RTOI"
,.a,.0)#0A..2a.:#3D.list(3,.number,.0)#0A..2errlvdb
g()#0A..2RETURN#0A..}#0A..a.:#3D.list(3,.number,.rt
oi(h3!a).)#0A..nextlv11()#0A}#0A#0AAND.rdchar().BE#0A
{.split1()#0A..a.:#3D.list(2,.nils)#0A..IF.linep>li
net.DO#0A..{.UNLESS.dataflag.GOTO.enddata#0A..2IF.c
h#3D'#23'.TEST.dataflag#0A..2THEN.{.dataflag.:#3D.F
ALSE#0A..9nextlv11().//.VALUE.OF.NILS.INDICATES.EOD
#0A..9RETURN#0A..7}#0A..2ELSE#0Aenddata:.{.writes("
*nEND.OF.DATA.FILE.ENCOUNTERED*n*n")#0A..9terminate
1().}#0A..9linet.:#3D.linev#0A..9linet!0.:#3D.ch#0A
..9UNTIL.ch#3D'*n'.DO#0A..9{.ch.:#3D.rdch()#0A..11l
inet.:#3D.linet.+.1#0A..11linet!0.:#3D.ch#0A..9}#0A
..2ch.:#3D.rdch()#0A..2linep.:#3D.linev.#0A..}#0A..
a.:#3D.list(4,.string,.a,.linep!0.)#0A..linep.:#3D.
linep.+.1#0A..nextlv11()#0A}#0A#0AAND.r_table().BE#0A
{.split1();.a.:#3D.h3!a#0A..UNLESS.h2!a.#3D.m_tuple
.&.h3!a.#3D.2.DO#0Atablerr:{.error1("TABLE",.a,.0)#0A
..8a.:#3D.nilrv#0A..8errlvdbg()#0A..8RETURN#0A..6}#0A
..{.LET.n.#3D.h3!(h4!a)#0A..2UNLESS.h2!n.#3D.number
.GOTO.tablerr#0A..2n.:#3D.h3!n#0A..2b.:#3D.h3!(h5!a
)#0A..2a.:#3D.node(n+3)#0A..2a!0,.a!1,.a!2.:#3D.n+3
,.m_tuple,.n#0A..2FOR.i.#3D.3.TO.n+2.DO.a!i.:#3D.li
st(3,.lvalue,.b)#0A..2nextlv11()#0A..}#0A}#0A#0AAND
.diagnose().BE#0A{.LET.n,.i.#3D.0,.1001#0A..a.:#3D.
s!(stackp-1)#0A..s!(stackp-1).:#3D.list(3,.lvalue,.
dummyrv).//.RETURN.VALUE#0A#09#093//REPLACES.ARGUME
NT.ON.STACK#0A..c.:#3D.c+1#0A..IF.h2!(h3!a)#3Dnumbe
r.DO.i.:#3D.h3!(h3!a)#0A..errorlv.:#3D.list(3,.lval
ue,.list(3,.basicfn,.lastfn).)#0A..IF.nset.DO#09//.
2.SUCCESSIVE.EXECUTIONS.OF.DIAGNOSE.REQUIRE#0A#09#09
1//.AN.INTERVENING.MARKING.PHASE#0A..{.mark()#0A..2
listl.:#3D.listv#0A..}.//.TAKE.ADVANTAGE.OF.THE.EXT
RA#0A..2//.MARKING.PHASE#0A..nset.:#3D.TRUE#0A..//c
ontrol(output,.-1)#0A..writes("THE.CURRENT.ENVIRONM
ENT.IS:*n*n")#0A..a.:#3D.e#0A..q.:#3D.s#0A..IF.h4!s
#3Drestartc.DO.//.TRUE.IFF.CALL.IS.FROM.COMDBG#0A..
2lastfn1(0).//.PEEL.OFF.TOP.STACK.NODE#0Al:writes("
*tVARIABLE*tRVALUE*n*n")#0A..WHILE.h4!a.~#3D.0.DO#0A
..{.LET.m.#3D.h1!a.&.nfield#0A..2TEST.m.~#3D.0#0A..
2THEN.{.writenode(m)#0A..9writes("ETC*n")#0A..9BREA
K#0A..7}#0A..2ELSE.{.n.:#3D.n+n1#0A..9h1!a.:#3D.h1!
a.|.n#0A..9writenode(n)#0A..9a.:#3D.h3!a#0A..7}#0A.
.}#0A..i.:#3D.i-1#0A..a.:#3D.h6!q#0A..//control(out
put,.3)#0A..UNLESS.lastfn1(1).DO#0Afini:{.//control
(output,.-1)#0A..5RETURN#0A..3}#0A..IF.i.<#3D.0.GOT
O.fini#0A..writes("*n*nTHE.ENVIRONMENT.IN.WHICH.")#0A
..writes("THE.ABOVE.APPLICATION.TAKES.PLACE.IS:*n*n
")#0A..GOTO.l#0A}#0A#0AAND.lastfn().BE#0A{.s!(stack
p-1).:#3D.list(3,.lvalue,.dummyrv).//.RETURN.VALUE#0A
..//.REPLACES.ARGUMENT.ON.STACK#0A..c.:#3D.c+1#0A..
//control(output,.2)#0A..q.:#3D.s#0A..IF.h4!s#3Dres
tartc.DO.//.TRUE.IFF.CALL.IS.FROM.COMDBG#0A..2lastf
n1(0).//.PEEL.OFF.TOP.STACK.NODE#0A..UNLESS.lastfn1
(1).DO#0A..2writes("ERROR.OCCURRED.IN.OUTER.LEVEL.O
F.PROGRAM*n")#0A..//control(output,.3)#0A}#0A#0AAND
.lookupine().BE#0A{.split1();.a.:#3D.h3!a#0A..UNLES
S.h2!a.#3D.m_tuple.&.h3!a.#3D.2.DO#0Alerr:{.error1(
"LOOKUPINE",.a,.0)#0A..5a.:#3D.nilrv#0A..5errlvdbg(
)#0A..5RETURN#0A..3}#0A..{.LET.x,.i,.l.#3D.h3!(h5!a
),.1,.namechain#0A..2LET.vp.#3D.VEC.10#0A..2LET.v.#3D
.VEC.40#0A..2b.:#3D.h3!(h4!a)#0A..2UNLESS.h2!b#3Dst
ring.&.h2!x#3Djj.GOTO.lerr#0A..2WHILE.h2!b#3Dstring
.DO#0A..2{.v!i.:#3D.h4!b#0A..4b.:#3D.h3!b#0A..4i.:#3D
.i+1#0A..2}#0A..2v!0.:#3D.i-1#0A..2packstring(v,.vp
)#0A..2i.:#3D.(.i-1.)/bytesperword.+.1#0A..2UNTIL.l
#3D0.DO#0A..2{.LET.v.#3D.l!1#0A..4IF.vp!0#3Dv!0.DO#0A
..4{.IF.i#3D1.BREAK#0A..6IF.vp!1#3Dv!1.DO#0A..6{.IF
.i#3D2.BREAK#0A..8IF.vp!2#3Dv!2.DO#0A..8{.IF.i#3D3.
BREAK#0A..10IF.vp!3#3Dv!3.DO#0A..10{.IF.i#3D4.BREAK
#0A..12IF.vp!4#3Dv!4.IF.i#3D5.BREAK#0A..10}#0A..8}#0A
..6}#0A..4}#0A..4l.:#3D.l!0#0A..2}#0A..2TEST.l#3D0#0A
..2THEN.i.:#3D.vp#0A..2ELSE.i.:#3D.l!1#0A..2a.:#3D.
lvofname(i,.h5!x)#0A..2TEST.a#3Dnilrv#0A..2THEN.err
lvdbg()#0A..2ELSE.next11()#0A..}#0A}#0A#0AAND.savee
nv().BE#0A{.split1()#0A..a.:#3D.list(5,.jj,.h4!s,.h
5!s,.h6!s)#0A..nextlv11()#0A}#0A#0A

######g/bcplfecg.h#
//.This.header.file.contains.the.interface.between.
the.standard#0A//.BCPL.compiler.front.end.and.its.c
odegenerators#2E#0A#0A/*#0A13/05/13#0AExtended.to.i
nclude.globals.used.by.bcpl64#0A#0A00005/01/11#0AEx
tended.to.include.manifests.and.globals.used.by.xbc
pl.and.procode#0A#0A*/#0A#0AMANIFEST.{#0A#0A//.Inte
rface.globals.are.betweeb.ug.and.feg-1#0Aintg#3Dug.
.3//.First.of.the.interface.globals,.ie.those#0A..1
0//.common.to.Lex,.Syn,.Trn.and.the.codegenerator#2E
#0Afeg#3Dintg+50.//.First.of.the.Lex/Syn.globals#0A
trng#3Dfeg+60.//.First.of.the.TRN.globals#0Acgg#3Dt
rng+60.//.CG.globals.are.cgg.and.above#0A#0A//..Sel
ectors#0Ah1#3D0;.h2;.h3;.h4;.h5;.h6;.h7#0A#0A//.BCP
L.lexical.tokens,.tree.and.ocode.operators#0A#0As_n
umber#3D1#0As_name;.s_string;.s_true;.s_false#0As_v
alof;.s_lv;.s_rv;.s_vecap;.s_fnap#0As_query#0As_neg
;.s_abs.//.Integer.operators#0As_mul;.s_div;.s_rem;
.s_add;.s_sub#0As_eq;.s_ne;.s_ls;.s_gr;.s_le;.s_ge#0A
s_slct;.s_of..17//.Inserted.11/7/01#0As_byteap;.s_m
thap#0As_not;.s_lshift;.s_rshift;.s_logand;.s_logor
#0As_eqv;.s_neqv;.s_cond;.s_comma;.s_table#0As_need
s;.s_section#0As_ass#0As_rtap;.s_goto;.s_resultis;.
s_colon#0As_test;.s_for;.s_if;.s_unless#0As_while;.
s_until;.s_repeat;.s_repeatwhile;.s_repeatuntil#0As
_skip.//.Added.22/6/05#0As_loop;.s_break;.s_return;
.s_finish#0As_endcase;.s_switchon;.s_case;.s_defaul
t#0As_seq;.s_let;.s_and;.s_manifest;.s_global;.s_st
atic#0As_valdef;.s_vecdef;.s_constdef;.s_const#0As_
fndef;.s_rtdef;.s_local;.s_label#0A#0A//.Othe.lexic
al.token#0As_be;.s_lsect;.s_rsect;.s_get#0As_semico
lon;.s_into;.s_to;.s_by;.s_do;.s_else#0As_vec;.s_lp
aren;.s_rparen;.s_sbra;.s_sket;.s_dot;.s_eof#0As_bi
tsperbcplword#0A#0A//.Used.in.the.code.generators#0A
s_none#0A#0A//.Ocode.operators#0As_lf;.s_lp;.s_lg;.
s_ln;.s_lstr;.s_ll;.s_llp;.s_llg;.s_ll1.#0As_sp;.s_
sg;.s_sl;.s_stind;.s_jump;.s_jt;.s_jf;.s_endfor#0As
_lab;.s_stack;.s_store;.s_rstack;.s_entry#0As_save;
.s_fnrn;.s_rtrn;.s_res;.s_datalab;.s_itemn#0As_endp
roc;.s_getbyte;.s_putbyte#0A#0A//.The.following.hav
e.been.added.for.the.extended.compiler.xbcpl#0A#0A/
/.Floating.point.operators.and.assignment.operators
,.added.15/07/10#0A#0As_fnum.//.Floating.point.cons
tants#0As_float;.s_fix;.s_fabs#0As_fmul;.s_fdiv;.s_
fadd;.s_fsub;..s_fpos;.s_fneg#0As_feq;.s_fne;.s_fls
;.s_fgr;.s_fle;.s_fge#0A#0A//.Assign.operators.--.a
dded.15/07/10#0As_assvecap#0As_assmul;.s_assdiv;.s_
assrem;.s_assadd;.s_ass1ub#0As_assfmul;.s_assfdiv;.
s_assfadd;.s_assfsub#0As_asslshift;.s_assrshift#0As
_asslogand;.s_asslogor;.s_asseqv;.s_assneqv#0A#0A1s
_selld;.s_selst.//.Added.19/07/10#0A#0As_fltop..//.
FLTOP.is.followed.by.one.of.the.fl_.codes#0A..7//.e
g.FLTOP.FADD.to.do.a.:#3D.b.#23+.a#0A..7//.or.FLTOP
.FLOAT.to.do.a.:#3D.FLOAT.a#0A#0Asf_none#3D0..3//.A
ssignment.operators#0Asf_vecap#0Asf_fmul#0Asf_fdiv#0A
sf_fadd#0Asf_fsub#0Asf_mul#0Asf_div#0Asf_rem#0Asf_a
dd#0Asf_sub#0Asf_lshift#0Asf_rshift#0Asf_logand#0As
f_logor#0Asf_eqv#0Asf_neqv#0A}#0A#0AGLOBAL.{#0A//.O
ption.variables,.and.fe-cg.interface.variables#0A#0A
nametable:intg;.nametablesize#0Afin_p;.fin_l;.plist
;.treep;.treevec#0A#0A//.xbcpl.functions#0A#0Aopnam
e..1//.For.lex.tokens,.tree.and.ocode.ops#0A..7//.U
sed.by.both.fe.and.cg#0Aflopname.//.For.ocode.ops.a
nd.Cintcode.ops#0Asfname..1//.For.ocode.assignment.
ops.used.in.SELST#0A#0A//.OCODE.buffer.variables#0A
obuf;.obufp;.obufq;.obuft;.obufsize#0Ardn;.wrn..#0A
#0Atrnerr#0Atranslate#0Asavespacesize#0Acodegenerat
e#0A#0Abigender..7//.Compiler.options#0Anaming#0Ade
bug#0Aeqcases#0Aprtree#0Abining#0Axrefing#0Agdefsin
g#0Ahard..11//.Abort.on.errors#0A#0Aobjline1..7//.e
ither."".or.of.form."#23!#2E#2E1"#0Aobjline1written
#0Aoptstring..6//.The.opt.argument#0Ac64..12//.#3DT
RUE.if.compiler.is.on.a.64-bit.system#0At64..12//.#3D
TRUE.if.generating.64-bit.Cintcode#0Awordbytelen..4
//.#3D4.or.8#0Aencoding..7//.Current.encoding.#3DRT
F8.or.GB2312#0Adefaultencoding..//.Default.encoding
,.set.by.command.args#2E#0A#0Aerrcount;.errmax#0Aso
urcestream;.sysprint;.ocodeout#0Agostream..7//.Stre
am.for.compiled.code#0Asourcenamev..4//.Fileno.to.s
tring.mapping#0A#0A}#0A#0A

######g/graphics.b#
/*#0D#0AGraphics.Library.for.BCPL#0D#0A#0D#0AThis.l
ibrary.allow.the.user.to.create.a.#2Ebmp.file.repre
senting.an#0D#0Aimage#2E#0D#0A#0D#0AImplemented.by.
Martin.Richards.(c).August.2012#0D#0A#0D#0AThe.head
er.file.is.g/graphics#2Eh#0D#0A#0D#0AThis.file.shou
ld.be.included.(by.GET).after.libhdr.has.been.inclu
ded#0D#0Aand.after.the.manifest.g_grfbase.has.been.
declared.if.the.default#0D#0Avalue.declared.in.libh
dr.is.not.suitable#2E.This.library.uses.region.of#0D
#0Athe.global.vector.from.g_grfbase.upwards#2E#0D#0A
#0D#0AFor.many.applications.using.the.SDL.or.GL.lib
raries.is.preferable#2E#0D#0A#0D#0A09/12/11#0D#0ASt
arted.inplementation#0D#0A*/#0D#0A#0D#0ALET.opengra
phics(xmax,.ymax).#3D.VALOF#0D#0A{.//.Allocate.the.
rectangular.pixel.array.and.colour.map#2E#0D#0A..//
.Return.TRUE.if.successful#0D#0A..xsize,.ysize.:#3D
.xmax,.ymax#0D#0A..canvas,.colourtab.:#3D.0,.0#0D#0A
#0D#0A..plotcolour.:#3D.col_black#0D#0A..plotx,.plo
ty.:#3D.0,.0#0D#0A..rowlen.:#3D.(ysize+3).&.-4.//.R
ound.up.to.a.multiple.of.4.bytes#0D#0A..canvassize.
:#3D.xsize.*.rowlen..9//.Number.of.bytes#0D#0A..can
vasupb.:#3D.canvassize/bytesperword..1//.UPB.in.wor
ds#0D#0A#0D#0A..canvas.:#3D.getvec(canvasupb)#0D#0A
..UNLESS.canvas.RESULTIS.FALSE#0D#0A..colourtab.:#3D
.initcolourtab()#0D#0A#0D#0A..FOR.i.#3D.0.TO.canvas
upb.DO.canvas!i.:#3D.0//randno(1004)#0D#0A#0D#0A..R
ESULTIS.TRUE#0D#0A}#0D#0A#0D#0AAND.closegraphics().
BE#0D#0A{.IF.canvas.DO.freevec(canvas)#0D#0A}#0D#0A
#0D#0AAND.wrgraph(filename).BE#0D#0A{.//.Output.#2E
pbm.format.file.to.filename.scale.to.15x25cms#2E#0D
#0A#0D#0A..LET.xres..#3D.muldiv(xsize,.100,.15)..//
.15.cms.horizontal.#0D#0A..LET.yres..#3D.xres//muld
iv(ysize,.100,.25)..//.25.cms.vertical#0D#0A..LET.h
drsize..3#3D.14#0D#0A..LET.infohdrsize.#3D.40#0D#0A
..LET.paletsize..1#3D.4*256#0D#0A..LET.dataoffset.#3D
.hdrsize.+.infohdrsize.+.paletsize#0D#0A..LET.strea
m.#3D.findoutput(filename)#0D#0A..LET.ostream.#3D.o
utput()#0D#0A#0D#0A..UNLESS.stream.DO#0D#0A..{.writ
ef("Trouble.with.file:.%s*n",.filename)#0D#0A..2RET
URN#0D#0A..}#0D#0A#0D#0A..selectoutput(stream)#0D#0A
#0D#0A..//.Write.the.header#0D#0A..wr1('B');.wr1('M
').//."BM"#0D#0A..//wr4(hdrsize.+.infohdrsize.+.pix
eldatasize).//.File.size.in.bytes#0D#0A..wr4(dataof
fset.+.canvassize).//.File.size.in.bytes#0D#0A..wr4
(0)..11//.Unused#0D#0A..wr4(dataoffset)..2//.File.o
ffset.of.pixel.data#0D#0A#0D#0A..//.Write.the.Info.
header#0D#0A..wr4(40)..11//.Size.of.info.header.#3D
.40#0D#0A..wr4(ysize)..8//.Bitmap.width#0D#0A..wr4(
xsize)..8//.Bitmap.height#0D#0A..wr2(1)..12//.Numbe
r.of.planes.#3D.1#0D#0A..wr2(8)..12//.8.bits.per.pi
xel#0D#0A..wr4(0)..12//.No.compression#0D#0A..//wr4
(pixeldatasize)..//.Size.of.image#0D#0A..wr4(0)..12
//.Size.of.image.#3D0.valid.if.no.compression#0D#0A
..wr4(yres)..9//.Horizontal.resolution.in.pixels.pe
r.meter#0D#0A..wr4(xres)..9//.Vertical..1resolution
.in.pixels.per.meter#0D#0A..wr4(256)..10//.Number.o
f.colours.actually.used#0D#0A..wr4(0)..12//.All.col
ours.are.important#0D#0A#0D#0A..//.Write.the.colour
.table#0D#0A..FOR.i.#3D.0.TO.255.DO.wr4(colourtab!i
)#0D#0A#0D#0A//sawritef("*nwrgraph:.writing.picture
.%nx%n*n",.xsize,.ysize)#0D#0A..FOR.x.#3D.0.TO.xsiz
e-1.DO#0D#0A..{.LET.xrow.#3D.x*rowlen.#0D#0A..2IF.x
.MOD.100.#3D.0.DO.sawritef("raster.line.%i4.of.%i4*
n",.x,.xsize-1)#0D#0A#0D#0A..2FOR.y.#3D.ysize-1.TO.
0.BY.-1.DO#0D#0A..2{.LET.a.#3D.canvas%(xrow.+.y)#0D
#0A..4wr1(a)#0D#0A..2}#0D#0A..2FOR.y.#3D.ysize+1.TO
.rowlen.DO.wr1(0).//.Pad.up.to.next.32-bit.boundary
#0D#0A..}#0D#0A#0D#0Afin:#0D#0A..IF.stream.DO.endst
ream(stream)#0D#0A..selectoutput(ostream)#0D#0A}#0D
#0A#0D#0AAND.initcolourtab().#3D.VALOF#0D#0A{.LET.c
olours.#3D.TABLE#0D#0A..//..2//..1n..2red..2green..
2blue#0D#0A..//..0070,..001255,..002255,..002255,..
//.White#0D#0A..//..00628,..001150,..002150,..00215
0,..//.Light.grey#0D#0A..//..00656,..0030,..002150,
..002150,..//.#0D#0A..//..00685,..0030,..0040,..002
190,..//.Blue#0D#0A..//..005110003,..001130,..0040,
..002130,..//#0D#0A..//..005142,..001150,..0040,..0
040,..//.Red#0D#0A..//..005170,..001140,..002140,..
0040,..//.#0D#0A..//..005199,..0030,..002180,..0040
,..//.Green#0D#0A..//..005220007,..001100,..002100,
..002100,..//.Dark.grey#0D#0A..//..005256,..0030,..
0040,..0040..1//.Black#0D#0A#0D#0A..4//..1n..6red..
2green..2blue#0D#0A..0110,..003255,..002255,..00225
5,..//.White#0D#0A..8col_rb,..001255,..0040,..00225
5,..//.red-blue#0D#0A..8col_b,..0040,..0040,..00225
5,..//.blue#0D#0A..8col_gb,..0030,..002255,..002255
,..//.blue-green#0D#0A..8col_g,..0040,..002255,..00
40,..//.green#0D#0A..8col_rg,..001255,..002255,..00
40,..//.green-red#0D#0A..8col_r,..002255,..0040,..0
040,..//.red.#0D#0A..008255,..0060,..0040,..0040..1
//.black#0D#0A..LET.t.#3D.colours#0D#0A..LET.ctab.#3D
.getvec(255)#0D#0A..UNLESS.ctab.RESULTIS.0#0D#0A#0D
#0A..WHILE.!t<255.DO#0D#0A..{.LET.p,.r1,.g1,.b1.#3D
.t!0,.t!1,.t!2,.t!3#0D#0A..2LET.q,.r2,.g2,.b2.#3D.t
!4,.t!5,.t!6,.t!7#0D#0A//sawritef("p#3D%i3..q#3D%i3
..%i3.%i3.%i3..%i3.%i3.%i3*n",#0D#0A//..10p,.q,.r1,
.g1,.b1,.r2,.g2,.b2)#0D#0A..2FOR.i.#3D.p.TO.q.DO#0D
#0A..2{.LET.r.#3D.(r1*(q-i)+r2*(i-p))/(q-p)#0D#0A..
4LET.g.#3D.(g1*(q-i)+g2*(i-p))/(q-p)#0D#0A..4LET.b.
#3D.(b1*(q-i)+b2*(i-p))/(q-p)#0D#0A..4ctab!i.:#3D.r
<<00016.|.g<<0008.|.b#0D#0A..4//sawritef("%i3:.%x6*
n",.i,.ctab!i)#0D#0A..2}#0D#0A..2//sawritef("*n")#0D
#0A..2//abort(1001)#0D#0A..2t.:#3D.t+4#0D#0A..}#0D#0A
..//sawritef("*nColour.table*n")#0D#0A..//FOR.i.#3D
.0.TO.255.DO#0D#0A..//{.IF.i.MOD.8.#3D.0.DO.sawrch(
'*n')#0D#0A..//..sawritef(".%x6",.ctab!i)#0D#0A..//
}#0D#0A..//sawrch('*n')#0D#0A..RESULTIS.ctab..2#0D#0A
}#0D#0A#0D#0A#0D#0AAND.wr1(b).BE#0D#0A{.binwrch(b)#0D
#0A}#0D#0A#0D#0AAND.wr2(w).BE#0D#0A{.LET.s.#3D.@w#0D
#0A..binwrch(s%0)#0D#0A..binwrch(s%1)#0D#0A}#0D#0A#0D
#0AAND.wr4(w).BE#0D#0A{.LET.s.#3D.@w#0D#0A..binwrch
(s%0)#0D#0A..binwrch(s%1)#0D#0A..binwrch(s%2)#0D#0A
..binwrch(s%3)#0D#0A}#0D#0A#0D#0AAND.wrpixel(x,.y,.
col).BE.IF.0<#3Dx<xsize.&.0<#3Dy<ysize.DO#0D#0A{.//
.Plot.a.point#0D#0A..LET.p.#3D.x*rowlen.+.y#0D#0A//
sawritef("wrpixel:.x#3D%i4..y#3D%i4..col#3D%i3*n",.
x,.y,.col)#0D#0A..canvas%p.:#3D.col#0D#0A}#0D#0A#0D
#0AAND.wrpixel33(x,.y,.col).BE#0D#0A{.//.Plot.a.3x3
.point#0D#0A..FOR.i.#3D.-1.TO.1.FOR.j.#3D.-1.TO.1.D
O.wrpixel(x+i,.y+j,.col)#0D#0A}#0D#0A#0D#0AAND.plot
ch(ch).BE.TEST.ch#3D'*n'#0D#0ATHEN.{.plotx,.ploty.:
#3D.10,.ploty-14#0D#0A..3}#0D#0AELSE.{.LET.x,.y.#3D
.plotx+1,.ploty#0D#0A..5FOR.line.#3D.0.TO.11.DO#0D#0A
..7write_ch_slice(plotx,.ploty+11-line,.ch,.line)#0D
#0A..5plotx.:#3D.plotx+9#0D#0A..3}#0D#0A#0D#0A#0D#0A
AND.write_ch_slice(x,.y,.ch,.line).BE#0D#0A{#0D#0A.
.//.Writes.the.horizontal.slice.of.the.given.charac
ter#2E#0D#0A#0D#0A..LET.i.#3D.(ch&#23x7F).-.'*s'#0D
#0A..LET.charbase.#3D.TABLE.//.Needs.correction.!!1
#0D#0A..7#23X006,.#23X006,.#23X006,.//.space#0D#0A.
.7#23X18181818,.#23X18180000018,.#23X18004,.//.!#0D
#0A..7#23X6600400,.#23X006,.#23X006,.//."#0D#0A..7#23
X662FF2,.#23X66FF00266,.#23X66000004,.//.#23#0D#0A.
.7#23X7EFFD8FE,.#23X7F1B1BFF,.#23X7E004,.//.$#0D#0A
..7#23X0662C0C,.#23X18303661,.#23X6005,.//.%#0D#0A.
.7#23X3078C8C8,.#23X7276DCC1,.#23X76004,.//.&#0D#0A
..7#23X18181800,.#23X006,.#23X006,.//.'#0D#0A..7#23
X18306060,.#23X60606030,.#23X18004,.//.(#0D#0A..7#23
X180C0606,.#23X0606060C,.#23X18004,.//.)#0D#0A..7#23
X000029254,.#23X38FE3854,.#23X92004,.//.*#0D#0A..7#23
X0000418,.#23X187E7E18,.#23X18004,.//.+#0D#0A..7#23
X006,.#23X000021818,.#23X081003,.//.,#0D#0A..7#23X0
06,.#23X000007E7E00,.#23X006,.//.-#0D#0A..7#23X006,
.#23X0000418,.#23X18004,.//.#2E#0D#0A..7#23X06060C0
C,.#23X18183030,.#23X606003,.//./#0D#0A..7#23X386CC
0006C6,.#23XC6C6C66C,.#23X38004,.//.0#0D#0A..7#23X1
8387818,.#23X18181818,.#23X18004,.//.1#0D#0A..7#23X
3C7E6206,.#23X0C18307E,.#23X7E004,.//.2#0D#0A..7#23
X3C6E4606,.#23X1C06466E,.#23X3C004,.//.3#0D#0A..7#23
X1C3C3C6C,.#23XCCFF0020C,.#23X0C004,.//.4#0D#0A..7#23
X7E7E6060,.#23X7C0E466E,.#23X3C004,.//.5#0D#0A..7#23
X3C7E6060,.#23X7C660027E,.#23X3C004,.//.6#0D#0A..7#23
X7E7E0606,.#23X0C183060,.#23X4005,.//.7#0D#0A..7#23
X3C664,.#23X3C664,.#23X3C004,.//.8#0D#0A..7#23X3C66
4,.#23X3E060661,.#23X3C004,.//.9#0D#0A..7#23X000021
818,.#23X000021818,.#23X006,.//.:#0D#0A..7#23X00002
1818,.#23X000021818,.#23X081003,.//.;#0D#0A..7#23X0
000160C18,.#23X30603018,.#23X0C06002,.//.<#0D#0A..7
#23X006,.#23X7C000007C00,.#23X006,.//.#3D#0D#0A..7#23
X00000603018,.#23X0C060C18,.#23X306003,.//.>#0D#0A.
.7#23X3C7E0606,.#23X0C181800,.#23X1818002,.//.?#0D#0A
..7#23X7E819DA5,.#23XA5A59F80,.#23X7F004,.//.@#0D#0A
..7#23X3C7EC3C3,.#23XFF2C3C3,.#23XC3004,.//.A#0D#0A
..7#23XFEFFC3FE,.#23XFEC3C3FF,.#23XFE004,.//.B#0D#0A
..7#23X3E7FC3C0,.#23XC0C0C37F,.#23X3E004,.//.C#0D#0A
..7#23XFCFEC3C3,.#23XC3C3C3FE,.#23XFC004,.//.D#0D#0A
..7#23XFF2C0FC,.#23XFCC0000C0FF,.#23XFF000004,.//.E
#0D#0A..7#23XFF2C0FC,.#23XFCC0000C0C0,.#23XC005,.//
.F#0D#0A..7#23X3E7FE1C0,.#23XCFCFE3FF,.#23X7E004,./
/.G#0D#0A..7#23XC3C3C3FF,.#23XFFC3C3C3,.#23XC3004,.
//.H#0D#0A..7#23X18181818,.#23X18181818,.#23X18004,
.//.I#0D#0A..7#23X7F7F0C0C,.#23X0C0CC1FC,.#23X78004
,.//.J#0D#0A..7#23XC2C6CCD8,.#23XF0F8CC0016,.#23XC2
004,.//.K#0D#0A..7#23XC0C0C0C0,.#23XC0C0C0FE,.#23XF
E004,.//.L#0D#0A..7#23X81C3E7FF,.#23XDBC3C3C3,.#23X
C3004,.//.M#0D#0A..7#23X83C3E3F3,.#23XDBCFC7C3,.#23
XC1004,.//.N#0D#0A..7#23X7EFFC3C3,.#23XC3C3C3FF,.#23
X7E004,.//.O#0D#0A..7#23XFEFFC3C3,.#23XFF1EC0C0,.#23
XC005,.//.P#0D#0A..7#23X7EFFC3C3,.#23XDBCFC7FE,.#23
X7D004,.//.Q#0D#0A..7#23XFEFFC3C3,.#23XFF1ECC0016,.
#23XC3004,.//.R#0D#0A..7#23X7EC3C0C0,.#23X7E0303C3,
.#23X7E004,.//.S#0D#0A..7#23XFF0021818,.#23X1818181
8,.#23X18004,.//.T#0D#0A..7#23XC3C3C3C3,.#23XC3C3C3
7E,.#23X3C004,.//.U#0D#0A..7#23X81C3C366,.#23X66000
3C3C18,.#23X18004,.//.V#0D#0A..7#23XC3C3C3C3,.#23XD
BFFE7C3,.#23X81004,.//.W#0D#0A..7#23XC3C3660003C,.#23
X183C66C3,.#23XC3004,.//.X#0D#0A..7#23XC3C3662,.#23
X3C3C1818,.#23X18004,.//.Y#0D#0A..7#23XFF002060C,.#23
X183060FF,.#23XFF000004,.//.Z#0D#0A..7#23X78786060,
.#23X60606060,.#23X7878002,.//.[#0D#0A..7#23X606030
30,.#23X18180C0C,.#23X0606002,.//.\#0D#0A..7#23X1E1
E0606,.#23X06060606,.#23X1E1E002,.//.]#0D#0A..7#23X
10284400000,.#23X006,.#23X006,.//.^#0D#0A..7#23X006
,.#23X006,.#23X00FF00200,.//._#0D#0A..7#23X30180C00
,.#23X006,.#23X006,.//.`#0D#0A..7#23X000027AFE,.#23
XC6C6C6FE,.#23X7B004,.//.a#0D#0A..7#23XC0C0DCFE,.#23
XC6C6C6FE,.#23XDC004,.//.b#0D#0A..7#23X000027CFE,.#23
XC6C0C6FE,.#23X7C004,.//.c#0D#0A..7#23X060676FE,.#23
XC6C6C6FE,.#23X76004,.//.d#0D#0A..7#23X000027CFE,.#23
XC6FCC0000FE,.#23X7C004,.//.e#0D#0A..7#23X0000278FC
,.#23XC0F0F0C0,.#23XC005,.//.f#0D#0A..7#23X0000276F
E,.#23XC6C6C6FE,.#23X7606FE7C,.//.g#0D#0A..7#23XC0C
0DCFE,.#23XC6C6C6C6,.#23XC6004,.//.h#0D#0A..7#23X18
180000018,.#23X18181818,.#23X18004,.//.i#0D#0A..7#23
X0C0C001C,.#23X0C0C0C7C,.#23X38004,.//.j#0D#0A..7#23
X00C0C6CC,.#23XD8F0F8CC,.#23XC6004,.//.k#0D#0A..7#23
X00000606060,.#23X6060607C,.#23X38004,.//.l#0D#0A..
7#23X000026CFE,.#23XD6D6D6D6,.#23XD6004,.//.m#0D#0A
..7#23X002DCFE,.#23XC6C6C6C6,.#23XC6004,.//.n#0D#0A
..7#23X000027CFE,.#23XC6C6C6FE,.#23X7C004,.//.o#0D#0A
..7#23X000027CFE,.#23XC6FEFCC0000,.#23XC005,.//.p#0D
#0A..7#23X000027CFE,.#23XC6FE7E06,.#23X06004,.//.q#0D
#0A..7#23X002DCFE,.#23XC6C0C0C0,.#23XC005,.//.r#0D#0A
..7#23X000027CFE,.#23XC07C06FE,.#23X7C004,.//.s#0D#0A
..7#23X0000060F8F8,.#23X6060607C,.#23X38004,.//.t#0D
#0A..7#23X002C6C6,.#23XC6C6C6FE,.#23X7C004,.//.u#0D
#0A..7#23X002C6C6,.#23X6C6C6C38,.#23X1005,.//.v#0D#0A
..7#23X002D6D6,.#23XD6D6D6FE,.#23X6C004,.//.w#0D#0A
..7#23X002C6C6,.#23X6C386CC0006,.#23XC6004,.//.x#0D
#0A..7#23X002C6C6,.#23XC6C6C67E,.#23X7606FE7C,.//.y
#0D#0A..7#23X000027EFE,.#23X0C3860FE,.#23XFC004,.//
.z#0D#0A..7#23X0C181808,.#23X18301808,.#23X18180C00
,.//.{#0D#0A..7#23X18181818,.#23X18181818,.#23X1818
1800,.//.|#0D#0A..7#23X30181810,.#23X180C1810,.#23X
18183001,.//.}#0D#0A..7#23X0000470,.#23XD1990008B0E
,.#23X006,.//.~#0D#0A..7#23XAA00055AA00055,.#23XAA0
0055AA00055,.#23XAA00055AA00055..//.rubout#0D#0A#0D
#0A..IF.i>#3D0.DO.charbase.:#3D.charbase.+.3*i#0D#0A
#0D#0A..{.LET.col.#3D.plotcolour#0D#0A..2LET.w.#3D.
VALOF.SWITCHON.line.INTO#0D#0A..2{.CASE..0000:.RESU
LTIS.charbase!0>>00024#0D#0A..4CASE..0001:.RESULTIS
.charbase!0>>00016#0D#0A..4CASE..0002:.RESULTIS.cha
rbase!0>>.8#0D#0A..4CASE..0003:.RESULTIS.charbase!0
#0D#0A..4CASE..0004:.RESULTIS.charbase!1>>00024#0D#0A
..4CASE..0005:.RESULTIS.charbase!1>>00016#0D#0A..4C
ASE..0006:.RESULTIS.charbase!1>>.8#0D#0A..4CASE..00
07:.RESULTIS.charbase!1#0D#0A..4CASE..0008:.RESULTI
S.charbase!2>>00024#0D#0A..4CASE..0009:.RESULTIS.ch
arbase!2>>00016#0D#0A..4CASE.10:.RESULTIS.charbase!
2>>.8#0D#0A..4CASE.11:.RESULTIS.charbase!2#0D#0A..2
}#0D#0A..2TEST.((w.>>.7).&.1).#3D.1#0D#0A..2THEN.wr
pixel(x,.y,.col)#0D#0A..2ELSE.wrpixel(x,.y,.0)#0D#0A
#0D#0A..2TEST.((w.>>.6).&.1).#3D.1#0D#0A..2THEN.wrp
ixel(x+1,.y,.col)#0D#0A..2ELSE.wrpixel(x+1,.y,.0)#0D
#0A#0D#0A..2TEST.((w.>>.5).&.1).#3D.1#0D#0A..2THEN.
wrpixel(x+2,.y,.col)#0D#0A..2ELSE.wrpixel(x+2,.y,.0
)#0D#0A#0D#0A..2TEST.((w.>>.4).&.1).#3D.1#0D#0A..2T
HEN.wrpixel(x+3,.y,.col)#0D#0A..2ELSE.wrpixel(x+3,.
y,.0)#0D#0A#0D#0A..2TEST.((w.>>.3).&.1).#3D.1#0D#0A
..2THEN.wrpixel(x+4,.y,.col)#0D#0A..2ELSE.wrpixel(x
+4,.y,.0)#0D#0A#0D#0A..2TEST.((w.>>.2).&.1).#3D.1#0D
#0A..2THEN.wrpixel(x+5,.y,.col)#0D#0A..2ELSE.wrpixe
l(x+5,.y,.0)#0D#0A#0D#0A..2TEST.((w.>>.1).&.1).#3D.
1#0D#0A..2THEN.wrpixel(x+6,.y,.col)#0D#0A..2ELSE.wr
pixel(x+6,.y,.0)#0D#0A#0D#0A..2TEST.(w.&.1).#3D.1#0D
#0A..2THEN.wrpixel(x+7,.y,.col)#0D#0A..2ELSE.wrpixe
l(x+7,.y,.0)#0D#0A#0D#0A..2wrpixel(x+8,.y,.0)#0D#0A
..}#0D#0A}#0D#0A#0D#0AAND.plotstr(s).BE.FOR.i.#3D.1
.TO.s%0.DO.plotch(s%i)#0D#0A#0D#0AAND.moveto(x,.y).
BE#0D#0A{.plotx,.ploty.:#3D.x,.y#0D#0A}#0D#0A#0D#0A
AND.moveby(dx,.dy).BE#0D#0A{.plotx,.ploty.:#3D.plot
x+dx,.ploty+dy#0D#0A}#0D#0A#0D#0AAND.drawto(x,.y).B
E#0D#0A{.//.This.is.Bresenham's.algorithm#0D#0A..LE
T.dx.#3D.ABS(x-plotx)#0D#0A..AND.dy.#3D.ABS(y-ploty
)#0D#0A..LET.sx.#3D.plotx<x.->.1,.-1#0D#0A..LET.sy.
#3D.ploty<y.->.1,.-1#0D#0A..LET.err.#3D.dx-dy#0D#0A
..LET.e2.#3D.?#0D#0A#0D#0A..{.wrpixel(plotx,.ploty,
.plotcolour)#0D#0A..2IF.plotx#3Dx.&.ploty#3Dy.RETUR
N#0D#0A..2e2.:#3D.2*err#0D#0A..2IF.e2.>.-dy.DO#0D#0A
..2{.err.:#3D.err.-.dy#0D#0A..4plotx.:#3D.plotx+sx#0D
#0A..2}#0D#0A..2IF.e2.<.dx.DO#0D#0A..2{.err.:#3D.er
r.+.dx#0D#0A..4ploty.:#3D.ploty.+.sy#0D#0A..2}#0D#0A
..}.REPEAT#0D#0A}#0D#0A#0D#0AAND.drawby(dx,.dy).BE.
drawto(plotx+dx,.ploty+dy)#0D#0A#0D#0AAND.drawrect(
x0,.y0,.x1,.y1).BE#0D#0A{.LET.xmin,.xmax.#3D.x0,.x1
#0D#0A..LET.ymin,.ymax.#3D.y0,.y1#0D#0A..IF.xmin>xm
ax.DO.xmin,.xmax.:#3D.x1,.x0#0D#0A..IF.ymin>ymax.DO
.ymin,.ymax.:#3D.y1,.y0#0D#0A//sawritef("drawrect:.
%i4.%i4.%i4.%i4*n",xmin,ymin,xmax,ymax)#0D#0A..FOR.
x.#3D.xmin.TO.xmax.DO#0D#0A..{.wrpixel(x,.ymin,.plo
tcolour)#0D#0A..2wrpixel(x,.ymax,.plotcolour)#0D#0A
..}#0D#0A..FOR.y.#3D.ymin+1.TO.ymax-1.DO#0D#0A..{.w
rpixel(xmin,.y,.plotcolour)#0D#0A..2wrpixel(xmax,.y
,.plotcolour)#0D#0A..}#0D#0A..plotx,.ploty.:#3D.x0,
.y0#0D#0A}#0D#0A#0D#0AAND.fillrect(x0,.y0,.x1,.y1).
BE#0D#0A{.LET.xmin,.xmax.#3D.x0,.x1#0D#0A..LET.ymin
,.ymax.#3D.y0,.y1#0D#0A..IF.xmin>xmax.DO.xmin,.xmax
.:#3D.x1,.x0#0D#0A..IF.ymin>ymax.DO.ymin,.ymax.:#3D
.y1,.y0#0D#0A//sawritef("fillrect:.%i4.%i4.%i4.%i4*
n",xmin,ymin,xmax,ymax)#0D#0A..FOR.x.#3D.xmin.TO.xm
ax.FOR.y.#3D.ymin.TO.ymax.DO#0D#0A..{.wrpixel(x,.y,
.plotcolour)#0D#0A..2//sawritef("fillrect:.x#3D%i4.
.y#3D%i4*n",.x,.y)#0D#0A..}#0D#0A..plotx,.ploty.:#3D
.x0,.y0#0D#0A}#0D#0A#0D#0AAND.drawrndrect(x0,y0,x1,
y1,radius).BE#0D#0A{.LET.xmin,.xmax.#3D.x0,.x1#0D#0A
..LET.ymin,.ymax.#3D.y0,.y1#0D#0A..LET.r.#3D.radius
#0D#0A..LET.f,.ddf_x,.ddf_y,.x,.y.#3D.?,.?,.?,.?,.?
#0D#0A#0D#0A..IF.xmin>xmax.DO.xmin,.xmax.:#3D.x1,.x
0#0D#0A..IF.ymin>ymax.DO.ymin,.ymax.:#3D.y1,.y0#0D#0A
..IF.r<0.DO.r.:#3D.0#0D#0A..IF.r+r>xmax-xmin.DO.r.:
#3D.(xmax-xmin)/2#0D#0A..IF.r+r>ymax-ymin.DO.r.:#3D
.(ymax-ymin)/2#0D#0A#0D#0A//sawritef("drawrndrect:.
%i4.%i4.%i4.%i4.%i4*n",xmin,ymin,xmax,ymax,radius)#0D
#0A..FOR.x.#3D.xmin+r.TO.xmax-r.DO#0D#0A..{.wrpixel
(x,.ymin,.plotcolour)#0D#0A..2wrpixel(x,.ymax,.plot
colour)#0D#0A..}#0D#0A..FOR.y.#3D.ymin+r+1.TO.ymax-
r-1.DO#0D#0A..{.wrpixel(xmin,.y,.plotcolour)#0D#0A.
.2wrpixel(xmax,.y,.plotcolour)#0D#0A..}#0D#0A..//.N
ow.draw.the.rounded.corners#0D#0A..//.This.is.commo
nly.called.Bresenham's.circle.algorithm.since.it#0D
#0A..//.is.derived.from.Bresenham's.line.algorithm#2E
#0D#0A..f.:#3D.1.-.r#0D#0A..ddf_x.:#3D.1#0D#0A..ddf
_y.:#3D.-2.*.r#0D#0A..x.:#3D.0#0D#0A..y.:#3D.r#0D#0A
#0D#0A..wrpixel(xmax,.ymin+r,.plotcolour)#0D#0A..wr
pixel(xmin,.ymin+r,.plotcolour)#0D#0A..wrpixel(xmax
,.ymax-r,.plotcolour)#0D#0A..wrpixel(xmin,.ymax-r,.
plotcolour)#0D#0A#0D#0A..WHILE.x<y.DO#0D#0A..{.//.d
df_x.#3D.2*x.+.1#0D#0A..2//.ddf_y.#3D.-2.*.y#0D#0A.
.2//.f.#3D.x*x.+.y*y.-.radius*radius.+.2*x.-.y.+.1#0D
#0A..2IF.f>#3D0.DO#0D#0A..2{.y.:#3D.y-1#0D#0A..4ddf
_y.:#3D.ddf_y.+.2#0D#0A..4f.:#3D.f.+.ddf_y#0D#0A..2
}#0D#0A..2x.:#3D.x+1#0D#0A..2ddf_x.:#3D.ddf_x.+.2#0D
#0A..2f.:#3D.f.+.ddf_x#0D#0A..2wrpixel(xmax-r+x,.ym
ax-r+y,.plotcolour).//.octant.2#0D#0A..2wrpixel(xmi
n+r-x,.ymax-r+y,.plotcolour).//.Octant.3#0D#0A..2wr
pixel(xmax-r+x,.ymin+r-y,.plotcolour).//.Octant.7#0D
#0A..2wrpixel(xmin+r-x,.ymin+r-y,.plotcolour).//.Oc
tant.6#0D#0A..2wrpixel(xmax-r+y,.ymax-r+x,.plotcolo
ur).//.Octant.1#0D#0A..2wrpixel(xmin+r-y,.ymax-r+x,
.plotcolour).//.Octant.4#0D#0A..2wrpixel(xmax-r+y,.
ymin+r-x,.plotcolour).//.Octant.8#0D#0A..2wrpixel(x
min+r-y,.ymin+r-x,.plotcolour).//.Octant.5#0D#0A..}
#0D#0A#0D#0A..plotx,.ploty.:#3D.x0,.y0#0D#0A}#0D#0A
#0D#0AAND.fillrndrect(x0,.y0,.x1,.y1,.radius).BE#0D
#0A{.LET.xmin,.xmax.#3D.x0,.x1#0D#0A..LET.ymin,.yma
x.#3D.y0,.y1#0D#0A..LET.r.#3D.radius#0D#0A..LET.f,.
ddf_x,.ddf_y,.x,.y.#3D.?,.?,.?,.?,.?#0D#0A..LET.las
tx,.lasty.#3D.0,.0#0D#0A#0D#0A..IF.xmin>xmax.DO.xmi
n,.xmax.:#3D.x1,.x0#0D#0A..IF.ymin>ymax.DO.ymin,.ym
ax.:#3D.y1,.y0#0D#0A..IF.r<0.DO.r.:#3D.0#0D#0A..IF.
r+r>xmax-xmin.DO.r.:#3D.(xmax-xmin)/2#0D#0A..IF.r+r
>ymax-ymin.DO.r.:#3D.(ymax-ymin)/2#0D#0A#0D#0A//saw
ritef("fillrndrect:.%i4.%i4.%i4.%i4.%i4*n",xmin,ymi
n,xmax,ymax,radius)#0D#0A..FOR.x.#3D.xmin.TO.xmax.F
OR.y.#3D.ymin+r.TO.ymax-r.DO#0D#0A..{.wrpixel(x,.y,
.plotcolour)#0D#0A..2wrpixel(x,.y,.plotcolour)#0D#0A
..}#0D#0A#0D#0A..//.Now.draw.the.rounded.corners#0D
#0A..//.This.is.commonly.called.Bresenham's.circle.
algorithm.since.it#0D#0A..//.is.derived.from.Bresen
ham's.line.algorithm#2E#0D#0A..f.:#3D.1.-.r#0D#0A..
ddf_x.:#3D.1#0D#0A..ddf_y.:#3D.-2.*.r#0D#0A..x.:#3D
.0#0D#0A..y.:#3D.r#0D#0A#0D#0A..wrpixel(xmax,.ymin+
r,.plotcolour)#0D#0A..wrpixel(xmin,.ymin+r,.plotcol
our)#0D#0A..wrpixel(xmax,.ymax-r,.plotcolour)#0D#0A
..wrpixel(xmin,.ymax-r,.plotcolour)#0D#0A#0D#0A..WH
ILE.x<y.DO#0D#0A..{.//.ddf_x.#3D.2*x.+.1#0D#0A..2//
.ddf_y.#3D.-2.*.y#0D#0A..2//.f.#3D.x*x.+.y*y.-.radi
us*radius.+.2*x.-.y.+.1#0D#0A..2IF.f>#3D0.DO#0D#0A.
.2{.y.:#3D.y-1#0D#0A..4ddf_y.:#3D.ddf_y.+.2#0D#0A..
4f.:#3D.f.+.ddf_y#0D#0A..2}#0D#0A..2x.:#3D.x+1#0D#0A
..2ddf_x.:#3D.ddf_x.+.2#0D#0A..2f.:#3D.f.+.ddf_x#0D
#0A..2wrpixel(xmax-r+x,.ymax-r+y,.plotcolour).//.oc
tant.2#0D#0A..2wrpixel(xmin+r-x,.ymax-r+y,.plotcolo
ur).//.Octant.3#0D#0A..2wrpixel(xmax-r+x,.ymin+r-y,
.plotcolour).//.Octant.7#0D#0A..2wrpixel(xmin+r-x,.
ymin+r-y,.plotcolour).//.Octant.6#0D#0A..2wrpixel(x
max-r+y,.ymax-r+x,.plotcolour).//.Octant.1#0D#0A..2
wrpixel(xmin+r-y,.ymax-r+x,.plotcolour).//.Octant.4
#0D#0A..2wrpixel(xmax-r+y,.ymin+r-x,.plotcolour).//
.Octant.8#0D#0A..2wrpixel(xmin+r-y,.ymin+r-x,.plotc
olour).//.Octant.5#0D#0A#0D#0A..2UNLESS.x#3Dlastx.D
O#0D#0A..2{.FOR.fx.#3D.xmin+r-y+1.TO.xmax-r+y-1.DO#0D
#0A..4{.wrpixel(fx,.ymax-r+x,.plotcolour)#0D#0A..6w
rpixel(fx,.ymin+r-x,.plotcolour)#0D#0A..4}#0D#0A..4
lastx.:#3D.x#0D#0A..2}#0D#0A..2UNLESS.y#3Dlasty.DO#0D
#0A..2{.FOR.fx.#3D.xmin+r-x+1.TO.xmax-r+x-1.DO#0D#0A
..4{.wrpixel(fx,.ymax-r+y,.plotcolour)#0D#0A..6wrpi
xel(fx,.ymin+r-y,.plotcolour)#0D#0A..4}#0D#0A..2}#0D
#0A..}#0D#0A#0D#0A..plotx,.ploty.:#3D.x0,.y0#0D#0A}
#0D#0A#0D#0AAND.drawcircle(x0,.y0,.radius).BE#0D#0A
{.//.This.is.commonly.called.Bresenham's.circle.alg
orithm.since.it#0D#0A..//.is.derived.from.Bresenham
's.line.algorithm#2E#0D#0A..LET.f.#3D.1.-.radius#0D
#0A..LET.ddf_x.#3D.1#0D#0A..LET.ddf_y.#3D.-2.*.radi
us#0D#0A..LET.x.#3D.0#0D#0A..LET.y.#3D.radius#0D#0A
..wrpixel(x0,.y0+radius,.plotcolour)#0D#0A..wrpixel
(x0,.y0-radius,.plotcolour)#0D#0A..wrpixel(x0+radiu
s,.y0,.plotcolour)#0D#0A..wrpixel(x0-radius,.y0,.pl
otcolour)#0D#0A#0D#0A..WHILE.x<y.DO#0D#0A..{.//.ddf
_x.#3D.2*x.+.1#0D#0A..2//.ddf_y.#3D.-2.*.y#0D#0A..2
//.f.#3D.x*x.+.y*y.-.radius*radius.+.2*x.-.y.+.1#0D
#0A..2IF.f>#3D0.DO#0D#0A..2{.y.:#3D.y-1#0D#0A..4ddf
_y.:#3D.ddf_y.+.2#0D#0A..4f.:#3D.f.+.ddf_y#0D#0A..2
}#0D#0A..2x.:#3D.x+1#0D#0A..2ddf_x.:#3D.ddf_x.+.2#0D
#0A..2f.:#3D.f.+.ddf_x#0D#0A..2wrpixel(x0+x,.y0+y,.
plotcolour)#0D#0A..2wrpixel(x0-x,.y0+y,.plotcolour)
#0D#0A..2wrpixel(x0+x,.y0-y,.plotcolour)#0D#0A..2wr
pixel(x0-x,.y0-y,.plotcolour)#0D#0A..2wrpixel(x0+y,
.y0+x,.plotcolour)#0D#0A..2wrpixel(x0-y,.y0+x,.plot
colour)#0D#0A..2wrpixel(x0+y,.y0-x,.plotcolour)#0D#0A
..2wrpixel(x0-y,.y0-x,.plotcolour)#0D#0A..}#0D#0A}#0D
#0A#0D#0AAND.fillcircle(x0,.y0,.radius).BE#0D#0A{./
/.This.is.commonly.called.Bresenham's.circle.algori
thm.since.it#0D#0A..//.is.derived.from.Bresenham's.
line.algorithm#2E#0D#0A..LET.f.#3D.1.-.radius#0D#0A
..LET.ddf_x.#3D.1#0D#0A..LET.ddf_y.#3D.-2.*.radius#0D
#0A..LET.x.#3D.0#0D#0A..LET.y.#3D.radius#0D#0A..LET
.lastx,.lasty.#3D.0,.0#0D#0A..wrpixel(x0,.y0+radius
,.plotcolour)#0D#0A..wrpixel(x0,.y0-radius,.plotcol
our)#0D#0A..FOR.x.#3D.x0-radius.TO.x0+radius.DO.wrp
ixel(x,.y0,.plotcolour)#0D#0A#0D#0A..WHILE.x<y.DO#0D
#0A..{.//.ddf_x.#3D.2*x.+.1#0D#0A..2//.ddf_y.#3D.-2
.*.y#0D#0A..2//.f.#3D.x*x.+.y*y.-.radius*radius.+.2
*x.-.y.+.1#0D#0A..2IF.f>#3D0.DO#0D#0A..2{.y.:#3D.y-
1#0D#0A..4ddf_y.:#3D.ddf_y.+.2#0D#0A..4f.:#3D.f.+.d
df_y#0D#0A..2}#0D#0A..2x.:#3D.x+1#0D#0A..2ddf_x.:#3D
.ddf_x.+.2#0D#0A..2f.:#3D.f.+.ddf_x#0D#0A..2wrpixel
(x0+x,.y0+y,.plotcolour)#0D#0A..2wrpixel(x0-x,.y0+y
,.plotcolour)#0D#0A..2wrpixel(x0+x,.y0-y,.plotcolou
r)#0D#0A..2wrpixel(x0-x,.y0-y,.plotcolour)#0D#0A..2
wrpixel(x0+y,.y0+x,.plotcolour)#0D#0A..2wrpixel(x0-
y,.y0+x,.plotcolour)#0D#0A..2wrpixel(x0+y,.y0-x,.pl
otcolour)#0D#0A..2wrpixel(x0-y,.y0-x,.plotcolour)#0D
#0A..2UNLESS.x#3Dlastx.DO#0D#0A..2{.FOR.fx.#3D.x0-y
+1.TO.x0+y-1.DO#0D#0A..4{.wrpixel(fx,.y0+x,.plotcol
our)#0D#0A..6wrpixel(fx,.y0-x,.plotcolour)#0D#0A..4
}#0D#0A..4lastx.:#3D.x#0D#0A..2}#0D#0A..2UNLESS.y#3D
lasty.DO#0D#0A..2{.FOR.fx.#3D.x0-x+1.TO.x0+x-1.DO#0D
#0A..4{.wrpixel(fx,.y0+y,.plotcolour)#0D#0A..6wrpix
el(fx,.y0-y,.plotcolour)#0D#0A..4}#0D#0A..4lasty.:#3D
.y#0D#0A..2}#0D#0A..}#0D#0A}#0D#0A

######g/graphics.h#
/*#0AThis.is.the.header.file.for.the.graphics.libra
ry.com/graphics#2Eb#0A#0AImplemented.by.Martin.Rich
ards.(c).9.December.2011#0A#0AThe.manifest.graphics
gbase.must.be.declared.before.including#0Athis.head
er#2E#0A*/#0A#0AGLOBAL.{#0Aopengraphics:.g_grfbase#0A
closegraphics#0A#0Acanvas..4//.Rectangular.array.of
.pixel.bytes#0Acanvassize..//.Number.of.bytes.in.ca
nvas#0Acanvasupb..1//.UPB.of.canvas.in.words#0Axsiz
e#0Aysize#0Acolourtab..1//.Vector.to.map.pixel.byte
s.to.RGB.values#0Arowlen..4//.xsize.rounded.up.to.a
.multiple.of.4.bytes#0Awrpixel..3//.(x,y,col)#0Awrp
ixel33..1//.(x,y,col)#0Aplotx..5//.Current.plotting
.x#0Aploty..5//.Cyrrent.plotting.y#0Aplotcolour..//
.Current.plotting.colour#0Aplotch..4//.(ch)#0Aplots
tr..3//.(s)#0Amoveto..4//.(x,y)#0Amoveby..4//.(dx,d
y)#0Adrawto..4//.(x,y)#0Adrawby..4//.(dx,dy)#0Adraw
rect..2//.(x0,y0,x1,y1)#0Afillrect..2//.(x0,y0,x1,y
1)#0Adrawrndrect.//.(x0,y0,x1,y1,radius)#0Afillrndr
ect.//.(x0,y0,x1,y1,.radius)#0Adrawcircle..//.(x0,.
y0,.radius)#0Afillcircle..//.(x0,.y0,.radius)#0Awrg
raph..3//.(filename)#0A}#0A#0AMANIFEST.{#0A//.Some.
colours#0A.col_white#3D..0010#0A.col_rb..1#3D..0003
0#0A.col_b..2#3D..00070#0A.col_gb..1#3D.110000#0A.c
ol_g..2#3D.150#0A.col_rg..1#3D.190#0A.col_r..2#3D.2
30#0A.col_black#3D.255#0A}#0A#0A

######g/manhdr.h#
/*..4SYSTEM.MANIFESTS#0A#0A..6Aborts#0A..6Actions#0A
..6Errors#0A*/#0A#0A1MANIFEST#0A$(.//.Aborts:#0A..1
Abort_impossible..3#3D.299#0A..1Abort_ictionnotnnow
n.#3D.298#0A..1Abort_keyoutofrange..#3D.297#0A..1Ab
ort_discerror..4#3D.296#0A..1Abort_badfreelock..2#3D
.295#0A..1Abort_discfull..5#3D.294#0A..1Abort_inval
idchecksum..6#3D.293#0A..1Abort_loadsegfailure.#3D.
292#0A..1Abort_createtaskfailure..4#3D.291#0A..1Abo
rt_keyalreadyallocated..2#3D.290#0A..1Abort_keyalre
adyfree.#3D.289#0A..1Abort_objecttoolarge.#3D.288#0A
..1Abort_bitmapcorrupt..#3D.287#0A..1Abort_sequence
_error.#3D.286..3//.file.handler.three.error#0A#0A1
..1//.Actions:.for.device.handler.task.packets#0A#0A
..1Action_nil#3D0#0A..1Action_startup#3D100.//.Leav
e.1.-.99.free.#0A..1Action_getblock#0A..1Action_unt
ilfree#0A..1Action_setmap#0A..1Action_die#0A#0A..1A
ction_resumework#0A..1Action_locateobject#0A#0A..1A
ction_setaccess#0A..1Action_write#0A..1Action_read#0A
..1Action_closeinput#0A..1Action_closeoutput#0A..1A
ction_closeinoutput#0A..1Action_close#0A..1Action_e
nd#0A..1Action_freelock#0A..1Action_deleteobject#0A
..1Action_renameobject#0A..1Action_getremipaddr..1/
/.for.TCPHAND..1MR.3/4/03#0A#0A..1Action_copydir#0A
..1Action_note#0A..1Action_point#0A..1Action_create
dir#0A..1Action_examineobject#0A..1Action_examinene
xt#0A..1Action_discinfo#0A#0A..1Action_findinput#0A
..1Action_findoutput#0A..1Action_findinoutput#0A..1
Action_findappend#0A#0A..1Action_setcomment..6//.sp
ecial.version.of.FH3#0A#0A..1Action_aliasobject..5/
/.For.Fileserver.FH.only#0A..1Action_setroot..9//.F
or.Fileserver.FH.only#0A#0A..1Action_endtoinput#0A.
.1Action_rewind#0A#0A..1Action_self_immolation..5//
.For.COHAND#0A..1Action_ttyin..15//.For.COHAND#0A..
1Action_ttyout..14//.For.COHAND#0A..1Action_exclusi
veinput..6//.For.COHAND..MR.28/4/03#0A..1Action_exc
lusiverdch..7//.For.COHAND..MR.28/4/03#0A..1Action_
devices..13//.For.COHAND..MR.28/4/03#0A#0A..1Action
_debug..15//.For.TCPHAND.etc..MR.26/1/04#0A#0A..1//
.Environment.vector.offsets:#0A..1Envec_szblk..8#3D
.1#0A..1Envec_secorg..7#3D.2#0A..1Envec_nsur..9#3D.
3#0A..1Envec_nsecblk..6#3D.4#0A..1Envec_nblktrk..6#3D
.5#0A..1Envec_nresblk..6#3D.6#0A..1Envec_prefac..7#3D
.7#0A..1Envec_intfac..7#3D.8#0A..1Envec_lowcyl..7#3D
.9#0A..1Envec_upcyl..8#3D.10#0A..1Envec_nbuffers..5
#3D.11#0A#0A1..1//.Errors:#0A..1Error_getvecfailure
..#3D.103#0A..1Error_nodefaultdir..1#3D.201#0A..1Er
ror_objectinuse..2#3D.202#0A..1Error_objectexists..
1#3D.203#0A..1Error_dirnotfound..2#3D.204#0A..1Erro
r_objectnotfound.#3D.205#0A..1Error_badstreamname..
#3D.206#0A..1Error_objecttoolarge.#3D.207#0A..1Erro
r_busy..9#3D.208#0A..1Error_actionnotknown.#3D.209#0A
..1Error_invalidcomponentname..1#3D.210#0A..1Error_
invalidlock..2#3D.211#0A..1Error_objectwrongtype..6
#3D.212#0A..1Error_discnotvalidated..5#3D.213#0A..1
Error_discwriteprotected..3#3D.214#0A..1Error_renam
eacrossdevices..2#3D.215#0A..1Error_directorynotemp
ty..4#3D.216#0A..1Error_toomanylevels..8#3D.217#0A.
.1Error_device_not_mounted..3#3D.218#0A..1Error_poi
nt_error..10#3D.219#0A..1Error_commenttoobig#09#09#3D
.220000#09//.special.modified.FH3#0A#0A..1//.Filese
rver.filing.system.errors#0A#0A..1error_insufficien
taccess..3#3D.230#0A..1Error_nomoreentries..8#3D.23
2#0A..1Error_illegaldelete..8#3D.233#0A..1Error_fil
e_in_root..9#3D.234..//.Attempt.to.create.file.in.r
oot.dir#0A..1Error_open_in_fs..11#3D.2200014#0A..1E
rror_invalid_uid..10#3D.2200017#0A$)#0A

######g/libhdr.h#
//.Standard.BCPL.header.for.both.Cintsys.and.Cintpo
s#0A#0A//.Modified.by.Martin.Richards.(c).15.May.20
13#0A#0A/*#0A11/02/04.MR#0AAdded.binwrch,.removed.p
ackstring,.unpackstring.and.dqpkt#0A21/10/02.MR#0AM
ade.compatible.with.libhdr.of.the.standard.BCPL.dis
tribution#0A*/#0A#0AMANIFEST.{#0A//.Uncomment.one.o
f.the.following.lines.if.using.a.compiler.that.does
.not#0A//.implement.BITSPERBCPLWORD.as.a..reserved.
word#2E#0A//BITSPERBCPLWORD.#3D.32#0A//BITSPERBCPLW
ORD.#3D.64#0A#0AB2Wsh.#3D.1.+.BITSPERBCPLWORD/32../
/.#3D2.for.32-.bit.implementations#0A..30//.#3D3.fo
r.64-bit.implementations#0A}#0A#0A//.All.that.follo
ws.is.the.same.for.both.32-.and.64-bit.Cintcode.sys
tems#2E#0A#0A//.Globals.used.in.the.standard.(singl
e.threaded).BCPL.Cintcode.System#0AGLOBAL.{#0Aglobs
ize:..0100#0Astart:..0131#0Astop:..0142#0Asys:..015
3..//SYSLIB..1MR.18/7/01#0Aclihook:..0114#0Amuldiv:
..0125..//SYSLIB..1changed.to.G:5.MR.6/5/05#0Achang
eco:..0106..//SYSLIB..1MR.6/5/04#0Acurrco:..0127#0A
colist:..0128#0Arootnode:..0109..//.For.compatibili
ty.with.native.BCPL#0Aresult2:..01010#0Areturncode:
..00711#0Acis:..01412#0Acos:..01413#0Acurrentdir:..
00714#0Alevel:..01215#0Alongjump:..00916#0Acreateco
:..00917#0Adeleteco:..00918#0Acallco:..01119#0Acowa
it:..01120#0Aresumeco:..00921#0Ainitco:..01122#0Ast
artco:..01023#0Aglobin:..01124#0Agetvec:..01125#0A#0A
freevec:..01027#0Aabort:..01228#0Asysabort:..00929#0A
packstring:..00730#0Aunpackstring:..00531#0Agetword
:..01032#0Aputword:..01033#0Arandno:..01134#0Asetse
ed:..01035#0Asardch:..01136#0Asawrch:..01137#0Ardch
:..01338#0Abinrdch:..01039#0Aunrdch:..01140#0Awrch:
..01341#0Abinwrch:..01042#0Adeplete:..01043#0Areadw
ords:..00844#0Awritewords:..00745#0Ainitio:..01146#0A
splitname:..00847#0Afindinput:..00848#0Afindoutput:
..00749#0Afindinoutput:..00550#0Afindupdate:..00751
#0Afindstream:..00752#0Apathfindinput:..00453#0Aget
remipaddr:..00554#0Asettimeout:..00755#0Aselectinpu
t:..00656#0Aselectoutput:..00557#0Ainput:..01258#0A
output:..01159#0Aendread:..01060#0Aendwrite:..00961
#0Aendstream:..00862#0Anote:..01363#0Apoint:..01264
#0Arewindstream:..00565#0Aappendstream:..00566#0Ast
epstream:..00767#0Asetrecordlength:..00268#0Arecord
point:..00669#0Arecordnote:..00770#0Aget_record:..0
0771#0Aput_record:..00772#0Aget_index_record:..0017
3..//.Not.yet.implemented#0Aput_index_record:..0017
4..//.Not.yet.implemented#0Acopyobj:..01075#0Adelet
efile:..00776#0Arenamefile:..00777#0Afreeobj:..0107
8#0Acopydir:..01079#0Alocatedir:..00880#0Alocateobj
:..00881#0Acreatedir:..00882#0Areadn:..01283#0Anewl
ine:..01084#0Awrited:..01185#0Awriten:..01186#0Awri
tehex:..00987#0Awriteoct:..00988#0Awrites:..01189#0A
writet:..01190#0Awriteu:..01191#0Awritez:..01192#0A
get_textblib:..00593..//BLIB.version#0Aget_text:..0
0993..//BLIB.overridden.version#0Awritef:..01194../
/BLIB#0Asawritef:..00995#0Acapitalch:..00896#0Acomp
ch:..01197#0Acompstring:..00798#0Acopystring:..0079
9#0Astring_to_number:..000100#0Astr2numb:..008101#0A
rdargs:..010102#0Arditem:..010103#0Afindarg:..00910
4#0Aloadseg:..009105#0Aunloadseg:..007106#0Acallseg
:..009107#0Adatstring:..007108#0Adatstamp:..008109#0A
dat_to_strings:..002110000#0Astring_to_dat:..003111
#0Asetbit:..010110002#0Atestbit:..009110003#0Acopy_
words:..006110004#0Aclear_words:..005110005#0Acopy_
bytes:..006110006#0Asetlogname:..006110007#0Agetlog
name:..006110008#0Aintflag:..009110009#0Anewpage:..
009120#0Ainstrcount:..006121#0Asetbulk:..009122#0A/
/mkramstream:..005123..//.use.findinoutput("RAM:").
instead#0Asettimeoutact:..003124#0Adeleteself:..006
125#0Acodewrch:..008126.//.Write.an.extended.charac
ter.in.UTF8.or.GB2312.format#0Arandseed:..008127#0A
delay:..011128.//.delay(msecs)#0Adelayuntil:..00612
9.//.delayuntil(days,.msecs)#0Afindappend:..006130.
//.Added.18/01/11#0A#0A//#23#233.CLI.uses.globals.1
31.-.149.#23#233#0A#0Acli_tallyflag:..003132#0Acli_
init:..008133#0Acli_result2:..005134#0Acli_data:..0
08135..//.CLI.dependent.data..MR.10/7/03#0Acli_comm
anddir:..002136#0Acli_returncode:..002137#0Acli_com
mandname:..001138#0Acli_faillevel:..003139#0Acli_pr
ompt:..006140#0Acli_standardinput:.141#0Acli_curren
tinput:..000142#0Acli_commandfile:..001143..//.Name
.of.temporary.command.file.used.in#0A..22//.command
-commands#0Acli_status:..006144..//.Contains.the.CL
I.status.flags#0Acli_preloadlist:..001145#0Acli_cur
rentoutput:.146#0Acli_defaultstack:..000147#0Acli_s
tandardoutput:148#0Acli_module:..006149#0A#0A//#23#23
3.Cintpos.uses.globals.150.-.199.#23#233#0A#0Asrchw
k:..010150#0Atcb:..013151#0Ataskid:..010152#0Acreat
etask:..006153#0Adeletetask:..006154#0Achangepri:..
007155#0Asetflags:..008156#0Atestflags:..007157#0Ah
old:..012158#0Aunhold:..010159;..release:..009159#0A
taskwait:..008160#0Aqpkt:..012161#0Aendtask:..00916
2#0A#0Asendpkt:..009165.//.Overridden.when.in.multi
event.mode#0A#0Areturnpkt:..007169#0A#0Aconsoletask
:..005171#0Acreatedev:..007172#0Adeletedev:..007173
#0Afault:..011174#0Aset_process_name:..000175#0A#0A
peercom:..009179#0A#0A//.Globals.190-199.are.variab
les.not.reset.between.CLI.commands#0Acurrent_langua
ge:..000190.//.Potentially.used.by.get_text#0A}#0A#0A
MANIFEST.{#0A#0Atg.#3D.190..1//.First.user.global.n
ot.reset.between.CLI.commands#0Aug.#3D.200..1//.Fir
st.user.global#0A#0Abytesperword..2#3D.1<<B2Wsh#0Ab
itsperbyte#09#3D.8#0Abitsperword#09#3D.bitsperbyte.
*.bytesperword#0Amcaddrinc#09#3D.bytesperword#0Amin
int..8#3D.1<<(bitsperword-1)..//.#3D.#23x80#2E#2E00
20#0Amaxint..8#3D.minint.-.1..8//.#3D.#23x7F#2E#2E2
F#0A#0Aendstreamch#09#3D.-1..//.ch.returned.at.EOF#0A
timeoutch#09#3D.-2..//.ch.returned.when.none.availa
ble.before.timeout#0Apollingch#09#3D.-3..//.ch.retu
rned.when.none.available.when.polling#0A#0A//.Objec
t.module.format.types#0A#0At_hunk..2#3D.1001.//.A.h
unk.in.ASCII.hex#0At_reloc..1#3D.1000001#0At_end..3
#3D.1000002#0At_hunk64..#3D.2001.//.A.hunk.in.ASCII
.hex.for.64-bit.Cintcode#0At_reloc64.#3D.2000001#0A
t_end64..1#3D.2000002#0At_bhunk..1#3D.3001.//.A.hun
k.in.binary#0At_bhunk64.#3D.4001.//.A.hunk.in.binar
y.for.64-bit.Cintcode#0A#0Aglobword..#3D.#23xFF0068
F8F002..//.MR.7/9/2000006.(for.64-bit.version)#0Ast
ackword.#3D.#23xFF6ABCD1234#0Adeadcode..#3D.#23xFF6
DEADC0DE#0Asectword..#3D.#23x0010FDDF#0Aentryword.#3D
.#23x0010DFDF#0A#0A//.Important.global.variable.num
bers#0Ag_globsize.#3D.0#0Ag_sys..4#3D.3#0Ag_currco.
.1#3D.7#0Ag_colist..1#3D.8#0Ag_rootnode.#3D.9#0A#0A
g_memsize..#3D.14#0Ag_keyboard.#3D.20#0Ag_screen..1
#3D.21#0A#0A//.co-routine.stackbase.offsets#0A#0Aco
_pptr.#3D.0#0Aco_parent#0Aco_list#0Aco_fn#0Aco_size
#0Aco_c#0A#0AInitObj..#3D.0..//.Initialisation.and.
closing.methods.for.objects#0ACloseObj.#3D.1#0A#0A/
/.Rootnode.manifests#0A#0Arootnodeaddr.#3D.100..//.
MR.21/10/02.for.compatibility.with.Cintpos#0A..18//
.Not.used.in.native.code.versions#0A#0Artn_tasktab.
#3D.0#0Artn_devtab#0Artn_tcblist#0Artn_crntask#0Art
n_blklist#0Artn_tallyv#0A#0Artn_clkintson#0Artn_las
tch..7//.For.sadebug.polling.input#0Artn_insadebug.
.4//.Looked.at.by.ttyin.device#0A#0Artn_bptaddr..6/
/.Breakpoint.addresses..4).MR.20/9/02#0Artn_bptinst
r..5//.Breakpoint.instructions..1)#0Artn_dbgvars..6
//.The.Standalone.Debug.variables#0A#0Artn_clwkq#0A
rtn_membase#0Artn_memsize#0Artn_info#0Artn_sys#0Art
n_boot..9//.BOOT.code#0Artn_klib..9//.KLIB.code.seg
ments#0Artn_blib..9//.BLIB.code.segments#0Artn_keyb
oard..5//.Keyboard.stream#0Artn_screen..7//.Screen.
stream#0A#0Artn_vecstatsv#0Artn_vecstatsvupb#0A#0Ar
tn_intflag..6//.Set.to.TRUE.by.ctrl-c.and.FALSE.by.
sadebug#0Artn_dumpflag..5//.#3DTRUE.for.memory.dump
.to.DUMP#2Emem#0Artn_envlist..6//.List.of.logical.n
ame-value.pairs#0A..17//.used.by.setlogname.and.get
logname#0Artn_abortcode..4//.Latest.reason.for.leav
ing.the.interpreter#0Artn_context..6//.Context.of.D
UMP#2Emem#0A..17//.1.dump.caused.by.second.SIGINT#0A
..17//.2.dump.caused.by.SIGSEGV#0A..17//.3.fault.in
.BOOT.or.standalone.debug#0A..17//.4.dump.by.user.c
alling.sys(Sys_quit,.-2)#0A..17//.5.dump.caused.by.
non.zero.user.fault.code#0A..17//.6.dump.requestest
ed.from.standalone.debug#0A#0Artn_lastp..8//.Latest
.setting.of.p.pointer.at.SIGINT.or.SIGSEGV#0Artn_la
stg..8//.Latest.setting.of.p.pointer.at.SIGINT.or.S
IGSEGV#0Artn_lastst..7//.Latest.setting.of.st#0A..1
7//.st.#3D.0..2in.a.user.task,.interrupts.enabled#0A
..17//.st.#3D.1..2in.BOOT,..6interrupts.disabled#0A
..17//.st.#3D.2..2in.KLIB,..6interrupts.disabled#0A
..17//.st.#3D.3..2in.the.ISR..4interrupts.disabled#0A
#0Artn_idletcb..6//.The.IDLE.TCB.(for.debugging)#0A
rtn_adjclock..5//.Real.time.clock.adjustment.in.min
utes#0A#0Artn_dcountv..6//.the.Debug.Counts.vectors
#0A#0A//.The.following.four.variables.are.set.by.bo
ot#2Eb#0A//.and.used.by.programs.such.as.cli#2Eb,.b
cpl#2Eb.and.c#2Eb#0A#0Artn_rootvar..6//.The.environ
ment.variable.giving.the#0A..17//.system.root.direc
tory,.eg."BCPLROOT".or."POSROOT"#0Artn_pathvar..6//
.The.environment.variable.giving.the.directories#0A
..17//.searched.by.loadseg,.eg."BCPLPATH".or."POSPA
TH"#0Artn_hdrsvar..6//.The.environment.variable.giv
ing.the.directories#0A..17//.containing.BCPL.header
s,.eg."BCPLHDRS".or."POSHDRS"#0Artn_scriptsvar..3//
.The.environment.variable.giving.the.directories#0A
..17//.containing.cli.scripts,.eg."BCPLSCRIPTS".or.
"POSSCRIPTS"#0Artn_boottrace..4//.#3D0,.1,.2.or.3.a
s.set.by.-v.and.-vv.options.to#0A..17//.trace.the.p
rogress.of.booting.the.system#2E#0A#0Artn_days..9//
.Days.since.1.Jan.1970.(1978.old.dat.format)#0Artn_
msecs..8//.Milliseconds.since.midnight#0Artn_mins#3D
rtn_msecs.//.for.old.dat.format#0Artn_ticks..8//.#3D
-1.for.new.dat.format#0A#0Artn_mc0..10//.Machine.ad
dress.of.the.start.of.the#0A..17//.Cintcode.memory#2E
#0Artn_mc1..10//.Other.values.used.by.the.MC.packag
e#2E#0Artn_mc2..8#0Artn_mc3..8#0A#0Artn_upb.#3D.50.
.5//.Leave.some.unused.entries#0A#0A//.SYS.function
s#0ASys_setcount..6#3D..-1#0ASys_quit..10#3D..0010#0A
Sys_rti..11#3D..0011#0ASys_saveregs..6#3D..0012#0AS
ys_setst..9#3D..0013#0ASys_tracing..7#3D..0014#0ASy
s_watch..9#3D..0015#0ASys_tally..9#3D..0016#0ASys_i
nterpret..5#3D..0017#0A#0ASys_sardch..8#3D..00010#0A
Sys_sawrch..8#3D..00011#0ASys_read..10#3D..00012#0A
Sys_write..9#3D..00013#0ASys_openread..6#3D..00014#0A
Sys_openwrite..5#3D..00015#0ASys_close..9#3D..00016
#0ASys_deletefile..4#3D..00017#0ASys_renamefile..4#3D
..00018#0ASys_openappend..4#3D..00019#0A#0ASys_getv
ec..8#3D..00021#0ASys_freevec..7#3D..00022#0ASys_lo
adseg..7#3D..00023#0ASys_globin..8#3D..00024#0ASys_
unloadseg..5#3D..00025#0ASys_muldiv..8#3D..00026#0A
Sys_intflag..7#3D..00028#0ASys_setraster..5#3D..000
29#0ASys_cputime..7#3D..00030#0ASys_filemodtime..3#3D
..00031#0ASys_setprefix..5#3D..00032#0ASys_getprefi
x..5#3D..00033#0ASys_graphics..6#3D..00034..//.Not.
implemented#0A#0ASys_seek..10#3D..00038..//.MR.10/1
1/01#0ASys_tell..10#3D..00039..//.MR.10/11/01#0ASys
_waitirq..7#3D..00040..//.MR..0004/02/02#0ASys_lock
irq..7#3D..00041..//.MR.24/02/03#0ASys_unlockirq..5
#3D..00042..//.MR.24/02/03#0ASys_devcom..8#3D..0004
3..//.MR..0004/02/02#0ASys_datstamp..6#3D..00044../
/.MR.29/03/10#0A#0ASys_filesize..6#3D..00046..//.MR
.15/03/02#0ASys_openreadwrite..1#3D..00047..//.MR.1
9/03/02#0ASys_getsysval..5#3D..00048..//.MR.18/11/0
2#0ASys_putsysval..5#3D..00049..//.MR.18/11/02#0ASy
s_shellcom..6#3D..00050..//.MR.13/01/03#0ASys_getpi
d..8#3D..00051..//.MR..0007/10/03#0ASys_dumpmem..7#3D
..00052..//.MR.29/10/03.Used.only.in.BOOT#2Eb#0ASys
_callnative..4#3D..00053..//.MR.24/04/04#0ASys_plat
form..6#3D..00054..//.MR.06/04/05.architecture.and.
OS#0ASys_inc..11#3D..00055..//.MR.17/12/04#0ASys_bu
ttons..7#3D..00056..//.MR.21/06/06.Button.on.the.GP
2X#0ASys_delay..9#3D..00057..//.MR.01/05/10.Delay.u
ntil.a.specified.date.and.time#0ASys_sound..9#3D..0
0058..//.MR.11/09/07.Sound.functions#0ASys_callc..9
#3D..00059..//.MR.28/01/09.Call.the.C.function#0A..
25//..11callc(args,g)#0ASys_trpush..8#3D..00060..//
.MR.05/02/10.Push.a.trace.value#0ASys_settrcount..4
#3D..00061..//.MR.05/02/10.Set.trcount#0ASys_gettrv
al..6#3D..00062..//.MR.05/02/10.Get.a.pushed.trace.
value#0ASys_flt..11#3D..00063..//.MR.21/07/10.Float
ing.point.ops#0ASys_pollsardch..4#3D..00064..//.MR.
07/03/11.Return.next.ch.or.-3#0ASys_incdcount..5#3D
..00065..//.MR.06/03/12.Increment.a.specified.debug
.counter#2E#0A#0ASys_sdl..11#3D..00066..//.MR.30/05
/12.SDL.features#0ASys_gl..12#3D..00067..//.MR.12/0
1/14.OpenGL.features#0ASys_ext..11#3D..00068..//.MR
.14/04/14.EXT.user.extension.features#0A#0Abootregs
.#3D.11.//.Registers.used.by.cintpos.to.start.BOOT#0A
cliregs..#3D.21.//.Registers.used.by.BOOT.to.start.
the.CLI#0Aklibregs.#3D.21.//.Registers.used.by.BOOT
.to.start.KLIB#0Asaveregs.#3D.31.//.Registers.are.s
aved.here.on.Cintpos.interrupt#0Aisrregs..#3D.41.//
.Registers.for.the.Cintpos.interrupt.service.routin
e#0A#0Aid_inscb#09#3D.#23x81..//.MR.21/10/02#0Aid_o
utscb#09#3D.#23x82..//.MR.21/10/02#0Aid_inoutscb#09
#3D.#23x83..//.MR.21/10/02#0Aid_appendscb#09#3D.#23
x84..//.MR.18/01/11#0A#0Ascbt_net..3#3D..0002..//.N
on.interactive.TCP/IP.stream#0Ascbt_file..2#3D..000
1..//.Non.interactive.disc.file.stream#0Ascbt_ram..
3#3D..0000..//.Non.interactive.RAM.stream#0Ascbt_co
nsole.#3D.-1..//.Interactive.--.output.triggered.by
.'*n'.etc#0Ascbt_mbx..3#3D.-2..//.Interactive.MBX.s
tream#0Ascbt_tcp..3#3D.-3..//.Interactive.TCP/IP.st
ream#0A#0Ascb_maxnamelen.#3D.31#0A#0Ascb_id.#3D.0..
7//.id_inscb,.id_outscb.or.id_inoutscb#0Ascb_type..
9//.<#3D0.interactive.stream,.>0.block.file#0Ascb_t
ask..9//.0.or.the.task.associated.with.this.stream#0A
scb_buf..10//.0.or.the.byte.buffer.for.this.stream#0A
scb_pos..10//.position.of.next.character.to.be.tran
sferred#0Ascb_end..10//.number.of.valid.bytes.in.th
e.buffer.or.-1#0Ascb_rdfn..9//.zero.or.function.to.
replenish.the.buffer#0Ascb_wrfn..9//.zero.or.functi
on.to.deplete.the.buffer#0Ascb_endfn..8//.zero.or.f
unction.to.close.down.the.stream#0Ascb_block..8//.C
urrent.block.number.of.a.disc.file#0Ascb_write..8//
.Buf.written.to.but.not.yet.written.to.disc#0Ascb_b
ufend..7//.Size.of.buf.in.bytes#0Ascb_lblock..7//.N
umber.of.last.block.of.a.disc.file#0Ascb_ldata..8//
.Bytes.in.last.block.of.a.disc.file#0Ascb_blength..
6//.Length.of.a.disc.block.in.bytes.(typically.4096
)#0Ascb_reclen..7//.Record.length.in.bytes.for.some
.files#0Ascb_fd..11//.File.or.mailbox.descriptor.MR
.18/4/02#0Ascb_timeout..6//.The.stream.timeout.valu
e.in.milli-seconds.MR.26/3/02#0A..17//.#3D.0..means
.no.time.out.is.to.be.applied#0A..17//.#3D-1..only.
transfer.data.that.is.immediately.possible#0Ascb_ti
meoutact..3//.Action.if.a.timeout.occurs#0A..17//.#3D
.0..Try.the.operation.again#0A..17//.#3D-1..Abort.t
he.operation#0A..17//.#3D-2..Return.timeoutch#0Ascb
_encoding..5//.Unicode.encoding:.UTF8.(#3D-1).or.GB
2312.(#3D-2),#0A..17//.used.by.uniwrch#2E#0Ascb_nam
e..9//.Pointer.to.name.of.stream,.see.below#0A#0Asc
b_namee1nd.#3D.scb_name.+.scb_maxnamelen/bytesperwo
rd#0A..17//.Last.word.of.space.for.name#0A#0Ascb_si
ze#0Ascb_upb.#3D.scb_size-1#0A#0A//.Floating.point.
operations.used.in.sys(Sys_flt,.op,#2E#2E1)#0A//.32
-.or.64-bit.floating.point.will.be.used.depending.o
n#0A//.whether.32-.or.64-bit.Cintcode.is.being.used
#2E#0Afl_avail#3D0#0Afl_mk;.fl_unmk#0Afl_float;.fl_
fix;.fl_abs#0Afl_mul;.fl_div;.fl_add;.fl_sub;.fl_po
s;.fl_neg#0Afl_eq;.fl_ne;.fl_ls;.fl_gr;.fl_le;.fl_g
e#0A#0Afl_acos#3D20#0Afl_asin#0Afl_atan#0Afl_atan2#0A
fl_cos#0Afl_sin#0Afl_tan#0Afl_cosh#0Afl_sinh#0Afl_t
anh#0Afl_exp..3//#3D30#0Afl_frexp#0Afl_ldexp#0Afl_l
og#0Afl_log10#0Afl_modf#0Afl_pow#0Afl_sqrt#0Afl_cei
l#0Afl_floor#0Afl_fmod..1//#3D40#0A#0Afl_N2F#0Afl_F
2N#0Afl_radius2#0Afl_radius3#0A#0A//.Unicode.encodi
ngs#0AUTF8.#3D.-1#0AGB2312.#3D.-2#0A#0Areturn_sever
e..2#3D..00020#0Areturn_hard..4#3D..00010#0Areturn_
soft..4#3D..0015#0Areturn_ok..6#3D..0010#0Acli_modu
le_gn..2#3D..000149#0Acli_initialstack.#3D..0005002
..5//.Changed.21/5/2000001#0Acli_initialfaillevel.#3D
.return_hard#0A#0A//.cli_state.flags#0Aclibit_nopro
mpt..#3D..#23b000061..//.Don't.output.a.prompt#0Acl
ibit_eofdel..2#3D..#23b0000510..//.Delete.this.task
.if.EOF.received#0Aclibit_comcom..2#3D..#23b0000410
0..//.Currently.execution.a.command-command#0Aclibi
t_maincli..1#3D..#23b000031001..//.Executing.the.ma
in.CLI#0Aclibit_newcli..2#3D..#23b000021002..//.Exe
cuting.a.new.CLI#0Aclibit_runcli..2#3D..#23b0000110
03..//.Executing.a.CLI.invoked.by.run#0Aclibit_mbxc
li..2#3D..#23b000001004..//.Executing.an.MBX.CLI#0A
clibit_tcpcli..2#3D..#23b01005..//.Execution.a.TCP.
CLI#0Aclibit_endcli..2#3D..#23b1006..//.endcli.has.
been.executed.on.this.CLI#0A#0A1notinuse#09#3D.-1#0A
#0A//.standard.packet.offsets#0A#0Apkt_link.#3D..00
00#0Apkt_id..1#3D..0001;.pkt_devid.#3D..0001;.pkt_d
evtaskid.#3D.1;.pkt_taskid.#3D.1#0Apkt_type.#3D..00
02;.pkt_op..2#3D..0002#0Apkt_res1.#3D..0003;.pkt_r1
..2#3D..0003#0Apkt_res2.#3D..0004;.pkt_r2..2#3D..00
04#0Apkt_arg1.#3D..0005;.pkt_a1..2#3D..0005#0Apkt_a
rg2.#3D..0006;.pkt_a2..2#3D..0006#0Apkt_arg3.#3D..0
007;.pkt_a3..2#3D..0007#0Apkt_arg4.#3D..0008;.pkt_a
4..2#3D..0008#0Apkt_arg5.#3D..0009;.pkt_a5..2#3D..0
009#0Apkt_arg6.#3D.10;.pkt_a6..2#3D.10#0A#0A//.TCB.
offsets#0A#0Atcb_link#09#3D..0000#0Atcb_taskid#09#3D
..0001#0Atcb_pri#09#09#3D..0002#0Atcb_wkq#09#09#3D.
.0003#0Atcb_state#09#3D..0004#0Atcb_flags#09#3D..00
05#0Atcb_stsiz#09#3D..0006#0Atcb_seglist#09#3D..000
7#0Atcb_gbase#09#3D..0008#0Atcb_sbase#09#3D..0009#0A
tcb_active#09#3D.10.//.TRUE.if.the.task.is.fully.ac
tivated#0A#0Atcb_regs..6#3D.11#0Atcb_a..9#3D.tcb_re
gs#0Atcb_b..9#3D.12#0Atcb_c..9#3D.13#0Atcb_p..9#3D.
14#0Atcb_g..9#3D.15#0Atcb_st..8#3D.16#0Atcb_pc..8#3D
.17#0Atcb_count..5#3D.18#0A#0Atcb_namebase..2#3D.19
.//.Space.for.upto.15.chars.of.task.name#0A#0Atcb_u
pb.#3D.tcb_namebase.+.15/bytesperword.+.1#0A#0A//.T
he.DCB.structure#0ADcb_type..2#3D..0000..1//.Device
.type:.clk,.ttyin,.ttyout,.fileop,.tcpdev,.etc#0ADc
b_devid..1#3D..0001..1//.The.device.id.(<0)#0ADcb_w
kq..3#3D..0002..1//.The.device.work.queue#0ADcb_op.
.4#3D..0003..1//.op..set.by.devcommand#0ADcb_arg..3
#3D..0004..1//.arg.set.by.devcommand#0ADcb_threadp.
#3D..0005..1//.M/C.address.of.location.holding.the.
thread.id#0ADcb_cvp..3#3D..0006..1//.M/C.address.of
.its.condition.variable#2E.It.is#0A..17//.signalled
.when.the.wkq.has.another.packet.for#0A..17//.the.d
evice.to.process.and.flag.is.set.to.zero#2E#0A..17/
/.This.is.used.with.irq_mutex.#0ADcb_intson..#3D..0
007..1//.TRUE.if.the.device.may.generate.interrupts
#0ADcb_irq..3#3D..0008..1//.TRUE.if.the.device.has.
a.packet.to.return#0ADcb_flag..2#3D..0009..1//.#3D1
.if.the.device.has.requested.and.interrupt#0A..17//
.#3D0.after.the.interrupt.request.has.been.removed.
from#0A..17//.the.fifo.and.the.corresponding.pkt.de
queued.from.the#0A..17//.wkq#2E.This.field.is.prote
cted.by.irq_mutex#0ADcb_var0..2#3D.10..1//.Variable
s.(currently.not).used.by.some.devices#0ADcb_var1..
2#3D.11#0ADcb_var2..2#3D.12#0ADcb_var3..2#3D.13#0AD
cb_var4..2#3D.14#0ADcb_upb#0A#0A//.Device.types#0AD
evt_clk..3#3D.1#0ADevt_ttyin..1#3D.2#0ADevt_ttyout.
.#3D.3#0ADevt_fileop..#3D.4#0ADevt_tcpdev..#3D.5#0A
#0A//.Device.commands#0ADevc_create..2#3D.1#0ADevc_
destroy..1#3D.2#0ADevc_start..3#3D.3#0ADevc_stop..4
#3D.4#0ADevc_setintson.#3D.5#0A#0A//.Standard.task.
numbers#0ATask_cli..10#3D..0031#0ATask_debug..8#3D.
.0032#0ATask_consolehandler.#3D..0033#0ATask_fileha
ndler..2#3D..0034#0ATask_mbxhandler..3#3D..0035#0AT
ask_tcphandler..3#3D..0036#0A#0A//.Scheduling.state
s.and.flags#0AState_pkt..9#3D..3#23b000011#0AState_
hold..8#3D..3#23b0000010#0AState_wait..8#3D..3#23b0
100#0AState_int..9#3D..3#23b1001#0AState_dead..8#3D
..3#23b1100000#0A#0Aflag_a..5#3D.1<<0000..14//.MR.0
5/05/10#0Aflag_b..5#3D.1<<0001..14//.Note.that.the.
bit#0Aflag_c..5#3D.1<<0002..14//.positions.have.cha
nged#0Aflag_d..5#3D.1<<0003#0Aflag_e..5#3D.1<<0004#0A
#0A//.Assignment.vectors#0AAss_link..#3D.0#0AAss_ta
sk..#3D.1#0AAss_dir..1#3D.2#0AAss_type..#3D.3#0AAss
_dev..1#3D.4#0AAss_name..#3D.5#0A#0Ag_grfbase.#3D.4
00.//.Number.of.the.first.global.in.the.Graphics.li
brary#0Ag_sndbase.#3D.400.//.Number.of.the.first.gl
obal.in.the.Sound.library#0Ag_sdlbase.#3D.450.//.Nu
mber.of.the.first.global.in.the.SDL.library#0Ag_glb
ase..#3D.450.//.Number.of.the.first.global.in.the.G
L.library#0Ag_extbase.#3D.950.//.Number.of.the.firs
t.global.in.the.EXT.library#0A}#0A#0A

######g/mc.h#
/*#0D#0AHeader.for.the.MC.machine.independent.dynam
ic.code.generation.package#2E#0D#0A#0D#0AMartin.Ric
hards.(c).February.2000007#0D#0A#0D#0A#0D#0AMC.code
.is.compiled.into.space.pointed.to.by.mc,.the.curre
ntly.selected#0D#0Ainstance.of.the.MC.package#2E#0D
#0A#0D#0AInitialisation#0D#0A#0D#0ALET.mcb.#3D.mcIn
it(maxfn,.isize,.dsize).#0D#0A#0D#0Amcb.is.the.cont
rol.block.for.this.instance.of.the.MC.package#2E#0D
#0A#0D#0AmcSelect(mcb).selects.mcb.as.the.current.M
C.instance#2E#0D#0A#0D#0A*/#0D#0A#0D#0AMANIFEST.{#0D
#0A//.MC.Machine.Registers#0D#0A#0D#0A..mc_a.#3D.0.
.//.MC.register.A#0D#0A..mc_b.#3D.1..//.MC.register
.B#0D#0A..mc_c.#3D.2..//.MC.register.C#0D#0A..mc_d.
#3D.3..//.MC.register.D#0D#0A..mc_e.#3D.4..//.MC.re
gister.E#0D#0A..mc_f.#3D.5..//.MC.register.F#0D#0A#0D
#0A//.MC.op.codes.and.directives#2E#0D#0A#0D#0A..mc
_add#3D1..3//..2RA.RV.RG.RM.RL.RD.RDX.RDXs.RDXsB#0D
#0A..13//.RR.AR.VR.GR.MR.LR.DR.DXR.DXsR.DXsBR#0D#0A
..13//.RK.AK.VK.GK.MK.LK.DK.DXK.DXsK.DXsBK#0D#0A..m
c_addc..4//..2RA.RV.RG.RM.RL.RD.RDX.RDXs.RDXsB#0D#0A
..13//.RR.AR.VR.GR.MR.LR.DR.DXR.DXsR.DXsBR#0D#0A..1
3//.RK.AK.VK.GK.MK.LK.DK.DXK.DXsK.DXsBK#0D#0A..mc_a
lignc..2//.K#0D#0A..mc_alignd..2//.K#0D#0A..mc_and.
.5//..2RA.RV.RG.RM.RL.RD.RDX.RDXs.RDXsB#0D#0A..13//
.RR.AR.VR.GR.MR.LR.DR.DXR.DXsR.DXsBR#0D#0A..13//.RK
.AK.VK.GK.MK.LK.DK.DXK.DXsK.DXsBK#0D#0A..mc_call..4
//.KK#0D#0A..mc_cdq..5//.F#0D#0A..mc_cmp..5//..2RA.
RV.RG.RM.RL.RD.RDX.RDXs.RDXsB#0D#0A..13//.RR.AR.VR.
GR.MR.LR.DR.DXR.DXsR.DXsBR#0D#0A..13//.RK.AK.VK.GK.
MK.LK.DK.DXK.DXsK.DXsBK#0D#0A..mc_datab..3//.K#0D#0A
..mc_datak..3//.K#0D#0A..mc_datal..3//.L#0D#0A..mc_
debug..3//.K#0D#0A..mc_dec..5//..2R..A..V..G..M..L.
.D..DX..DXs..DXsB#0D#0A..mc_div..5//.K..R..A..V..G.
.M..L..D..DX..DXs..DXsB#0D#0A..mc_dlab..4//.L#0D#0A
..mc_end..5//.F#0D#0A..mc_endfn..3//.F#0D#0A..mc_en
try..3//.KK1#0D#0A..mc_inc..5//..2R..A..V..G..M..L.
.D..DX..DXs..DXsB#0D#0A..mc_jeq..5//.JS.JL.JR#0D#0A
..mc_jge..5//.JS.JL.JR#0D#0A..mc_jgt..5//.JS.JL.JR#0D
#0A..mc_jle..5//.JS.JL.JR#0D#0A..mc_jlt..5//.JS.JL.
JR#0D#0A..mc_jmp..5//.JS.JL.JR#0D#0A..mc_jne..5//.J
S.JL.JR#0D#0A..mc_lab..5//.L#0D#0A..mc_lea..5//..2R
A.RV.RG.RM.RL.RD.RDX.RDXs.RDXsB#0D#0A..mc_lsh..5//.
RK.RR#0D#0A..mc_mul..5//.K..R..A..V..G..M..L..D..DX
..DXs..DXsB#0D#0A..mc_mv..6//..2RA.RV.RG.RM.RL.RD.R
DX.RDXs.RDXsB#0D#0A..13//.RR.AR.VR.GR.MR.LR.DR.DXR.
DXsR.DXsBR#0D#0A..13//.RK.AK.VK.GK.MK.LK.DK.DXK.DXs
K.DXsBK#0D#0A..mc_mvsxb..3//..2RA.RV.RG.RM.RL.RD.RD
X.RDXs.RDXsB#0D#0A..13//.RR.AR.VR.GR.MR.LR.DR.DXR.D
XsR.DXsBR#0D#0A..mc_mvsxh..3//..2RA.RV.RG.RM.RL.RD.
RDX.RDXs.RDXsB#0D#0A..13//.RR.AR.VR.GR.MR.LR.DR.DXR
.DXsR.DXsBR#0D#0A..mc_mvb..5//..2AR.VR.GR.MR.LR.DR.
DXR.DXsR.DXsBR#0D#0A..13//..2AK.VK.GK.MK.LK.DK.DXK.
DXsK.DXsBK#0D#0A..mc_mvh..5//..2AR.VR.GR.MR.LR.DR.D
XR.DXsR.DXsBR#0D#0A..13//..2AK.VK.GK.MK.LK.DK.DXK.D
XsK.DXsBK#0D#0A..mc_mvzxb..3//..2RA.RV.RG.RM.RL.RD.
RDX.RDXs.RDXsB#0D#0A..13//.RR.AR.VR.GR.MR.LR.DR.DXR
.DXsR.DXsBR#0D#0A..mc_mvzxh..3//..2RA.RV.RG.RM.RL.R
D.RDX.RDXs.RDXsB#0D#0A..13//.RR.AR.VR.GR.MR.LR.DR.D
XR.DXsR.DXsBR#0D#0A..mc_neg..5//..2R..A..V..G..M..L
..D..DX..DXs..DXsB#0D#0A..mc_nop..5//..F#0D#0A..mc_
not..5//..2R..A..V..G..M..L..D..DX..DXs..DXsB#0D#0A
..mc_or..6//..2RA.RV.RG.RM.RL.RD.RDX.RDXs.RDXsB#0D#0A
..13//.RR.AR.VR.GR.MR.LR.DR.DXR.DXsR.DXsBR#0D#0A..1
3//.RK.AK.VK.GK.MK.LK.DK.DXK.DXsK.DXsBK#0D#0A..mc_p
op..5//..2R..A..V..G..M..L..D..DX..DXs..DXsB#0D#0A.
.mc_push..4//.K..R..A..V..G..M..L..D..DX..DXs..DXsB
#0D#0A..mc_rsh..5//.RK..RR#0D#0A..mc_rtn..5//.K#0D#0A
..mc_seq..5//..2R#0D#0A..mc_sge..5//..2R#0D#0A..mc_
sge..5//..2R#0D#0A..mc_sgt..5//..2R#0D#0A..mc_sle..
5//..2R#0D#0A..mc_slt..5//..2R#0D#0A..mc_sne..5//..
2R#0D#0A..mc_sub..5//..2RA.RV.RG.RM.RL.RD.RDX.RDXs.
RDXsB#0D#0A..13//.RR.AR.VR.GR.MR.LR.DR.DXR.DXsR.DXs
BR#0D#0A..13//.RK.AK.VK.GK.MK.LK.DK.DXK.DXsK.DXsBK#0D
#0A..mc_subc..4//..2RA.RV.RG.RM.RL.RD.RDX.RDXs.RDXs
B#0D#0A..13//.RR.AR.VR.GR.MR.LR.DR.DXR.DXsR.DXsBR#0D
#0A..13//.RK.AK.VK.GK.MK.LK.DK.DXK.DXsK.DXsBK#0D#0A
..mc_udiv..4//.K..R..A..V..G..M..L..D..DX..DXs..DXs
B#0D#0A..mc_ujge..4//.JS.JL.JR#0D#0A..mc_ujgt..4//.
JS.JL.JR#0D#0A..mc_ujle..4//.JS.JL.JR#0D#0A..mc_ujl
t..4//.JS.JL.JR#0D#0A..mc_umul..4//.K..R..A..V..G..
M..L..D..DX..DXs..DXsB#0D#0A..mc_usge..4//.JS.JL.JR
#0D#0A..mc_usgt..4//.JS.JL.JR#0D#0A..mc_usle..4//.J
S.JL.JR#0D#0A..mc_uslt..4//.JS.JL.JR#0D#0A..mc_xchg
..4//.RR.RA.RV.RG.RM.RL.RD.RDX.RDXs.RDXsB#0D#0A..mc
_xor..5//..2RA.RV.RG.RM.RL.RD.RDX.RDXs.RDXsB#0D#0A.
.13//.RR.AR.VR.GR.MR.LR.DR.DXR.DXsR.DXsBR#0D#0A..13
//.RK.AK.VK.GK.MK.LK.DK.DXK.DXsK.DXsBK#0D#0A}#0D#0A
#0D#0A#0D#0AGLOBAL.{#0D#0A..mc:800..5//.The.current
ly.selected.mc.control.block#0D#0A#0D#0A..mcInit..5
//.mcb.:#3D.mcInit(maxfno,.csize,.dsize)#0D#0A#0D#0A
..mcSelect..3//.Select.and.instance.of.the.MC.packa
ge#0D#0A#0D#0A..mcCall..5//.Call.an.assembled.funct
ion#0D#0A#0D#0A..mcClose..4//.Close.the.current.MC.
instant#0D#0A..mcPRF..6//.Print.a.formatted.message
#0D#0A#0D#0A..mcNextlab..2//.Returns.next.available
.label#0D#0A..mcComment..2//.Write.a.comment,.if.mc
Debug>#3D1#0D#0A#0D#0A..mcDatap..4//.Returns.the.va
lue.of.datap#0D#0A..mcCodep..4//.Returns.the.value.
of.codep#0D#0A#0D#0A//.Generator.functions.for.the.
abstract.machine#0D#0A//.directives.and.instruction
s#2E#0D#0A#0D#0A..mcF..3//.cdq.end.endfn.nop.rtn#0D
#0A#0D#0A..mcK..3//.alignc.alignd.datab.datak.debug
.push#0D#0A..mcR..3//.div.jmp.mul.neg.not.pop.push.
udiv.umul#0D#0A..8//.seq.sne.slt.sle.sgt.sge.uslt.u
sle.usgt.usge#0D#0A..mcA..3//.div.jmp.mul.neg.not.p
op.push.udiv.umul#0D#0A..8//.seq.sne.slt.sle.sgt.sg
e.uslt.usle.usgt.usge#0D#0A..mcV..3//.div.jmp.mul.n
eg.not.pop.push.udiv.umul#0D#0A..8//.seq.sne.slt.sl
e.sgt.sge.uslt.usle.usgt.usge#0D#0A..mcG..3//.div.j
mp.mul.neg.not.pop.push.udiv.umul#0D#0A..8//.seq.sn
e.slt.sle.sgt.sge.uslt.usle.usgt.usge#0D#0A..mcM..3
//.div.jmp.mul.neg.not.pop.push.udiv.umul#0D#0A..8/
/.seq.sne.slt.sle.sgt.sge.uslt.usle.usgt.usge#0D#0A
..mcL..3//.datal.dlab.lab#0D#0A..8//.div.jmp.mul.ne
g.not.pop.push.udiv.umul#0D#0A..8//.seq.sne.slt.sle
.sgt.sge.uslt.usle.usgt.usge#0D#0A..mcD..3//.div.jm
p.mul.neg.not.pop.push.udiv.umul#0D#0A..8//.seq.sne
.slt.sle.sgt.sge.uslt.usle.usgt.usge#0D#0A..mcDX..1
//.div.jmp.mul.neg.not.pop.push.udiv.umul#0D#0A..8/
/.seq.sne.slt.sle.sgt.sge.uslt.usle.usgt.usge#0D#0A
..mcDXs..1//.div.jmp.mul.neg.not.pop.push.udiv.umul
#0D#0A..8//.seq.sne.slt.sle.sgt.sge.uslt.usle.usgt.
usge#0D#0A..mcDXsB..//.div.jmp.mul.neg.not.pop.push
.udiv.umul#0D#0A..8//.seq.sne.slt.sle.sgt.sge.uslt.
usle.usgt.usge#0D#0A#0D#0A..mcJS..2//.Jump.with.8-b
it.relative.address.as.default#0D#0A..8//.jmp.jeq.j
ne.jlt.jle.jgt.jge.ujlt.ujle.ujgt.ujge#0D#0A..mcJL.
.2//.Jump.with.32-bit.relative.address.as.default#0D
#0A..8//.jmp.jeq.jne.jlt.jle.jgt.jge.ujlt.ujle.ujgt
.ujge#0D#0A..mcJR..2//.Jump.with.target.in.a.regist
er#0D#0A..8//.jmp.jeq.jne.jlt.jle.jgt.jge.ujlt.ujle
.ujgt.ujge#0D#0A#0D#0A..mcRA..2//.add.and.cmp.lea.l
sh.mv.mvsxb.mvsxh.mvzxb.mzxh.rsh.or.sub.xor#0D#0A..
mcRV..2//.add.and.cmp.lea.lsh.mv.mvsxb.mvsxh.mvzxb.
mzxh.rsh.or.sub.xor#0D#0A..mcRG..2//.add.and.cmp.le
a.lsh.mv.mvsxb.mvsxh.mvzxb.mzxh.rsh.or.sub.xor#0D#0A
..mcRM..2//.add.and.cmp.lea.lsh.mv.mvsxb.mvsxh.mvzx
b.mzxh.rsh.or.sub.xor#0D#0A..mcRL..2//.add.and.cmp.
lea.lsh.mv.mvsxb.mvsxh.mvzxb.mzxh.rsh.or.sub.xor#0D
#0A..mcRD..2//.add.and.cmp.lea.lsh.mv.mvsxb.mvsxh.m
vzxb.mzxh.rsh.or.sub.xor#0D#0A..mcRDX..1//.add.and.
cmp.lea.lsh.mv.mvsxb.mvsxh.mvzxb.mzxh.rsh.or.sub.xo
r#0D#0A..mcRDXs..//.add.and.cmp.lea.lsh.mv.mvsxb.mv
sxh.mvzxb.mzxh.rsh.or.sub.xor#0D#0A..mcRDXsB.//.add
.and.cmp.lea.lsh.mv.mvsxb.mvsxh.mvzxb.mzxh.rsh.or.s
ub.xor#0D#0A#0D#0A..mcRR..2//.add.and.cmp.lsh.mv.mv
sxb.mvsxh.mvzxb.mzxh.rsh.or.sub.xor#0D#0A..mcAR..2/
/.add.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A..mcVR..2/
/.add.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A..mcGR..2/
/.add.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A..mcMR..2/
/.add.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A..mcLR..2/
/.add.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A..mcDR..2/
/.add.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A..mcDXR..1
//.add.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A..mcDXsR.
.//.add.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A..mcDXsB
R.//.add.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A#0D#0A.
.mcRK..2//.add.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A.
.mcAK..2//.add.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A.
.mcVK..2//.add.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A.
.mcGK..2//.add.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A.
.mcMK..2//.add.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A.
.mcLK..2//.add.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A.
.mcDK..2//.add.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A.
.mcDXK..1//.add.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A
..mcDXsK..//.add.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A
..mcDXsBK.//.add.and.cmp.lsh.mv.rsh.or.sub.xor#0D#0A
#0D#0A..mcKK..2//.call..1--.fno.and.number.of.args.
pushed#0D#0A..mcKK1..1//.entry..--.fno,.number.of.a
rgs,.number.of.locals#0D#0A}#0D#0A

######g/sial.h#
MANIFEST.{..1//.sial.opcodes.and.directives#0Af_1#3D
..0041..//.Used.in.the.run.length.encoding.scheme#0A
f_2#3D..0042..//.in.compacted.sial#0A#0Af_lp#3D..00
33#0Af_lg#3D..0034#0Af_ll#3D..0035#0A#0Af_llp#3D..0
026#0Af_llg#3D..0027#0Af_ll1#3D..0028#0Af_lf#3D..00
39#0Af_lw#3D..00210#0A#0Af_l#3D..00411#0Af_lm#3D..0
0312#0A#0Af_sp#3D..00313#0Af_sg#3D..00314#0Af_sl#3D
..00315#0A#0Af_ap#3D..00316#0Af_ag#3D..00317#0Af_a#3D
..00418#0Af_s#3D..00419#0A#0Af_lkp#3D..00220#0Af_lk
g#3D..00221#0Af_rv#3D..00322#0Af_rvp#3D..00223#0Af_
rvk#3D..00224#0Af_st#3D..00325#0Af_stp#3D..00226#0A
f_stk#3D..00227#0Af_stkp#3D..00128#0Af_skg#3D..0022
9#0Af_xst#3D..00230#0A#0Af_k#3D..00431#0Af_kpg#3D..
00232#0A#0Af_neg#3D..00233#0Af_not#3D..00234#0Af_ab
s#3D..00235#0A#0Af_xdiv#3D..00136#0Af_xrem#3D..0013
7#0Af_xsub#3D..00138#0A#0Af_mul#3D..00239#0Af_div#3D
..00240#0Af_rem#3D..00241#0Af_add#3D..00242#0Af_sub
#3D..00243#0A#0Af_eq#3D..00344#0Af_ne#3D..00345#0Af
_ls#3D..00346#0Af_gr#3D..00347#0Af_le#3D..00348#0Af
_ge#3D..00349#0Af_eq0#3D..00250#0Af_ne0#3D..00251#0A
f_ls0#3D..00252#0Af_gr0#3D..00253#0Af_le0#3D..00254
#0Af_ge0#3D..00255#0A#0Af_lsh#3D..00256#0Af_rsh#3D.
.00257#0Af_and#3D..00258#0Af_or#3D..00359#0Af_xor#3D
..00260#0Af_eqv#3D..00261#0A#0Af_gbyt#3D..00162#0Af
_xgbyt#3D..00063#0Af_pbyt#3D..00164#0Af_xpbyt#3D..0
0065#0A#0Af_swb#3D..00266#0Af_swl#3D..00267#0A#0Af_
xch#3D..00268#0Af_atb#3D..00269#0Af_atc#3D..00270#0A
f_bta#3D..00271#0Af_btc#3D..00272#0Af_atblp#3D..000
73#0Af_atblg#3D..00074#0Af_atbl#3D..00175#0A#0Af_j#3D
..00476#0Af_rtn#3D..00277#0Af_goto#3D..00178#0A#0Af
_ikp#3D..00279#0Af_ikg#3D..00280#0Af_ikl#3D..00281#0A
f_ip#3D..00382#0Af_ig#3D..00383#0Af_il#3D..00384#0A
#0Af_jeq#3D..00285#0Af_jne#3D..00286#0Af_jls#3D..00
287#0Af_jgr#3D..00288#0Af_jle#3D..00289#0Af_jge#3D.
.00290#0A#0Af_jeq0#3D..00191#0Af_jne0#3D..00192#0Af
_jls0#3D..00193#0Af_jgr0#3D..00194#0Af_jle0#3D..001
95#0Af_jge0#3D..00196#0Af_jge0m#3D..00097#0A#0Af_br
k#3D..00298#0Af_nop#3D..00299#0Af_chgco#3D..000100#0A
f_mdiv#3D..001101#0Af_sys#3D..002102#0A#0Af_section
#3D..000103#0Af_modstart#3D.104#0Af_modend#3D..0011
05#0Af_global#3D..001106#0Af_string#3D..001107#0Af_
const#3D..002108#0Af_static#3D..001109#0Af_mlab#3D.
.003110000#0Af_lab#3D..004111#0Af_lstr#3D..00311000
2#0Af_entry#3D..002110003#0A#0Af_float#3D..00211000
4#0Af_fix#3D..004110005#0Af_fabs#3D..003110006#0Af_
fmul#3D..003110007#0Af_fdiv#3D..003110008#0Af_fxdiv
#3D..002110009#0Af_fadd#3D..003120#0Af_fsub#3D..003
121#0Af_fxsub#3D..002122#0Af_fneg#3D..003123#0A#0Af
_feq#3D..004124#0Af_fne#3D..004125#0Af_fls#3D..0041
26#0Af_fgr#3D..004127#0Af_fle#3D..004128#0Af_fge#3D
..004129#0A#0Af_feq0#3D..003130#0Af_fne0#3D..003131
#0Af_fls0#3D..003132#0Af_fgr0#3D..003133#0Af_fle0#3D
..003134#0Af_fge0#3D..003135#0A#0Af_jfeq#3D..003136
#0Af_jfne#3D..003137#0Af_jfls#3D..003138#0Af_jfgr#3D
..003139#0Af_jfle#3D..003140#0Af_jfge#3D..003141#0A
#0Af_jfeq0#3D..002142#0Af_jfne0#3D..002143#0Af_jfls
0#3D..002144#0Af_jfgr0#3D..002145#0Af_jfle0#3D..002
146#0Af_jfge0#3D..002147#0A#0Af_res#3D..004148#0Af_
ldres#3D..002149#0A}#0A

######b#
#23!/home/mr/distribution/BCPL/cintcode/cintsys.-s#0A
#2Ek.file/a,opt#0Aecho."bcpl.<file>#2Eb.to.<file>.h
drs.BCPLHDRS.t32.<opt>"#0Abcpl.<file>#2Eb.to.<file>
.hdrs.BCPLHDRS.t32.<opt>#0A

######b64#
#23!/home/mr/distribution/BCPL/cintcode/cintsys.-s#0A
#2Ek.file/a,opt#0Aecho."bcpl.<file>#2Eb.to.<file>.h
drs.BCPLHDRS.t64.<opt>"#0Abcpl.<file>#2Eb.to.<file>
.hdrs.BCPLHDRS.t64.<opt>#0A

######bc#
#23!/home/mr/distribution/BCPL/cintcode/cintsys.-s#0A
#2Ek.file/a,arg#0Aecho."bcpl.com/<file>#2Eb.to.cin/
<file>.hdrs.BCPLHDRS.t32.<arg>"#0Abcpl.com/<file>#2E
b.to.cin/<file>.hdrs.BCPLHDRS.t32.<arg>#0A#0A

######bc64#
#23!/home/mr/distribution/BCPL/cintcode/cintsys.-s#0A
#2Ek.file/a,arg#0Aecho."bcpl.com/<file>#2Eb.to.cin6
4/<file>.hdrs.BCPLHDRS.t64.<arg>"#0Abcpl.com/<file>
#2Eb.to.cin64/<file>.hdrs.BCPLHDRS.t64.<arg>#0A#0A

######bcb#
#23!/home/mr/distribution/BCPL/cintcode/cintsys.-s#0A
#2Ek.file/a,arg#0Aecho."bcpl.com/<file>#2Eb.to.ende
rbig/<file>.hdrs.BCPLHDRS.oender.t32.<arg>"#0Abcpl.
com/<file>#2Eb.to.enderbig/<file>.hdrs.BCPLHDRS.oen
der.t32.<arg>#0A

######bcb64#
#23!/home/mr/distribution/BCPL/cintcode/cintsys.-s#0A
#2Ek.file/a,arg#0Aecho."bcpl.com/<file>#2Eb.to.ende
rbig64/<file>.hdrs.BCPLHDRS.oender.t64.<arg>"#0Abcp
l.com/<file>#2Eb.to.enderbig64/<file>.hdrs.BCPLHDRS
.oender.t64.<arg>#0A

######bcl#
#23!/home/mr/distribution/BCPL/cintcode/cintsys.-s#0A
#2Ek.file/a,arg#0Aecho."bcpl.com/<file>#2Eb.to.ende
rlit/<file>.hdrs.BCPLHDRS.t32.<arg>"#0Abcpl.com/<fi
le>#2Eb.to.enderlit/<file>.hdrs.BCPLHDRS.t32.<arg>#0A


######bcl64#
#23!/home/mr/distribution/BCPL/cintcode/cintsys.-s#0A
#2Ek.file/a,arg#0Aecho."bcpl.com/<file>#2Eb.to.ende
rlit64/<file>.hdrs.BCPLHDRS.t64.<arg>"#0Abcpl.com/<
file>#2Eb.to.enderlit64/<file>.hdrs.BCPLHDRS.t64.<a
rg>#0A

######bmakefile#
xref#0A<<#0Adelete.-f.rawxref#0Ac.compall."ver.rawx
ref.xref"#0Asortxref.rawxref.to.xrefdata#0Adelete.r
awxref#0A>>#0A#0Axplaymus.<#3D.com/playmus#2Eb.g/pl
aymus#2Eh#0A<<#0Adelete.-f.rawxref#0Ac.bc.playmus."
ver.rawxref.xref"#0Asortxref.rawxref.to.xplaymus#0A
delete.rawxref#0A>>#0A#0A1%.xcdecode.all.the.compre
ssed.source.files.in.posxfiles#0A#0Adecodeall#0A<<#0A
xcdecode.bin.sysxfiles/cintsys#2Exc1#0A>>#0A

######bs#
#23!/home/mr/distribution/BCPL/cintcode/cintsys.-s#0A
#2Ek.file/a,arg#0Aecho."bcpl.sysb/<file>#2Eb.to.cin
/syscin/<file>.hdrs.BCPLHDRS.t32.<arg>"#0Abcpl.sysb
/<file>#2Eb.to.cin/syscin/<file>.hdrs.BCPLHDRS.t32.
<arg>#0A

######bs64#
#23!/home/mr/distribution/BCPL/cintcode/cintsys.-s#0A
#2Ek.file/a,arg#0Aecho."bcpl.sysb/<file>#2Eb.to.cin
64/syscin/<file>.hdrs.BCPLHDRS.t64.<arg>"#0Abcpl.sy
sb/<file>#2Eb.to.cin64/syscin/<file>.hdrs.BCPLHDRS.
t64.<arg>#0A

######bsb#
#23!/home/mr/distribution/BCPL/cintcode/cintsys.-s#0A
#2Ek.file/a,arg#0Aecho."bcpl.sysb/<file>#2Eb.to.end
erbig/<file>.hdrs.BCPLHDRS.oender.t32.<arg>"#0Abcpl
.sysb/<file>#2Eb.to.enderbig/<file>.hdrs.BCPLHDRS.o
ender.t32.<arg>#0A

######bsb64#
#23!/home/mr/distribution/BCPL/cintcode/cintsys.-s#0A
#2Ek.file/a,arg#0Aecho."bcpl.sysb/<file>#2Eb.to.end
erbig64/<file>.hdrs.BCPLHDRS.oender.t64.<arg>"#0Abc
pl.sysb/<file>#2Eb.to.enderbig64/<file>.hdrs.BCPLHD
RS.oender.t64.<arg>#0A

######bsl#
#23!/home/mr/distribution/BCPL/cintcode/cintsys.-s#0A
#2Ek.file/a,arg#0Aecho."bcpl.sysb/<file>#2Eb.to.end
erlit/<file>.hdrs.BCPLHDRS.t32.<arg>"#0Abcpl.sysb/<
file>#2Eb.to.enderlit/<file>.hdrs.BCPLHDRS.t32.<arg
>#0A

######bsl64#
#23!/home/mr/distribution/BCPL/cintcode/cintsys.-s#0A
#2Ek.file/a,arg#0Aecho."bcpl.sysb/<file>#2Eb.to.end
erlit64/<file>.hdrs.BCPLHDRS.t64.<arg>"#0Abcpl.sysb
/<file>#2Eb.to.enderlit64/<file>.hdrs.BCPLHDRS.t64.
<arg>#0A

######compall#
#2Ek.arg#0A#0A#23.Assume.bcpl.c.echo.and.preload.ar
e.already.compiled#0A#0A#23.preload.bcpl.c.echo#0A#0A
echo."First.compile.the.bigender.versions"#0Ac.bcb.
abort."<arg>"#0Ac.bcb.bcpl."<arg>"#0Ac.bcb.bcpl64."
<arg>"#0Ac.bsb.blib."<arg>"#0Ac.bsb.boot."<arg>"#0A
c.bcb.c."<arg>"#0Ac.bsb.cli."<arg>"#0Ac.bcb.cmpltes
t."<arg>"#0Ac.bsb.dlib."<arg>"#0Ac.bcb.echo."<arg>"
#0Ac.bcb.logout."<arg>"#0Ac.bcb.map."<arg>"#0Ac.bcb
.safebcpl."<arg>"#0Ac.bcb.sbcpl."<arg>"#0A#0A1echo.
"Now.compile.for.the.little.ender.versions"#0Ac.bcb
.abort."<arg>"#0Ac.bcb.bcpl."<arg>"#0Ac.bcb.bcpl64.
"<arg>"#0Ac.bsb.blib."<arg>"#0Ac.bsb.boot."<arg>"#0A
c.bcb.c."<arg>"#0Ac.bsb.cli."<arg>"#0Ac.bcb.cmpltes
t."<arg>"#0Ac.bsb.dlib."<arg>"#0Ac.bcb.echo."<arg>"
#0Ac.bcb.logout."<arg>"#0Ac.bcb.map."<arg>"#0Ac.bcb
.safebcpl."<arg>"#0Ac.bcb.sbcpl."<arg>"#0A#0Aecho."
Now.compile.the.system.files"#0Ac.bs.boot."<arg>"#0A
c.bs.blib."<arg>"#0Ac.bs.dlib."<arg>"#0Ac.bs.cli."<
arg>"#0A#0Aecho."Compile.the.all.the.standard.comma
nds"#0Ac.bc.abort."<arg>"#0Ac.bc.adjclock."<arg>"#0A
c.bc.append."<arg>"#0Ac.bc.bcpl."<arg>"#0Ac.bc.bcpl
int."<arg>"#0Ac.bc.bcpl64."<arg>"#0Ac.bc.bcpl2sial.
"<arg>"#0Ac.bc.bcplxref."<arg>"#0Ac.bc.bench100."<a
rg>"#0Ac.bc.bgpm."<arg>"#0Ac.bc.bin-hex."<arg>"#0Ac
.bc.bin2n."<arg>"#0Ac.bc.bin-x8."<arg>"#0Ac.bc.bmak
e."<arg>"#0A#23.c.bc.break."<arg>"#0Ac.bc.c."<arg>"
#0Ac.bc.casech."<arg>"#0Ac.bc.checksum."<arg>"#0Ac.
bc.cmpltest."<arg>"#0Ac.bc.cobench."<arg>"#0Ac.bc.c
obounce."<arg>"#0Ac.bc.compare."<arg>"#0Ac.bc.cosim
."<arg>"#0Ac.bc.cotest."<arg>"#0Ac.bc.dat."<arg>"#0A
c.bc.date."<arg>"#0Ac.bc.dcounts."<arg>"#0Ac.bc.del
ete."<arg>"#0Ac.bc.detab."<arg>"#0Ac.bc.dumpmem."<a
rg>"#0Ac.bc.dumppos."<arg>"#0Ac.bc.dumpsys."<arg>"#0A
c.bc.echo."<arg>"#0Ac.bc.edit."<arg>"#0Ac.bc.enlarg
e."<arg>"#0Ac.bc.fail."<arg>"#0Ac.bc.failat."<arg>"
#0Ac.bc.getlogname."<arg>"#0Ac.bc.graphdemo."<arg>"
#0Ac.bc.hello."<arg>"#0A#23.c.bc.help."<arg>"#0Ac.b
c.hex-bin."<arg>"#0Ac.bc.hexdump."<arg>"#0A#23.c.bc
.idvec."<arg>"#0Ac.bc.if."<arg>"#0Ac.bc.input."<arg
>"#0Ac.bc.interp."<arg>"#0Ac.bc.interpreter."<arg>"
#0Ac.bc.join."<arg>"#0Ac.bc.lab."<arg>"#0A#23.c.bc.
library."<arg>"#0Ac.bc.logout."<arg>"#0Ac.bc.makein
it."<arg>"#0Ac.bc.map."<arg>"#0Ac.bc.mcpl."<arg>"#0A
c.bc.mci386."<arg>"#0Ac.bc.mcpl2mial."<arg>"#0Ac.bc
.mial-386."<arg>"#0Ac.bc.mial-masm."<arg>"#0Ac.bc.n
lconv."<arg>"#0Ac.bc.n2bin."<arg>"#0Ac.bc.origbcpl.
"<arg>"#0Ac.bc.pal70."<arg>"#0A#23c.xbc.pal75."<arg
>"#0Ac.bc.playgraph."<arg>"#0Ac.bc.playmus."<arg>"#0A
c.bc.polltest."<arg>"#0Ac.bc.posdebug."<arg>"#0Ac.b
c.prefix."<arg>"#0Ac.bc.preload."<arg>"#0Ac.bc.prmc
ode."<arg>"#0Ac.bc.prmidi."<arg>"#0Ac.bc.procode."<
arg>"#0Ac.bc.prompt."<arg>"#0Ac.bc.quit."<arg>"#0Ac
.bc.rast2ps."<arg>"#0Ac.bc.raster."<arg>"#0Ac.bc.re
name."<arg>"#0Ac.bc.repeat."<arg>"#0Ac.bc.rl-decode
."<arg>"#0Ac.bc.rl-encode."<arg>"#0Ac.bc.sbcpl."<ar
g>"#0Ac.bc.safebcpl."<arg>"#0Ac.bc.setlogname."<arg
>"#0Ac.bc.setroot."<arg>"#0Ac.bc.shellcom."<arg>"#0A
c.bc.sial-386."<arg>"#0Ac.bc.sial-686."<arg>"#0Ac.b
c.sial-386old."<arg>"#0Ac.bc.sial-alpha."<arg>"#0Ac
.bc.sial-arm."<arg>"#0Ac.bc.sial-sasm."<arg>"#0Ac.b
c.sial-vax."<arg>"#0Ac.bc.skip."<arg>"#0Ac.bc.sortx
ref."<arg>"#0Ac.bc.stack."<arg>"#0Ac.bc.stats."<arg
>"#0Ac.bc.sysdebug."<arg>"#0Ac.bc.testext."<arg>"#0A
c.bc.testtr."<arg>"#0Ac.bc.testtime."<arg>"#0Ac.bc.
time."<arg>"#0Ac.bc.tstmuldivbits."<arg>"#0Ac.bc.ty
pe."<arg>"#0A#23.c.bc.typeflush."<arg>"#0Ac.bc.type
hex."<arg>"#0Ac.bc.unpreload."<arg>"#0Ac.bc.vecstat
s."<arg>"#0Ac.bc.vspl."<arg>"#0Ac.bc.wait."<arg>"#0A
c.bc.why."<arg>"#0Ac.bc.x8-bin."<arg>"#0Ac.bc.xbcpl
."<arg>"#0Ac.xbc.xcmpltest."<arg>"#0Ac.bc.xcdecode.
"<arg>"#0Ac.bc.xcencode."<arg>"#0Ac.bc.xdecode."<ar
g>"#0Ac.bc.xencode."<arg>"#0Ac.bc.xpal70."<arg>"#0A
#0A3

######xb#
#23!/home/mr/distribution/BCPL/cintcode/cintsys.-s#0A
#2Ek.file/a,opt#0Aecho."xbcpl.<file>#2Eb.to.<file>.
hdrs.BCPLHDRS.<opt>"#0Axbcpl.<file>#2Eb.to.<file>.h
drs.BCPLHDRS.<opt>#0A

######xbc#
#23!/home/mr/distribution/BCPL/cintcode/cintsys.-s#0A
#2Ek.file/a,arg#0Aecho."xbcpl.com/<file>#2Eb.to.cin
/<file>.hdrs.BCPLHDRS.<arg>"#0Axbcpl.com/<file>#2Eb
.to.cin/<file>.hdrs.BCPLHDRS.<arg>#0A#0A

######xbs#
#23!/home/mr/distribution/BCPL/cintcode/cintsys.-s#0A
#2Ek.file/a,arg#0Aecho."xbcpl.sysb/<file>#2Eb.to.ci
n/syscin/<file>.hdrs.BCPLHDRS.<arg>"#0Axbcpl.sysb/<
file>#2Eb.to.cin/syscin/<file>.hdrs.BCPLHDRS.<arg>#0A


######sysxfiles/bmakefile#
%.Convert.cintsys#2Exc..to.cintsys#2Exc1.on.VMS#0A#0A
1all#0A<<#0Aecho."Converting.cintsys#2Exc";.shellco
m."conv/fdl#3Dbin.cintsys#2Exc.cintsys#2Exc1"#0A>>#0A


######sysb/blib.b#
//.(c)..Copyright:..Martin.Richards..00030.April.20
14#0A#0A/*#0A09/01/14#0Ardargs.rewritten#2E#0A#0A00
029/03/10#0AChanged.the.units.of.time.to.be.msecs.i
nstead.of.the.system.dependent#0Aticks#2E.Tickspers
econd.has.been.removed.and.the.datstamp.format.chan
ged.to:#0Adatv!0.#3D.days..since.1.Jan.1970#0Adatv!
1.#3D.msecs..since.midnight#0Adatv!2.#3D.-1.to.indi
cate.that.the.new.date.and.time.format.is.being.use
d#2E#0Asys(Sys_delay,.msecs).performs.a.delay.in.ms
ecs.(not.ticks)#2E#0AThe.cli.prompt.is.now.written.
using#0Awritef(promptstring,.cputime,.taskid,.hours
,.mins,.secs,.msecs)#0ATry.the.command:.prompt."%+%
+%z2:%z2:%z2#2E%z3>."#0A#0A00001/10/07#0AModified.i
nitco.to.return.a.second.result.in.result2#0A#0A000
03/07/07#0AAdded.codewrch.to.write.extended.charact
ers.using.UTF8.or#0AGB2312#2E.Added.%#23.substituti
on.item.in.writef.to.invoke.it#2E.Note.that#0A*xU,.
*xG,.*#23hh2,.*#23#23hh6.and.*#23dd2.escapes.have.b
een.added.to#0ABCPL.string.and.character.constants#2E
#0A#0A00029/6/02#0ARenamed.IOLIB.as.DLIB.(the.syste
m.Dependent.Library)#2E.Put.system#0Aindependent.co
de.in.BLIB.and.the.rest.in.DLIB#2E#0A#0A00024/4/04#0A
Made.many.changed.to.make.BLIB.more.compatible.betw
een.Cintpos.and#0Asingle.threaded.Cintcode.BCPL#2E#0A
#0A00021/3/2000003#0AMake.instrcount(f,a,b,#2E#2E1)
.set.result2.to.result.of.f(a,b,c,#2E#2E2)#0A#0A000
10/7/2001#0AChanged.the.definition.of.mkobj.to.take
.up.to.11.initialisation#0Aarguments#2E.See.bcplpro
gs/objdemo#2Eb#0A#0A00028/2/2001#0AAdded.function.i
nstrcount(f,a,b,c,e,f,r,g,h,i,j,k)#0Awhich.returns.
the.number.of.cintcode.instructions.executed#0Awhen
.calling.f(a,b,#2E#2E1)#2E#0A#0A00030/4/1990006#0AA
dded.function.flush()#0Awith.corresponding.change.i
n.cintsys#2Ec.and.cintpos#2Ec#0A#0A0007/6/1990006#0A
Defined.mkobj(upb,.fns,.a,.b).for.use.in.object.ori
ented.programming#2E#0ASee.bcplprogs/objdemo#2Eb..(
args.a.and.b.added.30.March.1991)#2E#0A*/#0A#0ASECT
ION."BLIB"#0A#0AGET."libhdr"#0A#0ALET.stop(code,.re
ason).BE#0A{.//.Return.to.the.CLI.with.the.given.re
turn.code.and.reason#2E#0A..//.It.must.be.called.fr
om.the.command's.main.coroutine,.ie#0A..//.not.an.i
nner.coroutine#2E#0A..result2.:#3D.reason#0A..cowai
t(code)#0A}#0A#0AAND.fault(code).BE.sawritef("BLIB:
.fault:.code#3D%n*n",.code)#0A#0AAND.clihook(a1).#3D
.start(a1)#0A#0AAND.intflag().#3D.sys(Sys_intflag).
.//.Returns.TRUE.if.user.interrupt#0A#0AAND.abort(c
ode).#3D.sys(Sys_quit,.code)#0A#0AAND.level(p3).#3D
.(@p3)!-3#0A#0AAND.longjump(lev,.lab).BE.{.LET.p.#3D
.@lev.-.3;.p!0,.p!1.:#3D.lev,.lab.}#0A#0AAND.sardch
()..1#3D.sys(Sys_sardch)#0A#0AAND.sawrch(ch).#3D.sy
s(Sys_sawrch,ch)#0A#0A//.Set.the.timeout.field#0A//
.msecs>0..1The.stream.timeout.value.in.milli-second
s#0A//.msecs#3D0..1No.timeout.value.(the.default)#0A
//.msecs<0..1Only.perform.non.blocking.operations.o
n.the.stream#0A//.On.a.timeout.(on.TCP.streams)#0A/
/.act#3D.0..2Repeat.the.current.operation#0A//.act#3D
-1..2Make.timeout.have.the.effect.of.EOF#0A//.act#3D
-2..2Return.timeoutch#0AAND.settimeout(scb,.msecs,.
act).BE#0A{.scb!scb_timeout.:#3D.msecs#0A..scb!scb_
timeoutact.:#3D.act#0A}#0A#0A//.Just.set.the.timeou
tact.field#0AAND.settimeoutact(scb,.act).BE.scb!scb
_timeoutact.:#3D.act#0A#0AAND.rdch().#3D.VALOF#0A//
.Returns.the.next.byte.from.the.currently.selected.
input.stream,#0A//.but.ignores.CR#2E#0A//.If.the.bu
ffer.is.empty,.it.calls.replenish.to.attempt.to.ref
ill.it#2E#0A//.It.aborts.186.if.no.input.stream.is.
selected#2E#0A{.LET.pos.#3D.cis!scb_pos.//.Position
.of.next.byte#0A#0A..UNLESS.cis.DO.abort(186)#0A..I
F.pos<cis!scb_end.DO.{.LET.ch.#3D.cis!scb_buf%pos#0A
..24cis!scb_pos.:#3D.pos+1#0A..24IF.ch#3D'*c'.LOOP.
//.Ignore.CR#0A..24RESULTIS.ch#0A..22}#0A..//.No.by
te.available,.so.attempt.to.replenish.the.buffer#0A
..//.If.replenish.returns.FALSE,.no.chars.were.plac
ed.in.the.buffer#0A..//.and.the.reason.why.not.is.p
laced.in.result2.as.follows#0A..//..2result2.#3D.-1
..2end.of.file#0A..//..2result2.#3D.-2..2timeout#0A
..//..2result2.#3D.-3..2polling.and.no.characters.a
vailable#2E#0A..//..2result2.#3D.code..error.code#0A
..UNTIL.replenish(cis).DO#0A..{.IF.result2#3D-2.DO#0A
..2{.LET.act.#3D.cis!scb_timeoutact.//.Look.at.time
out.action#0A..4IF.act#3D-2.RESULTIS.timeoutch#0A..
4IF.act#3D-1.RESULTIS.endstreamch#0A..4LOOP..//.Try
.replenishing.again#0A..2}#0A..2RESULTIS.result2<0.
->.result2,.endstreamch#0A..}#0A..//.Successful.rep
lenishment.so.try.rdch.again#0A..//.There.will.be.a
t.least.one.character.in.the.buffer#0A}.REPEAT#0A#0A
AND.binrdch().#3D.VALOF#0A//.Same.as.rdch.but.does.
not.ignore.CR#2E#0A{.LET.pos.#3D.cis!scb_pos.//.Pos
ition.of.next.byte#0A#0A..UNLESS.cis.DO.abort(186)#0A
..IF.pos<cis!scb_end.DO.{.LET.ch.#3D.cis!scb_buf%po
s#0A..24cis!scb_pos.:#3D.pos+1#0A..24RESULTIS.ch#0A
..22}#0A..//.No.byte.available,.so.attempt.to.reple
nish.the.buffer#0A..//.If.replenish.returns.FALSE,.
no.chars.were.placed.in.the.buffer#0A..//.and.the.r
eason.why.not.is.placed.in.result2.as.follows#0A../
/..2result2.#3D.-1..2end.of.file#0A..//..2result2.#3D
.-2..2timeout#0A..//..2result2.#3D.-3..2polling.and
.no.characters.available#2E#0A..//..2result2.#3D.co
de..error.code#0A..UNTIL.replenish(cis).DO#0A..{.IF
.result2#3D-2.DO#0A..2{.LET.act.#3D.cis!scb_timeout
act.//.Look.at.timeout.action#0A..4IF.act#3D-2.RESU
LTIS.timeoutch#0A..4IF.act#3D-1.RESULTIS.endstreamc
h#0A..4LOOP..//.Try.replenishing.again#0A..2}#0A..2
RESULTIS.result2<0.->.result2,.endstreamch#0A..}#0A
..//.Successful.replenishment.so.try.rdch.again#0A.
.//.There.will.be.at.least.one.ch.in.the.buffer#0A}
.REPEAT#0A#0AAND.unrdch().#3D.VALOF#0A//.Attempt.to
.step.input.back.by.one.byte.position#2E#0A//.It.re
turns:.TRUE.if.successful,.and#0A//..11FALSE.otherw
ise#0A//.After.a.call.of.rdch().it.will.always.be.s
uccessful.at.least.once#2E#0A//.It.aborts:.186.if.n
ot.input.stream,.is.selected#2E#0A{.LET.pos.#3D.cis
!scb_pos#0A..UNLESS.cis.DO.abort(186)#0A..IF.pos<#3D
0.RESULTIS.FALSE.//.Cannot.UNRDCH.past.origin#2E#0A
..cis!scb_pos.:#3D.pos-1#0A..RESULTIS.TRUE#0A}#0A#0A
AND.wrch(ch).#3D.VALOF#0A//.wrch(ch).writes.ch.to.t
he.current.output.stream#2E#0A//.It.returns.TRUE.if
.successful,.FALSE.otherwise#0A//.It.aborts:.187.if
.no.stream.is.selected#0A//..010189.on.depletion.fa
ilure#2E#0A{.LET.pos.#3D.cos!scb_pos#0A#0A..//.If.t
he.buffer.is.full.try.to.deplete.it#2E#0A..IF.pos.>
#3D.cos!scb_bufend.DO#0A..{.UNLESS.deplete(cos).RES
ULTIS.FALSE#0A..2UNLESS.cos!scb_buf..RESULTIS.TRUE.
//.Must.be.writing.to.NIL:#0A..2pos.:#3D.cos!scb_po
s#0A..}#0A#0A..//.Pack.the.character.and.advance.po
s#2E#0A..cos!scb_buf%pos.:#3D.ch#0A..pos.:#3D.pos+1
#0A..cos!scb_pos.:#3D.pos#0A..//.Advance.end.of.val
id.data.pointer,.if.necessary#0A..IF.cos!scb_end.<.
pos.DO.cos!scb_end.:#3D.pos#0A..cos!scb_write.:#3D.
TRUE.//.Set.flag.to.indicate.the.buffer.has.changed
#2E#0A#0A..UNLESS.ch<'*s'.&.cos!scb_type<0.RESULTIS
.TRUE.//.Normal.return#0A#0A..//.The.stream.is.inte
ractive.and.ch.is.a.control.character#2E#0A#0A..IF.
ch#3D'*n'.DO..wrch('*c')..//.Fiddle.for.Cygwin#0A#0A
..//.Call.deplete.at.the.end.of.each.interactive.li
ne#2E#0A..IF.ch#3D'*n'.|.ch#3D'*p'.RESULTIS.deplete
(cos)#0A..RESULTIS.TRUE#0A}#0A#0AAND.binwrch(ch).#3D
.wrch(ch.|.256)#0A#0AAND.codewrch(code).BE#0A{.//.T
his.(misleadingly).writes.either.a.Unicode.characte
r.in#0A..//.UTF-8.format.or.a.code.in.GB2312.format
#2E#0A..//.A.special.(negative).value.to.select.the
.current.encoding#0A..//.to.be.used.on.the.currentl
y.selected.output.stream.(cos)#2E#0A#0A..IF.code<0.
DO#0A..{.//.Set.the.encoding.for.the.currently.sele
cted#0A..2//.output.stream#2E#0A..2cos!scb_encoding
.:#3D.code.//.UTF8.(#3D-1).or.GB2312.(#3D-2)#0A..2R
ETURN#0A..}#0A..//.Select.UTF8.unless.GB2312.explic
itly.specified.in.the.SCB#2E#0A..TEST.cos!scb_encod
ing#3DGB2312#0A..THEN.gb2312wrch(code)#0A..ELSE.utf
8wrch(code)#0A}#0A#0AAND.gb2312wrch(code).BE#0A{.//
.I.believe.the.encoding.is.as.follows:#0A..//.code.
#3D.0.-.127.#3D>.code#0A..//.code.#3D.xxyy..2#3D>.<
xx.+.160>.<yy.+.160>#0A..//..17eg.4566.#3D>.<45+160
>.<66+160>.or.CD.E2#0A..//.Note.that.the.row.encodi
ng.(CD).is.written.first,.followed#0A..//.by.the.co
lumn#2E#0A..TEST.code<#3D127#0A..THEN.{.wrch(code)#0A
//sawritef(".gb2312:.%x4.#3D>.%x2*n",.code,.code)#0A
..5}#0A..ELSE.{.LET.hi.#3D.code../..000100.+.160.//
.Row.encoding#0A..7LET.lo.#3D.code.MOD.100.+.160.//
.Column.encoding#0A..7wrch(hi)#0A..7wrch(lo)#0A//sa
writef(".gb2312:.%x4.#3D>.%x2.%x2*n",.code,.hi,.lo)
#0A..5}#0A}#0A#0AAND.utf8wrch(code).BE#0A{.//.Write
.a.Unicode.character.in.RTF-8.format#0A..IF.code<#3D
#23x7F.DO#0A..{.wrch(code)..17//.0xx5#0A..2RETURN#0A
..}#0A..IF.code<#3D#23x7FF.DO#0A..{.wrch(#23b110000
0_002+(code>>0006))..//.110000xx3#0A..2wrch(#23x80+
(.code..2&#23x3F))..//.10xx4#0A..2RETURN#0A..}#0A..
IF.code<#3D#23xFF2.DO#0A..{.wrch(#23b110010_002+(co
de>>00012)).//.110010xx2#0A..2wrch(#23x80+((code>>0
006)&#23x3F))..//.10xx4#0A..2wrch(#23x80+(.code..2&
#23x3F))..//.10xx4#0A..2RETURN#0A..}#0A..IF.code<#3D
#23x1F_FF2.DO#0A..{.wrch(#23b112_002+(code>>00018))
.//.110020xx1#0A..2wrch(#23x80+((code>>00012)&#23x3
F)).//.10xx4#0A..2wrch(#23x80+((code>>0006)&#23x3F)
)..//.10xx4#0A..2wrch(#23x80+(.code..2&#23x3F))..//
.10xx4#0A..2RETURN#0A..}#0A..IF.code<#3D#23x3FF_FF2
.DO#0A..{.wrch(#23b112_1001+(code>>00024)).//.11003
0xx#0A..2wrch(#23x80+((code>>00018)&#23x3F)).//.10x
x4#0A..2wrch(#23x80+((code>>00012)&#23x3F)).//.10xx
4#0A..2wrch(#23x80+((code>>0006)&#23x3F))..//.10xx4
#0A..2wrch(#23x80+(.code..2&#23x3F))..//.10xx4#0A..
2RETURN#0A..}#0A..IF.code<#3D#23x7FF1_FF2.DO#0A..{.
wrch(#23b112_1100000+(code>>00030)).//.110040x#0A..
2wrch(#23x80+((code>>00024)&#23x3F)).//.10xx4#0A..2
wrch(#23x80+((code>>00018)&#23x3F)).//.10xx4#0A..2w
rch(#23x80+((code>>00012)&#23x3F)).//.10xx4#0A..2wr
ch(#23x80+((code>>.6)&#23x3F)).//.10xx4#0A..2wrch(#23
x80+(.code..3&#23x3F)).//.10xx4#0A..2RETURN#0A..}#0A
#0A..//.Bad.Unicode.character#0A..writef("#23%x4#23
",.code)#0A}#0A#0AAND.readwords(vector,.count).#3D.
VALOF#0A//.count.is.the.number.of.words.to.read#2E#0A
{.LET.i,.lim.#3D.0,.count*bytesperword#0A..//.lim.i
s.the.number.of.bytes.still.needed#2E#0A#0A//sawrit
ef("BLIB.co#3D%n:.readwords.count#3D%n.scb#3D%n.blo
ck#3D%n.pos#3D%n*n",#0A//..8currco,.count,.cis,.cis
!scb_block,.cis!scb_pos)#0A#0A..IF.count<#3D0.RESUL
TIS.0#0A#0A..{.LET.pos.#3D.cis!scb_pos.//.Position.
of.next.byte#0A..2AND.end.#3D.cis!scb_end.//.Positi
on.past.last.byte#0A..2AND.buf.#3D.cis!scb_buf.//.B
yte.buffer.--.replenish.might.change.buf#0A#0A..2WH
ILE.pos.<.end.DO..2//.Copy.bytes.--.more.needed#0A.
.2{.//.At.least.one.byte.available.and.needed#0A..4
vector%i.:#3D.buf%pos..5//.Copy.it#0A..4i,.pos.:#3D
.i+1,.pos+1#0A..4IF.i<lim.LOOP..10//.More.byte(s).n
eeded#0A..4//.Successful.completion#0A..4cis!scb_po
s.:#3D.pos#0A..4RESULTIS.count#0A..2}#0A#0A..2cis!s
cb_pos.:#3D.pos#0A#0A..2//.No.byte.available,.so.at
tempt.to.replenish.the.buffer#0A..2UNLESS.replenish
(cis).RESULTIS.i/bytesperword#0A..2//.Successful.re
plenishment.so.copy.some.more.bytes#0A..2//.There.w
ill.be.at.least.one.byte.in.the.buffer#0A..}.REPEAT
#0A}#0A#0AAND.writewords(vector,.count).#3D.VALOF#0A
{.LET.i,.len.#3D.0,.count*bytesperword.//.Length.in
.bytes#0A#0A//sawritef("BLIB.co#3D%n:.writewords.co
unt#3D%n.scb#3D%n.block#3D%n.pos#3D%n*n",#0A//..8cu
rrco,.count,.cos,.cos!scb_block,.cos!scb_pos)#0A#0A
..IF.len<#3D0.RESULTIS.FALSE#0A#0A..{.LET.pos..2#3D
.cos!scb_pos#0A..2AND.bufend.#3D.cos!scb_bufend#0A.
.2AND.buf..2#3D.cos!scb_buf#0A#0A..2//.If.the.buffe
r.is.full.try.to.deplete.it#2E#0A..2WHILE.pos.<.buf
end.DO#0A..2{.//.There.is.a.byte.available.and.room
.in.the.buffer#0A..4buf%pos.:#3D.vector%i..2//.so.c
opy.it#0A..4i,.pos.:#3D.i+1,.pos+1#0A..4IF.i<len.LO
OP..8//.Loop.if.another.byte.available#0A#0A..4cos!
scb_pos.:#3D.pos..3//.Update.SCB.and.return.success
fully#0A..4//.Advance.end.of.valid.data,.if.necessa
ry#0A..4IF.cos!scb_end.<.pos.DO.cos!scb_end.:#3D.po
s#0A..4cos!scb_write.:#3D.TRUE..//.At.least.one.byt
e.has.been.written#0A#0A..4RESULTIS.TRUE#0A..2}#0A#0A
..2//.The.buffer.is.full.so.update.the.SCB.and.depl
ete#0A..2cos!scb_pos.:#3D.pos#0A..2//.Advance.end.o
f.valid.data,.if.necessary#0A..2IF.cos!scb_end.<.po
s.DO.cos!scb_end.:#3D.pos#0A..2IF.i>0.DO.cos!scb_wr
ite.:#3D.TRUE.//.TRUE.if.at.least.one.byte.has.been
.written#0A#0A..2UNLESS.deplete(cos).RESULTIS.FALSE
#0A..}.REPEAT#0A}#0A#0A//.get_record.returns.TRUE.i
f.successful#0A//.it.returns.FALSE.if.eof.is.encoun
tered.before.the.whole.record#0A//.has.been.read#2E
#0A//.MR.29/7/02:.First.record.of.a.file.has.record
.number.0#0AAND.get_record.(vector,.recno,.scb).#3D
.VALOF#0A{.LET.i..1#3D.0..12//.Position.of.next.byt
e.to.put.in.vector#2E#0A..LET.len.#3D.scb!scb_recle
n.//.Length.of.the.record.in.bytes#2E#0A#0A..IF.len
<#3D0.RESULTIS.FALSE.//.Fail,.no.record.length.spec
ified#2E#0A#0A//sawritef("BLIB.co#3D%n:.get_record.
recno#3D%n.reclen#3D%n.blk#3D%n.pos#3D%n.end#3D%n*n
",#0A//..1currco,.recno,.scb!scb_reclen,.scb!scb_bl
ock,.scb!scb_pos,.scb!scb_end)#0A..recordpoint(scb,
.recno)#0A#0A//sawritef("BLIB:.get_record.recno#3D%
n.reclen#3D%n.pos#3D%n.end#3D%n*n",#0A//..9recno,.s
cb!scb_reclen,.scb!scb_pos,.scb!scb_end)#0A#0A1..{.
//.Start.of.reading.loop#0A..2LET.pos.#3D.scb!scb_p
os.//.Position.of.next.byte#0A..2AND.end.#3D.scb!sc
b_end.//.Position.past.last.byte#0A..2AND.buf.#3D.s
cb!scb_buf.//.Byte.buffer.--.replenish.might.change
.buf#0A#0A..2WHILE.pos.<.end.DO..2//.Copy.bytes.--.
more.needed#0A..2{.//.At.least.one.byte.needed#0A..
4vector%i.:#3D.buf%pos#0A//sawritef("BLIB.co#3D%n:.
get_record.byte#3D%x2*n",.currco,.vector%i)#0A..4i,
.pos.:#3D.i+1,.pos+1#0A..4IF.i<len.LOOP..5//.More.b
yte(s).needed#0A..4//.Successful.completion#0A..4sc
b!scb_pos.:#3D.pos#0A//sawritef("BLIB.co#3D%n:.get_
record.recno#3D%n.len#3D%n.successful*n",#0A//..8cu
rrco,.recno,.len)#0A..4RESULTIS.TRUE#0A..2}#0A#0A..
2scb!scb_pos.:#3D.pos#0A#0A..2//.No.byte.available,
.so.attempt.to.replenish.the.buffer#0A..2UNLESS.rep
lenish(scb).DO#0A..2{#0A//sawritef("BLIB.co#3D%n:.g
et_record.recno#3D%n.len#3D%n.hit.eof.at.%n*n",#0A/
/..8currco,.recno,.len,.i)#0A..4RESULTIS.FALSE..//.
Failure.due.to.eof,.timeout,.error.etc#0A..2}#0A..2
//.Successful.replenishment.so.copy.some.more.bytes
#0A..2//.There.will.still.be.at.least.one.byte.in.t
he.buffer#0A..}.REPEAT#0A}#0A#0A//.MR.29/7/02:.The.
first.record.of.a.file.has.number.0.(not.1)#0A//.Re
turns.TRUE.if.successful#0A//.Returns.FALSE,.otherw
ise#2E#0AAND.put_record(vector,.recno,.scb).#3D.VAL
OF#0A{.LET.i,.len.#3D.0,.scb!scb_reclen#0A#0A..UNLE
SS.scb!scb_id#3Did_inoutscb.DO#0A..{.sawritef("BLIB
.co#3D%n:.put_record.id.not.inout*n",.currco)#0A..2
abort(991)#0A..2RESULTIS.FALSE#0A..}#0A#0A..IF.len<
#3D0.RESULTIS.FALSE.//.Error.--.no.record.length#0A
#0A//sawritef("BLIB:.put_record.recno#3D%n.reclen#3D
%n.blk#3D%n.pos#3D%n.end#3D%n*n",#0A//..9recno,.scb
!scb_reclen,.scb!scb_block,.scb!scb_pos,.scb!scb_en
d)#0A..UNLESS.recordpoint(scb,.recno).RESULTIS.FALS
E#0A//sawritef("BLIB:.put_record.recno#3D%n.reclen#3D
%n.blk#3D%n.pos#3D%n.end#3D%n*n",#0A//..9recno,.scb
!scb_reclen,.scb!scb_block,.scb!scb_pos,.scb!scb_en
d)#0A//abort(222)#0A..{.LET.pos..2#3D.scb!scb_pos#0A
..2AND.bufend.#3D.scb!scb_bufend#0A..2AND.buf..2#3D
.scb!scb_buf#0A#0A..2//.If.the.buffer.is.full.try.t
o.deplete.it#2E#0A..2WHILE.pos.<.bufend.DO#0A..2{./
/.There.is.a.byte.available.and.room.in.the.buffer#0A
..4buf%pos.:#3D.vector%i..2//.so.copy.it#0A..4i,.po
s.:#3D.i+1,.pos+1#0A..4scb!scb_write.:#3D.TRUE..//.
At.least.one.byte.has.been.written#0A..4IF.i<len.LO
OP..8//.Loop.if.another.byte.available#0A#0A..4scb!
scb_pos.:#3D.pos..3//.Update.SCB.and.return.success
fully#0A..4//.Advance.end.of.valid.data,.if.necessa
ry#0A..4IF.scb!scb_end.<.pos.DO.scb!scb_end.:#3D.po
s#0A//..4scb!scb_write.:#3D.TRUE.//.At.least.one.by
te.has.been.written#0A#0A..4RESULTIS.TRUE..7//.Succ
essful.completion#0A..2}#0A#0A..2//.The.buffer.is.f
ull.so.update.the.SCB.and.deplete#0A..2scb!scb_pos.
:#3D.pos#0A..2//.Advance.end.of.valid.data,.if.nece
ssary#0A..2IF.scb!scb_end.<.pos.DO.scb!scb_end.:#3D
.pos#0A//..IF.i>0.DO.scb!scb_write.:#3D.TRUE.//.if.
at.least.one.byte.has.been.written#0A#0A..2UNLESS.d
eplete(scb).RESULTIS.FALSE#0A..}.REPEAT#0A}#0A#0A//
.replenish(scb).returns:#0A//..1TRUE..14Successful.
replenishment,.at.least.one.ch.read#0A//..1FALSE.re
sult2.#3D.-1..End.of.file,.no.chars.read..3//.MR.15
/4/03#0A//..1FALSE.result2.#3D.-2..Timeout,.no.char
s.read.--.none.yet.available#0A//..1FALSE.result2.#3D
.-3..Polling,.no.chars.read.--.none.available#0A//.
.1FALSE.result2..5Error.code#0A#0AAND.replenish(scb
).#3D.VALOF#0A{.LET.rdfn.#3D.scb!scb_rdfn#0A..resul
t2.:#3D.-1#0A..//.The.condition.scb!scb_end<0.indic
ates.that.the.stream.is.exhausted#0A..UNLESS.scb!sc
b_end>#3D0.&.rdfn.&.rdfn(scb).RESULTIS.FALSE#0A..RE
SULTIS.TRUE#0A}#0A#0A//.deplete(scb).returns:#0A//.
.1TRUE..Successful.depletion,.or#0A//..1FALSE.other
wise#2E#0A//.It.aborts:.187.if.scb.is.not.a.suitabl
e.stream#2E#0A#0AAND.deplete(scb).#3D.VALOF#0A{.LET
.wrfn.#3D.scb!scb_wrfn.#0A..//.The.condition.scb!sc
b_end<0.indicates.that.the.stream.is.exhausted#0A..
UNLESS.scb!scb_end>#3D0.&.wrfn.&.wrfn(scb).RESULTIS
.FALSE#0A..RESULTIS.TRUE#0A}#0A#0AAND.findinput..2(
string)..5#3D..findstream(string,.id_inscb,..0030)#0A
#0AAND.pathfindinput(string,.path).#3D..findstream(
string,.id_inscb,..path)#0A#0AAND.findoutput..1(str
ing)..5#3D..findstream(string,.id_outscb,..0020)#0A
#0AAND.findinoutput.(string)..5#3D..findstream(stri
ng,.id_inoutscb,..0000)#0A#0AAND.findupdate..1(stri
ng)..5#3D..findstream(string,.id_inoutscb,..0000)#0A
#0AAND.findappend..1(string)..5#3D..findstream(stri
ng,.id_appendscb,.0)#0A#0AAND.selectinput(scb).BE./
/.scb#3D0.is.occasionally.used#0A{.UNLESS.scb#3D0.|
.scb!scb_id#3Did_inscb.|.scb!scb_id#3Did_inoutscb.D
O.abort(186)#0A..cis.:#3D.scb#0A}#0A#0AAND.selectou
tput(scb).BE.//.scb#3D0.is.occasionally.used#0A{.UN
LESS.scb#3D0.|#0A..7scb!scb_id#3Did_outscb.|#0A..7s
cb!scb_id#3Did_appendscb.|#0A..7scb!scb_id#3Did_ino
utscb.DO.abort(187)#0A..cos.:#3D.scb#0A}#0A#0AAND.e
ndread().BE.endstream(cis)#0A#0AAND.endwrite().BE.e
ndstream(cos)#0A#0AAND.endstream(scb).BE.TEST.scb>0
#0ATHEN.{.LET.endfn.#3D.scb!scb_endfn#0A..5LET.res2
.#3D.result2#0A//sawritef("endstream:.task.%i2.clos
ing.%s*n",.taskid,.@scb!scb_name)#0A#0A..5//.endstr
eam.now.frees.the.buffer#0A..5//.so.endfn.no.longer
.has.to#2E#0A..5IF.endfn.DO.endfn(scb)#0A..5IF.scb!
scb_buf.DO.{.#0A//sawritef("endstream:.task.%n.call
ing.freevec(%n)*n",.taskid,.scb!scb_buf)#0A..7freev
ec(scb!scb_buf);#0A..7scb!scb_buf.:#3D.0#0A..5}#0A.
.5freevec(scb)#0A..5IF.cis.#3D.scb.DO.cis.:#3D.0#0A
..5IF.cos.#3D.scb.DO.cos.:#3D.0#0A#0A..5result2.:#3D
.res2#0A..3}#0AELSE.IF.scb<0.DO.//.Safety.check#0A.
.3{.sawritef("*nBLIB:.endstream.given.negative.scb#3D
%n*n",.scb)#0A..5abort(991)#0A..3}#0A#0AAND.input()
.#3D.cis#0A#0AAND.output().#3D.cos#0A#0AAND.readn()
.#3D.VALOF#0A{.LET.sum,.ch,.neg.#3D.0,.0,.FALSE#0A#0A
..{.ch.:#3D.rdch()#0A..2IF.'0'<#3Dch<#3D'9'.BREAK#0A
..2SWITCHON.ch.INTO#0A..2{.DEFAULT:..1unrdch()#0A..
15result2.:#3D.-1#0A..15RESULTIS.0#0A..4CASE.'*s':#0A
..4CASE.'*t':#0A..4CASE.'*n':.LOOP#0A#0A..4CASE.'-'
:..neg.:#3D.TRUE#0A..4CASE.'+':..ch.:#3D.rdch()#0A.
.15BREAK#0A..2}#0A..}.REPEAT#0A#0A..WHILE.'0'<#3Dch
<#3D'9'.DO#0A..{.sum.:#3D.10.*.sum.+.ch.-.'0'#0A..2
ch.:#3D.rdch()#0A..}#0A..IF.neg.DO.sum.:#3D.-sum#0A
..unrdch()#0A..result2.:#3D.0#0A..RESULTIS.sum#0A}#0A
#0AAND.newline().BE.wrch('*n')#0A#0AAND.newpage().B
E.wrch('*p')#0A#0AAND.writed(n,.d).BE.writedz(n,.d,
.FALSE,.n<0)#0A#0AAND.writez(n,.d).BE.writedz(n,.d,
.TRUE,..n<0)#0A#0AAND.writedz(n,.d,.zeroes,.neg).BE
#0A{.LET.t.#3D.VEC.10#0A..LET.i.#3D.0#0A..LET.k.#3D
.-n#0A#0A..IF.neg.DO.{.d.:#3D.d.-.1;.k.:#3D.n.}#0A#0A
..{.t!i.:#3D.-(k.MOD.10)#0A..2k..1:#3D.k/10#0A..2i.
.1:#3D.i.+.1#0A..}.REPEATWHILE.k#0A#0A..IF.neg.&.ze
roes.DO.wrch('-')#0A..FOR.j.#3D.i+1.TO.d.DO.wrch(ze
roes.->.'0',.'*s')#0A..IF.neg.&.~zeroes.DO.wrch('-'
)#0A..FOR.j.#3D.i-1.TO.0.BY.-1.DO.wrch(t!j+'0')#0A}
#0A#0AAND.writen(n).BE.writed(n,.0)#0A#0AAND.writeh
ex(n,.d).BE.#0A{.IF.d>1.DO.writehex(n>>0004,.d-1)#0A
..wrch((n&15)!TABLE.'0','1','2','3','4','5','6','7'
,#0A..18'8','9','A','B','C','D','E','F')#0A}#0A#0AA
ND.writeoct(n,.d).BE#0A{.IF.d.>.1.DO.writeoct(n>>00
03,.d-1)#0A..wrch((n&7)+'0')#0A}#0A#0AAND.writebin(
n,.d).BE#0A{.IF.d.>.1.DO.writebin(n>>0001,.d-1)#0A.
.wrch((n&1)+'0')#0A}#0A#0AAND.writes(s).BE#0A{.UNLE
SS.0.<.s.<.rootnode!rtn_memsize.DO.s.:#3D."#23#23Ba
d.string#23#23"#0A..FOR.i.#3D.1.TO.s%0.DO.wrch(s%i)
#0A}#0A#0AAND.writet(s,.d).BE#0A{.writes(s)#0A..FOR
.i.#3D.1.TO.d-s%0.DO.wrch('*s')#0A}#0A#0AAND.writeu
(n,.d).BE#0A{.LET.m.#3D.(n>>0001)/5#0A..IF.m.DO.{.w
rited(m,.d-1);.d.:#3D.1.}#0A..writed(n-m*10,.d)#0A}
#0A#0A1/*#0A..6The.following.routines.provide.and.e
xtended.version.of.writef#2E#0AThey.support.the.fol
lowing.extra.substitution.items:#0A#0A..0061#2E.%F.
.1-.Takes.next.argument.as.a.writef.format.string.a
nd#0A..14calls.writef.recursively.using.the.remaini
ng.arguments#2E#0A..14The.argument.pointer.is.posit
ioned.to.the.next.available#0A..14argument.on.retur
n#2E#0A#0A..0062#2E.%M..1-.The.next.argument.is.tak
en.as.a.message.number.and.processed#0A..14as.for.%
F.above#2E.The.message.format.string.is.looked.up.b
y#0A..14get_text(messno,.str,.upb).where.str.is.a.v
ector.local.to#0A..14writef.to.hold.the.message.str
ing#2E.This.is.provided.to.easy#0A..14the.generatio
n.of.messages.in.different.languages#2E#0A#0A..0063
#2E.%+..1-.The.argument.pointer.is.incremented.by.1
#2E#0A#0A..0064#2E.%-..1-.The.argument.pointer.is.d
ecremented.by.1#2E#0A#0A..0065#2E.%P..1-.Plural.for
mation#2E.The.singular.form.is.use.if.and.only.if#0A
..14the.next.argument.is.one#2E.So.that.the.argumen
t.can.be.used#0A..14twice.it.is.normal.to.preceed.o
r.follow.the.%P.item.with.%-#2E#0A..14There.are.two
.forms.as.follows:#0A#0A..14a#2E.%Pc..-.The.charact
er.c.is.output.if.the.the.next.argument#0A..22not.o
ne#2E#0A#0A..14b#2E.%P\singular\plural\..-.The.appr
opriate.text.is.printed,#0A..22skipping.the.other#2E
.The.'\'.chars.are.not.printed#2E#0A#0AExample:.FOR
.count.#3D.0.TO.2.DO#0A..10writef("There.%p\is\are\
.%-%n.thing%-%ps#2E*n",.count)#0Aoutputs:#0A..7Ther
e.are.0.things#2E#0A..7There.is.1.thing#2E#0A..7The
re.are.2.things#2E#0A#0A..0066#2E.%nOp..eg.%12i.as.
an.alternative.to.%iB#0A..15where.n.is.a.decimal.nu
mber.and.Op.is.a.format.letter#0A..15expecting.a.fi
eld.width#2E.If.n.is.given.it.specifies.the#0A..15f
ield.width.otherwise.it.is.specified,.as.before,.by
.the#0A..15single.character.(0-9,.A-Z).following.Op
#2E#0A#0A..0067#2E.%n#2Emd..eg.%8#2E2d#0A..16print.
a.fixed.point.scaled.decimal.number.in.a.field#0A..
16width.of.n.with.m.digits.after.the.decimal.point#2E
.For#0A..16example.writef("%8#2E2d",.1234567).would
.output:.12345#2E67#0A..16and..3writef("%8#2E0d",.1
234567).would.output:..0001234567#0A#0A..0068#2E.%#23
..3Write.the.next.argument.using.codewrch,.ie.conve
rt.the#0A..16next.argument.to.UTF-8.format#2E#0A*/#0A
#0A//.The.following.version.of.writef.is.new.--.MR.
21/1/04#0A#0A//.get_textblib.and.get_text.have.the.
same.global.variable.number#0AAND.get_textblib(n,.s
tr,.upb).#3D.VALOF..//.Default.definition.of.get_te
xt#0A..37//.This.is.normally.overridden.#0A..37//.b
y.get_text,.defined.elsewhere#2E#0A{.LET.s.#3D."<me
ss:%-%n>"#0A..IF.upb>s%0.DO.upb.:#3D.s%0#0A..str%0.
:#3D.upb#0A..FOR.i.#3D.1.TO.upb.DO.str%i.:#3D.s%i#0A
..RESULTIS.str#0A}#0A#0AAND.writef(format,a,b,c,d,e
,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z).BE#0A{.
LET.nextarg.#3D.@a#0A..write_format(format,.@nextar
g)#0A}#0A#0AAND.sawritef(format,a,b,c,d,e,f,g,h,i,j
,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z).BE#0A{.LET.nextar
g.#3D.@a#0A..LET.wch,.rch.#3D.wrch,.rdch#0A..wrch,.
rdch.:#3D.sawrch,.sardch#0A..write_format(format,.@
nextarg)#0A..wrch,.rdch.:#3D.wch,.rch#0A}#0A#0AAND.
write_format(format,.lvnextarg).BE#0A{.//.writef.an
d.sawritef.must.preserve.result2#0A..LET.res2.#3D.r
esult2#0A#0A..UNLESS.0.<.format.<.rootnode!rtn_mems
ize.DO.format.:#3D."#23#23Bad.format#23#23"#0A#0A..
FOR.p.#3D.1.TO.format%0.DO#0A..{.LET.k,.type,.f,.n,
.m,.arg.#3D.format%p,.?,.?,.?,.?,.?#0A..2LET.widthg
iven.#3D.FALSE#0A..2UNLESS.k#3D'%'.DO.{.wrch(k);.LO
OP.}#0A#0A..2//.Deal.with.a.substitution.item#0A..2
p.:#3D.p.+.1#0A..2type,.arg,.n,.m.:#3D.format%p,.!!
lvnextarg,.0,.0#0A#0Asw:.SWITCHON.capitalch(type).I
NTO#0A..2{.DEFAULT:..2wrch(type)#0A..16LOOP#0A#0A..
4CASE.'0':CASE.'1':CASE.'2':CASE.'3':CASE.'4':#0A..
4CASE.'5':CASE.'6':CASE.'7':CASE.'8':CASE.'9':#0A..
16{.n.:#3D.10*n.+.type.-.'0'#0A..18p.:#3D.p+1#0A..1
8type.:#3D.format%p#0A..18widthgiven.:#3D.TRUE#0A..
16}.REPEATWHILE.'0'<#3Dtype<#3D'9'#0A..16IF.type#3D
'#2E'.DO#0A..16{.p.:#3D.p+1#0A..18type.:#3D.format%
p#0A..18WHILE.'0'<#3Dtype<#3D'9'.DO#0A..18{.m.:#3D.
10*m.+.type.-.'0'#0A..20p.:#3D.p+1#0A..20type.:#3D.
format%p#0A..18}#0A..16}#0A..16GOTO.sw#0A#0A..4CASE
.'D':..1IF.m.DO#0A..16{.//.Write.a.scaled.number.of
.the.form.nn1#2Enn#0A..18LET.scale.#3D.1#0A..18FOR.
i.#3D.1.TO.m.DO.scale.:#3D.scale.*.10#0A..18writedz
(arg/scale,.n-1-m,.FALSE,.arg<0)#0A..18wrch('#2E')#0A
..18writez(.ABS.arg.MOD.scale,.m)#0A..18!lvnextarg.
:#3D.!lvnextarg.+.1#0A..18LOOP#0A..16}#0A..16f.:#3D
.writed;..2GOTO.getarg#0A#0A1..4CASE.'S':..1f.:#3D.
writes;..2GOTO.noargs#0A..4CASE.'T':..1f.:#3D.write
t;..2GOTO.getarg#0A..4CASE.'C':..1f.:#3D.wrch;..4GO
TO.noargs#0A..4CASE.'#23':..1f.:#3D.codewrch;..GOTO
.noargs#0A..4CASE.'O':..1f.:#3D.writeoct;..GOTO.get
arg#0A..4CASE.'X':..1f.:#3D.writehex;..GOTO.getarg#0A
..4CASE.'I':..1f.:#3D.writed;..2GOTO.getarg#0A..4CA
SE.'N':..1f.:#3D.writen;..2GOTO.noargs#0A..4CASE.'U
':..1f.:#3D.writeu;..2GOTO.getarg#0A..4CASE.'Z':..1
f.:#3D.writez;..2GOTO.getarg#0A..4CASE.'B':..1f.:#3D
.writebin;..GOTO.getarg#0A#0A..2getarg:..5UNLESS.wi
dthgiven.DO#0A..16{.p.:#3D.p.+.1#0A..18n.:#3D.capit
alch(format%p)#0A..18n.:#3D.'0'.<#3D.n.<#3D.'9'.->.
n.-.'0',.10.+.n.-.'A'#0A..16}#0A#0A..2noargs:..5f(a
rg,.n)#0A..16!lvnextarg.:#3D.!lvnextarg.+.1#0A..16L
OOP#0A#0A..4CASE.'$':#0A..4CASE.'+':..1!lvnextarg.:
#3D.!lvnextarg.+.1#0A..16LOOP#0A#0A..4CASE.'-':..1!
lvnextarg.:#3D.!lvnextarg.-.1#0A..16LOOP#0A#0A..4CA
SE.'M':.{.LET.buf.#3D.VEC.256/bytesperword#0A..16!l
vnextarg.:#3D.!lvnextarg.+.1#0A..16UNLESS.get_text(
arg,.buf,.256/bytesperword).DO#0A..18buf.:#3D."<<me
ss:%-%n>>"..//.No.message.text#0A..16write_format(b
uf,.lvnextarg)#0A..16LOOP#0A..14}#0A#0A..4CASE.'F':
..1!lvnextarg.:#3D.!lvnextarg.+.1#0A..16write_forma
t(arg,.lvnextarg)#0A..16LOOP#0A#0A..4CASE.'P':.{.LE
T.plural.#3D.arg.~#3D.1#0A..16!lvnextarg.:#3D.!lvne
xtarg.+.1#0A..16p.:#3D.p+1#0A..16type.:#3D.format%p
#0A..16IF.type.#3D.'\'.DO#0A..16{.//.Deal.with.%P\s
ingular\plural\.item#0A..18LET.skipping.#3D.plural#0A
..18p.:#3D.p.+.1#0A..18UNTIL.p.>.format%0.DO#0A..18
{.LET.ch.#3D.format%p#0A..20TEST.ch.#3D.'\'.THEN.{.
skipping.:#3D.~skipping#0A..41IF.skipping.#3D.plura
l.BREAK#0A..39}#0A..34ELSE.UNLESS.skipping.DO.wrch(
ch)#0A..20p.:#3D.p.+.1#0A..18}#0A..18LOOP#0A..16}#0A
#0A..16//.Deal.with.simple.%Pc.items#0A..16IF.plura
l.DO.wrch(type)#0A..16LOOP#0A..14}#0A..2}.//.End.of
.SWITCHON.#2E#2E1#0A..}.//.End.of.FOR.p.#3D.#2E#2E1
#0A#0A..result2.:#3D.res2#0A}#0A#0ALET.randno(upb).
#3D.VALOF..//.return.a.random.number.in.the.range.1
.to.upb#0A{.randseed.:#3D.randseed*2147000001325.+.
715136305#0A..RESULTIS.(ABS(randseed/3)).MOD.upb.+.
1#0A}#0A#0AAND.setseed(newseed).#3D.VALOF.//.Added.
by.MR.20/01/2001#0A{.LET.oldseed.#3D.randseed#0A..r
andseed.:#3D.newseed#0A..RESULTIS.oldseed#0A}#0A#0A
//.muldiv.is.now.implemented.in.SYSLIB.using.the.MD
IV.instruction#0A//.NO.--.MDIV.sometimes.causes.a.f
loating.point.exception#0AAND.muldiv(a,.b,.c).#3D.s
ys(Sys_muldiv,.a,.b,.c)#0A#0AAND.unpackstring(s,.v)
.BE.FOR.i.#3D.s%0.TO.0.BY.-1.DO.v!i.:#3D.s%i#0A#0AA
ND.packstring(v,.s).#3D.VALOF#0A{.LET.n.#3D.v!0.&.2
55#0A..LET.size.#3D.n/bytesperword#0A..FOR.i.#3D.0.
TO.n.DO.s%i.:#3D.v!i#0A..FOR.i.#3D.n+1.TO.(size+1)*
bytesperword-1.DO.s%i.:#3D.0#0A..RESULTIS.size#0A}#0A
#0AAND.capitalch(ch).#3D.'a'.<#3D.ch.<#3D.'z'.->.ch
.+.'A'.-.'a',.ch#0A#0AAND.compch(ch1,.ch2).#3D.capi
talch(ch1).-.capitalch(ch2)#0A#0AAND.compstring(s1,
.s2).#3D.VALOF#0A{.LET.lens1,.lens2.#3D.s1%0,.s2%0#0A
..LET.smaller.#3D.lens1.<.lens2.->.s1,.s2#0A..FOR.i
.#3D.1.TO.smaller%0.DO#0A..{.LET.res.#3D.compch(s1%
i,.s2%i)#0A..2IF.res.RESULTIS.res#0A..}#0A..IF.lens
1.#3D.lens2.RESULTIS.0#0A..RESULTIS.smaller.#3D.s1.
->.-1,.1#0A}#0A#0AAND.str2numb(s).#3D.VALOF.//.Depr
ecated#0A{.LET.a.#3D.0#0A..FOR.i.#3D.1.TO.s%0.DO.{.
LET.dig.#3D.s%i.-.'0'#0A..22IF.0<#3Ddig<#3D9.DO.a.:
#3D.10*a.+.dig#0A..20}#0A..RESULTIS.s%1#3D'-'.->.-a
,.a#0A}#0A#0AAND.getkey(keys,.i,.keyword).#3D.VALOF
#0A{.LET.len.#3D.keys%0.//.Length.of.keys.string#0A
..LET.p.#3D.1..6//.Position.in.keys.string#0A..LET.
n.#3D.0..6//.For.length.of.key.word#0A#0A..//.Set.p
.to.start.of.the.keyword.for.argument.i#0A..UNTIL.p
>len.DO#0A..{.UNLESS.i.BREAK#0A..2IF.keys%p#3D','.D
O.i.:#3D.i-1#0A..2p.:#3D.p+1#0A..}#0A#0A..//.Copy.t
he.key.word.(ignoring.newlines).into.keyword#0A..WH
ILE.p.<#3D.len.DO#0A..{.LET.ch.#3D.keys%p#0A..2IF.c
h#3D'/'.|.ch#3D'#3D'.|.ch#3D','.BREAK#0A..2UNLESS.c
h#3D'*n'.DO#0A..2{.n.:#3D.n.+.1#0A..4keyword%n.:#3D
.keys%p#0A..2}#0A..2p.:#3D.p.+.1#0A..}#0A#0A..keywo
rd%0.:#3D.n#0A..RESULTIS.keyword#0A}#0A#0A/*#0Ardar
gs.provides.the.programmer.with.the.facility.to.rea
d#0Aarguments.from.the.currently.selected.input.and
.store.them.in.the#0Agiven.vector#2E#0A#0AThe.possi
ble.key.qualifiers.are:#0A#0A../a..2this.argument.i
s.required#0A../k..2argument.requires.the.keyword#0A
../s..2argument.is.a.switch#0A../n..2argument.has.t
o.be.a.number#0A../p..2prompt.will.be.displayed#0A*
/..#0A#0AAND.rdargs(keys,.argv,.size).#3D.VALOF#0A{
.MANIFEST#0A..{.a_bit.#3D..0001..10//./A#0A..2k_bit
.#3D..0002..10//./K#0A..2s_bit.#3D..0004..10//./S#0A
..2n_bit.#3D..0008..10//./N#0A..2p_bit.#3D.16..10//
./P#0A..2d_bit.#3D.32..10//.argument.defined.bit#0A
..}#0A#0A..LET.w..6#3D.0..5//.w.is.a.moving.pointer
.into.argv#0A..LET.argmax..1#3D.0#0A..LET.errflag..
#3D.FALSE..1//.Set.to.TRUE.when.an.error.is.encount
ered#0A..LET.keyword..#3D.VEC.30#0A..AND.argtype..#3D
.VEC.127.//.Space.for.argument.qualifier.bits#0A#0A
..//.A.typical.key.string.is:."FROM#3DDATA/A,TO/K/P
,VAL/K/N,T#3DTRACE/S"#0A#0A..clear_words(argv,.size
+1)#0A..clear_words(argtype,.128)#0A#0A..{.LET.coun
t.#3D.1#0A..2FOR.i.#3D.1.TO.keys%0.IF.keys%i#3D','.
DO.count.:#3D.count+1#0A..2IF.count>128.DO#0A..2{.s
awritef("Error:.rdargs.format.expects.more.than.128
.arguments*n")#0A..4RESULTIS.0#0A..2}#0A..}#0A#0A..
//.Fill.in.argument.qualified.bits#0A..FOR.p.#3D.1.
TO.keys%0.DO#0A..{.LET.kch.#3D.keys%p#0A#0A..2IF.kc
h.#3D.'/'.SWITCHON.capitalch(keys%(p+1)).INTO#0A..2
{.DEFAULT:.//.Bad.qualifier#0A..13GOTO.err#0A#0A..4
CASE.'A':.argtype!argmax.:#3D.argtype!argmax.+.a_bi
t;.ENDCASE#0A..4CASE.'K':.argtype!argmax.:#3D.argty
pe!argmax.+.k_bit;.ENDCASE#0A..4CASE.'S':.argtype!a
rgmax.:#3D.argtype!argmax.+.s_bit;.ENDCASE#0A..4CAS
E.'N':.argtype!argmax.:#3D.argtype!argmax.+.n_bit;.
ENDCASE#0A..4CASE.'P':.argtype!argmax.:#3D.argtype!
argmax.+.p_bit;.ENDCASE#0A..2}#0A#0A..2IF.kch.#3D.'
,'.DO.argmax.:#3D.argmax+1#0A..}#0A#0A..//.Check.th
at.no.argument.has.both./S.and./N.set#2E#0A..FOR.i.
#3D.0.TO.argmax.DO#0A..2IF.(argtype!i.&.(s_bit|n_bi
t)).#3D.(s_bit|n_bit).GOTO.err#0A#0A..w.:#3D.argv.+
.argmax.+.1.//.First.free.position.in.argv#0A#0A..{
.//.Main.loop#0A..2LET.argno.#3D.-1#0A..2LET.wsize.
#3D.size.-.(w.-.argv).//.Number.of.words.remaining.
in.argv#0A..2LET.itemtype.#3D.rditem(w,.wsize)#0A#0A
..2clear_words(keyword,.31).//.Clear.keyword!0.to.k
eyword!30#0A#0A..2SWITCHON.itemtype.INTO#0A..2{.DEF
AULT:.//.Unknown.item.type#0A..13GOTO.err#0A#0A..4C
ASE.0:..//.endstreamch#0A..4CASE.3:..//.newline#0A.
.4CASE.4:..//.semicolon#0A//.These.item.types.mark.
the.end.of.the.argument.list,.but.there.may#0A//.st
ill.be.prompted.input.from.the.user#2E#0A#0A..13FOR
.i.#3D.0.TO.argmax.DO#0A..13{.LET.type.#3D.argtype!
i#0A..15UNLESS.(argtype!i.&.(p_bit|d_bit))#3Dp_bit.
&#0A..22cis!scb_type.#3D.scbt_console..5&#0A..22cos
!scb_type.#3D.scbt_console..5LOOP#0A..15//.Unset.ar
gument.found.with./P.qualifier#0A..15//.and.both.in
put.and.output.are.connected.to.a.terminal#2E#0A#0A
..15//.Write.a.suitable.prompt#0A..15writes(getkey(
keys,.i,.keyword))#0A..15UNLESS.(argtype!i.&.s_bit)
.#3D.0.DO.writes(".(yes/no)")#0A..15writes(".>.")#0A
..15deplete(cos)#0A#0A..15itemtype.:#3D.rditem(w,.w
size)#0A#0A..15SWITCHON.itemtype.INTO#0A..15{.CASE.
0:.//.endstreamch#0A..25ENDCASE#0A#0A..17CASE.1:.//
.Unquoted.item#0A..25IF.(type.&.s_bit).~#3D.0.DO#0A
..25{.argv!i.:#3D.compstring(w,."yes").#3D.0#0A..27
argtype!i.:#3D.argtype!i.|.d_bit#0A..27GOTO.skip#0A
..25}#0A#0A..25IF.(type.&.n_bit).~#3D.0.DO#0A..25{.
argv!i.:#3D.w..1//.numeric#0A..27UNLESS.string_to_n
umber(w).GOTO.err#0A..27!w.:#3D.result2#0A..27argv!
i.:#3D.w#0A..27argtype!i.:#3D.argtype!i.|.d_bit#0A.
.27w..:#3D.w.+.1#0A..27GOTO.skip#0A..25}#0A#0A..17C
ASE.2:.//.Quoted.item#0A..25//.or.unquoted.item.wit
h.neither./S.or./N#0A..25argv!i.:#3D.w#0A..25argtyp
e!i.:#3D.argtype!i.|.d_bit#0A..25w.:#3D.w.+.w%0/byt
esperword.+.1#0A..25wsize.:#3D.size.-.(w.-.argv)..3
#0Askip:#0A..25unrdch()#0A..25{.LET.ch.#3D.rdch()#0A
..27IF.ch#3D'*n'.|.ch#3D';'.|.ch#3Dendstreamch.BREA
K#0A..25}.REPEAT#0A..25LOOP#0A#0A..17CASE.3:.//.new
line#0A..25//.Do.not.set.this.argument#2E#0A..25LOO
P#0A#0A..17CASE.4:.//.semicolon#0A..25ENDCASE#0A#0A
..17DEFAULT:GOTO.err#0A..15}#0A..13}.//.End.of.for-
loop#0A#0A..13//.Before.returning,.check.that.all.t
he.required#0A..13//.arguments.have.been.set#2E#0A.
.13FOR.i.#3D.0.TO.argmax.DO#0A..15IF.(argtype!i.&.(
a_bit|d_bit))#3Da_bit.GOTO.err#0A#0A..13result2.:#3D
.0#0A..13RESULTIS.w.//.Point.to.first.unused.word.i
n.argv#0A#0A..4CASE.1:..//.Unquoted.item#0A#0A..13a
rgno.:#3D.findarg(keys,.w)#0A#0A..13TEST.argno.>#3D
.0#0A..13THEN.{.//.Item.matches.a.keyword#0A#0A..20
//.Error.is.argument.already.defined#0A..20IF.(argt
ype!argno.&.d_bit).~#3D.0.GOTO.err#0A#0A..20//.Chec
k.for./S.qualifier#0A..20IF.(argtype!argno.&.s_bit)
.~#3D.0.DO#0A..20{.argv!argno.:#3D.-1.//.Set.the.sw
itch.argument#0A..22argtype!argno.:#3D.argtype!argn
o.|.d_bit#0A..22LOOP#0A..20}#0A#0A..20//.Read.the.a
rgument.value#0A..20{.LET.item.#3D.rditem(w,.wsize)
#0A#0A..22IF.item.#3D.5.DO.//.Skip.optional.'#3D'#0A
..24item.:#3D.rditem(w,.wsize)#0A#0A..22//.Check.fo
r.suitable.value#0A..22UNLESS.item#3D1.|.item#3D2.G
OTO.err#0A..20}#0A..18}#0A#0A..13ELSE.TEST.rdch().#3D
.'*n'.&.compstring("?",.w).#3D.0#0A..18THEN.{.write
f("%s:.",.keys)#0A..25deplete(cos).//.MR.13/1/03#0A
..25ENDCASE#0A..23}#0A..18ELSE.unrdch()#0A#0A//.Del
iberate.missing.'ENDCASE'#0A#0A..4CASE.2:.//.item.w
as.either.quoted.or#0A..12//.was.unquoted.but.did.n
ot.match.a.key.word#2E#0A..12//.So.it.is.a.position
al.argument#2E#0A..12//.Find.the.first.unset.argume
nt.no.having./K.or./S#0A..12IF.argno.<.0.FOR.i.#3D.
0.TO.argmax.DO#0A..14IF.(argtype!i.&.(d_bit|k_bit|s
_bit)).#3D.0.DO#0A..14{.argno.:#3D.i#0A..16BREAK#0A
..14}#0A#0A..12//.If.the.argument.did.not.match.a.k
eyword.and#0A..12//.there.are.no.more.positional.ar
guments.left#0A..12//.indicate.a.error#2E#0A..12UNL
ESS.argno>#3D0.GOTO.err#0A#0A..12//.Error.if.this.a
rgument.is.already.set#0A..12IF.(argtype!argno.&.d_
bit).~#3D.0.GOTO.err#0A#0A..12IF.(argtype!argno.&.n
_bit).~#3D.0.DO#0A..12{.UNLESS.string_to_number(w).
GOTO.err#0A..14!w.:#3D.result2#0A..14argv!argno.:#3D
.w#0A..14argtype!argno.:#3D.argtype!argno.|.d_bit#0A
..14w..:#3D.w.+.1#0A..14LOOP#0A..12}#0A#0A..12//.St
ore.an.ordinary.or.quoted.argument.value#0A..12argv
!argno.:#3D.w#0A..12argtype!argno.:#3D.argtype!argn
o.|.d_bit#0A..12w.:#3D.w.+.w%0/bytesperword.+.1#0A.
.12LOOP#0A#0A..2}.//.End.of.main.switch#0A..}.REPEA
T#0A#0Aerr:.//.An.error.was.detected.so.skip.to.the
.end.of.the.line#2E#0A..{.LET.ch.#3D.?#0A..2unrdch(
)#0A..2ch.:#3D.rdch().REPEATUNTIL.ch#3D'*n'.|#0A..2
7ch#3D';'..|#0A..27ch#3Dendstreamch#0A..2result2.:#3D
.120..//.Bad.argument.format.or.bad.arguments#0A..2
RESULTIS.0..//.Error.result#0A..}#0A}#0A#0A//.Read.
an.item.from.current.input.stream#0A#0A//.returns.-
1..2error,.input.too.long.or.unmatched.quote#0A//..
0080..2endstreamch#0A//..0081..2unquoted.item#0A//.
.0082..2quoted.item#0A//..0083..2*n#0A//..0084..2;#0A
//..0085..2#3D#0A#0A//.When.an.unquoted.item.is.rea
d.its.terminating.character.is#0A//.unrdch-ed.so.th
at.it.can.be.read.again.by.the.next.call.of.rdch#2E
#0A//.All.items.other.items,.namely.strings,.newlin
e,.';',.'#3D'.and#0A//.endstreamch,.are.self.termin
ating.and.so.do.not.need.unrdch#0A//.to.be.called#2E
#0A#0AAND.rditem(v,.upb).#3D.VALOF#0A{.LET.p,.pmax.
#3D.0,.(upb+1)*bytesperword-1#0A..//.With.bytesperw
ord#3D4#0A..//.upb#3D0.#3D>.pmax#3D3#0A..//.upb#3D1
.#3D>.pmax#3D7#0A..//.#2E#2E1#0A..LET.ch,.quoted.#3D
.rdch(),.FALSE#0A#0A..FOR.i.#3D.0.TO.upb.DO.v!i.:#3D
.0#0A#0A//sawritef("*nrditem.first.ch.#3D.'%c'*n",.
ch)#0A#0A..//.Skip.over.white.space#2E#0A..WHILE.ch
#3D'*s'.|.ch#3D'*t'.|.ch#3D'*c'DO.ch.:#3D.rdch().#0A
#0A..IF.ch#3Dendstreamch.RESULTIS..0000..1//.EOF#0A
..IF.ch#3D'*n'..6RESULTIS..0003..1//.'*n'#0A..IF.ch
#3D';'..7RESULTIS..0004..1//.';'#0A..IF.ch#3D'#3D'.
.7RESULTIS..0005..1//.'#3D'#0A#0A..IF.ch#3D'"'.DO.{
.ch.:#3D..rdch()#0A..15IF.ch#3D'*c'.LOOP#0A..15IF.c
h#3D'*n'.|.ch#3Dendstreamch.RESULTIS.-1.//.Error#0A
..15IF.ch#3D'"'.RESULTIS.2.//.Found.a.quoted.string
#2E#0A..15IF.ch#3D'**'.DO.{.ch.:#3D.rdch()#0A..31IF
.capitalch(ch)#3D'N'..DO.ch.:#3D.'*n'#0A..31IF.capi
talch(ch)#3D'*"'.DO.ch.:#3D.'*"'.//.MR.8/1/03#0A..2
9}#0A..15p.:#3D.p+1#0A..15IF.p>pmax.RESULTIS.-1.//.
Error#0A..15v%0,.v%p.:#3D.p,.ch#0A..13}.REPEAT#0A#0A
..//.Copy.chars.of.an.unquoted.item.into.v#0A..UNTI
L.ch#3D'*n'.|.ch#3D'*s'.|.ch#3D'*t'.|.ch#3D';'.|.ch
#3D'#3D'.|.ch#3Dendstreamch.DO#0A..{.p.:#3D.p+1#0A.
.2IF.p>pmax.RESULTIS.-1..12//.Error#0A..2v%0,.v%p.:
#3D.p,.ch#0A..2ch.:#3D.rdch().REPEATWHILE.ch#3D'*c'
#0A..}#0A..//.Unrdch.its.terminating.character#0A#0A
//sawritef("rditem.returning.type.1.%s,.ch#3D%x2.'%
c'*n",.v,.ch,.ch)#0A..UNLESS.ch#3Dendstreamch.DO.un
rdch()#0A..RESULTIS.1..26//.Unquoted.item#0A}#0A#0A
AND.findarg(keys,.w).#3D.VALOF#0A{.MANIFEST.{.match
ing.#3D.0;.skipping.#3D.1.}#0A..LET.state,.wp,.argn
o.#3D.matching,.0,.0#0A..FOR.i.#3D.1.TO.keys%0.DO#0A
..{.LET.kch#3Dkeys%i#0A..2IF.state#3Dmatching.DO#0A
..2{.IF.(kch#3D'#3D'.|.kch#3D'/'.|.kch#3D',').&.wp#3D
w%0.DO#0A..6RESULTIS.argno#0A..4wp.:#3D.wp.+.1#0A..
4UNLESS.compch(kch,.w%wp).#3D.0.DO.state.:#3D.skipp
ing#0A..2}#0A..2IF.kch#3D','.|.kch#3D'#3D'.DO.state
,.wp.:#3D.matching,.0#0A..2IF.kch.#3D.','.DO.argno.
:#3D.argno.+.1#0A..}#0A..IF.state.#3D.matching.&.wp
.#3D.w%0.RESULTIS.argno#0A..RESULTIS.-1#0A}#0A#0AAN
D.createco(fn,.size).#3D.VALOF#0A{.LET.c.#3D.getvec
(size+6)#0A..UNLESS.c.RESULTIS.0#0A..FOR.i.#3D.6.TO
.size+6.DO.c!i.:#3D.stackword#0A#0A..//.Using.P.to.
denote.the.current.stack.frame#0A..//.pointer,.the.
following.assumptions.are.made:#0A..//..P!0,.P!1,.P
!2.contain.the.return.link.information#0A..//..P!3.
.1is.the.variable.fn#0A..//..P!4..1is.the.variable.
size#0A..//..P!5..1is.the.variable.c#0A#0A..//.Now.
make.the.vector.c.into.a.valid.BCPL#0A..//.stack.fr
ame.containg.copies.of.fn,.size#0A..//.and.c.in.the
.same.relative.positions#2E#0A..//.Other.locations.
in.the.new.stack.frame.#0A..//.are.used.for.other.p
urposes#2E#0A..c!0.:#3D.c<<B2Wsh.//.resumption.poin
t#0A..c!1.:#3D.currco..1//.parent.link#0A..c!2.:#3D
.colist..1//.colist.chain#0A..c!3.:#3D.fn..5//.the.
main.function#0A..c!4.:#3D.size..3//.the.coroutine.
size#0A..c!5.:#3D.c..6//.the.new.coroutine.pointer#0A
#0A..colist.:#3D.c..//.insert.into.the.list.of.coro
utines#0A#0A..changeco(0,.c)#0A#0A..//.Execution.no
w.continues.with.the.P.pointer.set.to.c<<B2Wsh,#0A.
.//.and.so..the.vector.c.becomes.the.current.stack.
frame#2E#0A..//.The.compiler.will.have.generated.co
de.on#0A..//.the.assumption.that.fn.and.c.are.the.t
hird.and.fifth#0A..//.words.of.the.stack.frame,.and
,.since.c!3.and.c!5#0A..//.were.initialised.to.fn.a
nd.c,.the.following.repeated#0A..//.statement.will.
have.the.effect.(naively).expected#2E#0A..//.Note.t
hat.the.first.call.of.cowait.causes.a.return#0A..//
.from.createco.with.result.c#2E#0A#0A..c.:#3D.fn(co
wait(c)).REPEAT#0A}#0A#0AAND.deleteco(cptr).#3D.VAL
OF#0A{.LET.a.#3D.@colist#0A#0A..{.LET.co.#3D.!a#0A.
.2UNLESS.co.DO#0A..2{.sawritef("BLIB.co#3D%n:.canno
t.deleteco.%n.--.not.found*n",#0A..7currco,.cptr)#0A
..4abort(110002)#0A..4RESULTIS.FALSE#0A..2}#0A..2IF
.co#3Dcptr.BREAK#0A..2a.:#3D.@.co!co_list#0A..}.REP
EAT#0A#0A..IF.cptr!co_parent.DO#0A..{.sawritef("BLI
B.co#3D%n:.cannot.deleteco.%n.--.has.a.parent*n",#0A
..5currco,.cptr)#0A..2abort(110002)#0A..2RESULTIS.F
ALSE#0A..}#0A#0A..!a.:#3D.cptr!co_list..4//.Remove.
the.coroutine.from.colist#2E#0A..freevec(cptr)..9//
.Free.the.coroutine.stack#2E#0A..RESULTIS.TRUE#0A}#0A
#0AAND.callco(cptr,.a).#3D.VALOF#0A{.IF.cptr!co_par
ent.DO.abort(110000)#0A..cptr!co_parent.:#3D.currco
#0A..RESULTIS.changeco(a,.cptr)#0A}#0A#0AAND.resume
co(cptr,.a).#3D.VALOF#0A{.LET.parent.#3D.currco!co_
parent#0A..currco!co_parent.:#3D.0#0A..IF.cptr!co_p
arent.DO.abort(111)#0A..cptr!co_parent.:#3D.parent#0A
..RESULTIS.changeco(a,.cptr)#0A}#0A#0AAND.cowait(a)
.#3D.VALOF#0A{.LET.parent.#3D.currco!co_parent#0A..
currco!co_parent.:#3D.0#0A..RESULTIS.changeco(a,.pa
rent)#0A}#0A#0AAND.initco(fn,.size,.a,.b,.c,.d,.e,.
f,.g,.h,.i,.j,.k).#3D.VALOF#0A{.LET.cptr.#3D.create
co(fn,.size)#0A..result2.:#3D.0#0A..IF.cptr.DO.resu
lt2.:#3D.callco(cptr,.@a)#0A..RESULTIS.cptr#0A}#0A#0A
/*..4res.:#3D.startco(body,.arg,.stsize)#0A#0A..6Th
e.routine.'body'.is.created.as.a.coroutine.with.a.s
tacksize.'stsize'#0A..6and.'arg'.passed.as.an.argum
ent#2E..The.result.is.the.stackbase.of#0A..6the.new
.coroutine#2E#0A*/#0A#0AAND.startco(body,.arg,.stsi
ze).#3D.VALOF#0A{.LET.newco.#3D.createco(body,.stsi
ze)#0A//sawritef("BLIB:.callco(%n,%n)*n",.newco,.ar
g)#0A..1IF.newco.DO.callco(newco,.arg)#0A..1RESULTI
S.newco#0A}#0A#0A//.object.making.function#0AAND.mk
obj(upb,.fns,.a,.b,.c,.d,.e,.f,.g,.h,.i,.j,.k).#3D.
VALOF#0A{.LET.obj.#3D.getvec(upb)#0A..UNLESS.obj#3D
0.DO#0A..{.!obj.:#3D.fns#0A..2InitObj#23(obj,.@a)./
/.Send.the.InitObj.message.to.the.object#0A..}#0A..
RESULTIS.obj#0A}#0A#0AAND.instrcount(fn,.a,b,c,d,e,
f,g,h,i,j,k).#3D.VALOF#0A{.LET.res.#3D.0#0A..LET.co
unt.#3D.sys(Sys_setcount,.maxint)..//.Set.count.reg
ister.to.maxint#0A..result2.:#3D.fn(a,b,c,d,e,f,g,h
,i,j,k)#0A..res.:#3D.sys(Sys_setcount,.count)..6//.
Restore.previous.value#0A..29//.returning.the.modif
ied.count#0A..RESULTIS.maxint.-.res.-.32..1//.Corre
ct.for.overhead#0A}#0A#0AAND.datstring(v).#3D.VALOF
#0A{.LET.datv.#3D.VEC.2#0A..datstamp(datv)#0A..dat_
to_strings(datv,.v)#0A..RESULTIS.v#0A}#0A#0AAND.dat
_to_strings(datv,.v).#3D.VALOF#0A#0A//.Returns.v.co
ntaining.3.strings.representing.the#0A//.time.and.d
ate.given.in.datv,.where#0A//.datv!0.#3D.days.since
.1.Jan.1970#0A//.datv!1.#3D.msecs.since.midnight#0A
//.datv!2.#3D.-1#0A//.or#0A//.datv!0.#3D.days.since
.1.Jan.1978#0A//.datv!1.#3D.mins.since.midnight#0A/
/.datv!2.#3D.ticks.since.start.of.current.minute#0A
#0A//.On.return,#0A//.v..2contains.a.the.date.in.th
e.form.DD-MM1-YY2,#0A//.v+5..contains.the.time.in.t
he.format.HH:MM:SS,.and#0A//.v+10.contains.the.day.
of.the.week#2E#0A//.Vector.v.should.have.an.upperbo
und.of.14#0A//.If.the.date.is.unset.(days.#3D.0).th
en.the.strings#0A//.are.all.set.to."<unset>"#0A#0A{
.LET.days,.msecs.#3D.datv!0,.datv!1#0A..LET.datestr
,.timestr,.dowstr.#3D.v,.v+5,.v+10#0A..LET.year.#3D
.1970.//.BCPL,.Unix.and.Windows.epoc#0A..LET.month.
#3D.1#0A..LET.dayofweek.#3D.?#0A..LET.dowtemp.#3D.?
#0A..LET.hours,.mins,.secs.#3D.?,.?,.?#0A..LET.mont
htab..3#3D.TABLE..0010,.31,.59,.90,120,151,#0A..025
181,212,243,273,304,330004,365#0A..LET.leapmonthtab
.#3D.TABLE..0010,.31,.60,.91,121,152,#0A..025182,21
3,244,274,305,330005,366#0A..LET.mchars.#3D."JanFeb
MarAprMayJunJulAugSepOctNovDec"#0A..LET.mcharbase.#3D
.?#0A..LET.mtable.#3D.?#0A#0A..IF.datv!2>#3D0.DO#0A
..{.//.Convert.old.dat.format.to.new#0A..2days.:#3D
.days.+.2922.//.Days.between.1.Jan.1970.and.1978#0A
..2//.Convert.(mins,ticks).to.msecs.assuming.1001.t
icks.per.second#0A..2msecs..:#3D.datv!1*60_001.+.da
tv!2#0A..2datv!2.:#3D.-1.//.mark.as.new.dat.format#0A
..}#0A#0A..dayofweek.:#3D.(days+4).MOD.7.//.1.Jan.1
970.was.a.Thursday.(code#3D4)#0A..secs..:#3D.msecs/
1001..7//.Seconds.since.midnight#0A..msecs.:#3D.mse
cs.MOD.1001..3//.msecs.since.start.of.current.secon
d#0A#0A//sawritef("dat_to_strings:.days#3D%n.secs#3D
%n.msecs#3D%n*n",.days,.secs,.msecs)#0A..//.Deal.wi
th.case.of.unset.date#0A..IF.days.<#3D.0.DO#0A..{.L
ET.unset.#3D."<unset>"#0A..2FOR.i.#3D.0.TO.unset%0.
DO.#0A..2{.LET.c.#3D.unset%i#0A..4datestr%i.:#3D.c#0A
..4timestr%i.:#3D.c#0A..4dowstr%i..:#3D.c#0A..2}#0A
..2RESULTIS.v#0A..}#0A#0A..days.:#3D.days.+.1#0A..F
OR.j#3D0.TO.9.DO.datestr%j.:#3D."DD-MM1-YY2"%j#0A..
FOR.j#3D0.TO.8.DO.timestr%j.:#3D."HH:MM:SS"%j#0A#0A
..//.Construct.date#0A#0A..{.//.Loop.to.get.year#0A
..2LET.yearlen.#3D.isleap(year).->.366,.365#0A..2IF
.days.<#3D.yearlen.BREAK#0A..2days,.year.:#3D.days.
-.yearlen,.year.+.1#0A..}.REPEAT#0A#0A..datestr%8..
:#3D.year/1001.MOD.10.+.'0'#0A..datestr%9..:#3D.yea
r/100..MOD.10.+.'0'#0A..datestr%10.:#3D.year/10..1M
OD.10.+.'0'#0A..datestr%11.:#3D.year..4MOD.10.+.'0'
#0A.#0A..//.Find.the.month#0A..mtable.:#3D.isleap(y
ear).->.leapmonthtab,.monthtab#0A#0A..//.1.<#3D.day
s.<#3D.366#0A..month.:#3D.1.+.days./.32.//.Actual.m
onth.or.one.less#0A..IF.days.>.mtable.!.month.DO.mo
nth.:#3D.month+1#0A#0A..mcharbase.:#3D.month*3.-.2#0A
..FOR.j.#3D.0.TO.2.DO.datestr%(4+j).:#3D.mchars.%.(
mcharbase.+.j)#0A..days.:#3D.days.-.mtable.!.(month
.-.1)#0A..datestr%1.:#3D.days/10.+.'0'#0A..datestr%
2.:#3D.days.MOD.10.+.'0'#0A#0A..//.Construct.time#0A
#0A..mins..:#3D.secs../..00060#0A..hours.:#3D.mins.
./..00060#0A..mins..:#3D.mins.MOD.60#0A..secs..:#3D
.secs.MOD.60#0A#0A..timestr%1.:#3D.hours/10.+.'0'#0A
..timestr%2.:#3D.hours.MOD.10.+.'0'#0A..timestr%4.:
#3D.mins/10.+.'0'#0A..timestr%5.:#3D.mins.MOD.10.+.
'0'#0A..timestr%7.:#3D.secs/10.MOD.10.+.'0'#0A..tim
estr%8.:#3D.secs.MOD.10.+.'0'#0A#0A..//.Get.day.of.
week#0A..2#0A..dowtemp.:#3D.VALOF.SWITCHON.dayofwee
k.INTO#0A..4{.CASE.0:.RESULTIS."Sunday"#0A..6CASE.1
:.RESULTIS."Monday"#0A..6CASE.2:.RESULTIS."Tuesday"
#0A..6CASE.3:.RESULTIS."Wednesday"#0A..6CASE.4:.RES
ULTIS."Thursday"#0A..6CASE.5:.RESULTIS."Friday"#0A.
.6CASE.6:.RESULTIS."Saturday"#0A..4}#0A#0A..FOR.j.#3D
.0.TO.dowtemp%0.DO.dowstr%j.:#3D.dowtemp%j#0A#0A..R
ESULTIS.v#0A}#0A#0AAND.isleap(year).#3D.year.MOD.40
0.#3D.0.->.TRUE,#0A..17year.MOD.100.#3D.0.->.FALSE,
#0A..17year.MOD..0014.#3D.0.->.TRUE,#0A..37FALSE#0A
#0AAND.testbit(bitno,.bitvec).#3D.VALOF#0A//.This.f
unction.returns.a.non.zero.value.if.the.specified.b
it.in#0A//.bitvec.is.a.one,.otherwise.it.returns.ze
ro#2E#0A//.Bits.are.numbered.from.zero.starting.at.
the.least.significant.bit#0A//.of.bitvec!0#2E#0A//.
bitvec!0.holds.bits.0.to.bitsperword-1#0A//.bitvec!
1.holds.bits.bitsperword.to.2*bitsperword-1#0A//.et
c#0A{.LET.i.#3D.bitno../..bitsperword#0A..AND.s.#3D
.bitno.MOD.bitsperword#0A..RESULTIS.bitvec!i.&.(1<<
s)#0A}#0A#0AAND.setbit(bitno,.bitvec,.state).#3D.VA
LOF#0A//.This.function.sets.the.specified.bit.in.bi
tvec.to.1.or.0.depending#0A//.on.whether.state.is.T
RUE.or.FALSE,.respectively#2E.It.returns.a#0A//.non
-zero.value.if.the.previous.setting.of.the.bit.was.
a.one,.otherwise#0A//.it.returns.zero#2E.See.testbi
t.above#2E#0A{.LET.i.#3D.bitno../..bitsperword#0A..
AND.s.#3D.bitno.MOD.bitsperword#0A..LET.mask.#3D.1.
<<.s#0A..LET.oldstate.#3D.bitvec!i.&.mask#0A..TEST.
state.THEN.bitvec!i.:#3D.bitvec!i.|..mask#0A..11ELS
E.bitvec!i.:#3D.bitvec!i.&.~mask#0A..RESULTIS.oldst
ate#0A}#0A#0AAND.string_to_number(s).#3D.VALOF#0A//
.Return.TRUE.if.OK.with.value.in.result2#0A//..6FAL
SE.and.result2#3D0.if.s.is.not.a.number#0A//.Exampl
e.strings:.#0A//..1'A'#0A//..000123..2-99..2+63#0A/
/..#23377..1-#23x7FF.+#23b_1011_0000011.#0A//.It.ig
nores.underscores.in.digit.strings#0A{.LET.p,.len.#3D
.1,.s%0#0A..LET.neg,.radix.#3D.FALSE,.10#0A..LET.ch
.#3D.?#0A#0A..result2.:#3D.0#0A..UNLESS.len.RESULTI
S.FALSE#0A..ch.:#3D.capitalch(s%p)#0A..IF.ch.#3D.'*
''.&.len.#3D.3.&.s%3.#3D.'*''.DO#0A..{.result2.:#3D
.s%2#0A..2RESULTIS.TRUE#0A..}#0A#0A..IF.ch.#3D.'+'.
|.ch.#3D.'-'.DO#0A..{.neg.:#3D.ch.#3D.'-'#0A..2IF.p
.#3D.len.RESULTIS.TRUE#0A..2p.:#3D.p.+.1#0A..2ch.:#3D
.capitalch(s%p)#0A..}#0A..IF.ch.#3D.'#23'.DO#0A..{.
radix.:#3D.8#0A..2IF.p.#3D.len.RESULTIS.TRUE#0A..2p
.:#3D.p.+.1#0A..2ch.:#3D.capitalch(s%p)#0A..2IF.ch.
#3D.'O'.|.ch.#3D.'X'.|.ch.#3D.'B'.DO#0A..2{.IF.ch.#3D
.'X'.DO.radix.:#3D.16#0A..4IF.ch.#3D.'B'.DO.radix.:
#3D.2#0A..4IF.p.#3D.len.RESULTIS.TRUE#0A..4p.:#3D.p
.+.1#0A..4ch.:#3D.capitalch(s%p)#0A..2}#0A..}#0A#0A
..{.LET.n.#3D.'0'.<#3D.ch.<#3D.'9'.->.ch.-.'0',#0A.
.10'A'.<#3D.ch.<#3D.'Z'.->.ch.-.'A'.+.10,#0A..10ch#3D
'_'.->.-1,.//.Ignore.underscores.in.numbers.#0A..01
01001#0A..2UNLESS.n.<.radix.RESULTIS.FALSE#0A..2IF.
n>#3D0.DO.result2.:#3D.result2.*.radix.+.n#0A..2p.:
#3D.p.+.1#0A..2IF.p.>.len.BREAK#0A..2ch.:#3D.capita
lch(s%p)#0A..}.REPEAT#0A#0A..IF.neg.DO.result2.:#3D
.-result2#0A..RESULTIS.TRUE#0A}#0A#0AAND.string_to_
dat().#3D.VALOF#0A{.sawritef("function.string_to_da
t.not.implemented.(BLIB)*n")#0A..RESULTIS.0#0A}#0A#0A
//.Get.the.ith.element.of.vector.v.of.16-bit.unsign
ed.words#0AAND.getword(v,.i).#3D.VALOF#0A{.LET.j.#3D
.i+i#0A..LET.res.#3D.v%j.+.(v%(j+1)<<0008)..//.Assu
mes.little.ender.m/c.??8#0A..RESULTIS.res#0A}#0A#0A
//.Store.least.sig.16.bits.of.w.in.the.ith.element.
of.vector.v.of.16-bit.words#0AAND.putword(v,.i,.w).
BE..2//.store.16.bit.word#0A{.LET.j.#3D.i+i#0A..v%j
,.v%(j+1).:#3D.w,.w>>0008..//.Assumes.little.ender.
m/c..??11#0A}#0A#0AAND.copystring(from,.to).BE#0A..
FOR.i.#3D.0.TO.from%0.DO.to%i.:#3D.from%i#0A#0AAND.
copy_words(from,.to,.n).BE#0A..FOR.i.#3D.0.TO.n-1.D
O.to!i.:#3D.from!i#0A#0AAND.clear_words(v,.n).BE#0A
..FOR.i.#3D.0.TO.n-1.DO.v!i.:#3D.0#0A#0AAND.copy_by
tes(fromlen,.from,.fillch,.tolen,.to).#3D.VALOF#0A/
/.This.is.an.implementation.of.the.VAX.MOVC5.instru
ction#0A//.for.copying.bytes#2E#0A{.LET.n.#3D.froml
en#0A..//.from.and.to.are.byte.addresses!!3#0A..IF.
n>tolen.DO.n.:#3D.tolen#0A..//.This.code.need.check
ing!!3#0A..FOR.i.#3D.0.TO.n-1.DO.0%(to+i).:#3D.0%(f
rom+i)#0A..FOR.i.#3D.n.TO.tolen-1.DO.0%(to+i).:#3D.
fillch#0A..RESULTIS.fromlen-n.//.Number.of.non.copi
ed.characters#0A}#0A#0A2AND.getvec(upb).#3D.VALOF#0A
{.LET.res.#3D.?#0A..IF.upb<0.DO#0A..{.sawritef("BLI
B:.getvec(%n).called*n",.upb)#0A..2abort(1001)#0A..
}#0A..res.:#3D.sys(Sys_getvec,.upb)#0A//sawritef("B
LIB:.task.%i2.calling.getvec(%i6).#3D>.%i6*n",.task
id,.upb,.res)#0A..RESULTIS.res#0A}#0A#0AAND.freevec
(ptr).BE#0A{.//sawritef("BLIB:.task.%i2.freevec(%n)
*n",.taskid,.ptr)#0A#0A..IF.ptr.UNLESS.sys(Sys_free
vec,.ptr).DO#0A..{.sawritef("BLIB.co#3D%n:.freevec.
failure,.ptr#3D%n*n",.currco,.ptr)#0A..2abort(991)#0A
..}#0A}#0A#0AAND.loadseg(name).#3D.sys(Sys_loadseg,
.name)#0A#0AAND.globin(segl).#3D.sys(Sys_globin,.se
gl)#0A#0AAND.unloadseg(segl).BE.sys(Sys_unloadseg,.
segl)#0A#0AAND.callseg(file,.arg1,.arg2,.arg3,.arg4
).#3D.VALOF#0A{.LET.res.#3D.0#0A..LET.seg.#3D.loads
eg(file)#0A..LET.s.#3D.start#0A//sawritef("BLIB:.ca
llseg.%s.entered*n",.file)#0A#0A//.BEWARE:.The.call
ed.segment.must.be.careful.which.globals.it.uses!#0A
..TEST.seg.&.globin(seg)#0A..THEN.res.:#3D.start(ar
g1,.arg2,.arg3,.arg4)#0A..ELSE.{.sawritef("BLIB:.Un
able.to.callseg.%s.seg#3D%n*n",.file,.seg)#0A..7abo
rt(991)#0A..7start.:#3D.s#0A..7RESULTIS.0#0A..5}#0A
..unloadseg(seg)#0A..start.:#3D.s#0A..RESULTIS.res#0A
}#0A#0AAND.deletefile(name).#3D.sys(Sys_deletefile,
.name)#0A#0AAND.renamefile(fromname,.toname).#3D.sy
s(Sys_renamefile,.fromname,.toname)#0A#0AAND.setlog
name(logname,.logvalue).#3D.VALOF#0A{.LET.a.#3D.@ro
otnode!rtn_envlist#0A#0A..//.First.delete.current.e
ntry.if.it.exists#2E#0A..{.LET.p.#3D.!a#0A..2UNLESS
.p.BREAK#0A..2IF.compstring(logname,.p!1)#3D0.DO#0A
..2{.!a.:#3D.!p#0A..4freevec(p)#0A..4BREAK#0A..2}#0A
..2a.:#3D.p#0A..}.REPEAT#0A#0A..IF.logvalue.DO.//.I
nsert.new.entry#0A..{.LET.upb1.#3D.logname%0../.byt
esperword#0A..2LET.upb2.#3D.logvalue%0./.bytesperwo
rd#0A..2LET.p.#3D.getvec(4.+.upb1.+.upb2).//.3.+.up
b1+1.+.upb2+1.-.1#0A..2LET.s1.#3D.p.+.3#0A..2LET.s2
.#3D.s1.+.upb1.+.1#0A..2UNLESS.p.RESULTIS.0#0A..2FO
R.i.#3D.0.TO.upb1.DO.s1!i.:#3D.logname!i#0A..2FOR.i
.#3D.0.TO.upb2.DO.s2!i.:#3D.logvalue!i#0A..2p!1,.p!
2.:#3D.s1,.s2#0A..2!p.:#3D.rootnode!rtn_envlist#0A.
.2rootnode!rtn_envlist.:#3D.p#0A..2RESULTIS.p#0A..}
#0A#0A//sawritef("BLIB:.not.adding.%s*n",.logname)#0A
..RESULTIS.0#0A}#0A#0AAND.getlogname(logname).#3D.V
ALOF#0A{.LET.p.#3D.rootnode!rtn_envlist#0A..WHILE.p
.DO#0A..{.IF.compstring(logname,.p!1)#3D0.RESULTIS.
p!2#0A..2p.:#3D.!p#0A..}#0A..RESULTIS.0#0A}#0A#0A//
.Example.calls.of.splitname.give.the.following.resu
lts#0A#0A//.splitname(prefix,.':',."TCP:shep:9001",
..0001).#3D>..0005,.prefix#3D"TCP"#0A//.splitname(p
refix,.':',."TCP:shep:9001",..0005).#3D>.10,.prefix
#3D"shep"#0A//.splitname(prefix,.':',."TCP::0009001
",..0045).#3D>..0006,.prefix#3D""#0A//.splitname(pr
efix,.':',."TCP:shep",..0055).#3D>..0000,.prefix#3D
"shep"#0A//.splitname(prefix,.':',."TCP:shep:",..00
45).#3D>.10,.prefix#3D"shep"#0A//.splitname(prefix,
.':',."TCP:shep:",..00310).#3D>..0000,.prefix#3D""#0A
//.splitname(prefix,.':',."TCP:shep:9001",.10).#3D>
..0000,.prefix#3D"9001"#0A#0AAND.splitname(prefix,.
ch,.string,.ptr).#3D.VALOF#0A{.LET.len.#3D.string%0
#0A..LET.res,.pos.#3D.0,.0#0A#0A..WHILE.ptr<#3Dlen.
DO#0A..{.LET.k.#3D.string%ptr#0A..2IF.k#3Dch.DO.{.p
refix%0.:#3D.pos;.RESULTIS..ptr+1.}#0A..2pos,.ptr.:
#3D.pos+1,.ptr+1#0A..2prefix%pos.:#3D.k.#0A..}#0A..
prefix%0.:#3D.pos#0A..RESULTIS.0#0A}#0A#0A//.Not.us
ed#0AAND.open_for_output(name,.recsiz,.maxrec).#3D.
VALOF#0A{.sawritef("DLIB:.open_for_output(%s,%n,%n)
.called*n",.name,.recsiz,.maxrec).#0A..RESULTIS.fin
dstream(name,.id_outscb,.recsiz.<<.2,.maxrec)#0A}#0A
#0AAND.open_for_input(name).#3D.findstream(name,.id
_inscb,.0)#0A#0AAND.open_for_update(name).#3D.finds
tream(name,.id_inoutscb,.0)#0A#0AAND.setrecordlengt
h(scb,.length).#3D.VALOF..//.length.is.in.bytes.--.
MR.12/7/04#0A{.LET.old.#3D.scb!scb_reclen#0A..scb!s
cb_reclen.:#3D.length.//.in.bytes#0A..RESULTIS.old#0A
}#0A#0AAND.recordnote(scb).#3D.VALOF.//.The.first.r
ecord.has.number.0#0A//.Returns.the.record.number.c
orresponding.to.the.current.position#0A//..7of.the.
stream#2E#0A//.Returns.-1.if.the.stream.is.not.suit
able#2E#0A{.LET.blkno.#3D.scb!scb_block..2//.The.bl
ocksize.is.the.buffer.size.in.bytes#0A..AND.reclen.
#3D.scb!scb_reclen..//.in.bytes#0A..IF.blkno>#3D0.&
.reclen>0.DO.//.Modified.by.MR.12/7/04#0A..{.LET.re
cno.#3D.muldiv(blkno,.scb!scb_bufend,.reclen)#0A..2
RESULTIS.recno.+.(result2.+.scb!scb_pos)/reclen..//
.MR.12/2/04#0A..}#0A..sawritef("BLIB:.recordnote:.r
esult.-1*n")#0A..RESULTIS.-1..1//.MR.26/7/04#0A}#0A
#0AAND.recordpoint(scb,.recno).#3D.VALOF#0A//.MR.28
/7/02:.The.first.record.of.a.file.has.number.0#0A//
.Returns.TRUE.if.successful#0A//.Returns.FALSE,.oth
erwise#2E#0A{.LET.pvec.#3D.VEC.1#0A..LET.type.#3D.s
cb!scb_type#0A..UNLESS.type#3Dscbt_file.|.type#3Dsc
bt_ram.DO#0A..{.sawritef("FLIB.recordpoint:.only.wo
rks.on.a.disc.or.RAM.file*n")#0A..2abort(991)#0A..2
RESULTIS.FALSE#0A..}#0A..IF.recno<0.DO..1//.The.fir
st.record.has.number.0#0A..{.sawritef("DLIB:.record
point.recno#3D%n*n",.recno)#0A..2abort(1001)#0A..2r
ecno.:#3D.0#0A..}#0A//sawritef("DLIB:.recordpoint:.
muldiv(%n,%n,%n)*n",#0A//..8scb!scb_reclen,.recno,.
scb!scb_bufend)#0A//abort(1001)#0A..pvec!0.:#3D.mul
div(scb!scb_reclen,.recno,.scb!scb_bufend).//.MR.29
/7/02#0A..pvec!1.:#3D.result2#0A//sawritef("DLIB:.r
ecordpoint:.recno.%n.#3D>.%n.%n*n",#0A//..8recno,.p
vec!0,.pvec!1)#0A//abort(1001)#0A//IF.pvec!0>2.DO.a
bort(882)#0A..RESULTIS.point(scb,.pvec)#0A}#0A#0A//
.Position.an.inout.stream.to.its.end#0A//.This.shou
ld.be.removed#2E#0AAND.appendstream(scb).#3D.VALOF#0A
{.LET.lblock,.ldata.#3D.scb!scb_lblock,.scb!scb_lda
ta#0A//sawritef("DLIB:.appendstream.called*n");.abo
rt(991)#0A..UNLESS.scb!scb_id#3Did_inoutscb.RESULTI
S.FALSE#0A..IF.scb!scb_block#3Dlblock.&.scb!scb_end
>ldata.DO#0A..2ldata.:#3D.scb!scb_end#0A..UNLESS.po
int(scb,.@lblock).RESULTIS.FALSE#0A//..scb!scb_pos.
:#3D.scb!scb_end#0A..RESULTIS.TRUE#0A}#0A#0A//.Posi
tion.to.start.of.stream#0AAND.rewindstream(scb).#3D
.VALOF.//.MR.17/3/02#0A{.LET.blockno,.pos.#3D.0,.0#0A
..RESULTIS.point(scb,.@blockno)#0A}#0A#0A//.Advance
.stream.position.by.n.words#0AAND.stepstream(scb,.n
).#3D.VALOF#0A{.LET.pvec.#3D.VEC.1#0A..LET.bytes,.l
en.#3D.n.*.bytesperword,.scb!scb_bufend#0A..LET.blo
cks.#3D.bytes./.len#0A..bytes.:#3D.bytes.MOD.len#0A
..note(scb,.pvec)#0A..pvec!1.:#3D.pvec!1.+.bytes#0A
..IF.pvec!1.<.0..1DO.pvec!0,.pvec!1.:#3D.pvec!0.-.1
,.pvec!1.+.len#0A..IF.pvec!1.>.len.DO.pvec!0,.pvec!
1.:#3D.pvec!0.+.1,.pvec!1.-.len#0A..pvec!0.:#3D.pve
c!0.+.blocks#0A..RESULTIS.pvec!0.<.1.->.FALSE,.poin
t(scb,.pvec)#0A}#0A#0AAND.freeobj(obj).BE.freevec(o
bj)#0A#0AAND.copydir(dir).#3D.VALOF#0A{.LET.v.#3D.g
etvec((dir%0)/bytesperword)#0A..IF.v.FOR.i.#3D.0.TO
.dir%0.DO.v%i.:#3D.dir%i#0A//sawritef("BLIB:.copydi
r.called*n")#0A//abort(991)#0A..RESULTIS.v#0A}#0A#0A
//.Write.the.specified.number.of.records.of.zeroes.
to.the.opened.file#0AAND.setbulk(scb,.no_records).#3D
.VALOF#0A{.LET.oldout.#3D.output()#0A..LET.n.#3D.no
_records..3*.//.Number.of.bytes.to.write#0A..8scb!s
cb_reclen#0A..MANIFEST.{.bytes.#3D.2048;.words#3Dby
tes/bytesperword.}#0A..LET.v.#3D.VEC.words#0A//sawr
itef("BLIB:.setbulk:.clearing.v!0.to.v!%n*n",.words
-1)#0A..FOR.p.#3D.@v!0.TO.@v!words-1.DO.!p.:#3D.0#0A
#0A..rewindstream(scb)#0A..selectoutput(scb)#0A..//
.Used.writewords.to.write.2048.bytes.at.a.time#0A//
sawritef("BLIB:.setbulk:.writing.%n.bytes.to.file*n
",.n)#0A..WHILE.n>#3Dbytes.DO.{.writewords(v,.words
);.n.:#3D.n-bytes.}#0A..//.and.then.write.the.few.r
emaining.bytes,.if.any#2E#0A//sawritef("BLIB:.setbu
lk:.writing.the.remaining.%n.bytes.to.file*n",.n)#0A
..FOR.i.#3D.1.TO.n.DO.binwrch(0)#0A..rewindstream(s
cb)#0A..selectoutput(oldout)#0A..RESULTIS.TRUE#0A}#0A
#0AAND.datstamp(v).#3D.sys(Sys_datstamp,.v)#0A#0A//
.Dummy.definition.of.testflags#0AAND.testflags(flag
s).#3D.FALSE#0A

######sysb/boot.b#
//.(c).Copyright:.Martin.Richards..0018.Dec.2010#0A
#0A/*#0AChange.log#0A#0A0008/11/06#0AMade.several.c
hanges.for.the.-v.and.-d.options,.and.for.dumpsys#2E
#0A#0A00027/07/06#0AStored.the.default.environment.
variable.names.for.the.system.root,#0Athe.headers.a
nd.the.cli.path.directories.in.the.rootnode#2E.#0A#0A
00005/07/06#0AChanged.to.use.mainly.lowercase.file.
names#2E#0A#0A00012/01/06#0AAs.suggested.by.Dave.Le
wis,.saved.cli_returncode.from.the.CLI.global#0Avec
tor.in.the.BOOT.global.vector,.so.that.this.value.c
an.be.returned#0Ato.the.(Unix).shell#2E#0A*/#0A#0AS
ECTION."BOOT"#0A#0AGET."libhdr"#0A//GET."clihdr"../
/.MR.17/1/2000006#0A#0AGLOBAL.{#0Asadebug:ug#0Achec
kaddr#0Acont#0Adebug#0Aerror#0Agb#0Agh#0Agsb#0Agsh#0A
gw#0Ainstrtype#0Afname#0Anextpc#0Apraddr#0Aprinstr#0A
print#0Ardval#0Ardvaraddr#0Arch#0Awrcortn#0Awrframe
#0Awritearg#0A#0Abpt..6//.The.current.breakpoint.nu
mber.or.-1#0Abpt_addr..1//.Vector.of.breakpoint.PC.
values#0Abpt_instr..//.Vector.of.breakpoint.first.b
ytes.(op.codes)#0Abrkstep..2//.#3DTRUE.when.resumin
g.from.a.breakpoint#0Asnglstep..1//.#3DTRUE.when.si
ngle.stepping.(\.command)#0A#0Agptr..5//.Currently.
selected.G.pointer#0Acptr..5//.Currently.selected.c
oroutine#0Apptr..5//.Currently.selected.P.pointer#0A
fsize..4//.Size.of.currently.selected.stack.frame#0A
#0Amembase#0Amemlim#0Aoldcount#0Arecp#0Arecl#0Aregs
..5//.The.register.set.of.the.selected.task#0Atrapr
egs..1//.regs.on.entry.to.sadebug,.ie.the.set.that.
caused#0A..9//.cinterp.to.return.with.a.non.zero.re
sult#2E#0Astyle#0Aval..6//.Current.value#0Avars..5/
/.Vector.of.variables.(V1.#2E#2E.V9)#0A#0Acrntcb..3
//.Currently.selected.TCB,.if.in.Cintpos#0Ach#0Alch
#0A}#0A#0ASTATIC.{.debugstarted.#3D.FALSE.}.//.For.
Cintpos.only#0A#0AMANIFEST#0A{#0Ag_globsize#3D0;.g_
sys#3D3;.g_currco#3D7;.g_colist#3D8;.g_rootnode#3D9
#0A#0Af_brk..1#3D.2#0A#0Ar_a..3#3D.0#0Ar_b..3#3D.1#0A
r_c..3#3D.2#0Ar_p..3#3D.3#0Ar_g..3#3D.4#0Ar_st..2#3D
.5#0Ar_pc..2#3D.6#0Ar_count.#3D.7#0Ar_mw..2#3D.8#0A
r_upb..1#3D.8#0A#0Aroot_stackupb.#3D..000500..//.MR
.25/1/07#0Aroot_gvecupb..#3D.1001..//.MR.25/1/07#0A
gn_cli_returncode.#3D.137..//.dtl.25-09-06,.matches
.declaration.of.cli_returncode#0A#0Afl_mk.#3D.2.//.
Floating.point.operation#0A#0A//.Cintpos.only#0Atas
ktabupb.#3D.200..//.MR.18/10/04#0Adevtabupb..#3D.10
01#0A}#0A#0ALET.start(fn,.size,.c).BE#0A//.This.is.
the.very.first.BCPL.code.to.be.entered.(from.cintsy
s/cintpos)#0A//.Its.stack.and.globals.are.already.s
etup#0A//.globsize.(G0).is.already.set.--.MR.25/1/0
7#0A//.rootnode.(G9).is.already.set.--.MR.25/1/07#0A
//.p!0.holds.the.stack.size#0A//.sys.is.in.rootnode
!rtn_sys#0A#0A{.//.First.make.the.boot.stack.into.a
.coroutine.stack#0A..//.for.debugging.purposes#2E#0A
..LET.cosz.#3D.?#0A..currco.:#3D.@fn-3..13//.currco
.#3D.base.of.the.boot.stack#0A..cosz.:#3D.currco!0.
.12//.The.size.as.supplied.by.cintsys/cintpos#0A#0A
..colist.:#3D.currco#0A..currco!co_pptr..3:#3D..000
0#0A..currco!co_parent..1:#3D.-1..4//.Mark.as.root.
coroutine#0A..currco!co_list..3:#3D..0000#0A..currc
o!co_fn..5:#3D..start..//.These.are.the.same.locati
ons.as.fn#0A..currco!co_size..3:#3D..cosz..1//..31s
ize#0A..currco!co_c..6:#3D..0000..4//..27and.c#0A#0A
..boot()#0A}#0A#0AAND.boot().BE#0A//.This.is.the.ve
ry.first.BCPL.code.to.be.entered.(from.cintsys/cint
pos)#2E#0A//.Its.stack.is.allocated.and.initialised
.with.#23xABCD1234.but#0A//.must.be.made.into.a.roo
t.coroutine.stack#2E.The.global.vector#0A//.is.allo
cated.and.fully.initilalise.with.all.the.entry.poin
ts#0A//.in:.boot,.blib,.syslib.and.dlib#2E#0A#0A//.
Most.rootnode.fields.have.been.initialised.by.cints
ys/cintpos,#0A//.including#0A#0A//.rtn_boot..1The.m
odule.boot.ie.this.module#0A//.rtn_blib..1The.modul
e.blib,.syslib.and.dlib#0A//.rtn_sys..2The.function
.sys#0A#0A{.LET.g,.p.#3D.0,.0#0A..1#0A..IF.rootnode
!rtn_boottrace.DO#0A..{.sawritef("BOOT.stack.is.at.
%n*n",.currco)#0A..2sawritef("BOOT.global.vector.is
.at.%n*n",.@globsize)#0A..}#0A#0A..//.Allocate.the.
root.stack.and.global.vector.(for.klib.or.cli)#0A..
//.Note.that.boot's.stack.and.global.vector.were.al
located.by#0A..//.cintsys(64).or.cintpos#2E#0A..p.:
#3D.getvec(root_stackupb+6)..//.The.root.coroutine.
stack#0A..g.:#3D.getvec(root_gvecupb)..3//.The.root
.global.vector#0A#0A..//.boot.only.uses.standalone.
i/o#0A..rdch,.wrch.:#3D.sardch,.sawrch#0A..tcb,.tas
kid.:#3D.0,.1..8//.For.compatibility.with.cintpos#0A
..29//.Pretend.to.be.in.the.CLI.task#0A#0A..IF.root
node!rtn_boottrace>1.DO#0A..{.sys(Sys_tracing,.FALS
E)#0A..2sawritef("boot:.instruction.tracing.turned.
off*n")#0A..}#0A#0A..UNLESS.p.&.g.DO#0A..{.sawritef
("System.error.in.boot:.getvec.failed*n")#0A..2sys(
Sys_quit,.0)#0A..}#0A#0A..IF.rootnode!rtn_boottrace
.DO#0A..{.sawritef("CLI.stack.allocated.at.%n*n",.p
)#0A..2sawritef("CLI.global.vector.allocated.at.%n*
n",.g)#0A..}#0A#0A..//.Clear.the.root.global.vector
.and.stack.(for.klib.to.cli)#0A..g!0.:#3D.root_gvec
upb#0A..p!0.:#3D.root_stackupb#0A..FOR.i.#3D.1.TO.g
!0.DO.g!i.:#3D.globword.+.i;#0A..FOR.i.#3D.1.TO.p!0
+6.DO.p!i.:#3D.stackword#0A.#0A..writef("*nBCPL.%n-
bit.Cintcode.System.(30.May.2013)*n",.BITSPERBCPLWO
RD)#0A#0A..IF.rootnode!rtn_boottrace>1.DO#0A..{.saw
ritef("boot:.turning.on.instruction.tracing*n")#0A.
.2sys(Sys_tracing,.TRUE)#0A..}#0A#0A..//.Set.the.en
vironment.variable.names.for.this.system.in.the.roo
tnode#0A..//.BCPL.Cintcode.uses.BCPLROOT,..1BCPLPAT
H..1and.BCPLHDRS#0A..//.BCPL64..6uses.BCPL64ROOT,.B
CPL64PATH.and.BCPL64HDRS#0A..//.Cintpos..5uses.POSR
OOT,..2POSPATH..2and.POSHDRS#0A..//{.LET.rootvar,.p
athvar,.hdrsvar,.scriptsvar.#3D.#0A..//..4"BCPLROOT
",..1"BCPLPATH",..1"BCPLHDRS",..1"BCPLSCRIPTS"#0A..
//..2//"BCPL64ROOT",."BCPL64PATH",."BCPL64HDRS",."B
CPL64SCRIPTS"#0A..//..2//"POSROOT",..2"POSPATH",..2
"POSHDRS",..2"POSSCRIPTS"#0A..//..FOR.i.#3D.0.TO.ro
otvar%0..2DO.(rootnode!rtn_rootvar)%i..2:#3D.rootva
r%i#0A..//..FOR.i.#3D.0.TO.pathvar%0..2DO.(rootnode
!rtn_pathvar)%i..2:#3D.pathvar%i#0A..//..FOR.i.#3D.
0.TO.hdrsvar%0..2DO.(rootnode!rtn_hdrsvar)%i..2:#3D
.hdrsvar%i#0A..//..FOR.i.#3D.0.TO.scriptsvar%0.DO.(
rootnode!rtn_scriptsvar)%i.:#3D.scriptsvar%i#0A..//
}#0A#0A//writef("Type.5.characters.to.test.standalo
ne.rdch*n")#0A//FOR.i.#3D.1.TO.5.DO#0A//{.LET.ch.#3D
.sardch()#0A//..sawritef("ch.#3D.%n.'%c'*n",.ch,.ch
)#0A//..IF.ch#3D'#2E'.BREAK#0A//}#0A#0A1..g!g_globs
ize.:#3D.root_gvecupb#0A..g!g_sys..4:#3D.sys#0A..g!
g_rootnode.:#3D.rootnode#0A..g!g_currco..1:#3D.0..8
//.These.are.initialised.to.simplify#0A..g!g_colist
..1:#3D.0..8//.the.initial.debugging.of.cintasm#2E#0A
..1#0A..//.Initialise.the.standalone.debugger.varia
bles#0A..membase..1:#3D.rootnode!rtn_membase#0A..me
mlim..2:#3D.membase.+.rootnode!rtn_memsize#0A..vars
..4:#3D.TABLE.0,0,0,0,0,0,0,0,0,0#0A..bpt_addr..:#3D
.TABLE.0,0,0,0,0,0,0,0,0,0#0A..bpt_instr.:#3D.TABLE
.0,0,0,0,0,0,0,0,0,0#0A..style..3:#3D.'F'..17//.Def
ault.printing.style#0A..val..5:#3D.0#0A..brkstep..1
:#3D.FALSE#0A..snglstep..:#3D.FALSE#0A#0A..crntcb..
2:#3D.0..5//.For.Cintpos.only#0A#0A..//.Breakpoints
.may.be.set.and.cleared.by.the.debug.task.so#0A..//
.bpt_addr.and.bpt_instr.must.be.accessible.to.it#2E
.These.fields#0A..//.are.also.used.by.the.dumpdebug
.command#2E#0A..rootnode!rtn_bptaddr..:#3D.bpt_addr
#0A..rootnode!rtn_bptinstr.:#3D.bpt_instr#0A..rootn
ode!rtn_dbgvars..:#3D.vars..6//.MR.25/08/05#0A#0A..
regs..7:#3D.cliregs#0A..regs!r_a..3:#3D.0..8//.A#0A
..regs!r_b..3:#3D.0..8//.B#0A..regs!r_c..3:#3D.0..8
//.C#0A..regs!r_p..3:#3D.p<<B2Wsh..1//.P#0A..regs!r
_g..3:#3D.g<<B2Wsh..1//.G#0A..regs!r_st..2:#3D.1..8
//.Cintpos.only.--.In.klib,.interrupts.disabled#0A.
.regs!r_pc..2:#3D.startroot..//.PC#0A..regs!r_count
.:#3D.-1..7//.Count..(-1.#3D.infinity)#0A..regs!r_m
w..2:#3D.0..8//.MW.(used.by.64-bit.Cintcode)#0A#0A.
.{.LET.sw.#3D.1..//.1#3Dcintasm..0002#3Dinterpret#0A
..2IF.rootnode!rtn_boottrace>1.DO.sw.:#3D.2#0A..2re
gs!r_count.:#3D.sw#3D1.->.-1,.1_001_001_001#0A..}#0A
#0A..IF.rootnode!rtn_boottrace>1.DO#0A..{.sys(Sys_t
racing,.FALSE)#0A..2sawritef("boot:.instruction.tra
cing.turned.off*n")#0A..}#0A#0A..IF.rootnode!rtn_bo
ottrace.DO#0A..{.sawritef("boot.about.to.call.the.i
nterpreter.recursively*n")#0A..2sawritef("It.should
.start.executing.the.boot.function:.startroot*n")#0A
..}#0A#0A..{.//.In.this.loop.a.private.copy.of.the.
sys.function.is.made#0A..2//.so.that.breakpoints.ca
n.be.set.in.the.normal.sys.fuction#0A..2//.without.
interferring.with.the.sys.calls.used.here#2E#0A..2L
ET.res.#3D.0#0A..2LET.sysf.#3D.(rootnode!rtn_sys>>B
2Wsh)-4#0A..2LET.sysv.#3D.VEC.4..5//.The.vector.to.
hold.the.private.copy.sys#2E#0A..25//.This.copy.wil
l.work.on.big.and.little#0A..25//.ender.machines.ru
nning.using.either.32-#0A..25//.or.64-bit.Cintcode#2E
#0A..2//.Copy.the.standard.version.of.sys.including
.its.name#0A..2//.into.private.work.space#2E#0A..2F
OR.i.#3D.0.TO.4.DO.sysv!i.:#3D.sysf!i#0A..2sys.:#3D
.(sysv+4)<<B2Wsh.//.Update.the.sys.function.in.boot
's.global#0A..25//.vector.to.point.to.this.private.
version#2E#0A#0A..2//sysv%0.:#3D.#23x91..4//.SYS#0A
..2//sysv%1.:#3D.#23x7B..4//.RTN#0A..2//sys.:#3D.sy
sv<<B2Wsh..//.Update.the.sys.function.in.boot's.glo
bal#0A..22//.vector.to.point.to.this.private.versio
n#2E#0A#0A..2IF.rootnode!rtn_boottrace.DO#0A..2{.sa
writef("boot:.about.to.call.sys(Sys_interpret,#2E#2E
1)*n")#0A..2}#0A#0A..2IF.rootnode!rtn_boottrace>1.D
O#0A..2{.sawritef("boot:.after.turning.instruction.
tracing.on*n")#0A..4sys(Sys_tracing,.TRUE)#0A..2}#0A
#0A..2res.:#3D.sys(Sys_interpret,.regs)..//.Call.th
e.interpreter#0A#0A..2//.Save.cli_returncode.from.C
LI.global.vector.in.BOOT.global.vector#0A..2cli_ret
urncode.:#3D.g!gn_cli_returncode.//.MR.17/1/06#0A#0A
..2UNLESS.res.DO.sys(Sys_quit,.0)..//.Exit.from.cin
tsys.or.cintpos#0A#0A..2IF.res#3D-1.LOOP..6//.Re-en
ter.the.interpreter.immediately#0A..24//.to.allow.a
.different.interpreter.to#0A..24//.be.entered#2E#0A
#0A..2IF.res#3D-2.DO..8//.Used.by.the.dumpmem.comma
nd.to#0A..2{.sys(Sys_dumpmem,.4).//.dump.the.memory
.(context#3D4).and#0A..4LOOP..14//.re-enter.the.int
erpreter#2E#0A..2}#0A..2rootnode!rtn_abortcode.:#3D
.res#0A#0A..2IF.rootnode!rtn_dumpflag.DO#0A..2{.roo
tnode!rtn_dumpflag.:#3D.FALSE.//.To.stop.memory.bei
ng.dumped.twice#2E#0A..4sys(Sys_dumpmem,.5).//.Dump
.the.memory.(context#3D5).and.quit#0A..4//.Memory.h
as.been.dumped.so.just.leave.Cintpos#0A..4sys(Sys_q
uit,.0)#0A..2}#0A#0A..2val.:#3D.regs!r_pc..4//.Debu
g's.current.value#0A#0A..2IF.rootnode!rtn_boottrace
>1.DO#0A..2{.sys(Sys_tracing,.FALSE)#0A..4sawritef(
"boot:.instruction.tracing.turned.off*n")#0A..2}#0A
#0A..2UNLESS.sadebug(res).DO#0A..2{.sawritef("Stand
alone.debug.could.not.cope*n")#0A..4sys(Sys_quit,.r
es)#0A..2}#0A#0A..}.REPEAT.//.to.re-enter.the.inter
preter#2E#0A}#0A#0AAND.startroot(fn,.size,.c).BE#0A
{.//.On.entry.the.base.of.the.stack.is.at.@fn-3,#0A
..//.and.the.P.pointer.is.set.to.this.value#2E#0A..
//.All.the.stack.elements.are.set.to.#23xABCD1234,.
except#0A..//.for.the.zeroth.word.which.holds.the.s
tacksize#2E#0A#0A..//.The.base.of.the.global.vector
.is.at.@globsize.(#3DGlobal.0),#0A..//.all.its.elem
ents.are.filled.with.words.of.the.form#0A..//.globw
ord+n.(#3D#238F8F002+n),.except.for.the.follow.few.
critical#0A..//.global.variables:#0A#0A..//.globsiz
e..--.set.to.the.upper.bound#0A..//.sys..5--.set.to
.the.entry.point.of.the.function.sys#0A..//.rootnod
e..--.set.to.point.to.the.root.node.(typically.#3D.
100)#0A..//.currco..2--.set.to.zero#0A..//.colist..
2--.set.to.zero#0A#0A..LET.stacksize.#3D.0#0A#0A../
/.Make.the.stack.into.a.root.coroutine.stack#2E#0A.
.currco.:#3D.@fn-3#0A..colist.:#3D.currco#0A#0A..st
acksize..6:#3D.currco!0#0A#0A..currco!co_pptr..1:#3D
..0000#0A..currco!co_parent.:#3D.-1..8//.Mark.as.ro
ot.coroutine#0A..currco!co_list..1:#3D..0000#0A..cu
rrco!co_fn..3:#3D..startroot..//.These.are.the.same
.locations.as.fn#0A..currco!co_size..1:#3D..stacksi
ze..//..31size#0A..currco!co_c..4:#3D..0000..8//..2
7and.c#0A#0A..rootcode()#0A}#0A#0AAND.rootcode().BE
#0A{#0A..tcb,.taskid.:#3D.0,.1.//.Compatibility.wit
h.Cintpos#0A..crntcb.:#3D.0..7//.Cintpos.only.--.no
.current.task.yet#0A#0A..//.Set.the.globals.defined
.in.blib,.syslib.and.dlib#0A..sys(Sys_globin,.rootn
ode!rtn_blib)#0A..1#0A..rootnode!rtn_keyboard.:#3D.
0#0A..rootnode!rtn_screen..1:#3D.0#0A..currentdir..
10:#3D.0#0A#0A..IF.rootnode!rtn_boottrace>1.DO#0A..
{.sys(Sys_tracing,.FALSE)#0A..2sawritef("rootcode:.
instruction.tracing.turned.off*n")#0A..}#0A#0A..sel
ectinput(findinput("**"))#0A..selectoutput(findoutp
ut("**"))#0A#0A..//.We.can.now.do.normal.stream.IO.
(using.rdch.and.wrch),#0A..//.for.example:#0A..//wr
ites("Hello*n")#0A#0A..IF.rootnode!rtn_boottrace.DO
#0A..{.sawritef("startroot:.can.now.use.normal.stre
am.i/o*n")#0A..2sawritef("startroot:.trying.to.load
.syscin/cli*n")#0A..}#0A#0A1..UNLESS.globin(loadseg
("syscin/cli")).DO#0A..{.sawritef("Unable.to.start.
the.CLI#2E*n")#0A..2sys(Sys_quit,.0)#0A..}#0A#0A..I
F.rootnode!rtn_boottrace.DO#0A..{.sawritef("startro
ot:.loaded.syscin/cli.successfully*n")#0A..2sawrite
f("startroot:.now.entering.the.cli*n")#0A..}#0A..1#0A
..start()..8//.Enter.the.newly.loaded.CLI#0A..sys(S
ys_quit,.0)#0A}#0A#0AAND.sadebug(code).#3D.VALOF#0A
//.Enter.standalone.debug#0A//.Only.entered.as.a.re
sult.of.the.interpreter.encountering#0A//.a.fault#2E
.The.Cintcode.registers.in.regs.represent.the.state
.at#0A//.that.moment#2E#0A#0A{.IF.sawrch<0.DO..3//.
Test.if.the.system.is.sufficiently.initialised#0A..
19//.to.run.standalone.debug#2E#0A..{.LET.mess.#3D.
"Fault.occurred.before.the.system.was.initialised*n
"#0A..2FOR.i.#3D.1.TO.mess%0.DO.sys(Sys_sawrch,.mes
s%i)#0A..2sys(Sys_quit,.code)#0A..2RESULTIS.FALSE#0A
..}#0A#0A..trapregs.:#3D.regs.//.Save.the.register.
set.at.time.of.entering.sadebug#0A..17//.(In.Cintpo
s,.regs.changes.when.selecting.different#0A..17//.t
asks)#0A..17//.On.exit.from.sadebug.regs.must.equal
.trapregs#2E#0A#0A..recp..:#3D.@code-3.<<.B2Wsh.//.
level().without.using.BLIB#2E#0A..recl..:#3D.recove
r#0A..bpt..1:#3D.-1#0A#0A..gptr..:#3D.regs!r_g.>>.B
2Wsh#0A..cptr..:#3D.gptr!g_currco#0A..pptr..:#3D.re
gs!r_p.>>.B2Wsh#0A..fsize.:#3D.cptr.+.6.+.cptr!co_s
ize#0A..val..1:#3D.regs!r_pc#0A#0A..IF.code#3D3.DO.
.8//.Zero.count#2E#0A..{.IF.brkstep.DO#0A..2{.brkst
ep.:#3D.FALSE..//.Breakpoint.continuation#2E#0A..4I
F.oldcount>0.DO.oldcount.:#3D.oldcount-1#0A..4trapr
egs!r_count.:#3D.oldcount#0A..4GOTO.ret..8//.Restor
e.BRK.instructions.and.continue#2E#0A..2}#0A..2IF.s
nglstep.DO#0A..2{.snglstep.:#3D.FALSE.//.Single.ste
p#2E#0A..4IF.oldcount>0.DO.oldcount.:#3D.oldcount-1
#0A..4trapregs!r_count.:#3D.oldcount#0A..4writes(".
A#3D");.print(regs!r_a)#0A..4writes(".B#3D");.print
(regs!r_b)#0A..4prinstr(val)#0A..4newline()#0A..4GO
TO.recover#0A..2}#0A..}#0A#0A..FOR.i.#3D.0.TO.9.DO.
.10//.Remove.all.BRK.instructions#0A..{.LET.ba.#3D.
bpt_addr!i#0A..2IF.ba~#3D0.&.0%ba#3Df_brk.DO.0%ba.:
#3D.bpt_instr!i#0A..}#0A#0A..IF.code#3D2.DO..//.BRK
.instruction#0A..2FOR.i.#3D.0.TO.9.IF.bpt_addr!i#3D
val.DO#0A..2{.bpt.:#3D.i#0A..4writef("*n!!.BPT.%n:.
.",.bpt)#0A..4writearg(val)#0A..4writes("*n..1")#0A
..4writes(".A#3D");.print(regs!r_a)#0A..4writes(".B
#3D");.print(regs!r_b)#0A..4prinstr(val)#0A..4newli
ne()#0A..4GOTO.recover#0A..2}#0A#0A..IF.code#3D10.D
O.//.Cintasm.single.step#0A..{.writes(".A#3D");.pri
nt(regs!r_a)#0A..2writes(".B#3D");.print(regs!r_b)#0A
..2prinstr(val)#0A..2newline()#0A..2GOTO.recover#0A
..}#0A#0A..{.LET.gn.#3D.regs!r_pc.-.globword#0A..2L
ET.mess.#3D..VALOF.SWITCHON.code.INTO#0A..14{.CASE.
.0011:.RESULTIS."Illegal.instruction"#0A..16CASE..0
012:.RESULTIS."BRK.instruction"#0A..16CASE..0013:.R
ESULTIS."Zero.count"#0A..16CASE..0014:.TEST.0<#3Dgn
<#3Dgptr!0#0A..26THEN.RESULTIS."G%n.unassigned"#0A.
.26ELSE.RESULTIS."Negative.pc"#0A..16CASE..0015:.RE
SULTIS."Division.by.zero"#0A..16CASE..00010:.RESULT
IS."Cintasm.single.step"#0A..16CASE..00011:.RESULTI
S."Watch.addr:.%+%i7.value:.%i8"#0A..16CASE..00012:
.RESULTIS."Indirect.address.out.of.range:.%+%+%+%n"
#0A..16CASE..00013:.RESULTIS."SIGINT.received"#0A..
16CASE..00099:.RESULTIS."User.requested"#0A..16CASE
.110000:.RESULTIS."Callco.fault"#0A..16CASE.111:.RE
SULTIS."Resumeco.fault"#0A..16CASE.110002:.RESULTIS
."Deleteco.fault"#0A..16CASE.180:.RESULTIS."Unable.
to.delete.a.task"#0A..16CASE.181:.RESULTIS."Unable.
to.send.a.packet"#0A..16CASE.182:.RESULTIS."Unexpec
ted.pkt.received"#0A..16CASE.186:.RESULTIS."Bad.inp
ut.stream"#0A..16CASE.187:.RESULTIS."Bad.output.str
eam"#0A..16CASE.188:.RESULTIS."Unable.to.replenish.
input"#0A..16CASE.189:.RESULTIS."Wrch.fault"#0A..16
CASE.190:.RESULTIS."Endread.fault"#0A..16CASE.191:.
RESULTIS."Endwrite.fault"#0A..16CASE.197:.RESULTIS.
"Store.chain.fault"#0A..16DEFAULT:..RESULTIS."Unkno
wn.fault"#0A..14}#0A..2sawritef("*n!!.ABORT.%n:.",.
code)#0A..2sawritef(mess,.gn,.!1,.!2,.!3)#0A..2sawr
ch('*n')#0A..}#0A#0Arecover:#0A..ch.:#3D.'*n'#0Anxt
:..21//.Main.loop.for.debug.commands#0A..IF.ch#3D'*
n'.DO.writes("**.")#0A..rch()#0Asw:#0A..SWITCHON.ch
.INTO#0A#0A..{.DEFAULT:.error()#0A#0A..2CASE.endstr
eamch:#0A..2CASE.'Q':.sawritef("*n");.sys(Sys_quit,
.0)..1//.Quit#0A..7#0A..4#0A..2CASE.'*s':#0A..2CASE
.'*t':#0A..2CASE.'*n':.GOTO.nxt#0A#0A..2CASE.'?':#0A
..5writes("*n?..10Print.list.of.debug.commands*n")#0A
..5writes("Gn.Pn.Rn.Vn..14Variables*n")#0A..5writes
("G..P..R..V..15Pointers*n")#0A..5writes("123.#23o3
77.#23FF00003.'c..7Constants*n")#0A..5writes("**e./
e.%e.+e.-e.|e.&e.^e..1Dyadic.operators*n")#0A..5wri
tes("!e..23Subscription*n")#0A..5writes("<.>..22Shi
ft.left/right.one.place*n")#0A..5writes("$b.$c.$d.$
f.$o.$s.$u.$x..2Set.the.print.style*n")#0A..5writes
("SGn.SPn.SRn.SVn.SAn..6Store.in.variable*n")#0A..5
writes("#3D..8Print.current.value*n")#0A..5writes("
Tn..7Print.n.consecutive.locations*n")#0A..5writes(
"I..8Print.current.instruction*n")#0A..5writes("N..
8Print.next.instruction*n")#0A..5writes("D..8Dump.C
intcode.memory.to.DUMP#2Emem*n")#0A..5writes("Q..8Q
uit.--.leave.the.cintpos.system*n")#0A..5writes("M.
.8Set/Reset.memory.watch.address*n")#0A..5writes("B
.0Bn.eBn..List,.Unset.or.Set.breakpoints*n")#0A..5w
rites("X..(G4B9C).Set.breakpoint.9.at.start.of.clih
ook*n")#0A..5writes("Z..(P1B9C).Set.breakpoint.9.at
.return.of.current.function*n")#0A..5writes("C..8Co
ntinue.normal.execution*n")#0A..5writes("\..8Single
.step.execute.one.Cintcode.instruction*n")#0A..5wri
tes("#2E.;.[.]..2Move.to.current/parent/first/next.
coroutine*n")#0A..5writes(",..8Move.down.one.stack.
frame*n")#0A..5GOTO.recover#0A#0A..2CASE.'0':.CASE.
'1':.CASE.'2':#0A..2CASE.'3':.CASE.'4':.CASE.'5':#0A
..2CASE.'6':.CASE.'7':.CASE.'8':#0A..2CASE.'9':.CAS
E.'#23':.CASE.'*'':#0A..2CASE.'G':.CASE.'P':.CASE.'
R':#0A..2CASE.'V':.CASE.'A':#0A..12val.:#3D.rdval()
;..21GOTO.sw#0A#0A..2CASE.'!':.rch();.val.:#3D.cont
(val..+..rdval());..GOTO.sw#0A..2CASE.'+':.rch();.v
al.:#3D.val..+..rdval();..6GOTO.sw#0A..2CASE.'-':.r
ch();.val.:#3D.val..-..rdval();..6GOTO.sw#0A..2CASE
.'**':rch();.val.:#3D.val..*..rdval();..6GOTO.sw#0A
..2CASE.'/':.rch();.{.LET.a.#3D.rdval()#0A..21UNLES
S.a.DO.error()#0A..21val.:#3D.val./.a#0A..21GOTO.sw
#0A..19}#0A..2CASE.'%':.rch();.{.LET.a.#3D.rdval()#0A
..21UNLESS.a.DO.error()#0A..21val.:#3D.val.REM.a#0A
..21GOTO.sw#0A..19}#0A..2CASE.'|':.rch();.val.:#3D.
val..|..rdval();..GOTO.sw#0A..2CASE.'&':.rch();.val
.:#3D.val..&..rdval();..GOTO.sw#0A..2CASE.'^':.rch(
);.val.:#3D.val.XOR.rdval();..GOTO.sw#0A#0A..2CASE.
'<':.val.:#3D.val.<<.1;..14GOTO.nxt#0A..2CASE.'>':.
val.:#3D.val.>>.1;..14GOTO.nxt#0A#0A..2CASE.'#3D':.
print(val);.newline();..8GOTO.recover#0A#0A..2CASE.
'S':.{.LET.type.#3D.rch()#0A..14rch()#0A..14!rdvara
ddr(type).:#3D.val#0A..14GOTO.sw#0A..12}#0A#0A..2CA
SE.'T':.rch()#0A..10{.LET.n.#3D.rdn()#0A..12LET.k.#3D
.bitsperword#3D32.->.5,.4#0A..12IF.n<#3D0.DO.n.:#3D
.1#0A..12FOR.i#3D0.TO.n-1.DO#0A..12{.IF.i.REM.k.#3D
.0.DO.praddr(val+i)#0A..14print(cont(val+i))#0A..12
}#0A..12newline()#0A..12GOTO.sw#0A..10}#0A#0A..2CAS
E.'$':.rch()#0A..12UNLESS.ch#3D'B'.|.ch#3D'C'.|.ch#3D
'D'.|.ch#3D'F'.|#0A..19ch#3D'O'.|.ch#3D'S'.|.ch#3D'
U'.|.ch#3D'X'.DO#0A..12{.writef("Valid.style.letter
s.are:.BCDFOSUX*n")#0A..14GOTO.nxt#0A..12}#0A..12st
yle.:#3D.ch#0A..12GOTO.nxt#0A#0A..2CASE.'D':.writef
("*nCintcode.memory.dumped.to.DUMP#2Emem*n")#0A..12
sys(Sys_dumpmem,.6).//.Dump.the.memory.(context#3D6
)#0A..12GOTO.recover#0A#0A..2CASE.'N':.val.:#3D.nex
tpc(val)#0A..2CASE.'I':.prinstr(val);.newline();.GO
TO.recover#0A#0A..2CASE.'X':..//.Equivalent.to.G4B9
C#0A..7val.:#3D.gptr!4..//.set.breakpoint.9.at.clih
ook.and.resume#0A..7GOTO.caseb#0A#0A..2CASE.'Z':../
/.Equivalent.to.P1B9C#0A..7val.:#3D.pptr!1..//.set.
breakpoint.9.to.current.return.address.and.resume#0A
#0A..2caseb:#0A..2CASE.'B':..//.Set,.clear.or.displ
ay.breakpoints#2E#0A..3{.LET.comch.#3D.ch#0A..5TEST
.comch#3D'B'.THEN.rch()..5//.For.B#0A..20ELSE.ch.:#3D
.'9'..1//.For.X.or.Z#0A..5IF.'0'<#3Dch<#3D'9'.DO#0A
..5{.LET.n.#3D.ch.-.'0'..//.Set.or.Clear.a.break.po
int#2E#0A..7bpt_addr!n.:#3D.0#0A..7IF.val#3D0.GOTO.
nxt#0A..7checkaddr(val>>B2Wsh)#0A..7FOR.i.#3D.0.TO.
9.IF.bpt_addr!i#3Dval.DO.bpt_addr!i.:#3D.0#0A..7bpt
_addr!n,.bpt_instr!n.:#3D.val,.0%val#0A..7GOTO.comc
h#3D'B'.->.nxt,.resume#0A..5}#0A..5UNLESS.ch#3D'*n'
.DO.newline()#0A..5FOR.i.#3D.0.TO.9.DO..//.List.all
.breakpoints#2E#0A..5{.LET.ba#3Dbpt_addr!i#0A..7UNL
ESS.ba#3D0.DO#0A..7{.writef("%n:..",.i)#0A..9writea
rg(ba)#0A..9newline()#0A..7}#0A..5}#0A..5GOTO.recov
er#0A..3}#0A#0A..2CASE.'M':..//.Set.or.clear.memory
.watch.address#0A..13checkaddr(val)#0A..13TEST.val.
THEN.writef("*nWatch.address:.%n*n",.val)#0A..22ELS
E.writef("*nWatch.unset*n")#0A..13sys(Sys_watch,.va
l)#0A..13GOTO.recover#0A#0Aresume:#0A..2CASE.'C':./
/.Continue.Cintcode.execution#2E#0A..11{.LET.pc.#3D
.trapregs!r_pc#0A..13newline()#0A..13FOR.i.#3D.0.TO
.9.IF.pc#3Dbpt_addr!i.DO#0A..13{.//.We.are.resuming
.at.a.break.point#0A..15oldcount.:#3D.trapregs!r_co
unt#0A..15trapregs!r_count.:#3D.1.//.Set.it.up.to.e
xecute.just#0A..15brkstep.:#3D.TRUE..1//.one.instru
ction#0A..15GOTO.retstep#0A..13}#0A..13GOTO.ret..//
.Resume.execution#2E#0A..11}#0A#0A..2CASE.'\':.oldc
ount.:#3D.trapregs!r_count.//.Single.step.execution
#2E#0A..12trapregs!r_count.:#3D.1#0A..12snglstep.:#3D
.TRUE#0A..12GOTO.retstep#0A#0A..2CASE.',':..//.Move
.down.one.stack.frame.and.output.it#2E#0A..11{.LET.
a.#3D.pptr!0>>B2Wsh#0A..13IF.pptr#3Dcptr.DO.{.write
f(".Base.of.stack*n")#0A..31GOTO.recover#0A..29}#0A
..13fsize.:#3D.pptr-a#0A..13pptr.:#3D.a#0A..13wrfra
me()#0A..13GOTO.recover#0A..11}#0A#0A..2CASE.';':.I
F.cptr.DO#0A..12{.LET.c.#3D.cont(cptr+co_parent)#0A
..14IF.c<#3D0.DO#0A..14{.writef(".A.root.coroutine.
has.no.parent*n")#0A..16GOTO.recover#0A..14}#0A..14
cptr.:#3D.c#0A..12}#0A..12GOTO.newc#0A#0A..2CASE.'#2E
':.cptr.:#3D.cont(gptr+g_currco)#0A..12GOTO.newc#0A
#0A..2CASE.']':.cptr.:#3D.cont(cptr+co_list)#0A..12
IF.cptr#3D0.DO.{.writef(".End.of.coroutine.list*n")
#0A..27GOTO.recover#0A..25}#0A..12GOTO.newc#0A#0A..
2CASE.'[':.cptr.:#3D.cont(gptr+g_colist)#0A#0Anewc:
..7UNLESS.cptr.DO#0A..12{.writef("No.such.coroutine
*n")#0A..14GOTO.recover#0A..12}#0A..12TEST.cptr#3Dc
ont(gptr+g_currco)#0A..12THEN.pptr.:#3D.regs!r_p>>B
2Wsh#0A..12ELSE.pptr.:#3D.cont(cptr+co_pptr)>>B2Wsh
#0A..12fsize.:#3D.cptr.+.6.+.cptr!co_size.-.pptr#0A
..12wrcortn()#0A..12GOTO.recover#0A#0A..}#0A#0Aret:
#0A..//.Set.BRK.instructions.at.the.breakpoint.and.
resume#2E#0A..FOR.i.#3D.0.TO.9.DO.{.LET.ba#3Dbpt_ad
dr!i.//.Set.all.breakpoints#2E#0A..20IF.ba.DO.0%ba.
:#3D.f_brk#0A..18}#0Aretstep:#0A..//.Resume.executi
on.without.setting.BRK.instructions.at.the.breakpoi
nts#2E#0A..//.This.is.used.by.the.'\'.command.and.w
hen.resuming.from.a.breakpoint#2E#0A#0A..//.Must.en
sure.that.regs.is.restored.to.its.original.value#2E
#0A..regs.:#3D.trapregs#0A#0A//sawritef("sadebug:.r
etstep.reached*n")#0A//..rtn_insadebug!rootnode.:#3D
.FALSE#0A..RESULTIS.TRUE..//.Successful.return.from
.sadebug#0A}#0A#0AAND.prprompt().BE#0A{.#0A..writef
("**.")..//.Standalone.prompt#0A}#0A#0AAND.wrcortn(
).BE#0A{.LET.size.#3D.cont(cptr+co_size)#0A..LET.hw
m.#3D.size+6#0A..writef(".%i7:.",.cptr)#0A..writes(
"..Coroutine:")#0A..writearg(cont(cptr+co_fn))#0A..
writef("..Parent.%n",.cptr!co_parent)#0A..WHILE.con
t(cptr+hwm)#3Dstackword.DO.hwm:#3Dhwm-1#0A..writef(
"..Stack.%n/%n*n",.hwm-6,.size)#0A..prprompt()#0A..
wrch('.')#0A..wrframe()#0A}#0A#0AAND.wrframe().BE#0A
{.writef("%i8:",.pptr)#0A..TEST.pptr#3Dcptr#0A..THE
N.writef("..#23StackBase#23")#0A..ELSE.writearg(ppt
r!2)#0A..FOR.i#3D3.TO.6.IF.i<fsize.DO.print(cont(pp
tr+i))#0A..newline()#0A..IF.fsize>7.DO#0A..{.prprom
pt()#0A..2writef("..8")#0A..2FOR.i.#3D.7.TO.11.IF.i
<fsize.DO.print(cont(pptr+i))#0A..2newline()#0A..}#0A
..IF.fsize>12.DO#0A..{.prprompt()#0A..2writef("..8"
)#0A..2FOR.i.#3D.12.TO.16.IF.i<fsize.DO.print(cont(
pptr+i))#0A..2newline()#0A..}#0A..IF.fsize>17.DO#0A
..{.prprompt()#0A..2writef("..8")#0A..2FOR.i.#3D.17
.TO.21.IF.i<fsize.DO.print(cont(pptr+i))#0A..2newli
ne()#0A..}#0A}#0A#0AAND.writearg(n).BE#0A{.LET.name
.#3D.fname(n)#0A..TEST.bitsperword#3D32#0A..THEN.//
.Write.value.in.a.field.width.of.21#0A..5TEST.name#0A
..5THEN.{.LET.len.#3D.name%0#0A..12WHILE.len>0.&.na
me%len#3D'.'.DO.len.:#3D.len-1#0A..12FOR.i.#3D.len+
1.TO.13.DO.wrch('.')#0A..12FOR.i.#3D.1.TO.len.DO.wr
ch(name%i)..//.MR.17/11/06#0A..10}#0A..5ELSE.TEST.g
lobword<#3Dn<#3Dglobword+gptr!0#0A..10THEN.writef("
..5#23G%z3#23",.n-globword)#0A..10ELSE.TEST.-1005<#3D
n<#3D1005#0A..15THEN.writef("..%iB",.n)#0A..15ELSE.
writef("..1#23x%x8",.n)#0A..ELSE.//.Write.value.in.
a.field.width.of.21#0A..5TEST.name#0A..5THEN.{.LET.
len.#3D.name%0#0A..12WHILE.len>0.&.name%len#3D'.'.D
O.len.:#3D.len-1#0A..12FOR.i.#3D.len+1.TO.21.DO.wrc
h('.')#0A..12FOR.i.#3D.1.TO.len.DO.wrch(name%i)..//
.MR.17/11/06#0A..10}#0A..5ELSE.TEST.globword<#3Dn<#3D
globword+gptr!0#0A..10THEN.writef("..13#23G%z3#23",
.n-globword)#0A..10ELSE.TEST.-1005<#3Dn<#3D1005#0A.
.15THEN.writef("..%iJ",.n)#0A..15ELSE.writef("..1#23
x%xG",.n)#0A}#0A#0AAND.fname(f).#3D.VALOF#0A{.LET.n
ameoffset.#3D.bitsperword#3D32.->.3,.2#0A..LET.n.#3D
.(f>>B2Wsh).-.nameoffset#0A..UNLESS.(f&(bytesperwor
d-1))#3D0.&#0A..7membase+2<n<#3Dmemlim.RESULTIS.0./
/.MR.25/9/03#0A..IF.n!-1#3Dentryword.&.n%0#3D11.RES
ULTIS.n.#0A..RESULTIS.0#0A}#0A#0AAND.rdn().#3D.VALO
F#0A{.LET.res.#3D.0#0A..WHILE.'0'<#3Dch<#3D'9'.DO.{
.res.:#3D.res*10.+.ch.-.'0';.rch().}#0A..RESULTIS.r
es#0A}#0A#0AAND.rdvaraddr(type).#3D.VALOF#0A{.LET.b
ase,.lim,.n.#3D.?,.?,.?#0A..UNLESS.'0'<#3Dch<#3D'9'
.DO.error()#0A..n.:#3D.rdn()#0A..SWITCHON.type.INTO
#0A..{.DEFAULT:..1error()#0A..2CASE.'P':.base,.lim.
:#3D.pptr,..1fsize;..9ENDCASE#0A..2CASE.'G':.base,.
lim.:#3D.gptr,..1gptr!g_globsize;.ENDCASE#0A..2CASE
.'R':.base,.lim.:#3D.regs,..1r_upb;..9ENDCASE#0A..2
CASE.'V':.base,.lim.:#3D.vars,..0019;..13ENDCASE#0A
..//CASE.'W':.base,.lim.:#3D.crntcb,.tcb_upb;..7END
CASE#0A..2CASE.'A':.base,.lim.:#3D.0,..4memlim;..8E
NDCASE#0A..}#0A..UNLESS.0<#3Dn<#3Dlim.DO.error()#0A
..RESULTIS.base.+.n#0A}#0A#0AAND.rdval().#3D.VALOF#0A
{.LET.res,.radix.#3D.0,.10#0A#0A..SWITCHON.ch.INTO#0A
..{.DEFAULT:..1error()#0A#0A..2CASE.'G':..rch()#0A.
.13IF.'0'<#3Dch<#3D'9'.RESULTIS.!rdvaraddr('G')#0A.
.13RESULTIS.gptr#0A#0A..2CASE.'P':..rch()#0A..13IF.
'0'<#3Dch<#3D'9'.RESULTIS.!rdvaraddr('P')#0A..13RES
ULTIS.pptr#0A#0A..2CASE.'R':..rch()#0A..13IF.'0'<#3D
ch<#3D'9'.RESULTIS.!rdvaraddr('R')#0A..13RESULTIS.r
egs#0A#0A..2CASE.'V':..rch()#0A..13IF.'0'<#3Dch<#3D
'9'.RESULTIS.!rdvaraddr('V')#0A..13RESULTIS.vars#0A
#0A..2CASE.'A':..rch()#0A..13IF.'0'<#3Dch<#3D'9'.RE
SULTIS.!rdvaraddr('A')#0A..13RESULTIS.0#0A#0A..2CAS
E.'*'':.rch();.res.:#3D.lch;.rch();..RESULTIS.res#0A
#0A..2CASE.'#23':..radix.:#3D.16#0A..13rch()#0A..13
IF.ch#3D'O'.DO.{.radix.:#3D.8;.rch().}#0A#0A..2CASE
.'0':.CASE.'1':.CASE.'2':.CASE.'3':.CASE.'4':.#0A..
2CASE.'5':.CASE.'6':.CASE.'7':.CASE.'8':.CASE.'9':.
#0A..13{.LET.d.#3D.100#0A..15IF.'0'<#3Dch<#3D'9'.DO
.d.:#3D.ch-'0'#0A..15IF.'A'<#3Dch<#3D'F'.DO.d.:#3D.
ch-'A'+10#0A..15IF.d>#3Dradix.RESULTIS.res#0A..15re
s.:#3D.res*radix+d#0A..15rch()#0A..13}.REPEAT#0A..}
#0A}#0A#0AAND.praddr(a).BE#0A{.LET.type,.base.#3D.'
A',.0#0A..IF.pptr.<#3D.a.<#3D.pptr+fsize..9DO.type,
.base.:#3D.'P',.pptr#0A..IF.gptr.<#3D.a.<#3D.gptr+g
ptr!g_globsize.DO.type,.base.:#3D.'G',.gptr#0A..IF.
vars.<#3D.a.<#3D.vars+9..13DO.type,.base.:#3D.'V',.
vars#0A..IF.regs.<#3D.a.<#3D.regs+r_upb..9DO.type,.
base.:#3D.'R',.regs#0A..writef("*n%c%i5:",.type,.a-
base)#0A}#0A#0AAND.print(n).BE#0ATEST.bitsperword#3D
32#0ATHEN.//.Write.32-bit.value.in.given.style.in.a
.field.width.of.13#0A..3SWITCHON.style.INTO#0A..3{.
DEFAULT:..1error();..15RETURN#0A..5CASE.'C':..{.LET
.p.#3D.@n#0A..18writes("..7")#0A..18FOR.i.#3D.0.TO.
3.DO#0A..18{.LET.ch.#3D.p%i#0A..20wrch(32<#3Dch<#3D
127.->.ch,.'#2E')#0A..18}#0A..18RETURN#0A..16}#0A..
5CASE.'B':..writef(."..%bW",.n);..3RETURN#0A..5CASE
.'D':..writef(."..%IB",.n);..3RETURN#0A..5CASE.'F':
..writearg(n);..11RETURN#0A..5CASE.'O':..writef(.".
.%OB",.n);..3RETURN#0A..5CASE.'S':..checkaddr(n)#0A
..16writef(."..%S",..n);..3RETURN#0A..5CASE.'U':..w
ritef(."..%UB",.n);..3RETURN#0A..5CASE.'X':..writef
(."..3%X8",.n);..RETURN#0A..3}#0AELSE.//.Write.64-b
it.value.in.given.style.in.a.field.width.of.21#0A..
3SWITCHON.style.INTO#0A..3{.DEFAULT:..1error();..15
RETURN#0A..5CASE.'C':..{.LET.p.#3D.@n#0A..18writes(
".")#0A..18FOR.i.#3D.0.TO.7.DO#0A..18{.LET.ch.#3D.p
%i#0A..20wrch(32<#3Dch<#3D127.->.ch,.'#2E')#0A..18}
#0A..18RETURN#0A..16}#0A..5CASE.'B':..TEST.bitsperw
ord#3D32#0A..16THEN.writef(.".%32b.",.n)#0A..16ELSE
.writef(.".%64b.",.n)#0A..16RETURN#0A#0A..5CASE.'D'
:..TEST.bitsperword#3D32#0A..16THEN.writef(.".%10i.
",.n)#0A..16ELSE.writef(.".%20i.",.n)#0A..16RETURN#0A
#0A..5CASE.'F':..writearg(n);..11RETURN#0A#0A..5CAS
E.'O':..TEST.bitsperword#3D32#0A..16THEN.writef(.".
%11o.",.n)#0A..16ELSE.writef(.".%22o.",.n)#0A..16RE
TURN#0A#0A..5CASE.'S':..checkaddr(n)#0A..16writef(.
".%S.",..n);..3RETURN#0A#0A..5CASE.'U':..TEST.bitsp
erword#3D32#0A..16THEN.writef(.".%10U.",.n)#0A..16E
LSE.writef(.".%20U.",.n)#0A..16RETURN#0A#0A..5CASE.
'X':..TEST.bitsperword#3D32#0A..16THEN.writef(.".%8
x.",.n)#0A..16ELSE.writef(.".%16x.",.n)#0A..16RETUR
N#0A..3}#0A#0AAND.checkaddr(a).#3D.VALOF#0A{.UNLESS
.membase<#3Da<#3Dmemlim.DO.error()#0A..RESULTIS.a#0A
}#0A#0AAND.cont(a).#3D.!checkaddr(a)#0A#0AAND.error
().BE.{.writes("..??*n");.longjump(recp,.recl).}#0A
#0AAND.wrfcode(f).BE#0A{.LET.s.#3D.VALOF.SWITCHON.f
&31.INTO#0A..{.DEFAULT:#0A..2CASE..0000:.RESULTIS."
..3-..3K..1LLP..3L..2LP..2SP..2AP..3A"#0A..2CASE..0
001:.RESULTIS.".FLTOP..2KH..LLPH..2LH..1LPH..1SPH..
1APH..2AH"#0A..2CASE..0002:.RESULTIS."..1BRK..2KW..
LLPW..2LW..1LPW..1SPW..1APW..2AW"#0A..2CASE..0003:.
RESULTIS."..2K3..1K3G..K3G1..K3GH..1LP3..1SP3..1AP3
..L0P3"#0A..2CASE..0004:.RESULTIS."..2K4..1K4G..K4G
1..K4GH..1LP4..1SP4..1AP4..L0P4"#0A..2CASE..0005:.R
ESULTIS."..2K5..1K5G..K5G1..K5GH..1LP5..1SP5..1AP5.
.L0P5"#0A..2CASE..0006:.RESULTIS."..2K6..1K6G..K6G1
..K6GH..1LP6..1SP6..1AP6..L0P6"#0A..2CASE..0007:.RE
SULTIS."..2K7..1K7G..K7G1..K7GH..1LP7..1SP7..1AP7..
L0P7"#0A..2CASE..0008:.RESULTIS."..2K8..1K8G..K8G1.
.K8GH..1LP8..1SP8..1AP8..L0P8"#0A..2CASE..0009:.RES
ULTIS."..2K9..1K9G..K9G1..K9GH..1LP9..1SP9..1AP9..L
0P9"#0A..2CASE.10:.RESULTIS."..1K10..K10G.K10G1.K10
GH..LP10..SP10..AP10.L0P10"#0A..2CASE.11:.RESULTIS.
"..1K11..K11G.K11G1.K11GH..LP11..SP11..AP11.L0P11"#0A
..2CASE.12:.RESULTIS."..2LF..1S0G..S0G1..S0GH..LP12
..SP12..AP12.L0P12"#0A..2CASE.13:.RESULTIS."..1LF$.
.1L0G..L0G1..L0GH..LP13..SP13.XPBYT..3S"#0A..2CASE.
14:.RESULTIS."..2LM..1L1G..L1G1..L1GH..LP14..SP14..
1LMH..2SH"#0A..2CASE.15:.RESULTIS."..1LM1..1L2G..L2
G1..L2GH..LP15..SP15..1BTC..MDIV"#0A..2CASE.16:.RES
ULTIS."..2L0..2LG..1LG1..1LGH..LP16..SP16..1NOP.CHG
CO"#0A..2CASE.17:.RESULTIS."..2L1..2SG..1SG1..1SGH.
.1SYS..2S1..2A1..1NEG"#0A..2CASE.18:.RESULTIS."..2L
2..1LLG..LLG1..LLGH..1SWB..2S2..2A2..1NOT"#0A..2CAS
E.19:.RESULTIS."..2L3..2AG..1AG1..1AGH..1SWL..2S3..
2A3..L1P3"#0A..2CASE.20:.RESULTIS."..2L4..1MUL..1AD
D..2RV..2ST..2S4..2A4..L1P4"#0A..2CASE.21:.RESULTIS
."..2L5..1DIV..1SUB..1RV1..1ST1..1XCH..2A5..L1P5"#0A
..2CASE.22:.RESULTIS."..2L6..1REM..1LSH..1RV2..1ST2
..GBYT..RVP3..L1P6"#0A..2CASE.23:.RESULTIS."..2L7..
1XOR..1RSH..1RV3..1ST3..PBYT..RVP4..L2P3"#0A..2CASE
.24:.RESULTIS."..2L8..2SL..1AND..1RV4..STP3..1ATC..
RVP5..L2P4"#0A..2CASE.25:.RESULTIS."..2L9..1SL$..2O
R..1RV5..STP4..1ATB..RVP6..L2P5"#0A..2CASE.26:.RESU
LTIS."..1L10..2LL..1LL1..1RV6..STP5..3J..RVP7..L3P3
"#0A..2CASE.27:.RESULTIS."..FHOP..1LL$..LL1$..1RTN.
.GOTO..2J$.ST0P3..L3P4"#0A..2CASE.28:.RESULTIS."..1
JEQ..1JNE..1JLS..1JGR..1JLE..1JGE.ST0P4..L4P3"#0A..
2CASE.29:.RESULTIS."..JEQ$..JNE$..JLS$..JGR$..JLE$.
.JGE$.ST1P3..L4P4"#0A..2CASE.30:.RESULTIS."..JEQ0..
JNE0..JLS0..JGR0..JLE0..JGE0.ST1P4.SELLD"#0A..2CASE
.31:.RESULTIS.".JEQ0$.JNE0$.JLS0$.JGR0$.JLE0$.JGE0$
..2MW.SELST"#0A..}#0A..LET.n.#3D.f>>0005.&.7#0A..FO
R.i.#3D.6*n+1.TO.6*(n+1).DO.wrch(s%i)#0A}#0A#0AAND.
prinstr(pc).BE#0A{.LET.a,.b,.c.#3D.0,.0,.0#0A..writ
ef(".%i7:.",.pc)#0A..checkaddr(pc>>B2Wsh)#0A..wrfco
de(0%pc)#0A..SWITCHON.instrtype(0%pc).INTO#0A..{.DE
FAULT:#0A..2CASE.'0':..36RETURN#0A..2CASE.'1':.a.:#3D
.gb(pc+1);..21ENDCASE#0A..2CASE.'2':.a.:#3D.gh(pc+1
);..21ENDCASE#0A..2CASE.'F':.a.:#3D.gb(pc+1)#0A..12
writef("..%n",.a)#0A..12IF.a#3Dfl_mk.DO#0A..12{.LET
.m.#3D.gw(pc+2)#0A..14LET.e.#3D.gw(pc+6)#0A..14writ
ef("..%n.%n",.m,.e)#0A..12}#0A..12RETURN#0A..2CASE.
'X':.a..:#3D.gb(pc+1)#0A..12b..:#3D.gb(pc+2)#0A..12
writef("..%n.%n",.a,.b)#0A..12RETURN#0A..2CASE.'Y':
.a..:#3D.gb(pc+1)#0A..12b..:#3D.gb(pc+2)#0A..12c..:
#3D.gb(pc+3)#0A..12writef("..%n.%n.%n",.a,.b,.c)#0A
..12RETURN#0A#0A..2CASE.'4':.a..:#3D.gw(pc+1);..20E
NDCASE#0A..2CASE.'R':.a..:#3D.pc+1.+.gsb(pc+1);..12
ENDCASE#0A..2CASE.'I':.pc.:#3D.pc+1.+.2*gb(pc+1).&.
#23xFF5E#0A..12a..:#3D.pc.+.gsh(pc);..16ENDCASE#0A.
.}#0A..TEST.-10_001_001.<.a.<.10_001_001#0A..THEN.w
ritef("..%n",.a)#0A..ELSE.writef("..#23%x8",.a)#0A.
.vars!9.:#3D.a#0A}#0A#0AAND.gb(pc).#3D.0%pc#0A#0AAN
D.gsb(pc).#3D.0%pc<#3D127.->.0%pc,.0%pc-256#0A#0AAN
D.gsh(pc).#3D.VALOF#0A{.LET.h.#3D.gh(pc)#0A..RESULT
IS.h<#3D#23x7FF1.->.h,.h.-.#23x1002#0A}#0A#0AAND.gh
(pc).#3D.VALOF#0A{.LET.w.#3D.?#0A..LET.p.#3D.@w..//
.Designed.to.work.on.both.Big.and.Little.Ender.M/Cs
#2E#0A..p%0,.p%1,.p%2,.p%3.:#3D.0%pc,.0%(pc+1),.0%p
c,.0%(pc+1)#0A..RESULTIS.w.&.#23xFF2#0A}#0A#0AAND.g
w(pc).#3D.VALOF#0A{.LET.w.#3D.?#0A..LET.p.#3D.@w../
/.Designed.to.work.on.both.Big.and.Little.Ender.M/C
s#2E#0A..p%0,.p%1,.p%2,.p%3.:#3D.0%pc,.0%(pc+1),.0%
(pc+2),.0%(pc+3)#0A..RESULTIS.w#0A}#0A#0AAND.instrt
ype(f).#3D."F008RI10011RIRI*#0A..16*12411015002RIRI
RIRI*#0A..16*12411015004RIRIRI*#0A..16*12422015006R
IRI*#0A..16*1240013BL006RIRI*#0A..16*1240021RIRIRI*
#0A..16*124008?2?000134*#0A..16*1240000812?0012XY"%
f#0A#0AAND.nextpc(pc).#3D.VALOF.SWITCHON.instrtype(
0%pc).INTO#0A..21{.DEFAULT:#0A..23CASE.'0':.RESULTI
S.pc+1#0A..23CASE.'1':#0A..23CASE.'F':.//.FLTOP.MK.
exponent#0A..33//.FLTOP.op#0A..33IF.0%(pc+1)#3Dfl_m
k.RESULTIS.pc+3#0A..33RESULTIS.pc+2#0A..23CASE.'R':
#0A..23CASE.'I':.RESULTIS.pc+2#0A..23CASE.'X':..13/
/.SELLD.len.sh#0A..23CASE.'2':.RESULTIS.pc+3#0A..23
CASE.'Y':.RESULTIS.pc+4.//.SELST.op.len.sh#0A..23CA
SE.'4':.RESULTIS.pc+5#0A..23CASE.'B':.pc.:#3D.pc+2.
&.#23xFF5E#0A..33RESULTIS.pc.+.4*gh(pc).+.6#0A..23C
ASE.'L':.pc.:#3D.pc+2.&.#23xFF5E#0A..33RESULTIS.pc.
+.2*gh(pc).+.6#0A..21}#0A#0AAND.rch().BE.{.lch.:#3D
.rdch();.ch.:#3D.capitalch(lch).}#0A#0A

######sysb/cli.b#
//.(c).Copyright.M#2E.Richards,.23.April.2010#0A#0A
/*.Change.log#0A#0A00023/04/10#0AChanged.to.new.dat
stamp.format#2E#0A#0A00027/06/07#0AAdded.setseed(12
345).since.the.random.number.seed.is.now.a.global#0A
variable.(not.a.static)#2E#0A#0A00017/01/06#0AAs.su
ggested.by.Dave.Lewis,.ignore.commands.starting.wit
h.a.#23#2E.This#0Aenables.executable.Unix.command.s
cripts.using.text.like:#0A#23!/usr/local/bin/cintsy
s.-s#0Aas.the.first.line.of.the.script.file#2E#0A21
/5/2000001#0AChanged.manifest.cli_initialstack.to.5
002.in.CLIHDR.(previously.5001)#0A*/#0A#0ASECTION."
CLI"#0A#0AGET."libhdr"#0A//GET."clihdr"#0A#0AMANIFE
ST#0A{.namemax..1#3D.25#0A..promptmax.#3D.15#0A..fi
lemax..1#3D.10#0A}#0A#0ALET.start(parm_pkt).BE.//.p
arm_pkt.only.used.in.Cintpos#0A{.LET.prompt..4#3D.V
EC.promptmax#0A..LET.commandname.#3D.VEC.namemax#0A
..LET.commandfile.#3D.VEC.filemax..//.Command-comma
nd.file.name,.if.in.use#0A..LET.globbase..2#3D.@glo
bsize..2//.globsize.is.global.0#0A..LET.cpumsecs..2
#3D.sys(Sys_cputime)#0A..LET.initprompt..#3D."%5#2E
3d>."#0A..//LET.initprompt.#3D."%5#2E3d.%+%2i:%2z:%
2z#2E%3z>.".//.Useful.for.debugging#0A..LET.datavec
..3#3D.VEC.10..5//.Used.as.private.data.by.some.CLI
s#0A..31//.tcpcli.uses.it.to.hold.the.TCP#0A..31//.
stream.name#2E#0A..FOR.i.#3D.0.TO.10.DO.datavec!i.:
#3D.0#0A..1#0A..cli_data..6:#3D.datavec..5//.MR.10/
7/03#0A..cli_status..4:#3D.0..11//.MR.10/7/03#0A..c
li_prompt..4:#3D.prompt#0A..cli_commandname.:#3D.co
mmandname#0A..cli_commandfile.:#3D.commandfile#0A#0A
..FOR.i.#3D.0.TO.initprompt%0.DO#0A..2cli_prompt%i.
:#3D.initprompt%i#0A#0A..cli_standardinput.:#3D.inp
ut()#0A..cli_currentinput.:#3D.cli_standardinput#0A
..cli_standardoutput.:#3D.output()#0A..cli_commandn
ame%0.:#3D.0#0A..cli_commandfile%0.:#3D.0#0A..cli_d
efaultstack.:#3D.cli_initialstack#0A..cli_returncod
e.:#3D.0#0A..cli_result2.:#3D.0#0A..cli_module.:#3D
.0#0A..cli_preloadlist.:#3D.0#0A..cli_tallyflag.:#3D
.FALSE#0A..cli_faillevel.:#3D.cli_initialfaillevel#0A
#0A..setseed(12345).//.MR.27/6/07#0A#0A..IF.rootnod
e!rtn_boottrace.DO#0A..2sawritef("cli:.now.entering
.the.main.CLI.loop*n")#0A#0A..{.LET.ch,.item.#3D.'*
n',.?#0A#0A..2{.//.Start.of.main.command.loop#0A..4
//cli_interactive.:#3D..cli_currentinput#3Dcli_stan
dardinput#0A#0A..4//.Possibly.output.the.prompt#0A.
.4IF.ch#3D'*n'.&.cli_currentinput#3Dcli_standardinp
ut.DO#0A..4{.LET.hours,.mins,.secs.#3D.0,.0,.0#0A..
6LET.days,.msecs,.flag.#3D.0,.0,.0.#0A..6datstamp(@
days)#0A..6secs..:#3D.msecs../..0001001#0A..6msecs.
:#3D.msecs.MOD.1001#0A..6mins..:#3D.secs..1/..00060
#0A..6hours.:#3D.mins..1/..00060#0A..6mins..:#3D.mi
ns..MOD.60#0A..6secs..:#3D.secs..MOD.60#0A#0A..6//.
Calculate.msecs.since.issuing.last.prompt#0A..6cpum
secs.:#3D.sys(Sys_cputime).-.cpumsecs#0A#0A..6write
f(cli_prompt,#0A..13cpumsecs,.//.msecs.used.by.last
.command#0A..0130,..6//.The.task.number,.if.running
.under.Cintpos#0A..13hours,.mins,.secs,.msecs).//.T
he.time.of.day#0A..6deplete(cos)#0A#0A..6cpumsecs.:
#3D.sys(Sys_cputime)#0A..4}#0A#0A..4item.:#3D.rdite
m(cli_commandname,.namemax)#0A#0A..4SWITCHON.item.I
NTO#0A..4{.CASE.0:.//.The.item.was:.eof#0A..8IF.cli
_currentinput#3Dcli_standardinput.DO.sys(Sys_quit,.
0)#0A..8BREAK#0A#0A..6CASE.1:.//.The.item.was:.unqu
oted.name#0A..6CASE.2:.//.The.item.was:.quoted.name
#0A..6{.LET.p,.coptr.#3D.cli_preloadlist,.0#0A..8//
.If.the.command.name.is.#23.or.starts.with.a.#23,#0A
..8//.treat.the.command.as.a.comment,#0A..8//.ie.sk
ip.to.just.before.EOL.or.EOF#2E#0A..8IF.cli_command
name%0.>.0.&.cli_commandname%1.#3D.'#23'.DO#0A..8{.
LET.ch.#3D.?#0A..10ch.:#3D.rdch().REPEATUNTIL.ch#3D
'*n'.|.ch#3D';'.|.ch#3Dendstreamch#0A..10IF.ch#3D'*
n'.DO.unrdch()#0A..10LOOP#0A..8}#0A.#0A..8WHILE.p.D
O..10//.Search.in.preloadlist#2E#0A..8{.IF.compstri
ng(cli_commandname,.@p!2)#3D0.DO#0A..10{.cli_module
.:#3D.p!1#0A..12BREAK..11//.Module.found#2E#0A..10}
#0A..10p.:#3D.!p#0A..8}#0A#0A..8UNLESS.cli_module.D
O.cli_module.:#3D.loadseg(cli_commandname)#0A#0A..8
start.:#3D.globword+1.//.Unset.start#0A..8UNLESS.gl
obin(cli_module)#3D0.DO#0A..10coptr.:#3D.createco(c
lihook,.cli_defaultstack)#0A..8TEST.coptr#3D0#0A..8
THEN.{.cli_result2.:#3D.result2#0A..15writef("Can't
.load.%s*n",.cli_commandname)#0A..13}#0A..8ELSE.{.I
F.cli_tallyflag.DO#0A..15{.cli_tallyflag.:#3D.FALSE
#0A..17sys(Sys_tally,.TRUE)..1//.Turn.on.tallying#0A
..15}#0A#0A..15//.Transfer.control.to.the.command,#0A
..15//.and.save.the.return.code#2E#0A..15cli_return
code.:#3D.callco(coptr,.0)#0A..15cli_result2.:#3D.r
esult2#0A#0A..15sys(Sys_tally,.FALSE)..2//.Turn.off
.tallying#0A#0A..15//.Unset.user.globals#0A..15FOR.
i.#3D.ug.TO.globsize.DO#0A..17globbase!i.:#3D.globw
ord.+.i#0A#0A..15//.Restore.the.library.globals#0A.
.15globin(rootnode!rtn_blib)#0A..15//globin(rootnod
e!rtn_cli)#0A#0A..15deleteco(coptr)#0A..15selectinp
ut.(cli_currentinput)#0A..15selectoutput(cli_standa
rdoutput)#0A#0A..15IF.cli_returncode.>#3D.cli_faill
evel.DO#0A..15{.writef("%s.failed.returncode.%n",#0A
..25cli_commandname,.cli_returncode)#0A..17IF.cli_r
esult2.DO#0A..19writef(".reason.%n",.cli_result2)#0A
..17newline()#0A..15}#0A..13}#0A#0A..8IF.p#3D0.&.cl
i_module.DO.unloadseg(cli_module)#0A..8cli_module.:
#3D.0#0A..6}#0A#0A..6CASE.3:.//.The.item.was:.'*n'#0A
..6CASE.4:.//.The.item.was:.';'#0A..8ENDCASE#0A#0A.
.6DEFAULT://.Unknown.item#2E.#0A..8writes("Error.in
.command.name*n")#0A..4}#0A#0A..4ch.:#3D.'*n'#0A..4
IF.unrdch().DO.ch.:#3D.rdch()#0A..4//.Skip.to.end.o
f.line.unless.last.command.terminated.by.nl.or.;#0A
..4UNTIL.ch#3D'*n'.|.ch#3D';'.|.ch#3Dendstreamch.DO
.ch.:#3D.rdch()#0A#0A..4IF.intflag().DO.{.writes("*
*2BREAK.-.CLI*N")#0A..22BREAK#0A..20}#0A..2}.REPEAT
#0A#0A..2IF.(cli_status.&.clibit_comcom).~#3D.0.DO#0A
..2{.//.We.were.within.a.command-command,.so.close.
the.stream#0A..4endstream(cli_currentinput)#0A..4cl
i_currentinput.:#3D.cli_standardinput#0A..4selectin
put(cli_currentinput)#0A#0A//sawritef("cli:.deletin
g.command.file.%s*n",.cli_commandfile)#0A#0A..4//.a
nd.delete.the.command.file#0A..4IF.cli_commandfile%
0.DO.{.sys(Sys_deletefile,.cli_commandfile)#0A..30c
li_commandfile%0.:#3D.0#0A..28}#0A..4cli_status.:#3D
.cli_status.&.~clibit_comcom#0A..2}#0A..}.REPEAT#0A
}#0A

######sysb/dlib.b#
//.This.is.DLIB.(system.dependent.library).for.sing
le.threaded#0A//.Cintcode.BCPL#0A#0A//.It.contains.
functions.that.have.different.definitions.in.Cintpo
s#0A#0A/*#0AChange.log#0A#0A0009/11/06#0AChange.tre
atment.of.RUBOUT.(#23x7F)#0A#0A*/#0A#0ASECTION."DLI
B"#0A#0AGET."libhdr"#0A#0AMANIFEST.{#0A..char_bs.#3D
.8#0A..buflen..#3D.4096.//.Must.equal.the.block.siz
e#0A}#0A#0ALET.findstream(name,.id,.path).#3D.VALOF
.//.MR.8/5/03#0A{.LET.console.#3D.compstring("**",.
name)#3D0#0A..LET.scb.#3D.?#0A..LET.res.#3D.0#0A..L
ET.prefix.#3D.VEC.31#0A#0A//TEST.path#0A//THEN.sawr
itef("DLIB:.findstream(%s,.%n,.%s)*n",.name,.id,.pa
th)#0A//ELSE.sawritef("DLIB:.findstream(%s,.%n,.0)*
n",.name,.id)#0A//sawritef("DLIB:.currentdir#3D%n*n
",.currentdir)#0A//sawritef("findstream:.name#3D%s*
n",.name)#0A..IF.console.DO#0A..{.IF.id#3Did_inscb.
&.rootnode!rtn_keyboard.RESULTIS.rootnode!rtn_keybo
ard#0A..2IF.id#3Did_outscb.&.rootnode!rtn_screen..R
ESULTIS.rootnode!rtn_screen#0A..}.#0A#0A..scb.:#3D.
getvec(scb_upb)#0A..UNLESS.scb.RESULTIS.0#0A#0A//sa
writef("findstream:.task.%i2.allocating.scb.#3D%i6.
for.%s*n",.taskid,.scb,.name)#0A..//.Clear.all.scb.
fields#0A..FOR.i.#3D.0.TO.scb_upb.DO.scb!i.:#3D.0#0A
#0A..scb!scb_id.:#3D.id..//.id_inscb,.id_outscb,.id
_inoutscb.or.id_appendscb#0A#0A..//.Copy.(truncated
).stream.name.into.the.scb#0A..{.LET.len.#3D.name%0
#0A..2LET.scbname.#3D.@scb!scb_name#0A..2LET.maxlen
.#3D.scb_maxnamelen#0A..2IF.len>scb_maxnamelen.DO.l
en.:#3D.scb_maxnamelen#0A..2FOR.i.#3D.1.TO.len.DO.s
cbname%i.:#3D.name%i#0A..2scbname%0.:#3D.len#0A..}#0A
#0A..IF.console.DO#0A..{.//.Console.stream.being.op
ened.for.the.first.time#0A..2LET.buf.#3D.getvec(409
5/bytesperword).//.Room.for.4096.bytes#0A..2UNLESS.
buf.DO.{.freevec(scb);.RESULTIS.0.}#0A..2scb!scb_ty
pe..2:#3D.scbt_console#0A..2scb!scb_buf..3:#3D.buf#0A
..2scb!scb_bufend..:#3D.4096#0A..2scb!scb_endfn.:#3D
.cnslendfn#0A#0A..2IF.id#3Did_inscb.DO#0A..2{.scb!s
cb_rdfn..1:#3D.cnslrdfn.//.fn.to.replenish.current.
buffer#0A..4rootnode!rtn_keyboard.:#3D.scb#0A..4RES
ULTIS.scb#0A..2}#0A..2IF.id#3Did_outscb.DO#0A..2{.s
cb!scb_wrfn..1:#3D.cnslwrfn.//.fn.to.deplete.curren
t.buffer#0A..4rootnode!rtn_screen.:#3D.scb#0A..4RES
ULTIS.scb#0A..2}#0A..2//.Bad.stream.id#0A..2freevec
(scb)#0A..2freevec(buf)#0A..2RESULTIS.0#0A..}#0A#0A
..splitname(prefix,.':',.name,.1)#0A#0A..IF.compstr
ing(prefix,."NIL")#3D0.DO#0A..{.//.On.reading.alway
s.gives.endstreamch#0A..2//.On.writing.always.throw
s.away.the.data#0A..2scb!scb_wrfn.:#3D.nilwrfn#0A//
sawritef("DLIB:.Opening.stream.to/from.NIL:*n")#0A.
.2RESULTIS.scb.#0A..}#0A#0A..IF.compstring(prefix,.
"RAM")#3D0.DO#0A..{.//.Open.a.RAM.stream#2E#0A..2//
.It.is.always.a.read/write.stream#2E#0A..2//.Its.bu
ffer.is.automatically.extended.as.needed#2E#0A..2//
.All.stream.buffers.are.allocated.using.getvec.and#0A
..2//.must.be.freed.using.freevec.when.the.stream.i
s.closed#2E#0A..2//.Note.that.rewindstream,.note,.p
oint.and.record.access#0A..2//.all.work.with.RAM.st
reams#2E#0A..2LET.buf.#3D.getvec(1024/bytesperword)
.//.Initial.allocation#0A..2UNLESS.buf.DO.{.freevec
(scb);.RESULTIS.0.}#0A..2scb!scb_type..2:#3D.scbt_r
am#0A..2scb!scb_id..4:#3D.id_inoutscb#0A..2scb!scb_
buf..3:#3D.buf#0A..2scb!scb_pos..3:#3D.0..3//.Initi
al.position#0A..2scb!scb_end..3:#3D.0..3//.End.of.v
alid.data#0A..2scb!scb_bufend..:#3D.1024..//.Curren
t.size.of.buf#0A#0A..2scb!scb_wrfn..2:#3D.ramwrfn./
/.This.expands.the.buffer#0A//sawritef("DLIB:.Openi
ng.stream.to/from.RAM:*n")#0A..2RESULTIS.scb.#0A..}
#0A#0A..IF.compstring(prefix,."TCP")#3D0.|.compstri
ng(prefix,."NET")#3D0.DO#0A..{.sawritef("TCP.connec
tions.not.yet.available*n")#0A..2freevec(scb)#0A..2
RESULTIS.0#0A..}#0A#0A1..//.Open.a.file.stream#0A//
sawritef("DLIB:.%s.must.be.a.file*n",.name)#0A#0A..
IF.id#3Did_inscb..3&.fh0findinput..1(scb,.name,.pat
h).RESULTIS.scb#0A..IF.(id#3Did_outscb.|.id#3Did_ap
pendscb).&#0A..21fh0findoutput..(scb,.name)..5RESUL
TIS.scb#0A..IF.id#3Did_inoutscb..&.fh0findinoutput(
scb,.name)..5RESULTIS.scb#0A#0A..freevec(scb)#0A..R
ESULTIS.0#0A}#0A#0AAND.nilwrfn(scb).#3D.VALOF#0A{.s
cb!scb_pos.:#3D.0.//.Throw.away.the.buffer.contents
.(if.any)#0A..RESULTIS.TRUE#0A}#0A#0AAND.ramwrfn(sc
b).#3D.VALOF#0A{.//.Replace.the.buffer.by.one.of.tw
ice.the.size#0A..LET.oldbufend.#3D.scb!scb_bufend#0A
..LET.oldbufupb.#3D.oldbufend/bytesperword#0A..LET.
oldbuf..2#3D.scb!scb_buf#0A..LET.newbufend.#3D.oldb
ufend*2#0A..LET.newbufupb.#3D.newbufend/bytesperwor
d#0A..LET.newbuf..2#3D.getvec(newbufupb)#0A..UNLESS
.newbuf.RESULTIS.FALSE#0A..FOR.i.#3D.0.TO.oldbufupb
.DO.newbuf!i.:#3D.oldbuf!i#0A..scb!scb_buf,.scb!scb
_bufend.:#3D.newbuf,.newbufend#0A..freevec(oldbuf)#0A
..RESULTIS.TRUE#0A}#0A#0AAND.cnslrdfn(scb).#3D.VALO
F#0A{.LET.buf,.p.#3D.scb!scb_buf,.0#0A#0A//sawritef
("DLIB:.cnslrdfn:.scb#3D%n*n",.scb)#0A..{.LET.ch.#3D
.sys(Sys_sardch)#0A..2SWITCHON.ch.INTO#0A..2{.DEFAU
LT:..8buf%p.:#3D.ch#0A..22p.:#3D.p+1#0A..22IF.p<409
6.LOOP#0A..22BREAK#0A#0A..4CASE.endstreamch:.IF.p.B
REAK#0A..22//.No.characters.in.the.buffer#0A..22res
ult2.:#3D.endstreamch.//.#3D-1#0A..22RESULTIS.FALSE
#0A#0A..4CASE.'*n':..6buf%p.:#3D.ch#0A..22p.:#3D.p+
1#0A..22BREAK#0A#0A..4CASE.#23x7F:..6//.Rubout#0A..
22sys(Sys_sawrch,.char_bs)#0A..4CASE.char_bs:..3//.
Backspace.--.already.echoed#0A..22sys(Sys_sawrch,.'
.')..3//.MR.9/11/06#0A..22sys(Sys_sawrch,.char_bs)#0A
..22IF.p>0.DO.p.:#3D.p-1#0A..22LOOP#0A..2}#0A..}.RE
PEAT#0A//sawritef("DLIB:.cnslrdfn:.line.read*n")#0A
//FOR.i.#3D.0.TO.p-1.DO.sawrch(buf%i)#0A..scb!scb_p
os,.scb!scb_end.:#3D.0,.p#0A..RESULTIS.TRUE#0A}#0A#0A
AND.cnslwrfn(scb).#3D.VALOF#0A{.LET.buf.#3D.scb!scb
_buf#0A//sawritef("DLIB:.cnslwrfn(%n).called*n",.sc
b)#0A//sawritef("DLIB:.cnslwrfn:.buf#3D%n.pos#3D%n.
end#3D%n*n",#0A//..8scb!scb_buf,.scb!scb_pos,.scb!s
cb_end)#0A#0A..FOR.i.#3D.0.TO.scb!scb_pos-1.DO.sys(
Sys_sawrch,.buf%i)#0A..scb!scb_pos.:#3D.0#0A..scb!s
cb_end.:#3D.0..//.No.valid.data#0A..RESULTIS.TRUE#0A
}#0A#0AAND.cnslendfn(scb).#3D.VALOF#0A{.//freevec(s
cb!scb_buf)#0A..RESULTIS.TRUE#0A}#0A#0AAND.flush().
#3D.VALOF#0A{.IF.cos#3D0.|.cos!scb_id~#3Did_outscb.
DO.abort(187)#0A..RESULTIS.fh0wrfn(cos)#0A}..#0A#0A
AND.getremipaddr(scb).#3D.VALOF#0A{#0Asawritef("DLI
B:.getremipaddr.not.yet.available*n")#0ARESULTIS.0#0A
..1UNLESS.scb!scb_type#3Dscbt_tcp.|.scb!scb_type#3D
scbt_net.DO#0A..{.result2.:#3D.0#0A..2RESULTIS.0#0A
..}#0A..RESULTIS.0.//sendpkt(-1,.scb!scb_task,.Acti
on_getremipaddr,.0,0,.scb)#0A}#0A#0AAND.relfilename
(name).#3D.VALOF#0A{.//.Absolute.file.names.are.(eg
):#0A..//.."/abc"..2"\xyz"..1"pqr:vuw"#0A..LET.len.
#3D.name%0#0A..UNLESS.len.RESULTIS.TRUE#0A..IF.name
%1#3D'/'.|.name%1#3D'\'.RESULTIS.FALSE#0A..FOR.i.#3D
.1.TO.len.IF.name%i#3D':'.RESULTIS.FALSE#0A..RESULT
IS.TRUE#0A}#0A#0AAND.trfilename(name,.filename).BE#0A
{.LET.p.#3D.0#0A#0A//IF.currentdir.DO#0A//..1sawrit
ef("DLIB:.trfilename:.name#3D%s.currentdir#3D%n*n",
.name,.currentdir)#0A#0A..IF.currentdir.&.relfilena
me(name).DO#0A..{.LET.len.#3D.currentdir%0#0A..2LET
.lastch.#3D.currentdir%len#0A..2IF.lastch#3D'/'.|.l
astch#3D':'.DO.len.:#3D.len-1#0A..2IF.len.DO#0A..2{
.FOR.i.#3D.1.TO.len.DO.{.p.:#3D..p+1;.filename%p.:#3D
.currentdir%i.}#0A..4p.:#3D.p+1#0A..4filename%p.:#3D
.'/'#0A..2}#0A..}#0A..FOR.i.#3D.1.TO.name%0.DO.{.p.
:#3D..p+1;.filename%p.:#3D.name%i.}#0A..filename%0.
:#3D.p#0A..//FOR.i.#3D.1.TO.p.IF.filename%i#3D':'.D
O.filename%i.:#3D.'/'#0A//TEST.currentdir#0A//THEN.
sawritef("DLIB:.trfilename.%s.%s.#3D>.%s*n",.curren
tdir,.name,.filename)#0A//ELSE.sawritef("DLIB:.trfi
lename.%s.#3D>.%s*n",.name,.filename)#0A}#0A#0AAND.
fh0findinput(scb,.name,.path).#3D.VALOF#0A//.Return
s.TRUE..1if.successful#0A//.Returns.FALSE,.result2#3D
100..Can't.open.file#0A//..14result2#3D101..Can't.a
llocate.buffer#0A{.LET.fp,.buf.#3D.0,.0#0A..LET.fil
esize.#3D.0#0A..LET.filename.#3D.VEC.50#0A..trfilen
ame(name,.filename)#0A#0A//sawritef("DLIB:.fh0findi
nput.calling.sys_openread.%s.%s*n",#0A//..8filename
,.path->path,"null")#0A..//.Open.the.file.for.input
#0A..fp.:#3D.sys(Sys_openread,.filename,.path)..//.
MR.8/5/03#0A..UNLESS.fp.DO#0A..{#0A//sawritef("DLIB
:.fh0findinput.sys_openread.%s.failed*n",.filename)
#0A..2result2.:#3D.100#0A..2RESULTIS.FALSE#0A..}#0A
#0A//sawritef("DLIB:.%s.opened*n",.filename)#0A..fi
lesize.:#3Dsys(Sys_filesize,.fp)#0A//sawritef("DLIB
:.filesize#3D%n*n",.filesize)#0A#0A..//.allocate.a.
buffer#0A..buf.:#3D.getvec(buflen/bytesperword)#0A.
.UNLESS.buf.DO#0A..{.sys(Sys_close,.fp).//.First.cl
ose.the.file#0A..2result2.:#3D.101#0A..2RESULTIS.0#0A
..}#0A//sawritef("DLIB:.fh0findinput.scb.%n.fp.%n.b
uf.%n*n",.scb,.fp,.buf)#0A..2#0A..scb!scb_type..2:#3D
.scbt_file#0A..scb!scb_task..2:#3D.0#0A..scb!scb_bu
f..3:#3D.buf#0A..scb!scb_rdfn..2:#3D.fh0rdfn#0A..sc
b!scb_wrfn..2:#3D.0..5//.An.input.stream.cannot.be.
depleted#0A..scb!scb_endfn..1:#3D.fh0endfn#0A..scb!
scb_fd..4:#3D.fp#0A..scb!scb_bufend..:#3D.buflen#0A
..scb!scb_write..1:#3D.FALSE..1//.No.data.waiting.t
o.be.written#0A..scb!scb_blength.:#3D.buflen..//.MR
.15/3/02#0A..scb!scb_block..1:#3D.0..5//.MR.29/7/02
#0A..scb!scb_lblock..:#3D.filesize/buflen.//+.1..//
.MR.16/4/02.MR.29/7/02#0A..scb!scb_ldata..1:#3D.fil
esize.REM.buflen..//.MR.16/4/02#0A//sawritef("fh0fi
ndinput:.lblock#3D%n*n",.scb!scb_lblock)#0A#0A..//.
Initialise.the.buffer.by.reading.the.first.block#0A
..fh0getbuf(scb)#0A..RESULTIS.scb#0A}#0A#0AAND.fh0f
indoutput(scb,.name).#3D.VALOF#0A//.Returns.TRUE..1
if.successful#0A//.Returns.FALSE,.result2#3D100..Ca
n't.open.file#0A//..14result2#3D101..Can't.allocate
.buffer#0A{.LET.fp,.buf.#3D.0,.0#0A..LET.sysop.#3D.
scb!scb_id#3Did_appendscb.->.Sys_openappend,.Sys_op
enwrite#0A..LET.filename.#3D.VEC.50#0A..trfilename(
name,.filename)#0A#0A..//.Open.the.file.for.output#0A
..fp.:#3D.sys(sysop,.filename)#0A..UNLESS.fp.DO#0A.
.{.result2.:#3D.100#0A..2RESULTIS.FALSE#0A..}#0A#0A
..//.allocate.a.buffer#0A..buf.:#3D.getvec(buflen/b
ytesperword)#0A..UNLESS.buf.DO#0A..{.sys(Sys_close,
.fp).//.First.close.the.file#0A..2result2.:#3D.101#0A
..2RESULTIS.FALSE#0A..}#0A#0A//sawritef("DLIB:.fh0f
indoutput.scb.%n..buf.%n*n",.scb,.buf)#0A#0A..scb!s
cb_type..2:#3D.scbt_file#0A..scb!scb_task..2:#3D.0#0A
..scb!scb_buf..3:#3D.buf#0A..scb!scb_rdfn..2:#3D.0.
.5//.Can't.replenish.output.streams#0A..scb!scb_wrf
n..2:#3D.fh0wrfn#0A..scb!scb_endfn..1:#3D.fh0endfn#0A
..scb!scb_fd..4:#3D.fp#0A..scb!scb_bufend..:#3D.buf
len#0A..scb!scb_write..1:#3D.FALSE..1//.No.data.wai
ting.to.be.written#0A..scb!scb_blength.:#3D.buflen#0A
..scb!scb_block..1:#3D.0..5//.MR.29/7/02#0A..scb!sc
b_lblock..:#3D.0..5//.This.is.an.empty.file.current
ly,.MR.29/7/02#0A..scb!scb_ldata..1:#3D.0#0A//sawri
tef("fh0findoutput:.lblock#3D%n*n",.scb!scb_lblock)
#0A#0A..scb!scb_pos..3:#3D.0..5//.The.buffer.has.no
.valid.data.initially#0A..scb!scb_end..3:#3D.0#0A#0A
..result2.:#3D.0#0A..RESULTIS.TRUE#0A}#0A#0AAND.fh0
findinoutput(scb,.name).#3D.VALOF#0A//.Returns.TRUE
..1if.successful#0A//.Returns.FALSE,.result2#3D100.
.Can't.open.file#0A//..14result2#3D101..Can't.alloc
ate.buffer#0A{.LET.fp,.buf,.res1,.res2.#3D.0,.0,.1,
.0#0A..LET.filesize.#3D.0#0A..LET.filename.#3D.VEC.
50#0A..trfilename(name,.filename)#0A#0A..//.open.th
e.file.for.input.and.output#0A..fp.:#3D.sys(Sys_ope
nreadwrite,.filename)#0A//sawritef("DLIB:.open.%s.i
n.inout.mode.#3D>.%n*n",.filename,.fp)#0A..UNLESS.f
p.DO#0A..{.result2.:#3D.100#0A..2RESULTIS.FALSE#0A.
.}#0A#0A..filesize.:#3Dsys(Sys_filesize,.fp)#0A//sa
writef("BLIB:.filesize#3D%n*n",.filesize)#0A#0A..//
.allocate.a.buffer#0A..buf.:#3D.getvec(buflen/bytes
perword)#0A..UNLESS.buf.DO#0A..{.sys(Sys_close,.fp)
.//.First.close.the.file#0A..2result2.:#3D.101#0A..
2RESULTIS.FALSE#0A..}#0A//sawritef("DLIB:.buflen.#3D
.%n*n",.buflen)#0A//sawritef("DLIB:.fh0findinoutput
.scb.%n..%n..buf.%n*n",.scb,.fp,.buf)#0A#0A..scb!sc
b_type..2:#3D.scbt_file#0A..scb!scb_buf..3:#3D.buf#0A
..scb!scb_rdfn..2:#3D.fh0rdfn#0A..scb!scb_wrfn..2:#3D
.fh0wrfn#0A..scb!scb_endfn..1:#3D.fh0endfn#0A..scb!
scb_fd..4:#3D.fp#0A..scb!scb_bufend..:#3D.buflen#0A
..scb!scb_write..1:#3D.FALSE..1//.No.data.waiting.t
o.be.written#0A..scb!scb_blength.:#3D.buflen..//.MR
.15/3/02#0A..scb!scb_block..1:#3D.0.//0001.MR.29/7/
02#0A..scb!scb_lblock..:#3D.filesize/buflen.//+.1..
//.MR.16/4/02.MR.29/7/02#0A..scb!scb_ldata..1:#3D.f
ilesize.REM.buflen..//.MR.16/4/02#0A//sawritef("fh0
findinoutput:.lblock#3D%n*n",.scb!scb_lblock)#0A#0A
..//.Initialise.the.buffer.by.reading.the.first.blo
ck#0A..UNLESS.fh0getbuf(scb).DO#0A..{.//.Failed.to.
fill.the.buffer.with.data#0A..2sawritef("DLIB:.fh0g
etbuf(%n).failed*n",.scb)#0A..2RESULTIS.FALSE#0A..}
#0A..res2.:#3D.result2#0A..RESULTIS.TRUE#0A}#0A#0AA
ND.fh0falsefn(scb)..#3D.FALSE#0A#0A1AND.fh0rdfn(scb
)..#3D.VALOF#0A//.This.is.only.used.for.disc.files#2E
.The.field.end.will.equal#0A//.buflen.for.all.block
s.except.possibly.the.last.one#2E#0A//.If.the.buffe
r.contains.data.from.the.last.block.and.pos#3Dend,#0A
//.then.EOF.has.been.reached#2E.If.pos#3Dend.data.f
rom.the.next.block#0A//.must.be.read#2E.But.the.cur
rent.block.will.first.have.to.be#0A//.written.to.di
sc,.if.the.write.field.is.TRUE#2E#0A//.Returns.TRUE
,..if.successful#2E.There.will.be.valid.data.betwee
n#0A//..14pos.and.end.in.the.buffer#2E#0A//.Returns
.FALSE,.result2#3D-1.on.EOF#0A//..7FALSE,.result2#3D
errorcode,.otherwise#2E#0A{.LET.block,.lblock.#3D.s
cb!scb_block,.scb!scb_lblock#0A..LET.pos,..1end..2#3D
.scb!scb_pos,..1scb!scb_end#0A//sawritef("DLIB:.fh0
readfn.scb.%n.pos.%n.end.%n*n",.scb,.pos,.end)#0A//
sawritef("DLIB:.fh0readfn.block.%n.lblock.%n*n",.bl
ock,.lblock)#0A..IF.pos<end..4RESULTIS.TRUE..//.Dat
a.still.available.in.current.buffer#0A..IF.block#3D
lblock.DO.{.result2.:#3D.-1;.RESULTIS.FALSE.}.//.En
d-of-file#0A#0A..IF.scb!scb_write.DO.fh0putbuf(scb)
..//.Write.block.if.necessary#0A#0A..IF.end>#3Dbufl
en.DO.block.:#3D.block+1..//.Advance.block.if.neces
sary#0A..scb!scb_block,.scb!scb_pos.:#3D.block,.0#0A
//sawritef("DLIB:.fh0rdfn.block.%n.pos.%n.end.%n*n"
,.scb!scb_block,.pos,.end)#0A#0A..UNLESS.fh0getbuf(
scb).DO#0A..{.sawritef("DLIB:.fh0getbuf(%n).failed*
n",.scb)#0A..2RESULTIS.FALSE..//.Read.data.into.the
.buffer#0A..}#0A#0A..//.Safety.check#0A..end.:#3D.s
cb!scb_end#0A..UNLESS.end#3Dbuflen.|.lblock.#3D.scb
!scb_block.DO#0A..{.sawritef("DLIB:.fh0rdfn.block#3D
%n.lblock#3D%n.pos#3D%n.end#3D%n*n",#0A..12scb!scb_
block,.lblock,.scb!scb_pos,.end)#0A..2abort(992)#0A
..}#0A..#0A..RESULTIS.TRUE..12//.The.buffer.is.not.
empty#0A}..#0A..1#0AAND.fh0wrfn(scb).#3D.VALOF#0A//
.Write.the.current.buffer.to.file,.if.the.write.fla
g.is.set#0A//.Return.TRUE,.if.successful#0A//.Retur
n.FALSE.otherwise#2E#0A{.LET.block,.lblock.#3D.scb!
scb_block,.scb!scb_lblock#0A..LET.pos,.end.#3D.scb!
scb_pos,.scb!scb_end#0A..LET.len.#3D.?#0A//sawritef
("DLIB:.fh0wrfn.scb.%n.pos.%n.end.%n*n",.scb,.pos,.
end)#0A//sawritef("DLIB:.fh0wrfn.block.%n.lblock.%n
*n",.block,.lblock)#0A..IF.scb!scb_write.DO.//.Writ
e.current.block.if.necessary#0A..2UNLESS.fh0putbuf(
scb).RESULTIS.FALSE#0A#0A//..IF.pos<scb!scb_bufend.
DO#0A//sawritef("DLIB:.return0.from.fh0wrfn.block#3D
%n.lblock#3D%n.pos#3D%n.end#3D%n*n",#0A//..8scb!scb
_block,.scb!scb_lblock,.pos,.end)#0A#0A..IF.pos.<.s
cb!scb_bufend.RESULTIS.TRUE..//.Still.room.in.the.b
uffer#0A..//.Move.to.next.block#0A..block.:#3D.bloc
k+1#0A..scb!scb_block,.scb!scb_pos,.scb!scb_end.:#3D
.block,.0,.0#0A..IF.block>lblock.DO#0A..{.scb!scb_l
block.:#3D.block..2//.Last.block.is.empty#0A//sawri
tef("DLIB:.return1.from.fh0wrfn.block#3D%n.lblock#3D
%n.pos#3D%n.end#3D%n*n",#0A//..8scb!scb_block,.scb!
scb_lblock,.pos,.end)#0A..2RESULTIS.TRUE#0A..}#0A#0A
..IF.scb!scb_id#3Did_inoutscb.UNLESS.fh0getbuf(scb)
.DO#0A..{.sawritef("DLIB:.fh0wrfn.getbuf.failed.blo
ck#3D%n.lblock#3D%n.pos#3D%n.end#3D%n*n",#0A..12scb
!scb_block,.scb!scb_lblock,.pos,.end)#0A..2abort(11
00002)#0A..}#0A#0A//sawritef("DLIB:.return2.from.fh
0wrfn.block#3D%n.lblock#3D%n.pos#3D%n.end#3D%n*n",#0A
//..8scb!scb_block,.scb!scb_lblock,.pos,.end)#0A#0A
..RESULTIS.TRUE#0A}..#0A#0A..1#0AAND.fh0endfn(scb).
#3D.VALOF#0A//.Write.the.buffer,.if.necessary,.and.
free.it#2E#0A//.Close.the.file#2E#0A//.Return.TRUE,
.if.successful#0A//.Return.FALSE.otherwise#2E#0A{#0A
//sawritef("DLIB:.fh0endfn.scb.%n,.write.flag#3D%n*
n",.scb,.scb!scb_write)#0A//sawritef("DLIB:.fh0endf
n.pos#3D%n.end#3D%n*n",.scb!scb_pos,.scb!scb_end)#0A
..IF.scb!scb_write.UNLESS.fh0putbuf(scb).RESULTIS.F
ALSE#0A//sawritef("DLIB:.fh0endfn.freeing.buf#3D%n*
n",.scb!scb_buf)#0A..//1freevec(scb!scb_buf)#0A..//
1scb!scb_buf.:#3D.0#0A..RESULTIS.sys(Sys_close,.scb
!scb_fd)#0A}#0A#0A//.Result.TRUE:.posv.contains.the
.stream.block.and.pos#0A//..5FALSE:.scb.was.not.a.f
ile.or.RAM.stream#0AAND.note(scb,.posv).#3D.VALOF#0A
{.LET.type.#3D.scb!scb_type#0A..UNLESS.type#3Dscbt_
file.|.type#3Dscbt_ram.RESULTIS.FALSE#0A..posv!0.:#3D
.scb!scb_block#0A..posv!1.:#3D.scb!scb_pos#0A//sawr
itef("DLIB:.note.#3D>.%n.%n*n",.posv!0,.posv!1)#0A.
.RESULTIS.TRUE#0A}#0A#0A//.Set.the.stream.position.
to.that.specified.in.posv#2E..If.the#0A//.new.posit
ion.is.in.a.different.block.the.buffer.may.have.to#0A
//.be.written.out.and.new.data.read.in#2E#0A//.It.r
eturns.TRUE.if.successful,.even.if.positioned.just.
after.the#0A//.last.block.of.the.file,.ie.block#3Dl
block+1.and.pos#3Dend#3D0#2E#0A//.It.returns.FALSE,
.otherwise#2E.Possibly.because.the.stream.is.not#0A
//.pointable.or.the.posv.is.out.of.range#2E#0AAND.p
oint(scb,.posv).#3D.VALOF#0A{.LET.blkno..#3D.posv!0
#0A..LET.pos..2#3D.posv!1#0A..LET.id..3#3D.scb!scb_
id#0A..LET.block..#3D.scb!scb_block..1//.Current.bl
ock.number#0A..LET.lblock.#3D.scb!scb_lblock..//.La
st.block.number.of.the.stream#0A..LET.end..2#3D.scb
!scb_end#0A..LET.type..1#3D.scb!scb_type#0A//sawrit
ef("DLIB:.point.posv!0#3D%n.posv!1#3D%n*n",.posv!0,
.posv!1)#0A#0A//sawritef("DLIB:.point.block#3D%n.lb
lock#3D%n.blkno#3D%n.pos#3D%n.end#3D%n*n",#0A//..13
block,.lblock,..blkno,.pos,.end)#0A#0A..1//.The.str
eam.must.be.a.readable.disc.or.RAM.file#0A..UNLESS.
(type#3Dscbt_file.|.type#3Dscbt_ram).&#0A..7(id#3Di
d_inscb.|.id#3Did_inoutscb).RESULTIS.FALSE#0A#0A..I
F.pos#3D0.&.blkno#3Dlblock+1.DO.blkno,.pos.:#3D.lbl
ock,.buflen#0A.#0A//sawritef("DLIB:.point.block#3D%
n.lblock#3D%n.blkno#3D%n.pos#3D%n.end#3D%n*n",#0A//
..13block,.lblock,..blkno,.pos,.end)#0A#0A//..IF.bl
kno<#3D0.DO.blkno,.pos.:#3D.0,.0.//.Cannot.position
.before.start.of.file#0A#0A..//.Safety.check#0A..//
.Make.sure.the.position.is.within.the.file#0A..IF.b
lkno<0.|.#0A..3blkno>lblock.|#0A..3blkno#3Dlblock.&
.pos.>.(block#3Dlblock.->.end,.scb!scb_ldata)..DO#0A
..{.sawritef("DLIB:.point.beyond.end.of.file,.blkno
#3D%n.pos#3D%n*n",.blkno,.pos)#0A..2sawritef("block
#3D%n.end#3D%n.lblock#3D%n.posv#3D(%n,%n)*n",#0A..1
2block,.end,.lblock,.posv!0,.posv!1)#0A..2abort(991
)#0A..2RESULTIS.FALSE#0A..}#0A#0A..IF.blkno#3Dblock
.DO#0A..{.//.The.new.position.is.in.the.current.blo
ck#0A..2scb!scb_block.:#3D.blkno#0A..2scb!scb_pos..
1:#3D.pos#0A//sawritef("DLIB:.point.setting.scb.blo
ck#3D%n.pos#3D%n*n",.blkno,.pos)#0A..2RESULTIS.TRUE
.//.Success#0A..}#0A#0A..//.The.move.is.to.a.differ
ent.block,.so.must.read.a.block#0A..//.but.first.ch
eck.if.the.current.block.must.be.written#0A..IF.scb
!scb_write.DO#0A..{.//sawritef("DLIB:.point.write.b
lock.%n*n",.scb!scb_block).#0A..2UNLESS.fh0putbuf(s
cb).DO.abort(5000003)#0A..}#0A#0A..scb!scb_block.:#3D
.blkno..//.Set.the.new.position#0A.#0A//sawritef("D
LIB:.point.read.block.%n*n",.blkno)#0A#0A..UNLESS.f
h0getbuf(scb).DO#0A..{.sawritef("DLIB:.point.fh0get
buf.failed.block.%n.#3D>.%n*n",.blkno,.end)#0A..2ab
ort(5000004)#0A..2RESULTIS.FALSE#0A..}#0A#0A..//.Sa
fety.check#0A..UNLESS.scb!scb_end#3Dbuflen.|#0A..7b
lkno#3Dlblock.&.end>#3Dscb!scb_ldata.DO#0A..{.sawri
tef("DLIB.point:.safety.check.failed*n")#0A..2sawri
tef("DLIB.point:.blkno.%n.pos.%n*n",.blkno,.pos)#0A
..2sawritef("DLIB.point:.end.%n.buflen.%n*n",.scb!s
cb_end,.buflen)#0A..2sawritef("DLIB.point:.block.%n
.lblock.%n*n",.blkno,.lblock)#0A..2sawritef("DLIB.p
oint:.end.%n.ldata.%n*n",.end,.scb!scb_ldata)#0A..2
abort(5000005)#0A..}#0A#0A..scb!scb_pos..1:#3D.pos.
.//.Set.the.desired.offset#0A#0A//sawritef("DLIB:.p
oint(#2E#2E).#3D>.TRUE,.blkno.%n.pos.%n*n",.blkno,.
pos)#0A..RESULTIS.TRUE#0A}#0A#0AAND.fh0putbuf(scb).
#3D.VALOF#0A//.This.is.only.used.on.disc.file.strea
ms.and.is.only.called.when#0A//.the.write.field.is.
TRUE#2E.It.writes.the.buffer.to.file#2E#0A//.The.fi
le.is.positioned.before.the.write#2E.If.the.last.bl
ock#0A//.is.being.written.ldata.is.set.to.end.and.t
his.number.of.bytes.written#0A//.to.disc#2E.(For.al
l.other.blocks.end#3Dbuflen#2E)#0A//.Returns.TRUE,.
if.successful,.having.set.the.write.field.to.FALSE#2E
#0A//.Returns.FALSE,.otherwise#2E#0A{.LET.end..2#3D
.scb!scb_end..2//.Number.of.bytes.of.valid.data.in.
buf#0A..LET.block..#3D.scb!scb_block#0A..LET.fd..3#3D
.scb!scb_fd#0A..LET.offset.#3D.buflen*block..1//.Fi
le.offset.of.buffer's.first.byte.MR.29/7/02#0A#0A..
IF.end<#3D0.DO#0A..{.//.Nothing.in.the.buffer.to.wr
ite,.probably.a.mistake#2E#0A..2//sawritef("DLIB:.f
h0putbuf,.end#3D%n*n",.end)#0A..2scb!scb_write.:#3D
.FALSE#0A..2RESULTIS.TRUE#0A..}#0A#0A..//.The.size.
of.a.file.can.only.change.when.writing.its.last.blo
ck#0A..//.so.ldata.only.needs.correcting.when.this.
happens#0A..IF.block.#3D.scb!scb_lblock.DO.scb!scb_
ldata.:#3D.end#0A#0A//sawritef("DLIB:.putbuf.seekin
g.offset.%n.(block.%n)*n",.offset,.block)#0A..UNLES
S.sys(Sys_seek,.fd,.offset).RESULTIS.FALSE#0A#0A//s
awritef("DLIB:.putbuf.write.%n.bytes.at.offset.%n*n
",.end,.offset)#0A..IF.sys(Sys_write,.fd,.scb!scb_b
uf,.end).<.0#0A..2RESULTIS.FALSE#0A..scb!scb_write.
:#3D.FALSE.//.The.buffer.has.been.written.successfu
lly#0A..RESULTIS.TRUE#0A}#0A#0A//.fh0getbuf.reads.a
.block.into.the.scb's.buffer#2E#0A//.Returns.TRUE.i
f.successful#0A//..4having.set.pos#3D0.and.end.to.t
he.end.of.valid.data#0A//.Returns.FALSE,.otherwise#2E
#0A#0AAND.fh0getbuf(scb).#3D.VALOF#0A{.LET.fd..4#3D
.scb!scb_fd#0A..LET.block..1#3D.scb!scb_block..1//.
Block.number.(>#3D0)#0A..LET.offset..#3D.buflen*blo
ck..2//.MR.29/7/02#0A..LET.end..3#3D.?.#0A#0A//sawr
itef("DLIB:.fh0getbuf.seeking.start.of.block.%n.(of
fset.%n)*n",#0A//..10block,.offset)#0A..UNLESS.sys(
Sys_seek,.fd,.offset).RESULTIS.FALSE#0A//sawritef("
DLIB:.fh0getbuf.file.position.now.%n*n",.sys(Sys_te
ll,.fd))#0A#0A//sawritef("DLIB:.fh0getbuf.reading.b
lock.%n.offset#3D%n*n",.block,.offset)#0A..end.:#3D
.sys(Sys_read,.fd,.scb!scb_buf,.buflen)#0A//sawrite
f("DLIB:.fh0getbuf.read.#3D>.%n*n",.end)#0A//sawrit
ef("DLIB:.fh0getbuf.block#3D%n.lblock#3D%n.ldata#3D
%n*n",#0A//..13block,.scb!scb_lblock,.scb!scb_ldata
)#0A..IF.end<0.RESULTIS.FALSE.//.Unable.to.read#0A.
.scb!scb_pos,.scb!scb_end.:#3D.0,.end.#0A..RESULTIS
.TRUE#0A}#0A#0AAND.delay(ms).#3D.sys(Sys_delay,.ms)
#0A#0AAND.delayuntil(days,.msecs).BE#0A{.LET.ds,.ms
.#3D.0,.0#0A..datstamp(@ds)#0A..IF.ds<days.RETURN#0A
..IF.ds#3Ddays.&.ms<#3Dmsecs.RETURN#0A..sys(Sys_del
ay,.1).//.Sleep.for.1.msec#0A}.REPEAT#0A#0A2

######sysc/cfuncs.c#
/*#0AThis.is.a.file.contains.the.definition.of.the.
C.function.cfuncs#0Awhich.is.callable.from.BCPL#2E#0A
#0AImplemented.by.Martin.Richards.(c).May.2000008#0A
#0AUnder.Cintcode.and.Cintpos,.the.following#0A#0Ar
es.:#3D.sys(Sys_callc,.fno,.a1,.a2,#2E#2E1)#0A#0Aca
lls.cfuncs(args,.g).where.cfuncs.is.a.C.function,.a
rgs.is.a#0Apointer.to.the.arguments.fno,.a1,.a2,#2E
#2E1,.and.g.is.a.pointer#0Ato.the.base.of.the.globa
l.vector#2E.The.result.of.cfuncs.is.assigned#0Ato.r
es#2E#0A#0A*/#0A#0A#23include.<stdio#2Eh>#0A#23incl
ude."cintsys#2Eh"#0A#0A#23include.<stdlib#2Eh>#0A#23
include.<signal#2Eh>#0A#23include.<errno#2Eh>#0A#0A
#23include.<fcntl#2Eh>#0A#23include.<sys/wait#2Eh>#0A
//#23include.<sys/time#2Eh>#0A#23include.<sys/timeb
#2Eh>#0A//#23include.<sys/select#2Eh>#0A//#23includ
e.<linux/time#2Eh>#0A#23include.<unistd#2Eh>#0A#23i
nclude.<sys/signal#2Eh>#0A#0A/*.include.for.the.TCP
/IP.code.*/#0A#0A#23include.<netdb#2Eh>#0A#23includ
e.<sys/socket#2Eh>#0A#23include.<netinet/in#2Eh>#0A
#0A#23define..c_name2ipaddr.101#0A#23define..c_name
2port..001102#0A#23define..c_newsocket..001103#0A#23
define..c_reuseaddr..001104#0A#23define..c_setsndbu
fsz.105#0A#23define..c_setrcvbufsz.106#0A#23define.
.c_tcpbind..003107#0A#23define..c_tcpconnect..00010
8#0A#23define..c_tcplisten..001109#0A#23define..c_t
cpaccept..001110000#0A#23define..c_tcpclose..002111
#0A#23define..c_fd_zero..003110002#0A#23define..c_f
d_set..004110003#0A#23define..c_fd_isset..002110004
#0A#23define..c_select..004110005#0A#23define..c_re
cv..006110006#0A#23define..c_send..006110007#0A#23d
efine..c_read..006110008#0A#23define..c_write..0051
10009#0A#0Aextern.BCPLWORD.*W;#0A#0Achar.namebuf[.2
56];#0A#0ABCPLWORD.result2..#3D.0;#0A#0Aextern.char
.*b2c_str(BCPLWORD.bstr,.char.*cstr);#0A#0Aint.name
2ipaddr(char.*hname).{.//.name.#3D>.ipaddr.(host.fo
rmat)#0A..struct.hostent.*hp;#0A..int.ipaddr.#3D.-1
;#0A#0A..if.(hname#3D#3D0000).return.INADDR_ANY;#0A
#0A..//printf("name2ipaddr:.\"%s\"\n",.hname);#0A#0A
..if(inet_aton(hname,.&ipaddr)).return.ntohl(ipaddr
);#0A#0A..hp.#3D.gethostbyname(hname);#0A..if(hp#3D
#3DNULL).return.-1;.//.Unknown.host#0A#0A..return.n
tohl((1struct.in_addr.*)hp->h_addr)->s_addr);#0A}#0A
#0Aint.name2port(char.*pname).{.//.name.#3D>.port.(
host.format)#0A..struct.servent.*sp;#0A..char.*endp
tr;#0A..short.port;#0A#0A..if(pname#3D#3D0000).retu
rn.-1;#0A#0A..port.#3D.strtol(pname,.&endptr,.0);#0A
..if(*endptr.#3D#3D.'\0').return.port;#0A#0A..sp.#3D
.getservbyname(pname,."tcp");#0A..if(sp#3D#3DNULL).
return.-1;#0A..return.ntohs(sp->s_port);#0A}#0A#0Ai
nt.newsocket().{#0A..//.Create.an.internet.socket.t
o.provide.a.reliable,.full.duplex#0A..//.connection
-oriented.(TCP).byte.stream#2E#0A..return.socket(.A
F_INET,.SOCK_STREAM,.0.);#0A}#0A#0Aint.reuseaddr(in
t.s,.int.n).{#0A..return.setsockopt(.s,.SOL_SOCKET,
.SO_REUSEADDR,#0A..19(.char.*.)&n,.sizeof(.n.).);#0A
}#0A#0Aint.setsndbufsz(int.s,.int.sz).{#0A..return.
setsockopt(.s,.SOL_SOCKET,.SO_SNDBUF,#0A..19(.char.
*.)&sz,.sizeof(.sz.).);#0A}#0A#0Aint.setrcvbufsz(in
t.s,.int.sz).{#0A..return.setsockopt(.s,.SOL_SOCKET
,.SO_RCVBUF,#0A..19(.char.*.)&sz,.sizeof(.sz.).);#0A
}#0A#0Aint.tcpbind(int.s,.int.ipaddr,.int.port).{#0A
..int.rc;#0A..struct.sockaddr_in.addr;#0A..addr#2Es
in_family.#3D.AF_INET;#0A..addr#2Esin_port.#3D.hton
s(port);#0A..addr#2Esin_addr#2Es_addr.#3D.htonl(ipa
ddr);#0A..rc.#3D.bind(.s,.(.struct.sockaddr.*.)&add
r,.sizeof(.addr.).);#0A..if(rc#3D#3D-1).perror("bin
d.error");#0A..return.rc;#0A}#0A#0Aint.tcpconnect(i
nt.s,.int.ipaddr,.int.port).{#0A..struct.sockaddr_i
n.peer;#0A..peer#2Esin_family.#3D.AF_INET;#0A..peer
#2Esin_port.#3D.htons(port);#0A..peer#2Esin_addr#2E
s_addr.#3D.htonl(ipaddr);#0A..return.connect(.s,.(.
struct.sockaddr.*.)&peer,.sizeof(.peer.).);#0A}#0A#0A
int.tcplisten(int.s,.int.n).{#0A..return.listen(s,.
n);#0A}#0A#0Aint.tcpaccept(int.s).{#0A..struct.sock
addr_in.peer;#0A..int.peerlen.#3D.sizeof(peer);#0A.
.int.res.#3D.accept(s,.(struct.sockaddr.*)&peer,.&p
eerlen);#0A..result2.#3D.ntohl(peer#2Esin_addr#2Es_
addr);#0A..return.res;#0A}#0A#0A/*#0Aint.copydata(i
nt.s).{#0A..fd_set.allreads;#0A..fd_set.readmask;#0A
..int.rc;#0A..char.buf[128];#0A#0A..FD_ZERO(..&allr
eads);#0A..FD_SET(s,.&allreads);..//.the.TCP/IP.soc
ket#0A..FD_SET(0,.&allreads);..//.stdin#0A#0A..whil
e(1).{#0A..2readmask.#3D.allreads;#0A#0A..2rc.#3D.s
elect(s+1,.&readmask,.NULL,.NULL,.NULL);#0A..2if(rc
<0).{#0A..4printf("\nerror:.select.returned.%d\n",.
rc);#0A..4break;#0A..2}#0A#0A..2if(FD_ISSET(0,.&rea
dmask)).{#0A..4//printf("copydata:.calling.read\n")
;#0A#0A..4rc.#3D.read(0,.buf,.sizeof(buf)-1);#0A..4
if(rc#3D#3D0000).{#0A..6//printf("\nserver.disconne
cted.--.EOF\n");#0A..6break;#0A..4}#0A..4if(rc<0).{
#0A..6printf("\nerror:.read.returned.%d\n",.rc);#0A
..6break;#0A..4}#0A#0A..4//if(rc>0.&&.buf[0]#3D#3D'
#2E').break;#0A#0A..4if(send(s,.buf,.rc,.0).<.0).{#0A
..6printf("\nerror:.send.failure\n");#0A..6break;#0A
..4}#0A..2}#0A#0A..2if(FD_ISSET(s,.&readmask)).{#0A
..4rc.#3D.recv(s,.buf,.sizeof(buf)-1,.0);#0A..4//.I
t.read.rc.chars.into.buf#0A..4if(rc#3D#3D0000).{#0A
..6printf("\nserver.disconnected\n");#0A..6break;#0A
..4}#0A..4if(rc<0).{#0A..6printf("\nerror:.read.ret
urned.%d\n",.rc);#0A..6break;#0A..4}#0A#0A..4buf[rc
].#3D.0;#0A..4printf("%s",.buf);#0A..4fflush(stdout
);#0A..2}#0A..}#0A#0A..return.0;#0A}#0A*/#0A#0ABCPL
WORD.callc(BCPLWORD.*args,.BCPLWORD.*g).{#0A..int.r
c.#3D.0;#0A..BCPLWORD.fno.#3D.args[0];#0A..//printf
("\nCallc:.fno.#3D.%d\n",.fno);#0A#0A..switch(fno).
{#0A..default:#0A..2return.-1;#0A#0A..case.c_name2i
paddr:.//.name.#3D>.ipaddr.(host.format)#0A..2b2c_s
tr(args[1],.namebuf);#0A..2//printf("Callc.c_name2i
paddr:.args[1]#3D%d.%s\n",#0A..2//..5args[1],.nameb
uf);#0A..2return.name2ipaddr(namebuf);#0A#0A..case.
c_name2port:.//.name.#3D>.port.(host.format)#0A..2b
2c_str(args[1],.namebuf);#0A..2//printf("callc.c_na
me2port:.%s\n",.namebuf);#0A..2return.name2port(nam
ebuf);#0A#0A..case.c_newsocket:.//.Allocate.a.new.s
ocket#0A..2return.newsocket();#0A#0A..case.c_reusea
ddr:.//.Reuse.address#0A..2return.reuseaddr((int)ar
gs[1],.(int)args[2]);#0A#0A..case.c_setsndbufsz:.//
.Set.the.send.buffer.size#0A..2return.setsndbufsz((
int)args[1],.(int)args[2]);#0A#0A..case.c_setrcvbuf
sz:.//.Set.the.recv.buffer.size#0A..2return.setrcvb
ufsz((int)args[1],.(int)args[2]);#0A#0A..case.c_tcp
bind:..3//.Bind.a.socket.to.a.given.ipaddr/port#0A.
.2//printf("c_tcpbind:.%d.%08x.%d\n",.args[1],.args
[2],.args[3]);#0A..2return.tcpbind((int)args[1],.(i
nt)args[2],.(int)args[3]);#0A#0A..case.c_tcpconnect
:.//..Connect.a.socket.to.a.given.ipaddr/port#0A..2
//printf("tcpconnect.%d.%08x.%d\n",.args[1],.args[2
],.args[3]);#0A..2return.tcpconnect((int)args[1],.(
int)args[2],.(int)args[3]);#0A#0A..case.c_tcplisten
:.//..Cause.a.socket.to.listen#0A..2return.tcpliste
n((int)args[1],.(int)args[2]);#0A#0A..case.c_tcpacc
ept:.//.Cause.a.socket.to.accept.a.connection#0A..2
return.tcpaccept((int)args[1]);#0A#0A..case.c_tcpcl
ose:.//.Close.a.connection#0A..2//printf("tcpclose.
%d\n",.args[1]);#0A..2return.close((int)args[1]);#0A
#0A..case.c_fd_zero:.//.Clear.all.bits.in.an.fd_set
#0A..2{.//fd_set.*bits.#3D.(fd_set*)&W[args[2]];#0A
..4FD_ZERO((fd_set*)&W[args[1]]);#0A..4return.0;#0A
..2}#0A#0A..case.c_fd_set:.//.Set.a.bit.in.an.fd_se
t#0A..2//printf("c_fd_set:.args[1]#3D%d.args[2]#3D%
d\n",.args[1],.args[2]);#0A..2FD_SET((int)args[1],.
(fd_set*)&W[args[2]]);#0A..2return.0;#0A#0A..case.c
_fd_isset:.//.Test.a.bit.in.an.fd_set#0A..2return.F
D_ISSET((int)args[1],.(fd_set*)&W[args[2]]);#0A#0A.
.case.c_select:.//.Call.the.select.function#0A..2{.
int.i,.rc;#0A..4int..4s..5#3D.(int)..8args[1];#0A..
4fd_set..*rd_set..#3D.(fd_set.*)..&W[args[2]];#0A..
4fd_set..*wr_set..#3D.(fd_set.*)..&W[args[3]];#0A..
4fd_set..*er_set..#3D.(fd_set.*)..&W[args[4]];#0A..
4struct.timeval.*timeval.#3D.(struct.timeval.*)#0A#09
..22((args[5]#3D#3D0000).?.NULL.:.&W[args[5]]);#0A.
.4/*#0A..4//for(i#3D0;.i<10;i++)#0A..4//..printf("c
allc:.rdset.bit.%d.#3D.%d\n",#0A#09..5i,.FD_ISSET(i
,.(fd_set*)&W[args[2]]));#0A..4*/#0A..4//printf("ca
llc:.calling.select(%d,%d,%d,%d,%d)\n",#0A..4//..6a
rgs[1],args[2],args[3],args[4],args[5]);#0A..4//if(
timeval).{#0A..4//printf("c_select:.tv_sec..#3D.%d\
n",.timeval->tv_sec);#0A..4//printf("c_select:.tv_u
sec.#3D.%d\n",.timeval->tv_usec);#0A..4//}#0A..4rc.
#3D.select(s,.rd_set,.wr_set,.er_set,.timeval);#0A#0A
..4if(rc#3D#3D-1).perror("select.returned.error");#0A
..4//printf("\ncallc:.select.#3D>.rc.#3D.%d\n",.rc)
;#0A..4//for(i#3D0;.i<10;i++)#0A..4//..1printf("cal
lc:.rdset.bit.%d.#3D.%d\n",#0A..4//..9i,.FD_ISSET(i
,.rd_set));#0A..4return.rc;#0A..2}#0A#0A..case.c_re
cv:..2//.Call.the.recv(s,.buf,.len,.flags)#0A..2{.i
nt..1s..3#3D.(int)args[1];#0A..4char.*buf..1#3D.(ch
ar*)&W[args[2]];#0A..4int..1len..1#3D.(int)args[3];
#0A..4int..1flags.#3D.(int)args[4];#0A..4int.rc.#3D
.0;#0A..4//printf("cfuncs:.Calling.recv(%d,.%d,.%d,
.%d)\n",#0A..4//..3args[1],.args[2],.args[3],.args[
4]);#0A..4rc.#3D.recv(s,.buf,.len,.flags);#0A..4if(
rc#3D#3D-1)perror("recv.returned.error");#0A..4//pr
intf("cfuncs:.recv.returned.rc#3D%d\n",.rc);#0A..4r
eturn.rc;#0A..2}#0A#0A..case.c_send:..2//.Call.the.
send(s,.buf,.len,.flags)#0A..2{.int..1s..3#3D.(int)
args[1];#0A..4char.*buf..1#3D.(char*)&W[args[2]];#0A
..4int..1len..1#3D.(int)args[3];#0A..4int..1flags.#3D
.(int)args[4];#0A..4int.rc.#3D.0;#0A..4//printf("cf
uncs:.Calling.send(%d,.%d,.%d,.%d)\n",#0A..4//..5ar
gs[1],.args[2],.args[3],.args[4]);#0A..4rc.#3D.send
(s,.buf,.len,.flags);#0A..4if(rc#3D#3D-1)perror("se
nd.returned.error");#0A..4//printf("cfuncs:.send.re
turned.rc#3D%d\n",.rc);#0A..4return.rc;#0A..2}#0A#0A
..case.c_read:..2//.Call.the.read(s,.buf,.len)#0A..
2{.int..1s..1#3D.(int)args[1];#0A..4char.*buf.#3D.(
char*)&W[args[2]];#0A..4int..1len.#3D.(int)args[3];
#0A..4int.rc.#3D.0;#0A..4//printf("cfuncs:.Calling.
read(%d,.%d,.%d)\n",.args[1],.args[2],.args[3]);#0A
..4rc.#3D.read(s,.buf,.len);#0A..4//if(rc#3D#3D-1)p
error("read.returned.error");#0A..4//printf("cfuncs
:.read.returned.rc#3D%d\n",.rc);#0A..4return.rc;#0A
..2}#0A#0A..case.c_write:..1//.Call.the.write(s,.bu
f,.len)#0A..2{.int..1s..1#3D.(int)..1args[1];#0A..4
char.*buf.#3D.(char*).&W[args[2]];#0A..4int..1len.#3D
.(int)..1args[3];#0A..4int..1rc..#3D.0;#0A..4//prin
tf("cfuncs:.Calling.write(%d,.%d,.%d)\n",.args[1],.
args[2],.args[3]);#0A..4rc.#3D.write(s,.buf,.len);#0A
..4if(rc#3D#3D-1)perror("read.returned.error");#0A.
.4//printf("cfuncs:.read.returned.rc#3D%d\n",.rc);#0A
..4return.rc;#0A..2}#0A..}#0A}#0A#0A

######sysc/cfuncs64.c#
/*#0AThis.is.a.file.contains.the.definition.of.the.
C.function.cfuncs#0Awhich.is.callable.from.BCPL#2E#0A
#0AImplemented.by.Martin.Richards.(c).May.2000008#0A
#0AUnder.Cintcode.and.Cintpos,.the.following#0A#0Ar
es.:#3D.sys(Sys_callc,.fno,.a1,.a2,#2E#2E1)#0A#0Aca
lls.cfuncs(args,.g).where.cfuncs.is.a.C.function,.a
rgs.is.a#0Apointer.to.the.arguments.fno,.a1,.a2,#2E
#2E1,.and.g.is.a.pointer#0Ato.the.base.of.the.globa
l.vector#2E.The.result.of.cfuncs.is.assigned#0Ato.r
es#2E#0A#0A*/#0A#0A#23include.<stdio#2Eh>#0A#23incl
ude."cintsys64#2Eh"#0A#0A#23include.<stdlib#2Eh>#0A
#23include.<signal#2Eh>#0A#23include.<errno#2Eh>#0A
#0A#23include.<fcntl#2Eh>#0A#23include.<sys/wait#2E
h>#0A//#23include.<sys/time#2Eh>#0A#23include.<sys/
timeb#2Eh>#0A//#23include.<sys/select#2Eh>#0A//#23i
nclude.<linux/time#2Eh>#0A#23include.<unistd#2Eh>#0A
#23include.<sys/signal#2Eh>#0A#0A/*.include.for.the
.TCP/IP.code.*/#0A#0A#23include.<netdb#2Eh>#0A#23in
clude.<sys/socket#2Eh>#0A#23include.<netinet/in#2Eh
>#0A#0A#23define..c_name2ipaddr.101#0A#23define..c_
name2port..001102#0A#23define..c_newsocket..001103#0A
#23define..c_reuseaddr..001104#0A#23define..c_setsn
dbufsz.105#0A#23define..c_setrcvbufsz.106#0A#23defi
ne..c_tcpbind..003107#0A#23define..c_tcpconnect..00
0108#0A#23define..c_tcplisten..001109#0A#23define..
c_tcpaccept..001110000#0A#23define..c_tcpclose..002
111#0A#23define..c_fd_zero..003110002#0A#23define..
c_fd_set..004110003#0A#23define..c_fd_isset..002110
004#0A#23define..c_select..004110005#0A#23define..c
_recv..006110006#0A#23define..c_send..006110007#0A#23
define..c_read..006110008#0A#23define..c_write..005
110009#0A#0Aextern.BCPLWORD.*W;#0A#0Achar.namebuf[.
256];#0A#0ABCPLWORD.result2..#3D.0;#0A#0Achar.*b2cs
tr(BCPLWORD.bstr,.char.*cstr).{#0A..char.*p.#3D.(ch
ar*)&W[bstr];#0A..char.*q.#3D.cstr;#0A..int.len.#3D
.*p++;#0A..int.i.#3D.0;#0A..//printf("b2cstr:.len#3D
%d\n",.len);#0A..for(i#3D1;.i<#3Dlen;.i++).*q++.#3D
.*p++;#0A..*q.#3D.0;#0A..//printf("b2cstr:.#3D>.\"%
s\"\n",.cstr);#0A..return.cstr;#0A}#0A#0Aint.name2i
paddr(char.*hname).{.//.name.#3D>.ipaddr.(host.form
at)#0A..struct.hostent.*hp;#0A..int.ipaddr.#3D.-1;#0A
#0A..if.(hname#3D#3D0000).return.INADDR_ANY;#0A#0A.
.//printf("name2ipaddr:.\"%s\"\n",.hname);#0A#0A..i
f(inet_aton(hname,.&ipaddr)).return.ntohl(ipaddr);#0A
#0A..hp.#3D.gethostbyname(hname);#0A..if(hp#3D#3DNU
LL).return.-1;.//.Unknown.host#0A#0A..return.ntohl(
(1struct.in_addr.*)hp->h_addr)->s_addr);#0A}#0A#0Ai
nt.name2port(char.*pname).{.//.name.#3D>.port.(host
.format)#0A..struct.servent.*sp;#0A..char.*endptr;#0A
..short.port;#0A#0A..if(pname#3D#3D0000).return.-1;
#0A#0A..port.#3D.strtol(pname,.&endptr,.0);#0A..if(
*endptr.#3D#3D.'\0').return.port;#0A#0A..sp.#3D.get
servbyname(pname,."tcp");#0A..if(sp#3D#3DNULL).retu
rn.-1;#0A..return.ntohs(sp->s_port);#0A}#0A#0Aint.n
ewsocket().{#0A..//.Create.an.internet.socket.to.pr
ovide.a.reliable,.full.duplex#0A..//.connection-ori
ented.(TCP).byte.stream#2E#0A..return.socket(.AF_IN
ET,.SOCK_STREAM,.0.);#0A}#0A#0Aint.reuseaddr(int.s,
.int.n).{#0A..return.setsockopt(.s,.SOL_SOCKET,.SO_
REUSEADDR,#0A..19(.char.*.)&n,.sizeof(.n.).);#0A}#0A
#0Aint.setsndbufsz(int.s,.int.sz).{#0A..return.sets
ockopt(.s,.SOL_SOCKET,.SO_SNDBUF,#0A..19(.char.*.)&
sz,.sizeof(.sz.).);#0A}#0A#0Aint.setrcvbufsz(int.s,
.int.sz).{#0A..return.setsockopt(.s,.SOL_SOCKET,.SO
_RCVBUF,#0A..19(.char.*.)&sz,.sizeof(.sz.).);#0A}#0A
#0Aint.tcpbind(int.s,.int.ipaddr,.int.port).{#0A..i
nt.rc;#0A..struct.sockaddr_in.addr;#0A..addr#2Esin_
family.#3D.AF_INET;#0A..addr#2Esin_port.#3D.htons(p
ort);#0A..addr#2Esin_addr#2Es_addr.#3D.htonl(ipaddr
);#0A..rc.#3D.bind(.s,.(.struct.sockaddr.*.)&addr,.
sizeof(.addr.).);#0A..if(rc#3D#3D-1).perror("bind.e
rror");#0A..return.rc;#0A}#0A#0Aint.tcpconnect(int.
s,.int.ipaddr,.int.port).{#0A..struct.sockaddr_in.p
eer;#0A..peer#2Esin_family.#3D.AF_INET;#0A..peer#2E
sin_port.#3D.htons(port);#0A..peer#2Esin_addr#2Es_a
ddr.#3D.htonl(ipaddr);#0A..return.connect(.s,.(.str
uct.sockaddr.*.)&peer,.sizeof(.peer.).);#0A}#0A#0Ai
nt.tcplisten(int.s,.int.n).{#0A..return.listen(s,.n
);#0A}#0A#0Aint.tcpaccept(int.s).{#0A..struct.socka
ddr_in.peer;#0A..int.peerlen.#3D.sizeof(peer);#0A..
int.res.#3D.accept(s,.(struct.sockaddr.*)&peer,.&pe
erlen);#0A..result2.#3D.ntohl(peer#2Esin_addr#2Es_a
ddr);#0A..return.res;#0A}#0A#0A/*#0Aint.copydata(in
t.s).{#0A..fd_set.allreads;#0A..fd_set.readmask;#0A
..int.rc;#0A..char.buf[128];#0A#0A..FD_ZERO(..&allr
eads);#0A..FD_SET(s,.&allreads);..//.the.TCP/IP.soc
ket#0A..FD_SET(0,.&allreads);..//.stdin#0A#0A..whil
e(1).{#0A..2readmask.#3D.allreads;#0A#0A..2rc.#3D.s
elect(s+1,.&readmask,.NULL,.NULL,.NULL);#0A..2if(rc
<0).{#0A..4printf("\nerror:.select.returned.%d\n",.
rc);#0A..4break;#0A..2}#0A#0A..2if(FD_ISSET(0,.&rea
dmask)).{#0A..4//printf("copydata:.calling.read\n")
;#0A#0A..4rc.#3D.read(0,.buf,.sizeof(buf)-1);#0A..4
if(rc#3D#3D0000).{#0A..6//printf("\nserver.disconne
cted.--.EOF\n");#0A..6break;#0A..4}#0A..4if(rc<0).{
#0A..6printf("\nerror:.read.returned.%d\n",.rc);#0A
..6break;#0A..4}#0A#0A..4//if(rc>0.&&.buf[0]#3D#3D'
#2E').break;#0A#0A..4if(send(s,.buf,.rc,.0).<.0).{#0A
..6printf("\nerror:.send.failure\n");#0A..6break;#0A
..4}#0A..2}#0A#0A..2if(FD_ISSET(s,.&readmask)).{#0A
..4rc.#3D.recv(s,.buf,.sizeof(buf)-1,.0);#0A..4//.I
t.read.rc.chars.into.buf#0A..4if(rc#3D#3D0000).{#0A
..6printf("\nserver.disconnected\n");#0A..6break;#0A
..4}#0A..4if(rc<0).{#0A..6printf("\nerror:.read.ret
urned.%d\n",.rc);#0A..6break;#0A..4}#0A#0A..4buf[rc
].#3D.0;#0A..4printf("%s",.buf);#0A..4fflush(stdout
);#0A..2}#0A..}#0A#0A..return.0;#0A}#0A*/#0A#0ABCPL
WORD.callc(BCPLWORD.*args,.BCPLWORD.*g).{#0A..int.r
c.#3D.0;#0A..BCPLWORD.fno.#3D.args[0];#0A..//printf
("\nCallc:.fno.#3D.%d\n",.fno);#0A#0A..switch(fno).
{#0A..default:#0A..2return.-1;#0A#0A..case.c_name2i
paddr:.//.name.#3D>.ipaddr.(host.format)#0A..2b2cst
r(args[1],.namebuf);#0A..2//printf("Callc.c_name2ip
addr:.args[1]#3D%d.%s\n",#0A..2//..5args[1],.namebu
f);#0A..2return.name2ipaddr(namebuf);#0A#0A..case.c
_name2port:.//.name.#3D>.port.(host.format)#0A..2b2
cstr(args[1],.namebuf);#0A..2//printf("callc.c_name
2port:.%s\n",.namebuf);#0A..2return.name2port(nameb
uf);#0A#0A..case.c_newsocket:.//.Allocate.a.new.soc
ket#0A..2return.newsocket();#0A#0A..case.c_reuseadd
r:.//.Reuse.address#0A..2return.reuseaddr((int)args
[1],.(int)args[2]);#0A#0A..case.c_setsndbufsz:.//.S
et.the.send.buffer.size#0A..2return.setsndbufsz((in
t)args[1],.(int)args[2]);#0A#0A..case.c_setrcvbufsz
:.//.Set.the.recv.buffer.size#0A..2return.setrcvbuf
sz((int)args[1],.(int)args[2]);#0A#0A..case.c_tcpbi
nd:..3//.Bind.a.socket.to.a.given.ipaddr/port#0A..2
//printf("c_tcpbind:.%d.%08x.%d\n",.args[1],.args[2
],.args[3]);#0A..2return.tcpbind((int)args[1],.(int
)args[2],.(int)args[3]);#0A#0A..case.c_tcpconnect:.
//..Connect.a.socket.to.a.given.ipaddr/port#0A..2//
printf("tcpconnect.%d.%08x.%d\n",.args[1],.args[2],
.args[3]);#0A..2return.tcpconnect((int)args[1],.(in
t)args[2],.(int)args[3]);#0A#0A..case.c_tcplisten:.
//..Cause.a.socket.to.listen#0A..2return.tcplisten(
(int)args[1],.(int)args[2]);#0A#0A..case.c_tcpaccep
t:.//.Cause.a.socket.to.accept.a.connection#0A..2re
turn.tcpaccept((int)args[1]);#0A#0A..case.c_tcpclos
e:.//.Close.a.connection#0A..2//printf("tcpclose.%d
\n",.args[1]);#0A..2return.close((int)args[1]);#0A#0A
..case.c_fd_zero:.//.Clear.all.bits.in.an.fd_set#0A
..2{.//fd_set.*bits.#3D.(fd_set*)&W[args[2]];#0A..4
FD_ZERO((fd_set*)&W[args[1]]);#0A..4return.0;#0A..2
}#0A#0A..case.c_fd_set:.//.Set.a.bit.in.an.fd_set#0A
..2//printf("c_fd_set:.args[1]#3D%d.args[2]#3D%d\n"
,.args[1],.args[2]);#0A..2FD_SET((int)args[1],.(fd_
set*)&W[args[2]]);#0A..2return.0;#0A#0A..case.c_fd_
isset:.//.Test.a.bit.in.an.fd_set#0A..2return.FD_IS
SET((int)args[1],.(fd_set*)&W[args[2]]);#0A#0A..cas
e.c_select:.//.Call.the.select.function#0A..2{.int.
i,.rc;#0A..4int..4s..5#3D.(int)..8args[1];#0A..4fd_
set..*rd_set..#3D.(fd_set.*)..&W[args[2]];#0A..4fd_
set..*wr_set..#3D.(fd_set.*)..&W[args[3]];#0A..4fd_
set..*er_set..#3D.(fd_set.*)..&W[args[4]];#0A..4str
uct.timeval.*timeval.#3D.(struct.timeval.*)#0A#09..
22((args[5]#3D#3D0000).?.NULL.:.&W[args[5]]);#0A..4
/*#0A..4//for(i#3D0;.i<10;i++)#0A..4//..printf("cal
lc:.rdset.bit.%d.#3D.%d\n",#0A#09..5i,.FD_ISSET(i,.
(fd_set*)&W[args[2]]));#0A..4*/#0A..4//printf("call
c:.calling.select(%d,%d,%d,%d,%d)\n",#0A..4//..6arg
s[1],args[2],args[3],args[4],args[5]);#0A..4//if(ti
meval).{#0A..4//printf("c_select:.tv_sec..#3D.%d\n"
,.timeval->tv_sec);#0A..4//printf("c_select:.tv_use
c.#3D.%d\n",.timeval->tv_usec);#0A..4//}#0A..4rc.#3D
.select(s,.rd_set,.wr_set,.er_set,.timeval);#0A#0A.
.4if(rc#3D#3D-1).perror("select.returned.error");#0A
..4//printf("\ncallc:.select.#3D>.rc.#3D.%d\n",.rc)
;#0A..4//for(i#3D0;.i<10;i++)#0A..4//..1printf("cal
lc:.rdset.bit.%d.#3D.%d\n",#0A..4//..9i,.FD_ISSET(i
,.rd_set));#0A..4return.rc;#0A..2}#0A#0A..case.c_re
cv:..2//.Call.the.recv(s,.buf,.len,.flags)#0A..2{.i
nt..1s..3#3D.(int)args[1];#0A..4char.*buf..1#3D.(ch
ar*)&W[args[2]];#0A..4int..1len..1#3D.(int)args[3];
#0A..4int..1flags.#3D.(int)args[4];#0A..4int.rc.#3D
.0;#0A..4//printf("cfuncs:.Calling.recv(%d,.%d,.%d,
.%d)\n",#0A..4//..3args[1],.args[2],.args[3],.args[
4]);#0A..4rc.#3D.recv(s,.buf,.len,.flags);#0A..4if(
rc#3D#3D-1)perror("recv.returned.error");#0A..4//pr
intf("cfuncs:.recv.returned.rc#3D%d\n",.rc);#0A..4r
eturn.rc;#0A..2}#0A#0A..case.c_send:..2//.Call.the.
send(s,.buf,.len,.flags)#0A..2{.int..1s..3#3D.(int)
args[1];#0A..4char.*buf..1#3D.(char*)&W[args[2]];#0A
..4int..1len..1#3D.(int)args[3];#0A..4int..1flags.#3D
.(int)args[4];#0A..4int.rc.#3D.0;#0A..4//printf("cf
uncs:.Calling.send(%d,.%d,.%d,.%d)\n",#0A..4//..5ar
gs[1],.args[2],.args[3],.args[4]);#0A..4rc.#3D.send
(s,.buf,.len,.flags);#0A..4if(rc#3D#3D-1)perror("se
nd.returned.error");#0A..4//printf("cfuncs:.send.re
turned.rc#3D%d\n",.rc);#0A..4return.rc;#0A..2}#0A#0A
..case.c_read:..2//.Call.the.read(s,.buf,.len)#0A..
2{.int..1s..1#3D.(int)args[1];#0A..4char.*buf.#3D.(
char*)&W[args[2]];#0A..4int..1len.#3D.(int)args[3];
#0A..4int.rc.#3D.0;#0A..4//printf("cfuncs:.Calling.
read(%d,.%d,.%d)\n",.args[1],.args[2],.args[3]);#0A
..4rc.#3D.read(s,.buf,.len);#0A..4//if(rc#3D#3D-1)p
error("read.returned.error");#0A..4//printf("cfuncs
:.read.returned.rc#3D%d\n",.rc);#0A..4return.rc;#0A
..2}#0A#0A..case.c_write:..1//.Call.the.write(s,.bu
f,.len)#0A..2{.int..1s..1#3D.(int)..1args[1];#0A..4
char.*buf.#3D.(char*).&W[args[2]];#0A..4int..1len.#3D
.(int)..1args[3];#0A..4int..1rc..#3D.0;#0A..4//prin
tf("cfuncs:.Calling.write(%d,.%d,.%d)\n",.args[1],.
args[2],.args[3]);#0A..4rc.#3D.write(s,.buf,.len);#0A
..4if(rc#3D#3D-1)perror("read.returned.error");#0A.
.4//printf("cfuncs:.read.returned.rc#3D%d\n",.rc);#0A
..4return.rc;#0A..2}#0A..}#0A}#0A#0A

######sysc/cinterp.c#
/*#0A**.This.is.a.32.bit.CINTCODE.interpreter.writt
en.in.C#0A**.with.modifications.for.the.Cintpos.sys
tem#2E#0A**#0A**.(c).Copyright:..Martin.Richards..O
ctober.2010#0A**#0A**.If.FASTyes.if.defined,.most.o
f.the.debugging.aids.are#0A**.disabled.making.it.fu
nctionally.equivalent.to.the#0A**.handwritten.assem
bly.code.versions.provided.for.some#0A**.architectu
res#2E#0A**#0A**.The.fast.version.defines.the.funct
ion.cintasm#0A**.while.the.slow.version.defines.int
erpret#2E#0A#0A00009/04/10#0APut.time.the.time.stam
p.(days,.msecs).in.the.rootnode.every.1002.cintcode
#0Ainstructions#2E#0A*/#0A#0A#23ifndef.forSHwinCE#0A
#23include.<stdio#2Eh>#0A#23include.<stdlib#2Eh>#0A
#23endif#0A#0A/*.cintsys#2Eh.contains.machine/syste
m.dependent.#23defines..*/#0A#23include."cintsys#2E
h"#0A#0A#23ifndef.FASTyes#0A#0A#23define.TRACINGyes
#0A#23define.TALLYyes#0A#23define.WATCHyes#0A#23def
ine.MEMCHKyes#0A#23define.COUNTyes#0A#0A#23endif#0A
#0A#23ifdef.MEMCHKyes#0A#23define.MC1(a).if((UBCPLW
ORD)a>memupb){W[3]#3Da;.res#3D12;.pc--;..goto.ret;.
}#0A#23define.MC2(a).if((UBCPLWORD)a>memupb){W[3]#3D
a;.res#3D12;.pc-#3D2;.goto.ret;.}#0A#23define.MC3(a
).if((UBCPLWORD)a>memupb){W[3]#3Da;.res#3D12;.pc-#3D
3;.goto.ret;.}#0A#23define.MC5(a).if((UBCPLWORD)a>m
emupb){W[3]#3Da;.res#3D12;.pc-#3D5;.goto.ret;.}#0A#23
else#0A#23define.MC1(a)#0A#23define.MC2(a)#0A#23def
ine.MC3(a)#0A#23define.MC5(a)#0A#23endif#0A#0Aexter
n.BCPLWORD.result2;#0A#0Aextern.BCPLWORD.*lastWp;..
2/*.Latest.setting.of.Wp.*/#0Aextern.BCPLWORD.*last
Wg;..2/*.Latest.setting.of.Wg.*/#0A#0Aextern.int.tr
acing;#0Aextern.BCPLWORD.memupb;#0AUBCPLWORD.memupb
b;#0A#0Aextern.BCPLWORD.*tallyv;#0Aextern.BCPLWORD.
tallylim;#0AUBCPLWORD.tallylimb;#0A#0Aextern.BCPLWO
RD.dosys(BCPLWORD.p,.BCPLWORD.g);#0Aextern.BCPLWORD
.doflt(BCPLWORD.op,.BCPLWORD.a,.BCPLWORD.b);#0Aexte
rn.BCPLWORD.muldiv(BCPLWORD.a,.BCPLWORD.b,.BCPLWORD
.c);#0A#0Aextern.void.wrcode(char.*form,.BCPLWORD.f
,.BCPLWORD.a);.#0Aextern.void.wrfcode(BCPLWORD.f);#0A
extern.void.trace(BCPLWORD.pc,.BCPLWORD.p,.BCPLWORD
.a,.BCPLWORD.b);#0Aextern.BCPLWORD.timestamp(BCPLWO
RD.*datstamp);#0A#0A1#23define.Gn_currco..0047#0A#23
define.Gn_result2..00210#0A#0A/*.CINTCODE.function.
codes..*/#0A#0A#23define.F_0..0050#0A#0A#23define.F
_fltop..0011#0A#23define.F_brk..0032#0A#23define.F_
k0..0040#0A#23define.F_lf..00312#0A#23define.F_lm..
00314#0A#23define.F_lm1..00215#0A#23define.F_l0..00
316#0A#23define.F_fhop..00127#0A#23define.F_jeq..00
228#0A#0A#23define.F_k..00432#0A#23define.F_kh..003
33#0A#23define.F_kw..00334#0A#23define.F_k0g..00232
#0A#23define.F_k0g1..1(F_k0g+32)#0A#23define.F_k0gh
..1(F_k0g+64)#0A#23define.F_s0g..00244#0A#23define.
F_s0g1..1(F_s0g+32)#0A#23define.F_s0gh..1(F_s0g+64)
#0A#23define.F_l0g..00245#0A#23define.F_l0g1..1(F_l
0g+32)#0A#23define.F_l0gh..1(F_l0g+64)#0A#23define.
F_l1g..00246#0A#23define.F_l1g1..1(F_l1g+32)#0A#23d
efine.F_l1gh..1(F_l1g+64)#0A#23define.F_l2g..00247#0A
#23define.F_l2g1..1(F_l2g+32)#0A#23define.F_l2gh..1
(F_l2g+64)#0A#23define.F_lg..00348#0A#23define.F_lg
1..2(F_lg+32)#0A#23define.F_lgh..2(F_lg+64)#0A#23de
fine.F_sg..00349#0A#23define.F_sg1..2(F_sg+32)#0A#23
define.F_sgh..2(F_sg+64)#0A#23define.F_llg..00250#0A
#23define.F_llg1..1(F_llg+32)#0A#23define.F_llgh..1
(F_llg+64)#0A#23define.F_ag..00351#0A#23define.F_ag
1..2(F_ag+32)#0A#23define.F_agh..2(F_ag+64)#0A#23de
fine.F_mul..00252#0A#23define.F_div..00253#0A#23def
ine.F_rem..00254#0A#23define.F_xor..00255#0A#23defi
ne.F_sl..00356#0A#23define.F_ll..00358#0A#23define.
F_jne..00260#0A#0A#23define.F_llp..00264#0A#23defin
e.F_llph..00165#0A#23define.F_llpw..00166#0A#23defi
ne.F_add..00284#0A#23define.F_sub..00285#0A#23defin
e.F_lsh..00286#0A#23define.F_rsh..00287#0A#23define
.F_and..00288#0A#23define.F_or..00389#0A#23define.F
_ll1..00290#0A#23define.F_jls..00292#0A#0A#23define
.F_l..00496#0A#23define.F_lh..00397#0A#23define.F_l
w..00398#0A#23define.F_rv..002110006#0A#23define.F_
rtn..001123#0A#23define.F_jgr..001124#0A#0A#23defin
e.F_lp..002128#0A#23define.F_lph..001129#0A#23defin
e.F_lpw..001130#0A#23define.F_lp0..001128#0A#23defi
ne.F_sys..001145#0A#23define.F_swb..001146#0A#23def
ine.F_swl..001147#0A#23define.F_st..002148#0A#23def
ine.F_st0..001148#0A#23define.F_stp0..000149#0A#23d
efine.F_goto..000155#0A#23define.F_jle..001156#0A#0A
#23define.F_sp..002160#0A#23define.F_sph..001161#0A
#23define.F_spw..001162#0A#23define.F_sp0..001160#0A
#23define.F_s0..002176#0A#23define.F_xch..001181#0A
#23define.F_gbyt..000182#0A#23define.F_pbyt..000183
#0A#23define.F_atc..001184#0A#23define.F_atb..00118
5#0A#23define.F_j..003186#0A#23define.F_jge..001188
#0A#0A#23define.F_ap..002192#0A#23define.F_aph..001
193#0A#23define.F_apw..001194#0A#23define.F_ap0..00
1192#0A#0A#23define.F_xpbyt.205#0A#23define.F_lmh..
001206#0A#23define.F_btc..001207#0A#23define.F_nop.
.001208#0A#23define.F_a0..002208#0A#23define.F_rvp0
..000211#0A#23define.F_st0p0.216#0A#23define.F_st1p
0.218#0A#0A#23define.F_mw..002220003#0A#0A#23define
.F_a..003220004#0A#23define.F_ah..002220005#0A#23de
fine.F_aw..002220006#0A#23define.F_l0p0..000220004#0A
#23define.F_s..003237#0A#23define.F_sh..002238#0A#0A
#23define.F_mdiv..000239#0A#23define.F_chgco.240#0A
#23define.F_neg..001241#0A#23define.F_not..001242#0A
#23define.F_l1p0..000240#0A#23define.F_l2p0..000244
#0A#23define.F_l3p0..000247.#0A#23define.F_l4p0..00
0249#0A#0A#23define.F_selld.254#0A#23define.F_selst
.255#0A#23define.F_255..001255#0A#0A#23define.sf_no
ne..0020..3//.Assignment.operators#0A#23define.sf_v
ecap..0011#0A#23define.sf_fmul..0022#0A#23define.sf
_fdiv..0023#0A#23define.sf_fadd..0024#0A#23define.s
f_fsub..0025#0A#23define.sf_mul..0036#0A#23define.s
f_div..0037#0A#23define.sf_rem..0038#0A#23define.sf
_add..0039#0A#23define.sf_sub..00210#0A#23define.sf
_lshift.11#0A#23define.sf_rshift.12#0A#23define.sf_
logand.13#0A#23define.sf_logor..00014#0A#23define.s
f_eqv..00215#0A#23define.sf_neqv..00116#0A#0A/*.The
.function.interpret.is.designed.to.be.separately.co
mpiled,#0A//.and.possibly.implemented.in.assembly.l
anguage#2E#0A//#0A//.Unless.either.TRACINGyes.or.TA
LLYyes.are.defined,.its.only.free#0A//.variable.is.
the.function.dosys(p,.g)#2E#0A//#0A//.mem..is.the.p
ointer.to.the.cintcode.memory#2E#0A//.regs.is.the.p
osition.in.the.Cintcode.memory.where.the.initial#0A
//..4value.of.the.Cintcode.registers#2E#0A//#0A//.i
nterpret.executes.Cintcode.instructions.and.returns
.with.an#0A//.integer.result.as.follows:#0A#0A//..2
-2..4sys(Sys_dumpmem).cause.a.memory.dump.to.DUMP#2E
mem#0A//..2-1.*..2sys(Sys_setcount,.val).called#0A/
/..0030.*..2sys(Sys_quit,.0).called#0A//..0031..4No
n.existent.instruction#0A//..0032..4Brk.instruction
#0A//..0033..4Zero.count#0A//..0034..4PC.too.large.
or.negative#0A//..0035..4Division.by.zero#0A//..002
10..4Cintasm.single.step.trap#0A//..00211..4Content
s.of.watch.address.has.changed#0A//..00212..4Memory
.address.too.large.or.negative#0A//..00213..4SIGINT
.received#0A//..00214..4Unknown.floating.point.oper
ation#0A//..00215#0A//..00216..4P.pointer.too.large
.or.negative#0A//..3n..4sys(Sys_quit,.n).called#0A/
/#0A//.On.return.the.Cintcode.registers.are.dumped.
back.in.the.vector.regs#0A*/#0A#0A#23ifdef.FASTyes#0A
extern.BCPLWORD.*watchaddr,.watchval;#0A#23else#0AB
CPLWORD.*watchaddr#3D0,.watchval#3D0;#0A#23endif#0A
#0A#23define.B.(BP.W)#0A#23define.SB.(SBP.W)#0A#23d
efine.H.(HP.W)#0A#23define.SH.(SHP.W)#0A#0A#23ifdef
.BIGENDER#0A#23define.GH(x).((WD.B[x+0]<<0008).|.B[
x+1])#0A#23define.GW(x).((4WD.B[x]<<0008)|B[x+1])<<
0008)|B[x+2])<<0008)|B[x+3])#0A#23else#0A#23define.
GH(x).((WD.B[x+1]<<0008).|.B[x])#0A#23define.GW(x).
((4WD.B[x+3]<<0008)|B[x+2])<<0008)|B[x+1])<<0008)|B
[x])#0A#23endif#0A#0A#23ifndef.NOFLOAT#0A#0Astatic.
float.itof(BCPLWORD.a).{#0A..union.{.BCPLWORD.i;.fl
oat.f;.}.x;#0A..x#2Ei.#3D.a;#0A..return.x#2Ef;#0A}#0A
#0A#23endif#0A#0A#23ifdef.FASTyes#0Aint.cintasm(BCP
LWORD.regs,.BCPLWORDpt.mem)#0A#23else#0Aint.interpr
et(BCPLWORD.regs,.BCPLWORDpt.mem)#0A#23endif#0A#0A{
..BCPLWORDpt.W.#3D.mem;#0A#0A..1register.int.icount
.#3D.0;#0A#0A..1register.BCPLWORD..9a..#3D.W[regs+0
];#0A..1register.BCPLWORD..9b..#3D.W[regs+1];#0A..1
BCPLWORD..18c..#3D.W[regs+2];#0A..1BCPLWORD..18p..#3D
.W[regs+3]>>B2Wsh;#0A..1BCPLWORD..18g..#3D.W[regs+4
]>>B2Wsh;#0A..1BCPLWORD..18st.#3D.W[regs+5];#0A..1r
egister.BCPLWORD..9pc.#3D.W[regs+6];#0A..1BCPLWORD.
.18count.#3D.W[regs+7];#0A..1BCPLWORD..18mw.#3D.W[r
egs+8];#0A#0A..1register.BCPLWORDpt.Wp..#3D.W+p,..2
/*.Optimise.access.to.the.stack.*/#0A..21Wg..#3D.W+
g,..2/*.Optimise.access.to.the.global.vector.*/#0A.
.21Wg1.#3D.W+g+256;#0A#0A..1BCPLWORD.res,.k,.i;#0A#0A
..1UBCPLWORD.memupbb.#3D.memupb<<B2Wsh;#0A..1UBCPLW
ORD.tallylimb.#3D.tallylim<<B2Wsh;#0A#0A..1/*..1tra
cing.#3D.1;.*/#0A#0Afetchchk:#0A..1//.Check.PC.is.i
n.range#0A..1if((UBCPLWORD)pc.>.memupbb).goto.badpc
;#0A#0Afetch:#0A#0A#23ifdef.WATCHyes#0A..1/*.Specia
l.watch.debugging.aid.*/#0A..1if(watchaddr.&&.*watc
haddr!#3Dwatchval)#0A..1{./*#0A..5printf("%7".FormD
.":.changed.from.%7".FormD."(%8".FormX.").to.%7".Fo
rmD#0A..12"(%8".FormX.")\n",#0A..12watchaddr-W,.wat
chval,.(UBCPLWORD)watchval,#0A..12*watchaddr,.(UBCP
LWORD)*watchaddr);#0A..3*/#0A..3watchval.#3D.*watch
addr;#0A..3W[1].#3D.watchaddr-W;#0A..3W[2].#3D.watc
hval;#0A..3res.#3D.11;..6/*.Contents.of.watch.addre
ss.has.changed.*/#0A..3goto.ret;#0A..1}#0A..1/*.End
.of.watch.code.*/#0A#23endif#0A#0A..1/*.count>#3D0.
.means.execute.count.instructions.(slow.interpreter
)#0A..4count#3D-1..means.go.on.for.ever.(fast.inter
preter)#0A..4count#3D-2..means.single.step.the.fast
.interpreter#0A..1*/#0A#23ifdef.COUNTyes#0A..1if.(c
ount>#3D0)#0A..1{.if.(count#3D#3D0000).{.res.#3D.3;
.goto.ret;.}#0A..3count--;#0A..1}#0A#23endif#0A#0A#23
ifdef.TRACINGyes#0A..1if.(tracing).trace(pc,.p,.a,.
b);#0A#23endif#0A#0A#23ifdef.TALLYyes#0A..1if.((UBC
PLWORD)pc.<.tallylimb).tallyv[pc]++;#0A#23endif#0A#0A
if(--icount<#3D0).{#0A..//.Update.the.days.and.msec
s.fields.in.the.rootnode#0A..timestamp(&W[rootnode+
Rtn_days]);#0A..icount.#3D.1002;#0A..//.icount..3be
nch100.time#0A..//..0011..004923#2E370#0A..//..0011
0..00499#2E780#0A..//..001100..00316#2E040#0A..//..
0011001..0037#2E470#0A..//..0011002..0026#2E600.(gc
c.-O9)#0A..//..0011003..0016#2E510.(gcc.-O3)#0A..//
..0105#2E550000.without.this.code.omitted.(gcc.-O1)
#0A..//trpush(0x11000004+W[rootnode+Rtn_msecs]);#0A
}#0A#0A//.Uncommenting.the.next.line.increase.the.b
ench100.time#0A//.from.6#2E310.to.7#2E180.and.is.no
t.a.very.useful.check#2E#0A//if((UBCPLWORD)p.>.memu
pbb).{.res.#3D.16;.goto.ret;.}#0A#0Aswitch(B[pc++])
#0A{..default:#0A..1case.F_0:..3/*.Cases.F_0.and.F_
255.have.been.added.explicitly.to..1*/#0A..3//case.
F_255:..1/*.improve.the.compiled.code.(with.luck)..
13*/#0A..15res.#3D.1;.pc--;.goto.ret;./*.Unimplemen
ted.instruction..*/#0A#0A..3//.Added.21/7/10#0A..1c
ase.F_fltop:#0A..3{.BCPLWORD.op.#3D.B[pc++];#0A#0A#23
ifdef.NOFLOAT#0A..5a.#3D.0;#0A..5goto.fetch;#0A#23e
lse#0A..5//printf("fltop.op#3D%".FormD."\n",.op);#0A
..5switch.(op).{#0A..5default:#0A..7res.#3D.14;.pc.
-#3D2;.goto.ret;#0A#0A..5case.fl_avail:#0A..7a.#3D.
-1;.goto.fetch;#0A#0A..5case.fl_mk:#0A..5{.BCPLWORD
.exponent.#3D.B[pc++];.//.Signed.byte#0A..7if.(expo
nent>#3D128).exponent.#3D.exponent-256;#0A#09.//pri
ntf("fl_mk.calling.doflt(%".FormD.",.%".FormD.",.%"
.FormD.")\n",#0A..7//..6op,.a,.exponent);#0A..7a.#3D
.doflt(op,.a,.exponent);#0A..7goto.fetch;#0A..5}#0A
#0A..5case.fl_float:#0A..5case.fl_fix:#0A..5case.fl
_pos:#0A..5case.fl_neg:#0A..5case.fl_abs:#0A..7a.#3D
.doflt(op,.a,.0);#0A..7goto.fetch;#0A#0A..5case.fl_
mul:#0A..5case.fl_div:#0A..5case.fl_add:#0A..5case.
fl_sub:#0A..5case.fl_eq:#0A..5case.fl_ne:#0A..5case
.fl_ls:#0A..5case.fl_gr:#0A..5case.fl_le:#0A..5case
.fl_ge:#0A..7a.#3D.doflt(op,.b,.a);#0A..7goto.fetch
;#0A..5}#0A#23endif#0A..3}#0A#0A..3//.Added.21/7/10
#0A..1case.F_selld:..//.load.a.field..SELLD.len.sh#0A
..3{.BCPLWORD.len.#3D.B[pc++];#0A..5BCPLWORD.sh..#3D
.B[pc++];#0A..5BCPLWORD.mask.#3D.-1;#0A..5if.(len).
mask.#3D.(1<<len).-.1;#0A..5a.#3D.(W[a]>>sh).&.mask
;#0A..5goto.fetch;#0A..3}#0A#0A..3//.Added.21/7/10#0A
..1case.F_selst:.//.SLCT.len:sh:0.OF.<arg1>.op:#3D.
<arg2>#0A..15//..4len.sh..7a..1op..4b#0A..3{.BCPLWO
RD.*ptr.#3D.&W[a];#0A..5BCPLWORD.op..#3D.B[pc++];#0A
..5BCPLWORD.len.#3D.B[pc++];#0A..5BCPLWORD.sh..#3D.
B[pc++];#0A..5BCPLWORD.mask;#0A..5BCPLWORD.val;#0A.
.5BCPLWORD.oldval;#0A..5union.IorF.{.BCPLWORD.i;.fl
oat.f;.}.x,.y;#0A#0A..5if(len#3D#3D0000).{#0A..7mas
k.#3D.UWD(-1).>>.sh;#0A..5}.else.{#0A..7mask.#3D.(1
<<len).-.1;#0A..5}#0A..5val.#3D.WD((1UWD*ptr)>>sh))
.&.mask;#0A..5oldval.#3D.val;.//.Old.value.shifted.
down#0A#0A..5//.val.and.oldval.are.both.the.old.fie
ld.value.shifted.down#0A..5switch(op).{#0A..5defaul
t:..8a.#3D.0;.goto.fetch;#0A..5case.sf_none:..3val.
#3D.b;..15break;#0A..5case.sf_vecap:..2val.#3D.W[va
l.+.b];..6break;#0A..5case.sf_fmul:..3x#2Ei.#3D.val
;.y#2Ei.#3D.b;#0A..23x#2Ef.#3D.x#2Ef.*.y#2Ef;#0A..2
3val.#3D.x#2Ei;..13break;#0A..5case.sf_fdiv:..3x#2E
i.#3D.val;.y#2Ei.#3D.b;#0A..23x#2Ef.#3D.x#2Ef./.y#2E
f;#0A..23val.#3D.x#2Ei;..13break;#0A..5case.sf_fadd
:..3x#2Ei.#3D.val;.y#2Ei.#3D.b;#0A..23x#2Ef.#3D.x#2E
f.+.y#2Ef;#0A..23val.#3D.x#2Ei;..13break;#0A..5case
.sf_fsub:..3x#2Ei.#3D.val;.y#2Ei.#3D.b;#0A..23x#2Ef
.#3D.x#2Ef.-.y#2Ef;#0A..23val.#3D.x#2Ei;..13break;#0A
..5case.sf_mul:..4val.*#3D.b;..14break;#0A..5case.s
f_div:..4val./#3D.b;..14break;#0A..5case.sf_rem:..4
val.%#3D.b;..14break;#0A..5case.sf_add:..4val.+#3D.
b;..14break;#0A..5case.sf_sub:..4val.-#3D.b;..14bre
ak;#0A..5case.sf_lshift:..1if.(b>#3DBperW).val#3D0;
./*.bug.*/#0A..23val.<<#3D.b;..13break;#0A..5case.s
f_rshift:..1if.(b>#3DBperW).val#3D0;./*.bug.*/#0A#09
..15val.#3D.WD((UWD.val)>>b);..break;#0A..5case.sf_
logand:..1val.&#3D.b;..14break;#0A..5case.sf_logor:
..2val.|#3D.b;..14break;#0A..5case.sf_eqv:..4val.#3D
.~(val.^.b);..6break;#0A..5case.sf_neqv:..3val.^#3D
.b;..14break;#0A..5}#0A..5//printf("selst:.op#3D%".
FormD.".len#3D%".FormD.".sh#3D%".FormD#0A..5//..7".
oldval#3D%08".FormX.".val#3D%08".FormX.".mask#3D%08
".FormX."\n",#0A..5//..5op,.len,.sh,.(UBCPLWORD)old
val,.(UBCPLWORD)val,.(UBCPLWORD)mask);#0A..5//.Repl
ace.field.by.new.value#0A..5*ptr.^#3D.((val.^.oldva
l)&mask).<<.sh;#0A..5goto.fetch;#0A..3}#0A#0A..1cas
e.F_mul:..1a.#3D.b.*.a;..6goto.fetch;#0A..1case.F_d
iv:..1if(a#3D#3D0000).{res.#3D.5;.pc--;.goto.ret;.}
./*.Division.by.zero.*/#0A..15a.#3D.b./.a;..6goto.f
etch;#0A..1case.F_rem:..1if(a#3D#3D0000).{res.#3D.5
;.pc--;.goto.ret;.}./*.Division.by.zero.*/#0A..15a.
#3D.b.%.a;..6goto.fetch;#0A..1case.F_add:..1a.#3D.b
.+.a;..6goto.fetch;#0A..1case.F_sub:..1a.#3D.b.-.a;
..6goto.fetch;#0A..1case.F_neg:..1a.#3D.-.a;..8goto
.fetch;#0A#0A..1case.F_fhop:..a.#3D.0;.pc++;..4goto
.fetch;#0A#0A..1case.F_lsh:..1if.(a>#3DBperW).b#3D0
;./*.bug.*/#0A..15a.#3D.b.<<.a;..5goto.fetch;#0A..1
case.F_rsh:..1if.(a>#3DBperW).b#3D0;./*.bug.*/#0A..
15a.#3D.WD((UWD.b)>>a);.goto.fetch;#0A..1case.F_not
:..1a.#3D.~.a;..8goto.fetch;#0A..1case.F_and:..1a.#3D
.b.&.a;..6goto.fetch;#0A..1case.F_or:..2a.#3D.b.|.a
;..6goto.fetch;#0A..1case.F_xor:..1a.#3D.b.^.a;..6g
oto.fetch;#0A#0A..1case.F_goto:..pc.#3D.a;..9goto.f
etchchk;#0A#0A..1case.F_brk:..1res.#3D.2;.pc--;.got
o.ret;../*.BREAKPOINT..*/#0A..15#0A..1case.F_rv+6:.
.a.#3D.W[a+6];.goto.fetch;#0A..1case.F_rv+5:..a.#3D
.W[a+5];.goto.fetch;#0A..1case.F_rv+4:..a.#3D.W[a+4
];.goto.fetch;#0A..1case.F_rv+3:..a.#3D.W[a+3];.got
o.fetch;#0A..1case.F_rv+2:..a.#3D.W[a+2];.goto.fetc
h;#0A..1case.F_rv+1:..a.#3D.W[a+1];.goto.fetch;#0A.
.1case.F_rv:..2a.#3D.W[a+0];.goto.fetch;#0A#0A..1ca
se.F_st+3:..W[a+3].#3D.b;.goto.fetch;#0A..1case.F_s
t+2:..W[a+2].#3D.b;.goto.fetch;#0A..1case.F_st+1:..
W[a+1].#3D.b;.goto.fetch;#0A..1case.F_st:..2W[a+0].
#3D.b;.goto.fetch;#0A#0A..1case.F_chgco:.W[Wg[Gn_cu
rrco]].#3D.Wp[0];./*.!currco.:#3D.!p..2*/#0A..15pc.
#3D.Wp[1];..13/*.pc..4:#3D.p!1..1*/#0A..15Wg[Gn_cur
rco].#3D.Wp[4];..2/*.currco..:#3D.cptr..*/#0A..15p.
#3D.W[Wp[4]]>>B2Wsh;..4/*.p..5:#3D.!cptr.*/#0A..15W
p.#3D.W+p;#0A..15goto.fetchchk;#0A#0A..1case.F_mdiv
:#0A..13{.BCPLINT64.ab.#3D.(BCPLINT64)(Wp[3]).*.(BC
PLINT64)(Wp[4]);#0A..15BCPLWORD.c.#3D.Wp[5];#0A..15
if(c#3D#3D0000).c#3D1;#0A..15Wg[Gn_result2].#3D.(BC
PLWORD)(ab.%.c);#0A..15a.#3D.(BCPLWORD)(ab./.c);#0A
..15/*.fall.through.to.return..*/#0A..13}#0A..1case
.F_rtn:..1pc.#3D.Wp[1];#0A..15p..#3D.W[p]>>B2Wsh;#0A
..15Wp.#3D.W+p;.#0A..15goto.fetchchk;#0A#0A..1case.
F_gbyt:.a.#3D.B[a+(b<<B2Wsh)];#0A..14goto.fetch;#0A
..1case.F_pbyt:.B[a+(b<<B2Wsh)].#3D.(char)c;..goto.
fetch;#0A..1case.F_xpbyt:B[b+(a<<B2Wsh)].#3D.(char)
c;..goto.fetch;#0A..1case.F_atc:..c.#3D.a;..20goto.
fetch;#0A..1case.F_btc:..c.#3D.b;..20goto.fetch;#0A
..1case.F_atb:..b.#3D.a;..20goto.fetch;#0A..1case.F
_xch:..a.#3D.a^b;.b.#3D.a^b;.a.#3D.a^b;..goto.fetch
;#0A#0A..1case.F_swb:.{.BCPLWORD.n,.k,.val,.i#3D1;#0A
..15k.#3D.(pc+1)>>0001;#0A..15n.#3D.H[k];#0A..15whi
le(i<#3Dn)#0A..15{.i.+#3D.i;#0A..17val.#3D.H[k+i];#0A
..17if.(a#3D#3Dval).{.k.+#3D.i;.break;.}#0A..17if.(
a<val).i++;#0A..15}#0A..15k++;#0A..15pc.#3D.(k<<000
1).+.SH[k];#0A..15goto.fetchchk;#0A..13}#0A#0A..1ca
se.F_swl:.{.BCPLWORD.n,q;#0A..15q.#3D.(pc+1)>>0001;
#0A..15n.#3D.H[q++];#0A..15if(0<#3Da.&&.a<n).q.+#3D
.a.+.1;#0A..15pc.#3D.(q<<0001).+.SH[q];#0A..15goto.
fetchchk;#0A..13}#0A#0A..1case.F_sys:.switch(a).{#0A
..15default:.//.system.call.--.general.case#0A.#0A#09
#09..7W[regs+0]..#3D.a;..2/*.Save.all.the.registers
.*/#0A#09#09..7W[regs+1]..#3D.b;..2/*.for.debugging
.purposes.*/#0A..23W[regs+2]..#3D.c;#0A..23W[regs+3
]..#3D.p<<B2Wsh;#0A..23W[regs+4]..#3D.g<<B2Wsh;#0A.
.23W[regs+5]..#3D.st;#0A..23W[regs+6]..#3D.pc;#0A..
23W[regs+7]..#3D.count;#0A..23W[regs+8]..#3D.mw;#0A
..#0A..23a.#3D.dosys(p,.g);.#0A..23goto.fetch;#0A#0A
..15case.Sys_setcount:#0A..23/*.oldcount.:#3D.sys(S
ys_setcount,.newcount)..*/#0A..23a.#3D.count;.#0A#09
#09..7count.#3D.Wp[4];#0A..23res.#3D.-1;./*.Leave.a
nd.immediately.re-enter.*/#0A..23goto.ret;./*.the.i
nterpreter.*/#0A#0A..15case.Sys_quit:#0A..23res.#3D
.Wp[4];#0A..23goto.ret;#0A#0A#09..4/*#0A..15case.Sy
s_rti:..//..sys(Sys_rti,.regs)#0A..15case.Sys_saver
egs:.//.sys(Sys_saveregs,.regs)#0A..15case.Sys_sets
t:.//.sys(Sys_setst,.st)#0A..12*/#0A#09#09.case.Sys
_watch:../*.sys(Sys_watch,.addr).*/#0A..21{.watchad
dr.#3D.&W[Wp[4]];#0A#09..15watchval.#3D.*watchaddr;
#0A..23goto.fetch;#0A..21}#0A..13}#0A#0A..1case.F_l
p0+16:..b.#3D.a;.a.#3D.Wp[16];.goto.fetch;#0A..1cas
e.F_lp0+15:..b.#3D.a;.a.#3D.Wp[15];.goto.fetch;#0A.
.1case.F_lp0+14:..b.#3D.a;.a.#3D.Wp[14];.goto.fetch
;#0A..1case.F_lp0+13:..b.#3D.a;.a.#3D.Wp[13];.goto.
fetch;#0A..1case.F_lp0+12:..b.#3D.a;.a.#3D.Wp[12];.
goto.fetch;#0A..1case.F_lp0+11:..b.#3D.a;.a.#3D.Wp[
11];.goto.fetch;#0A..1case.F_lp0+10:..b.#3D.a;.a.#3D
.Wp[10];.goto.fetch;#0A..1case.F_lp0+9:..1b.#3D.a;.
a.#3D.Wp[9];..goto.fetch;#0A..1case.F_lp0+8:..1b.#3D
.a;.a.#3D.Wp[8];..goto.fetch;#0A..1case.F_lp0+7:..1
b.#3D.a;.a.#3D.Wp[7];..goto.fetch;#0A..1case.F_lp0+
6:..1b.#3D.a;.a.#3D.Wp[6];..goto.fetch;#0A..1case.F
_lp0+5:..1b.#3D.a;.a.#3D.Wp[5];..goto.fetch;#0A..1c
ase.F_lp0+4:..1b.#3D.a;.a.#3D.Wp[4];..goto.fetch;#0A
..1case.F_lp0+3:..1b.#3D.a;.a.#3D.Wp[3];..goto.fetc
h;#0A#0A..1case.F_lp:..1b.#3D.a;.a.#3D.Wp[B[pc++]];
..8goto.fetch;#0A..1case.F_lph:..b.#3D.a;.a.#3D.Wp[
GH(pc)];..pc.+#3D.2;.goto.fetch;#0A..1case.F_lpw:..
b.#3D.a;.a.#3D.Wp[GW(pc)];..pc.+#3D.4;.goto.fetch;#0A
#0A..1case.F_llp:..b.#3D.a;.a.#3D.p+B[pc++];..11got
o.fetch;#0A..1case.F_llph:.b.#3D.a;.a.#3D.p+GH(pc);
..3pc.+#3D.2;.goto.fetch;#0A..1case.F_llpw:.b.#3D.a
;.a.#3D.p+GW(pc);..3pc.+#3D.4;.goto.fetch;#0A#0A..1
case.F_sp0+16:.Wp[16].#3D.a;.goto.fetch;#0A..1case.
F_sp0+15:.Wp[15].#3D.a;.goto.fetch;#0A..1case.F_sp0
+14:.Wp[14].#3D.a;.goto.fetch;#0A..1case.F_sp0+13:.
Wp[13].#3D.a;.goto.fetch;#0A..1case.F_sp0+12:.Wp[12
].#3D.a;.goto.fetch;#0A..1case.F_sp0+11:.Wp[11].#3D
.a;.goto.fetch;#0A..1case.F_sp0+10:.Wp[10].#3D.a;.g
oto.fetch;#0A..1case.F_sp0+9:..Wp[9]..#3D.a;.goto.f
etch;#0A..1case.F_sp0+8:..Wp[8]..#3D.a;.goto.fetch;
#0A..1case.F_sp0+7:..Wp[7]..#3D.a;.goto.fetch;#0A..
1case.F_sp0+6:..Wp[6]..#3D.a;.goto.fetch;#0A..1case
.F_sp0+5:..Wp[5]..#3D.a;.goto.fetch;#0A..1case.F_sp
0+4:..Wp[4]..#3D.a;.goto.fetch;#0A..1case.F_sp0+3:.
.Wp[3]..#3D.a;.goto.fetch;#0A#0A..1case.F_sp:..2Wp[
B[pc++]].#3D.a;..16goto.fetch;#0A..1case.F_sph:..1W
p[GH(pc)]..#3D.a;..7pc.+#3D.2;.goto.fetch;#0A..1cas
e.F_spw:..1Wp[GW(pc)]..#3D.a;..7pc.+#3D.4;.goto.fet
ch;#0A#0A..1case.F_lgh:..1b.#3D.a;.a.#3D.Wg[GH(pc)]
;..1pc.+#3D.2;.goto.fetch;#0A..1case.F_lg1:..1b.#3D
.a;.a.#3D.Wg1[B[pc++]];..8goto.fetch;#0A..1case.F_l
g:..2b.#3D.a;.a.#3D.Wg[B[pc++]];..9goto.fetch;#0A#0A
..1case.F_sgh:..1Wg[GH(pc)]..1#3D.a;..6pc.+#3D.2;.g
oto.fetch;#0A..1case.F_sg1:..1Wg1[B[pc++]].#3D.a;..
15goto.fetch;#0A..1case.F_sg:..2Wg[B[pc++]]..#3D.a;
..15goto.fetch;#0A#0A..1case.F_llgh:.b.#3D.a;.a.#3D
.g+GH(pc);..4pc.+#3D.2;.goto.fetch;#0A..1case.F_llg
1:.b.#3D.a;.a.#3D.g+256+B[pc++];..8goto.fetch;#0A..
1case.F_llg:..b.#3D.a;.a.#3D.g+B[pc++];..12goto.fet
ch;#0A#0A..1case.F_ll+1:.i.#3D.(pc>>0001).+.B[pc];#0A
..14i.#3D.(i<<0001).+.SH[i];#0A..14b.#3D.a;.a.#3D.W
[i>>B2Wsh];..8pc++;.goto.fetch;#0A#0A..1case.F_ll:.
.1b.#3D.a;.a.#3D.W[(pc+SB[pc])>>B2Wsh];pc++;.goto.f
etch;#0A#0A..1case.F_sl+1:.i.#3D.(pc>>0001).+.B[pc]
;#0A..14i.#3D.(i<<0001).+.SH[i];#0A..14W[i>>B2Wsh].
#3D.a;..15pc++;.goto.fetch;#0A#0A..1case.F_sl:..1W[
(pc+SB[pc])>>B2Wsh].#3D.a;..5pc++;.goto.fetch;#0A..
1#0A..1case.F_ll1+1:i.#3D.(pc>>0001).+.B[pc];#0A..1
4i.#3D.(i<<0001).+.SH[i];#0A..14b.#3D.a;.a.#3D.i>>B
2Wsh;..11pc++;.goto.fetch;#0A#0A..1case.F_ll1:..b.#3D
.a;.a.#3D.(pc+SB[pc])>>B2Wsh;..1pc++;.goto.fetch;#0A
..1#0A..1case.F_l0+10:.b.#3D.a;.a.#3D.10;.goto.fetc
h;#0A..1case.F_l0+9:..b.#3D.a;.a.#3D..0009;.goto.fe
tch;#0A..1case.F_l0+8:..b.#3D.a;.a.#3D..0008;.goto.
fetch;#0A..1case.F_l0+7:..b.#3D.a;.a.#3D..0007;.got
o.fetch;#0A..1case.F_l0+6:..b.#3D.a;.a.#3D..0006;.g
oto.fetch;#0A..1case.F_l0+5:..b.#3D.a;.a.#3D..0005;
.goto.fetch;#0A..1case.F_l0+4:..b.#3D.a;.a.#3D..000
4;.goto.fetch;#0A..1case.F_l0+3:..b.#3D.a;.a.#3D..0
003;.goto.fetch;#0A..1case.F_l0+2:..b.#3D.a;.a.#3D.
.0002;.goto.fetch;#0A..1case.F_l0+1:..b.#3D.a;.a.#3D
..0001;.goto.fetch;#0A..1case.F_l0:..2b.#3D.a;.a.#3D
..0000;.goto.fetch;#0A..1case.F_l0-1:..b.#3D.a;.a.#3D
.-1;.goto.fetch;.#0A#0A..1case.F_l:..3b.#3D.a;.a.#3D
.B[pc++];..13goto.fetch;#0A..1case.F_lh:..2b.#3D.a;
.a.#3D.GH(pc);..5pc.+#3D.2;.goto.fetch;#0A..1case.F
_lw:..2b.#3D.a;.a.#3D.GW(pc);..5pc.+#3D.4;.goto.fet
ch;#0A#0A..1case.F_lm:..2b.#3D.a;.a.#3D.-.WD(B[pc++
]);..7goto.fetch;#0A..1case.F_lmh:..1b.#3D.a;.a.#3D
.-.WD(GH(pc));.pc.+#3D.2;.goto.fetch;#0A..14#0A..1c
ase.F_lf+1:..b.#3D.a;#0A..15a.#3D.(pc>>0001).+.B[pc
];#0A..15a.#3D.(a<<0001).+.SH[a];..7pc++;.goto.fetc
h;#0A#0A..1case.F_lf:..2b.#3D.a;.a.#3D.pc.+.SB[pc];
..3pc++;.goto.fetch;#0A.#0A..1case.F_k0gh+11:.Wp[11
].#3D.p<<B2Wsh;.p.+#3D.11;.goto.applygh;#0A..1case.
F_k0gh+10:.Wp[10].#3D.p<<B2Wsh;.p.+#3D.10;.goto.app
lygh;#0A..1case.F_k0gh+9:..Wp[.9].#3D.p<<B2Wsh;.p.+
#3D..0009;.goto.applygh;#0A..1case.F_k0gh+8:..Wp[.8
].#3D.p<<B2Wsh;.p.+#3D..0008;.goto.applygh;#0A..1ca
se.F_k0gh+7:..Wp[.7].#3D.p<<B2Wsh;.p.+#3D..0007;.go
to.applygh;#0A..1case.F_k0gh+6:..Wp[.6].#3D.p<<B2Ws
h;.p.+#3D..0006;.goto.applygh;#0A..1case.F_k0gh+5:.
.Wp[.5].#3D.p<<B2Wsh;.p.+#3D..0005;.goto.applygh;#0A
..1case.F_k0gh+4:..Wp[.4].#3D.p<<B2Wsh;.p.+#3D..000
4;.goto.applygh;#0A..1case.F_k0gh+3:..Wp[.3].#3D.p<
<B2Wsh;.p.+#3D..0003;#0A..1applygh:..6Wp..2#3D.W+p;
#0A..17Wp[1].#3D.pc.+.2;#0A..17pc..2#3D.Wg[GH(pc)];
#0A..17Wp[2].#3D.pc;#0A..17Wp[3].#3D..a;#0A..17goto
.fetchchk;#0A#0A..1case.F_k0g1+11:.Wp[11].#3D.p<<B2
Wsh;.p.+#3D.11;.goto.applyg1;#0A..1case.F_k0g1+10:.
Wp[10].#3D.p<<B2Wsh;.p.+#3D.10;.goto.applyg1;#0A..1
case.F_k0g1+9:..Wp[.9].#3D.p<<B2Wsh;.p.+#3D..0009;.
goto.applyg1;#0A..1case.F_k0g1+8:..Wp[.8].#3D.p<<B2
Wsh;.p.+#3D..0008;.goto.applyg1;#0A..1case.F_k0g1+7
:..Wp[.7].#3D.p<<B2Wsh;.p.+#3D..0007;.goto.applyg1;
#0A..1case.F_k0g1+6:..Wp[.6].#3D.p<<B2Wsh;.p.+#3D..
0006;.goto.applyg1;#0A..1case.F_k0g1+5:..Wp[.5].#3D
.p<<B2Wsh;.p.+#3D..0005;.goto.applyg1;#0A..1case.F_
k0g1+4:..Wp[.4].#3D.p<<B2Wsh;.p.+#3D..0004;.goto.ap
plyg1;#0A..1case.F_k0g1+3:..Wp[.3].#3D.p<<B2Wsh;.p.
+#3D..0003;#0A..1applyg1:..6Wp..2#3D.W+p;#0A..17Wp[
1].#3D.pc.+.1;#0A..17pc..2#3D.Wg1[B[pc]];#0A..17Wp[
2].#3D.pc;#0A..17Wp[3].#3D.a;#0A..17goto.fetchchk;#0A
.#0A..1case.F_k0g+11:.Wp[11].#3D.p<<B2Wsh;.p.+#3D.1
1;.goto.applyg;#0A..1case.F_k0g+10:.Wp[10].#3D.p<<B
2Wsh;.p.+#3D.10;.goto.applyg;#0A..1case.F_k0g+9:..W
p[.9].#3D.p<<B2Wsh;.p.+#3D..0009;.goto.applyg;#0A..
1case.F_k0g+8:..Wp[.8].#3D.p<<B2Wsh;.p.+#3D..0008;.
goto.applyg;#0A..1case.F_k0g+7:..Wp[.7].#3D.p<<B2Ws
h;.p.+#3D..0007;.goto.applyg;#0A..1case.F_k0g+6:..W
p[.6].#3D.p<<B2Wsh;.p.+#3D..0006;.goto.applyg;#0A..
1case.F_k0g+5:..Wp[.5].#3D.p<<B2Wsh;.p.+#3D..0005;.
goto.applyg;#0A..1case.F_k0g+4:..Wp[.4].#3D.p<<B2Ws
h;.p.+#3D..0004;.goto.applyg;#0A..1case.F_k0g+3:..W
p[.3].#3D.p<<B2Wsh;.p.+#3D..0003;#0A..1applyg:..6Wp
..2#3D.W+p;#0A..16Wp[1].#3D.pc.+.1;#0A..16pc..2#3D.
Wg[B[pc]];#0A..16Wp[2].#3D.pc;#0A..16Wp[3].#3D.a;#0A
..16goto.fetchchk;#0A.#0A..1case.F_k0+11:..Wp[11].#3D
.p<<B2Wsh;.p.+#3D.11;.goto.applyk;#0A..1case.F_k0+1
0:..Wp[10].#3D.p<<B2Wsh;.p.+#3D.10;.goto.applyk;#0A
..1case.F_k0+9:..1Wp[.9].#3D.p<<B2Wsh;.p.+#3D..0009
;.goto.applyk;#0A..1case.F_k0+8:..1Wp[.8].#3D.p<<B2
Wsh;.p.+#3D..0008;.goto.applyk;#0A..1case.F_k0+7:..
1Wp[.7].#3D.p<<B2Wsh;.p.+#3D..0007;.goto.applyk;#0A
..1case.F_k0+6:..1Wp[.6].#3D.p<<B2Wsh;.p.+#3D..0006
;.goto.applyk;#0A..1case.F_k0+5:..1Wp[.5].#3D.p<<B2
Wsh;.p.+#3D..0005;.goto.applyk;#0A..1case.F_k0+4:..
1Wp[.4].#3D.p<<B2Wsh;.p.+#3D..0004;.goto.applyk;#0A
..1case.F_k0+3:..1Wp[.3].#3D.p<<B2Wsh;.p.+#3D..0003
;#0A..1applyk:..6Wp..2#3D.W+p;#0A..16Wp[1].#3D.WD.p
c;#0A..16pc..2#3D.a;#0A..16Wp[2].#3D.pc;#0A..16Wp[3
].#3D.a.#3D.b;#0A..16goto.fetchchk;#0A#0A..1case.F_
k:..4k.#3D.B[pc];.Wp[k].#3D.p<<B2Wsh;.p.+#3D..k;#0A
..16Wp..2#3D.W+p;#0A..16Wp[1].#3D.pc.+.1;#0A..16pc.
.2#3D.a;#0A..16Wp[2].#3D.pc;#0A..16Wp[3].#3D.a.#3D.
b;#0A..16goto.fetchchk;#0A#0A..1case.F_kh:..3k.#3D.
GH(pc);.Wp[k].#3D.p<<B2Wsh;.p.+#3D..k;#0A..16Wp..2#3D
.W+p;#0A..16Wp[1].#3D.pc.+.2;#0A..16pc..2#3D.a;#0A.
.16Wp[2].#3D.pc;#0A..16Wp[3].#3D.a.#3D.b;#0A..16got
o.fetchchk;#0A#0A..1case.F_kw:..3k.#3D.GW(pc);.Wp[k
].#3D.p<<B2Wsh;.p.+#3D..k;#0A..16Wp..2#3D.W+p;#0A..
16Wp[1].#3D.pc.+.4;#0A..16pc..2#3D.a;#0A..16Wp[2].#3D
.pc;#0A..16Wp[3].#3D.a.#3D.b;#0A..16goto.fetchchk;#0A
#0A..1case.F_jeq:..1if(b#3D#3Da).{.pc.+#3D.SB[pc];.
.1goto.fetch;.}#0A..15pc++;.goto.fetch;#0A..1case.F
_jeq+1:.if(b#3D#3Da).goto.indjump;#0A..15pc++;.goto
.fetch;#0A..1case.F_jeq+2:.if(a#3D#3D0000).{.pc.+#3D
.SB[pc];..1goto.fetch;.}#0A..15pc++;.goto.fetch;#0A
..1case.F_jeq+3:.if(a#3D#3D0000).goto.indjump;#0A..
15pc++;.goto.fetch;#0A#0A..1case.F_jne:..1if(b!#3Da
).{.pc.+#3D.SB[pc];..1goto.fetch;.}#0A..15pc++;.got
o.fetch;#0A..1case.F_jne+1:.if(b!#3Da).goto.indjump
;#0A..15pc++;.goto.fetch;#0A..1case.F_jne+2:.if(a!#3D
0).{.pc.+#3D.SB[pc];..1goto.fetch;.}#0A..15pc++;.go
to.fetch;#0A..1case.F_jne+3:.if(a!#3D0).goto.indjum
p;#0A..15pc++;.goto.fetch;#0A#0A..1case.F_jls:..1if
(b<a).{.pc.+#3D.SB[pc];..1goto.fetch;.}#0A..15pc++;
.goto.fetch;#0A..1case.F_jls+1:.if(b<a).goto.indjum
p;#0A..15pc++;.goto.fetch;#0A..1case.F_jls+2:.if(a<
0).{.pc.+#3D.SB[pc];..1goto.fetch;.}#0A..15pc++;.go
to.fetch;#0A..1case.F_jls+3:.if(a<0).goto.indjump;#0A
..15pc++;.goto.fetch;#0A#0A..1case.F_jgr:..1if(b>a)
.{.pc.+#3D.SB[pc];..1goto.fetch;.}#0A..15pc++;.goto
.fetch;#0A..1case.F_jgr+1:.if(b>a).goto.indjump;#0A
..15pc++;.goto.fetch;#0A..1case.F_jgr+2:.if(a>0).{.
pc.+#3D.SB[pc];..1goto.fetch;.}#0A..15pc++;.goto.fe
tch;#0A..1case.F_jgr+3:.if(a>0).goto.indjump;#0A..1
5pc++;.goto.fetch;#0A#0A..1case.F_jle:..1if(b<#3Da)
.{.pc.+#3D.SB[pc];..1goto.fetch;.}#0A..15pc++;.goto
.fetch;#0A..1case.F_jle+1:.if(b<#3Da).goto.indjump;
#0A..15pc++;.goto.fetch;#0A..1case.F_jle+2:.if(a<#3D
0).{.pc.+#3D.SB[pc];..1goto.fetch;.}#0A..15pc++;.go
to.fetch;#0A..1case.F_jle+3:.if(a<#3D0).goto.indjum
p;#0A..15pc++;.goto.fetch;#0A#0A..1case.F_jge:..1if
(b>#3Da).{.pc.+#3D.SB[pc];..1goto.fetch;.}#0A..15pc
++;.goto.fetch;#0A..1case.F_jge+1:.if(b>#3Da).goto.
indjump;#0A..15pc++;.goto.fetch;#0A..1case.F_jge+2:
.if(a>#3D0).{.pc.+#3D.SB[pc];..1goto.fetch;.}#0A..1
5pc++;.goto.fetch;#0A..1case.F_jge+3:.if(a>#3D0).go
to.indjump;#0A..15pc++;.goto.fetch;#0A#0A..1case.F_
j:..3pc.+#3D.SB[pc];..6goto.fetch;#0A#0A.indjump:#0A
..1case.F_j+1:..1pc.#3D.(pc>>0001).+.B[pc];#0A..15p
c.#3D.(pc<<0001).+.SH[pc];#0A..15goto.fetch;#0A#0A.
.1case.F_ap0+12:.a.#3D.a.+.Wp[12];.goto.fetch;#0A..
1case.F_ap0+11:.a.#3D.a.+.Wp[11];.goto.fetch;#0A..1
case.F_ap0+10:.a.#3D.a.+.Wp[10];.goto.fetch;#0A..1c
ase.F_ap0+9:..a.#3D.a.+.Wp[.9];.goto.fetch;#0A..1ca
se.F_ap0+8:..a.#3D.a.+.Wp[.8];.goto.fetch;#0A..1cas
e.F_ap0+7:..a.#3D.a.+.Wp[.7];.goto.fetch;#0A..1case
.F_ap0+6:..a.#3D.a.+.Wp[.6];.goto.fetch;#0A..1case.
F_ap0+5:..a.#3D.a.+.Wp[.5];.goto.fetch;#0A..1case.F
_ap0+4:..a.#3D.a.+.Wp[.4];.goto.fetch;#0A..1case.F_
ap0+3:..a.#3D.a.+.Wp[.3];.goto.fetch;#0A#0A..1case.
F_ap:..2a.+#3D.Wp[B[pc++]];..7goto.fetch;#0A..1case
.F_aph:..1a.+#3D.Wp[GH(pc)];.pc.+#3D.2;.goto.fetch;
#0A..1case.F_apw:..1a.+#3D.Wp[GW(pc)];.pc.+#3D.4;.g
oto.fetch;#0A..1case.F_agh:..1a.+#3D.Wg[GH(pc)];.pc
.+#3D.2;.goto.fetch;#0A..1case.F_ag1:..1a.+#3D.Wg1[
B[pc++]];..6goto.fetch;#0A..1case.F_ag:..2a.+#3D.Wg
[B[pc++]];..7goto.fetch;#0A#0A..1case.F_a0+5:.a.+#3D
.5;.goto.fetch;#0A..1case.F_a0+4:.a.+#3D.4;.goto.fe
tch;#0A..1case.F_a0+3:.a.+#3D.3;.goto.fetch;#0A..1c
ase.F_a0+2:.a.+#3D.2;.goto.fetch;#0A..1case.F_a0+1:
.a.+#3D.1;.goto.fetch;#0A..1case.F_nop:..8goto.fetc
h;#0A#0A..1//.mv.is.only.used.in.64-bit.Cintcode#0A
..1//.Commented.out.to.avoid.a.warning#0A..1//case.
F_mw:..1mw.#3D.GW(pc)<<00032;..1pc.+#3D.4;.goto.fet
ch;#0A#0A..1case.F_a:..2a.+#3D.B[pc++];..9goto.fetc
h;#0A..1case.F_ah:..1a.+#3D.GH(pc);..1pc.+#3D.2;.go
to.fetch;#0A..1case.F_aw:..1a.+#3D.GW(pc);..1pc.+#3D
.4;.goto.fetch;#0A..1case.F_s:..2a.-#3D.B[pc++];..9
goto.fetch;#0A..1case.F_sh:..1a.-#3D.GH(pc);..1pc.+
#3D.2;.goto.fetch;#0A#0A..1case.F_s0+4:.a.-#3D.4;.g
oto.fetch;#0A..1case.F_s0+3:.a.-#3D.3;.goto.fetch;#0A
..1case.F_s0+2:.a.-#3D.2;.goto.fetch;#0A..1case.F_s
0+1:.a.-#3D.1;.goto.fetch;#0A#0A..1case.F_l0p0+12:.
b.#3D.a;.a.#3D.W[Wp[12]+0];.goto.fetch;#0A..1case.F
_l0p0+11:.b.#3D.a;.a.#3D.W[Wp[11]+0];.goto.fetch;#0A
..1case.F_l0p0+10:.b.#3D.a;.a.#3D.W[Wp[10]+0];.goto
.fetch;#0A..1case.F_l0p0+9:..b.#3D.a;.a.#3D.W[Wp[.9
]+0];.goto.fetch;#0A..1case.F_l0p0+8:..b.#3D.a;.a.#3D
.W[Wp[.8]+0];.goto.fetch;#0A..1case.F_l0p0+7:..b.#3D
.a;.a.#3D.W[Wp[.7]+0];.goto.fetch;#0A..1case.F_l0p0
+6:..b.#3D.a;.a.#3D.W[Wp[.6]+0];.goto.fetch;#0A..1c
ase.F_l0p0+5:..b.#3D.a;.a.#3D.W[Wp[.5]+0];.goto.fet
ch;#0A..1case.F_l0p0+4:..b.#3D.a;.a.#3D.W[Wp[.4]+0]
;.goto.fetch;#0A..1case.F_l0p0+3:..b.#3D.a;.a.#3D.W
[Wp[.3]+0];.goto.fetch;#0A#0A..1case.F_l1p0+6:..b.#3D
.a;.a.#3D.W[Wp[.6]+1];.goto.fetch;#0A..1case.F_l1p0
+5:..b.#3D.a;.a.#3D.W[Wp[.5]+1];.goto.fetch;#0A..1c
ase.F_l1p0+4:..b.#3D.a;.a.#3D.W[Wp[.4]+1];.goto.fet
ch;#0A..1case.F_l1p0+3:..b.#3D.a;.a.#3D.W[Wp[.3]+1]
;.goto.fetch;#0A#0A..1case.F_l2p0+5:..b.#3D.a;.a.#3D
.W[Wp[.5]+2];.goto.fetch;#0A..1case.F_l2p0+4:..b.#3D
.a;.a.#3D.W[Wp[.4]+2];.goto.fetch;#0A..1case.F_l2p0
+3:..b.#3D.a;.a.#3D.W[Wp[.3]+2];.goto.fetch;#0A#0A.
.1case.F_l3p0+4:..b.#3D.a;.a.#3D.W[Wp[.4]+3];.goto.
fetch;#0A..1case.F_l3p0+3:..b.#3D.a;.a.#3D.W[Wp[.3]
+3];.goto.fetch;#0A#0A..1case.F_l4p0+4:..b.#3D.a;.a
.#3D.W[Wp[.4]+4];.goto.fetch;#0A..1case.F_l4p0+3:..
b.#3D.a;.a.#3D.W[Wp[.3]+4];.goto.fetch;#0A#0A..1cas
e.F_l0gh:..b.#3D.a;.a.#3D.W[Wg[GH(pc)]+0];.pc.+#3D.
2;.goto.fetch;#0A..1case.F_l1gh:..b.#3D.a;.a.#3D.W[
Wg[GH(pc)]+1];.pc.+#3D.2;.goto.fetch;#0A..1case.F_l
2gh:..b.#3D.a;.a.#3D.W[Wg[GH(pc)]+2];.pc.+#3D.2;.go
to.fetch;#0A..1case.F_l0g1:..b.#3D.a;.a.#3D.W[Wg1[B
[pc++]]+0];..6goto.fetch;#0A..1case.F_l1g1:..b.#3D.
a;.a.#3D.W[Wg1[B[pc++]]+1];..6goto.fetch;#0A..1case
.F_l2g1:..b.#3D.a;.a.#3D.W[Wg1[B[pc++]]+2];..6goto.
fetch;#0A..1case.F_l0g:..1b.#3D.a;.a.#3D.W[Wg[B[pc+
+]]+0];..7goto.fetch;#0A..1case.F_l1g:..1b.#3D.a;.a
.#3D.W[Wg[B[pc++]]+1];..7goto.fetch;#0A..1case.F_l2
g:..1b.#3D.a;.a.#3D.W[Wg[B[pc++]]+2];..7goto.fetch;
#0A#0A..1case.F_s0gh:..W[Wg[GH(pc)]+0].#3D.a;..6pc.
+#3D.2;.goto.fetch;#0A..1case.F_s0g1:..W[Wg1[B[pc++
]]+0].#3D.a;..13goto.fetch;#0A..1case.F_s0g:..1W[Wg
[B[pc++]]+0].#3D.a;..14goto.fetch;#0A#0A..1case.F_s
tp0+5:.W[a+Wp[5]].#3D.b;.goto.fetch;#0A..1case.F_st
p0+4:.W[a+Wp[4]].#3D.b;.goto.fetch;#0A..1case.F_stp
0+3:.W[a+Wp[3]].#3D.b;.goto.fetch;#0A#0A..1case.F_s
t0p0+4:.W[Wp[4]+0].#3D.a;.goto.fetch;#0A..1case.F_s
t0p0+3:.W[Wp[3]+0].#3D.a;.goto.fetch;#0A#0A..1case.
F_st1p0+4:.W[Wp[4]+1].#3D.a;.goto.fetch;#0A..1case.
F_st1p0+3:.W[Wp[3]+1].#3D.a;.goto.fetch;#0A..1#0A..
1case.F_rvp0+7:.a.#3D.W[a+Wp[7]];.goto.fetch;#0A..1
case.F_rvp0+6:.a.#3D.W[a+Wp[6]];.goto.fetch;#0A..1c
ase.F_rvp0+5:.a.#3D.W[a+Wp[5]];.goto.fetch;#0A..1ca
se.F_rvp0+4:.a.#3D.W[a+Wp[4]];.goto.fetch;#0A..1cas
e.F_rvp0+3:.a.#3D.W[a+Wp[3]];.goto.fetch;#0A..1}#0A
#0Abadpc:#0A..1res.#3D.4;../*.pc.too.large.or.negat
ive..*/#0A.#0Aret:#0A..1tracing.#3D.0;#0A..1//print
f("cinterp:.returning.from.interpret,.res#3D%".Form
D."\n",.res);#0A..1W[regs+0]..#3D.a;..2/*.Save.the.
machine.registers..*/#0A..1W[regs+1]..#3D.b;#0A..1W
[regs+2]..#3D.c;#0A..1W[regs+3]..#3D.p<<B2Wsh;#0A..
1W[regs+4]..#3D.g<<B2Wsh;#0A..1W[regs+5]..#3D.st;#0A
..1W[regs+6]..#3D.pc;#0A..1W[regs+7]..#3D.count;#0A
..1W[regs+8]..#3D.mw;#0A#0A..1/*.Save.p.in.currco.r
esumption.point,.for.debugging.purposes..3*/#0A..1/
*.currco.must.always.be.set.to.the.coroutine.stack.
containing.p.*/#0A..1//W[Wg[Gn_currco]].#3D.p;#0A..
1#0A..1return.res;..//.Return.from.this.invocation.
of.interpret#0A}#0A#0A

######sysc/cinterp64.c#
/*#0A**.This.is.a.32.bit.CINTCODE.interpreter.writt
en.in.C#0A**#0A**.(c).Copyright:..Martin.Richards..
October.2010#0A**#0A**.Modified.5.Feb.2014#0A**#0A*
*.If.FASTyes.if.defined,.most.of.the.debugging.aids
.are#0A**.disabled.making.it.functionally.equivalen
t.to.the#0A**.handwritten.assembly.code.versions.pr
ovided.for.some#0A**.architectures#2E#0A**#0A**.The
.fast.version.defines.the.function.cintasm#0A**.whi
le.the.slow.version.defines.interpret#2E#0A#0A00009
/04/10#0APut.time.the.time.stamp.(days,.msecs).in.t
he.rootnode.every.1002.cintcode#0Ainstructions#2E#0A
*/#0A#0A#23ifndef.forSHwinCE#0A#23include.<stdio#2E
h>#0A#23include.<stdlib#2Eh>#0A#23endif#0A#0A/*.cin
tsys64#2Eh.contains.machine/system.dependent.#23def
ines..*/#0A#23include."cintsys64#2Eh"#0A#0A#23ifnde
f.FASTyes#0A#0A#23define.TRACINGyes#0A#23define.TAL
LYyes#0A#23define.WATCHyes#0A#23define.MEMCHKyes#0A
#23define.COUNTyes#0A#0A#23endif#0A#0A#23ifdef.MEMC
HKyes#0A#23define.MC1(a).if((unsigned.BCPLWORD)a>me
mupb){W[3]#3Da;.res#3D12;.pc--;..goto.ret;.}#0A#23d
efine.MC2(a).if((unsigned.BCPLWORD)a>memupb){W[3]#3D
a;.res#3D12;.pc-#3D2;.goto.ret;.}#0A#23define.MC3(a
).if((unsigned.BCPLWORD)a>memupb){W[3]#3Da;.res#3D1
2;.pc-#3D3;.goto.ret;.}#0A#23define.MC5(a).if((unsi
gned.BCPLWORD)a>memupb){W[3]#3Da;.res#3D12;.pc-#3D5
;.goto.ret;.}#0A#23else#0A#23define.MC1(n)#0A#23def
ine.MC2(n)#0A#23define.MC3(n)#0A#23define.MC5(n)#0A
#23endif#0A#0Aextern.BCPLWORD.result2;#0A#0Aextern.
BCPLWORD.*lastWp;..2/*.Latest.setting.of.Wp.*/#0Aex
tern.BCPLWORD.*lastWg;..2/*.Latest.setting.of.Wg.*/
#0A#0Aextern.int.tracing;#0Aextern.BCPLWORD.memupb;
#0A#0Aextern.BCPLWORD.*tallyv;#0Aextern.BCPLWORD.ta
llylim;#0A#0Aextern.BCPLWORD.dosys(BCPLWORD.p,.BCPL
WORD.g);#0Aextern.BCPLWORD.doflt(BCPLWORD.op,.BCPLW
ORD.a,.BCPLWORD.b);#0Aextern.BCPLWORD.muldiv(BCPLWO
RD.a,.BCPLWORD.b,.BCPLWORD.c);#0A#0Aextern.void.wrc
ode(char.*form,.BCPLWORD.f,.BCPLWORD.a);.#0Aextern.
void.wrfcode(BCPLWORD.f);#0Aextern.void.trace(BCPLW
ORD.pc,.BCPLWORD.p,.BCPLWORD.a,.BCPLWORD.b);#0Aexte
rn.BCPLWORD.timestamp(BCPLWORD.*datstamp);#0A#0A1#23
define.Gn_currco..0047#0A#23define.Gn_result2..0021
0#0A#0A/*.CINTCODE.function.codes..*/#0A#0A#23defin
e.F_0..0050#0A#0A#23define.F_fltop..0011#0A#23defin
e.F_brk..0032#0A#23define.F_k0..0040#0A#23define.F_
lf..00312#0A#23define.F_lm..00314#0A#23define.F_lm1
..00215#0A#23define.F_l0..00316#0A#23define.F_fhop.
.00127#0A#23define.F_jeq..00228#0A#0A#23define.F_k.
.00432#0A#23define.F_kh..00333#0A#23define.F_kw..00
334#0A#23define.F_k0g..00232#0A#23define.F_k0g1..1(
F_k0g+32)#0A#23define.F_k0gh..1(F_k0g+64)#0A#23defi
ne.F_s0g..00244#0A#23define.F_s0g1..1(F_s0g+32)#0A#23
define.F_s0gh..1(F_s0g+64)#0A#23define.F_l0g..00245
#0A#23define.F_l0g1..1(F_l0g+32)#0A#23define.F_l0gh
..1(F_l0g+64)#0A#23define.F_l1g..00246#0A#23define.
F_l1g1..1(F_l1g+32)#0A#23define.F_l1gh..1(F_l1g+64)
#0A#23define.F_l2g..00247#0A#23define.F_l2g1..1(F_l
2g+32)#0A#23define.F_l2gh..1(F_l2g+64)#0A#23define.
F_lg..00348#0A#23define.F_lg1..2(F_lg+32)#0A#23defi
ne.F_lgh..2(F_lg+64)#0A#23define.F_sg..00349#0A#23d
efine.F_sg1..2(F_sg+32)#0A#23define.F_sgh..2(F_sg+6
4)#0A#23define.F_llg..00250#0A#23define.F_llg1..1(F
_llg+32)#0A#23define.F_llgh..1(F_llg+64)#0A#23defin
e.F_ag..00351#0A#23define.F_ag1..2(F_ag+32)#0A#23de
fine.F_agh..2(F_ag+64)#0A#23define.F_mul..00252#0A#23
define.F_div..00253#0A#23define.F_rem..00254#0A#23d
efine.F_xor..00255#0A#23define.F_sl..00356#0A#23def
ine.F_ll..00358#0A#23define.F_jne..00260#0A#0A#23de
fine.F_llp..00264#0A#23define.F_llph..00165#0A#23de
fine.F_llpw..00166#0A#23define.F_add..00284#0A#23de
fine.F_sub..00285#0A#23define.F_lsh..00286#0A#23def
ine.F_rsh..00287#0A#23define.F_and..00288#0A#23defi
ne.F_or..00389#0A#23define.F_ll1..00290#0A#23define
.F_jls..00292#0A#0A#23define.F_l..00496#0A#23define
.F_lh..00397#0A#23define.F_lw..00398#0A#23define.F_
rv..002110006#0A#23define.F_rtn..001123#0A#23define
.F_jgr..001124#0A#0A#23define.F_lp..002128#0A#23def
ine.F_lph..001129#0A#23define.F_lpw..001130#0A#23de
fine.F_lp0..001128#0A#23define.F_sys..001145#0A#23d
efine.F_swb..001146#0A#23define.F_swl..001147#0A#23
define.F_st..002148#0A#23define.F_st0..001148#0A#23
define.F_stp0..000149#0A#23define.F_goto..000155#0A
#23define.F_jle..001156#0A#0A#23define.F_sp..002160
#0A#23define.F_sph..001161#0A#23define.F_spw..00116
2#0A#23define.F_sp0..001160#0A#23define.F_s0..00217
6#0A#23define.F_xch..001181#0A#23define.F_gbyt..000
182#0A#23define.F_pbyt..000183#0A#23define.F_atc..0
01184#0A#23define.F_atb..001185#0A#23define.F_j..00
3186#0A#23define.F_jge..001188#0A#0A#23define.F_ap.
.002192#0A#23define.F_aph..001193#0A#23define.F_apw
..001194#0A#23define.F_ap0..001192#0A#0A#23define.F
_xpbyt.205#0A#23define.F_lmh..001206#0A#23define.F_
btc..001207#0A#23define.F_nop..001208#0A#23define.F
_a0..002208#0A#23define.F_rvp0..000211#0A#23define.
F_st0p0.216#0A#23define.F_st1p0.218#0A#0A#23define.
F_mw..002220003#0A#0A#23define.F_a..003220004#0A#23
define.F_ah..002220005#0A#23define.F_aw..002220006#0A
#23define.F_l0p0..000220004#0A#23define.F_s..003237
#0A#23define.F_sh..002238#0A#0A#23define.F_mdiv..00
0239#0A#23define.F_chgco.240#0A#23define.F_neg..001
241#0A#23define.F_not..001242#0A#23define.F_l1p0..0
00240#0A#23define.F_l2p0..000244#0A#23define.F_l3p0
..000247.#0A#23define.F_l4p0..000249#0A#0A#23define
.F_selld.254#0A#23define.F_selst.255#0A#23define.F_
255..001255#0A#0A#23define.sf_none..0020..3//.Assig
nment.operators#0A#23define.sf_vecap..0011#0A#23def
ine.sf_fmult..0012#0A#23define.sf_fdiv..0023#0A#23d
efine.sf_fplus..0014#0A#23define.sf_fminus..0005#0A
#23define.sf_mult..0026#0A#23define.sf_div..0037#0A
#23define.sf_rem..0038#0A#23define.sf_plus..0029#0A
#23define.sf_minus..00010#0A#23define.sf_lshift.11#0A
#23define.sf_rshift.12#0A#23define.sf_logand.13#0A#23
define.sf_logor..00014#0A#23define.sf_eqv..00215#0A
#23define.sf_neqv..00116#0A#0A/*.The.function.inter
pret.is.designed.to.be.separately.compiled,#0A//.an
d.possibly.implemented.in.assembly.language#2E#0A//
#0A//.Unless.either.TRACINGyes.or.TALLYyes.are.defi
ned,.its.only.free#0A//.variable.is.the.function.do
sys(p,.g)#2E#0A//#0A//.mem..is.the.pointer.to.the.c
intcode.memory#2E#0A//.regs.is.the.position.in.the.
Cintcode.memory.where.the.initial#0A//..4value.of.t
he.Cintcode.registers#2E#0A//#0A//.interpret.execut
es.Cintcode.instructions.and.returns.with.an#0A//.i
nteger.result.as.follows:#0A#0A//..2-2..4sys(Sys_du
mpmem).cause.a.memory.dump.to.DUMP#2Emem#0A//..2-1.
*..2sys(Sys_setcount,.val).called#0A//..0030.*..2sy
s(Sys_quit,.0).called#0A//..0031..4Non.existant.ins
truction#0A//..0032..4Brk.instruction#0A//..0033..4
Zero.count#0A//..0034..4Negative.pc#0A//..0035..4Di
vision.by.zero#0A//..00210..4Cintasm.single.step.tr
ap#0A//..00211..4Contents.of.watch.address.has.chan
ged#0A//..00212..4Memory.address.too.large.or.negat
ive#0A//..00213..4SIGINT.received#0A//..00214..4Unk
nown.floating.point.operation#0A//..00215#0A//..002
16..4P.pointer.too.large.or.negative#0A**..3n..4sys
(Sys_quit,.n).called#0A**#0A**.On.return.the.Cintco
de.registers.are.dumped.back.in.the.vector.regs#0A*
/#0A#0A#23ifdef.FASTyes#0Aextern.BCPLWORD.*watchadd
r,.watchval;#0A#23else#0ABCPLWORD.*watchaddr#3D0,.w
atchval#3D0;#0A#23endif#0A#0A#23define.B.(BP.W)#0A#23
define.SB.(SBP.W)#0A#23define.H.(HP.W)#0A#23define.
SH.(SHP.W)#0A#0A#23ifdef.BIGENDER#0A#23define.GH(x)
.((WD.B[x+0]<<0008).|.B[x+1])#0A#23define.GW(x).(BC
PLINT32)((4WD.B[x]<<0008)|B[x+1])<<0008)|B[x+2])<<0
008)|B[x+3])#0A#23else#0A#23define.GH(x).((WD.B[x+1
]<<0008).|.B[x])#0A#23define.GW(x).(BCPLINT32)((4WD
.B[x+3]<<0008)|B[x+2])<<0008)|B[x+1])<<0008)|B[x])#0A
#23endif#0A#0A#23ifndef.NOFLOAT#0A#0Astatic.float.i
tof(BCPLWORD.a).{#0A..union.{.BCPLWORD.i;.float.f;.
}.x;#0A..x#2Ei.#3D.a;#0A..return.x#2Ef;#0A}#0A#0A#23
endif#0A#0A#23ifdef.FASTyes#0Aint.cintasm(BCPLWORD.
regs,.BCPLWORDpt.mem)#0A{.//printf("cintasm:.entere
d.regs#3D%lld\n",.regs);#0A#23else#0Aint.interpret(
BCPLWORD.regs,.BCPLWORDpt.mem)#0A{.//printf("interp
ret:.entered.regs#3D%lld\n",.regs);#0A#23endif#0A{.
.BCPLWORDpt.W.#3D.mem;#0A#0A..1register.int.icount.
#3D.0;#0A#0A..1register.BCPLWORD..9a..#3D.W[regs+0]
;#0A..1register.BCPLWORD..9b..#3D.W[regs+1];#0A..1B
CPLWORD..18c..#3D.W[regs+2];#0A..1BCPLWORD..18p..#3D
.W[regs+3]>>B2Wsh;#0A..1BCPLWORD..18g..#3D.W[regs+4
]>>B2Wsh;#0A..1BCPLWORD..18st.#3D.W[regs+5];#0A..1r
egister.BCPLWORD..9pc.#3D.W[regs+6];#0A..1BCPLWORD.
.18count.#3D.W[regs+7];#0A..1BCPLWORD..18mw.#3D.W[r
egs+8];#0A#0A..1register.BCPLWORDpt.Wp..#3D.W+p,..2
/*.Optimise.access.to.the.stack.*/#0A..21Wg..#3D.W+
g,..2/*.Optimise.access.to.the.global.vector.*/#0A.
.21Wg1.#3D.W+g+256;#0A#0A..1BCPLWORD.res,.k,.i;#0A#0A
..1UBCPLWORD.memupbb.#3D.memupb<<B2Wsh;#0A..1UBCPLW
ORD.tallylimb.#3D.tallylim<<B2Wsh;#0A#0A..1//printf
("cintasm.or.interpret:.entered\n");#0A..1/*..1trac
ing.#3D.1;.*/#0A#0A.fetchchk:#0A..1//.Check.pc.is.i
n.range#0A..1if.((UBCPLWORD)pc.>.memupbb).goto.badp
c;#0A#0Afetch:#0A#0A#23ifdef.WATCHyes#0A..1/*.Speci
al.watch.debugging.aid.*/#0A..1if(watchaddr.&&.*wat
chaddr!#3Dwatchval)#0A..1{./*#0A..5printf("%7".Form
D.":.changed.from.%7".FormD."(%8".FormX.").to.%7".F
ormD#0A..12"(%8".FormX.")\n",#0A..12watchaddr-W,.wa
tchval,.(UBCPLWORD)watchval,#0A..12*watchaddr,.(UBC
PLWORD)*watchaddr);#0A..3*/#0A..3watchval.#3D.*watc
haddr;#0A..3W[1].#3D.watchaddr-W;#0A..3W[2].#3D.wat
chval;#0A..3res.#3D.11;..6/*.Contents.of.watch.addr
ess.has.changed.*/#0A..3goto.ret;#0A..1}#0A..1/*.En
d.of.watch.code.*/#0A#23endif#0A#0A..1/*.count>#3D0
..means.execute.count.instructions.(slow.interprete
r)#0A..4count#3D-1..means.go.on.for.ever.(fast.inte
rpreter)#0A..4count#3D-2..means.single.step.the.fas
t.interpreter#0A..1*/#0A#23ifdef.COUNTyes#0A..1if.(
count>#3D0)#0A..1{.if.(count#3D#3D0000).{.res.#3D.3
;.goto.ret;.}#0A..3count--;#0A..1}#0A#23endif#0A#0A
#23ifdef.TRACINGyes#0A..1if.(tracing).trace(pc,.p,.
a,.b);#0A#23endif#0A#0A#23ifdef.TALLYyes#0A..1if.((
UBCPLWORD)pc.<.tallylimb).tallyv[pc]++;#0A#23endif#0A
#0Aif(--icount<#3D0).{#0A..//.Update.the.days.and.m
secs.fields.in.the.rootnode#0A..timestamp(&W[rootno
de+Rtn_days]);#0A..icount.#3D.1002;#0A..//.icount..
3bench100.time.under.64-bit.Cintcode.using.gcc.-O4#0A
..//..0011..004955#2E090#0A..//..00110..003106#2E20
0#0A..//..001100..00318#2E760#0A..//..0011001..0039
#2E980#0A..//..0011002..0029#2E050#0A..//..0011003.
.0019#2E020#0A..//..0108#2E790.with.this.code.omitt
ed.(gcc.-O1)#0A..//trpush(0x11000004+W[rootnode+Rtn
_msecs]);#0A}#0A#0Aswitch(B[pc++])#0A{..default:#0A
..1case.F_0:..3/*.Cases.F_0.and.F_255.have.been.add
ed.explicitly.to..1*/#0A..3//case.F_255:..1/*.impro
ve.the.compiled.code.(with.luck)..13*/#0A..15res.#3D
.1;.pc--;.goto.ret;./*.Unimplemented.instruction..*
/#0A#0A..3//.Added.21/7/10#0A..1case.F_fltop:#0A..3
{.BCPLWORD.op.#3D.B[pc++];#0A#0A#23ifdef.NOFLOAT#0A
..5a.#3D.0;#0A..5goto.fetch;#0A#23else#0A..5//print
f("fltop.op#3D%".FormD."\n",.op);#0A..5switch.(op).
{#0A..5default:#0A..7res.#3D.14;.pc.-#3D2;.goto.ret
;#0A#0A..5case.fl_avail:#0A..7a.#3D.-1;.goto.fetch;
#0A#0A..5case.fl_mk:#0A..5{.BCPLWORD.exponent.#3D.B
[pc++];.//.Signed.byte#0A..7if.(exponent>#3D128).ex
ponent.#3D.exponent-256;#0A#09.//printf("fl_mk.call
ing.doflt(%".FormD.",.%".FormD.",.%".FormD.")\n",#0A
..7//..6op,.a,.exponent);#0A..7a.#3D.doflt(op,.a,.e
xponent);#0A..7goto.fetch;#0A..5}#0A#0A..5case.fl_f
loat:#0A..5case.fl_fix:#0A..5case.fl_pos:#0A..5case
.fl_neg:#0A..5case.fl_abs:#0A..7a.#3D.doflt(op,.a,.
0);#0A..7goto.fetch;#0A#0A..5case.fl_mult:#0A..5cas
e.fl_div:#0A..5case.fl_plus:#0A..5case.fl_minus:#0A
..5case.fl_eq:#0A..5case.fl_ne:#0A..5case.fl_ls:#0A
..5case.fl_gr:#0A..5case.fl_le:#0A..5case.fl_ge:#0A
..7a.#3D.doflt(op,.b,.a);#0A..7goto.fetch;#0A..5}#0A
#23endif#0A..3}#0A#0A..3//.Added.21/7/10#0A..1case.
F_selld:..//.load.a.field..SELLD.len.sh#0A..3{.BCPL
WORD.len.#3D.B[pc++];#0A..5BCPLWORD.sh..#3D.B[pc++]
;#0A..5BCPLWORD.mask.#3D.-1;#0A..5if.(len).mask.#3D
.(1<<len).-.1;#0A..5a.#3D.(W[a]>>sh).&.mask;#0A..5g
oto.fetch;#0A..3}#0A#0A..3//.Added.21/7/10#0A..1cas
e.F_selst:.//.SLCT.len:sh:0.OF.<arg1>.op:#3D.<arg2>
#0A..15//..4len.sh..7a..1op..4b#0A..3{.BCPLWORD.*pt
r.#3D.&W[a];#0A..5BCPLWORD.op..#3D.B[pc++];#0A..5BC
PLWORD.len.#3D.B[pc++];#0A..5BCPLWORD.sh..#3D.B[pc+
+];#0A..5BCPLWORD.mask;#0A..5BCPLWORD.val;#0A..5BCP
LWORD.oldval;#0A..5union.IorF.{.BCPLWORD.i;.float.f
;.}.x,.y;#0A#0A..5if(len#3D#3D0000).{#0A..7mask.#3D
.UWD(-1).>>.sh;#0A..5}.else.{#0A..7mask.#3D.(1<<len
).-.1;#0A..5}#0A..5val.#3D.WD((1UWD*ptr)>>sh)).&.ma
sk;#0A..5oldval.#3D.val;.//.Old.value.shifted.down#0A
#0A..5//.val.and.oldval.are.both.the.old.field.valu
e.shifted.down#0A..5switch(op).{#0A..5default:..8a.
#3D.0;.goto.fetch;#0A..5case.sf_none:..3val.#3D.b;.
.15break;#0A..5case.sf_vecap:..2val.#3D.W[val.+.b];
..6break;#0A..5case.sf_fmult:..2x#2Ei.#3D.val;.y#2E
i.#3D.b;#0A..23x#2Ef.#3D.x#2Ef.*.y#2Ef;#0A..23val.#3D
.x#2Ei;..13break;#0A..5case.sf_fdiv:..3x#2Ei.#3D.va
l;.y#2Ei.#3D.b;#0A..23x#2Ef.#3D.x#2Ef./.y#2Ef;#0A..
23val.#3D.x#2Ei;..13break;#0A..5case.sf_fplus:..2x#2E
i.#3D.val;.y#2Ei.#3D.b;#0A..23x#2Ef.#3D.x#2Ef.+.y#2E
f;#0A..23val.#3D.x#2Ei;..13break;#0A..5case.sf_fmin
us:..1x#2Ei.#3D.val;.y#2Ei.#3D.b;#0A..23x#2Ef.#3D.x
#2Ef.-.y#2Ef;#0A..23val.#3D.x#2Ei;..13break;#0A..5c
ase.sf_mult:..3val.*#3D.b;..14break;#0A..5case.sf_d
iv:..4val./#3D.b;..14break;#0A..5case.sf_rem:..4val
.%#3D.b;..14break;#0A..5case.sf_plus:..3val.+#3D.b;
..14break;#0A..5case.sf_minus:..2val.-#3D.b;..14bre
ak;#0A..5case.sf_lshift:..1if.(b>#3DBperW).val#3D0;
./*.bug.*/#0A..23val.<<#3D.b;..13break;#0A..5case.s
f_rshift:..1if.(b>#3DBperW).val#3D0;./*.bug.*/#0A#09
..15val.#3D.WD((UWD.val)>>b);..break;#0A..5case.sf_
logand:..1val.&#3D.b;..14break;#0A..5case.sf_logor:
..2val.|#3D.b;..14break;#0A..5case.sf_eqv:..4val.#3D
.~(val.^.b);..6break;#0A..5case.sf_neqv:..3val.^#3D
.b;..14break;#0A..5}#0A..5//printf("selst:.op#3D%".
FormD.".len#3D%".FormD.".sh#3D%".FormD#0A..14".oldv
al#3D%08".FormX.".val#3D%08".FormX.".mask#3D%08".Fo
rmX."\n",#0A..5//..5op,.len,.sh,.(UBCPLWORD)oldval,
.(UBCPLWORD)val,.(UBCPLWORD)mask);#0A..5//.Replace.
field.by.new.value#0A..5*ptr.^#3D.((val.^.oldval)&m
ask).<<.sh;#0A..5goto.fetch;#0A..3}#0A#0A..1case.F_
mul:..1a.#3D.b.*.a;..6goto.fetch;#0A..1case.F_div:.
.1if(a#3D#3D0000).{res.#3D.5;.pc--;.goto.ret;.}./*.
Division.by.zero.*/#0A..15a.#3D.b./.a;..6goto.fetch
;#0A..1case.F_rem:..1if(a#3D#3D0000).{res.#3D.5;.pc
--;.goto.ret;.}./*.Division.by.zero.*/#0A..15a.#3D.
b.%.a;..6goto.fetch;#0A..1case.F_add:..1a.#3D.b.+.a
;..6goto.fetch;#0A..1case.F_sub:..1a.#3D.b.-.a;..6g
oto.fetch;#0A..1case.F_neg:..1a.#3D.-.a;..8goto.fet
ch;#0A#0A..1case.F_fhop:..a.#3D.0;.pc++;..4goto.fet
ch;#0A#0A..1case.F_lsh:..1if.(a>#3DBperW).b#3D0;./*
.bug.*/#0A..15a.#3D.b.<<.a;..5goto.fetch;#0A..1case
.F_rsh:..1if.(a>#3DBperW).b#3D0;./*.bug.*/#0A..15a.
#3D.WD((UWD.b)>>a);.goto.fetch;#0A..1case.F_not:..1
a.#3D.~.a;..8goto.fetch;#0A..1case.F_and:..1a.#3D.b
.&.a;..6goto.fetch;#0A..1case.F_or:..2a.#3D.b.|.a;.
.6goto.fetch;#0A..1case.F_xor:..1a.#3D.b.^.a;..6got
o.fetch;#0A#0A..1case.F_goto:..pc.#3D.a;..9goto.fet
ch;#0A#0A..1case.F_brk:..1res.#3D.2;.pc--;.goto.ret
;../*.BREAKPOINT..*/#0A..15#0A..1case.F_rv+6:..a.#3D
.W[a+6];.goto.fetch;#0A..1case.F_rv+5:..a.#3D.W[a+5
];.goto.fetch;#0A..1case.F_rv+4:..a.#3D.W[a+4];.got
o.fetch;#0A..1case.F_rv+3:..a.#3D.W[a+3];.goto.fetc
h;#0A..1case.F_rv+2:..a.#3D.W[a+2];.goto.fetch;#0A.
.1case.F_rv+1:..a.#3D.W[a+1];.goto.fetch;#0A..1case
.F_rv:..2a.#3D.W[a+0];.goto.fetch;#0A#0A..1case.F_s
t+3:..W[a+3].#3D.b;.goto.fetch;#0A..1case.F_st+2:..
W[a+2].#3D.b;.goto.fetch;#0A..1case.F_st+1:..W[a+1]
.#3D.b;.goto.fetch;#0A..1case.F_st:..2W[a+0].#3D.b;
.goto.fetch;#0A#0A..1case.F_chgco:.W[Wg[Gn_currco]]
.#3D.Wp[0];./*.!currco.:#3D.!p..2*/#0A..15pc.#3D.Wp
[1];..13/*.pc..4:#3D.p!1..1*/#0A..15Wg[Gn_currco].#3D
.Wp[4];..2/*.currco..:#3D.cptr..*/#0A..15p.#3D.W[Wp
[4]]>>B2Wsh;..4/*.p..5:#3D.!cptr.*/#0A..15Wp.#3D.W+
p;#0A..15goto.fetchchk;#0A#0A..1case.F_mdiv:..a.#3D
.muldiv(Wp[3],.Wp[4],.Wp[5]);#0A..15Wg[Gn_result2].
#3D.result2;#0A..15/*.fall.through.to.return..*/#0A
#0A..1case.F_rtn:..1pc.#3D.Wp[1];#0A..15p..#3D.W[p]
>>B2Wsh;#0A..15Wp.#3D.W+p;.#0A..15goto.fetchchk;#0A
#0A..1case.F_gbyt:.a.#3D.B[a+(b<<B2Wsh)];#0A..14got
o.fetch;#0A..1case.F_pbyt:.B[a+(b<<B2Wsh)].#3D.(cha
r)c;..goto.fetch;#0A..1case.F_xpbyt:B[b+(a<<B2Wsh)]
.#3D.(char)c;..goto.fetch;#0A..1case.F_atc:..c.#3D.
a;..20goto.fetch;#0A..1case.F_btc:..c.#3D.b;..20got
o.fetch;#0A..1case.F_atb:..b.#3D.a;..20goto.fetch;#0A
..1case.F_xch:..a.#3D.a^b;.b.#3D.a^b;.a.#3D.a^b;..g
oto.fetch;#0A#0A..1case.F_swb:.{.BCPLWORD.n,.k,.val
,.i#3D1;#0A..15k.#3D.(pc+1)>>0001;#0A..15n.#3D.H[k]
;#0A..15while(i<#3Dn)#0A..15{.i.+#3D.i;#0A..17val.#3D
.H[k+i];#0A..17if.(a#3D#3Dval).{.k.+#3D.i;.break;.}
#0A..17if.(a<val).i++;#0A..15}#0A..15k++;#0A..15pc.
#3D.(k<<0001).+.SH[k];#0A..15goto.fetch;#0A..13}#0A
#0A..1case.F_swl:.{.BCPLWORD.n,q;#0A..15q.#3D.(pc+1
)>>0001;#0A..15n.#3D.H[q++];#0A..15if(0<#3Da.&&.a<n
).q.+#3D.a.+.1;#0A..15pc.#3D.(q<<0001).+.SH[q];#0A.
.15goto.fetch;#0A..13}#0A#0A..1case.F_sys:.switch(a
).{#0A..15default:.//.system.call.--.general.case#0A
.#0A#09#09..7W[regs+0]..#3D.a;..2/*.Save.all.the.re
gisters.*/#0A#09#09..7W[regs+1]..#3D.b;..2/*.for.de
bugging.purposes.*/#0A..23W[regs+2]..#3D.c;#0A..23W
[regs+3]..#3D.p<<B2Wsh;#0A..23W[regs+4]..#3D.g<<B2W
sh;#0A..23W[regs+5]..#3D.st;#0A..23W[regs+6]..#3D.p
c;#0A..23W[regs+7]..#3D.count;#0A..23W[regs+8]..#3D
.mw;#0A..#0A..23a.#3D.dosys(p,.g);.#0A..23goto.fetc
h;#0A#0A..15case.Sys_setcount:#0A..23/*.oldcount.:#3D
.sys(Sys_setcount,.newcount)..*/#0A..23a.#3D.count;
.#0A#09#09..7count.#3D.Wp[4];#0A..23res.#3D.-1;./*.
Leave.and.immediately.re-enter.*/#0A..23goto.ret;./
*.the.interpreter.*/#0A#0A..15case.Sys_quit:#0A..23
res.#3D.Wp[4];#0A..23goto.ret;#0A#0A#09..4/*#0A..15
case.Sys_rti:..//..sys(Sys_rti,.regs)#0A..15case.Sy
s_saveregs:.//.sys(Sys_saveregs,.regs)#0A..15case.S
ys_setst:.//.sys(Sys_setst,.st)#0A..12*/#0A#09#09.c
ase.Sys_watch:../*.sys(Sys_watch,.addr).*/#0A..21{.
watchaddr.#3D.&W[Wp[4]];#0A#09..15watchval.#3D.*wat
chaddr;#0A..23goto.fetch;#0A..21}#0A..13}#0A#0A..1c
ase.F_lp0+16:..b.#3D.a;.a.#3D.Wp[16];.goto.fetch;#0A
..1case.F_lp0+15:..b.#3D.a;.a.#3D.Wp[15];.goto.fetc
h;#0A..1case.F_lp0+14:..b.#3D.a;.a.#3D.Wp[14];.goto
.fetch;#0A..1case.F_lp0+13:..b.#3D.a;.a.#3D.Wp[13];
.goto.fetch;#0A..1case.F_lp0+12:..b.#3D.a;.a.#3D.Wp
[12];.goto.fetch;#0A..1case.F_lp0+11:..b.#3D.a;.a.#3D
.Wp[11];.goto.fetch;#0A..1case.F_lp0+10:..b.#3D.a;.
a.#3D.Wp[10];.goto.fetch;#0A..1case.F_lp0+9:..1b.#3D
.a;.a.#3D.Wp[9];..goto.fetch;#0A..1case.F_lp0+8:..1
b.#3D.a;.a.#3D.Wp[8];..goto.fetch;#0A..1case.F_lp0+
7:..1b.#3D.a;.a.#3D.Wp[7];..goto.fetch;#0A..1case.F
_lp0+6:..1b.#3D.a;.a.#3D.Wp[6];..goto.fetch;#0A..1c
ase.F_lp0+5:..1b.#3D.a;.a.#3D.Wp[5];..goto.fetch;#0A
..1case.F_lp0+4:..1b.#3D.a;.a.#3D.Wp[4];..goto.fetc
h;#0A..1case.F_lp0+3:..1b.#3D.a;.a.#3D.Wp[3];..goto
.fetch;#0A#0A..1case.F_lp:..1b.#3D.a;.a.#3D.Wp[B[pc
++]];..8goto.fetch;#0A..1case.F_lph:..b.#3D.a;.a.#3D
.Wp[GH(pc)];..pc.+#3D.2;.goto.fetch;#0A..1case.F_lp
w:..b.#3D.a;#0A..14a.#3D.Wp[mw+GW(pc)];.mw.#3D.0;#0A
..14pc.+#3D.4;.goto.fetch;#0A#0A..1case.F_llp:..b.#3D
.a;.a.#3D.p+B[pc++];..11goto.fetch;#0A..1case.F_llp
h:.b.#3D.a;.a.#3D.p+GH(pc);..3pc.+#3D.2;.goto.fetch
;#0A..1case.F_llpw:.b.#3D.a;#0A..14a.#3D.p+GW(mw+pc
);.mw.#3D.0;#0A..14pc.+#3D.4;.goto.fetch;#0A#0A..1c
ase.F_sp0+16:.Wp[16].#3D.a;.goto.fetch;#0A..1case.F
_sp0+15:.Wp[15].#3D.a;.goto.fetch;#0A..1case.F_sp0+
14:.Wp[14].#3D.a;.goto.fetch;#0A..1case.F_sp0+13:.W
p[13].#3D.a;.goto.fetch;#0A..1case.F_sp0+12:.Wp[12]
.#3D.a;.goto.fetch;#0A..1case.F_sp0+11:.Wp[11].#3D.
a;.goto.fetch;#0A..1case.F_sp0+10:.Wp[10].#3D.a;.go
to.fetch;#0A..1case.F_sp0+9:..Wp[9]..#3D.a;.goto.fe
tch;#0A..1case.F_sp0+8:..Wp[8]..#3D.a;.goto.fetch;#0A
..1case.F_sp0+7:..Wp[7]..#3D.a;.goto.fetch;#0A..1ca
se.F_sp0+6:..Wp[6]..#3D.a;.goto.fetch;#0A..1case.F_
sp0+5:..Wp[5]..#3D.a;.goto.fetch;#0A..1case.F_sp0+4
:..Wp[4]..#3D.a;.goto.fetch;#0A..1case.F_sp0+3:..Wp
[3]..#3D.a;.goto.fetch;#0A#0A..1case.F_sp:..2Wp[B[p
c++]].#3D.a;..16goto.fetch;#0A..1case.F_sph:..1Wp[G
H(pc)]..#3D.a;..7pc.+#3D.2;.goto.fetch;#0A..1case.F
_spw:..1Wp[mw+GW(pc)]..#3D.a;.mw.#3D.0;#0A..15pc.+#3D
.4;.goto.fetch;#0A#0A..1case.F_lgh:..1b.#3D.a;.a.#3D
.Wg[GH(pc)];..1pc.+#3D.2;.goto.fetch;#0A..1case.F_l
g1:..1b.#3D.a;.a.#3D.Wg1[B[pc++]];..8goto.fetch;#0A
..1case.F_lg:..2b.#3D.a;.a.#3D.Wg[B[pc++]];..9goto.
fetch;#0A#0A..1case.F_sgh:..1Wg[GH(pc)]..1#3D.a;..6
pc.+#3D.2;.goto.fetch;#0A..1case.F_sg1:..1Wg1[B[pc+
+]].#3D.a;..15goto.fetch;#0A..1case.F_sg:..2Wg[B[pc
++]]..#3D.a;..15goto.fetch;#0A#0A..1case.F_llgh:.b.
#3D.a;.a.#3D.g+GH(pc);..4pc.+#3D.2;.goto.fetch;#0A.
.1case.F_llg1:.b.#3D.a;.a.#3D.g+256+B[pc++];..8goto
.fetch;#0A..1case.F_llg:..b.#3D.a;.a.#3D.g+B[pc++];
..12goto.fetch;#0A#0A..1case.F_ll+1:.i.#3D.(pc>>000
1).+.B[pc];#0A..14i.#3D.(i<<0001).+.SH[i];#0A..14b.
#3D.a;.a.#3D.W[i>>B2Wsh];..8pc++;.goto.fetch;#0A#0A
..1case.F_ll:..1b.#3D.a;.a.#3D.W[(pc+SB[pc])>>B2Wsh
];pc++;.goto.fetch;#0A#0A..1case.F_sl+1:.i.#3D.(pc>
>0001).+.B[pc];#0A..14i.#3D.(i<<0001).+.SH[i];#0A..
14W[i>>B2Wsh].#3D.a;..15pc++;.goto.fetch;#0A#0A..1c
ase.F_sl:..1W[(pc+SB[pc])>>B2Wsh].#3D.a;..5pc++;.go
to.fetch;#0A..1#0A..1case.F_ll1+1:i.#3D.(pc>>0001).
+.B[pc];#0A..14i.#3D.(i<<0001).+.SH[i];#0A..14b.#3D
.a;.a.#3D.i>>B2Wsh;..11pc++;.goto.fetch;#0A#0A..1ca
se.F_ll1:..b.#3D.a;.a.#3D.(pc+SB[pc])>>B2Wsh;..1pc+
+;.goto.fetch;#0A..1#0A..1case.F_l0+10:.b.#3D.a;.a.
#3D.10;.goto.fetch;#0A..1case.F_l0+9:..b.#3D.a;.a.#3D
..0009;.goto.fetch;#0A..1case.F_l0+8:..b.#3D.a;.a.#3D
..0008;.goto.fetch;#0A..1case.F_l0+7:..b.#3D.a;.a.#3D
..0007;.goto.fetch;#0A..1case.F_l0+6:..b.#3D.a;.a.#3D
..0006;.goto.fetch;#0A..1case.F_l0+5:..b.#3D.a;.a.#3D
..0005;.goto.fetch;#0A..1case.F_l0+4:..b.#3D.a;.a.#3D
..0004;.goto.fetch;#0A..1case.F_l0+3:..b.#3D.a;.a.#3D
..0003;.goto.fetch;#0A..1case.F_l0+2:..b.#3D.a;.a.#3D
..0002;.goto.fetch;#0A..1case.F_l0+1:..b.#3D.a;.a.#3D
..0001;.goto.fetch;#0A..1case.F_l0:..2b.#3D.a;.a.#3D
..0000;.goto.fetch;#0A..1case.F_l0-1:..b.#3D.a;.a.#3D
.-1;.goto.fetch;.#0A#0A..1case.F_l:..3b.#3D.a;.a.#3D
.B[pc++];..13goto.fetch;#0A..1case.F_lh:..2b.#3D.a;
.a.#3D.GH(pc);..5pc.+#3D.2;.goto.fetch;#0A..1case.F
_lw:..2b.#3D.a;.a.#3D.mw+GW(pc);.mw.#3D.0;#0A..15pc
.+#3D.4;.goto.fetch;#0A#0A..1case.F_lm:..2b.#3D.a;.
a.#3D.-.WD(B[pc++]);..7goto.fetch;#0A..1case.F_lmh:
..1b.#3D.a;.a.#3D.-.WD(GH(pc));.pc.+#3D.2;.goto.fet
ch;#0A..14#0A..1case.F_lf+1:..b.#3D.a;#0A..15a.#3D.
(pc>>0001).+.B[pc];#0A..15a.#3D.(a<<0001).+.SH[a];.
.7pc++;.goto.fetch;#0A#0A..1case.F_lf:..2b.#3D.a;.a
.#3D.pc.+.SB[pc];..3pc++;.goto.fetch;#0A.#0A..1case
.F_k0gh+11:.Wp[11].#3D.p<<B2Wsh;.p.+#3D.11;.goto.ap
plygh;#0A..1case.F_k0gh+10:.Wp[10].#3D.p<<B2Wsh;.p.
+#3D.10;.goto.applygh;#0A..1case.F_k0gh+9:..Wp[.9].
#3D.p<<B2Wsh;.p.+#3D..0009;.goto.applygh;#0A..1case
.F_k0gh+8:..Wp[.8].#3D.p<<B2Wsh;.p.+#3D..0008;.goto
.applygh;#0A..1case.F_k0gh+7:..Wp[.7].#3D.p<<B2Wsh;
.p.+#3D..0007;.goto.applygh;#0A..1case.F_k0gh+6:..W
p[.6].#3D.p<<B2Wsh;.p.+#3D..0006;.goto.applygh;#0A.
.1case.F_k0gh+5:..Wp[.5].#3D.p<<B2Wsh;.p.+#3D..0005
;.goto.applygh;#0A..1case.F_k0gh+4:..Wp[.4].#3D.p<<
B2Wsh;.p.+#3D..0004;.goto.applygh;#0A..1case.F_k0gh
+3:..Wp[.3].#3D.p<<B2Wsh;.p.+#3D..0003;#0A..1applyg
h:..6Wp..2#3D.W+p;#0A..17Wp[1].#3D.pc.+.2;#0A..17pc
..2#3D.Wg[GH(pc)];#0A..17Wp[2].#3D.pc;#0A..17Wp[3].
#3D..a;#0A..17goto.fetchchk;#0A#0A..1case.F_k0g1+11
:.Wp[11].#3D.p<<B2Wsh;.p.+#3D.11;.goto.applyg1;#0A.
.1case.F_k0g1+10:.Wp[10].#3D.p<<B2Wsh;.p.+#3D.10;.g
oto.applyg1;#0A..1case.F_k0g1+9:..Wp[.9].#3D.p<<B2W
sh;.p.+#3D..0009;.goto.applyg1;#0A..1case.F_k0g1+8:
..Wp[.8].#3D.p<<B2Wsh;.p.+#3D..0008;.goto.applyg1;#0A
..1case.F_k0g1+7:..Wp[.7].#3D.p<<B2Wsh;.p.+#3D..000
7;.goto.applyg1;#0A..1case.F_k0g1+6:..Wp[.6].#3D.p<
<B2Wsh;.p.+#3D..0006;.goto.applyg1;#0A..1case.F_k0g
1+5:..Wp[.5].#3D.p<<B2Wsh;.p.+#3D..0005;.goto.apply
g1;#0A..1case.F_k0g1+4:..Wp[.4].#3D.p<<B2Wsh;.p.+#3D
..0004;.goto.applyg1;#0A..1case.F_k0g1+3:..Wp[.3].#3D
.p<<B2Wsh;.p.+#3D..0003;#0A..1applyg1:..6Wp..2#3D.W
+p;#0A..17Wp[1].#3D.pc.+.1;#0A..17pc..2#3D.Wg1[B[pc
]];#0A..17Wp[2].#3D.pc;#0A..17Wp[3].#3D.a;#0A..17go
to.fetchchk;#0A.#0A..1case.F_k0g+11:.Wp[11].#3D.p<<
B2Wsh;.p.+#3D.11;.goto.applyg;#0A..1case.F_k0g+10:.
Wp[10].#3D.p<<B2Wsh;.p.+#3D.10;.goto.applyg;#0A..1c
ase.F_k0g+9:..Wp[.9].#3D.p<<B2Wsh;.p.+#3D..0009;.go
to.applyg;#0A..1case.F_k0g+8:..Wp[.8].#3D.p<<B2Wsh;
.p.+#3D..0008;.goto.applyg;#0A..1case.F_k0g+7:..Wp[
.7].#3D.p<<B2Wsh;.p.+#3D..0007;.goto.applyg;#0A..1c
ase.F_k0g+6:..Wp[.6].#3D.p<<B2Wsh;.p.+#3D..0006;.go
to.applyg;#0A..1case.F_k0g+5:..Wp[.5].#3D.p<<B2Wsh;
.p.+#3D..0005;.goto.applyg;#0A..1case.F_k0g+4:..Wp[
.4].#3D.p<<B2Wsh;.p.+#3D..0004;.goto.applyg;#0A..1c
ase.F_k0g+3:..Wp[.3].#3D.p<<B2Wsh;.p.+#3D..0003;#0A
..1applyg:..6Wp..2#3D.W+p;#0A..16Wp[1].#3D.pc.+.1;#0A
..16pc..2#3D.Wg[B[pc]];#0A..16Wp[2].#3D.pc;#0A..16W
p[3].#3D.a;#0A..16goto.fetchchk;#0A.#0A..1case.F_k0
+11:..Wp[11].#3D.p<<B2Wsh;.p.+#3D.11;.goto.applyk;#0A
..1case.F_k0+10:..Wp[10].#3D.p<<B2Wsh;.p.+#3D.10;.g
oto.applyk;#0A..1case.F_k0+9:..1Wp[.9].#3D.p<<B2Wsh
;.p.+#3D..0009;.goto.applyk;#0A..1case.F_k0+8:..1Wp
[.8].#3D.p<<B2Wsh;.p.+#3D..0008;.goto.applyk;#0A..1
case.F_k0+7:..1Wp[.7].#3D.p<<B2Wsh;.p.+#3D..0007;.g
oto.applyk;#0A..1case.F_k0+6:..1Wp[.6].#3D.p<<B2Wsh
;.p.+#3D..0006;.goto.applyk;#0A..1case.F_k0+5:..1Wp
[.5].#3D.p<<B2Wsh;.p.+#3D..0005;.goto.applyk;#0A..1
case.F_k0+4:..1Wp[.4].#3D.p<<B2Wsh;.p.+#3D..0004;.g
oto.applyk;#0A..1case.F_k0+3:..1Wp[.3].#3D.p<<B2Wsh
;.p.+#3D..0003;#0A..1applyk:..6Wp..2#3D.W+p;#0A..16
Wp[1].#3D.WD.pc;#0A..16pc..2#3D.a;#0A..16Wp[2].#3D.
pc;#0A..16Wp[3].#3D.a.#3D.b;#0A..16goto.fetchchk;#0A
#0A..1case.F_k:..4k.#3D.B[pc];.Wp[k].#3D.p<<B2Wsh;.
p.+#3D..k;#0A..16Wp..2#3D.W+p;#0A..16Wp[1].#3D.pc.+
.1;#0A..16pc..2#3D.a;#0A..16Wp[2].#3D.pc;#0A..16Wp[
3].#3D.a.#3D.b;#0A..16goto.fetchchk;#0A#0A..1case.F
_kh:..3k.#3D.GH(pc);.Wp[k].#3D.p<<B2Wsh;.p.+#3D..k;
#0A..16Wp..2#3D.W+p;#0A..16Wp[1].#3D.pc.+.2;#0A..16
pc..2#3D.a;#0A..16Wp[2].#3D.pc;#0A..16Wp[3].#3D.a.#3D
.b;#0A..16goto.fetchchk;#0A#0A..1case.F_kw:..3k.#3D
.mw+GW(pc);.mw.#3D.0;#0A..16Wp[k].#3D.p<<B2Wsh;.p.+
#3D..k;#0A..16Wp..2#3D.W+p;#0A..16Wp[1].#3D.pc.+.4;
#0A..16pc..2#3D.a;#0A..16Wp[2].#3D.pc;#0A..16Wp[3].
#3D.a.#3D.b;#0A..16goto.fetchchk;#0A#0A..1case.F_je
q:..1if(b#3D#3Da).{.pc.+#3D.SB[pc];..1goto.fetch;.}
#0A..15pc++;.goto.fetch;#0A..1case.F_jeq+1:.if(b#3D
#3Da).goto.indjump;#0A..15pc++;.goto.fetch;#0A..1ca
se.F_jeq+2:.if(a#3D#3D0000).{.pc.+#3D.SB[pc];..1got
o.fetch;.}#0A..15pc++;.goto.fetch;#0A..1case.F_jeq+
3:.if(a#3D#3D0000).goto.indjump;#0A..15pc++;.goto.f
etch;#0A#0A..1case.F_jne:..1if(b!#3Da).{.pc.+#3D.SB
[pc];..1goto.fetch;.}#0A..15pc++;.goto.fetch;#0A..1
case.F_jne+1:.if(b!#3Da).goto.indjump;#0A..15pc++;.
goto.fetch;#0A..1case.F_jne+2:.if(a!#3D0).{.pc.+#3D
.SB[pc];..1goto.fetch;.}#0A..15pc++;.goto.fetch;#0A
..1case.F_jne+3:.if(a!#3D0).goto.indjump;#0A..15pc+
+;.goto.fetch;#0A#0A..1case.F_jls:..1if(b<a).{.pc.+
#3D.SB[pc];..1goto.fetch;.}#0A..15pc++;.goto.fetch;
#0A..1case.F_jls+1:.if(b<a).goto.indjump;#0A..15pc+
+;.goto.fetch;#0A..1case.F_jls+2:.if(a<0).{.pc.+#3D
.SB[pc];..1goto.fetch;.}#0A..15pc++;.goto.fetch;#0A
..1case.F_jls+3:.if(a<0).goto.indjump;#0A..15pc++;.
goto.fetch;#0A#0A..1case.F_jgr:..1if(b>a).{.pc.+#3D
.SB[pc];..1goto.fetch;.}#0A..15pc++;.goto.fetch;#0A
..1case.F_jgr+1:.if(b>a).goto.indjump;#0A..15pc++;.
goto.fetch;#0A..1case.F_jgr+2:.if(a>0).{.pc.+#3D.SB
[pc];..1goto.fetch;.}#0A..15pc++;.goto.fetch;#0A..1
case.F_jgr+3:.if(a>0).goto.indjump;#0A..15pc++;.got
o.fetch;#0A#0A..1case.F_jle:..1if(b<#3Da).{.pc.+#3D
.SB[pc];..1goto.fetch;.}#0A..15pc++;.goto.fetch;#0A
..1case.F_jle+1:.if(b<#3Da).goto.indjump;#0A..15pc+
+;.goto.fetch;#0A..1case.F_jle+2:.if(a<#3D0).{.pc.+
#3D.SB[pc];..1goto.fetch;.}#0A..15pc++;.goto.fetch;
#0A..1case.F_jle+3:.if(a<#3D0).goto.indjump;#0A..15
pc++;.goto.fetch;#0A#0A..1case.F_jge:..1if(b>#3Da).
{.pc.+#3D.SB[pc];..1goto.fetch;.}#0A..15pc++;.goto.
fetch;#0A..1case.F_jge+1:.if(b>#3Da).goto.indjump;#0A
..15pc++;.goto.fetch;#0A..1case.F_jge+2:.if(a>#3D0)
.{.pc.+#3D.SB[pc];..1goto.fetch;.}#0A..15pc++;.goto
.fetch;#0A..1case.F_jge+3:.if(a>#3D0).goto.indjump;
#0A..15pc++;.goto.fetch;#0A#0A..1case.F_j:..3pc.+#3D
.SB[pc];..6goto.fetch;#0A#0A.indjump:#0A..1case.F_j
+1:..1pc.#3D.(pc>>0001).+.B[pc];#0A..15pc.#3D.(pc<<
0001).+.SH[pc];#0A..15goto.fetch;#0A#0A..1case.F_ap
0+12:.a.#3D.a.+.Wp[12];.goto.fetch;#0A..1case.F_ap0
+11:.a.#3D.a.+.Wp[11];.goto.fetch;#0A..1case.F_ap0+
10:.a.#3D.a.+.Wp[10];.goto.fetch;#0A..1case.F_ap0+9
:..a.#3D.a.+.Wp[.9];.goto.fetch;#0A..1case.F_ap0+8:
..a.#3D.a.+.Wp[.8];.goto.fetch;#0A..1case.F_ap0+7:.
.a.#3D.a.+.Wp[.7];.goto.fetch;#0A..1case.F_ap0+6:..
a.#3D.a.+.Wp[.6];.goto.fetch;#0A..1case.F_ap0+5:..a
.#3D.a.+.Wp[.5];.goto.fetch;#0A..1case.F_ap0+4:..a.
#3D.a.+.Wp[.4];.goto.fetch;#0A..1case.F_ap0+3:..a.#3D
.a.+.Wp[.3];.goto.fetch;#0A#0A..1case.F_ap:..2a.+#3D
.Wp[B[pc++]];..7goto.fetch;#0A..1case.F_aph:..1a.+#3D
.Wp[GH(pc)];.pc.+#3D.2;.goto.fetch;#0A..1case.F_apw
:..1a.+#3D.Wp[mw+GW(pc)];.mw.#3D.0;#0A..15pc.+#3D.4
;.goto.fetch;#0A..1case.F_agh:..1a.+#3D.Wg[GH(pc)];
.pc.+#3D.2;.goto.fetch;#0A..1case.F_ag1:..1a.+#3D.W
g1[B[pc++]];..6goto.fetch;#0A..1case.F_ag:..2a.+#3D
.Wg[B[pc++]];..7goto.fetch;#0A#0A..1case.F_a0+5:.a.
+#3D.5;.goto.fetch;#0A..1case.F_a0+4:.a.+#3D.4;.got
o.fetch;#0A..1case.F_a0+3:.a.+#3D.3;.goto.fetch;#0A
..1case.F_a0+2:.a.+#3D.2;.goto.fetch;#0A..1case.F_a
0+1:.a.+#3D.1;.goto.fetch;#0A..1case.F_nop:..8goto.
fetch;#0A#0A..1case.F_mw:..1mw.#3D.((BCPLWORD)GW(pc
))<<00032;#0A..14pc.+#3D.4;.goto.fetch;#0A#0A..1cas
e.F_a:..2a.+#3D.B[pc++];..9goto.fetch;#0A..1case.F_
ah:..1a.+#3D.GH(pc);..1pc.+#3D.2;.goto.fetch;#0A..1
case.F_aw:..1a.+#3D.mw+GW(pc);.mw.#3D.0;#0A..14pc.+
#3D.4;.goto.fetch;#0A..1case.F_s:..2a.-#3D.B[pc++];
..9goto.fetch;#0A..1case.F_sh:..1a.-#3D.GH(pc);..1p
c.+#3D.2;.goto.fetch;#0A#0A..1case.F_s0+4:.a.-#3D.4
;.goto.fetch;#0A..1case.F_s0+3:.a.-#3D.3;.goto.fetc
h;#0A..1case.F_s0+2:.a.-#3D.2;.goto.fetch;#0A..1cas
e.F_s0+1:.a.-#3D.1;.goto.fetch;#0A#0A..1case.F_l0p0
+12:.b.#3D.a;.a.#3D.W[Wp[12]+0];.goto.fetch;#0A..1c
ase.F_l0p0+11:.b.#3D.a;.a.#3D.W[Wp[11]+0];.goto.fet
ch;#0A..1case.F_l0p0+10:.b.#3D.a;.a.#3D.W[Wp[10]+0]
;.goto.fetch;#0A..1case.F_l0p0+9:..b.#3D.a;.a.#3D.W
[Wp[.9]+0];.goto.fetch;#0A..1case.F_l0p0+8:..b.#3D.
a;.a.#3D.W[Wp[.8]+0];.goto.fetch;#0A..1case.F_l0p0+
7:..b.#3D.a;.a.#3D.W[Wp[.7]+0];.goto.fetch;#0A..1ca
se.F_l0p0+6:..b.#3D.a;.a.#3D.W[Wp[.6]+0];.goto.fetc
h;#0A..1case.F_l0p0+5:..b.#3D.a;.a.#3D.W[Wp[.5]+0];
.goto.fetch;#0A..1case.F_l0p0+4:..b.#3D.a;.a.#3D.W[
Wp[.4]+0];.goto.fetch;#0A..1case.F_l0p0+3:..b.#3D.a
;.a.#3D.W[Wp[.3]+0];.goto.fetch;#0A#0A..1case.F_l1p
0+6:..b.#3D.a;.a.#3D.W[Wp[.6]+1];.goto.fetch;#0A..1
case.F_l1p0+5:..b.#3D.a;.a.#3D.W[Wp[.5]+1];.goto.fe
tch;#0A..1case.F_l1p0+4:..b.#3D.a;.a.#3D.W[Wp[.4]+1
];.goto.fetch;#0A..1case.F_l1p0+3:..b.#3D.a;.a.#3D.
W[Wp[.3]+1];.goto.fetch;#0A#0A..1case.F_l2p0+5:..b.
#3D.a;.a.#3D.W[Wp[.5]+2];.goto.fetch;#0A..1case.F_l
2p0+4:..b.#3D.a;.a.#3D.W[Wp[.4]+2];.goto.fetch;#0A.
.1case.F_l2p0+3:..b.#3D.a;.a.#3D.W[Wp[.3]+2];.goto.
fetch;#0A#0A..1case.F_l3p0+4:..b.#3D.a;.a.#3D.W[Wp[
.4]+3];.goto.fetch;#0A..1case.F_l3p0+3:..b.#3D.a;.a
.#3D.W[Wp[.3]+3];.goto.fetch;#0A#0A..1case.F_l4p0+4
:..b.#3D.a;.a.#3D.W[Wp[.4]+4];.goto.fetch;#0A..1cas
e.F_l4p0+3:..b.#3D.a;.a.#3D.W[Wp[.3]+4];.goto.fetch
;#0A#0A..1case.F_l0gh:..b.#3D.a;.a.#3D.W[Wg[GH(pc)]
+0];.pc.+#3D.2;.goto.fetch;#0A..1case.F_l1gh:..b.#3D
.a;.a.#3D.W[Wg[GH(pc)]+1];.pc.+#3D.2;.goto.fetch;#0A
..1case.F_l2gh:..b.#3D.a;.a.#3D.W[Wg[GH(pc)]+2];.pc
.+#3D.2;.goto.fetch;#0A..1case.F_l0g1:..b.#3D.a;.a.
#3D.W[Wg1[B[pc++]]+0];..6goto.fetch;#0A..1case.F_l1
g1:..b.#3D.a;.a.#3D.W[Wg1[B[pc++]]+1];..6goto.fetch
;#0A..1case.F_l2g1:..b.#3D.a;.a.#3D.W[Wg1[B[pc++]]+
2];..6goto.fetch;#0A..1case.F_l0g:..1b.#3D.a;.a.#3D
.W[Wg[B[pc++]]+0];..7goto.fetch;#0A..1case.F_l1g:..
1b.#3D.a;.a.#3D.W[Wg[B[pc++]]+1];..7goto.fetch;#0A.
.1case.F_l2g:..1b.#3D.a;.a.#3D.W[Wg[B[pc++]]+2];..7
goto.fetch;#0A#0A..1case.F_s0gh:..W[Wg[GH(pc)]+0].#3D
.a;..6pc.+#3D.2;.goto.fetch;#0A..1case.F_s0g1:..W[W
g1[B[pc++]]+0].#3D.a;..13goto.fetch;#0A..1case.F_s0
g:..1W[Wg[B[pc++]]+0].#3D.a;..14goto.fetch;#0A#0A..
1case.F_stp0+5:.W[a+Wp[5]].#3D.b;.goto.fetch;#0A..1
case.F_stp0+4:.W[a+Wp[4]].#3D.b;.goto.fetch;#0A..1c
ase.F_stp0+3:.W[a+Wp[3]].#3D.b;.goto.fetch;#0A#0A..
1case.F_st0p0+4:.W[Wp[4]+0].#3D.a;.goto.fetch;#0A..
1case.F_st0p0+3:.W[Wp[3]+0].#3D.a;.goto.fetch;#0A#0A
..1case.F_st1p0+4:.W[Wp[4]+1].#3D.a;.goto.fetch;#0A
..1case.F_st1p0+3:.W[Wp[3]+1].#3D.a;.goto.fetch;#0A
..1#0A..1case.F_rvp0+7:.a.#3D.W[a+Wp[7]];.goto.fetc
h;#0A..1case.F_rvp0+6:.a.#3D.W[a+Wp[6]];.goto.fetch
;#0A..1case.F_rvp0+5:.a.#3D.W[a+Wp[5]];.goto.fetch;
#0A..1case.F_rvp0+4:.a.#3D.W[a+Wp[4]];.goto.fetch;#0A
..1case.F_rvp0+3:.a.#3D.W[a+Wp[3]];.goto.fetch;#0A.
.1}#0A#0Abadpc:#0A..1res.#3D.4;../*.pc.too.large.or
.negative..*/.#0A#0Aret:#0A..1tracing.#3D.0;#0A..1/
/printf("cinterp:.returning.from.interpret,.res#3D%
".FormD."\n",.res);#0A..1W[regs+0]..#3D.a;..2/*.Sav
e.the.machine.registers..*/#0A..1W[regs+1]..#3D.b;#0A
..1W[regs+2]..#3D.c;#0A..1W[regs+3]..#3D.p<<B2Wsh;#0A
..1W[regs+4]..#3D.g<<B2Wsh;#0A..1W[regs+5]..#3D.st;
#0A..1W[regs+6]..#3D.pc;#0A..1W[regs+7]..#3D.count;
#0A..1W[regs+8]..#3D.mw;#0A#0A..1/*.Save.p.in.currc
o.resumption.point,.for.debugging.purposes..3*/#0A.
.1/*.currco.must.always.be.set.to.the.coroutine.sta
ck.containing.p.*/#0A..1//W[Wg[Gn_currco]].#3D.p;#0A
..1#0A..1return.res;..//.Return.from.this.invocatio
n.of.interpret#0A}#0A}#0A

######sysc/cintsys.c#
/*#0A**.This.is.a.32.bit.CINTCODE.interpreter.writt
en.in.C.designed#0A**.to.run.on.most.machines.with.
Unix-like.C.libraries#2E#0A**#0A**.(c).Copyright:..
Martin.Richards..00025.Jan.2012#0A**#0A*/#0A#0A//.T
est.this.sort.of.comment#2E#0A#0A/*#0A03/03/14#0ATh
e.Cintcode.memory.must.have.read,.write.and.execute
.permissions#2E..Allocating#0Amemory.using.malloc.s
eems.to.provide.this.under.windows.but.not.under.al
l#0Aversions.of.Linux,.so.under.Linux.the.Cintcode.
memory.is.now.allocated.using#0Ammap#2E#0A#0A00015/
04/13#0AAdded.sys(Sys_opengl,#2E#2E1).to.provide.an
.interface.to.the.OpenGL.graphics.library#2E#0A#0A0
0022/06/12#0AAdded.sys(Sys_sdl,#2E#2E1).to.provide.
an.interface.to.the.SDL.graphics.library#2E#0A#0A00
006/03/12#0AImplemented.debug.counts.by.defining.in
cdcount(n).and.sys(Sys_incdcount,n)#2E#0AThere.were
.related.changes.to.cintsys#2Eh,.cintpos#2Eh,.cintp
os#2Ec.g/libhdr#2Eh.and.#0Acom/dcount#2Eb#0A#0A0000
7/02/11#0AChanged.the.format.of.BCPL.filenames.to.u
se.'/'.(or.'\').as.separators.of.file#0Aname.compon
ents#2E.Such.names.are.converted.to.target.system.n
ames.before#0Ause#2E.The.targets.are.UNIXNAMES.for.
Linux.style,.WINNAMES.for.Windows.style.and#0AVMSNA
MES.for.VMS.style#2E.Separators.in.path.list.can.be
.ether.semicolons.or#0Acolons,.except.under.Window.
when.only.semicolons.are.allowed#2E#0A#0A00012/01/1
1#0AMade.INT#2Eh.define.the.macro.FormD.to.have.val
ues.like#0A"d".or."ld".depending.on.whether.BCPLWOR
D.is.int.or.long#2E.FormX#0Ais.similarly.defined.as
."X".or."lX"#2E.These.are.used.in.printf.formats#0A
taking.advantage.of.the.C.feature.that.concatenates
.consecutive.string#0Aconstants.at.compile.time,.as
.in:.printf("x.#3D.%5".FormD."\n",.(BCPLWORD).x);#0A
Made.systematic.changes.to.cintsys#2Ec,.cintsys#2Eh
.and.kblib#2Ec.to.make.use#0Aof.FormD.and.FormX.in.
all.calls.of.printf#2E#0A#0A00004/12/10#0AChanged.t
he.implementation.of.Sys_delay.to.use.select().rath
er.than#0Ausleep().or.nanosleep()#2E#0A#0A00003/05/
10#0ARemoved.Sys_usleep.and.reimplemented.Sys_delay
.to.sleep.for.a.time#0Ain.msecs.(possibly.>#3D.1001
)#2E#0A#0A00007/04/10#0AChange.BCPL.epoc.of.1.Jan.1
978.to.1.Jan.1970.to.be.the.same#0Aas.that.used.by.
Unix.and.Windows#2E.Made.corresponding.changes#0Ato
.blib#2E#0AChanged.INT32.and.INT64.to.BCPLINT32.and
.BCPLINT64#0AChanged.CHAR.to.UNSIGNEDCHAR#0A#0A0002
9/03/10#0AMade.systematic.changes.to.measure.time.i
n.msecs.rather.than.ticks#2E#0AThis.is.equivalent.t
o.setting.tickspersecond.to.1001,.but.the.code.is#0A
simpler#2E#0A#0A00024/02/10#0ABegan.to.implement.mu
ch.stricter.control.of.access.to.memory.values.shar
ed#0Abetween.threads,.and,.for.systems.that.provide
.priority.scheduling,.the#0ACintcode.interpreter.th
read.is.given.a.lower.priority.than.any.thread#0Ade
fined.in.devices#2Ec#2E.For.further.details.see.bel
ow#2E..1#0A#0A00005/02/10#0AAdded.the.low.level.tra
ce.functions.trpush,.settrcount.and.gettrcount,#0At
ogether.with.the.sys.operations.Sys_trpush,.Sys_set
trcount.and.Sys_gettrval#2E#0AThese.can.all.be.safe
ly.called.from.any.thread#2E.The.circular.trace.buf
fer#0Acan.hold.4096.values#2E#0A#0A00007/10/09#0ARe
named.files.cinterp#2Eh.to.cintsys#2Eh.(and.for.cin
tpos,.cinterp#2Eh.to#0Acintpos#2Eh).to.distinguish.
between.the.two.versions.of.cinterp#2Eh#0A#0A00005/
10/09#0AMoved.some.some.configuration.statements.to
.cintsys#2Eh.and.added.VMSNAMES#0A#0A00017/07/09#0A
Added.forVmsItanium.and.forVmsVax.features,.includi
ng.the.following:#0AImplemented.vmsfile(filename,.v
msfilename).to.convert#0Amost.Linux.file.names.to.V
ax.filenames#2E#0A#0A00019/02/08#0ARound.up.the.add
ress.of.the.Cintcode.memory.to.a.double.word.bounda
ry#2E..(malloc#0Aprobably.already.does.this)#2E#0A#0A
00007/12/07#0AAdded.and.initialised.the.rootnode.fi
elds.rtn_mc0.to.rtn_mc3.to.hold.the.m/c#0Aaddress.o
f.the.Cintcode.memory.and.other.system.dependent.va
lues.used.by.the.MC#0Adynamic.native.code.package#2E
#0A#0A00021/11/06#0AForce.sardch.to.treat.RUBOUT.(i
e.the.backspace.key).to.return.Backspace.(#3D8)#0An
ot.rubout.(#3D127)#2E.Add.sys(Sys_delay,.ticks).and
.tickspersecond.to.delay#0Afor.a.given.number.of.ti
cks.using.sleep.and.usleep#2E#0A#0A00010/11/06#0AAd
ded.the.-slow.option.to.force.using.the.slow.interp
reter.(interpret).all#0Athe.time#2E.This.is.useful.
if.there.seems.to.be.a.bug.in.cinterp.or.fasterp#2E
#0A#0A00008/11/06#0AAdded.the.-d.option.to.set.the.
dump.flag.in.the.rootnode.(equivalent.to.calling#0A
the.command:.dumpmem.on)#2E.This.will.cause.the.ent
ire.Cintcode.memory.to.be#0Adumped.to.DUMP#2Emem.in
.a.compacted.form.if.the.Cintcode.system.returns.wi
th.a#0Anon.zero.return.code#2E.The.file.DUMP#2Emem.
can.be.printed.in.a.readable.form.using#0Athe.dumps
ys.command.(always.assuming.you.have.a.working.BCPL
.system)#2E#0A#0A00007/11/06#0AAdded.-v.option.to.t
race.the.progress.of.the.booting.process#2E.This.is
.primarily#0Ato.help.people.a.new.installation.of.C
intcode.BCPL#2E#0AAdded.-vv.option.to.trace.the.pro
gress.of.the.booting.process#2E.It.behaves.like#0A-
v.above.but.also.does.some.Cintcode.instruction.lev
el.tracing#2E#0AAdded.-f.option.to.cintsys.to.trace
.the.use.of.environment.variables.such.as#0ABCPLPAT
H.by.pathinput#2E.This.is.helps.to.track.down.insta
llation.problems#2E#0A#0A00026/07/06#0AMade.changes
.to.cause.loadseg.to.look.first.in.the.BCPLPATH.dir
ectories.then#0Athe.current.directory.and.finally.i
n.the.cin.directory.of.BCPLROOT#2E..To#0Asimplify.t
his.change,.the.first.argument.of.pathinput.was.cha
nges.from.a.BCPL#0Astring.to.a.C.string,.together.w
ith.related.changes#2E..There.are.now.three.work#0A
C.strings.chbuf1,.chbuf2.and.chbuf3#2E.Made.cintsys
#2Ec.more.compatible.with#0Acintpos#2Ec#0A#0A00022/
06/06#0AMaking.a.version.for.the.GP2X.handheld.Linu
x.machine#2E#0A#0A00021/06/06#0ADefined.CHAR.in.cin
tpos#2Eh.and.cintsys#2Eh.to.be.unsigned.char.and.re
placed.nearly#0Aall.occurences.of.char.with.CHAR#2E
.This.avoids.a.warning.from.some.compilers#2E#0ACha
nged.most.file.names.to.lower.case.to.simplify.use.
of.windows.machines#2E#0A#0A00018/01/06#0AAdded.-s,
.-c.and.--.parameters.to.cintpos,.to.prepend.charac
ters.before.the#0Astart.of.stdin.(as.suggested.by.D
ave.Lewis)#2E#0A#0A00001/01/06#0AChange.-m.and.-t.o
ptions.to.specify.sizes.in.words.(not.thousands.of.
words)#2E#0A#0A00024/04/04#0AMade.many.changes.to.m
ake.cintsys.more.compatible.with.cintpos#0A#0A00022
/06/00#0AMade.a.correction.to.muldiv.to.stop.it.loo
ping.on.#23x8004.This.Cintcode#0Ainstruction.MDIV.i
s.now.not.invoked.since.it.sometimes.causes.a.float
ing#0Apoint(!!).exception.on.a.Pentium#2E#0A#0A0000
5/04/00#0AAdded.-m.and.-t.command.line.options.to.s
pecify.the.Cintcode.memory.size.and#0Atally.vector.
size.in.thousands.of.words#2E..Added.the.-h.option#2E
#0A#0A00006/01/00#0AMade.changes.to.make.cintsys#2E
c.more.compatible.with.the.Windows.CE.version#2E#0A
#0A00026/2/99#0AChanged.loadseg.to.accept.binary.hu
nks.as.well.as.hex.hunks#2E#0A#0A0006/11/98#0AImple
mented.changes.to.replace.sys(14,name).by.sys(14,na
me,pathname)#2E.If#0Apathname.is.0.or.the.specified
.shell.variable.is.unset,.there.should.be.no#0Anoti
ceable.difference#2E.The.new.version.searches.for.t
he.file.in.the.current#0Aworking.directory,.then.th
e.directories.given.by.the.shell.variable.pathname#0A
until.successfully.opened#2E..It.is.designed.to.wor
k.on.both.Windows.and#0Aunix#2E.The.convention.will
.be.that.if.the.shell.variable.is.set.it.will.speci
fy#0Aa.path.used.by.loadseg.(ie.the.initial.loading
.of.SYSLIB,.BOOT,.BLIB,.CLI.and#0ACLI.commands).as.
well.as.for.header.files#2E.There.are.small.related
.changes.to#0Alibhdr,.BLIB#2Eb.and.bcpl#2Eb#2E#0A#0A
0005/11/98#0AThe.comment.character.in.object.module
s.has.changed.from.semicolon(';').to.hash#0A('#23')
#2E#0A#0A00012/6/96.Move.the.definition.of#0AINT32p
t,.WD,.UWD,.PT,.BP,.SBP,.HP.and.SHP.to.cintpos#2Eh,
.and.define.SIGNEDCHAR#0Ain.cintpos#2Eh.to.solve.a.
problem.with.char.being.unsigned.on.some#0Aimplemen
tations#2E#0A#0A00031/5/96#0AAdded.handler.for.SIGI
NT.to.restore.tty.settings#0A#0A00030/4/96#0AAdded.
call.of.fflush(fp).to.case.13:.in.dosys,.with.corre
sponding.changes.to#0Alibhdr.and.BLIB#2Eb.(added.fl
ush())#0A#0A00024/11/95#0AImproved.the.efficiency.o
f.the.calls.of.fread.and.fwrite#0AReduced.the.size.
of.chbuf.from.1024.to.256#0A#0A00025/10/95#0AUse.AN
SI.clock().instead.of.ftime(),.adding.TICKS_PER_MS#2E
..Change.#23define.names#0Ato.forMAC,.forMIPS,.forS
UN4.etc.Add.and.set.external.tallyv#0A#0A*/#0A#0A/*
.cintsys#2Eh.and.cintpos#2Eh.contains.machine/OS.de
pendent.#23defines..*/#0A#23include."cintsys#2Eh"#0A
#23include.<math#2Eh>#0A#23include."time#2Eh"#0A#0A
/*.Function.defined.in.callc#2Ec..*/#0Aextern.BCPLW
ORD.callc(BCPLWORD.*args,.BCPLWORD.*g);#0A#0ABCPLWO
RD.trcount.#3D.-1;.//.trpush.initially.disabled#0AB
CPLWORD.trvec[4096];..//.4096.elements.in.the.trpus
h.circular.buffer#0A#0A/*.Low.level.trace.functions
.*/#0A#0Avoid.trpush(BCPLWORD.val);#0ABCPLWORD.sett
rcount(BCPLWORD.count);.//.Set.trcount.and.returns.
its.old.value#0ABCPLWORD.gettrval(BCPLWORD.count);.
//.Get.the.specified.trace.value#0ABCPLWORD.incdcou
nt(BCPLWORD.n);#0A#0A1/*.Functions.defined.in.kblib
#2Ec..*/#0Aextern.int.Readch(void);#0Aextern.int.po
llReadch(void);#0Aextern.int.init_keyb(void);#0Aext
ern.int.close_keyb(void);#0Aextern.int.intflag(void
);#0A#0A/*.Function.defined.in.soundfn#2Ec.*/#0ABCP
LWORD.soundfn(BCPLWORD.*args,.BCPLWORD.*g);#0A#0A/*
.Function.defined.in.sdlfn#2Ec.*/#0ABCPLWORD.sdlfn(
BCPLWORD.*args,.BCPLWORD.*g,.BCPLWORD.*W);#0A#0A/*.
Function.defined.in.glfn#2Ec.*/#0ABCPLWORD.glfn(BCP
LWORD.*args,.BCPLWORD.*g,.BCPLWORD.*W);#0A#0A/*.Fun
ction.defined.in.extfn#2Ec.*/#0ABCPLWORD.extfn(BCPL
WORD.*args,.BCPLWORD.*g,.BCPLWORD.*W);#0A#0A/*.Func
tions.defined.in.rastlib#2Ec.(or.nullrastlib#2Ec)..
*/#0Aextern.BCPLWORD.setraster(BCPLWORD.n,.BCPLWORD
.val);#0A#0A/*.Function.defined.in.graphics#2Ec#0A.
.1Only.available.under.Windows.CE.--.Now.obsolete#2E
#0A*/#0A#23ifdef.forWinCE#0Aextern.BCPLWORD.sysGrap
hics(BCPLWORD.p);#0A#23else#0ABCPLWORD.sysGraphics(
BCPLWORD.p).{.return.0;.}./*.Dummy.definition.*/#0A
#23endif#0A#0A#23define.Stackupb..003500L#0A#23defi
ne.Globupb..0031001L#0A#0ABCPLWORDpt.W;../*.This.wi
ll.hold.the.pointer.to.the.Cintcode.memory.*/#0A#0A
BCPLWORD.*lastWp;..2/*.Latest.setting.of.Wp..*/#0AB
CPLWORD.*lastWg;..2/*.Latest.setting.of.Wg..*/#0ABC
PLWORD..lastst;..2/*.Latest.setting.of.st..*/#0A#0A
BCPLWORD.rootvarstr.#3D.0;#0ABCPLWORD.pathvarstr.#3D
.0;#0ABCPLWORD.hdrsvarstr.#3D.0;#0ABCPLWORD.scripts
varstr.#3D.0;#0A#0ABCPLWORD.prefixstr.#3D.0;./*.Pos
ition.in.the.Cintcode.memory.of.the.filename.*/#0A.
.22/*.prefix#2E.The.prefixstr.is.prepended.to.all.n
on.*/#0A..22/*.absolute.file.names#2E.prefixstr.is.
set.by.*/#0A..22/*.sys(Sys_setprefix,.str).and.read
.by.*/#0A..22/*.sys(Sys_getprefix)#2E.*/#0Achar.*pr
efixbp;..7/*.Address.of.byte.holding.the.length.of.
the.prefix.*/#0A#0ABCPLWORD.stackbase;#0ABCPLWORD.g
lobbase;#0ABCPLWORD.result2;#0A#0Astatic.char.chbuf
1[256];./*.These.buffers.are.used.to.hold.filenames
.*/#0Astatic.char.chbuf2[256];#0Astatic.char.chbuf3
[256];#0Astatic.char.chbuf4[256];#0Astatic.char*.ro
otvar.#3D."BCPLROOT";./*.The.default.setting.*/#0As
tatic.char*.pathvar.#3D."BCPLPATH";./*.The.default.
setting.*/#0Astatic.char*.hdrsvar.#3D."BCPLHDRS";./
*.The.default.setting.*/#0Astatic.char*.scriptsvar.
#3D."BCPLSCRIPTS";./*.The.default.setting.*/#0A#0Ai
nt.tracing.#3D.0;#0Aint.filetracing.#3D.0;#0Aint.du
mpflag.#3D.0;#0Aint.slowflag.#3D.0;..1/*.If.non.zer
o.always.use.the.slow.interpreter.*/#0Aint.boottrac
e.#3D.0;#0A#0ABCPLWORD.memupb;#0ABCPLWORD.tallyupb,
.tallyvec,.*tallyv,.tallylim#3D0;#0ABCPLWORD.vecsta
tsvupb,.vecstatsvec,.*vecstatsv;..2/*.Stats.of.getv
ec/freevec.*/#0ABCPLWORD.dcountv;..2/*.To.hold.the.
BCPL.pointer.to.the.debug.count.vector.*/#0A#0ABCPL
WORD.taskname[4];..7/*.Used.in.getvec.for.debugging
.*/#0A#0ABCPLWORD.concatsegs(BCPLWORD.seg1,.BCPLWOR
D.seg2);#0ABCPLWORD.loadsysseg(char.*name);#0ABCPLW
ORD.loadseg(char.*name);#0Avoid..unloadseg(BCPLWORD
.segl);#0ABCPLWORD.rdhex(FILEPT.fp);#0ABCPLWORD.glo
bin(BCPLWORD.segl,.BCPLWORD.g);#0ABCPLWORD.getvec(B
CPLWORD.upb);#0ABCPLWORD.freevec(BCPLWORD.p);#0ABCP
LWORD.muldiv(BCPLWORD.a,.BCPLWORD.b,.BCPLWORD.c);#0A
FILEPT.pathinput(char.*name,.char.*pathname);#0ABCP
LWORD.dosys(BCPLWORD.p,.BCPLWORD.g);#0ABCPLWORD.dof
lt(BCPLWORD.op,.BCPLWORD.a,.BCPLWORD.b,.BCPLWORD.c)
;#0Achar.*prepend_prefix(char.*fromstr,.char.*tostr
);#0Achar.*vmsfname(char.*name,.char.*vmsname);#0Ac
har.*osfname(char.*name,.char.*osname);#0Avoid.c2b_
str(char.*cstr,.BCPLWORD.bstr);#0Achar.*b2c_str(BCP
LWORD.bstr,.char.*cstr);#0ABCPLWORD.syscin2b_str(ch
ar.*cstr,.BCPLWORD.bstr);#0Achar.*catstr2c_str(char
.*cstr1,.char.*cstr2,.char.*str);#0Avoid..wrcode(ch
ar.*form,.BCPLWORD.f,.BCPLWORD.a);#0Avoid..wrfcode(
BCPLWORD.f);#0Avoid..trace(BCPLWORD.pc,.BCPLWORD.p,
.BCPLWORD.a,.BCPLWORD.b);#0Avoid..dumpmem(BCPLWORD.
*mem,.BCPLWORD.upb,.BCPLWORD.context);#0ABCPLWORD.t
imestamp(BCPLWORD.*v);#0Avoid.msecdelay(unsigned.in
t.delaymsecs);#0A#0Aextern.int.cintasm(BCPLWORD.reg
s,.BCPLWORDpt.mem);#0Aextern.int.interpret(BCPLWORD
.regs,.BCPLWORDpt.mem);#0A#0A#23define.Globword..00
50x8F8F002L#0A#0A#23define.Gn_globsize..0020#0A#23d
efine.Gn_start..0051#0A#23define.Gn_sys..0073#0A#23
define.Gn_currco..0047#0A#23define.Gn_colist..0048#0A
#23define.Gn_rootnode..0029#0A#23define.Gn_result2.
.00210#0A#23define.Gn_cli_returncode..002137#0A#0A/
*.relocatable.object.blocks..*/#0A#23define.T_hunk.
.0021001L#0A#23define.T_reloc..0011000001L#0A#23def
ine.T_end..0031000002L#0A#23define.T_hunk64..000200
1L#0A#23define.T_reloc64.2000001L#0A#23define.T_end
64..0012000002L#0A#23define.T_bhunk..0013001L#0A#23
define.T_bhunk64.4001L#0A#0Aint.badimplementation(v
oid)#0A{.int.bad.#3D.0;#0A..int.A#3D'A';#0A..SIGNED
CHAR.c.#3D.(SIGNEDCHAR)255;#0A..if(sizeof(BCPLWORD)
!#3D(1<<B2Wsh)).{#0A..5PRINTF("Size.of.a.BCPL.word.
is.not.%d\n",.1<<B2Wsh);#0A..5bad.#3D.1;#0A..}#0A..
if(A!#3D65).{#0A..5PRINTF("Character.set.is.not.ASC
II\n");#0A..5bad.#3D.1;#0A..}#0A..if.(c/-1.!#3D.1).
{#0A..2PRINTF("There.is.a.problem.with.SIGNEDCHAR\n
");#0A..2bad.#3D.1;#0A..}#0A../*.Test.vmsfname.*/#0A
../*#0A..vmsfname("echo#2Eb",.chbuf4);#0A..vmsfname
("com/echo#2Eb",.chbuf4);#0A..vmsfname("/mrich177/d
istribution/bcpl/g/libhdr#2Eh",.chbuf4);#0A..vmsfna
me("vd10$disk:/mrich177/junk#2Eb",.chbuf4);#0A..vms
fname("#2E#2E/cintcode/com/bcplfe#2Eb",.chbuf4);#0A
..vmsfname("/junk",.chbuf4);#0A..*/#0A..return.bad;
#0A}#0A#0A/*.The.following.four.functions.are.neces
sary.since.the.type.FILE*#0A**.is.too.large.for.a.B
CPL.word.on.some.machines.(such.as.the.DEC.Alpha)#0A
*/#0A#0A#23if.defined(forALPHA).||.defined(forLINUX
AMD64)#0A#23define.Fnolim.100#0A#0AFILEPT.fpvec[Fno
lim];#0A#0Aint.initfpvec(void)#0A{.BCPLWORD.i;#0A..
for(i#3D1;i<Fnolim;i++).fpvec[i]#3DNULL;#0A..return
.0;#0A}#0A#0ABCPLWORD.newfno(FILEPT.fp)#0A{.BCPLWOR
D.i;#0A..for(i#3D1;i<Fnolim;i++).if(fpvec[i]#3D#3DN
ULL){.fpvec[i]#3Dfp;.return.i;.}#0A..return.0;#0A}#0A
#0ABCPLWORD.freefno(BCPLWORD.fno)#0A{.if(0<fno.&&.f
no<Fnolim){fpvec[fno]#3DNULL;.return.1;.}#0A..retur
n.0;#0A}#0A#0AFILEPT.findfp(BCPLWORD.fno)#0A{.if(0<
fno.&&.fno<Fnolim).return.fpvec[fno];#0A..return.0;
#0A}#0A#0A#23else#0A#0Aint..1initfpvec(void)..2{.re
turn.0;.}#0ABCPLWORD.newfno(FILEPT.fp)..1{.return.W
D.(long)fp;.}#0ABCPLWORD.freefno(BCPLWORD.fno).{.re
turn.fno;.}#0AFILEPT.findfp(BCPLWORD.fno)..{.return
.(FILEPT.)(long)fno;.}#0A#0A#23endif#0A#0Aint.mainp
id#3D0;#0Aextern.BCPLWORD.exitflag;./*.Set.to.one.o
n.receiving.SIGINT.or.SIGGEGV.*/#0A#0A#23ifndef.for
WinCE#0Avoid.(*old_inthandler)(int);#0Avoid.(*old_s
egvhandler)(int);#0A#0Avoid.inthandler(int.sig)#0A{
.#0A..PRINTF("\nSIGINT.received\n");#0A..old_inthan
dler.#3D.signal(SIGINT,.old_inthandler);#0A#0A..clo
se_keyb();#0A..PRINTF("\nLeaving.Cintsys\n");#0A..i
f(W[rootnode+Rtn_dumpflag])#0A..{.W[rootnode+Rtn_la
stp].#3D.lastWp-W;#0A..2W[rootnode+Rtn_lastg].#3D.l
astWg-W;#0A..2dumpmem(W,.memupb,.1);#0A..2PRINTF("\
nMemory.dumped.to.DUMP#2Emem,.context#3D1\n");#0A..
}#0A../*if(mainpid).{.kill(mainpid,.SIGKILL);.mainp
id.#3D.0;.}.*/#0A..exit(0);#0A}#0A#0Avoid.segvhandl
er(int.sig)#0A{.#0A..PRINTF("\nSIGSEGV.received\n")
;#0A..old_segvhandler..#3D.signal(SIGSEGV,..old_seg
vhandler);#0A#0A..close_keyb();#0A..PRINTF("\nLeavi
ng.Cintsys\n");#0A..if(W[rootnode+Rtn_dumpflag])#0A
..{.W[rootnode+Rtn_lastp].#3D.lastWp-W;#0A..2W[root
node+Rtn_lastg].#3D.lastWg-W;#0A..2dumpmem(W,.memup
b,.2);#0A..2PRINTF("\nMemory.dumped.to.DUMP#2Emem,.
context#3D2\n");#0A..}#0A../*if(mainpid).{.kill(mai
npid,.SIGKILL);.mainpid.#3D.0;.}.*/#0A..exit(0);#0A
}#0A#23endif#0A#0Achar.*inbuf.#3D.NULL;#09/*.Buffer
.for.input.to.interpreter.*/#0Aint.reattach_stdin.#3D
.0;#09/*.FALSE,.if.true.switch.to.stdin.after.inbuf
.is.empty.*/#0A#0A/*.Replacement.for.Readch().when.
taking.stdin.from.a.command.line.parameter.*/#0Aint
.inbuf_next()#0A{#0A..static.int.idx.#3D.0;#0A..int
.c.#3D.inbuf[idx];#0A..if.(c).{#0A..2idx++;#0A..2re
turn.c;#0A..}#0A..else.return.EOF;./*.-1.*/#0A}#0A#0A
/*#0ASet.up.a.stream.of.characters.to.be.prepended.
to.the.standard.input,.for.the#0Acli.to.read.before
.those.in.the.normal.input.stream#2E..If.leading_st
ring.is#0Aprovided,.it.is.prepended.to.stream.of.ch
aracters#2E..This.is.used.to.support#0Aexecutable.c
intcode.files.and.CLI.scripts.on.Unix.systems#2E.Th
e.leading_string#0Afeature.permits.support.of.scrip
ts.by.running.the."c".command.followed.by.its#0Acom
mand.line.arguments#2E#0A*/#0Avoid.prepend_stdin(ch
ar.*leading_string,.int.argc,.char*.argv[],.int.arg
vpos).{#0A..int.j;#0A..int.inbuf_len;#0A../*.Total.
number.of.fields.to.prepend.to.standard.input.strea
m.*/#0A..int.field_count.#3D.(leading_string?1:0).+
.argc.-.argvpos.-.1;#0A..if.(field_count.#3D#3D.0).
{#0A..2return;./*.nothing.to.prepend.*/#0A..}#0A../
*.Count.space.to.allocate,.beginning.with.leading_s
tring.*/#0A..inbuf_len.#3D.leading_string.?.strlen(
leading_string).:.0;#0A../*.Add.space.for.remaining
.fields.*/#0A..for.(j#3Dargvpos+1;.j<argc;.j++).{#0A
..2inbuf_len.+#3D.strlen(argv[j]);#0A..}#0A../*.Add
.room.for.spaces.between.fields.plus.a.trailing.<cr
>.*/#0A../*.plus.a.null.terminator.*/#0A..inbuf_len
.+#3D.field_count.+.1;#0A../*.Allocate.buffer.for.i
nput.stream.*/#0A..if.(!(inbuf.#3D.(char*)malloc(in
buf_len))1.{#0A..2perror("malloc");#0A..2exit(-1);#0A
..}#0A..inbuf[0].#3D.0;#0A../*.Fill.the.buffer.*/#0A
../*.First.prepend.the.leading.string,.if.any.*/#0A
..if.(leading_string).strcat(inbuf,.leading_string)
;#0A../*.Concatenate.remaining.args,.separated.by.s
paces.*/#0A..for.(argvpos++;.argvpos<argc;.argvpos+
+).{#0A..2if.(inbuf[0]).strcat(inbuf,.".");#0A..2st
rcat(inbuf,.argv[argvpos]);#0A..}#0A..strcat(inbuf,
."\n");./*.Simulate.interactive.end.of.line.*/#0A#0A
../*PRINTFS("\nPrepended.string:\n%s\n",.inbuf);.*/
#0A}#0A#0A/*.The.MC.package.printf.function.*/#0ABC
PLWORD.mcprf(char.*format,.BCPLWORD.a).{#0A..printf
(format,.a);#0A..return.0;#0A}#0A#0Aint.main(int.ar
gc,.char*.argv[])#0A{.int.rc;#0A..int.i;..9/*.for.F
OR.loops..*/#0A..BCPLWORD.res;..2/*.result.of.inter
pret..*/#0A#0A..for.(i#3D0;.i<4;.i++).taskname[i].#3D
.0;#0A#0A#23ifdef.forWinCE#0A..argc.#3D.0;..3/*.tem
porary.fiddle.for.Windows.CE.*/#0A..memupb..1#3D.20
04L;#0A..tallyupb.#3D..0002003L;#0A#23else#0A..memu
pb..1#3D.4004L;#0A..tallyupb.#3D.1004L;#0A#23endif#0A
#0A..vecstatsvupb.#3D.2002L;#0A#0A#23ifndef.forWinC
E#0A..mainpid.#3D.getpid();#0A#23endif#0A#0A../*for
.(i#3D0;.i<argc;.i++).printf("%2".FormD.":.%s\n",.i
,.argv[i]);.*/#0A#0A..for.(i#3D1;.i<argc;.i++).{#0A
#0A..2if.(strcmp(argv[i],."-m")#3D#3D0000).{#0A..4m
emupb..1#3D.atoi(argv[++i]);#0A..4continue;#0A..2}#0A
#0A..2if.(strcmp(argv[i],."-t")#3D#3D0000).{#0A..4t
allyupb.#3D.atoi(argv[++i]);#0A..4continue;#0A..2}#0A
#0A..2if.(strcmp(argv[i],."-cin")#3D#3D0000).{#0A..
4pathvar.#3D.argv[++i];#0A..4continue;#0A..2}#0A#0A
..2if.(strcmp(argv[i],."-f")#3D#3D0000).{#0A..4file
tracing.#3D.1;#0A..4continue;#0A..2}#0A#0A..2if.(st
rcmp(argv[i],."-d")#3D#3D0000).{#0A..4dumpflag.#3D.
1;#0A..4continue;#0A..2}#0A#0A..2if.(strcmp(argv[i]
,."-slow")#3D#3D0000).{#0A..4slowflag.#3D.1;#0A..4c
ontinue;#0A..2}#0A#0A..2if.(strcmp(argv[i],."-s")#3D
#3D0000).{#0A..4/*#0A..4Invoke.a.CLI.command.interp
reter.giving.it.the.current.file.to#0A..4execute.as
.a.sequence.of.commands#2E..It.is.used.to.enable.ex
ecutable.CLI#0A..4scripts.to.be.invoke.from.Unix#2E
#0A#0A..4Example:.Make.and.executable.file.test1.co
ntaining.something.like:#0A#0A..4#23!/home/mr/distr
ibution/Cintpos/cintpos/cintpos.-s#0A..4bcpl.com/bc
pl#2Eb.to.junk#0A..4echo."*nCompilation.done*n"#0A#0A
..4#23!/home/mr/distribution/BCPL/cintcode/cintsys.
-s#0A..4bcpl.com/bcpl#2Eb.to.junk#0A..4echo."*nComp
ilation.done*n"#0A#0A..4and.run.it.by.typing.the.Un
ix.command:.test1#0A..4*/#0A#0A..4char.*fname.#3D.a
rgv[i.+.1];#0A..4if.(!fname).{#0A..6fprintf(stderr,
."missing.parameter.for.-s\n");#0A..6exit(-1);#0A..
4}#0A..4prepend_stdin("c",.argc,.argv,.i);#0A..4bre
ak;#0A..2}#0A#0A..2if.(strcmp(argv[i],."--")#3D#3D.
0).{#0A..4/*.Like.-c.but.reattach.standard.input.af
ter.exhausting.command.*/#0A..4/*.line.characters#2E
.*/#0A..4reattach_stdin.#3D.1;./*.TRUE.*/#0A..2}#0A
#0A..2if.(strcmp(argv[i],."-c")#3D#3D.0.||.strcmp(a
rgv[i],."--")#3D#3D.0).{#0A..4/*.Allocate.a.buffer.
to.hold.remaining.args.as.a.string.and.pass#0A..4**
.remainder.of.command.line.to.the.interpreter#2E#0A
#0A..4**.Typical.usage:#0A#0A..4**.cintpos.-c.bcpl.
com/bcpl#2Eb.to.junk#0A..4**.cintsys.-c.bcpl.com/bc
pl#2Eb.to.junk#0A..4*/#0A#0A..4prepend_stdin(NULL,.
argc,.argv,.i);#0A..4break;#0A..2}#0A#0A..2if.(strc
mp(argv[i],."-v")#3D#3D.0).{.boottrace#3D1;.continu
e;.}#0A#0A..2if.(strcmp(argv[i],."-vv")#3D#3D.0).{.
boottrace#3D2;.continue;.}#0A#0A..2if.(strcmp(argv[
i],."-h")!#3D0).PRINTF("Unknown.command.option:.%s\
n",.argv[i]);#0A#0A..2PRINTF("\nValid.arguments:\n\
n").;#0A..2PRINTF("-h..10Output.this.help.informati
on\n");#0A..2PRINTF("-m.n..8Set.Cintcode.memory.siz
e.to.n.words\n");#0A..2PRINTF("-t.n..8Set.Tally.vec
tor.size.to.n.words\n");#0A..2PRINTF("-c.args..5"#0A
..9"Pass.args.to.interpreter.as.standard.input.(exe
cutable.bytecode)\n");#0A..2PRINTF("--.args..5"#0A.
.9"Pass.args.to.interpreter.standard.input,.then.re
-attach.stdin\n");#0A..2PRINTF("-s.file.args.."#0A.
.9"Invoke.command.interpreter.on.file.with.args.(ex
ecutable.scripts)\n");#0A..2PRINTF("-cin.name..3Set
.the.pathvar.environment.variable.name\n");#0A..2PR
INTF("-f..10Trace.the.use.of.environment.variables.
in.pathinput\n");#0A..2PRINTF("-v..10Trace.the.boot
strapping.process\n");#0A..2PRINTF("-v.-v..7As.-v,.
but.also.include.some.Cincode.level.tracing\n");#0A
#0A..2PRINTF("-d..10Cause.a.dump.of.the.Cintcode.me
mory.to.DUMP#2Emem\n");#0A..2PRINTF("..12if.a.fault
/error.is.encountered\n");#0A#0A..2PRINTF("-slow..7
Force.the.slow.interpreter.to.always.be.selected\n"
);#0A#0A..2return.0;#0A..}#0A#0A..if(boottrace>0).P
RINTFD("Boot.tracing.level.is.set.to.%d\n",.boottra
ce);#0A#0A..if.(memupb<5002.||.tallyupb<0).{#0A..2P
RINTF("Bad.-m.or.-t.size\n");#0A..2return.10;#0A..}
#0A#0A..if(boottrace).{#0A..2char.*bytestr.#3D."ABC
D1234";#0A..2int.litend.#3D.0;#0A..2printf("\ncints
ys.06.Sep.2014..00013:49\n\n");#0A..2printf("bytest
r#3D%s.word.0.#3D.%8".FormX."\n",.bytestr,.*((BCPLW
ORD*)bytestr));#0A..2if((2BCPLWORD*)bytestr)[0]&255
)#3D#3D'A').litend.#3D.1;#0A#23ifdef.BIGENDER#0A..2
printf("BIGENDER.is.defined");#0A..2if(litend#3D#3D
0000)..printf(".but.the.host.machine.is.a.little.en
der");#0A#23else#0A..2printf("BIGENDER.is.not.defin
ed");#0A..2if(litend#3D#3D0001)..printf(".but.the.h
ost.machine.is.a.big.ender");#0A#23endif#0A..2print
f("\n");#0A..2printf("sizeof(int)..6#3D.%d\n",.(int
)sizeof(int));#0A..2printf("sizeof(long)..5#3D.%d\n
",.(int)sizeof(long));#0A..2printf("sizeof(BCPLWORD
)..1#3D.%d\n",.(int)sizeof(BCPLWORD));#0A..2printf(
"sizeof(BCPLWORD.*).#3D.%d\n",.(int)sizeof(BCPLWORD
.*));#0A..2printf("FormD.is.\"%s\"\n",.FormD);#0A..
2printf("FormX.is.\"%s\"\n",.FormX);#0A..}#0A#0A..i
f(badimplementation())#0A..{.PRINTF("This.implement
ation.of.C.is.not.suitable\n");#0A..2return.0;#0A..
}#0A#0A..initfpvec();#0A#0A../*.Allocate.Cintcode.m
emory.*/#0A..{.int.membytes.#3D.(memupb+tallyupb+ve
cstatsvupb+7)<<B2Wsh;#0A#23ifdef.MMAP#0A..2int.page
size.#3D.sysconf(_SC_PAGE_SIZE);#0A..2if(.tracing.)
#0A..4printf("Allocating.Cintcode.memory.using.mmap
,.pagesize#3D%d\n",.pagesize);#0A..2W.#3D.PT.(mmap(
NULL,.membytes,#0A..15PROT_READ|PROT_WRITE|PROT_EXE
C,#0A..15MAP_PRIVATE|MAP_ANON,.0,.0));#0A..2//..15P
ROT_READ.|.PROT_WRITE.|.PROT_EXEC,.MAP_ANON,.0,.0))
;#0A..2if(.tracing.).printf("W#3D%d.%8x\n",.(BCPLWO
RD)W,.(BCPLWORD)W);#0A#23else#0A..2W.#3D.PT.malloc(
membytes);#0A#23endif#0A..}#0A.#0A..if(W#3D#3DNULL)
#0A..{.PRINTF("Insufficient.memory.for.memvec\n");#0A
..2return.0;#0A..}#0A../*..printf("Cintcode.memory.
%8".FormX.".(unrounded)\n",.(UBCPLWORD).W);.*/#0A..
W.#3D.PT((1long).W.+.7L).&.-8L);#0A../*..printf("Ci
ntcode.memory.%8".FormX".(rounded)\n",.(UBCPLWORD)W
);..*/#0A#0A..lastWp.#3D.W;#0A..lastWg.#3D.W;#0A..l
astst.#3D.3;./*.Pretend.to.be.in.the.interrupt.serv
ice.routine.*/#0A#0A..for.(i#3D0;.i<memupb;.i++).W[
i].#3D.0xDEADC0DE;#0A#0A..if.(boottrace>0).PRINTFD(
"Cintcode.memory.(upb#3D%".FormD.").allocated\n",.m
emupb);#0A#0A..W[0].#3D.memupb+1;../*.Initialise.he
ap.space.*/#0A..W[memupb].#3D.0;#0A#0A..tallylim.#3D
.0;#0A..tallyvec.#3D.memupb+1;#0A..tallyv.#3D.&W[ta
llyvec];#0A..tallyv[0].#3D.tallyupb;#0A..for(i#3D1;
.i<#3Dtallyupb;.i++).tallyv[i].#3D.0;#0A#0A..vecsta
tsvec.#3D.tallyvec.+.tallyupb.+.1;#0A..vecstatsv.#3D
.&W[vecstatsvec];#0A..for(i#3D0;.i<#3Dvecstatsvupb;
.i++).vecstatsv[i].#3D.0;#0A.#0A..getvec(rootnode-1
2);../*.Allocate.space.for.interrupt.vectors.*/#0A#0A
..//.Allocate.the.rootnode.in.exactly.the.correct.p
lace.in.Cintcode.memory#0A..if.(rootnode.!#3D.(i#3D
getvec(100L)+1)).{#0A..2printf("The.root.node.was.a
t.%d.not.at.%d\n",.i,.rootnode);#0A..}#0A#0A..//.Al
locate.space.for.the.environment.variable.names#0A.
.//.and.file.prefix.string#2E#0A..rootvarstr..2#3D.
getvec(5*16);#0A..pathvarstr..2#3D.rootvarstr+1*16;
#0A..hdrsvarstr..2#3D.rootvarstr+2*16;#0A..scriptsv
arstr.#3D.rootvarstr+3*16;#0A..prefixstr..3#3D.root
varstr+4*16;#0A..prefixbp..4#3D.(char.*)(&W[prefixs
tr]);#0A..for(i#3D0;.i<#3D5*16;.i++).W[rootvarstr+i
].#3D.0;#0A#0A..c2b_str(rootvar,.rootvarstr);#0A..c
2b_str(pathvar,.pathvarstr);#0A..c2b_str(hdrsvar,.h
drsvarstr);#0A..c2b_str(scriptsvar,.scriptsvarstr);
#0A#0A..dcountv..2#3D.getvec(511);..14//.Allocate.t
he.debug.counts.vector#0A..W[dcountv].#3D.511;#0A..
for(i#3D1;.i<#3D511;.i++).W[dcountv+i].#3D.0;#0A#0A
..if(filetracing).{#0A..2char.*path.#3D.getenv(root
var);#0A..2PRINTFS("Environment.variable.%s",.rootv
ar);#0A..2PRINTFS(".#3D.%s\n",.path);#0A..2path.#3D
.getenv(pathvar);#0A..2PRINTFS("Environment.variabl
e.%s",.pathvar);#0A..2PRINTFS(".#3D.%s\n",.path);#0A
..2path.#3D.getenv(hdrsvar);#0A..2PRINTFS("Environm
ent.variable.%s",.hdrsvar);#0A..2PRINTFS(".#3D.%s\n
",.path);#0A..2path.#3D.getenv(scriptsvar);#0A..2PR
INTFS("Environment.variable.%s",.scriptsvar);#0A..2
PRINTFS(".#3D.%s\n",.path);#0A..}#0A#0A..stackbase.
#3D.getvec(Stackupb+6);../*.+6.because.it.will.be.a
.coroutine.*/#0A..globbase..#3D.getvec(Globupb);#0A
..result2.#3D.0L;#0A#0A..if.(boottrace>0).PRINTF("B
oot's.stack.allocated.at.%".FormD."\n",.stackbase);
#0A#0A..W[stackbase].#3D.Stackupb;./*.Tell.boot.how
.large.its.stack.is#2E.*/#0A..for(i#3D1;.i<#3DStack
upb+6;.i++).W[stackbase+i].#3D.0xABCD1234;#0A../*.b
oot.will.turn.this.stack.into.a.coroutine.stack.*/#0A
#0A..if.(boottrace>0)#0A..2PRINTF("Boot's.global.ve
ctor.allocated.at.%".FormD."\n",.globbase);#0A#0A..
for(i.#3D.0;.i<#3DGlobupb;.i++).W[globbase+i].#3D.G
lobword+i;#0A..W[globbase+Gn_globsize].#3D.Globupb;
#0A..W[globbase+Gn_rootnode].#3D.rootnode;#0A#0A..f
or(i#3D0;.i<#3DRtn_upb;.i++).W[rootnode+i].#3D.0;#0A
#0A..W[rootnode+Rtn_membase]..4#3D.0;#0A..W[rootnod
e+Rtn_memsize]..4#3D.memupb;#0A..W[rootnode+Rtn_blk
list]..4#3D.0;#0A..W[rootnode+Rtn_tallyv]..5#3D.tal
lyvec;#0A..W[rootnode+Rtn_vecstatsv]..2#3D.vecstats
vec;#0A..W[rootnode+Rtn_vecstatsvupb].#3D.vecstatsv
upb;#0A..W[rootnode+Rtn_boottrace]..2#3D.(BCPLWORD)
.boottrace;#0A..W[rootnode+Rtn_dumpflag]..3#3D.dump
flag;#0A..{.//.This.fudge.is.for.systems.where.the.
size.of.BCPLWORD#0A..2//.and.BCPLWORD*.are.differen
t#2E.The.fields.mc1.to.mc3.are#0A..2//.only.used.by
.the.MC.package#0A..2union.{.BCPLWORD.*p;#0A..10BCP
LWORD.v[2];}.pv;#0A..2union.{.BCPLWORD.(*f)(char*,.
BCPLWORD);#0A..10BCPLWORD.v[2];}.fv;#0A..2pv#2Ev[0]
.#3D.pv#2Ev[1].#3D.0;#0A..2pv#2Ep.#3D.W;..13/*.Cint
code.memory.*/#0A..2W[rootnode+Rtn_mc0]..8#3D.pv#2E
v[0];#0A..2W[rootnode+Rtn_mc1]..8#3D.pv#2Ev[1];#0A.
.2fv#2Ev[0].#3D.fv#2Ev[1].#3D.0;#0A..2fv#2Ef.#3D.mc
prf;..9/*.The.MC.prf.fn.*/#0A..2W[rootnode+Rtn_mc2]
..8#3D.fv#2Ev[0];#0A..2W[rootnode+Rtn_mc3]..8#3D.fv
#2Ev[1];#0A..}#0A..W[rootnode+Rtn_rootvar]..4#3D.ro
otvarstr;#0A..W[rootnode+Rtn_pathvar]..4#3D.pathvar
str;#0A..W[rootnode+Rtn_hdrsvar]..4#3D.hdrsvarstr;#0A
..W[rootnode+Rtn_scriptsvar]..1#3D.scriptsvarstr;#0A
#0A..W[rootnode+Rtn_dcountv]..4#3D.dcountv;#0A#0A..
if.(boottrace>0).PRINTF("Rootnode.allocated.at.%".F
ormD."\n",.rootnode);#0A#0A..if.(boottrace>0).PRINT
F("Loading.all.resident.programs.and.libraries\n");
#0A#0A..{.BCPLWORD.seg.#3D.loadseg("syscin/boot");#0A
..2if(seg#3D#3D0000).{#0A..4PRINTF("\nUnable.to.fin
d.syscin/boot\n");#0A..4PRINTF("This.is.probably.ca
used.by.incorrect.settings.of\n");#0A..4PRINTF("env
ironment.variables.such.as.BCPLROOT.and.BCPLPATH\n"
);#0A..4PRINTF("Try.entering.cintsys.using.the.comm
and\n");#0A..4PRINTF("\ncintsys.-f.-v\n\n");#0A..4P
RINTF("to.see.what.is.happening\n");#0A..4return.20
;#0A..2}#0A..2W[rootnode+Rtn_boot].#3D.globin(seg,.
globbase);#0A..2if(W[rootnode+Rtn_boot]#3D#3D0000).
{#0A..4PRINTF("Can't.globin.boot\n");#0A..4return.2
0;#0A..2}#0A#0A..2if.(boottrace>0).PRINTF("syscin/b
oot.loaded.successfully\n");#0A#0A..2seg.#3D.loadse
g("syscin/blib");#0A..2if(seg#3D#3D0000).{.PRINTF("
Can't.load.syscin/blib\n");.return.20;.}#0A..2if.(b
oottrace>0).PRINTF("syscin/blib.loaded.successfully
\n");#0A#0A..2seg.#3D.concatsegs(seg,.loadseg("sysc
in/syslib"));#0A..2if(seg#3D#3D0000).{.PRINTF("Can'
t.load.syscin/syslib\n");.return.20;.}#0A..2if.(boo
ttrace>0).PRINTF("syscin/syslib.loaded.successfully
\n");#0A#0A..2seg.#3D.concatsegs(seg,.loadseg("sysc
in/dlib"));#0A..2if(seg#3D#3D0000).{.PRINTF("Can't.
load.syscin/dlib\n");.return.20;.}#0A..2if.(boottra
ce>0).PRINTF("syscin/dlib.loaded.successfully\n");#0A
#0A..2W[rootnode+Rtn_blib].#3D.globin(seg,.globbase
);#0A..2if(W[rootnode+Rtn_blib]#3D#3D0000).{#0A..4P
RINTF("Can't.globin.{blib,syslib,dlib}\n");#0A..4re
turn.20;#0A..2}#0A..}#0A#0A#23ifndef.forWinCE#0A../
*.Set.handler.for.CTRL-C.*/#0A..old_inthandler..#3D
.signal(SIGINT,.inthandler);./*.To.catch.CTRL-C.*/#0A
../*.Set.handler.for.segment.violation.*/#0A..old_s
egvhandler..#3D.signal(SIGSEGV,.segvhandler);./*.To
.catch.segv.*/#0A#23endif#0A#0A../*.Make.sys.availa
ble.via.the.root.node.*/#0A..W[rootnode+Rtn_sys].#3D
.W[globbase+Gn_sys];#0A#0A../*#0A..boot.has.no.coro
utine.environment#2E..Note.that.boot's.global.vecto
r.is.also#0A..used.by.interrupt.service.routines#2E
.The.chain.of.stack.frames.in.such.an#0A..environme
nt.must.be.terminated.by.a.zero.link.(for.DEBUG.to.
work.properly)#2E#0A..*/#0A..W[globbase+Gn_currco].
#3D.0;#0A..W[globbase+Gn_colist].#3D.0;#0A#0A../*.S
et.the.boot.registers.ready.for.the.Cintcode.interp
reter.*/#0A#0A..W[bootregs+0].#3D.0;..14/*.A.*/#0A.
.W[bootregs+1].#3D.0;..14/*.B.*/#0A..W[bootregs+2].
#3D.0;..14/*.C.*/#0A..W[bootregs+3].#3D.stackbase<<
B2Wsh;./*.P.*/#0A..W[bootregs+4].#3D.globbase<<B2Ws
h;../*.G.*/#0A..W[bootregs+5].#3D.2;..14/*.ST.--.in
.boot,.interrupts.disabled.*/#0A..W[bootregs+6].#3D
.W[globbase+1];..2/*.PC.(start.in.boot).*/#0A..W[bo
otregs+7].#3D.-1;..13/*.Count.*/#0A..W[bootregs+8].
#3D.0;..14/*.MW.*/#0A#0A../*.A.debbugging.aid!!.*/#0A
../*.tracing.#3D.1;.*/#0A#0A..init_keyb();#0A../*.C
all.the.slow.interpreter.even.though.Count#3D-1.*/#0A
..if.(boottrace>0).PRINTF("Calling.the.interpreter\
n");#0A..if.(boottrace>1)#0A..{.PRINTF("Turning.ins
truction.tracing.on\n");#0A..2tracing.#3D.1;#0A..}#0A
#0A..res.#3D.interpret(bootregs,.W);#0A..if.(boottr
ace>0)#0A..2PRINTFD("interpreter.returned.control.t
o.cintsys,.res#3D%".FormD."\n",.res);#0A#0A..close_
keyb();#0A#0A..if.(res).{#0A..2PRINTFD("\nExecution
.finished,.return.code.%".FormD"\n",.res);#0A#0A..2
if.(res.&&.W[rootnode+Rtn_dumpflag]).{#0A..4dumpmem
(W,.memupb,.3);#0A..4PRINTF("\nCintpos.memory.dumpe
d.to.DUMP#2Emem,.context#3D3\n");#0A..2}#0A..}#0A..
PRINTF("\n");#0A../*Change.suggested.by.Dave.Lewis.
-.return.cli_returncode.rather.than.res.*/#0A..retu
rn.W[globbase+Gn_cli_returncode];./*.MR.17/01/06.*/
#0A../*return.res;.*/#0A}#0A#0ABCPLWORD.concatsegs(
BCPLWORD.seg1,.BCPLWORD.seg2).{#0A..BCPLWORD.p.#3D.
seg1;#0A..if(p#3D#3D0000.||.seg2#3D#3D0000).return.
0;#0A..while(W[p]).p.#3D.W[p];#0A../*PRINTFD("conca
tsegs:.seg1.%".FormD".",.seg1);.*/#0A../*PRINTFD("s
eg2.%".FormD.".",.seg2);.*/#0A../*PRINTFD("p.%".For
mD."\n",.p);.*/#0A..W[p].#3D.seg2;#0A..return.seg1;
#0A}#0A#0ABCPLWORD.loadsegfp(FILEPT.fp)#0A{.BCPLWOR
D.list..#3D.0;#0A..BCPLWORD.liste.#3D.0;#0A#0A..for
(;;)#0A..{.BCPLWORD.type.#3D.rdhex(fp);#0A..2/*PRIN
TFD("loadsegtype.#3D.%".FormD."\n",.type);.*/#0A..2
switch((int)type)#0A..2{.default:#0A..8err:..1unloa
dseg(list);#0A..15list.#3D.0;#0A..4case.-1:..1#0A..
15return.list;#0A#09#09.#0A..4case.T_hunk:#0A..13{.
BCPLWORD.i,.n#3Drdhex(fp);#0A..15BCPLWORD.space.#3D
.getvec(n);#0A#09#09./*PRINTFD("loading.hunk.size.%
".FormD.".",.n);.*/#0A#09#09./*PRINTFD("to.%".FormD
."\n",.space);.*/#0A..15if(space#3D#3D0000).goto.er
r;#0A..15W[space].#3D.0;#0A..15for(i.#3D.1;.i<#3Dn;
.i++).W[space+i].#3D.rdhex(fp);#0A..15if(list#3D#3D
0000).list#3Dspace;#0A..15else.W[liste].#3D.space;#0A
..15liste.#3D.space;#0A..15continue;#0A..13}#0A#09#09
.#0A..4case.T_bhunk:./*.For.hunks.in.binary.(not.he
x).*/#0A..14{.BCPLWORD.n;#0A..16BCPLWORD.space;#0A.
.16int.len.#3D.fread((char.*)&n,.(size_t)4,.(size_t
)1,.fp);#0A..16if.(len!#3D1.&&.len!#3D4).goto.err;#0A
..16space.#3D.getvec(n);#0A..16if(space#3D#3D0000).
goto.err;#0A..16W[space].#3D.0;#0A..16len.#3D.fread
((char.*)&W[space+1],.(size_t)4,.(size_t)n,.fp);#0A
..16if.(len!#3Dn.&&.len!#3D4*n).goto.err;#0A..16if(
list#3D#3D0000).list#3Dspace;#0A..16else.W[liste].#3D
.space;#0A..16liste.#3D.space;#0A..16continue;#0A..
14}#0A#09#09.#0A..4case.T_end:#0A#09..8break;#0A..2
}#09#09.#0A..}#09#09.#0A}.#09#09.#0A#0ABCPLWORD.loa
dseg(char.*file)#0A{.BCPLWORD.list..#3D.0;#0A..BCPL
WORD.liste.#3D.0;#0A#0A..//PRINTF("loadseg:.attempt
ing.to.load.file.%s\n",.file);#0A#0A..//.First.look
.in.the.current.directory#0A..FILEPT.fp.#3D.pathinp
ut(file,.0);#0A#0A..if.(fp)#0A..{.list.#3D.loadsegf
p(fp);#0A..2fclose(fp);#0A..2if.(list).return.list;
#0A..2fp.#3D.0;#0A..}#0A.#0A..//.The.module.was.not
.found.in.the.current.directory.or.it#0A..//.was.in
valid.so.look.in.the.directories.specified.by.the.e
nvironment#0A..//.variable.whose.name.is.in.the.pat
hvar.entry.of.the.rootnode#2E#0A..if(fp#3D#3DNULL).
{#0A..2char.envname[256];#0A..2fp.#3D.pathinput(fil
e,.b2c_str(W[rootnode+Rtn_pathvar],.envname));#0A..
}#0A#0A..//if(fp#3D#3DNULL).{#0A..//..char.chbuf[25
6];#0A..//../*.It.was.not.found.in.the.BCPLPATH.dir
ectories.so.*/#0A..//../*.look.in.<BCPLROOT>/cin,.i
e.preprend.cin/.to.file.*/#0A..//../*PRINTFS("loads
eg:.searching.for.%s.in.$BCPLROOT/cin\n",.file);.*/
#0A..//..fp.#3D.pathinput(catstr2c_str("cin/",.file
,.chbuf),."BCPLROOT");#0A..//}#0A..if(fp#3D#3DNULL)
.return.0;#0A#0A..list.#3D.loadsegfp(fp);#0A..fclos
e(fp);#0A..return.list;#0A}#0A#0Avoid.unloadseg(BCP
LWORD.segl)#0A{.while(segl).{.BCPLWORD.s.#3D.W[segl
];#0A..14freevec(segl);#0A..14segl.#3D.s;#0A..12}#0A
}#0A#0A/*.rdhex.reads.in.one.hex.number.including.t
he.terminating.character#0A..1and.returns.its.BCPLW
ORD.value#2E.EOF.returns.-1#2E#0A*/#0ABCPLWORD.rdhe
x(FILEPT.fp)#0A{..BCPLWORD.w.#3D.0;#0A..1int.ch.#3D
.fgetc(fp);#0A#0A..1while(ch#3D#3D'.'.||.ch#3D#3D'\
n'.||.ch#3D#3D'\r').ch.#3D.fgetc(fp);#0A#0A..1if.(c
h#3D#3D'#23').{./*.remove.comments.from.object.modu
les.*/#0A..16while.(ch.!#3D.'\n'.&&.ch.!#3D.EOF).ch
.#3D.fgetc(fp);#0A..16return.rdhex(fp);#0A..14}#0A#0A
..1for(;;)#0A..1{..int.d.#3D.100;#0A..4if('0'<#3Dch
.&&.ch<#3D'9').d.#3D.ch-'0';#0A..4if('A'<#3Dch.&&.c
h<#3D'F').d.#3D.ch-'A'+10;#0A..4if('a'<#3Dch.&&.ch<
#3D'f').d.#3D.ch-'a'+10;#0A#09#09.#0A..4if(d#3D#3D0
00100).return.ch#3D#3DEOF.?.-1.:.w;#0A..4w.#3D.(w<<
0004).|.d;#0A..4ch.#3D.fgetc(fp);#0A..1}#09#09.#0A}
#09#09.#0A#09#09.#0ABCPLWORD.globin(BCPLWORD.segl,.
BCPLWORD.g)#0A{.BCPLWORD..a.#3D.segl,.globsize.#3D.
W[g];#0A../*PRINTFD("globin.segl.#3D.%6".FormD"..",
.segl);.*/#0A../*PRINTFD("g.#3D.%6".FormD."\n",.g);
.*/#0A..while.(a).{.BCPLWORD.base.#3D.(a+1)<<B2Wsh;
#0A..12BCPLWORD.i.#3D.a.+.W[a+1];#0A..12if.(W[i]>gl
obsize).return.0;#0A#09..4/*PRINTFD("globin:..base.
%6".FormD."..",.a+1);.*/.#0A#09..4/*PRINTFD("to.%6"
.FormD."..",.i);.*/#0A#09..4/*PRINTFD("size:.%5".Fo
rmD."\n",.W[a+1]);.*/.#0A..12for(;;).{.i.-#3D.2;#0A
..22if.(W[i+1]#3D#3D0000).break;#0A..22W[g+W[i]].#3D
.base.+.W[i+1];#0A#09#091/*PRINTFD("globin:..g[%3".
FormD."].",.W[i]);..*/#0A#09#091/*PRINTFD("#3D.%6".
FormD."\n",.base+W[i+1]);.*/#0A..20}#0A..12a.#3D.W[
a];#0A..10}#0A..return.segl;#0A}#0A#0ABCPLWORD.getv
ec(BCPLWORD.requpb)#0A{.BCPLWORD.upb.#3D.requpb+4+4
;../*.Allocate.4.words.at.the.end.for.safety.*/#0A.
.28/*.plus.4.words.of.task.name#2E.*/#0A..BCPLWORD.
p;#0A..BCPLWORD.q.#3D.0;./*.The.start.of.the.block.
list.*/#0A..BCPLWORD.n.#3D.(upb+1+1+1).&.0xFF5E;../
*.Add.1.word.for.size.and.alloc.bit#0A..40and.1.wor
d.for.word.zero.and#0A..40then.round.up.to.an.even.
size.*/#0A..#0A..do#0A..{.p.#3D.q;#0A..2for(;;).{.B
CPLWORD.size.#3D.W[p];#0A..12if((size&1).!#3D.0).br
eak;#0A..12if(.size.#3D#3D.0)..2return.0;#0A..12p.+
#3D.size;#0A..10}#0A..2q.#3D.p;../*.find.next.used.
block.*/#0A..2for(;;).{.BCPLWORD.size.#3D.W[q];#0A.
.12if((size&1).#3D#3D.0).break;#0A..12q.+#3D.size-1
;#0A..10}#0A..}.while(q-p<n);#0A..#0A..if(p+n!#3Dq)
#0A..2W[p+n].#3D.q-p-n+1;./*.If.splitting,.the.size
.of.the.other.part.with.a#0A..23flag.of.1.indicatin
g.that.it.is.free.*/#0A..W[p].#3D.n;..9/*.The.size.
of.this.block.in.words.with.a.flag.of.zero#0A..23in
dicating.that.it.is.allocated.*/#0A../*.The.followi
ng.improves.the.safety.of.memory.allocation.*/#0A..
/*.by.adding.some.checkable.redundancy.*/#0A..W[p+n
-9].#3D.0xCC6;../*.Funny.pattern.for.possible.round
up.word.*/#0A..W[p+n-8].#3D.0x556;../*.Special.patt
erns.*/#0A..W[p+n-7].#3D.0xAA6;#0A..W[p+n-6].#3D.re
qupb;..4/*.The.requested.upb.*/#0A#0A..W[p+n-5].#3D
.taskname[0];./*.The.taskname,.if.any.*/#0A..W[p+n-
4].#3D.taskname[1];./*.The.taskname,.if.any.*/#0A..
W[p+n-3].#3D.taskname[2];./*.The.taskname,.if.any.*
/#0A..W[p+n-2].#3D.taskname[3];./*.The.taskname,.if
.any.*/#0A#0A..W[p+n-1].#3D.p;..9/*.Pointer.to.base
.of.this.memory.block.*/#0A../*PRINTFD("getvec:.all
ocating.block.%6".FormD."..",.p);.*/#0A../*PRINTFD(
"upb.%4".FormD."\n",.upb);.*/#0A#0A..if(requpb>vecs
tatsvupb).requpb.#3D.vecstatsvupb;#0A..W[vecstatsve
c+requpb]++;#0A..return.p+1;#0A}#0A#0ABCPLWORD.free
vec(BCPLWORD.p)#0A{.BCPLWORD.res.#3D.-1;../*.#3DTRU
E.*/#0A..BCPLWORD.n,.upb;#0A#0A..if(p#3D#3D0000).re
turn.res;#0A#0A..p--;..5/*.All.getvec'ed.blocks.sta
rt.on.odd.addresses.*/#0A..n.#3D.W[p];#0A#0A..if(n.
&.1).{#0A..2PRINTFD("\n#23#232.freevec:.block.at.%"
.FormD.".already.free\n",.p);#0A..2return.0;#0A..}#0A
#0A../*PRINTFD("#23#232.freevec:.Freeing.block.at.%
".FormD."\n",.p);.*/#0A#0A..if(W[p+n-1]!#3Dp.||#0A.
.3W[p+n-7]!#3D0xAA6.||#0A..3W[p+n-8]!#3D0x556).{#0A
..5PRINTFD("\n#23#232.freevec:.block.at.%".FormD.".
",.p);#0A..5PRINTFD("size.%".FormD.".corrupted",.n)
;#0A..5PRINTFD("\n#23#232.freevec:.last.4.words.%8"
.FormX.".",.(UBCPLWORD)W[p+n-8]);#0A..5PRINTFD("%8"
.FormX.".",..28(UBCPLWORD)W[p+n-7]);#0A..5PRINTFD("
%6".FormD.".",..28W[p+n-6]);#0A..5PRINTFD("%7".Form
D."\n",..27W[p+n-1]);#0A..5PRINTFD("#23#232.freevec
:.should.be..002556.AA6.requpb.%7".FormD."\n\n",#0A
..14p);#0A..5res.#3D.0;#0A..}#0A..W[p].|#3D.1;#0A..
/*.Deal.with.getvec.allocation.statistics.*/#0A..up
b.#3D.W[p+n-6];..5/*.The.requested.size.*/#0A..if(u
pb>vecstatsvupb).upb.#3D.vecstatsvupb;#0A..W[vecsta
tsvec+upb]--;./*.Decrement.count.of.block.of.this.s
ize.*/#0A..return.res;#0A}#0A#0ABCPLWORD.muldiv(BCP
LWORD.a,.BCPLWORD.b,.BCPLWORD.c)#0A{.//.This.versio
n.produces.the.same.results.as.muldiv1#0A..//.and.s
eem.to.run.about.60%.faster#2E#0A..//.It.is.used.by
.the.MDIV.instruction.(and.the.syslib.muldiv.functi
on)#2E#0A..BCPLINT64.ab.#3D.(BCPLINT64)a.*.(BCPLINT
64)b;#0A..if(c#3D#3D0000).c#3D1;#0A..result2.#3D.(B
CPLWORD)(ab.%.c);#0A..return.(BCPLWORD)(ab./.c);#0A
}#0A#0ABCPLWORD.muldiv1(BCPLWORD.a,.BCPLWORD.b,.BCP
LWORD.c)#0A{.//.This.is.used.by.sys(Sys_muldiv,#2E#2E
1)#0A..unsigned.BCPLWORD.q#3D0,.r#3D0,.qn,.rn;#0A..
unsigned.BCPLWORD.ua,.ub,.uc;#0A..int.qneg#3D0,.rne
g#3D0;#0A..if(c#3D#3D0000).c#3D1;#0A..if(a<0).{.qne
g#3D!qneg;.rneg#3D!rneg;.ua.#3D.-a;.}#0A..else..28u
a.#3D..a;#0A..if(b<0).{.qneg#3D!qneg;.rneg#3D!rneg;
.ub.#3D.-b;.}#0A..else..28ub.#3D..b;#0A..if(c<0).{.
qneg#3D!qneg;..11uc.#3D.-c;.}#0A..else..28uc.#3D..c
;#0A..#0A..qn.#3D.ub./.uc;#0A..rn.#3D.ub.%.uc;#0A..
#0A..while(ua)#0A..{.if(ua&1).{.q.+#3D.qn;#0A..13r.
+#3D.rn;#0A..13if(r>#3Duc).{.q++;.r.-#3D.uc;.}#0A..
11}#0A..2ua.>>#3D.1;#0A..2qn.<<#3D.1;#0A..2rn.<<#3D
.1;#0A..2if(rn>#3Duc).{.qn++;.rn.-#3D.uc;.}#0A..}#0A
..result2.#3D.rneg.?.-(BCPLWORD)r.:.r;#0A..return..
2qneg.?.-(BCPLWORD)q.:.q;#0A}#0A#0Aint.relfilename(
char.*name).{#0A/*#0Aname.is.a.C.string.representin
g.a.Cintsys/Cintpos.file.name#2E#0AIf.it.starts.wit
h.'/'.(or.'\').or.contains.a.colon.':',.it#0Arepres
ents.an.absolute.file.name.otherwise.it.is.relative
#2E#0AThis.function.returns#0A..0010.if.absolute,#0A
..0011.if.relative#2E#0A*/#0A..if(name[0]#3D#3D'/'.
||.name[0]#3D#3D'\\').return.0;#0A..while(*name).if
(*name++#3D#3D':').return.0;#0A..return.1;.#0A}#0A#0A
/*.pathinput.does.not.use.any.of.chbuf1,.chbuf2.or.
chbuf3#2E.*/#0AFILEPT.pathinput(char.*name,.char.*p
athname)#0A/*.name.is.a.Linux.style.filename.using.
'/'.(not.'\').as.the.separator#2E#0A..1If.pathname.
is.null,.name.is.looked.up.in.the.current.directory
,#0A..1otherwise.name.is.looked.up.in.the.directori
es.that.the.environment#0A..1variable.pathname.spec
ifies#2E.These.directories.should.now.be.separated.
#0A..1by.';'.(nor.':').even.under.Linux.or.Cygwin#2E
#0A*/#0A{.FILEPT.fp.#3D.0;#0A#0A..if.(.pathname#3D#3D
0000.||.!relfilename(name)).{#0A..2/*.If.no.pathnam
e.given.or.name.is.absolute.just.search.the.current
.directory.*/#0A..2//printf("pathinput:.pathname#3D
0\n");#0A..2fp.#3D.fopen(osfname(name,.chbuf4),."rb
");#0A..2if(filetracing)#0A..2{.PRINTFS("Trying:.%s
.in.the.current.directory.-.",.name);#0A..4if(fp).{
#0A..6PRINTF("found\n");#0A..4}.else.{#0A..6PRINTF(
"not.found\n");#0A..4}#0A..2}#0A..2return.fp;#0A..}
#0A#0A..//printf("pathinput:.pathname#3D%s\n",.path
name);#0A#0A../*.Look.through.the.PATH.directories.
if.pathname.is.given#2E.*/#0A..{.char.*path.#3D.get
env(pathname);#0A.#0A..2if(filetracing).{#0A..4PRIN
TFS("pathinput:.attempting.to.open.%s",.name);#0A..
4PRINTFS(".using\n..%s",.pathname);#0A..4PRINTFS(".
#3D.%s\n",.path);#0A..2}#0A#0A..2/*.Try.prefixing.w
ith.each.directory.in.the.path.until.the#0A..5file.
can.be.openned.successfully.*/#0A..2while(path)#0A.
.2{.char.str[256];#0A..4char.*filename.#3D.&str[0];
#0A..4char.*f#3Dfilename;#0A..4char.*n#3Dname;#0A..
4char.lastch#3D0;#0A..4//.f.points.to.the.next.char
acter.of.constructed.filename#0A..4//.n.points.to.t
he.next.character.of.name#0A#0A..4//.Prefix.the.nex
t.directory.name.after.skipping.over#0A..4//.a.sepa
rator,.if.necessary#2E#0A..4while(1)#0A..4{.char.ch
.#3D.*path;#0A..6if(ch#3D#3D';').{.path++;.continue
;.}#0A#23ifndef.WINNAMES#0A..6if(ch#3D#3D':').{.pat
h++;.continue;.}#0A#23endif#0A..6break;#0A..4}#0A..
4if(*path#3D#3D0000).break;#0A..4/*.Copy.the.direct
ory.name.into.filename.*/#0A..4while(1)#0A..4{.char
.ch.#3D.*path;#0A..6if(ch#3D#3D0000).break;#0A..6pa
th++;#0A..6if(ch#3D#3D';').break;#0A#23ifndef.WINNA
MES#0A#09if(ch#3D#3D':').break;#0A#23endif#0A..6*f+
+.#3D.ch;#0A..6lastch.#3D.ch;#0A..4}#0A..4/*.Insert
.a.filename.'/'.if.necessary#2E.*/#0A..4if(lastch!#3D
'/'.&&.lastch!#3D'\\').*f++.#3D.'/';#0A#0A..4/*.App
end.the.given.file.name.*/#0A..4while(1)#0A..4{.cha
r.ch.#3D.*n++;#0A..6*f++.#3D.ch;#0A..6if(ch#3D#3D00
00).break;#0A..4}#0A#0A..4fp.#3D.fopen(osfname(file
name,.chbuf4),."rb");#0A..4if(filetracing)#0A..4{.P
RINTFS("Trying:.%s.-.",.filename);#0A..6if(fp).{#0A
..8PRINTF("found\n");#0A#09}.else.{#0A..8PRINTF("no
t.found\n");#0A#09}#0A..4}#0A..4if(fp).return.fp;#0A
..4//.Try.using.the.next.directory.in.the.path#0A..
2}#0A..2//.Not.found.in.any.of.the.path.directories
.so.look.in.the#0A..2//.current.directory#0A#0A..2f
p.#3D.fopen(osfname(name,.chbuf4),."rb");#0A..2if(f
iletracing)#0A..2{.PRINTFS("Trying:.%s.in.the.curre
nt.directory.-.",.name);#0A..4if(fp).{#0A..6PRINTF(
"found\n");#0A..4}.else.{#0A..6PRINTF("not.found\n"
);#0A..4}#0A..2}#0A..2return.fp;#0A..}#0A}#0A#0ABCP
LWORD.dosys(register.BCPLWORD.p,.register.BCPLWORD.
g)#0A{.register.BCPLWORD.i;#0A../*PRINTFD("dosys(%"
.FormD.",.",.p);.*/#0A../*PRINTFD("%".FormD,.g);.*/
#0A../*PINTFD(").P3#3D%".FormD.".",.W[p+3]);.*/#0A.
./*PRINTFD("P4#3D%".FormD."\n",..W[p+4]);.*/#0A..sw
itch((int)(W[p+3]))#0A..{.default:.PRINTFD("\nBad.s
ys.number:.%".FormD."\n",.W[p+3]);#0A..11return.W[p
+3];#0A#0A..2/*.case.Sys_setcount:.set.count..13--.
done.in.cinterp#0A..2**.case.Sys_quit:..3return.fro
m.interpreter.--.done.in.cinterp#0A#0A..2**.case.Sy
s_rti:..4sys(Sys_rti,.regs)..4--.done.in.cinterp..C
intpos#0A..2**.case.Sys_saveregs:.sys(Sys_saveregs,
.regs).--.done.in.cinterp..Cintpos#0A..2**.case.Sys
_setst:..2sys(Sys_setst,.st)..4--.done.in.cinterp..
Cintpos#0A..2*/#0A..2case.Sys_tracing:../*.sys(Sys_
tracing,.b).*/#0A..10tracing.#3D.W[p+4];#0A..10retu
rn.0;#0A..2/*.case.Sys_watch:..2sys(Sys_watch,.addr
)..2--.done.in.cinterp#0A..2*/#0A#0A..2case..Sys_ta
lly:..7/*.sys(Sys_tally,.flag)..3*/#0A..11if(W[p+4]
).{#0A..14tallylim.#3D.tallyupb;#0A..14for(i#3D1;.i
<#3Dtallylim;.i++).tallyv[i].#3D.0;#0A..12}.else.{#0A
..14tallylim.#3D.0;#0A..12}#0A..12return.0;#0A..3#0A
..2case.Sys_interpret:./*.call.interpreter.(recursi
vely).*/#0A..10{.BCPLWORD.regsv.#3D.W[p+4];#0A..12i
f(W[regsv+7]>#3D0.||.slowflag).return.interpret(reg
sv,.W);#0A..12return.CINTASM..(regsv,.W);#0A..10}#0A
#0A..2case.Sys_sardch:#0A..12{.int.ch;#0A#0A..14if.
(inbuf).{#0A..16/*.Input.taken.from.command.line.*/
#0A..16ch.#3D.inbuf_next();#0A..16if.(ch.#3D#3D.EOF
).{./*.inbuf.is.now.empty.*/#0A..18if.(reattach_std
in).{#0A..20free(inbuf);#0A..20inbuf.#3D.0;./*.Don'
t.try.to.read.more.characters.*/#0A#09#09..15/*.fro
m.the.buffer.*/#0A..20/*.Continue.with.normal.read.
from.stdin.*/#0A..18}.else.{#0A..20return.ch;./*.EO
F.*/#0A..18}#0A..16}.else.{#0A..18return.ch;./*.val
id.character.*/#0A..16}#0A..14}#0A..14/*.Normal.cas
e,.stdin.input.to.interpreter.*/#0A#0A..14ch.#3D.Re
adch();./*.get.the.keyboard.character..*/#0A#09#09/
*PRINTFD("Sys_sardch:.ch.#3D.%d\n",.ch);.*/#0A#09#09
if(ch#3D#3D000127)./*.RUBOUT.from.the.keyboard.*/#0A
#09#09..ch.#3D.8;..1/*.Replace.by.BS.*/#0A..14if.(c
h>#3D0).putchar(ch);#0A..14if(ch#3D#3D00013).{.ch.#3D
.10;.putchar(10);.}#0A..14fflush(stdout);#0A#09#09/
*PRINTFD("Sys_sardch.returning.ch.#3D.%d\n",.ch);.*
/#0A..14//incdcount(1);#0A..14return.ch;#0A..12}#0A
#0A..2case.Sys_sawrch:#0A#23ifdef.forCYGWIN32#0A..1
2if(W[p+4].#3D#3D.10).putchar(13);#0A#23endif#0A..1
2putchar((char)W[p+4]);#0A..12fflush(stdout);#0A..1
2//incdcount(2);#0A..12return.0;#0A#0A..2case.Sys_r
ead:../*.bytesread.:#3D.sys(Sys_read,.fp,.buf,.byte
count).*/#0A..12{.FILEPT.fp.#3D.findfp(W[p+4]);#0A.
.14BCPLWORD.bbuf.#3D.W[p+5]<<B2Wsh;#0A..14BCPLWORD.
len..1#3D.(int).W[p+6];#0A#23ifndef.forWinCE#0A..14
clearerr(fp);./*.clear.eof.and.error.flag.*/#0A#23e
ndif#0A..14len.#3D.fread(&(BP.W)[bbuf],.(size_t)1,.
(size_t)len,.fp);#0A#23ifndef.forWinCE#0A..14if(fer
ror(fp)).{.perror("sys_read");#0A..31return.-1;./*.
check.for.errors.*/#0A#09#09}#0A#23endif#0A..14retu
rn.len;#0A..12}#0A#0A..2case.Sys_write:#0A..4{.FILE
PT.fp.#3D.findfp(W[p+4]);#0A..6BCPLWORD.bbuf.#3D.W[
p+5]<<B2Wsh;#0A..6BCPLWORD.len.#3D.W[p+6];#0A..6/*f
seek(fp,.0L,.SEEK_CUR);.*/./*.Why??.MR.9/7/04.*/#0A
..6len.#3D.WD.fwrite(&(BP.W)[bbuf],.(size_t)1,.(siz
e_t)len,.fp);#0A..6fflush(fp);#0A..6return.len;#0A.
.4}#0A#0A..2case.Sys_openread:#0A..4{.char.*name.#3D
.b2c_str(W[p+4],.chbuf1);#0A..6FILEPT.fp;#0A..6fp.#3D
.pathinput(name,..20/*.Filename.*/#0A#09..13b2c_str
(W[p+5],.chbuf2));../*.Environment#0A#09..4#09#092.
.11variable.*/#0A..6if(fp#3D#3D0000).return.0L;#0A.
.6return.newfno(fp);#0A..4}#0A#0A..2case.Sys_openwr
ite:#0A..4{.char.*name.#3D.b2c_str(W[p+4],.chbuf1);
#0A..6FILEPT.fp;#0A..6fp.#3D.fopen(osfname(name,.ch
buf4),."wb");#0A..6if(fp#3D#3D0000).return.0L;#0A..
6return.newfno(fp);#0A..4}#0A#0A..2case.Sys_openapp
end:#0A..4{.char.*name.#3D.b2c_str(W[p+4],.chbuf1);
#0A..6FILEPT.fp;#0A..6fp.#3D.fopen(osfname(name,.ch
buf4),."ab");#0A..6if(fp#3D#3D0000).return.0L;#0A..
6return.newfno(fp);#0A..4}#0A#0A..2case.Sys_openrea
dwrite:#0A..4{.char.*name.#3D.b2c_str(W[p+4],.chbuf
1);#0A#09FILEPT.fp;#0A..6fp.#3D.fopen(osfname(name,
.chbuf4),."rb+");#0A..6if(fp#3D#3D0000).fp.#3D.fope
n(name,."wb+");#0A..6if(fp#3D#3D0000).return.0L;#0A
..6return.newfno(fp);#0A..4}#0A#0A..2case.Sys_close
:#0A..2{.BCPLWORD.res.#3D.fclose(findfp(W[p+4]));#0A
..4freefno(W[p+4]);#0A..4return.res#3D#3D0000.?.-1.
:.0;./*.res#3D#3D0000.means.success.*/#0A..2}#0A#0A
..2case.Sys_deletefile:#0A..2{.char.*name.#3D.b2c_s
tr(W[p+4],.chbuf1);#0A..4FILEPT.fp;#0A..4name.#3D.o
sfname(name,.chbuf4);#0A#23ifdef.VMSNAMES#0A..4{./*
.Append.';*'.to.name.*/#0A..6int.len.#3D.0;#0A..6wh
ile.(name[len]).len++;#0A..6name[len++].#3D.';';#0A
..6name[len++].#3D.'*';#0A..6name[len].#3D.0;#0A..4
}#0A#23endif#0A..4return.!.REMOVE(name);#0A..2}#0A#0A
..2case.Sys_renamefile:#0A..2{.char.*name1.#3D.b2c_
str(W[p+4],.chbuf1);#0A..4char.*name2.#3D.b2c_str(W
[p+5],.chbuf2);#0A..4int.len.#3D.0;#0A..4name1.#3D.
osfname(name1,.chbuf3);#0A..4name2.#3D.osfname(name
2,.chbuf4);#0A#23ifdef.VMSNAMES#0A..4{./*.Append.';
*'.to.name2.*/#0A..6len.#3D.0;#0A..6while.(name2[le
n]).len++;#0A..6name2[len]..1#3D.';';#0A..6name2[le
n+1].#3D.'*';#0A..6name2[len+2].#3D.0;#0A..4}#0A#23
endif#0A..4REMOVE(name2);#0A#23ifdef.VMSNAMES#0A..4
name2[len].#3D.0;#0A#23endif#0A..4return.!.rename(n
ame1,.name2);#0A..2}#0A#0A..2case.Sys_getvec:#0A..1
2{.BCPLWORD.tcb.#3D.W[rootnode+Rtn_crntask];#0A..14
BCPLWORD.*tn.#3D.&W[tcb+Tcb_namebase];#0A#09..6task
name[0].#3D.(tcb#3D#3D0000).?.0.:.tn[0];#0A#09..6ta
skname[1].#3D.(tcb#3D#3D0000).?.0.:.tn[1];#0A#09..6
taskname[2].#3D.(tcb#3D#3D0000).?.0.:.tn[2];#0A#09.
.6taskname[3].#3D.(tcb#3D#3D0000).?.0.:.tn[3];#0A..
14return.getvec(W[p+4]);#0A#09..4}#0A#0A..2case.Sys
_freevec:#0A..14return.freevec(W[p+4]);#0A#0A..2cas
e.Sys_loadseg:#0A..12{.BCPLWORD.tcb.#3D.W[rootnode+
Rtn_crntask];#0A..14BCPLWORD.*tn.#3D.&W[tcb+Tcb_nam
ebase];#0A..14char.*name.#3D.b2c_str(W[p+4],.chbuf2
);#0A#09..6taskname[0].#3D.(tcb#3D#3D0000).?.0.:.tn
[0];#0A#09..6taskname[1].#3D.(tcb#3D#3D0000).?.0.:.
tn[1];#0A#09..6taskname[2].#3D.(tcb#3D#3D0000).?.0.
:.tn[2];#0A#09..6taskname[3].#3D.(tcb#3D#3D0000).?.
0.:.tn[3];#0A..14return.loadseg(name);#0A#09..4}#0A
#0A..2case.Sys_globin:#0A..14return.globin(W[p+4],.
g);#0A#0A..2case.Sys_unloadseg:#0A..14unloadseg(W[p
+4]);..18return.0;#0A#0A..2case.Sys_muldiv:#0A..2{.
BCPLWORD.res.#3D..muldiv1(W[p+4],.W[p+5],.W[p+6]);#0A
..4W[g+Gn_result2].#3D.result2;#0A..4return.res;#0A
..2}#0A#0A..2case.Sys_intflag:#0A..4return.intflag(
).?.-1L.:.0L;#0A#0A..2case.Sys_setraster:#0A..4retu
rn.setraster(W[p+4],.W[p+5]);#0A#0A..2case.Sys_cput
ime:./*.Return.CPU.time.in.milliseconds..*/#0A..4re
turn.muldiv(clock(),.1001,.TICKS_PER_SEC);#0A#0A#23
ifndef.forWinCE#0A..2case.Sys_filemodtime:#0A..2/*.
sys(Sys_filemodtime,.filename,.datv)#0A..5Set.the.e
lements.of.datv.to.represent.the.date.and.time.of#0A
..5the.last.modification.of.the.given.file,.returni
ng.TRUE.if#0A..5successful.and.FALSE.otherwise#2E.d
atv!0.is.the.number.of.days#0A..5since.1.January.19
70,.datv!1.is.the.number.of.milli-seconds#0A..5sinc
e.midnight.and.datv!2#3D-1.indicating.that.the.new.
date.and#0A..5time.format.is.being.used#2E#0A..5If.
the.file.does.not.exist.or.there.is.an.error.then#0A
..5FALSE.is.returned.and.the.elements.of.datv.are.s
et.to.0,.0.and#0A..5-1,.respectively#2E#0A..2*/#0A.
.2{.struct.stat.buf;#0A..4BCPLWORD.days,.secs,.msec
s;#0A..4char.*name.#3D.b2c_str(W[p+4],.chbuf1);#0A.
.4BCPLWORD.datestamp.#3D.W[p+5];#0A..4if.(stat(osfn
ame(name,.chbuf4),.&buf)).{#0A..6W[datestamp]..1#3D
.0;#0A..6W[datestamp+1].#3D.0;#0A..6W[datestamp+2].
#3D.-1;#0A..6return.0;#0A..4}#0A..4secs.#3D.buf#2Es
t_mtime;#0A..4//.nsecs.#3D.buf#2Est_mtimensec;.//.n
ano.second.time,.if.poss#0A..4days.#3D.secs./.(24*6
0*60);#0A..4msecs.#3D.(secs.%.(24*60*60)).*.1001;#0A
..4W[datestamp].#3D.days;#0A..4W[datestamp+1].#3D.m
secs;#0A..4W[datestamp+2].#3D.-1;..//.New.dat.forma
t#0A..4//printf("filemodtime:.name#3D%s.days#3D%".F
ormD.".msecs#3D%".FormD."\n",#0A..4//..6name,.days,
.msecs);#0A..4return.-1;#0A..2}#0A#23endif#0A#0A..2
case.Sys_setprefix:./*.Set.the.file.name.prefix.str
ing..*/#0A..2{.BCPLWORD.str.#3D.W[p+4];#0A..4char.*
fp.#3D.(char*)(&W[str]);#0A..4char.*tp.#3D.(char*)(
&W[prefixstr]);#0A..4int.i,.len#3D*fp;#0A..4if(len>
63).return.0;#0A..4for.(i#3D0;.i<#3Dlen;.i++).*tp++
.#3D.*fp++;#0A..4return.prefixstr;#0A..2}#0A#0A..2c
ase.Sys_getprefix:./*.Return.the.file.name.prefix.s
tring..*/#0A..4return.prefixstr;#0A#0A..2case.Sys_g
raphics:./*.Perform.an.operation.on.the.graphics.wi
ndow..*/#0A..4return.sysGraphics(p);#0A#0A..2case.3
5:./*.Return.TRUE.if.no.keyboard.character.is.avail
able.*/#0A#23ifdef.forWinCE#0A..12return.chBufEmpty
().?.-1.:.0;#0A#23else#0A..12return.-1;#0A#23endif#0A
#0A..2case.36:..1return.0;./*.Spare.*/#0A#0A..2case
.37:..1return.0;./*.Spare..*/#0A#0A..2case.Sys_seek
:../*.res.:#3D.sys(Sys_seek,.fd,.pos)..1*/#0A..2{.F
ILEPT.fp.#3D.findfp(W[p+4]);#0A..4BCPLWORD.pos.#3D.
W[p+5];#0A..4BCPLWORD.res.#3D.fseek(fp,.pos,.SEEK_S
ET);#0A..4W[g+Gn_result2].#3D.errno;#0A..4/*PRINTFD
("fseek.pos#3D%".FormD.".",.pos);.*/#0A..4/*PRINTFD
("#3D>.res#3D%".FormD."\n",.res);.*/#0A..4/*PRINTFD
("errno#3D%d\n",.errno);.*/#0A..4return.res#3D#3D00
00.?.-1.:.0;./*.res#3D0.succ,.res#3D-1.error..*/#0A
..2}#0A#0A..2case.Sys_tell:./*.pos.:#3D.sys(Sys_tel
l,fd)..*/#0A..2{.FILEPT.fp.#3D.findfp(W[p+4]);#0A..
4BCPLWORD.pos.#3D.ftell(fp);#0A..4W[g+Gn_result2].#3D
.errno;#0A..4/*PRINTFD("tell.#3D>.%".FormD."\n",.po
s);.*/#0A..4return.pos;./*.>#3D0.succ,.-1#3Derror.*
/#0A..2}#0A#0A..2case.Sys_waitirq:./*.Wait.for.irq.
*/#0A..4/*#0A..4pthread_mutex_lock..(..7&irq_mutex)
;#0A..4pthread_cond_wait..1(&irq_cv,.&irq_mutex);#0A
..4pthread_mutex_unlock(..7&irq_mutex);#0A..4*/#0A.
.4return.0;#0A#0A..2case.Sys_lockirq:./*.Stop.all.d
evices.from.modifying.*/#0A..20/*.packets.or.genera
ting.interrupts.*/#0A..4/*#0A..4pthread_mutex_lock(
&irq_mutex);#0A..4*/#0A..4return.0;#0A#0A..2case.Sy
s_unlockirq:./*.Allow.devices.to.modify.packets.*/#0A
..22/*.and.generate.interrupts.*/#0A..4/*#0A..4pthr
ead_mutex_unlock(&irq_mutex);#0A..4*/#0A..4return.0
;#0A#0A..2case.Sys_devcom:./*.res.:#3D.sys(Sys_devc
om,.dcb,.com,.arg).*/#0A..4return.0;./*devcommand(W
[p+4],.W[p+5],.W[p+6]);.*/#0A#0A..2case.Sys_datstam
p:./*.res.:#3D.sys(Sys_datstamp,.v)..*/#0A..2//.Set
.v!0.#3D.days..since.1.January.1970#0A..2//..3v!1.#3D
.msecs.since.midnight#0A..2//..3v!2.#3D.ticks.#3D-1
.for.new.dat.format#0A..2//.Return.-1.if.successful
#0A..14return.timestamp(&W[W[p+4]]);#0A#0A..2case.S
ys_filesize:../*.res.:#3D.sys(Sys_filesize,.fd)..1*
/#0A..4{.FILEPT.fp..1#3D.findfp(W[p+4]);#0A..6long.
pos..#3D.ftell(fp);#0A..6BCPLWORD.rc..1#3D.fseek(fp
,.0,.SEEK_END);#0A..6BCPLWORD.size.#3D.ftell(fp);#0A
..6rc..#3D.fseek(fp,.pos,.SEEK_SET);#0A..6if.(rc).s
ize.#3D.-1;#0A..6return.size;./*.>#3D0.succ,.-1#3De
rror..*/#0A..4}#0A#0A..2case.Sys_getsysval:./*.res.
:#3D.sys(Sys_getsysval,.addr).*/#0A..12{.BCPLWORD.a
ddr.#3D.W[p+4];#0A..14return.W[addr];#0A..12}#0A#0A
..2case.Sys_putsysval:./*.res.:#3D.sys(Sys_putsysva
l,.addr,.val).*/#0A..12{.BCPLWORD.addr.#3D.W[p+4];#0A
..14W[addr].#3D.W[p+5];#0A..14return.0;#0A..12}#0A#0A
#23ifndef.forWinCE#0A..2case.Sys_shellcom:./*.res.:
#3D.sys(Sys_shellcom,.comstr).*/#0A..12{.BCPLWORD.c
omstr.#3D.W[p+4]<<B2Wsh;#0A#09..6int.i;#0A..14char.
com[256];#0A..14int.len.#3D.((char.*)W)[comstr];#0A
..14for(i#3D0;.i<len;.i++).com[i].#3D.((char.*)W)[c
omstr+i+1];#0A..14com[len].#3D.0;#0A#09#09/*PRINTFS
("\nmain:.calling.shell.command.%s\n",.com);.*/#0A.
.14return.system(com);#0A..12}#0A#23endif#0A#0A#23i
fndef.forWinCE#0A..2case.Sys_getpid:./*.res.:#3D.sy
s(Sys_getpid).*/#0A..14return.getpid();#0A#23endif#0A
#0A..2case.Sys_dumpmem:./*.sys(Sys_dumpmem,.context
).*/#0A..14dumpmem(W,.memupb,.W[p+4]);#0A..14PRINTF
D("\nMemory.dumped.to.DUMP#2Emem,.context#3D%".Form
D."\n",#0A..22W[p+4]);#0A..14return.0;#0A#0A..2case
.Sys_callnative:./*.res.:#3D.sys(Sys_callnative,.fn
,.a1,.a2,.a3).*/#0A..12{./*.Call.native.code#2E.*/#0A
..14union.{./*.To.allow.conversion.from.pointer.to.
function.*/#0A#09#09..BCPLWORD.*p;#0A#09#09..BCPLWO
RD(*f)(BCPLWORD,.BCPLWORD,.BCPLWORD);#0A..14}.func;
#0A#0A..14func#2Ep.#3D.&W[W[p+4]];#0A..14return.(fu
nc#2Ef)(W[p+5],W[p+6],W[p+7]);#0A..12}#0A#0A..2case
.Sys_platform:#0A..12{./*.Return.platform.code,.0.i
f.unknown.*/#0A#09#09BCPLWORD.res.#3D.0;#0A#23ifdef
.forMAC#0A#09#09res.#3D.1;#0A#23endif#0A#23ifdef.fo
rMIPS#0A#09#09res.#3D.2;#0A#23endif#0A#23ifdef.forS
GI#0A#09#09res.#3D.3;#0A#23endif#0A#23ifdef.forARM#0A
#09#09res.#3D.4;#0A#23endif#0A#23ifdef.forLINUX#0A#09
#09res.#3D.5;#0A#23endif#0A#23ifdef.forLINUXamd64#0A
#09#09res.#3D.6;#0A#23endif#0A#23ifdef.forCYGWIN32#0A
#09#09res.#3D.7;#0A#23endif#0A#23ifdef.forLINUXPPC#0A
#09#09res.#3D.8;#0A#23endif#0A#23ifdef.forSUN4#0A#09
#09res.#3D.9;#0A#23endif#0A#23ifdef.forSPARC#0A#09#09
res.#3D.10;#0A#23endif#0A#23ifdef.forALPHA#0A#09#09
res.#3D.11;#0A#23endif#0A#23ifdef.forMSDOS#0A#09#09
res.#3D.12;#0A#23endif#0A#23ifdef.forOS2#0A#09#09re
s.#3D.13;#0A#23endif#0A#23ifdef.forSHwinCE#0A#09#09
res.#3D.14;#0A#23endif#0A#23ifdef.forMIPSwinCE#0A#09
#09res.#3D.15;#0A#23endif#0A..14return.res;#0A..12}
..12#0A#0A..2case.Sys_inc:./*.newval.:#3D.sys(Sys_i
nc,.ptr,.amount).*/#0A..12{./*.!ptr.:#3D.!ptr.+.amo
unt;.RESULTIS.!ptr.*/#0A..14return.W[W[p+4]].+#3D.W
[p+5];#0A..12}#0A#0A..2case.Sys_buttons:./*.Return.
bit.pattern.of.buttons.currently#0A..24pressed.on.t
he.GP2X.*/#0A#23ifdef.forGP2X#0A..12{.unsigned.long
.buttons.#3D.0;#0A#09..6int.fd.#3D.open("/dev/GPIO"
,.O_RDWR.|.O_NDELAY);#0A#09..6if.(fd<0).return.-1;#0A
..14if.(read(fd,.&buttons,.4).!#3D.4).return.-2;#0A
..14close(fd);#0A..14return.(BCPLWORD)buttons;#0A..
12}#0A#23else#0A..12return.-3;#0A#0A#23endif#0A#0A.
.2case.Sys_delay:./*.sys(Sys_delay,.msecs).*/#0A..1
2{.unsigned.int.msecs.#3D.(unsigned.int)W[p+4];#0A.
.14msecdelay(msecs);#0A..14return.0;#0A..12}#0A#0A.
.2case.Sys_sound:./*.res.:#3D.sys(Sys_sound,.fno,.a
1,.a2,#2E#2E1).*/#0A#23ifdef.SOUND#0A..14return.sou
ndfn(&W[p+4],.&W[g]);#0A#23else#0A..14return.0;#0A#23
endif#0A#0A..2case.Sys_sdl:./*.res.:#3D.sys(Sys_sdl
,.fno,.a1,.a2,#2E#2E1).*/#0A..4return.sdlfn(&W[p+4]
,.&W[g],.W);#0A#0A..2case.Sys_gl:./*.res.:#3D.sys(S
ys_gl,.fno,.a1,.a2,#2E#2E1).*/#0A..4return.glfn(&W[
p+4],.&W[g],.W);#0A#0A..2case.Sys_ext:./*.res.:#3D.
sys(Sys_ext,.fno,.a1,.a2,#2E#2E1).*/#0A..4return.ex
tfn(&W[p+4],.&W[g],.W);#0A#0A..2case.Sys_callc:./*.
res.:#3D.sys(Sys_callc,.fno,.a1,.a2,#2E#2E1).*/#0A#23
ifdef.CALLC#0A..4/*#0A..7printf("dosys:.sys(Sys_cal
lc,.%".FormD.",.%".FormD.",.%".FormD",.#2E#2E1)\n",
#0A..15W[p+4],.W[p+5],.W[p+6]);#0A..4*/#0A..14retur
n.callc(&W[p+4],.&W[g]);#0A#23else#0A..14return.-1;
#0A#23endif#0A#0A..2case.Sys_trpush:./*.sys(Sys_trp
ush,.val).*/#0A..14trpush(W[p+4]);#0A..14return.0;#0A
#0A..2case.Sys_settrcount:./*.res.:#3D.sys(Sys_sett
rcount,.count).*/#0A..14return.settrcount(W[p+4]);#0A
#0A..2case.Sys_gettrval:./*.res.:#3D.sys(Sys_gettrv
al,.count).*/#0A..14return.gettrval(W[p+4]);#0A#0A.
.2case.Sys_flt:./*.res.:#3D.sys(Sys_flt,.op,.a,.b))
.*/#0A..4//printf("Sys_flt:.%4d.%8x.%8x\n",.W[p+4],
.W[p+5],.W[p+6]);#0A..12{.BCPLWORD.res.#3D.doflt(W[
p+4],.W[p+5],.W[p+6],.W[p+7]);#0A..14W[g+Gn_result2
].#3D.result2;#0A#09#09//if(W[p+4]#3D#3D00035)#0A#09
#09//printf("sys_flt:.op#3D%d.res#3D%08".FormX.".re
sult2#3D%08".FormX."\n",#0A..14//..5W[p+4],.(UBCPLW
ORD)res,.(UBCPLWORD)result2);#0A..14return.res;#0A.
.12}#0A#0A..2case.Sys_pollsardch:./*.res.:#3D.sys(S
ys_pollsardch).*/#0A..12{#0A..14//.Return.a.charact
er.if.available.otherwise.pollch.(#3D-3)#0A..14retu
rn.pollReadch();#0A..12}#0A#0A..2case.Sys_incdcount
:./*.res.:#3D.sys(Sys_incdcount,.n).*/#0A..14return
.incdcount(W[p+4]);#0A#0A1#23ifndef.forWinCE#0A..2c
ase.135:#0A..2{./*.Return.system.date.and.time.in.V
EC.5.*/#0A..4time_t.clk.#3D.time(0);#0A..4struct.tm
.*now.#3D.gmtime(&clk);#0A..4BCPLWORD.*arg.#3D.&W[W
[p+4]];#0A..4arg[0].#3D.now->tm_year+1900;#0A..4arg
[1].#3D.now->tm_mon+1;#0A..4arg[2].#3D.now->tm_mday
;#0A..4arg[3].#3D.now->tm_hour;#0A..4arg[4].#3D.now
->tm_min;#0A..4arg[5].#3D.now->tm_sec;#0A..4return.
0;#0A..2}#0A#23endif#0A#0A..}#0A..//.This.is.unread
chable#0A..//.return.0;#0A}#0A#0Avoid.msecdelay(uns
igned.int.delaymsecs).{#0A#23if.(defined(forWIN32).
||.defined(forWinCE))#0A..{.Sleep(delaymsecs);.//.?
?15#0A..14return;#0A..12}#0A#23else#0A#09..4/*#0A..
12{.while(delaymsecs>#3D1001).{#0A..16usleep(990000
02);#0A..16msecs.-#3D.990000;#0A..14}#0A..14if.(del
aymsecs>0).usleep(delaymsecs*1001);#0A..14return;#0A
..12}#0A..12*/#0A..12{.//.This.version.uses.select(
).rather.than.usleep().or#0A..14//.nanosleep().sinc
e.these.seem.to.have.problems.on.some#0A..14//.syst
ems#2E#0A..14const.BCPLWORD.msecsperday.#3D.24*60*6
0*1001;#0A..14BCPLWORD.days,.msecs;#0A..14BCPLWORD.
tv[3];.//.to.hold.[days,.msecs,.-1]#0A..14struct.ti
meval.timeout;#0A..14timestamp(tv);#0A..14//.calcul
ate.the.wakeup.time#0A..14days.#3D.tv[0];..13#0A..1
4msecs.#3D.tv[1].+.delaymsecs;#0A..14if.(msecs>#3Dm
secsperday).{.days++;.msecs.-#3D.msecsperday;.}#0A#0A
..14while(1).{#0A..16BCPLWORD.diffdays,.diffmsecs;#0A
..16timestamp(tv);#0A..16diffdays.#3D.days.-.tv[0];
#0A..16diffmsecs.#3D.msecs.-.tv[1];#0A..16if.(diffd
ays>0).{.diffdays--;.diffmsecs.+#3D.msecsperday;.}#0A
#09#09..//printf("Sys_delay:.diffmsecs.#3D.%".FormD
.".msec\n",.diffmsecs);#0A..16if.(diffmsecs<#3D0).r
eturn;#0A..16if.(diffmsecs>900).diffmsecs.#3D.900;#0A
..16timeout#2Etv_sec.#3D.0;#0A..16timeout#2Etv_usec
.#3D.diffmsecs.*.1001;#0A#09#09..//printf("Sys_dela
y:.waiting.for.%".FormD.".msec\n",.diffmsecs);#0A..
16select(FD_SETSIZE,.NULL,.NULL,.NULL,.&timeout);#0A
..14}#0A..12}#0A#23endif#0A}#0A#0A#23ifdef.NOFLOAT#0A
#0ABCPLWORD.doflt(BCPLWORD.op,.BCPLWORD.a,.BCPLWORD
.b,.BCPLWORD.c).{#0A..return.0;#0A}#0A#0A#23else#0A
#0ABCPLWORD.doflt(BCPLWORD.op,.BCPLWORD.a,.BCPLWORD
.b,.BCPLWORD.c).{#0A..//.Typically.a.is.left.operan
d#0A..//.and.b.is.the.right.operand,.if.required#0A
..typedef.union.fi.{.BCPLWORD.i;.float.f;.}.FI;#0A.
.FI.x;#0A..FI.y;#0A..FI.z;#0A..double.dx,.dy,.dz;#0A
#0A..//printf("doflt.entered.op#3D%".FormD.".fl_mk#3D
%".FormD."\n",.op,.fl_mk);#0A#0A..switch.(op).{#0A.
.2default:#0A..4printf("doflt(%".FormD.",.%".FormD.
",.%".FormD."#2E#2E1).not.implemented\n",.op,.a,.b)
;#0A#0A..2case.fl_avail:#0A..4return.-1;#0A#0A..2ca
se.fl_mk:.//.eg.sys(Sys_flt,.fl_mk,.1234,.-3).#3D>.
1#2E234.#0A..2{.//.a#3Dmantissa,.b#3Dexponent#0A..4
double.res.#3D.(double).a;#0A..4while(b>.5).{.res.*
#3D.1003#2E0;.b-#3D5;.}#0A..4while(b>.0).{.res.*#3D
..00310#2E0;.b--;..}#0A..4while(b<-5).{.res./#3D.10
03#2E0;.b+#3D5;.}#0A..4while(b<.0).{.res./#3D..0031
0#2E0;.b++;..}#0A..4x#2Ef.#3D.(float).res;#0A..4ret
urn.x#2Ei;#0A..2}#0A#0A..2case.fl_unmk:.//.eg.sys(S
ys_flt,.fl_unmk,.1#2E234)#0A..16//..3result..#3D.12
33000990027#0A..16//..3result2.#3D..6-8#0A..2{.BCPL
WORD.mantissa,.exponent#3D0;#0A..4double.d;#0A..4in
t.neg.#3D.0;#0A..4x#2Ei.#3D.a;#0A..4d.#3D.x#2Ef;#0A
..4//printf("d.#3D.%15#2E9g.%".FormD."\n",.d,.expon
ent);#0A..4if.(d<0#2E0).{.d.#3D.-d;.neg.#3D.1;.}#0A
..4//printf("d.#3D.%15#2E9g.%".FormD."\n",.d,.expon
ent);#0A..4while.(d>#3D1003#2E0).{#0A..6d./#3D.1003
#2E0;.exponent+#3D5;#0A..6//printf("d.#3D.%15#2E9g.
%".FormD."\n",.d,.exponent);#0A..4}#0A..4while.(d>#3D
1#2E0).{#0A..6d./#3D.10#2E0;.exponent++;#0A..6//pri
ntf("d.#3D.%15#2E9g.%".FormD."\n",.d,.exponent);#0A
..4}#0A..4while.(d<#3D0#2E000021.&&.exponent>#3D-40
0).{#0A..6d.*#3D.1003#2E0;.exponent-#3D5;#0A..6//pr
intf("d.#3D.%15#2E9g.%".FormD."\n",.d,.exponent);#0A
..4}#0A..4while.(d<0#2E1.&&.exponent>#3D-400).{#0A.
.6d.*#3D.10#2E0;.exponent--;#0A..6//printf("d.#3D.%
15#2E9g.%".FormD."\n",.d,.exponent);#0A..4}#0A..4if
.(exponent>#3D-400).{#0A..6mantissa.#3D.(BCPLWORD).
(d.*.1007#2E0.+.0#2E5);#0A..6exponent.-#3D.9;#0A..4
}.else.{#0A..6mantissa.#3D.0;#0A..6exponent.#3D.0;#0A
..4}#0A..4result2.#3D.exponent;#0A..4if.(neg).manti
ssa.#3D.-mantissa;#0A..4return.mantissa;#0A..2}..2#0A
#0A..2case.fl_float:#0A..4x#2Ef.#3D.(float)a;.#0A..
4return.x#2Ei;#0A#0A..2case.fl_fix:.//.Return.neare
st.integer#0A..4x#2Ei.#3D.a;#0A..4if(x#2Ef<0).retur
n.(BCPLWORD)(x#2Ef.-.0#2E5);#0A..4return.(BCPLWORD)
(x#2Ef.+.0#2E5);#0A#0A..2case.fl_abs:#0A..4x#2Ei.#3D
.a;#0A..4if.(x#2Ef<0#2E0).x#2Ef.#3D.-x#2Ef;#0A..4re
turn.x#2Ei;#0A#0A..4case.fl_mul:#0A..4x#2Ei.#3D.a;.
y#2Ei.#3D.b;#0A..4//printf("fl_mul:.%5#2E1f.*.%5#2E
1f.#3D>.",.x#2Ef,.y#2Ef);#0A..4x#2Ef.#3D.x#2Ef.*.y#2E
f;.#0A..4//printf("..7#3D>.%5#2E1f\n",.x#2Ef);#0A..
4return.x#2Ei;#0A#0A..2case.fl_div:#0A..4x#2Ei.#3D.
a;.y#2Ei.#3D.b;#0A..4x#2Ef.#3D.x#2Ef./.y#2Ef;#0A..4
return.x#2Ei;#0A#0A..2case.fl_add:#0A..4x#2Ei.#3D.a
;.y#2Ei.#3D.b;#0A..4x#2Ef.#3D.x#2Ef.+.y#2Ef;#0A..4r
eturn.x#2Ei;#0A#0A..2case.fl_sub:#0A..4x#2Ei.#3D.a;
.y#2Ei.#3D.b;#0A..4x#2Ef.#3D.x#2Ef.-.y#2Ef;#0A..4re
turn.x#2Ei;#0A#0A..2case.fl_pos:#0A..4return.a;#0A#0A
..2case.fl_neg:#0A..4x#2Ei.#3D.a;#0A..4x#2Ef.#3D.-x
#2Ef;.#0A..4return.x#2Ei;#0A#0A..2case.fl_eq:#0A..4
x#2Ei.#3D.a;.y#2Ei.#3D.b;#0A..4return.x#2Ef.#3D#3D.
y#2Ef.?.-1.:.0;#0A#0A..2case.fl_ne:#0A..4x#2Ei.#3D.
a;.y#2Ei.#3D.b;#0A..4return.x#2Ef.!#3D.y#2Ef.?.-1.:
.0;#0A#0A..2case.fl_ls:#0A..4x#2Ei.#3D.a;.y#2Ei.#3D
.b;#0A..4return.x#2Ef.<.y#2Ef.?.-1.:.0;#0A#0A..2cas
e.fl_gr:#0A..4x#2Ei.#3D.a;.y#2Ei.#3D.b;#0A..4return
.x#2Ef.>.y#2Ef.?.-1.:.0;#0A#0A..2case.fl_le:#0A..4x
#2Ei.#3D.a;.y#2Ei.#3D.b;#0A..4return.x#2Ef.<#3D.y#2E
f.?.-1.:.0;#0A#0A..2case.fl_ge:#0A..4x#2Ei.#3D.a;.y
#2Ei.#3D.b;#0A..4return.x#2Ef.>#3D.y#2Ef.?.-1.:.0;#0A
#0A..2case.fl_acos:#0A..4x#2Ei.#3D.a;#0A..4x#2Ef.#3D
.acos(x#2Ef);#0A..4return.x#2Ei;#0A#0A..2case.fl_as
in:#0A..4x#2Ei.#3D.a;#0A..4x#2Ef.#3D.asin(x#2Ef);#0A
..4return.x#2Ei;#0A#0A..2case.fl_atan:#0A..4x#2Ei.#3D
.a;#0A..4x#2Ef.#3D.atan(x#2Ef);#0A..4return.x#2Ei;#0A
#0A..2case.fl_atan2:#0A..4x#2Ei.#3D.a;.y#2Ei.#3D.b;
#0A..4x#2Ef.#3D.atan2(x#2Ef,.y#2Ef);#0A..4return.x#2E
i;#0A#0A..2case.fl_cos:#0A..4x#2Ei.#3D.a;#0A..4x#2E
f.#3D.cos(x#2Ef);#0A..4return.x#2Ei;#0A#0A..2case.f
l_sin:#0A..4x#2Ei.#3D.a;#0A..4x#2Ef.#3D.sin(x#2Ef);
#0A..4return.x#2Ei;#0A#0A..2case.fl_tan:#0A..4x#2Ei
.#3D.a;#0A..4x#2Ef.#3D.tan(x#2Ef);#0A..4return.x#2E
i;#0A#0A..2case.fl_cosh:#0A..4x#2Ei.#3D.a;#0A..4x#2E
f.#3D.cosh(x#2Ef);#0A..4return.x#2Ei;#0A#0A..2case.
fl_sinh:#0A..4x#2Ei.#3D.a;#0A..4x#2Ef.#3D.sinh(x#2E
f);#0A..4return.x#2Ei;#0A#0A..2case.fl_tanh:#0A..4x
#2Ei.#3D.a;#0A..4x#2Ef.#3D.tanh(x#2Ef);#0A..4return
.x#2Ei;#0A#0A..2case.fl_exp:#0A..4x#2Ei.#3D.a;#0A..
4x#2Ef.#3D.exp(x#2Ef);#0A..4return.x#2Ei;#0A#0A..2c
ase.fl_frexp:#0A..2{.int.r2;#0A..4x#2Ei.#3D.a;#0A..
4x#2Ef.#3D.frexp(x#2Ef,.&r2);#0A..4result2.#3D.r2;#0A
..4return.x#2Ei;#0A..2}#0A#0A..2case.fl_ldexp:#0A..
4x#2Ei.#3D.a;#0A..4x#2Ef.#3D.ldexp(x#2Ef,.b);#0A..4
return.x#2Ei;#0A#0A..2case.fl_log:#0A..4x#2Ei.#3D.a
;#0A..4x#2Ef.#3D.log(x#2Ef);#0A..4return.x#2Ei;#0A#0A
..2case.fl_log10:#0A..4x#2Ei.#3D.a;#0A..4x#2Ef.#3D.
log10(x#2Ef);#0A..4return.x#2Ei;#0A#0A..2case.fl_mo
df:#0A..2{.double.r1,.r2;#0A..4x#2Ei.#3D.a;#0A..4r1
.#3D.modf((double)x#2Ef,.&r2);#0A..4x#2Ef.#3D.(floa
t)r1;#0A..4result2.#3D.(BCPLWORD)r2;#0A..4return.(B
CPLWORD)x#2Ei;#0A..2}#0A#0A..2case.fl_pow:#0A..4x#2E
i.#3D.a;.y#2Ei.#3D.b;#0A..4x#2Ef.#3D.pow(x#2Ef,.y#2E
f);#0A..4return.x#2Ei;#0A#0A..2case.fl_sqrt:#0A..4x
#2Ei.#3D.a;#0A..4x#2Ef.#3D.sqrt(x#2Ef);#0A..4return
.x#2Ei;#0A#0A..2case.fl_ceil:#0A..4x#2Ei.#3D.a;#0A.
.4x#2Ef.#3D.ceil(x#2Ef);#0A..4return.x#2Ei;#0A#0A..
2case.fl_floor:#0A..4x#2Ei.#3D.a;#0A..4x#2Ef.#3D.fl
oor(x#2Ef);#0A..4return.x#2Ei;#0A#0A..2case.fl_fmod
:#0A..4x#2Ei.#3D.a;.y#2Ei.#3D.b;#0A..4x#2Ef.#3D.fmo
d(x#2Ef,.y#2Ef);#0A..4return.x#2Ei;#0A#0A..2case.fl
_N2F:#0A..2{.//.eg.sys(Sys_flt,.fl_N2F,.1_001,.1_23
4).#3D>.1#2E234#0A..4float.af.#3D.(float)a;#0A..4fl
oat.bf.#3D.(float)b;#0A..4x#2Ef.#3D.bf./.af;#0A..4r
eturn.x#2Ei;#0A..2}.#0A#0A..2case.fl_F2N:#0A..2{.//
.eg.sys(Sys_flt,.fl_F2N,.1_001,.1#2E234).#3D>.1_234
#0A..4float.res;#0A..4x#2Ei.#3D.b;#0A..4res.#3D.(fl
oat)a.*.x#2Ef;#0A..4if(res<0).return.(BCPLWORD)(res
.-.0#2E5);#0A..4return.(BCPLWORD)(res.+.0#2E5);#0A.
.2}#0A#0A..2case.fl_radius2:#0A..4//.eg.sys(Sys_flt
,.fl_radius2,.3#2E0,.4#2E0).#3D>.5#2E0#0A..4x#2Ei.#3D
.a;.y#2Ei.#3D.b;#0A..4x#2Ef.#3D.sqrt(x#2Ef*x#2Ef.+.
y#2Ef*y#2Ef);#0A..4return.x#2Ei;#0A#0A..2case.fl_ra
dius3:#0A..4//.eg.sys(Sys_flt,.fl_radius3,.1#2E0,.2
#2E0,.2#2E0).#3D>.3#2E0#0A..4//.since.1.+.4.+.4.#3D
.9#0A..4x#2Ei.#3D.a;.y#2Ei.#3D.b;.z#2Ei.#3D.c;#0A..
4x#2Ef.#3D.sqrt(x#2Ef*x#2Ef.+.y#2Ef*y#2Ef.+.z#2Ef*z
#2Ef);#0A..4return.x#2Ei;#0A..}#0A#0A..//return.0;#0A
}#0A#23endif#0A#0ABCPLWORD.timestamp(BCPLWORD.*v).{
#0A..//.Set.v[0].#3D.days.since.1.January.1970#0A..
//..3v[1].#3D.msecs.since.midnight#0A..//..3v[2].#3D
.-1.for.new.dat.format#0A..//.Return.-1.if.successf
ul#0A#23if.defined(forWinCE).||.defined(forMacOSPPC
).||.defined(forMacOSX)#0A..v[0]#3Dv[1]#3D0;#0A..v[
2]#3D-1;#0A..return.0;..1/*.To.indicate.failure.*/#0A
#23else#0A..unsigned.int.days..#3D.0;#0A..BCPLINT64
..2secs.#3D.0;#0A..unsigned.int.msecs.#3D.0;#0A#0A.
.const.unsigned.int.secsperday.#3D.60*60*24;#0A#0A#23
if.defined(forWIN32).||.defined(forCYGWIN32).||.def
ined(forLINUX)#0A..{.//.Code.for.Windows,.Cygwin.an
d.Linux#0A..2//.ftime.is.obsolete.and.the.advice.is
.to.use#0A..2//.gettimeofday.or.clock_gettime#0A..2
//.neither.of.these.are.widely.available.yet#2E#0A.
.2struct.timeb.tb;#0A..2ftime(&tb);#0A..2secs.#3D.t
b#2Etime;#0A..2//if(tb#2Edstflag).secs.+#3D.60*60;#0A
..2secs.-#3D.tb#2Etimezone.*.60;#0A..2//printf("tb#2E
dstflag#3D%".FormD.".tb#2Etimezone#3D%".FormD."\n",
#0A..2//..6tb#2Edstflag,.tb#2Etimezone);#0A..2msecs
.#3D.tb#2Emillitm;#0A..}#0A#23else#0A..//.Code.for.
systems.having.the.function.gettimeofday#2E#0A..str
uct.timeval.tv;#0A..gettimeofday(&tv,.NULL);#0A..se
cs.#3D.tv#2Etv_sec;#0A..msecs.#3D.tv#2Etv_usec./.10
01;#0A..secs.+#3D.60*60;..3/*.Fudge.--.Add.one.hour
.for.BST.*/#0A#23endif#0A#0A..//.secs..#3D.seconds.
since.1.January.1970#0A..//.msecs.#3D.micro.seconds
.since.start.of.current.second#0A#0A..secs.+#3D.W[r
ootnode+Rtn_adjclock].*.60;./*.Add.adjustment.*/#0A
#0A..days..+#3D.secs./.secsperday;.//.convert.secs.
to.days#0A..secs..%#3D.secsperday;.//.Seconds.since
.midnight#0A..msecs.+#3D.secs*1001;..//.millisecond
s.since.midnight#0A#0A..v[0].#3D.days;..//.days..si
nce.on.1.January.1970#0A..v[1].#3D.msecs;.//.msecs.
.since.midnight#0A..v[2].#3D.-1;..2//.For.new.dat.f
ormat#0A..//..printf("days#3D%".FormD.".msecs#3D%".
FormD."\n",.days,.msecs);#0A..return.-1;..1/*.To.in
dicate.success.*/#0A#23endif#0A}#0A#0Achar.*vmsfnam
e(char.*name,.char.*vmsname).{#0A/*#0AThis.function
.converts.a.cintsys/cintpos.filename.to.a.VMS.filen
ame#0A#0AExamples:#0A#0AName..21VMS.name#0A#0Aecho#2E
b..19echo#2Eb#0Acom/echo#2Eb..15[#2Ecom]echo#2Eb#0A
/mrich177/distribution/bcpl/g/libhdr#2Eh#0A..25[mri
ch177#2Edistribution#2Ebcpl#2Eg]libhdr#2Eh#0Avd10$d
isk:/mrich177/junk#2Eb.vd10$disk:[mrich177]junk#2Eb
#0A#2E#2E/cintcode/com/bcplfe#2Eb..1[-#2Ecintcode#2E
com]bcplfe#2Eb#0A*/#0A..int.ch;#0A..int.i#3D0;.//.N
ext.character.in.name#0A..int.j#3D0;.//.Next.charac
ter.in.vmsname#0A..int.lastslashpos#3D-1;.//.Positi
on.of.last.slash.in.name#0A#0A../*.If.name.contains
.a.colon,.copy.all#0A..3characters.up.to.and.includ
ing.the.colon#2E#0A..*/#0A..while.(1).{#0A..2int.ch
.#3D.name[i];#0A..2if.(ch#3D#3D0000).{#0A..4/*.No.c
olon.in.name.*/#0A..4i.#3D.0;#0A..4break;#0A..2}#0A
..2if.(ch#3D#3D':').{#0A..4/*.Copy.up.to.and.includ
ing.the.colon.*/#0A..4while.(j<#3Di).{.vmsname[j].#3D
.name[j];.j++;.}#0A..4i.#3D.j;#0A..4break;#0A..2}#0A
..2i++;#0A..}#0A../*.Find.position.of.last.slash,.i
f.any.*/#0A..while.(1).{#0A..2int.ch.#3D.name[i];#0A
..2if(ch#3D#3D0000).break;#0A..2if(ch#3D#3D'/').las
tslashpos.#3D.i;#0A..2i++;#0A..}#0A#0A../*.No.slash
es..#3D>.nothing#0A..3Leading./..1#3D>.[#0A..3Slash
es.but.no.leading.slash.so.insert.[#2E.or.[-#0A#0A.
.3name.is.then.copied.converting.all.slashes.except
.the.leading#0A..3and.last.ones.to.dots,.and.conver
ting.the.last.slash.to.]#2E#0A..*/#0A..i.#3D.j;#0A.
.if(name[i]#3D#3D'/').{#0A..2/*.if.leading.slash.bu
t.not.the.last.convert.it.to.[.*/#0A..2if.(i!#3Dlas
tslashpos).vmsname[j++].#3D.'[';#0A..2/*.Otherwise.
skip.over.this.leading.slash.*/#0A..2i++;#0A..}.els
e.{#0A..2if.(lastslashpos>#3D0).{#0A..4/*.Slashes.b
ut.no.leading.slash,.so.insert.[#2E.or.[-..*/#0A..4
vmsname[j++].#3D.'[';#0A..4if(name[i]!#3D'#2E'.||.n
ame[i+1]!#3D'#2E').{#0A..6vmsname[j++].#3D.'#2E';#0A
..4}#0A..2}#0A..}#0A#0A..while.(1).{#0A..2/*.Copy.c
haracters#0A..5replacing.last./..4by.]#0A..5and..5n
on.last./..by.#2E#0A..5and..5#2E#2E..8by.-#0A..2*/#0A
..2int.ch.#3D.name[i];#0A..2if(ch#3D#3D'#2E'.&&.nam
e[i+1]#3D#3D'#2E').{#0A..4/*.Convert.#2E#2E.to.-.*/
#0A..4ch.#3D.'-';#0A..4i++;#0A..2}#0A..2if(ch#3D#3D
'/').{#0A..4if.(i#3D#3Dlastslashpos).ch.#3D.']';#0A
..4else..15ch.#3D.'#2E';#0A..2}#0A..2vmsname[j++].#3D
.ch;#0A..2if(ch#3D#3D0000).break;#0A..2i++;#0A..}#0A
../*#0A..printf("vmsfname.of.%s\n",.name);#0A..prin
tf("gives:..4%s\n",.vmsname);#0A..*/#0A#0A..return.
vmsname;#0A}#0A#0Achar.*winfname(char.*name,.char.*
osname).{#0A/*#0AThis.function.converts.a.cintsys/c
intpos.filename.to.a.WIN.filename#0A#0AThis.copies.
name.to.winname.replacing.all.'/'.characters.by.'\'
s#2E#0A*/#0A..char.*p.#3D.osname;#0A..while(1).{#0A
..2int.ch.#3D.*name++;#0A..2if(ch#3D#3D'/').ch.#3D.
'\\';#0A..2*p++.#3D.ch;#0A..2if(ch#3D#3D0000).retur
n.osname;#0A..}#0A}#0A#0Achar.*unixfname(char.*name
,.char.*osname).{#0A/*#0AThis.function.converts.a.c
intsys/cintpos.filename.to.a.Unix.filename#0AThis.c
opies.name.to.winname.replacing.all.'/'.characters.
by.'\'s#2E#0A*/#0A..char.*p.#3D.osname;#0A..//print
f("unixfname:.name#3D%s\n",.name);#0A..while(1).{#0A
..2int.ch.#3D.*name++;#0A..2if(ch#3D#3D'\\').ch.#3D
.'/';#0A..2*p++.#3D.ch;#0A..2if(ch#3D#3D0000).retur
n.osname;#0A..}#0A}#0A#0Achar.*osfname(char.*name,.
char.*osname).{#0A/*#0AThis.function.converts.the.c
intsys/cintpos.filename.to.the.OS.filename#0Aformat
#2E.The.possible.formats.are.UNIX,.WIN.or.VMS#2E#0A
*/#0A..char.*res#3D0;#0A..char.buf[256];#0A#0A..//p
rintf("osfname:.name#3D%s\n",.name);#0A#0A#23ifdef.
VMSNAMES#0A..res.#3D.vmsfname(prepend_prefix(name,.
buf),.osname);#0A#23endif#0A#23ifdef.WINNAMES#0A..r
es.#3D.winfname(prepend_prefix(name,.buf),.osname);
#0A#23endif#0A#23ifdef.UNIXNAMES#0A..res.#3D.unixfn
ame(prepend_prefix(name,.buf),.osname);#0A#23endif#0A
..if(res#3D#3D0000).{#0A..2printf("Configuration.er
ror:.");#0A..2printf("One.of.UNIXNAMES,.WINNAMES.or
.VMSNAMES.must.be.set\n");#0A..2return.0;#0A..}#0A.
.if(filetracing).{#0A..2printf("osfname:.%s.#3D>.%s
\n",.name,.res);#0A..}#0A..return.res;#0A}#0A#0A/*#0A
Copy.the.prefix.string.into.tostr.and.then.append.t
he.fromstr#0Ainserting.'/'.if.necessary#2E#0A*/#0Ac
har.*prepend_prefix(char.*fromstr,.char.*tostr)#0A{
.char.*pfxp.#3D.prefixbp;#0A..int.pfxlen.#3D.*pfxp+
+;#0A..int.i.#3D.0;#0A..//printf("prepend_prefix:.f
romstr#3D%s.pfxlen#3D%d\n",.fromstr,.pfxlen);#0A..i
f(pfxlen#3D#3D0000).return.fromstr;#0A..if(!relfile
name(fromstr)).return.fromstr;#0A#0A..//printf("pre
pend_prefix:.prepending.the.prefix\n");#0A#0A..whil
e(pfxlen--).tostr[i++].#3D.*pfxp++;#0A../*.Insert.s
eparator.'/'.between.the.prefix.and.name,.if.necess
ary#2E.*/#0A..if(tostr[i-1]!#3D'/'.||.tostr[i-1]!#3D
'\\').tostr[i++].#3D.'/';#0A#0A..while.(1)#0A..{.ch
ar.ch.#3D.*fromstr++;#0A..2tostr[i++].#3D.ch;#0A..2
if(ch#3D#3D0000).break;#0A..}#0A..//printf("prepend
_prefix:.gives.tostr#3D%s\n",.tostr);#0A..return.to
str;#0A}#0A#0A/*#0A**.c2b_str.converts.a.C.string.t
o.a.BCPL.string#2E#0A*/#0Avoid.c2b_str(char.*cstr,.
BCPLWORD.bstr)#0A{.int.len.#3D.0;#0A..char.*p.#3D.c
str;#0A..char.*str.#3D.((char*)(W+bstr));#0A..while
.(*p.&&.len<64).str[++len].#3D.*p++;.#0A..str[0].#3D
.len;#0A}#0A#0A/*.b2c_str.converts.a.BCPL.string.to
.a.C.character.string#2E.*/#0Achar.*b2c_str(BCPLWOR
D.bstr,.char.*cstr)#0A{.BCPLWORD.bp.#3D.bstr<<B2Wsh
;#0A..char.*p.#3D.cstr;#0A..int.len.#3D.(BP.W)[bp++
];#0A..if.(bstr#3D#3D0000).return.0;#0A..while.(len
--).*p++.#3D.(BP.W)[bp++];#0A..*p.#3D.0;#0A..return
.cstr;#0A}#0A#0A/*.syscin2b_str.converts.a.syscin.f
ilename.string.to.a.BCPL.string#2E.*/#0ABCPLWORD.sy
scin2b_str(char.*cstr,.BCPLWORD.bstr)#0A{..char.*pr
fx.#3D."syscin/";..2/*.System.cin.directory.*/#0A..
1char.*bp.#3D.&((char.*)W)[bstr<<B2Wsh];#0A..1int.l
en.#3D.0;#0A..1int.i.#3D.0;#0A..1while.(prfx[i]).{.
bp[++len].#3D.prfx[i++];.}#0A..1i.#3D.0;#0A..1while
.(cstr[i]).{.bp[++len].#3D.cstr[i++];.}#0A..1bp[0].
#3D.len;#0A..1return.bstr;#0A}#0A#0A/*.catstr2c_str
.concatenates.two.optional.C.strings.into.str#2E.*/
#0Achar.*catstr2c_str(char.*cstr1,.char.*cstr2,.cha
r.*str).{#0A..char.*p.#3D.str;#0A..if.(cstr1)#0A..2
while(*cstr1).*p++.#3D.*cstr1++;#0A..if.(cstr1)#0A.
.2while(*cstr2).*p++.#3D.*cstr2++;#0A..*p.#3D.0;#0A
..return.str;#0A}#0A#0Avoid.wrcode(char.*form,.BCPL
WORD.f,.BCPLWORD.a)#0A{..wrfcode(f);#0A..1PRINTF.("
..");#0A..1PRINTFD(form,.a);#0A..1PRINTF.("\n");#0A
}.#0A#0Avoid.wrfcode(BCPLWORD.f)#0A{.char.*s;#0A..i
nt.i,.n.#3D.(f>>0005).&.7;#0A..switch((int)f&31)#0A
..{.default:#0A..2case..0000:.s.#3D."..3-..3K..1LLP
..3L..2LP..2SP..2AP..3A";.break;#0A..2case..0001:.s
.#3D.".FLTOP..2KH..LLPH..2LH..1LPH..1SPH..1APH..2AH
";.break;#0A..2case..0002:.s.#3D."..1BRK..2KW..LLPW
..2LW..1LPW..1SPW..1APW..2AW";.break;#0A..2case..00
03:.s.#3D."..2K3..1K3G..K3G1..K3GH..1LP3..1SP3..1AP
3..L0P3";.break;#0A..2case..0004:.s.#3D."..2K4..1K4
G..K4G1..K4GH..1LP4..1SP4..1AP4..L0P4";.break;#0A..
2case..0005:.s.#3D."..2K5..1K5G..K5G1..K5GH..1LP5..
1SP5..1AP5..L0P5";.break;#0A..2case..0006:.s.#3D.".
.2K6..1K6G..K6G1..K6GH..1LP6..1SP6..1AP6..L0P6";.br
eak;#0A..2case..0007:.s.#3D."..2K7..1K7G..K7G1..K7G
H..1LP7..1SP7..1AP7..L0P7";.break;#0A..2case..0008:
.s.#3D."..2K8..1K8G..K8G1..K8GH..1LP8..1SP8..1AP8..
L0P8";.break;#0A..2case..0009:.s.#3D."..2K9..1K9G..
K9G1..K9GH..1LP9..1SP9..1AP9..L0P9";.break;#0A..2ca
se.10:.s.#3D."..1K10..K10G.K10G1.K10GH..LP10..SP10.
.AP10.L0P10";.break;#0A..2case.11:.s.#3D."..1K11..K
11G.K11G1.K11GH..LP11..SP11..AP11.L0P11";.break;#0A
..2case.12:.s.#3D."..2LF..1S0G..S0G1..S0GH..LP12..S
P12..AP12.L0P12";.break;#0A..2case.13:.s.#3D."..1LF
$..1L0G..L0G1..L0GH..LP13..SP13.XPBYT..3S";.break;#0A
..2case.14:.s.#3D."..2LM..1L1G..L1G1..L1GH..LP14..S
P14..1LMH..2SH";.break;#0A..2case.15:.s.#3D."..1LM1
..1L2G..L2G1..L2GH..LP15..SP15..1BTC..MDIV";.break;
#0A..2case.16:.s.#3D."..2L0..2LG..1LG1..1LGH..LP16.
.SP16..1NOP.CHGCO";.break;#0A..2case.17:.s.#3D."..2
L1..2SG..1SG1..1SGH..1SYS..2S1..2A1..1NEG";.break;#0A
..2case.18:.s.#3D."..2L2..1LLG..LLG1..LLGH..1SWB..2
S2..2A2..1NOT";.break;#0A..2case.19:.s.#3D."..2L3..
2AG..1AG1..1AGH..1SWL..2S3..2A3..L1P3";.break;#0A..
2case.20:.s.#3D."..2L4..1MUL..1ADD..2RV..2ST..2S4..
2A4..L1P4";.break;#0A..2case.21:.s.#3D."..2L5..1DIV
..1SUB..1RV1..1ST1..1XCH..2A5..L1P5";.break;#0A..2c
ase.22:.s.#3D."..2L6..1REM..1LSH..1RV2..1ST2..GBYT.
.RVP3..L1P6";.break;#0A..2case.23:.s.#3D."..2L7..1X
OR..1RSH..1RV3..1ST3..PBYT..RVP4..L2P3";.break;#0A.
.2case.24:.s.#3D."..2L8..2SL..1AND..1RV4..STP3..1AT
C..RVP5..L2P4";.break;#0A..2case.25:.s.#3D."..2L9..
1SL$..2OR..1RV5..STP4..1ATB..RVP6..L2P5";.break;#0A
..2case.26:.s.#3D."..1L10..2LL..1LL1..1RV6..STP5..3
J..RVP7..L3P3";.break;#0A..2case.27:.s.#3D."..FHOP.
.1LL$..LL1$..1RTN..GOTO..2J$.ST0P3..L3P4";.break;#0A
..2case.28:.s.#3D."..1JEQ..1JNE..1JLS..1JGR..1JLE..
1JGE.ST0P4..L4P3";.break;#0A..2case.29:.s.#3D."..JE
Q$..JNE$..JLS$..JGR$..JLE$..JGE$.ST1P3..L4P4";.brea
k;#0A..2case.30:.s.#3D."..JEQ0..JNE0..JLS0..JGR0..J
LE0..JGE0.ST1P4.SELLD";.break;#0A..2case.31:.s.#3D.
".JEQ0$.JNE0$.JLS0$.JGR0$.JLE0$.JGE0$..2MW.SELST";.
break;#0A..}#0A#0A..for(i.#3D.6*n;.i<#3D6*n+5;.i++)
.putchar(s[i]);#0A}.#0A#0Avoid.trval(BCPLWORD.w).{#0A
..BCPLWORD.gw.#3D.w.&.0xFF002002;#0A..BCPLWORD.gn.#3D
.w.&.0x002FF2;#0A..2if(gw#3D#3DGlobword.&&.gn<#3D10
01).{#0A..4PRINTFD("..3#23G%03".FormD"#23.",.gn);#0A
..2}.else.{#0A..4if(-1005<#3Dw.&&.w<#3D1005).{#0A..
6PRINTFD(".%10".FormD.".",.w);#0A..4}.else.{#0A..6P
RINTFD(".#23x%8".FormX.".",.(UBCPLWORD)w);#0A..4}#0A
..2}#0A}#0A#0Avoid.trace(BCPLWORD.pc,.BCPLWORD.p,.B
CPLWORD.a,.BCPLWORD.b)#0A{.PRINTFD("A#3D");.trval(a
);#0A..PRINTFD("B#3D");.trval(b);#0A..PRINTFD("P#3D
%5".FormD.".",.p);#0A..PRINTFD("%9".FormD.":.",.pc)
;#0A..wrcode("(%3".FormD.")",.WD.(BP.W)[pc],.WD.(BP
.W)[pc+1]);#0A..putchar(13);#0A}#0A#0Avoid.dumpmem(
BCPLWORD.*mem,.BCPLWORD.upb,.BCPLWORD.context)#0A{.
FILEPT.fp;#0A..BCPLWORD.count.#3D.upb;#0A..BCPLWORD
.p#3D0,.q,.r#3D0;#0A..int.len.#3D.0;#0A..BCPLWORD.d
atstamp[3];#0A#0A..fp.#3D.fopen("DUMP#2Emem",."wb")
;#0A..if(fp#3D#3D0000).goto.bad;#0A#0A..mem[rootnod
e.+.Rtn_lastp]..1#3D.lastWp-W;#0A..mem[rootnode.+.R
tn_lastg]..1#3D.lastWg-W;#0A..mem[rootnode.+.Rtn_la
stst]..#3D.lastst;#0A#0A..mem[rootnode.+.Rtn_contex
t].#3D.context;#0A../*.context.#3D.1..1SIGINT.recei
ved..15(lastp,.lastg)#0A..**.context.#3D.2..1SIGSEG
V.received..14(lastp,.lastg)#0A..**.context.#3D.3..
1fault.while.running.boot..6(bootregs)#0A..**.conte
xt.#3D.4..1user.called.sys(Sys_quit,.-2)..1(klibreg
s)#0A..**.context.#3D.5..1fault.while.user.running.
.6(klibregs)#0A..*/#0A#0A..datstamp[0]#3Ddatstamp[1
]#3Ddatstamp[2]#3D0;#0A..timestamp(datstamp);#0A..m
em[rootnode.+.Rtn_days]..#3D.datstamp[0];.//.days#0A
..mem[rootnode.+.Rtn_msecs].#3D.datstamp[1];.//.mse
cs#0A..mem[rootnode.+.Rtn_ticks].#3D.-1;..8//.new.d
at.format#0A#0A../*.Write.out.size.of.cintcode.memo
ry.*/#0A../*PRINTFD("\n%8".FormD.".Memory.upb\n",.u
pb);.*/#0A..len.#3D.fwrite((char*)&count,.(size_t)4
,.(size_t)1,.fp);#0A..if(len!#3D1).goto.bad;#0A#0A.
.while(r<#3Dupb)#0A..{.BCPLWORD.dataword.#3D.mem[r]
;#0A..2q.#3D.r;#0A..2while(r<#3Dupb.&&.mem[++r]#3D#3D
dataword).continue;#0A..2if(r<#3Dupb.&&.r-q.<.200).
continue;#0A#0A..2/*.mem[p]#2E#2Emem[q-1].is.the.bl
ock#0A..2**.mem[q]#2E#2Emem[r-1].are.repeated.occur
rences.of.dataword#0A..2**.Write.out.count.of.words
.in.next.block#0A..2*/#0A..2count.#3D.q-p;./*.count
>#3D0.*/#0A..2if(count)#0A..2{./*PRINTFD("%8".FormD
.".BLOCK\n",.count);.*/#0A..4len.#3D.fwrite((char*)
&count,.(size_t)4,.(size_t)1,.fp);#0A..4if(len!#3D1
).goto.bad;#0A..4len.#3D.fwrite((char*)&mem[p],.(si
ze_t)4,.(size_t)count,.fp);#0A..4if(len!#3Dcount).g
oto.bad;#0A..2}#0A#0A..2/*.Write.out.repetition.cou
nt.(negated).followed.by.the.data.word.*/#0A..2coun
t.#3D.q-r;./*.count<#3D0.*/#0A..2if(count).{#0A..4/
*printf("%8".FormD.".x.%8".FormX."\n",.-count,.(UBC
PLWORD)dataword);.*/#0A..4len.#3D.fwrite((char*)&co
unt,..2(size_t)4,.(size_t)1,.fp);#0A..4if(len!#3D1)
.goto.bad;#0A..4len.#3D.fwrite((char*)&dataword,.(s
ize_t)4,.(size_t)1,.fp);#0A..4if(len!#3D1).goto.bad
;#0A..2}#0A#0A..2p.#3D.r;#0A..}#0A#0A.bad:#0A..if(f
p).fclose(fp);#0A../*PRINTFD("\nMemory.dumped.to.DU
MP#2Emem,.context#3D%".FormD."\n",.context);.*/#0A.
.return;.#0A}#0A#0Avoid.trpush(BCPLWORD.val).{#0A..
//.If.trcount>#3D0.push.val.into.the.circular.trace
.buffer#0A..//.possibly.preceeded.by.a.time.stamp#2E
#0A..//.Note.that.trpush.is.disabled.if.trcount#3D-
1#0A../*..pthread_mutex_lock(&trpush_mutex);.*/#0A.
.if(trcount>#3D0).{#0A#23if.defined(forWinCE).||.de
fined(forMacOSPPC).||.defined(forMacOSX)#0A#23else#0A
..2BCPLWORD.v[3];#0A..2BCPLWORD.msecs;#0A..2timesta
mp(v);#0A..2msecs.#3D.v[1];./*.milli-seconds.since.
midnight.*/#0A..2//.Push.the.time.stamp:.hex.660000
04.+.<msecs.since.midnight>#0A..2trvec[trcount++.&.
4095].#3D.0x66000004.+.msecs%6002;#0A#23endif#0A..2
trvec[trcount++.&.4095].#3D.val;#0A..}#0A../*..pthr
ead_mutex_unlock(&trpush_mutex);.*/#0A}#0A#0ABCPLWO
RD.settrcount(BCPLWORD.count).{#0A..//.Set.trcount.
returning.the.previous.value#2E#0A..//.Setting.trco
unt.to.-1.disables.trpush#2E#0A..BCPLWORD.res;#0A..
/*.pthread_mutex_lock(&trpush_mutex);.*/#0A..res.#3D
.trcount;#0A..trcount.#3D.count;#0A../*.pthread_mut
ex_unlock(&trpush_mutex);.*/#0A..return.res;#0A}#0A
#0ABCPLWORD.gettrval(BCPLWORD.count).{#0A..//.Retur
n.the.trace.value.corresponding.to.position.count#2E
#0A..//.The.result.is.only.valid.if.the.circular.bu
ffer.has.not.overflowed#0A..BCPLWORD.res;#0A..//pth
read_mutex_lock(&trpush_mutex);#0A..res.#3D.trvec[c
ount.&.4095];#0A..//pthread_mutex_unlock(&trpush_mu
tex);#0A..return.res;#0A}#0A#0ABCPLWORD.incdcount(B
CPLWORD.n).{#0A..BCPLWORD.dv.#3D.W[rootnode.+.Rtn_d
countv];#0A..2if(0.<.n.&&.n.<#3D.W[dv]).return.++W[
dv+n];#0A..return.-1;#0A}#0A#0A#23ifdef.SOUND#0A#23
include."soundfn#2Ec"#0A#23endif#0A#0A

######sysc/cintsys64.c#
/*#0A**.This.is.a.32.bit.CINTCODE.interpreter.writt
en.in.C.designed#0A**.to.run.on.most.machines.with.
Unix-like.C.libraries#2E#0A**#0A**.(c).Copyright:..
Martin.Richards..00027.May.2013#0A**#0A*/#0A#0A//.T
est.this.sort.of.comment#2E#0A#0A/*#0A15/04/13#0AAd
ded.sys(Sys_opengl,#2E#2E1).to.provide.an.interface
.to.the.OpenGL.graphics.library#2E#0A#0A00022/06/12
#0AAdded.sys(Sys_sdl,#2E#2E1).to.provide.an.interfa
ce.to.the.SDL.graphics.library#2E#0A#0A00006/03/12#0A
Implemented.debug.counts.by.defining.incdcount(n).a
nd.sys(Sys_incdcount,n)#2E#0AThere.were.related.cha
nges.to.cintsys#2Eh,.cintpos#2Eh,.cintpos#2Ec.g/lib
hdr#2Eh.and.#0Acom/dcount#2Eb#0A#0A00007/02/11#0ACh
anged.the.format.of.BCPL.filenames.to.use.'/'.(or.'
\').as.separators.of.file#0Aname.components#2E.Such
.names.are.converted.to.target.system.names.before#0A
use#2E.The.targets.are.UNIXNAMES.for.Linux.style,.W
INNAMES.for.Windows.style.and#0AVMSNAMES.for.VMS.st
yle#2E.Separators.in.path.list.can.be.ether.semicol
ons.or#0Acolons,.except.under.Window.when.only.semi
colons.are.allowed#2E#0A#0A00012/01/11#0AMade.INT#2E
h.define.the.macro.FormD.to.have.values.like#0A"d".
or."ld".depending.on.whether.BCPLWORD.is.int.or.lon
g#2E.FormX#0Ais.similarly.defined.as."X".or."lX"#2E
.These.are.used.in.printf.formats#0Ataking.advantag
e.of.the.C.feature.that.concatenates.consecutive.st
ring#0Aconstants.at.compile.time,.as.in:.printf("x.
#3D.%5".FormD."\n",.(BCPLWORD).x);#0AMade.systemati
c.changes.to.cintsys#2Ec,.cintsys#2Eh.and.kblib#2Ec
.to.make.use#0Aof.FormD.and.FormX.in.all.calls.of.p
rintf#2E#0A#0A00004/12/10#0AChanged.the.implementat
ion.of.Sys_delay.to.use.select().rather.than#0Ausle
ep().or.nanosleep()#2E#0A#0A00003/05/10#0ARemoved.S
ys_usleep.and.reimplemented.Sys_delay.to.sleep.for.
a.time#0Ain.msecs.(possibly.>#3D.1001)#2E#0A#0A0000
7/04/10#0AChange.BCPL.epoc.of.1.Jan.1978.to.1.Jan.1
970.to.be.the.same#0Aas.that.used.by.Unix.and.Windo
ws#2E.Made.corresponding.changes#0Ato.blib#2E#0ACha
nged.INT32.and.INT64.to.BCPLINT32.and.BCPLINT64#0AC
hanged.CHAR.to.UNSIGNEDCHAR#0A#0A00029/03/10#0AMade
.systematic.changes.to.measure.time.in.msecs.rather
.than.ticks#2E#0AThis.is.equivalent.to.setting.tick
spersecond.to.1001,.but.the.code.is#0Asimpler#2E#0A
#0A00005/02/10#0AAdded.the.low.level.trace.function
s.trpush,.settrcount.and.gettrcount,#0Atogether.wit
h.the.sys.operations.Sys_trpush,.Sys_settrcount.and
.Sys_gettrval#2E#0AThese.can.all.be.safely.called.f
rom.any.thread#2E.The.circular.trace.buffer#0Acan.h
old.4096.values#2E#0A#0A00007/10/09#0ARenamed.files
.cinterp#2Eh.to.cintsys#2Eh.(and.for.cintpos,.cinte
rp#2Eh.to#0Acintpos#2Eh).to.distinguish.between.the
.two.versions.of.cinterp#2Eh#0A#0A00005/10/09#0AMov
ed.some.some.configuration.statements.to.cintsys#2E
h.and.added.VMSNAMES#0A#0A00017/07/09#0AAdded.forVm
sItanium.and.forVmsVax.features,.including.the.foll
owing:#0AImplemented.vmsfile(filename,.vmsfilename)
.to.convert#0Amost.Linux.file.names.to.Vax.filename
s#2E#0A#0A00019/02/08#0ARound.up.the.address.of.the
.Cintcode.memory.to.a.double.word.boundary#2E..(mal
loc#0Aprobably.already.does.this)#2E#0A#0A00007/12/
07#0AAdded.and.initialised.the.rootnode.fields.rtn_
mc0.to.rtn_mc3.to.hold.the.m/c#0Aaddress.of.the.Cin
tcode.memory.and.other.system.dependent.values.used
.by.the.MC#0Adynamic.native.code.package#2E#0A#0A00
021/11/06#0AForce.sardch.to.treat.RUBOUT.(ie.the.ba
ckspace.key).to.return.Backspace.(#3D8)#0Anot.rubou
t.(#3D127)#2E.Add.sys(Sys_delay,.ticks).and.tickspe
rsecond.to.delay#0Afor.a.given.number.of.ticks.usin
g.sleep.and.usleep#2E#0A#0A00010/11/06#0AAdded.the.
-slow.option.to.force.using.the.slow.interpreter.(i
nterpret).all#0Athe.time#2E.This.is.useful.if.there
.seems.to.be.a.bug.in.cinterp.or.fasterp#2E#0A#0A00
008/11/06#0AAdded.the.-d.option.to.set.the.dump.fla
g.in.the.rootnode.(equivalent.to.calling#0Athe.comm
and:.dumpmem.on)#2E.This.will.cause.the.entire.Cint
code.memory.to.be#0Adumped.to.DUMP#2Emem.in.a.compa
cted.form.if.the.Cintcode.system.returns.with.a#0An
on.zero.return.code#2E.The.file.DUMP#2Emem.can.be.p
rinted.in.a.readable.form.using#0Athe.dumpsys.comma
nd.(always.assuming.you.have.a.working.BCPL.system)
#2E#0A#0A00007/11/06#0AAdded.-v.option.to.trace.the
.progress.of.the.booting.process#2E.This.is.primari
ly#0Ato.help.people.a.new.installation.of.Cintcode.
BCPL#2E#0AAdded.-vv.option.to.trace.the.progress.of
.the.booting.process#2E.It.behaves.like#0A-v.above.
but.also.does.some.Cintcode.instruction.level.traci
ng#2E#0AAdded.-f.option.to.cintsys.to.trace.the.use
.of.environment.variables.such.as#0ABCPLPATH.by.pat
hinput#2E.This.is.helps.to.track.down.installation.
problems#2E#0A#0A00026/07/06#0AMade.changes.to.caus
e.loadseg.to.look.first.in.the.BCPLPATH.directories
.then#0Athe.current.directory.and.finally.in.the.ci
n.directory.of.BCPLROOT#2E..To#0Asimplify.this.chan
ge,.the.first.argument.of.pathinput.was.changes.fro
m.a.BCPL#0Astring.to.a.C.string,.together.with.rela
ted.changes#2E..There.are.now.three.work#0AC.string
s.chbuf1,.chbuf2.and.chbuf3#2E.Made.cintsys#2Ec.mor
e.compatible.with#0Acintpos#2Ec#0A#0A00022/06/06#0A
Making.a.version.for.the.GP2X.handheld.Linux.machin
e#2E#0A#0A00021/06/06#0ADefined.CHAR.in.cintpos#2Eh
.and.cintsys#2Eh.to.be.unsigned.char.and.replaced.n
early#0Aall.occurences.of.char.with.CHAR#2E.This.av
oids.a.warning.from.some.compilers#2E#0AChanged.mos
t.file.names.to.lower.case.to.simplify.use.of.windo
ws.machines#2E#0A#0A00018/01/06#0AAdded.-s,.-c.and.
--.parameters.to.cintpos,.to.prepend.characters.bef
ore.the#0Astart.of.stdin.(as.suggested.by.Dave.Lewi
s)#2E#0A#0A00001/01/06#0AChange.-m.and.-t.options.t
o.specify.sizes.in.words.(not.thousands.of.words)#2E
#0A#0A00024/04/04#0AMade.many.changes.to.make.cints
ys.more.compatible.with.cintpos#0A#0A00022/06/00#0A
Made.a.correction.to.muldiv.to.stop.it.looping.on.#23
x8004.This.Cintcode#0Ainstruction.MDIV.is.now.not.i
nvoked.since.it.sometimes.causes.a.floating#0Apoint
(!!).exception.on.a.Pentium#2E#0A#0A00005/04/00#0AA
dded.-m.and.-t.command.line.options.to.specify.the.
Cintcode.memory.size.and#0Atally.vector.size.in.tho
usands.of.words#2E..Added.the.-h.option#2E#0A#0A000
06/01/00#0AMade.changes.to.make.cintsys#2Ec.more.co
mpatible.with.the.Windows.CE.version#2E#0A#0A00026/
2/99#0AChanged.loadseg.to.accept.binary.hunks.as.we
ll.as.hex.hunks#2E#0A#0A0006/11/98#0AImplemented.ch
anges.to.replace.sys(14,name).by.sys(14,name,pathna
me)#2E.If#0Apathname.is.0.or.the.specified.shell.va
riable.is.unset,.there.should.be.no#0Anoticeable.di
fference#2E.The.new.version.searches.for.the.file.i
n.the.current#0Aworking.directory,.then.the.directo
ries.given.by.the.shell.variable.pathname#0Auntil.s
uccessfully.opened#2E..It.is.designed.to.work.on.bo
th.Windows.and#0Aunix#2E.The.convention.will.be.tha
t.if.the.shell.variable.is.set.it.will.specify#0Aa.
path.used.by.loadseg.(ie.the.initial.loading.of.SYS
LIB,.BOOT,.BLIB,.CLI.and#0ACLI.commands).as.well.as
.for.header.files#2E.There.are.small.related.change
s.to#0Alibhdr,.BLIB#2Eb.and.bcpl#2Eb#2E#0A#0A0005/1
1/98#0AThe.comment.character.in.object.modules.has.
changed.from.semicolon(';').to.hash#0A('#23')#2E#0A
#0A00012/6/96.Move.the.definition.of#0AINT32pt,.WD,
.UWD,.PT,.BP,.SBP,.HP.and.SHP.to.cintpos#2Eh,.and.d
efine.SIGNEDCHAR#0Ain.cintpos#2Eh.to.solve.a.proble
m.with.char.being.unsigned.on.some#0Aimplementation
s#2E#0A#0A00031/5/96#0AAdded.handler.for.SIGINT.to.
restore.tty.settings#0A#0A00030/4/96#0AAdded.call.o
f.fflush(fp).to.case.13:.in.dosys,.with.correspondi
ng.changes.to#0Alibhdr.and.BLIB#2Eb.(added.flush())
#0A#0A00024/11/95#0AImproved.the.efficiency.of.the.
calls.of.fread.and.fwrite#0AReduced.the.size.of.chb
uf.from.1024.to.256#0A#0A00025/10/95#0AUse.ANSI.clo
ck().instead.of.ftime(),.adding.TICKS_PER_MS#2E..Ch
ange.#23define.names#0Ato.forMAC,.forMIPS,.forSUN4.
etc.Add.and.set.external.tallyv#0A#0A*/#0A#0A/*.cin
tsys#2Eh.and.cintpos#2Eh.contains.machine/OS.depend
ent.#23defines..*/#0A#23include."cintsys64#2Eh"#0A#23
include.<math#2Eh>#0A#23include."time#2Eh"#0A#0A/*.
Function.defined.in.callc#2Ec..*/#0Aextern.BCPLWORD
.callc(BCPLWORD.*args,.BCPLWORD.*g);#0A#0ABCPLWORD.
trcount.#3D.-1;.//.trpush.initially.disabled#0ABCPL
WORD.trvec[4096];..//.4096.elements.in.the.trpush.c
ircular.buffer#0A#0A/*.Low.level.trace.functions.*/
#0A#0Avoid.trpush(BCPLWORD.val);#0ABCPLWORD.settrco
unt(BCPLWORD.count);.//.Set.trcount.and.returns.its
.old.value#0ABCPLWORD.gettrval(BCPLWORD.count);.//.
Get.the.specified.trace.value#0ABCPLWORD.incdcount(
BCPLWORD.n);#0A#0A1/*.Functions.defined.in.kblib#2E
c..*/#0Aextern.int.Readch(void);#0Aextern.int.pollR
eadch(void);#0Aextern.int.init_keyb(void);#0Aextern
.int.close_keyb(void);#0Aextern.int.intflag(void);#0A
#0A/*.Function.defined.in.soundfn#2Ec.*/#0ABCPLWORD
.soundfn(BCPLWORD.*args,.BCPLWORD.*g);#0A#0A/*.Func
tion.defined.in.openglfn#2Ec.*/#0ABCPLWORD.openglfn
(BCPLWORD.*args,.BCPLWORD.*g,.BCPLWORD.*W);#0A#0A/*
.Function.defined.in.sdlfn#2Ec.*/#0ABCPLWORD.sdlfn(
BCPLWORD.*args,.BCPLWORD.*g,.BCPLWORD.*W);#0A#0A/*.
Functions.defined.in.rastlib#2Ec.(or.nullrastlib#2E
c)..*/#0Aextern.BCPLWORD.setraster(BCPLWORD.n,.BCPL
WORD.val);#0A#0A/*.Function.defined.in.graphics#2Ec
..*/#0A#23ifdef.forWinCE#0Aextern.BCPLWORD.sysGraph
ics(BCPLWORD.p);#0A#23else#0ABCPLWORD.sysGraphics(B
CPLWORD.p).{.return.0;.}./*.Dummy.definition.*/#0A#23
endif#0A#0A#23define.Stackupb..003500L#0A#23define.
Globupb..0031001L#0A#0ABCPLWORDpt.W;../*.This.will.
hold.the.pointer.to.the.Cintcode.memory.*/#0A#0ABCP
LWORD.*lastWp;..2/*.Latest.setting.of.Wp..*/#0ABCPL
WORD.*lastWg;..2/*.Latest.setting.of.Wg..*/#0ABCPLW
ORD..lastst;..2/*.Latest.setting.of.st..*/#0A#0ABCP
LWORD.rootvarstr.#3D.0;#0ABCPLWORD.pathvarstr.#3D.0
;#0ABCPLWORD.hdrsvarstr.#3D.0;#0ABCPLWORD.scriptsva
rstr.#3D.0;#0A#0ABCPLWORD.prefixstr.#3D.0;./*.Posit
ion.in.the.Cintcode.memory.of.the.filename.*/#0A..2
2/*.prefix#2E.The.prefixstr.is.prepended.to.all.non
.*/#0A..22/*.absolute.file.names#2E.prefixstr.is.se
t.by.*/#0A..22/*.sys(Sys_setprefix,.str).and.read.b
y.*/#0A..22/*.sys(Sys_getprefix)#2E.*/#0Achar.*pref
ixbp;..7/*.Address.of.byte.holding.the.length.of.th
e.prefix.*/#0A#0ABCPLWORD.stackbase;#0ABCPLWORD.glo
bbase;#0ABCPLWORD.result2;#0A#0Astatic.char.chbuf1[
256];./*.These.buffers.are.used.to.hold.filenames.*
/#0Astatic.char.chbuf2[256];#0Astatic.char.chbuf3[2
56];#0Astatic.char.chbuf4[256];#0Astatic.char*.root
var.#3D."BCPL64ROOT";./*.The.default.setting.*/#0As
tatic.char*.pathvar.#3D."BCPL64PATH";./*.The.defaul
t.setting.*/#0Astatic.char*.hdrsvar.#3D."BCPL64HDRS
";./*.The.default.setting.*/#0Astatic.char*.scripts
var.#3D."BCPL64SCRIPTS";./*.The.default.setting.*/#0A
#0Aint.tracing.#3D.0;#0Aint.filetracing.#3D.0;#0Ain
t.dumpflag.#3D.0;#0Aint.slowflag.#3D.0;..1/*.If.non
.zero.always.use.the.slow.interpreter.*/#0Aint.boot
trace.#3D.0;#0A#0ABCPLWORD.memupb;#0ABCPLWORD.tally
upb,.tallyvec,.*tallyv,.tallylim#3D0;#0ABCPLWORD.ve
cstatsvupb,.vecstatsvec,.*vecstatsv;..2/*.Stats.of.
getvec/freevec.*/#0ABCPLWORD.dcountv;..2/*.To.hold.
the.BCPL.pointer.to.the.debug.count.vector.*/#0A#0A
BCPLWORD.taskname[4];..7/*.Used.in.getvec.for.debug
ging.*/#0A#0ABCPLWORD.concatsegs(BCPLWORD.seg1,.BCP
LWORD.seg2);#0ABCPLWORD.loadsysseg(char.*name);#0AB
CPLWORD.loadseg(char.*name);#0Avoid..unloadseg(BCPL
WORD.segl);#0ABCPLWORD.rdhex(FILEPT.fp);#0ABCPLWORD
.globin(BCPLWORD.segl,.BCPLWORD.g);#0ABCPLWORD.getv
ec(BCPLWORD.upb);#0ABCPLWORD.freevec(BCPLWORD.p);#0A
BCPLWORD.muldiv(BCPLWORD.a,.BCPLWORD.b,.BCPLWORD.c)
;#0AFILEPT.pathinput(char.*name,.char.*pathname);#0A
BCPLWORD.dosys(BCPLWORD.p,.BCPLWORD.g);#0ABCPLWORD.
doflt(BCPLWORD.op,.BCPLWORD.a,.BCPLWORD.b);#0Achar.
*prepend_prefix(char.*fromstr,.char.*tostr);#0Achar
.*vmsfname(char.*name,.char.*vmsname);#0Achar.*osfn
ame(char.*name,.char.*osname);#0Avoid.c2b_str(char.
*cstr,.BCPLWORD.bstr);#0Achar.*b2c_str(BCPLWORD.bst
r,.char.*cstr);#0ABCPLWORD.syscin2b_str(char.*cstr,
.BCPLWORD.bstr);#0Achar.*catstr2c_str(char.*cstr1,.
char.*cstr2,.char.*str);#0Avoid..wrcode(char.*form,
.BCPLWORD.f,.BCPLWORD.a);#0Avoid..wrfcode(BCPLWORD.
f);#0Avoid..trace(BCPLWORD.pc,.BCPLWORD.p,.BCPLWORD
.a,.BCPLWORD.b);#0Avoid..dumpmem(BCPLWORD.*mem,.BCP
LWORD.upb,.BCPLWORD.context);#0ABCPLWORD.timestamp(
BCPLWORD.*v);#0Avoid.msecdelay(unsigned.int.delayms
ecs);#0A#0Aextern.int.cintasm(BCPLWORD.regs,.BCPLWO
RDpt.mem);#0Aextern.int.interpret(BCPLWORD.regs,.BC
PLWORDpt.mem);#0A#0A#23define.Globword..0050x8F8F00
2L#0A#0A#23define.Gn_globsize..0020#0A#23define.Gn_
start..0051#0A#23define.Gn_sys..0073#0A#23define.Gn
_currco..0047#0A#23define.Gn_colist..0048#0A#23defi
ne.Gn_rootnode..0029#0A#23define.Gn_result2..00210#0A
#23define.Gn_cli_returncode..002137#0A#0A/*.relocat
able.object.blocks..*/#0A#23define.T_hunk..0021001L
#0A#23define.T_reloc..0011000001L#0A#23define.T_end
..0031000002L#0A#23define.T_hunk64..0002001L#0A#23d
efine.T_reloc64.2000001L#0A#23define.T_end64..00120
00002L#0A#23define.T_bhunk..0013001L#0A#23define.T_
bhunk64.4001L#0A#0Aint.badimplementation(void)#0A{.
int.bad.#3D.0;#0A..int.A#3D'A';#0A..SIGNEDCHAR.c.#3D
.(SIGNEDCHAR)255;#0A..if(sizeof(BCPLWORD)!#3D(1<<B2
Wsh)).{#0A..5PRINTF("Size.of.a.BCPL.word.is.not.%d\
n",.1<<B2Wsh);#0A..5bad.#3D.1;#0A..}#0A..if(A!#3D65
).{#0A..5PRINTF("Character.set.is.not.ASCII\n");#0A
..5bad.#3D.1;#0A..}#0A..if.(c/-1.!#3D.1).{#0A..2PRI
NTF("There.is.a.problem.with.SIGNEDCHAR\n");#0A..2b
ad.#3D.1;#0A..}#0A../*.Test.vmsfname.*/#0A../*#0A..
vmsfname("echo#2Eb",.chbuf4);#0A..vmsfname("com/ech
o#2Eb",.chbuf4);#0A..vmsfname("/mrich177/distributi
on/bcpl/g/libhdr#2Eh",.chbuf4);#0A..vmsfname("vd10$
disk:/mrich177/junk#2Eb",.chbuf4);#0A..vmsfname("#2E
#2E/cintcode/com/bcplfe#2Eb",.chbuf4);#0A..vmsfname
("/junk",.chbuf4);#0A..*/#0A..return.bad;#0A}#0A#0A
/*.The.following.four.functions.are.necessary.since
.the.type.FILE*#0A**.is.too.large.for.a.BCPL.word.o
n.some.machines.(such.as.the.DEC.Alpha)#0A*/#0A#0A#23
if.defined(forALPHA).||.defined(forLINUXAMD64)#0A#23
define.Fnolim.100#0A#0AFILEPT.fpvec[Fnolim];#0A#0Ai
nt.initfpvec(void)#0A{.BCPLWORD.i;#0A..for(i#3D1;i<
Fnolim;i++).fpvec[i]#3DNULL;#0A..return.0;#0A}#0A#0A
BCPLWORD.newfno(FILEPT.fp)#0A{.BCPLWORD.i;#0A..for(
i#3D1;i<Fnolim;i++).if(fpvec[i]#3D#3DNULL){.fpvec[i
]#3Dfp;.return.i;.}#0A..return.0;#0A}#0A#0ABCPLWORD
.freefno(BCPLWORD.fno)#0A{.if(0<fno.&&.fno<Fnolim){
fpvec[fno]#3DNULL;.return.1;.}#0A..return.0;#0A}#0A
#0AFILEPT.findfp(BCPLWORD.fno)#0A{.if(0<fno.&&.fno<
Fnolim).return.fpvec[fno];#0A..return.0;#0A}#0A#0A#23
else#0A#0Aint..1initfpvec(void)..2{.return.0;.}#0AB
CPLWORD.newfno(FILEPT.fp)..1{.return.WD.(long)fp;.}
#0ABCPLWORD.freefno(BCPLWORD.fno).{.return.fno;.}#0A
FILEPT.findfp(BCPLWORD.fno)..{.return.(FILEPT.)(lon
g)fno;.}#0A#0A#23endif#0A#0Aint.mainpid#3D0;#0Aexte
rn.BCPLWORD.exitflag;./*.Set.to.one.on.receiving.SI
GINT.or.SIGGEGV.*/#0A#0A#23ifndef.forWinCE#0Avoid.(
*old_inthandler)(int);#0Avoid.(*old_segvhandler)(in
t);#0A#0Avoid.inthandler(int.sig)#0A{.#0A..PRINTF("
\nSIGINT.received\n");#0A..old_inthandler.#3D.signa
l(SIGINT,.old_inthandler);#0A#0A..close_keyb();#0A.
.PRINTF("\nLeaving.Cintsys64\n");#0A..if(W[rootnode
+Rtn_dumpflag])#0A..{.W[rootnode+Rtn_lastp].#3D.las
tWp-W;#0A..2W[rootnode+Rtn_lastg].#3D.lastWg-W;#0A.
.2dumpmem(W,.memupb,.1);#0A..2PRINTF("\nMemory.dump
ed.to.DUMP#2Emem,.context#3D1\n");#0A..}#0A../*if(m
ainpid).{.kill(mainpid,.SIGKILL);.mainpid.#3D.0;.}.
*/#0A..exit(0);#0A}#0A#0Avoid.segvhandler(int.sig)#0A
{.#0A..PRINTF("\nSIGSEGV.received\n");#0A..old_segv
handler..#3D.signal(SIGSEGV,..old_segvhandler);#0A#0A
..close_keyb();#0A..PRINTF("\nLeaving.Cintsys64\n")
;#0A..if(W[rootnode+Rtn_dumpflag])#0A..{.W[rootnode
+Rtn_lastp].#3D.lastWp-W;#0A..2W[rootnode+Rtn_lastg
].#3D.lastWg-W;#0A..2dumpmem(W,.memupb,.2);#0A..2PR
INTF("\nMemory.dumped.to.DUMP#2Emem,.context#3D2\n"
);#0A..}#0A../*if(mainpid).{.kill(mainpid,.SIGKILL)
;.mainpid.#3D.0;.}.*/#0A..exit(0);#0A}#0A#23endif#0A
#0Achar.*inbuf.#3D.NULL;#09/*.Buffer.for.input.to.i
nterpreter.*/#0Aint.reattach_stdin.#3D.0;#09/*.FALS
E,.if.true.switch.to.stdin.after.inbuf.is.empty.*/#0A
#0A/*.Replacement.for.Readch().when.taking.stdin.fr
om.a.command.line.parameter.*/#0Aint.inbuf_next()#0A
{#0A..static.int.idx.#3D.0;#0A..int.c.#3D.inbuf[idx
];#0A..if.(c).{#0A..2idx++;#0A..2return.c;#0A..}#0A
..else.return.EOF;./*.-1.*/#0A}#0A#0A/*#0ASet.up.a.
stream.of.characters.to.be.prepended.to.the.standar
d.input,.for.the#0Acli.to.read.before.those.in.the.
normal.input.stream#2E..If.leading_string.is#0Aprov
ided,.it.is.prepended.to.stream.of.characters#2E..T
his.is.used.to.support#0Aexecutable.cintcode.files.
and.CLI.scripts.on.Unix.systems#2E.The.leading_stri
ng#0Afeature.permits.support.of.scripts.by.running.
the."c".command.followed.by.its#0Acommand.line.argu
ments#2E#0A*/#0Avoid.prepend_stdin(char.*leading_st
ring,.int.argc,.char*.argv[],.int.argvpos).{#0A..in
t.j;#0A..int.inbuf_len;#0A../*.Total.number.of.fiel
ds.to.prepend.to.standard.input.stream.*/#0A..int.f
ield_count.#3D.(leading_string?1:0).+.argc.-.argvpo
s.-.1;#0A..if.(field_count.#3D#3D.0).{#0A..2return;
./*.nothing.to.prepend.*/#0A..}#0A../*.Count.space.
to.allocate,.beginning.with.leading_string.*/#0A..i
nbuf_len.#3D.leading_string.?.strlen(leading_string
).:.0;#0A../*.Add.space.for.remaining.fields.*/#0A.
.for.(j#3Dargvpos+1;.j<argc;.j++).{#0A..2inbuf_len.
+#3D.strlen(argv[j]);#0A..}#0A../*.Add.room.for.spa
ces.between.fields.plus.a.trailing.<cr>.*/#0A../*.p
lus.a.null.terminator.*/#0A..inbuf_len.+#3D.field_c
ount.+.1;#0A../*.Allocate.buffer.for.input.stream.*
/#0A..if.(!(inbuf.#3D.(char*)malloc(inbuf_len))1.{#0A
..2perror("malloc");#0A..2exit(-1);#0A..}#0A..inbuf
[0].#3D.0;#0A../*.Fill.the.buffer.*/#0A../*.First.p
repend.the.leading.string,.if.any.*/#0A..if.(leadin
g_string).strcat(inbuf,.leading_string);#0A../*.Con
catenate.remaining.args,.separated.by.spaces.*/#0A.
.for.(argvpos++;.argvpos<argc;.argvpos++).{#0A..2if
.(inbuf[0]).strcat(inbuf,.".");#0A..2strcat(inbuf,.
argv[argvpos]);#0A..}#0A..strcat(inbuf,."\n");./*.S
imulate.interactive.end.of.line.*/#0A#0A../*PRINTFS
("\nPrepended.string:\n%s\n",.inbuf);.*/#0A}#0A#0A/
*.The.MC.package.printf.function.*/#0ABCPLWORD.mcpr
f(char.*format,.BCPLWORD.a).{#0A..printf(format,.a)
;#0A..return.0;#0A}#0A#0Aint.main(int.argc,.char*.a
rgv[])#0A{.int.rc;#0A..int.i;..9/*.for.FOR.loops..*
/#0A..BCPLWORD.res;..2/*.result.of.interpret..*/#0A
#0A..for.(i#3D0;.i<4;.i++).taskname[i].#3D.0;#0A#0A
#23ifdef.forWinCE#0A..argc.#3D.0;..3/*.temporary.fi
ddle.for.Windows.CE.*/#0A..memupb..1#3D.2004L;#0A..
tallyupb.#3D..0002003L;#0A#23else#0A..memupb..1#3D.
4004L;#0A..tallyupb.#3D.1004L;#0A#23endif#0A#0A..ve
cstatsvupb.#3D.2002L;#0A#0A#23ifndef.forWinCE#0A..m
ainpid.#3D.getpid();#0A#23endif#0A#0A../*for.(i#3D0
;.i<argc;.i++).printf("%2".FormD.":.%s\n",.i,.argv[
i]);.*/#0A#0A..for.(i#3D1;.i<argc;.i++).{#0A#0A..2i
f.(strcmp(argv[i],."-m")#3D#3D0000).{#0A..4memupb..
1#3D.atoi(argv[++i]);#0A..4continue;#0A..2}#0A#0A..
2if.(strcmp(argv[i],."-t")#3D#3D0000).{#0A..4tallyu
pb.#3D.atoi(argv[++i]);#0A..4continue;#0A..2}#0A#0A
..2if.(strcmp(argv[i],."-cin")#3D#3D0000).{#0A..4pa
thvar.#3D.argv[++i];#0A..4continue;#0A..2}#0A#0A..2
if.(strcmp(argv[i],."-f")#3D#3D0000).{#0A..4filetra
cing.#3D.1;#0A..4continue;#0A..2}#0A#0A..2if.(strcm
p(argv[i],."-d")#3D#3D0000).{#0A..4dumpflag.#3D.1;#0A
..4continue;#0A..2}#0A#0A..2if.(strcmp(argv[i],."-s
low")#3D#3D0000).{#0A..4slowflag.#3D.1;#0A..4contin
ue;#0A..2}#0A#0A..2if.(strcmp(argv[i],."-s")#3D#3D0
000).{#0A..4/*#0A..4Invoke.a.CLI.command.interprete
r.giving.it.the.current.file.to#0A..4execute.as.a.s
equence.of.commands#2E..It.is.used.to.enable.execut
able.CLI#0A..4scripts.to.be.invoke.from.Unix#2E#0A#0A
..4Example:.Make.and.executable.file.test1.containi
ng.something.like:#0A#0A..4#23!/home/mr/distributio
n/Cintpos/cintpos/cintpos.-s#0A..4bcpl.com/bcpl#2Eb
.to.junk#0A..4echo."*nCompilation.done*n"#0A#0A..4#23
!/home/mr/distribution/BCPL/cintcode/cintsys.-s#0A.
.4bcpl.com/bcpl#2Eb.to.junk#0A..4echo."*nCompilatio
n.done*n"#0A#0A..4and.run.it.by.typing.the.Unix.com
mand:.test1#0A..4*/#0A#0A..4char.*fname.#3D.argv[i.
+.1];#0A..4if.(!fname).{#0A..6fprintf(stderr,."miss
ing.parameter.for.-s\n");#0A..6exit(-1);#0A..4}#0A.
.4prepend_stdin("c",.argc,.argv,.i);#0A..4break;#0A
..2}#0A#0A..2if.(strcmp(argv[i],."--")#3D#3D.0).{#0A
..4/*.Like.-c.but.reattach.standard.input.after.exh
austing.command.*/#0A..4/*.line.characters#2E.*/#0A
..4reattach_stdin.#3D.1;./*.TRUE.*/#0A..2}#0A#0A..2
if.(strcmp(argv[i],."-c")#3D#3D.0.||.strcmp(argv[i]
,."--")#3D#3D.0).{#0A..4/*.Allocate.a.buffer.to.hol
d.remaining.args.as.a.string.and.pass#0A..4**.remai
nder.of.command.line.to.the.interpreter#2E#0A#0A..4
**.Typical.usage:#0A#0A..4**.cintpos.-c.bcpl.com/bc
pl#2Eb.to.junk#0A..4**.cintsys.-c.bcpl.com/bcpl#2Eb
.to.junk#0A..4*/#0A#0A..4prepend_stdin(NULL,.argc,.
argv,.i);#0A..4break;#0A..2}#0A#0A..2if.(strcmp(arg
v[i],."-v")#3D#3D.0).{.boottrace#3D1;.continue;.}#0A
#0A..2if.(strcmp(argv[i],."-vv")#3D#3D.0).{.boottra
ce#3D2;.continue;.}#0A#0A..2if.(strcmp(argv[i],."-h
")!#3D0).PRINTF("Unknown.command.option:.%s\n",.arg
v[i]);#0A#0A..2PRINTF("\nValid.arguments:\n\n").;#0A
..2PRINTF("-h..10Output.this.help.information\n");#0A
..2PRINTF("-m.n..8Set.Cintcode.memory.size.to.n.wor
ds\n");#0A..2PRINTF("-t.n..8Set.Tally.vector.size.t
o.n.words\n");#0A..2PRINTF("-c.args..5"#0A..9"Pass.
args.to.interpreter.as.standard.input.(executable.b
ytecode)\n");#0A..2PRINTF("--.args..5"#0A..9"Pass.a
rgs.to.interpreter.standard.input,.then.re-attach.s
tdin\n");#0A..2PRINTF("-s.file.args.."#0A..9"Invoke
.command.interpreter.on.file.with.args.(executable.
scripts)\n");#0A..2PRINTF("-cin.name..3Set.the.path
var.environment.variable.name\n");#0A..2PRINTF("-f.
.10Trace.the.use.of.environment.variables.in.pathin
put\n");#0A..2PRINTF("-v..10Trace.the.bootstrapping
.process\n");#0A..2PRINTF("-vv..9As.-v,.but.also.in
clude.some.Cincode.level.tracing\n");#0A#0A..2PRINT
F("-d..10Cause.a.dump.of.the.Cintcode.memory.to.DUM
P#2Emem\n");#0A..2PRINTF("..12if.a.fault/error.is.e
ncountered\n");#0A#0A..2PRINTF("-slow..7Force.the.s
low.interpreter.to.always.be.selected\n");#0A#0A..2
return.0;#0A..}#0A#0A..if(boottrace>0).PRINTFD("Boo
t.tracing.level.is.set.to.%d\n",.boottrace);#0A#0A.
.if.(memupb<5002.||.tallyupb<0).{#0A..2PRINTF("Bad.
-m.or.-t.size\n");#0A..2return.10;#0A..}#0A#0A..if(
boottrace).{#0A..2char.*bytestr.#3D."ABCD1234";#0A.
.2int.litend.#3D.0;#0A..2printf("\ncintsys64.27.May
.2013..00020:26\n\n");#0A..2printf("bytestr#3D%s.wo
rd.0.#3D.%8".FormX."\n",.bytestr,.*((BCPLWORD*)byte
str));#0A..2if((1BCPLWORD*)bytestr)[0]&255#3D#3D'A'
).litend.#3D.1;#0A#23ifdef.BIGENDER#0A..2printf("BI
GENDER.is.defined");#0A..2if(litend#3D#3D0000)..pri
ntf(".but.the.host.machine.is.a.little.ender");#0A#23
else#0A..2printf("BIGENDER.is.not.defined");#0A..2i
f(litend#3D#3D0001)..printf(".but.the.host.machine.
is.a.big.ender");#0A#23endif#0A..2printf("\n");#0A.
.2printf("sizeof(int)..6#3D.%d\n",.(int)sizeof(int)
);#0A..2printf("sizeof(long)..5#3D.%d\n",.(int)size
of(long));#0A..2printf("sizeof(BCPLWORD)..1#3D.%d\n
",.(int)sizeof(BCPLWORD));#0A..2printf("sizeof(BCPL
WORD.*).#3D.%d\n",.(int)sizeof(BCPLWORD.*));#0A..2p
rintf("FormD.is.\"%s\"\n",.FormD);#0A..2printf("For
mX.is.\"%s\"\n",.FormX);#0A..}#0A#0A..if(badimpleme
ntation())#0A..{.PRINTF("This.implementation.of.C.i
s.not.suitable\n");#0A..2return.0;#0A..}#0A#0A..ini
tfpvec();#0A#0A..W.#3D.PT.malloc((memupb+tallyupb+v
ecstatsvupb+7)<<B2Wsh);#0A#0A..if(W#3D#3DNULL)#0A..
{.PRINTF("Insufficient.memory.for.memvec\n");#0A..2
return.0;#0A..}#0A../*..printf("Cintcode.memory.%8"
.FormX.".(unrounded)\n",.(UBCPLWORD).W);.*/#0A..W.#3D
.PT((1long).W.+.7L).&.-8L);#0A../*..printf("Cintcod
e.memory.%8".FormX".(rounded)\n",.(UBCPLWORD)W);..*
/#0A#0A..lastWp.#3D.W;#0A..lastWg.#3D.W;#0A..lastst
.#3D.3;./*.Pretend.to.be.in.the.interrupt.service.r
outine.*/#0A#0A..for.(i#3D0;.i<memupb;.i++).W[i].#3D
.0xDEADC0DE;#0A#0A..if.(boottrace>0).PRINTFD("Cintc
ode.memory.(upb#3D%".FormD.").allocated\n",.memupb)
;#0A#0A..W[0].#3D.memupb+1;../*.Initialise.heap.spa
ce.*/#0A..W[memupb].#3D.0;#0A#0A..tallylim.#3D.0;#0A
..tallyvec.#3D.memupb+1;#0A..tallyv.#3D.&W[tallyvec
];#0A..tallyv[0].#3D.tallyupb;#0A..for(i#3D1;.i<#3D
tallyupb;.i++).tallyv[i].#3D.0;#0A#0A..vecstatsvec.
#3D.tallyvec.+.tallyupb.+.1;#0A..vecstatsv.#3D.&W[v
ecstatsvec];#0A..for(i#3D0;.i<#3Dvecstatsvupb;.i++)
.vecstatsv[i].#3D.0;#0A.#0A..getvec(rootnode-12);..
/*.Allocate.space.for.interrupt.vectors.*/#0A#0A../
/.Allocate.the.rootnode.in.exactly.the.correct.plac
e.in.Cintcode.memory#0A..if.(rootnode.!#3D.(i#3Dget
vec(100L)+1)).{#0A..2printf("The.root.node.was.at.%
d.not.at.%d\n",.i,.rootnode);#0A..}#0A#0A..//.Alloc
ate.space.for.the.environment.variable.names#0A..//
.and.file.prefix.string#2E#0A..rootvarstr..2#3D.get
vec(5*16);#0A..pathvarstr..2#3D.rootvarstr+1*16;#0A
..hdrsvarstr..2#3D.rootvarstr+2*16;#0A..scriptsvars
tr.#3D.rootvarstr+3*16;#0A..prefixstr..3#3D.rootvar
str+4*16;#0A..prefixbp..4#3D.(char.*)(&W[prefixstr]
);#0A..for(i#3D0;.i<#3D5*16;.i++).W[rootvarstr+i].#3D
.0;#0A#0A..c2b_str(rootvar,.rootvarstr);#0A..c2b_st
r(pathvar,.pathvarstr);#0A..c2b_str(hdrsvar,.hdrsva
rstr);#0A..c2b_str(scriptsvar,.scriptsvarstr);#0A#0A
..dcountv..2#3D.getvec(511);..14//.Allocate.the.deb
ug.counts.vector#0A..W[dcountv].#3D.511;#0A..for(i#3D
1;.i<#3D511;.i++).W[dcountv+i].#3D.0;#0A#0A..if(fil
etracing).{#0A..2char.*path.#3D.getenv(rootvar);#0A
..2PRINTFS("Environment.variable.%s",.rootvar);#0A.
.2PRINTFS(".#3D.%s\n",.path);#0A..2path.#3D.getenv(
pathvar);#0A..2PRINTFS("Environment.variable.%s",.p
athvar);#0A..2PRINTFS(".#3D.%s\n",.path);#0A..2path
.#3D.getenv(hdrsvar);#0A..2PRINTFS("Environment.var
iable.%s",.hdrsvar);#0A..2PRINTFS(".#3D.%s\n",.path
);#0A..2path.#3D.getenv(scriptsvar);#0A..2PRINTFS("
Environment.variable.%s",.scriptsvar);#0A..2PRINTFS
(".#3D.%s\n",.path);#0A..}#0A#0A..stackbase.#3D.get
vec(Stackupb+6);../*.+6.because.it.will.be.a.corout
ine.*/#0A..globbase..#3D.getvec(Globupb);#0A..resul
t2.#3D.0L;#0A#0A..if.(boottrace>0).PRINTF("Boot's.s
tack.allocated.at.%".FormD."\n",.stackbase);#0A#0A.
.W[stackbase].#3D.Stackupb;./*.Tell.boot.how.large.
its.stack.is#2E.*/#0A..for(i#3D1;.i<#3DStackupb+6;.
i++).W[stackbase+i].#3D.0xABCD1234;#0A../*.boot.wil
l.turn.this.stack.into.a.coroutine.stack.*/#0A#0A..
if.(boottrace>0)#0A..2PRINTF("Boot's.global.vector.
allocated.at.%".FormD."\n",.globbase);#0A#0A..for(i
.#3D.0;.i<#3DGlobupb;.i++).W[globbase+i].#3D.Globwo
rd+i;#0A..W[globbase+Gn_globsize].#3D.Globupb;#0A..
W[globbase+Gn_rootnode].#3D.rootnode;#0A#0A..for(i#3D
0;.i<#3DRtn_upb;.i++).W[rootnode+i].#3D.0;#0A#0A..W
[rootnode+Rtn_membase]..4#3D.0;#0A..W[rootnode+Rtn_
memsize]..4#3D.memupb;#0A..W[rootnode+Rtn_blklist].
.4#3D.0;#0A..W[rootnode+Rtn_tallyv]..5#3D.tallyvec;
#0A..W[rootnode+Rtn_vecstatsv]..2#3D.vecstatsvec;#0A
..W[rootnode+Rtn_vecstatsvupb].#3D.vecstatsvupb;#0A
..W[rootnode+Rtn_boottrace]..2#3D.(BCPLWORD).boottr
ace;#0A..W[rootnode+Rtn_dumpflag]..3#3D.dumpflag;#0A
..{.//.This.fudge.is.for.systems.where.the.size.of.
BCPLWORD#0A..2//.and.BCPLWORD*.are.different#2E.The
.fields.mc1.to.mc3.are#0A..2//.only.used.by.the.MC.
package#0A..2union.{.BCPLWORD.*p;#0A..10BCPLWORD.v[
2];}.pv;#0A..2union.{.BCPLWORD.(*f)(char*,.BCPLWORD
);#0A..10BCPLWORD.v[2];}.fv;#0A..2pv#2Ev[0].#3D.pv#2E
v[1].#3D.0;#0A..2pv#2Ep.#3D.W;..13/*.Cintcode.memor
y.*/#0A..2W[rootnode+Rtn_mc0]..8#3D.pv#2Ev[0];#0A..
2W[rootnode+Rtn_mc1]..8#3D.pv#2Ev[1];#0A..2fv#2Ev[0
].#3D.fv#2Ev[1].#3D.0;#0A..2fv#2Ef.#3D.mcprf;..9/*.
The.MC.prf.fn.*/#0A..2W[rootnode+Rtn_mc2]..8#3D.fv#2E
v[0];#0A..2W[rootnode+Rtn_mc3]..8#3D.fv#2Ev[1];#0A.
.}#0A..W[rootnode+Rtn_rootvar]..4#3D.rootvarstr;#0A
..W[rootnode+Rtn_pathvar]..4#3D.pathvarstr;#0A..W[r
ootnode+Rtn_hdrsvar]..4#3D.hdrsvarstr;#0A..W[rootno
de+Rtn_scriptsvar]..1#3D.scriptsvarstr;#0A#0A..W[ro
otnode+Rtn_dcountv]..4#3D.dcountv;#0A#0A..if.(boott
race>0).PRINTF("Rootnode.allocated.at.%d\n",.rootno
de);#0A#0A..if.(boottrace>0).PRINTF("Loading.reside
nt.programs.and.libraries\n");#0A#0A..{.BCPLWORD.se
g.#3D.loadseg("syscin/boot");#0A..2if(seg#3D#3D0000
).{#0A..4PRINTF("\nUnable.to.find.syscin/boot\n");#0A
..4PRINTF("This.is.probably.caused.by.incorrect.set
tings.of\n");#0A..4PRINTF("environment.variables.su
ch.as.BCPLROOT.and.BCPL64PATH\n");#0A..4PRINTF("Try
.entering.cintsys.using.the.command\n");#0A..4PRINT
F("\ncintsys64.-f.-v\n\n");#0A..4PRINTF("to.see.wha
t.is.happening\n");#0A..4return.20;#0A..2}#0A..2W[r
ootnode+Rtn_boot].#3D.globin(seg,.globbase);#0A..2i
f(W[rootnode+Rtn_boot]#3D#3D0000).{#0A..4PRINTF("Ca
n't.globin.boot\n");#0A..4return.20;#0A..2}#0A#0A..
2if.(boottrace>0).PRINTF("syscin/boot.loaded.succes
sfully\n");#0A#0A..2seg.#3D.loadseg("syscin/blib");
#0A..2if(seg#3D#3D0000).{.PRINTF("Can't.load.syscin
/blib\n");.return.20;.}#0A..2if.(boottrace>0).PRINT
F("syscin/blib.loaded.successfully\n");#0A#0A..2seg
.#3D.concatsegs(seg,.loadseg("syscin/syslib"));#0A.
.2if(seg#3D#3D0000).{.PRINTF("Can't.load.syscin/sys
lib\n");.return.20;.}#0A..2if.(boottrace>0).PRINTF(
"syscin/syslib.loaded.successfully\n");#0A#0A..2seg
.#3D.concatsegs(seg,.loadseg("syscin/dlib"));#0A..2
if(seg#3D#3D0000).{.PRINTF("Can't.load.syscin/dlib\
n");.return.20;.}#0A..2if.(boottrace>0).PRINTF("sys
cin/dlib.loaded.successfully\n");#0A#0A..2W[rootnod
e+Rtn_blib].#3D.globin(seg,.globbase);#0A..2if(W[ro
otnode+Rtn_blib]#3D#3D0000).{#0A..4PRINTF("Can't.gl
obin.{blib,syslib,dlib}\n");#0A..4return.20;#0A..2}
#0A..}#0A#0A#23ifndef.forWinCE#0A../*.Set.handler.f
or.CTRL-C.*/#0A..old_inthandler..#3D.signal(SIGINT,
.inthandler);./*.To.catch.CTRL-C.*/#0A../*.Set.hand
ler.for.segment.violation.*/#0A..old_segvhandler..#3D
.signal(SIGSEGV,.segvhandler);./*.To.catch.segv.*/#0A
#23endif#0A#0A../*.Make.sys.available.via.the.root.
node.*/#0A..W[rootnode+Rtn_sys].#3D.W[globbase+Gn_s
ys];#0A..//printf("sys.code.is.%16llX\n",.W[globbas
e+Gn_sys]);#0A#0A../*#0A..boot.has.no.coroutine.env
ironment#2E..Note.that.boot's.global.vector.is.also
#0A..used.by.interrupt.service.routines#2E.The.chai
n.of.stack.frames.in.such.an#0A..environment.must.b
e.terminated.by.a.zero.link.(for.DEBUG.to.work.prop
erly)#2E#0A..*/#0A..W[globbase+Gn_currco].#3D.0;#0A
..W[globbase+Gn_colist].#3D.0;#0A#0A../*.Set.the.bo
ot.registers.ready.for.the.Cintcode.interpreter.*/#0A
#0A..W[bootregs+0].#3D.0;..14/*.A.*/#0A..W[bootregs
+1].#3D.0;..14/*.B.*/#0A..W[bootregs+2].#3D.0;..14/
*.C.*/#0A..W[bootregs+3].#3D.stackbase<<B2Wsh;./*.P
.*/#0A..W[bootregs+4].#3D.globbase<<B2Wsh;../*.G.*/
#0A..W[bootregs+5].#3D.2;..14/*.ST.--.in.boot,.inte
rrupts.disabled.*/#0A..W[bootregs+6].#3D.W[globbase
+1];..2/*.PC.(start.in.boot).*/#0A..W[bootregs+7].#3D
.-1;..13/*.Count.*/#0A..W[bootregs+8].#3D.0;..14/*.
MW.*/#0A#0A../*.A.debbugging.aid!!.*/#0A../*.tracin
g.#3D.1;.*/#0A#0A..init_keyb();#0A../*.Call.the.slo
w.interpreter.even.though.Count#3D-1.*/#0A..if.(boo
ttrace>0).PRINTF("Calling.the.interpreter\n");#0A..
if.(boottrace>1)#0A..{.PRINTF("Turning.instruction.
tracing.on\n");#0A..2tracing.#3D.1;#0A..}#0A#0A..re
s.#3D.interpret(bootregs,.W);#0A..if.(boottrace>0)#0A
..2PRINTFD("interpreter.returned.control.to.cintsys
,.res#3D%".FormD."\n",.res);#0A#0A..close_keyb();#0A
#0A..if.(res).{#0A..2PRINTFD("\nExecution.finished,
.return.code.%".FormD"\n",.res);#0A#0A..2if.(res.&&
.W[rootnode+Rtn_dumpflag]).{#0A..4dumpmem(W,.memupb
,.3);#0A..4PRINTF("\nCintpos.memory.dumped.to.DUMP#2E
mem,.context#3D3\n");#0A..2}#0A..}#0A..PRINTF("\n")
;#0A../*Change.suggested.by.Dave.Lewis.-.return.cli
_returncode.rather.than.res.*/#0A..return.W[globbas
e+Gn_cli_returncode];./*.MR.17/01/06.*/#0A../*retur
n.res;.*/#0A}#0A#0ABCPLWORD.concatsegs(BCPLWORD.seg
1,.BCPLWORD.seg2).{#0A..BCPLWORD.p.#3D.seg1;#0A..if
(p#3D#3D0000.||.seg2#3D#3D0000).return.0;#0A..while
(W[p]).p.#3D.W[p];#0A../*PRINTFD("concatsegs:.seg1.
%".FormD".",.seg1);.*/#0A../*PRINTFD("seg2.%".FormD
.".",.seg2);.*/#0A../*PRINTFD("p.%".FormD."\n",.p);
.*/#0A..W[p].#3D.seg2;#0A..return.seg1;#0A}#0A#0ABC
PLWORD.loadsegfp(FILEPT.fp)#0A{.BCPLWORD.list..#3D.
0;#0A..BCPLWORD.liste.#3D.0;#0A#0A..for(;;)#0A..{.B
CPLWORD.type.#3D.rdhex(fp);#0A..2/*PRINTFD("loadseg
type.#3D.%".FormD."\n",.type);.*/#0A..2switch((int)
type)#0A..2{.default:#0A..8err:..1unloadseg(list);#0A
..15list.#3D.0;#0A..4case.-1:..1#0A..15return.list;
#0A#09#09.#0A..4case.T_hunk64:#0A..13{.BCPLWORD.i,.
n#3Drdhex(fp);#0A..15BCPLWORD.space.#3D.getvec(n);#0A
#09#09./*#0A..15PRINTFD("loading.hunk.size.%".FormD
.".",.n);#0A#09#09.PRINTFD("to.%".FormD."\n",.space
);#0A..15*/#0A..15if(space#3D#3D0000).goto.err;#0A.
.15W[space].#3D.0;#0A..15for(i.#3D.1;.i<#3Dn;.i++).
W[space+i].#3D.rdhex(fp);#0A#09#09.//if(n<#3D24)for
(i.#3D.1;.i<#3Dn;.i++)#0A#09#09.//printf("%5lld..%5
lld:.%16llX\n",..space,.i,.W[space+i]);#0A..15if(li
st#3D#3D0000).list#3Dspace;#0A..15else.W[liste].#3D
.space;#0A..15liste.#3D.space;#0A..15continue;#0A..
13}#0A#09#09.#0A..4case.T_bhunk64:./*.For.hunks.in.
binary.(not.hex).*/#0A..14{.BCPLWORD.n;#0A..16BCPLW
ORD.space;#0A..16int.len.#3D.fread((char.*)&n,.(siz
e_t)4,.(size_t)1,.fp);#0A..16if.(len!#3D1.&&.len!#3D
4).goto.err;#0A..16space.#3D.getvec(n);#0A..16if(sp
ace#3D#3D0000).goto.err;#0A..16W[space].#3D.0;#0A..
16len.#3D.fread((char.*)&W[space+1],.(size_t)4,.(si
ze_t)n,.fp);#0A..16if.(len!#3Dn.&&.len!#3D4*n).goto
.err;#0A..16if(list#3D#3D0000).list#3Dspace;#0A..16
else.W[liste].#3D.space;#0A..16liste.#3D.space;#0A.
.16continue;#0A..14}#0A#09#09.#0A..4case.T_end64:#0A
#09..8break;#0A..2}#09#09.#0A..}#09#09.#0A}.#09#09.
#0A#0ABCPLWORD.loadseg(char.*file)#0A{.BCPLWORD.lis
t..#3D.0;#0A..BCPLWORD.liste.#3D.0;#0A#0A..//PRINTF
("loadseg:.attempting.to.load.file.%s\n",.file);#0A
#0A..//.First.look.in.the.current.directory#0A..FIL
EPT.fp.#3D.pathinput(file,.0);#0A#0A..if.(fp)#0A..{
.list.#3D.loadsegfp(fp);#0A..2fclose(fp);#0A..2if.(
list).return.list;#0A..2fp.#3D.0;#0A..}#0A.#0A..//.
The.module.was.not.found.in.the.current.directory.o
r.it#0A..//.was.invalid.so.look.in.the.directories.
specified.by.the.environment#0A..//.variable.whose.
name.is.in.the.pathvar.entry.of.the.rootnode#2E#0A.
.if(fp#3D#3DNULL).{#0A..2char.envname[256];#0A..2fp
.#3D.pathinput(file,.b2c_str(W[rootnode+Rtn_pathvar
],.envname));#0A..}#0A#0A..//if(fp#3D#3DNULL).{#0A.
.//..char.chbuf[256];#0A..//../*.It.was.not.found.i
n.the.BCPL64PATH.directories.so.*/#0A..//../*.look.
in.<BCPL64ROOT>/cin,.ie.preprend.cin/.to.file.*/#0A
..//../*PRINTFS("loadseg:.searching.for.%s.in.$BCPL
64ROOT/cin\n",.file);.*/#0A..//..fp.#3D.pathinput(c
atstr2c_str("cin/",.file,.chbuf),."BCPL64ROOT");#0A
..//}#0A..if(fp#3D#3DNULL).return.0;#0A#0A..list.#3D
.loadsegfp(fp);#0A..fclose(fp);#0A..return.list;#0A
}#0A#0Avoid.unloadseg(BCPLWORD.segl)#0A{.while(segl
).{.BCPLWORD.s.#3D.W[segl];#0A..14freevec(segl);#0A
..14segl.#3D.s;#0A..12}#0A}#0A#0A/*.rdhex.reads.in.
one.hex.number.including.the.terminating.character#0A
..1and.returns.its.BCPLWORD.value#2E.EOF.returns.-1
#2E#0A*/#0ABCPLWORD.rdhex(FILEPT.fp)#0A{..BCPLWORD.
w.#3D.0;#0A..1int.ch.#3D.fgetc(fp);#0A#0A..1while(c
h#3D#3D'.'.||.ch#3D#3D'\n'.||.ch#3D#3D'\r').ch.#3D.
fgetc(fp);#0A#0A..1if.(ch#3D#3D'#23').{./*.remove.c
omments.from.object.modules.*/#0A..16while.(ch.!#3D
.'\n'.&&.ch.!#3D.EOF).ch.#3D.fgetc(fp);#0A..16retur
n.rdhex(fp);#0A..14}#0A#0A..1for(;;)#0A..1{..int.d.
#3D.100;#0A..4if('0'<#3Dch.&&.ch<#3D'9').d.#3D.ch-'
0';#0A..4if('A'<#3Dch.&&.ch<#3D'F').d.#3D.ch-'A'+10
;#0A..4if('a'<#3Dch.&&.ch<#3D'f').d.#3D.ch-'a'+10;#0A
#09#09.#0A..4if(d#3D#3D000100).return.ch#3D#3DEOF.?
.-1.:.w;#0A..4w.#3D.(w<<0004).|.d;#0A..4ch.#3D.fget
c(fp);#0A..1}#09#09.#0A}#09#09.#0A#09#09.#0ABCPLWOR
D.globin(BCPLWORD.segl,.BCPLWORD.g)#0A{.BCPLWORD..a
.#3D.segl,.globsize.#3D.W[g];#0A../*PRINTFD("globin
.segl.#3D.%6".FormD"..",.segl);.*/#0A../*PRINTFD("g
.#3D.%6".FormD."\n",.g);.*/#0A..while.(a).{.BCPLWOR
D.base.#3D.(a+1)<<B2Wsh;#0A..12BCPLWORD.i.#3D.a.+.W
[a+1];#0A..12if.(W[i]>globsize).return.0;#0A#09..4/
*PRINTFD("globin:..base.%6".FormD."..",.a+1);.*/.#0A
#09..4/*PRINTFD("to.%6".FormD."..",.i);.*/#0A#09..4
/*PRINTFD("size:.%5".FormD."\n",.W[a+1]);.*/.#0A..1
2for(;;).{.i.-#3D.2;#0A..22if.(W[i+1]#3D#3D0000).br
eak;#0A..22W[g+W[i]].#3D.base.+.W[i+1];#0A#09#091/*
#0A..22PRINTFD("globin:..g[%3".FormD."].",.W[i]);#0A
#09#091PRINTFD("#3D.%6".FormD."\n",.base+W[i+1]);#0A
..22*/#0A..20}#0A..12a.#3D.W[a];#0A..10}#0A..return
.segl;#0A}#0A#0ABCPLWORD.getvec(BCPLWORD.requpb)#0A
{.BCPLWORD.upb.#3D.requpb+4+4;../*.Allocate.4.words
.at.the.end.for.safety.*/#0A..28/*.plus.4.words.of.
task.name#2E.*/#0A..BCPLWORD.p;#0A..BCPLWORD.q.#3D.
0;./*.The.start.of.the.block.list.*/#0A..BCPLWORD.n
.#3D.(upb+1+1+1).&.0xFF5E;../*.Add.1.word.for.size.
and.alloc.bit#0A..40and.1.word.for.word.zero.and#0A
..40then.round.up.to.an.even.size.*/#0A..#0A..do#0A
..{.p.#3D.q;#0A..2for(;;).{.BCPLWORD.size.#3D.W[p];
#0A..12if((size&1).!#3D.0).break;#0A..12if(.size.#3D
#3D.0)..2return.0;#0A..12p.+#3D.size;#0A..10}#0A..2
q.#3D.p;../*.find.next.used.block.*/#0A..2for(;;).{
.BCPLWORD.size.#3D.W[q];#0A..12if((size&1).#3D#3D.0
).break;#0A..12q.+#3D.size-1;#0A..10}#0A..}.while(q
-p<n);#0A..#0A..if(p+n!#3Dq)#0A..2W[p+n].#3D.q-p-n+
1;./*.If.splitting,.the.size.of.the.other.part.with
.a#0A..23flag.of.1.indicating.that.it.is.free.*/#0A
..W[p].#3D.n;..9/*.The.size.of.this.block.in.words.
with.a.flag.of.zero#0A..23indicating.that.it.is.all
ocated.*/#0A../*.The.following.improves.the.safety.
of.memory.allocation.*/#0A../*.by.adding.some.check
able.redundancy.*/#0A..W[p+n-9].#3D.0xCC6;../*.Funn
y.pattern.for.possible.roundup.word.*/#0A..W[p+n-8]
.#3D.0x556;../*.Special.patterns.*/#0A..W[p+n-7].#3D
.0xAA6;#0A..W[p+n-6].#3D.requpb;..4/*.The.requested
.upb.*/#0A#0A..W[p+n-5].#3D.taskname[0];./*.The.tas
kname,.if.any.*/#0A..W[p+n-4].#3D.taskname[1];./*.T
he.taskname,.if.any.*/#0A..W[p+n-3].#3D.taskname[2]
;./*.The.taskname,.if.any.*/#0A..W[p+n-2].#3D.taskn
ame[3];./*.The.taskname,.if.any.*/#0A#0A..W[p+n-1].
#3D.p;..9/*.Pointer.to.base.of.this.memory.block.*/
#0A../*PRINTFD("getvec:.allocating.block.%6".FormD.
"..",.p);.*/#0A../*PRINTFD("upb.%4".FormD."\n",.upb
);.*/#0A#0A..if(requpb>vecstatsvupb).requpb.#3D.vec
statsvupb;#0A..W[vecstatsvec+requpb]++;#0A..return.
p+1;#0A}#0A#0ABCPLWORD.freevec(BCPLWORD.p)#0A{.BCPL
WORD.res.#3D.-1;../*.#3DTRUE.*/#0A..BCPLWORD.n,.upb
;#0A#0A..if(p#3D#3D0000).return.res;#0A#0A..p--;..5
/*.All.getvec'ed.blocks.start.on.odd.addresses.*/#0A
..n.#3D.W[p];#0A#0A..if(n.&.1).{#0A..2PRINTFD("\n#23
#232.freevec:.block.at.%".FormD.".already.free\n",.
p);#0A..2return.0;#0A..}#0A#0A../*PRINTFD("#23#232.
freevec:.Freeing.block.at.%".FormD."\n",.p);.*/#0A#0A
..if(W[p+n-1]!#3Dp.||#0A..3W[p+n-7]!#3D0xAA6.||#0A.
.3W[p+n-8]!#3D0x556).{#0A..5PRINTFD("\n#23#232.free
vec:.block.at.%".FormD.".",.p);#0A..5PRINTFD("size.
%".FormD.".corrupted",.n);#0A..5PRINTFD("\n#23#232.
freevec:.last.4.words.%8".FormX.".",.(UBCPLWORD)W[p
+n-8]);#0A..5PRINTFD("%8".FormX.".",..28(UBCPLWORD)
W[p+n-7]);#0A..5PRINTFD("%6".FormD.".",..28W[p+n-6]
);#0A..5PRINTFD("%7".FormD."\n",..27W[p+n-1]);#0A..
5PRINTFD("#23#232.freevec:.should.be..002556.AA6.re
qupb.%7".FormD."\n\n",#0A..14p);#0A..5res.#3D.0;#0A
..}#0A..W[p].|#3D.1;#0A../*.Deal.with.getvec.alloca
tion.statistics.*/#0A..upb.#3D.W[p+n-6];..5/*.The.r
equested.size.*/#0A..if(upb>vecstatsvupb).upb.#3D.v
ecstatsvupb;#0A..W[vecstatsvec+upb]--;./*.Decrement
.count.of.block.of.this.size.*/#0A..return.res;#0A}
#0A#0ABCPLWORD.muldiv1(BCPLWORD.a,.BCPLWORD.b,.BCPL
WORD.c).//.Not.for.64-bit.BCPL#0A{.//.This.version.
produces.the.same.results.as.muldiv1#0A..//.and.see
m.to.run.about.60%.faster#2E#0A..//.It.is.used.by.t
he.MDIV.instruction.(and.the.syslib.muldiv.function
)#2E#0A..BCPLINT64.ab.#3D.(BCPLINT64)a.*.(BCPLINT64
)b;#0A..if(c#3D#3D0000).c#3D1;#0A..result2.#3D.(BCP
LWORD)(ab.%.c);#0A..return.(BCPLWORD)(ab./.c);#0A}#0A
#0ABCPLWORD.muldiv(BCPLWORD.a,.BCPLWORD.b,.BCPLWORD
.c)#0A{.//.This.is.used.by.sys(Sys_muldiv,#2E#2E1)#0A
..unsigned.BCPLWORD.q#3D0,.r#3D0,.qn,.rn;#0A..unsig
ned.BCPLWORD.ua,.ub,.uc;#0A..int.qneg#3D0,.rneg#3D0
;#0A..if(c#3D#3D0000).c#3D1;#0A..if(a<0).{.qneg#3D!
qneg;.rneg#3D!rneg;.ua.#3D.-a;.}#0A..else..28ua.#3D
..a;#0A..if(b<0).{.qneg#3D!qneg;.rneg#3D!rneg;.ub.#3D
.-b;.}#0A..else..28ub.#3D..b;#0A..if(c<0).{.qneg#3D
!qneg;..11uc.#3D.-c;.}#0A..else..28uc.#3D..c;#0A..#0A
..qn.#3D.ub./.uc;#0A..rn.#3D.ub.%.uc;#0A..#0A..whil
e(ua)#0A..{.if(ua&1).{.q.+#3D.qn;#0A..13r.+#3D.rn;#0A
..13if(r>#3Duc).{.q++;.r.-#3D.uc;.}#0A..11}#0A..2ua
.>>#3D.1;#0A..2qn.<<#3D.1;#0A..2rn.<<#3D.1;#0A..2if
(rn>#3Duc).{.qn++;.rn.-#3D.uc;.}#0A..}#0A..result2.
#3D.rneg.?.-(BCPLWORD)r.:.r;#0A..return..2qneg.?.-(
BCPLWORD)q.:.q;#0A}#0A#0Aint.relfilename(char.*name
).{#0A/*#0Aname.is.a.C.string.representing.a.Cintsy
s/Cintpos.file.name#2E#0AIf.it.starts.with.'/'.(or.
'\').or.contains.a.colon.':',.it#0Arepresents.an.ab
solute.file.name.otherwise.it.is.relative#2E#0AThis
.function.returns#0A..0010.if.absolute,#0A..0011.if
.relative#2E#0A*/#0A..if(name[0]#3D#3D'/'.||.name[0
]#3D#3D'\\').return.0;#0A..while(*name).if(*name++#3D
#3D':').return.0;#0A..return.1;.#0A}#0A#0A/*.pathin
put.does.not.use.any.of.chbuf1,.chbuf2.or.chbuf3#2E
.*/#0AFILEPT.pathinput(char.*name,.char.*pathname)#0A
/*.name.is.a.Linux.style.filename.using.'/'.(not.'\
').as.the.separator#2E#0A..1If.pathname.is.null,.na
me.is.looked.up.in.the.current.directory,#0A..1othe
rwise.name.is.looked.up.in.the.directories.that.the
.environment#0A..1variable.pathname.specifies#2E.Th
ese.directories.should.now.be.separated.#0A..1by.';
'.(nor.':').even.under.Linux.or.Cygwin#2E#0A*/#0A{.
FILEPT.fp.#3D.0;#0A#0A..if.(.pathname#3D#3D0000.||.
!relfilename(name)).{#0A..2/*.If.no.pathname.given.
or.name.is.absolute.just.search.the.current.directo
ry.*/#0A..2//printf("pathinput:.pathname#3D0\n");#0A
..2fp.#3D.fopen(osfname(name,.chbuf4),."rb");#0A..2
if(filetracing)#0A..2{.PRINTFS("Trying:.%s.in.the.c
urrent.directory.-.",.name);#0A..4if(fp).{#0A..6PRI
NTF("found\n");#0A..4}.else.{#0A..6PRINTF("not.foun
d\n");#0A..4}#0A..2}#0A..2return.fp;#0A..}#0A#0A../
/printf("pathinput:.pathname#3D%s\n",.pathname);#0A
#0A../*.Look.through.the.PATH.directories.if.pathna
me.is.given#2E.*/#0A..{.char.*path.#3D.getenv(pathn
ame);#0A.#0A..2if(filetracing).{#0A..4PRINTFS("path
input:.attempting.to.open.%s",.name);#0A..4PRINTFS(
".using\n..%s",.pathname);#0A..4PRINTFS(".#3D.%s\n"
,.path);#0A..2}#0A#0A..2/*.Try.prefixing.with.each.
directory.in.the.path.until.the#0A..5file.can.be.op
enned.successfully.*/#0A..2while(path)#0A..2{.char.
str[256];#0A..4char.*filename.#3D.&str[0];#0A..4cha
r.*f#3Dfilename;#0A..4char.*n#3Dname;#0A..4char.las
tch#3D0;#0A..4//.f.points.to.the.next.character.of.
constructed.filename#0A..4//.n.points.to.the.next.c
haracter.of.name#0A#0A..4//.Prefix.the.next.directo
ry.name.after.skipping.over#0A..4//.a.separator,.if
.necessary#2E#0A..4while(1)#0A..4{.char.ch.#3D.*pat
h;#0A..6if(ch#3D#3D';').{.path++;.continue;.}#0A#23
ifndef.WINNAMES#0A..6if(ch#3D#3D':').{.path++;.cont
inue;.}#0A#23endif#0A..6break;#0A..4}#0A..4if(*path
#3D#3D0000).break;#0A..4/*.Copy.the.directory.name.
into.filename.*/#0A..4while(1)#0A..4{.char.ch.#3D.*
path;#0A..6if(ch#3D#3D0000).break;#0A..6path++;#0A.
.6if(ch#3D#3D';').break;#0A#23ifndef.WINNAMES#0A#09
if(ch#3D#3D':').break;#0A#23endif#0A..6*f++.#3D.ch;
#0A..6lastch.#3D.ch;#0A..4}#0A..4/*.Insert.a.filena
me.'/'.if.necessary#2E.*/#0A..4if(lastch!#3D'/'.&&.
lastch!#3D'\\').*f++.#3D.'/';#0A#0A..4/*.Append.the
.given.file.name.*/#0A..4while(1)#0A..4{.char.ch.#3D
.*n++;#0A..6*f++.#3D.ch;#0A..6if(ch#3D#3D0000).brea
k;#0A..4}#0A#0A..4fp.#3D.fopen(osfname(filename,.ch
buf4),."rb");#0A..4if(filetracing)#0A..4{.PRINTFS("
Trying:.%s.-.",.filename);#0A..6if(fp).{#0A..8PRINT
F("found\n");#0A#09}.else.{#0A..8PRINTF("not.found\
n");#0A#09}#0A..4}#0A..4if(fp).return.fp;#0A..4//.T
ry.using.the.next.directory.in.the.path#0A..2}#0A..
2//.Not.found.in.any.of.the.path.directories.so.loo
k.in.the#0A..2//.current.directory#0A#0A..2fp.#3D.f
open(osfname(name,.chbuf4),."rb");#0A..2if(filetrac
ing)#0A..2{.PRINTFS("Trying:.%s.in.the.current.dire
ctory.-.",.name);#0A..4if(fp).{#0A..6PRINTF("found\
n");#0A..4}.else.{#0A..6PRINTF("not.found\n");#0A..
4}#0A..2}#0A..2return.fp;#0A..}#0A}#0A#0ABCPLWORD.d
osys(register.BCPLWORD.p,.register.BCPLWORD.g)#0A{.
register.BCPLWORD.i;#0A../*PRINTFD("dosys(%".FormD.
",.",.p);.*/#0A../*PRINTFD("%".FormD,.g);.*/#0A../*
PINTFD(").P3#3D%".FormD.".",.W[p+3]);.*/#0A../*PRIN
TFD("P4#3D%".FormD."\n",..W[p+4]);.*/#0A..switch((i
nt)(W[p+3]))#0A..{.default:.PRINTFD("\nBad.sys.numb
er:.%".FormD."\n",.W[p+3]);#0A..11return.W[p+3];#0A
#0A..2/*.case.Sys_setcount:.set.count..13--.done.in
.cinterp#0A..2**.case.Sys_quit:..3return.from.inter
preter.--.done.in.cinterp#0A#0A..2**.case.Sys_rti:.
.4sys(Sys_rti,.regs)..4--.done.in.cinterp..Cintpos#0A
..2**.case.Sys_saveregs:.sys(Sys_saveregs,.regs).--
.done.in.cinterp..Cintpos#0A..2**.case.Sys_setst:..
2sys(Sys_setst,.st)..4--.done.in.cinterp..Cintpos#0A
..2*/#0A..2case.Sys_tracing:../*.sys(Sys_tracing,.b
).*/#0A..10tracing.#3D.W[p+4];#0A..10return.0;#0A..
2/*.case.Sys_watch:..2sys(Sys_watch,.addr)..2--.don
e.in.cinterp#0A..2*/#0A#0A..2case..Sys_tally:..7/*.
sys(Sys_tally,.flag)..3*/#0A..11if(W[p+4]).{#0A..14
tallylim.#3D.tallyupb;#0A..14for(i#3D1;.i<#3Dtallyl
im;.i++).tallyv[i].#3D.0;#0A..12}.else.{#0A..14tall
ylim.#3D.0;#0A..12}#0A..12return.0;#0A..3#0A..2case
.Sys_interpret:./*.call.interpreter.(recursively).*
/#0A..10{.BCPLWORD.regsv.#3D.W[p+4];#0A#09#09//prin
tf("Sys_interpret:.regsv#3D%lld\n",.regsv);#0A#09#09
//printf("Sys_interpret:.W[regsv+7]#3D%lld\n",.W[re
gsv+7]);#0A..12if(W[regsv+7]>#3D0.||.slowflag).retu
rn.interpret(regsv,.W);#0A#09..4//printf("Sys_inter
pret:.Calling.CINTASM\n");#0A..12return.CINTASM..(r
egsv,.W);#0A..10}#0A#0A..2case.Sys_sardch:#0A..12{.
int.ch;#0A#0A..14if.(inbuf).{#0A..16/*.Input.taken.
from.command.line.*/#0A..16ch.#3D.inbuf_next();#0A.
.16if.(ch.#3D#3D.EOF).{./*.inbuf.is.now.empty.*/#0A
..18if.(reattach_stdin).{#0A..20free(inbuf);#0A..20
inbuf.#3D.0;./*.Don't.try.to.read.more.characters.*
/#0A#09#09..15/*.from.the.buffer.*/#0A..20/*.Contin
ue.with.normal.read.from.stdin.*/#0A..18}.else.{#0A
..20return.ch;./*.EOF.*/#0A..18}#0A..16}.else.{#0A.
.18return.ch;./*.valid.character.*/#0A..16}#0A..14}
#0A..14/*.Normal.case,.stdin.input.to.interpreter.*
/#0A#0A..14ch.#3D.Readch();./*.get.the.keyboard.cha
racter..*/#0A#09#09/*PRINTFD("Sys_sardch:.ch.#3D.%d
\n",.ch);.*/#0A#09#09if(ch#3D#3D000127)./*.RUBOUT.f
rom.the.keyboard.*/#0A#09#09..ch.#3D.8;..1/*.Replac
e.by.BS.*/#0A..14if.(ch>#3D0).putchar(ch);#0A..14if
(ch#3D#3D00013).{.ch.#3D.10;.putchar(10);.}#0A..14f
flush(stdout);#0A#09#09/*PRINTFD("Sys_sardch.return
ing.ch.#3D.%d\n",.ch);.*/#0A..14//incdcount(1);#0A.
.14return.ch;#0A..12}#0A#0A..2case.Sys_sawrch:#0A#23
ifdef.forCYGWIN32#0A..12if(W[p+4].#3D#3D.10).putcha
r(13);#0A#23endif#0A..12putchar((char)W[p+4]);#0A..
12fflush(stdout);#0A..12//incdcount(2);#0A..12retur
n.0;#0A#0A..2case.Sys_read:../*.bytesread.:#3D.sys(
Sys_read,.fp,.buf,.bytecount).*/#0A..12{.FILEPT.fp.
#3D.findfp(W[p+4]);#0A..14BCPLWORD.bbuf.#3D.W[p+5]<
<B2Wsh;#0A..14BCPLWORD.len..1#3D.(int).W[p+6];#0A#23
ifndef.forWinCE#0A..14clearerr(fp);./*.clear.eof.an
d.error.flag.*/#0A#23endif#0A..14len.#3D.fread(&(BP
.W)[bbuf],.(size_t)1,.(size_t)len,.fp);#0A#23ifndef
.forWinCE#0A..14if(ferror(fp)).{.perror("sys_read")
;#0A..31return.-1;./*.check.for.errors.*/#0A#09#09}
#0A#23endif#0A..14return.len;#0A..12}#0A#0A..2case.
Sys_write:#0A..4{.FILEPT.fp.#3D.findfp(W[p+4]);#0A.
.6BCPLWORD.bbuf.#3D.W[p+5]<<B2Wsh;#0A..6BCPLWORD.le
n.#3D.W[p+6];#0A..6/*fseek(fp,.0L,.SEEK_CUR);.*/./*
.Why??.MR.9/7/04.*/#0A..6len.#3D.WD.fwrite(&(BP.W)[
bbuf],.(size_t)1,.(size_t)len,.fp);#0A..6fflush(fp)
;#0A..6return.len;#0A..4}#0A#0A..2case.Sys_openread
:#0A..4{.char.*name.#3D.b2c_str(W[p+4],.chbuf1);#0A
..6FILEPT.fp;#0A..6fp.#3D.pathinput(name,..20/*.Fil
ename.*/#0A#09..13b2c_str(W[p+5],.chbuf2));../*.Env
ironment#0A#09..4#09#092..11variable.*/#0A..6if(fp#3D
#3D0000).return.0L;#0A..6return.newfno(fp);#0A..4}#0A
#0A..2case.Sys_openwrite:#0A..4{.char.*name.#3D.b2c
_str(W[p+4],.chbuf1);#0A..6FILEPT.fp;#0A..6fp.#3D.f
open(osfname(name,.chbuf4),."wb");#0A..6if(fp#3D#3D
0000).return.0L;#0A..6return.newfno(fp);#0A..4}#0A#0A
..2case.Sys_openappend:#0A..4{.char.*name.#3D.b2c_s
tr(W[p+4],.chbuf1);#0A..6FILEPT.fp;#0A..6fp.#3D.fop
en(osfname(name,.chbuf4),."ab");#0A..6if(fp#3D#3D00
00).return.0L;#0A..6return.newfno(fp);#0A..4}#0A#0A
..2case.Sys_openreadwrite:#0A..4{.char.*name.#3D.b2
c_str(W[p+4],.chbuf1);#0A#09FILEPT.fp;#0A..6fp.#3D.
fopen(osfname(name,.chbuf4),."rb+");#0A..6if(fp#3D#3D
0000).fp.#3D.fopen(name,."wb+");#0A..6if(fp#3D#3D00
00).return.0L;#0A..6return.newfno(fp);#0A..4}#0A#0A
..2case.Sys_close:#0A..2{.BCPLWORD.res.#3D.fclose(f
indfp(W[p+4]));#0A..4freefno(W[p+4]);#0A..4return.r
es#3D#3D0000.?.-1.:.0;./*.res#3D#3D0000.means.succe
ss.*/#0A..2}#0A#0A..2case.Sys_deletefile:#0A..2{.ch
ar.*name.#3D.b2c_str(W[p+4],.chbuf1);#0A..4FILEPT.f
p;#0A..4name.#3D.osfname(name,.chbuf4);#0A#23ifdef.
VMSNAMES#0A..4{./*.Append.';*'.to.name.*/#0A..6int.
len.#3D.0;#0A..6while.(name[len]).len++;#0A..6name[
len++].#3D.';';#0A..6name[len++].#3D.'*';#0A..6name
[len].#3D.0;#0A..4}#0A#23endif#0A..4return.!.REMOVE
(name);#0A..2}#0A#0A..2case.Sys_renamefile:#0A..2{.
char.*name1.#3D.b2c_str(W[p+4],.chbuf1);#0A..4char.
*name2.#3D.b2c_str(W[p+5],.chbuf2);#0A..4int.len.#3D
.0;#0A..4name1.#3D.osfname(name1,.chbuf3);#0A..4nam
e2.#3D.osfname(name2,.chbuf4);#0A#23ifdef.VMSNAMES#0A
..4{./*.Append.';*'.to.name2.*/#0A..6len.#3D.0;#0A.
.6while.(name2[len]).len++;#0A..6name2[len]..1#3D.'
;';#0A..6name2[len+1].#3D.'*';#0A..6name2[len+2].#3D
.0;#0A..4}#0A#23endif#0A..4REMOVE(name2);#0A#23ifde
f.VMSNAMES#0A..4name2[len].#3D.0;#0A#23endif#0A..4r
eturn.!.rename(name1,.name2);#0A..2}#0A#0A..2case.S
ys_getvec:#0A..12{.BCPLWORD.tcb.#3D.W[rootnode+Rtn_
crntask];#0A..14BCPLWORD.*tn.#3D.&W[tcb+Tcb_namebas
e];#0A#09..6taskname[0].#3D.(tcb#3D#3D0000).?.0.:.t
n[0];#0A#09..6taskname[1].#3D.(tcb#3D#3D0000).?.0.:
.tn[1];#0A#09..6taskname[2].#3D.(tcb#3D#3D0000).?.0
.:.tn[2];#0A#09..6taskname[3].#3D.(tcb#3D#3D0000).?
.0.:.tn[3];#0A..14return.getvec(W[p+4]);#0A#09..4}#0A
#0A..2case.Sys_freevec:#0A..14return.freevec(W[p+4]
);#0A#0A..2case.Sys_loadseg:#0A..12{.BCPLWORD.tcb.#3D
.W[rootnode+Rtn_crntask];#0A..14BCPLWORD.*tn.#3D.&W
[tcb+Tcb_namebase];#0A..14char.*name.#3D.b2c_str(W[
p+4],.chbuf2);#0A#09..6taskname[0].#3D.(tcb#3D#3D00
00).?.0.:.tn[0];#0A#09..6taskname[1].#3D.(tcb#3D#3D
0000).?.0.:.tn[1];#0A#09..6taskname[2].#3D.(tcb#3D#3D
0000).?.0.:.tn[2];#0A#09..6taskname[3].#3D.(tcb#3D#3D
0000).?.0.:.tn[3];#0A..14return.loadseg(name);#0A#09
..4}#0A#0A..2case.Sys_globin:#0A..14return.globin(W
[p+4],.g);#0A#0A..2case.Sys_unloadseg:#0A..14unload
seg(W[p+4]);..18return.0;#0A#0A..2case.Sys_muldiv:#0A
..2{.BCPLWORD.res.#3D..muldiv1(W[p+4],.W[p+5],.W[p+
6]);#0A..4W[g+Gn_result2].#3D.result2;#0A..4return.
res;#0A..2}#0A#0A..2case.Sys_intflag:#0A..4return.i
ntflag().?.-1L.:.0L;#0A#0A..2case.Sys_setraster:#0A
..4return.setraster(W[p+4],.W[p+5]);#0A#0A..2case.S
ys_cputime:./*.Return.CPU.time.in.milliseconds..*/#0A
..4return.muldiv(clock(),.1001,.TICKS_PER_SEC);#0A#0A
#23ifndef.forWinCE#0A..2case.Sys_filemodtime:#0A..2
/*.sys(Sys_filemodtime,.filename,.datv)#0A..5Set.th
e.elements.of.datv.to.represent.the.date.and.time.o
f#0A..5the.last.modification.of.the.given.file,.ret
urning.TRUE.if#0A..5successful.and.FALSE.otherwise#2E
.datv!0.is.the.number.of.days#0A..5since.1.January.
1970,.datv!1.is.the.number.of.milli-seconds#0A..5si
nce.midnight.and.datv!2#3D-1.indicating.that.the.ne
w.date.and#0A..5time.format.is.being.used#2E#0A..5I
f.the.file.does.not.exist.or.there.is.an.error.then
#0A..5FALSE.is.returned.and.the.elements.of.datv.ar
e.set.to.0,.0.and#0A..5-1,.respectively#2E#0A..2*/#0A
..2{.struct.stat.buf;#0A..4BCPLWORD.days,.secs,.mse
cs;#0A..4char.*name.#3D.b2c_str(W[p+4],.chbuf1);#0A
..4BCPLWORD.datestamp.#3D.W[p+5];#0A..4if.(stat(osf
name(name,.chbuf4),.&buf)).{#0A..6W[datestamp]..1#3D
.0;#0A..6W[datestamp+1].#3D.0;#0A..6W[datestamp+2].
#3D.-1;#0A..6return.0;#0A..4}#0A..4secs.#3D.buf#2Es
t_mtime;#0A..4//.nsecs.#3D.buf#2Est_mtimensec;.//.n
ano.second.time,.if.poss#0A..4days.#3D.secs./.(24*6
0*60);#0A..4msecs.#3D.(secs.%.(24*60*60)).*.1001;#0A
..4W[datestamp].#3D.days;#0A..4W[datestamp+1].#3D.m
secs;#0A..4W[datestamp+2].#3D.-1;..//.New.dat.forma
t#0A..4//printf("filemodtime:.name#3D%s.days#3D%".F
ormD.".msecs#3D%".FormD."\n",#0A..4//..6name,.days,
.msecs);#0A..4return.-1;#0A..2}#0A#23endif#0A#0A..2
case.Sys_setprefix:./*.Set.the.file.name.prefix.str
ing..*/#0A..2{.BCPLWORD.str.#3D.W[p+4];#0A..4char.*
fp.#3D.(char*)(&W[str]);#0A..4char.*tp.#3D.(char*)(
&W[prefixstr]);#0A..4int.i,.len#3D*fp;#0A..4if(len>
63).return.0;#0A..4for.(i#3D0;.i<#3Dlen;.i++).*tp++
.#3D.*fp++;#0A..4return.prefixstr;#0A..2}#0A#0A..2c
ase.Sys_getprefix:./*.Return.the.file.name.prefix.s
tring..*/#0A..4return.prefixstr;#0A#0A..2case.Sys_g
raphics:./*.Perform.an.operation.on.the.graphics.wi
ndow..*/#0A..4return.sysGraphics(p);#0A#0A..2case.3
5:./*.Return.TRUE.if.no.keyboard.character.is.avail
able.*/#0A#23ifdef.forWinCE#0A..12return.chBufEmpty
().?.-1.:.0;#0A#23else#0A..12return.-1;#0A#23endif#0A
#0A..2case.36:..1return.0;./*.Spare.*/#0A#0A..2case
.37:..1return.0;./*.Spare..*/#0A#0A..2case.Sys_seek
:../*.res.:#3D.sys(Sys_seek,.fd,.pos)..1*/#0A..2{.F
ILEPT.fp.#3D.findfp(W[p+4]);#0A..4BCPLWORD.pos.#3D.
W[p+5];#0A..4BCPLWORD.res.#3D.fseek(fp,.pos,.SEEK_S
ET);#0A..4W[g+Gn_result2].#3D.errno;#0A..4/*PRINTFD
("fseek.pos#3D%".FormD.".",.pos);.*/#0A..4/*PRINTFD
("#3D>.res#3D%".FormD."\n",.res);.*/#0A..4/*PRINTFD
("errno#3D%d\n",.errno);.*/#0A..4return.res#3D#3D00
00.?.-1.:.0;./*.res#3D0.succ,.res#3D-1.error..*/#0A
..2}#0A#0A..2case.Sys_tell:./*.pos.:#3D.sys(Sys_tel
l,fd)..*/#0A..2{.FILEPT.fp.#3D.findfp(W[p+4]);#0A..
4BCPLWORD.pos.#3D.ftell(fp);#0A..4W[g+Gn_result2].#3D
.errno;#0A..4/*PRINTFD("tell.#3D>.%".FormD."\n",.po
s);.*/#0A..4return.pos;./*.>#3D0.succ,.-1#3Derror.*
/#0A..2}#0A#0A..2case.Sys_waitirq:./*.Wait.for.irq.
*/#0A..4/*#0A..4pthread_mutex_lock..(..7&irq_mutex)
;#0A..4pthread_cond_wait..1(&irq_cv,.&irq_mutex);#0A
..4pthread_mutex_unlock(..7&irq_mutex);#0A..4*/#0A.
.4return.0;#0A#0A..2case.Sys_lockirq:./*.Stop.all.d
evices.from.modifying.*/#0A..20/*.packets.or.genera
ting.interrupts.*/#0A..4/*#0A..4pthread_mutex_lock(
&irq_mutex);#0A..4*/#0A..4return.0;#0A#0A..2case.Sy
s_unlockirq:./*.Allow.devices.to.modify.packets.*/#0A
..22/*.and.generate.interrupts.*/#0A..4/*#0A..4pthr
ead_mutex_unlock(&irq_mutex);#0A..4*/#0A..4return.0
;#0A#0A..2case.Sys_devcom:./*.res.:#3D.sys(Sys_devc
om,.dcb,.com,.arg).*/#0A..4return.0;./*devcommand(W
[p+4],.W[p+5],.W[p+6]);.*/#0A#0A..2case.Sys_datstam
p:./*.res.:#3D.sys(Sys_datstamp,.v)..*/#0A..2//.Set
.v!0.#3D.days..since.1.January.1970#0A..2//..3v!1.#3D
.msecs.since.midnight#0A..2//..3v!2.#3D.ticks.#3D-1
.for.new.dat.format#0A..2//.Return.-1.if.successful
#0A..14return.timestamp(&W[W[p+4]]);#0A#0A..2case.S
ys_filesize:../*.res.:#3D.sys(Sys_filesize,.fd)..1*
/#0A..4{.FILEPT.fp..1#3D.findfp(W[p+4]);#0A..6long.
pos..#3D.ftell(fp);#0A..6BCPLWORD.rc..1#3D.fseek(fp
,.0,.SEEK_END);#0A..6BCPLWORD.size.#3D.ftell(fp);#0A
..6rc..#3D.fseek(fp,.pos,.SEEK_SET);#0A..6if.(rc).s
ize.#3D.-1;#0A..6return.size;./*.>#3D0.succ,.-1#3De
rror..*/#0A..4}#0A#0A..2case.Sys_getsysval:./*.res.
:#3D.sys(Sys_getsysval,.addr).*/#0A..12{.BCPLWORD.a
ddr.#3D.W[p+4];#0A..14return.W[addr];#0A..12}#0A#0A
..2case.Sys_putsysval:./*.res.:#3D.sys(Sys_putsysva
l,.addr,.val).*/#0A..12{.BCPLWORD.addr.#3D.W[p+4];#0A
..14W[addr].#3D.W[p+5];#0A..14return.0;#0A..12}#0A#0A
#23ifndef.forWinCE#0A..2case.Sys_shellcom:./*.res.:
#3D.sys(Sys_shellcom,.comstr).*/#0A..12{.BCPLWORD.c
omstr.#3D.W[p+4]<<B2Wsh;#0A#09..6int.i;#0A..14char.
com[256];#0A..14int.len.#3D.((char.*)W)[comstr];#0A
..14for(i#3D0;.i<len;.i++).com[i].#3D.((char.*)W)[c
omstr+i+1];#0A..14com[len].#3D.0;#0A#09#09/*PRINTFS
("\nmain:.calling.shell.command.%s\n",.com);.*/#0A.
.14return.system(com);#0A..12}#0A#23endif#0A#0A#23i
fndef.forWinCE#0A..2case.Sys_getpid:./*.res.:#3D.sy
s(Sys_getpid).*/#0A..14return.getpid();#0A#23endif#0A
#0A..2case.Sys_dumpmem:./*.sys(Sys_dumpmem,.context
).*/#0A..14dumpmem(W,.memupb,.W[p+4]);#0A..14PRINTF
D("\nMemory.dumped.to.DUMP#2Emem,.context#3D%".Form
D."\n",#0A..22W[p+4]);#0A..14return.0;#0A#0A..2case
.Sys_callnative:./*.res.:#3D.sys(Sys_callnative,.fn
,.a1,.a2,.a3).*/#0A..12{./*.Call.native.code#2E.*/#0A
..14union.{./*.To.allow.conversion.from.pointer.to.
function.*/#0A#09#09..BCPLWORD.*p;#0A#09#09..BCPLWO
RD(*f)(BCPLWORD,.BCPLWORD,.BCPLWORD);#0A..14}.func;
#0A#0A..14func#2Ep.#3D.&W[W[p+4]];#0A..14return.(fu
nc#2Ef)(W[p+5],W[p+6],W[p+7]);#0A..12}#0A#0A..2case
.Sys_platform:#0A..12{./*.Return.platform.code,.0.i
f.unknown.*/#0A#09#09BCPLWORD.res.#3D.0;#0A#23ifdef
.forMAC#0A#09#09res.#3D.1;#0A#23endif#0A#23ifdef.fo
rMIPS#0A#09#09res.#3D.2;#0A#23endif#0A#23ifdef.forS
GI#0A#09#09res.#3D.3;#0A#23endif#0A#23ifdef.forARM#0A
#09#09res.#3D.4;#0A#23endif#0A#23ifdef.forLINUX#0A#09
#09res.#3D.5;#0A#23endif#0A#23ifdef.forLINUXamd64#0A
#09#09res.#3D.6;#0A#23endif#0A#23ifdef.forCYGWIN32#0A
#09#09res.#3D.7;#0A#23endif#0A#23ifdef.forLINUXPPC#0A
#09#09res.#3D.8;#0A#23endif#0A#23ifdef.forSUN4#0A#09
#09res.#3D.9;#0A#23endif#0A#23ifdef.forSPARC#0A#09#09
res.#3D.10;#0A#23endif#0A#23ifdef.forALPHA#0A#09#09
res.#3D.11;#0A#23endif#0A#23ifdef.forMSDOS#0A#09#09
res.#3D.12;#0A#23endif#0A#23ifdef.forOS2#0A#09#09re
s.#3D.13;#0A#23endif#0A#23ifdef.forSHwinCE#0A#09#09
res.#3D.14;#0A#23endif#0A#23ifdef.forMIPSwinCE#0A#09
#09res.#3D.15;#0A#23endif#0A..14return.res;#0A..12}
..12#0A#0A..2case.Sys_inc:./*.newval.:#3D.sys(Sys_i
nc,.ptr,.amount).*/#0A..12{./*.!ptr.:#3D.!ptr.+.amo
unt;.RESULTIS.!ptr.*/#0A..14return.W[W[p+4]].+#3D.W
[p+5];#0A..12}#0A#0A..2case.Sys_buttons:./*.Return.
bit.pattern.of.buttons.currently#0A..24pressed.on.t
he.GP2X.*/#0A#23ifdef.forGP2X#0A..12{.unsigned.long
.buttons.#3D.0;#0A#09..6int.fd.#3D.open("/dev/GPIO"
,.O_RDWR.|.O_NDELAY);#0A#09..6if.(fd<0).return.-1;#0A
..14if.(read(fd,.&buttons,.4).!#3D.4).return.-2;#0A
..14close(fd);#0A..14return.(BCPLWORD)buttons;#0A..
12}#0A#23else#0A..12return.-3;#0A#0A#23endif#0A#0A.
.2case.Sys_delay:./*.sys(Sys_delay,.msecs).*/#0A..1
2{.unsigned.int.msecs.#3D.(unsigned.int)W[p+4];#0A.
.14msecdelay(msecs);#0A..14return.0;#0A..12}#0A#0A.
.2case.Sys_sound:./*.res.:#3D.sys(Sys_sound,.fno,.a
1,.a2,#2E#2E1).*/#0A#23ifdef.SOUND#0A..14return.sou
ndfn(&W[p+4],.&W[g]);#0A#23else#0A..14return.0;#0A#23
endif#0A#0A..2case.Sys_sdl:./*.res.:#3D.sys(Sys_sdl
,.fno,.a1,.a2,#2E#2E1).*/#0A..4return.sdlfn(&W[p+4]
,.&W[g],.W);#0A#0A..2case.Sys_callc:./*.res.:#3D.sy
s(Sys_callc,.fno,.a1,.a2,#2E#2E1).*/#0A#23ifdef.CAL
LC#0A..4/*#0A..7printf("dosys:.sys(Sys_callc,.%".Fo
rmD.",.%".FormD.",.%".FormD",.#2E#2E1)\n",#0A..15W[
p+4],.W[p+5],.W[p+6]);#0A..4*/#0A..14return.callc(&
W[p+4],.&W[g]);#0A#23else#0A..14return.-1;#0A#23end
if#0A#0A..2case.Sys_trpush:./*.sys(Sys_trpush,.val)
.*/#0A..14trpush(W[p+4]);#0A..14return.0;#0A#0A..2c
ase.Sys_settrcount:./*.res.:#3D.sys(Sys_settrcount,
.count).*/#0A..14return.settrcount(W[p+4]);#0A#0A..
2case.Sys_gettrval:./*.res.:#3D.sys(Sys_gettrval,.c
ount).*/#0A..14return.gettrval(W[p+4]);#0A#0A..2cas
e.Sys_flt:./*.res.:#3D.sys(Sys_flt,.op,.a,.b)).*/#0A
..12{.BCPLWORD.res.#3D.doflt(W[p+4],.W[p+5],.W[p+6]
);#0A..14W[g+Gn_result2].#3D.result2;#0A#09#09//if(
W[p+4]#3D#3D00035)#0A#09#09//printf("sys_flt:.op#3D
%d.res#3D%08".FormX.".result2#3D%08".FormX."\n",#0A
..14//..5W[p+4],.(UBCPLWORD)res,.(UBCPLWORD)result2
);#0A..14return.res;#0A..12}#0A#0A..2case.Sys_polls
ardch:./*.res.:#3D.sys(Sys_pollsardch).*/#0A..12{#0A
..14//.Return.a.character.if.available.otherwise.po
llch.(#3D-3)#0A..14return.pollReadch();#0A..12}#0A#0A
..2case.Sys_incdcount:./*.res.:#3D.sys(Sys_incdcoun
t,.n).*/#0A..14return.incdcount(W[p+4]);#0A#0A1#23i
fndef.forWinCE#0A..2case.135:#0A..2{./*.Return.syst
em.date.and.time.in.VEC.5.*/#0A..4time_t.clk.#3D.ti
me(0);#0A..4struct.tm.*now.#3D.gmtime(&clk);#0A..4B
CPLWORD.*arg.#3D.&W[W[p+4]];#0A..4arg[0].#3D.now->t
m_year+1900;#0A..4arg[1].#3D.now->tm_mon+1;#0A..4ar
g[2].#3D.now->tm_mday;#0A..4arg[3].#3D.now->tm_hour
;#0A..4arg[4].#3D.now->tm_min;#0A..4arg[5].#3D.now-
>tm_sec;#0A..4return.0;#0A..2}#0A#23endif#0A#0A..}#0A
..//.This.is.unreadchable#0A..//.return.0;#0A}#0A#0A
void.msecdelay(unsigned.int.delaymsecs).{#0A#23if.(
defined(forWIN32).||.defined(forWinCE))#0A..{.Sleep
(delaymsecs);.//.??15#0A..14return;#0A..12}#0A#23el
se#0A#09..4/*#0A..12{.while(delaymsecs>#3D1001).{#0A
..16usleep(99000002);#0A..16msecs.-#3D.990000;#0A..
14}#0A..14if.(delaymsecs>0).usleep(delaymsecs*1001)
;#0A..14return;#0A..12}#0A..12*/#0A..12{.//.This.ve
rsion.uses.select().rather.than.usleep().or#0A..14/
/.nanosleep().since.these.seem.to.have.problems.on.
some#0A..14//.systems#2E#0A..14const.BCPLWORD.msecs
perday.#3D.24*60*60*1001;#0A..14BCPLWORD.days,.msec
s;#0A..14BCPLWORD.tv[3];.//.to.hold.[days,.msecs,.-
1]#0A..14struct.timeval.timeout;#0A..14timestamp(tv
);#0A..14//.calculate.the.wakeup.time#0A..14days.#3D
.tv[0];..13#0A..14msecs.#3D.tv[1].+.delaymsecs;#0A.
.14if.(msecs>#3Dmsecsperday).{.days++;.msecs.-#3D.m
secsperday;.}#0A#0A..14while(1).{#0A..16BCPLWORD.di
ffdays,.diffmsecs;#0A..16timestamp(tv);#0A..16diffd
ays.#3D.days.-.tv[0];#0A..16diffmsecs.#3D.msecs.-.t
v[1];#0A..16if.(diffdays>0).{.diffdays--;.diffmsecs
.+#3D.msecsperday;.}#0A#09#09..//printf("Sys_delay:
.diffmsecs.#3D.%".FormD.".msec\n",.diffmsecs);#0A..
16if.(diffmsecs<#3D0).return;#0A..16if.(diffmsecs>9
00).diffmsecs.#3D.900;#0A..16timeout#2Etv_sec.#3D.0
;#0A..16timeout#2Etv_usec.#3D.diffmsecs.*.1001;#0A#09
#09..//printf("Sys_delay:.waiting.for.%".FormD.".ms
ec\n",.diffmsecs);#0A..16select(FD_SETSIZE,.NULL,.N
ULL,.NULL,.&timeout);#0A..14}#0A..12}#0A#23endif#0A
}#0A#0A#23ifdef.NOFLOAT#0A#0ABCPLWORD.doflt(BCPLWOR
D.op,.BCPLWORD.a,.BCPLWORD.b).{#0A..return.0;#0A}#0A
#0A#23else#0A#0ABCPLWORD.doflt(BCPLWORD.op,.BCPLWOR
D.a,.BCPLWORD.b).{#0A..//.Typically.a.is.left.opera
nd#0A..//.and.b.is.the.right.operand,.if.required#0A
..union.{.BCPLWORD.i;.float.f;.}.x,.y;#0A..double.d
x,.dy;#0A#0A..//printf("doflt.entered.op#3D%".FormD
.".fl_mk#3D%".FormD."\n",.op,.fl_mk);#0A#0A..switch
.(op).{#0A..default:#0A..2printf("doflt(%".FormD.",
.%".FormD.",.%".FormD.").not.implemented\n",.op,.a,
.b);#0A#0A..case.fl_avail:#0A..2return.-1;#0A#0A..c
ase.fl_mk:#0A..{.//.a#3Dmantissa,.b#3Dexponent#0A..
2double.res.#3D.(double).a;#0A..2while(b>.5).{.res.
*#3D.1003#2E0;.b-#3D5;.}#0A..2while(b>.0).{.res.*#3D
..00310#2E0;.b--;..}#0A..2while(b<-5).{.res./#3D.10
03#2E0;.b+#3D5;.}#0A..2while(b<.0).{.res./#3D..0031
0#2E0;.b++;..}#0A..2x#2Ef.#3D.(float).res;#0A..2ret
urn.x#2Ei;#0A..}#0A..case.fl_unmk:#0A..{.BCPLWORD.m
antissa,.exponent#3D0;#0A..2double.d;#0A..2int.neg.
#3D.0;#0A..2x#2Ei.#3D.a;#0A..2d.#3D.x#2Ef;#0A..2//p
rintf("d.#3D.%15#2E9g.%".FormD."\n",.d,.exponent);#0A
..2if.(d<0#2E0).{.d.#3D.-d;.neg.#3D.1;.}#0A..2//pri
ntf("d.#3D.%15#2E9g.%".FormD."\n",.d,.exponent);#0A
..2while.(d>#3D1003#2E0).{#0A..4d./#3D.1003#2E0;.ex
ponent+#3D5;#0A..4//printf("d.#3D.%15#2E9g.%".FormD
."\n",.d,.exponent);#0A..2}#0A..2while.(d>#3D1#2E0)
.{#0A..4d./#3D.10#2E0;.exponent++;#0A..4//printf("d
.#3D.%15#2E9g.%".FormD."\n",.d,.exponent);#0A..2}#0A
..2while.(d<#3D0#2E000021.&&.exponent>#3D-400).{#0A
..4d.*#3D.1003#2E0;.exponent-#3D5;#0A..4//printf("d
.#3D.%15#2E9g.%".FormD."\n",.d,.exponent);#0A..2}#0A
..2while.(d<0#2E1.&&.exponent>#3D-400).{#0A..4d.*#3D
.10#2E0;.exponent--;#0A..4//printf("d.#3D.%15#2E9g.
%".FormD."\n",.d,.exponent);#0A..2}#0A..2if.(expone
nt>#3D-400).{#0A..4mantissa.#3D.(BCPLWORD).(d.*.100
7#2E0.+.0#2E5);#0A..4exponent.-#3D.9;#0A..2}.else.{
#0A..4mantissa.#3D.0;#0A..4exponent.#3D.0;#0A..2}#0A
..2result2.#3D.exponent;#0A..2if.(neg).mantissa.#3D
.-mantissa;#0A..2return.mantissa;#0A..}..2#0A#0A..c
ase.fl_float:#0A..2x#2Ef.#3D.(float)a;.#0A..2return
.x#2Ei;#0A#0A..case.fl_fix:#0A..2x#2Ei.#3D.a;#0A..2
if(x#2Ef<0).return.(BCPLWORD)(x#2Ef.-.0#2E5);#0A..2
return.(BCPLWORD)(x#2Ef.+.0#2E5);#0A#0A..case.fl_ab
s:#0A..2x#2Ei.#3D.a;#0A..2if.(x#2Ef<0#2E0).x#2Ef.#3D
.-x#2Ef;#0A..2return.x#2Ei;#0A#0A..case.fl_mult:#0A
..2x#2Ei.#3D.a;.y#2Ei.#3D.b;#0A..2x#2Ef.#3D.x#2Ef.*
.y#2Ef;#0A..2return.x#2Ei;#0A#0A..case.fl_div:#0A..
2x#2Ei.#3D.a;.y#2Ei.#3D.b;#0A..2x#2Ef.#3D.x#2Ef./.y
#2Ef;#0A..2return.x#2Ei;#0A#0A..case.fl_plus:#0A..2
x#2Ei.#3D.a;.y#2Ei.#3D.b;#0A..2x#2Ef.#3D.x#2Ef.+.y#2E
f;#0A..2return.x#2Ei;#0A#0A..case.fl_minus:#0A..2x#2E
i.#3D.a;.y#2Ei.#3D.b;#0A..2x#2Ef.#3D.x#2Ef.-.y#2Ef;
#0A..2return.x#2Ei;#0A#0A..case.fl_pos:#0A..2return
.a;#0A#0A..case.fl_neg:#0A..2x#2Ei.#3D.a;#0A..2x#2E
f.#3D.-x#2Ef;#0A..2return.x#2Ei;#0A#0A..case.fl_eq:
#0A..2x#2Ei.#3D.a;.y#2Ei.#3D.b;#0A..2return.x#2Ef.#3D
#3D.y#2Ef.?.-1.:.0;#0A#0A..case.fl_ne:#0A..2x#2Ei.#3D
.a;.y#2Ei.#3D.b;#0A..2return.x#2Ef.!#3D.y#2Ef.?.-1.
:.0;#0A#0A..case.fl_ls:#0A..2x#2Ei.#3D.a;.y#2Ei.#3D
.b;#0A..2return.x#2Ef.<.y#2Ef.?.-1.:.0;#0A#0A..case
.fl_gr:#0A..2x#2Ei.#3D.a;.y#2Ei.#3D.b;#0A..2return.
x#2Ef.>.y#2Ef.?.-1.:.0;#0A#0A..case.fl_le:#0A..2x#2E
i.#3D.a;.y#2Ei.#3D.b;#0A..2return.x#2Ef.<#3D.y#2Ef.
?.-1.:.0;#0A#0A..case.fl_ge:#0A..2x#2Ei.#3D.a;.y#2E
i.#3D.b;#0A..2return.x#2Ef.>#3D.y#2Ef.?.-1.:.0;#0A#0A
..case.fl_acos:#0A..2x#2Ei.#3D.a;#0A..2x#2Ef.#3D.ac
os(x#2Ef);#0A..2return.x#2Ei;#0A#0A..case.fl_asin:#0A
..2x#2Ei.#3D.a;#0A..2x#2Ef.#3D.asin(x#2Ef);#0A..2re
turn.x#2Ei;#0A#0A..case.fl_atan:#0A..2x#2Ei.#3D.a;#0A
..2x#2Ef.#3D.atan(x#2Ef);#0A..2return.x#2Ei;#0A#0A.
.case.fl_atan2:#0A..2x#2Ei.#3D.a;.y#2Ei.#3D.b;#0A..
2x#2Ef.#3D.atan2(x#2Ef,.y#2Ef);#0A..2return.x#2Ei;#0A
#0A..case.fl_cos:#0A..2x#2Ei.#3D.a;#0A..2x#2Ef.#3D.
cos(x#2Ef);#0A..2return.x#2Ei;#0A#0A..case.fl_sin:#0A
..2x#2Ei.#3D.a;#0A..2x#2Ef.#3D.sin(x#2Ef);#0A..2ret
urn.x#2Ei;#0A#0A..case.fl_tan:#0A..2x#2Ei.#3D.a;#0A
..2x#2Ef.#3D.tan(x#2Ef);#0A..2return.x#2Ei;#0A#0A..
case.fl_cosh:#0A..2x#2Ei.#3D.a;#0A..2x#2Ef.#3D.cosh
(x#2Ef);#0A..2return.x#2Ei;#0A#0A..case.fl_sinh:#0A
..2x#2Ei.#3D.a;#0A..2x#2Ef.#3D.sinh(x#2Ef);#0A..2re
turn.x#2Ei;#0A#0A..case.fl_tanh:#0A..2x#2Ei.#3D.a;#0A
..2x#2Ef.#3D.tanh(x#2Ef);#0A..2return.x#2Ei;#0A#0A.
.case.fl_exp:#0A..2x#2Ei.#3D.a;#0A..2x#2Ef.#3D.exp(
x#2Ef);#0A..2return.x#2Ei;#0A#0A..case.fl_frexp:#0A
..{.int.r2;#0A..2x#2Ei.#3D.a;#0A..2x#2Ef.#3D.frexp(
x#2Ef,.&r2);#0A..2result2.#3D.r2;#0A..2return.x#2Ei
;#0A..}#0A#0A..case.fl_ldexp:#0A..2x#2Ei.#3D.a;#0A.
.2x#2Ef.#3D.ldexp(x#2Ef,.b);#0A..2return.x#2Ei;#0A#0A
..case.fl_log:#0A..2x#2Ei.#3D.a;#0A..2x#2Ef.#3D.log
(x#2Ef);#0A..2return.x#2Ei;#0A#0A..case.fl_log10:#0A
..2x#2Ei.#3D.a;#0A..2x#2Ef.#3D.log10(x#2Ef);#0A..2r
eturn.x#2Ei;#0A#0A..case.fl_modf:#0A..2{.double.r1,
.r2;#0A..4x#2Ei.#3D.a;#0A..4//printf("modfx#2Ef#3D%
15#2E6g.#3D>.",.x#2Ef);#0A..4r1.#3D.modf((double)x#2E
f,.&r2);#0A..4//printf("%15#2E6g.%15#2E6g\n",.r1,.r
2);#0A..4x#2Ef.#3D.(float)r1;#0A..4//printf("%15#2E
6g.%08".FormX."\n",.x#2Ef,.(UBCPLWORD)x#2Ei);#0A..4
result2.#3D.(BCPLWORD)r2;#0A#0A..4//printf("modf.se
t.result2#3D%08".FormX.".returning.%08".FormX."\n",
#0A..4//..6result2,.(BCPLWORD)x#2Ei);#0A..4return.(
BCPLWORD)x#2Ei;#0A..2}#0A#0A..case.fl_pow:#0A..2x#2E
i.#3D.a;.y#2Ei.#3D.b;#0A..2x#2Ef.#3D.pow(x#2Ef,.y#2E
f);#0A..2return.x#2Ei;#0A#0A..case.fl_sqrt:#0A..2x#2E
i.#3D.a;#0A..2x#2Ef.#3D.sqrt(x#2Ef);#0A..2return.x#2E
i;#0A#0A..case.fl_ceil:#0A..2x#2Ei.#3D.a;#0A..2x#2E
f.#3D.ceil(x#2Ef);#0A..2return.x#2Ei;#0A#0A..case.f
l_floor:#0A..2x#2Ei.#3D.a;#0A..2x#2Ef.#3D.floor(x#2E
f);#0A..2return.x#2Ei;#0A#0A..case.fl_fmod:#0A..2x#2E
i.#3D.a;.y#2Ei.#3D.b;#0A..2x#2Ef.#3D.fmod(x#2Ef,.y#2E
f);#0A..2return.x#2Ei;#0A..};#0A..//printf("doflt(%
".FormD.",.%".FormD.",.%".FormD.").not.implemented\
n",.op,.a,.b);#0A#0A..//return.0;#0A}#0A#23endif#0A
#0ABCPLWORD.timestamp(BCPLWORD.*v).{#0A..//.Set.v[0
].#3D.days.since.1.January.1970#0A..//..3v[1].#3D.m
secs.since.midnight#0A..//..3v[2].#3D.-1.for.new.da
t.format#0A..//.Return.-1.if.successful#0A#23if.def
ined(forWinCE).||.defined(forMacOSPPC).||.defined(f
orMacOSX)#0A..v[0]#3Dv[1]#3D0;#0A..v[2]#3D-1;#0A..r
eturn.0;..1/*.To.indicate.failure.*/#0A#23else#0A..
unsigned.int.days..#3D.0;#0A..BCPLINT64..2secs.#3D.
0;#0A..unsigned.int.msecs.#3D.0;#0A#0A..const.unsig
ned.int.secsperday.#3D.60*60*24;#0A#0A#23if.defined
(forWIN32).||.defined(forCYGWIN32).||.defined(forLI
NUX)#0A..{.//.Code.for.Windows,.Cygwin.and.Linux#0A
..2//.ftime.is.obsolete.and.the.advice.is.to.use#0A
..2//.gettimeofday.or.clock_gettime#0A..2//.neither
.of.these.are.widely.available.yet#2E#0A..2struct.t
imeb.tb;#0A..2ftime(&tb);#0A..2secs.#3D.tb#2Etime;#0A
..2//if(tb#2Edstflag).secs.+#3D.60*60;#0A..2secs.-#3D
.tb#2Etimezone.*.60;#0A..2//printf("tb#2Edstflag#3D
%".FormD.".tb#2Etimezone#3D%".FormD."\n",#0A..2//..
6tb#2Edstflag,.tb#2Etimezone);#0A..2msecs.#3D.tb#2E
millitm;#0A..}#0A#23else#0A..//.Code.for.systems.ha
ving.the.function.gettimeofday#2E#0A..struct.timeva
l.tv;#0A..gettimeofday(&tv,.NULL);#0A..secs.#3D.tv#2E
tv_sec;#0A..msecs.#3D.tv#2Etv_usec./.1001;#0A..secs
.+#3D.60*60;..3/*.Fudge.--.Add.one.hour.for.BST.*/#0A
#23endif#0A#0A..//.secs..#3D.seconds.since.1.Januar
y.1970#0A..//.msecs.#3D.micro.seconds.since.start.o
f.current.second#0A#0A..secs.+#3D.W[rootnode+Rtn_ad
jclock].*.60;./*.Add.adjustment.*/#0A#0A..days..+#3D
.secs./.secsperday;.//.convert.secs.to.days#0A..sec
s..%#3D.secsperday;.//.Seconds.since.midnight#0A..m
secs.+#3D.secs*1001;..//.milliseconds.since.midnigh
t#0A#0A..v[0].#3D.days;..//.days..since.on.1.Januar
y.1970#0A..v[1].#3D.msecs;.//.msecs..since.midnight
#0A..v[2].#3D.-1;..2//.For.new.dat.format#0A..//..p
rintf("days#3D%".FormD.".msecs#3D%".FormD."\n",.day
s,.msecs);#0A..return.-1;..1/*.To.indicate.success.
*/#0A#23endif#0A}#0A#0Achar.*vmsfname(char.*name,.c
har.*vmsname).{#0A/*#0AThis.function.converts.a.cin
tsys/cintpos.filename.to.a.VMS.filename#0A#0AExampl
es:#0A#0AName..21VMS.name#0A#0Aecho#2Eb..19echo#2Eb
#0Acom/echo#2Eb..15[#2Ecom]echo#2Eb#0A/mrich177/dis
tribution/bcpl/g/libhdr#2Eh#0A..25[mrich177#2Edistr
ibution#2Ebcpl#2Eg]libhdr#2Eh#0Avd10$disk:/mrich177
/junk#2Eb.vd10$disk:[mrich177]junk#2Eb#0A#2E#2E/cin
tcode/com/bcplfe#2Eb..1[-#2Ecintcode#2Ecom]bcplfe#2E
b#0A*/#0A..int.ch;#0A..int.i#3D0;.//.Next.character
.in.name#0A..int.j#3D0;.//.Next.character.in.vmsnam
e#0A..int.lastslashpos#3D-1;.//.Position.of.last.sl
ash.in.name#0A#0A../*.If.name.contains.a.colon,.cop
y.all#0A..3characters.up.to.and.including.the.colon
#2E#0A..*/#0A..while.(1).{#0A..2int.ch.#3D.name[i];
#0A..2if.(ch#3D#3D0000).{#0A..4/*.No.colon.in.name.
*/#0A..4i.#3D.0;#0A..4break;#0A..2}#0A..2if.(ch#3D#3D
':').{#0A..4/*.Copy.up.to.and.including.the.colon.*
/#0A..4while.(j<#3Di).{.vmsname[j].#3D.name[j];.j++
;.}#0A..4i.#3D.j;#0A..4break;#0A..2}#0A..2i++;#0A..
}#0A../*.Find.position.of.last.slash,.if.any.*/#0A.
.while.(1).{#0A..2int.ch.#3D.name[i];#0A..2if(ch#3D
#3D0000).break;#0A..2if(ch#3D#3D'/').lastslashpos.#3D
.i;#0A..2i++;#0A..}#0A#0A../*.No.slashes..#3D>.noth
ing#0A..3Leading./..1#3D>.[#0A..3Slashes.but.no.lea
ding.slash.so.insert.[#2E.or.[-#0A#0A..3name.is.the
n.copied.converting.all.slashes.except.the.leading#0A
..3and.last.ones.to.dots,.and.converting.the.last.s
lash.to.]#2E#0A..*/#0A..i.#3D.j;#0A..if(name[i]#3D#3D
'/').{#0A..2/*.if.leading.slash.but.not.the.last.co
nvert.it.to.[.*/#0A..2if.(i!#3Dlastslashpos).vmsnam
e[j++].#3D.'[';#0A..2/*.Otherwise.skip.over.this.le
ading.slash.*/#0A..2i++;#0A..}.else.{#0A..2if.(last
slashpos>#3D0).{#0A..4/*.Slashes.but.no.leading.sla
sh,.so.insert.[#2E.or.[-..*/#0A..4vmsname[j++].#3D.
'[';#0A..4if(name[i]!#3D'#2E'.||.name[i+1]!#3D'#2E'
).{#0A..6vmsname[j++].#3D.'#2E';#0A..4}#0A..2}#0A..
}#0A#0A..while.(1).{#0A..2/*.Copy.characters#0A..5r
eplacing.last./..4by.]#0A..5and..5non.last./..by.#2E
#0A..5and..5#2E#2E..8by.-#0A..2*/#0A..2int.ch.#3D.n
ame[i];#0A..2if(ch#3D#3D'#2E'.&&.name[i+1]#3D#3D'#2E
').{#0A..4/*.Convert.#2E#2E.to.-.*/#0A..4ch.#3D.'-'
;#0A..4i++;#0A..2}#0A..2if(ch#3D#3D'/').{#0A..4if.(
i#3D#3Dlastslashpos).ch.#3D.']';#0A..4else..15ch.#3D
.'#2E';#0A..2}#0A..2vmsname[j++].#3D.ch;#0A..2if(ch
#3D#3D0000).break;#0A..2i++;#0A..}#0A../*#0A..print
f("vmsfname.of.%s\n",.name);#0A..printf("gives:..4%
s\n",.vmsname);#0A..*/#0A#0A..return.vmsname;#0A}#0A
#0Achar.*winfname(char.*name,.char.*osname).{#0A/*#0A
This.function.converts.a.cintsys/cintpos.filename.t
o.a.WIN.filename#0A#0AThis.copies.name.to.winname.r
eplacing.all.'/'.characters.by.'\'s#2E#0A*/#0A..cha
r.*p.#3D.osname;#0A..while(1).{#0A..2int.ch.#3D.*na
me++;#0A..2if(ch#3D#3D'/').ch.#3D.'\\';#0A..2*p++.#3D
.ch;#0A..2if(ch#3D#3D0000).return.osname;#0A..}#0A}
#0A#0Achar.*unixfname(char.*name,.char.*osname).{#0A
/*#0AThis.function.converts.a.cintsys/cintpos.filen
ame.to.a.Unix.filename#0AThis.copies.name.to.winnam
e.replacing.all.'/'.characters.by.'\'s#2E#0A*/#0A..
char.*p.#3D.osname;#0A..//printf("unixfname:.name#3D
%s\n",.name);#0A..while(1).{#0A..2int.ch.#3D.*name+
+;#0A..2if(ch#3D#3D'\\').ch.#3D.'/';#0A..2*p++.#3D.
ch;#0A..2if(ch#3D#3D0000).return.osname;#0A..}#0A}#0A
#0Achar.*osfname(char.*name,.char.*osname).{#0A/*#0A
This.function.converts.the.cintsys/cintpos.filename
.to.the.OS.filename#0Aformat#2E.The.possible.format
s.are.UNIX,.WIN.or.VMS#2E#0A*/#0A..char.*res#3D0;#0A
..char.buf[256];#0A#0A..//printf("osfname:.name#3D%
s\n",.name);#0A#0A#23ifdef.VMSNAMES#0A..res.#3D.vms
fname(prepend_prefix(name,.buf),.osname);#0A#23endi
f#0A#23ifdef.WINNAMES#0A..res.#3D.winfname(prepend_
prefix(name,.buf),.osname);#0A#23endif#0A#23ifdef.U
NIXNAMES#0A..res.#3D.unixfname(prepend_prefix(name,
.buf),.osname);#0A#23endif#0A..if(res#3D#3D0000).{#0A
..2printf("Configuration.error:.");#0A..2printf("On
e.of.UNIXNAMES,.WINNAMES.or.VMSNAMES.must.be.set\n"
);#0A..2return.0;#0A..}#0A..if(filetracing).{#0A..2
printf("osfname:.%s.#3D>.%s\n",.name,.res);#0A..}#0A
..return.res;#0A}#0A#0A/*#0ACopy.the.prefix.string.
into.tostr.and.then.append.the.fromstr#0Ainserting.
'/'.if.necessary#2E#0A*/#0Achar.*prepend_prefix(cha
r.*fromstr,.char.*tostr)#0A{.char.*pfxp.#3D.prefixb
p;#0A..int.pfxlen.#3D.*pfxp++;#0A..int.i.#3D.0;#0A.
.//printf("prepend_prefix:.fromstr#3D%s.pfxlen#3D%d
\n",.fromstr,.pfxlen);#0A..if(pfxlen#3D#3D0000).ret
urn.fromstr;#0A..if(!relfilename(fromstr)).return.f
romstr;#0A#0A..//printf("prepend_prefix:.prepending
.the.prefix\n");#0A#0A..while(pfxlen--).tostr[i++].
#3D.*pfxp++;#0A../*.Insert.separator.'/'.between.th
e.prefix.and.name,.if.necessary#2E.*/#0A..if(tostr[
i-1]!#3D'/'.||.tostr[i-1]!#3D'\\').tostr[i++].#3D.'
/';#0A#0A..while.(1)#0A..{.char.ch.#3D.*fromstr++;#0A
..2tostr[i++].#3D.ch;#0A..2if(ch#3D#3D0000).break;#0A
..}#0A..//printf("prepend_prefix:.gives.tostr#3D%s\
n",.tostr);#0A..return.tostr;#0A}#0A#0A/*#0A**.c2b_
str.converts.a.C.string.to.a.BCPL.string#2E#0A*/#0A
void.c2b_str(char.*cstr,.BCPLWORD.bstr)#0A{.int.len
.#3D.0;#0A..char.*p.#3D.cstr;#0A..char.*str.#3D.((c
har*)(W+bstr));#0A..while.(*p.&&.len<64).str[++len]
.#3D.*p++;.#0A..str[0].#3D.len;#0A}#0A#0A/*.b2c_str
.converts.a.BCPL.string.to.a.C.character.string#2E.
*/#0Achar.*b2c_str(BCPLWORD.bstr,.char.*cstr)#0A{.B
CPLWORD.bp.#3D.bstr<<B2Wsh;#0A..char.*p.#3D.cstr;#0A
..int.len.#3D.(BP.W)[bp++];#0A..if.(bstr#3D#3D0000)
.return.0;#0A..while.(len--).*p++.#3D.(BP.W)[bp++];
#0A..*p.#3D.0;#0A..return.cstr;#0A}#0A#0A/*.syscin2
b_str.converts.a.syscin.filename.string.to.a.BCPL.s
tring#2E.*/#0ABCPLWORD.syscin2b_str(char.*cstr,.BCP
LWORD.bstr)#0A{..char.*prfx.#3D."syscin/";..2/*.Sys
tem.cin.directory.*/#0A..1char.*bp.#3D.&((char.*)W)
[bstr<<B2Wsh];#0A..1int.len.#3D.0;#0A..1int.i.#3D.0
;#0A..1while.(prfx[i]).{.bp[++len].#3D.prfx[i++];.}
#0A..1i.#3D.0;#0A..1while.(cstr[i]).{.bp[++len].#3D
.cstr[i++];.}#0A..1bp[0].#3D.len;#0A..1return.bstr;
#0A}#0A#0A/*.catstr2c_str.concatenates.two.optional
.C.strings.into.str#2E.*/#0Achar.*catstr2c_str(char
.*cstr1,.char.*cstr2,.char.*str).{#0A..char.*p.#3D.
str;#0A..if.(cstr1)#0A..2while(*cstr1).*p++.#3D.*cs
tr1++;#0A..if.(cstr1)#0A..2while(*cstr2).*p++.#3D.*
cstr2++;#0A..*p.#3D.0;#0A..return.str;#0A}#0A#0Avoi
d.wrcode(char.*form,.BCPLWORD.f,.BCPLWORD.a)#0A{..w
rfcode(f);#0A..1PRINTF.("..");#0A..1PRINTFD(form,.a
);#0A..1PRINTF.("\n");#0A}.#0A#0Avoid.wrfcode(BCPLW
ORD.f)#0A{.char.*s;#0A..int.i,.n.#3D.(f>>0005).&.7;
#0A..switch((int)f&31)#0A..{.default:#0A..2case..00
00:.s.#3D."..3-..3K..1LLP..3L..2LP..2SP..2AP..3A";.
break;#0A..2case..0001:.s.#3D.".FLTOP..2KH..LLPH..2
LH..1LPH..1SPH..1APH..2AH";.break;#0A..2case..0002:
.s.#3D."..1BRK..2KW..LLPW..2LW..1LPW..1SPW..1APW..2
AW";.break;#0A..2case..0003:.s.#3D."..2K3..1K3G..K3
G1..K3GH..1LP3..1SP3..1AP3..L0P3";.break;#0A..2case
..0004:.s.#3D."..2K4..1K4G..K4G1..K4GH..1LP4..1SP4.
.1AP4..L0P4";.break;#0A..2case..0005:.s.#3D."..2K5.
.1K5G..K5G1..K5GH..1LP5..1SP5..1AP5..L0P5";.break;#0A
..2case..0006:.s.#3D."..2K6..1K6G..K6G1..K6GH..1LP6
..1SP6..1AP6..L0P6";.break;#0A..2case..0007:.s.#3D.
"..2K7..1K7G..K7G1..K7GH..1LP7..1SP7..1AP7..L0P7";.
break;#0A..2case..0008:.s.#3D."..2K8..1K8G..K8G1..K
8GH..1LP8..1SP8..1AP8..L0P8";.break;#0A..2case..000
9:.s.#3D."..2K9..1K9G..K9G1..K9GH..1LP9..1SP9..1AP9
..L0P9";.break;#0A..2case.10:.s.#3D."..1K10..K10G.K
10G1.K10GH..LP10..SP10..AP10.L0P10";.break;#0A..2ca
se.11:.s.#3D."..1K11..K11G.K11G1.K11GH..LP11..SP11.
.AP11.L0P11";.break;#0A..2case.12:.s.#3D."..2LF..1S
0G..S0G1..S0GH..LP12..SP12..AP12.L0P12";.break;#0A.
.2case.13:.s.#3D."..1LF$..1L0G..L0G1..L0GH..LP13..S
P13.XPBYT..3S";.break;#0A..2case.14:.s.#3D."..2LM..
1L1G..L1G1..L1GH..LP14..SP14..1LMH..2SH";.break;#0A
..2case.15:.s.#3D."..1LM1..1L2G..L2G1..L2GH..LP15..
SP15..1BTC..MDIV";.break;#0A..2case.16:.s.#3D."..2L
0..2LG..1LG1..1LGH..LP16..SP16..1NOP.CHGCO";.break;
#0A..2case.17:.s.#3D."..2L1..2SG..1SG1..1SGH..1SYS.
.2S1..2A1..1NEG";.break;#0A..2case.18:.s.#3D."..2L2
..1LLG..LLG1..LLGH..1SWB..2S2..2A2..1NOT";.break;#0A
..2case.19:.s.#3D."..2L3..2AG..1AG1..1AGH..1SWL..2S
3..2A3..L1P3";.break;#0A..2case.20:.s.#3D."..2L4..1
MUL..1ADD..2RV..2ST..2S4..2A4..L1P4";.break;#0A..2c
ase.21:.s.#3D."..2L5..1DIV..1SUB..1RV1..1ST1..1XCH.
.2A5..L1P5";.break;#0A..2case.22:.s.#3D."..2L6..1RE
M..1LSH..1RV2..1ST2..GBYT..RVP3..L1P6";.break;#0A..
2case.23:.s.#3D."..2L7..1XOR..1RSH..1RV3..1ST3..PBY
T..RVP4..L2P3";.break;#0A..2case.24:.s.#3D."..2L8..
2SL..1AND..1RV4..STP3..1ATC..RVP5..L2P4";.break;#0A
..2case.25:.s.#3D."..2L9..1SL$..2OR..1RV5..STP4..1A
TB..RVP6..L2P5";.break;#0A..2case.26:.s.#3D."..1L10
..2LL..1LL1..1RV6..STP5..3J..RVP7..L3P3";.break;#0A
..2case.27:.s.#3D."..FHOP..1LL$..LL1$..1RTN..GOTO..
2J$.ST0P3..L3P4";.break;#0A..2case.28:.s.#3D."..1JE
Q..1JNE..1JLS..1JGR..1JLE..1JGE.ST0P4..L4P3";.break
;#0A..2case.29:.s.#3D."..JEQ$..JNE$..JLS$..JGR$..JL
E$..JGE$.ST1P3..L4P4";.break;#0A..2case.30:.s.#3D."
..JEQ0..JNE0..JLS0..JGR0..JLE0..JGE0.ST1P4.SELLD";.
break;#0A..2case.31:.s.#3D.".JEQ0$.JNE0$.JLS0$.JGR0
$.JLE0$.JGE0$..2MW.SELST";.break;#0A..}#0A#0A..for(
i.#3D.6*n;.i<#3D6*n+5;.i++).putchar(s[i]);#0A}.#0A#0A
void.trval(BCPLWORD.w).{#0A..BCPLWORD.gw.#3D.w.&.0x
FF002002;#0A..BCPLWORD.gn.#3D.w.&.0x002FF2;#0A..2if
(gw#3D#3DGlobword.&&.gn<#3D1001).{#0A..4PRINTFD("..
3#23G%03".FormD"#23.",.gn);#0A..2}.else.{#0A..4if(-
1005<#3Dw.&&.w<#3D1005).{#0A..6PRINTFD(".%10".FormD
.".",.w);#0A..4}.else.{#0A..6PRINTFD(".#23x%8".Form
X.".",.(UBCPLWORD)w);#0A..4}#0A..2}#0A}#0A#0Avoid.t
race(BCPLWORD.pc,.BCPLWORD.p,.BCPLWORD.a,.BCPLWORD.
b)#0A{.PRINTFD("A#3D");.trval(a);#0A..PRINTFD("B#3D
");.trval(b);#0A..PRINTFD("P#3D%5".FormD.".",.p);#0A
..PRINTFD("%9".FormD.":.",.pc);#0A..wrcode("(%3".Fo
rmD.")",.WD.(BP.W)[pc],.WD.(BP.W)[pc+1]);#0A..putch
ar(13);#0A}#0A#0Avoid.dumpmem(BCPLWORD.*mem,.BCPLWO
RD.upb,.BCPLWORD.context)#0A{.FILEPT.fp;#0A..BCPLWO
RD.count.#3D.upb;#0A..BCPLWORD.p#3D0,.q,.r#3D0;#0A.
.int.len.#3D.0;#0A..BCPLWORD.datstamp[3];#0A#0A..fp
.#3D.fopen("DUMP#2Emem",."wb");#0A..if(fp#3D#3D0000
).goto.bad;#0A#0A..mem[rootnode.+.Rtn_lastp]..1#3D.
lastWp-W;#0A..mem[rootnode.+.Rtn_lastg]..1#3D.lastW
g-W;#0A..mem[rootnode.+.Rtn_lastst]..#3D.lastst;#0A
#0A..mem[rootnode.+.Rtn_context].#3D.context;#0A../
*.context.#3D.1..1SIGINT.received..15(lastp,.lastg)
#0A..**.context.#3D.2..1SIGSEGV.received..14(lastp,
.lastg)#0A..**.context.#3D.3..1fault.while.running.
boot..6(bootregs)#0A..**.context.#3D.4..1user.calle
d.sys(Sys_quit,.-2)..1(klibregs)#0A..**.context.#3D
.5..1fault.while.user.running..6(klibregs)#0A..*/#0A
#0A..datstamp[0]#3Ddatstamp[1]#3Ddatstamp[2]#3D0;#0A
..timestamp(datstamp);#0A..mem[rootnode.+.Rtn_days]
..#3D.datstamp[0];.//.days#0A..mem[rootnode.+.Rtn_m
secs].#3D.datstamp[1];.//.msecs#0A..mem[rootnode.+.
Rtn_ticks].#3D.-1;..8//.new.dat.format#0A#0A../*.Wr
ite.out.size.of.cintcode.memory.*/#0A../*PRINTFD("\
n%8".FormD.".Memory.upb\n",.upb);.*/#0A..len.#3D.fw
rite((char*)&count,.(size_t)4,.(size_t)1,.fp);#0A..
if(len!#3D1).goto.bad;#0A#0A..while(r<#3Dupb)#0A..{
.BCPLWORD.dataword.#3D.mem[r];#0A..2q.#3D.r;#0A..2w
hile(r<#3Dupb.&&.mem[++r]#3D#3Ddataword).continue;#0A
..2if(r<#3Dupb.&&.r-q.<.200).continue;#0A#0A..2/*.m
em[p]#2E#2Emem[q-1].is.the.block#0A..2**.mem[q]#2E#2E
mem[r-1].are.repeated.occurrences.of.dataword#0A..2
**.Write.out.count.of.words.in.next.block#0A..2*/#0A
..2count.#3D.q-p;./*.count>#3D0.*/#0A..2if(count)#0A
..2{./*PRINTFD("%8".FormD.".BLOCK\n",.count);.*/#0A
..4len.#3D.fwrite((char*)&count,.(size_t)4,.(size_t
)1,.fp);#0A..4if(len!#3D1).goto.bad;#0A..4len.#3D.f
write((char*)&mem[p],.(size_t)4,.(size_t)count,.fp)
;#0A..4if(len!#3Dcount).goto.bad;#0A..2}#0A#0A..2/*
.Write.out.repetition.count.(negated).followed.by.t
he.data.word.*/#0A..2count.#3D.q-r;./*.count<#3D0.*
/#0A..2if(count).{#0A..4/*printf("%8".FormD.".x.%8"
.FormX."\n",.-count,.(UBCPLWORD)dataword);.*/#0A..4
len.#3D.fwrite((char*)&count,..2(size_t)4,.(size_t)
1,.fp);#0A..4if(len!#3D1).goto.bad;#0A..4len.#3D.fw
rite((char*)&dataword,.(size_t)4,.(size_t)1,.fp);#0A
..4if(len!#3D1).goto.bad;#0A..2}#0A#0A..2p.#3D.r;#0A
..}#0A#0A.bad:#0A..if(fp).fclose(fp);#0A../*PRINTFD
("\nMemory.dumped.to.DUMP#2Emem,.context#3D%".FormD
."\n",.context);.*/#0A..return;.#0A}#0A#0Avoid.trpu
sh(BCPLWORD.val).{#0A..//.If.trcount>#3D0.push.val.
into.the.circular.trace.buffer#0A..//.possibly.prec
eeded.by.a.time.stamp#2E#0A..//.Note.that.trpush.is
.disabled.if.trcount#3D-1#0A../*..pthread_mutex_loc
k(&trpush_mutex);.*/#0A..if(trcount>#3D0).{#0A#23if
.defined(forWinCE).||.defined(forMacOSPPC).||.defin
ed(forMacOSX)#0A#23else#0A..2BCPLWORD.v[3];#0A..2BC
PLWORD.msecs;#0A..2timestamp(v);#0A..2msecs.#3D.v[1
];./*.milli-seconds.since.midnight.*/#0A..2//.Push.
the.time.stamp:.hex.66000004.+.<msecs.since.midnigh
t>#0A..2trvec[trcount++.&.4095].#3D.0x66000004.+.ms
ecs%6002;#0A#23endif#0A..2trvec[trcount++.&.4095].#3D
.val;#0A..}#0A../*..pthread_mutex_unlock(&trpush_mu
tex);.*/#0A}#0A#0ABCPLWORD.settrcount(BCPLWORD.coun
t).{#0A..//.Set.trcount.returning.the.previous.valu
e#2E#0A..//.Setting.trcount.to.-1.disables.trpush#2E
#0A..BCPLWORD.res;#0A../*.pthread_mutex_lock(&trpus
h_mutex);.*/#0A..res.#3D.trcount;#0A..trcount.#3D.c
ount;#0A../*.pthread_mutex_unlock(&trpush_mutex);.*
/#0A..return.res;#0A}#0A#0ABCPLWORD.gettrval(BCPLWO
RD.count).{#0A..//.Return.the.trace.value.correspon
ding.to.position.count#2E#0A..//.The.result.is.only
.valid.if.the.circular.buffer.has.not.overflowed#0A
..BCPLWORD.res;#0A..//pthread_mutex_lock(&trpush_mu
tex);#0A..res.#3D.trvec[count.&.4095];#0A..//pthrea
d_mutex_unlock(&trpush_mutex);#0A..return.res;#0A}#0A
#0ABCPLWORD.incdcount(BCPLWORD.n).{#0A..BCPLWORD.dv
.#3D.W[rootnode.+.Rtn_dcountv];#0A..2if(0.<.n.&&.n.
<#3D.W[dv]).return.++W[dv+n];#0A..return.-1;#0A}#0A
#0A#23ifdef.SOUND#0A#23include."soundfn#2Ec"#0A#23e
ndif#0A#0A

######sysc/cintsys.h#
/*.This.header.file.contains.machine/system.depende
nt.#23defines#0A**.These.are.dependent.on.the.-D.pa
rameter.specified.in.Makefile#2E#0A**.The.possible.
-D.parameters.are:#0A**#0A**..-DforMAC..9for.Apple.
MAC.(not.recently.tested)#0A**..-DforMIPS..8for.DEC
.R2001/3001.Workstations.under.Ultrix.4#2E3#0A**..-
DforSGI..9for.SGI.MIPS.machines.under.Ultrix#0A**..
-DforARM..9for.ARM.under.RISC.OS.(under.development
)#0A**..-DforLINUX..7for.Linux.on.a.Pentium#0A**..-
DforVmsItanium..2for.the.Itanium.under.VMS#0A**..-D
forVmsVax..6for.the.Vax.under.VMS#0A**..-DforLINUX6
4..5for.64-bit.Linux#0A**..-DforGP2X..8for.the.GP2X
.handheld.Linux.gaming.machine#0A**..-DforLINUXAMD6
4..2for.Linux.on.the.AMD.64#0A**..-DforLINUXPPC..4f
or.Linux.on.a.PowerMac.G4#0A**..-DforMacOSPPC..4for
.Mac.OS.X.on.a.Mac.Power.PC.G4#0A**..-DforMacOSX..6
for.Mac.OS.X#0A**..-DforSUN4..8for.Sun4m.under.SunO
S.4#2E1#2E3#0A**..-DforSPARC..7for.Sun4m.spac.under
.SunOS.5#2E4#0A**..-DforALPHA..7for.DEC.Alpha.under
.OSF1.V3#2E2.17#0A**..-DforMSDOS..7for.MSDOS.32.bit
.protected.mode.usinf.Borland.C.v4#2E0#0A**..-DforW
in32..7for.Windows.(eg.XP).using.Microsoft.Visual.C
#0A**..-DforCYGWIN32..4for.Windows.(eg.XP).using.GN
U.Cygnus.Solutions#0A**..-DforBC4..9for.Windows.(eg
.XP).using.Borland.C.4#2E0.and.TASM#0A**..-DforOS2.
.9for.OS/2.V2#2E1.using.Cset/2.and.Borland.Tasm#0A*
*..-DforSHwinCE..5for.WinCE.2#2E0.(SH3.processor)#0A
*/#0A#0A/*.INT#2Eh.is.created.by.mkint-h.(source.mk
int-h#2Ec),.it.defines#0A**.the.macros.BCPLINT32.an
d.BCPLINT64#0A*/#0A#23include."INT#2Eh"#0A#0A#23ifn
def.forWinCE#0A#23include.<stdio#2Eh>#0A#23endif#0A
#0A#23ifndef.forWIN32#0A#23include.<unistd#2Eh>#0A#23
endif#0A#0A#23ifndef.forWinCE#0A#23include.<stdlib#2E
h>#0A#23include.<string#2Eh>#0A#23include.<signal#2E
h>#0A#23endif#0A#0A#23ifndef.forWIN32#0A#23include.
<sys/time#2Eh>#0A#23endif#0A#0A#23ifndef.forWinCE#0A
#23include.<time#2Eh>#0A#23include.<errno#2Eh>#0A#23
include.<math#2Eh>#0A#23endif#0A#0A/*.For.32-bit.im
plementations.--.uncomment.the.following.*/#0A#23de
fine.B2Wsh.2#0A#23define.BperW.32#0A#23define.BCPLW
ORD.BCPLINT32#0A#23define.UBCPLWORD.BCPLUINT32#0A#23
define.FormD.FormD32#0A#23define.FormX.FormX32#0A#0A
/*.For.64-bit.implementations.--.uncomment.the.foll
owing.*/#0A/*#0A#23define.B2Wsh.3#0A#23define.BperW
.64#0A#23define.BCPLWORD.BCPLINT64#0A#23define.UBCP
LWORD.BCPLUINT64#0A#23define.FormD.FormD64#0A#23def
ine.FormX.FormX64#0A*/#0A#0A1/*.The.MAC.version.jus
t.about.works.on.a.Power.Macintosh.7100/66#0A**.usi
ng.Symantec.Think.C.6#2E0#0A**.I.used.cintsys#2Ec.c
interp#2Ec.kblib#2Ec.and.nullrastlib#2Ec.linked#0A*
*.with.the.standard.libraries.ANSI.and.unix#2E.The.
partition.size.was.5001K#0A**.and.#23define.forMAC.
was.edited.into.this.file#2E.(I.don't.know.how.to#0A
**.get.Think.C.to.do.that.#23definition.for.me)#2E#0A
**.The.command.command.files.bc.bs.bp.bco.and.bso.h
ad.to.be.edited.to#0A**.change./s.to.:s.and.#2E#2E/
.to.::.etc#2E.These.versions.are.in.sys/MAC#2E#0A**
.If.someone.would.suggest.how.to.get.a.visible.curs
or.I.would.be.grateful#2E#0A*/#0A#0A/*#0A**.Cintsys
/Cintpos.and.cinterp.need.the.type.signed.char.but.
this.is#0A**.not.available.on.all.implementations.o
f.C#2E.On.some.the.type.char#0A**.is.signed,.and.on
.some.(in.fact.most).signed.char.is.allowed#2E#0A**
.Comment.out.of.the.following.definitions.of.SIGNED
CHAR#2E.A.test.in#0A**.the.function.badimplementati
on.will.determine.whether.you.have.made#0A**.the.ri
ght.choice#2E#0A*/#0A#0A#23define.UNSIGNEDCHAR.unsi
gned.char#0A#23define.SIGNEDCHAR.signed.char#0A/*.#23
define.SIGNEDCHAR.char.*/#0A#0A1/*.Note.that#0A**..
1#23define.CINTASM.cintasm..6will.use.a.hand.writte
n.cintcode#0A**..32interpreter.in.addition.to.the#0A
**..32one.implemented.in.C#2E#0A**..1#23define.CINT
ASM.interpreter..2will.only.use.the.interperter#0A*
*..32written.in.C,.this.typically.runs#0A**..0322-3
.times.slower#2E#0A*/#0A#0A/*#0A**.CINTASM.is.now.a
lways.defined.to.be.cintasm#2E.The.function.cintasm
#0A**.is.either.defined.in.files.such.as.sysasm/LIN
UX/cintasm#2Es.of#0A**.in.cinterp#2Ec.when.compiled
.with.FASTyes.defined#2E#0A*/#0A#23define.CINTASM.c
intasm#0A#0A#23define.UNSIGNEDCHAR.unsigned.char#0A
#23define.SIGNEDCHAR.signed.char#0A/*.#23define.SIG
NEDCHAR.char.*/#0A#0A/*#0AMMAP..11set.if.mmap.is.us
ed.to.allocate.Cintcode.memory#0A*/#0A#0A#23ifdef.f
orMAC#0A#23include.<unix#2Eh>#0A#23include.<time#2E
h>#0A#23include.<sys/timeb#2Eh>#0A#23define.MALLOC(
n).malloc((n)<<B2Wsh)#0A#23define.TICKS_PER_SEC.(CL
OCKS_PER_SEC)#0A#23define.REMOVE.unlink#0A#23define
.UNIXNAMES#0A#23define.BIGENDER#0A#23endif#0A#0A#23
ifdef.forMIPS#0A#23include.<sys/types#2Eh>#0A#23inc
lude.<sys/stat#2Eh>#0A#23include.<time#2Eh>#0A#23in
clude.<sys/timeb#2Eh>#0A#23define.MALLOC(n).malloc(
(n)<<B2Wsh)#0A#23define.TICKS_PER_SEC.(CLOCKS_PER_S
EC)#0A#23define.REMOVE.unlink#0A#23define.UNIXNAMES
#0A#23endif#0A#0A#23ifdef.forSGI#0A#23include.<sys/
types#2Eh>#0A#23include.<sys/stat#2Eh>#0A#23include
.<time#2Eh>#0A#23include.<sys/timeb#2Eh>#0A#23defin
e.MALLOC(n).malloc((n)<<B2Wsh)#0A#23define.TICKS_PE
R_SEC.(CLOCKS_PER_SEC)#0A#23define.REMOVE.unlink#0A
#23define.UNIXNAMES#0A#23endif#0A#0A#23ifdef.forARM
#0A#23include.<sys/types#2Eh>#0A#23include.<sys/sta
t#2Eh>#0A#23include.<time#2Eh>#0A#23include.<sys/ti
meb#2Eh>#0A#23define.MALLOC(n).malloc((n)<<B2Wsh)#0A
#23define.TICKS_PER_SEC.(CLOCKS_PER_SEC)#0A#23defin
e.REMOVE.unlink#0A#23define.UNIXNAMES#0A#23define.M
MAP#0A#23endif#0A#0A#23ifdef.forLINUX#0A#23include.
<sys/stat#2Eh>#0A#23include.<time#2Eh>#0A#23include
.<fcntl#2Eh>#0A#23include.<sys/wait#2Eh>#0A#23inclu
de.<sys/time#2Eh>#0A#23include.<sys/timeb#2Eh>#0A#23
ifdef.SOUND#0A#23include.<sys/ioctl#2Eh>#0A#23inclu
de.<sys/unistd#2Eh>#0A#23include.<sys/fcntl#2Eh>#0A
#23include.<sys/soundcard#2Eh>#0A#23endif#0A#23defi
ne.MALLOC(n).malloc((n)<<B2Wsh)#0A#23define.TICKS_P
ER_SEC.(CLOCKS_PER_SEC)#0A#23define.REMOVE.unlink#0A
#23define.UNIXNAMES#0A#23define.MMAP#0A#23endif#0A#0A
#23ifdef.forLINUX64#0A#23include.<sys/stat#2Eh>#0A#23
include.<time#2Eh>#0A#23include.<fcntl#2Eh>#0A#23in
clude.<sys/wait#2Eh>#0A#23include.<sys/time#2Eh>#0A
#23include.<sys/timeb#2Eh>#0A#23ifdef.SOUND#0A#23in
clude.<sys/ioctl#2Eh>#0A#23include.<sys/unistd#2Eh>
#0A#23include.<sys/fcntl#2Eh>#0A#23include.<sys/sou
ndcard#2Eh>#0A#23endif#0A#23define.MALLOC(n).malloc
((n)<<B2Wsh)#0A#23define.TICKS_PER_SEC.(CLOCKS_PER_
SEC)#0A#23define.REMOVE.unlink#0A#23define.UNIXNAME
S#0A#23define.MMAP#0A#23endif#0A#0A#23ifdef.forVmsI
tanium#0A#23define.VMSNAMES#0A#23include.<stat#2Eh>
#0A#23include.<time#2Eh>#0A#23include.<fcntl#2Eh>#0A
#23include.<wait#2Eh>#0A#23include.<time#2Eh>#0A#23
include.<timeb#2Eh>#0A#23include.<unistd#2Eh>#0A#23
include.<inet#2Eh>#0A#23define.MALLOC(n).malloc((n)
<<B2Wsh)#0A#23define.TICKS_PER_SEC.(1001)#0A#23defi
ne.REMOVE.unlink#0A#23define.VMSNAMES#0A#23undef.CI
NTASM#0A#23define.CINTASM.interpret#0Atypedef.unsig
ned.int.socklen_t;#0A#23endif#0A#0A#23ifdef.forVmsV
ax#0A#23define.VMSNAMES#0A#23include.<stat#2Eh>#0A#23
include.<time#2Eh>#0A#23include.<fcntl#2Eh>#0A#23in
clude.<wait#2Eh>#0A#23include.<time#2Eh>#0A#23inclu
de.<timeb#2Eh>#0A#23include.<unistd#2Eh>#0A#23defin
e.MALLOC(n).malloc((n)<<B2Wsh)#0A#23define.TICKS_PE
R_SEC.(1001)#0A#23define.REMOVE.unlink#0A#23define.
VMSNAMES#0A#23endif#0A#0A#23ifdef.forGP2X#0A#23incl
ude.<sys/stat#2Eh>#0A#23include.<time#2Eh>#0A#23inc
lude.<fcntl#2Eh>#0A#23include.<sys/wait#2Eh>#0A#23i
nclude.<sys/time#2Eh>#0A#23include.<sys/timeb#2Eh>#0A
#23define.MALLOC(n).malloc((n)<<B2Wsh)#0A#23define.
TICKS_PER_SEC.(CLOCKS_PER_SEC)#0A#23define.REMOVE.u
nlink#0A#23define.UNIXNAMES#0A#23endif#0A#0A#23ifde
f.forLINUXAMD64#0A#23include.<sys/stat#2Eh>#0A#23in
clude.<time#2Eh>#0A#23include.<sys/timeb#2Eh>#0A#23
define.MALLOC(n).malloc((n)<<B2Wsh)#0A#23define.TIC
KS_PER_SEC.(CLOCKS_PER_SEC)#0A#23define.REMOVE.unli
nk#0A#23define.UNIXNAMES#0A#23define.MMAP#0A#23endi
f#0A#0A#23ifdef.forMacOSPPC#0A#23include.<sys/stat#2E
h>#0A#23include.<time#2Eh>#0A#23include.<sys/timeb#2E
h>#0A#23define.MALLOC(n).malloc((n)<<B2Wsh)#0A#23de
fine.TICKS_PER_SEC.(CLOCKS_PER_SEC)#0A#23define.REM
OVE.unlink#0A#23define.UNIXNAMES#0A#23define.BIGEND
ER#0A#23endif#0A#0A#23ifdef.forMacOSX#0A#23include.
<sys/stat#2Eh>#0A#23include.<time#2Eh>#0A#23include
.<sys/timeb#2Eh>#0A#23define.MALLOC(n).malloc((n)<<
B2Wsh)#0A#23define.TICKS_PER_SEC.(CLOCKS_PER_SEC)#0A
#23define.REMOVE.unlink#0A#23define.UNIXNAMES#0A#23
define.MMAP#0A#23endif#0A#0A#23ifdef.forCYGWIN32#0A
#23include.<sys/stat#2Eh>#0A#23include.<time#2Eh>#0A
#23include.<sys/timeb#2Eh>#0A#23define.MALLOC(n).ma
lloc((n)<<B2Wsh)#0A#23define.TICKS_PER_SEC.(CLOCKS_
PER_SEC)#0A#23define.REMOVE.unlink#0A#23define.UNIX
NAMES#0A#23endif#0A#0A#23ifdef.forLINUXPPC#0A#23inc
lude.<sys/stat#2Eh>#0A#23include.<time#2Eh>#0A#23in
clude.<sys/timeb#2Eh>#0A#23define.MALLOC(n).malloc(
(n)<<B2Wsh)#0A#23define.TICKS_PER_SEC.(CLOCKS_PER_S
EC)#0A#23define.REMOVE.unlink#0A#23define.UNIXNAMES
#0A#23define.BIGENDER#0A#23endif#0A#0A#23ifdef.forS
UN4#0A#23include.<sys/stat#2Eh>#0A#23include.<sys/t
ime#2Eh>#0A#23include.<sys/timeb#2Eh>#0A#23define.M
ALLOC(n).malloc((n)<<B2Wsh)#0A#23define.TICKS_PER_S
EC.(1004)#0A#23define.REMOVE.unlink#0A#23define.UNI
XNAMES#0A#23define.BIGENDER#0A#23endif#0A#0A#23ifde
f.forSPARC#0A#23include.<sys/stat#2Eh>#0A#23include
.<time#2Eh>#0A#23include.<sys/timeb#2Eh>#0A#23defin
e.MALLOC(n).malloc((n)<<B2Wsh)#0A#23define.TICKS_PE
R_SEC.(CLOCKS_PER_SEC)#0A#23define.REMOVE.unlink#0A
#23define.UNIXNAMES#0A#23define.BIGENDER#0A#23endif
#0A#0A#23ifdef.forALPHA#0A#23include.<sys/stat#2Eh>
#0A#23include.<sys/time#2Eh>#0A#23include.<sys/time
b#2Eh>#0A#23include.<stdlib#2Eh>#0A#23define.MALLOC
(n).malloc((n)<<B2Wsh)#0A#23define.TICKS_PER_SEC.(C
LOCKS_PER_SEC)#0A#23define.REMOVE.unlink#0A#23defin
e.UNIXNAMES#0A#23endif#0A#0A#23ifdef.forMSDOS#0A#23
include.<sys\stat#2Eh>#0A#23include.<time#2Eh>#0A#23
include.<sys/timeb#2Eh>#0A#23define.MALLOC(n).mallo
c((n)<<B2Wsh)#0A#23define.TICKS_PER_SEC.(CLK_TCK)#0A
#23define.REMOVE.unlink#0A#23define.WINNAMES#0A#23e
ndif#0A#0A#23ifdef.forBC4#0A#23include.<sys\stat#2E
h>#0A#23include.<time#2Eh>#0A#23include.<sys/timeb#2E
h>#0A#23define.MALLOC(n).malloc((n)<<B2Wsh)#0A#23de
fine.TICKS_PER_SEC.(CLK_TCK)#0A#23define.REMOVE.unl
ink#0A#23define.WINNAMES#0A#23endif#0A#0A#23ifdef.f
orOS2#0A#23include.<sys/stat#2Eh>#0A#23include.<sys
/time#2Eh>#0A#23include.<sys/timeb#2Eh>#0A#23define
.MALLOC(n).malloc((n)<<B2Wsh)#0A#23define.TICKS_PER
_SEC.(CLOCKS_PER_SEC)#0A#23define.REMOVE.remove#0A#23
define.WINNAMES#0A#23endif#0A#0A#23ifdef.forWIN32#0A
#23include.<sys/stat#2Eh>#0A#23include.<time#2Eh>#0A
#23include.<sys/timeb#2Eh>#0A#23include.<windows#2E
h>#0A#23include.<mmsystem#2Eh>#0A#23define.MALLOC(n
).malloc((n)<<B2Wsh)#0A#23define.TICKS_PER_SEC.(CLK
_TCK)#0A#23define.REMOVE._unlink#0A#23define.tzset.
_tzset#0A#23define.WINNAMES#0A#23endif#0A#0A#23ifde
f.forSHwinCE#0A#23define.forWinCE#0A#23endif#0A#0A#23
ifdef.forWinCE#0A#23undef.BCPLWORD#0A#23define.BCPL
WORD.long#0A#23define.MALLOC(n).LocalAlloc(LPTR,.(n
)<<B2Wsh)#0A#23define.TICKS_PER_SEC.1001#0A#23defin
e.REMOVE.unlink#0A#23define.WINNAMES#0A/*#23include
.<sys\stat#2Eh>.*/#0A/*#23include.<time#2Eh>.*/#0A#23
include.<windows#2Eh>..7/*.For.all.that.Windows.stu
ff.*/#0A#23include.<commctrl#2Eh>..6/*.Command.bar.
includes.*/#0A#23include."#2E#2E/sysasm/shWinCE/ceB
CPL#2Eh"./*.Program-specific.stuff.*/#0A#23include.
"Objidl#2Eh"#0A#23include.<stdlib#2Eh>#0A#0A#23defi
ne.PRINTFS.printfs#0A#23define.PRINTFD.printfd#0A#23
define.PRINTF(s).printfd(s,.0)#0A#23define.FILEPT.H
ANDLE#0A#0A/*.Unix.style.library.declarations.*/#0A
#0A#23define.FILEPT.HANDLE#0A#0A#23define.SEEK_SET.
FILE_BEGIN#0A#23define.SEEK_END.FILE_END#0A#0Aint.f
close(FILEPT.fp);#0Aint.fgetc(FILEPT.fp);#0Avoid.pu
tchar(char.ch);#0Avoid.fflush(FILEPT.fp);#0AFILEPT.
fopen(char.*,.char.*);#0Aint.fread(char.*buf,.size_
t.size,.size_t.len,.FILEPT.fp);#0Aint.fwrite(char.*
buf,.size_t.size,.size_t.len,.FILEPT.fp);#0Aint.fse
ek(FILEPT.fp,.long.pos,.int.method);#0Aint.ftell(FI
LEPT.fp);#0Aint.unlink(char.*);#0Aint.rename(char.*
,.char.*);#0Aint.clock();#0Achar.*getenv(char.*);#0A
int.main();#0A#0AFILEPT.stdout#3D0;#0A#0A#23define.
EOF.-1#0A#0A#23else#0A#0A#23define.PRINTFS.printf#0A
#23define.PRINTFD.printf#0A#23define.PRINTF.printf#0A
#23define.FILEPT.FILE*#0A#0A#23endif#0A#0A#23ifdef.
MMAP#0A#23include.<sys/mman#2Eh>#0A#23endif#0A#0Avo
id.trpush(BCPLWORD.val);#0A#0Atypedef.BCPLWORD.*BCP
LWORDpt;#0A#0A#23define.WD.(BCPLWORD)#0A#23define.U
WD.(unsigned.BCPLWORD)#0A#23define.PT.(BCPLWORD.*)#0A
#23define.BP.(unsigned.char.*)#0A#23define.SBP.(SIG
NEDCHAR.*)#0A#23define.HP.(unsigned.short.*)#0A#23d
efine.SHP.(short.*)#0A#0A#23define.Gn_sys..0073#0A#23
define.Gn_currco..0047#0A#23define.Gn_colist..0048#0A
#23define.Gn_rootnode..0029#0A#23define.Gn_result2.
.00210#0A#0A#23define.bootregs..00011#0A#23define.k
libregs..00021#0A#23define.saveregs..00031#0A#23def
ine.isrregs..00141#0A#0A#23define.rootnode.100#0A#0A
#23define.Rtn_tasktab..0050L#0A#23define.Rtn_devtab
..0061L#0A#23define.Rtn_tcblist..0052L#0A#23define.
Rtn_crntask..0053L#0A#23define.Rtn_blklist..0054L#0A
#23define.Rtn_tallyv..0065L#0A#23define.Rtn_clkints
on..0036L#0A#23define.Rtn_lastch..0067L#0A#23define
.Rtn_insadebug..0038L#0A#23define.Rtn_bptaddr..0059
L#0A#23define.Rtn_bptinstr..00310L#0A#23define.Rtn_
dbgvars..00411L#0A#23define.Rtn_clwkq..00612L#0A#23
define.Rtn_membase..00413L#0A#23define.Rtn_memsize.
.00414L#0A#23define.Rtn_info..00715L#0A#23define.Rt
n_sys..00816L#0A#23define.Rtn_boot..00717L#0A#23def
ine.Rtn_klib..00718L#0A#23define.Rtn_blib..00719L#0A
#23define.Rtn_keyboard..00320L#0A#23define.Rtn_scre
en..00521L#0A#23define.Rtn_vecstatsv..00222L#0A#23d
efine.Rtn_vecstatsvupb.23L#0A#23define.Rtn_intflag.
.00424L#0A#23define.Rtn_dumpflag..00325L#0A#23defin
e.Rtn_envlist..00426L#0A#23define.Rtn_abortcode..00
227L#0A#23define.Rtn_context..00428L#0A#23define.Rt
n_lastp..00629L#0A#23define.Rtn_lastg..00630L#0A#23
define.Rtn_lastst..00531L#0A#23define.Rtn_idletcb..
00432L#0A#23define.Rtn_adjclock..00333L#0A#23define
.Rtn_dcountv..00434L#0A#23define.Rtn_rootvar..00435
L#0A#23define.Rtn_pathvar..00436L#0A#23define.Rtn_h
drsvar..00437L#0A#23define.Rtn_scriptsvar..00138L#0A
#23define.Rtn_boottrace..00239L#0A#23define.Rtn_day
s..00740L#0A#23define.Rtn_msecs..00641L#0A#23define
.Rtn_ticks..00642L#0A#23define.Rtn_mc0..00843L#0A#23
define.Rtn_mc1..00844L#0A#23define.Rtn_mc2..00845L#0A
#23define.Rtn_mc3..00846L#0A#0A#23define.Rtn_upb..0
0850L#0A#0A1#23define.Tcb_namebase..00319L./*.Space
.for.upto.15.chars.of.task.name.*/#0A#0A1/*.SYS.fun
ctions.*/#0A#0A#23define.Sys_setcount..4(-1)#0A#23d
efine.Sys_quit..0100#0A#23define.Sys_rti..0111#0A#23
define.Sys_saveregs..0062#0A#23define.Sys_setst..00
93#0A#23define.Sys_tracing..0074#0A#23define.Sys_wa
tch..0095#0A#23define.Sys_tally..0096#0A#23define.S
ys_interpret..0057#0A#0A#23define.Sys_sardch..00710
#0A#23define.Sys_sawrch..00711#0A#23define.Sys_read
..00912#0A#23define.Sys_write..00813#0A#23define.Sy
s_openread..00514#0A#23define.Sys_openwrite..00415#0A
#23define.Sys_close..00816#0A#23define.Sys_deletefi
le..00317#0A#23define.Sys_renamefile..00318#0A#23de
fine.Sys_openappend..00319#0A#0A#23define.Sys_getve
c..00721#0A#23define.Sys_freevec..00622#0A#23define
.Sys_loadseg..00623#0A#23define.Sys_globin..00724#0A
#23define.Sys_unloadseg..00425#0A#23define.Sys_muld
iv..00726#0A#23define.Sys_intflag..00628#0A#23defin
e.Sys_setraster..00429#0A#23define.Sys_cputime..006
30#0A#23define.Sys_filemodtime..00231#0A#23define.S
ys_setprefix..00432#0A#23define.Sys_getprefix..0043
3#0A#23define.Sys_graphics..00534..5/*.Windows.CE.o
nly.*/#0A#0A#23define.Sys_seek..00938#0A#23define.S
ys_tell..00939#0A#23define.Sys_waitirq..00640#0A#23
define.Sys_lockirq..00641#0A#23define.Sys_unlockirq
..00442#0A#23define.Sys_devcom..00743#0A#23define.S
ys_datstamp..00544#0A#0A#23define.Sys_filesize..005
46#0A#23define.Sys_openreadwrite..00047#0A#23define
.Sys_getsysval..00448#0A#23define.Sys_putsysval..00
449#0A#23define.Sys_shellcom..00550#0A#23define.Sys
_getpid..00751#0A#23define.Sys_dumpmem..00652#0A#23
define.Sys_callnative..00353#0A#23define.Sys_platfo
rm..00554#0A#23define.Sys_inc..01055#0A#23define.Sy
s_buttons..00656#0A#23define.Sys_delay..00857#0A#23
define.Sys_sound..00858#0A#23define.Sys_callc..0085
9#0A#23define.Sys_trpush..00760#0A#23define.Sys_set
trcount..00361#0A#23define.Sys_gettrval..00562#0A#23
define.Sys_flt..01063#0A#23define.Sys_pollsardch..0
0364#0A#23define.Sys_incdcount..00465#0A#23define.S
ys_sdl..01066#0A#23define.Sys_gl..01167#0A#23define
.Sys_ext..01068#0A#0A#23define.fl_avail..0000#0A#23
define.fl_mk..0031#0A#23define.fl_unmk..0012#0A#23d
efine.fl_float..0003#0A#23define.fl_fix..0024#0A#23
define.fl_abs..0025#0A#23define.fl_mul..0026#0A#23d
efine.fl_div..0027#0A#23define.fl_add..0028#0A#23de
fine.fl_sub..0029#0A#23define.fl_pos..00110.#0A#23d
efine.fl_neg..00111#0A#23define.fl_eq..00212#0A#23d
efine.fl_ne..00213#0A#23define.fl_ls..00214#0A#23de
fine.fl_gr..00215#0A#23define.fl_le..00216#0A#23def
ine.fl_ge..00217#0A#0A#23define.fl_acos..00020#0A#23
define.fl_asin..00021#0A#23define.fl_atan..00022#0A
#23define.fl_atan2.23#0A#23define.fl_cos..00124#0A#23
define.fl_sin..00125#0A#23define.fl_tan..00126#0A#23
define.fl_cosh..00027#0A#23define.fl_sinh..00028#0A
#23define.fl_tanh..00029#0A#23define.fl_exp..00130#0A
#23define.fl_frexp.31#0A#23define.fl_ldexp.32#0A#23
define.fl_log..00133#0A#23define.fl_log10.34#0A#23d
efine.fl_modf..00035#0A#23define.fl_pow..00136#0A#23
define.fl_sqrt..00037#0A#23define.fl_ceil..00038#0A
#23define.fl_floor.39#0A#23define.fl_fmod..00040#0A
#0A#23define.fl_N2F..00141#0A#23define.fl_F2N..0014
2#0A#23define.fl_radius2..00143#0A#23define.fl_radi
us3..00144#0A#0A

######sysc/INT.h#
/*.This.file.was.generated.by.mkint-h.*/#0A#0A#23de
fine.BCPLINT32.int#0A#23define.BCPLUINT32.unsigned.
int#0A#23define.FormD32."d"#0A#23define.FormX32."X"
#0A#23define.BCPLINT64.long.long#0A#23define.BCPLUI
NT64.unsigned.long.long#0A#23define.FormD64."lld"#0A
#23define.FormX64."llX"#0A

######sysc/kblib.c#
/*.this.module.defines.the.machine.dependent.keyboa
rd.interface#0A#0A..1int.Readch(void)..3returns.the
.ASCII.code.for.the.next.key.pressed#0A..22without.
echo#2E#0A..1int.pollReadch(void).returns.the.next.
character.or.-3.if.none.available#2E#0A..1int.init_
keyb(void)..initialises.the.keyboard.interface#2E#0A
..1int.close_keyb(void).restores.the.keyboard.to.it
s.original.state#2E#0A..1int.intflag(void)..2return
s.1.if.interrupt.key.combination.pressed#2E#0A*/#0A
#0A#23ifndef.forSHwinCE#0A#23include.<stdio#2Eh>#0A
#23include.<stdlib#2Eh>#0A#23endif#0A#0A/*.cintsys#2E
h.contains.machine/system.dependent.#23defines..*/#0A
#23include."cintsys#2Eh"#0A#0A#23if.defined(forMIPS
).||.defined(forSUN4).||.defined(forALPHA).||.\#0A.
.2defined(forLINUXPPC).||.defined(forMacOSPPC).||.d
efined(forMacOSX)#0A#23include.<sys/ioctl#2Eh>#0A#23
include.<sgtty#2Eh>#0A#0Aint.init_keyb(void)#0A{.st
ruct.sgttyb.ttyb;#0A#0A..ioctl(0,.TIOCGETP,.&ttyb);
#0A..ttyb#2Esg_flags.#3D.CBREAK+EVENP+ODDP+CRMOD;#0A
..ioctl(0,.TIOCSETP,.&ttyb);#0A..return.0;#0A}#0A#0A
int.close_keyb(void)#0A{.struct.sgttyb.ttyb;#0A..io
ctl(0,.TIOCGETP,.&ttyb);#0A..ttyb#2Esg_flags.#3D.EC
HO+EVENP+ODDP+CRMOD;#0A..ioctl(0,.TIOCSETP,.&ttyb);
#0A..return.0;#0A}#0A#0Aint.Readch(void)#0A{.return
.getchar();#0A}#0A#0Aint.pollReadch(void)#0A{.retur
n.Readch();#0A}#0A#0Aint.intflag(void)#0A{.return.0
;#0A}#0A#23endif#0A#0A#23if.defined(forVmsItanium1)
#0A//.This.is.for.an.Itanium.running.VMS#0Atypedef.
unsigned.long.uLong;#0Atypedef.unsigned.long.long.u
Quad;#0Atypedef.unsigned.short.uWord;#0Atypedef.uns
igned.char.uByte;#0A#0A#23include.<errno#2Eh>#0A#23
include.<stdio#2Eh>#0A#23include.<stdlib#2Eh>#0A#23
include.<string#2Eh>#0A#23include.<time#2Eh>#0A#0A#23
include.dcdef#0A#23include.iodef#0A#23include.ssdef
#0A#23include.tt0002def#0A#0Astatic.uByte.originalm
odes[12];#09#09/*.original.terminal.modes.*/#0Astat
ic.uWord.ttchan.#3D.0;#09#09/*.0:.channel.has.not.b
een.assigned.yet.*/#0A#09#093/*.else:.i/o.channel.t
o.the.terminal.*/#0Astatic.char.keybuf[256];..14/*.
Bytes.received.from.TT.*/#0Astatic.int.keyp#3D0;..2
0/*.position.of.next.byte.in.keybuf.*/#0Astatic.int
.keylen#3D0;..18/*.Number.of.bytes.in.keylen.*/#0A#0A
uLong.sys$assign.();#0AuLong.sys$dassgn.();#0AuLong
.sys$exit.();#0AuLong.sys$gettim.();#0AuLong.sys$qi
o.();#0AuLong.sys$qiow.();#0AuLong.sys$setast.();#0A
uLong.sys$setimr.();#0AuLong.sys$synch.();#0A#0Aint
.init_keyb(void)#0A{.char.*p,.*ttname;#0A..struct.{
.uLong.size;#0A..9char.*buff;#0A..7}.ttdesc;#0A..uL
ong.sts;#0A#0A..struct.{.uWord.sts,.len;#0A..9char.
trm[4];#0A..7}.iosb;#0A#0A../*.Assign.I/O.channel.t
o.terminal.*/#0A#0A..ttname.#3D."TT";#0A..ttdesc#2E
size.#3D.strlen.(ttname);#0A..ttdesc#2Ebuff.#3D.ttn
ame;#0A..sts.#3D.sys$assign.(&ttdesc,.&ttchan,.0,.0
);#0A..if.(!(sts.&.1)).{#0A..2fprintf.(stderr,."err
or.0x%x.assigning.channel.to.terminal.%s\n",.sts,.t
tname);#0A..2return.sts;#0A..}#0A#0A../*.Sense.mode
.-.get.original.modes.and.make.sure.it.is.a.termina
l.*/#0A#0A..sts.#3D.sys$qiow.(1,.ttchan,.IO$_SENSEM
ODE,.&iosb,.0,.0,#0A..16originalmodes,.sizeof.origi
nalmodes,#0A..0160,.0,.0,.0);#0A..if.(sts.&.1).sts.
#3D.iosb#2Ests;#0A..if.(!(sts.&.1)).{#0A..2fprintf.
(stderr,."error.0x%x.sensing.terminal.%s.modes\n",.
sts,.ttname);#0A..2sys$exit.(sts);#0A..}#0A..if.(or
iginalmodes[0].!#3D.DC$_TERM).{#0A..2fprintf.(stder
r,."device.%s.is.not.a.terminal\n",.ttname);#0A..2r
eturn.SS$_IVDEVNAM;#0A..}#0A..return.0;#0A}#0A#0Ain
t.close_keyb(void)#0A{.sys$dassgn(ttchan);#0A..retu
rn.0;#0A}#0A#0Aint.readkeyseq(char.*keystr,.int.fla
g).{#0A..//.If.flag!#3D0.read.at.least.one.key.pres
s.into.keystr#0A..//.otherwise.read.as.many.as.are.
currently.available#2E#0A..//.Return.the.number.of.
bytes.read#2E#0A..int..len.#3D.0;#0A..int.i;#0A..ch
ar.buf[256];#0A..struct.{.uWord.sts,.len;#0A..9char
.termchr;#0A..9char.fill0001;#0A..9char.termlen;#0A
..9char.fill0002;#0A..7}.iosb;#0A..uLong.sts;#0A#0A
..if(flag).{#0A..2/*.Read.without.echoing,.wait.for
.one.character.*/#0A#0A..2sts.#3D.sys$qiow.(1,.ttch
an,.IO$_READVBLK.|.IO$M_NOECHO,#0A..18&iosb,.0,.0,.
buf,.1,#0A..0180,.0,.0,.0);#0A#0A..2/*.Check.termin
ation.status,.treat.any.error.like.an.eof.*/#0A#0A.
.2if.(sts.&.1).sts.#3D.iosb#2Ests;#0A..2if.(!(sts.&
.1)).return.-1;..14//.EOF#0A#0A..2/*.Concat.any.fet
ched.data.to.string.*/#0A#0A..2for.(i#3D0;.i<iosb#2E
len;.i++).keystr[len++].#3D.buf[i];#0A..2for.(i#3D0
;.i<iosb#2Etermlen;.i++).keystr[len++].#3D.(&iosb#2E
termchr)[i];#0A..}#0A#0A../*.Read.again,.but.just.g
et.whatever.happens.to.be.in.read-ahead,.don't.wait
.*/#0A#0A..sts.#3D.sys$qiow.(1,.ttchan,.IO$_READVBL
K.|.IO$M_NOECHO.|.IO$M_TIMED,#0A..16&iosb,.0,.0,#0A
..16buf,.sizeof.buf,#0A..0160,.0,.0,.0);#0A#0A../*.
Check.termination.status,.treat.any.error.like.an.e
of.*/#0A#0A..if.(sts.&.1).sts.#3D.iosb#2Ests;#0A..i
f.(sts.#3D#3D.SS$_TIMEOUT).sts.|#3D.1;#0A..if.(!(st
s.&.1)).return..-1;..16//.EOF#0A#0A../*.Concat.any.
fetched.data.to.string.*/#0A#0A..for.(i#3D0;.i<iosb
#2Elen;.i++).keystr[len++].#3D.buf[i];#0A..for.(i#3D
0;.i<iosb#2Etermlen;.i++).keystr[len++].#3D.(&iosb#2E
termchr)[i];#0A..keystr[len].#3D.0;#0A#0A..if(len#3D
#3D0000).len.#3D.-3;.//.pollingch#0A..return.len;#0A
}#0A#0Aint.Readch(void)#0A{.if.(keyp>#3Dkeylen).{#0A
..2keylen.#3D.readkeyseq(keybuf,.1);#0A..2keyp.#3D.
0;#0A..}#0A..return.keybuf[keyp++];#0A}#0A#0Aint.po
llReadch(void)#0A{.if.(keyp>#3Dkeylen).{#0A..2keyle
n.#3D.readkeyseq(keybuf,.0);.//.Read.what.is.availa
ble#0A..2keyp.#3D.0;#0A..}#0A..if(keylen#3D#3D-3.||
.keylen#3D#3D-1).return.keylen;.//.pollingch.or.end
streamch#0A..return.keybuf[keyp++];#0A}#0A#0Aint.in
tflag(void)#0A{.return.0;#0A}#0A#23endif#0A#0A#23if
.defined(forLINUX)||defined(forCYGWIN32)||defined(f
orSPARC)||\#0A..2defined(forGP2X)||defined(forLINUX
AMD64)||defined(forARM)#0A#23include.<unistd#2Eh>#0A
#23include.<stdio#2Eh>#0A#23include.<stdlib#2Eh>#0A
#23include.<termios#2Eh>#0A#23include.<errno#2Eh>#0A
#0A/*.Use.this.variable.to.remember.original.termin
al.attributes#2E..*/#0A..3#0Astruct.termios.saved_a
ttributes;#0A..3#0Avoid#0Areset_input_mode.(void)#0A
{#0A..tcsetattr.(STDIN_FILENO,.TCSANOW,.&saved_attr
ibutes);#0A}#0A..3#0Avoid#0Aset_input_mode.(void)#0A
{#0A..struct.termios.tattr;#0A#0A..if.(!isatty(STDI
N_FILENO)).return;..#0A..1#0A../*.Save.the.terminal
.attributes.so.we.can.restore.them.later#2E..*/#0A.
.tcgetattr.(STDIN_FILENO,.&saved_attributes);#0A..a
texit.(reset_input_mode);#0A#0A../*.Set.the.funny.t
erminal.modes#2E..*/#0A..tcgetattr.(STDIN_FILENO,.&
tattr);#0A..tattr#2Ec_lflag.&#3D.~(ICANON|ECHO);./*
.Clear.ICANON.and.ECHO#2E..1*/#0A..tattr#2Ec_cc[VMI
N].#3D.1;#0A..tattr#2Ec_cc[VTIME].#3D.0;#0A..tcseta
ttr.(STDIN_FILENO,.TCSAFLUSH,.&tattr);#0A}#0A..3#0A
int.Readch()#0A{.char.ch;#0A..int.rc.#3D.read(STDIN
_FILENO,.&ch,.1);#0A..if(rc#3D#3D0000).ch.#3D.-1;#0A
..//if(rc#3D#3D0000).#0A..//printf("rc#3D%d.ch#3D%3
d.errno#3D%d\n",.rc,.ch,.errno);#0A..return.ch;#0A}
#0A#0Aint.pollReadch(void)#0A{.struct.timeval.tv;#0A
..fd_set.read_fd;#0A..int.rc#3D0;#0A..tv#2Etv_sec..
#3D.0;#0A..tv#2Etv_usec.#3D.0;#0A..FD_ZERO(&read_fd
);#0A..FD_SET(0,.&read_fd);#0A..rc#3Dselect(1,.&rea
d_fd,.0,.0,.&tv);#0A..if(rc#3D#3D0000).return.-3;./
/.pollingch#0A..if(rc>0.&&.FD_ISSET(0,.&read_fd)).r
eturn.Readch();#0A..return.-1;.//.Error.or.EOF#0A}#0A
#0Aint.init_keyb(void)#0A{.set_input_mode();#0A..re
turn.0;#0A}#0A#0Aint.close_keyb(void)#0A{.return.0;
#0A}#0A#0Aint.intflag(void)#0A{.return.0;#0A}#0A#23
endif#0A#0A#23ifdef.forMAC#0A#23include.<console#2E
h>#0A#0Aint.Readch(void)#0A{.int.ch.#3D.EOF;#0A..wh
ile.(ch#3D#3DEOF).ch.#3D.getchar();./*.horrible!!2.
*/#0A..return.ch;#0A}#0A#0Aint.pollReadch(void)#0A{
.return.Readch();#0A}#0A#0Aint.init_keyb(void)#0A{.
console_options#2Etitle.#3D."\pBCPL.Cintcode";#0A..
console_options#2Epause_atexit.#3D.0;#0A..cshow(std
in);#0A..csetmode(C_RAW,.stdin);#0A..return.0;#0A}#0A
#0Aint.close_keyb()#0A{.return.0;#0A}#0A#0Aint.intf
lag(void)#0A{.long.theKeys[4];#0A..GetKeys(theKeys)
;#0A..return.theKeys[1]#3D#3D0000x8000005;../*.Comm
and-Option-Shift.depressed..*/#0A}#0A#23endif#0A#0A
#23if.defined(forMSDOS).||.defined(forBC4).||.defin
ed(forVmsItanium)#0A#23include.<signal#2Eh>#0A#0Aex
tern.int.getch(void);#0A#0Aint.Readch()#0A//{.int.c
h#3Dgetch();#0A{.int.ch#3Dgetchar();..//.Itanium.ve
rsion#0A..if(ch#3D#3D0003).{./*.ctrl-C.*/#0A..2rais
e(SIGINT);#0A..}#0A..return.ch;#0A}#0A#0Aint.pollRe
adch(void)#0A{.return.Readch();#0A}#0A#0Aint.init_k
eyb(void)#0A{.return.0;#0A}#0A#0Aint.close_keyb(voi
d)#0A{.return.0;#0A}#0A#0Aint.intflag(void)#0A{.ret
urn.0;#0A}#0A#23endif#0A#0A#23ifdef.forWIN32#0A#23i
nclude.<conio#2Eh>#0A#23include.<signal#2Eh>#0A#0Ae
xtern.int.getch(void);#0A#0Aint.Readch()#0A{.int.ch
#3D_getch();#0A..if(ch#3D#3D0003).{./*.ctrl-C.*/#0A
..2raise(SIGINT);#0A..}#0A..return.ch;#0A}#0A#0Aint
.pollReadch(void)#0A{.if.(_kbhit()).return._getch()
;#0A..return.-3;./*.pollingch.*/#0A}#0A#0Aint.init_
keyb(void)#0A{.return.0;#0A}#0A#0Aint.close_keyb(vo
id)#0A{.return.0;#0A}#0A#0Aint.intflag(void)#0A{.re
turn.0;#0A}#0A#23endif#0A#0A#23ifdef.forOS2#0A#23in
clude.<conio#2Eh>#0A#0Aint.Readch(void)#0A{.int.ch.
#3D.getch();#0A..return.ch;#0A}#0A#0Aint.pollReadch
(void)#0A{.return.Readch();#0A}#0A#0Aint.init_keyb(
void)#0A{.return.0;#0A}#0A#0Aint.close_keyb(void)#0A
{.return.0;#0A}#0A#0Aint.intflag(void)#0A{.return.0
;#0A}#0A#23endif#0A#0A#23ifdef.forSHwinCE#0A#0Aexte
rn.int.getch(void);#0A#0Aint.Readch()#0A{.return.ch
BufGet();#0A}#0A#0Aint.pollReadch(void)#0A{.return.
Readch();#0A}#0A#0Aint.init_keyb(void)#0A{.return.0
;#0A}#0A#0Aint.close_keyb(void)#0A{.return.0;#0A}#0A
#0Aint.intflag(void)#0A{.INT32.flag.#3D.Interrupted
;#0A..Interrupted.#3D.0;#0A..return.flag;#0A}#0A#0A
/*.Unix.style.library.*/#0A#0AFILEPT.fopen(char.*na
me,.char.*str).{#0A#09FILEPT.fp#3DNULL;#0A#09TCHAR.
szName[100];#0A#09DWORD.access.#3D.0;#0A#09DWORD.mo
de.#3D.0;#0A..6DWORD.share.#3D.0;#0A..6DWORD.creati
on.#3D.0;#0A..6DWORD.attrs.#3D.0;#0A#09int.i;#0A#09
for.(i#3D0;.*name;.i++).szName[i].#3D.*name++;#0A#09
szName[i].#3D.0;#0A#0A#09while(*str).{#0A#09..if.(s
tr[0]#3D#3D'r').{#0A..10access.#3D..1GENERIC_READ;#0A
..10share.#3D..2FILE_SHARE_READ;#0A..10creation.#3D
.OPEN_EXISTING;./*.fail.if.doesn't.exist.*/#0A..10a
ttrs.#3D..2FILE_ATTRIBUTE_NORMAL;#0A..8}#0A..8if(*s
tr#3D#3D'w').{#0A..10access.#3D..1GENERIC_WRITE;#0A
..10share.#3D..2FILE_SHARE_WRITE;#0A..10creation.#3D
.CREATE_ALWAYS;./*.create.or.truncate.*/#0A..10attr
s.#3D..2FILE_ATTRIBUTE_NORMAL;#0A#09..}#0A..8if(*st
r#3D#3D'+').{#0A..10access.#3D..1GENERIC_READ.|.GEN
ERIC_WRITE;#0A..10share.#3D..2FILE_SHARE_READ.|.FIL
E_SHARE_WRITE;#0A..10creation.#3D.OPEN_ALWAYS;./*.O
pen.or.create,.no.truncation.*/#0A..10attrs.#3D..2F
ILE_FLAG_RANDOM_ACCESS;#0A#09..}#0A..8str++;#0A#09}
#0A..6fp.#3D.CreateFile(szName,.access,.share,.NULL
,.creation,.attrs,.0);#0A#09if.(fp#3D#3DINVALID_HAN
DLE_VALUE).fp.#3D.0;#0A#09return.fp;#0A}#0A#0Aint.f
close(FILEPT.fp).{#0A#09return.CloseHandle(fp).?.0.
:.1;#0A}#0A#0Aint.clock().{#0A#09return.GetTickCoun
t();#0A}#0A#0Avoid.putchar(char.ch).{#0A#09Wrch(ch)
;#0A}#0A#0Avoid.fflush(FILEPT.fp).{#0A#09return;#0A
}#0A#0Aint.fread(char.*buf,.size_t.size,.size_t.len
,.FILEPT.fp).{#0A#09DWORD.n#3D0;#0A#09BOOL.rc.#3D.R
eadFile(fp,.buf,.(DWORD)size*len,.&n,.NULL);#0A#09i
f(!rc).{#0A..8DWORD.err.#3D.GetLastError();#0A#09..
/*#0A..8PRINTFD("fread:.ReadFile,.err#3D%".FormD."\
n",.(DWORD)err);#0A#09..*/#0A..8return.-1;#0A#09}#0A
#09/*#0A#09PRINTFD("fread.trying.to.read.from.fd#3D
%".FormD."\n",.(DWORD)fp);#0A#09PRINTFD("fread.tryi
ng.to.read.%".FormD.".bytes,.",.(DWORD)(size*len));
#0A#09PRINTFD("got.%".FormD."\n",.n);#0A#09*/#0A#09
return.n;#0A}#0A#0Aint.fwrite(char.*buf,.size_t.siz
e,.size_t.len,.FILEPT.fp).{#0A#09DWORD.n#3D0;#0A#09
if(WriteFile(fp,.buf,.(DWORD)size*len,.&n,.NULL))#0A
#09..return.n;./*.Success.*/#0A#09return.-1;#0A}#0A
#0Aint.fseek(FILEPT.fp,.INT32.pos,.int.method).{./*
.Set.the.file.position.*/#0A..SetFilePointer(fp,.(L
ONG)pos,.NULL,.method);#0A..return.0;#0A}#0A#0Aint.
ftell(FILEPT.fp).{./*.Return.the.current.file.posit
ion.*/#0A..return.SetFilePointer(fp,.0,.NULL,.FILE_
CURRENT);#0A}#0A#0A1int.unlink(char.*name).{#0A..6/
*.Delete.(remove).a.named.file#2E.*/#0A#09TCHAR.szN
ame[100];#0A#09int.i;#0A#09for.(i#3D0;.*name;.i++).
szName[i].#3D.*name++;#0A#09szName[i].#3D.0;#0A#09r
eturn.!.DeleteFile(szName);#0A}#0A#0Aint.rename(cha
r.*from,.char.*to).{#0A#09TCHAR.szFrom[100];#0A#09T
CHAR.szTo[100];#0A#09int.i;#0A#09for.(i#3D0;.*from;
.i++).szFrom[i].#3D.*from++;#0A#09szFrom[i].#3D.0;#0A
#09for.(i#3D0;.*to;.i++).szTo[i].#3D.*to++;#0A#09sz
To[i].#3D.0;#0A#09return.!.MoveFile(szFrom,.szTo);#0A
}#0A#0Aint.fgetc(FILEPT.fp).{#0A#09BYTE.ch;#0A#09DW
ORD.n#3D0;#0A#09ReadFile(fp,.&ch,.1,.&n,.NULL);#0A#0A
#09return.n#3D#3D0000.?.EOF.:.ch;#0A}#0A#0Aint.eqst
r(char.*s1,.char.*s2).{#0A..while(*s1.&&.*s2).if(*s
1++.!#3D.*s2++).return.0;#0A..return.*s1#3D#3D*s2;#0A
}#0A#0Achar.*getenv(char.*name).{#0A.if(eqstr(name,
."BCPLPATH")).return."\\BCPL\\cintcode\\cin";#0A.if
(eqstr(name,."BCPLROOT")).return."\\BCPL\\cintcode"
;#0A.if(eqstr(name,."BCPLHDRS")).return."\\BCPL\\ci
ntcode\\g";#0A.return."";#0A}#0A#23endif#0A#0A

######sysc/kblib64.c#
/*.this.module.defines.the.machine.dependent.keyboa
rd.interface#0A#0A..1int.Readch(void)..3returns.the
.ASCII.code.for.the.next.key.pressed#0A..22without.
echo#2E#0A..1int.pollReadch(void).returns.the.next.
character.or.-3.if.none.available#2E#0A..1int.init_
keyb(void)..initialises.the.keyboard.interface#2E#0A
..1int.close_keyb(void).restores.the.keyboard.to.it
s.original.state#2E#0A..1int.intflag(void)..2return
s.1.if.interrupt.key.combination.pressed#2E#0A*/#0A
#0A#23ifndef.forSHwinCE#0A#23include.<stdio#2Eh>#0A
#23include.<stdlib#2Eh>#0A#23endif#0A#0A/*.cinterp6
4#2Eh.contains.machine/system.dependent.#23defines.
.*/#0A#23include."cintsys64#2Eh"#0A#0A#23if.defined
(forMIPS).||.defined(forSUN4).||.defined(forALPHA).
||.\#0A..2defined(forLINUXPPC).||.defined(forMacOSP
PC).||.defined(forMacOSX)#0A#23include.<sys/ioctl#2E
h>#0A#23include.<sgtty#2Eh>#0A#0Aint.init_keyb(void
)#0A{.struct.sgttyb.ttyb;#0A#0A..ioctl(0,.TIOCGETP,
.&ttyb);#0A..ttyb#2Esg_flags.#3D.CBREAK+EVENP+ODDP+
CRMOD;#0A..ioctl(0,.TIOCSETP,.&ttyb);#0A..return.0;
#0A}#0A#0Aint.close_keyb(void)#0A{.struct.sgttyb.tt
yb;#0A..ioctl(0,.TIOCGETP,.&ttyb);#0A..ttyb#2Esg_fl
ags.#3D.ECHO+EVENP+ODDP+CRMOD;#0A..ioctl(0,.TIOCSET
P,.&ttyb);#0A..return.0;#0A}#0A#0Aint.Readch(void)#0A
{.return.getchar();#0A}#0A#0Aint.pollReadch(void)#0A
{.return.Readch();#0A}#0A#0Aint.intflag(void)#0A{.r
eturn.0;#0A}#0A#23endif#0A#0A#23if.defined(forVmsIt
anium1)#0A//.This.is.for.an.Itanium.running.VMS#0At
ypedef.unsigned.long.uLong;#0Atypedef.unsigned.long
.long.uQuad;#0Atypedef.unsigned.short.uWord;#0Atype
def.unsigned.char.uByte;#0A#0A#23include.<errno#2Eh
>#0A#23include.<stdio#2Eh>#0A#23include.<stdlib#2Eh
>#0A#23include.<string#2Eh>#0A#23include.<time#2Eh>
#0A#0A#23include.dcdef#0A#23include.iodef#0A#23incl
ude.ssdef#0A#23include.tt0002def#0A#0Astatic.uByte.
originalmodes[12];#09#09/*.original.terminal.modes.
*/#0Astatic.uWord.ttchan.#3D.0;#09#09/*.0:.channel.
has.not.been.assigned.yet.*/#0A#09#093/*.else:.i/o.
channel.to.the.terminal.*/#0Astatic.char.keybuf[256
];..14/*.Bytes.received.from.TT.*/#0Astatic.int.key
p#3D0;..20/*.position.of.next.byte.in.keybuf.*/#0As
tatic.int.keylen#3D0;..18/*.Number.of.bytes.in.keyl
en.*/#0A#0AuLong.sys$assign.();#0AuLong.sys$dassgn.
();#0AuLong.sys$exit.();#0AuLong.sys$gettim.();#0Au
Long.sys$qio.();#0AuLong.sys$qiow.();#0AuLong.sys$s
etast.();#0AuLong.sys$setimr.();#0AuLong.sys$synch.
();#0A#0Aint.init_keyb(void)#0A{.char.*p,.*ttname;#0A
..struct.{.uLong.size;#0A..9char.*buff;#0A..7}.ttde
sc;#0A..uLong.sts;#0A#0A..struct.{.uWord.sts,.len;#0A
..9char.trm[4];#0A..7}.iosb;#0A#0A../*.Assign.I/O.c
hannel.to.terminal.*/#0A#0A..ttname.#3D."TT";#0A..t
tdesc#2Esize.#3D.strlen.(ttname);#0A..ttdesc#2Ebuff
.#3D.ttname;#0A..sts.#3D.sys$assign.(&ttdesc,.&ttch
an,.0,.0);#0A..if.(!(sts.&.1)).{#0A..2fprintf.(stde
rr,."error.0x%x.assigning.channel.to.terminal.%s\n"
,.sts,.ttname);#0A..2return.sts;#0A..}#0A#0A../*.Se
nse.mode.-.get.original.modes.and.make.sure.it.is.a
.terminal.*/#0A#0A..sts.#3D.sys$qiow.(1,.ttchan,.IO
$_SENSEMODE,.&iosb,.0,.0,#0A..16originalmodes,.size
of.originalmodes,#0A..0160,.0,.0,.0);#0A..if.(sts.&
.1).sts.#3D.iosb#2Ests;#0A..if.(!(sts.&.1)).{#0A..2
fprintf.(stderr,."error.0x%x.sensing.terminal.%s.mo
des\n",.sts,.ttname);#0A..2sys$exit.(sts);#0A..}#0A
..if.(originalmodes[0].!#3D.DC$_TERM).{#0A..2fprint
f.(stderr,."device.%s.is.not.a.terminal\n",.ttname)
;#0A..2return.SS$_IVDEVNAM;#0A..}#0A..return.0;#0A}
#0A#0Aint.close_keyb(void)#0A{.sys$dassgn(ttchan);#0A
..return.0;#0A}#0A#0Aint.readkeyseq(char.*keystr,.i
nt.flag).{#0A..//.If.flag!#3D0.read.at.least.one.ke
y.press.into.keystr#0A..//.otherwise.read.as.many.a
s.are.currently.available#2E#0A..//.Return.the.numb
er.of.bytes.read#2E#0A..int..len.#3D.0;#0A..int.i;#0A
..char.buf[256];#0A..struct.{.uWord.sts,.len;#0A..9
char.termchr;#0A..9char.fill0001;#0A..9char.termlen
;#0A..9char.fill0002;#0A..7}.iosb;#0A..uLong.sts;#0A
#0A..if(flag).{#0A..2/*.Read.without.echoing,.wait.
for.one.character.*/#0A#0A..2sts.#3D.sys$qiow.(1,.t
tchan,.IO$_READVBLK.|.IO$M_NOECHO,#0A..18&iosb,.0,.
0,.buf,.1,#0A..0180,.0,.0,.0);#0A#0A..2/*.Check.ter
mination.status,.treat.any.error.like.an.eof.*/#0A#0A
..2if.(sts.&.1).sts.#3D.iosb#2Ests;#0A..2if.(!(sts.
&.1)).return.-1;..14//.EOF#0A#0A..2/*.Concat.any.fe
tched.data.to.string.*/#0A#0A..2for.(i#3D0;.i<iosb#2E
len;.i++).keystr[len++].#3D.buf[i];#0A..2for.(i#3D0
;.i<iosb#2Etermlen;.i++).keystr[len++].#3D.(&iosb#2E
termchr)[i];#0A..}#0A#0A../*.Read.again,.but.just.g
et.whatever.happens.to.be.in.read-ahead,.don't.wait
.*/#0A#0A..sts.#3D.sys$qiow.(1,.ttchan,.IO$_READVBL
K.|.IO$M_NOECHO.|.IO$M_TIMED,#0A..16&iosb,.0,.0,#0A
..16buf,.sizeof.buf,#0A..0160,.0,.0,.0);#0A#0A../*.
Check.termination.status,.treat.any.error.like.an.e
of.*/#0A#0A..if.(sts.&.1).sts.#3D.iosb#2Ests;#0A..i
f.(sts.#3D#3D.SS$_TIMEOUT).sts.|#3D.1;#0A..if.(!(st
s.&.1)).return..-1;..16//.EOF#0A#0A../*.Concat.any.
fetched.data.to.string.*/#0A#0A..for.(i#3D0;.i<iosb
#2Elen;.i++).keystr[len++].#3D.buf[i];#0A..for.(i#3D
0;.i<iosb#2Etermlen;.i++).keystr[len++].#3D.(&iosb#2E
termchr)[i];#0A..keystr[len].#3D.0;#0A#0A..if(len#3D
#3D0000).len.#3D.-3;.//.pollingch#0A..return.len;#0A
}#0A#0Aint.Readch(void)#0A{.if.(keyp>#3Dkeylen).{#0A
..2keylen.#3D.readkeyseq(keybuf,.1);#0A..2keyp.#3D.
0;#0A..}#0A..return.keybuf[keyp++];#0A}#0A#0Aint.po
llReadch(void)#0A{.if.(keyp>#3Dkeylen).{#0A..2keyle
n.#3D.readkeyseq(keybuf,.0);.//.Read.what.is.availa
ble#0A..2keyp.#3D.0;#0A..}#0A..if(keylen#3D#3D-3.||
.keylen#3D#3D-1).return.keylen;.//.pollingch.or.end
streamch#0A..return.keybuf[keyp++];#0A}#0A#0Aint.in
tflag(void)#0A{.return.0;#0A}#0A#23endif#0A#0A#23if
.defined(forLINUX)||defined(forCYGWIN32)||defined(f
orSPARC)||\#0A..2defined(forGP2X)||defined(forLINUX
AMD64)||defined(forLINUX64)||defined(forARM)#0A#23i
nclude.<unistd#2Eh>#0A#23include.<stdio#2Eh>#0A#23i
nclude.<stdlib#2Eh>#0A#23include.<termios#2Eh>#0A#23
include.<errno#2Eh>#0A#0A/*.Use.this.variable.to.re
member.original.terminal.attributes#2E..*/#0A..3#0A
struct.termios.saved_attributes;#0A..3#0Avoid#0Ares
et_input_mode.(void)#0A{#0A..tcsetattr.(STDIN_FILEN
O,.TCSANOW,.&saved_attributes);#0A}#0A..3#0Avoid#0A
set_input_mode.(void)#0A{#0A..struct.termios.tattr;
#0A#0A..if.(!isatty(STDIN_FILENO)).return;..#0A..1#0A
../*.Save.the.terminal.attributes.so.we.can.restore
.them.later#2E..*/#0A..tcgetattr.(STDIN_FILENO,.&sa
ved_attributes);#0A..atexit.(reset_input_mode);#0A#0A
../*.Set.the.funny.terminal.modes#2E..*/#0A..tcgeta
ttr.(STDIN_FILENO,.&tattr);#0A..tattr#2Ec_lflag.&#3D
.~(ICANON|ECHO);./*.Clear.ICANON.and.ECHO#2E..1*/#0A
..tattr#2Ec_cc[VMIN].#3D.1;#0A..tattr#2Ec_cc[VTIME]
.#3D.0;#0A..tcsetattr.(STDIN_FILENO,.TCSAFLUSH,.&ta
ttr);#0A}#0A..3#0Aint.Readch()#0A{.char.ch;#0A..int
.rc.#3D.read(STDIN_FILENO,.&ch,.1);#0A..if(rc#3D#3D
0000).ch.#3D.-1;#0A..//if(rc#3D#3D0000).#0A..//prin
tf("rc#3D%d.ch#3D%3d.errno#3D%d\n",.rc,.ch,.errno);
#0A..return.ch;#0A}#0A#0Aint.pollReadch(void)#0A{.s
truct.timeval.tv;#0A..fd_set.read_fd;#0A..int.rc#3D
0;#0A..tv#2Etv_sec..#3D.0;#0A..tv#2Etv_usec.#3D.0;#0A
..FD_ZERO(&read_fd);#0A..FD_SET(0,.&read_fd);#0A..r
c#3Dselect(1,.&read_fd,.0,.0,.&tv);#0A..if(rc#3D#3D
0000).return.-3;.//.pollingch#0A..if(rc>0.&&.FD_ISS
ET(0,.&read_fd)).return.Readch();#0A..return.-1;.//
.Error.or.EOF#0A}#0A#0Aint.init_keyb(void)#0A{.set_
input_mode();#0A..return.0;#0A}#0A#0Aint.close_keyb
(void)#0A{.return.0;#0A}#0A#0Aint.intflag(void)#0A{
.return.0;#0A}#0A#23endif#0A#0A#23ifdef.forMAC#0A#23
include.<console#2Eh>#0A#0Aint.Readch(void)#0A{.int
.ch.#3D.EOF;#0A..while.(ch#3D#3DEOF).ch.#3D.getchar
();./*.horrible!!2.*/#0A..return.ch;#0A}#0A#0Aint.p
ollReadch(void)#0A{.return.Readch();#0A}#0A#0Aint.i
nit_keyb(void)#0A{.console_options#2Etitle.#3D."\pB
CPL.Cintcode";#0A..console_options#2Epause_atexit.#3D
.0;#0A..cshow(stdin);#0A..csetmode(C_RAW,.stdin);#0A
..return.0;#0A}#0A#0Aint.close_keyb()#0A{.return.0;
#0A}#0A#0Aint.intflag(void)#0A{.long.theKeys[4];#0A
..GetKeys(theKeys);#0A..return.theKeys[1]#3D#3D0000
x8000005;../*.Command-Option-Shift.depressed..*/#0A
}#0A#23endif#0A#0A#23if.defined(forMSDOS).||.define
d(forBC4).||.defined(forVmsItanium)#0A#23include.<s
ignal#2Eh>#0A#0Aextern.int.getch(void);#0A#0Aint.Re
adch()#0A//{.int.ch#3Dgetch();#0A{.int.ch#3Dgetchar
();..//.Itanium.version#0A..if(ch#3D#3D0003).{./*.c
trl-C.*/#0A..2raise(SIGINT);#0A..}#0A..return.ch;#0A
}#0A#0Aint.pollReadch(void)#0A{.return.Readch();#0A
}#0A#0Aint.init_keyb(void)#0A{.return.0;#0A}#0A#0Ai
nt.close_keyb(void)#0A{.return.0;#0A}#0A#0Aint.intf
lag(void)#0A{.return.0;#0A}#0A#23endif#0A#0A#23ifde
f.forWIN32#0A#23include.<conio#2Eh>#0A#23include.<s
ignal#2Eh>#0A#0Aextern.int.getch(void);#0A#0Aint.Re
adch()#0A{.int.ch#3D_getch();#0A..if(ch#3D#3D0003).
{./*.ctrl-C.*/#0A..2raise(SIGINT);#0A..}#0A..return
.ch;#0A}#0A#0Aint.pollReadch(void)#0A{.if.(_kbhit()
).return._getch();#0A..return.-3;./*.pollingch.*/#0A
}#0A#0Aint.init_keyb(void)#0A{.return.0;#0A}#0A#0Ai
nt.close_keyb(void)#0A{.return.0;#0A}#0A#0Aint.intf
lag(void)#0A{.return.0;#0A}#0A#23endif#0A#0A#23ifde
f.forOS2#0A#23include.<conio#2Eh>#0A#0Aint.Readch(v
oid)#0A{.int.ch.#3D.getch();#0A..return.ch;#0A}#0A#0A
int.pollReadch(void)#0A{.return.Readch();#0A}#0A#0A
int.init_keyb(void)#0A{.return.0;#0A}#0A#0Aint.clos
e_keyb(void)#0A{.return.0;#0A}#0A#0Aint.intflag(voi
d)#0A{.return.0;#0A}#0A#23endif#0A#0A#23ifdef.forSH
winCE#0A#0Aextern.int.getch(void);#0A#0Aint.Readch(
)#0A{.return.chBufGet();#0A}#0A#0Aint.pollReadch(vo
id)#0A{.return.Readch();#0A}#0A#0Aint.init_keyb(voi
d)#0A{.return.0;#0A}#0A#0Aint.close_keyb(void)#0A{.
return.0;#0A}#0A#0Aint.intflag(void)#0A{.INT32.flag
.#3D.Interrupted;#0A..Interrupted.#3D.0;#0A..return
.flag;#0A}#0A#0A/*.Unix.style.library.*/#0A#0AFILEP
T.fopen(char.*name,.char.*str).{#0A#09FILEPT.fp#3DN
ULL;#0A#09TCHAR.szName[100];#0A#09DWORD.access.#3D.
0;#0A#09DWORD.mode.#3D.0;#0A..6DWORD.share.#3D.0;#0A
..6DWORD.creation.#3D.0;#0A..6DWORD.attrs.#3D.0;#0A
#09int.i;#0A#09for.(i#3D0;.*name;.i++).szName[i].#3D
.*name++;#0A#09szName[i].#3D.0;#0A#0A#09while(*str)
.{#0A#09..if.(str[0]#3D#3D'r').{#0A..10access.#3D..
1GENERIC_READ;#0A..10share.#3D..2FILE_SHARE_READ;#0A
..10creation.#3D.OPEN_EXISTING;./*.fail.if.doesn't.
exist.*/#0A..10attrs.#3D..2FILE_ATTRIBUTE_NORMAL;#0A
..8}#0A..8if(*str#3D#3D'w').{#0A..10access.#3D..1GE
NERIC_WRITE;#0A..10share.#3D..2FILE_SHARE_WRITE;#0A
..10creation.#3D.CREATE_ALWAYS;./*.create.or.trunca
te.*/#0A..10attrs.#3D..2FILE_ATTRIBUTE_NORMAL;#0A#09
..}#0A..8if(*str#3D#3D'+').{#0A..10access.#3D..1GEN
ERIC_READ.|.GENERIC_WRITE;#0A..10share.#3D..2FILE_S
HARE_READ.|.FILE_SHARE_WRITE;#0A..10creation.#3D.OP
EN_ALWAYS;./*.Open.or.create,.no.truncation.*/#0A..
10attrs.#3D..2FILE_FLAG_RANDOM_ACCESS;#0A#09..}#0A.
.8str++;#0A#09}#0A..6fp.#3D.CreateFile(szName,.acce
ss,.share,.NULL,.creation,.attrs,.0);#0A#09if.(fp#3D
#3DINVALID_HANDLE_VALUE).fp.#3D.0;#0A#09return.fp;#0A
}#0A#0Aint.fclose(FILEPT.fp).{#0A#09return.CloseHan
dle(fp).?.0.:.1;#0A}#0A#0Aint.clock().{#0A#09return
.GetTickCount();#0A}#0A#0Avoid.putchar(char.ch).{#0A
#09Wrch(ch);#0A}#0A#0Avoid.fflush(FILEPT.fp).{#0A#09
return;#0A}#0A#0Aint.fread(char.*buf,.size_t.size,.
size_t.len,.FILEPT.fp).{#0A#09DWORD.n#3D0;#0A#09BOO
L.rc.#3D.ReadFile(fp,.buf,.(DWORD)size*len,.&n,.NUL
L);#0A#09if(!rc).{#0A..8DWORD.err.#3D.GetLastError(
);#0A#09../*#0A..8PRINTFD("fread:.ReadFile,.err#3D%
".FormD."\n",.(DWORD)err);#0A#09..*/#0A..8return.-1
;#0A#09}#0A#09/*#0A#09PRINTFD("fread.trying.to.read
.from.fd#3D%".FormD."\n",.(DWORD)fp);#0A#09PRINTFD(
"fread.trying.to.read.%".FormD.".bytes,.",.(DWORD)(
size*len));#0A#09PRINTFD("got.%".FormD."\n",.n);#0A
#09*/#0A#09return.n;#0A}#0A#0Aint.fwrite(char.*buf,
.size_t.size,.size_t.len,.FILEPT.fp).{#0A#09DWORD.n
#3D0;#0A#09if(WriteFile(fp,.buf,.(DWORD)size*len,.&
n,.NULL))#0A#09..return.n;./*.Success.*/#0A#09retur
n.-1;#0A}#0A#0Aint.fseek(FILEPT.fp,.INT32.pos,.int.
method).{./*.Set.the.file.position.*/#0A..SetFilePo
inter(fp,.(LONG)pos,.NULL,.method);#0A..return.0;#0A
}#0A#0Aint.ftell(FILEPT.fp).{./*.Return.the.current
.file.position.*/#0A..return.SetFilePointer(fp,.0,.
NULL,.FILE_CURRENT);#0A}#0A#0A1int.unlink(char.*nam
e).{#0A..6/*.Delete.(remove).a.named.file#2E.*/#0A#09
TCHAR.szName[100];#0A#09int.i;#0A#09for.(i#3D0;.*na
me;.i++).szName[i].#3D.*name++;#0A#09szName[i].#3D.
0;#0A#09return.!.DeleteFile(szName);#0A}#0A#0Aint.r
ename(char.*from,.char.*to).{#0A#09TCHAR.szFrom[100
];#0A#09TCHAR.szTo[100];#0A#09int.i;#0A#09for.(i#3D
0;.*from;.i++).szFrom[i].#3D.*from++;#0A#09szFrom[i
].#3D.0;#0A#09for.(i#3D0;.*to;.i++).szTo[i].#3D.*to
++;#0A#09szTo[i].#3D.0;#0A#09return.!.MoveFile(szFr
om,.szTo);#0A}#0A#0Aint.fgetc(FILEPT.fp).{#0A#09BYT
E.ch;#0A#09DWORD.n#3D0;#0A#09ReadFile(fp,.&ch,.1,.&
n,.NULL);#0A#0A#09return.n#3D#3D0000.?.EOF.:.ch;#0A
}#0A#0Aint.eqstr(char.*s1,.char.*s2).{#0A..while(*s
1.&&.*s2).if(*s1++.!#3D.*s2++).return.0;#0A..return
.*s1#3D#3D*s2;#0A}#0A#0Achar.*getenv(char.*name).{#0A
.if(eqstr(name,."BCPLPATH")).return."\\BCPL\\cintco
de\\cin";#0A.if(eqstr(name,."BCPLROOT")).return."\\
BCPL\\cintcode";#0A.if(eqstr(name,."BCPLHDRS")).ret
urn."\\BCPL\\cintcode\\g";#0A.return."";#0A}#0A#23e
ndif#0A#0A

######sysc/mkint-h.c#
/*#0AThis.is.a.program.that.writes.a.file.(INT#2Eh)
.that#0Acontains.C.#23define.statements.that.define
.BCPLINT32.and.BCPLINT64#0Afor.the.architecture.tha
t.this.program.is.running.on#2E.#0A*/#0A#0A#23inclu
de.<stdio#2Eh>#0A#0Aint.main().{#0A..printf("/*.Thi
s.file.was.generated.by.mkint-h.*/\n\n");#0A#0A..//
.define.BCPLINT32#0A..if.(sizeof(int)#3D#3D0004).{#0A
..2printf("#23define.BCPLINT32.int\n");#0A..2printf
("#23define.BCPLUINT32.unsigned.int\n");#0A..2print
f("#23define.FormD32.\"d\"\n");#0A..2printf("#23def
ine.FormX32.\"X\"\n");#0A..2}.else.if.(sizeof(long)
#3D#3D0004).{#0A..2printf("#23define.BCPLINT32.long
\n");#0A..2printf("#23define.BCPLUINT32.unsigned.lo
ng\n");#0A..2printf("#23define.FormD32.\"ld\"\n");#0A
..2printf("#23define.FormX32.\"lX\"\n");#0A..}#0A#0A
..//.define.BCPLINT64#0A..if.(sizeof(int)#3D#3D0008
){#0A..2printf("#23define.BCPLINT64.int\n");#0A..2p
rintf("#23define.BCPLUINT64.unsigned.int\n");#0A..2
printf("#23define.FormD64.\"d\"\n");#0A..2printf("#23
define.FormX64.\"X\"\n");#0A..}.else.if.(sizeof(lon
g)#3D#3D0008).{#0A..2printf("#23define.BCPLINT64.lo
ng\n");#0A..2printf("#23define.BCPLUINT64.unsigned.
long\n");#0A..2printf("#23define.FormD64.\"ld\"\n")
;#0A..2printf("#23define.FormX64.\"lX\"\n");#0A..}.
else.if.(sizeof(long.long)#3D#3D0008).{#0A..2printf
("#23define.BCPLINT64.long.long\n");#0A..2printf("#23
define.BCPLUINT64.unsigned.long.long\n");#0A..2prin
tf("#23define.FormD64.\"lld\"\n");#0A..2printf("#23
define.FormX64.\"llX\"\n");#0A..}#0A..return.0;#0A}
#0A

######sysc/mkcintsys.com#
$.cxx./DEFINE#3D"forVmsItanium".cintsys#2Ec#0A$.cxx
./DEFINE#3D"forVmsItanium"./NOOPTIMIZE.cinterp#2Ec#0A
$.cxx./DEFINE#3D"forVmsItanium"./DEFINE#3D"FASTyes"
./object#3Dfasterp.cinterp#2Ec#0A$.cxx./DEFINE#3D"f
orVmsItanium".kblib#2Ec#0A$.cxx./DEFINE#3D"forVmsIt
anium".nrastlib#2Ec#0A$.cxx./DEFINE#3D"forVmsItaniu
m".sdlfn#2Ec#0A$.cxx./DEFINE#3D"forVmsItanium".sdld
rawlib#2Ec#0A$.link.cintsys,.cinterp,.fasterp,.kbli
b,.nrastlib,.sdlfn,.sdldrawlib#0A

######sysc/nrastlib.c#
/*.cinterp#2Eh.contains.machine/system.dependent.#23
defines..*/#0A#0A#23include."cintsys#2Eh"#0A#0ABCPL
WORD.setraster(BCPLWORD.n,.BCPLWORD.val)#0A{.#0A..r
eturn.-1;..1/*.To.indicate.rastering.not.available.
*/#0A}#0A#0Avoid.rasterpoint(BCPLWORD.p)#0A{.#0A..r
eturn;#0A}#0A#0A1

######sysc/rasterp.c#
/*#0A**.This.is.a.version.of.the.CINTCODE.interpret
er.that.can.genearate#0A**.memory.reference.data.th
at.allows.memory.address/time.graphs#0A**.to.be.con
structed#2E.It.should.be.linked.as.a.replacement.fo
r.cintasm#2E#0A**.When.linked.with.rastlib.it.is.ca
pable.of.generating.Postscript.pictures#0A**.of.the
.execution.history.of.a.program#2E#0A**#0A**.(c).Co
pyright:..Martin.Richards..00026.October.1990005#0A
*/#0A#0A1#23include.<stdio#2Eh>#0A#0A/*.cintsys#2Eh
.contains.machine/system.dependent.#23defines..*/#0A
#23include."cintsys#2Eh"#0A#0Aextern.BCPLWORD.resul
t2;#0A#0Aextern.BCPLWORD.tallylim;#0A#0Aextern.BCPL
WORD.dosys(BCPLWORD.p,.BCPLWORD.g);#0Aextern.BCPLWO
RD.muldiv(BCPLWORD.a,.BCPLWORD.b,.BCPLWORD.c);#0A#0A
1/*.functions.in.rastlib#2Ec..*/#0Aextern.BCPLWORD.
fcount;#0Aextern.BCPLWORD.setraster(BCPLWORD,.BCPLW
ORD);./*.not.called.from.this.module.*/#0Aextern.vo
id.rasterpoint(BCPLWORD);#0A#0A#23define.Gn_currco.
.0047#0A#23define.Gn_result2..00210#0A#0A/*.CINTCOD
E.function.codes..*/#0A#0A#23define.F_0..0050#0A#0A
#23define.F_brk..0032#0A#23define.F_k0..0040#0A#23d
efine.F_lf..00312#0A#23define.F_lm..00314#0A#23defi
ne.F_lm1..00215#0A#23define.F_l0..00316#0A#23define
.F_fhop..00127#0A#23define.F_jeq..00228#0A#0A#23def
ine.F_k..00432#0A#23define.F_kh..00333#0A#23define.
F_kw..00334#0A#23define.F_k0g..00232#0A#23define.F_
k0g1..1(F_k0g+32)#0A#23define.F_k0gh..1(F_k0g+64)#0A
#23define.F_s0g..00244#0A#23define.F_s0g1..1(F_s0g+
32)#0A#23define.F_s0gh..1(F_s0g+64)#0A#23define.F_l
0g..00245#0A#23define.F_l0g1..1(F_l0g+32)#0A#23defi
ne.F_l0gh..1(F_l0g+64)#0A#23define.F_l1g..00246#0A#23
define.F_l1g1..1(F_l1g+32)#0A#23define.F_l1gh..1(F_
l1g+64)#0A#23define.F_l2g..00247#0A#23define.F_l2g1
..1(F_l2g+32)#0A#23define.F_l2gh..1(F_l2g+64)#0A#23
define.F_lg..00348#0A#23define.F_lg1..2(F_lg+32)#0A
#23define.F_lgh..2(F_lg+64)#0A#23define.F_sg..00349
#0A#23define.F_sg1..2(F_sg+32)#0A#23define.F_sgh..2
(F_sg+64)#0A#23define.F_llg..00250#0A#23define.F_ll
g1..1(F_llg+32)#0A#23define.F_llgh..1(F_llg+64)#0A#23
define.F_ag..00351#0A#23define.F_ag1..2(F_ag+32)#0A
#23define.F_agh..2(F_ag+64)#0A#23define.F_mul..0025
2#0A#23define.F_div..00253#0A#23define.F_rem..00254
#0A#23define.F_xor..00255#0A#23define.F_sl..00356#0A
#23define.F_ll..00358#0A#23define.F_jne..00260#0A#0A
#23define.F_llp..00264#0A#23define.F_llph..00165#0A
#23define.F_llpw..00166#0A#23define.F_add..00284#0A
#23define.F_sub..00285#0A#23define.F_lsh..00286#0A#23
define.F_rsh..00287#0A#23define.F_and..00288#0A#23d
efine.F_or..00389#0A#23define.F_ll1..00290#0A#23def
ine.F_jls..00292#0A#0A#23define.F_l..00496#0A#23def
ine.F_lh..00397#0A#23define.F_lw..00398#0A#23define
.F_rv..002110006#0A#23define.F_rtn..001123#0A#23def
ine.F_jgr..001124#0A#0A#23define.F_lp..002128#0A#23
define.F_lph..001129#0A#23define.F_lpw..001130#0A#23
define.F_lp0..001128#0A#23define.F_sys..001145#0A#23
define.F_swb..001146#0A#23define.F_swl..001147#0A#23
define.F_st..002148#0A#23define.F_st0..001148#0A#23
define.F_stp0..000149#0A#23define.F_goto..000155#0A
#23define.F_jle..001156#0A#0A#23define.F_sp..002160
#0A#23define.F_sph..001161#0A#23define.F_spw..00116
2#0A#23define.F_sp0..001160#0A#23define.F_s0..00217
6#0A#23define.F_xch..001181#0A#23define.F_gbyt..000
182#0A#23define.F_pbyt..000183#0A#23define.F_atc..0
01184#0A#23define.F_atb..001185#0A#23define.F_j..00
3186#0A#23define.F_jge..001188#0A#0A#23define.F_ap.
.002192#0A#23define.F_aph..001193#0A#23define.F_apw
..001194#0A#23define.F_ap0..001192#0A#0A#23define.F
_xpbyt.205#0A#23define.F_lmh..001206#0A#23define.F_
btc..001207#0A#23define.F_nop..001208#0A#23define.F
_a0..002208#0A#23define.F_rvp0..000211#0A#23define.
F_st0p0.216#0A#23define.F_st1p0.218#0A#0A#23define.
F_mw..002220003#0A#0A#23define.F_a..003220004#0A#23
define.F_ah..002220005#0A#23define.F_aw..002220006#0A
#23define.F_l0p0..000220004#0A#23define.F_s..003237
#0A#23define.F_sh..002238#0A#0A#23define.F_mdiv..00
0239#0A#23define.F_chgco.240#0A#23define.F_neg..001
241#0A#23define.F_not..001242#0A#23define.F_l1p0..0
00240#0A#23define.F_l2p0..000244#0A#23define.F_l3p0
..000247.#0A#23define.F_l4p0..000249#0A#0A#23define
.F_selld.254#0A#23define.F_selst.255#0A#23define.F_
255..001255#0A#0A1/*.The.function.cintasm.is.design
ed.to.be.separately.compiled,#0A**.and.possibly.imp
lemented.in.assembly.language.for.speed#2E#0A**#0A*
*.mem..is.the.pointer.to.the.cintcode.memory#2E#0A*
*.regs.is.the.position.in.the.Cintcode.memory.where
.the.initial#0A**..4value.of.the.Cintcode.registers
#2E#0A**#0A**.interpret.(or.cintasm).executes.Cintc
ode.instructions.and.returns.with#0A**.an.integer.r
esult.as.follows:#0A**..0030..4sys(0,.0).called#0A*
*..0031..4Non.existant.instruction#0A**..0032..4Brk
.instruction#0A**..0033..4Zero.count#0A**..0034..4N
egative.pc#0A**..0035..4Division.by.zero#0A**..3n..
4sys(0,.n).called#0A**#0A**.On.return.the.Cintcode.
registers.are.dumped.back.in.the.vector.regs#0A*/#0A
#0A1void.Rb(BCPLWORD.a)#0A{#0A..if.(tallylim).raste
rpoint(a);#0A}#0A#0Avoid.Rh(BCPLWORD.a)#0A{#0A..if.
(tallylim).rasterpoint(a<<0001);#0A}#0A#0Avoid.Rw(B
CPLWORD.a)#0A{#0A..if.(tallylim).rasterpoint(a<<B2W
sh);#0A}#0A#0A1int.cintasm(BCPLWORD.regs,.BCPLWORDp
t.mem)#0A{.register.BCPLWORDpt.W.#3D.mem;#0A#0A#23d
efine.B.(BP.W)#0A#23define.SB.(SBP.W)#0A#23define.H
.(HP.W)#0A#23define.SH.(SHP.W)#0A#0A#23ifdef.BIGEND
ER#0A#23define.GH(x).((WD.B[x+0]<<0008).|.B[x+1])#0A
#23define.GW(x).((4WD.B[x]<<0008)|B[x+1])<<0008)|B[
x+2])<<0008)|B[x+3])#0A#23else#0A#23define.GH(x).((
WD.B[x+1]<<0008).|.B[x])#0A#23define.GW(x).((4WD.B[
x+3]<<0008)|B[x+2])<<0008)|B[x+1])<<0008)|B[x])#0A#23
endif#0A#0A..1register.BCPLWORD..9a..#3D.W[regs+0];
#0A..1register.BCPLWORD..9b..#3D.W[regs+1];#0A..1BC
PLWORD..18c..#3D.W[regs+2];#0A..1BCPLWORD..18p..#3D
.W[regs+3]>>B2Wsh;#0A..1BCPLWORD..18g..#3D.W[regs+4
]>>B2Wsh;#0A..1BCPLWORD..18st.#3D.W[regs+5];#0A..1r
egister.BCPLWORD..9pc.#3D.W[regs+6];#0A..1BCPLWORD.
.18count.#3D.W[regs+7];#0A..1BCPLWORD..18mw.#3D.W[r
egs+8];#0A#0A..1register.BCPLWORDpt.Wp..#3D.W+p,..2
/*.Optimise.access.to.the.stack.*/#0A..21Wg..#3D.W+
g,..2/*.Optimise.access.to.the.global.vector.*/#0A.
.21Wg1.#3D.W+g+256;#0A#0A..1BCPLWORD.res,.k,.i;#0A#0A
..1Rw(regs+0);.#0A..1Rw(regs+1);.#0A..1Rw(regs+2);.
#0A..1Rw(regs+3);.#0A..1Rw(regs+4);.#0A..1Rw(regs+5
);.#0A..1Rw(regs+6);.#0A..1Rw(regs+7);.#0A..1Rw(reg
s+8);.#0A#0A..1if.(pc<0).goto.negpc;#0A#0Afetch:#0A
..1if.(tallylim).fcount++;#0A..1Rb(pc);#0A..1switch
((int).B[pc++])#0A#0A{..default:..4/*.Cases.F_0.and
.F_255.have.been.added.explicitly.to..1*/#0A..1case
.F_0:..3/*.improve.the.compiled.code.(with.luck)..1
3*/#0A..1case.F_255:..1res.#3D.1;.pc--;.goto.ret;./
*.Unimplemented.instruction..*/#0A#0A..1case.F_mul:
..1a.#3D.b.*.a;..6goto.fetch;#0A..1case.F_div:..1if
(a#3D#3D0000).{res.#3D.5;.pc--;.goto.ret;.}./*.Divi
sion.by.zero.*/#0A..15a.#3D.b./.a;..6goto.fetch;#0A
..1case.F_rem:..1if(a#3D#3D0000).{res.#3D.5;.pc--;.
goto.ret;.}./*.Division.by.zero.*/#0A..15a.#3D.b.%.
a;..6goto.fetch;#0A..1case.F_add:..1a.#3D.b.+.a;..6
goto.fetch;#0A..1case.F_sub:..1a.#3D.b.-.a;..6goto.
fetch;#0A..1case.F_neg:..1a.#3D.-.a;..8goto.fetch;#0A
#0A..1case.F_fhop:..a.#3D.0;.pc++;..4goto.fetch;#0A
#0A..1case.F_lsh:..1if.(a>31).b#3D0;./*.bug.*/#0A..
15a.#3D.b.<<.a;..5goto.fetch;#0A..1case.F_rsh:..1if
.(a>31).b#3D0;./*.bug.*/#0A..15a.#3D.WD((UWD.b)>>a)
;.goto.fetch;#0A..1case.F_not:..1a.#3D.~.a;..8goto.
fetch;#0A..1case.F_and:..1a.#3D.b.&.a;..6goto.fetch
;#0A..1case.F_or:..2a.#3D.b.|.a;..6goto.fetch;#0A..
1case.F_xor:..1a.#3D.b.^.a;..6goto.fetch;#0A#0A..1c
ase.F_goto:..pc.#3D.a;..9goto.fetch;#0A#0A..1case.F
_brk:..1res.#3D.2;.pc--;.goto.ret;../*.BREAKPOINT..
*/#0A..15#0A..1case.F_rv+6:..Rw(a+6);.a.#3D.W[a+6];
.goto.fetch;#0A..1case.F_rv+5:..Rw(a+5);.a.#3D.W[a+
5];.goto.fetch;#0A..1case.F_rv+4:..Rw(a+4);.a.#3D.W
[a+4];.goto.fetch;#0A..1case.F_rv+3:..Rw(a+3);.a.#3D
.W[a+3];.goto.fetch;#0A..1case.F_rv+2:..Rw(a+2);.a.
#3D.W[a+2];.goto.fetch;#0A..1case.F_rv+1:..Rw(a+1);
.a.#3D.W[a+1];.goto.fetch;#0A..1case.F_rv:..2Rw(a+0
);.a.#3D.W[a+0];.goto.fetch;#0A#0A..1case.F_st+3:..
Rw(a+3);.W[a+3].#3D.b;.goto.fetch;#0A..1case.F_st+2
:..Rw(a+2);.W[a+2].#3D.b;.goto.fetch;#0A..1case.F_s
t+1:..Rw(a+1);.W[a+1].#3D.b;.goto.fetch;#0A..1case.
F_st:..2Rw(a+0);.W[a+0].#3D.b;.goto.fetch;#0A#0A..1
case.F_chgco:.Rw(p+0);.Rw(g+Gn_currco);.Rw(Wg[Gn_cu
rrco]);.#0A..15W[Wg[Gn_currco]].#3D.Wp[0];..3/*.!cu
rrco.:#3D.!p..2*/#0A..15Rw(p+1);.#0A..15pc.#3D.Wp[1
];..17/*.pc..4:#3D.p!1..1*/#0A..15Rw(p+4);.Rw(g+Gn_
currco);.#0A..15Wg[Gn_currco].#3D.Wp[4];..6/*.currc
o..:#3D.cptr..*/#0A..15Rw(p+4);.Rw(Wp[4]);.#0A..15p
.#3D.W[Wp[4]]>>B2Wsh;..12/*.p..5:#3D.!cptr.*/#0A..1
5Wp.#3D.W+p;#0A..15goto.fetch;#0A#0A..1case.F_mdiv:
..Rw(p+3);.Rw(p+4);.Rw(p+5);.#0A..15a.#3D.muldiv(Wp
[3],.Wp[4],.Wp[5]);#0A..15Rw(g+Gn_result2);.#0A..15
Wg[Gn_result2].#3D.result2;#0A..15/*.fall.through.t
o.return..*/#0A..1case.F_rtn:..1Rw(p+1);.#0A..15pc.
#3D.Wp[1];#0A..15Rw(p+0);.#0A..15p..#3D.Wp[0]>>B2Ws
h;..Wp.#3D.W+p;.goto.fetch;#0A#0A..1case.F_gbyt:.Rb
(a+(b<<B2Wsh));#0A..14a.#3D.B[a+(b<<B2Wsh)];..10got
o.fetch;#0A..1case.F_pbyt:.Rb(a+(b<<B2Wsh));#0A..14
B[a+(b<<B2Wsh)].#3D.c;..10goto.fetch;#0A..1case.F_x
pbyt:Rb(b+(a<<B2Wsh));#0A..14B[b+(a<<B2Wsh)].#3D.c;
..10goto.fetch;#0A..1case.F_atc:..c.#3D.a;..20goto.
fetch;#0A..1case.F_btc:..c.#3D.b;..20goto.fetch;#0A
..1case.F_atb:..b.#3D.a;..20goto.fetch;#0A..1case.F
_xch:..a.#3D.a^b;.b.#3D.a^b;.a.#3D.a^b;..goto.fetch
;#0A#0A..1case.F_swb:.{.BCPLWORD.n,.k,.val,.i#3D1;#0A
..15k.#3D.(pc+1)>>0001;#0A..15Rh(k);#0A..15n.#3D.H[
k];#0A..15while(i<#3Dn)#0A..15{.i.+#3D.i;#0A..17val
.#3D.H[k+i];#0A..17if.(a#3D#3Dval).{.k.+#3D.i;.brea
k;.}#0A..17if.(a<val).i++;#0A..15}#0A..15k++;#0A..1
5Rh(k);#0A..15pc.#3D.(k<<0001).+.SH[k];#0A..15goto.
fetch;#0A..13}#0A#0A..1case.F_swl:.{.BCPLWORD.n,q;#0A
..15q.#3D.(pc+1)>>0001;#0A..15Rh(q);#0A..15n.#3D.H[
q++];#0A..15if(0<#3Da.&&.a<n).q.#3D.q.+.a.+.1;#0A..
15Rh(q);#0A..15pc.#3D.(q<<0001).+.SH[q];#0A..15goto
.fetch;#0A..13}#0A#0A..1case.F_sys:.switch(a).{#0A.
.#09#09default:./*.system.call.--.general.case.*/#0A
.#0A..#09#09..7W[regs+0]..#3D.a;..2/*.Save.the.regi
sters.*/#0A#09#09..7W[regs+1]..#3D.b;..2/*.for.debu
gging.purposes.*/#0A..23W[regs+2]..#3D.c;#0A..23W[r
egs+3]..#3D.p<<B2Wsh;#0A..23W[regs+4]..#3D.g<<B2Wsh
;#0A..23W[regs+5]..#3D.st;#0A..23W[regs+6]..#3D.pc;
#0A..23W[regs+7]..#3D.count;#0A..23W[regs+8]..#3D.m
w;#0A..#0A..23a.#3D.dosys(p,.g);.#0A..23goto.fetch;
#0A#0A..15case.Sys_setcount:#0A..23/*.oldcount.:#3D
.sys(Sys_setcount,.newcount)..*/#0A..23a.#3D.count;
.#0A#09#09..7Rw(p+4);.count.#3D.Wp[4];#0A..23res.#3D
.-1;./*.Leave.and.immediately.re-enter.*/#0A..23got
o.ret;./*.the.interpreter.*/#0A#0A..15case.Sys_quit
:#0A..23Rw(p+4);.res.#3D.Wp[4];#0A..23goto.ret;#0A#0A
#09#09./*#0A#09#09.case.Sys_rti:.//..sys(Sys_rti,.r
egs)#0A..15case.Sys_saveregs:.//.sys(Sys_saveregs,.
regs)#0A..15case.Sys_setst:.//.sys(Sys_setst,.st)#0A
#09#09.*/#0A..15/*.case.Sys_watch:.*/./*.sys(Sys_wa
tch,.addr).*/#0A..13}#0A#0A..1case.F_lp0+16:..b.#3D
.a;.Rw(p+16);.a.#3D.Wp[16];.goto.fetch;#0A..1case.F
_lp0+15:..b.#3D.a;.Rw(p+15);.a.#3D.Wp[15];.goto.fet
ch;#0A..1case.F_lp0+14:..b.#3D.a;.Rw(p+14);.a.#3D.W
p[14];.goto.fetch;#0A..1case.F_lp0+13:..b.#3D.a;.Rw
(p+13);.a.#3D.Wp[13];.goto.fetch;#0A..1case.F_lp0+1
2:..b.#3D.a;.Rw(p+12);.a.#3D.Wp[12];.goto.fetch;#0A
..1case.F_lp0+11:..b.#3D.a;.Rw(p+11);.a.#3D.Wp[11];
.goto.fetch;#0A..1case.F_lp0+10:..b.#3D.a;.Rw(p+10)
;.a.#3D.Wp[10];.goto.fetch;#0A..1case.F_lp0+9:..1b.
#3D.a;.Rw(p+9);..a.#3D.Wp[9];..goto.fetch;#0A..1cas
e.F_lp0+8:..1b.#3D.a;.Rw(p+8);..a.#3D.Wp[8];..goto.
fetch;#0A..1case.F_lp0+7:..1b.#3D.a;.Rw(p+7);..a.#3D
.Wp[7];..goto.fetch;#0A..1case.F_lp0+6:..1b.#3D.a;.
Rw(p+6);..a.#3D.Wp[6];..goto.fetch;#0A..1case.F_lp0
+5:..1b.#3D.a;.Rw(p+5);..a.#3D.Wp[5];..goto.fetch;#0A
..1case.F_lp0+4:..1b.#3D.a;.Rw(p+4);..a.#3D.Wp[4];.
.goto.fetch;#0A..1case.F_lp0+3:..1b.#3D.a;.Rw(p+3);
..a.#3D.Wp[3];..goto.fetch;#0A#0A..1case.F_lp:..1Rb
(pc);.Rw(p+B[pc]);#0A..14b.#3D.a;.a.#3D.Wp[B[pc++]]
;..8goto.fetch;#0A..1case.F_lph:..Rb(pc);.Rw(p+GH(p
c));#0A..14b.#3D.a;.a.#3D.Wp[GH(pc)];..pc.+#3D.2;.g
oto.fetch;#0A..1case.F_lpw:..Rb(pc);.Rw(p+GW(pc));#0A
..14b.#3D.a;.a.#3D.Wp[GW(pc)];..pc.+#3D.4;.goto.fet
ch;#0A#0A..1case.F_llp:..b.#3D.a;..Rb(pc);.a.#3D.p+
B[pc++];..11goto.fetch;#0A..1case.F_llph:.b.#3D.a;.
.Rb(pc);.a.#3D.p+GH(pc);..3pc.+#3D.2;.goto.fetch;#0A
..1case.F_llpw:.b.#3D.a;..Rb(pc);.a.#3D.p+GW(pc);..
3pc.+#3D.4;.goto.fetch;#0A#0A..1case.F_sp0+16:.Rw(p
+16);.Wp[16].#3D.a;.goto.fetch;#0A..1case.F_sp0+15:
.Rw(p+15);.Wp[15].#3D.a;.goto.fetch;#0A..1case.F_sp
0+14:.Rw(p+14);.Wp[14].#3D.a;.goto.fetch;#0A..1case
.F_sp0+13:.Rw(p+13);.Wp[13].#3D.a;.goto.fetch;#0A..
1case.F_sp0+12:.Rw(p+12);.Wp[12].#3D.a;.goto.fetch;
#0A..1case.F_sp0+11:.Rw(p+11);.Wp[11].#3D.a;.goto.f
etch;#0A..1case.F_sp0+10:.Rw(p+10);.Wp[10].#3D.a;.g
oto.fetch;#0A..1case.F_sp0+9:..Rw(p+9);..Wp[9]..#3D
.a;.goto.fetch;#0A..1case.F_sp0+8:..Rw(p+8);..Wp[8]
..#3D.a;.goto.fetch;#0A..1case.F_sp0+7:..Rw(p+7);..
Wp[7]..#3D.a;.goto.fetch;#0A..1case.F_sp0+6:..Rw(p+
6);..Wp[6]..#3D.a;.goto.fetch;#0A..1case.F_sp0+5:..
Rw(p+5);..Wp[5]..#3D.a;.goto.fetch;#0A..1case.F_sp0
+4:..Rw(p+4);..Wp[4]..#3D.a;.goto.fetch;#0A..1case.
F_sp0+3:..Rw(p+3);..Wp[3]..#3D.a;.goto.fetch;#0A#0A
..1case.F_sp:..2Rb(pc);.Rw(p+B[pc]);#0A..15Wp[B[pc+
+]].#3D.a;..16goto.fetch;#0A..1case.F_sph:..1Rb(pc)
;.Rw(p+GH(pc));#0A..15Wp[GH(pc)]..#3D.a;..7pc.+#3D.
2;.goto.fetch;#0A..1case.F_spw:..1Rb(pc);.Rw(p+GW(p
c));#0A..15Wp[GW(pc)]..#3D.a;..7pc.+#3D.4;.goto.fet
ch;#0A#0A..1case.F_lgh:..1Rb(pc);.Rw(g+GH(pc));#0A.
.15b.#3D.a;.a.#3D.Wg[GH(pc)];..1pc.+#3D.2;.goto.fet
ch;#0A..1case.F_lg1:..1Rb(pc);.Rw(g+256+B[pc]);#0A.
.15b.#3D.a;.a.#3D.Wg1[B[pc++]];..8goto.fetch;#0A..1
case.F_lg:..2Rb(pc);.Rw(g+B[pc]);#0A..15b.#3D.a;.a.
#3D.Wg[B[pc++]];..9goto.fetch;#0A#0A..1case.F_sgh:.
.1Rb(pc);.Rw(g+GH(pc));#0A..15Wg[GH(pc)]..1#3D.a;..
6pc.+#3D.2;.goto.fetch;#0A..1case.F_sg1:..1Rb(pc);.
Rw(g+256+B[pc]);#0A..15Wg1[B[pc++]].#3D.a;..15goto.
fetch;#0A..1case.F_sg:..2Rb(pc);.Rw(g+B[pc]);#0A..1
5Wg[B[pc++]]..#3D.a;..15goto.fetch;#0A#0A..1case.F_
llgh:.b.#3D.a;.Rb(pc);.a.#3D.g+GH(pc);..4pc.+#3D.2;
.goto.fetch;#0A..1case.F_llg1:.b.#3D.a;.Rb(pc);.a.#3D
.g+256+B[pc++];..8goto.fetch;#0A..1case.F_llg:..b.#3D
.a;.Rb(pc);.a.#3D.g+B[pc++];..12goto.fetch;#0A#0A..
1case.F_ll+1:.Rb(pc);.i.#3D.(pc>>0001).+.B[pc];#0A.
.14Rh(i);..i.#3D.(i<<0001).+.SH[i];#0A..14Rw(i>>B2W
sh);.b.#3D.a;.a.#3D.W[i>>B2Wsh];..8pc++;.goto.fetch
;#0A#0A..1case.F_ll:..1Rb(pc);.Rw((pc+SB[pc])>>B2Ws
h);#0A..14b.#3D.a;.a.#3D.W[(pc+SB[pc])>>B2Wsh];pc++
;.goto.fetch;#0A#0A..1case.F_sl+1:.Rb(pc);.i.#3D.(p
c>>0001).+.B[pc];#0A..14Rh(i);.i.#3D.(i<<0001).+.SH
[i];#0A..14Rw(i>>B2Wsh);.W[i>>B2Wsh].#3D.a;..15pc++
;.goto.fetch;#0A#0A..1case.F_sl:..1Rb(pc);.Rw((pc+S
B[pc])>>B2Wsh);#0A..14W[(pc+SB[pc])>>B2Wsh].#3D.a;.
.5pc++;.goto.fetch;#0A..1#0A..1case.F_ll1+1:Rb(pc);
.i.#3D.(pc>>0001).+.B[pc];#0A..14Rh(i);.i.#3D.(i<<0
001).+.SH[i];#0A..14b.#3D.a;.a.#3D.i>>B2Wsh;..11pc+
+;.goto.fetch;#0A#0A..1case.F_ll1:..Rb(pc);.b.#3D.a
;.a.#3D.(pc+SB[pc])>>B2Wsh;..1pc++;.goto.fetch;#0A.
.1#0A..1case.F_l0+10:.b.#3D.a;.a.#3D.10;.goto.fetch
;#0A..1case.F_l0+9:..b.#3D.a;.a.#3D..0009;.goto.fet
ch;#0A..1case.F_l0+8:..b.#3D.a;.a.#3D..0008;.goto.f
etch;#0A..1case.F_l0+7:..b.#3D.a;.a.#3D..0007;.goto
.fetch;#0A..1case.F_l0+6:..b.#3D.a;.a.#3D..0006;.go
to.fetch;#0A..1case.F_l0+5:..b.#3D.a;.a.#3D..0005;.
goto.fetch;#0A..1case.F_l0+4:..b.#3D.a;.a.#3D..0004
;.goto.fetch;#0A..1case.F_l0+3:..b.#3D.a;.a.#3D..00
03;.goto.fetch;#0A..1case.F_l0+2:..b.#3D.a;.a.#3D..
0002;.goto.fetch;#0A..1case.F_l0+1:..b.#3D.a;.a.#3D
..0001;.goto.fetch;#0A..1case.F_l0:..2b.#3D.a;.a.#3D
..0000;.goto.fetch;#0A..1case.F_l0-1:..b.#3D.a;.a.#3D
.-1;.goto.fetch;.#0A#0A..1case.F_l:..3Rb(pc);.b.#3D
.a;.a.#3D.B[pc++];..13goto.fetch;#0A..1case.F_lh:..
2Rb(pc);.b.#3D.a;.a.#3D.GH(pc);..5pc.+#3D.2;.goto.f
etch;#0A..1case.F_lw:..2Rb(pc);.b.#3D.a;.a.#3D.GW(p
c);..5pc.+#3D.4;.goto.fetch;#0A#0A..1case.F_lm:..2R
b(pc);.b.#3D.a;.a.#3D.-.WD(B[pc++]);..7goto.fetch;#0A
..1case.F_lmh:..1Rb(pc);.b.#3D.a;.a.#3D.-.WD(GH(pc)
);.pc.+#3D.2;.goto.fetch;#0A..14#0A..1case.F_lf+1:.
.b.#3D.a;#0A..15Rb(pc);.a.#3D.(pc>>0001).+.B[pc];#0A
..15Rh(a);.a.#3D.(a<<0001).+.SH[a];..7pc++;.goto.fe
tch;#0A#0A..1case.F_lf:..2Rb(pc);.b.#3D.a;.a.#3D.pc
.+.SB[pc];..3pc++;.goto.fetch;#0A.#0A..1case.F_k0gh
+11:.Rw(p+11);.Wp[11].#3D.p<<B2Wsh;.p.+#3D.11;.goto
.applygh;#0A..1case.F_k0gh+10:.Rw(p+10);.Wp[10].#3D
.p<<B2Wsh;.p.+#3D.10;.goto.applygh;#0A..1case.F_k0g
h+9:..Rw(p+9);..Wp[.9].#3D.p<<B2Wsh;.p.+#3D..0009;.
goto.applygh;#0A..1case.F_k0gh+8:..Rw(p+8);..Wp[.8]
.#3D.p<<B2Wsh;.p.+#3D..0008;.goto.applygh;#0A..1cas
e.F_k0gh+7:..Rw(p+7);..Wp[.7].#3D.p<<B2Wsh;.p.+#3D.
.0007;.goto.applygh;#0A..1case.F_k0gh+6:..Rw(p+6);.
.Wp[.6].#3D.p<<B2Wsh;.p.+#3D..0006;.goto.applygh;#0A
..1case.F_k0gh+5:..Rw(p+5);..Wp[.5].#3D.p<<B2Wsh;.p
.+#3D..0005;.goto.applygh;#0A..1case.F_k0gh+4:..Rw(
p+4);..Wp[.4].#3D.p<<B2Wsh;.p.+#3D..0004;.goto.appl
ygh;#0A..1case.F_k0gh+3:..Rw(p+3);..Wp[.3].#3D.p<<B
2Wsh;.p.+#3D..0003;#0A..1applygh:..6Wp..2#3D.W+p;#0A
..17Rw(p+1);.Wp[1].#3D.pc.+.2;#0A..17Rb(pc);.Rw(g+G
H(pc));.pc..2#3D.Wg[GH(pc)];#0A..17Rw(p+2);.Wp[2].#3D
.pc;#0A..17Rw(p+3);.Wp[3].#3D..a;#0A..17if.(pc>#3D0
).goto.fetch;#0A..17goto.negpc;#0A#0A..1case.F_k0g1
+11:.Rw(p+11);.Wp[11].#3D.p<<B2Wsh;.p.+#3D.11;.goto
.applyg1;#0A..1case.F_k0g1+10:.Rw(p+10);.Wp[10].#3D
.p<<B2Wsh;.p.+#3D.10;.goto.applyg1;#0A..1case.F_k0g
1+9:..Rw(p+9);..Wp[.9].#3D.p<<B2Wsh;.p.+#3D..0009;.
goto.applyg1;#0A..1case.F_k0g1+8:..Rw(p+8);..Wp[.8]
.#3D.p<<B2Wsh;.p.+#3D..0008;.goto.applyg1;#0A..1cas
e.F_k0g1+7:..Rw(p+7);..Wp[.7].#3D.p<<B2Wsh;.p.+#3D.
.0007;.goto.applyg1;#0A..1case.F_k0g1+6:..Rw(p+6);.
.Wp[.6].#3D.p<<B2Wsh;.p.+#3D..0006;.goto.applyg1;#0A
..1case.F_k0g1+5:..Rw(p+5);..Wp[.5].#3D.p<<B2Wsh;.p
.+#3D..0005;.goto.applyg1;#0A..1case.F_k0g1+4:..Rw(
p+4);..Wp[.4].#3D.p<<B2Wsh;.p.+#3D..0004;.goto.appl
yg1;#0A..1case.F_k0g1+3:..Rw(p+3);..Wp[.3].#3D.p<<B
2Wsh;.p.+#3D..0003;#0A..1applyg1:..6Wp..2#3D.W+p;#0A
..17Rw(p+1);.Wp[1].#3D.pc.+.1;#0A..17Rb(pc);.Rw(g+2
56+B[pc]);.pc..2#3D.Wg1[B[pc]];#0A..17Rw(p+2);.Wp[2
].#3D.pc;#0A..17Rw(p+3);.Wp[3].#3D.a;#0A..17if.(pc>
#3D0).goto.fetch;#0A..17goto.negpc;#0A.#0A..1case.F
_k0g+11:.Rw(p+11);.Wp[11].#3D.p<<B2Wsh;.p.+#3D.11;.
goto.applyg;#0A..1case.F_k0g+10:.Rw(p+10);.Wp[10].#3D
.p<<B2Wsh;.p.+#3D.10;.goto.applyg;#0A..1case.F_k0g+
9:..Rw(p+9);..Wp[.9].#3D.p<<B2Wsh;.p.+#3D..0009;.go
to.applyg;#0A..1case.F_k0g+8:..Rw(p+8);..Wp[.8].#3D
.p<<B2Wsh;.p.+#3D..0008;.goto.applyg;#0A..1case.F_k
0g+7:..Rw(p+7);..Wp[.7].#3D.p<<B2Wsh;.p.+#3D..0007;
.goto.applyg;#0A..1case.F_k0g+6:..Rw(p+6);..Wp[.6].
#3D.p<<B2Wsh;.p.+#3D..0006;.goto.applyg;#0A..1case.
F_k0g+5:..Rw(p+5);..Wp[.5].#3D.p<<B2Wsh;.p.+#3D..00
05;.goto.applyg;#0A..1case.F_k0g+4:..Rw(p+4);..Wp[.
4].#3D.p<<B2Wsh;.p.+#3D..0004;.goto.applyg;#0A..1ca
se.F_k0g+3:..Rw(p+3);..Wp[.3].#3D.p<<B2Wsh;.p.+#3D.
.0003;#0A..1applyg:..6Wp..2#3D.W+p;#0A..16Rw(p+1);.
Wp[1].#3D.pc.+.1;#0A..16Rb(pc);.Rw(g+B[pc]);.pc..2#3D
.Wg[B[pc]];#0A..16Rw(p+2);.Wp[2].#3D.pc;#0A..16Rw(p
+3);.Wp[3].#3D.a;#0A..16if.(pc>#3D0).goto.fetch;#0A
..16goto.negpc;#0A.#0A..1case.F_k0+11:..Rw(p+11);.W
p[11].#3D.p<<B2Wsh;.p.+#3D.11;.goto.applyk;#0A..1ca
se.F_k0+10:..Rw(p+10);.Wp[10].#3D.p<<B2Wsh;.p.+#3D.
10;.goto.applyk;#0A..1case.F_k0+9:..1Rw(p+9);..Wp[.
9].#3D.p<<B2Wsh;.p.+#3D..0009;.goto.applyk;#0A..1ca
se.F_k0+8:..1Rw(p+8);..Wp[.8].#3D.p<<B2Wsh;.p.+#3D.
.0008;.goto.applyk;#0A..1case.F_k0+7:..1Rw(p+7);..W
p[.7].#3D.p<<B2Wsh;.p.+#3D..0007;.goto.applyk;#0A..
1case.F_k0+6:..1Rw(p+6);..Wp[.6].#3D.p<<B2Wsh;.p.+#3D
..0006;.goto.applyk;#0A..1case.F_k0+5:..1Rw(p+5);..
Wp[.5].#3D.p<<B2Wsh;.p.+#3D..0005;.goto.applyk;#0A.
.1case.F_k0+4:..1Rw(p+4);..Wp[.4].#3D.p<<B2Wsh;.p.+
#3D..0004;.goto.applyk;#0A..1case.F_k0+3:..1Rw(p+3)
;..Wp[.3].#3D.p<<B2Wsh;.p.+#3D..0003;#0A..1applyk:.
.6Wp..2#3D.W+p;#0A..16Rw(p+1);.Wp[1].#3D.WD.pc;#0A.
.16pc..2#3D.a;#0A..16Rw(p+2);.Wp[2].#3D.pc;#0A..16R
w(p+3);.Wp[3].#3D.a.#3D.b;#0A..16if.(pc>#3D0).goto.
fetch;#0A..16goto.negpc;#0A#0A..1case.F_k:..4Rb(pc)
;.k.#3D.B[pc];.Rw(p+k);.Wp[k].#3D.p<<B2Wsh;.p.+#3D.
.k;#0A..16Wp..2#3D.W+p;#0A..16Rw(p+1);.Wp[1].#3D.pc
.+.1;#0A..16pc..2#3D.a;#0A..16Rw(p+2);.Wp[2].#3D.pc
;#0A..16Rw(p+3);.Wp[3].#3D.a.#3D.b;#0A..16if.(pc>#3D
0).goto.fetch;#0A..16goto.negpc;#0A#0A..1case.F_kh:
..3Rb(pc);.k.#3D.GH(pc);.Rw(p+k);.Wp[k].#3D.p<<B2Ws
h;.p.+#3D..k;#0A..16Wp..2#3D.W+p;#0A..16Rw(p+1);.Wp
[1].#3D.pc.+.2;#0A..16pc..2#3D.a;#0A..16Rw(p+2);.Wp
[2].#3D.pc;#0A..16Rw(p+3);.Wp[3].#3D.a.#3D.b;#0A..1
6if.(pc>#3D0).goto.fetch;#0A..16goto.negpc;#0A#0A..
1case.F_kw:..3Rb(pc);.k.#3D.GW(pc);.Rw(p+k);.Wp[k].
#3D.p<<B2Wsh;.p.+#3D..k;#0A..16Wp..2#3D.W+p;#0A..16
Rw(p+1);.Wp[1].#3D.pc.+.4;#0A..16pc..2#3D.a;#0A..16
Rw(p+2);.Wp[2].#3D.pc;#0A..16Rw(p+3);.Wp[3].#3D.a.#3D
.b;#0A..16if.(pc>#3D0).goto.fetch;#0A..16goto.negpc
;#0A#0A..1case.F_jeq:..1if(b#3D#3Da).{.Rb(pc);.pc.+
#3D.SB[pc];..1goto.fetch;.}#0A..15pc++;.goto.fetch;
#0A..1case.F_jeq+1:.if(b#3D#3Da).goto.indjump;#0A..
15pc++;.goto.fetch;#0A..1case.F_jeq+2:.if(a#3D#3D00
00).{.Rb(pc);.pc.+#3D.SB[pc];..1goto.fetch;.}#0A..1
5pc++;.goto.fetch;#0A..1case.F_jeq+3:.if(a#3D#3D000
0).goto.indjump;#0A..15pc++;.goto.fetch;#0A#0A..1ca
se.F_jne:..1if(b!#3Da).{.Rb(pc);.pc.+#3D.SB[pc];..1
goto.fetch;.}#0A..15pc++;.goto.fetch;#0A..1case.F_j
ne+1:.if(b!#3Da).goto.indjump;#0A..15pc++;.goto.fet
ch;#0A..1case.F_jne+2:.if(a!#3D0).{.Rb(pc);.pc.+#3D
.SB[pc];..1goto.fetch;.}#0A..15pc++;.goto.fetch;#0A
..1case.F_jne+3:.if(a!#3D0).goto.indjump;#0A..15pc+
+;.goto.fetch;#0A#0A..1case.F_jls:..1if(b<a).{.Rb(p
c);.pc.+#3D.SB[pc];..1goto.fetch;.}#0A..15pc++;.got
o.fetch;#0A..1case.F_jls+1:.if(b<a).goto.indjump;#0A
..15pc++;.goto.fetch;#0A..1case.F_jls+2:.if(a<0).{.
Rb(pc);.pc.+#3D.SB[pc];..1goto.fetch;.}#0A..15pc++;
.goto.fetch;#0A..1case.F_jls+3:.if(a<0).goto.indjum
p;#0A..15pc++;.goto.fetch;#0A#0A..1case.F_jgr:..1if
(b>a).{.Rb(pc);.pc.+#3D.SB[pc];..1goto.fetch;.}#0A.
.15pc++;.goto.fetch;#0A..1case.F_jgr+1:.if(b>a).got
o.indjump;#0A..15pc++;.goto.fetch;#0A..1case.F_jgr+
2:.if(a>0).{.Rb(pc);.pc.+#3D.SB[pc];..1goto.fetch;.
}#0A..15pc++;.goto.fetch;#0A..1case.F_jgr+3:.if(a>0
).goto.indjump;#0A..15pc++;.goto.fetch;#0A#0A..1cas
e.F_jle:..1if(b<#3Da).{Rb(pc);..pc.+#3D.SB[pc];..1g
oto.fetch;.}#0A..15pc++;.goto.fetch;#0A..1case.F_jl
e+1:.if(b<#3Da).goto.indjump;#0A..15pc++;.goto.fetc
h;#0A..1case.F_jle+2:.if(a<#3D0).{.Rb(pc);.pc.+#3D.
SB[pc];..1goto.fetch;.}#0A..15pc++;.goto.fetch;#0A.
.1case.F_jle+3:.if(a<#3D0).goto.indjump;#0A..15pc++
;.goto.fetch;#0A#0A..1case.F_jge:..1if(b>#3Da).{.Rb
(pc);.pc.+#3D.SB[pc];..1goto.fetch;.}#0A..15pc++;.g
oto.fetch;#0A..1case.F_jge+1:.if(b>#3Da).goto.indju
mp;#0A..15pc++;.goto.fetch;#0A..1case.F_jge+2:.if(a
>#3D0).{.Rb(pc);.pc.+#3D.SB[pc];..1goto.fetch;.}#0A
..15pc++;.goto.fetch;#0A..1case.F_jge+3:.if(a>#3D0)
.goto.indjump;#0A..15pc++;.goto.fetch;#0A#0A..1case
.F_j:..3Rb(pc);.pc.+#3D.SB[pc];..6goto.fetch;#0A#0A
.indjump:#0A..1case.F_j+1:..1Rb(pc);.pc.#3D.(pc>>00
01).+.B[pc];#0A..15Rh(pc);.pc.#3D.(pc<<0001).+.SH[p
c];#0A..15goto.fetch;#0A#0A..1case.F_ap0+12:.Rw(p+1
2);.a.#3D.a.+.Wp[12];.goto.fetch;#0A..1case.F_ap0+1
1:.Rw(p+11);.a.#3D.a.+.Wp[11];.goto.fetch;#0A..1cas
e.F_ap0+10:.Rw(p+10);.a.#3D.a.+.Wp[10];.goto.fetch;
#0A..1case.F_ap0+9:..Rw(p+9);..a.#3D.a.+.Wp[.9];.go
to.fetch;#0A..1case.F_ap0+8:..Rw(p+8);..a.#3D.a.+.W
p[.8];.goto.fetch;#0A..1case.F_ap0+7:..Rw(p+7);..a.
#3D.a.+.Wp[.7];.goto.fetch;#0A..1case.F_ap0+6:..Rw(
p+6);..a.#3D.a.+.Wp[.6];.goto.fetch;#0A..1case.F_ap
0+5:..Rw(p+5);..a.#3D.a.+.Wp[.5];.goto.fetch;#0A..1
case.F_ap0+4:..Rw(p+4);..a.#3D.a.+.Wp[.4];.goto.fet
ch;#0A..1case.F_ap0+3:..Rw(p+3);..a.#3D.a.+.Wp[.3];
.goto.fetch;#0A#0A..1case.F_ap:..2Rb(pc);.Rw(p+B[pc
]);..3a.+#3D.Wp[B[pc++]];..7goto.fetch;#0A..1case.F
_aph:..1Rb(pc);.Rw(p+GH(pc));..2a.+#3D.Wp[GH(pc)];.
pc.+#3D.2;.goto.fetch;#0A..1case.F_apw:..1Rb(pc);.R
w(p+GW(pc));..2a.+#3D.Wp[GW(pc)];.pc.+#3D.4;.goto.f
etch;#0A..1case.F_agh:..1Rb(pc);.Rw(g+GH(pc));..2a.
+#3D.Wg[GH(pc)];.pc.+#3D.2;.goto.fetch;#0A..1case.F
_ag1:..1Rb(pc);.Rw(g+256+B[pc]);.a.+#3D.Wg1[B[pc++]
];..6goto.fetch;#0A..1case.F_ag:..2Rb(pc);.Rw(g+B[p
c]);..3a.+#3D.Wg[B[pc++]];..7goto.fetch;#0A#0A..1ca
se.F_a0+5:.a.+#3D.5;.goto.fetch;#0A..1case.F_a0+4:.
a.+#3D.4;.goto.fetch;#0A..1case.F_a0+3:.a.+#3D.3;.g
oto.fetch;#0A..1case.F_a0+2:.a.+#3D.2;.goto.fetch;#0A
..1case.F_a0+1:.a.+#3D.1;.goto.fetch;#0A..1case.F_n
op:..8goto.fetch;#0A#0A..1case.F_a:..2Rb(pc);.a.+#3D
.B[pc++];..9goto.fetch;#0A..1case.F_ah:..1Rb(pc);.a
.+#3D.GH(pc);..1pc.+#3D.2;.goto.fetch;#0A..1case.F_
aw:..1Rb(pc);.a.+#3D.GW(pc);..1pc.+#3D.4;.goto.fetc
h;#0A..1case.F_s:..2Rb(pc);.a.-#3D.B[pc++];..9goto.
fetch;#0A..1case.F_sh:..1Rb(pc);.a.-#3D.GH(pc);..1p
c.+#3D.2;.goto.fetch;#0A#0A..1case.F_s0+4:.a.-#3D.4
;.goto.fetch;#0A..1case.F_s0+3:.a.-#3D.3;.goto.fetc
h;#0A..1case.F_s0+2:.a.-#3D.2;.goto.fetch;#0A..1cas
e.F_s0+1:.a.-#3D.1;.goto.fetch;#0A#0A..1case.F_l0p0
+12:.Rw(p+12);.Rw(Wp[12]+0);#0A..17b.#3D.a;.a.#3D.W
[Wp[12]+0];.goto.fetch;#0A..1case.F_l0p0+11:.Rw(p+1
1);.Rw(Wp[11]+0);#0A..17b.#3D.a;.a.#3D.W[Wp[11]+0];
.goto.fetch;#0A..1case.F_l0p0+10:.Rw(p+10);.Rw(Wp[1
0]+0);#0A..17b.#3D.a;.a.#3D.W[Wp[10]+0];.goto.fetch
;#0A..1case.F_l0p0+9:..Rw(p+9);..1Rw(Wp[9]+0);#0A..
17b.#3D.a;.a.#3D.W[Wp[.9]+0];.goto.fetch;#0A..1case
.F_l0p0+8:..Rw(p+8);..1Rw(Wp[8]+0);#0A..17b.#3D.a;.
a.#3D.W[Wp[.8]+0];.goto.fetch;#0A..1case.F_l0p0+7:.
.Rw(p+7);..1Rw(Wp[7]+0);#0A..17b.#3D.a;.a.#3D.W[Wp[
.7]+0];.goto.fetch;#0A..1case.F_l0p0+6:..Rw(p+6);..
1Rw(Wp[6]+0);#0A..17b.#3D.a;.a.#3D.W[Wp[.6]+0];.got
o.fetch;#0A..1case.F_l0p0+5:..Rw(p+5);..1Rw(Wp[5]+0
);#0A..17b.#3D.a;.a.#3D.W[Wp[.5]+0];.goto.fetch;#0A
..1case.F_l0p0+4:..Rw(p+4);..1Rw(Wp[4]+0);#0A..17b.
#3D.a;.a.#3D.W[Wp[.4]+0];.goto.fetch;#0A..1case.F_l
0p0+3:..Rw(p+3);..1Rw(Wp[3]+0);#0A..17b.#3D.a;.a.#3D
.W[Wp[.3]+0];.goto.fetch;#0A#0A..1case.F_l1p0+6:..R
w(p+6);..1Rw(Wp[6]+1);#0A..17b.#3D.a;.a.#3D.W[Wp[.6
]+1];.goto.fetch;#0A..1case.F_l1p0+5:..Rw(p+5);..1R
w(Wp[5]+1);#0A..17b.#3D.a;.a.#3D.W[Wp[.5]+1];.goto.
fetch;#0A..1case.F_l1p0+4:..Rw(p+4);..1Rw(Wp[4]+1);
#0A..17b.#3D.a;.a.#3D.W[Wp[.4]+1];.goto.fetch;#0A..
1case.F_l1p0+3:..Rw(p+3);..1Rw(Wp[3]+1);#0A..17b.#3D
.a;.a.#3D.W[Wp[.3]+1];.goto.fetch;#0A#0A..1case.F_l
2p0+5:..Rw(p+5);..1Rw(Wp[5]+2);#0A..17b.#3D.a;.a.#3D
.W[Wp[.5]+2];.goto.fetch;#0A..1case.F_l2p0+4:..Rw(p
+4);..1Rw(Wp[4]+2);#0A..17b.#3D.a;.a.#3D.W[Wp[.4]+2
];.goto.fetch;#0A..1case.F_l2p0+3:..Rw(p+3);..1Rw(W
p[3]+2);#0A..17b.#3D.a;.a.#3D.W[Wp[.3]+2];.goto.fet
ch;#0A#0A..1case.F_l3p0+4:..Rw(p+4);..1Rw(Wp[4]+3);
#0A..17b.#3D.a;.a.#3D.W[Wp[.4]+3];.goto.fetch;#0A..
1case.F_l3p0+3:..Rw(p+3);..1Rw(Wp[3]+3);#0A..17b.#3D
.a;.a.#3D.W[Wp[.3]+3];.goto.fetch;#0A#0A..1case.F_l
4p0+4:..Rw(p+4);..1Rw(Wp[4]+4);#0A..17b.#3D.a;.a.#3D
.W[Wp[.4]+4];.goto.fetch;#0A..1case.F_l4p0+3:..Rw(p
+3);..1Rw(Wp[3]+4);#0A..17b.#3D.a;.a.#3D.W[Wp[.3]+4
];.goto.fetch;#0A#0A..1case.F_l0gh:..Rb(pc);.Rw(g+G
H(pc));.Rw(Wg[GH(pc)]+0);#0A..15b.#3D.a;.a.#3D.W[Wg
[GH(pc)]+0];.pc.+#3D.2;.goto.fetch;#0A..1case.F_l1g
h:..Rb(pc);.Rw(g+GH(pc));.Rw(Wg[GH(pc)]+1);#0A..15b
.#3D.a;.a.#3D.W[Wg[GH(pc)]+1];.pc.+#3D.2;.goto.fetc
h;#0A..1case.F_l2gh:..Rb(pc);.Rw(g+GH(pc));.Rw(Wg[G
H(pc)]+2);#0A..15b.#3D.a;.a.#3D.W[Wg[GH(pc)]+2];.pc
.+#3D.2;.goto.fetch;#0A..1case.F_l0g1:..Rb(pc);.Rw(
g+256+B[pc]);.Rw(Wg1[B[pc]]+0);#0A..15b.#3D.a;.a.#3D
.W[Wg1[B[pc++]]+0];..6goto.fetch;#0A..1case.F_l1g1:
..Rb(pc);.Rw(g+256+B[pc]);.Rw(Wg1[B[pc]]+1);#0A..15
b.#3D.a;.a.#3D.W[Wg1[B[pc++]]+1];..6goto.fetch;#0A.
.1case.F_l2g1:..Rb(pc);.Rw(g+256+B[pc]);.Rw(Wg1[B[p
c]]+2);#0A..15b.#3D.a;.a.#3D.W[Wg1[B[pc++]]+2];..6g
oto.fetch;#0A..1case.F_l0g:..1Rb(pc);.Rw(g+B[pc]);.
Rw(Wg[B[pc]]+0);#0A..15b.#3D.a;.a.#3D.W[Wg[B[pc++]]
+0];..7goto.fetch;#0A..1case.F_l1g:..1Rb(pc);.Rw(g+
B[pc]);.Rw(Wg[B[pc]]+1);#0A..15b.#3D.a;.a.#3D.W[Wg[
B[pc++]]+1];..7goto.fetch;#0A..1case.F_l2g:..1Rb(pc
);.Rw(g+B[pc]);.Rw(Wg[B[pc]]+2);#0A..15b.#3D.a;.a.#3D
.W[Wg[B[pc++]]+2];..7goto.fetch;#0A#0A..1case.F_s0g
h:..Rb(pc);.Rw(g+GH(pc));.Rw(Wg[GH(pc)]+0);#0A..15W
[Wg[GH(pc)]+0].#3D.a;..6pc.+#3D.2;.goto.fetch;#0A..
1case.F_s0g1:..Rb(pc);.Rw(g+256+B[pc]);.Rw(Wg1[B[pc
]]+0);#0A..15W[Wg1[B[pc++]]+0].#3D.a;..13goto.fetch
;#0A..1case.F_s0g:..1Rb(pc);.Rw(g+B[pc]);.Rw(Wg[B[p
c]]+0);#0A..15W[Wg[B[pc++]]+0].#3D.a;..14goto.fetch
;#0A#0A..1case.F_stp0+5:.Rw(p+5);.Rw(a+Wp[5]);.W[a+
Wp[5]].#3D.b;.goto.fetch;#0A..1case.F_stp0+4:.Rw(p+
4);.Rw(a+Wp[4]);.W[a+Wp[4]].#3D.b;.goto.fetch;#0A..
1case.F_stp0+3:.Rw(p+3);.Rw(a+Wp[3]);.W[a+Wp[3]].#3D
.b;.goto.fetch;#0A#0A..1case.F_st0p0+4:.Rw(p+4);.Rw
(Wp[4]+0);.W[Wp[4]+0].#3D.a;.goto.fetch;#0A..1case.
F_st0p0+3:.Rw(p+3);.Rw(Wp[3]+0);.W[Wp[3]+0].#3D.a;.
goto.fetch;#0A#0A..1case.F_st1p0+4:.Rw(p+4);.Rw(Wp[
4]+1);.W[Wp[4]+1].#3D.a;.goto.fetch;#0A..1case.F_st
1p0+3:.Rw(p+3);.Rw(Wp[3]+1);.W[Wp[3]+1].#3D.a;.goto
.fetch;#0A..1#0A..1case.F_rvp0+7:.Rw(p+7);.Rw(a+Wp[
7]);.a.#3D.W[a+Wp[7]];.goto.fetch;#0A..1case.F_rvp0
+6:.Rw(p+6);.Rw(a+Wp[6]);.a.#3D.W[a+Wp[6]];.goto.fe
tch;#0A..1case.F_rvp0+5:.Rw(p+5);.Rw(a+Wp[5]);.a.#3D
.W[a+Wp[5]];.goto.fetch;#0A..1case.F_rvp0+4:.Rw(p+4
);.Rw(a+Wp[4]);.a.#3D.W[a+Wp[4]];.goto.fetch;#0A..1
case.F_rvp0+3:.Rw(p+3);.Rw(a+Wp[3]);.a.#3D.W[a+Wp[3
]];.goto.fetch;#0A..1}#0A#0Anegpc:#0A..1res.#3D.4;.
./*.negative.pc..*/.#0Aret:#0A..1Rw(regs+0);.W[regs
+0]..#3D.a;..2/*.Save.the.machine.registers..*/#0A.
.1Rw(regs+1);.W[regs+1]..#3D.b;#0A..1Rw(regs+2);.W[
regs+2]..#3D.c;#0A..1Rw(regs+3);.W[regs+3]..#3D.p<<
B2Wsh;#0A..1Rw(regs+4);.W[regs+4]..#3D.g<<B2Wsh;#0A
..1Rw(regs+5);.W[regs+5]..#3D.st;#0A..1Rw(regs+6);.
W[regs+6]..#3D.pc;#0A..1Rw(regs+7);.W[regs+7]..#3D.
count;#0A..1Rw(regs+8);.W[regs+8]..#3D.mw;#0A..1#0A
..1return.res;#0A}#0A#0A

######sysc/rasterp64.c#
/*#0A**.This.is.a.version.of.the.CINTCODE.interpret
er.that.can.genearate#0A**.memory.reference.data.th
at.allows.memory.address/time.graphs#0A**.to.be.con
structed#2E.It.should.be.linked.as.a.replacement.fo
r.cintasm#2E#0A**.When.linked.with.rastlib.it.is.ca
pable.of.generating.Postscript.pictures#0A**.of.the
.execution.history.of.a.program#2E#0A**#0A**.(c).Co
pyright:..Martin.Richards..00026.October.1990005#0A
*/#0A#0A1#23include.<stdio#2Eh>#0A#0A/*.cinterp#2Eh
.contains.machine/system.dependent.#23defines..*/#0A
#23include."cintsys64#2Eh"#0A#0Aextern.BCPLWORD.res
ult2;#0A#0Aextern.BCPLWORD.tallylim;#0A#0Aextern.BC
PLWORD.dosys(BCPLWORD.p,.BCPLWORD.g);#0Aextern.BCPL
WORD.muldiv(BCPLWORD.a,.BCPLWORD.b,.BCPLWORD.c);#0A
#0A1/*.functions.in.rastlib#2Ec..*/#0Aextern.BCPLWO
RD.fcount;#0Aextern.BCPLWORD.setraster(BCPLWORD,.BC
PLWORD);./*.not.called.from.this.module.*/#0Aextern
.void.rasterpoint(BCPLWORD);#0A#0A#23define.Gn_curr
co..0047#0A#23define.Gn_result2..00210#0A#0A/*.CINT
CODE.function.codes..*/#0A#0A#23define.F_0..0050#0A
#0A#23define.F_brk..0032#0A#23define.F_k0..0040#0A#23
define.F_lf..00312#0A#23define.F_lm..00314#0A#23def
ine.F_lm1..00215#0A#23define.F_l0..00316#0A#23defin
e.F_fhop..00127#0A#23define.F_jeq..00228#0A#0A#23de
fine.F_k..00432#0A#23define.F_kh..00333#0A#23define
.F_kw..00334#0A#23define.F_k0g..00232#0A#23define.F
_k0g1..1(F_k0g+32)#0A#23define.F_k0gh..1(F_k0g+64)#0A
#23define.F_s0g..00244#0A#23define.F_s0g1..1(F_s0g+
32)#0A#23define.F_s0gh..1(F_s0g+64)#0A#23define.F_l
0g..00245#0A#23define.F_l0g1..1(F_l0g+32)#0A#23defi
ne.F_l0gh..1(F_l0g+64)#0A#23define.F_l1g..00246#0A#23
define.F_l1g1..1(F_l1g+32)#0A#23define.F_l1gh..1(F_
l1g+64)#0A#23define.F_l2g..00247#0A#23define.F_l2g1
..1(F_l2g+32)#0A#23define.F_l2gh..1(F_l2g+64)#0A#23
define.F_lg..00348#0A#23define.F_lg1..2(F_lg+32)#0A
#23define.F_lgh..2(F_lg+64)#0A#23define.F_sg..00349
#0A#23define.F_sg1..2(F_sg+32)#0A#23define.F_sgh..2
(F_sg+64)#0A#23define.F_llg..00250#0A#23define.F_ll
g1..1(F_llg+32)#0A#23define.F_llgh..1(F_llg+64)#0A#23
define.F_ag..00351#0A#23define.F_ag1..2(F_ag+32)#0A
#23define.F_agh..2(F_ag+64)#0A#23define.F_mul..0025
2#0A#23define.F_div..00253#0A#23define.F_rem..00254
#0A#23define.F_xor..00255#0A#23define.F_sl..00356#0A
#23define.F_ll..00358#0A#23define.F_jne..00260#0A#0A
#23define.F_llp..00264#0A#23define.F_llph..00165#0A
#23define.F_llpw..00166#0A#23define.F_add..00284#0A
#23define.F_sub..00285#0A#23define.F_lsh..00286#0A#23
define.F_rsh..00287#0A#23define.F_and..00288#0A#23d
efine.F_or..00389#0A#23define.F_ll1..00290#0A#23def
ine.F_jls..00292#0A#0A#23define.F_l..00496#0A#23def
ine.F_lh..00397#0A#23define.F_lw..00398#0A#23define
.F_rv..002110006#0A#23define.F_rtn..001123#0A#23def
ine.F_jgr..001124#0A#0A#23define.F_lp..002128#0A#23
define.F_lph..001129#0A#23define.F_lpw..001130#0A#23
define.F_lp0..001128#0A#23define.F_sys..001145#0A#23
define.F_swb..001146#0A#23define.F_swl..001147#0A#23
define.F_st..002148#0A#23define.F_st0..001148#0A#23
define.F_stp0..000149#0A#23define.F_goto..000155#0A
#23define.F_jle..001156#0A#0A#23define.F_sp..002160
#0A#23define.F_sph..001161#0A#23define.F_spw..00116
2#0A#23define.F_sp0..001160#0A#23define.F_s0..00217
6#0A#23define.F_xch..001181#0A#23define.F_gbyt..000
182#0A#23define.F_pbyt..000183#0A#23define.F_atc..0
01184#0A#23define.F_atb..001185#0A#23define.F_j..00
3186#0A#23define.F_jge..001188#0A#0A#23define.F_ap.
.002192#0A#23define.F_aph..001193#0A#23define.F_apw
..001194#0A#23define.F_ap0..001192#0A#0A#23define.F
_xpbyt.205#0A#23define.F_lmh..001206#0A#23define.F_
btc..001207#0A#23define.F_nop..001208#0A#23define.F
_a0..002208#0A#23define.F_rvp0..000211#0A#23define.
F_st0p0.216#0A#23define.F_st1p0.218#0A#0A#23define.
F_a..003220004#0A#23define.F_ah..002220005#0A#23def
ine.F_aw..002220006#0A#23define.F_l0p0..000220004#0A
#23define.F_s..003237#0A#23define.F_sh..002238#0A#0A
#23define.F_mdiv..000239#0A#23define.F_chgco.240#0A
#23define.F_neg..001241#0A#23define.F_not..001242#0A
#23define.F_l1p0..000240#0A#23define.F_l2p0..000244
#0A#23define.F_l3p0..000247.#0A#23define.F_l4p0..00
0249#0A#0A#23define.F_255..001255#0A#0A1/*.The.func
tion.cintasm.is.designed.to.be.separately.compiled,
#0A//.and.possibly.implemented.in.assembly.language
.for.speed#2E#0A//#0A//.mem..is.the.pointer.to.the.
cintcode.memory#2E#0A//.regs.is.the.position.in.the
.Cintcode.memory.where.the.initial#0A//..4value.of.
the.Cintcode.registers#2E#0A//#0A//.interpret.(or.c
intasm).executes.Cintcode.instructions.and.returns.
with#0A//.an.integer.result.as.follows:#0A//..0030.
.4sys(0,.0).called#0A//..0031..4Non.existant.instru
ction#0A//..0032..4Brk.instruction#0A//..0033..4Zer
o.count#0A//..0034..4Negative.pc#0A//..0035..4Divis
ion.by.zero#0A//..3n..4sys(0,.n).called#0A//#0A//.O
n.return.the.Cintcode.registers.are.dumped.back.in.
the.vector.regs#0A*/#0A#0A1void.Rb(BCPLWORD.a)#0A{#0A
..if.(tallylim).rasterpoint(a);#0A}#0A#0Avoid.Rh(BC
PLWORD.a)#0A{#0A..if.(tallylim).rasterpoint(a<<0001
);#0A}#0A#0Avoid.Rw(BCPLWORD.a)#0A{#0A..if.(tallyli
m).rasterpoint(a<<B2Wsh);#0A}#0A#0A1int.cintasm(BCP
LWORD.regs,.BCPLWORDpt.mem)#0A{.register.BCPLWORDpt
.W.#3D.mem;#0A#0A#23define.B.(BP.W)#0A#23define.SB.
(SBP.W)#0A#23define.H.(HP.W)#0A#23define.SH.(SHP.W)
#0A#0A#23ifdef.BIGENDER#0A#23define.GH(x).((WD.B[x+
0]<<0008).|.B[x+1])#0A#23define.GW(x).((4WD.B[x]<<0
008)|B[x+1])<<0008)|B[x+2])<<0008)|B[x+3])#0A#23els
e#0A#23define.GH(x).((WD.B[x+1]<<0008).|.B[x])#0A#23
define.GW(x).((4WD.B[x+3]<<0008)|B[x+2])<<0008)|B[x
+1])<<0008)|B[x])#0A#23endif#0A#0A..1register.BCPLW
ORD..9a..#3D.W[regs+0];#0A..1register.BCPLWORD..9b.
.#3D.W[regs+1];#0A..1BCPLWORD..18c..#3D.W[regs+2];#0A
..1register.BCPLWORD..9p..#3D.W[regs+3]>>B2Wsh;#0A.
.1register.BCPLWORD..9g..#3D.W[regs+4]>>B2Wsh;#0A..
1BCPLWORD..18st.#3D.W[regs+5];#0A..1register.BCPLWO
RD..9pc.#3D.W[regs+6];#0A..1register.BCPLWORD..6cou
nt.#3D.W[regs+7];#0A#0A..1register.BCPLWORDpt.Wp..#3D
.W+p,..2/*.Optimise.access.to.the.stack.*/#0A..18Wg
..#3D.W+g,..2/*.Optimise.access.to.the.global.vecto
r.*/#0A..18Wg1.#3D.W+g+256;#0A#0A..1BCPLWORD..res,.
k,.i;#0A..1Rw(regs+0);.#0A..1Rw(regs+1);.#0A..1Rw(r
egs+2);.#0A..1Rw(regs+3);.#0A..1Rw(regs+4);.#0A..1R
w(regs+5);.#0A..1Rw(regs+6);.#0A..1Rw(regs+7);.#0A#0A
..1if.(pc<0).goto.negpc;#0A..1#0Afetch:#0A..1if.(ta
llylim).fcount++;#0A..1Rb(pc);#0A..1switch((int).B[
pc++])#0A#0A{..default:..4/*.Cases.F_0.and.F_255.ha
ve.been.added.explicitly.to..1*/#0A..1case.F_0:..3/
*.improve.the.compiled.code.(with.luck)..13*/#0A..1
case.F_255:..1res.#3D.1;.pc--;.goto.ret;./*.Unimple
mented.instruction..*/#0A#0A..1case.F_mul:..1a.#3D.
b.*.a;..6goto.fetch;#0A..1case.F_div:..1if(a#3D#3D0
000).{res.#3D.5;.pc--;.goto.ret;.}./*.Division.by.z
ero.*/#0A..15a.#3D.b./.a;..6goto.fetch;#0A..1case.F
_rem:..1if(a#3D#3D0000).{res.#3D.5;.pc--;.goto.ret;
.}./*.Division.by.zero.*/#0A..15a.#3D.b.%.a;..6goto
.fetch;#0A..1case.F_add:..1a.#3D.b.+.a;..6goto.fetc
h;#0A..1case.F_sub:..1a.#3D.b.-.a;..6goto.fetch;#0A
..1case.F_neg:..1a.#3D.-.a;..8goto.fetch;#0A#0A..1c
ase.F_fhop:..a.#3D.0;.pc++;..4goto.fetch;#0A#0A..1c
ase.F_lsh:..1if.(a>31).b#3D0;./*.bug.*/#0A..15a.#3D
.b.<<.a;..5goto.fetch;#0A..1case.F_rsh:..1if.(a>31)
.b#3D0;./*.bug.*/#0A..15a.#3D.WD((UWD.b)>>a);.goto.
fetch;#0A..1case.F_not:..1a.#3D.~.a;..8goto.fetch;#0A
..1case.F_and:..1a.#3D.b.&.a;..6goto.fetch;#0A..1ca
se.F_or:..2a.#3D.b.|.a;..6goto.fetch;#0A..1case.F_x
or:..1a.#3D.b.^.a;..6goto.fetch;#0A#0A..1case.F_got
o:..pc.#3D.a;..9goto.fetch;#0A#0A..1case.F_brk:..1r
es.#3D.2;.pc--;.goto.ret;../*.BREAKPOINT..*/#0A..15
#0A..1case.F_rv+6:..Rw(a+6);.a.#3D.W[a+6];.goto.fet
ch;#0A..1case.F_rv+5:..Rw(a+5);.a.#3D.W[a+5];.goto.
fetch;#0A..1case.F_rv+4:..Rw(a+4);.a.#3D.W[a+4];.go
to.fetch;#0A..1case.F_rv+3:..Rw(a+3);.a.#3D.W[a+3];
.goto.fetch;#0A..1case.F_rv+2:..Rw(a+2);.a.#3D.W[a+
2];.goto.fetch;#0A..1case.F_rv+1:..Rw(a+1);.a.#3D.W
[a+1];.goto.fetch;#0A..1case.F_rv:..2Rw(a+0);.a.#3D
.W[a+0];.goto.fetch;#0A#0A..1case.F_st+3:..Rw(a+3);
.W[a+3].#3D.b;.goto.fetch;#0A..1case.F_st+2:..Rw(a+
2);.W[a+2].#3D.b;.goto.fetch;#0A..1case.F_st+1:..Rw
(a+1);.W[a+1].#3D.b;.goto.fetch;#0A..1case.F_st:..2
Rw(a+0);.W[a+0].#3D.b;.goto.fetch;#0A#0A..1case.F_c
hgco:.Rw(p+0);.Rw(g+Gn_currco);.Rw(Wg[Gn_currco]);.
#0A..15W[Wg[Gn_currco]].#3D.Wp[0];..3/*.!currco.:#3D
.!p..2*/#0A..15Rw(p+1);.#0A..15pc.#3D.Wp[1];..17/*.
pc..4:#3D.p!1..1*/#0A..15Rw(p+4);.Rw(g+Gn_currco);.
#0A..15Wg[Gn_currco].#3D.Wp[4];..6/*.currco..:#3D.c
ptr..*/#0A..15Rw(p+4);.Rw(Wp[4]);.#0A..15p.#3D.W[Wp
[4]]>>B2Wsh;..12/*.p..5:#3D.!cptr.*/#0A..15Wp.#3D.W
+p;#0A..15goto.fetch;#0A#0A..1case.F_mdiv:..Rw(p+3)
;.Rw(p+4);.Rw(p+5);.#0A..15a.#3D.muldiv(Wp[3],.Wp[4
],.Wp[5]);#0A..15Rw(g+Gn_result2);.#0A..15Wg[Gn_res
ult2].#3D.result2;#0A..15/*.fall.through.to.return.
.*/#0A..1case.F_rtn:..1Rw(p+1);.#0A..15pc.#3D.Wp[1]
;#0A..15Rw(p+0);.#0A..15p..#3D.Wp[0]>>B2Wsh;..Wp.#3D
.W+p;.goto.fetch;#0A#0A..1case.F_gbyt:.Rb(a+(b<<B2W
sh));#0A..14a.#3D.B[a+(b<<B2Wsh)];..10goto.fetch;#0A
..1case.F_pbyt:.Rb(a+(b<<B2Wsh));#0A..14B[a+(b<<B2W
sh)].#3D.c;..10goto.fetch;#0A..1case.F_xpbyt:Rb(b+(
a<<B2Wsh));#0A..14B[b+(a<<B2Wsh)].#3D.c;..10goto.fe
tch;#0A..1case.F_atc:..c.#3D.a;..20goto.fetch;#0A..
1case.F_btc:..c.#3D.b;..20goto.fetch;#0A..1case.F_a
tb:..b.#3D.a;..20goto.fetch;#0A..1case.F_xch:..a.#3D
.a^b;.b.#3D.a^b;.a.#3D.a^b;..goto.fetch;#0A#0A..1ca
se.F_swb:.{.BCPLWORD.n,k,val,i#3D1;#0A..15k.#3D.(pc
+1)>>0001;#0A..15Rh(k);#0A..15n.#3D.H[k];#0A..15whi
le(i<#3Dn)#0A..15{.i.#3D.i+i;#0A..17Rh(k+i);#0A..17
val.#3D.H[k+i];#0A..17if.(a#3D#3Dval).{.k.+#3D.i;.b
reak;.}#0A..17if.(a<val).i++;#0A..15}#0A..15k++;#0A
..15Rh(k);#0A..15pc.#3D.(k<<0001).+.SH[k];#0A..15go
to.fetch;#0A..13}#0A#0A..1case.F_swl:.{.BCPLWORD.n,
q;#0A..15q.#3D.(pc+1)>>0001;#0A..15Rh(q);#0A..15n.#3D
.H[q++];#0A..15if(0<#3Da.&&.a<n).q.#3D.q.+.a.+.1;#0A
..15Rh(q);#0A..15pc.#3D.(q<<0001).+.SH[q];#0A..15go
to.fetch;#0A..13}#0A#0A..1case.F_sys:.switch(a).{#0A
..15default:.//.system.call.--.general.case#0A.#0A.
.23W[regs+0]..#3D.a;..2//.Save.the.registers#0A..23
W[regs+1]..#3D.b;..2//.for.debugging.purposes#0A..2
3W[regs+2]..#3D.c;#0A..23W[regs+3]..#3D.p<<B2Wsh;#0A
..23W[regs+4]..#3D.g<<B2Wsh;#0A..23W[regs+5]..#3D.s
t;#0A..23W[regs+6]..#3D.pc;#0A..23W[regs+7]..#3D.co
unt;#0A..#0A..23a.#3D.dosys(p,.g);.#0A..23goto.fetc
h;#0A#0A..15case.Sys_setcount:#0A..23/*.oldcount.:#3D
.sys(Sys_setcount,.newcount)..*/#0A..23a.#3D.count;
.#0A#09#09..7Rw(p+4);.count.#3D.Wp[4];#0A..23res.#3D
.-1;.//.Leave.and.immediately.re-enter#0A..23goto.r
et;.//.the.interpreter#0A#0A..15case.Sys_quit:#0A..
23Rw(p+4);.res.#3D.Wp[4];#0A..23goto.ret;#0A#0A#09#09
.//.case.Sys_rti:.//..sys(Sys_rti,.regs)#0A..15//.c
ase.Sys_saveregs:.//.sys(Sys_saveregs,.regs)#0A..15
//.case.Sys_setst:.//.sys(Sys_setst,.st)#0A#0A..15/
/.case.Sys_watch:..//.sys(Sys_watch,.addr)#0A..13}#0A
#0A..1case.F_lp0+16:..b.#3D.a;.Rw(p+16);.a.#3D.Wp[1
6];.goto.fetch;#0A..1case.F_lp0+15:..b.#3D.a;.Rw(p+
15);.a.#3D.Wp[15];.goto.fetch;#0A..1case.F_lp0+14:.
.b.#3D.a;.Rw(p+14);.a.#3D.Wp[14];.goto.fetch;#0A..1
case.F_lp0+13:..b.#3D.a;.Rw(p+13);.a.#3D.Wp[13];.go
to.fetch;#0A..1case.F_lp0+12:..b.#3D.a;.Rw(p+12);.a
.#3D.Wp[12];.goto.fetch;#0A..1case.F_lp0+11:..b.#3D
.a;.Rw(p+11);.a.#3D.Wp[11];.goto.fetch;#0A..1case.F
_lp0+10:..b.#3D.a;.Rw(p+10);.a.#3D.Wp[10];.goto.fet
ch;#0A..1case.F_lp0+9:..1b.#3D.a;.Rw(p+9);..a.#3D.W
p[9];..goto.fetch;#0A..1case.F_lp0+8:..1b.#3D.a;.Rw
(p+8);..a.#3D.Wp[8];..goto.fetch;#0A..1case.F_lp0+7
:..1b.#3D.a;.Rw(p+7);..a.#3D.Wp[7];..goto.fetch;#0A
..1case.F_lp0+6:..1b.#3D.a;.Rw(p+6);..a.#3D.Wp[6];.
.goto.fetch;#0A..1case.F_lp0+5:..1b.#3D.a;.Rw(p+5);
..a.#3D.Wp[5];..goto.fetch;#0A..1case.F_lp0+4:..1b.
#3D.a;.Rw(p+4);..a.#3D.Wp[4];..goto.fetch;#0A..1cas
e.F_lp0+3:..1b.#3D.a;.Rw(p+3);..a.#3D.Wp[3];..goto.
fetch;#0A#0A..1case.F_lp:..1Rb(pc);.Rw(p+B[pc]);#0A
..14b.#3D.a;.a.#3D.Wp[B[pc++]];..8goto.fetch;#0A..1
case.F_lph:..Rb(pc);.Rw(p+GH(pc));#0A..14b.#3D.a;.a
.#3D.Wp[GH(pc)];..pc.+#3D.2;.goto.fetch;#0A..1case.
F_lpw:..Rb(pc);.Rw(p+GW(pc));#0A..14b.#3D.a;.a.#3D.
Wp[GW(pc)];..pc.+#3D.4;.goto.fetch;#0A#0A..1case.F_
llp:..b.#3D.a;..Rb(pc);.a.#3D.p+B[pc++];..11goto.fe
tch;#0A..1case.F_llph:.b.#3D.a;..Rb(pc);.a.#3D.p+GH
(pc);..3pc.+#3D.2;.goto.fetch;#0A..1case.F_llpw:.b.
#3D.a;..Rb(pc);.a.#3D.p+GW(pc);..3pc.+#3D.4;.goto.f
etch;#0A#0A..1case.F_sp0+16:.Rw(p+16);.Wp[16].#3D.a
;.goto.fetch;#0A..1case.F_sp0+15:.Rw(p+15);.Wp[15].
#3D.a;.goto.fetch;#0A..1case.F_sp0+14:.Rw(p+14);.Wp
[14].#3D.a;.goto.fetch;#0A..1case.F_sp0+13:.Rw(p+13
);.Wp[13].#3D.a;.goto.fetch;#0A..1case.F_sp0+12:.Rw
(p+12);.Wp[12].#3D.a;.goto.fetch;#0A..1case.F_sp0+1
1:.Rw(p+11);.Wp[11].#3D.a;.goto.fetch;#0A..1case.F_
sp0+10:.Rw(p+10);.Wp[10].#3D.a;.goto.fetch;#0A..1ca
se.F_sp0+9:..Rw(p+9);..Wp[9]..#3D.a;.goto.fetch;#0A
..1case.F_sp0+8:..Rw(p+8);..Wp[8]..#3D.a;.goto.fetc
h;#0A..1case.F_sp0+7:..Rw(p+7);..Wp[7]..#3D.a;.goto
.fetch;#0A..1case.F_sp0+6:..Rw(p+6);..Wp[6]..#3D.a;
.goto.fetch;#0A..1case.F_sp0+5:..Rw(p+5);..Wp[5]..#3D
.a;.goto.fetch;#0A..1case.F_sp0+4:..Rw(p+4);..Wp[4]
..#3D.a;.goto.fetch;#0A..1case.F_sp0+3:..Rw(p+3);..
Wp[3]..#3D.a;.goto.fetch;#0A#0A..1case.F_sp:..2Rb(p
c);.Rw(p+B[pc]);#0A..15Wp[B[pc++]].#3D.a;..16goto.f
etch;#0A..1case.F_sph:..1Rb(pc);.Rw(p+GH(pc));#0A..
15Wp[GH(pc)]..#3D.a;..7pc.+#3D.2;.goto.fetch;#0A..1
case.F_spw:..1Rb(pc);.Rw(p+GW(pc));#0A..15Wp[GW(pc)
]..#3D.a;..7pc.+#3D.4;.goto.fetch;#0A#0A..1case.F_l
gh:..1Rb(pc);.Rw(g+GH(pc));#0A..15b.#3D.a;.a.#3D.Wg
[GH(pc)];..1pc.+#3D.2;.goto.fetch;#0A..1case.F_lg1:
..1Rb(pc);.Rw(g+256+B[pc]);#0A..15b.#3D.a;.a.#3D.Wg
1[B[pc++]];..8goto.fetch;#0A..1case.F_lg:..2Rb(pc);
.Rw(g+B[pc]);#0A..15b.#3D.a;.a.#3D.Wg[B[pc++]];..9g
oto.fetch;#0A#0A..1case.F_sgh:..1Rb(pc);.Rw(g+GH(pc
));#0A..15Wg[GH(pc)]..1#3D.a;..6pc.+#3D.2;.goto.fet
ch;#0A..1case.F_sg1:..1Rb(pc);.Rw(g+256+B[pc]);#0A.
.15Wg1[B[pc++]].#3D.a;..15goto.fetch;#0A..1case.F_s
g:..2Rb(pc);.Rw(g+B[pc]);#0A..15Wg[B[pc++]]..#3D.a;
..15goto.fetch;#0A#0A..1case.F_llgh:.b.#3D.a;.Rb(pc
);.a.#3D.g+GH(pc);..4pc.+#3D.2;.goto.fetch;#0A..1ca
se.F_llg1:.b.#3D.a;.Rb(pc);.a.#3D.g+256+B[pc++];..8
goto.fetch;#0A..1case.F_llg:..b.#3D.a;.Rb(pc);.a.#3D
.g+B[pc++];..12goto.fetch;#0A#0A..1case.F_ll+1:.Rb(
pc);.i.#3D.(pc>>0001).+.B[pc];#0A..14Rh(i);..i.#3D.
(i<<0001).+.SH[i];#0A..14Rw(i>>B2Wsh);.b.#3D.a;.a.#3D
.W[i>>B2Wsh];..8pc++;.goto.fetch;#0A#0A..1case.F_ll
:..1Rb(pc);.Rw((pc+SB[pc])>>B2Wsh);#0A..14b.#3D.a;.
a.#3D.W[(pc+SB[pc])>>B2Wsh];pc++;.goto.fetch;#0A#0A
..1case.F_sl+1:.Rb(pc);.i.#3D.(pc>>0001).+.B[pc];#0A
..14Rh(i);.i.#3D.(i<<0001).+.SH[i];#0A..14Rw(i>>B2W
sh);.W[i>>B2Wsh].#3D.a;..15pc++;.goto.fetch;#0A#0A.
.1case.F_sl:..1Rb(pc);.Rw((pc+SB[pc])>>B2Wsh);#0A..
14W[(pc+SB[pc])>>B2Wsh].#3D.a;..5pc++;.goto.fetch;#0A
..1#0A..1case.F_ll1+1:Rb(pc);.i.#3D.(pc>>0001).+.B[
pc];#0A..14Rh(i);.i.#3D.(i<<0001).+.SH[i];#0A..14b.
#3D.a;.a.#3D.i>>B2Wsh;..11pc++;.goto.fetch;#0A#0A..
1case.F_ll1:..Rb(pc);.b.#3D.a;.a.#3D.(pc+SB[pc])>>B
2Wsh;..1pc++;.goto.fetch;#0A..1#0A..1case.F_l0+10:.
b.#3D.a;.a.#3D.10;.goto.fetch;#0A..1case.F_l0+9:..b
.#3D.a;.a.#3D..0009;.goto.fetch;#0A..1case.F_l0+8:.
.b.#3D.a;.a.#3D..0008;.goto.fetch;#0A..1case.F_l0+7
:..b.#3D.a;.a.#3D..0007;.goto.fetch;#0A..1case.F_l0
+6:..b.#3D.a;.a.#3D..0006;.goto.fetch;#0A..1case.F_
l0+5:..b.#3D.a;.a.#3D..0005;.goto.fetch;#0A..1case.
F_l0+4:..b.#3D.a;.a.#3D..0004;.goto.fetch;#0A..1cas
e.F_l0+3:..b.#3D.a;.a.#3D..0003;.goto.fetch;#0A..1c
ase.F_l0+2:..b.#3D.a;.a.#3D..0002;.goto.fetch;#0A..
1case.F_l0+1:..b.#3D.a;.a.#3D..0001;.goto.fetch;#0A
..1case.F_l0:..2b.#3D.a;.a.#3D..0000;.goto.fetch;#0A
..1case.F_l0-1:..b.#3D.a;.a.#3D.-1;.goto.fetch;.#0A
#0A..1case.F_l:..3Rb(pc);.b.#3D.a;.a.#3D.B[pc++];..
13goto.fetch;#0A..1case.F_lh:..2Rb(pc);.b.#3D.a;.a.
#3D.GH(pc);..5pc.+#3D.2;.goto.fetch;#0A..1case.F_lw
:..2Rb(pc);.b.#3D.a;.a.#3D.GW(pc);..5pc.+#3D.4;.got
o.fetch;#0A#0A..1case.F_lm:..2Rb(pc);.b.#3D.a;.a.#3D
.-.WD(B[pc++]);..7goto.fetch;#0A..1case.F_lmh:..1Rb
(pc);.b.#3D.a;.a.#3D.-.WD(GH(pc));.pc.+#3D.2;.goto.
fetch;#0A..14#0A..1case.F_lf+1:..b.#3D.a;#0A..15Rb(
pc);.a.#3D.(pc>>0001).+.B[pc];#0A..15Rh(a);.a.#3D.(
a<<0001).+.SH[a];..7pc++;.goto.fetch;#0A#0A..1case.
F_lf:..2Rb(pc);.b.#3D.a;.a.#3D.pc.+.SB[pc];..3pc++;
.goto.fetch;#0A.#0A..1case.F_k0gh+11:.Rw(p+11);.Wp[
11].#3D.p<<B2Wsh;.p.+#3D.11;.goto.applygh;#0A..1cas
e.F_k0gh+10:.Rw(p+10);.Wp[10].#3D.p<<B2Wsh;.p.+#3D.
10;.goto.applygh;#0A..1case.F_k0gh+9:..Rw(p+9);..Wp
[.9].#3D.p<<B2Wsh;.p.+#3D..0009;.goto.applygh;#0A..
1case.F_k0gh+8:..Rw(p+8);..Wp[.8].#3D.p<<B2Wsh;.p.+
#3D..0008;.goto.applygh;#0A..1case.F_k0gh+7:..Rw(p+
7);..Wp[.7].#3D.p<<B2Wsh;.p.+#3D..0007;.goto.applyg
h;#0A..1case.F_k0gh+6:..Rw(p+6);..Wp[.6].#3D.p<<B2W
sh;.p.+#3D..0006;.goto.applygh;#0A..1case.F_k0gh+5:
..Rw(p+5);..Wp[.5].#3D.p<<B2Wsh;.p.+#3D..0005;.goto
.applygh;#0A..1case.F_k0gh+4:..Rw(p+4);..Wp[.4].#3D
.p<<B2Wsh;.p.+#3D..0004;.goto.applygh;#0A..1case.F_
k0gh+3:..Rw(p+3);..Wp[.3].#3D.p<<B2Wsh;.p.+#3D..000
3;#0A..1applygh:..6Wp..2#3D.W+p;#0A..17Rw(p+1);.Wp[
1].#3D.pc.+.2;#0A..17Rb(pc);.Rw(g+GH(pc));.pc..2#3D
.Wg[GH(pc)];#0A..17Rw(p+2);.Wp[2].#3D.pc;#0A..17Rw(
p+3);.Wp[3].#3D..a;#0A..17if.(pc>#3D0).goto.fetch;#0A
..17goto.negpc;#0A#0A..1case.F_k0g1+11:.Rw(p+11);.W
p[11].#3D.p<<B2Wsh;.p.+#3D.11;.goto.applyg1;#0A..1c
ase.F_k0g1+10:.Rw(p+10);.Wp[10].#3D.p<<B2Wsh;.p.+#3D
.10;.goto.applyg1;#0A..1case.F_k0g1+9:..Rw(p+9);..W
p[.9].#3D.p<<B2Wsh;.p.+#3D..0009;.goto.applyg1;#0A.
.1case.F_k0g1+8:..Rw(p+8);..Wp[.8].#3D.p<<B2Wsh;.p.
+#3D..0008;.goto.applyg1;#0A..1case.F_k0g1+7:..Rw(p
+7);..Wp[.7].#3D.p<<B2Wsh;.p.+#3D..0007;.goto.apply
g1;#0A..1case.F_k0g1+6:..Rw(p+6);..Wp[.6].#3D.p<<B2
Wsh;.p.+#3D..0006;.goto.applyg1;#0A..1case.F_k0g1+5
:..Rw(p+5);..Wp[.5].#3D.p<<B2Wsh;.p.+#3D..0005;.got
o.applyg1;#0A..1case.F_k0g1+4:..Rw(p+4);..Wp[.4].#3D
.p<<B2Wsh;.p.+#3D..0004;.goto.applyg1;#0A..1case.F_
k0g1+3:..Rw(p+3);..Wp[.3].#3D.p<<B2Wsh;.p.+#3D..000
3;#0A..1applyg1:..6Wp..2#3D.W+p;#0A..17Rw(p+1);.Wp[
1].#3D.pc.+.1;#0A..17Rb(pc);.Rw(g+256+B[pc]);.pc..2
#3D.Wg1[B[pc]];#0A..17Rw(p+2);.Wp[2].#3D.pc;#0A..17
Rw(p+3);.Wp[3].#3D.a;#0A..17if.(pc>#3D0).goto.fetch
;#0A..17goto.negpc;#0A.#0A..1case.F_k0g+11:.Rw(p+11
);.Wp[11].#3D.p<<B2Wsh;.p.+#3D.11;.goto.applyg;#0A.
.1case.F_k0g+10:.Rw(p+10);.Wp[10].#3D.p<<B2Wsh;.p.+
#3D.10;.goto.applyg;#0A..1case.F_k0g+9:..Rw(p+9);..
Wp[.9].#3D.p<<B2Wsh;.p.+#3D..0009;.goto.applyg;#0A.
.1case.F_k0g+8:..Rw(p+8);..Wp[.8].#3D.p<<B2Wsh;.p.+
#3D..0008;.goto.applyg;#0A..1case.F_k0g+7:..Rw(p+7)
;..Wp[.7].#3D.p<<B2Wsh;.p.+#3D..0007;.goto.applyg;#0A
..1case.F_k0g+6:..Rw(p+6);..Wp[.6].#3D.p<<B2Wsh;.p.
+#3D..0006;.goto.applyg;#0A..1case.F_k0g+5:..Rw(p+5
);..Wp[.5].#3D.p<<B2Wsh;.p.+#3D..0005;.goto.applyg;
#0A..1case.F_k0g+4:..Rw(p+4);..Wp[.4].#3D.p<<B2Wsh;
.p.+#3D..0004;.goto.applyg;#0A..1case.F_k0g+3:..Rw(
p+3);..Wp[.3].#3D.p<<B2Wsh;.p.+#3D..0003;#0A..1appl
yg:..6Wp..2#3D.W+p;#0A..16Rw(p+1);.Wp[1].#3D.pc.+.1
;#0A..16Rb(pc);.Rw(g+B[pc]);.pc..2#3D.Wg[B[pc]];#0A
..16Rw(p+2);.Wp[2].#3D.pc;#0A..16Rw(p+3);.Wp[3].#3D
.a;#0A..16if.(pc>#3D0).goto.fetch;#0A..16goto.negpc
;#0A.#0A..1case.F_k0+11:..Rw(p+11);.Wp[11].#3D.p<<B
2Wsh;.p.+#3D.11;.goto.applyk;#0A..1case.F_k0+10:..R
w(p+10);.Wp[10].#3D.p<<B2Wsh;.p.+#3D.10;.goto.apply
k;#0A..1case.F_k0+9:..1Rw(p+9);..Wp[.9].#3D.p<<B2Ws
h;.p.+#3D..0009;.goto.applyk;#0A..1case.F_k0+8:..1R
w(p+8);..Wp[.8].#3D.p<<B2Wsh;.p.+#3D..0008;.goto.ap
plyk;#0A..1case.F_k0+7:..1Rw(p+7);..Wp[.7].#3D.p<<B
2Wsh;.p.+#3D..0007;.goto.applyk;#0A..1case.F_k0+6:.
.1Rw(p+6);..Wp[.6].#3D.p<<B2Wsh;.p.+#3D..0006;.goto
.applyk;#0A..1case.F_k0+5:..1Rw(p+5);..Wp[.5].#3D.p
<<B2Wsh;.p.+#3D..0005;.goto.applyk;#0A..1case.F_k0+
4:..1Rw(p+4);..Wp[.4].#3D.p<<B2Wsh;.p.+#3D..0004;.g
oto.applyk;#0A..1case.F_k0+3:..1Rw(p+3);..Wp[.3].#3D
.p<<B2Wsh;.p.+#3D..0003;#0A..1applyk:..6Wp..2#3D.W+
p;#0A..16Rw(p+1);.Wp[1].#3D.WD.pc;#0A..16pc..2#3D.a
;#0A..16Rw(p+2);.Wp[2].#3D.pc;#0A..16Rw(p+3);.Wp[3]
.#3D.a.#3D.b;#0A..16if.(pc>#3D0).goto.fetch;#0A..16
goto.negpc;#0A#0A..1case.F_k:..4Rb(pc);.k.#3D.B[pc]
;.Rw(p+k);.Wp[k].#3D.p<<B2Wsh;.p.+#3D..k;#0A..16Wp.
.2#3D.W+p;#0A..16Rw(p+1);.Wp[1].#3D.pc.+.1;#0A..16p
c..2#3D.a;#0A..16Rw(p+2);.Wp[2].#3D.pc;#0A..16Rw(p+
3);.Wp[3].#3D.a.#3D.b;#0A..16if.(pc>#3D0).goto.fetc
h;#0A..16goto.negpc;#0A#0A..1case.F_kh:..3Rb(pc);.k
.#3D.GH(pc);.Rw(p+k);.Wp[k].#3D.p<<B2Wsh;.p.+#3D..k
;#0A..16Wp..2#3D.W+p;#0A..16Rw(p+1);.Wp[1].#3D.pc.+
.2;#0A..16pc..2#3D.a;#0A..16Rw(p+2);.Wp[2].#3D.pc;#0A
..16Rw(p+3);.Wp[3].#3D.a.#3D.b;#0A..16if.(pc>#3D0).
goto.fetch;#0A..16goto.negpc;#0A#0A..1case.F_kw:..3
Rb(pc);.k.#3D.GW(pc);.Rw(p+k);.Wp[k].#3D.p<<B2Wsh;.
p.+#3D..k;#0A..16Wp..2#3D.W+p;#0A..16Rw(p+1);.Wp[1]
.#3D.pc.+.4;#0A..16pc..2#3D.a;#0A..16Rw(p+2);.Wp[2]
.#3D.pc;#0A..16Rw(p+3);.Wp[3].#3D.a.#3D.b;#0A..16if
.(pc>#3D0).goto.fetch;#0A..16goto.negpc;#0A#0A..1ca
se.F_jeq:..1if(b#3D#3Da).{.Rb(pc);.pc.+#3D.SB[pc];.
.1goto.fetch;.}#0A..15pc++;.goto.fetch;#0A..1case.F
_jeq+1:.if(b#3D#3Da).goto.indjump;#0A..15pc++;.goto
.fetch;#0A..1case.F_jeq+2:.if(a#3D#3D0000).{.Rb(pc)
;.pc.+#3D.SB[pc];..1goto.fetch;.}#0A..15pc++;.goto.
fetch;#0A..1case.F_jeq+3:.if(a#3D#3D0000).goto.indj
ump;#0A..15pc++;.goto.fetch;#0A#0A..1case.F_jne:..1
if(b!#3Da).{.Rb(pc);.pc.+#3D.SB[pc];..1goto.fetch;.
}#0A..15pc++;.goto.fetch;#0A..1case.F_jne+1:.if(b!#3D
a).goto.indjump;#0A..15pc++;.goto.fetch;#0A..1case.
F_jne+2:.if(a!#3D0).{.Rb(pc);.pc.+#3D.SB[pc];..1got
o.fetch;.}#0A..15pc++;.goto.fetch;#0A..1case.F_jne+
3:.if(a!#3D0).goto.indjump;#0A..15pc++;.goto.fetch;
#0A#0A..1case.F_jls:..1if(b<a).{.Rb(pc);.pc.+#3D.SB
[pc];..1goto.fetch;.}#0A..15pc++;.goto.fetch;#0A..1
case.F_jls+1:.if(b<a).goto.indjump;#0A..15pc++;.got
o.fetch;#0A..1case.F_jls+2:.if(a<0).{.Rb(pc);.pc.+#3D
.SB[pc];..1goto.fetch;.}#0A..15pc++;.goto.fetch;#0A
..1case.F_jls+3:.if(a<0).goto.indjump;#0A..15pc++;.
goto.fetch;#0A#0A..1case.F_jgr:..1if(b>a).{.Rb(pc);
.pc.+#3D.SB[pc];..1goto.fetch;.}#0A..15pc++;.goto.f
etch;#0A..1case.F_jgr+1:.if(b>a).goto.indjump;#0A..
15pc++;.goto.fetch;#0A..1case.F_jgr+2:.if(a>0).{.Rb
(pc);.pc.+#3D.SB[pc];..1goto.fetch;.}#0A..15pc++;.g
oto.fetch;#0A..1case.F_jgr+3:.if(a>0).goto.indjump;
#0A..15pc++;.goto.fetch;#0A#0A..1case.F_jle:..1if(b
<#3Da).{Rb(pc);..pc.+#3D.SB[pc];..1goto.fetch;.}#0A
..15pc++;.goto.fetch;#0A..1case.F_jle+1:.if(b<#3Da)
.goto.indjump;#0A..15pc++;.goto.fetch;#0A..1case.F_
jle+2:.if(a<#3D0).{.Rb(pc);.pc.+#3D.SB[pc];..1goto.
fetch;.}#0A..15pc++;.goto.fetch;#0A..1case.F_jle+3:
.if(a<#3D0).goto.indjump;#0A..15pc++;.goto.fetch;#0A
#0A..1case.F_jge:..1if(b>#3Da).{.Rb(pc);.pc.+#3D.SB
[pc];..1goto.fetch;.}#0A..15pc++;.goto.fetch;#0A..1
case.F_jge+1:.if(b>#3Da).goto.indjump;#0A..15pc++;.
goto.fetch;#0A..1case.F_jge+2:.if(a>#3D0).{.Rb(pc);
.pc.+#3D.SB[pc];..1goto.fetch;.}#0A..15pc++;.goto.f
etch;#0A..1case.F_jge+3:.if(a>#3D0).goto.indjump;#0A
..15pc++;.goto.fetch;#0A#0A..1case.F_j:..3Rb(pc);.p
c.+#3D.SB[pc];..6goto.fetch;#0A#0A.indjump:#0A..1ca
se.F_j+1:..1Rb(pc);.pc.#3D.(pc>>0001).+.B[pc];#0A..
15Rh(pc);.pc.#3D.(pc<<0001).+.SH[pc];#0A..15goto.fe
tch;#0A#0A..1case.F_ap0+12:.Rw(p+12);.a.#3D.a.+.Wp[
12];.goto.fetch;#0A..1case.F_ap0+11:.Rw(p+11);.a.#3D
.a.+.Wp[11];.goto.fetch;#0A..1case.F_ap0+10:.Rw(p+1
0);.a.#3D.a.+.Wp[10];.goto.fetch;#0A..1case.F_ap0+9
:..Rw(p+9);..a.#3D.a.+.Wp[.9];.goto.fetch;#0A..1cas
e.F_ap0+8:..Rw(p+8);..a.#3D.a.+.Wp[.8];.goto.fetch;
#0A..1case.F_ap0+7:..Rw(p+7);..a.#3D.a.+.Wp[.7];.go
to.fetch;#0A..1case.F_ap0+6:..Rw(p+6);..a.#3D.a.+.W
p[.6];.goto.fetch;#0A..1case.F_ap0+5:..Rw(p+5);..a.
#3D.a.+.Wp[.5];.goto.fetch;#0A..1case.F_ap0+4:..Rw(
p+4);..a.#3D.a.+.Wp[.4];.goto.fetch;#0A..1case.F_ap
0+3:..Rw(p+3);..a.#3D.a.+.Wp[.3];.goto.fetch;#0A#0A
..1case.F_ap:..2Rb(pc);.Rw(p+B[pc]);..3a.+#3D.Wp[B[
pc++]];..7goto.fetch;#0A..1case.F_aph:..1Rb(pc);.Rw
(p+GH(pc));..2a.+#3D.Wp[GH(pc)];.pc.+#3D.2;.goto.fe
tch;#0A..1case.F_apw:..1Rb(pc);.Rw(p+GW(pc));..2a.+
#3D.Wp[GW(pc)];.pc.+#3D.4;.goto.fetch;#0A..1case.F_
agh:..1Rb(pc);.Rw(g+GH(pc));..2a.+#3D.Wg[GH(pc)];.p
c.+#3D.2;.goto.fetch;#0A..1case.F_ag1:..1Rb(pc);.Rw
(g+256+B[pc]);.a.+#3D.Wg1[B[pc++]];..6goto.fetch;#0A
..1case.F_ag:..2Rb(pc);.Rw(g+B[pc]);..3a.+#3D.Wg[B[
pc++]];..7goto.fetch;#0A#0A..1case.F_a0+5:.a.+#3D.5
;.goto.fetch;#0A..1case.F_a0+4:.a.+#3D.4;.goto.fetc
h;#0A..1case.F_a0+3:.a.+#3D.3;.goto.fetch;#0A..1cas
e.F_a0+2:.a.+#3D.2;.goto.fetch;#0A..1case.F_a0+1:.a
.+#3D.1;.goto.fetch;#0A..1case.F_nop:..8goto.fetch;
#0A#0A..1case.F_a:..2Rb(pc);.a.+#3D.B[pc++];..9goto
.fetch;#0A..1case.F_ah:..1Rb(pc);.a.+#3D.GH(pc);..1
pc.+#3D.2;.goto.fetch;#0A..1case.F_aw:..1Rb(pc);.a.
+#3D.GW(pc);..1pc.+#3D.4;.goto.fetch;#0A..1case.F_s
:..2Rb(pc);.a.-#3D.B[pc++];..9goto.fetch;#0A..1case
.F_sh:..1Rb(pc);.a.-#3D.GH(pc);..1pc.+#3D.2;.goto.f
etch;#0A#0A..1case.F_s0+4:.a.-#3D.4;.goto.fetch;#0A
..1case.F_s0+3:.a.-#3D.3;.goto.fetch;#0A..1case.F_s
0+2:.a.-#3D.2;.goto.fetch;#0A..1case.F_s0+1:.a.-#3D
.1;.goto.fetch;#0A#0A..1case.F_l0p0+12:.Rw(p+12);.R
w(Wp[12]+0);#0A..17b.#3D.a;.a.#3D.W[Wp[12]+0];.goto
.fetch;#0A..1case.F_l0p0+11:.Rw(p+11);.Rw(Wp[11]+0)
;#0A..17b.#3D.a;.a.#3D.W[Wp[11]+0];.goto.fetch;#0A.
.1case.F_l0p0+10:.Rw(p+10);.Rw(Wp[10]+0);#0A..17b.#3D
.a;.a.#3D.W[Wp[10]+0];.goto.fetch;#0A..1case.F_l0p0
+9:..Rw(p+9);..1Rw(Wp[9]+0);#0A..17b.#3D.a;.a.#3D.W
[Wp[.9]+0];.goto.fetch;#0A..1case.F_l0p0+8:..Rw(p+8
);..1Rw(Wp[8]+0);#0A..17b.#3D.a;.a.#3D.W[Wp[.8]+0];
.goto.fetch;#0A..1case.F_l0p0+7:..Rw(p+7);..1Rw(Wp[
7]+0);#0A..17b.#3D.a;.a.#3D.W[Wp[.7]+0];.goto.fetch
;#0A..1case.F_l0p0+6:..Rw(p+6);..1Rw(Wp[6]+0);#0A..
17b.#3D.a;.a.#3D.W[Wp[.6]+0];.goto.fetch;#0A..1case
.F_l0p0+5:..Rw(p+5);..1Rw(Wp[5]+0);#0A..17b.#3D.a;.
a.#3D.W[Wp[.5]+0];.goto.fetch;#0A..1case.F_l0p0+4:.
.Rw(p+4);..1Rw(Wp[4]+0);#0A..17b.#3D.a;.a.#3D.W[Wp[
.4]+0];.goto.fetch;#0A..1case.F_l0p0+3:..Rw(p+3);..
1Rw(Wp[3]+0);#0A..17b.#3D.a;.a.#3D.W[Wp[.3]+0];.got
o.fetch;#0A#0A..1case.F_l1p0+6:..Rw(p+6);..1Rw(Wp[6
]+1);#0A..17b.#3D.a;.a.#3D.W[Wp[.6]+1];.goto.fetch;
#0A..1case.F_l1p0+5:..Rw(p+5);..1Rw(Wp[5]+1);#0A..1
7b.#3D.a;.a.#3D.W[Wp[.5]+1];.goto.fetch;#0A..1case.
F_l1p0+4:..Rw(p+4);..1Rw(Wp[4]+1);#0A..17b.#3D.a;.a
.#3D.W[Wp[.4]+1];.goto.fetch;#0A..1case.F_l1p0+3:..
Rw(p+3);..1Rw(Wp[3]+1);#0A..17b.#3D.a;.a.#3D.W[Wp[.
3]+1];.goto.fetch;#0A#0A..1case.F_l2p0+5:..Rw(p+5);
..1Rw(Wp[5]+2);#0A..17b.#3D.a;.a.#3D.W[Wp[.5]+2];.g
oto.fetch;#0A..1case.F_l2p0+4:..Rw(p+4);..1Rw(Wp[4]
+2);#0A..17b.#3D.a;.a.#3D.W[Wp[.4]+2];.goto.fetch;#0A
..1case.F_l2p0+3:..Rw(p+3);..1Rw(Wp[3]+2);#0A..17b.
#3D.a;.a.#3D.W[Wp[.3]+2];.goto.fetch;#0A#0A..1case.
F_l3p0+4:..Rw(p+4);..1Rw(Wp[4]+3);#0A..17b.#3D.a;.a
.#3D.W[Wp[.4]+3];.goto.fetch;#0A..1case.F_l3p0+3:..
Rw(p+3);..1Rw(Wp[3]+3);#0A..17b.#3D.a;.a.#3D.W[Wp[.
3]+3];.goto.fetch;#0A#0A..1case.F_l4p0+4:..Rw(p+4);
..1Rw(Wp[4]+4);#0A..17b.#3D.a;.a.#3D.W[Wp[.4]+4];.g
oto.fetch;#0A..1case.F_l4p0+3:..Rw(p+3);..1Rw(Wp[3]
+4);#0A..17b.#3D.a;.a.#3D.W[Wp[.3]+4];.goto.fetch;#0A
#0A..1case.F_l0gh:..Rb(pc);.Rw(g+GH(pc));.Rw(Wg[GH(
pc)]+0);#0A..15b.#3D.a;.a.#3D.W[Wg[GH(pc)]+0];.pc.+
#3D.2;.goto.fetch;#0A..1case.F_l1gh:..Rb(pc);.Rw(g+
GH(pc));.Rw(Wg[GH(pc)]+1);#0A..15b.#3D.a;.a.#3D.W[W
g[GH(pc)]+1];.pc.+#3D.2;.goto.fetch;#0A..1case.F_l2
gh:..Rb(pc);.Rw(g+GH(pc));.Rw(Wg[GH(pc)]+2);#0A..15
b.#3D.a;.a.#3D.W[Wg[GH(pc)]+2];.pc.+#3D.2;.goto.fet
ch;#0A..1case.F_l0g1:..Rb(pc);.Rw(g+256+B[pc]);.Rw(
Wg1[B[pc]]+0);#0A..15b.#3D.a;.a.#3D.W[Wg1[B[pc++]]+
0];..6goto.fetch;#0A..1case.F_l1g1:..Rb(pc);.Rw(g+2
56+B[pc]);.Rw(Wg1[B[pc]]+1);#0A..15b.#3D.a;.a.#3D.W
[Wg1[B[pc++]]+1];..6goto.fetch;#0A..1case.F_l2g1:..
Rb(pc);.Rw(g+256+B[pc]);.Rw(Wg1[B[pc]]+2);#0A..15b.
#3D.a;.a.#3D.W[Wg1[B[pc++]]+2];..6goto.fetch;#0A..1
case.F_l0g:..1Rb(pc);.Rw(g+B[pc]);.Rw(Wg[B[pc]]+0);
#0A..15b.#3D.a;.a.#3D.W[Wg[B[pc++]]+0];..7goto.fetc
h;#0A..1case.F_l1g:..1Rb(pc);.Rw(g+B[pc]);.Rw(Wg[B[
pc]]+1);#0A..15b.#3D.a;.a.#3D.W[Wg[B[pc++]]+1];..7g
oto.fetch;#0A..1case.F_l2g:..1Rb(pc);.Rw(g+B[pc]);.
Rw(Wg[B[pc]]+2);#0A..15b.#3D.a;.a.#3D.W[Wg[B[pc++]]
+2];..7goto.fetch;#0A#0A..1case.F_s0gh:..Rb(pc);.Rw
(g+GH(pc));.Rw(Wg[GH(pc)]+0);#0A..15W[Wg[GH(pc)]+0]
.#3D.a;..6pc.+#3D.2;.goto.fetch;#0A..1case.F_s0g1:.
.Rb(pc);.Rw(g+256+B[pc]);.Rw(Wg1[B[pc]]+0);#0A..15W
[Wg1[B[pc++]]+0].#3D.a;..13goto.fetch;#0A..1case.F_
s0g:..1Rb(pc);.Rw(g+B[pc]);.Rw(Wg[B[pc]]+0);#0A..15
W[Wg[B[pc++]]+0].#3D.a;..14goto.fetch;#0A#0A..1case
.F_stp0+5:.Rw(p+5);.Rw(a+Wp[5]);.W[a+Wp[5]].#3D.b;.
goto.fetch;#0A..1case.F_stp0+4:.Rw(p+4);.Rw(a+Wp[4]
);.W[a+Wp[4]].#3D.b;.goto.fetch;#0A..1case.F_stp0+3
:.Rw(p+3);.Rw(a+Wp[3]);.W[a+Wp[3]].#3D.b;.goto.fetc
h;#0A#0A..1case.F_st0p0+4:.Rw(p+4);.Rw(Wp[4]+0);.W[
Wp[4]+0].#3D.a;.goto.fetch;#0A..1case.F_st0p0+3:.Rw
(p+3);.Rw(Wp[3]+0);.W[Wp[3]+0].#3D.a;.goto.fetch;#0A
#0A..1case.F_st1p0+4:.Rw(p+4);.Rw(Wp[4]+1);.W[Wp[4]
+1].#3D.a;.goto.fetch;#0A..1case.F_st1p0+3:.Rw(p+3)
;.Rw(Wp[3]+1);.W[Wp[3]+1].#3D.a;.goto.fetch;#0A..1#0A
..1case.F_rvp0+7:.Rw(p+7);.Rw(a+Wp[7]);.a.#3D.W[a+W
p[7]];.goto.fetch;#0A..1case.F_rvp0+6:.Rw(p+6);.Rw(
a+Wp[6]);.a.#3D.W[a+Wp[6]];.goto.fetch;#0A..1case.F
_rvp0+5:.Rw(p+5);.Rw(a+Wp[5]);.a.#3D.W[a+Wp[5]];.go
to.fetch;#0A..1case.F_rvp0+4:.Rw(p+4);.Rw(a+Wp[4]);
.a.#3D.W[a+Wp[4]];.goto.fetch;#0A..1case.F_rvp0+3:.
Rw(p+3);.Rw(a+Wp[3]);.a.#3D.W[a+Wp[3]];.goto.fetch;
#0A..1}#0A#0Anegpc:#0A..1res.#3D.4;../*.negative.pc
..*/.#0Aret:#0A..1Rw(regs+0);.W[regs+0]..#3D.a;..2/
*.Save.the.machine.registers..*/#0A..1Rw(regs+1);.W
[regs+1]..#3D.b;#0A..1Rw(regs+2);.W[regs+2]..#3D.c;
#0A..1Rw(regs+3);.W[regs+3]..#3D.p<<B2Wsh;#0A..1Rw(
regs+4);.W[regs+4]..#3D.g<<B2Wsh;#0A..1Rw(regs+5);.
W[regs+5]..#3D.st;#0A..1Rw(regs+6);.W[regs+6]..#3D.
pc;#0A..1Rw(regs+7);.W[regs+7]..#3D.count;#0A..1#0A
..1return.res;#0A}#0A#0A

######sysc/rastlib.c#
/*.rastlib.generates.a.relatively.compact.represent
ation.of#0A**.raster.lines.using.run.length.encodin
g#2E#0A**#0A**.K1001.S12..0081001.instruction.per.r
aster.line,.scale.12#0A**.W10B3W1345B1N..00410.whit
e.3.black.1345.white.1.black.newline#0A**.W13B3W12B
2N..6etc#0A**.#2E#2E1#0A*/#0A#0A#23include.<stdio#2E
h>#0A#23include.<stdlib#2Eh>#0A#0A/*.cintsys#2Eh.co
ntains.machine/system.dependent.#23defines..*/#0A#23
include."cintsys#2Eh"#0A#0A/*.Upb.of.address.refere
nces.buffer.*/#0A#23define.UPB.5002#0A#0Astatic.FIL
E.*rasterfile;#0Astatic.BCPLWORD.addr[UPB+1],.addp;
#0Astatic.BCPLWORD.p#3D0;#0Astatic.BCPLWORD.count#3D
1001,.scale#3D12,.fcounttrig;#0ABCPLWORD.fcount;#0A
#0Aextern.char.*b2c_str(BCPLWORD.bstr,.char.*cstr);
#0Aextern.char.*osfname(char.*name,.char.*osname);#0A
#0Astatic.void.wrline(void);#0A#0Astatic.int.initra
ster(char.*filename)#0A{.fcounttrig.#3D.count;#0A..
addp.#3D.0;#0A..fcount.#3D.0;#0A..rasterfile.#3D.fo
pen(filename,."w");#0A..fprintf(rasterfile,."K%d.S%
d\n",.count,.scale);#0A..if(rasterfile).return.0;#0A
..return.1;#0A}#0A#0A1static.int.endraster(void)#0A
{.if.(rasterfile)#0A..{.wrline();#0A..2return.fclos
e(rasterfile);./*.Return.0.if.successful.*/#0A..}#0A
..return.-1;#0A}#0A#0ABCPLWORD.setraster(BCPLWORD.n
,.BCPLWORD.val)#0A{.char.chbuf1[256];#0A..char.chbu
f2[256];#0A..switch((int)n)#0A..{.case.0:.if.(val).
#0A..10{.char.*name.#3D.b2c_str(val,.chbuf1);#0A..1
2return.initraster(osfname(name,.chbuf2));#0A..10}#0A
..2else..2return.endraster();./*.Return.0.if.succes
sful.*/#0A..10return.1;#0A..2case.1:.if(val>#3D0).c
ount.#3D.val;.return.count;#0A..2case.2:.if(val>#3D
0).scale.#3D.val;.return.scale;#0A..2case.3:.return
.0;../*.Rastering.is.available.*/#0A..}#0A..return.
0;#0A}#0A#0Avoid.sort(BCPLWORD.p,.BCPLWORD.q)#0A{.i
f(p<q)#0A..{.BCPLWORD.t;#0A..2BCPLWORD.m.#3D.addr[(
p+q)>>0001];#0A..2BCPLWORD.i#3Dp,.j#3Dq;#0A..2while
(1)#0A..2{.while(addr[i]<m).i++;#0A..4/*.all.k.in.p
#2E#2Ei-1.#3D>.addr[k]<m#0A..4**.addr[i].>#3D.m#0A.
.4*/#0A..4while(j>i.&&.addr[j]>#3Dm).j--;#0A..4/*.a
ll.k.in.j+1.#2E#2E.q.#3D>.addr[k]>#3Dm#0A..4**.j>#3D
i#0A..4*/#0A..4if(i#3D#3Dj).break;#0A..4/*.j>i.and.
addr[i]>m.and.addr[j]<m#0A..4*/#0A..4t.#3D.addr[i];
#0A..4addr[i].#3D.addr[j];#0A..4addr[j].#3D.t;#0A..
4/*.j>i.and.addr[i]<m.and.addr[j]>m#0A..4*/#0A..4i+
+;#0A..2}#0A..2sort(p,.i-1);#0A..2j.#3D.q;#0A..2whi
le(1)#0A..2{.while(i<#3Dj.&&.addr[i]#3D#3Dm).i++;#0A
..4while(addr[j]!#3Dm).j--;#0A..4if.(j<i).break;#0A
..4addr[j].#3D.addr[i];#0A..4addr[i].#3D.m;#0A..4i+
+;#0A..2}#0A..2sort(i,.q);#0A..}#0A}#0A#0Astatic.vo
id.wrline(void)#0A{.BCPLWORD.i#3D1,.k,.a#3D0,.b;#0A
..sort(1,.addp);#0A..while(i<#3Daddp.&&.addr[i]<0).
i++;#0A..#0A..while(i<#3Daddp)#0A..{.#0A..2b.#3D.ad
dr[i++];./*.addr.of.next.black.*/#0A..2k.#3D.b-a;..
5/*.white.count,.possibly.zero.*/#0A..2fprintf(rast
erfile,."W%ld",.(long)k);#0A..2a.#3D.b;./*.start.of
.next.black.region.*/#0A..2/*.find.next.white.*/#0A
..2b++;#0A..2while.(i<#3Daddp.&&.addr[i]<#3Db).b#3D
addr[i++]+1;.#0A..2k.#3D.b-a;#0A..2a.#3D.b;./*.star
t.of.next.white.region.*/#0A..2fprintf(rasterfile,.
"B%ld",.(long)k);#0A..}#0A..fprintf(rasterfile,."N\
n");#0A..addp.#3D.0;#0A..fcounttrig.+#3D.count;#0A.
.if(fcount%1004#3D#3D0000).printf("fcount.#3D.%ld\n
",.(long)fcount);#0A}#0A#0Avoid.rasterpoint(BCPLWOR
D.p)#0A{.BCPLWORD.a.#3D.p/scale;#0A..if.(addp<UPB).
addr[++addp].#3D.a;#0A/*..printf("%7ld.%7ld\n",.(lo
ng)addp,.(long)a);*/#0A..if.(fcount.>#3D.fcounttrig
).wrline();#0A}#0A#0A4

######sysc/rastlib64.c#
/*.A.new.version.of.rastlib.that.generated.a.relati
vely.compact#0A**.file.using.run.length.encoding#0A
**#0A**.K1001..0121001.instruction.per.raster.line#0A
**.W10B3W1345B1N..00410.white.3.black.1345.white.1.
black.newline#0A**.W13B3W12B2N..6etc#0A**.#2E#2E1#0A
*/#0A#0A#23include.<stdio#2Eh>#0A#23include.<stdlib
#2Eh>#0A#0A/*.cinterp#2Eh.contains.machine/system.d
ependent.#23defines..*/#0A#23include."cintsys64#2Eh
"#0A#0A/*.Upb.of.address.references.buffer.*/#0A#23
define.UPB.5002#0A#0Astatic.FILE.*rasterfile;#0Asta
tic.BCPLWORD.addr[UPB+1],.addp;#0Astatic.BCPLWORD.p
#3D0;#0Astatic.BCPLWORD.count#3D1001,.scale#3D12,.f
counttrig;#0ABCPLWORD.fcount#3D0;#0A#0Aextern.char.
*b2c_fname(BCPLWORD.bstr,.char.*cstr);#0Aextern.cha
r.*osfname(char.*name,.char.*osname);#0A#0Astatic.v
oid.wrline(void);#0A#0Astatic.int.initraster(char.*
filename)#0A{.fcounttrig.#3D.count;#0A..addp.#3D.0;
#0A..fcount.#3D.0;#0A..rasterfile.#3D.fopen(filenam
e,."w");#0A..fprintf(rasterfile,."K%".FormD.".S%".F
ormD."\n",.count,.scale);#0A..if(rasterfile).return
.0;#0A..return.1;#0A}#0A#0A1static.int.endraster(vo
id)#0A{.if.(rasterfile)#0A..{.wrline();#0A..2return
.fclose(rasterfile);.//.Return.0.if.successful#0A..
}#0A..return.-1;#0A}#0A#0ABCPLWORD.setraster(BCPLWO
RD.n,.BCPLWORD.val)#0A{.char.chbuf[256];#0A..switch
((int)n)#0A..{.case.0:.if.(val).return.initraster(o
sfname(val,.chbuf));#0A..10else..3return.endraster(
);.//.Return.0.if.successful#0A..10return.1;#0A..2c
ase.1:.if(val>#3D0).count.#3D.val;.return.count;#0A
..2case.2:.if(val>#3D0).scale.#3D.val;.return.scale
;#0A..2case.3:.return.0;..//.Rastering.is.available
#0A..}#0A}#0A#0Avoid.sort(BCPLWORD.p,.BCPLWORD.q)#0A
{.if(p<q)#0A..{.BCPLWORD.t;#0A..2BCPLWORD.m.#3D.add
r[(p+q)>>0001];#0A..2BCPLWORD.i#3Dp,.j#3Dq;#0A..2wh
ile(1)#0A..2{.while(addr[i]<m).i++;#0A..4/*.all.k.i
n.p#2E#2Ei-1.#3D>.addr[k]<m#0A..4**.addr[i].>#3D.m#0A
..4*/#0A..4while(j>i.&&.addr[j]>#3Dm).j--;#0A..4/*.
all.k.in.j+1.#2E#2E.q.#3D>.addr[k]>#3Dm#0A..4**.j>#3D
i#0A..4*/#0A..4if(i#3D#3Dj).break;#0A..4/*.j>i.and.
addr[i]>m.and.addr[j]<m#0A..4*/#0A..4t.#3D.addr[i];
#0A..4addr[i].#3D.addr[j];#0A..4addr[j].#3D.t;#0A..
4/*.j>i.and.addr[i]<m.and.addr[j]>m#0A..4*/#0A..4i+
+;#0A..2}#0A..2sort(p,.i-1);#0A..2j.#3D.q;#0A..2whi
le(1)#0A..2{.while(i<#3Dj.&&.addr[i]#3D#3Dm).i++;#0A
..4while(addr[j]!#3Dm).j--;#0A..4if.(j<i).break;#0A
..4addr[j].#3D.addr[i];#0A..4addr[i].#3D.m;#0A..4i+
+;#0A..2}#0A..2sort(i,.q);#0A..}#0A}#0A#0Astatic.vo
id.wrline(void)#0A{.BCPLWORD.i#3D1,.k,.a#3D0,.b;#0A
..sort(1,.addp);#0A..while(i<#3Daddp.&&.addr[i]<0).
i++;#0A..#0A..while(i<#3Daddp)#0A..{.#0A..2b.#3D.ad
dr[i++];./*.addr.of.next.black.*/#0A..2k.#3D.b-a;..
5/*.white.count,.possibly.zero.*/#0A..2fprintf(rast
erfile,."W%ld",.(long)k);#0A..2a.#3D.b;./*.start.of
.next.black.region.*/#0A..2/*.find.next.white.*/#0A
..2b++;#0A..2while.(i<#3Daddp.&&.addr[i]<#3Db).b#3D
addr[i++]+1;.#0A..2k.#3D.b-a;#0A..2a.#3D.b;./*.star
t.of.next.white.region.*/#0A..2fprintf(rasterfile,.
"B%ld",.(long)k);#0A..}#0A..fprintf(rasterfile,."N\
n");#0A..addp.#3D.0;#0A..fcounttrig.+#3D.count;#0A.
.if(fcount%1004#3D#3D0000).printf("fcount.#3D.%ld\n
",.(long)fcount);#0A}#0A#0Avoid.rasterpoint(BCPLWOR
D.p)#0A{.BCPLWORD.a.#3D.p/scale;#0A..if.(addp<UPB).
addr[++addp].#3D.a;#0A/*..printf("%7ld.%7ld\n",.(lo
ng)addp,.(long)a);*/#0A..if.(fcount.>#3D.fcounttrig
).wrline();#0A}#0A#0A4

######sysc/extfn.c#
/*#0AThis.contains.the.implemetation.of.the.sys(Sys
_ext,.fno,.#2E#2E1).facility#2E#0A#0A#23#234.Still.
under.development.#23#2310#0A#0AImplemented.by.Mart
in.Richards.(c).April.2014#0A#0AThis.file.can.be.mo
dified.by.users.to.provide.any.extension.to.the#0AB
CPL.library.that.the.user.would.like#2E#0A#0ABCPL.c
alls.to.this.library.are.of.the.form#0A#0Ares.:#3D.
sys(Sys_ext,.fno,.a1,.a2,.a3,.a4,#2E#2E1)#0A#0AThis
.calls.extfn(args,.g)#0Awhere.args[0].#3D.fno,.args
[1]#3Da1,#2E#2E1.etc#0Aand..1g.points.to.the.base.o
f.the.global.vector#2E#0A#0Afno#3D0..Test.that.a.ve
rsion.of.the.EXT.extension.is.available#0A..5res.is
.TRUE.if.it.is#2E#0A#0Afno#3D1.#2E#2E1#0A#0AThe.fun
ction.numbers.such.as.EXT_avail,.EXT_init.and.EXT_t
estfn.are.declared#0Aas.mainfests.in.g/ext#2Eh#0A*/
#0A#0A#23include."cintsys#2Eh"#0A#23include.<stdio#2E
h>#0A#23include.<stdlib#2Eh>#0A#0A1#23ifndef.EXTava
il#0ABCPLWORD.extfn(BCPLWORD.*args,.BCPLWORD.*g,.BC
PLWORD.*W).{#0A..printf("extfn:.EXTavail.was.not.de
fined\n");#0A..2return.0;..1//.EXT.is.not.available
#0A}#0A#23endif#0A#0A#23ifdef.EXTavail#0A//.These.m
ust.agree.with.the.declarations.in.g/ext#2Eh#0A#23d
efine.EXT_Avail..0130#0A#23define.EXT_Init..0141#0A
#23define.EXT_Testfn..0122#0A#0ABCPLWORD.extfn(BCPL
WORD.*a,.BCPLWORD.*g,.BCPLWORD.*W).{#0A..char.tmpst
r[256];#0A..int.argc.#3D.0;#0A#0A..//printf("extfn:
.EXTavail.was.defined\n");#0A#0A..//printf("extfn:.
fno#3D%d.a1#3D%d.a2#3D%d.a3#3D%d.a4#3D%d\n",#0A..//
..6a[0],.a[1],.a[2],.a[3],.a[4]);#0A#0A..switch(a[0
]).{#0A..2default:#0A..4printf("extfn:.Unknown.op:.
fno#3D%d.a1#3D%d.a2#3D%d.a3#3D%d.a4#3D%d\n",#0A..12
a[0],.a[1],.a[2],.a[3],.a[4]);#0A..4return.0;#0A#0A
..2case.EXT_Avail:.//.Return.TRUE.since.the.EXT.fea
tures.are.available#2E#0A..6return.-1;#0A#0A..2case
.EXT_Init:..//.Initialise.all.EXT.features#0A..4{.r
eturn.-1;#0A..4}#0A#0A..2case.EXT_Testfn:..//.Set.r
esult2.and.return.a.result#2E#0A..6printf("extfn:.f
no#3D%d.a1#3D%d.a2#3D%d.a3#3D%d\n",#0A..12a[0],.a[1
],.a[2],.a[3]);#0A..6g[Gn_result2].#3D.a[1]*a[2].-.
a[3];#0A..6return.a[1]*a[2].+.a[3];#0A..}#0A}#0A#23
endif#0A

######sysc/glfn.c#
/*#0AThis.contains.the.implemetation.of.the.sys(Sys
_sd,.fno,.#2E#2E1).facility#2E#0A#0A#23#234.Still.u
nder.development.#23#2310#0A#0AImplemented.by.Marti
n.Richards.(c).Feb.2014#0A#0AThis.file.is.planned.t
o.provide.and.interface.to.either.OpenGL.using.SDL.
or#0AOpenGL.ES.using.EGL.(typically.for.the.Raspber
ry.Pi)#2E..To.hide.the.differences#0Abetween.these.
two.versions.of.OpenGL,.BCPL.programs.should.use.th
e.g/gl#2Eb#0Alibrary.with.the.g/gl#2Eh.header.file#2E
#0A#0ASDLavail.is.defined.only.if.the.SDL.libraries
.are.available#0AGLavail.is.defined.if.OpenGL.or.Op
enGL.ES.libraries.are.available#2E#0AEGLavail.is.de
fined.if.the.EGL.libraries.are.available#0A#0AWhich
ever.version.of.OpenGL.is.used.the.BCPL.interface.u
sing#0A#0Ares.:#3D.sys(Sys_gl,.fno,.a1,.a2,.a3,.a4,
#2E#2E1)#0A#0Ais.the.same#2E#0A#0ANote.that.this.ca
lls.glfn(args,.g)#0Awhere.args[0].#3D.fno,.args[1]#3D
a1,#2E#2E1.etc#0Aand..1g.points.to.the.base.of.the.
global.vector#2E#0A#0Afno#3D0..Test.that.a.version.
of.OpenGL.is.available#0A..5res.is.TRUE.if.it.is#2E
#0A#0Afno#3D1.#2E#2E1#0A*/#0A#0A#23include."cintsys
#2Eh"#0A#23include.<stdio#2Eh>#0A#23include.<stdlib
#2Eh>#0A#0Atypedef.union.FN.{#0A..BCPLWORD.i;#0A..f
loat.f;#0A}.FN;#0A#0A#23ifndef.GLavail#0ABCPLWORD.g
lfn(BCPLWORD.*args,.BCPLWORD.*g,.BCPLWORD.*W).{#0A.
.//printf("glfn:.GLavail.was.not.defined\n");#0A..2
return.0;..1//.GL.is.not.available#0A}#0A#23endif#0A
#0A#23ifdef.GLavail#0A#0A#23ifndef.EGLavail#0A//.In
clude.SDL.headers.if.not.using.EGL#0A#23ifdef.forWI
N32#0A#23include.<SDL#2Eh>#0A#23else#0A#23include.<
SDL/SDL#2Eh>#0A#23endif#0A#23endif#0A#0A//.OpenGL.o
r.OpenGL.ES.headers#0A#23ifdef.forRaspiGL#0A#23incl
ude."bcm_host#2Eh"#0A#23include."GLES/gl#2Eh"#0A#23
else#0A#23include.<GL/gl#2Eh>#0A//#23include.<GL/gl
u#2Eh>#0A//#23include.<GL/glut#2Eh>#0A#23endif#0A#23
endif#0A#0A#23ifdef.EGLavail#0A//.EGL.headers#0A#23
ifdef.forRaspiGL#0A#23include."EGL/egl#2Eh"#0A#23in
clude."EGL/eglext#2Eh"#0A#23else#0A#23include.<EGL/
egl#2Eh>#0A#23endif#0A#23endif#0A#0A#23ifdef.GLavai
l#0A//.These.must.agree.with.the.declarations.in.g/
gl#2Eh#0A#23define.gl_Init..0141#0A#23define.gl_Set
FltScale..0072#0A#23define.gl_Quit..0143#0A#23defin
e.gl_GetError..0104#0A#23define.gl_MkScreen..0105#0A
#23define.gl_SwapBuffers..0076#0A#23define.gl_MkPro
g..0127#0A#23define.gl_CompileVshader..0048#0A#23de
fine.gl_CompileFshader..0049#0A#23define.gl_GetAttr
ibLocation..00010#0A#23define.gl_GetUniformLocation
.11#0A#23define.gl_DeleteShader..00512#0A#23define.
gl_UseProgram..00713#0A#23define.gl_LinkProgram..00
614#0A#23define.gl_Uniform1f..00815#0A#23define.gl_
Uniform1i..00816#0A#23define.gl_Uniform2f..00817#0A
#23define.gl_Uniform2i..00818#0A#23define.gl_BindAt
tribLocation.20#0A#23define.gl_UniformMatrix4fv..00
121#0A#23define.gl_ClearColour..00622#0A#23define.g
l_ClearBuffer..00623#0A#23define.gl_M4mulM4..01024#0A
#23define.gl_pollevent..00825#0A#23define.gl_Enable
..01126#0A#23define.gl_Disable..01027#0A#23define.g
l_DepthFunc..00828#0A#23define.gl_VertexData..00729
#0A#23define.gl_DrawTriangles..00430#0A#23define.gl
_EnableVertexAttribArray.31#0A#23define.gl_DisableV
ertexAttribArray.32#0A#23define.gl_GenVertexBuffer.
.00233#0A#23define.gl_GenIndexBuffer..00334#0A#23de
fine.gl_VertexAttribPointer.35#0A#23define.gl_M4mul
V..01036#0A#0A//float.fltscale;#0A//float.invfltsca
le;#0A#0Aconst.SDL_VideoInfo*.info.#3D.NULL;#0Aint.
width.#3D.700;#0Aint.height.#3D200;#0Aint.bpp.#3D.0
;#0Aint.flags#3D0;.//.Flag.to.pass.to.SDL_SetVideoM
ode#0A#0AGLuint.glProgram;#0A#0A1BCPLWORD.decodeeve
nt(SDL_Event*e,.BCPLWORD.*ptr).{#0A..if(e).{#0A..2p
tr[0].#3D.(BCPLWORD)(e->type);#0A..2switch.(e->type
).{#0A..2default:#0A..4printf("glfn:.Unknown.event.
type.%d\n",.e->type);#0A..4return.-1;#0A#0A..2case.
SDL_ACTIVEEVENT:..4//.1#0A..4ptr[1].#3D.(BCPLWORD)(
e->active)#2Egain;..//.0.if.loss,.1.if.gain#0A..4pt
r[2].#3D.(BCPLWORD)(e->active)#2Estate;.//.0#3Dmous
e.focus,.1#3Dkeyboard.focus,#0A..42//.2#3Dminimised
#0A..4return.-1;#0A#0A..2case.SDL_KEYDOWN:..8//.2#0A
..2case.SDL_KEYUP:..10//.3#0A..4//printf("getevent:
.KEYDOWN.or.UP\n");#0A..2{.SDL_keysym.*ks.#3D.&(e->
key)#2Ekeysym;#0A..4BCPLWORD.sym.#3D.ks->sym;#0A..4
BCPLWORD.mod.#3D.ks->mod;#0A..4BCPLWORD.ch.#3D.(BCP
LWORD)(ks->unicode);#0A..4if(ch#3D#3D0000).ch.#3D.s
ym;#0A..4ptr[1].#3D.mod;#0A..4ptr[2].#3D.ch;#0A..4r
eturn.-1;#0A..2}#0A#0A..2case.SDL_MOUSEMOTION:..4//
.4#0A..4ptr[1].#3D.(BCPLWORD)(e->motion)#2Estate;#0A
..4ptr[2].#3D.(BCPLWORD)(e->motion)#2Ex;#0A..4ptr[3
].#3D.(BCPLWORD)(e->motion)#2Ey;#0A..4//printf("get
event:.MOUSEMOTION.%4d.%4d.%4d\n",.ptr[1],.ptr[2],.
ptr[3]);#0A..4return.-1;#0A#0A..2case.SDL_MOUSEBUTT
ONDOWN:..//.5#0A..2case.SDL_MOUSEBUTTONUP:..2//.6#0A
..4ptr[1].#3D.(BCPLWORD)(e->button)#2Estate;#0A..4p
tr[2].#3D.(BCPLWORD)(e->button)#2Ex;#0A..4ptr[3].#3D
.(BCPLWORD)(e->button)#2Ey;#0A..4//printf("getevent
:.MOUSEBUTTONDOWN/UP.%4d.%4d.%4d\n",.ptr[1],.ptr[2]
,.ptr[3]);#0A..4return.-1;#0A#0A..2case.SDL_JOYAXIS
MOTION:..2//.7#0A..4ptr[1].#3D.(BCPLWORD)(e->jaxis)
#2Ewhich;..//.Which.joystick#0A..4ptr[2].#3D.(BCPLW
ORD)(e->jaxis)#2Eaxis;..1//.Which.axis#0A..42//.0.#3D
.aileron#0A..42//.1.#3D.elevator#0A..42//.2.#3D.thr
ottle#0A..4ptr[3].#3D.(BCPLWORD)(e->jaxis)#2Evalue;
..//.What.value..-32768.to.+.32767#0A..4return.-1;#0A
#0A..2case.SDL_JOYBALLMOTION:..2//.8#0A..4ptr[1].#3D
.(BCPLWORD)(e->jball)#2Ewhich;..//.Which.joystick#0A
..4ptr[2].#3D.(BCPLWORD)(e->jball)#2Eball;..1//.Whi
ch.ball#0A..4ptr[3].#3D.(BCPLWORD)(e->jball)#2Exrel
;..1//.X.relative.motion#0A..4ptr[4].#3D.(BCPLWORD)
(e->jball)#2Eyrel;..1//.Y.relative.motion#0A..4retu
rn.-1;#0A#0A..2case.SDL_JOYHATMOTION:..3//.9#0A..4p
tr[1].#3D.(BCPLWORD)(e->jhat)#2Ewhich;..//.Which.jo
ystick#0A..4ptr[2].#3D.(BCPLWORD)(e->jhat)#2Ehat;..
2//.Which.hat#0A..4ptr[3].#3D.(BCPLWORD)(e->jhat)#2E
value;..//.Hat.position#0A..4return.-1;#0A#0A..2cas
e.SDL_JOYBUTTONDOWN:..2//.10#0A..2case.SDL_JOYBUTTO
NUP:..4//.11#0A..4ptr[1].#3D.(BCPLWORD)(e->jbutton)
#2Ewhich;..//.Which.joystick#0A..4ptr[2].#3D.(BCPLW
ORD)(e->jbutton)#2Ebutton;.//.Which.button#0A..4ptr
[3].#3D.(BCPLWORD)(e->jbutton)#2Estate;..//.What.st
ate#0A..4return.-1;#0A#0A..2case.SDL_QUIT:..11//.12
#0A..4return.-1;#0A#0A..2case.SDL_SYSWMEVENT:..5//.
13#0A..4return.-1;#0A#0A..2case.SDL_VIDEORESIZE:..4
//.16#0A..4ptr[1].#3D.(BCPLWORD)(e->resize)#2Ew;../
/.New.window.width#0A..4ptr[2].#3D.(BCPLWORD)(e->re
size)#2Eh;..//.New.window.height#0A..4//printf("VID
EORESIZE#3D%d\n",.SDL_VIDEORESIZE);#0A..4return.-1;
#0A#0A..2case.SDL_VIDEOEXPOSE:..4//.17#0A..4//.Scre
en.needs.to.be.redrawn#0A..4//printf("VIDEOEXPOSE#3D
%d\n",.SDL_VIDEOEXPOSE);#0A..4return.-1;#0A#0A..2ca
se.SDL_USEREVENT:..6//.24#0A..4return.-1;#0A..2}#0A
..}#0A..*ptr.#3D.0;#0A..return.0;#0A}#0A#0A1BCPLWOR
D.glfn(BCPLWORD.*a,.BCPLWORD.*g,.BCPLWORD.*W).{#0A.
.char.tmpstr[256];#0A..int.argc.#3D.0;#0A#0A..//pri
ntf("glfn:.GLavail.was.defined\n");#0A#0A..//printf
("glfn:.fno#3D%d.a1#3D%d.a2#3D%d.a3#3D%d.a4#3D%d\n"
,#0A..//..6a[0],.a[1],.a[2],.a[3],.a[4]);#0A#0A..sw
itch(a[0]).{#0A..default:#0A..2printf("glfn:.Unknow
n.op:.fno#3D%d.a1#3D%d.a2#3D%d.a3#3D%d.a4#3D%d\n",#0A
..10a[0],.a[1],.a[2],.a[3],.a[4]);#0A..2return.0;#0A
#0A..case.gl_Init:..//.Initialise.all.SDL.features#0A
..2{.int.argc.#3D.0;#0A..4//BCPLWORD.res.#3D.(BCPLW
ORD).SDL_Init(SDL_INIT_EVERYTHING);#0A..4BCPLWORD.r
es.#3D.(BCPLWORD).SDL_Init(SDL_INIT_VIDEO);#0A..4if
.(res<0).{#0A..6fprintf(stderr,."Video.initializati
on.failed:.%s\n",."error");#0A#09#09//#09SDL_GetErr
or());#0A..6return.0;#0A..6//SDL_Quit();#0A..4}#0A#0A
..4//printf("glfn:.SDL_init.returned.ok\n");#0A#0A.
.4info.#3D.SDL_GetVideoInfo();#0A..#0A..4if(.!info.
).{#0A..6fprintf(stderr,."Video.query.failed:.%s\n"
,#0A..14SDL_GetError());#0A..6SDL_Quit();#0A..6exit
(0);#0A..4}#0A#0A..4bpp.#3D.info->vfmt->BitsPerPixe
l;#0A..4//printf("bpp#3D%d\n",.bpp);#0A#0A..4SDL_GL
_SetAttribute(SDL_GL_RED_SIZE,.5);#0A..4SDL_GL_SetA
ttribute(SDL_GL_GREEN_SIZE,.5);#0A..4SDL_GL_SetAttr
ibute(SDL_GL_BLUE_SIZE,.5);#0A..4SDL_GL_SetAttribut
e(SDL_GL_DEPTH_SIZE,.16);#0A..4SDL_GL_SetAttribute(
SDL_GL_DOUBLEBUFFER,.1);#0A#0A..4return.-1;#0A..2}#0A
#0A..2//.The.following.will.probably.never.be.used#2E
#0A..2//case.gl_SetFltScale:..//.Set.the.floating.p
oint.scale.factors#0A..2//..fltscale.#3D.1001#2E0;#0A
..2//..invfltscale.#3D.1#2E0./.fltscale;#0A..2//..r
eturn.0;#0A#0A..2case.gl_Quit:..4//.Shut.down.SDL#0A
..4SDL_Quit();#0A..4return.-1;#0A#0A..4//1*#0A..2ca
se.gl_GetError:..1//.str.--.fill.str.with.BCPL.stri
ng.for.the.latest.SDL.error#0A..2{.char.*str.#3D.SD
L_GetError();#0A..4printf("sdl_GetError:.%s\n",.str
);#0A..4return.c2b_str(str,.a[1]);.//.Convert.to.BC
PL.string.format#0A..2}#0A..2//*/#0A#0A..2case.gl_M
kScreen:.//.(title,.width,.height)#0A..2{.char.tmps
tr[256];#0A..4int.i;#0A..4char.*title.#3D.(char.*)(
a[1]);#0A#0A..4width..#3D.a[2];#0A..4height.#3D.a[3
];#0A#0A..4float.ratio.#3D.(float)width./.(float)he
ight;#0A#0A..4flags.#3D.SDL_OPENGL;#0A#0A..4if(.SDL
_SetVideoMode(width,.height,.bpp,.flags)#3D#3D0000)
{#0A..6fprintf(stderr,."Video.mode.set.failed:.%s\n
",#0A..14SDL_GetError());#0A..6SDL_Quit();#0A..6exi
t(0);#0A..4}#0A#0A..4b2c_str(a[1],.tmpstr);#0A#0A..
4//printf("gl_MkScreen:.title#3D%s.width#3D%d.heigh
t#3D%d\n",#0A..4//..6tmpstr,.a[2],.a[3]);#0A..4SDL_
WM_SetCaption(tmpstr,.0);#0A#0A..4//.Enable.Unicode
.translation.of.keyboard.events#2E#0A..4SDL_EnableU
NICODE(1);#0A..4SDL_JoystickEventState(SDL_ENABLE);
#0A#0A..4//.Initialise.the.floating.point.scale.fac
tors#0A..4//fltscale.#3D.1001#2E0;#0A..4//invfltsca
le.#3D.1#2E0./.fltscale;#0A..4//printf("gl_MkScreen
:.returning.-1\n");#0A..4return.-1;#0A..2}#0A#0A..2
case.gl_MkProg:.//.()#0A..2{.GLuint.prog.#3D..glCre
ateProgram();#0A..4//printf("glfn:.glCreateProgram.
#3D>.%d\n",.prog);#0A..4return.(BCPLWORD).prog;#0A.
.2}#0A#0A..2case.gl_CompileVshader:.//.(prog,.cstr)
#0A..2{.//.Compiler.the.vertex.shader.whose.source.
is.in.the#0A..4//.C.string.cstr,.and.attach.it.to.t
he.given.GL.program#2E#0A..4GLuint.prog.#3D.(GLuint
).a[1];#0A..4const.char*.cstr.#3D.(char.*).(&W[a[2]
]);#0A#0A..4GLuint.Vshader.#3D.glCreateShader(GL_VE
RTEX_SHADER);#0A#0A..4glShaderSource(Vshader,.1,.&c
str,.NULL);#0A..4glCompileShader(Vshader);#0A#0A..4
GLint.nCompileResult.#3D.0;#0A#0A..4glGetShaderiv(V
shader,.GL_COMPILE_STATUS,.&nCompileResult);#0A#0A.
.4if(!nCompileResult)#0A..4{.int.i;#0A..6char.Log[1
024];#0A..6GLint.nLength;#0A..6glGetShaderInfoLog(V
shader,.1024,.&nLength,.Log);#0A..6for(i#3D0;.i<nLe
ngth;.i++).printf("%c",.Log[i]);#0A..6printf("\n");
#0A..4}..4#0A#0A..4glAttachShader(prog,.Vshader);#0A
..4return.Vshader;#0A..2}#0A#0A..2case.gl_CompileFs
hader:.//.(prog,.cstr)#0A..2{.//.Compiler.the.fragm
ent.shader.whose.source.is.in.the#0A..4//.C.string.
cstr,.and.attach.it.to.the.given.GL.program#2E#0A..
4GLuint.prog.#3D.(GLuint).a[1];#0A..4const.char*.cs
tr.#3D.(char.*).(&W[a[2]]);#0A..4GLuint.Fshader.#3D
.glCreateShader(GL_FRAGMENT_SHADER);#0A#0A..4glShad
erSource(Fshader,.1,.&cstr,.NULL);#0A..4glCompileSh
ader(Fshader);#0A#0A..4GLint.nCompileResult.#3D.0;#0A
#0A..4glGetShaderiv(Fshader,.GL_COMPILE_STATUS,.&nC
ompileResult);#0A#0A..4if(!nCompileResult)#0A..4{.i
nt.i;#0A..6char.Log[1024];#0A..6GLint.nLength#3D20;
#0A..6glGetShaderInfoLog(Fshader,.1024,.&nLength,.L
og);#0A..6for(i#3D0;.i<nLength;.i++).printf("%c",.L
og[i]);#0A..6printf("\n");#0A..4}..4#0A#0A..4glAtta
chShader(prog,.Fshader);#0A..4return.Fshader;#0A..2
}#0A#0A..2case.gl_LinkProgram:.//.(prog)#0A..2{.GLu
int.prog.#3D.(GLuint)a[1];#0A..4glLinkProgram(prog)
;#0A#0A..4GLint.nLinkResult.#3D.0;#0A#0A..4glGetPro
gramiv(prog,.GL_LINK_STATUS,.&nLinkResult);#0A#0A..
4if(!nLinkResult)#0A..4{.int.i;#0A..6char.Log[1024]
;#0A..6GLint.nLength;#0A..6glGetProgramInfoLog(prog
,.1024,.&nLength,.Log);#0A..6for(i#3D0;.i<nLength;.
i++).printf("%c",.Log[i]);#0A..6printf("\n");#0A..4
}#0A..4//printf("glfn:.gl_LinkProgram.returning.-1\
n");#0A..4return.-1;#0A..2}#0A#0A..2case.gl_BindAtt
ribLocation:.//.(prog,.loc,.name)#0A..2{.//.Specify
.the.location.of.an.attribute.before.linking#0A..4G
Luint.prog.#3D.(GLuint).a[1];#0A..4GLuint.loc..#3D.
(GLuint).a[2];#0A..4b2c_str(a[3],.tmpstr);#0A..4pri
ntf("glfn:.BindAttribLocation.prog#3D%d.loc#3D%d.na
me#3D%s\n",.prog,.loc,.tmpstr);#0A..4return.(BCPLWO
RD).glBindAttribLocation(prog,.loc,.tmpstr);#0A..2}
#0A#0A..2case.gl_Uniform1f:.//.(loc,.value)#0A..2{.
//.Find.out.where.the.linker.put.a.uniform.variable
#0A..4FN.x;#0A..4GLuint..loc..1#3D.(GLuint).a[1];#0A
..4x#2Ei.#3D.a[2];#0A..4//printf("glfn:.Uniform1f.l
oc#3D%7d.value#3D%6#2E3g\n",.loc,.x#2Ef);#0A..4retu
rn.(BCPLWORD).glUniform1f(loc,.x#2Ef);#0A..2}#0A#0A
..2case.gl_GetAttribLocation:.//.(prog,.name)#0A..2
{.//.Find.out.where.the.linker.put.an.attribute.var
iable#0A..4GLuint.prog.#3D.(GLuint).a[1];#0A..4b2c_
str(a[2],.tmpstr);#0A..4//printf("glfn:.GetAttribLo
cation.prog#3D%d.name#3D%s\n",.prog,.tmpstr);#0A..4
return.(BCPLWORD).glGetAttribLocation(prog,.tmpstr)
;#0A..2}#0A#0A..2case.gl_GetUniformLocation:.//.(pr
og,.name)#0A..2{.//.Find.out.where.the.linker.put.a
.uniform.variable#0A..4GLuint.prog.#3D.(GLuint).a[1
];#0A..4b2c_str(a[2],.tmpstr);#0A..4//printf("glfn:
.GetAttribLocation.prog#3D%d.name#3D%s\n",.prog,.tm
pstr);#0A..4return.(BCPLWORD).glGetUniformLocation(
prog,.tmpstr);#0A..2}#0A#0A..2case.gl_UniformMatrix
4fv:.//.(loc,.prog,.matrix).--.4x4.matrix#0A..2{.#0A
..4GLuint.loc.#3D.(GLuint).a[1];#0A..4GLuint.prog.#3D
.(GLuint).a[2];#0A..4float.*matrix.#3D.(float.*).(&
W[a[3]]);#0A..4int.i;#0A..4//for(i#3D0;.i<16;.i++).
printf("%9#2E3f\n",.matrix[i]);#0A..4return.(BCPLWO
RD).glUniformMatrix4fv(loc,.prog,.GL_FALSE,.matrix)
;#0A..2}#0A#0A..2case.gl_DeleteShader:.//.(shader)#0A
..2{.GLuint.shader.#3D.(GLuint).a[1];#0A..4glDelete
Shader(shader);#0A..4return.-1;#0A..2}#0A#0A..2case
.gl_UseProgram:.//.(prog)#0A..2{.GLuint.prog.#3D.(G
Luint)a[1];#0A..4glUseProgram(prog);#0A..4return.-1
;#0A..2}#0A#0A..2case.gl_Enable:.//.(op)#0A..2{.GLi
nt.op.#3D.(GLint)a[1];#0A..4glEnable(op);#0A..4retu
rn.-1;#0A..2}#0A#0A..2case.gl_Disable:.//.(op)#0A..
2{.GLint.op.#3D.(GLint)a[1];#0A..4glDisable(op);#0A
..4return.-1;#0A..2}#0A#0A..2case.gl_DepthFunc:.//.
(relation)#0A..2{.GLint.relation.#3D.(GLint)a[1];#0A
..4glDepthFunc(relation);#0A..4return.-1;#0A..2}#0A
#0A..2case.gl_VertexData:.//.(loc,.n,.stride,.datav
))#0A..2{.//.datav<32.the.a.vertex.object.is.being.
used.and.datav.is.an.offset#0A..4//.The.are.n.verte
x.items.each.containing.stride.floating.point.numbe
rs#0A..4GLint.loc.#3D.(GLint)a[1];#0A..4GLint.n.#3D
.(GLint)a[2];#0A..4GLint.stride.#3D.(GLint)(a[3]*4)
;#0A..4GLfloat.*datav.#3D.(GLfloat.*)((0000<#3Da[4]
.&&.a[4]<32).?.(const.void.*)(a[4]*4).:.&W[a[4]]);#0A
..4int.i;#0A..4//printf("glfn:.calling.glVertexAttr
ibPointer.loc#3D%d.n#3D%d.stride#3D%d.a[4]#3D%d\n",
#0A..4//..3loc,.n,.stride,.a[4]);#0A..4//printf("gl
fn:.calling..5glVertexAttribPointer.loc#3D%d.n#3D%d
.stride#3D%d.a[4]#3D%d\n",#0A..4//..3loc,.n,.a[3],.
a[4]);#0A#0A..4glVertexAttribPointer(loc,#0A..26n,.
GL_FLOAT,..1//.n.elements.of.type.float#0A..26GL_FA
LSE,..4//.Do.not.normalise#0A..26stride,..6//.Strid
e#0A..26datav);#0A..4glEnableVertexAttribArray(loc)
;#0A..4//printf("glfn:.gl_VertexData.loc#3D%d.n#3D%
d.stride#3D%d\n",.loc,.n,.stride);#0A..4//for(i.#3D
.0;.i<3;.i++).printf("%3d:.%5#2E3f\n",.i,.datav[i])
;#0A..4//printf("glfn:.returned.from.glVertexAttrib
Pointer.loc#3D%d.n#3D%d.stride#3D%d.a[4]#3D%d\n",#0A
..4//..3loc,.n,.a[3],.a[4]);#0A..4return.-1;#0A..2}
#0A#0A..2case.gl_DrawTriangles:.//.(n,.indexv)#0A..
4//.n.#3D.number.of.index.values.(.ie.3*n/3.triangl
es)#0A..4//.indexv.is.a.vector.of.16-bit.integers#2E
#0A..4//.If.indexv#3D0.objects.are.being.used#0A..2
{.GLint.n.#3D.(GLint)(a[1]);.//.Number.of.index.val
ues#0A..4GLushort.*datav.#3D.(GLushort.*)(a[2].?.&W
[a[2]]:.0);#0A#0A..4//printf("glfn:.gl_DrawTriangle
s.n#3D%d.a[2]#3D%d\n",.n,.a[2]);#0A..4//int.i;#0A..
4//for(i#3D0;.i<24;.i++)#0A..4//..printf("glfn:.Dra
wTriangles.i#3D%2d..datav[i]#3D%d\n",.i,.datav[i]);
#0A..4glDrawElements(GL_TRIANGLES,#0A..19n,..15//.N
umber.of.vertices#0A..19GL_UNSIGNED_SHORT,.//.Type.
of.index.elements#0A..19datav);..10//.Index.data#0A
..4//printf("glfn:.returned.from.gl_DrawTriangles.n
#3D%d\n",.n);#0A..4return.-1;#0A..2}#0A#0A..2case.g
l_EnableVertexAttribArray:.//.(attrib)#0A..2{.GLint
.attrib.#3D.(GLint)(a[1]);#0A..4//printf("glfn:.Ena
bleVertexAttribArray(%d)\n",.attrib);#0A..4glEnable
VertexAttribArray(attrib);#0A..4return.-1;#0A..2}#0A
#0A..2case.gl_DisableVertexAttribArray:.//.(attrib)
#0A..2{.GLint.attrib.#3D.(GLint)(a[1]);#0A..4printf
("glfn:.DisableVertexAttribArray(%d)\n",.attrib);#0A
..4glDisableVertexAttribArray(attrib);#0A..4return.
-1;#0A..2}#0A#0A..2case.gl_GenVertexBuffer:.//.(siz
e,.data)#0A..2{.GLint.size.#3D.(GLint)a[1];.//.Numb
er.of.floats#0A..4GLfloat.*data.#3D.(GLfloat.*)&W[a
[2]];#0A..4GLuint.buffer;#0A..4glGenBuffers(1,.&buf
fer);#0A..4glBindBuffer(GL_ARRAY_BUFFER,.buffer);#0A
..4glBufferData(GL_ARRAY_BUFFER,..6//.Copy.vertex.d
ata.to.graphics.memory#0A..17size.*.sizeof(GLfloat)
,.//.The.size.of.data.in.bytes#0A..17data,..17//.Th
e.vertex.data#0A..17GL_STATIC_DRAW);..6//.Usage.hin
t#0A..4return.(BCPLWORD)buffer;#0A..2}#0A#0A..2case
.gl_GenIndexBuffer:.//.(data,.size)#0A..2{.GLushort
.*data.#3D.(GLushort.*)&W[a[1]];#0A..4GLint.size.#3D
.(GLint)a[2];.//.Number.of.16-bit.indices#0A..4GLui
nt.buffer;#0A..4//int.i;#0A..4//for(i#3D0;.i<size;.
i++).printf("glfn:.i#3D%2d.index#3D%3d\n",.i,.data[
i]);#0A..4glGenBuffers(1,.&buffer);#0A..4glBindBuff
er(GL_ELEMENT_ARRAY_BUFFER,.buffer);#0A..4glBufferD
ata(GL_ELEMENT_ARRAY_BUFFER,.//.Copy.index.data.to.
graphics.memory#0A..17size.*.sizeof(GLushort),.//.T
he.size.index.data.in.bytes#0A..17data,..18//.The.v
ertex.data#0A..17GL_STATIC_DRAW);..7//.Usage.hint#0A
..4return.(BCPLWORD)buffer;#0A..2}#0A#0A..2case.gl_
ClearColour:.//.(r,.g,.b,.a)#0A..4glClearColor(a[1]
/255#2E0f,.a[2]/255#2E0f,.a[3]/255#2E0f,.a[4]/255#2E
0f);#0A..4return.-1;#0A#0A..2case.gl_ClearBuffer:./
/.()#0A..4glClear(GL_COLOR_BUFFER_BIT.|.GL_DEPTH_BU
FFER_BIT);#0A..4//glClear(GL_COLOR_BUFFER_BIT);#0A.
.4return.-1;#0A#0A..2case.gl_SwapBuffers:.//.()#0A.
.4SDL_GL_SwapBuffers();#0A..4return.-1;#0A#0A..case
.gl_pollevent:..2//.(pointer).to.[type,.args,.#2E#2E
1.].to.hold.details.of#0A#09#091//.the.next.event#0A
..2{.SDL_Event.test_event;#0A..4if.(SDL_PollEvent(&
test_event))#0A..4{.decodeevent(&test_event,.&W[a[1
]]);#0A..6return.-1;#0A..4}#0A..4decodeevent(0,.&W[
a[1]]);#0A..4return.0;#0A..2}#0A#0A..2case.gl_M4mul
M4:.//.(A,.B,.C).performs.C.:#3D.A.*.B#0A..2{.float
.*A.#3D.(float.*)(&W[a[1]]);#0A..4float.*B.#3D.(flo
at.*)(&W[a[2]]);#0A..4float.*C.#3D.(float.*)(&W[a[3
]]);#0A..4float.a00#3DA[.0],.a10#3DA[.1],.a20#3DA[.
2],.a30#3DA[.3];#0A..4float.a01#3DA[.4],.a11#3DA[.5
],.a21#3DA[.6],.a31#3DA[.7];#0A..4float.a02#3DA[.8]
,.a12#3DA[.9],.a22#3DA[10],.a32#3DA[11];#0A..4float
.a03#3DA[12],.a13#3DA[13],.a23#3DA[14],.a33#3DA[15]
;#0A#0A..4float.b00#3DB[.0],.b10#3DB[.1],.b20#3DB[.
2],.b30#3DB[.3];#0A..4float.b01#3DB[.4],.b11#3DB[.5
],.b21#3DB[.6],.b31#3DB[.7];#0A..4float.b02#3DB[.8]
,.b12#3DB[.9],.b22#3DB[10],.b32#3DB[11];#0A..4float
.b03#3DB[12],.b13#3DB[13],.b23#3DB[14],.b33#3DB[15]
;#0A#0A..4//printf("gl_M4mulM4:.entered.%d.%d.%d\n"
,.a[1],.a[2],.a[3]);#0A#0A..4//printf("%8#2E3f.%8#2E
3f.%8#2E3f.%8#2E3f.\n",..1a00,.a01,.a02,.a03);#0A..
4//printf("%8#2E3f.%8#2E3f.%8#2E3f.%8#2E3f.\n",..1a
10,.a11,.a12,.a13);#0A..4//printf("%8#2E3f.%8#2E3f.
%8#2E3f.%8#2E3f.\n",..1a20,.a21,.a22,.a23);#0A..4//
printf("%8#2E3f.%8#2E3f.%8#2E3f.%8#2E3f.\n\n",.a30,
.a31,.a32,.a33);#0A#0A..4//printf("%8#2E3f.%8#2E3f.
%8#2E3f.%8#2E3f.\n",..1b00,.b01,.b02,.b03);#0A..4//
printf("%8#2E3f.%8#2E3f.%8#2E3f.%8#2E3f.\n",..1b10,
.b11,.b12,.b13);#0A..4//printf("%8#2E3f.%8#2E3f.%8#2E
3f.%8#2E3f.\n",..1b20,.b21,.b22,.b23);#0A..4//print
f("%8#2E3f.%8#2E3f.%8#2E3f.%8#2E3f.\n\n",.b30,.b31,
.b32,.b33);#0A#0A..4C[.0].#3D.a00*b00.+.a01*b10.+.a
02*b20.+.a03*b30;.//.c00#0A..4C[.1].#3D.a10*b00.+.a
11*b10.+.a12*b20.+.a13*b30;.//.c10#0A..4C[.2].#3D.a
20*b00.+.a21*b10.+.a22*b20.+.a23*b30;.//.c20#0A..4C
[.3].#3D.a30*b00.+.a31*b10.+.a32*b20.+.a33*b30;.//.
c30#0A#0A..4C[.4].#3D.a00*b01.+.a01*b11.+.a02*b21.+
.a03*b31;.//.c01#0A..4C[.5].#3D.a10*b01.+.a11*b11.+
.a12*b21.+.a13*b31;.//.c11#0A..4C[.6].#3D.a20*b01.+
.a21*b11.+.a22*b21.+.a23*b31;.//.c21#0A..4C[.7].#3D
.a30*b01.+.a31*b11.+.a32*b21.+.a33*b31;.//.c31#0A#0A
..4C[.8].#3D.a00*b02.+.a01*b12.+.a02*b22.+.a03*b32;
.//.c02#0A..4C[.9].#3D.a10*b02.+.a11*b12.+.a12*b22.
+.a13*b32;.//.c12#0A..4C[10].#3D.a20*b02.+.a21*b12.
+.a22*b22.+.a23*b32;.//.c22#0A..4C[11].#3D.a30*b02.
+.a31*b12.+.a32*b22.+.a33*b32;.//.c32#0A#0A..4C[12]
.#3D.a00*b03.+.a01*b13.+.a02*b23.+.a03*b33;.//.c03#0A
..4C[13].#3D.a10*b03.+.a11*b13.+.a12*b23.+.a13*b33;
.//.c13#0A..4C[14].#3D.a20*b03.+.a21*b13.+.a22*b23.
+.a23*b33;.//.c23#0A..4C[15].#3D.a30*b03.+.a31*b13.
+.a32*b23.+.a33*b33;.//.c33#0A#0A..4//printf("%8#2E
3f.%8#2E3f.%8#2E3f.%8#2E3f.\n",..1C[0],.C[4],.C[.8]
,.C[12]);#0A..4//printf("%8#2E3f.%8#2E3f.%8#2E3f.%8
#2E3f.\n",..1C[1],.C[5],.C[.9],.C[13]);#0A..4//prin
tf("%8#2E3f.%8#2E3f.%8#2E3f.%8#2E3f.\n",..1C[2],.C[
6],.C[10],.C[14]);#0A..4//printf("%8#2E3f.%8#2E3f.%
8#2E3f.%8#2E3f.\n\n",.C[3],.C[7],.C[11],.C[15]);#0A
..4return.0;#0A..2}#0A#0A..2case.gl_M4mulV:.//.(A,.
B,.C).performs.C.:#3D.A.*.B#0A..18//.where.A.is.a.4
x4.matrix.and.B.and.C.are#0A..18//.4.element.vector
s#2E.B.and.C.need.not.be.distinct#2E#0A..2{.float.*
A.#3D.(float.*)(&W[a[1]]);#0A..4float.*B.#3D.(float
.*)(&W[a[2]]);#0A..4float.*C.#3D.(float.*)(&W[a[3]]
);#0A..4float.a00#3DA[.0],.a10#3DA[.1],.a20#3DA[.2]
,.a30#3DA[.3];#0A..4float.a01#3DA[.4],.a11#3DA[.5],
.a21#3DA[.6],.a31#3DA[.7];#0A..4float.a02#3DA[.8],.
a12#3DA[.9],.a22#3DA[10],.a32#3DA[11];#0A..4float.a
03#3DA[12],.a13#3DA[13],.a23#3DA[14],.a33#3DA[15];#0A
#0A..4float.b0#3DB[0],.b1#3DB[1],.b2#3DB[2],.b3#3DB
[3];#0A..4C[0].#3D.a00*b0.+.a01*b1.+.a02*b2.+.a03*b
3;.//.c0#0A..4C[1].#3D.a10*b0.+.a11*b1.+.a12*b2.+.a
13*b3;.//.c1#0A..4C[2].#3D.a20*b0.+.a21*b1.+.a22*b2
.+.a23*b3;.//.c2#0A..4C[3].#3D.a30*b0.+.a31*b1.+.a3
2*b2.+.a33*b3;.//.c3#0A#0A..4return.0;#0A..2}#0A..}
#0A}#0A#23endif#0A

######sysc/sdlfn.c#
/*#0AThis.contains.the.implemetation.of.the.sys(Sys
_sdl,.fno,.#2E#2E1).facility#2E#0A#0AImplemented.by
.Martin.Richards.(c).June.2013#0A#0A00024/07/2014#0A
Began.to.add.SDL2.#0A#0A00024/09/12#0AAdded.joystic
k.events#0A#0A1Specification.of.res.:#3D.sys(Sys_sd
l,.fno,.a1,.a2,.a3,.a4,#2E#2E1)#0A#0ANote.that.this
.calls.sdlfn(args,.g)#0Awhere.args[0].#3D.fno,.args
[1]#3Da1,#2E#2E1.etc#0Aand..1g.points.to.the.base.o
f.the.global.vector#2E#0A#0Afno#3D0..Test.the.sdl.i
s.available#0A..5res.is.TRUE.if.the.sdl.features.ar
e.implemented#2E#0A#0Afno#3D1.#2E#2E1#0A*/#0A#0A#23
include."cintsys#2Eh"#0A#0Aextern.char.*b2c_str(BCP
LWORD.bstr,.char.*cstr);#0Aextern.BCPLWORD.c2b_str(
const.char.*cstr,.BCPLWORD.bstr);#0A#0A#23ifndef.SD
Lavail#0ABCPLWORD.sdlfn(BCPLWORD.*args,.BCPLWORD.*g
,.BCPLWORD.*W).{#0A..2return.0;..1//.SDL.is.not.ava
ilable#0A}#0A#23endif#0A#0A1#23ifdef.SDLavail#0A//.
SDL.is.available#0A#0A#23include.<stdio#2Eh>#0A#23i
nclude.<stdlib#2Eh>#0A#23include."sdldraw#2Eh"#0A#0A
#23ifdef.forWIN32#0A#23include.<SDL#2Eh>#0A#23else#0A
#23include.<SDL/SDL#2Eh>#0A#23endif#0A#0A//#23ifdef
.GLavail#0A//#23include.<GL/gl#2Eh>#0A//#23include.
<GL/glu#2Eh>#0A//#23endif#0A#0A//.These.must.agree.
with.the.declarations.in.g/sdl#2Eh#0A#23define.sdl_
avail..0090#0A#23define.sdl_init..0101#0A#23define.
sdl_setvideomode..0022#0A#23define.sdl_quit..0103#0A
#23define.sdl_locksurface..0034#0A#23define.sdl_unl
ocksurface..0015#0A#23define.sdl_getsurfaceinfo..00
06#0A#23define.sdl_getfmtinfo..0047#0A#23define.sdl
_geterror..0068#0A#23define.sdl_updaterect..0049#0A
#23define.sdl_loadbmp..00610#0A#23define.sdl_blitsu
rface..00211#0A#23define.sdl_setcolorkey..00212#0A#23
define.sdl_freesurface..00213#0A#23define.sdl_setal
pha..00514#0A#23define.sdl_imgload..00615#0A#23defi
ne.sdl_delay..00816#0A#23define.sdl_flip..00917#0A#23
define.sdl_displayformat..00018#0A#23define.sdl_wai
tevent..00419#0A#23define.sdl_pollevent..00420#0A#23
define.sdl_getmousestate..00021#0A#23define.sdl_loa
dwav..00622#0A#23define.sdl_freewav..00623#0A//.mor
e.to.come.#2E#2E1#0A#0A#23define.sdl_wm_setcaption.
.00024#0A#23define.sdl_videoinfo..00425#0A#23define
.sdl_maprgb..00726#0A#23define.sdl_drawline..00527#0A
#23define.sdl_drawhline..00428#0A#23define.sdl_draw
vline..00429#0A#23define.sdl_drawcircle..00330#0A#23
define.sdl_drawrect..00531#0A#23define.sdl_drawpixe
l..00432#0A#23define.sdl_drawellipse..00233#0A#23de
fine.sdl_drawfillellipse..00134#0A#23define.sdl_dra
wround..00435#0A#23define.sdl_drawfillround..00036#0A
#23define.sdl_drawfillcircle.37#0A#23define.sdl_dra
wfillrect..00138#0A#0A#23define.sdl_fillrect..00539
#0A#23define.sdl_fillsurf..00540#0A//.Joystick.func
tions#0A#23define.sdl_numjoysticks..00541#0A#23defi
ne.sdl_joystickopen..00542#0A#23define.sdl_joystick
close..00443#0A#23define.sdl_joystickname..00544#0A
#23define.sdl_joysticknumaxes..00245#0A#23define.sd
l_joysticknumbuttons.46#0A#23define.sdl_joysticknum
balls..00147#0A#23define.sdl_joysticknumhats..00248
#0A#0A#23define.sdl_joystickeventstate.49#0A#23defi
ne.sdl_getticks..00950#0A#23define.sdl_showcursor..
00751#0A#23define.sdl_hidecursor..00752#0A#23define
.sdl_mksurface..00853#0A#23define.sdl_setcolourkey.
.00554#0A#0A#23define.sdl_joystickgetbutton..00055#0A
#23define.sdl_joystickgetaxis..00256#0A#23define.sd
l_joystickgetball..00257#0A#23define.sdl_joystickge
that..00358#0A#0A#23define.gl_setvideomode..006200#0A
#23define.gl_avail..013201#0A#23define.gl_ShadeMode
l..008202#0A#23define.gl_CullFace..010203#0A#23defi
ne.gl_FrontFace..009204#0A#23define.gl_Enable..0122
05#0A#23define.gl_ClearColor..008206#0A#23define.gl
_ViewPort..010207#0A#23define.gl_MatrixMode..008208
#0A#23define.gl_LoadIdentity..006209#0A#23define.gl
u_Perspective..006210#0A#23define.gl_Clear..013211#0A
#23define.gl_Translate..009212#0A#23define.gl_Begin
..013213#0A#23define.gl_End..015214#0A#23define.gl_
Color4v..011215#0A#23define.gl_Vertex3v..010216#0A#23
define.gl_SwapBuffers..007217#0A#23define.gl_Rotate
..012218#0A#0A2BCPLWORD.decodeevent(SDL_Event*e,.BC
PLWORD.*ptr).{#0A..if(e).{#0A..2ptr[0].#3D.(BCPLWOR
D)(e->type);#0A..2switch.(e->type).{#0A..2default:#0A
..4printf("sdlfn:.Unknown.event.type.%d\n",.e->type
);#0A..4return.-1;#0A#0A..2case.SDL_ACTIVEEVENT:..4
//.1#0A..4ptr[1].#3D.(BCPLWORD)(e->active)#2Egain;.
.//.0.if.loss,.1.if.gain#0A..4ptr[2].#3D.(BCPLWORD)
(e->active)#2Estate;.//.0#3Dmouse.focus,.1#3Dkeyboa
rd.focus,#0A..42//.2#3Dminimised#0A..4return.-1;#0A
#0A..2case.SDL_KEYDOWN:..8//.2#0A..2case.SDL_KEYUP:
..10//.3#0A..2{.SDL_keysym.*ks.#3D.&(e->key)#2Ekeys
ym;#0A..4BCPLWORD.sym.#3D.ks->sym;#0A..4BCPLWORD.mo
d.#3D.ks->mod;#0A..4BCPLWORD.ch.#3D.(BCPLWORD)(ks->
unicode);#0A..4if(ch#3D#3D0000).ch.#3D.sym;#0A..4pt
r[1].#3D.mod;#0A..4ptr[2].#3D.ch;#0A..4return.-1;#0A
..2}#0A#0A..2case.SDL_MOUSEMOTION:..4//.4#0A..4ptr[
1].#3D.(BCPLWORD)(e->motion)#2Estate;#0A..4ptr[2].#3D
.(BCPLWORD)(e->motion)#2Ex;#0A..4ptr[3].#3D.(BCPLWO
RD)(e->motion)#2Ey;#0A..4return.-1;#0A#0A..2case.SD
L_MOUSEBUTTONDOWN:..//.5#0A..2case.SDL_MOUSEBUTTONU
P:..2//.6#0A..4ptr[1].#3D.(BCPLWORD)(e->button)#2Es
tate;#0A..4ptr[2].#3D.(BCPLWORD)(e->button)#2Ex;#0A
..4ptr[3].#3D.(BCPLWORD)(e->button)#2Ey;#0A..4retur
n.-1;#0A#0A..2case.SDL_JOYAXISMOTION:..2//.7#0A..4p
tr[1].#3D.(BCPLWORD)(e->jaxis)#2Ewhich;..//.Which.j
oystick#0A..4ptr[2].#3D.(BCPLWORD)(e->jaxis)#2Eaxis
;..1//.Which.axis#0A..42//.0.#3D.aileron#0A..42//.1
.#3D.elevator#0A..42//.2.#3D.throttle#0A..4ptr[3].#3D
.(BCPLWORD)(e->jaxis)#2Evalue;..//.What.value..-327
68.to.+.32767#0A..4return.-1;#0A#0A..2case.SDL_JOYB
ALLMOTION:..2//.8#0A..4ptr[1].#3D.(BCPLWORD)(e->jba
ll)#2Ewhich;..//.Which.joystick#0A..4ptr[2].#3D.(BC
PLWORD)(e->jball)#2Eball;..1//.Which.ball#0A..4ptr[
3].#3D.(BCPLWORD)(e->jball)#2Exrel;..1//.X.relative
.motion#0A..4ptr[4].#3D.(BCPLWORD)(e->jball)#2Eyrel
;..1//.Y.relative.motion#0A..4return.-1;#0A#0A..2ca
se.SDL_JOYHATMOTION:..3//.9#0A..4ptr[1].#3D.(BCPLWO
RD)(e->jhat)#2Ewhich;..//.Which.joystick#0A..4ptr[2
].#3D.(BCPLWORD)(e->jhat)#2Ehat;..2//.Which.hat#0A.
.4ptr[3].#3D.(BCPLWORD)(e->jhat)#2Evalue;..//.Hat.p
osition#0A..4return.-1;#0A#0A..2case.SDL_JOYBUTTOND
OWN:..2//.10#0A..2case.SDL_JOYBUTTONUP:..4//.11#0A.
.4ptr[1].#3D.(BCPLWORD)(e->jbutton)#2Ewhich;..//.Wh
ich.joystick#0A..4ptr[2].#3D.(BCPLWORD)(e->jbutton)
#2Ebutton;.//.Which.button#0A..4ptr[3].#3D.(BCPLWOR
D)(e->jbutton)#2Estate;..//.What.state#0A..4return.
-1;#0A#0A..2case.SDL_QUIT:..11//.12#0A..4return.-1;
#0A#0A..2case.SDL_SYSWMEVENT:..5//.13#0A..4return.-
1;#0A#0A..2case.SDL_VIDEORESIZE:..4//.16#0A..4ptr[1
].#3D.(BCPLWORD)(e->resize)#2Ew;..//.New.window.wid
th#0A..4ptr[2].#3D.(BCPLWORD)(e->resize)#2Eh;..//.N
ew.window.height#0A..4printf("VIDEORESIZE#3D%d\n",.
SDL_VIDEORESIZE);#0A..4return.-1;#0A#0A..2case.SDL_
VIDEOEXPOSE:..4//.17#0A..4//.Screen.needs.to.be.red
rawn#0A..4printf("VIDEOEXPOSE#3D%d\n",.SDL_VIDEOEXP
OSE);#0A..4return.-1;#0A#0A..2case.SDL_USEREVENT:..
6//.24#0A..4return.-1;#0A..2}#0A..}#0A..*ptr.#3D.0;
#0A..return.0;#0A}#0A#0A1BCPLWORD.sdlfn(BCPLWORD.*a
,.BCPLWORD.*g,.BCPLWORD.*W).{#0A..char.tmpstr[256];
#0A#0A..//printf("sdlfn:.fno#3D%d.a1#3D%d.a2#3D%d.a
3#3D%d.a4#3D%d\n",#0A..//..6a[0],.a[1],.a[2],.a[3],
.a[4]);#0A#0A..switch(a[0]).{#0A..default:#0A..2pri
ntf("sdlfn:.Unknown.op:.fno#3D%d.a1#3D%d.a2#3D%d.a3
#3D%d.a4#3D%d\n",#0A..10a[0],.a[1],.a[2],.a[3],.a[4
]);#0A..2return.0;#0A#0A..case.sdl_avail:.//.Test.w
hether.SDL.is.available#0A..2return.-1;..2//.SDL.is
.available#0A#0A..case.gl_avail:..//.Test.whether.O
penGL.is.available#0A#23ifdef.GLavail#0A..2return.-
1;..2//.OpenGL.is.available#0A#23else#0A..2return..
0000;..2//.OpenGL.is.not.available#0A#23endif#0A#0A
..case.sdl_init:..//.Initialise.all.SDL.features#0A
..{.BCPLWORD.res.#3D.(BCPLWORD).SDL_Init(SDL_INIT_E
VERYTHING);#0A..4//.Enable.Unicode.translation.of.k
eyboard.events#2E#0A..2SDL_EnableUNICODE(1);#0A..2S
DL_JoystickEventState(SDL_ENABLE);#0A..2//printf("s
dl_init\n");#0A..2return.res;#0A..}#0A#0A..case.sdl
_setvideomode:..//.width,.height,.bbp,.flags#0A..{.
SDL_Surface.*scr;#0A..2//printf("Calling.SetVideoMo
de(%d,.%d,.%d,.%8x)\n",.a[1],.a[2],.a[3],.a[4]);#0A
..2scr.#3D.SDL_SetVideoMode((int)a[1],.(int)a[2],.(
int)a[3],.(Uint32)a[4]);#0A..2SDL_Flip(scr);#0A..2r
eturn.(BCPLWORD).scr;#0A..2//return.(BCPLWORD).SDL_
SetVideoMode((int)a[1],.(int)a[2],.(int)a[3],.(Uint
32)a[4]);#0A..}#0A#0A..case.sdl_quit:..4//.Shut.dow
n.SDL#0A..2printf("sdl_quit\n");#0A..2SDL_Quit();#0A
..2return.-1;#0A#0A..case.sdl_locksurface:.//.surf#0A
..2//.Return.0.on.success#0A..2//.Return.-1.on.fail
ure#0A..2return.(BCPLWORD).SDL_LockSurface((SDL_Sur
face*).a[1]);#0A#0A..case.sdl_unlocksurface:.//.sur
f#0A..2SDL_UnlockSurface((SDL_Surface*).a[1]);#0A..
2return.0;#0A#0A..case.sdl_getsurfaceinfo:#0A..//.s
urf,.surfinfo.->.[flag,.format,.w,.h,.pitch,.pixels
,.cliprect,.refcount]#0A..{.SDL_Surface.*surf.#3D.(
SDL_Surface*)a[1];#0A..2BCPLWORD.*info.#3D.&W[a[2]]
;#0A..2info[.0].#3D.(BCPLWORD).(surf->flags);#0A..2
info[.1].#3D.(BCPLWORD).(surf->format);#0A..2info[.
2].#3D.(BCPLWORD).(surf->w);#0A..2info[.3].#3D.(BCP
LWORD).(surf->h);#0A..2info[.4].#3D.(BCPLWORD).(sur
f->pitch);#0A..2info[.5].#3D.(BCPLWORD).(surf->pixe
ls);#0A..2//info[.6].#3D.(BCPLWORD).(surf->clip_rec
t);.//.fields:.x,y,.w,.h#0A..2info[.7].#3D.(BCPLWOR
D).(surf->refcount);#0A..2//printf("getsurfaceinfo:
.format#3D%d\n",.info[1]);#0A..2return.0;..6#0A..}#0A
#0A..case.sdl_getfmtinfo:#0A..//.fmt,.pxlinfo.->.[p
alette,.bitspp,.bytespp,.rmask,.gmask,.rmask,.amask
,#0A..//..16rloss,.rshift,.gloss,.gshift,.bloss,.bs
hift,.aloss,.ashift,#0A..//..16colorkey,.alpha]#0A.
.{.SDL_PixelFormat.*fmt.#3D.(SDL_PixelFormat*)(a[1]
);#0A..2BCPLWORD.*info.#3D.&(W[a[2]]);#0A..2//print
f("getfmtinfo:.format#3D%d\n",.(BCPLWORD)fmt);#0A..
2info[.0].#3D.(BCPLWORD).(fmt->palette);#0A..2info[
.1].#3D.(BCPLWORD).(fmt->BitsPerPixel);#0A..2info[.
2].#3D.(BCPLWORD).(fmt->BytesPerPixel);#0A..2info[.
3].#3D.(BCPLWORD).(fmt->Rmask);#0A..2info[.4].#3D.(
BCPLWORD).(fmt->Gmask);#0A..2info[.5].#3D.(BCPLWORD
).(fmt->Bmask);#0A..2info[.6].#3D.(BCPLWORD).(fmt->
Amask);#0A..2info[.7].#3D.(BCPLWORD).(fmt->Rshift);
#0A..2info[.8].#3D.(BCPLWORD).(fmt->Gshift);#0A..2i
nfo[.9].#3D.(BCPLWORD).(fmt->Bshift);#0A..2info[10]
.#3D.(BCPLWORD).(fmt->Ashift);#0A..2info[11].#3D.(B
CPLWORD).(fmt->Rloss);#0A..2info[12].#3D.(BCPLWORD)
.(fmt->Gloss);#0A..2info[13].#3D.(BCPLWORD).(fmt->R
loss);#0A..2info[14].#3D.(BCPLWORD).(fmt->Aloss);#0A
..2info[15].#3D.(BCPLWORD).(fmt->colorkey);#0A..2in
fo[16].#3D.(BCPLWORD).(fmt->alpha);#0A#0A..2return.
0;..6#0A..}#0A#0A..case.sdl_geterror:..1//.str.--.f
ill.str.with.BCPL.string.for.the.latest.SDL.error#0A
..{.char.*str.#3D.SDL_GetError();#0A..2printf("sdl_
geterror:.%s\n",.str);#0A..2return.c2b_str(str,.a[1
]);.//.Convert.to.BCPL.string.format#0A..}#0A#0A..c
ase.sdl_updaterect:.//.surf,.left,.top,.right,.bott
om#0A..2return.0;..3//.Not.yet.available#0A#0A..cas
e.sdl_loadbmp:..2//.filename.of.a.#2Ebmp.image#0A..
{.char.tmpstr[256];#0A..2b2c_str(a[1],.tmpstr);#0A.
.2return.(BCPLWORD).SDL_LoadBMP(tmpstr);#0A..}#0A#0A
..case.sdl_mksurface:.//(format,.w,.h)#0A..{.SDL_Pi
xelFormat.*fmt.#3D.(SDL_PixelFormat*)(a[1]);#0A..2U
int32.rmask.#3D.fmt->Rmask;#0A..2Uint32.gmask.#3D.f
mt->Gmask;#0A..2Uint32.bmask.#3D.fmt->Bmask;#0A..2U
int32.amask.#3D.fmt->Amask;#0A..2//printf("rmask#3D
%8x.gmask#3D%8x.bmask#3D%8x.amask#3D%8x\n",.rmask,.
gmask,.bmask,.amask);#0A..2return.(BCPLWORD)SDL_Cre
ateRGBSurface(#0A..23SDL_SWSURFACE,#0A..23a[2],.a[3
],.//.Width,.Height#0A..02332,..3//.Not.using.a.pal
ette#0A..23rmask,.gmask,.bmask,.amask);#0A..}#0A#0A
..case.sdl_blitsurface:.//.src,.srcrect,.dest,.dest
rect#0A..2//printf("blitsurface:.%d,.%d,.%d,.%d)\n"
,.a[1],.a[2],.a[3],.a[4]);#0A..{.BCPLWORD.*p.#3D.&W
[a[4]];#0A..2SDL_Rect.dstrect.#3D.{p[0],p[1],p[2],p
[3]};#0A..2//printf("x#3D%d,.y#3D%d,.w#3D%d,.h#3D%d
\n",.p[0],.p[1],.p[2],.p[3]);#0A..2return.(BCPLWORD
).SDL_BlitSurface((SDL_Surface*).a[1],#0A..36(SDL_R
ect*)..0020,#0A..36(SDL_Surface*).a[3],#0A..36&dstr
ect);#0A..}#0A#0A..case.sdl_setcolourkey:.//(surf,.
key)#0A..2//.If.key#3D-1.unset.colour.key#0A..2//.o
therwise.set.colour.key.to.given.value#2E#0A..2//.k
ey.must.be.in.the.pixel.format.of.the.given.surface
#0A..2//printf("sdl_setcolourkey:.%8x\n",.a[2]);#0A
..2if(a[2]#3D#3D-1).{#0A..4return.(BCPLWORD)SDL_Set
ColorKey((SDL_Surface*)a[1],.0,.(Uint32)a[2]);#0A..
2}.else.{#0A..4return.(BCPLWORD)SDL_SetColorKey((SD
L_Surface*)a[1],.SDL_SRCCOLORKEY,.(Uint32)a[2]);#0A
..2}#0A#0A..case.sdl_freesurface:.//.surf#0A..2SDL_
FreeSurface((SDL_Surface*)a[1]);#0A..2return.0;#0A#0A
..case.sdl_setalpha:..2//.surf,.flags,.alpha#0A..2r
eturn.0;..3//.Not.yet.available#0A#0A..case.sdl_img
load:..3//.filename.--.using.the.SDL_image.library#0A
..2return.0;..3//.Not.yet.available#0A#0A..case.sdl
_delay:..5//.msecs.--.the.SDL.delay.function#0A..2S
DL_Delay((int)a[1]);#0A..2return.0;#0A#0A..case.sdl
_getticks:..2//.return.msecs.since.initialisation#0A
..2return.(BCPLWORD)SDL_GetTicks();#0A#0A..case.sdl
_showcursor:..//.Show.the.cursor#0A..2return.(BCPLW
ORD)SDL_ShowCursor(SDL_ENABLE);#0A#0A..case.sdl_hid
ecursor:..//.Hide.the.cursor#0A..2return.(BCPLWORD)
SDL_ShowCursor(SDL_DISABLE);#0A#0A..case.sdl_flip:.
.6//.surf.--.Double.buffered.update.of.the.screen#0A
..2return.(BCPLWORD).SDL_Flip((SDL_Surface*)a[1]);#0A
#0A..case.sdl_displayformat:.//.surf.--.convert.sur
f.to.display.format#0A..2return.0;..3//.Not.yet.ava
ilable#0A#0A..case.sdl_waitevent:..2//.(pointer).to
.[type,.args,.#2E#2E1.].to.hold.details.of.the.next
.event#0A..15//.return.0.if.no.events.available#0A.
.2return.0;..3//.Not.yet.available#0A#0A..case.sdl_
pollevent:..2//.(pointer).to.[type,.args,.#2E#2E1.]
.to.hold.details.of#0A#09#091.//.the.next.event#0A.
.2{.SDL_Event.test_event;#0A..4if.(SDL_PollEvent(&t
est_event))#0A..4{.decodeevent(&test_event,.&W[a[1]
]);#0A..6return.-1;#0A..4}#0A..4decodeevent(0,.&W[a
[1]]);#0A..4return.0;#0A..2}#0A#0A..case.sdl_getmou
sestate:.//.pointer.to.[x,.y].returns.bit.pattern.o
f.buttons.currently.pressed#0A..2return.0;..3//.Not
.yet.available#0A#0A..case.sdl_loadwav:..4//.file,.
spec,.buff,.len#0A..2return.0;..3//.Not.yet.availab
le#0A#0A..case.sdl_freewav:..4//.buffer#0A..2return
.0;..3//.Not.yet.available#0A#0A..case.sdl_wm_setca
ption:..4//.surf,.string#0A..{.char.tmpstr[256];#0A
..2b2c_str(a[1],.tmpstr);#0A..2SDL_WM_SetCaption(tm
pstr,.0);#0A..2return.0;#0A..}#0A#0A..case.sdl_vide
oinfo:..4//.buffer#0A..{.const.SDL_VideoInfo*.p.#3D
.SDL_GetVideoInfo();#0A..2BCPLWORD.*info.#3D.&W[a[1
]];#0A..2info[.0].#3D.(BCPLWORD).((p->hw_available)
.|#0A..25(p->hw_available)<<0001.|#0A..25(p->blit_h
w)<<0002.|#0A..25(p->blit_hw_CC)<<0003.|#0A..25(p->
blit_hw_A)<<0004.|#0A..25(p->blit_sw)<<0005.|#0A..2
5(p->blit_sw_CC)<<0006.|#0A..25(p->blit_sw_A)<<0007
#0A..24);#0A..2info[.1].#3D.(BCPLWORD).(p->blit_fil
l);#0A..2info[.2].#3D.(BCPLWORD).(p->video_mem);#0A
..2info[.3].#3D.(BCPLWORD).(p->vfmt);#0A..2info[.4]
.#3D.(BCPLWORD).(p->vfmt->BitsPerPixel);#0A..2//pri
ntf("videoinfo:.a[2]#3D%d.%8X.%8X.%d.%d.%d\n",#0A..
2//..8a[2],.info[0],.info[1],.info[2],.info[3],.inf
o[4]);#0A.#0A..2return.0;#0A..}#0A#0A1..case.sdl_ma
prgb:..4//.format,.r,.g,.b#0A..{.#0A..2return.(BCPL
WORD).SDL_MapRGB((SDL_PixelFormat*)(a[1]),.a[2],.a[
3],.a[4]);.#0A..}#0A#0A..case.sdl_drawline:#0A..{.S
DL_Surface.*surf.#3D.(SDL_Surface*)(a[1]);#0A..2//p
rintf("\nDraw.Line:.%d.%d.%d.%d.%d.%8x\n",.a[1],.a[
2],.a[3],.a[4],.a[5],.a[6]);#0A..2Draw_Line(surf,.a
[2],.a[3],.a[4],.a[5],.a[6]);#0A..2return.0;#0A..}#0A
#0A..case.sdl_drawhline:#0A..case.sdl_drawvline:#0A
..case.sdl_drawcircle:#0A..case.sdl_drawrect:#0A..c
ase.sdl_drawpixel:#0A..case.sdl_drawellipse:#0A..ca
se.sdl_drawfillellipse:#0A..case.sdl_drawround:#0A.
.case.sdl_drawfillround:#0A..2return.0;#0A#0A..case
.sdl_drawfillcircle:#0A..{.SDL_Surface.*surf.#3D.(S
DL_Surface*)(a[1]);#0A..2Draw_FillCircle(surf,.a[2]
,.a[3],.a[4],.a[5]);#0A..2return.0;#0A..}#0A..2//..
case.sdl_drawfillrect:#0A..2//return..Draw_FillRect
((SDL_Surface*)a[1],.500,200,.50,70,.0xF0FF00000);#0A
#0A..case.sdl_fillrect:#0A..{.SDL_Rect.rect.#3D.{a[
2],a[3],a[4],a[5]};#0A..2//printf("\nfillrect:.surf
ace#3D%d.rect#3D(%d,%d,%d,%d).col#3D%8x\n",#0A..2//
..5a[1],.a[2],.a[3],.a[4],.a[5],.a[6]);#0A..2SDL_Fi
llRect((SDL_Surface*)(a[1]),.&rect,.a[6]);#0A..2ret
urn.0;#0A..}#0A#0A..case.sdl_fillsurf:#0A..2//print
f("\nfillsurf:.surface#3D%d.col#3D%8x\n",#0A..2//..
6a[1],.a[2]);#0A..2SDL_FillRect((SDL_Surface*)(a[1]
),.0,.a[2]);#0A..2return.0;#0A#0A//.Joystick.functi
ons#0A..case.sdl_numjoysticks:#0A..2return.SDL_NumJ
oysticks();#0A#0A..case.sdl_joystickopen:..5//.42.(
index).#3D>.joy#0A..2return.(BCPLWORD)SDL_JoystickO
pen(a[1]);#0A#0A..case.sdl_joystickclose:..4//.43.(
joy)#0A..2SDL_JoystickClose((SDL_Joystick.*)a[1]);#0A
..2return.0;#0A#0A..case.sdl_joystickname:..5//.44.
(index)#0A..{.const.char.*name.#3D.SDL_JoystickName
(a[1]);#0A..2return.c2b_str(name,.a[1]);#0A..}#0A#0A
..case.sdl_joysticknumaxes:..2//.45.(joy)#0A..2retu
rn.SDL_JoystickNumAxes((SDL_Joystick*)a[1]);#0A#0A.
.case.sdl_joysticknumbuttons:.//.46.(joy)#0A..2retu
rn.SDL_JoystickNumButtons((SDL_Joystick*)a[1]);#0A#0A
..case.sdl_joysticknumballs:..1//.47.(joy)#0A..2ret
urn.SDL_JoystickNumBalls((SDL_Joystick*)a[1]);#0A#0A
..case.sdl_joysticknumhats:..2//.47.(joy)#0A..2retu
rn.SDL_JoystickNumHats((SDL_Joystick*)a[1]);#0A#0A.
.case.sdl_joystickeventstate:.//00049..sdl_enable#3D
1.or.sdl_ignore#3D0#0A..2return.SDL_JoystickEventSt
ate(a[1]);#0A#0A..case.sdl_joystickgetbutton:.//.55
.(joy)#0A..2return.SDL_JoystickGetButton((SDL_Joyst
ick*)a[1],.a[2]);#0A#0A..case.sdl_joystickgetaxis:.
//.56.(joy)#0A..2return.SDL_JoystickGetAxis((SDL_Jo
ystick*)a[1],.a[2]);#0A#0A..case.sdl_joystickgethat
:.//.58.(joy)#0A..2return.SDL_JoystickGetHat((SDL_J
oystick*)a[1],.a[2]);#0A#0A..case.gl_setvideomode:.
//.200.(width,.height)#0A..{.//.Setup.minimum.bit.s
izes,.a.depth.buffer.and.double.buffering#2E#0A..2c
onst.SDL_VideoInfo*.info.#3D.NULL;#0A..2int.bpp.#3D
.0;#0A..2SDL_Surface.*scr;#0A#0A..2info.#3D.SDL_Get
VideoInfo();#0A..2if(!info).return.0;#0A..2bpp.#3D.
info->vfmt->BitsPerPixel;#0A..2printf("bpp#3D%d.wid
th#3D%d.height#3D%d\n",.bpp,.a[1],.a[2]);#0A..2SDL_
GL_SetAttribute(SDL_GL_RED_SIZE,.5);#0A..2SDL_GL_Se
tAttribute(SDL_GL_GREEN_SIZE,.5);#0A..2SDL_GL_SetAt
tribute(SDL_GL_BLUE_SIZE,.5);#0A..2SDL_GL_SetAttrib
ute(SDL_GL_DEPTH_SIZE,.16);#0A..2SDL_GL_SetAttribut
e(SDL_GL_DOUBLEBUFFER,.1);#0A..2printf("Calling.SDL
_SetVideoMode\n");#0A..2scr.#3D.SDL_SetVideoMode((i
nt)a[1],.(int)a[2],.bpp,.SDL_OPENGL);#0A..2return.(
BCPLWORD)scr;#0A..}#0A#0A#23ifdef.GLavail#0A..case.
gl_ShadeModel:#0A..2//printf("gl_ShadeModel:.a[1]#3D
%d.GL_SMOOTH#3D%d\n",.a[1],.GL_SMOOTH);#0A..2//glSh
adeModel((int)a[1]);#0A..2//glShadeModel(GL_SMOOTH)
;#0A..2return.0;#0A..case.gl_CullFace:#0A..2//print
f("gl_CullFace:.%d.GL_BACK#3D%d\n",.a[1],.GL_BACK);
#0A..2//glCullFace(a[1]);#0A..2glCullFace(GL_BACK);
#0A..2return.0;#0A..case.gl_FrontFace:#0A..2//print
f("gl_FrontFace:.%d\n",.a[1]);#0A..2//printf("..1GL
_CCW#3D%d\n",.GL_CCW);#0A..2//glFrontFace(a[1]);#0A
..2glFrontFace(GL_CCW);#0A..2return.0;#0A..case.gl_
Enable:#0A..2//printf("gl_Enable:.%d\n",.a[1]);#0A.
.2//printf("..1GL_CULLFACE#3D%d\n",.GL_CULL_FACE);#0A
..2glEnable(a[1]);#0A..2return.0;#0A..case.gl_Clear
Color:#0A..2//printf("gl_ClearColor:.%d.%d.%d.%d\n"
,.a[1],.a[2],.a[3],.a[4]);#0A..2glClearColor(a[1]/2
55#2E0,.a[2]/255#2E0,.a[3]/255#2E0,.a[4]/255#2E0);#0A
..2return.0;#0A..case.gl_ViewPort:#0A..2printf("sdl
fn:.gl_Viewport:.%d.%d.%d.%d\n",.a[1],.a[2],.a[3],.
a[4]);#0A..2glViewport(a[1],.a[2],.a[3],.a[4]);#0A.
.2//glViewport(0,.0,.800,.500);#0A..2return.0;#0A..
case.gl_MatrixMode:#0A..2//printf("gl_MatrixMode:.%
d\n",.a[1]);#0A..2//printf("..1GL_PROJECTION#3D%d\n
",.GL_PROJECTION);#0A..2//printf("..1GL_MODELVIEW#3D
%d\n",.GL_MODELVIEW);#0A..2glMatrixMode(a[1]);#0A..
2return.0;#0A..case.gl_LoadIdentity:#0A..2//printf(
"gl_LoadIdentity:\n");#0A..2glLoadIdentity();#0A..2
return.0;#0A..case.glu_Perspective:#0A..2//printf("
gl_Perspective:.%d.%d.%d.%d\n",.a[1],.a[2],.a[3],.a
[4]);#0A..2gluPerspective((1float)a[1])/1004,.((flo
at)a[2])/1004,#0A..17((float)a[3])/1001,.((float)a[
4])/1001);..#0A..2//gluPerspective(60#2E0,.800#2E0/
500#2E0,.1#2E0,.1024#2E0);#0A..2return.0;#0A..case.
gl_Clear:#0A..2//printf("gl_Clear:.#23x%8X\n",.a[1]
);#0A..2//printf("..1GL_COLOR_BUFFER_BIT#3D%8X\n",.
GL_COLOR_BUFFER_BIT);#0A..2//printf("..1GL_DEPTH_BU
FFER_BIT#3D%8X\n",.GL_DEPTH_BUFFER_BIT);#0A..2glCle
ar(a[1]);#0A..2//glClear(GL_COLOR_BUFFER_BIT.|.GL_D
EPTH_BUFFER_BIT);#0A..2return.0;#0A..case.gl_Transl
ate:#0A..2//printf("gl_Translate:.%d.%d.%d\n",.a[1]
,.a[2],.a[3]);#0A..2glTranslatef(a[1]/1001#2E0,.a[2
]/1001#2E0,.a[3]/1001#2E0);#0A..2return.0;#0A..case
.gl_Rotate:#0A..2//printf("gl_Rotate:.%d.%d.%d.%d\n
",.a[1],.a[2],.a[3],.a[4]);#0A..2glRotatef(a[1]/100
4#2E0,.a[2]/1001#2E0,.a[3]/1001#2E0,.a[4]/1001#2E0)
;#0A..2return.0;#0A..case.gl_Begin:#0A..2//printf("
gl_Begin:.%d\n",.a[1]);#0A..2//printf("..1GL_TRIANG
LES#3D%d\n",.GL_TRIANGLES);#0A..2glBegin(a[1]);#0A.
.2return.0;#0A..case.gl_End:#0A..2//printf("gl_End:
\n");#0A..2glEnd();#0A..2return.0;#0A..case.gl_Colo
r4v:#0A..2//printf("gl_Color4v:.%d\n",.a[1]);#0A..2
glColor4ub(W[a[1]],.W[a[1]+1],.W[a[1]+2],.W[a[1]+3]
);#0A..2return.0;#0A..case.gl_Vertex3v:#0A..2//prin
tf("gl_Vertex3v:.%d.->.[%d.%d.%d]\n",.a[1],.W[a[1]]
,.W[a[1]+1],.W[a[1]+2]);#0A..2glVertex3f(W[a[1]]/10
01#2E0,.W[a[1]+1]/1001#2E0,.W[a[1]+2]/1001#2E0);#0A
..2return.0;#0A..case.gl_SwapBuffers:#0A..2//printf
("gl_SwapBuffers:\n");#0A..2SDL_GL_SwapBuffers();#0A
..2return.0;#0A#23endif#0A#0A//.more.to.come.#2E#2E
1#0A#0A..}#0A}#0A#23endif#0A

######sysc/sdldrawlib.c#
/*!#0A#0AThis.has.been.modified.by.Martin.Richards.
for.use.by.the.BCPL.Cintcode.system#0A#0A1..\file.S
DL_draw#2Ec#0A..\author.Mario.Palomo.Torrero.<mpalo
mo@ihman#2Ecom>#0A..\author.Jose.M#2E.de.la.Huerga.
Fern#E1ndez#0A..\author.Pepe.Gonz#E1lez.Mora#0A..\d
ate.05-2000002#0A#0A..Drawing.primitives.for.SDL#2E
.Main.implementation.file#2E#0A#0A..This.library.is
.free.software;.you.can.redistribute.it.and/or#0A..
modify.it.under.the.terms.of.the.GNU.Library.Genera
l.Public#0A..License.as.published.by.the.Free.Softw
are.Foundation;.either#0A..version.2.of.the.License
,.or.(at.your.option).any.later.version#2E#0A#0A..T
his.library.is.distributed.in.the.hope.that.it.will
.be.useful,#0A..but.WITHOUT.ANY.WARRANTY;.without.e
ven.the.implied.warranty.of#0A..MERCHANTABILITY.or.
FITNESS.FOR.A.PARTICULAR.PURPOSE#2E..See.the.GNU#0A
..Library.General.Public.License.for.more.details#2E
#0A#0A..You.should.have.received.a.copy.of.the.GNU.
Library.General.Public#0A..License.along.with.this.
library;.if.not,.write.to.the.Free.Foundation,#0A..
Inc#2E,.59.Temple.Place,.Suite.330000,.Boston,.MA.0
2111-1307.USA#0A*/#0A#0A#23ifdef.SDLavail#0A#0A//#23
include."SDL_draw#2Eh"#0A#23include."sdldraw#2Eh"#0A
#23include.<stdio#2Eh>#0A#23include.<stdlib#2Eh>#0A
#23include.<string#2Eh>#0A#23include.<wchar#2Eh>../
*wmemset*/#0A#0A1/*.Draw_Init.is.defined.at.the.end
.*/#0Astatic.void.Draw_Init(void);#0A#0A/*#3D#3D18.
BEGIN.of.Draw_Pixel.#3D#3D20*/#0A#0A#23define.SDL_D
RAW_BPP.1#0A#23define.SDL_DRAWFUNCTION..Draw_Pixel_
1#0A#23include."draw/Draw_Pixel#2Ec"#0A#23undef.SDL
_DRAWFUNCTION#0A#23undef.SDL_DRAW_BPP#0A#0A#23defin
e.SDL_DRAW_BPP.2#0A#23define.SDL_DRAWFUNCTION..Draw
_Pixel_2#0A#23include."draw/Draw_Pixel#2Ec"#0A#23un
def.SDL_DRAWFUNCTION#0A#23undef.SDL_DRAW_BPP#0A#0A#23
define.SDL_DRAW_BPP.3#0A#23define.SDL_DRAWFUNCTION.
.Draw_Pixel_3#0A#23include."draw/Draw_Pixel#2Ec"#0A
#23undef.SDL_DRAWFUNCTION#0A#23undef.SDL_DRAW_BPP#0A
#0A#23define.SDL_DRAW_BPP.4#0A#23define.SDL_DRAWFUN
CTION..Draw_Pixel_4#0A#23include."draw/Draw_Pixel#2E
c"#0A#23undef.SDL_DRAWFUNCTION#0A#23undef.SDL_DRAW_
BPP#0A#0Astatic#0Avoid.Draw_Pixel_Init(SDL_Surface.
*super,#0A..19Sint16.x,.Sint16.y,.Uint32.color)#0A{
#0A..Draw_Init();#0A..Draw_Pixel(super,.x,.y,.color
);#0A}#0A#0Avoid.(*Draw_Pixel)(SDL_Surface.*super,#0A
..17Sint16.x,.Sint16.y,.Uint32.color).#3D.Draw_Pixe
l_Init;#0A#0A/*#3D#3D19.END.of.Draw_Pixel.#3D#3D21*
/#0A#0A/*#3D#3D18.BEGIN.of.Draw_Line.#3D#3D20*/#0A#0A
#23define.SDL_DRAW_BPP.1#0A#23define.SDL_DRAWFUNCTI
ON..Draw_Line_1#0A#23include."draw/Draw_Line#2Ec"#0A
#23undef.SDL_DRAWFUNCTION#0A#23undef.SDL_DRAW_BPP#0A
#0A#23define.SDL_DRAW_BPP.2#0A#23define.SDL_DRAWFUN
CTION..Draw_Line_2#0A#23include."draw/Draw_Line#2Ec
"#0A#23undef.SDL_DRAWFUNCTION#0A#23undef.SDL_DRAW_B
PP#0A#0A#23define.SDL_DRAW_BPP.3#0A#23define.SDL_DR
AWFUNCTION..Draw_Line_3#0A#23include."draw/Draw_Lin
e#2Ec"#0A#23undef.SDL_DRAWFUNCTION#0A#23undef.SDL_D
RAW_BPP#0A#0A#23define.SDL_DRAW_BPP.4#0A#23define.S
DL_DRAWFUNCTION..Draw_Line_4#0A#23include."draw/Dra
w_Line#2Ec"#0A#23undef.SDL_DRAWFUNCTION#0A#23undef.
SDL_DRAW_BPP#0A#0Astatic#0Avoid.Draw_Line_Init(SDL_
Surface.*super,#0A..18Sint16.x1,.Sint16.y1,.Sint16.
x2,.Sint16.y2,#0A..18Uint32.color)#0A{#0A..Draw_Ini
t();#0A..Draw_Line(super,.x1,.y1,.x2,.y2,.color);#0A
}#0A#0Avoid.(*Draw_Line)(SDL_Surface.*super,#0A..16
Sint16.x1,.Sint16.y1,.Sint16.x2,.Sint16.y2,#0A..16U
int32.color).#3D.Draw_Line_Init;#0A#0A/*#3D#3D19.EN
D.of.Draw_Line.#3D#3D21*/#0A#0A/*#3D#3D17.BEGIN.of.
Draw_Circle.#3D#3D19*/#0A#0A#23define.SDL_DRAW_BPP.
1#0A#23define.SDL_DRAWFUNCTION..Draw_Circle_1#0A#23
include."draw/Draw_Circle#2Ec"#0A#23undef.SDL_DRAWF
UNCTION#0A#23undef.SDL_DRAW_BPP#0A#0A#23define.SDL_
DRAW_BPP.2#0A#23define.SDL_DRAWFUNCTION..Draw_Circl
e_2#0A#23include."draw/Draw_Circle#2Ec"#0A#23undef.
SDL_DRAWFUNCTION#0A#23undef.SDL_DRAW_BPP#0A#0A#23de
fine.SDL_DRAW_BPP.3#0A#23define.SDL_DRAWFUNCTION..D
raw_Circle_3#0A#23include."draw/Draw_Circle#2Ec"#0A
#23undef.SDL_DRAWFUNCTION#0A#23undef.SDL_DRAW_BPP#0A
#0A#23define.SDL_DRAW_BPP.4#0A#23define.SDL_DRAWFUN
CTION..Draw_Circle_4#0A#23include."draw/Draw_Circle
#2Ec"#0A#23undef.SDL_DRAWFUNCTION#0A#23undef.SDL_DR
AW_BPP#0A#0Astatic#0Avoid.Draw_Circle_Init(SDL_Surf
ace.*super,#0A..20Sint16.x0,.Sint16.y0,.Uint16.r,#0A
..20Uint32.color)#0A{#0A..Draw_Init();#0A..Draw_Cir
cle(super,.x0,.y0,.r,.color);#0A}#0A#0A1void.(*Draw
_Circle)(SDL_Surface.*super,#0A..18Sint16.x0,.Sint1
6.y0,.Uint16.r,#0A..18Uint32.color).#3D.Draw_Circle
_Init;#0A#0A/*#3D#3D18.END.of.Draw_Circle.#3D#3D20*
/#0A#0A/*#3D#3D15.BEGIN.of.Draw_FillCircle.#3D#3D17
*/#0A#0A#23define.SDL_DRAW_BPP.1#0A#23define.SDL_DR
AWFUNCTION..Draw_FillCircle_1#0A#23include."draw/Dr
aw_FillCircle#2Ec"#0A#23undef.SDL_DRAWFUNCTION#0A#23
undef.SDL_DRAW_BPP#0A#0A#23define.SDL_DRAW_BPP.2#0A
#23define.SDL_DRAWFUNCTION..Draw_FillCircle_2#0A#23
include."draw/Draw_FillCircle#2Ec"#0A#23undef.SDL_D
RAWFUNCTION#0A#23undef.SDL_DRAW_BPP#0A#0A#23define.
SDL_DRAW_BPP.3#0A#23define.SDL_DRAWFUNCTION..Draw_F
illCircle_3#0A#23include."draw/Draw_FillCircle#2Ec"
#0A#23undef.SDL_DRAWFUNCTION#0A#23undef.SDL_DRAW_BP
P#0A#0A#23define.SDL_DRAW_BPP.4#0A#23define.SDL_DRA
WFUNCTION..Draw_FillCircle_4#0A#23include."draw/Dra
w_FillCircle#2Ec"#0A#23undef.SDL_DRAWFUNCTION#0A#23
undef.SDL_DRAW_BPP#0A#0Astatic#0Avoid.Draw_FillCirc
le_Init(SDL_Surface.*super,#0A..24Sint16.x0,.Sint16
.y0,.Uint16.r,#0A..24Uint32.color)#0A{#0A..Draw_Ini
t();#0A..Draw_FillCircle(super,.x0,.y0,.r,.color);#0A
}#0A#0A1void.(*Draw_FillCircle)(SDL_Surface.*super,
#0A..22Sint16.x0,.Sint16.y0,.Uint16.r,#0A..22Uint32
.color).#3D.Draw_FillCircle_Init;#0A#0A/*#3D#3D16.E
ND.of.Draw_FillCircle.#3D#3D18*/#0A#0A/*#3D#3D17.BE
GIN.of.Draw_HLine.#3D#3D19*/#0A#0A#23define.SDL_DRA
W_BPP.1#0A#23define.SDL_DRAWFUNCTION..Draw_HLine_1#0A
#23include."draw/Draw_HLine#2Ec"#0A#23undef.SDL_DRA
WFUNCTION#0A#23undef.SDL_DRAW_BPP#0A#0A#23define.SD
L_DRAW_BPP.2#0A#23define.SDL_DRAWFUNCTION..Draw_HLi
ne_2#0A#23include."draw/Draw_HLine#2Ec"#0A#23undef.
SDL_DRAWFUNCTION#0A#23undef.SDL_DRAW_BPP#0A#0A#23de
fine.SDL_DRAW_BPP.3#0A#23define.SDL_DRAWFUNCTION..D
raw_HLine_3#0A#23include."draw/Draw_HLine#2Ec"#0A#23
undef.SDL_DRAWFUNCTION#0A#23undef.SDL_DRAW_BPP#0A#0A
#23define.SDL_DRAW_BPP.4#0A#23define.SDL_DRAWFUNCTI
ON..Draw_HLine_4#0A#23include."draw/Draw_HLine#2Ec"
#0A#23undef.SDL_DRAWFUNCTION#0A#23undef.SDL_DRAW_BP
P#0A#0Astatic#0Avoid.Draw_HLine_Init(SDL_Surface.*s
uper,#0A..19Sint16.x0,Sint16.y0,.Sint16.x1,#0A..19U
int32.color)#0A{#0A..Draw_Init();#0A..Draw_HLine(su
per,.x0,.y0,.x1,.color);#0A}#0A#0Avoid.(*Draw_HLine
)(SDL_Surface.*super,#0A..17Sint16.x0,Sint16.y0,.Si
nt16.x1,#0A..17Uint32.color).#3D.Draw_HLine_Init;#0A
#0A/*#3D#3D18.END.of.Draw_HLine.#3D#3D20*/#0A#0A/*#3D
#3D17.BEGIN.of.Draw_VLine.#3D#3D19*/#0A#23define.SD
L_DRAW_BPP.1#0A#23define.SDL_DRAWFUNCTION..Draw_VLi
ne_1#0A#23include."draw/Draw_VLine#2Ec"#0A#23undef.
SDL_DRAWFUNCTION#0A#23undef.SDL_DRAW_BPP#0A#0A#23de
fine.SDL_DRAW_BPP.2#0A#23define.SDL_DRAWFUNCTION..D
raw_VLine_2#0A#23include."draw/Draw_VLine#2Ec"#0A#23
undef.SDL_DRAWFUNCTION#0A#23undef.SDL_DRAW_BPP#0A#0A
#23define.SDL_DRAW_BPP.3#0A#23define.SDL_DRAWFUNCTI
ON..Draw_VLine_3#0A#23include."draw/Draw_VLine#2Ec"
#0A#23undef.SDL_DRAWFUNCTION#0A#23undef.SDL_DRAW_BP
P#0A#0A#23define.SDL_DRAW_BPP.4#0A#23define.SDL_DRA
WFUNCTION..Draw_VLine_4#0A#23include."draw/Draw_VLi
ne#2Ec"#0A#23undef.SDL_DRAWFUNCTION#0A#23undef.SDL_
DRAW_BPP#0A#0Astatic#0Avoid.Draw_VLine_Init(SDL_Sur
face.*super,#0A..19Sint16.x0,Sint16.y0,.Sint16.y1,#0A
..19Uint32.color)#0A{#0A..Draw_Init();#0A..Draw_VLi
ne(super,.x0,.y0,.y1,.color);#0A}#0A#0Avoid.(*Draw_
VLine)(SDL_Surface.*super,#0A..17Sint16.x0,Sint16.y
0,.Sint16.y1,#0A..17Uint32.color).#3D.Draw_VLine_In
it;#0A#0A/*#3D#3D18.END.of.Draw_VLine.#3D#3D20*/#0A
#0A/*#3D#3D18.BEGIN.of.Draw_Rect.#3D#3D20*/#0A#0A#23
define.SDL_DRAW_BPP.1#0A#23define.SDL_DRAWFUNCTION.
.Draw_Rect_1#0A#23include."draw/Draw_Rect#2Ec"#0A#23
undef.SDL_DRAWFUNCTION#0A#23undef.SDL_DRAW_BPP#0A#0A
#23define.SDL_DRAW_BPP.2#0A#23define.SDL_DRAWFUNCTI
ON..Draw_Rect_2#0A#23include."draw/Draw_Rect#2Ec"#0A
#23undef.SDL_DRAWFUNCTION#0A#23undef.SDL_DRAW_BPP#0A
#0A#23define.SDL_DRAW_BPP.3#0A#23define.SDL_DRAWFUN
CTION..Draw_Rect_3#0A#23include."draw/Draw_Rect#2Ec
"#0A#23undef.SDL_DRAWFUNCTION#0A#23undef.SDL_DRAW_B
PP#0A#0A#23define.SDL_DRAW_BPP.4#0A#23define.SDL_DR
AWFUNCTION..Draw_Rect_4#0A#23include."draw/Draw_Rec
t#2Ec"#0A#23undef.SDL_DRAWFUNCTION#0A#23undef.SDL_D
RAW_BPP#0A#0Astatic#0Avoid.Draw_Rect_Init(SDL_Surfa
ce.*super,#0A..18Sint16.x,Sint16.y,.Uint16.w,Uint16
.h,#0A..18Uint32.color)#0A{#0A..Draw_Init();#0A..Dr
aw_Rect(super,.x,.y,.w,.h,.color);#0A}#0A#0Avoid.(*
Draw_Rect)(SDL_Surface.*super,#0A..16Sint16.x,Sint1
6.y,.Uint16.w,Uint16.h,#0A..16Uint32.color).#3D.Dra
w_Rect_Init;#0A#0Avoid.Draw_FillRect(SDL_Surface.*s
uper,.Sint16.x,.Sint16.y,.Sint16.w,.Sint16.h,.Uint3
2.color)#0A{#0A..2SDL_Rect.r.#3D.{x,.y,.w,.h};#0A..
2SDL_FillRect(super,.&r,.color);#0A}#0A#0A1/*#3D#3D
19.END.of.Draw_Rect.#3D#3D21*/#0A#0A/*#3D#3D17.BEGI
N.of.Draw_Ellipse.#3D#3D18*/#0A#0A#23define.SDL_DRA
W_BPP.1#0A#23define.SDL_DRAWFUNCTION..Draw_Ellipse_
1#0A#23include."draw/Draw_Ellipse#2Ec"#0A#23undef.S
DL_DRAWFUNCTION#0A#23undef.SDL_DRAW_BPP#0A#0A#23def
ine.SDL_DRAW_BPP.2#0A#23define.SDL_DRAWFUNCTION..Dr
aw_Ellipse_2#0A#23include."draw/Draw_Ellipse#2Ec"#0A
#23undef.SDL_DRAWFUNCTION#0A#23undef.SDL_DRAW_BPP#0A
#0A#23define.SDL_DRAW_BPP.3#0A#23define.SDL_DRAWFUN
CTION..Draw_Ellipse_3#0A#23include."draw/Draw_Ellip
se#2Ec"#0A#23undef.SDL_DRAWFUNCTION#0A#23undef.SDL_
DRAW_BPP#0A#0A#23define.SDL_DRAW_BPP.4#0A#23define.
SDL_DRAWFUNCTION..Draw_Ellipse_4#0A#23include."draw
/Draw_Ellipse#2Ec"#0A#23undef.SDL_DRAWFUNCTION#0A#23
undef.SDL_DRAW_BPP#0A#0Astatic#0Avoid.Draw_Ellipse_
Init(SDL_Surface.*super,#0A..21Sint16.x0,.Sint16.y0
,#0A..21Uint16.Xradius,.Uint16.Yradius,#0A..21Uint3
2.color)#0A{#0A..Draw_Init();#0A..Draw_Ellipse(supe
r,.x0,.y0,.Xradius,.Yradius,.color);#0A}#0A#0A1void
.(*Draw_Ellipse)(SDL_Surface.*super,#0A..19Sint16.x
0,.Sint16.y0,#0A..19Uint16.Xradius,.Uint16.Yradius,
#0A..19Uint32.color).#3D.Draw_Ellipse_Init;#0A#0A/*
#3D#3D18.END.of.Draw_Ellipse.#3D#3D19*/#0A#0A/*#3D#3D
15.BEGIN.of.Draw_FillEllipse.#3D#3D16*/#0A#0A#23def
ine.SDL_DRAW_BPP.1#0A#23define.SDL_DRAWFUNCTION..Dr
aw_FillEllipse_1#0A#23include."draw/Draw_FillEllips
e#2Ec"#0A#23undef.SDL_DRAWFUNCTION#0A#23undef.SDL_D
RAW_BPP#0A#0A#23define.SDL_DRAW_BPP.2#0A#23define.S
DL_DRAWFUNCTION..Draw_FillEllipse_2#0A#23include."d
raw/Draw_FillEllipse#2Ec"#0A#23undef.SDL_DRAWFUNCTI
ON#0A#23undef.SDL_DRAW_BPP#0A#0A#23define.SDL_DRAW_
BPP.3#0A#23define.SDL_DRAWFUNCTION..Draw_FillEllips
e_3#0A#23include."draw/Draw_FillEllipse#2Ec"#0A#23u
ndef.SDL_DRAWFUNCTION#0A#23undef.SDL_DRAW_BPP#0A#0A
#23define.SDL_DRAW_BPP.4#0A#23define.SDL_DRAWFUNCTI
ON..Draw_FillEllipse_4#0A#23include."draw/Draw_Fill
Ellipse#2Ec"#0A#23undef.SDL_DRAWFUNCTION#0A#23undef
.SDL_DRAW_BPP#0A#0Astatic#0Avoid.Draw_FillEllipse_I
nit(SDL_Surface.*super,#0A..25Sint16.x0,.Sint16.y0,
#0A..25Uint16.Xradius,.Uint16.Yradius,#0A..25Uint32
.color)#0A{#0A..Draw_Init();#0A..Draw_FillEllipse(s
uper,.x0,.y0,.Xradius,.Yradius,.color);#0A}#0A#0A1v
oid.(*Draw_FillEllipse)(SDL_Surface.*super,#0A..23S
int16.x0,.Sint16.y0,#0A..23Uint16.Xradius,.Uint16.Y
radius,#0A..23Uint32.color).#3D.Draw_FillEllipse_In
it;#0A#0A/*#3D#3D16.END.of.Draw_FillEllipse.#3D#3D1
7*/#0A#0A/*#3D#3D18.BEGIN.of.Draw_Round.#3D#3D19*/#0A
#0A#23define.SDL_DRAW_BPP.1#0A#23define.SDL_DRAWFUN
CTION..Draw_Round_1#0A#23include."draw/Draw_Round#2E
c"#0A#23undef.SDL_DRAWFUNCTION#0A#23undef.SDL_DRAW_
BPP#0A#0A#23define.SDL_DRAW_BPP.2#0A#23define.SDL_D
RAWFUNCTION..Draw_Round_2#0A#23include."draw/Draw_R
ound#2Ec"#0A#23undef.SDL_DRAWFUNCTION#0A#23undef.SD
L_DRAW_BPP#0A#0A#23define.SDL_DRAW_BPP.3#0A#23defin
e.SDL_DRAWFUNCTION..Draw_Round_3#0A#23include."draw
/Draw_Round#2Ec"#0A#23undef.SDL_DRAWFUNCTION#0A#23u
ndef.SDL_DRAW_BPP#0A#0A#23define.SDL_DRAW_BPP.4#0A#23
define.SDL_DRAWFUNCTION..Draw_Round_4#0A#23include.
"draw/Draw_Round#2Ec"#0A#23undef.SDL_DRAWFUNCTION#0A
#23undef.SDL_DRAW_BPP#0A#0Astatic#0Avoid.Draw_Round
_Init(SDL_Surface.*super,#0A..19Sint16.x0,Sint16.y0
,.Uint16.w,Uint16.h,#0A..19Uint16.corner,.Uint32.co
lor)#0A{#0A..Draw_Init();#0A..Draw_Round(super,.x0,
.y0,.w,.h,.corner,.color);#0A}#0A#0Avoid.(*Draw_Rou
nd)(SDL_Surface.*super,#0A..17Sint16.x0,Sint16.y0,.
Uint16.w,Uint16.h,#0A..17Uint16.corner,.Uint32.colo
r).#3D.Draw_Round_Init;#0A#0A/*#3D#3D19.END.of.Draw
_Round.#3D#3D20*/#0A#0A/*#3D#3D16.BEGIN.of.Draw_Fil
lRound.#3D#3D17*/#0A#0A#23define.SDL_DRAW_BPP.1#0A#23
define.SDL_DRAWFUNCTION..Draw_FillRound_1#0A#23incl
ude."draw/Draw_FillRound#2Ec"#0A#23undef.SDL_DRAWFU
NCTION#0A#23undef.SDL_DRAW_BPP#0A#0A#23define.SDL_D
RAW_BPP.2#0A#23define.SDL_DRAWFUNCTION..Draw_FillRo
und_2#0A#23include."draw/Draw_FillRound#2Ec"#0A#23u
ndef.SDL_DRAWFUNCTION#0A#23undef.SDL_DRAW_BPP#0A#0A
#23define.SDL_DRAW_BPP.3#0A#23define.SDL_DRAWFUNCTI
ON..Draw_FillRound_3#0A#23include."draw/Draw_FillRo
und#2Ec"#0A#23undef.SDL_DRAWFUNCTION#0A#23undef.SDL
_DRAW_BPP#0A#0A#23define.SDL_DRAW_BPP.4#0A#23define
.SDL_DRAWFUNCTION..Draw_FillRound_4#0A#23include."d
raw/Draw_FillRound#2Ec"#0A#23undef.SDL_DRAWFUNCTION
#0A#23undef.SDL_DRAW_BPP#0A#0Astatic#0Avoid.Draw_Fi
llRound_Init(SDL_Surface.*super,#0A..23Sint16.x0,Si
nt16.y0,.Uint16.w,Uint16.h,#0A..23Uint16.corner,.Ui
nt32.color)#0A{#0A..Draw_Init();#0A..Draw_FillRound
(super,.x0,.y0,.w,.h,.corner,.color);#0A}#0A#0Avoid
.(*Draw_FillRound)(SDL_Surface.*super,#0A..21Sint16
.x0,Sint16.y0,.Uint16.w,Uint16.h,#0A..21Uint16.corn
er,.Uint32.color).#3D.Draw_FillRound_Init;#0A#0A/*#3D
#3D17.END.of.Draw_FillRound.#3D#3D18*/#0A#0A1/*Assi
gnment.of.function.pointers:*/#0A#23define.SDL_DRAW
_FUNCTIONS_BPP(x).\#0A..4Draw_Pixel..5#3D.Draw_Pixe
l_#23#23x;..5\#0A..4Draw_Line..6#3D.Draw_Line_#23#23
x;..6\#0A..4Draw_Circle..4#3D.Draw_Circle_#23#23x;.
.4\#0A..4Draw_FillCircle..#3D.Draw_FillCircle_#23#23
x;..\#0A..4Draw_HLine..5#3D.Draw_HLine_#23#23x;..5\
#0A..4Draw_VLine..5#3D.Draw_VLine_#23#23x;..5\#0A..
4Draw_Rect..6#3D.Draw_Rect_#23#23x;..6\#0A..4Draw_E
llipse..3#3D.Draw_Ellipse_#23#23x;..3\#0A..4Draw_Fi
llEllipse.#3D.Draw_FillEllipse_#23#23x;.\#0A..4Draw
_Round..5#3D.Draw_Round_#23#23x;..5\#0A..4Draw_Fill
Round..1#3D.Draw_FillRound_#23#23x#0A#0Astatic#0Avo
id.Draw_Init(void)#0A{#0A..SDL_Surface.*screen.#3D.
SDL_GetVideoSurface();#0A..if.(!screen).{#0A..2fpri
ntf(stderr,"SDL_draw:.SDL_Draw_Init.ERROR!!#2E"#0A.
.16".Video.Surface.not.found\n");#0A..2exit(-2);#0A
..}#0A#0A..//printf("\nDraw_Init:.called\n");#0A..S
DL_Delay(1001);#0A#0A..switch(screen->format->Bytes
PerPixel).{#0A..2case.1:#0A..4//printf("\nDraw_Init
:.case.1\n");#0A..4SDL_DRAW_FUNCTIONS_BPP(1);#0A..2
break;#0A#0A..2case.2:#0A..4//printf("\nDraw_Init:.
case.2\n");#0A..4SDL_DRAW_FUNCTIONS_BPP(2);#0A..2br
eak;#0A#0A..2case.3:#0A..4//printf("\nDraw_Init:.ca
se.3\n");#0A..4SDL_DRAW_FUNCTIONS_BPP(3);#0A..2brea
k;#0A#0A..2case.4:#0A..4//printf("\nDraw_Init:.case
.4\n");#0A..4SDL_DRAW_FUNCTIONS_BPP(4);#0A..2break;
#0A..}/*switch*/#0A#0A}/*Draw_Init*/#0A#0A#23undef.
SDL_DRAW_FUNCTIONS_BPP#0A#0A#23else#0A#0Avoid.dummy
sdldraw().{#0A..return;#0A}#0A#0A#23endif#0A#0A

######sysc/sdldraw.h#
/*!..This.this.a.modification.by.Martin.Richards.fo
r.the.BCPL.system#0A..of.SDL_draw#2Eh.derived.from:
#0A#0A..\file.SDL_draw#2Eh#0A..\author.Mario.Palomo
.Torrero.<mpalomo@ihman#2Ecom>#0A..\author.Jose.M#2E
.de.la.Huerga.Fern#E1ndez#0A..\author.Pepe.Gonz#E1l
ez.Mora#0A..\date.05-2000002#0A#0A..Drawing.primiti
ves.for.SDL#2E.Main.header.file#2E#0A#0A..This.libr
ary.is.free.software;.you.can.redistribute.it.and/o
r#0A..modify.it.under.the.terms.of.the.GNU.Library.
General.Public#0A..License.as.published.by.the.Free
.Software.Foundation;.either#0A..version.2.of.the.L
icense,.or.(at.your.option).any.later.version#2E#0A
#0A..This.library.is.distributed.in.the.hope.that.i
t.will.be.useful,#0A..but.WITHOUT.ANY.WARRANTY;.wit
hout.even.the.implied.warranty.of#0A..MERCHANTABILI
TY.or.FITNESS.FOR.A.PARTICULAR.PURPOSE#2E..See.the.
GNU#0A..Library.General.Public.License.for.more.det
ails#2E#0A#0A..You.should.have.received.a.copy.of.t
he.GNU.Library.General.Public#0A..License.along.wit
h.this.library;.if.not,.write.to.the.Free.Foundatio
n,#0A..Inc#2E,.59.Temple.Place,.Suite.330000,.Bosto
n,.MA.02111-1307.USA..#0A*/#0A#0A#23ifdef.forWIN32#0A
#23include."SDL#2Eh"#0A#23else#0A#23include."SDL/SD
L#2Eh"#0A#23endif#0A#0Aextern#0Avoid.(*Draw_Pixel)(
SDL_Surface.*super,#0A..17Sint16.x,.Sint16.y,.Uint3
2.color);#0A#0Aextern#0Avoid.(*Draw_Line)(SDL_Surfa
ce.*super,#0A..16Sint16.x1,.Sint16.y1,.Sint16.x2,.S
int16.y2,#0A..16Uint32.color);#0A#0Aextern#0Avoid.(
*Draw_Circle)(SDL_Surface.*super,#0A..18Sint16.x0,.
Sint16.y0,.Uint16.r,#0A..18Uint32.color);#0A#0Aexte
rn#0Avoid.(*Draw_FillCircle)(SDL_Surface.*super,#0A
..22Sint16.x0,.Sint16.y0,.Uint16.r,#0A..22Uint32.co
lor);#0A#0Aextern#0Avoid.(*Draw_HLine)(SDL_Surface.
*super,#0A..20Sint16.x0,Sint16.y0,.Sint16.x1,#0A..2
0Uint32.color);#0A#0Aextern#0Avoid.(*Draw_VLine)(SD
L_Surface.*super,#0A..20Sint16.x0,Sint16.y0,.Sint16
.y1,#0A..20Uint32.color);#0A#0Aextern#0Avoid.(*Draw
_Rect)(SDL_Surface.*super,#0A..16Sint16.x,Sint16.y,
.Uint16.w,Uint16.h,#0A..16Uint32.color);#0A#0Aexter
n#0Avoid.Draw_FillRect(SDL_Surface.*super,#0A..17Si
nt16.x,.Sint16.y,.Sint16.w,.Sint16.h,.Uint32.color)
;#0A#0A1extern#0Avoid.(*Draw_Ellipse)(SDL_Surface.*
super,#0A..22Sint16.x0,.Sint16.y0,#0A..22Uint16.Xra
dius,.Uint16.Yradius,#0A..22Uint32.color);#0A#0Aext
ern#0Avoid.(*Draw_FillEllipse)(SDL_Surface.*super,#0A
..22Sint16.x0,.Sint16.y0,#0A..22Uint16.Xradius,.Uin
t16.Yradius,#0A..22Uint32.color);#0A#0Aextern#0Avoi
d.(*Draw_Round)(SDL_Surface.*super,#0A..17Sint16.x0
,Sint16.y0,.Uint16.w,Uint16.h,#0A..17Uint16.corner,
.Uint32.color);#0A#0Aextern#0Avoid.(*Draw_FillRound
)(SDL_Surface.*super,#0A..21Sint16.x0,Sint16.y0,.Ui
nt16.w,Uint16.h,#0A..21Uint16.corner,.Uint32.color)
;#0A#0A1/*.We'll.use.SDL.for.reporting.errors.*/#0A
#23define.Draw_SetError..SDL_SetError#0A#0A

######+#
