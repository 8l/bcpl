Return-path: <mrich177@ford.com>
Envelope-to: Martin.Richards@cl.cam.ac.uk
Delivery-date: Wed, 30 Sep 2009 13:07:31 +0100
Received: from ppsw-0.csi.cam.ac.uk ([131.111.8.130])
	by mta1.cl.cam.ac.uk with esmtp (Exim 3.092 #1)
	id 1Msxxz-0001LH-00
	for Martin.Richards@cl.cam.ac.uk; Wed, 30 Sep 2009 13:07:31 +0100
X-Cam-AntiVirus: no malware found
X-Cam-SpamDetails: not scanned (message too large)
X-Cam-ScannerInfo: http://www.cam.ac.uk/cs/email/scanner/
Received: from lomwsm05.mwlo.mailwatch.com ([216.157.241.11]:59763)
	by ppsw-0.csi.cam.ac.uk (mx.cam.ac.uk [131.111.8.140]:25)
	with esmtp (csa=unknown) id 1Msxxw-0002JB-2j (Exim 4.70) for mr@cl.cam.ac.uk
	(return-path <mrich177@ford.com>); Wed, 30 Sep 2009 13:07:31 +0100
Received: from lomwsc27.mwlo.mailwatch.com ([216.157.241.245])
	by lomwsm05.mwlo.mailwatch.com (8.13.5.20060308/8.13.5) with ESMTP id n8UC7ABY024741
	for <mr@cl.cam.ac.uk>; Wed, 30 Sep 2009 08:07:10 -0400 (EDT)
Received: from mail pickup service by lomwsc27.mwlo.mailwatch.com with Microsoft SMTPSVC;
	 Wed, 30 Sep 2009 08:07:10 -0400
Received: from 216.157.241.245 ([216.157.241.245]) by LOMWSC27.mwlo.mailwatch.com with SMTP id 0003001b4172530b-2333-44fc-b505-d8ef70517352;
	 Wed, 30 Sep 2009 08:07:09 -0400
Received: from ecpo1.azell.com (ecpo1.azell.com [136.1.7.4])
	by lomwsm17.mwlo.mailwatch.com (8.13.5.20060308/8.12.9) with ESMTP id n8UC77sR018551
	(version=TLSv1/SSLv3 cipher=DES-CBC3-SHA bits=168 verify=FAIL)
	for <mr@cl.cam.ac.uk>; Wed, 30 Sep 2009 08:07:07 -0400 (EDT)
Received: from fbbecs51.dearborn.ford.com ([19.99.2.101])
	by ecpo1.azell.com (MOS 3.7.4b-GA)
	with ESMTP id BMW20325;
	Wed, 30 Sep 2009 12:07:01 GMT
Received: from fbbfcb01.Dearborn.ford.com ([19.59.152.45]) by fbbecs51.dearborn.ford.com with Microsoft SMTPSVC(6.0.3790.3959);
	 Wed, 30 Sep 2009 08:00:32 -0400
Received: from eu1wab02.Warley.ford.com ([19.150.142.31]) by fbbfcb01.Dearborn.ford.com with Microsoft SMTPSVC(6.0.3790.3959);
	 Wed, 30 Sep 2009 07:59:58 -0400
Received: from eu1wam30.warley.ford.com ([19.150.176.30]) by eu1wab02.Warley.ford.com with Microsoft SMTPSVC(6.0.3790.3959);
	 Wed, 30 Sep 2009 12:59:55 +0100
X-MimeOLE: Produced By Microsoft Exchange V6.5
Content-class: urn:content-classes:message
MIME-Version: 1.0
Content-Type: multipart/alternative;
	boundary="----_=_NextPart_001_01CA41C5.8645FCBE"
Subject: FW: files1-x
Date: Wed, 30 Sep 2009 12:59:34 +0100
Message-ID: <13B574AE394ADB4EA4C45269F547AA9737E4C4@eu1wam30.warley.ford.com>
Thread-Topic: files1-x
Thread-Index: AcpBxSJQ0Z8HtS9dRbWm6+Hxdj5+bAAAFemp
References: <09093013563554@nepcsa.niehl.ford.com>
From: "Richards, Martin (M.)" <mrich177@ford.com>
To: <Martin.Richards@cl.cam.ac.uk>
X-OriginalArrivalTime: 30 Sep 2009 11:59:55.0190 (UTC) FILETIME=[865A2D60:01CA41C5]
X-MW-BTID: 093325000020092734362900003
X-MW-CTIME: 1254312427
X-MW-SENDING-MTA: 136.1.7.4
HOP-COUNT: 1
X-MAILWATCH-INSTANCEID: 0103001b4172530b-2333-44fc-b505-d8ef70517352

This is a multi-part message in MIME format.

------_=_NextPart_001_01CA41C5.8645FCBE
Content-Type: text/plain;
	charset="iso-8859-1"
Content-Transfer-Encoding: quoted-printable

=20

________________________________

From: mrich177@nepcsa.niehl.ford.com =
[mailto:mrich177@nepcsa.niehl.ford.com]
Sent: Wed 30/09/2009 13:56
To: Richards, Martin (M.)
Subject: files1-x




######cintcode/com/bcplfe.b#
//.This.is.the.BCPL.syntax.analyser#0A#0A//.Impleme
nted.by.Martin.Richards.(c).May.2009#0A#0A#0A/*.Cha
nge.history#0A#0A10/07/09#0AStopped.'#2E'.terminati
ng.GET.streams.so.that.GET.streams.can.contain#0Ase
veral.sections.separated.by.dots#2E.BEWARE:.this.is
.an.incompatible#0Achange,.since.the.first.section.
of.a.GET.stream.has.in.the.past.been#0Aused.as.a.he
ader#2E#0ARe-organised.the.compiler.into.g/bcplfecg
#2Eh,.bcplfe#2Eb.and.bcplcgcin#2Eb,#0Aand.reallocat
ing.most.of.the.compiler.globals#2E#0A#0A08/05/09#0A
Increased.the.default.treesize.to.200000#2E#0A#0A03
/07/07#0AModified.the.treatment.of.*#23.escapes.in.
string.and.character.constants#0Ato.allow.both.UTF8
.and.GB2312.encoding#2E.Added.compiler.options.UTF8
#0Aand.GB2312.to.set.the.default.encoding#2E.*#23U.
and.*#23G.in.a.string.and#0Acharacter.constant.temp
orarily.set.the.encoding.to.UTF8.and.GB2312,#0Aresp
ectively,.overriding.the.default.setting#2E.In.GB23
12.mode,.*#23dddd#0Acontains.up.to.4.decimal.digits
#2E.See.the.BCPL.manual#2E#0A#0A27/06/07#0AAdded.th
e.Unicode.escape.sequences.*#23hhhh.and.*#23#23hhhh
hhhh.to.string#0Aand.character.constants#2E.Within.
string.they.are.converted.to.the#0Acorresponding.UT
F8.sequence.of.bytes.and.within.a.character.constan
t#0Athey.yield.the.corresponding.Unicode.integer#2E
.See.the.last.few.tests#0Ain.com/cmpltest#2Eb#0A#0A
27/07/06#0AChanged.the.implementation.of.the.GET.di
rective.to.make.it.system#0Aindependent#2E.Performg
et.now.obtains.the.headers.environment.variable#0Af
rom.the.root.node.(rootnode!rtn_hdrsvar).this.is.no
rmally.either#0A"BCPLHDRS".or."POSHDRS"#2E.If.the.h
eader.file.does.not.end.in.#2Eh.or.#2Eb,#0A#2Eh.is.
appended#2E.The.search.order.is.as.follows:#0A#0A(1
).The.current.directory#2E#0A(2).The.directories.sp
ecified.by.the.headers.environment.variable,#0A....
if.set#2E#0A(3).The.subdirectory.g/.of.the.root.spe
cified.by.the.environment#0A....variable.rootnode!r
tn_rootvar,.if.set#2E#0A#0A05/04/06#0AMended.a.bug.
in.trans.concerning.the.tranlation.of.SKIP#2E#0A#0A
18/01/06#0ABased.on.Dave.Lewis's.suggestion,#0Ain.o
utputsection(),.add:#0A...IF.objline1%0.DO.writef("
%s*n",.objline1)#0Awhere.objline1.is.the.first.line
.of.file.objline1.if.it.can.be.found#0Ain.the.curre
nt.directory.or.in.the.HDRS.directory#2E.This.will.
typically#0Aput.a.line.such.as:#0A#23!/usr/local/bi
n/cintsys.-c#0Aas.the.first.line.of.the.compiled.ob
ject.module#2E.This.line.is.ignored#0Aby.the.CLI.bu
t.may.be.useful.under.Linux#2E.If.objline1.cannot.b
e.found#0Ano.such.line.is.inserted.at.the.start.of.
the.object.module#2E#0A#0A30/8/05#0ADefined.the.fun
ction.default_hdrs().near.the.start.to.allow.easy.c
hange#0Afrom.cintsys.to.cintpos.versions.of.the.com
piler#2E#0A.#0A22/6/05#0AAdded.the.empty.command.SK
IP.and.let.empty.blocks.be.equivalent.to#0ASKIP#2E.
Empty.section.brackets.are.now.also.allowed.after.M
ANIFEST,#0ASTATIC.and.GLOBAL#2E..These.changes.make
.program.development.marginally#0Aeasier#2E#0A#0A17
/6/04#0AMade.GET.first.look.in.the.current.director
y#2E#0AAdded.argument.HDRS.to.allow.the.environment
.variable.specifying#0Athe.headers.directory.to.be.
changed#2E.The.default.is.BCPLHDRS#2E#0A#0A23/4/04#0A
Update.the.standard.BCPL.compiler.with.all.the.Cint
pos.extensions#0Aincluding.cross.referencing.and.11
.character.names#2E#0AMake.GET.directives.use.the.B
CPLHDRS.environment.variable#2E#0A#0A11/6/02#0AChan
ged.square.brackets.to.mean.subscription.with.same.
precedence#0Aand.function.calls#2E#0A#0A18/3/02#0AU
se.HDRPATH.and.BCPLPATH.in.GET.directives#2E#0A#0A1
4/1/02#0AAdded.XREF.option.to.output.name.informati
on.during.compilation#2E#0A#0A11/7/01#0AAdded.langu
age.extensions.for.the.Ford.dialect.of.BCPL#2E#0Ai#2E
e#2E.modified.performget#0A.....added.SLCT.and.OF.(
also.::)#0A.....added.||.comments#0A.....treesize.s
et.to.100000#0A#0A15/1/01#0AComplain.if.global.numb
er.is.larger.than.65535#2E#0A#0A10/8/00#0AChange.th
e.maximum.number.of.error.messages.from.30.to.10#2E
#0A#0A14/12/99#0AMade./.*.#2E#2E#2E.*./..comments.n
est#2E#0AAllow.the.constants.in.MANIFEST,.STATIC.an
d.GLOBAL.declarations.#0Ato.be.optional#2E.If.absen
t.the.value.is.one.greater.than.the#0Aprevious.valu
e#2E.Unless.specified.the.first.value.is.zero,.so#0A
MANIFEST.{.a;.b#3D10;.c.}.declares.a,.b.and.c.to.be
.0,.10.and.11,#0Arespectively#2E#0A#0A9/6/99#0AMade
.changes.to.buffer.OCODE.in.memory#2E.When.bcpl.is.
called#0Awithout.the.TO.argument.it.writes.numeric.
ocode.to.the.file.ocode#2E#0ALex.treats.CR.(13).cor
rectly.to.improve.convenience.when.running#0Aunder.
Windows.and.WindowsCE#2E#0A#0A26/2/99#0AAdded.BIN.o
ption.to.the.compiler.to.generate.a.binary.(rather.
than#0Ahex).hunk.format.for.the.compiled.code#2E.Th
is.is.primarily.for.the#0AWindows.CE.version.of.the
.cintcode.system.where.compactness.is#0Aparticularl
y.important#2E.There.is.a.related.change.to.loadseg
.in#0Acintmain#2Ec#0A#0A17/11/98#0AChanged.the.work
spacesize.to.40000.and.added.the.SIZE.keyword#0Ato.
allow.the.user.to.specify.this.size#2E#0A#0A9/11/98
#0AMade.GET.directives.search.the.current.working.d
irectory#0Athen.directories.given.by.the.shell.vari
able.BCPLPATH,.if.set#2E#0AIt.uses.the.BLIB.functio
n.pathfindinput#2E#0A#0A15/12/96#0ACorrect.a.bug.in
.cellwithname#0A#0A16/8/96#0AAdded.one.line.to.read
number.to.allow.underscores.in.numbers.after.#0Athe
.first.digit#2E#0A#0A7/6/96#0AImplement.the.method.
application.operator.for.object.oriented#0Aprogramm
ing.in.BCPL#2E.E.#23.(E1,.E2,#2E#2E#2E,.En).is.equi
valent.to#0A((!E1)!E)(E1,.E2,#2E#2E#2E,.En)#0A#0A24
/12/95#0AImproved.the.efficiency.of.cellwithname.in
.TRN.(using.the.hash.chain#0Alink.in.name.node)#2E#0A
Improved.the.efficiency.of.outputsection.in.CG.by.i
ntroducing#0Awrhex2.and.wrword_at#2E#0A#0A24/7/95#0A
Removed.bug.in.atbinfo,.define.addinfo_b.change.som
e.global.numbers#2E#0AImplement.constant.folding.in
.TRN#2E#0A#0A13/7/95#0AAllowed.{.and.}.to.represent
.untagged.section.brackets#2E#0A#0A22/6/93#0ARevers
e.order.in.SWB.and.have.a.minimum.of.7.cases#0Ato.a
llow.faster.interpreter#2E#0A#0A2/6/93#0AChanged.co
de.for.SWB.to.use.heap-like.binary.tree#2E#0A#0A19/
5/93#0APut.in.code.to.compile.BTC.and.XPBYT.instruc
tions#2E#0A#0A23/4/93#0AAllowed.the.codegenerator.t
o.compiler.the.S.instruction#2E#0A#0A21/12/92#0ACur
ed.bug.in.compilation.of.(b.->.f,.g)(1,2,3)#0A#0A24
/11/92.#0ACured.bug.in.compilation.of.a,.b.:#3D.s%0
.>.0,.s%1.#3D.'!'#0A#0A23/7/92:#0ARenamed.nextlab.a
s.newlab,.load.as.loadval.in.the.CG#2E#0APut.back.s
impler.hashing.function.in.lookupword#2E#0ARemoved.
rdargs.fudge#2E#0ARemoved.S2.compiler.option#2E#0AC
ured.bug.concerning.the.closing.of.gostream.when.eq
ual.to.stdout#2E#0A*/#0A#0ASECTION."BCPL"#0A#0AGET.
"libhdr"#0AGET."bcplfecg"#0A.#0ALET.default_hdrs().
#3D.VALOF.//.Changed.MR.12/07/09#0A{.LET.hdrs.#3D.r
ootnode!rtn_hdrsvar.//.Typically."BCPLHDRS".or."POS
HDRS".or.0#0A..IF.hdrs.RESULTIS.hdrs#0A..RESULTIS."
BCPLHDRS"#0A}#0A.#0AGLOBAL.{#0A//.Globals.used.in.L
EX#0Achbuf:feg#0Adecval;.getstreams;.charv#0Ahdrs..
//.MR.10/7/04#0A#0Aworkvec#0Areadnumber;.rdstrch#0A
token;.wordnode;.ch#0Ardtag;.performget#0Alex;.dsw;
.declsyswords;.nlpending#0Alookupword;.rch#0Asource
namev;.sourcefileno;.sourcefileupb#0Askiptag;.wrchb
uf;.chcount;.lineno#0Anulltag;.rec_p;.rec_l#0A.#0A/
/.Globals.used.in.SYN#0Ardblockbody;..rdsect#0Arnam
elist;.rname#0Ardef;.rcom#0Ardcdefs#0Aformtree;.syn
err;.opname#0Arexplist;.rdseq#0Amk1;.mk2;.mk3#0Amk4
;.mk5;.mk6;.mk7#0Anewvec#0Arnexp;.rexp;.rbexp#0A}#0A
.#0A.#0AMANIFEST.{#0Ac_backspace.#3D..8#0Ac_tab....
...#3D..9#0Ac_newline...#3D.10#0Ac_newpage...#3D.12
#0Ac_return....#3D.13#0Ac_escape....#3D.27#0Ac_spac
e.....#3D.32#0A}#0A#0ALET.start().#3D.VALOF#0A{.LET
.treesize.#3D.0#0A..AND.argv.#3D.VEC.50#0A..AND.arg
form.#3D."FROM/A,TO/K,VER/K,SIZE/K/N,TREE/S,NONAMES
/S,*#0A................*D1/S,D2/S,OENDER/S,EQCASES/
S,BIN/S,XREF/S,GDEFS/S,HDRS/K,*#0A................*
GB2312/S,UTF8/S,SAVESIZE/K/N"#0A..LET.stdout.#3D.ou
tput()#0A..LET.objline1vec.#3D.VEC.256/bytesperword
#0A..objline1.:#3D.objline1vec#0A..objline1%0.:#3D.
0#0A..errmax...:#3D.10#0A..errcount.:#3D.0#0A..fin_
p,.fin_l.:#3D.level(),.fin#0A#0A..treevec......:#3D
.0#0A..obuf.........:#3D.0#0A..sourcestream.:#3D.0#0A
..ocodeout.....:#3D.0#0A..gostream.....:#3D.0#0A..g
etstreams...:#3D.0#0A#0A..sysprint.:#3D.stdout#0A..
selectoutput(sysprint)#0A.#0A..writef("*nBCPL.(7.Se
pt.2009)*n")#0A#0A..//.Allocate.vector.for.source.f
ile.names#0A..sourcefileupb.:#3D.1000#0A..sourcenam
ev.:#3D.getvec(sourcefileupb)#0A..UNLESS.sourcename
v.DO#0A..{.writef("Insufficient.space.available*n")
#0A....errcount.:#3D.1#0A....GOTO.fin#0A..}#0A..sou
rcefileno.:#3D.0#0A..FOR.i.#3D.0.TO.sourcefileupb.D
O.sourcenamev!0.:#3D.0...#0A.#0A..IF.rdargs(argform
,.argv,.50)#3D0.DO.{.writes("Bad.arguments*n")#0A..
....................................errcount.:#3D.1
#0A......................................GOTO.fin#0A
....................................}#0A..treesize.
:#3D.200_000#0A..IF.argv!3.DO.treesize.:#3D.!argv!3
#0A..IF.treesize<10_000.DO.treesize.:#3D.10_000#0A.
.obufsize.:#3D.treesize/4#0A#0A..prtree........:#3D
.argv!4#0A..savespacesize.:#3D.3#0A#0A..//.Code.gen
erator.options.#0A#0A..naming.:#3D.TRUE#0A..debug.:
#3D.0#0A..bigender.:#3D.(!"AAA".&.255).#3D.'A'.//.#3D
TRUE.if.running.on.a.bigender#0A..IF.argv!5.DO.nami
ng...:#3D.FALSE..........//.NONAMES#0A..IF.argv!6.D
O.debug....:#3D.debug+1........//.D1#0A..IF.argv!7.
DO.debug....:#3D.debug+2........//.D2#0A..IF.argv!8
.DO.bigender.:#3D.~bigender......//.OENDER#0A..eqca
ses..:#3D.argv!9......................//.EQCASES#0A
..bining...:#3D.argv!10.....................//.BIN.
(binary.hunk)#0A..xrefing..:#3D.argv!11............
.........//.XREF#0A..gdefsing.:#3D.argv!12.........
............//.GDEFS#0A..hdrs.....:#3D.argv!13.....
................//.HDRS#0A..defaultencoding.:#3D.UT
F8#0A..IF.argv!14.DO.defaultencoding.:#3D.GB2312.//
.GB2312#0A..IF.argv!15.DO.defaultencoding.:#3D.UTF8
...//.UTF8#0A..encoding.:#3D.defaultencoding#0A..IF
.argv!16.DO.savespacesize.:#3D.!(argv!16).//.SAVESI
ZE#0A#0A..UNLESS.hdrs.DO#0A....hdrs.:#3D.default_hd
rs()................//.Use.the.default.HDRS#0A.....
.....................................//.(typically.
BCPLHDRS.or.POSHDRS)#0A#0A..{.//.Feature.added.by.M
R.17/01/06#0A....//.If.file.objline1.can.be.found,.
its.first.line.will.be.written#0A....//.at.the.star
t.of.the.compiled.Cintcode.file#2E.It.first.looks.i
n.the#0A....//.current.directory.then.the.HDRS.dire
ctory.and.finally.it.tries#0A....//.g/objline1.in.t
he.system.root.directory#2E#0A....LET.line1stream.#3D
.findinput("objline1")#0A....LET.len.#3D.0#0A....UN
LESS.line1stream.DO#0A......line1stream.:#3D.pathfi
ndinput("objline1",.hdrs)#0A....UNLESS.line1stream.
IF.rootnode!rtn_rootvar.DO#0A......line1stream.:#3D
.pathfindinput("g/objline1",.rootnode!rtn_rootvar)#0A
....#0A....IF.line1stream.DO#0A....{.//.Copy.first.
line.of.objline1.into.string.objline1#0A......selec
tinput(line1stream)#0A......WHILE.len<255.DO#0A....
..{.LET.ch.#3D.rdch()#0A........IF.ch#3D'*n'.|.ch#3D
endstreamch.BREAK#0A........len.:#3D.len+1#0A......
..objline1%len.:#3D.ch#0A......}#0A......endread()#0A
....}#0A....objline1%0.:#3D.len#0A....objline1writt
en.:#3D.FALSE#0A..}#0A#0A..sourcestream.:#3D.findin
put(argv!0)......//.FROM#0A..sourcenamev!0.:#3D.arg
v!0#0A..sourcefileno..:#3D.0#0A#0A..IF.sourcestream
#3D0.DO.{.writef("Trouble.with.file.%s*n",.argv!0)#0A
.........................errcount.:#3D.1#0A........
.................GOTO.fin#0A.......................
}#0A#0A..selectinput(sourcestream)#0A.#0A..TEST.arg
v!1..........//.TO#0A..THEN.{.gostream.:#3D.findout
put(argv!1)#0A.........IF.gostream#3D0.DO#0A.......
..{.writef("Trouble.with.code.file.%s*n",.argv!1)#0A
...........errcount.:#3D.1#0A...........GOTO.fin#0A
.........}#0A.......}#0A..ELSE.{.ocodeout.:#3D.find
output("ocode")#0A.........IF.ocodeout#3D0.DO#0A...
......{.writes("Trouble.with.file.ocode*n")#0A.....
......errcount.:#3D.1#0A...........GOTO.fin#0A.....
....}#0A.......}#0A#0A..treevec.:#3D.getvec(treesiz
e)#0A..obuf....:#3D.getvec(obufsize)#0A#0A..IF.tree
vec#3D0.|.obuf#3D0.DO#0A..{.writes("Insufficient.me
mory*n")#0A....errcount.:#3D.1#0A....GOTO.fin#0A..}
#0A...#0A..UNLESS.argv!2#3D0.DO.......//.VER#0A..{.
sysprint.:#3D.findoutput(argv!2)#0A....IF.sysprint#3D
0.DO#0A....{.sysprint.:#3D.stdout#0A......writef("T
rouble.with.file.%s*n",.argv!2)#0A......errcount.:#3D
.1#0A......GOTO.fin#0A....}#0A..}#0A#0A..selectoutp
ut(sysprint)#0A#0A..//.Now.syntax.analyse,.translat
e.and.code-generate.each.section#0A..{.LET.b.#3D.VE
C.64/bytesperword#0A....chbuf.:#3D.b#0A....FOR.i.#3D
.0.TO.63.DO.chbuf%i.:#3D.0#0A....//.Sourcefile.0.is
.always.the.FROM.argument.filename#0A....//.others.
are.GET.files#0A....sourcenamev!0.:#3D.argv!0#0A...
.sourcefileno.:#3D.0#0A....FOR.i.#3D.1.TO.sourcefil
eupb.DO.sourcenamev!i.:#3D.0.//.Done.for.safety#0A.
...chcount,.lineno.:#3D.0,.(sourcefileno<<20).+.1#0A
....token,.decval.:#3D.0,.0#0A....rch()#0A.#0A....{
.//.Start.of.loop.to.process.each.section#0A......L
ET.tree.#3D.?#0A......treep.:#3D.treevec.+.treesize
#0A......obufp.:#3D.0#0A......obuft.:#3D.obufsize.*
.bytesperword#0A#0A......tree.:#3D.formtree()#0A...
...IF.tree#3D0.BREAK#0A#0A......//writef("Tree.size
.%n*n",.treesize+treevec-treep)#0A.#0A......IF.prtr
ee.DO.{.writes("Parse.Tree*n")#0A..................
...plist(tree,.0,.20)#0A.....................newlin
e()#0A...................}#0A..#0A......UNLESS.errc
ount#3D0.GOTO.fin#0A.#0A......translate(tree)#0A#0A
......obufq.:#3D.obufp.....//.Prepare.to.read.from.
OCODE.buffer#0A......obufp.:#3D.0#0A#0A......TEST.a
rgv!1#3D0#0A......THEN.writeocode()..//.Write.OCODE
.file.if.no.TO.argument#0A......ELSE.codegenerate(t
reevec,.treesize)#0A....}.REPEATWHILE.token#3Ds_dot
#0A..}#0A...#0Afin:#0A..IF.getstreams....DO.{.LET.p
.#3D.getstreams#0A........................getstream
s.:#3D.!p#0A........................freevec(p)#0A..
....................}#0A..IF.treevec.......DO.freev
ec(treevec)#0A..IF.obuf..........DO.freevec(obuf)#0A
..IF.sourcenamev...DO.freevec(sourcenamev)#0A..IF.s
ourcestream..DO.{.selectinput(sourcestream);.endrea
d().}#0A..IF.ocodeout......DO.{.selectoutput(ocodeo
ut)#0A........................UNLESS.ocodeout#3Dstd
out.DO.endwrite()#0A......................}#0A..IF.
gostream......DO.{.selectoutput(gostream)#0A.......
.................UNLESS.gostream#3Dstdout.DO.endwri
te()#0A......................}#0A..UNLESS.sysprint#3D
stdout.DO.{.selectoutput(sysprint);.endwrite().}#0A
#0A..selectoutput(stdout)#0A//abort(7777)#0A..RESUL
TIS.errcount#3D0.->.0,.20#0A}#0A#0A//.*************
.OCODE.I/O.Routines.**************************#0A#0A
/*#0AThe.OCODE.buffer.variables.are:#0A#0Aobuf.....
....is.the.OCODE.buffer.--.(obuf#3Dworkvec)#0Aobufp
........position.of.next.byte.in.the.OCODE.buffer#0A
obufq........another.pointer.into.the.OCODE.buffer#0A
obuft........end.of.the.OCODE.buffer#2E#0Aobufsize.
....size.of.obuf.(in.words)#0A*/#0A#0AAND.writeocod
e().BE#0A{.LET.layout.#3D.0#0A..selectoutput(ocodeo
ut)#0A#0A..UNTIL.obufp>#3Dobufq.DO#0A..{.writef(".%
n",.rdn())#0A....layout.:#3D.layout+1#0A....UNLESS.
layout.REM.16.DO.newline()#0A..}#0A..newline()#0A..
selectoutput(sysprint)#0A..writef("OCODE.size:.%i5/
%n*n",.obufq,.obuft)#0A}#0A#0AAND.rdn().#3D.VALOF#0A
{.LET.byte.#3D.obuf%obufp#0A..IF.obufp>#3Dobufq.RES
ULTIS.0#0A..obufp.:#3D.obufp+1#0A..IF.byte<223.RESU
LTIS.byte#0A..IF.byte#3D223.RESULTIS.-1#0A..RESULTI
S.(byte&31).+.(rdn()<<5)#0A}#0A#0AAND.wrn(n).BE#0A{
.IF.obufp>#3Dobuft.DO#0A..{.errmax.:#3D.0.//.Make.i
t.fatal#0A....trnerr("More.workspace.needed.for.OCO
DE.buffer*n")#0A..}#0A..IF.-1<#3Dn<223.DO....//.Thi
s.is.the.normal.case#0A..{.IF.n#3D-1.DO.n.:#3D.223#0A
....obuf%obufp.:#3D.n#0A....obufp.:#3D.obufp.+.1#0A
....RETURN#0A..}#0A..obuf%obufp.:#3D.224.+.(n&31)#0A
..obufp.:#3D.obufp.+.1#0A..n.:#3D.n>>5#0A}.REPEAT#0A
#0A//.*************.End.of..OCODE.I/O.Routines.****
***************#0A..#0ALET.lex().BE#0A{.nlpending.:
#3D.FALSE#0A.#0A..{.SWITCHON.ch.INTO#0A.#0A....{.DE
FAULT:#0A............{.LET.badch.#3D.ch#0A.........
.....ch.:#3D.'*s'#0A..............synerr("Illegal.c
haracter.%x2",.badch)#0A............}#0A#0A......CA
SE.'*n':#0A...............lineno.:#3D.lineno.+.1#0A
......CASE.'*p':#0A...............nlpending.:#3D.TR
UE..//.IGNORABLE.CHARACTERS#0A......CASE.'*c':#0A..
....CASE.'*t':#0A......CASE.'*s':#0A...............
rch().REPEATWHILE.ch#3D'*s'#0A...............LOOP#0A
#0A......CASE.'0':CASE.'1':CASE.'2':CASE.'3':CASE.'
4':#0A......CASE.'5':CASE.'6':CASE.'7':CASE.'8':CAS
E.'9':#0A..............token.:#3D.s_number#0A......
........decval.:#3D.readnumber(10,.100)#0A.........
.....RETURN#0A.#0A......CASE.'a':CASE.'b':CASE.'c':
CASE.'d':CASE.'e':#0A......CASE.'f':CASE.'g':CASE.'
h':CASE.'i':CASE.'j':#0A......CASE.'k':CASE.'l':CAS
E.'m':CASE.'n':CASE.'o':#0A......CASE.'p':CASE.'q':
CASE.'r':CASE.'s':CASE.'t':#0A......CASE.'u':CASE.'
v':CASE.'w':CASE.'x':CASE.'y':#0A......CASE.'z':#0A
......CASE.'A':CASE.'B':CASE.'C':CASE.'D':CASE.'E':
#0A......CASE.'F':CASE.'G':CASE.'H':CASE.'I':CASE.'
J':#0A......CASE.'K':CASE.'L':CASE.'M':CASE.'N':CAS
E.'O':#0A......CASE.'P':CASE.'Q':CASE.'R':CASE.'S':
CASE.'T':#0A......CASE.'U':CASE.'V':CASE.'W':CASE.'
X':CASE.'Y':#0A......CASE.'Z':#0A..............toke
n.:#3D.lookupword(rdtag(ch))#0A..............IF.tok
en#3Ds_get.DO.{.performget();.LOOP..}#0A...........
...RETURN#0A.#0A......CASE.'$':#0A..............rch
()#0A..............IF.ch#3D'$'.|.ch#3D'<'.|.ch#3D'>
'.DO#0A..............{.LET.k.#3D.ch#0A.............
...token.:#3D.lookupword(rdtag('<'))#0A............
....//.token.#3D.s_true.............if.the.tag.is.s
et#0A................//......#3D.s_false.or.s_name.
.otherwise#0A.#0A................//.$>tag...marks.t
he.end.of.a.conditional#0A................//.......
..skipping.section#0A................IF.k#3D'>'.DO#0A
................{.IF.skiptag#3Dwordnode.DO#0A......
................skiptag.:#3D.0...//.Matching.$>tag.
found#0A..................LOOP#0A................}#0A
.#0A................UNLESS.skiptag#3D0.LOOP#0A#0A..
..............//.Only.process.$<tag.and.$$tag.if.no
t.skipping#0A.#0A................//.$$tag..compleme
nts.the.value.of.a.tag#0A................IF.k#3D'$'
.DO#0A................{.h1!wordnode.:#3D.token#3Ds_
true.->.s_false,.s_true#0A..................LOOP#0A
................}#0A.#0A................//.$<tag#0A
................IF.token#3Ds_true.LOOP......//.Don'
t.skip.if.set#0A#0A................//.tag.is.false.
so.skip.until.matching.$>tag.or.EOF#0A.............
...skiptag.:#3D.wordnode#0A................UNTIL.sk
iptag#3D0.|.token#3Ds_dot.|.token#3Ds_eof.DO.lex()#0A
................skiptag.:#3D.0#0A................RE
TURN#0A..............}#0A.#0A..............UNLESS.c
h#3D'('.|.ch#3D')'.DO.synerr("'$'.out.of.context")#0A
..............token.:#3D.ch#3D'('.->.s_lsect,.s_rse
ct#0A..............lookupword(rdtag('$'))#0A.......
.......RETURN#0A.#0A......CASE.'{':.token,.wordnode
.:#3D.s_lsect,.nulltag;.BREAK#0A......CASE.'}':.tok
en,.wordnode.:#3D.s_rsect,.nulltag;.BREAK#0A#0A....
..CASE.'#23':#0A..............token.:#3D.s_number#0A
..............rch()#0A..............IF.'0'<#3Dch<#3D
'7'.DO#0A..............{.decval.:#3D.readnumber(.8,
.100)#0A................RETURN#0A..............}#0A
..............IF.ch#3D'b'.|.ch#3D'B'.DO#0A.........
.....{.rch()#0A................decval.:#3D.readnumb
er(.2,.100)#0A................RETURN#0A............
..}#0A..............IF.ch#3D'o'.|.ch#3D'O'.DO#0A...
...........{.rch()#0A................decval.:#3D.re
adnumber(.8,.100)#0A................RETURN#0A......
........}#0A..............IF.ch#3D'x'.|.ch#3D'X'.DO
#0A..............{.rch()#0A................decval.:
#3D.readnumber(16,.100)#0A................RETURN#0A
..............}#0A..............token.:#3D.s_mthap#0A
..............RETURN#0A.#0A......CASE.'[':.token.:#3D
.s_sbra;......BREAK#0A......CASE.']':.token.:#3D.s_
sket;......BREAK#0A......CASE.'(':.token.:#3D.s_lpa
ren;....BREAK#0A......CASE.')':.token.:#3D.s_rparen
;....BREAK.#0A......CASE.'?':.token.:#3D.s_query;..
...BREAK#0A......CASE.'+':.token.:#3D.s_plus;......
BREAK#0A......CASE.',':.token.:#3D.s_comma;.....BRE
AK#0A......CASE.';':.token.:#3D.s_semicolon;.BREAK#0A
......CASE.'@':.token.:#3D.s_lv;........BREAK#0A...
...CASE.'&':.token.:#3D.s_logand;....BREAK#0A......
CASE.'#3D':.token.:#3D.s_eq;........BREAK#0A......C
ASE.'!':.token.:#3D.s_vecap;.....BREAK#0A......CASE
.'%':.token.:#3D.s_byteap;....BREAK#0A......CASE.'*
*':token.:#3D.s_mult;......BREAK#0A......CASE.'|':.
token.:#3D.s_logor;.....BREAK#0A......CASE.'#2E':.t
oken.:#3D.s_dot;.......BREAK#0A#0A.#0A......CASE.'/
':#0A..............rch()#0A..............IF.ch#3D'\
'.DO.{.token.:#3D.s_logand;.BREAK.}#0A.............
.IF.ch#3D'/'.DO#0A..............{.rch().REPEATUNTIL
.ch#3D'*n'.|.ch#3Dendstreamch#0A................LOO
P#0A..............}#0A.#0A..............IF.ch#3D'**
'.DO#0A..............{.LET.depth.#3D.1#0A#0A.......
.........{.rch()#0A..................IF.ch#3D'**'.D
O#0A..................{.rch().REPEATWHILE.ch#3D'**'
#0A....................IF.ch#3D'/'.DO.{.depth.:#3D.
depth-1;.LOOP.}#0A..................}#0A...........
.......IF.ch#3D'/'.DO#0A..................{.rch()#0A
....................IF.ch#3D'**'.DO.{.depth.:#3D.de
pth+1;.LOOP.}#0A..................}#0A.............
.....IF.ch#3D'*n'.DO.lineno.:#3D.lineno+1#0A.......
...........IF.ch#3Dendstreamch.DO.synerr("Missing.'
**/'")#0A................}.REPEATUNTIL.depth#3D0#0A
#0A................rch()#0A................LOOP#0A.
.............}#0A#0A..............token.:#3D.s_div#0A
..............RETURN#0A.#0A......CASE.'~':#0A......
........rch()#0A..............IF.ch#3D'#3D'.DO.{.to
ken.:#3D.s_ne;.....BREAK.}#0A..............token.:#3D
.s_not#0A..............RETURN#0A.#0A......CASE.'\':
#0A..............rch()#0A..............IF.ch#3D'/'.
DO.{.token.:#3D.s_logor;..BREAK.}#0A..............I
F.ch#3D'#3D'.DO.{.token.:#3D.s_ne;.....BREAK.}#0A..
............token.:#3D.s_not#0A..............RETURN
#0A.#0A......CASE.'<':.rch()#0A..............IF.ch#3D
'#3D'.DO.{.token.:#3D.s_le;.....BREAK.}#0A.........
.....IF.ch#3D'<'.DO.{.token.:#3D.s_lshift;.BREAK.}#0A
..............token.:#3D.s_ls#0A..............RETUR
N#0A.#0A......CASE.'>':.rch()#0A..............IF.ch
#3D'#3D'.DO.{.token.:#3D.s_ge;.....BREAK.}#0A......
........IF.ch#3D'>'.DO.{.token.:#3D.s_rshift;.BREAK
.}#0A..............token.:#3D.s_gr#0A..............
RETURN#0A.#0A......CASE.'-':.rch()#0A..............
IF.ch#3D'>'.DO.{.token.:#3D.s_cond;.BREAK..}#0A....
..........token.:#3D.s_minus#0A..............RETURN
#0A.#0A......CASE.':':.rch()#0A..............IF.ch#3D
'#3D'.DO.{.token.:#3D.s_ass;.BREAK..}#0A...........
...IF.ch#3D':'.DO.{.token.:#3D.s_of;..BREAK..}..//.
Inserted.11/7/01#0A..............token.:#3D.s_colon
#0A..............RETURN#0A.#0A......CASE.'"':#0A...
........{.LET.len.#3D.0#0A.............rch()#0A....
.........encoding.:#3D.defaultencoding.//.encoding.
for.*#23.escapes#0A#0A.............UNTIL.ch#3D'"'.D
O#0A.............{.LET.code.#3D.rdstrch()#0A.......
........TEST.result2#0A...............THEN.{.//.A..
*#23.code.found#2E#0A......................//.Conve
rt.it.to.UTF8.or.GB2312.format#2E#0A...............
.......TEST.encoding#3DGB2312#0A...................
...THEN.{.//.Convert.to.GB2312.sequence#0A.........
....................IF.code>#23x7F.DO#0A...........
..................{.LET.hi.#3D.code../..100.+.160#0A
...............................LET.lo.#3D.code.MOD.
100.+.160#0A...............................IF.len>#3D
254.DO.synerr("Bad.string.constant")#0A............
...................TEST.bigender#0A................
...............THEN.{.charv%(len+1).:#3D.hi.#0A....
..................................charv%(len+2).:#3D
.lo#0A....................................}#0A.....
..........................ELSE.{.charv%(len+1).:#3D
.lo.#0A......................................charv%
(len+2).:#3D.hi#0A.................................
...}#0A...............................len.:#3D.len.
+.2#0A...............................LOOP#0A.......
......................}#0A.........................
....IF.len>#3D255.DO.synerr("Bad.string.constant")#0A
.............................charv%(len+1).:#3D.cod
e.//.Ordinary.ASCII.char#0A........................
.....len.:#3D.len.+.1#0A...........................
..LOOP#0A...........................}#0A...........
...........ELSE.{.//.Convert.to.UTF8.sequence#0A...
..........................IF.code<#3D#23x7F.DO#0A..
...........................{.IF.len>#3D255.DO.syner
r("Bad.string.constant")#0A........................
.......charv%(len+1).:#3D.code...//.0xxxxxxx#0A....
...........................len.:#3D.len.+.1#0A.....
..........................LOOP#0A..................
...........}#0A.............................IF.code
<#3D#23x7FF.DO#0A.............................{.IF.
len>#3D254.DO.synerr("Bad.string.constant")#0A.....
..........................charv%(len+1).:#3D.#23b11
00_0000+(code>>6)..//.110xxxxx#0A..................
.............charv%(len+2).:#3D.#23x80+(.code....&#23
x3F)..//.10xxxxxx#0A...............................
len.:#3D.len.+.2#0A...............................L
OOP#0A.............................}#0A............
.................IF.code<#3D#23xFFFF.DO#0A.........
....................{.IF.len>#3D253.DO.synerr("Bad.
string.constant")#0A...............................
charv%(len+1).:#3D.#23b1110_0000+(code>>12).//.1110
xxxx#0A...............................charv%(len+2)
.:#3D.#23x80+((code>>6)&#23x3F)..//.10xxxxxx#0A....
...........................charv%(len+3).:#3D.#23x8
0+(.code....&#23x3F)..//.10xxxxxx#0A...............
................len.:#3D.len.+.3#0A................
...............LOOP#0A.............................
}#0A.............................IF.code<#3D#23x1F_
FFFF.DO#0A.............................{.IF.len>#3D
252.DO.synerr("Bad.string.constant")#0A............
...................charv%(len+1).:#3D.#23b1111_0000
+(code>>18).//.11110xxx#0A.........................
......charv%(len+2).:#3D.#23x80+((code>>12)&#23x3F)
.//.10xxxxxx#0A...............................charv
%(len+3).:#3D.#23x80+((code>>.6)&#23x3F).//.10xxxxx
x#0A...............................charv%(len+4).:#3D
.#23x80+(.code.....&#23x3F).//.10xxxxxx#0A.........
......................len.:#3D.len.+.4#0A..........
.....................LOOP#0A.......................
......}#0A.............................IF.code<#3D#23
x3FF_FFFF.DO#0A.............................{.IF.le
n>#3D251.DO.synerr("Bad.string.constant")#0A.......
........................charv%(len+1).:#3D.#23b1111
_1000+(code>>24).//.111110xx#0A....................
...........charv%(len+2).:#3D.#23x80+((code>>18)&#23
x3F).//.10xxxxxx#0A...............................c
harv%(len+3).:#3D.#23x80+((code>>12)&#23x3F).//.10x
xxxxx#0A...............................charv%(len+4
).:#3D.#23x80+((code>>.6)&#23x3F).//.10xxxxxx#0A...
............................charv%(len+5).:#3D.#23x
80+(.code.....&#23x3F).//.10xxxxxx#0A..............
.................len.:#3D.len.+.5#0A...............
................LOOP#0A............................
.}#0A.............................IF.code<#3D#23x7F
FF_FFFF.DO#0A.............................{.IF.len>
#3D250.DO.synerr("Bad.string.constant")#0A.........
......................charv%(len+1).:#3D.#23b1111_1
100+(code>>30).//.1111110x#0A......................
.........charv%(len+2).:#3D.#23x80+((code>>24)&#23x
3F).//.10xxxxxx#0A...............................ch
arv%(len+3).:#3D.#23x80+((code>>18)&#23x3F).//.10xx
xxxx#0A...............................charv%(len+4)
.:#3D.#23x80+((code>>12)&#23x3F).//.10xxxxxx#0A....
...........................charv%(len+5).:#3D.#23x8
0+((code>>.6)&#23x3F).//.10xxxxxx#0A...............
................charv%(len+6).:#3D.#23x80+(.code...
..&#23x3F).//.10xxxxxx#0A..........................
.....len.:#3D.len.+.6#0A...........................
....LOOP#0A.............................}#0A.......
......................synerr("Bad.Unicode.character
")#0A...........................}#0A...............
.....}#0A...............ELSE.{.//.Not.a.Unicode.cha
racter#0A......................IF.len#3D255.DO.syne
rr("Bad.string.constant")#0A......................l
en.:#3D.len.+.1#0A......................charv%len.:
#3D.code#0A....................}#0A.............}#0A
.#0A.............charv%0.:#3D.len#0A.............wo
rdnode.:#3D.newvec(len/bytesperword+2)#0A..........
...h1!wordnode.:#3D.s_string#0A.............FOR.i.#3D
.0.TO.len.DO.(@h2!wordnode)%i.:#3D.charv%i#0A......
.......token.:#3D.s_string#0A.............BREAK#0A.
.........}#0A.#0A......CASE.'*'':#0A..............r
ch()#0A..............encoding.:#3D.defaultencoding#0A
..............decval.:#3D.rdstrch()#0A.............
.token.:#3D.s_number#0A..............UNLESS.ch#3D'*
''.DO.synerr("Bad.character.constant")#0A..........
....BREAK#0A.#0A.#0A......CASE.endstreamch:#0A.....
.........IF.getstreams.DO#0A..............{.//.Retu
rn.from.a.'GET'.stream#0A................LET.p.#3D.
getstreams#0A................endread()#0A..........
......ch...........:#3D.h4!getstreams#0A...........
.....lineno.......:#3D.h3!getstreams#0A............
....sourcestream.:#3D.h2!getstreams#0A.............
...getstreams...:#3D.h1!getstreams#0A..............
..freevec(p).//.Free.the.GET.node#0A...............
.selectinput(sourcestream)#0A................LOOP#0A
..............}#0A..............//.endstreamch.#3D>
.EOF.only.at.outermost.GET.level.#0A..............t
oken.:#3D.s_eof#0A..............RETURN#0A....}#0A..
}.REPEAT#0A.#0A..rch()#0A}#0A.#0ALET.lookupword(wor
d).#3D.VALOF#0A{.LET.len,.i.#3D.word%0,.0#0A..LET.h
ashval.#3D.19609.//.This.and.31397.are.primes#2E#0A
..FOR.j.#3D.0.TO.len.DO.hashval.:#3D.(hashval.NEQV.
word%j).*.31397#0A..hashval.:#3D.(hashval>>1).REM.n
ametablesize#0A#0A..wordnode.:#3D.nametable!hashval
#0A.#0A..UNTIL.wordnode#3D0.|.i>len.TEST.(@h3!wordn
ode)%i#3Dword%i#0A...........................THEN.i
.:#3D.i+1#0A...........................ELSE.wordnod
e,.i.:#3D.h2!wordnode,.0#0A.#0A..UNLESS.wordnode.DO
#0A..{.wordnode.:#3D.newvec(len/bytesperword+2)#0A.
...h1!wordnode,.h2!wordnode.:#3D.s_name,.nametable!
hashval#0A....FOR.i.#3D.0.TO.len.DO.(@h3!wordnode)%
i.:#3D.word%i#0A....nametable!hashval.:#3D.wordnode
#0A..}#0A.#0A..RESULTIS.h1!wordnode#0A}#0A.#0AAND.d
sw(word,.sym).BE.{.lookupword(word);.h1!wordnode.:#3D
.sym..}#0A.#0AAND.declsyswords().BE#0A{.dsw("AND",.
s_and)#0A..dsw("ABS",.s_abs)#0A..dsw("BE",.s_be)#0A
..dsw("BREAK",.s_break)#0A..dsw("BY",.s_by)#0A..dsw
("CASE",.s_case)#0A..dsw("DO",.s_do)#0A..dsw("DEFAU
LT",.s_default)#0A..dsw("EQ",.s_eq)#0A..dsw("EQV",.
s_eqv)#0A..dsw("ELSE",.s_else)#0A..dsw("ENDCASE",.s
_endcase)#0A..dsw("FALSE",.s_false)#0A..dsw("FOR",.
s_for)#0A..dsw("FINISH",.s_finish)#0A..dsw("GOTO",.
s_goto)#0A..dsw("GE",.s_ge)#0A..dsw("GR",.s_gr)#0A.
.dsw("GLOBAL",.s_global)#0A..dsw("GET",.s_get)#0A..
dsw("IF",.s_if)#0A..dsw("INTO",.s_into)#0A..dsw("LE
T",.s_let)#0A..dsw("LV",.s_lv)#0A..dsw("LE",.s_le)#0A
..dsw("LS",.s_ls)#0A..dsw("LOGOR",.s_logor)#0A..dsw
("LOGAND",.s_logand)#0A..dsw("LOOP",.s_loop)#0A..ds
w("LSHIFT",.s_lshift)#0A..dsw("MANIFEST",.s_manifes
t)#0A..dsw("MOD",.s_rem)#0A..dsw("NE",.s_ne)#0A..ds
w("NEEDS",.s_needs)#0A..dsw("NEQV",.s_neqv)#0A..dsw
("NOT",.s_not)#0A..dsw("OF",.s_of).................
..//.Inserted.11/7/01#0A..dsw("OR",.s_else)#0A..dsw
("RESULTIS",.s_resultis)#0A..dsw("RETURN",.s_return
)#0A..dsw("REM",.s_rem)#0A..dsw("RSHIFT",.s_rshift)
#0A..dsw("RV",.s_rv)#0A..dsw("REPEAT",.s_repeat)#0A
..dsw("REPEATWHILE",.s_repeatwhile)#0A..dsw("REPEAT
UNTIL",.s_repeatuntil)#0A..dsw("SECTION",.s_section
)#0A..dsw("SKIP",.s_skip)...............//.Added.22
/6/05#0A..dsw("SLCT",.s_slct)...............//.Inse
rted.11/7/01#0A..dsw("STATIC",.s_static)#0A..dsw("S
WITCHON",.s_switchon)#0A..dsw("TO",.s_to)#0A..dsw("
TEST",.s_test)#0A..dsw("TRUE",.s_true)#0A..dsw("THE
N",.s_do)#0A..dsw("TABLE",.s_table)#0A..dsw("UNLESS
",.s_unless)#0A..dsw("UNTIL",.s_until)#0A..dsw("VEC
",.s_vec)#0A..dsw("VALOF",.s_valof)#0A..dsw("WHILE"
,.s_while)#0A..dsw("XOR",.s_neqv)#0A..dsw("$",.0)#0A
.#0A..nulltag.:#3D.wordnode#0A}.#0A.#0ALET.rch().BE
#0A{.ch.:#3D.rdch()#0A..chcount.:#3D.chcount.+.1#0A
..chbuf%(chcount&63).:#3D.ch#0A}#0A.#0AAND.wrchbuf(
).BE#0A{.writes("*n#2E#2E#2E")#0A..FOR.p.#3D.chcoun
t-63.TO.chcount.DO#0A..{.LET.k.#3D.chbuf%(p&63)#0A.
...IF.0<k<255.DO.wrch(k)#0A..}#0A..newline()#0A}#0A
.#0A.#0AAND.rdtag(ch1).#3D.VALOF#0A{.LET.len.#3D.1#0A
..IF.eqcases.&.'a'<#3Dch1<#3D'z'.DO.ch1.:#3D.ch1.+.
'A'.-.'a'#0A..charv%1.:#3D.ch1#0A.#0A..{.rch()#0A..
..UNLESS.'a'<#3Dch<#3D'z'.|.'A'<#3Dch<#3D'Z'.|#0A..
.........'0'<#3Dch<#3D'9'.|.ch#3D'#2E'.|.ch#3D'_'.B
REAK#0A....IF.eqcases.&.'a'<#3Dch<#3D'z'.DO.ch.:#3D
.ch.+.'A'.-.'a'#0A....len.:#3D.len+1#0A....charv%le
n.:#3D.ch#0A..}.REPEAT#0A.#0A..charv%0.:#3D.len#0A.
.RESULTIS.charv#0A}#0A#0AAND.catstr(s1,.s2).#3D.VAL
OF#0A//.Concatenate.strings.s1.and.s2.leaving.the.r
esult.in.s1#2E#0A//.s1.is.assumed.to.be.able.to.hol
d.a.string.of.length.255#2E#0A//.The.resulting.stri
ng.is.truncated.to.length.255,.if.necessary#2E.#0A{
.LET.len.#3D.s1%0#0A..LET.n.#3D.len#0A..FOR.i.#3D.1
.TO.s2%0.DO#0A..{.n.:#3D.n+1#0A....IF.n>255.BREAK#0A
....s1%n.:#3D.s2%i#0A..}#0A..s1%0.:#3D.n#0A}.#0A.#0A
AND.performget().BE#0A{.LET.stream.#3D.?#0A..LET.le
n.#3D.0#0A..lex()#0A..UNLESS.token#3Ds_string.DO.sy
nerr("Bad.GET.directive")#0A..len.:#3D.charv%0#0A#0A
..//.Append.#2Eh.to.the.GET.filename.does.not.end.i
n.#2Eh.or.#2Eb#0A..UNLESS.len>#3D2.&.charv%(len-1)#3D
'#2E'.&.#0A.........(charv%len#3D'h'.|.charv%len#3D
'b').DO#0A..{.len.:#3D.len+2#0A....charv%0,.charv%(
len-1),.charv%len.:#3D.len,.'#2E',.'h'#0A..}#0A#0A.
.FOR.i.#3D.1.TO.charv%0.IF.charv%i#3D':'.DO.charv%i
.:#3D.'/'#0A#0A..//.First.look.in.the.current.direc
tory#0A..//writef("Searching.for.*"%s*".in.the.curr
ent.directory*n",.charv)#0A..stream.:#3D.findinput(
charv)#0A#0A..//.Then.try.the.headers.directories#0A
..//UNLESS.stream.DO.writef("Searching.for.*"%s*".i
n.%s*n",.charv,.hdrs)#0A..UNLESS.stream.DO.stream.:
#3D.pathfindinput(charv,.hdrs)#0A#0A..//.Finally.pr
epend.g/.and.lookup.in.the.system.root.directory#0A
..UNLESS.stream.DO#0A..{.LET.filename.#3D.VEC.256/b
ytesperword#0A....filename%0.:#3D.0#0A....catstr(fi
lename,."g/")#0A....catstr(filename,.charv)#0A..../
/writef("Searching.for.*"%s*".in.%s*n",.filename,.r
ootnode!rtn_rootvar)#0A....stream.:#3D.pathfindinpu
t(filename,.rootnode!rtn_rootvar)#0A..}#0A#0A..UNLE
SS.stream.DO#0A..{.synerr("Unable.to.find.GET.file.
%s",.charv)#0A....RETURN#0A..}#0A#0A..IF.sourcefile
no>#3Dsourcefileupb.DO#0A..{.synerr("Too.many.GET.f
iles")#0A....RETURN#0A..}#0A#0A..{.LET.len.#3D.char
v%0#0A....LET.node.#3D.getvec(4.+.len/bytesperword)
#0A....LET.str.#3D.@node!4#0A#0A....UNLESS.node.DO.
synerr("getvec.failure.in.performget")#0A#0A....FOR
.i.#3D.0.TO.len.DO.str%i.:#3D.charv%i#0A....sourcef
ileno.:#3D.sourcefileno+1#0A....sourcenamev!sourcef
ileno.:#3D.str#0A....node!0,.node!1,.node!2,.node!3
.:#3D.getstreams,.sourcestream,.lineno,.ch#0A....ge
tstreams.:#3D.node#0A..}#0A..sourcestream.:#3D.stre
am#0A..selectinput(sourcestream)#0A..lineno.:#3D.(s
ourcefileno<<20).+.1#0A..rch()#0A}#0A.#0AAND.readnu
mber(radix,.digs).#3D.VALOF#0A//.Read.a.binary,.oct
al,.decimal.or.hexadecimal.unsigned.number#0A//.wit
h.between.1.and.digs.digits#2E.Underlines.are.allow
ed#2E#0A//.This.function.is.used.for.numerical.cons
tants.and.numerical#0A//.escapes.in.string.and.char
acter.constants#2E#0A{.LET.i,.res.#3D.0,.0#0A.#0A..
{.UNLESS.ch#3D'_'.DO.//.ignore.underlines#0A....{.L
ET.d.#3D.value(ch)#0A......IF.d>#3Dradix.BREAK#0A..
....i.:#3D.i+1.......//.Increment.count.of.digits#0A
......res.:#3D.radix*res.+.d#0A....}#0A....rch()#0A
..}.REPEATWHILE.i<digs#0A#0A..UNLESS.i.DO.synerr("B
ad.number")#0A..RESULTIS.res#0A}#0A.#0A.#0AAND.valu
e(ch).#3D.'0'<#3Dch<#3D'9'.->.ch-'0',#0A...........
.....'A'<#3Dch<#3D'F'.->.ch-'A'+10,#0A.............
...'a'<#3Dch<#3D'f'.->.ch-'a'+10,#0A...............
.100#0A.#0AAND.rdstrch().#3D.VALOF#0A{.//.Return.th
e.integer.code.for.the.next.string.character#0A..//
.Set.result2#3DTRUE.if.*#23.character.code.was.foun
d,.otherwise.FALSE#0A..LET.k.#3D.ch#0A#0A..IF.k#3D'
*n'.|.k#3D'*p'.DO#0A..{.lineno.:#3D.lineno+1#0A....
synerr("Unescaped.newline.character")#0A..}#0A.#0A.
.IF.k#3D'**'.DO#0A..{.rch()#0A....k.:#3D.ch#0A....I
F.'a'<#3Dk<#3D'z'.DO.k.:#3D.k.+.'A'.-.'a'#0A....SWI
TCHON.k.INTO#0A....{.CASE.'*n':#0A......CASE.'*c':#0A
......CASE.'*p':#0A......CASE.'*s':#0A......CASE.'*
t':.WHILE.ch#3D'*n'.|.ch#3D'*c'.|.ch#3D'*p'.|.ch#3D
'*s'.|.ch#3D'*t'.DO#0A.................{.IF.ch#3D'*
n'.DO.lineno.:#3D.lineno+1#0A...................rch
()#0A.................}#0A.................IF.ch#3D
'**'.DO.{.rch();.LOOP..}#0A#0A......DEFAULT:...syne
rr("Bad.string.or.character.constant,.ch#3D%n",.ch)
#0A.........#0A......CASE.'**':#0A......CASE.'*'':#0A
......CASE.'"':....................ENDCASE#0A......
...#0A......CASE.'T':..k.:#3D.c_tab;.......ENDCASE#0A
......CASE.'S':..k.:#3D.c_space;.....ENDCASE#0A....
..CASE.'N':..k.:#3D.c_newline;...ENDCASE#0A......CA
SE.'E':..k.:#3D.c_escape;....ENDCASE#0A......CASE.'
B':..k.:#3D.c_backspace;.ENDCASE#0A......CASE.'P':.
.k.:#3D.c_newpage;...ENDCASE#0A......CASE.'C':..k.:
#3D.c_return;....ENDCASE#0A.........#0A......CASE.'
X':..//.*xhh..--.A.character.escape.in.hexadecimal#0A
.................rch()#0A.................k.:#3D.re
adnumber(16,2)#0A.................result2.:#3D.FALS
E#0A.................RESULTIS.k#0A#0A......CASE.'#23
':..//.*#23u...set.UTF8.mode#0A.................//.
*#23g...set.GB2312.mode#0A.................//.In.UT
F8.mode#0A.................//.....*#23hhhh.or.*#23#23
hhhhhhhh..--.a.Unicode.character#0A................
.//.In.GB2312#0A.................//.....*#23dddd...
..............--.A.GB2312.code#0A...............{.L
ET.digs.#3D.4#0A.................rch()#0A..........
.......IF.ch#3D'u'.|.ch#3D'U'.DO.{.encoding.:#3D.UT
F8;...rch();.LOOP.}#0A.................IF.ch#3D'g'.
|.ch#3D'G'.DO.{.encoding.:#3D.GB2312;.rch();.LOOP.}
#0A.................TEST.encoding#3DGB2312#0A......
...........THEN.{.#0A........................k.:#3D
.readnumber(10,.digs)#0A//sawritef("rdstrch:.GB2312
:.%i4*n",.k)#0A......................}#0A..........
.......ELSE.{.IF.ch#3D'#23'.DO.{.rch();.digs.:#3D.8
.}#0A........................k.:#3D.readnumber(16,.
digs)#0A//sawritef("rdstrch:.Unicode:.%x4*n",.k)#0A
......................}#0A.................result2.
:#3D.TRUE#0A.................RESULTIS.k#0A.........
......}#0A#0A......CASE.'0':CASE.'1':CASE.'2':CASE.
'3':CASE.'4':#0A......CASE.'5':CASE.'6':CASE.'7':#0A
.................//.*ooo.--.A.character.escape.in.o
ctal.#0A.................k.:#3D.readnumber(8,3)#0A.
................IF.k>255.DO.#0A....................
...synerr("Bad.string.or.character.constant")#0A...
..............result2.:#3D.FALSE#0A................
.RESULTIS.k#0A....}#0A..}#0A...#0A..rch()#0A..resul
t2.:#3D.FALSE#0A..RESULTIS.k#0A}.REPEAT#0A#0ALET.ne
wvec(n).#3D.VALOF#0A{.treep.:#3D.treep.-.n.-.1;#0A.
.IF.treep<#3Dtreevec.DO#0A..{.errmax.:#3D.0..//.Mak
e.it.fatal#0A....synerr("More.workspace.needed")#0A
..}#0A..RESULTIS.treep#0A}#0A.#0AAND.mk1(x).#3D.VAL
OF#0A{.LET.p.#3D.newvec(0)#0A..p!0.:#3D.x#0A..RESUL
TIS.p#0A}#0A.#0AAND.mk2(x,.y).#3D.VALOF#0A{.LET.p.#3D
.newvec(1)#0A..p!0,.p!1.:#3D.x,.y#0A..RESULTIS.p#0A
}#0A.#0AAND.mk3(x,.y,.z).#3D.VALOF#0A{.LET.p.#3D.ne
wvec(2)#0A..p!0,.p!1,.p!2.:#3D.x,.y,.z#0A..RESULTIS
.p#0A}#0A.#0AAND.mk4(x,.y,.z,.t).#3D.VALOF#0A{.LET.
p.#3D.newvec(3)#0A..p!0,.p!1,.p!2,.p!3.:#3D.x,.y,.z
,.t#0A..RESULTIS.p#0A}#0A.#0AAND.mk5(x,.y,.z,.t,.u)
.#3D.VALOF#0A{.LET.p.#3D.newvec(4)#0A..p!0,.p!1,.p!
2,.p!3,.p!4.:#3D.x,.y,.z,.t,.u#0A..RESULTIS.p#0A}#0A
.#0AAND.mk6(x,.y,.z,.t,.u,.v).#3D.VALOF#0A{.LET.p.#3D
.newvec(5)#0A..p!0,.p!1,.p!2,.p!3,.p!4,.p!5.:#3D.x,
.y,.z,.t,.u,.v#0A..RESULTIS.p#0A}#0A.#0AAND.mk7(x,.
y,.z,.t,.u,.v,.w).#3D.VALOF#0A{.LET.p.#3D.newvec(6)
#0A..p!0,.p!1,.p!2,.p!3,.p!4,.p!5,.p!6.:#3D.x,.y,.z
,.t,.u,.v,.w#0A..RESULTIS.p#0A}#0A.#0AAND.formtree(
).#3D..VALOF#0A{.LET.res.#3D.0#0A#0A..nametablesize
.:#3D.541#0A#0A..charv......:#3D.newvec(256/bytespe
rword).....#0A..nametable..:#3D.newvec(nametablesiz
e).#0A..FOR.i.#3D.0.TO.nametablesize.DO.nametable!i
.:#3D.0#0A..skiptag.:#3D.0#0A..declsyswords()#0A.#0A
..rec_p,.rec_l.:#3D.level(),.rec#0A.#0A..token,.dec
val.:#3D.0,.0#0A#0A..lex()#0A//sawritef("formtree:.
token#3D%n.cis#3D%n*n",.token,.cis)#0A..IF.token#3D
s_query.DO............//.For.debugging.lex#2E#0A..{
.lex()#0A....writef("token.#3D%i3.ln#3D%i5.%12t..de
cval.#3D.%i8...charv.#3D.%s*n",#0A............token
,.lineno&#23xFFFFF,.opname(token),.decval,........c
harv)#0A....IF.token#3Ds_eof.RESULTIS.0#0A..}.REPEA
T#0A#0Arec:res.:#3D.token#3Ds_section.->.rprog(s_se
ction),#0A...........token#3Ds_needs...->.rprog(s_n
eeds),.rdblockbody(TRUE)#0A//sawritef("section.ende
d.with.%s*n",.opname(token))#0A..UNLESS.token#3Ds_d
ot.|.token#3Ds_eof.DO.synerr("Incorrect.termination
")#0A.#0A..RESULTIS.res#0A}#0A.#0AAND.rprog(thing).
#3D.VALOF#0A{.LET.a.#3D.0#0A..lex()#0A..a.:#3D.rbex
p()#0A..UNLESS.h1!a#3Ds_string.DO.synerr("Bad.SECTI
ON.or.NEEDS.name")#0A..RESULTIS.mk3(thing,.a,#0A...
..............token#3Ds_needs.->.rprog(s_needs),#0A
.................................rdblockbody(TRUE))
.//.TRUE#3Doutmost.level#0A}#0A.#0A.#0AAND.synerr(m
ess,.a).BE#0A{.LET.fno.#3D.lineno>>20#0A..LET.ln.#3D
.lineno.&.#23xFFFFF#0A..LET.filename.#3D.sourcename
v!fno#0A..errcount.:#3D.errcount.+.1#0A..writef("*n
Error.near.")#0A..IF.filename.DO.writef("%s",.filen
ame)#0A..writef("[%n]:..",.ln)#0A..writef(mess,.a)#0A
..wrchbuf()#0A..IF.errcount.>.errmax.DO#0A..{.write
s("*nCompilation.aborted*n")#0A....longjump(fin_p,.
fin_l)#0A..}#0A..nlpending.:#3D.FALSE#0A.#0A..UNTIL
.token#3Ds_lsect.|.token#3Ds_rsect.|#0A........toke
n#3Ds_let.|.token#3Ds_and.|#0A........token#3Ds_dot
.|.token#3Ds_eof.|.nlpending.DO.lex()#0A#0A..IF.tok
en#3Ds_and.DO.token.:#3D.s_let#0A..longjump(rec_p,.
rec_l)#0A}#0A.#0ALET.rdblockbody(outerlevel).#3D.VA
LOF#0A{.LET.p,.l.#3D.rec_p,.rec_l#0A..LET.a,.ln.#3D
.0,.?#0A.#0A..rec_p,.rec_l.:#3D.level(),.recover#0A
#0Arecover:..#0A..IF.token#3Ds_semicolon.DO.lex()#0A
.#0A..ln.:#3D.lineno#0A...#0A..SWITCHON.token.INTO#0A
..{.CASE.s_manifest:#0A....CASE.s_static:#0A....CAS
E.s_global:#0A..............{.LET.op.#3D.token#0A..
..............lex()#0A................a.:#3D.rdsect
(rdcdefs,.op#3Ds_global->s_colon,s_eq)#0A..........
......a.:#3D.mk4(op,.a,.rdblockbody(outerlevel),.ln
)#0A................ENDCASE#0A..............}#0A.#0A
.#0A....CASE.s_let:.lex()#0A................a.:#3D.
rdef(outerlevel)#0A................WHILE.token#3Ds_
and.DO#0A................{.LET.ln1.#3D.lineno#0A...
...............lex()#0A..................a.:#3D.mk4
(s_and,.a,.rdef(outerlevel),.ln1)#0A...............
.}#0A................a.:#3D.mk4(s_let,.a,.rdblockbo
dy(outerlevel),.ln)#0A................ENDCASE#0A.#0A
....DEFAULT:....IF.outerlevel.DO#0A................
{.errmax.:#3D.0.//.Make.it.fatal#2E#0A.............
.....synerr("Bad.outer.level.declaration")#0A......
..........}#0A................a.:#3D.rdseq()#0A....
............UNLESS.token#3Ds_rsect.DO.synerr("Error
.in.command")#0A.#0A....CASE.s_rsect:IF.outerlevel.
DO.lex()#0A....CASE.s_dot:#0A....CASE.s_eof:#0A..}#0A
.#0A..rec_p,.rec_l.:#3D.p,.l#0A..RESULTIS.a#0A}#0A.
#0AAND.rdseq().#3D.VALOF#0A{.LET.a.#3D.0#0A...IF.to
ken#3Ds_semicolon.DO.lex()#0A...a.:#3D.rcom()#0A...
IF.token#3Ds_rsect.|.token#3Ds_dot.|.token#3Ds_eof.
RESULTIS.a#0A...RESULTIS.mk3(s_seq,.a,.rdseq())#0A}
#0A#0AAND.rdcdefs(sep).#3D.VALOF#0A{.LET.res,.id.#3D
.0,.0#0A...LET.ptr.#3D.@res#0A...LET.p,.l.#3D.rec_p
,.rec_l#0A...LET.kexp.#3D.0#0A#0A.#0A...{.LET.ln.#3D
.lineno#0A......rec_p,.rec_l.:#3D.level(),.recov#0A
......kexp.:#3D.0#0A......id.:#3D.rname()#0A......I
F.token#3Dsep.DO.kexp.:#3D.rnexp(0)#0A......!ptr.:#3D
.mk5(s_constdef,.0,.id,.kexp,.ln)#0A......ptr.:#3D.
@h2!(!ptr)#0A#0Arecov:IF.token#3Ds_semicolon.DO.lex
()#0A...}.REPEATWHILE.token#3Ds_name#0A.#0A...rec_p
,.rec_l.:#3D.p,.l#0A...RESULTIS.res#0A}#0A.#0AAND.r
dsect(r,.arg).#3D.VALOF#0A//.Used.only.for.MANIFEST
,.STATIC.and.GLOBAL.declarations,#0A//.SWITCHON.com
mands.and.blocks#2E#0A{.LET.tag,.res.#3D.wordnode,.
0#0A...UNLESS.token#3Ds_lsect.DO.synerr("'{'.or.'$(
'.expected")#0A...lex()#0A...UNLESS.token#3Ds_rsect
.DO.res.:#3D.r(arg).//.Allow.{.}..MR.22/6/05#0A...U
NLESS.token#3Ds_rsect.DO.synerr("'}'.or.'$)'.expect
ed")#0A...TEST.tag#3Dwordnode.THEN.lex()#0A........
.............ELSE.IF.wordnode#3Dnulltag.DO#0A......
....................{.token.:#3D.0#0A..............
..............synerr("Untagged.'$)'.mismatch")#0A..
........................}#0A...//.res#3D0.for.empty
.section.brackets.{.}#0A...RESULTIS.res#0A}#0A#0AAN
D.rnamelist().#3D.VALOF#0A{.LET.a.#3D.rname()#0A...
UNLESS.token#3Ds_comma.RESULTIS.a#0A...lex()#0A...R
ESULTIS.mk3(s_comma,.a,.rnamelist())#0A}#0A#0AAND.r
name().#3D.VALOF#0A{.LET.a.#3D.wordnode#0A...UNLESS
.token#3Ds_name.DO.synerr("Name.expected")#0A...lex
()#0A...RESULTIS.a#0A}#0A.#0ALET.rbexp().#3D.VALOF#0A
{.LET.a,.op.#3D.0,.token#0A.#0A...SWITCHON.token.IN
TO#0A.#0A...{.DEFAULT:.synerr("Error.in.expression"
)#0A#0A......CASE.s_query:..lex()#0A...............
......RESULTIS.mk1(s_query)#0A.#0A......CASE.s_true
:#0A......CASE.s_false:#0A......CASE.s_name:#0A....
..CASE.s_string:.a.:#3D.wordnode#0A................
.....lex()#0A.....................RESULTIS.a#0A.#0A
......CASE.s_number:.a.:#3D.mk2(s_number,.decval)#0A
.....................lex()#0A.....................R
ESULTIS.a#0A#0A......CASE.s_slct:.{.LET.len,.sh,.of
fset.#3D.0,.0,.0..//.Inserted.11/7/01#0A#0A........
.............//.Allow...SLCT.offset#0A.............
........//.or......SLCT.sh:offset#0A...............
......//.or......SLCT.len:sh:offset#0A#0A..........
...........offset.:#3D.rnexp(0)#0A#0A..............
.......IF.token#3Ds_colon.DO#0A....................
.{.sh.:#3D.offset#0A.......................offset.:
#3D.rnexp(0)#0A.....................}#0A...........
..........IF.token#3Ds_colon.DO#0A.................
....{.len.:#3D.sh#0A.......................sh.:#3D.
offset#0A.......................offset.:#3D.rnexp(0
)#0A.....................}#0A#0A...................
..RESULTIS.mk4(s_slct,.len,.sh,.offset)#0A.........
..........}#0A.#0A......CASE.s_lparen:.a.:#3D.rnexp
(0)#0A.....................UNLESS.token#3Ds_rparen.
DO.synerr("')'.missing")#0A.....................lex
()#0A.....................RESULTIS.a#0A.#0A......CA
SE.s_valof:..lex()#0A.....................RESULTIS.
mk2(s_valof,.rcom())#0A.#0A......CASE.s_vecap:..op.
:#3D.s_rv#0A......CASE.s_lv:#0A......CASE.s_rv:....
.RESULTIS.mk2(op,.rnexp(7))#0A.#0A......CASE.s_plus
:...RESULTIS.rnexp(5)#0A.#0A......CASE.s_minus:..a.
:#3D.rnexp(5)#0A.....................TEST.h1!a#3Ds_
number.THEN.h2!a.:#3D.-.h2!a#0A....................
....................ELSE.a.:#3D.mk2(s_neg,.a)#0A...
..................RESULTIS.a#0A.#0A......CASE.s_abs
:....RESULTIS.mk2(s_abs,.rnexp(5))#0A.#0A......CASE
.s_not:....RESULTIS.mk2(s_not,.rnexp(3))#0A.#0A....
..CASE.s_table:..lex()#0A.....................RESUL
TIS.mk2(s_table,.rexplist())#0A..}#0A}#0A.#0AAND.rn
exp(n).#3D.VALOF.{.lex();.RESULTIS.rexp(n).}#0A.#0A
AND.rexp(n).#3D.VALOF#0A{.LET.a,.b,.p.#3D.rbexp(),.
0,.0#0A#0A...UNTIL.nlpending.DO.#0A...{.LET.op.#3D.
token#0A.#0A......SWITCHON.op.INTO#0A.#0A......{.DE
FAULT:.......RESULTIS.a#0A.#0A.........CASE.s_lpare
n:.lex()#0A........................b.:#3D.0#0A.....
...................UNLESS.token#3Ds_rparen.DO.b.:#3D
.rexplist()#0A........................UNLESS.token#3D
s_rparen.DO.synerr("')'.missing")#0A...............
.........lex()#0A........................a.:#3D.mk4
(s_fnap,.a,.b,.0)#0A........................LOOP#0A
.#0A.........CASE.s_mthap:{.LET.e1.#3D.0#0A........
.................lex()#0A.........................U
NLESS.token#3Ds_lparen.DO.synerr("'('.missing")#0A.
........................lex()#0A...................
......b.:#3D.0#0A.........................UNLESS.to
ken#3Ds_rparen.DO.b.:#3D.rexplist()#0A.............
............IF.b#3D0.DO.synerr("argument.expression
.missing")#0A.........................UNLESS.token#3D
s_rparen.DO.synerr("')'.missing")#0A...............
..........lex()#0A.........................TEST.h1!
b#3Ds_comma#0A.........................THEN.e1.:#3D
.h2!b#0A.........................ELSE.e1.:#3D.b#0A.
........................a.:#3D.mk3(s_vecap,.mk2(s_r
v,.e1),.a)#0A.........................a.:#3D.mk4(s_
fnap,.a,.b,.0)#0A.........................LOOP#0A..
....................}#0A.#0A.........CASE.s_sbra:..
.b.:#3D.rnexp(0)...//.Inserted.11/6/02#0A..........
..............UNLESS.token#3Ds_sket.DO.synerr("']'.
missing")#0A........................lex()#0A.......
.................a.:#3D.mk3(s_vecap,.a,.b)#0A......
..................LOOP#0A.#0A.........CASE.s_of:...
..p.:#3D.8;.ENDCASE.//.Inserted.11/7/01#0A#0A......
...CASE.s_vecap:..p.:#3D.8;.ENDCASE#0A.........CASE
.s_byteap:.p.:#3D.8;.ENDCASE.//.Changed.from.7.on.1
6.Dec.1999#0A.........CASE.s_mult:#0A.........CASE.
s_div:#0A.........CASE.s_rem:....p.:#3D.6;.ENDCASE#0A
.........CASE.s_plus:#0A.........CASE.s_minus:..p.:
#3D.5;.ENDCASE#0A.#0A.........CASE.s_eq:CASE.s_le:C
ASE.s_ls:#0A.........CASE.s_ne:CASE.s_ge:CASE.s_gr:
#0A........................IF.n>#3D4.RESULTIS.a#0A.
.......................b.:#3D.rnexp(4)#0A..........
..............a.:#3D.mk3(op,.a,.b)#0A..............
..........WHILE..s_eq<#3Dtoken<#3Ds_ge.DO#0A.......
.................{.LET.c.#3D.b#0A..................
.........op.:#3D.token#0A..........................
.b.:#3D.rnexp(4)#0A...........................a.:#3D
.mk3(s_logand,.a,.mk3(op,.c,.b))#0A................
........}#0A........................LOOP#0A.#0A....
.....CASE.s_lshift:#0A.........CASE.s_rshift:.IF.n>
#3D4.RESULTIS.a#0A........................a.:#3D.mk
3(op,.a,.rnexp(4))#0A........................LOOP#0A
#0A.........CASE.s_logand:.p.:#3D.3;.ENDCASE#0A....
.....CASE.s_logor:..p.:#3D.2;.ENDCASE#0A.........CA
SE.s_eqv:#0A.........CASE.s_neqv:...p.:#3D.1;.ENDCA
SE#0A.#0A.........CASE.s_cond:...IF.n>#3D1.RESULTIS
.a#0A........................b.:#3D.rnexp(0)#0A....
....................UNLESS.token#3Ds_comma.DO#0A...
............................synerr("Bad.conditional
.expression")#0A........................a.:#3D.mk4(
s_cond,.a,.b,.rnexp(0))#0A........................L
OOP#0A......}#0A......#0A......IF.n>#3Dp.RESULTIS.a
#0A......a.:#3D.mk3(op,.a,.rnexp(p))#0A...}#0A...#0A
...RESULTIS.a#0A}#0A.#0ALET.rexplist().#3D.VALOF#0A
{.LET.res,.a.#3D.0,.rexp(0)#0A...LET.ptr.#3D.@res#0A
.#0A...WHILE.token#3Ds_comma.DO.{.!ptr.:#3D.mk3(s_c
omma,.a,.0)#0A............................ptr.:#3D.
@h3!(!ptr)#0A............................a.:#3D.rne
xp(0)#0A.........................}#0A...!ptr.:#3D.a
#0A...RESULTIS.res#0A}#0A.#0ALET.rdef(outerlevel).#3D
.VALOF#0A{.LET.n.#3D.rnamelist()#0A...LET.ln.#3D.li
neno#0A#0A...SWITCHON.token.INTO#0A.#0A...{.CASE.s_
lparen:#0A........{.LET.a.#3D.0#0A...........lex()#0A
...........UNLESS.h1!n#3Ds_name.DO.synerr("Bad.form
al.parameter")#0A...........IF.token#3Ds_name.DO.a.
:#3D.rnamelist()#0A...........UNLESS.token#3Ds_rpar
en.DO.synerr("')'.missing")#0A...........lex()#0A.#0A
...........IF.token#3Ds_be.DO#0A...........{.lex()#0A
..............RESULTIS.mk6(s_rtdef,.n,.a,.rcom(),.0
,.ln)#0A...........}#0A.#0A...........IF.token#3Ds_
eq.RESULTIS.mk6(s_fndef,.n,.a,.rnexp(0),.0,.ln)#0A.
#0A...........synerr("Bad.procedure.heading")#0A...
.....}#0A.#0A......DEFAULT:.synerr("Bad.declaration
")#0A.#0A......CASE.s_eq:#0A...........IF.outerleve
l.DO.synerr("Bad.outer.level.declaration")#0A......
.....lex()#0A...........IF.token#3Ds_vec.DO#0A.....
......{.UNLESS.h1!n#3Ds_name.DO.synerr("Name.requir
ed.before.#3D.VEC")#0A..............RESULTIS.mk4(s_
vecdef,.n,.rnexp(0),.ln)#0A...........}#0A.........
..RESULTIS.mk4(s_valdef,.n,.rexplist(),.ln)#0A...}#0A
}#0A.#0ALET.rbcom().#3D.VALOF#0A{.LET.a,.b,.op,.ln.
#3D.0,.0,.token,.lineno#0A.#0A..SWITCHON.token.INTO
#0A..{.DEFAULT:.RESULTIS.0#0A.#0A....CASE.s_name:CA
SE.s_number:CASE.s_string:CASE.s_lparen:#0A....CASE
.s_true:CASE.s_false:CASE.s_lv:CASE.s_rv:CASE.s_vec
ap:#0A....CASE.s_slct:........//.Inserted.11/7/01#0A
....CASE.s_plus:CASE.s_minus:CASE.s_abs:CASE.s_not:
#0A....CASE.s_table:CASE.s_valof:CASE.s_query:#0A..
..........//.All.tokens.that.can.start.an.expressio
n#2E#0A............a.:#3D.rexplist()#0A.#0A........
....IF.token#3Ds_ass.DO#0A............{.op.:#3D.tok
en#0A...............lex()#0A...............RESULTIS
.mk4(op,.a,.rexplist(),.ln)#0A............}#0A.#0A.
...........IF.token#3Ds_colon.DO#0A............{.UN
LESS.h1!a#3Ds_name.DO.synerr("Unexpected.':'")#0A..
.............lex()#0A...............RESULTIS.mk5(s_
colon,.a,.rbcom(),.0,.ln)#0A............}#0A.#0A...
.........IF.h1!a#3Ds_fnap.DO#0A............{.h1!a,.
h4!a.:#3D.s_rtap,.ln#0A...............RESULTIS.a#0A
............}#0A.#0A............synerr("Error.in.co
mmand")#0A............RESULTIS.a#0A.#0A....CASE.s_g
oto:#0A....CASE.s_resultis:#0A............RESULTIS.
mk3(op,.rnexp(0),.ln)#0A.#0A....CASE.s_if:#0A....CA
SE.s_unless:#0A....CASE.s_while:#0A....CASE.s_until
:#0A............a.:#3D.rnexp(0)#0A............IF.to
ken#3Ds_do.DO.lex()#0A............RESULTIS.mk4(op,.
a,.rcom(),.ln)#0A.#0A....CASE.s_test:#0A...........
.a.:#3D.rnexp(0)#0A............IF.token#3Ds_do.DO.l
ex()#0A............b.:#3D.rcom()#0A............UNLE
SS.token#3Ds_else.DO.synerr("ELSE.missing")#0A.....
.......lex()#0A............RESULTIS.mk5(s_test,.a,.
b,.rcom(),.ln)#0A.#0A....CASE.s_for:#0A.........{.L
ET.i,.j,.k.#3D.0,.0,.0#0A............lex()#0A......
......a.:#3D.rname()#0A............UNLESS.token#3Ds
_eq.DO.synerr("'#3D'.missing")#0A............i.:#3D
.rnexp(0)#0A............UNLESS.token#3Ds_to.DO.syne
rr("TO.missing")#0A............j.:#3D.rnexp(0)#0A..
..........IF.token#3Ds_by.DO.k.:#3D.rnexp(0)#0A....
........IF.token#3Ds_do.DO.lex()#0A............RESU
LTIS.mk7(s_for,.a,.i,.j,.k,.rcom(),.ln)#0A.........
}#0A.#0A....CASE.s_skip:#0A....CASE.s_loop:#0A....C
ASE.s_break:#0A....CASE.s_return:#0A....CASE.s_fini
sh:#0A....CASE.s_endcase:#0A............lex()#0A...
.........RESULTIS.mk2(op,.ln)#0A.#0A....CASE.s_swit
chon:#0A............a.:#3D.rnexp(0)#0A............U
NLESS.token#3Ds_into.DO.synerr("INTO.missing")#0A..
..........lex()#0A............{.LET.skipln.#3D.line
no#0A..............b.:#3D.rdsect(rdseq)#0A.........
.....UNLESS.b.DO#0A................b.:#3D.mk2(s_ski
p,.skipln).........//.MR.5/4/06#0A............}#0A.
...........RESULTIS.mk4(s_switchon,.a,.b,.ln)#0A.#0A
....CASE.s_case:#0A............a.:#3D.rnexp(0)#0A..
..........UNLESS.token#3Ds_colon.DO.synerr("Bad.CAS
E.label")#0A............lex()#0A............RESULTI
S.mk4(s_case,.a,.rbcom(),.ln)#0A.#0A....CASE.s_defa
ult:#0A............lex()#0A............UNLESS.token
#3Ds_colon.DO.synerr("Bad.DEFAULT.label")#0A.......
.....lex()#0A............RESULTIS.mk3(s_default,.rb
com(),.ln)#0A.#0A....CASE.s_lsect:#0A............a.
:#3D.rdsect(rdblockbody,.FALSE)#0A............UNLES
S.a.DO#0A..............a.:#3D.mk2(s_skip,.ln)......
..//.MR.5/4/06#0A............RESULTIS.a#0A..}#0A}#0A
#0AAND.rcom().#3D.VALOF#0A{.LET.a.#3D.rbcom()#0A.#0A
...//.Empty.section.brackets.{.}.form.SKIP.nodes,.M
R.22/6/05#0A...IF.a#3D0.DO.synerr("Error.in.command
")#0A.#0A...WHILE.token#3Ds_repeat.|.token#3Ds_repe
atwhile.|.token#3Ds_repeatuntil.DO#0A...{.LET.op,.l
n.#3D.token,.lineno#0A......UNLESS.op#3Ds_repeat.{.
a.:#3D.mk4(op,.a,.rnexp(0),.ln);.LOOP.}#0A......a.:
#3D.mk3(op,.a,.ln)#0A......lex()#0A...}#0A.#0A...RE
SULTIS.a#0A}#0A/*#0ALET.plist(x).BE#0A{.writef("*nN
ame.table.contents,.size.#3D.%n*n",.nametablesize)#0A
...FOR.i.#3D.0.TO.nametablesize-1.DO#0A...{.LET.p,.
n.#3D.nametable!i,.0#0A......UNTIL.p#3D0.DO.p,.n.:#3D
.p!1,.n+1#0A......writef("%i3:%n",.i,.n)#0A......p.
:#3D.nametable!i#0A......UNTIL.p#3D0.DO.{.writef(".
%s",.p+2);.p.:#3D.p!1..}#0A......newline()#0A...}#0A
}#0A*/#0ALET.plist(x,.n,.d).BE#0A{.LET.size,.ln.#3D
.0,.0#0A...LET.v.#3D.TABLE.0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0#0A#0A...IF.x#3D0.DO.{.writes("Nil")
;.RETURN..}#0A.#0A...SWITCHON.h1!x.INTO#0A...{.CASE
.s_number:.writen(h2!x);.........RETURN#0A.#0A.....
.CASE.s_name:...writes(x+2);..........RETURN#0A.#0A
......CASE.s_string:.writef("*"%s*"",x+1);.RETURN#0A
.#0A......CASE.s_for:....size,.ln.:#3D.6,.h7!x;..EN
DCASE#0A.#0A......CASE.s_fndef:CASE.s_rtdef:#0A....
.................size,.ln.:#3D.4,.h6!x;..ENDCASE#0A
#0A......CASE.s_cond:#0A......CASE.s_slct:.......//
.Inserted.11/7/01#0A.....................size.:#3D.
4;............ENDCASE#0A.#0A......CASE.s_test:CASE.
s_constdef:#0A.....................size,.ln.:#3D.4,
.h5!x;..ENDCASE#0A.#0A......CASE.s_needs:CASE.s_sec
tion:CASE.s_vecap:CASE.s_byteap:CASE.s_fnap:#0A....
..CASE.s_of:..//.Inserted.11/7/01#0A......CASE.s_mu
lt:CASE.s_div:CASE.s_rem:CASE.s_plus:CASE.s_minus:#0A
......CASE.s_eq:CASE.s_ne:CASE.s_ls:CASE.s_gr:CASE.
s_le:CASE.s_ge:#0A......CASE.s_lshift:CASE.s_rshift
:CASE.s_logand:CASE.s_logor:#0A......CASE.s_eqv:CAS
E.s_neqv:CASE.s_comma:#0A......CASE.s_seq:#0A......
...............size.:#3D.3;............ENDCASE#0A..
...................#0A......CASE.s_valdef:CASE.s_ve
cdef:#0A.....................size,.ln.:#3D.3,.h4!x;
..ENDCASE#0A#0A......CASE.s_colon:#0A..............
.......size,.ln.:#3D.3,.h5!x;..ENDCASE#0A.#0A......
CASE.s_and:#0A......CASE.s_ass:CASE.s_rtap:CASE.s_i
f:CASE.s_unless:#0A......CASE.s_while:CASE.s_until:
CASE.s_repeatwhile:#0A......CASE.s_repeatuntil:#0A.
.....CASE.s_switchon:CASE.s_case:CASE.s_let:#0A....
..CASE.s_manifest:CASE.s_static:CASE.s_global:#0A..
...................size,.ln.:#3D.3,.h4!x;..ENDCASE#0A
.#0A......CASE.s_valof:CASE.s_lv:CASE.s_rv:CASE.s_n
eg:CASE.s_not:#0A......CASE.s_table:CASE.s_abs:#0A.
....................size.:#3D.2;............ENDCASE
#0A.#0A......CASE.s_goto:CASE.s_resultis:CASE.s_rep
eat:CASE.s_default:#0A.....................size,.ln
.:#3D.2,.h3!x;..ENDCASE#0A.#0A......CASE.s_true:CAS
E.s_false:CASE.s_query:#0A.....................size
.:#3D.1;............ENDCASE#0A......#0A......CASE.s
_skip:.//.MR.22/6/05#0A......CASE.s_loop:CASE.s_bre
ak:CASE.s_return:#0A......CASE.s_finish:CASE.s_endc
ase:#0A.....................size,.ln.:#3D.1,.h2!x;.
.ENDCASE#0A#0A......DEFAULT:.......size.:#3D.1#0A..
.}#0A.#0A...IF.n#3Dd.DO.{.writes("Etc");.RETURN.}#0A
.#0A//...writef("Op.%n",.h1!x)#0A...writef(opname(h
1!x),.h1!x)#0A//.IF.ln>0.DO.writef("..line.%n",.ln)
#0A...IF.ln>0.DO#0A...{.LET.fno.#3D.ln>>20#0A.....L
ET.lno.#3D.ln.&.#23xFFFFF#0A.....LET.filename.#3D.s
ourcenamev!fno#0A.....writef("..")#0A.....IF.filena
me.DO.writef("%s",.filename)#0A.....writef("[%n]",.
lno)#0A...}#0A...FOR.i.#3D.2.TO.size.DO.{.newline()
#0A...........................FOR.j#3D0.TO.n-1.DO.w
rites(.v!j.)#0A...........................writes("*
*-")#0A...........................v!n.:#3D.i#3Dsize
->"..","!."#0A...........................plist(h1!(
x+i-1),.n+1,.d)#0A........................}#0A}#0A.
#0AAND.opname(op).#3D.VALOF.SWITCHON.op.INTO#0A{.DE
FAULT:............RESULTIS."Op.%n"#0A#0A..CASE.s_ab
s:.........RESULTIS."ABS"#0A..CASE.s_and:.........R
ESULTIS."AND"#0A..CASE.s_ass:.........RESULTIS."ASS
"#0A..CASE.s_be:..........RESULTIS."BE"#0A..CASE.s_
by:..........RESULTIS."BY"#0A..CASE.s_break:.......
RESULTIS."BREAK"#0A..CASE.s_byteap:......RESULTIS."
BYTEAP"#0A..CASE.s_case:........RESULTIS."CASE"#0A.
.CASE.s_colon:.......RESULTIS."COLON"#0A..CASE.s_co
mma:.......RESULTIS."COMMA"#0A..CASE.s_cond:.......
.RESULTIS."COND"#0A..CASE.s_constdef:....RESULTIS."
CONSTDEF"#0A..CASE.s_default:.....RESULTIS."DEFAULT
"#0A..CASE.s_div:.........RESULTIS."DIV"#0A..CASE.s
_do:..........RESULTIS."DO"#0A..CASE.s_dot:........
.RESULTIS."DOT"#0A..CASE.s_else:........RESULTIS."E
LSE"#0A..CASE.s_eof:.........RESULTIS."EOF"#0A..CAS
E.s_endcase:.....RESULTIS."ENDCASE"#0A..CASE.s_eq:.
.........RESULTIS."EQ"#0A..CASE.s_eqv:.........RESU
LTIS."EQV"#0A..CASE.s_false:.......RESULTIS."FALSE"
#0A..CASE.s_finish:......RESULTIS."FINISH"#0A..CASE
.s_fnap:........RESULTIS."FNAP"#0A..CASE.s_fndef:..
.....RESULTIS."FNDEF"#0A..CASE.s_for:.........RESUL
TIS."FOR"#0A..CASE.s_ge:..........RESULTIS."GE"#0A.
.CASE.s_get:.........RESULTIS."GET"#0A..CASE.s_glob
al:......RESULTIS."GLOBAL"#0A..CASE.s_goto:........
RESULTIS."GOTO"#0A..CASE.s_gr:..........RESULTIS."G
R"#0A..CASE.s_if:..........RESULTIS."IF"#0A..CASE.s
_into:........RESULTIS."INTO"#0A..CASE.s_le:.......
...RESULTIS."LE"#0A..CASE.s_let:.........RESULTIS."
LET"#0A..CASE.s_logand:......RESULTIS."LOGAND"#0A..
CASE.s_logor:.......RESULTIS."LOGOR"#0A..CASE.s_loo
p:........RESULTIS."LOOP"#0A..CASE.s_lparen:......R
ESULTIS."LPAREN"#0A..CASE.s_ls:..........RESULTIS."
LS"#0A..CASE.s_lsect:.......RESULTIS."LSECT"#0A..CA
SE.s_lshift:......RESULTIS."LSHIFT"#0A..CASE.s_lv:.
.........RESULTIS."LV"#0A..CASE.s_manifest:....RESU
LTIS."MANIFEST"#0A..CASE.s_mthap:.......RESULTIS."M
THAP"#0A..CASE.s_minus:.......RESULTIS."MINUS"#0A..
CASE.s_mult:........RESULTIS."MULT"#0A..CASE.s_name
:........RESULTIS."NAME"#0A..CASE.s_ne:..........RE
SULTIS."NE"#0A..CASE.s_needs:.......RESULTIS."NEEDS
"#0A..CASE.s_neg:.........RESULTIS."NEG"#0A..CASE.s
_neqv:........RESULTIS."NEQV"#0A..CASE.s_not:......
...RESULTIS."NOT"#0A..CASE.s_number:......RESULTIS.
"NUMBER"#0A..CASE.s_of:..........RESULTIS."OF"#0A..
CASE.s_plus:........RESULTIS."PLUS"#0A..CASE.s_quer
y:.......RESULTIS."QUERY"#0A..CASE.s_rem:.........R
ESULTIS."REM"#0A..CASE.s_repeat:......RESULTIS."REP
EAT"#0A..CASE.s_repeatuntil:.RESULTIS."REPEATUNTIL"
#0A..CASE.s_repeatwhile:.RESULTIS."REPEATWHILE"#0A.
.CASE.s_resultis:....RESULTIS."RESULTIS"#0A..CASE.s
_return:......RESULTIS."RETURN"#0A..CASE.s_rparen:.
.....RESULTIS."RPAREN"#0A..CASE.s_rshift:......RESU
LTIS."RSHIFT"#0A..CASE.s_rsect:.......RESULTIS."RSE
CT"#0A..CASE.s_rtap:........RESULTIS."RTAP"#0A..CAS
E.s_rtdef:.......RESULTIS."RTDEF"#0A..CASE.s_rv:...
.......RESULTIS."RV"#0A..CASE.s_sbra:........RESULT
IS."SBRA"#0A..CASE.s_section:.....RESULTIS."SECTION
"#0A..CASE.s_semicolon:...RESULTIS."SEMICOLON"#0A..
CASE.s_seq:.........RESULTIS."SEQ"#0A..CASE.s_sket:
........RESULTIS."SKET"#0A..CASE.s_skip:........RES
ULTIS."SKIP"#0A..CASE.s_static:......RESULTIS."STAT
IC"#0A..CASE.s_string:......RESULTIS."STRING"#0A..C
ASE.s_switchon:....RESULTIS."SWITCHON"#0A..CASE.s_t
able:.......RESULTIS."TABLE"#0A..CASE.s_test:......
..RESULTIS."TEST"#0A..CASE.s_to:..........RESULTIS.
"TO"#0A..CASE.s_true:........RESULTIS."TRUE"#0A..CA
SE.s_unless:......RESULTIS."UNLESS"#0A..CASE.s_unti
l:.......RESULTIS."UNTIL"#0A..CASE.s_valdef:......R
ESULTIS."VALDEF"#0A..CASE.s_valof:.......RESULTIS."
VALOF"#0A..CASE.s_vec:.........RESULTIS."VEC"#0A..C
ASE.s_vecap:.......RESULTIS."VECAP"#0A..CASE.s_vecd
ef:......RESULTIS."VECDEF"#0A..CASE.s_while:.......
RESULTIS."WHILE"#0A}#0A#0A//#2E#0A#0A//SECTION."TRN
"#0A#0A//....TRNHDR#0A.#0A//GET."libhdr"#0A//GET."b
cplfecg"#0A.#0AGLOBAL..{#0Atrnext:trng#0Atrans;.dec
lnames;.decldyn#0Adeclstat;.checkdistinct;.addname;
.cellwithname#0Atransdef;.scanlabel#0Adecllabels;.u
ndeclare#0Ajumpcond;.transswitch;.transfor#0Aassign
;.load;.fnbody;.loadlv;.loadlist#0Aisconst.evalcons
t;.transname;.xref#0Anextlab;.labnumber#0Anewblk#0A
dvec;.dvece;.dvecp;.dvect#0Acaselist;.casecount#0Ac
ontext;.comline;.procname#0Aresultlab;.defaultlab;.
endcaselab#0Alooplab;.breaklab;.ssp;.vecssp#0Agdefl
ist;.gdefcount#0Aoutstring;.out1;.out2#0A}#0A#0ALET
.nextlab().#3D.VALOF#0A{.labnumber.:#3D.labnumber.+
.1#0A..RESULTIS.labnumber#0A}#0A.#0AAND.trnerr(mess
,.a).BE#0A{.LET.fno.#3D.comline>>20#0A..LET.lno.#3D
.comline.&.#23xFFFFF#0A..LET.filename.#3D.sourcenam
ev!fno#0A..writes("Error.")#0A..UNLESS.procname#3D0
.DO.writef("in.%s.",.@h3!procname)#0A..writef("near
.")#0A..IF.filename.DO.writef("%s",.filename)#0A..w
ritef("[%n]:.",.lno)#0A..writef(mess,.a)#0A..newlin
e()#0A..errcount.:#3D.errcount.+.1#0A..IF.errcount.
>#3D.errmax.DO.{.writes("*nCompilation.aborted*n")#0A
.............................longjump(fin_p,.fin_l)
#0A...........................}#0A}#0A#0AAND.newblk
(x,.y,.z).#3D.VALOF#0A{.LET.p.#3D.dvect.-.3#0A..IF.
dvece>p.DO.{.errmax.:#3D.0........//.Make.it.fatal#2E
#0A..................trnerr("More.workspace.needed"
)#0A................}#0A..p!0,.p!1,.p!2.:#3D.x,.y,.
z#0A..dvect.:#3D.p#0A..RESULTIS.p#0A}#0A#0AAND.tran
slate(x).BE#0A{.dvec,..dvect.:#3D.treevec,.treep#0A
..h1!dvec,.h2!dvec,.h3!dvec.:#3D.0,.0,.0#0A..dvece.
:#3D.dvec+3#0A..dvecp.:#3D.dvece#0A//selectoutput(s
ysprint)#0A..FOR.i.#3D.0.TO.nametablesize-1.DO#0A..
{.LET.name.#3D.nametable!i#0A....UNTIL.name#3D0.DO#0A
....{.LET.next.#3D.h2!name#0A......h2!name.:#3D.0./
/.Mark.undeclared#0A//...writef("Undeclare.%s*n",.n
ame+2)#0A......name.:#3D.next#0A....}#0A..}#0A#0A..
gdeflist,.gdefcount.:#3D.0,.0#0A..caselist,.casecou
nt,.defaultlab.:#3D.0,.-1,.0#0A..resultlab,.breakla
b,.looplab,.endcaselab.:#3D.-2,.-2,.-2,.-2#0A..cont
ext,.comline,.procname,.labnumber.:#3D.0,.1,.0,.0#0A
..ssp,.vecssp.:#3D.savespacesize,.savespacesize#0A#0A
..WHILE.x~#3D0.&.(h1!x#3Ds_section.|.h1!x#3Ds_needs
).DO#0A..{.LET.op,.a.#3D.h1!x,.h2!x#0A....out1(op)#0A
....outstring(@h2!a)#0A....x:#3Dh3!x#0A..}#0A#0A..t
rans(x,.0)#0A..out2(s_global,.gdefcount)#0A..UNTIL.
gdeflist#3D0.DO.{.out2(h2!gdeflist,.h3!gdeflist)#0A
........................gdeflist.:#3D.h1!gdeflist#0A
......................}..#0A}#0A#0ALET.trnext(next)
.BE.{.IF.next<0.DO.out1(s_rtrn)#0A.................
.....IF.next>0.DO.out2(s_jump,.next)#0A............
........}#0A.#0ALET.trans(x,.next).BE#0A//.x.......
is.the.command.to.translate#0A//.next<0..compile.x.
followed.by.RTRN#0A//.next>0..compile.x.followed.by
.JUMP.next#0A//.next#3D0..compile.x.only#0A{.LET.sw
.#3D.FALSE#0A...IF.x#3D0.DO.{.trnext(next);.RETURN.
}#0A.#0A...SWITCHON.h1!x.INTO#0A...{.DEFAULT:.trner
r("Compiler.error.in.Trans");.RETURN#0A.#0A......CA
SE.s_let:#0A......{.LET.cc.#3D.casecount#0A........
.LET.e,.s,.s1.#3D.dvece,.ssp,.0#0A.........LET.v.#3D
.vecssp#0A.........casecount.:#3D.-1.//.Disallow.CA
SE.and.DEFAULT.labels#0A.........context,.comline.:
#3D.x,.h4!x#0A.........declnames(h2!x)#0A.........c
heckdistinct(e)#0A.........vecssp,.s1.:#3D.ssp,.ssp
#0A.........ssp.:#3D.s#0A.........context,.comline.
:#3D.x,.h4!x#0A.........transdef(h2!x)#0A.........U
NLESS.ssp#3Ds1.DO.trnerr("Lhs.and.rhs.do.not.match"
)#0A.........UNLESS.ssp#3Dvecssp.DO.{.ssp.:#3D.vecs
sp;.out2(s_stack,.ssp).}#0A.........out1(s_store)#0A
.........decllabels(h3!x)#0A.........trans(h3!x,.ne
xt)#0A.........vecssp.:#3D.v#0A.........UNLESS.ssp#3D
s.DO.out2(s_stack,.s)#0A.........ssp.:#3D.s#0A.....
....casecount.:#3D.cc#0A.........undeclare(e)#0A...
......RETURN#0A......}#0A.#0A......CASE.s_static:#0A
......CASE.s_global:#0A......CASE.s_manifest:#0A...
...{.LET.cc.#3D.casecount#0A.........LET.e,.s.#3D.d
vece,.ssp#0A.........AND.op.#3D.h1!x#0A.........AND
.y,.n.#3D.h2!x,.0#0A.........LET.prevk.#3D.-1#0A...
......#0A.........casecount.:#3D.-1.//.Disallow.CAS
E.and.DEFAULT.labels#0A.........context,.comline.:#3D
.x,.h4!x#0A.#0A.........UNTIL.y#3D0.DO#0A.........{
.context,.comline.:#3D.y,.h5!y#0A............n.:#3D
.h4!y.->.evalconst(h4!y),.prevk+1#0A............con
text,.comline.:#3D.y,.h5!y#0A............prevk.:#3D
.n#0A............IF.op#3Ds_static.DO.{.LET.k.#3D.n#0A
.................................n.:#3D.nextlab()#0A
.................................out2(s_datalab,.n)
#0A.................................out2(s_itemn,.k
)#0A..............................}#0A............I
F.op#3Ds_global.UNLESS.0<#3Dn<#3D65535.DO#0A.......
........trnerr("Global.number.too.large.for:.%s*n",
.@h3!(h3!y))#0A............addname(h3!y,.op,.n)#0A.
...........IF.xrefing.DO.xref(h3!y,#0A.............
..................(op#3Ds_global->"G:",op#3Ds_stati
c->"S:","M:"),#0A...............................n,#0A
...............................s_constdef#0A.......
.......................)#0A............y.:#3D.h2!y#0A
.........}#0A.#0A.........decllabels(h3!x)#0A......
...trans(h3!x,.next)#0A.........ssp.:#3D.s#0A......
...casecount.:#3D.cc#0A.........undeclare(e)#0A....
.....RETURN#0A......}#0A.#0A.#0A......CASE.s_ass:#0A
.........context,.comline.:#3D.x,.h4!x#0A.........a
ssign(h2!x,.h3!x)#0A.........trnext(next)#0A.......
..RETURN#0A.#0A......CASE.s_rtap:#0A......{.LET.s.#3D
.ssp#0A.........context,.comline.:#3D.x,.h4!x#0A...
......ssp.:#3D.ssp+savespacesize#0A.........out2(s_
stack,.ssp)#0A.........loadlist(h3!x)#0A.........lo
ad(h2!x)#0A.........out2(s_rtap,.s)#0A.........ssp.
:#3D.s#0A.........trnext(next)#0A.........RETURN#0A
......}#0A.#0A......CASE.s_goto:#0A.........context
,.comline.:#3D.x,.h3!x#0A.........load(h2!x)#0A....
.....out1(s_goto)#0A.........ssp.:#3D.ssp-1#0A.....
....RETURN#0A.#0A......CASE.s_colon:#0A.........con
text,.comline.:#3D.x,.h5!x#0A.........out2(s_lab,.h
4!x)#0A.........trans(h3!x,.next)#0A.........RETURN
#0A.#0A......CASE.s_unless:.sw.:#3D.TRUE#0A......CA
SE.s_if:#0A.........context,.comline.:#3D.x,.h4!x#0A
.........TEST.next>0.THEN.{.jumpcond(h2!x,.sw,.next
)#0A.............................trans(h3!x,.next)#0A
..........................}#0A.....................
ELSE.{.LET.l.#3D.nextlab()#0A......................
.......jumpcond(h2!x,.sw,.l)#0A....................
.........trans(h3!x,.next)#0A......................
.......out2(s_lab,.l)#0A...........................
..trnext(next)#0A..........................}#0A....
.....RETURN#0A.#0A......CASE.s_test:#0A......{.LET.
l,.m.#3D.nextlab(),.0#0A.........context,.comline.:
#3D.x,.h5!x#0A.........jumpcond(h2!x,.FALSE,.l)#0A.
........#0A.........TEST.next#3D0.THEN.{.m.:#3D.nex
tlab();.trans(h3!x,.m).}#0A.....................ELS
E.trans(h3!x,.next)#0A.....................#0A.....
....out2(s_lab,.l)#0A.........trans(h4!x,.next)#0A.
........UNLESS.m#3D0.DO.out2(s_lab,.m)#0A.........R
ETURN#0A......}#0A.#0A......CASE.s_loop:#0A........
.context,.comline.:#3D.x,.h2!x#0A.........IF.loopla
b<0.DO.trnerr("Illegal.use.of.LOOP")#0A.........IF.
looplab#3D0.DO.looplab.:#3D.nextlab()#0A.........ou
t2(s_jump,.looplab)#0A.........RETURN#0A.#0A......C
ASE.s_break:#0A.........context,.comline.:#3D.x,.h2
!x#0A.........IF.breaklab#3D-2.DO.trnerr("Illegal.u
se.of.BREAK")#0A.........IF.breaklab#3D-1.DO.{.out1
(s_rtrn);.RETURN.}#0A.........IF.breaklab#3D.0.DO.b
reaklab.:#3D.nextlab()#0A.........out2(s_jump,.brea
klab)#0A.........RETURN#0A.#0A......CASE.s_return:#0A
.........context,.comline.:#3D.x,.h2!x#0A.........o
ut1(s_rtrn)#0A.........RETURN#0A.#0A......CASE.s_sk
ip:..//.MR.05/4/06#0A.........trnext(next)#0A......
...RETURN#0A#0A......CASE.s_finish:#0A.........cont
ext,.comline.:#3D.x,.h2!x#0A.........out1(s_finish)
#0A.........RETURN#0A.#0A......CASE.s_resultis:#0A.
........context,.comline.:#3D.x,.h3!x#0A.........IF
.resultlab#3D-1.DO.{.fnbody(h2!x);.RETURN.}#0A.....
....UNLESS.resultlab>0.DO.trnerr("RESULTIS.out.of.c
ontext")#0A.........load(h2!x)#0A.........out2(s_re
s,.resultlab)#0A.........ssp.:#3D.ssp.-.1#0A.......
..RETURN#0A.#0A......CASE.s_while:.sw.:#3D.TRUE#0A.
.....CASE.s_until:#0A......{.LET.l,.m.#3D.nextlab()
,.next#0A.........LET.bl,.ll.#3D.breaklab,.looplab#0A
.........context,.comline.:#3D.x,.h4!x#0A.........b
reaklab,.looplab.:#3D.next,.0#0A.........IF.next<#3D
0.DO.m.:#3D.nextlab()#0A.........IF.next.#3D0.DO.br
eaklab.:#3D.m#0A.........jumpcond(h2!x,.~sw,.m)#0A.
........out2(s_lab,.l)#0A.........trans(h3!x,.0)#0A
.........UNLESS.looplab#3D0.DO.out2(s_lab,.looplab)
#0A.........context,.comline.:#3D.x,.h4!x#0A.......
..jumpcond(h2!x,.sw,.l)#0A.........IF.next<#3D0.DO.
out2(s_lab,.m)#0A.........trnext(next)#0A.........b
reaklab,.looplab.:#3D.bl,.ll#0A.........RETURN#0A..
....}#0A.#0A......CASE.s_repeatwhile:.sw.:#3D.TRUE#0A
......CASE.s_repeatuntil:#0A......{.LET.l,.bl,.ll.#3D
.nextlab(),.breaklab,.looplab#0A.........context,.c
omline.:#3D.x,.h4!x#0A.........breaklab,.looplab.:#3D
.next,.0#0A.........out2(s_lab,.l)#0A.........trans
(h2!x,.0)#0A.........UNLESS.looplab#3D0.DO.out2(s_l
ab,.looplab)#0A.........context,.comline.:#3D.x,.h4
!x#0A.........jumpcond(h3!x,.sw,.l)#0A#0A//.......U
NLESS.breaklab#3D0.DO.out2(s_lab,.breaklab)#0A.....
....IF.next#3D0.&.breaklab>0.DO.out2(s_lab,.breakla
b)#0A#0A.........trnext(next)#0A.........breaklab,.
looplab.:#3D.bl,.ll#0A.........RETURN#0A......}#0A.
#0A......CASE.s_repeat:#0A......{.LET.bl,.ll.#3D.br
eaklab,.looplab#0A.........context,.comline.:#3D.x,
.h4!x#0A.........breaklab,.looplab.:#3D.next,.nextl
ab()#0A.........out2(s_lab,.looplab)#0A#0A.........
trans(h2!x,.looplab)#0A#0A.........IF.next#3D0.&.br
eaklab>0.DO.out2(s_lab,.breaklab)#0A#0A.........bre
aklab,.looplab.:#3D.bl,.ll#0A.........RETURN#0A....
..}#0A.#0A......CASE.s_case:#0A......{.LET.l,.k,.cl
.#3D.nextlab(),.?,.caselist#0A.........context,.com
line.:#3D.x,.h4!x#0A.........k.:#3D.evalconst(h2!x)
#0A.........IF.casecount<0.DO.trnerr("CASE.label.ou
t.of.context")#0A.........UNTIL.cl#3D0.DO#0A.......
..{.IF.h2!cl#3Dk.DO.trnerr("'CASE.%n:'.occurs.twice
",.k)#0A............cl.:#3D.h1!cl#0A.........}#0A..
.......caselist.:#3D.newblk(caselist,.k,.l)#0A.....
....casecount.:#3D.casecount.+.1#0A.........out2(s_
lab,.l)#0A.........trans(h3!x,.next)#0A.........RET
URN#0A......}#0A.#0A......CASE.s_default:#0A.......
..context,.comline.:#3D.x,.h3!x#0A.........IF.casec
ount<0.|.defaultlab~#3D0.DO.trnerr("Bad.DEFAULT.lab
el")#0A.........defaultlab.:#3D.nextlab()#0A.......
..out2(s_lab,.defaultlab)#0A.........trans(h2!x,.ne
xt)#0A.........RETURN#0A.#0A......CASE.s_endcase:#0A
.........context,.comline.:#3D.x,.h2!x#0A.........I
F.endcaselab#3D-2.DO.trnerr("Illegal.use.of.ENDCASE
")#0A.........IF.endcaselab#3D-1.DO.out1(s_rtrn)#0A
.........//.endcaselab.is.never.equal.to.0#0A......
...IF.endcaselab>0..DO.out2(s_jump,.endcaselab)#0A.
........RETURN#0A.#0A......CASE.s_switchon:#0A.....
....transswitch(x,.next)#0A.........RETURN#0A.#0A..
....CASE.s_for:#0A.........transfor(x,.next)#0A....
.....RETURN#0A.#0A......CASE.s_seq:#0A.........tran
s(h2!x,.0)#0A.........x.:#3D.h3!x#0A...}#0A}.REPEAT
#0A#0ALET.declnames(x).BE.UNLESS.x#3D0.SWITCHON.h1!
x.INTO#0A.#0A{..DEFAULT:.......trnerr("Compiler.err
or.in.Declnames")#0A...................RETURN#0A.#0A
....CASE.s_vecdef:#0A....CASE.s_valdef:.context,.co
mline.:#3D.x,.h4!x#0A...................decldyn(h2!
x)#0A...................RETURN#0A.#0A....CASE.s_rtd
ef:#0A....CASE.s_fndef:..context,.comline.:#3D.x,.h
6!x#0A...................h5!x.:#3D.nextlab()#0A....
...............declstat(h2!x,.h5!x)#0A.............
......RETURN#0A.#0A....CASE.s_and:....declnames(h2!
x)#0A...................declnames(h3!x)#0A}#0A.#0AA
ND.decldyn(x).BE.UNLESS.x#3D0.DO#0A.#0A{.IF.h1!x#3D
s_name..DO.{.addname(x,.s_local,.ssp)#0A...........
..............//IF.xrefing.DO.xref(x,."P:",.ssp,.h1
!context)#0A.........................ssp.:#3D.ssp.+
.1#0A.........................RETURN#0A............
..........}#0A.#0A...IF.h1!x#3Ds_comma.DO.{.addname
(h2!x,.s_local,.ssp)#0A.........................//I
F.xrefing.DO.xref(h2!x,."P:",.ssp,.h1!context)#0A..
.......................ssp.:#3D.ssp.+.1#0A.........
................decldyn(h3!x)#0A...................
......RETURN#0A......................}#0A.#0A...trn
err("Compiler.error.in.Decldyn")#0A}#0A.#0AAND.decl
stat(x,.lab).BE#0A{.LET.c.#3D.cellwithname(x)#0A.#0A
..TEST.h2!c#3Ds_global.THEN.{.LET.gn.#3D.h3!c#0A...
.........................gdeflist.:#3D.newblk(gdefl
ist,.gn,.lab)#0A............................gdefcou
nt.:#3D.gdefcount.+.1#0A...........................
.addname(x,.s_global,.gn)#0A.......................
.....IF.xrefing.DO.xref(x,."G:",.gn,.h1!context)#0A
............................IF.gdefsing.DO.writef("
G%i3.#3D.%s*n",.gn,.@h3!x)#0A......................
....}#0A.....................ELSE.{.addname(x,.s_la
bel,.lab)#0A............................IF.xrefing.
DO.xref(x,."F:",.lab,.h1!context)#0A...............
...........}#0A}#0A.#0AAND.decllabels(x).BE#0A{.LET
.e.#3D.dvece#0A..scanlabels(x)#0A..checkdistinct(e)
#0A}#0A.#0AAND.checkdistinct(p).BE#0A{.LET.lim.#3D.
dvece.-.3#0A..FOR.q.#3D.p.TO.lim-3.BY.3.DO#0A..{.LE
T.n.#3D.h1!q#0A....FOR.c.#3D.q+3.TO.lim.BY.3.DO#0A.
.......IF.h1!c#3Dn.DO.trnerr("Name.%s.defined.twice
",.@h3!n)#0A..}#0A}#0A.#0AAND.addname(name,.k,.a).B
E#0A{.LET.p.#3D.dvece.+.3#0A..IF.p>dvect.DO.trnerr(
"More.workspace.needed")#0A..h1!dvece,.h2!dvece,.h3
!dvece.:#3D.name,.k,.a#0A..h2!name.:#3D.dvece.//.Re
member.the.declaration#0A..dvece.:#3D.p#0A}#0A.#0AA
ND.undeclare(e).BE.#0A{.FOR.t.#3D.e.TO.dvece-3.BY.3
.DO#0A..{.LET.name.#3D.h1!t#0A....h2!name.:#3D.0...
//.Forget.its.declaration#0A..}#0A..dvece.:#3D.e#0A
}#0A#0AAND.cellwithname(n).#3D.VALOF#0A{.LET.t.#3D.
h2!n#0A..IF.t.RESULTIS.t..//.It.has.been.looked.up.
before#0A..t.:#3D.dvece#0A..t.:#3D.t.-.3.REPEATUNTI
L.h1!t#3Dn.|.h1!t#3D0#0A..h2!n.:#3D.t..//.Associate
.the.name.with.declaration.item#0A..RESULTIS.t#0A}#0A
.#0AAND.scanlabels(x).BE.UNLESS.x#3D0.SWITCHON.h1!x
.INTO#0A.#0A{.CASE.s_colon:...context,.comline.:#3D
.x,.h5!x#0A..................h4!x.:#3D.nextlab()#0A
..................declstat(h2!x,.h4!x)#0A.#0A..CASE
.s_if:.CASE.s_unless:.CASE.s_while:.CASE.s_until:#0A
..CASE.s_switchon:.CASE.s_case:#0A.................
.scanlabels(h3!x)#0A..................RETURN#0A.#0A
..CASE.s_seq:.....scanlabels(h3!x)#0A.#0A..CASE.s_r
epeat:.CASE.s_repeatwhile:.CASE.s_repeatuntil:#0A..
CASE.s_default:.scanlabels(h2!x)#0A................
..RETURN#0A.#0A..CASE.s_test:....scanlabels(h3!x)#0A
..................scanlabels(h4!x)#0A..DEFAULT:....
....RETURN#0A}#0A.#0AAND.transdef(x).BE#0A{.LET.ctx
t,.ln.#3D.context,.comline#0A..transdyndefs(x)#0A..
context,.comline.:#3D.ctxt,.ln#0A..IF.statdefs(x).D
O.{.LET.l,.s#3D.nextlab(),.ssp#0A..................
....out2(s_jump,.l)#0A......................transst
atdefs(x)#0A......................ssp.:#3D.s#0A....
..................out2(s_stack,.ssp)#0A............
..........out2(s_lab,.l)#0A....................}#0A
..context,.comline.:#3D.ctxt,.ln#0A}#0A.#0A.#0AAND.
transdyndefs(x).BE.SWITCHON.h1!x.INTO#0A{.CASE.s_an
d:....transdyndefs(h2!x)#0A.................transdy
ndefs(h3!x)#0A.................RETURN#0A.#0A..CASE.
s_vecdef:.context,.comline.:#3D.x,.h4!x#0A.........
........out2(s_llp,.vecssp)#0A.................ssp.
:#3D.ssp.+.1#0A.................vecssp.:#3D.vecssp.
+.1.+.evalconst(h3!x)#0A.................RETURN#0A.
#0A..CASE.s_valdef:.context,.comline.:#3D.h3!x,.h4!
x#0A.................loadlist(h3!x)#0A.#0A..DEFAULT
:.......RETURN#0A}#0A.#0AAND.transstatdefs(x).BE.SW
ITCHON.h1!x.INTO#0A{.CASE.s_and:..transstatdefs(h2!
x)#0A...............transstatdefs(h3!x)#0A.........
......RETURN#0A.#0A..CASE.s_fndef:#0A..CASE.s_rtdef
:#0A.............{.LET.e,.p.#3D.dvece,.dvecp#0A....
...........AND.oldpn.#3D.procname#0A...............
AND.bl,.ll.#3D.breaklab,..looplab#0A...............
AND.rl,.el.#3D.resultlab,.endcaselab#0A............
...AND.cl,.cc.#3D.caselist,..casecount#0A..........
.....breaklab,..looplab....:#3D.-2,.-2#0A..........
.....resultlab,.endcaselab.:#3D.-2,.-2#0A..........
.....caselist,..casecount..:#3D..0,.-1#0A..........
.....procname.:#3D.h2!x#0A...............context,.c
omline.:#3D.x,.h6!x#0A...............out2(s_entry,.
h5!x)#0A...............outstring(@h3!procname)#0A..
.............ssp.:#3D.savespacesize#0A.............
..dvecp.:#3D.dvece#0A...............context,.comlin
e.:#3D.x,.h6!x#0A...............decldyn(h3!x)#0A...
............checkdistinct(e)#0A...............conte
xt,.comline.:#3D.h4!x,.h6!x#0A...............declla
bels(h4!x)#0A...............out2(s_save,.ssp)#0A...
............context,.comline.:#3D.h4!x,.h6!x#0A....
...........TEST.h1!x#3Ds_rtdef.THEN.trans(h4!x,.-1)
#0A.................................ELSE.fnbody(h4!
x)#0A...............out1(s_endproc)#0A.#0A.........
......breaklab,..looplab....:#3D.bl,.ll#0A.........
......resultlab,.endcaselab.:#3D.rl,.el#0A.........
......caselist,..casecount..:#3D.cl,.cc#0A.........
......procname.:#3D.oldpn#0A...............dvecp.:#3D
.p#0A...............undeclare(e)#0A.............}#0A
.#0A..DEFAULT:.....RETURN#0A}#0A.#0AAND.statdefs(x)
.#3D.h1!x#3Ds_fndef.|.h1!x#3Ds_rtdef.->.TRUE,#0A...
...............h1!x.~#3D.s_and...............->.FAL
SE,#0A..................statdefs(h2!x).............
.->.TRUE,#0A..................statdefs(h3!x)#0A.#0A
.#0ALET.jumpcond(x,.b,.l).BE#0A{.LET.sw.#3D.b#0A#0A
..SWITCHON.h1!x.INTO#0A..{.CASE.s_false:..b.:#3D.NO
T.b#0A....CASE.s_true:...IF.b.DO.out2(s_jump,.l)#0A
...................RETURN#0A.#0A....CASE.s_not:....
jumpcond(h2!x,.NOT.b,.l)#0A...................RETUR
N#0A.#0A....CASE.s_logand:.sw.:#3D.NOT.sw#0A....CAS
E.s_logor:..TEST.sw.THEN.{.jumpcond(h2!x,.b,.l)#0A.
.................................jumpcond(h3!x,.b,.
l)#0A..................................RETURN#0A...
.............................}#0A.#0A..............
.............ELSE.{.LET.m.#3D.nextlab()#0A.........
.........................jumpcond(h2!x,.NOT.b,.m)#0A
..................................jumpcond(h3!x,.b,
.l)#0A..................................out2(s_lab,
.m)#0A..................................RETURN#0A..
..............................}#0A.#0A....DEFAULT:.
......load(x)#0A...................out2(b.->.s_jt,.
s_jf,.l)#0A...................ssp.:#3D.ssp.-.1#0A..
.................RETURN#0A..}#0A}#0A.#0AAND.transsw
itch(x,.next).BE#0A{.LET.cl,.cc.#3D.caselist,.casec
ount.#0A..LET.dl,.el.#3D.defaultlab,.endcaselab#0A.
.LET.l,.dlab.#3D.nextlab(),.?#0A..caselist,.casecou
nt,.defaultlab.:#3D.0,.0,.0#0A..endcaselab.:#3D.nex
t#3D0.->.nextlab(),.next#0A.#0A..context,.comline.:
#3D.x,.h4!x#0A..out2(s_jump,.l)#0A..trans(h3!x,.end
caselab)#0A.#0A..context,.comline.:#3D.x,.h4!x#0A..
out2(s_lab,.l)#0A..load(h2!x)#0A#0A..dlab.:#3D.defa
ultlab>0.->.defaultlab,#0A..........endcaselab>0.->
.endcaselab,#0A..........nextlab()#0A#0A..out2(s_sw
itchon,.casecount);.out1(dlab).#0A..UNTIL.caselist#3D
0.DO.{.out2(h2!caselist,.h3!caselist)#0A...........
.............caselist.:#3D.h1!caselist#0A..........
............}#0A..ssp.:#3D.ssp.-.1#0A#0A..IF.next#3D
0................DO...out2(s_lab,.endcaselab)#0A..I
F.next<0.&.defaultlab#3D0.DO.{.out2(s_lab,.dlab)#0A
................................out1(s_rtrn)#0A....
..........................}#0A#0A..defaultlab,.endc
aselab.:#3D.dl,.el#0A..caselist,...casecount..:#3D.
cl,.cc#0A}#0A.#0AAND.transfor(x,.next).BE#0A{.LET.e
,.m,.blab.#3D.dvece,.nextlab(),.0#0A..LET.bl,.ll.#3D
.breaklab,.looplab#0A..LET.cc.#3D.casecount#0A..LET
.k,.n,.step.#3D.0,.0,.1#0A..LET.s.#3D.ssp#0A#0A..ca
secount.:#3D.-1..//.Disallow.CASE.and.DEFAULT.label
s#2E...#0A..breaklab,.looplab.:#3D.next,.0#0A...#0A
..context,.comline.:#3D.x,.h7!x#0A.#0A..addname(h2!
x,.s_local,.s)#0A..load(h3!x).......//.The.initial.
value#0A.#0A..//.Set.k,.n.to.load.the.end.limit#0A.
.TEST.h1!(h4!x)#3Ds_number.THEN....k,.n.:#3D.s_ln,.
h2!(h4!x)#0A..........................ELSE.{.k,.n.:
#3D.s_lp,.ssp#0A.................................lo
ad(h4!x)#0A...............................}#0A.#0A.
.UNLESS.h5!x#3D0.DO.step.:#3D.evalconst(h5!x)#0A.#0A
..out1(s_store)#0A...#0A..TEST.k#3Ds_ln.&.h1!(h3!x)
#3Ds_number..//.check.for.constant.limits.#0A..THEN
.{.LET.initval.#3D.h2!(h3!x)#0A.........IF.step>#3D
0.&.initval>n.|.step<0.&.initval<n.DO#0A.........{.
TEST.next<0#0A...........THEN.out1(s_rtrn)#0A......
.....ELSE.TEST.next>0#0A................THEN.out2(s
_jump,.next)#0A................ELSE.{.blab.:#3D.bre
aklab>0.->.breaklab,.nextlab()#0A..................
.....out2(s_jump,.blab)#0A.....................}#0A
.........}#0A.......}#0A..ELSE.{.IF.next<#3D0.DO.bl
ab.:#3D.nextlab()#0A.........out2(s_lp,.s)#0A......
...out2(k,.n)#0A.........out1(step>#3D0.->.s_gr,.s_
ls)#0A.........out2(s_jt,.next>0.->.next,.blab)#0A.
......}#0A#0A..IF.breaklab#3D0.&.blab>0.DO.breaklab
.:#3D.blab#0A...#0A..context,.comline.:#3D.x,.h7!x#0A
..decllabels(h6!x)#0A..context,.comline.:#3D.x,.h7!
x#0A..out2(s_lab,.m)#0A..trans(h6!x,.0)#0A..UNLESS.
looplab#3D0.DO.out2(s_lab,.looplab)#0A..out2(s_lp,.
s);.out2(s_ln,.step);.out1(s_plus);.out2(s_sp,.s)#0A
..out2(s_lp,s);.out2(k,n);.out1(step>#3D0.->.s_le,.
s_ge)#0A..out2(s_jt,.m)#0A.#0A..IF.next<#3D0.TEST.b
lab>0.#0A.............THEN..................out2(s_
lab,.blab)#0A.............ELSE.IF.breaklab>0.DO.out
2(s_lab,.breaklab)#0A..trnext(next)#0A..casecount.:
#3D.cc#0A..breaklab,.looplab,.ssp.:#3D.bl,.ll,.s#0A
..out2(s_stack,.ssp)#0A..undeclare(e)#0A}#0A.#0ALET
.load(x).BE#0A{.LET.op.#3D.h1!x#0A#0A..IF.isconst(x
).DO#0A..{.out2(s_ln,.evalconst(x))#0A....ssp.:#3D.
ssp.+.1#0A....RETURN#0A..}#0A.#0A..SWITCHON.op.INTO
#0A..{.DEFAULT:..........trnerr("Compiler.error.in.
Load")#0A......................out2(s_ln,.0)#0A....
..................ssp.:#3D.ssp.+.1#0A..............
........RETURN#0A.#0A....CASE.s_of:......{.LET.slct
.#3D.evalconst(h2!x).//.Inserted.11/7/01#0A........
..............LET.len.#3D.slct>>24#0A..............
........LET.sh..#3D.slct>>16.&.255#0A..............
........LET.offset.#3D.slct.&.#23xFFFF#0A..........
............load(h3!x)#0A......................IF.o
ffset.DO.{.out2(s_ln,.offset);.out1(s_plus).}#0A...
...................out1(s_rv)#0A...................
...IF.sh.DO.{.out2(s_ln,.sh);.out1(s_rshift).}#0A..
....................IF.len>0.&.len+sh<32.DO....//.A
ssume.a.32.bit.m/c#0A......................{.LET.ma
sk.#3D.(1<<len)-1#0A........................out2(s_
ln,.mask)#0A........................out1(s_logand)#0A
......................}#0A......................RET
URN#0A....................}#0A#0A....CASE.s_byteap:
....op:#3Ds_getbyte#0A#0A....CASE.s_div:.CASE.s_rem
:.CASE.s_minus:#0A....CASE.s_ls:.CASE.s_gr:.CASE.s_
le:.CASE.s_ge:#0A....CASE.s_lshift:.CASE.s_rshift:#0A
......................load(h2!x);.load(h3!x);.out1(
op)#0A......................ssp.:#3D.ssp.-.1#0A....
..................RETURN#0A.#0A....CASE.s_vecap:.CA
SE.s_mult:.CASE.s_plus:.CASE.s_eq:.CASE.s_ne:#0A...
.CASE.s_logand:.CASE.s_logor:.CASE.s_eqv:.CASE.s_ne
qv:#0A.........{.LET.a,.b.#3D.h2!x,.h3!x#0A........
...TEST.h1!a#3Ds_name.|#0A................h1!a#3Ds_
number.THEN.{.load(b);.load(a).}#0A................
..............ELSE.{.load(a);.load(b).}#0A.........
..TEST.op#3Ds_vecap.THEN.out2(s_plus,.s_rv)#0A.....
......................ELSE.out1(op)#0A...........ss
p.:#3D.ssp.-.1#0A...........RETURN#0A.........}#0A.
#0A....CASE.s_neg:.CASE.s_not:.CASE.s_rv:.CASE.s_ab
s:#0A......................load(h2!x)#0A...........
...........out1(op)#0A......................RETURN#0A
.#0A....CASE.s_true:.CASE.s_false:.CASE.s_query:#0A
......................out1(op)#0A..................
....ssp.:#3D.ssp.+.1#0A......................RETURN
#0A.#0A....CASE.s_lv:........loadlv(h2!x);.RETURN#0A
.#0A....CASE.s_number:....out2(s_ln,.h2!x);.ssp.:#3D
.ssp.+.1;.RETURN#0A.#0A....CASE.s_string:....out1(s
_lstr)#0A......................outstring(@.h2!x)#0A
......................ssp.:#3D.ssp.+.1#0A..........
............RETURN#0A.#0A....CASE.s_name:......tran
sname(x,.s_lp,.s_lg,.s_ll,.s_lf,.s_ln)#0A..........
............ssp.:#3D.ssp.+.1#0A....................
..RETURN#0A.#0A....CASE.s_valof:...{.LET.e,.rl,.cc.
#3D.dvece,.resultlab,.casecount#0A.................
.....casecount.:#3D.-1.//.Disallow.CASE.&.DEFAULT.l
abels#0A......................resultlab.:#3D.nextla
b()#0A......................decllabels(h2!x)#0A....
..................trans(h2!x,.0)#0A................
......out2(s_lab,.resultlab)#0A....................
..out2(s_rstack,.ssp)#0A......................ssp.:
#3D.ssp.+.1#0A......................resultlab,.case
count.:#3D.rl,.cc#0A......................undeclare
(e)#0A......................RETURN#0A..............
......}#0A.#0A....CASE.s_fnap:....{.LET.s.#3D.ssp#0A
......................ssp.:#3D.ssp.+.savespacesize#0A
......................out2(s_stack,.ssp)#0A........
..............loadlist(h3!x)#0A....................
..load(h2!x)#0A......................out2(s_fnap,.s
)#0A......................ssp.:#3D.s.+.1#0A........
..............RETURN#0A....................}#0A.#0A
....CASE.s_cond:....{.LET.l,.m.#3D.nextlab(),.nextl
ab()#0A......................LET.s.#3D.ssp#0A......
................jumpcond(h2!x,.FALSE,.m)#0A........
..............load(h3!x)#0A......................ou
t2(s_res,l)#0A......................ssp.:#3D.s;.out
2(s_stack,.ssp)#0A......................out2(s_lab,
.m)#0A......................load(h4!x)#0A..........
............out2(s_res,l)#0A......................o
ut2(s_lab,.l)#0A......................out2(s_rstack
,s)#0A......................RETURN#0A..............
......}#0A.#0A....CASE.s_table:...{.LET.m.#3D.nextl
ab()#0A......................out2(s_datalab,.m)#0A.
.....................x.:#3D.h2!x#0A................
......WHILE.h1!x#3Ds_comma.DO#0A...................
...{.out2(s_itemn,.evalconst(h2!x))#0A.............
...........x.:#3D.h3!x#0A......................}#0A
......................out2(s_itemn,.evalconst(x))#0A
......................out2(s_lll,.m)#0A............
..........ssp.:#3D.ssp.+.1#0A......................
RETURN#0A....................}#0A..}#0A}#0A#0AAND.f
nbody(x).BE.SWITCHON.h1!x.INTO#0A{.DEFAULT:........
.load(x)#0A...................out1(s_fnrn)#0A......
.............ssp.:#3D.ssp.-.1#0A...................
RETURN#0A...................#0A..CASE.s_valof:.{.LE
T.e,.rl,.cc.#3D.dvece,.resultlab,.casecount#0A.....
.............casecount.:#3D.-1.//.Disallow.CASE.&.D
EFAULT.labels#0A..................resultlab.:#3D.-1
#0A..................decllabels(h2!x)#0A...........
.......trans(h2!x,.-1)#0A..................resultla
b,.casecount.:#3D.rl,.cc#0A..................undecl
are(e)#0A..................RETURN#0A...............
.}#0A#0A..CASE.s_cond:..{.LET.l.#3D.nextlab()#0A...
...............jumpcond(h2!x,.FALSE,.l)#0A.........
.........fnbody(h3!x)#0A..................out2(s_la
b,.l)#0A..................fnbody(h4!x)#0A..........
......}#0A}#0A.#0A.#0AAND.loadlv(x).BE#0A{.UNLESS.x
#3D0.SWITCHON.h1!x.INTO#0A..{.DEFAULT:.........ENDC
ASE#0A.#0A....CASE.s_name:.....transname(x,.s_llp,.
s_llg,.s_lll,.0,.0)#0A.....................ssp.:#3D
.ssp.+.1#0A.....................RETURN#0A.#0A....CA
SE.s_rv:.......load(h2!x)#0A.....................RE
TURN#0A.#0A....CASE.s_vecap:.{.LET.a,.b.#3D.h2!x,.h
3!x#0A....................IF.h1!a#3Ds_name.DO.a,.b.
:#3D.h3!x,.h2!x#0A....................load(a)#0A...
.................load(b)#0A....................out1
(s_plus)#0A....................ssp.:#3D.ssp.-.1#0A.
...................RETURN#0A..................}#0A.
.}#0A#0A..trnerr("Ltype.expression.needed")#0A..out
2(s_ln,.0)#0A..ssp.:#3D.ssp.+.1#0A}#0A.#0AAND.loadl
ist(x).BE.UNLESS.x#3D0.TEST.h1!x#3Ds_comma#0A......
........................THEN.{.loadlist(h2!x);.load
list(h3!x).}#0A..............................ELSE.l
oad(x)#0A#0ALET.isconst(x).#3D.VALOF#0A{.IF.x#3D0.R
ESULTIS.FALSE#0A.#0A..SWITCHON.h1!x.INTO#0A..{.CASE
.s_name:#0A........{.LET.c.#3D.cellwithname(x)#0A..
........RESULTIS.h2!c#3Ds_manifest#0A........}#0A.#0A
....CASE.s_number:#0A....CASE.s_slct:#0A....CASE.s_
true:#0A....CASE.s_false:..RESULTIS.TRUE#0A.#0A....
CASE.s_neg:#0A....CASE.s_abs:#0A....CASE.s_not:....
RESULTIS.isconst(h2!x)#0A.......#0A....CASE.s_mult:
#0A....CASE.s_div:#0A....CASE.s_rem:#0A....CASE.s_p
lus:#0A....CASE.s_minus:#0A....CASE.s_lshift:#0A...
.CASE.s_rshift:#0A....CASE.s_logor:#0A....CASE.s_lo
gand:#0A....CASE.s_eqv:#0A....CASE.s_neqv:...IF.isc
onst(h2!x).&.isconst(h3!x).RESULTIS.TRUE#0A#0A....D
EFAULT:.......RESULTIS.FALSE#0A#0A...}#0A}#0A#0ALET
.evalconst(x).#3D.VALOF#0A{.LET.a,.b.#3D.0,.0#0A#0A
..IF.x#3D0.DO.{.trnerr("Compiler.error.in.Evalconst
")#0A..............RESULTIS.0#0A............}#0A.#0A
..SWITCHON.h1!x.INTO#0A..{.CASE.s_name:.{.LET.c.#3D
.cellwithname(x)#0A...................LET.k,.a.#3D.
h2!c,.h3!c#0A...................IF.k#3Ds_manifest.D
O#0A...................{.IF.xrefing.DO.xref(x,."M:"
,.a,.s_const)#0A.....................RESULTIS.a#0A.
..................}#0A...................IF.k.DO.tr
nerr("%s.must.be.a.manifest.constant",.@h3!x)#0A...
................trnerr("Name.'%s'.not.declared",.@h
3!x)#0A...................RESULTIS.0#0A............
.....}#0A.#0A....CASE.s_number:.RESULTIS.h2!x#0A...
.CASE.s_true:...RESULTIS.TRUE#0A....CASE.s_false:..
RESULTIS.FALSE#0A....CASE.s_query:..RESULTIS.0#0A.#0A
....CASE.s_slct:.{.LET.len,.sh,.offset.#3D.0,.0,.0.
....//.Inserted.11/7/01#0A...................IF.h2!
x.DO.len....:#3D.evalconst(h2!x)#0A................
...IF.h3!x.DO.sh.....:#3D.evalconst(h3!x)#0A.......
............IF.h4!x.DO.offset.:#3D.evalconst(h4!x)#0A
...................UNLESS.0<#3Dlen<#3D255.&.0<#3Dsh
<#3D255.&.0<#3Doffset<#3D#23xFFFF.DO#0A............
...........trnerr("A.field.too.large.in.a.SLCT.expr
ession")#0A...................RESULTIS.len<<24.|.sh
<<16.|.offset#0A.................}#0A#0A....CASE.s_
neg:#0A....CASE.s_abs:#0A....CASE.s_not:....a.:#3D.
evalconst(h2!x)#0A...................ENDCASE#0A....
...#0A....CASE.s_mult:#0A....CASE.s_div:#0A....CASE
.s_rem:#0A....CASE.s_plus:#0A....CASE.s_minus:#0A..
..CASE.s_lshift:#0A....CASE.s_rshift:#0A....CASE.s_
logor:#0A....CASE.s_logand:#0A....CASE.s_eqv:#0A...
.CASE.s_neqv:...a,.b.:#3D.evalconst(h2!x),.evalcons
t(h3!x)#0A...................ENDCASE#0A#0A....DEFAU
LT:#0A..}#0A....#0A..SWITCHON.h1!x.INTO#0A..{.CASE.
s_neg:....RESULTIS..-..a#0A....CASE.s_abs:....RESUL
TIS.ABS.a#0A....CASE.s_not:....RESULTIS.NOT.a#0A...
....#0A....CASE.s_mult:...RESULTIS.a...*....b#0A...
.CASE.s_plus:...RESULTIS.a...+....b#0A....CASE.s_mi
nus:..RESULTIS.a...-....b#0A....CASE.s_lshift:.RESU
LTIS.a...<<...b#0A....CASE.s_rshift:.RESULTIS.a...>
>...b#0A....CASE.s_logor:..RESULTIS.a...|....b#0A..
..CASE.s_logand:.RESULTIS.a...&....b#0A....CASE.s_e
qv:....RESULTIS.a..EQV...b#0A....CASE.s_neqv:...RES
ULTIS.a..NEQV..b#0A....CASE.s_div:....UNLESS.b#3D0.
RESULTIS.a.../....b#0A....CASE.s_rem:....UNLESS.b#3D
0.RESULTIS.a..REM...b#0A.......#0A....DEFAULT:#0A..
}#0A#0A..trnerr("Error.in.manifest.expression")#0A.
.RESULTIS.0#0A}#0A#0AAND.assign(x,.y).BE#0A{.IF.x#3D
0.|.y#3D0.DO.{.trnerr("Compiler.error.in.assign")#0A
....................RETURN#0A..................}#0A
#0A..UNLESS.(h1!x#3Ds_comma)#3D(h1!y#3Ds_comma).DO#0A
..................{.trnerr("Bad.simultaneous.assign
ment")#0A....................RETURN#0A.............
.....}#0A.#0A..SWITCHON.h1!x.INTO#0A..{.CASE.s_comm
a:..assign(h2!x,.h2!y)#0A...................assign(
h3!x,.h3!y)#0A...................RETURN#0A.#0A....C
ASE.s_name:...load(y)#0A...................transnam
e(x,.s_sp,.s_sg,.s_sl,.0,.0)#0A...................s
sp.:#3D.ssp.-.1#0A...................RETURN#0A.#0A.
...CASE.s_byteap:.load(y)#0A...................load
(h2!x)#0A...................load(h3!x)#0A..........
.........out1(s_putbyte)#0A...................ssp:#3D
ssp-3#0A...................RETURN#0A.#0A....CASE.s_
rv:#0A....CASE.s_vecap:..load(y)#0A................
...loadlv(x)#0A...................out1(s_stind)#0A.
..................ssp.:#3D.ssp.-.2#0A..............
.....RETURN#0A.#0A....CASE.s_of:...{.LET.slct.#3D.e
valconst(h2!x).//.Inserted.11/7/01#0A..............
.....LET.len.#3D.slct>>24#0A...................LET.
sh..#3D.slct>>16.&.255#0A...................LET.off
set.#3D.slct.&.#23xFFFF#0A...................LET.ma
sk.#3D.-1#0A...................IF.len>0.DO.mask.:#3D
.(1<<len)-1#0A...................mask.:#3D.mask<<sh
#0A//writef("Compiling.(SLCT.%n:%n:%n).OF.x.:#3D.y*
n",.len,.sh,.offset)#0A//writef("Load.y*n")#0A.....
..............load(y)#0A...................IF.sh.DO
#0A...................{.out2(s_ln,.sh)#0A..........
...........out1(s_lshift)#0A//writef("lshift.by.%n*
n",.sh)#0A...................}#0A#0A...............
....UNLESS.mask#3D-1.DO#0A...................{.load
(h3!x)#0A.....................IF.offset.DO#0A......
...............{.out2(s_ln,.offset)#0A.............
..........out1(s_plus)#0A.....................}#0A.
....................out1(s_rv)#0A..................
...out1(s_neqv)#0A.....................ssp.:#3D.ssp
-1#0A//writef("xor.x!%n*n",.offset)#0A.............
........out2(s_ln,.mask)#0A.....................out
1(s_logand).//.bits.to.change.in.x#0A//writef("mask
.with.%bW*n",.mask)#0A#0A.....................load(
h3!x)#0A.....................IF.offset.DO#0A.......
..............{.out2(s_ln,.offset)#0A..............
.........out1(s_plus)#0A.....................}#0A..
...................out1(s_rv)#0A...................
..out1(s_neqv)#0A//writef("xor.with.x!%n*n",.offset
)#0A.....................ssp.:#3D.ssp-1#0A.........
..........}#0A#0A...................load(h3!x)#0A..
.................IF.offset.DO#0A...................
{.out2(s_ln,.offset)#0A.....................out1(s_
plus)#0A...................}#0A...................o
ut1(s_stind)#0A//writef("store.in.x!%n*n",.offset)#0A
...................ssp.:#3D.ssp-2#0A//writef("stind
*n")#0A...................RETURN#0A................
.}#0A#0A....DEFAULT:.......trnerr("Ltype.expression
.needed")#0A..}#0A}#0A.#0A.#0AAND.transname(x,.p,.g
,.l,.f,.n).BE#0A{.LET.c.#3D.cellwithname(x)#0A..LET
.k,.a.#3D.h2!c,.h3!c#0A.#0A..SWITCHON.k.INTO#0A..{.
DEFAULT:........trnerr("Name.'%s'.not.declared",.@h
3!x)#0A...#0A....CASE.s_global:..out2(g,.a)#0A.....
...............IF.xrefing.DO.xref(x,."G:",.a,.g)#0A
....................RETURN#0A.#0A....CASE.s_local:.
..IF.c<dvecp.DO#0A.........................trnerr("
Dynamic.free.variable.'%s'.used",.@h3!x)#0A........
............out2(p,.a)#0A....................//IF.x
refing.DO.xref(x,."P:",.a,.p)#0A...................
.RETURN#0A.#0A....CASE.s_static:..out2(l,.a)#0A....
................IF.xrefing.DO.xref(x,."S:",.a,.l)#0A
....................RETURN#0A.#0A....CASE.s_label:.
..IF.f#3D0.DO#0A....................{.trnerr("Misus
e.of.entry.name.'%s'",.@h3!x)#0A...................
...f.:#3D.p#0A....................}#0A.............
.......out2(f,.a)#0A....................IF.xrefing.
DO.xref(x,."F:",.a,.f)#0A....................RETURN
#0A#0A....CASE.s_manifest:IF.n#3D0.DO#0A...........
.........{.trnerr("Misuse.of.MANIFEST.name.'%s'",.@
h3!x)#0A......................n.:#3D.p#0A..........
..........}#0A....................out2(n,.a)#0A....
................IF.xrefing.DO.xref(x,."M:",.a,.n)#0A
..}#0A}#0A#0AAND.xref(x,.kstr,.n,.op).BE#0A{.LET.na
me.#3D.@h3!x#0A..LET.fno.#3D.comline>>20#0A..LET.ln
o.#3D.comline.&.#23xFFFFF#0A..LET.file.#3D.sourcena
mev!fno#0A..writef("%s.%s%n.",.name,.kstr,.n)#0A#0A
..SWITCHON.op.INTO#0A..{.DEFAULT:.........writef("o
p%n",.op);.ENDCASE#0A....CASE.s_fndef:....writef("F
N");.......ENDCASE#0A....CASE.s_rtdef:....writef("R
T");.......ENDCASE#0A....CASE.s_valdef:...writef("V
AL");......ENDCASE#0A....CASE.s_vecdef:...writef("V
EC");......ENDCASE#0A....CASE.s_constdef:.writef("D
EF");......ENDCASE#0A....CASE.s_const:....writef("M
AN");......ENDCASE#0A....CASE.s_colon:....writef("L
AB");......ENDCASE#0A....CASE.s_sp:.......writef("S
P");.......ENDCASE#0A....CASE.s_sg:.......writef("S
G");.......ENDCASE#0A....CASE.s_sl:.......writef("S
L");.......ENDCASE#0A....CASE.s_llp:......writef("L
LP");......ENDCASE#0A....CASE.s_llg:......writef("L
LG");......ENDCASE#0A....CASE.s_lll:......writef("L
LL");......ENDCASE#0A....CASE.s_lp:.......writef("L
P");.......ENDCASE#0A....CASE.s_lg:.......writef("L
G");.......ENDCASE#0A....CASE.s_ll:.......writef("L
L");.......ENDCASE#0A....CASE.s_lf:.......writef("L
F");.......ENDCASE#0A....CASE.s_ln:.......writef("L
N");.......ENDCASE#0A..}#0A..wrch('.')#0A..IF.file.
DO.writef("%s",.file)#0A..writef("[%n].",.lno)#0A#0A
..prctxt(context)#0A#0A..newline()#0A}#0A#0AAND.prc
txt(x).BE.IF.x.DO.#0A{.LET.op.#3D.h1!x#0A..SWITCHON
.op.INTO#0A..{.DEFAULT:..prctxte(x,.4,.0);.RETURN#0A
#0A....CASE.s_fndef:#0A.........writef("LET.")#0A..
.......prctxte(h2!x,.5,.0)#0A.........wrch('(')#0A.
........prctxte(h3!x,.7,.0)#0A.........writef(")#3D
#2E#2E")#0A.........RETURN#0A#0A....CASE.s_rtdef:#0A
.........writef("LET.")#0A.........prctxte(h2!x,.5,
.0)#0A.........wrch('(')#0A.........prctxte(h3!x,.7
,.0)#0A.........writef(")BE#2E#2E")#0A.........RETU
RN#0A#0A....CASE.s_valdef:#0A.........writef("LET."
)#0A.........prctxte(h2!x,.5,.0)#0A.........writef(
"#3D")#0A.........prctxte(h3!x,.5,.0)#0A.........RE
TURN#0A#0A....CASE.s_vecdef:#0A.........writef("LET
.")#0A.........prctxte(h2!x,.5,.0)#0A.........write
f("#3DVEC.")#0A.........prctxte(h3!x,.5,.0)#0A.....
....RETURN#0A#0A....CASE.s_constdef:#0A.........prc
txte(h3!x,.5,.0)#0A.........writef("#3D")#0A.......
..prctxte(h4!x,.5,.0)#0A.........RETURN#0A#0A....CA
SE.s_let:#0A.........writef("LET.")#0A.........prct
xtd(h2!x,.2)#0A.........writef(";.")#0A.........prc
txtc(h3!x,.2)#0A.........RETURN#0A.#0A....CASE.s_st
atic:....writef("STATIC#2E#2E");....RETURN#0A....CA
SE.s_global:....writef("GLOBAL#2E#2E");....RETURN#0A
....CASE.s_manifest:..writef("MANIFEST#2E#2E");..RE
TURN#0A#0A....CASE.s_ass:#0A.........prctxte(h2!x,.
4,.0)#0A.........writef(":#3D")#0A.........prctxte(
h3!x,.4,.0)#0A.........RETURN#0A.#0A....CASE.s_rtap
:#0A.........prctxte(h2!x,.2,.12)#0A.........writef
("(")#0A.........prctxte(h3!x,.3,.0)#0A.........wri
tef(")")#0A.........RETURN#0A.#0A....CASE.s_goto:#0A
.........writef("GOTO.")#0A.........prctxte(h2!x,.4
,.0)#0A.........RETURN#0A.#0A....CASE.s_colon:#0A..
.......prctxte(h2!x,.2,.0)#0A.........writef(":")#0A
.........prctxt(h3!x,.3)#0A.........RETURN#0A.#0A..
..CASE.s_unless:#0A....CASE.s_if:#0A....CASE.s_whil
e:#0A....CASE.s_until:#0A.........writef(op#3Ds_unl
ess->"UNLESS.",#0A................op#3Ds_if->"IF.",
#0A................op#3Ds_until->"UNTIL.",#0A......
.........."WHILE."#0A...............)#0A.........pr
ctxte(h2!x,.4,.0)#0A.........writef(".DO.")#0A.....
....prctxtc(h3!x,.3)#0A.........RETURN#0A#0A.#0A...
.CASE.s_test:#0A.........writef("TEST.")#0A........
.prctxte(h2!x,.4,.0)#0A.........writef(".THEN.")#0A
.........prctxtc(h3!x,.2)#0A.........writef(".ELSE.
")#0A.........prctxtc(h4!x,.2)#0A.........RETURN#0A
.#0A....CASE.s_loop:#0A.........writef("LOOP")#0A..
.......RETURN#0A.#0A....CASE.s_skip:#0A.........wri
tef("{}")#0A.........RETURN#0A.#0A....CASE.s_break:
#0A.........writef("BREAK")#0A.........RETURN#0A.#0A
....CASE.s_return:#0A.........writef("RETURN")#0A..
.......RETURN#0A.#0A....CASE.s_finish:#0A.........w
ritef("FINISH")#0A.........RETURN#0A.#0A....CASE.s_
resultis:#0A.........writef("RESULTIS.")#0A........
.prctxte(h2!x,.4,.0)#0A.........RETURN#0A.#0A....CA
SE.s_repeatwhile:#0A....CASE.s_repeatuntil:#0A.....
....prctxtc(h2!x,.4)#0A.........writef(op#3Ds_repea
twhile.->.".REPEATWHILE.",.".REPEATUNTIL.")#0A.....
....prctxte(h3!x,.4,.0)#0A.........RETURN#0A.#0A...
.CASE.s_repeat:#0A.........prctxtc(h2!x,.4)#0A.....
....writef(".REPEAT")#0A.........RETURN#0A.#0A....C
ASE.s_case:#0A.........writef("CASE.")#0A.........p
rctxte(h2!x,.4,.0)#0A.........writef(":#2E#2E.")#0A
.........RETURN#0A.#0A....CASE.s_default:#0A.......
..writef("DEFAULT:#2E#2E")#0A.........RETURN#0A.#0A
....CASE.s_endcase:#0A.........writef("ENDCASE")#0A
.........RETURN#0A.#0A....CASE.s_switchon:#0A......
...writef("SWITCHON.")#0A.........prctxte(h2!x,.4,.
0)#0A.........writef(".INTO#2E#2E")#0A.........RETU
RN#0A.#0A....CASE.s_for:#0A.........writef("FOR.")#0A
.........prctxte(h2!x,.4,.0)#0A.........writef("#3D
")#0A.........prctxte(h3!x,.4,.0)#0A.........writef
(".TO.")#0A.........prctxte(h4!x,.4,.0)#0A.........
IF.h5!x.DO.{.writef(".BY.");.prctxte(h5!x,.4,.0).}#0A
.........writef(".DO#2E#2E")#0A.........RETURN#0A.#0A
....CASE.s_seq:#0A.........prctxtc(h2!x,.4)#0A.....
....writef(";")#0A.........prctxtc(h3!x,.4)#0A.....
....RETURN#0A..}#0A}#0A#0AAND.prctxtd(x,.d).BE.writ
ef("#2E#2E")#0AAND.prctxtc(x,.d).BE.writef("#2E#2E"
)#0A#0AAND.prctxte(x,.d,.prec).BE.IF.x.DO#0A{.LET.o
p.#3D.h1!x#0A#0A..SWITCHON.op.INTO#0A..{.DEFAULT:.E
NDCASE#0A#0A....CASE.s_number:.#0A.................
{.LET.n.#3D.h2!x#0A...................TEST.-1_000_0
00<#3Dn<#3D1_000_000#0A...................THEN.writ
ef("%n",.n)#0A...................ELSE.writef("#23x%
x8",.n)#0A...................RETURN#0A.............
....}.#0A....CASE.s_name:...writef("%s",.@h3!x);...
.....RETURN#0A....CASE.s_true:...writef("TRUE");...
..........RETURN#0A....CASE.s_false:..writef("FALSE
");............RETURN#0A....CASE.s_query:..wrch('?'
);..................RETURN#0A#0A....CASE.s_string:.
#0A.................{.LET.s.#3D.@h2!x#0A...........
........LET.len.#3D.s%0#0A...................wrch('
"')#0A...................FOR.i.#3D.1.TO.len.DO#0A..
.................{.LET.ch.#3D.s%i#0A...............
......IF.i#3D6.&.len>6+8.DO.{.writef("'");.LOOP.}#0A
.....................IF.i<#3D6.|.i>len-8.DO.//.Firs
t.5.and.last.8.chars#0A.....................{.SWITC
HON.ch.INTO#0A.......................{.CASE.'**':.w
ritef("****");.LOOP#0A.........................CASE
.'*"':.writef("***"");.LOOP#0A.....................
....CASE.'*n':.writef("**n");..LOOP#0A.............
..........}#0A.......................UNLESS.32<#3Dc
h<#3D127.DO.ch.:#3D.'?'#0A.......................wr
ch(ch)#0A.....................}#0A.................
..}#0A...................wrch('"')#0A..............
.....RETURN#0A.................}#0A#0A..}#0A#0A..IF
.d#3D0.DO.{.writef("#2E#2E#2E");.RETURN.}#0A#0A..IF
.prec>#3D12.DO.{.wrch('(');.prctxte(x,.d,.0);.wrch(
')');.RETURN.}#0A#0A..SWITCHON.op.INTO#0A..{.DEFAUL
T:.ENDCASE#0A#0A....CASE.s_fnap:#0A.........prctxte
(h2!x,.d-1,.11)#0A.........wrch('(')#0A.........prc
txte(h3!x,.d-1,.0)#0A.........wrch(')')#0A.........
RETURN#0A..}#0A#0A..IF.prec>#3D11.DO.{.wrch('(');.p
rctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHO
N.op.INTO#0A..{.DEFAULT:.ENDCASE#0A#0A....CASE.s_of
:#0A....CASE.s_byteap:#0A....CASE.s_vecap:#0A......
...prctxte(h2!x,.d-1,.10)#0A.........writes(op#3Ds_
of->"::",.op#3Ds_byteap->"%",."!")#0A.........prctx
te(h3!x,.d-1,.10)#0A.........RETURN#0A#0A....CASE.s
_rv:#0A....CASE.s_lv:#0A.........writef(op#3Ds_rv->
"!","@")#0A.........prctxte(h2!x,.d-1,.10)#0A......
...RETURN#0A..}#0A#0A..IF.prec>#3D10.DO.{.wrch('(')
;.prctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWIT
CHON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A....CASE.s_mu
lt:.CASE.s_div:.CASE.s_rem:#0A.........prctxte(h2!x
,.d-1,.9)#0A.........writef(op#3Ds_mult->"**",.op#3D
s_div->"/",.".REM.")#0A.........prctxte(h3!x,.d-1,.
9)#0A.........RETURN#0A..}#0A#0A..IF.prec>#3D9.DO.{
.wrch('(');.prctxte(x,.d,.0);.wrch(')');.RETURN.}#0A
#0A..SWITCHON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A....
CASE.s_plus:#0A....CASE.s_minus:#0A.........prctxte
(h2!x,.d-1,.8)#0A.........writef(op#3Ds_plus->"+","
-")#0A.........prctxte(h3!x,.d-1,.8)#0A.........RET
URN#0A#0A....CASE.s_neg:#0A....CASE.s_abs:#0A......
...writef(op#3Ds_neg->"-","ABS.")#0A.........prctxt
e(h2!x,.d-1,.8)#0A.........RETURN#0A#0A..}#0A#0A..I
F.prec>#3D8.DO.{.wrch('(');.prctxte(x,.d,.0);.wrch(
')');.RETURN.}#0A#0A..SWITCHON.op.INTO#0A..{.DEFAUL
T:.ENDCASE#0A....CASE.s_eq:.CASE.s_ne:#0A.........p
rctxte(h2!x,.d-1,.7)#0A.........writef(op#3Ds_eq->"
#3D","~#3D")#0A.........prctxte(h3!x,.d-1,.7)#0A...
......RETURN#0A....CASE.s_ls:.CASE.s_gr:#0A........
.prctxte(h2!x,.d-1,.7)#0A.........writef(op#3Ds_ls-
>"<",">")#0A.........prctxte(h3!x,.d-1,.7)#0A......
...RETURN#0A....CASE.s_le:.CASE.s_ge:#0A.........pr
ctxte(h2!x,.d-1,.7)#0A.........writef(op#3Ds_le->"<
#3D",">#3D")#0A.........prctxte(h3!x,.d-1,.7)#0A...
......RETURN#0A..}#0A#0A..IF.prec>#3D7.DO.{.wrch('(
');.prctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SW
ITCHON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A....CASE.s_
lshift:.CASE.s_rshift:#0A.........prctxte(h2!x,.d-1
,.6)#0A.........writef(op#3Ds_lshift->"<<",">>")#0A
.........prctxte(h3!x,.d-1,.6)#0A.........RETURN#0A
..}#0A#0A..IF.prec>#3D6.DO.{.wrch('(');.prctxte(x,.
d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.op.INTO#0A
..{.DEFAULT:.ENDCASE#0A....CASE.s_not:#0A.........w
rch('~')#0A.........prctxte(h2!x,.d-1,.5)#0A.......
..RETURN#0A..}#0A#0A..IF.prec>#3D5.DO.{.wrch('(');.
prctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCH
ON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A....CASE.s_loga
nd:#0A.........prctxte(h2!x,.d-1,.4)#0A.........wrc
h('&')#0A.........prctxte(h3!x,.d-1,.4)#0A.........
RETURN#0A..}#0A#0A..IF.prec>#3D4.DO.{.wrch('(');.pr
ctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON
.op.INTO#0A..{.DEFAULT:.ENDCASE#0A....CASE.s_logor:
#0A.........prctxte(h2!x,.d-1,.3)#0A.........wrch('
|')#0A.........prctxte(h3!x,.d-1,.3)#0A.........RET
URN#0A..}#0A#0A..IF.prec>#3D3.DO.{.wrch('(');.prctx
te(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.op
.INTO#0A..{.DEFAULT:.ENDCASE#0A....CASE.s_eqv:#0A..
..CASE.s_neqv:#0A.........prctxte(h2!x,.d-1,.2)#0A.
........writef(op#3Ds_eqv->".EQV.",".XOR.")#0A.....
....prctxte(h3!x,.d-1,.2)#0A.........RETURN#0A#0A..
}#0A#0A..IF.prec>#3D2.DO.{.wrch('(');.prctxte(x,.d,
.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.op.INTO#0A
..{.DEFAULT:.ENDCASE#0A....CASE.s_cond:#0A.........
prctxte(h2!x,.d-1,.1)#0A.........writef("->")#0A...
......prctxte(h3!x,.d-1,.1)#0A.........writef(",")#0A
.........prctxte(h4!x,.d-1,.1)#0A.........RETURN#0A
..}#0A#0A..IF.prec>#3D1.DO.{.wrch('(');.prctxte(x,.
d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.op.INTO#0A
..{.DEFAULT:.writef("Op%n",.op);.RETURN#0A#0A....CA
SE.s_table:#0A.........writef("TABLE.")#0A.........
prctxte(h2!x,.d-1,.0)#0A.........RETURN#0A.........
#0A....CASE.s_valof:#0A.........writef("VALOF.{")#0A
.........prctxtc(h2!x,.d-1)#0A.........wrch('}')#0A
.........RETURN#0A#0A....CASE.s_comma:#0A.........p
rctxte(h2!x,.d-1,.0)#0A.........writef(",")#0A.....
....prctxte(h3!x,.d-1,.0)#0A.........RETURN#0A..}#0A
}#0A#0A#0AAND.out1(x).BE.wrn(x)#0A.#0AAND.out2(x,.y
).BE.{.out1(x);.out1(y).}#0A.#0AAND.outstring(s).BE
.FOR.i.#3D.0.TO.s%0.DO.out1(s%i)#0A

######cintcode/com/sial-vax.b#
/*#0AThis.is.an.sial.to.vax.code.generator#0Aimplem
ented.by.Martin.Richards.(c).7.August.2009#0A#0AVax
.register.usage#0A#0AR11...G,.m/c.address.of.global
.0#0AR10...P,.m/c.address.of.the.current.function.s
tack.frame#0AR9....#3D0.(to.simplify.indirection.an
d.logical.right.shift)#0AR8....Sial.A.register#0AR7
....Sial.B.register#0AR6....Sial.C.register#0AR2...
.Function.entry.point.at.time.of.call#0AR1....P.poi
nter.increment#0A#0A#0AP.stack.frame#0A#0A#2E#2E#2E
...<old.P>.<return.address>.<entry.address>.<arg.1>
.#2E#2E#2E#0A........^#0A........|#0A........P.(#3D
R10)#0A#0ASP.stack.frame#0A#0A......<entry.address>
.<old.P>.<return.address>..#2E#2E#2E#0A.......^#0A.
......|#0A.......SP#0A.............................
.............#0ABCPL.Calling.sequence#0A#0A....KPG.
k.n....#3D>......First.argument,.if.any,.in.A.(R8)#0A
.......................MOVL..4*n(R11),R2......;.R2.
:#3D.G!n#0A.......................MOVAL.4*k(R10),R1
......;.R1.:#3D.<new.P>#0A.......................JS
B...(R2).............;.J.to.function#0A#0A#0A....EN
TRY.n.Lm.C1.#2E#2E#2E.Cn.#3D.>#0A..................
............................;.first.arg,.if.any,.in
.A.(#3DR8)#0A......................................
........;.sp!0.#3D.<return.address>#0A.............
..........MOVL.R10,(R1)..........;.push.<old.P>#0A.
......................MOVL.R1,R10............;.P.:#3D
.<new.P>#0A.......................MOVL.(SP)+,4*1(R1
0)....;.save.<return.address>#0A...................
....MOVL.R2,4*2(R10).......;.save.<entry.address>#0A
.......................MOVL.R8,4*3(R10).......;.Sto
re.first.arg,.if.any#0A............................
..................;.Other.args.in.P!1,.P!2,.#2E#2E#2E
#0A#0A....RTN.....#3D>.........MOVL.4(R10),R2......
...;.R2.#3D.<return.address>#0A....................
...MOVL.(R10),R10.........;.P.:#3D.<old.P>#0A......
.................JMP.(R2)...............;.Jump.to.<
return.address>#0A#0A#0A*/#0A#0ASECTION."sial-vax"#0A
#0AGET."libhdr"#0AGET."sial#2Eh"#0A#0AGLOBAL.{#0Asi
alin:ug#0Aasmout#0Astdin#0Astdout#0Amodstarted#0A#0A
rdf;.rdp;.rdg;.rdk;.rdw;.rdl;.rdc#0Ardcode#0A#0Apva
l;.gval;.kval;.wval;.lval;.mval#0A#0Ascan#0Acvf;.cv
fp;.cvfg;.cvfk;.cvfw;.cvfl#0A#0Asectname;.modletter
;.charv;.labnumber#0A}#0A#0ALET.start().#3D.VALOF#0A
{.LET.argv.#3D.VEC.20#0A..LET.v....#3D.VEC.20#0A..L
ET.cv...#3D.VEC.256/bytesperword#0A#0A..sectname.:#3D
.v#0A..sectname%0.:#3D.0#0A..modstarted.:#3D.FALSE#0A
#0A..modletter.:#3D.'A'#0A..charv.:#3D.cv#0A..labnu
mber.:#3D.0#0A#0A..asmout.:#3D.0#0A..stdout.:#3D.ou
tput()#0A..IF.rdargs("FROM,TO/K",.argv,.20)#3D0.DO#0A
..{.writes("Bad.args.for.sial-vax*n")#0A....RESULTI
S.20#0A..}#0A..IF.argv!0#3D0.DO.argv!0.:#3D."prog#2E
sial"#0A..IF.argv!1#3D0.DO.argv!1.:#3D."prog#2Emar"
#0A..sialin.:#3D.findinput(argv!0)#0A..IF.sialin#3D
0.DO#0A..{.writef("Trouble.with.file.%s*n",.argv!0)
#0A....RESULTIS.20#0A..}#0A..asmout.:#3D.findoutput
(argv!1)#0A...#0A..UNLESS.asmout.DO#0A..{.writef("T
rouble.with.file.%s*n",.argv!1)#0A.....RESULTIS.20#0A
..}#0A...#0A..writef("Converting.%s.to.%s*n",.argv!
0,.argv!1)#0A..selectinput(sialin)#0A..selectoutput
(asmout)#0A#0A..writef(";.Code.generated.by.sial-va
x*n*n")#0A#0A..scan()#0A..endread()#0A..UNLESS.asmo
ut#3Dstdout.DO.endwrite()#0A..selectoutput(stdout)#0A
..writef("Conversion.complete*n")#0A..RESULTIS.0#0A
}#0A#0AAND.nextlab().#3D.VALOF#0A{.labnumber.:#3D.l
abnumber+1#0A..RESULTIS.labnumber#0A}#0A#0A//.argum
ent.may.be.of.form.Ln#0AAND.rdcode(let).#3D.VALOF#0A
{.LET.a,.ch,.neg.#3D.0,.?,.FALSE#0A#0A..ch.:#3D.rdc
h().REPEATWHILE.ch#3D'*s'.|.ch#3D'*n'#0A#0A..IF.ch#3D
endstreamch.RESULTIS.-1#0A#0A..UNLESS.ch#3Dlet.DO.e
rror("Bad.item,.looking.for.%c.found.%c*n",.let,.ch
)#0A#0A..ch.:#3D.rdch()#0A#0A..IF.ch#3D'-'.DO.{.neg
.:#3D.TRUE;.ch.:#3D.rdch().}#0A#0A..WHILE.'0'<#3Dch
<#3D'9'.DO.{.a.:#3D.10*a.+.ch.-.'0';.ch.:#3D.rdch()
..}#0A#0A..RESULTIS.neg.->.-a,.a#0A}#0A#0AAND.rdf()
.#3D.rdcode('F')#0AAND.rdp().#3D.VALOF.{.pval.:#3D.
rdcode('P');.RESULTIS.pval.}#0AAND.rdg().#3D.VALOF.
{.gval.:#3D.rdcode('G');.RESULTIS.gval.}#0AAND.rdk(
).#3D.VALOF.{.kval.:#3D.rdcode('K');.RESULTIS.kval.
}#0AAND.rdw().#3D.VALOF.{.wval.:#3D.rdcode('W');.RE
SULTIS.wval.}#0AAND.rdl().#3D.VALOF.{.lval.:#3D.rdc
ode('L');.RESULTIS.lval.}#0AAND.rdm().#3D.VALOF.{.m
val.:#3D.rdcode('M');.RESULTIS.mval.}#0AAND.rdc().#3D
.rdcode('C')#0A#0AAND.error(mess,.a,.b,.c).BE#0A{.L
ET.out.#3D.output()#0A..UNLESS.out#3Dstdout.DO#0A..
{.selectoutput(stdout)#0A....writef(mess,.a,.b,.c)#0A
....selectoutput(out)#0A..}#0A..writef(mess,.a,.b,.
c)#0A}#0A#0AAND.scan().BE#0A{.LET.op.#3D.rdf()#0A#0A
..IF.op#3D-1.RETURN.//.EOF.reached#0A#0A..UNLESS.mo
dstarted.DO#0A..{.WHILE.op#3Df_section.|.op#3Df_mod
start.TEST.op#3Df_section#0A....THEN.{.cvfs("SECTIO
N").//.Name.of.section#0A...........FOR.i.#3D.0.TO.
charv%0.DO.sectname%i.:#3D.charv%i#0A...........op.
:#3D.rdf()#0A.........}#0A....ELSE.{.cvf("MODSTART"
).//.Start.of.module#0A...........op.:#3D.rdf()#0A.
........}#0A#0A....//.If.there.is.no.section.name.t
his.module.is.called.MAIN#0A....IF.sectname%0#3D0.D
O#0A....{.LET.s.#3D."MAIN"#0A......FOR.i.#3D.0.TO.s
%0.DO.sectname%i.:#3D.s%i#0A....}#0A#0A....writef("
*n.#2EPSECT.%s,LONG",.sectname)#0A....writef("*n.#2E
TITLE.%s.generated.by.sial-vax",.sectname)#0A....wr
itef("*n;%s::",.sectname)#0A....writef("*n.#2ELONG.
L1000")#0A....modstarted.:#3D.TRUE#0A..}#0A#0A..SWI
TCHON.op.INTO#0A#0A..{.DEFAULT:.......error(";.Bad.
op.%n*n",.op);.LOOP#0A#0A....CASE.-1:.......RETURN#0A
......#0A....CASE.f_lp:.....cvfp("LP").//.a.:#3D.P!
n#0A...................writef("*n.MOVL.%n(R10),R8",
.4*pval)#0A...................ENDCASE#0A....CASE.f_
lg:.....cvfg("LG").//.a.:#3D.G!n#0A................
...writef("*n.MOVL.%n(R11),R8",.4*gval)#0A.........
..........ENDCASE#0A....CASE.f_ll:.....cvfl("LL")./
/.a.:#3D.!Ln#0A...................writef("*n.MOVL.L
%n,R8",.lval)#0A...................ENDCASE#0A#0A...
.CASE.f_llp:....cvfp("LLP").//.a.:#3D.@.P!n#0A.....
..............writef("*n.MOVAL.%n(R10),R8",.4*pval)
#0A...................writef("*n.DIVL2.#234,R8")#0A
...................ENDCASE#0A....CASE.f_llg:....cvf
g("LLG").//.a.:#3D.@.G!n#0A...................write
f("*n.MOVAL.%n(R11),R8",.4*gval)#0A................
...writef("*n.DIVL2.#234,R8")#0A...................
ENDCASE#0A....CASE.f_lll:....cvfl("LLL").//.a.:#3D.
@.!Ln#0A...................writef("*n.MOVAL.L%n,R8"
,.lval)#0A...................writef("*n.DIVL2.#234,
R8")#0A...................ENDCASE#0A....CASE.f_lf:.
....cvfl("LF").//.a.:#3D.byte.address.of.Ln#0A.....
..............writef("*n.MOVAL.L%n,R8",.lval)#0A...
................ENDCASE#0A....CASE.f_lw:.....cvfm("
LW")#0A...................writef("*n.MOVL.L%n,R8",.
mval+10000)#0A...................ENDCASE#0A#0A....C
ASE.f_l:......cvfk("L").//.a.:#3D.n#0A.............
......IF.kval#3D0.DO.{.writef("*n.CLRL.R8");.ENDCAS
E.}#0A...................writef("*n.MOVL.#23%n,R8",
.kval)#0A...................ENDCASE#0A....CASE.f_lm
:.....cvfk("LM").//.a.:#3D.-n#0A...................
writef("*n.MOVL.#23-%n,R8",.kval)#0A...............
....ENDCASE#0A#0A....CASE.f_sp:.....cvfp("SP").//.P
!n.:#3D.a#0A...................writef("*n.MOVL.R8,%
n(R10)",.4*pval)#0A...................ENDCASE#0A...
.CASE.f_sg:.....cvfg("SG").//.G!n.:#3D.a#0A........
...........writef("*n.MOVL.R8,%n(R11)",.4*gval)#0A.
..................ENDCASE#0A....CASE.f_sl:.....cvfl
("SL").//.!Ln.:#3D.a#0A...................writef("*
n.MOVL.R8,L%n",.lval)#0A...................ENDCASE#0A
#0A....CASE.f_ap:.....cvfp("AP").//.a.:#3D.a.+.P!n#0A
...................writef("*n.ADDL2.%n(R10),R8",.4*
pval)#0A...................ENDCASE#0A....CASE.f_ag:
.....cvfg("AG").//.a.:#3D.a.+.G!n#0A...............
....writef("*n.ADDL2.%n(R11),R8",.4*gval)#0A.......
............ENDCASE#0A....CASE.f_a:......cvfk("A").
//.a.:#3D.a.+.n#0A...................IF.kval#3D0.EN
DCASE#0A...................IF.kval#3D1..DO.{.writef
("*n.INCL.R8");.ENDCASE.}#0A...................IF.k
val#3D-1.DO.{.writef("*n.DECL.R8");.ENDCASE.}#0A...
................writef("*n.ADDL2.#23%n,R8",.kval)#0A
...................ENDCASE#0A....CASE.f_s:......cvf
k("S")..//.a.:#3D.a.-.k#0A...................IF.kva
l#3D0.ENDCASE#0A...................IF.kval#3D1..DO.
{.writef("*n.DECL.R8");.ENDCASE.}#0A...............
....IF.kval#3D-1.DO.{.writef("*n.INCL.R8");.ENDCASE
.}#0A...................writef("*n.SUBL2.#23%n,R8",
.kval)#0A...................ENDCASE#0A#0A....CASE.f
_lkp:....cvfkp("LKP").//.a.:#3D.P!n!k#0A...........
........writef("*n.MOVL.%n(R10),R1",.4*pval)#0A....
...............writef("*n.MOVL.%n(R9)[R1],R8",.4*kv
al)#0A...................ENDCASE#0A....CASE.f_lkg:.
...cvfkg("LKG").//.a.:#3D.G!n!k#0A.................
..writef("*n.MOVL.%n(R11),R1",.4*gval)#0A..........
.........writef("*n.MOVL.%n(R9)[R1],R8",.4*kval)#0A
...................ENDCASE#0A....CASE.f_rv:.....cvf
("RV")..//.a.:#3D.!.a#0A...................writef("
*n.MOVL.(R9)[R8],R8")#0A...................ENDCASE#0A
....CASE.f_rvp:....cvfp("RVP").//.a.:#3D.P!n!a#0A..
.................writef("*n.ADDL2.%n(R10),R8",.4*pv
al)#0A...................writef("*n.MOVL.(R9)[R8],R
8")#0A...................ENDCASE#0A....CASE.f_rvk:.
...cvfk("RVK").//.a.:#3D.a!k#0A...................w
ritef("*n.MOVL.%n(R9)[R8],R8",.4*kval)#0A..........
.........ENDCASE#0A....CASE.f_st:.....cvf("ST").//.
!a.:#3D.b#0A...................writef("*n.MOVL.R7,(
R9)[R8]")#0A...................ENDCASE#0A....CASE.f
_stp:....cvfp("STP").//.P!n!a.:#3D.b#0A............
.......writef("*n.MOVL.%n(R10),R1",.4*pval)#0A.....
..............writef("*n.ADDL2.R8,R1")#0A..........
.........writef("*n.MOVL.R7,(R9)[R1]")#0A..........
.........ENDCASE#0A....CASE.f_stk:....cvfk("STK")./
/.a!k.:#3D.b#0A...................writef("*n.MOVL.R
7,%n(R9)[R8]",.4*kval)#0A...................ENDCASE
#0A....CASE.f_stkp:...cvfkp("STKP")..//.P!n!k.:#3D.
a#0A...................writef("*n.MOVL.%n(R10),R1",
..4*pval)#0A...................writef("*n.MOVL.R8,%
n(R9)[R1]",.4*kval)#0A...................ENDCASE#0A
.....CASE.f_skg:....cvfkg("SKG").//.G!n!k.:#3D.a#0A
....................writef("*n.MOVL.%n(R11),R1",.4*
gval)#0A...................writef("*n.MOVL.R8,%n(R9
)[R1]",.4*kval)#0A...................ENDCASE#0A....
CASE.f_xst:....cvf("XST").//.!b.:#3D.a#0A..........
..........writef("*n.MOVL.R8,(R9)[R7]")#0A.........
...........ENDCASE#0A#0A....CASE.f_k:......cvfp("K"
).//.Call..a(b,#2E#2E#2E).incrementing.P.by.n#0A...
................writef("*n.MOVL.R8,R2")...//.R2.#3D
.<entry.point>#0A...................writef("*n.MOVL
.R7,R8")...//.R8.#3D.<first.arg>,.if.any#0A........
...........writef("*n.MOVAL.%n(R10),R1",.4*pval).//
.R1.#3D.<new.P>#0A...................writef("*n.JSB
.(R2)").....//.Subroutine.jump#0A..................
.ENDCASE#0A#0A....CASE.f_kpg:....cvfpg("KPG").//.Ca
ll.Gg(a,#2E#2E#2E).incrementing.P.by.k#0A..........
.........writef("*n.MOVL.%n(R11),R2",.4*gval)#0A...
................writef("*n.MOVAL.%n(R10),R1",.4*pva
l)#0A...................writef("*n.JSB.(R2)")#0A...
................ENDCASE#0A#0A....CASE.f_neg:....cvf
("NEG").//.a.:#3D.-.a#0A...................writef("
*n.MNEGL.R8,R8").#0A...................ENDCASE#0A..
..CASE.f_not:.....cvf("NOT").//.a.:#3D.~.a#0A......
.............writef("*n.MCOML.R8,R8").#0A..........
.........ENDCASE#0A....CASE.f_abs:....cvf("ABS").//
.a.:#3D.ABS.a#0A..................{.LET.lab.#3D.nex
tlab()#0A....................writef("*n.TSTL..R8")#0A
....................writef("*n.BGEQ..X%n",.lab)#0A.
...................writef("*n.MNEGL.R8,R8")#0A.....
..............writef("*nX%n:",.lab)#0A.............
......ENDCASE#0A..................}#0A#0A....CASE.f
_xdiv:...cvf("XDIV").//.a.:#3D.a./.b#0A............
.......writef("*n.DIVL2.R7,R8")#0A.................
..ENDCASE#0A....CASE.f_xrem:...cvf("XREM").//.a.:#3D
.a.REM.b#0A....................writef("*n.MOVL..R8,
R3")#0A....................writef("*n.ASHQ..#23-32,
R2,R2")#0A....................writef("*n.EDIV..R7,R
2,R8,R4")#0A....................writef("*n.MOVL..R4
,R8")#0A....................ENDCASE#0A....CASE.f_xs
ub:...cvf("XSUB").//.a.:#3D..a.-.b#0A..............
.....writef("*n.SUBL2.R7,R8")#0A...................
ENDCASE#0A#0A....CASE.f_mul:.....cvf("MUL").//.a.:#3D
.b.*.a;.c.:#3D.?#0A....................writef("*n.M
ULL2.R7,R8")#0A....................ENDCASE#0A....CA
SE.f_div:....cvf("DIV")..//.a..:#3D.b./.a;.c.:#3D.?
#0A...................writef("*n.DIVL3..R8,R7,R8")#0A
...................ENDCASE#0A.....CASE.f_rem:....cv
f("REM").//.a.:#3D.b.REM.a;.c.:#3D.?#0A............
.......writef("*n.MOVL..R7,R3")#0A.................
..writef("*n.ASHQ..#23-32,R2,R2")#0A...............
....writef("*n.EDIV..R8,R2,R7,R4")#0A..............
.....writef("*n.MOVL..R4,R8")#0A...................
.ENDCASE#0A....CASE.f_add:....cvf("ADD").//.a.:#3D.
b.+.a#0A...................writef("*n.ADDL2.R7,R8")
#0A...................ENDCASE#0A.....CASE.f_sub:...
.cvf("SUB").//.a.:#3D.b.-.a#0A....................w
ritef("*n.SUBL3.R8,R7,R8")#0A....................EN
DCASE#0A#0A....CASE.f_eq:.....cvf("EQ").//.a.:#3D.b
.#3D.a#0A.................{.LET.lab.#3D..nextlab()#0A
...................writef("*n.CLRL.R4")#0A.........
..........writef("*n.CMPL.R7,R8")#0A...............
.....writef("*n.BNEQ.X%n",.lab)#0A.................
...writef("*n.DECL.R4")#0A....................write
f("*nX%n:",.lab)#0A...................writef("*n.MO
VL.R4,R8")#0A...................ENDCASE#0A.........
.........}#0A....CASE.f_ne:.....cvf("NE").//.a.:#3D
.b.~#3D.a#0A.................{.LET.lab.#3D.nextlab(
)#0A...................writef("*n.CLRL.R4")#0A.....
..............writef("*n.CMPL.R7,R8")#0A...........
.........writef("*n.BEQL.X%n",.lab)#0A.............
.......writef("*n.DECL.R4")#0A...................wr
itef("*nX%n:",.lab)#0A...................writef("*n
.MOVL.R4,R8")#0A...................ENDCASE#0A......
...........}#0A....CASE.f_ls:.....cvf("LS").//.a.:#3D
.b.<.a#0A.................{.LET.lab.#3D.nextlab()#0A
...................writef("*n.CLRL.R4")#0A.........
..........writef("*n.CMPL.R7,R8")#0A...............
....writef("*n.BGEQ.X%n",.lab)#0A..................
.writef("*n.DECL.R4")#0A...................writef("
*nX%n:",.lab)#0A...................writef("*n.MOVL.
R4,R8")#0A...................ENDCASE#0A............
.....}#0A....CASE.f_gr:.....cvf("GR").//.a.:#3D.b.>
.a#0A.................{.LET.lab.#3D.nextlab()#0A...
................writef("*n.CLRL.R4")#0A............
.......writef("*n.CMPL.R7,R8")#0A..................
.writef("*n.BLEQ.X%n",.lab)#0A...................wr
itef("*n.DECL.R4")#0A...................writef("*nX
%n:",.lab)#0A...................writef("*n.MOVL.R4,
R8")#0A...................ENDCASE#0A...............
..}#0A....CASE.f_le:.....cvf("LE").//.a.:#3D.b.<#3D
.a#0A.................{.LET.lab.#3D.nextlab()#0A...
................writef("*n.CLRL.R4")#0A............
.......writef("*n.CMPL.R7,R8")#0A..................
.writef("*n.BGTR.X%n",.lab)#0A...................wr
itef("*n.DECL.R4")#0A...................writef("*nX
%n:",.lab)#0A...................writef("*n.MOVL.R4,
R8")#0A...................ENDCASE#0A...............
..}#0A....CASE.f_ge:.....cvf("GE").//.a.:#3D.b.>#3D
.a#0A.................{.LET.lab.#3D.nextlab()#0A...
................writef("*n.CLRL.R4")#0A............
.......writef("*n.CMPL.R7,R8")#0A..................
.writef("*n.BLSS.X%n",.lab)#0A...................wr
itef("*n.DECL.R4")#0A...................writef("*nX
%n:",.lab)#0A...................writef("*n.MOVL.R4,
R8")#0A...................ENDCASE#0A...............
..}#0A....CASE.f_eq0:....cvf("EQ0").//.a.:#3D.a.#3D
.0#0A.................{.LET.lab.#3D.nextlab()#0A...
................writef("*n.CLRL.R4")#0A............
.......writef("*n.TSTL.R8")#0A...................wr
itef("*n.BNEQ.X%n",.lab)#0A...................write
f("*n.DECL.R4")#0A...................writef("*nX%n:
",.lab)#0A...................writef("*n.MOVL.R4,R8"
)#0A...................ENDCASE#0A.................}
#0A....CASE.f_ne0:....cvf("NE0").//.a.:#3D.a.~#3D.0
#0A.................{.LET.lab.#3D.nextlab()#0A.....
..............writef("*n.CLRL.R4")#0A..............
.....writef("*n.TSTL.R8")#0A...................writ
ef("*n.BEQL.X%n",.lab)#0A...................writef(
"*n.DECL.R4")#0A...................writef("*nX%n:",
.lab)#0A...................writef("*n.MOVL.R4,R8")#0A
...................ENDCASE#0A.................}#0A.
...CASE.f_ls0:....cvf("LS0").//.a.:#3D.a.<.0#0A....
...............writef("*n.ASHL.#23-32,R8,R8")#0A...
................ENDCASE#0A....CASE.f_gr0:....cvf("G
R0").//.a.:#3D.a.>.0#0A...................writef("*
n.SUBL3.#231,R8,R4")#0A...................writef("*
n.BISL2.R8,R4")#0A...................writef("*n.ASH
L.#23-32,R4,R8")#0A...................writef("*n.MC
OML.R8,R8")#0A...................ENDCASE#0A....CASE
.f_le0:....cvf("LE0").//.a.:#3D.a.<#3D.0#0A........
...........writef("*n.SUBL3.#231,R8,R4")#0A........
...........writef("*n.BISL2.R8,R4")#0A.............
......writef("*n.ASHL.#23-32,R4,R8")#0A............
.......ENDCASE#0A....CASE.f_ge0:....cvf("GE0").//.a
.:#3D.a.>#3D.0#0A...................writef("*n.ASHL
.#23-32,R8,R8")#0A...................writef("*n.MCO
ML.R8,R8")#0A...................ENDCASE#0A#0A....CA
SE.f_lsh:....cvf("LSH").//.a.:#3D.b.<<.a;.b.:#3D.?#0A
...................writef("*n.ASHL.R8,R7,R8")#0A...
................ENDCASE#0A....CASE.f_rsh:....cvf("R
SH").//.a.:#3D.b.>>.a;.b.:#3D.?#0A.................
..writef("*n.MNEGL.R8,R4")#0A...................wri
tef("*n.MOVL.R7,R8")#0A...................writef("*
n.ASHQ.R4,R8,R8")#0A...................ENDCASE#0A..
..CASE.f_and:....cvf("AND").//.a.:#3D.b.&.a#0A.....
..............writef("*n.MCOML.R7,R1").#0A.........
..........writef("*n.BICL2.R1,R8").#0A.............
......ENDCASE#0A....CASE.f_or:.....cvf("OR").//.a.:
#3D.b.|.a.#0A...................writef("*n.BISL2.R7
,R8").#0A...................ENDCASE#0A....CASE.f_xo
r:....cvf("XOR").//.a.:#3D.b.NEQV.a#0A.............
......writef("*n.XORL2.R7,R8").#0A.................
..ENDCASE#0A....CASE.f_eqv:....cvf("EQV").//.a.:#3D
.b.EQV.a.#0A...................writef("*n.XORL2.R7,
R8").#0A...................writef("*n.MCOML.R8,R8")
.#0A...................ENDCASE#0A#0A....CASE.f_gbyt
:...cvf("GBYT").//.a.:#3D.b.%.a#0A.................
..writef("*n.MULL3.#234,R7,R4").#0A................
...writef("*n.MOVZBL.(R4)[R8],R8").#0A.............
......ENDCASE#0A....CASE.f_xgbyt:..cvf("XGBYT").//.
a.:#3D.a.%.b.#0A...................writef("*n.MULL3
.#234,R8,R4").#0A...................writef("*n.MOVZ
BL.(R4)[R7],R8").#0A...................ENDCASE#0A..
..CASE.f_pbyt:...cvf("PBYT").//.b.%.a.:#3D.c#0A....
...............writef("*n.MULL3.#234,R7,R4").#0A...
................writef("*n.MOVB.R6,(R4)[R8]").#0A..
.................ENDCASE#0A....CASE.f_xpbyt:..cvf("
XPBYT").//.a.%.b.:#3D.c.#0A...................write
f("*n.MULL3.#234,R8,R4").#0A...................writ
ef("*n.MOVB.R6,(R4)[R7]").#0A...................END
CASE#0A#0A//.swb.......Kn.Ld.K1.L1.#2E#2E#2E.Kn.Ln.
..Binary.chop.switch,.Ld.default#0A....CASE.f_swb:.
...cvswb()#0A...................ENDCASE#0A#0A//.swl
.......Kn.Ld.L1.#2E#2E#2E.Ln.........Label.vector.s
witch,.Ld.default#0A....CASE.f_swl:....cvswl()#0A..
.................ENDCASE#0A#0A....CASE.f_xch:....cv
f("XCH").//.swap.a.and.b#0A...................write
f("*n.MOVL.R8,R4")#0A...................writef("*n.
MOVL.R7,R8")#0A...................writef("*n.MOVL.R
4,R7")#0A...................ENDCASE#0A....CASE.f_at
b:....cvf("ATB").//.b.:#3D.a#0A...................w
ritef("*n.MOVL.R8,R7")#0A...................ENDCASE
#0A....CASE.f_atc:....cvf("ATC").//.c.:#3D.a#0A....
...............writef("*n.MOVL.R8,R6")#0A..........
.........ENDCASE#0A....CASE.f_bta:....cvf("BTA").//
.a.:#3D.b#0A...................writef("*n.MOVL.R7,R
8")#0A...................ENDCASE#0A....CASE.f_btc:.
...cvf("BTC").//.c.:#3D.b#0A...................writ
ef("*n.MOVL.R7,R6")#0A...................ENDCASE#0A
....CASE.f_atblp:..cvfp("ATBLP").//.b.:#3D.a;.a.:#3D
.P!n#0A...................writef("*n.MOVL.R8,R7")#0A
...................writef("*n.MOVL.%n(R10),R8",.4*p
val)#0A...................ENDCASE#0A....CASE.f_atbl
g:..cvfg("ATBLG").//.b.:#3D.a;.a.:#3D.G!n#0A.......
............writef("*n.MOVL.R8,R7")#0A.............
......writef("*n.MOVL.%n(R11),R8",.4*gval)#0A......
.............ENDCASE#0A....CASE.f_atbl:...cvfk("ATB
L").//.b.:#3D.a;.a.:#3D.k#0A...................writ
ef("*n.MOVL.R8,R7")#0A...................writef("*n
.MOVL.#23%n,R8",.kval)#0A...................ENDCASE
#0A#0A....CASE.f_j:......cvfl("J").//.jump.to.Ln#0A
...................writef("*n.JMP.L%n",.lval)#0A...
................ENDCASE#0A....CASE.f_rtn:....cvf("R
TN").//.procedure.return#0A...................write
f("*n.MOVL.4(R10),R2")..//.R2.#3D.<return.address>#0A
...................writef("*n.MOVL.(R10),R10")..//.
P.:#3D.old.P#0A...................writef("*n.JMP.(R
2)")........//.Jump.to.<return.address>#0A.........
..........ENDCASE#0A#0A....CASE.f_goto:...cvf("GOTO
").//.jump.to.a#0A...................writef("*n.JMP
.(R8)")#0A...................ENDCASE#0A#0A....CASE.
f_ikp:....cvfkp("IKP").//.a.:#3D.P!n.+.k;.P!n.:#3D.
a#0A...................writef("*n.MOVL.%n(R10),R8",
.4*pval)#0A...................TEST.kval#3D1#0A.....
..............THEN.writef("*n.INCL.R8")#0A.........
..........ELSE.TEST.kval#3D-1#0A...................
.....THEN.writef("*n.DECL.R8")#0A..................
......ELSE.writef("*n.ADDL2.#23%n,R8",.kval)#0A....
...............writef("*n.MOVL.R8,%n(R10)",.4*pval)
#0A...................ENDCASE#0A....CASE.f_ikg:....
cvfkg("IKG").//.a.:#3D.G!n.+.k;.G!n.:#3D.a#0A......
.............writef("*n.MOVL.%n(R11),R8",.4*gval)#0A
...................TEST.kval#3D1#0A................
...THEN.writef("*n.INCL.R8")#0A...................E
LSE.TEST.kval#3D-1#0A........................THEN.w
ritef("*n.DECL.R8")#0A........................ELSE.
writef("*n.ADDL2.#23%n,R8",.kval)#0A...............
....writef("*n.MOVL.R8,%n(R11)",.4*gval)#0A........
...........ENDCASE#0A....CASE.f_ikl:....cvfkl("IKL"
).//.a.:#3D.!Ln.+.k;.!Ln.:#3D.a#0A.................
..writef("*n.MOVL.L%n,R8",.lval)#0A................
...TEST.kval#3D1#0A...................THEN.writef("
*n.INCL.R8")#0A...................ELSE.TEST.kval#3D
-1#0A........................THEN.writef("*n.DECL.R
8")#0A........................ELSE.writef("*n.ADDL2
.#23%n,R8",.kval)#0A...................writef("*n.M
OVL.R8,L%n",.lval)#0A...................ENDCASE#0A.
...CASE.f_ip:.....cvfp("IP").//.a.:#3D.P!n.+.a;.P!n
.:#3D.a#0A...................writef("*n.ADDL2.%n(R1
0),R8",.4*pval)#0A...................writef("*n.MOV
L.R8,%n(R10)",.4*pval)#0A...................ENDCASE
#0A....CASE.f_ig:.....cvfg("IG").//.a.:#3D.G!n.+.a;
.G!n.:#3D.a#0A...................writef("*n.ADDL2.%
n(R11),R8",.4*gval)#0A...................writef("*n
.MOVL.R8,%n(R11)",.4*gval)#0A...................END
CASE#0A....CASE.f_il:.....cvfl("IL").//.a.:#3D.!Ln.
+.a;.!Ln.:#3D.a#0A...................writef("*n.ADD
L2.L%n,R8",.lval)#0A...................writef("*n.M
OVL.R8,L%n",.lval)#0A...................ENDCASE#0A#0A
....CASE.f_jeq:....cvfl("JEQ").//.Jump.to.Ln.if.b.#3D
.a#0A...................writef("*n.CMPL.R7,R8")#0A.
..................genBEQL(lval)#0A.................
..ENDCASE#0A....CASE.f_jne:....cvfl("JNE").//.Jump.
to.Ln.if.b.~#3D.a#0A...................writef("*n.C
MPL.R7,R8")#0A...................genBNEQ(lval)#0A..
.................ENDCASE#0A....CASE.f_jls:....cvfl(
"JLS").//.Jump.to.Ln.if.b.<.a#0A...................
writef("*n.CMPL.R7,R8")#0A...................genBLS
S(lval)#0A...................ENDCASE#0A....CASE.f_j
gr:....cvfl("JGR").//.Jump.to.Ln.if.b.>.a#0A.......
............writef("*n.CMPL.R7,R8")#0A.............
......genBGTR(lval)#0A...................ENDCASE#0A
....CASE.f_jle:....cvfl("JLE").//.Jump.to.Ln.if.b.<
#3D.a#0A...................writef("*n.CMPL.R7,R8")#0A
...................genBLEQ(lval)#0A................
...ENDCASE#0A....CASE.f_jge:....cvfl("JGE").//.Jump
.to.Ln.if.b.>#3D.a#0A...................writef("*n.
CMPL.R7,R8")#0A...................genBGEQ(lval)#0A.
..................ENDCASE#0A#0A....CASE.f_jeq0:...c
vfl("JEQ0").//.Jump.to.Ln.if.a.#3D.0#0A............
.......writef("*n.TSTL.R8")#0A...................ge
nBEQL(lval)#0A...................ENDCASE#0A....CASE
.f_jne0:...cvfl("JNE0").//.Jump.to.Ln.if.a.~#3D.0#0A
...................writef("*n.TSTL.R8")#0A.........
..........genBNEQ(lval)#0A...................ENDCAS
E#0A....CASE.f_jls0:...cvfl("JLS0").//.Jump.to.Ln.i
f.a.<.0#0A...................writef("*n.TSTL.R8")#0A
...................genBLSS(lval)#0A................
...ENDCASE#0A....CASE.f_jgr0:...cvfl("JGR0").//.Jum
p.to.Ln.if.a.>.0#0A...................writef("*n.TS
TL.R8")#0A...................genBGTR(lval)#0A......
.............ENDCASE#0A....CASE.f_jle0:...cvfl("JLE
0").//.Jump.to.Ln.if.a.<#3D.0#0A...................
writef("*n.TSTL.R8")#0A...................genBLEQ(l
val)#0A...................ENDCASE#0A....CASE.f_jge0
:...cvfl("JGE0").//.Jump.to.Ln.if.a.>#3D.0#0A......
.............writef("*n.TSTL.R8")#0A...............
....genBGEQ(lval)#0A...................ENDCASE#0A..
..CASE.f_jge0m:..cvfm("JGE0M").//.Jump.to.Mn.if.a.>
#3D.0#0A...................writef("*n.TSTL.R8")#0A.
..................genBGEQ(mval+10000)#0A...........
........ENDCASE#0A#0A....//.The.following.five.opco
des.are.never.generated.by#0A....//.the.BCPL.compil
er#0A....CASE.f_brk:....cvf("BRK").//.Breakpoint.in
struction#0A...................writef("*n.unimpleme
nted")#0A...................ENDCASE#0A....CASE.f_no
p:....cvf("NOP").//.No.operation#0A................
...ENDCASE#0A....CASE.f_chgco:..cvf("CHGCO").//.Cha
nge.coroutine#0A...................writef("*n.unimp
lemented")#0A...................ENDCASE#0A....CASE.
f_mdiv:...cvf("MDIV").//.a.:#3D.Muldiv(P!3,.P!4,.P!
5).#0A...................writef("*n.unimplemented")
#0A...................ENDCASE#0A....CASE.f_sys:....
cvf("SYS").//.System.function#0A...................
writef("*n.unimplemented")#0A...................END
CASE#0A#0A....CASE.f_modend:...cvf("MODEND").//.End
.of.module#0A.....................writef("*nL1000:"
).#0A.....................writef("*n.#2EEND*n").#0A
.....................modletter.:#3D.modletter+1#0A.
....................modstarted.:#3D.FALSE#0A.......
..............ENDCASE#0A....CASE.f_global:...cvglob
al().//.Global.initialisation.data#0A..............
.......ENDCASE#0A....CASE.f_string:...cvstring().//
.String.constant#0A.....................ENDCASE#0A.
...CASE.f_const:....cvconst().//.Large.integer.cons
tant#0A.....................ENDCASE#0A#0A....CASE.f
_static:...cvstatic().//.Static.variable.or.table#0A
.....................ENDCASE#0A....CASE.f_mlab:....
.cvfm("MLAB").//.Destination.of.jge0m#0A...........
..........writef("*nL%n:",.mval+10000)#0A..........
...........ENDCASE#0A....CASE.f_lab:......cvfl("LAB
").//.Program.label#0A.....................writef("
*nL%n:",.lval)#0A.....................ENDCASE#0A...
.CASE.f_lstr:.....cvfm("LSTR").//.a.:#3D.Mn...(poin
ter.to.string)#0A.....................writef("*n.MO
VAL.W^L%n,R8",.mval+10000)#0A.....................w
ritef("*n.DIVL2.#234,R8")#0A.....................EN
DCASE#0A....CASE.f_entry:....cventry().//.Start.of.
a.function#0A.....................ENDCASE#0A..}#0A#0A
..newline()#0A}.REPEAT#0A#0AAND.cvf(s)...BE.writef(
";.%s",.s)#0AAND.cvfp(s)..BE.writef(";.%t7.P%n",.s,
.rdp())#0AAND.cvfkp(s).BE.writef(";.%t7.K%n.P%n",.s
,.rdk(),.rdp())#0AAND.cvfg(s)..BE.writef(";.%t7.G%n
",.s,.rdg())#0AAND.cvfkg(s).BE.writef(";.%t7.K%n.G%
n",.s,.rdk(),.rdg())#0AAND.cvfkl(s).BE.writef(";.%t
7.K%n.L%n",.s,.rdk(),.rdl())#0AAND.cvfpg(s).BE.writ
ef(";.%t7.P%n.G%n",.s,.rdp(),.rdg())#0AAND.cvfk(s).
.BE.writef(";.%t7.K%n",.s,.rdk())#0AAND.cvfw(s)..BE
.writef(";.%t7.W%n",.s,.rdw())#0AAND.cvfl(s)..BE.wr
itef(";.%t7.L%n",.s,.rdl())#0AAND.cvfm(s)..BE.write
f(";.%t7.M%n",.s,.rdm())#0A#0AAND.cvswl().BE#0A{.LE
T.n.#3D.rdk()#0A..LET.dlab.#3D.rdl()#0A..LET.lab.#3D
.nextlab()#0A..writef(";.SWL.K%n.L%n",.n,.dlab)#0A.
.writef("*n.TSTL.R8")#0A..genBLSS(dlab)#0A..writef(
"*n.CMPL.#23%n,R8",.n)#0A..genBLEQ(dlab)#0Awritef("
*n.MOVL.L^X%n(R9)[R8],R1",.lab)#0Awritef("*n.JMP.(R
1)")#0A//..writef("*n.JMP.L^X%n(R9)[R8]",.lab)#0A..
writef("*n.#2EALIGN.LONG")#0A..writef("*nX%n:",.lab
)#0A..FOR.i.#3D.1.TO.n.DO#0A..{.writef("*n;.L%n",.r
dl())#0A....writef("*n.#2ELONG.L%n",.lval)#0A..}#0A
}#0A#0AAND.cvswb().BE#0A{.LET.n.#3D.rdk()#0A..LET.d
lab.#3D.rdl()#0A..writef(";.SWB.K%n.L%n",.n,.dlab).
.//.A.naive.implementation.of.swb#0A..FOR.i.#3D.1.T
O.n.DO.#0A..{.LET.k.#3D.rdk()#0A....LET.lab.#3D.rdl
()#0A....writef("*n;.K%n.L%n",.k,.lab)#0A....writef
("*n.CMPL.#23%n,R8",.k)#0A....genBEQL(lab)#0A..}#0A
..writef("*n.JMP.L%n",.dlab)#0A}#0A#0AAND.cvglobal(
).BE#0A{.LET.n.#3D.rdk()#0A..writef(";.GLOBAL.K%n*n
",.n)#0A..IF.sectname%0#3D0.FOR.i.#3D.0.TO.4.DO.sec
tname%i.:#3D."prog"%i#0A..writef("*n;#2Eglobl.%s*n"
,.sectname)#0A..writef(";%s::*n",.sectname)#0A..wri
tef(".#2Eentry.%s,0*n",.sectname)#0A..writef(".movl
.4(ap),r1*n")#0A..FOR.i.#3D.1.TO.n.DO#0A..{.LET.g.#3D
.rdg()#0A....LET.n.#3D.rdl()#0A....writef(";.G%n.L%
n*n",.g,.n)#0A....writef(".MOVAL.L%n,%n(r1)*n",.n,.
4*g)#0A..}#0A..writef(";.G%n",.rdg())#0A..writef("*
n.RET*n")#0A}#0A#0AAND.cvglobal1().BE#0A{.LET.n.#3D
.rdk()#0A..writef("*n;.GLOBAL.K%n",.n)#0A..IF.sectn
ame%0#3D0.FOR.i.#3D.0.TO.4.DO.sectname%i.:#3D."prog
"%i#0A..writef("*n#2EALIGN.LONG")#0A..writef("*n#2E
LONG.-1")#0A..FOR.i.#3D.1.TO.n.DO#0A..{.LET.g.#3D.r
dg()#0A....LET.n.#3D.rdl()#0A....writef("*n;.G%n.L%
n*n",.g,.n)#0A....writef("*n.#2ELONG.%i4,.L%n",.g,.
n)#0A..}#0A..writef("*n;.G%n",.rdg())#0A..writef("*
n.#2ELONG.%i4",.gval)#0A}#0A#0AAND.rdchars().#3D.VA
LOF#0A{.LET.n.#3D.rdk()#0A..charv%0.:#3D.n#0A..FOR.
i.#3D.1.TO.n.DO.charv%i.:#3D.rdc()#0A..RESULTIS.n#0A
}#0A#0AAND.cvstring().BE#0A{.LET.lab.#3D.rdm()#0A..
LET.n.#3D.rdchars()#0A..writef(";.STRING..M%n.K%n",
.lab,.n)#0A..FOR.i.#3D.1.TO.n.DO.writef(".C%n",.cha
rv%i)#0A..writef("*n.#2EALIGN.LONG")#0A..writef("*n
L%n:",.lab+10000)#0A..FOR.i.#3D.0.TO.n.DO.writef("*
n.#2EBYTE.%n",.charv%i)#0A}#0A#0AAND.cvconst().BE#0A
{.LET.lab.#3D.rdm()#0A..LET.w.#3D.rdw()#0A..writef(
";.CONST...M%n.W%n",.lab,.w)#0A..writef("*n.#2EALIG
N.LONG")#0A..writef("*nL%n:",.lab+10000)#0A..writef
("*n.#2ELONG.%n",.w)#0A}#0A#0AAND.cvstatic().BE#0A{
.LET.lab.#3D.rdl()#0A..LET.n.#3D.rdk()#0A..writef("
;.STATIC..L%n.K%n",.lab,.n)#0A..writef("*n.#2EALIGN
.LONG")#0A..writef("*nL%n:",.lab)#0A..FOR.i.#3D.1.T
O.n.DO.{.writef("*n;.W%n",.rdw())#0A...............
.......writef("*n.#2ELONG.%n",.wval)#0A............
........}#0A}#0A#0AAND.cvfs(s).BE#0A{.LET.n.#3D.rdc
hars()#0A..writef(";.%t7.K%n",.s,.n)#0A..FOR.i.#3D.
1.TO.n.DO.writef(".C%n",.charv%i)#0A}#0A#0AAND.cven
try().BE#0A{.LET.n.#3D.rdchars()#0A..LET.op.#3D.rdf
()#0A..LET.lab.#3D.rdl()#0A..writef("*n*n;.Entry.to
:.%s*n",.charv)#0A..writef(";.%t7.K%n",."ENTRY",.n)
#0A..FOR.i.#3D.1.TO.n.DO.writef(".C%n",.charv%i)#0A
..newline()#0A..TEST.op#3Df_lab.THEN.writef(";.LAB.
....L%n*n",.lab)#0A................ELSE.writef(";.B
ad.op.F%n.L%n*n",.op,.lab)#0A..FOR.i.#3D.n+1.TO.11.
DO.charv%i.:#3D.'.'#0A..IF.n>11.DO.charv!0.:#3D.11#0A
..writef("*n.#2ELONG.^X%x8",entryword)#0A..writef("
*n.#2ELONG.^X%x8",charv!0)#0A..writef("*n.#2ELONG.^
X%x8",charv!1)#0A..writef("*n.#2ELONG.^X%x8",charv!
2)#0A#0A..writef("*nL%n:",.lab)#0A..writef("*n.MOVL
.R10,(R1)").......//.Save.<old.P>#0A..writef("*n.MO
VL.R1,R10").........//.P.:#3D.<new.P>#0A..writef("*
n.MOVL.(SP)+,4(R10)").//.Save.<return.address>#0A..
writef("*n.MOVL.R2,8(R10)")....//.Save.<entry.point
>#0A..writef("*n.MOVL.R8,12(R10)")....//.Save.first
.argument#0A}#0A#0AAND.genBEQL(lab).BE#0A{.LET.m.#3D
.nextlab()#0A..writef("*n.BNEQ.X%n",.m)#0A..writef(
"*n.JMP.L%n",.lab)#0A..writef("*nX%n:",.m)#0A}#0A#0A
AND.genBNEQ(lab).BE#0A{.LET.m.#3D.nextlab()#0A..wri
tef("*n.BEQL.X%n",.m)#0A..writef("*n.JMP.L%n",.lab)
#0A..writef("*nX%n:",.m)#0A}#0A#0AAND.genBLSS(lab).
BE#0A{.LET.m.#3D.nextlab()#0A..writef("*n.BGEQ.X%n"
,.m)#0A..writef("*n.JMP.L%n",.lab)#0A..writef("*nX%
n:",.m)#0A}#0A#0AAND.genBGTR(lab).BE#0A{.LET.m.#3D.
nextlab()#0A..writef("*n.BLEQ.X%n",.m)#0A..writef("
*n.JMP.L%n",.lab)#0A..writef("*nX%n:",.m)#0A}#0A#0A
AND.genBLEQ(lab).BE#0A{.LET.m.#3D.nextlab()#0A..wri
tef("*n.BGTR.X%n",.m)#0A..writef("*n.JMP.L%n",.lab)
#0A..writef("*nX%n:",.m)#0A}#0A#0AAND.genBGEQ(lab).
BE#0A{.LET.m.#3D.nextlab()#0A..writef("*n.BLSS.X%n"
,.m)#0A..writef("*n.JMP.L%n",.lab)#0A..writef("*nX%
n:",.m)#0A}#0A#0A#0A

######natbcpl/sysb/blib.b#
//.(c)..Copyright:..Martin.Richards..29.May.2004#0A
#0A/*#0A03/07/07#0AAdded.codewrch.to.write.extended
.characters.using.UTF8.or#0AGB2312#2E.Added.%#23.su
bstitution.item.in.writef.to.invoke.it#2E.Note.that
#0A*xU,.*xG,.*#23hhhh,.*#23#23hhhhhhhh.and.*#23dddd
.escapes.have.been.added.to#0ABCPL.string.and.chara
cter.constants#2E#0A#0A29/6/02#0ARenamed.IOLIB.as.D
LIB.(the.system.Dependent.LIBrary)#2E.Put.system#0A
independent.code.in.BLIB.and.the.rest.in.DLIB#2E#0A
#0A24/4/04#0AMade.many.changed.to.make.BLIB.more.co
mpatible.between.Cintpos.and#0Asingle.threaded.Cint
code.BCPL#2E#0A#0A21/3/2003#0AMake.instrcount(f,a,b
,#2E#2E#2E).set.result2.to.result.of.f(a,b,c,#2E#2E
#2E#2E)#0A#0A10/7/2000#0AChanged.the.definition.of.
mkobj.to.take.up.to.11.initialisation#0Aarguments#2E
.See.bcplprogs/objdemo#2Eb#0A#0A28/2/2000#0AAdded.f
unction.instrcount(f,a,b,c,e,f,r,g,h,i,j,k)#0Awhich
.returns.the.number.of.cintcode.instructions.execut
ed#0Awhen.calling.f(a,b,#2E#2E#2E)#2E#0A#0A30/4/199
6#0AAdded.function.flush()#0Awith.corresponding.cha
nge.in.cintsys#2Ec#0A#0A7/6/1996#0ADefined.mkobj(up
b,.fns,.a,.b).for.use.in.object.oriented.programmin
g#2E#0ASee.bcplprogs/objdemo#2Eb..(args.a.and.b.add
ed.30.March.1999)#2E#0A*/#0A#0ASECTION."BLIB"#0A#0A
GET."libhdr"#0A#0ALET.stop(code).BE#0A{.//.Return.t
o.the.CLI.with.a.return.code#2E#0A..//.It.must.be.c
alled.from.the.command's.coroutine,#0A..//.not.an.i
nner.coroutine#2E#0A..returncode.:#3D.code#0A..cowa
it(code)#0A}#0A#0ALET.clihook(stackupb).#3D.VALOF#0A
{.LET.v.#3D.VEC.rtn_upb#0A..rootnode.:#3D.v#0A..FOR
.i.#3D.0.TO.rtn_upb.DO.rootnode!i.:#3D.0#0Asawritef
("*nclihook.entered,.stackupb#3D%n*n",.stackupb)#0A
..currentdir.:#3D.0#0A..selectoutput(findoutput("**
"))#0A..selectinput(findinput("**"))#0A#0A..//.The.
native.code.command.arguments.are.automatically#0A.
.//.prepended.to.stdin#2E.This.is.done.in.sardch.in
.dosys.of.sysc/clib#2Ec#0A#0A..currco.:#3D.@stackup
b-3-6.//.Initialise.the.coroutine.environment#0A..c
olist.:#3D.currco#0A..currco!co_pptr...:#3D.0#0A..c
urrco!co_parent.:#3D.-1..//.Mark.as.root.coroutine#2E
#0A..currco!co_list...:#3D.0#0A#0A..currco!co_fn...
:#3D.clihook......//.fn#0A..currco!co_size.:#3D.sta
ckupb.....//.stackupb.(first.arg.of.clihook)#0A..cu
rrco!5.......:#3D.0............//.c#0A#0A..RESULTIS
.start(0)#0A}#0A#0AAND.intflag().#3D.sys(Sys_intfla
g)..//.Returns.TRUE.if.user.interrupt#0A#0AAND.abor
t(code).#3D.sys(Sys_quit,.code)#0A#0AAND.level(p3).
#3D.(@p3)!-3#0A#0AAND.longjump(lev,.lab).BE.{.LET.p
.#3D.@lev.-.3;.p!0,.p!1.:#3D.lev,.lab.}#0A#0AAND.sa
rdch()...#3D.sys(Sys_sardch)#0A#0AAND.sawrch(ch).#3D
.sys(Sys_sawrch,ch)#0A#0A//.Set.the.timeout.field#0A
//.msecs>0...The.stream.timeout.value.in.milli-seco
nds#0A//.msecs#3D0...No.timeout.value.(the.default)
#0A//.msecs<0...Only.perform.non.blocking.operation
s.on.the.stream#0A//.On.a.timeout.(on.TCP.streams)#0A
//.act#3D.0....Repeat.the.current.operation#0A//.ac
t#3D-1....Make.timeout.have.the.effect.of.EOF#0A//.
act#3D-2....Return.timeoutch#0AAND.settimeout(scb,.
msecs,.act).BE#0A{.scb!scb_timeout.:#3D.msecs#0A..s
cb!scb_timeoutact.:#3D.act#0A}#0A#0A//.Just.set.the
.timeoutact.field#0AAND.settimeoutact(scb,.act).BE.
scb!scb_timeoutact.:#3D.act#0A#0AAND.rdch().#3D.VAL
OF#0A//.Returns.the.next.byte.from.the.currently.se
lected.input.stream,#0A//.but.ignores.CR#2E#0A//.If
.the.buffer.is.empty,.it.calls.replenish.to.attempt
.to.refill.it#2E#0A//.It.aborts.186.if.no.input.str
eam.is.selected#2E#0A{.LET.pos.#3D.cis!scb_pos.//.P
osition.of.next.byte#0A#0A..UNLESS.cis.DO.abort(186
)#0A..IF.pos<cis!scb_end.DO.{.LET.ch.#3D.cis!scb_bu
f%pos#0A..........................cis!scb_pos.:#3D.
pos+1#0A..........................IF.ch#3D'*c'.LOOP
.//.Ignore.CR#0A..........................RESULTIS.
ch#0A........................}#0A..//.No.byte.avail
able,.so.attempt.to.replenish.the.buffer#0A..//.If.
replenish.returns.FALSE,.no.chars.were.placed.in.th
e.buffer#0A..//.and.the.reason.why.not.is.placed.in
.result2.as.follows#0A..//....result2.#3D.-1....end
.of.file#0A..//....result2.#3D.-2....timeout#0A..//
....result2.#3D.-3....polling.and.no.characters.ava
ilable#2E#0A..//....result2.#3D.code..error.code#0A
..UNTIL.replenish(cis).DO#0A..{.IF.result2#3D-2.DO#0A
....{.LET.act.#3D.cis!scb_timeoutact.//.Look.at.tim
eout.action#0A......IF.act#3D-2.RESULTIS.timeoutch#0A
......IF.act#3D-1.RESULTIS.endstreamch#0A......LOOP
..//.Try.replenishing.again#0A....}#0A....RESULTIS.
result2<0.->.result2,.endstreamch#0A..}#0A..//.Succ
essful.replenishment.so.try.rdch.again#0A..//.There
.will.be.at.least.one.character.in.the.buffer#0A}.R
EPEAT#0A#0AAND.binrdch().#3D.VALOF#0A//.Same.as.rdc
h.but.does.not.ignore.CR#2E#0A{.LET.pos.#3D.cis!scb
_pos.//.Position.of.next.byte#0A#0A..UNLESS.cis.DO.
abort(186)#0A..IF.pos<cis!scb_end.DO.{.LET.ch.#3D.c
is!scb_buf%pos#0A..........................cis!scb_
pos.:#3D.pos+1#0A..........................RESULTIS
.ch#0A........................}#0A..//.No.byte.avai
lable,.so.attempt.to.replenish.the.buffer#0A..//.If
.replenish.returns.FALSE,.no.chars.were.placed.in.t
he.buffer#0A..//.and.the.reason.why.not.is.placed.i
n.result2.as.follows#0A..//....result2.#3D.-1....en
d.of.file#0A..//....result2.#3D.-2....timeout#0A../
/....result2.#3D.-3....polling.and.no.characters.av
ailable#2E#0A..//....result2.#3D.code..error.code#0A
..UNTIL.replenish(cis).DO#0A..{.IF.result2#3D-2.DO#0A
....{.LET.act.#3D.cis!scb_timeoutact.//.Look.at.tim
eout.action#0A......IF.act#3D-2.RESULTIS.timeoutch#0A
......IF.act#3D-1.RESULTIS.endstreamch#0A......LOOP
..//.Try.replenishing.again#0A....}#0A....RESULTIS.
result2<0.->.result2,.endstreamch#0A..}#0A..//.Succ
essful.replenishment.so.try.rdch.again#0A..//.There
.will.be.at.least.one.ch.in.the.buffer#0A}.REPEAT#0A
#0AAND.unrdch().#3D.VALOF#0A//.Attempt.to.step.inpu
t.back.by.one.byte.position#2E#0A//.It.returns:.TRU
E.if.successful,.and#0A//.............FALSE.otherwi
se#0A//.After.a.call.of.rdch().it.will.always.be.su
ccessful.at.least.once#2E#0A//.It.aborts:.186.if.no
t.input.stream,.is.selected#2E#0A{.LET.pos.#3D.cis!
scb_pos#0A..UNLESS.cis.DO.abort(186)#0A..IF.pos<#3D
0.RESULTIS.FALSE.//.Cannot.UNRDCH.past.origin#2E#0A
..cis!scb_pos.:#3D.pos-1#0A..RESULTIS.TRUE#0A}#0A#0A
AND.wrch(ch).#3D.VALOF#0A//.wrch(ch).writes.ch.to.t
he.current.output.stream#2E#0A//.It.returns.TRUE.if
.successful,.FALSE.otherwise#0A//.It.aborts:.187.if
.no.stream.is.selected#0A//............189.on.deple
tion.failure#2E#0A{.LET.pos.#3D.cos!scb_pos#0A#0A..
//.If.the.buffer.is.full.try.to.deplete.it#2E#0A..I
F.pos.>#3D.cos!scb_bufend.DO#0A..{.UNLESS.deplete(c
os).RESULTIS.FALSE#0A....UNLESS.cos!scb_buf..RESULT
IS.TRUE.//.Must.be.writing.to.NIL:#0A....pos.:#3D.c
os!scb_pos#0A..}#0A#0A..//.Pack.the.character.and.a
dvance.pos#2E#0A..cos!scb_buf%pos.:#3D.ch#0A..pos.:
#3D.pos+1#0A..cos!scb_pos.:#3D.pos#0A..//.Advance.e
nd.of.valid.data.pointer,.if.necessary#0A..IF.cos!s
cb_end.<.pos.DO.cos!scb_end.:#3D.pos#0A..cos!scb_wr
ite.:#3D.TRUE.//.Set.flag.to.indicate.the.buffer.ha
s.changed#2E#0A#0A..UNLESS.cos!scb_type<0.&.ch<'*s'
.RESULTIS.TRUE.//.Normal.return#0A#0A..//.The.strea
m.is.interactive.and.ch.is.a.control.character#2E#0A
#0A..IF.ch#3D'*n'.DO..wrch('*c')..//.Fiddle.for.Cyg
win#0A#0A..//.Call.deplete.at.the.end.of.each.inter
active.line#2E#0A..IF.ch#3D'*n'.|.ch#3D'*p'.RESULTI
S.deplete(cos)#0A..RESULTIS.TRUE#0A}#0A#0AAND.binwr
ch(ch).#3D.wrch(ch.|.256)#0A#0AAND.codewrch(code).B
E#0A{.//.This.(misleadingly).writes.either.a.Unicod
e.character.in#0A..//.UTF-8.format.or.a.code.in.GB2
312.format#2E#0A..//.A.special.(negative).value.to.
select.the.current.encoding#0A..//.to.be.used.on.th
e.currently.selected.output.stream.(cos)#2E#0A#0A..
IF.code<0.DO#0A..{.//.Set.the.encoding.for.the.curr
ently.selected#0A....//.output.stream#2E#0A....cos!
scb_encoding.:#3D.code.//.UTF8.(#3D-1).or.GB2312.(#3D
-2)#0A....RETURN#0A..}#0A..//.Select.UTF8.unless.GB
2312.explicitly.specified.in.the.SCB#2E#0A..TEST.co
s!scb_encoding#3DGB2312#0A..THEN.gb2312wrch(code)#0A
..ELSE.utf8wrch(code)#0A}#0A#0AAND.gb2312wrch(code)
.BE#0A{.//.I.believe.the.encoding.is.as.follows:#0A
..//.code.#3D.0.-.127.#3D>.code#0A..//.code.#3D.xxy
y....#3D>.<xx.+.160>.<yy.+.160>#0A..//.............
......eg.4566.#3D>.<45+160>.<66+160>.or.CD.E2#0A../
/.Note.that.the.row.encoding.(CD).is.written.first,
.followed#0A..//.by.the.column#2E#0A..TEST.code<#3D
127#0A..THEN.{.wrch(code)#0A//sawritef(".gb2312:.%x
4.#3D>.%x2*n",.code,.code)#0A.......}#0A..ELSE.{.LE
T.hi.#3D.code../..100.+.160.//.Row.encoding#0A.....
....LET.lo.#3D.code.MOD.100.+.160.//.Column.encodin
g#0A.........wrch(hi)#0A.........wrch(lo)#0A//sawri
tef(".gb2312:.%x4.#3D>.%x2.%x2*n",.code,.hi,.lo)#0A
.......}#0A}#0A#0AAND.utf8wrch(code).BE#0A{.//.Writ
e.a.Unicode.character.in.RTF-8.format#0A..IF.code<#3D
#23x7F.DO#0A..{.wrch(code)...................//.0xx
xxxxx#0A....RETURN#0A..}#0A..IF.code<#3D#23x7FF.DO#0A
..{.wrch(#23b1100_0000+(code>>6))..//.110xxxxx#0A..
..wrch(#23x80+(.code....&#23x3F))..//.10xxxxxx#0A..
..RETURN#0A..}#0A..IF.code<#3D#23xFFFF.DO#0A..{.wrc
h(#23b1110_0000+(code>>12)).//.1110xxxx#0A....wrch(
#23x80+((code>>6)&#23x3F))..//.10xxxxxx#0A....wrch(
#23x80+(.code....&#23x3F))..//.10xxxxxx#0A....RETUR
N#0A..}#0A..IF.code<#3D#23x1F_FFFF.DO#0A..{.wrch(#23
b1111_0000+(code>>18)).//.11110xxx#0A....wrch(#23x8
0+((code>>12)&#23x3F)).//.10xxxxxx#0A....wrch(#23x8
0+((code>>6)&#23x3F))..//.10xxxxxx#0A....wrch(#23x8
0+(.code....&#23x3F))..//.10xxxxxx#0A....RETURN#0A.
.}#0A..IF.code<#3D#23x3FF_FFFF.DO#0A..{.wrch(#23b11
11_1000+(code>>24)).//.111110xx#0A....wrch(#23x80+(
(code>>18)&#23x3F)).//.10xxxxxx#0A....wrch(#23x80+(
(code>>12)&#23x3F)).//.10xxxxxx#0A....wrch(#23x80+(
(code>>6)&#23x3F))..//.10xxxxxx#0A....wrch(#23x80+(
.code....&#23x3F))..//.10xxxxxx#0A....RETURN#0A..}#0A
..IF.code<#3D#23x7FFF_FFFF.DO#0A..{.wrch(#23b1111_1
100+(code>>30)).//.1111110x#0A....wrch(#23x80+((cod
e>>24)&#23x3F)).//.10xxxxxx#0A....wrch(#23x80+((cod
e>>18)&#23x3F)).//.10xxxxxx#0A....wrch(#23x80+((cod
e>>12)&#23x3F)).//.10xxxxxx#0A....wrch(#23x80+((cod
e>>.6)&#23x3F)).//.10xxxxxx#0A....wrch(#23x80+(.cod
e.....&#23x3F)).//.10xxxxxx#0A....RETURN#0A..}#0A#0A
..//.Bad.Unicode.character#0A..writef("#23%x4#23",.
code)#0A}#0A#0AAND.readwords(vector,.count).#3D.VAL
OF#0A{.LET.i,.lim.#3D.0,.count*bytesperword#0A//saw
ritef("BLIB.co#3D%n:.readwords.count#3D%n.scb#3D%n.
block#3D%n.pos#3D%n*n",#0A//..........currco,.count
,.cis,.cis!scb_block,.cis!scb_pos)#0A#0A..IF.count<
#3D0.RESULTIS.0#0A#0A..{.LET.pos.#3D.cis!scb_pos.//
..Position.of.next.byte#0A....AND.end.#3D.cis!scb_en
d.//.Position.past.last.byte#0A....AND.buf.#3D.cis!
scb_buf.//.Byte.buffer.--.replenish.might.change.bu
f#0A#0A....WHILE.pos.<.end.DO....//.Copy.bytes.--.m
ore.needed#0A....{.//.At.least.one.byte.available.a
nd.needed#0A......vector%i.:#3D.buf%pos.......//.Co
py.it#0A......i,.pos.:#3D.i+1,.pos+1#0A......IF.i<l
im.LOOP............//.More.byte(s).needed#0A....../
/.Successful.completion#0A......cis!scb_pos.:#3D.po
s#0A......RESULTIS.count#0A....}#0A#0A....cis!scb_p
os.:#3D.pos#0A#0A....//.No.byte.available,.so.attem
pt.to.replenish.the.buffer#0A....UNLESS.replenish(c
is).RESULTIS.i/bytesperword#0A....//.Successful.rep
lenishment.so.copy.some.more.bytes#0A....//.There.w
ill.be.at.least.one.byte.in.the.buffer#0A..}.REPEAT
#0A}#0A#0AAND.writewords(vector,.count).#3D.VALOF#0A
{.LET.i,.len.#3D.0,.count*bytesperword.//.Length.in
..bytes#0A#0A//sawritef("BLIB.co#3D%n:.writewords.co
unt#3D%n.scb#3D%n.block#3D%n.pos#3D%n*n",#0A//.....
......currco,.count,.cos,.cos!scb_block,.cos!scb_pos
)#0A#0A..IF.len<#3D0.RESULTIS.FALSE#0A#0A..{.LET.po
s....#3D.cos!scb_pos#0A....AND.bufend.#3D.cos!scb_b
ufend#0A....AND.buf....#3D.cos!scb_buf#0A#0A....//.
If.the.buffer.is.full.try.to.deplete.it#2E#0A....WH
ILE.pos.<.bufend.DO#0A....{.//.There.is.a.byte.avai
lable.and.room.in.the.buffer#0A......buf%pos.:#3D.v
ector%i....//.so.copy.it#0A......i,.pos.:#3D.i+1,.p
os+1#0A......IF.i<len.LOOP..........//.Loop.if.anot
her.byte.available#0A#0A......cos!scb_pos.:#3D.pos.
.....//.Update.SCB.and.return.successfully#0A....../
/.Advance.end.of.valid.data,.if.necessary#0A......I
F.cos!scb_end.<.pos.DO.cos!scb_end.:#3D.pos#0A.....
..cos!scb_write.:#3D.TRUE.//.At.least.one.byte.has.b
een.written#0A#0A......RESULTIS.TRUE#0A....}#0A#0A.
....//.The.buffer.is.full.so.update.the.SCB.and.depl
ete#0A....cos!scb_pos.:#3D.pos#0A....//.Advance.end
..of.valid.data,.if.necessary#0A....IF.cos!scb_end.<
..pos.DO.cos!scb_end.:#3D.pos#0A....IF.i>0.DO.cos!sc
b_write.:#3D.TRUE.//.TRUE.if.at.least.one.byte.has.
been.written#0A#0A....UNLESS.deplete(cos).RESULTIS.
FALSE#0A..}.REPEAT#0A}#0A#0A//.get_record.returns.T
RUE.if.successful#0A//.it.returns.FALSE.if.eof.is.e
ncountered.before.the.whole.record#0A//.has.been.re
ad#2E#0A//.MR.29/7/02:.First.record.of.a.file.has.r
ecord.number.0#0AAND.get_record.(vector,.recno,.scb
).#3D.VALOF#0A{.LET.i...#3D.0..............//.Posit
ion.of.next.byte.to.put.in.vector#2E#0A..LET.len.#3D
..scb!scb_reclen.//.Length.of.the.record.in.bytes#2E
#0A#0A..IF.len<#3D0.RESULTIS.FALSE.//.Fail,.no.reco
rd.length.specified#2E#0A#0A//sawritef("BLIB.co#3D%
n:.get_record.recno#3D%n.reclen#3D%n.blk#3D%n.pos#3D
%n.end#3D%n*n",#0A//...currco,.recno,.scb!scb_recle
n,.scb!scb_block,.scb!scb_pos,.scb!scb_end)#0A..rec
ordpoint(scb,.recno)#0A#0A//sawritef("BLIB:.get_rec
ord.recno#3D%n.reclen#3D%n.pos#3D%n.end#3D%n*n",#0A
//...........recno,.scb!scb_reclen,.scb!scb_pos,.sc
b!scb_end)#0A#0A#0A..{.//.Start.of.reading.loop#0A.
....LET.pos.#3D.scb!scb_pos.//.Position.of.next.byte
#0A....AND.end.#3D.scb!scb_end.//.Position.past.las
t.byte#0A....AND.buf.#3D.scb!scb_buf.//.Byte.buffer
..--.replenish.might.change.buf#0A#0A....WHILE.pos.<
..end.DO....//.Copy.bytes.--.more.needed#0A....{.//.
At.least.one.byte.needed#0A......vector%i.:#3D.buf%
pos#0A//sawritef("BLIB.co#3D%n:.get_record.byte#3D%
x2*n",.currco,.vector%i)#0A......i,.pos.:#3D.i+1,.p
os+1#0A......IF.i<len.LOOP.......//.More.byte(s).ne
eded#0A......//.Successful.completion#0A......scb!s
cb_pos.:#3D.pos#0A//sawritef("BLIB.co#3D%n:.get_rec
ord.recno#3D%n.len#3D%n.successful*n",#0A//........
...currco,.recno,.len)#0A......RESULTIS.TRUE#0A....}
#0A#0A....scb!scb_pos.:#3D.pos#0A#0A....//.No.byte.
available,.so.attempt.to.replenish.the.buffer#0A...
.UNLESS.replenish(scb).DO#0A....{#0A//sawritef("BLI
B.co#3D%n:.get_record.recno#3D%n.len#3D%n.hit.eof.a
t.%n*n",#0A//..........currco,.recno,.len,.i)#0A...
...RESULTIS.FALSE..//.Failure.due.to.eof,.timeout,.
error.etc#0A....}#0A....//.Successful.replenishment
.so.copy.some.more.bytes#0A....//.There.will.still.
be.at.least.one.byte.in.the.buffer#0A..}.REPEAT#0A}
#0A#0A//.MR.29/7/02:.The.first.record.of.a.file.has
.number.0.(not.1)#0A//.Returns.TRUE.if.successful#0A
//.Returns.FALSE,.otherwise#2E#0AAND.put_record(vec
tor,.recno,.scb).#3D.VALOF#0A{.LET.i,.len.#3D.0,.sc
b!scb_reclen#0A#0A..UNLESS.scb!scb_id#3Did_inoutscb
.DO#0A..{.sawritef("BLIB.co#3D%n:.put_record.id.not
.inout*n",.currco)#0A....abort(999)#0A....RESULTIS.
FALSE#0A..}#0A#0A..IF.len<#3D0.RESULTIS.FALSE.//.Er
ror.--.no.record.length#0A#0A//sawritef("BLIB:.put_
record.recno#3D%n.reclen#3D%n.blk#3D%n.pos#3D%n.end
#3D%n*n",#0A//...........recno,.scb!scb_reclen,.scb
!scb_block,.scb!scb_pos,.scb!scb_end)#0A..UNLESS.re
cordpoint(scb,.recno).RESULTIS.FALSE#0A//sawritef("
BLIB:.put_record.recno#3D%n.reclen#3D%n.blk#3D%n.po
s#3D%n.end#3D%n*n",#0A//...........recno,.scb!scb_r
eclen,.scb!scb_block,.scb!scb_pos,.scb!scb_end)#0A/
/abort(2222)#0A..{.LET.pos....#3D.scb!scb_pos#0A...
.AND.bufend.#3D.scb!scb_bufend#0A....AND.buf....#3D
.scb!scb_buf#0A#0A....//.If.the.buffer.is.full.try.
to.deplete.it#2E#0A....WHILE.pos.<.bufend.DO#0A....
{.//.There.is.a.byte.available.and.room.in.the.buff
er#0A......buf%pos.:#3D.vector%i....//.so.copy.it#0A
......i,.pos.:#3D.i+1,.pos+1#0A......scb!scb_write.
:#3D.TRUE..//.At.least.one.byte.has.been.written#0A
......IF.i<len.LOOP..........//.Loop.if.another.byt
e.available#0A#0A......scb!scb_pos.:#3D.pos.....//.
Update.SCB.and.return.successfully#0A......//.Advan
ce.end.of.valid.data,.if.necessary#0A......IF.scb!s
cb_end.<.pos.DO.scb!scb_end.:#3D.pos#0A//......scb!
scb_write.:#3D.TRUE.//.At.least.one.byte.has.been.w
ritten#0A#0A......RESULTIS.TRUE.........//.Successf
ul.completion#0A....}#0A#0A....//.The.buffer.is.ful
l.so.update.the.SCB.and.deplete#0A....scb!scb_pos.:
#3D.pos#0A....//.Advance.end.of.valid.data,.if.nece
ssary#0A....IF.scb!scb_end.<.pos.DO.scb!scb_end.:#3D
.pos#0A//..IF.i>0.DO.scb!scb_write.:#3D.TRUE.//.if.
at.least.one.byte.has.been.written#0A#0A....UNLESS.
deplete(scb).RESULTIS.FALSE#0A..}.REPEAT#0A}#0A#0A/
/.replenish(scb).returns:#0A//...TRUE..............
..Successful.replenishment,.at.least.one.ch.read#0A
//...FALSE.result2.#3D.-1..End.of.file,.no.chars.re
ad.....//.MR.15/4/03#0A//...FALSE.result2.#3D.-2..T
imeout,.no.chars.read.--.none.yet.available#0A//...
FALSE.result2.#3D.-3..Polling,.no.chars.read.--.non
e.available#0A//...FALSE.result2.......Error.code#0A
#0AAND.replenish(scb).#3D.VALOF#0A{.LET.rdfn.#3D.sc
b!scb_rdfn#0A..result2.:#3D.-1#0A..//.The.condition
.scb!scb_end<0.indicates.that.the.stream.is.exhaust
ed#0A..UNLESS.scb!scb_end>#3D0.&.rdfn.&.rdfn(scb).R
ESULTIS.FALSE#0A..RESULTIS.TRUE#0A}#0A#0A//.deplete
(scb).returns:#0A//...TRUE..Successful.depletion,.o
r#0A//...FALSE.otherwise#2E#0A//.It.aborts:.187.if.
scb.is.not.a.suitable.stream#2E#0A#0AAND.deplete(sc
b).#3D.VALOF#0A{.LET.wrfn.#3D.scb!scb_wrfn.#0A..IF.
scb!scb_end<0.RESULTIS.FALSE.///.?????.result2#0A..
UNLESS.wrfn.DO.abort(187)#0A//sawritef("BLIB:.deple
te.calling.wrfn(%n)*n",.scb)#0A..RESULTIS.wrfn(scb)
#0A}#0A#0AAND.findinput....(string).......#3D..find
stream(string,.id_inscb,....0)#0A#0AAND.pathfindinp
ut(string,.path).#3D..findstream(string,.id_inscb,.
path)#0A#0AAND.findoutput...(string).......#3D..fin
dstream(string,.id_outscb,...0)#0A#0AAND.findinoutp
ut.(string).......#3D..findstream(string,.id_inouts
cb,.0)#0A#0AAND.findupdate...(string).......#3D..fi
ndstream(string,.id_inoutscb,.0)#0A#0AAND.selectinp
ut(scb).BE.//.scb#3D0.is.occasionally.used#0A{.UNLE
SS.scb#3D0.|.scb!scb_id#3Did_inscb.|.scb!scb_id#3Di
d_inoutscb.DO.abort(186)#0A..cis.:#3D.scb#0A}#0A#0A
AND.selectoutput(scb).BE.//.scb#3D0.is.occasionally
.used#0A{.UNLESS.scb#3D0.|.scb!scb_id#3Did_outscb.|
.scb!scb_id#3Did_inoutscb.DO.abort(187)#0A..cos.:#3D
.scb#0A}#0A#0AAND.endread().BE.endstream(cis)#0A#0A
AND.endwrite().BE.endstream(cos)#0A#0AAND.endstream
(scb).BE.TEST.scb>0#0ATHEN.{.LET.endfn.#3D.scb!scb_
endfn#0A.......LET.res2.#3D.result2#0A.......IF.end
fn.DO.endfn(scb)#0A.......freevec(scb)#0A.......IF.
cis.#3D.scb.DO.cis.:#3D.0#0A.......IF.cos.#3D.scb.D
O.cos.:#3D.0#0A#0A.......result2.:#3D.res2#0A.....}
#0AELSE.IF.scb<0.DO.//.Safety.check#0A.....{.sawrit
ef("*nBLIB:.endstream.given.negative.scb#3D%n*n",.s
cb)#0A.......abort(999)#0A.....}#0A#0AAND.input().#3D
.cis#0A#0AAND.output().#3D.cos#0A#0AAND.readn().#3D
.VALOF#0A{.LET.sum,.ch,.neg.#3D.0,.0,.FALSE#0A#0A..
{.ch.:#3D.rdch()#0A....IF.'0'<#3Dch<#3D'9'.BREAK#0A
....SWITCHON.ch.INTO#0A....{.DEFAULT:...unrdch()#0A
.................result2.:#3D.-1#0A................
.RESULTIS.0#0A......CASE.'*s':#0A......CASE.'*t':#0A
......CASE.'*n':.LOOP#0A#0A......CASE.'-':..neg.:#3D
.TRUE#0A......CASE.'+':..ch.:#3D.rdch()#0A.........
........BREAK#0A....}#0A..}.REPEAT#0A#0A..WHILE.'0'
<#3Dch<#3D'9'.DO#0A..{.sum.:#3D.10.*.sum.+.ch.-.'0'
#0A....ch.:#3D.rdch()#0A..}#0A..IF.neg.DO.sum.:#3D.
-sum#0A..unrdch()#0A..result2.:#3D.0#0A..RESULTIS.s
um#0A}#0A#0AAND.newline().BE.wrch('*n')#0A#0AAND.ne
wpage().BE.wrch('*p')#0A#0AAND.writed(n,.d).BE.writ
edz(n,.d,.FALSE)#0A#0AAND.writez(n,.d).BE.writedz(n
,.d,.TRUE)#0A#0AAND.writedz(n,.d,.zeroes).BE#0A{.LE
T.t.#3D.VEC.10#0A..LET.i.#3D.0#0A..LET.k.#3D.-n#0A#0A
..IF.n<0.DO.{.d.:#3D.d.-.1;.k.:#3D.n.}#0A#0A..{.t!i
.:#3D.-(k.REM.10)#0A....k...:#3D.k/10#0A....i...:#3D
.i.+.1#0A..}.REPEATWHILE.k#0A#0A..IF.n<0.&.zeroes.D
O.wrch('-')#0A..FOR.j.#3D.i+1.TO.d.DO.wrch(zeroes.-
>.'0',.'*s')#0A..IF.(n<0).&.~zeroes.DO.wrch('-')#0A
..FOR.j.#3D.i-1.TO.0.BY.-1.DO.wrch(t!j+'0')#0A}#0A#0A
AND.writen(n).BE.writed(n,.0)#0A#0AAND.writehex(n,.
d).BE.#0A{.IF.d>1.DO.writehex(n>>4,.d-1)#0A..wrch((
n&15)!TABLE.'0','1','2','3','4','5','6','7',#0A....
................'8','9','A','B','C','D','E','F')#0A
}#0A#0AAND.writeoct(n,.d).BE#0A{.IF.d.>.1.DO.writeo
ct(n>>3,.d-1)#0A..wrch((n&7)+'0')#0A}#0A#0AAND.writ
ebin(n,.d).BE#0A{.IF.d.>.1.DO.writebin(n>>1,.d-1)#0A
..wrch((n&1)+'0')#0A}#0A#0AAND.writes(s).BE#0A{.//.
UNLESS.0.<.s.<.rootnode!rtn_memsize.DO.s.:#3D."#23#23
Bad.string#23#23"#0A..FOR.i.#3D.1.TO.s%0.DO.wrch(s%
i)#0A}#0A#0AAND.writet(s,.d).BE#0A{.writes(s)#0A..F
OR.i.#3D.1.TO.d-s%0.DO.wrch('*s')#0A}#0A#0AAND.writ
eu(n,.d).BE#0A{.LET.m.#3D.(n>>1)/5#0A..IF.m.DO.{.wr
ited(m,.d-1);.d.:#3D.1.}#0A..writed(n-m*10,.d)#0A}#0A
#0A#0A#0A/*#0A........The.following.routines.provid
e.and.extended.version.of.writef#2E#0AThey.support.
the.following.extra.substitution.items:#0A#0A......
..1#2E.%F...-.Takes.next.argument.as.a.writef.forma
t.string.and#0A................calls.writef.recursi
vely.using.the.remaining.arguments#2E#0A...........
.....The.argument.pointer.is.positioned.to.the.next
.available#0A................argument.on.return#2E#0A
#0A........2#2E.%M...-.The.next.argument.is.taken.a
s.a.message.number.and.processed#0A................
as.for.%F.above#2E.The.message.format.string.is.loo
ked.up.by#0A................get_text(messno,.str,.u
pb).where.str.is.a.vector.local.to#0A..............
..writef.to.hold.the.message.string#2E.This.is.prov
ided.to.easy#0A................the.generation.of.me
ssages.in.different.languages#2E#0A#0A........3#2E.
%+...-.The.argument.pointer.is.incremented.by.1#2E#0A
#0A........4#2E.%-...-.The.argument.pointer.is.decr
emented.by.1#2E#0A#0A........5#2E.%P...-.Plural.for
mation#2E.The.singular.form.is.use.if.and.only.if#0A
................the.next.argument.is.one#2E.So.that
.the.argument.can.be.used#0A................twice.i
t.is.normal.to.preceed.or.follow.the.%P.item.with.%
-#2E#0A................There.are.two.forms.as.follo
ws:#0A#0A................a#2E.%Pc..-.The.character.
c.is.output.if.the.the.next.argument#0A............
............not.one#2E#0A#0A................b#2E.%P
\singular\plural\..-.The.appropriate.text.is.printe
d,#0A........................skipping.the.other#2E.
The.'\'.chars.are.not.printed#2E#0A#0AExample:.FOR.
count.#3D.0.TO.2.DO#0A............writef("There.%p\
.is\are\.%-%n.thing%-%ps#2E*n",.count)#0Aoutputs:#0A
.........There.are.0.things#2E#0A.........There.is.
.1.thing#2E#0A.........There.are.2.things#2E#0A#0A.
.......6#2E.%nOp..eg.%12I.as.an.alternative.to.%IB#0A
.................where.n.is.a.decimal.number.and.Op
.is.a.format.letter#0A.................expecting.a.
field.width#2E.If.n.is.given.it.specifies.the#0A...
..............field.width.otherwise.it.is.specified
,.as.before,.by.the#0A.................single.chara
cter.(0-9,.A-Z).following.Op#2E#0A#0A........7#2E.%
n#2Emd..eg.%8#2E2d#0A..................print.a.fixe
d.point.scaled.decimal.number.in.a.field#0A........
..........width.of.n.with.m.digits.after.the.decima
l.point#2E.For#0A..................example.writef("
%8#2E2d",.1234567).would.output:.12345#2E67#0A.....
.............and.....writef("%8#2E0d",.1234567).wou
ld.output:..1234567#0A#0A........8#2E.%#23.....Writ
e.the.next.argument.using.codewrch,.ie.convert.the#0A
..................next.argument.to.UTF-8.format#2E#0A
*/#0A#0A//.The.following.version.of.writef.is.new.-
-.MR.21/1/04#0A#0A//.get_textblib.and.get_text.have
.the.same.global.variable.number#0AAND.get_textblib
(n,.str,.upb).#3D.VALOF..//.Default.definition.of.g
et_text#0A.......................................//
.This.is.normally.overridden.#0A...................
....................//.by.get_text,.defined.elsewhe
re#2E#0A{.LET.s.#3D."<mess:%-%n>"#0A..IF.upb>s%0.DO
.upb.:#3D.s%0#0A..str%0.:#3D.upb#0A..FOR.i.#3D.1.TO
.upb.DO.str%i.:#3D.s%i#0A..RESULTIS.str#0A}#0A#0AAN
D.writef(format,a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r
,s,t,u,v,w,x,y,z).BE#0A{.LET.nextarg.#3D.@a#0A..wri
te_format(format,.@nextarg)#0A}#0A#0AAND.sawritef(f
ormat,a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w
,x,y,z).BE#0A{.LET.nextarg.#3D.@a#0A..LET.wch,.rch.
#3D.wrch,.rdch#0A..wrch,.rdch.:#3D.sawrch,.sardch#0A
..write_format(format,.@nextarg)#0A..wrch,.rdch.:#3D
.wch,.rch#0A}#0A#0AAND.write_format(format,.lvnexta
rg).BE#0A{.//.writef.and.sawritef.must.preserve.res
ult2#0A..LET.res2.#3D.result2#0A#0A..//UNLESS.0.<.f
ormat.<.rootnode!rtn_memsize.DO.format.:#3D."#23#23
Bad.format#23#23"#0A#0A..FOR.p.#3D.1.TO.format%0.DO
#0A..{.LET.k,.type,.f,.n,.m,.arg.#3D.format%p,.?,.?
,.?,.?,.?#0A....LET.widthgiven.#3D.FALSE#0A....UNLE
SS.k#3D'%'.DO.{.wrch(k);.LOOP.}#0A#0A....//.Deal.wi
th.a.substitution.item#0A....p.:#3D.p.+.1#0A....typ
e,.arg,.n,.m.:#3D.format%p,.!!lvnextarg,.0,.0#0A#0A
sw:.SWITCHON.capitalch(type).INTO#0A....{.DEFAULT:.
...wrch(type)#0A..................LOOP#0A#0A......C
ASE.'0':CASE.'1':CASE.'2':CASE.'3':CASE.'4':#0A....
..CASE.'5':CASE.'6':CASE.'7':CASE.'8':CASE.'9':#0A.
.................{.n.:#3D.10*n.+.type.-.'0'#0A.....
...............p.:#3D.p+1#0A....................typ
e.:#3D.format%p#0A....................widthgiven.:#3D
.TRUE#0A..................}.REPEATWHILE.'0'<#3Dtype
<#3D'9'#0A..................IF.type#3D'#2E'.DO#0A..
................{.p.:#3D.p+1#0A....................
type.:#3D.format%p#0A....................WHILE.'0'<
#3Dtype<#3D'9'.DO#0A....................{.m.:#3D.10
*m.+.type.-.'0'#0A......................p.:#3D.p+1#0A
......................type.:#3D.format%p#0A........
............}#0A..................}#0A.............
.....GOTO.sw#0A#0A......CASE.'D':...IF.m.DO#0A.....
.............{.//.Write.a.number.of.the.form.nnn#2E
nn#0A....................LET.scale.#3D.1#0A........
............FOR.i.#3D.1.TO.m.DO.scale.:#3D.scale.*.
10#0A....................writed(arg/scale,.n-1-m)#0A
....................wrch('#2E')#0A.................
...writez(.ABS.arg.REM.scale,.m)#0A................
....!lvnextarg.:#3D.!lvnextarg.+.1#0A..............
......LOOP#0A..................}#0A................
..f.:#3D.writed;....GOTO.getarg#0A#0A#0A......CASE.
'S':...f.:#3D.writes;....GOTO.noargs#0A......CASE.'
T':...f.:#3D.writet;....GOTO.getarg#0A......CASE.'C
':...f.:#3D.wrch;......GOTO.noargs#0A......CASE.'#23
':...f.:#3D.codewrch;...GOTO.noargs#0A......CASE.'O
':...f.:#3D.writeoct;..GOTO.getarg#0A......CASE.'X'
:...f.:#3D.writehex;..GOTO.getarg#0A......CASE.'I':
...f.:#3D.writed;....GOTO.getarg#0A......CASE.'N':.
..f.:#3D.writen;....GOTO.noargs#0A......CASE.'U':..
.f.:#3D.writeu;....GOTO.getarg#0A......CASE.'Z':...
f.:#3D.writez;....GOTO.getarg#0A......CASE.'B':...f
.:#3D.writebin;..GOTO.getarg#0A#0A....getarg:......
.UNLESS.widthgiven.DO#0A..................{.p.:#3D.
p.+.1#0A....................n.:#3D.capitalch(format
%p)#0A....................n.:#3D.'0'.<#3D.n.<#3D.'9
'.->.n.-.'0',.10.+.n.-.'A'#0A..................}#0A
#0A....noargs:.......f(arg,.n)#0A..................
!lvnextarg.:#3D.!lvnextarg.+.1#0A..................
LOOP#0A#0A......CASE.'$':#0A......CASE.'+':...!lvne
xtarg.:#3D.!lvnextarg.+.1#0A..................LOOP#0A
#0A......CASE.'-':...!lvnextarg.:#3D.!lvnextarg.-.1
#0A..................LOOP#0A#0A......CASE.'M':.{.LE
T.buf.#3D.VEC.256/bytesperword#0A..................
!lvnextarg.:#3D.!lvnextarg.+.1#0A..................
UNLESS.get_text(arg,.buf,.256/bytesperword).DO#0A..
..................buf.:#3D."<<mess:%-%n>>"..//.No.m
essage.text#0A..................write_format(buf,.l
vnextarg)#0A..................LOOP#0A..............
..}#0A#0A......CASE.'F':...!lvnextarg.:#3D.!lvnexta
rg.+.1#0A..................write_format(arg,.lvnext
arg)#0A..................LOOP#0A#0A......CASE.'P':.
{.LET.plural.#3D.arg.~#3D.1#0A..................!lv
nextarg.:#3D.!lvnextarg.+.1#0A..................p.:
#3D.p+1#0A..................type.:#3D.format%p#0A..
................IF.type.#3D.'\'.DO#0A..............
....{.//.Deal.with.%P\singular\plural\.item#0A.....
...............LET.skipping.#3D.plural#0A..........
..........p.:#3D.p.+.1#0A....................UNTIL.
p.>.format%0.DO#0A....................{.LET.ch.#3D.
format%p#0A......................TEST.ch.#3D.'\'.TH
EN.{.skipping.:#3D.~skipping#0A....................
.......................IF.skipping.#3D.plural.BREAK
#0A.........................................}#0A...
.................................ELSE.UNLESS.skippi
ng.DO.wrch(ch)#0A......................p.:#3D.p.+.1
#0A....................}#0A....................LOOP
#0A..................}#0A#0A..................//.De
al.with.simple.%Pc.items#0A..................IF.plu
ral.DO.wrch(type)#0A..................LOOP#0A......
..........}#0A....}.//.End.of.SWITCHON.#2E#2E#2E#0A
..}.//.End.of.FOR.p.#3D.#2E#2E#2E#0A#0A..result2.:#3D
.res2#0A}#0A#0ALET.randno(upb).#3D.VALOF..//.return
.a.random.number.in.the.range.1.to.upb#0A{.randseed
.:#3D.randseed*2147001325.+.715136305#0A..RESULTIS.
(ABS(randseed/3)).REM.upb.+.1#0A}#0A#0AAND.setseed(
newseed).#3D.VALOF.//.Added.by.MR.20/01/2000#0A{.LE
T.oldseed.#3D.randseed#0A..randseed.:#3D.newseed#0A
..RESULTIS.oldseed#0A}#0A#0A//.muldiv.is.now.implem
ented.in.SYSLIB.using.the.MDIV.instruction#0A//.NO.
--.MDIV.sometimes.causes.a.floating.point.exception
#0AAND.muldiv(a,.b,.c).#3D.sys(Sys_muldiv,.a,.b,.c)
#0A#0AAND.unpackstring(s,.v).BE.FOR.i.#3D.s%0.TO.0.
BY.-1.DO.v!i.:#3D.s%i#0A#0AAND.packstring(v,.s).#3D
.VALOF#0A{.LET.n.#3D.v!0.&.255#0A..LET.size.#3D.n/b
ytesperword#0A..FOR.i.#3D.0.TO.n.DO.s%i.:#3D.v!i#0A
..FOR.i.#3D.n+1.TO.(size+1)*bytesperword-1.DO.s%i.:
#3D.0#0A..RESULTIS.size#0A}#0A#0AAND.capitalch(ch).
#3D.'a'.<#3D.ch.<#3D.'z'.->.ch.+.'A'.-.'a',.ch#0A#0A
AND.compch(ch1,.ch2).#3D.capitalch(ch1).-.capitalch
(ch2)#0A#0AAND.compstring(s1,.s2).#3D.VALOF#0A{.LET
.lens1,.lens2.#3D.s1%0,.s2%0#0A..LET.smaller.#3D.le
ns1.<.lens2.->.s1,.s2#0A..FOR.i.#3D.1.TO.smaller%0.
DO#0A..{.LET.res.#3D.compch(s1%i,.s2%i)#0A....IF.re
s.RESULTIS.res#0A..}#0A..IF.lens1.#3D.lens2.RESULTI
S.0#0A..RESULTIS.smaller.#3D.s1.->.-1,.1#0A}#0A#0AA
ND.str2numb(s).#3D.VALOF.//.Deprecated#0A{.LET.a.#3D
.0#0A..FOR.i.#3D.1.TO.s%0.DO.{.LET.dig.#3D.s%i.-.'0
'#0A........................IF.0<#3Ddig<#3D9.DO.a.:
#3D.10*a.+.dig#0A......................}#0A..RESULT
IS.s%1#3D'-'.->.-a,.a#0A}#0A#0AAND.getkey(keys,.i,.
keyword).#3D.VALOF#0A{.LET.len.#3D.keys%0#0A..LET.n
.#3D.0#0A..LET.p.#3D.1#0A#0A..UNTIL.p>len.DO#0A..{.
UNLESS.i.BREAK#0A....IF.keys%p#3D','.DO.i.:#3D.i-1#0A
....p.:#3D.p+1#0A..}#0A#0A..WHILE.p.<#3D.len.DO#0A.
.{.LET.ch.#3D.keys%p#0A....IF.ch#3D'/'.|.ch#3D'#3D'
.|.ch#3D','.BREAK#0A....n.:#3D.n.+.1#0A....keyword%
n.:#3D.keys%p#0A....p.:#3D.p.+.1#0A..}#0A#0A..keywo
rd%0.:#3D.n#0A..RESULTIS.keyword#0A}#0A#0A/*.rdargs
.provides.the.programmer.with.the.facility.to.read#0A
...arguments.from.the.currently.selected.input.and.
store.them.in.a#0A...vector.as.shown.below:#0A#0A..
........................|----------|#0A............
..............|address1..|#0A......................
....|__________|#0A..........................|.TRUE
.....|<-.logic.switch.value#0A.....................
.....|__________|.#0A..........................|add
ress2..|#0A..........................|----------|#0A
..........................|item1.....|#0A..........
................|__________|#0A....................
......|item2.....|#0A..........................|___
_______|#0A#0AThe.possible.key.qualifiers.are:#0A#0A
../k...keyed....--.argument.requires.the.keyword#0A
../p...prompted.--.prompt.will.be.displayed..(This.
option.may.be.scrapped)#0A../a...required.--.if.thi
s.argument.is.not.entered.an.error.will.follow#0A..
/n...numeric..--.argument.has.to.be.a.number#0A../s
...switch...--.exact.switch.word.has.to.be.entered.
for.TRUE#0A*/..#0A#0AAND.rdargs(keys,.argv,.size).#3D
.VALOF#0A{.MANIFEST#0A..{.required....#3D.1........
..........//..1.../A#0A....keyed.......#3D.1.<<.1..
...........//..2.../K#0A....switch......#3D.1.<<.2.
............//..4.../S#0A....prompt......#3D.1.<<.3
.............//..8.../P#0A....number......#3D.1.<<.
4.............//.16.../N#0A....control.....#3D.(num
ber.<<.1).-.1..//.31...All.the.flags#0A..}#0A#0A..L
ET.w........#3D.argv.//.w.is.a.moving.positional.po
inter.of.the.argv.vector#0A..LET.numbargs.#3D.?#0A.
.LET.status...#3D.TRUE...//.Set.to.FALSE.when.an.er
ror.is.encountered#0A..LET.keyword..#3D.VEC.30#0A#0A
..!w.:#3D.0#0A#0A////////////////.A.BIT.MAP.REPRESE
NTING.THE.KEY.QUALIFIERS.IS.///////////////#0A/////
//////////..PUT.INTO.THE.TOP.LOCATIONS.OF.THE.VECTO
R.....///////////////.#0A#0A..//.A.typical.key.stri
ng.is:."FROM#3DDATA/A,TO/K,VAL/K/N,T#3DTRACE/S"#0A.
.FOR.p.#3D.1.TO.keys%0.DO#0A..{.LET.kch.#3D.keys%p#0A
#0A....IF.kch.#3D.'/'.DO#0A....{.LET.c.#3D.capitalc
h(keys%(p+1))#0A......IF.c.#3D.'A'.DO.!w.:#3D.!w.|.
required#0A......IF.c.#3D.'K'.DO.!w.:#3D.!w.|.keyed
#0A......IF.c.#3D.'S'.DO.!w.:#3D.!w.|.switch#0A....
..IF.c.#3D.'P'.DO.!w.:#3D.!w.|.prompt#0A......IF.c.
#3D.'N'.DO.!w.:#3D.!w.|.number#0A....}#0A#0A....IF.
kch.#3D.','.DO#0A....{.w.:#3D.w.+.1#0A......!w.:#3D
.0#0A....}#0A..}#0A#0A..w.:#3D.w.+.1#0A..numbargs.:
#3D.w.-.argv..//.as.deduced.from.the.keys.string#0A
#0A#0A/////////////////////////////////////////////
///////////////////////////#0A/////////////////////
///.BEGINNING.OF.REPEAT.LOOP.//////////////////////
#0A////////////////////////////////////////////////
////////////////////////#0A#0A..{.LET.argno.#3D.-1#0A
....LET.wsize.#3D.size.-.(w.-.argv).//.Number.of.wo
rds.remaining.in.argv#0A....LET.itemtype.#3D.rditem
(w,.wsize)#0A//sawritef("BLIB:.rdargs..itemtype#3D%
n*n",.itemtype)#0A....clear_words(keyword,.31)#0A#0A
....SWITCHON.itemtype.INTO#0A....{.DEFAULT:.//.Unkn
own.item.type#0Aerr:#0A.............{.LET.ch.#3D.?#0A
//sawritef("BLIB:.rdargs.error.--.skipping.to.end.o
f.line*n")#0A...............unrdch()...//.MR.14/7/0
3#0A...............ch.:#3D.rdch().REPEATUNTIL.ch#3D
'*n'.|#0A........................................ch
#3D';'..|#0A.......................................
.ch#3Dendstreamch#0A#0A...............result2.:#3D.
120..//.Fault:.Argument.line.#0A...................
............//.invalid.or.too.long#0A..............
.RESULTIS.0......//.Error.result#0A.............}#0A
#0A......CASE.0:..//.endstreamch#0A......CASE.3:../
/.newline#0A......CASE.4:..//.semicolon#0A//.These.
item.types.mark.the.end.of.the.argument.list#2E#0A#0A
//.Now.check.for.prompted.arguments#2E#0A#0A.......
........FOR.i.#3D.0.TO.numbargs.-1.IF.0<#3Dargv!i<#3D
control.DO#0A...............{.//.Unset.argument.fou
nd#0A.................LET.a.#3D.argv!i#0A#0A.......
..........IF.status.&.((a.&.prompt).~#3D.0).DO#0A..
...............{.//.if.ok.so.far.&.prompted#0A.....
..............IF.cis!scb_type.#3D.scbt_console.&#0A
......................cos!scb_type.#3D.scbt_console
.DO#0A...................{.writes(getkey(keys,.i,.k
eyword))#0A.....................UNLESS.(a.&.switch)
.#3D.0.DO.writes(".(yes/no)")#0A...................
..writes(".>.").//.write.prompt#0A.................
....deplete(cos).//.MR.13/1/03#0A#0A...............
......itemtype.:#3D.rditem(w,.wsize)#0A............
.........SWITCHON.itemtype.INTO#0A.................
....{.CASE.1:.//.Unquoted.item#0A..................
.....CASE.2:.//.Quoted.item#0A//writef("*nvalue#3D%
s*n",.w)#0A...............................IF.(a.&.s
witch).~#3D.0.DO#0A...............................{
.IF.compstring(w,."yes").#3D.0.DO#0A...............
..................{.argv!i.:#3D.TRUE#0A............
.......................LOOP.//.Find.next.uset.argum
ent#0A.................................}#0A........
.........................IF.compstring(w,."no").#3D
.0.DO#0A.................................{.argv!i.:
#3D.FALSE#0A...................................LOOP
.//.Find.next.uset.argument#0A.....................
............}#0A...............................}#0A
#0A...............................IF.(a.&.number).~
#3D.0.DO#0A...............................{.argv!i.
:#3D.w...//.numeric#0A.............................
....IF.string_to_number(w).DO#0A...................
..............{.!w.:#3D.result2#0A.................
..................w..:#3D.w.+.1#0A.................
..................LOOP.//.Find.next.uset.argument#0A
.................................}#0A..............
...................status.:#3D.FALSE#0A............
.....................argv!i.:#3D.0#0A..............
...................LOOP.//.Find.next.uset.argument#0A
...............................}#0A#0A.............
..................//.Non.switch.non.numeric.argumen
t#0A//writef("*nargv!%n.#3D.%s..non.switch/num*n",.
i,.w)#0A...............................argv!i.:#3D.
w#0A...............................w.:#3D.w.+.w%0/b
ytesperword.+.1#0A...............................ws
ize.:#3D.size.-.(w.-.argv).....#0A.................
..............LOOP.//.Find.next.unset.argument#0A#0A
.......................CASE.0:#0A..................
.....CASE.3:#0A.......................CASE.4:#0Awri
tef("BLIB:.rdargs:.case.0,.3.or.4.reached*n")#0A...
............................ENDCASE#0A#0A..........
.............DEFAULT:#0A...........................
....status.:#3D.FALSE#0A...........................
....LOOP#0A.....................}#0A...............
....}#0A.................}#0A......................
......#0A.................TEST.(a.&.required).#3D.0
..//.final.check.for.required#0A.................TH
EN.argv!i.:#3D.0.........//.argument.-.clear.memory
#0A.................ELSE.status.:#3D.FALSE.....//.i
f.no.input.made.and.not.#0A........................
..................//.required#0A...............}.//
.End.of.for-loop#0A#0A...............UNLESS.status.
GOTO.err#0A...............result2.:#3D.0#0A........
.......FOR.i.#3D.0.TO.numbargs-1.IF.argv!i.DO.resul
t2.:#3D.result2.+.1#0A...............//.result2.#3D
.number.of.args.given#0A//...............writef("*n
itemtype#3D%n.calling.rdch().#3D>.'%c'*n",.itemtype
,.rdch())#0A//...............writef("*nreturning.rd
ch().#3D>.'%c'*n",.rdch())#0A...............RESULTI
S.w#0A#0A.....CASE.1:...//.Ordinary.item#0A........
.......//.notice.that.the.CASE.1.and.CASE.2.section
s.will#0A...............//.both.be.executed.consecu
tively.for.any.input.other.#0A...............//.the
n.items.in.quotes#0A#0A...............argno.:#3D.fi
ndarg(keys,.w)#0A//writef("Ordinary.item.%s..argno#3D
%n*n",.w,.argno)#0A#0A...............TEST.argno.>#3D
.0#0A...............THEN.{.UNLESS.0.<#3D.argv!argno
.<#3D.control.GOTO.err#0A#0A......................I
F.(argv!argno.&.switch).~#3D.0.DO#0A...............
.......{.argv!argno.:#3D.-1#0A.....................
...LOOP#0A......................}#0A#0A............
..........{.LET.item.#3D.rditem(w,.wsize)#0A#0A....
....................IF.item.#3D.5.DO.item.:#3D.rdit
em(w,.wsize).//.Skip.'#3D'#0A#0A...................
.....IF.item.<#3D.0.|.item#3D3.|.item#3D4.|.item#3D
5.GOTO.err#0A......................}#0A............
........}#0A#0A...............ELSE.TEST.rdch().#3D.
'*n'.&.compstring("?",.w).#3D.0#0A.................
...THEN.{.writef("%s:.",.keys)#0A..................
.........deplete(cos).//.MR.13/1/03#0A.............
..............ENDCASE#0A.........................}#0A
....................ELSE.unrdch()#0A#0A//.Deliberat
e.missing.'ENDCASE'#0A#0A............CASE.2:.//.ite
m.was.not.a.keyword.or.was.put.in.quotes#0A........
........IF.argno.<.0.DO......//.find.first.non-keye
d,.non-switch#0A..................FOR.i.#3D.0.TO.nu
mbargs.-.1.DO#0A....................IF.0.<#3D.argv!
i.<#3D.control.&#0A.......................(argv!i.&
.switch).#3D.0..&#0A.......................(argv!i.
&.keyed)..#3D.0..DO.#0A....................{.argno.
:#3D.i#0A......................BREAK#0A............
........}#0A#0A//.The.FOR-loop.below.the.CASE.2.end
s.here#0A#0A................UNLESS.argno.>#3D.0.DO#0A
................{.//.keyword.is.not.recognized#0A..
................GOTO.err.....//.MR.27/3/03#0A......
............status.:#3D.FALSE#0A..................L
OOP#0A................}#0A#0A................UNLESS
.0.<#3D.argv!argno.<#3D.control.GOTO.err#0A#0A//.Th
is.part.of.the.module.is.always.executed.if.the.ent
ered.argument.was#0A//.found.to.be.valid;.an.addres
s.from.vector.is.stored.in.the.top.half#0A//.of.the
.vector.argv#0A#0A................{.LET.a.#3D.argv!
argno#0A#0A..................IF.(a.&.number).~#3D.0
.DO#0A..................{.IF.string_to_number(w).DO
.//.check.if.the#0A....................{.argv!argno
.:#3D.w#0A......................!w.:#3D.result2....
.......//.expected.numeric.input#0A................
......w..:#3D.w.+.1.............//.can.be.string.co
nverted#0A......................LOOP#0A............
........}#0A#0A....................//.Number.cannot
.be.converted#0A....................status.:#3D.FAL
SE#0A....................argv!argno.:#3D.0#0A......
..............LOOP#0A..................}#0A#0A.....
.............//.Store.ordinary.argument.value#0A...
...............argv!argno.:#3D.w#0A................
..w.:#3D.w.+.w%0/bytesperword.+.1#0A...............
...LOOP#0A................}#0A....}.//.End.of.main.
switch#0A..}.REPEAT#0A}#0A#0A//.Read.an.item.from.c
urrent.input.stream#0A#0A//.returns.-1....error,.in
put.too.long.or.unmatched.quote#0A//..........0....
endstreamch............***.MR.change.11/12/92#0A//.
.........1....unquoted.item#0A//..........2....quot
ed.item#0A//..........3....*n.....................*
**.MR.change.11/12/92#0A//..........4....;.........
.............***.MR.change.11/12/92#0A//..........5
....#3D......................***.MR.change.12/07/03
#0A#0A//.When.an.unquoted.item.is.read.its.terminat
ing.character.is#0A//.unrdch-ed.so.that.it.can.be.r
ead.again.by.the.next.call.of.rdch#2E#0A//.All.item
s.other.items,.namely.strings,.newline,.';',.'#3D'.
and#0A//.endstreamch,.are.self.terminating.and.so.d
o.not.need.unrdch#0A//.to.be.called#2E#0A#0AAND.rdi
tem(v,.upb).#3D.VALOF#0A{.LET.p,.pmax.#3D.0,.(upb+1
)*bytesperword-1#0A..//.With.bytesperword#3D4#0A../
/.upb#3D0.#3D>.pmax#3D3#0A..//.upb#3D1.#3D>.pmax#3D
7#0A..//.#2E#2E#2E#0A..LET.ch,.quoted.#3D.rdch(),.F
ALSE#0A#0A..FOR.i.#3D.0.TO.upb.DO.v!i.:#3D.0#0A#0A/
/sawritef("*nrditem.first.ch.#3D.'%c'*n",.ch)#0A#0A
..//.Skip.over.white.space#2E#0A..WHILE.ch#3D'*s'.|
.ch#3D'*t'.|.ch#3D'*c'DO.ch.:#3D.rdch().#0A#0A..IF.
ch#3Dendstreamch.RESULTIS..0...//.EOF#0A..IF.ch#3D'
*n'........RESULTIS..3...//.'*n'#0A..IF.ch#3D';'...
......RESULTIS..4...//.';'#0A..IF.ch#3D'#3D'.......
..RESULTIS..5...//.'#3D'#0A#0A..IF.ch#3D'"'.DO.{.ch
.:#3D..rdch()#0A.................IF.ch#3D'*c'.LOOP#0A
.................IF.ch#3D'*n'.|.ch#3Dendstreamch.RE
SULTIS.-1.//.Error#0A.................IF.ch#3D'"'.R
ESULTIS.2.//.Found.a.quoted.string#2E#0A...........
......IF.ch#3D'**'.DO.{.ch.:#3D.rdch()#0A..........
.......................IF.capitalch(ch)#3D'N'..DO.c
h.:#3D.'*n'#0A.................................IF.c
apitalch(ch)#3D'*"'.DO.ch.:#3D.'*"'.//.MR.8/1/03#0A
...............................}#0A................
.p.:#3D.p+1#0A.................IF.p>pmax.RESULTIS.-
1.//.Error#0A.................v%0,.v%p.:#3D.p,.ch#0A
...............}.REPEAT#0A#0A..//.Copy.chars.of.an.
unquoted.item.into.v#0A..UNTIL.ch#3D'*n'.|.ch#3D'*s
'.|.ch#3D'*t'.|.ch#3D';'.|.ch#3D'#3D'.|.ch#3Dendstr
eamch.DO#0A..{.p.:#3D.p+1#0A....IF.p>pmax.RESULTIS.
-1..............//.Error#0A....v%0,.v%p.:#3D.p,.ch#0A
....ch.:#3D.rdch().REPEATWHILE.ch#3D'*c'#0A..}#0A..
//.Unrdch.its.terminating.character#0A#0A//sawritef
("rditem.returning.type.1.%s,.ch#3D%x2.'%c'*n",.v,.
ch,.ch)#0A..UNLESS.ch#3Dendstreamch.DO.unrdch()#0A.
.RESULTIS.1............................//.Unquoted.
item#0A}#0A#0AAND.findarg(keys,.w).#3D.VALOF#0A{.MA
NIFEST.{.matching.#3D.0;.skipping.#3D.1.}#0A..LET.s
tate,.wp,.argno.#3D.matching,.0,.0#0A..FOR.i.#3D.1.
TO.keys%0.DO#0A..{.LET.kch#3Dkeys%i#0A....IF.state#3D
matching.DO#0A....{.IF.(kch#3D'#3D'.|.kch#3D'/'.|.k
ch#3D',').&.wp#3Dw%0.DO#0A........RESULTIS.argno#0A
......wp.:#3D.wp.+.1#0A......UNLESS.compch(kch,.w%w
p).#3D.0.DO.state.:#3D.skipping#0A....}#0A....IF.kc
h#3D','.|.kch#3D'#3D'.DO.state,.wp.:#3D.matching,.0
#0A....IF.kch.#3D.','.DO.argno.:#3D.argno.+.1#0A..}
#0A..IF.state.#3D.matching.&.wp.#3D.w%0.RESULTIS.ar
gno#0A..RESULTIS.-1#0A}#0A#0AAND.createco(fn,.size)
.#3D.VALOF#0A{.LET.c.#3D.getvec(size+6)#0A..UNLESS.
c.RESULTIS.0#0A..FOR.i.#3D.6.TO.size+6.DO.c!i.:#3D.
stackword#0A#0A..//.Using.P.to.denote.the.current.s
tack.frame#0A..//.pointer,.the.following.assumption
s.are.made:#0A..//..P!0,.P!1,.P!2.contain.the.retur
n.link.information#0A..//..P!3...is.the.variable.fn
#0A..//..P!4...is.the.variable.size#0A..//..P!5...i
s.the.variable.c#0A#0A..//.Now.make.the.vector.c.in
to.a.valid.BCPL#0A..//.stack.frame.containg.copies.
of.fn,.size#0A..//.and.c.in.the.same.relative.posit
ions#2E#0A..//.Other.locations.in.the.new.stack.fra
me.#0A..//.are.used.for.other.purposes#2E#0A..c!0.:
#3D.c<<B2Wsh.//.resumption.point#0A..c!1.:#3D.currc
o...//.parent.link#0A..c!2.:#3D.colist...//.colist.
chain#0A..c!3.:#3D.fn.......//.the.main.function#0A
..c!4.:#3D.size.....//.the.coroutine.size#0A..c!5.:
#3D.c........//.the.new.coroutine.pointer#0A#0A..co
list.:#3D.c..//.insert.into.the.list.of.coroutines#0A
#0A..changeco(0,.c)#0A#0A..//.Execution.now.continu
es.with.the.P.pointer.set.to.c<<B2Wsh,#0A..//.and.s
o..the.vector.c.becomes.the.current.stack.frame#2E#0A
..//.The.compiler.will.have.generated.code.on#0A../
/.the.assumption.that.fn.and.c.are.the.third.and.fi
fth#0A..//.words.of.the.stack.frame,.and,.since.c!3
.and.c!5#0A..//.were.initialised.to.fn.and.c,.the.f
ollowing.repeated#0A..//.statement.will.have.the.ef
fect.(naively).expected#2E#0A..//.Note.that.the.fir
st.call.of.cowait.causes.a.return#0A..//.from.creat
eco.with.result.c#2E#0A#0A..c.:#3D.fn(cowait(c)).RE
PEAT#0A}#0A#0AAND.deleteco(cptr).#3D.VALOF#0A{.LET.
a.#3D.@colist#0A#0A..{.LET.co.#3D.!a#0A....UNLESS.c
o.DO#0A....{.sawritef("BLIB.co#3D%n:.cannot.deletec
o.%n.--.not.found*n",#0A.........currco,.cptr)#0A..
....abort(112)#0A......RESULTIS.FALSE#0A....}#0A...
.IF.co#3Dcptr.BREAK#0A....a.:#3D.@.co!co_list#0A..}
.REPEAT#0A#0A..IF.cptr!co_parent.DO#0A..{.sawritef(
"BLIB.co#3D%n:.cannot.deleteco.%n.--.has.a.parent*n
",#0A.......currco,.cptr)#0A....abort(112)#0A....RE
SULTIS.FALSE#0A..}#0A#0A..!a.:#3D.cptr!co_list.....
.//.Remove.the.coroutine.from.colist#2E#0A..freevec
(cptr)...........//.Free.the.coroutine.stack#2E#0A.
.RESULTIS.TRUE#0A}#0A#0AAND.callco(cptr,.a).#3D.VAL
OF#0A{.IF.cptr!co_parent.DO.abort(110)#0A..cptr!co_
parent.:#3D.currco#0A..RESULTIS.changeco(a,.cptr)#0A
}#0A#0AAND.resumeco(cptr,.a).#3D.VALOF#0A{.LET.pare
nt.#3D.currco!co_parent#0A..currco!co_parent.:#3D.0
#0A..IF.cptr!co_parent.DO.abort(111)#0A..cptr!co_pa
rent.:#3D.parent#0A..RESULTIS.changeco(a,.cptr)#0A}
#0A#0AAND.cowait(a).#3D.VALOF#0A{.LET.parent.#3D.cu
rrco!co_parent#0A..currco!co_parent.:#3D.0#0A..RESU
LTIS.changeco(a,.parent)#0A}#0A#0AAND.initco(fn,.si
ze,.a,.b,.c,.d,.e,.f,.g,.h,.i,.j,.k).#3D.VALOF#0A{.
LET.cptr.#3D.createco(fn,.size)#0A..IF.cptr.DO.call
co(cptr,.@a)#0A..RESULTIS.cptr#0A}#0A#0A/*......res
.:#3D.startco(body,.arg,.stsize)#0A#0A........The.r
outine.'body'.is.created.as.a.coroutine.with.a.stac
ksize.'stsize'#0A........and.'arg'.passed.as.an.arg
ument#2E..The.result.is.the.stackbase.of#0A........
the.coroutine#2E#0A*/#0A#0AAND.startco(body,.arg,.s
tsize).#3D.VALOF#0A{.LET.newco.#3D.createco(body,.s
tsize)#0A//sawritef("BLIB:.callco(%n,%n)*n",.newco,
.arg)#0A...IF.newco.DO.callco(newco,.arg)#0A...RESU
LTIS.newco#0A}#0A#0A//.object.making.function#0AAND
.mkobj(upb,.fns,.a,.b,.c,.d,.e,.f,.g,.h,.i,.j,.k).#3D
.VALOF#0A{.LET.obj.#3D.getvec(upb)#0A..UNLESS.obj#3D
0.DO#0A..{.!obj.:#3D.fns#0A....InitObj#23(obj,.@a).
//.Send.the.InitObj.message.to.the.object#0A..}#0A.
.RESULTIS.obj#0A}#0A#0AAND.instrcount(fn,.a,b,c,d,e
,f,g,h,i,j,k).#3D.VALOF#0A{.LET.res.#3D.0#0A..LET.c
ount.#3D.sys(Sys_setcount,.maxint)..//.Set.count.re
gister.to.maxint#0A..result2.:#3D.fn(a,b,c,d,e,f,g,
h,i,j,k)#0A..res.:#3D.sys(Sys_setcount,.count).....
...//.Restore.previous.value#0A....................
...........//.returning.the.modified.count#0A..RESU
LTIS.maxint.-.res.-.32...//.Correct.for.overhead#0A
}#0A#0AAND.datstring(v).#3D.VALOF#0A{.LET.datv.#3D.
VEC.2#0A..datstamp(datv)#0A..dat_to_strings(datv,.v
)#0A..RESULTIS.v#0A}#0A#0AAND.dat_to_strings(datv,.
v).#3D.VALOF#0A#0A//.Returns.v.containing.3.strings
.representing.the#0A//.time.and.date.given.in.datv,
.where#0A//.datv!0.#3D.days,.datv!1.#3D.mins,.datv!
2.#3D.ticks#2E#0A//.On.return,.v.contains.a.the.dat
e.in.the.form#0A//.DD-MMM-YY,.v+5.contains.the.time
.in.the.format#0A//.HH:MM:SS,.and.V+10.contains.the
.day.of.the.week#2E#0A//.Vector.v.should.have.an.up
perbound.of.14#0A//.If.the.date.is.unset.(days.#3D.
0).then.the.strings#0A//.are.all.set.to."<unset>"#0A
#0A{.LET.days,..mins,..ticks.#3D.datv!0,.datv!1,.da
tv!2#0A..LET.datestr,.timestr,.dowstr.#3D.v,.v+5,.v
+10#0A..LET.dayofweek.#3D.days.REM.7#0A..LET.dowtem
p.#3D.?#0A..LET.year.#3D.1978.//.Cintpos.base.year#0A
..LET.month.#3D.1#0A..LET.hours,.secs.#3D.?,.?#0A..
LET.monthtab.....#3D.TABLE...0,.31,.59,.90,120,151,
#0A...........................181,212,243,273,304,3
34,365#0A..LET.leapmonthtab.#3D.TABLE...0,.31,.60,.
91,121,152,#0A...........................182,213,24
4,274,305,335,366#0A..LET.mchars.#3D."JanFebMarAprM
ayJunJulAugSepOctNovDec"#0A..LET.mcharbase.#3D.?#0A
..LET.mtable.#3D.?#0A#0A//sawritef("BLIB:.dat_to_st
ring:.entered*n")#0A#0A..//.Deal.with.case.of.unset
.date#0A..IF.days.#3D.0.DO#0A..{.LET.unset.#3D."<un
set>"#0A....FOR.z.#3D.0.TO.unset%0.DO.#0A....{.LET.
c.#3D.unset%z#0A......datestr%z.:#3D.c#0A......time
str%z.:#3D.c#0A......dowstr%z..:#3D.c#0A....}#0A...
.RESULTIS.v#0A..}#0A#0A..days.:#3D.days.+.1#0A..FOR
.j#3D0.TO.9.DO.datestr%j.:#3D."DD-MMM-YY"%j#0A..FOR
.j#3D0.TO.8.DO.timestr%j.:#3D."HH:MM:SS"%j#0A#0A../
/.Construct.date#0A#0A..{.//.Loop.to.get.year#0A...
.LET.yearlen.#3D.isleap(year).->.366,.365#0A....IF.
0.<.days.<#3D.yearlen.BREAK#0A....days,.year.:#3D.d
ays.-.yearlen,.year.+.1#0A..}.REPEAT#0A#0A..datestr
%8.:#3D.year/10.REM.10.+.'0'#0A..datestr%9.:#3D.yea
r....REM.10.+.'0'#0A.#0A..//.Find.month#0A..mtable.
:#3D.isleap(year).->.leapmonthtab,.monthtab#0A#0A..
{.IF.days.<#3D.mtable.!.month.BREAK#0A....month.:#3D
.month.+.1#0A..}.REPEAT#0A#0A..mcharbase.:#3D.month
*3.-.2#0A..FOR.j#3D0.TO.2.DO.datestr%(4+j).:#3D.mch
ars.%.(mcharbase.+.j)#0A..days.:#3D.days.-.mtable.!
.(month.-.1)#0A..datestr%1.:#3D.days/10.+.'0'#0A..d
atestr%2.:#3D.days.REM.10.+.'0'#0A#0A..//.Construct
.time#0A#0A..hours.:#3D.mins/60#0A..mins.:#3D.mins.
REM.60#0A#0A..//.treat.ticks.as.unsigned.integers#0A
..secs.:#3D.(ticks>>1)./.(tickspersecond>>1)#0A#0A.
.timestr%1.:#3D.hours/10.+.'0'#0A..timestr%2.:#3D.h
ours.REM.10.+.'0'#0A..timestr%4.:#3D.mins/10.+.'0'#0A
..timestr%5.:#3D.mins.REM.10.+.'0'#0A..timestr%7.:#3D
.secs/10.REM.10.+.'0'#0A..timestr%8.:#3D.secs.REM.1
0.+.'0'#0A#0A..//.Get.day.of.week#0A....#0A..dowtem
p.:#3D.VALOF.SWITCHON.dayofweek.INTO#0A......{.CASE
.0:.RESULTIS."Sunday"#0A........CASE.1:.RESULTIS."M
onday"#0A........CASE.2:.RESULTIS."Tuesday"#0A.....
...CASE.3:.RESULTIS."Wednesday"#0A........CASE.4:.R
ESULTIS."Thursday"#0A........CASE.5:.RESULTIS."Frid
ay"#0A........CASE.6:.RESULTIS."Saturday"#0A......}
#0A#0A..FOR.j.#3D.0.TO.dowtemp%0.DO.dowstr%j.:#3D.d
owtemp%j#0A#0A..RESULTIS.v#0A}#0A#0AAND.isleap(year
).#3D.year.REM.400.#3D.0.->.TRUE,#0A...............
....year.REM.100.#3D.0.->.FALSE,#0A................
...year.REM...4.#3D.0.->.TRUE,#0A..................
.....................FALSE#0A#0AAND.testbit(bitno,.
bitvec).#3D.VALOF#0A//.This.function.returns.a.non.
zero.value.if.the.specified.bit.in#0A//.bitvec.is.a
.one,.otherwise.it.returns.zero#2E#0A//.Bits.are.nu
mbered.from.zero.starting.at.the.least.significant.
bit#0A//.of.bitvec!0#2E#0A//.bitvec!0.holds.bits.0.
to.bitsperword-1#0A//.bitvec!1.holds.bits.bitsperwo
rd.to.2*bitsperword-1#0A//.etc#0A{.LET.i.#3D.bitno.
./..bitsperword#0A..AND.s.#3D.bitno.REM.bitsperword
#0A..RESULTIS.bitvec!i.&.(1<<s)#0A}#0A#0AAND.setbit
(bitno,.bitvec,.state).#3D.VALOF#0A//.This.function
.sets.the.specified.bit.in.bitvec.to.1.or.0.dependi
ng#0A//.on.whether.state.is.TRUE.or.FALSE,.respecti
vely#2E.It.returns.a#0A//.non-zero.value.if.the.pre
vious.setting.of.the.bit.was.a.one,.otherwise#0A//.
it.returns.zero#2E.See.testbit.above#2E#0A{.LET.i.#3D
.bitno../..bitsperword#0A..AND.s.#3D.bitno.REM.bits
perword#0A..LET.mask.#3D.1.<<.s#0A..LET.oldstate.#3D
.bitvec!i.&.mask#0A..TEST.state.THEN.bitvec!i.:#3D.
bitvec!i.|..mask#0A.............ELSE.bitvec!i.:#3D.
bitvec!i.&.~mask#0A..RESULTIS.oldstate#0A}#0A#0AAND
.string_to_number(s).#3D.VALOF#0A//.Return.TRUE.if.
OK.with.value.in.result2#0A//........FALSE.and.resu
lt2#3D0.if.s.is.not.a.number#0A//.Example.strings:.
#0A//...'A'#0A//..123....-99....+63#0A//..#23377...
-#23x7FF.+#23b1011011.#0A{.LET.p,.len.#3D.1,.s%0#0A
..LET.neg,.radix.#3D.FALSE,.10#0A..LET.ch.#3D.?#0A#0A
..result2.:#3D.0#0A..UNLESS.len.RESULTIS.FALSE#0A..
ch.:#3D.capitalch(s%p)#0A..IF.ch.#3D.'*''.&.len.#3D
.3.&.s%3.#3D.'*''.DO#0A..{.result2.:#3D.s%2#0A....R
ESULTIS.TRUE#0A..}#0A#0A..IF.ch.#3D.'+'.|.ch.#3D.'-
'.DO#0A..{.neg.:#3D.ch.#3D.'-'#0A....IF.p.#3D.len.R
ESULTIS.TRUE#0A....p.:#3D.p.+.1#0A....ch.:#3D.capit
alch(s%p)#0A..}#0A..IF.ch.#3D.'#23'.DO#0A..{.radix.
:#3D.8#0A....IF.p.#3D.len.RESULTIS.TRUE#0A....p.:#3D
.p.+.1#0A....ch.:#3D.capitalch(s%p)#0A....IF.ch.#3D
.'O'.|.ch.#3D.'X'.|.ch.#3D.'B'.DO#0A....{.IF.ch.#3D
.'X'.DO.radix.:#3D.16#0A......IF.ch.#3D.'B'.DO.radi
x.:#3D.2#0A......IF.p.#3D.len.RESULTIS.TRUE#0A.....
.p.:#3D.p.+.1#0A......ch.:#3D.capitalch(s%p)#0A....
}#0A..}#0A..{.LET.n.#3D.'0'.<#3D.ch.<#3D.'9'.->.ch.
-.'0',#0A............'A'.<#3D.ch.<#3D.'Z'.->.ch.-.'
A'.+.10,.1000#0A....UNLESS.n.<.radix.RESULTIS.FALSE
#0A....result2.:#3D.result2.*.radix.+.n#0A....p.:#3D
.p.+.1#0A....IF.p.>.len.BREAK#0A....ch.:#3D.capital
ch(s%p)#0A..}.REPEAT#0A#0A..IF.neg.DO.result2.:#3D.
-result2#0A..RESULTIS.TRUE#0A}#0A#0AAND.string_to_d
at().#3D.VALOF#0A{.sawritef("function.string_to_dat
.not.implemented.(BLIB)*n")#0A..RESULTIS.0#0A}#0A#0A
//.Get.the.ith.element.of.vector.v.of.16-bit.unsign
ed.words#0AAND.getword(v,.i).#3D.VALOF#0A{.LET.j.#3D
.i+i#0A..LET.res.#3D.v%j.+.(v%(j+1)<<8)..//.Assumes
.little.ender.m/c.??????????#0A..RESULTIS.res#0A}#0A
#0A//.Store.least.sig.16.bits.of.w.in.the.ith.eleme
nt.of.vector.v.of.16-bit.words#0AAND.putword(v,.i,.
w).BE....//.store.16.bit.word#0A{.LET.j.#3D.i+i#0A.
.v%j,.v%(j+1).:#3D.w,.w>>8..//.Assumes.little.ender
.m/c..?????????????#0A}#0A#0AAND.copystring(from,.t
o).BE#0A..FOR.i.#3D.0.TO.from%0.DO.to%i.:#3D.from%i
#0A#0AAND.copy_words(from,.to,.n).BE#0A..FOR.i.#3D.
0.TO.n-1.DO.to!i.:#3D.from!i#0A#0AAND.clear_words(v
,.n).BE#0A..FOR.i.#3D.0.TO.n-1.DO.v!i.:#3D.0#0A#0AA
ND.copy_bytes(fromlen,.from,.fillch,.tolen,.to).#3D
.VALOF#0A//.This.is.an.implementation.of.the.VAX.MO
VC5.instruction#0A//.for.copying.bytes#2E#0A{.LET.n
.#3D.fromlen#0A..//.from.and.to.are.byte.addresses!
!!!!#0A..IF.n>tolen.DO.n.:#3D.tolen#0A..//.This.cod
e.need.checking!!!!!#0A..FOR.i.#3D.0.TO.n-1.DO.0%(t
o+i).:#3D.0%(from+i)#0A..FOR.i.#3D.n.TO.tolen-1.DO.
0%(to+i).:#3D.fillch#0A..RESULTIS.fromlen-n.//.Numb
er.of.non.copied.characters#0A}#0A#0A#0A#0AAND.getv
ec(upb).#3D.VALOF#0A{.IF.upb<0.DO#0A..{.sawritef("B
LIB:.getvec(%n).called*n",.upb)#0A....abort(1000)#0A
..}#0A..RESULTIS.sys(Sys_getvec,.upb)#0A}#0A#0AAND.
freevec(ptr).BE.IF.ptr.UNLESS.sys(Sys_freevec,.ptr)
.DO#0A{.sawritef("BLIB.co#3D%n:.freevec.failure,.pt
r#3D%n*n",.currco,.ptr)#0A..abort(999)#0A}#0A#0AAND
.loadseg(name).#3D.sys(Sys_loadseg,.name)#0A#0AAND.
globin(segl).#3D.sys(Sys_globin,.segl)#0A#0AAND.unl
oadseg(segl).BE.sys(Sys_unloadseg,.segl)#0A#0AAND.c
allseg(file,.arg1,.arg2,.arg3,.arg4).#3D.VALOF#0A{.
LET.res.#3D.0#0A..LET.seg.#3D.loadseg(file)#0A..LET
.s.#3D.start#0A//sawritef("BLIB:.callseg.%s.entered
*n",.file)#0A#0A..TEST.seg.&.globin(seg)#0A..THEN.r
es.:#3D.start(arg1,.arg2,.arg3,.arg4)#0A..ELSE.{.sa
writef("BLIB:.Unable.to.callseg.%s.seg#3D%n*n",.fil
e,.seg)#0A.........abort(999)#0A.........start.:#3D
.s#0A.........RESULTIS.0#0A.......}#0A..unloadseg(s
eg)#0A..start.:#3D.s#0A..RESULTIS.res#0A}#0A#0AAND.
deletefile(name).#3D.sys(Sys_deletefile,.name)#0A#0A
AND.renamefile(fromname,.toname).#3D.sys(Sys_rename
file,.fromname,.toname)#0A#0AAND.setlogname(logname
,.logvalue).#3D.VALOF#0A{.LET.a.#3D.@rootnode!rtn_e
nvlist#0A#0A..//.First.delete.current.entry.if.it.e
xists#2E#0A..{.LET.p.#3D.!a#0A....UNLESS.p.BREAK#0A
....IF.compstring(logname,.p!1)#3D0.DO#0A....{.!a.:
#3D.!p#0A......freevec(p)#0A......BREAK#0A....}#0A.
...a.:#3D.p#0A..}.REPEAT#0A#0A..IF.logvalue.DO.//.I
nsert.new.entry#0A..{.LET.upb1.#3D.logname%0../.byt
esperword#0A....LET.upb2.#3D.logvalue%0./.bytesperw
ord#0A....LET.p.#3D.getvec(4.+.upb1.+.upb2).//.3.+.
upb1+1.+.upb2+1.-.1#0A....LET.s1.#3D.p.+.3#0A....LE
T.s2.#3D.s1.+.upb1.+.1#0A....UNLESS.p.RESULTIS.0#0A
....FOR.i.#3D.0.TO.upb1.DO.s1!i.:#3D.logname!i#0A..
..FOR.i.#3D.0.TO.upb2.DO.s2!i.:#3D.logvalue!i#0A...
.p!1,.p!2.:#3D.s1,.s2#0A....!p.:#3D.rootnode!rtn_en
vlist#0A....rootnode!rtn_envlist.:#3D.p#0A....RESUL
TIS.p#0A..}#0A#0A//sawritef("BLIB:.not.adding.%s*n"
,.logname)#0A..RESULTIS.0#0A}#0A#0AAND.getlogname(l
ogname).#3D.VALOF#0A{.LET.p.#3D.rootnode!rtn_envlis
t#0A..WHILE.p.DO#0A..{.IF.compstring(logname,.p!1)#3D
0.RESULTIS.p!2#0A....p.:#3D.!p#0A..}#0A..RESULTIS.0
#0A}#0A#0A//.Example.calls.of.splitname.give.the.fo
llowing.results#0A#0A//.splitname(prefix,.':',."TCP
:shep:9000",..1).#3D>..5,.prefix#3D"TCP"#0A//.split
name(prefix,.':',."TCP:shep:9000",..5).#3D>.10,.pre
fix#3D"shep"#0A//.splitname(prefix,.':',."TCP::9000
",......5).#3D>..6,.prefix#3D""#0A//.splitname(pref
ix,.':',."TCP:shep",.......5).#3D>..0,.prefix#3D"sh
ep"#0A//.splitname(prefix,.':',."TCP:shep:",......5
).#3D>.10,.prefix#3D"shep"#0A//.splitname(prefix,.'
:',."TCP:shep:",.....10).#3D>..0,.prefix#3D""#0A//.
splitname(prefix,.':',."TCP:shep:9000",.10).#3D>..0
,.prefix#3D"9000"#0A#0AAND.splitname(prefix,.ch,.st
ring,.ptr).#3D.VALOF#0A{.LET.len.#3D.string%0#0A..L
ET.res,.pos.#3D.0,.0#0A#0A..WHILE.ptr<#3Dlen.DO#0A.
.{.LET.k.#3D.string%ptr#0A....IF.k#3Dch.DO.{.prefix
%0.:#3D.pos;.RESULTIS..ptr+1.}#0A....pos,.ptr.:#3D.
pos+1,.ptr+1#0A....prefix%pos.:#3D.k.#0A..}#0A..pre
fix%0.:#3D.pos#0A..RESULTIS.0#0A}#0A#0A//.Not.used#0A
AND.open_for_output(name,.recsiz,.maxrec).#3D.VALOF
#0A{.sawritef("DLIB:.open_for_output(%s,%n,%n).call
ed*n",.name,.recsiz,.maxrec).#0A..RESULTIS.findstre
am(name,.id_outscb,.recsiz.<<.2,.maxrec)#0A}#0A#0AA
ND.open_for_input(name).#3D.findstream(name,.id_ins
cb,.0)#0A#0AAND.open_for_update(name).#3D.findstrea
m(name,.id_inoutscb,.0)#0A#0AAND.setrecordlength(sc
b,.length).#3D.VALOF..//.length.is.in.bytes.--.MR.1
2/7/04#0A{.LET.old.#3D.scb!scb_reclen#0A..scb!scb_r
eclen.:#3D.length.//.in.bytes#0A..RESULTIS.old#0A}#0A
#0AAND.recordnote(scb).#3D.VALOF.//.The.first.recor
d.has.number.0#0A//.Returns.the.record.number.corre
sponding.to.the.current.position#0A//.........of.th
e.stream#2E#0A//.Returns.-1.if.the.stream.is.not.su
itable#2E#0A{.LET.blkno.#3D.scb!scb_block....//.The
.blocksize.is.the.buffer.size.in.bytes#0A..AND.recl
en.#3D.scb!scb_reclen..//.in.bytes#0A..IF.blkno>#3D
0.&.reclen>0.DO.//.Modified.by.MR.12/7/04#0A..{.LET
.recno.#3D.muldiv(blkno,.scb!scb_bufend,.reclen)#0A
....RESULTIS.recno.+.(result2.+.scb!scb_pos)/reclen
..//.MR.12/2/04#0A..}#0A..sawritef("BLIB:.recordnot
e:.result.-1*n")#0A..RESULTIS.-1...//.MR.26/7/04#0A
}#0A#0AAND.recordpoint(scb,.recno).#3D.VALOF#0A//.M
R.28/7/02:.The.first.record.of.a.file.has.number.0#0A
//.Returns.TRUE.if.successful#0A//.Returns.FALSE,.o
therwise#2E#0A{.LET.pvec.#3D.VEC.1#0A..LET.type.#3D
.scb!scb_type#0A..UNLESS.type#3Dscbt_file.|.type#3D
scbt_ram.DO#0A..{.sawritef("FLIB.recordpoint:.only.
works.on.a.disc.or.RAM.file*n")#0A....abort(999)#0A
....RESULTIS.FALSE#0A..}#0A..IF.recno<0.DO...//.The
.first.record.has.number.0#0A..{.sawritef("DLIB:.re
cordpoint.recno#3D%n*n",.recno)#0A....abort(1000)#0A
....recno.:#3D.0#0A..}#0A//sawritef("DLIB:.recordpo
int:.muldiv(%n,%n,%n)*n",#0A//..........scb!scb_rec
len,.recno,.scb!scb_bufend)#0A//abort(1000)#0A..pve
c!0.:#3D.muldiv(scb!scb_reclen,.recno,.scb!scb_bufe
nd).//.MR.29/7/02#0A..pvec!1.:#3D.result2#0A//sawri
tef("DLIB:.recordpoint:.recno.%n.#3D>.%n.%n*n",#0A/
/..........recno,.pvec!0,.pvec!1)#0A//abort(1000)#0A
//IF.pvec!0>2.DO.abort(8888)#0A..RESULTIS.point(scb
,.pvec)#0A}#0A#0A//.Position.an.inout.stream.to.its
.end#0A//.This.should.be.removed#2E#0AAND.appendstr
eam(scb).#3D.VALOF.//?????????????????????????????#0A
$(..LET.lblock.#3D.scb!scb_lblock#0A....LET.ldata.#3D
.scb!scb_ldata#0A....LET.pvec.#3D.VEC.1#0A//sawrite
f("DLIB:.appendstream.called*n");.abort(999)#0A....
UNLESS.scb!scb_id#3Did_inoutscb.RESULTIS.FALSE#0A..
..IF.scb!scb_block#3Dlblock.&.scb!scb_end>ldata.DO#0A
........ldata.:#3D.scb!scb_end#0A....pvec!0,.pvec!1
.:#3D.lblock,.ldata#0A....UNLESS.point(scb,.pvec).R
ESULTIS.FALSE#0A//....scb!scb_pos.:#3D.scb!scb_end#0A
....RESULTIS.TRUE#0A}#0A#0A//.Position.to.start.of.
stream#0AAND.rewindstream(scb).#3D.VALOF.//.MR.17/3
/02#0A{.LET.pvec.#3D.VEC.1#0A..pvec!0,.pvec!1.:#3D.
0,.0......//.MR.6/8/02#0A..RESULTIS.point(scb,.pvec
)#0A}#0A#0A//.Advance.stream.position.by.n.words#0A
AND.stepstream(scb,.n).#3D.VALOF#0A{.LET.pvec.#3D.V
EC.1#0A..LET.bytes,.len.#3D.n.*.bytesperword,.scb!s
cb_bufend#0A..LET.blocks.#3D.bytes./.len#0A..bytes.
:#3D.bytes.REM.len#0A..note(scb,.pvec)#0A..pvec!1.:
#3D.pvec!1.+.bytes#0A..IF.pvec!1.<.0...DO.pvec!0,.p
vec!1.:#3D.pvec!0.-.1,.pvec!1.+.len#0A..IF.pvec!1.>
.len.DO.pvec!0,.pvec!1.:#3D.pvec!0.+.1,.pvec!1.-.le
n#0A..pvec!0.:#3D.pvec!0.+.blocks#0A..RESULTIS.pvec
!0.<.1.->.FALSE,.point(scb,.pvec)#0A}#0A#0A//.Creat
e.a.RAM.stream.for.input.and.output.using.the.given
#0A//.vector,.v,.with.upper.bound.upb.as.the.buffer
,.and.end.is#0A//.the.byte.subscript.of.the.end.of.
valid.data#2E#0AAND.mkramstream(buf,.bufend,.end).#3D
.VALOF#0A{.LET.scb.#3D.getvec(scb_upb)#0A..UNLESS.s
cb.RESULTIS.0#0A..FOR.i.#3D.0.TO.scb_upb.DO.scb!i.:
#3D.0#0A..scb!scb_id......:#3D.id_inoutscb#0A..scb!
scb_type....:#3D.scbt_ram#0A..scb!scb_buf.....:#3D.
buf#0A..scb!scb_end.....:#3D.end.....//.End.of.vali
d.data#0A..scb!scb_rdfn....:#3D.falsefn.//.No.read#0A
..scb!scb_wrfn....:#3D.falsefn.//.or.write.function
s#0A..scb!scb_endfn...:#3D.ramendfn#0A..scb!scb_buf
end..:#3D.bufend..//.Length.in.bytes#0A..scb!scb_wr
ite...:#3D.FALSE...//.No.data.waiting.to.be.written
#0A..scb!scb_ldata...:#3D.end.....//.Number.of.byte
s.in.the.last.(only).block#0A..RESULTIS.scb#0A}#0A#0A
AND.falsefn().#3D.FALSE#0A#0AAND.ramendfn(scb).#3D.
TRUE.//.Always.successful#0A#0AAND.freeobj(obj).BE.
freevec(obj)#0A#0AAND.copydir(dir).#3D.VALOF#0A{.LE
T.v.#3D.getvec((dir%0)/bytesperword)#0A..IF.v.FOR.i
.#3D.0.TO.dir%0.DO.v%i.:#3D.dir%i#0A//sawritef("BLI
B:.copydir.called*n")#0A//abort(999)#0A..RESULTIS.v
#0A}#0A#0A//.Write.the.specified.number.of.records.
of.zeroes.to.the.opened.file#0AAND.setbulk(scb,.no_
records).#3D.VALOF#0A{.LET.oldout.#3D.output()#0A..
LET.n.#3D.no_records.....*.//.Number.of.bytes.to.wr
ite#0A..........scb!scb_reclen#0A..MANIFEST.{.bytes
.#3D.2048;.words#3Dbytes/bytesperword.}#0A..LET.v.#3D
.VEC.words#0A//sawritef("BLIB:.setbulk:.clearing.v!
0.to.v!%n*n",.words-1)#0A..FOR.p.#3D.@v!0.TO.@v!wor
ds-1.DO.!p.:#3D.0#0A#0A..rewindstream(scb)#0A..sele
ctoutput(scb)#0A..//.Used.writewords.to.write.2048.
bytes.at.a.time#0A//sawritef("BLIB:.setbulk:.writin
g.%n.bytes.to.file*n",.n)#0A..WHILE.n>#3Dbytes.DO.{
.writewords(v,.words);.n.:#3D.n-bytes.}#0A..//.and.
then.write.the.few.remaining.bytes,.if.any#2E#0A//s
awritef("BLIB:.setbulk:.writing.the.remaining.%n.by
tes.to.file*n",.n)#0A..FOR.i.#3D.1.TO.n.DO.binwrch(
0)#0A..rewindstream(scb)#0A..selectoutput(oldout)#0A
..RESULTIS.TRUE#0A}#0A#0AAND.datstamp(v).#3D.VALOF#0A
{.LET.tv....#3D.VEC.5#0A..LET.days..#3D.0#0A..LET.m
ins..#3D.0#0A..LET.secs..#3D.0#0A..LET.msecs.#3D.0#0A
.#0A..MANIFEST.{.secsperday.#3D.60*60*24.}#0A#0A..s
ys(Sys_ftime,.tv)#0A#0A..secs..:#3D.tv!1.-.2922*sec
sperday..//.Change.from.Unix.to.Tripos.epoc#0A..mse
cs.:#3D.tv!2#0A..//.secs.#3D.(unsigned).seconds.sin
ce.00:00:00.on.1.Jan.1978#0A..//.****.It.will.ovefl
ow.on.06:28:15.Friday.6.Feb.2114.****#0A..//.secs.:
#3D.#23xFFFFFFFF..//.Corresponds.to.06:28:15.Friday
.6.Feb.2114#0A#0A..//.secsperday*10000.#3D.864_000_
000#0A..//.The.following.loop.will.never.do.more.th
an.3.iterations#0A..WHILE.secs<0.DO.{.//.To.avoid.o
verflow.problems#0A....secs,.days.:#3D.secs-secsper
day*10000,.days+10000#0A....//sawritef("days#3D%n*n
",.days)#0A..}#0A..days..:#3D.days.+.secs./.secsper
day#0A..secs..:#3D.secs.REM.secsperday#0A..mins..:#3D
.secs./.60#0A..secs..:#3D.secs.REM.60#0A..msecs.:#3D
.secs*1000.+.msecs#0A#0A..v!0.:#3D.days#0A..v!1.:#3D
.mins#0A..v!2.:#3D.msecs.*.tickspersecond./.1000#0A
..RESULTIS.0#0A}#0A#0A

######natbcpl/sysb/dlib.b#
//.This.is.DLIB.(system.dependent.library).for.sing
le.threaded#0A//.Cintcode.BCPL#0A#0A//.It.contains.
functions.that.have.different.definitions.in.Cintpo
s#0A#0A/*#0AChange.log#0A#0A9/11/06#0AChange.treatm
ent.of.RUBOUT.(#23x7F)#0A#0A*/#0A#0ASECTION."DLIB"#0A
#0AGET."libhdr"#0A#0AMANIFEST.{#0A..char_bs.#3D.8#0A
..buflen..#3D.4096.//.Must.equal.the.block.size#0A}
#0A#0ALET.findstream(name,.id,.path).#3D.VALOF.//.M
R.8/5/03#0A{.LET.console.#3D.compstring("**",.name)
#3D0#0A..LET.scb.#3D.?#0A..LET.res.#3D.0#0A..LET.pr
efix.#3D.VEC.31#0A#0A//TEST.path#0A//THEN.sawritef(
"DLIB:.findstream(%s,.%n,.%s)*n",.name,.id,.path)#0A
//ELSE.sawritef("DLIB:.findstream(%s,.%n,.0)*n",.na
me,.id)#0A//sawritef("DLIB:.currentdir#3D%n*n",.cur
rentdir)#0A#0A..IF.console.DO#0A..{.IF.id#3Did_insc
b.&.rootnode!rtn_keyboard.RESULTIS.rootnode!rtn_key
board#0A....IF.id#3Did_outscb.&.rootnode!rtn_screen
..RESULTIS.rootnode!rtn_screen#0A..}.#0A#0A..scb.:#3D
.getvec(scb_upb)#0A..UNLESS.scb.RESULTIS.0#0A#0A..F
OR.i.#3D.0.TO.scb_upb.DO.scb!i.:#3D.0#0A#0A..scb!sc
b_id......:#3D.id#0A..scb!scb_rdfn....:#3D.0#0A..sc
b!scb_wrfn....:#3D.0#0A..scb!scb_endfn...:#3D.0#0A#0A
..//.Copy.(truncated).stream.name.into.the.scb#0A..
{.LET.len.#3D.name%0#0A....LET.scbname.#3D.@scb!scb
_name#0A....LET.maxlen.#3D.scb_maxnamelen#0A....IF.
len>scb_maxnamelen.DO.len.:#3D.scb_maxnamelen#0A...
.FOR.i.#3D.1.TO.len.DO.scbname%i.:#3D.name%i#0A....
scbname%0.:#3D.len#0A..}#0A#0A..IF.console.DO#0A..{
.//.Console.stream#0A....LET.buf.#3D.getvec(4095/by
tesperword).//.Room.for.4096.bytes#0A....UNLESS.buf
.DO.{.freevec(scb);.RESULTIS.0.}#0A....scb!scb_type
....:#3D.scbt_console#0A....scb!scb_buf.....:#3D.bu
f#0A....scb!scb_bufend..:#3D.4096#0A#0A....IF.id#3D
id_inscb.DO#0A....{.scb!scb_rdfn...:#3D.cnslrdfn.//
.fn.to.replenish.current.buffer#0A......rootnode!rt
n_keyboard.:#3D.scb#0A......RESULTIS.scb#0A....}#0A
....IF.id#3Did_outscb.DO#0A....{.scb!scb_wrfn...:#3D
.cnslwrfn.//.fn.to.output.current.buffer#0A......ro
otnode!rtn_screen.:#3D.scb#0A......RESULTIS.scb#0A.
...}#0A....freevec(scb)#0A....RESULTIS.0#0A..}#0A#0A
..splitname(prefix,.':',.name,.1)#0A..IF.compstring
(prefix,."NIL")#3D0.DO#0A..{.//.On.reading.always.g
ive.eof#0A....//.On.writing.always.throws.away.the.
data#0A....scb!scb_wrfn....:#3D.nilrdfn#0A....scb!s
cb_endfn...:#3D.nilwrfn#0A//sawritef("DLIB:.Opening
.stream.to/from.NIL:*n")#0A....RESULTIS.scb.#0A..}#0A
#0A..IF.compstring(prefix,."TCP")#3D0.|.compstring(
prefix,."NET")#3D0.DO#0A..{.sawritef("TCP.connectio
ns.not.yet.available*n")#0A....freevec(scb)#0A....R
ESULTIS.0#0A..}#0A#0A..//.Open.a.file.stream#0A//sa
writef("DLIB:.%s.must.be.a.file*n",.name)#0A#0A..IF
.id#3Did_inscb....&.fh0findinput...(scb,.name,.path
).RESULTIS.scb#0A..IF.id#3Did_outscb...&.fh0findout
put..(scb,.name).......RESULTIS.scb#0A..IF.id#3Did_
inoutscb.&.fh0findinoutput(scb,.name).......RESULTI
S.scb#0A#0A..freevec(scb)#0A..RESULTIS.0#0A}#0A#0AA
ND.nilrdfn(scb).#3D.FALSE#0A#0AAND.nilwrfn(scb).#3D
.VALOF#0A{.scb!scb_pos.:#3D.0.//.Throw.away.the.buf
fer.contents.(if.any)#0A..RESULTIS.TRUE#0A}#0A#0AAN
D.cnslrdfn(scb).#3D.VALOF#0A{.LET.buf,.p.#3D.scb!sc
b_buf,.0#0A#0A//sawritef("DLIB:.cnslrdfn:.scb#3D%n*
n",.scb)#0A..{.LET.ch.#3D.sys(Sys_sardch)#0A....SWI
TCHON.ch.INTO#0A....{.DEFAULT:..........buf%p.:#3D.
ch#0A........................p.:#3D.p+1#0A.........
...............IF.p<4096.LOOP#0A...................
.....BREAK#0A#0A......CASE.endstreamch:.IF.p.BREAK#0A
........................//.No.characters.in.the.buf
fer#0A........................result2.:#3D.endstrea
mch.//.#3D-1#0A........................RESULTIS.FAL
SE#0A#0A......CASE.'*n':........buf%p.:#3D.ch#0A...
.....................p.:#3D.p+1#0A.................
.......BREAK#0A#0A......CASE.#23x7F:........//.Rubo
ut#0A........................sys(Sys_sawrch,.char_b
s)#0A........................sys(Sys_sawrch,.'.')..
...//.MR.9/11/06#0A........................sys(Sys_
sawrch,.char_bs)#0A......CASE.char_bs:.....IF.p>0.D
O.p.:#3D.p-1#0A........................sys(Sys_sawr
ch,.'.')#0A........................sys(Sys_sawrch,.
char_bs)#0A........................LOOP#0A....}#0A.
.}.REPEAT#0A//sawritef("DLIB:.cnslrdfn:.line.read*n
")#0A//FOR.i.#3D.0.TO.p-1.DO.sawrch(buf%i)#0A..scb!
scb_pos,.scb!scb_end.:#3D.0,.p#0A..RESULTIS.TRUE#0A
}#0A#0AAND.cnslwrfn(scb).#3D.VALOF#0A{.LET.buf.#3D.
scb!scb_buf#0A//sawritef("DLIB:.cnslwrfn(%n).called
*n",.scb)#0A//sawritef("DLIB:.cnslwrfn:.buf#3D%n.po
s#3D%n.end#3D%n*n",#0A//..........scb!scb_buf,.scb!
scb_pos,.scb!scb_end)#0A#0A..FOR.i.#3D.0.TO.scb!scb
_pos-1.DO.sys(Sys_sawrch,.buf%i)#0A..scb!scb_pos.:#3D
.0#0A..scb!scb_end.:#3D.0..//.No.valid.data#0A..RES
ULTIS.TRUE#0A}#0A#0AAND.flush().#3D.VALOF#0A{.IF.co
s#3D0.|.cos!scb_id~#3Did_outscb.DO.abort(187)#0A..R
ESULTIS.fh0wrfn(cos)#0A}..#0A#0AAND.getremipaddr(sc
b).#3D.VALOF#0A{#0Asawritef("DLIB:.getremipaddr.not
.yet.available*n")#0ARESULTIS.0#0A...UNLESS.scb!scb
_type#3Dscbt_tcp.|.scb!scb_type#3Dscbt_net.DO#0A..{
.result2.:#3D.0#0A....RESULTIS.0#0A..}#0A..RESULTIS
.0.//sendpkt(-1,.scb!scb_task,.Action_getremipaddr,
.0,0,.scb)#0A}#0A#0AAND.relfilename(name).#3D.VALOF
#0A{.//.Absolute.file.names.are.(eg):#0A..//.."/abc
"...."\xyz"..."pqr:vuw"#0A..LET.len.#3D.name%0#0A..
UNLESS.len.RESULTIS.TRUE#0A..IF.name%1#3D'/'.|.name
%1#3D'\'.RESULTIS.FALSE#0A..FOR.i.#3D.1.TO.len.IF.n
ame%i#3D':'.RESULTIS.FALSE#0A..RESULTIS.TRUE#0A}#0A
#0AAND.trfilename(name,.filename).BE#0A{.LET.p.#3D.
0#0A#0A//IF.currentdir.DO#0A//...sawritef("DLIB:.tr
filename:.name#3D%s.currentdir#3D%n*n",.name,.curre
ntdir)#0A#0A..IF.currentdir.&.relfilename(name).DO#0A
..{.LET.len.#3D.currentdir%0#0A....LET.lastch.#3D.c
urrentdir%len#0A....IF.lastch#3D'/'.|.lastch#3D':'.
DO.len.:#3D.len-1#0A....IF.len.DO#0A....{.FOR.i.#3D
.1.TO.len.DO.{.p.:#3D..p+1;.filename%p.:#3D.current
dir%i.}#0A......p.:#3D.p+1#0A......filename%p.:#3D.
'/'#0A....}#0A..}#0A..FOR.i.#3D.1.TO.name%0.DO.{.p.
:#3D..p+1;.filename%p.:#3D.name%i.}#0A..filename%0.
:#3D.p#0A..FOR.i.#3D.1.TO.p.IF.filename%i#3D':'.DO.
filename%i.:#3D.'/'#0A//TEST.currentdir#0A//THEN.sa
writef("DLIB:.trfilename.%s.%s.#3D>.%s*n",.currentd
ir,.name,.filename)#0A//ELSE.sawritef("DLIB:.trfile
name.%s.#3D>.%s*n",.name,.filename)#0A}#0A#0AAND.fh
0findinput(scb,.name,.path).#3D.VALOF#0A//.Returns.
TRUE...if.successful#0A//.Returns.FALSE,.result2#3D
100..Can't.open.file#0A//................result2#3D
101..Can't.allocate.buffer#0A{.LET.fp,.buf.#3D.0,.0
#0A..LET.filesize.#3D.0#0A..LET.filename.#3D.VEC.50
#0A..trfilename(name,.filename)#0A#0A//sawritef("DL
IB:.fh0findinput.calling.sys_openread.%s.%s*n",#0A/
/..........filename,.path->path,"null")#0A..//.Open
.the.file.for.input#0A..fp.:#3D.sys(Sys_openread,.f
ilename,.path)..//.MR.8/5/03#0A..UNLESS.fp.DO#0A..{
#0A//sawritef("DLIB:.fh0findinput.sys_openread.%s.f
ailed*n",.filename)#0A....result2.:#3D.100#0A....RE
SULTIS.FALSE#0A..}#0A#0A//sawritef("DLIB:.%s.opened
*n",.filename)#0A..filesize.:#3Dsys(Sys_filesize,.f
p)#0A//sawritef("DLIB:.filesize#3D%n*n",.filesize)#0A
#0A..//.allocate.a.buffer#0A..buf.:#3D.getvec(bufle
n/bytesperword)#0A..UNLESS.buf.DO#0A..{.sys(Sys_clo
se,.fp).//.First.close.the.file#0A....result2.:#3D.
101#0A....RESULTIS.0#0A..}#0A//sawritef("DLIB:.fh0f
indinput.scb.%n.fp.%n.buf.%n*n",.scb,.fp,.buf)#0A..
..#0A..scb!scb_type....:#3D.scbt_file#0A..scb!scb_t
ask....:#3D.0#0A..scb!scb_buf.....:#3D.buf#0A..scb!
scb_rdfn....:#3D.fh0rdfn#0A..scb!scb_wrfn....:#3D.0
.......//.An.input.stream.cannot.be.depleted#0A..sc
b!scb_endfn...:#3D.fh0endfn#0A..scb!scb_fd......:#3D
.fp#0A..scb!scb_bufend..:#3D.buflen#0A..scb!scb_wri
te...:#3D.FALSE...//.No.data.waiting.to.be.written#0A
..scb!scb_blength.:#3D.buflen..//.MR.15/3/02#0A..sc
b!scb_block...:#3D.0.......//.MR.29/7/02#0A..scb!sc
b_lblock..:#3D.filesize/buflen.//+.1..//.MR.16/4/02
.MR.29/7/02#0A..scb!scb_ldata...:#3D.filesize.REM.b
uflen..//.MR.16/4/02#0A//sawritef("fh0findinput:.lb
lock#3D%n*n",.scb!scb_lblock)#0A#0A..//.Initialise.
the.buffer.by.reading.the.first.block#0A..fh0getbuf
(scb)#0A..RESULTIS.scb#0A}#0A#0AAND.fh0findoutput(s
cb,.name).#3D.VALOF#0A//.Returns.TRUE...if.successf
ul#0A//.Returns.FALSE,.result2#3D100..Can't.open.fi
le#0A//................result2#3D101..Can't.allocat
e.buffer#0A{.LET.fp,.buf.#3D.0,.0#0A..LET.filename.
#3D.VEC.50#0A..trfilename(name,.filename)#0A#0A..//
.Open.the.file.for.output#0A..fp.:#3D.sys(Sys_openw
rite,.filename)#0A..UNLESS.fp.DO#0A..{.result2.:#3D
.100#0A....RESULTIS.FALSE#0A..}#0A#0A..//.allocate.
a.buffer#0A..buf.:#3D.getvec(buflen/bytesperword)#0A
..UNLESS.buf.DO#0A..{.sys(Sys_close,.fp).//.First.c
lose.the.file#0A....result2.:#3D.101#0A....RESULTIS
.FALSE#0A..}#0A#0A//sawritef("DLIB:.fh0findoutput.s
cb.%n..%n..buf.%n*n",.scb,.fp,.buf)#0A#0A..scb!scb_
type....:#3D.scbt_file#0A..scb!scb_task....:#3D.0#0A
..scb!scb_buf.....:#3D.buf#0A..scb!scb_rdfn....:#3D
.0.......//.Can't.replenish.output.streams#0A..scb!
scb_wrfn....:#3D.fh0wrfn#0A..scb!scb_endfn...:#3D.f
h0endfn#0A..scb!scb_fd......:#3D.fp#0A..scb!scb_buf
end..:#3D.buflen#0A..scb!scb_write...:#3D.FALSE.../
/.No.data.waiting.to.be.written#0A..scb!scb_blength
.:#3D.buflen#0A..scb!scb_block...:#3D.0.......//.MR
.29/7/02#0A..scb!scb_lblock..:#3D.0.......//.This.i
s.an.empty.file.currently,.MR.29/7/02#0A..scb!scb_l
data...:#3D.0#0A//sawritef("fh0findoutput:.lblock#3D
%n*n",.scb!scb_lblock)#0A#0A..scb!scb_pos.....:#3D.
0.......//.The.buffer.has.no.valid.data.initially#0A
..scb!scb_end.....:#3D.0#0A#0A..result2.:#3D.0#0A..
RESULTIS.TRUE#0A}#0A#0AAND.fh0findinoutput(scb,.nam
e).#3D.VALOF#0A//.Returns.TRUE...if.successful#0A//
.Returns.FALSE,.result2#3D100..Can't.open.file#0A//
................result2#3D101..Can't.allocate.buffe
r#0A{.LET.fp,.buf,.res1,.res2.#3D.0,.0,.1,.0#0A..LE
T.filesize.#3D.0#0A..LET.filename.#3D.VEC.50#0A..tr
filename(name,.filename)#0A#0A..//.open.the.file.fo
r.input.and.output#0A..fp.:#3D.sys(Sys_openreadwrit
e,.filename)#0A//sawritef("DLIB:.open.%s.in.inout.m
ode.#3D>.%n*n",.filename,.fp)#0A..UNLESS.fp.DO#0A..
{.result2.:#3D.100#0A....RESULTIS.FALSE#0A..}#0A#0A
..filesize.:#3Dsys(Sys_filesize,.fp)#0A//sawritef("
BLIB:.filesize#3D%n*n",.filesize)#0A#0A..//.allocat
e.a.buffer#0A..buf.:#3D.getvec(buflen/bytesperword)
#0A..UNLESS.buf.DO#0A..{.sys(Sys_close,.fp).//.Firs
t.close.the.file#0A....result2.:#3D.101#0A....RESUL
TIS.FALSE#0A..}#0A//sawritef("DLIB:.buflen.#3D.%n*n
",.buflen)#0A//sawritef("DLIB:.fh0findinoutput.scb.
%n..%n..buf.%n*n",.scb,.fp,.buf)#0A#0A..scb!scb_typ
e....:#3D.scbt_file#0A..scb!scb_buf.....:#3D.buf#0A
..scb!scb_rdfn....:#3D.fh0rdfn#0A..scb!scb_wrfn....
:#3D.fh0wrfn#0A..scb!scb_endfn...:#3D.fh0endfn#0A..
scb!scb_fd......:#3D.fp#0A..scb!scb_bufend..:#3D.bu
flen#0A..scb!scb_write...:#3D.FALSE...//.No.data.wa
iting.to.be.written#0A..scb!scb_blength.:#3D.buflen
..//.MR.15/3/02#0A..scb!scb_block...:#3D.0.//1.MR.2
9/7/02#0A..scb!scb_lblock..:#3D.filesize/buflen.//+
.1..//.MR.16/4/02.MR.29/7/02#0A..scb!scb_ldata...:#3D
.filesize.REM.buflen..//.MR.16/4/02#0A//sawritef("f
h0findinoutput:.lblock#3D%n*n",.scb!scb_lblock)#0A#0A
..//.Initialise.the.buffer.by.reading.the.first.blo
ck#0A..UNLESS.fh0getbuf(scb).DO#0A..{.//.Failed.to.
fill.the.buffer.with.data#0A....sawritef("DLIB:.fh0
getbuf(%n).failed*n",.scb)#0A....RESULTIS.FALSE#0A.
.}#0A..res2.:#3D.result2#0A..RESULTIS.TRUE#0A}#0A#0A
AND.fh0falsefn(scb)..#3D.FALSE#0A#0A#0AAND.fh0rdfn(
scb)..#3D.VALOF#0A//.This.is.only.used.for.disc.fil
es#2E.The.field.end.will.equal#0A//.buflen.for.all.
blocks.except.possibly.the.last.one#2E#0A//.If.the.
buffer.contains.data.from.the.last.block.and.pos#3D
end,#0A//.then.EOF.has.been.reached#2E.If.pos#3Dend
.data.from.the.next.block#0A//.must.be.read#2E.But.
the.current.block.will.first.have.to.be#0A//.writte
n.to.disc,.if.the.write.field.is.TRUE#2E#0A//.Retur
ns.TRUE,..if.successful#2E.There.will.be.valid.data
.between#0A//................pos.and.end.in.the.buf
fer#2E#0A//.Returns.FALSE,.result2#3D-1.on.EOF#0A//
.........FALSE,.result2#3Derrorcode,.otherwise#2E#0A
{.LET.block,.lblock.#3D.scb!scb_block,.scb!scb_lblo
ck#0A..LET.pos,...end....#3D.scb!scb_pos,...scb!scb
_end#0A//sawritef("DLIB:.fh0readfn.scb.%n.pos.%n.en
d.%n*n",.scb,.pos,.end)#0A//sawritef("DLIB:.fh0read
fn.block.%n.lblock.%n*n",.block,.lblock)#0A..IF.pos
<end......RESULTIS.TRUE..//.Data.still.available.in
.current.buffer#0A..IF.block#3Dlblock.DO.{.result2.
:#3D.-1;.RESULTIS.FALSE.}.//.End-of-file#0A#0A..IF.
scb!scb_write.DO.fh0putbuf(scb)..//.Write.block.if.
necessary#0A#0A..IF.end>#3Dbuflen.DO.block.:#3D.blo
ck+1..//.Advance.block.if.necessary#0A..scb!scb_blo
ck,.scb!scb_pos.:#3D.block,.0#0A//sawritef("DLIB:.f
h0rdfn.block.%n.pos.%n.end.%n*n",.scb!scb_block,.po
s,.end)#0A#0A..UNLESS.fh0getbuf(scb).DO#0A..{.sawri
tef("DLIB:.fh0getbuf(%n).failed*n",.scb)#0A....RESU
LTIS.FALSE..//.Read.data.into.the.buffer#0A..}#0A#0A
..//.Safety.check#0A..end.:#3D.scb!scb_end#0A..UNLE
SS.end#3Dbuflen.|.lblock.#3D.scb!scb_block.DO#0A..{
.sawritef("DLIB:.fh0rdfn.block#3D%n.lblock#3D%n.pos
#3D%n.end#3D%n*n",#0A..............scb!scb_block,.l
block,.scb!scb_pos,.end)#0A....abort(9999)#0A..}#0A
..#0A..RESULTIS.TRUE..............//.The.buffer.is.
not.empty#0A}..#0A...#0AAND.fh0wrfn(scb).#3D.VALOF#0A
//.Write.the.current.buffer.to.file,.if.the.write.f
lag.is.set#0A//.Return.TRUE,.if.successful#0A//.Ret
urn.FALSE.otherwise#2E#0A{.LET.block,.lblock.#3D.sc
b!scb_block,.scb!scb_lblock#0A..LET.pos,.end.#3D.sc
b!scb_pos,.scb!scb_end#0A..LET.len.#3D.?#0A//sawrit
ef("DLIB:.fh0wrfn.scb.%n.pos.%n.end.%n*n",.scb,.pos
,.end)#0A//sawritef("DLIB:.fh0wrfn.block.%n.lblock.
%n*n",.block,.lblock)#0A..IF.scb!scb_write.DO.//.Wr
ite.current.block.if.necessary#0A....UNLESS.fh0putb
uf(scb).RESULTIS.FALSE#0A#0A//..IF.pos<scb!scb_bufe
nd.DO#0A//sawritef("DLIB:.return0.from.fh0wrfn.bloc
k#3D%n.lblock#3D%n.pos#3D%n.end#3D%n*n",#0A//......
....scb!scb_block,.scb!scb_lblock,.pos,.end)#0A#0A.
.IF.pos.<.scb!scb_bufend.RESULTIS.TRUE..//.Still.ro
om.in.the.buffer#0A..//.Move.to.next.block#0A..bloc
k.:#3D.block+1#0A..scb!scb_block,.scb!scb_pos,.scb!
scb_end.:#3D.block,.0,.0#0A..IF.block>lblock.DO#0A.
.{.scb!scb_lblock.:#3D.block....//.Last.block.is.em
pty#0A//sawritef("DLIB:.return1.from.fh0wrfn.block#3D
%n.lblock#3D%n.pos#3D%n.end#3D%n*n",#0A//..........
scb!scb_block,.scb!scb_lblock,.pos,.end)#0A....RESU
LTIS.TRUE#0A..}#0A#0A..IF.scb!scb_id#3Did_inoutscb.
UNLESS.fh0getbuf(scb).DO#0A..{.sawritef("DLIB:.fh0w
rfn.getbuf.failed.block#3D%n.lblock#3D%n.pos#3D%n.e
nd#3D%n*n",#0A..............scb!scb_block,.scb!scb_
lblock,.pos,.end)#0A....abort(1102)#0A..}#0A#0A//sa
writef("DLIB:.return2.from.fh0wrfn.block#3D%n.lbloc
k#3D%n.pos#3D%n.end#3D%n*n",#0A//..........scb!scb_
block,.scb!scb_lblock,.pos,.end)#0A#0A..RESULTIS.TR
UE#0A}..#0A#0A...#0AAND.fh0endfn(scb).#3D.VALOF#0A/
/.Write.the.buffer,.if.necessary,.and.free.it#2E#0A
//.Close.the.file#2E#0A//.Return.TRUE,.if.successfu
l#0A//.Return.FALSE.otherwise#2E#0A{#0A//sawritef("
DLIB:.fh0endfn.scb.%n,.write.flag#3D%n*n",.scb,.scb
!scb_write)#0A//sawritef("DLIB:.fh0endfn.pos#3D%n.e
nd#3D%n*n",.scb!scb_pos,.scb!scb_end)#0A..IF.scb!sc
b_write.UNLESS.fh0putbuf(scb).RESULTIS.FALSE#0A//sa
writef("DLIB:.fh0endfn.freeing.buf#3D%n*n",.scb!scb
_buf)#0A..freevec(scb!scb_buf)#0A..RESULTIS.sys(Sys
_close,.scb!scb_fd)#0A}#0A#0A//.Result.TRUE:.posv.c
ontains.the.stream.block.and.pos#0A//.......FALSE:.
scb.was.not.a.file.or.RAM.stream#0AAND.note(scb,.po
sv).#3D.VALOF#0A{.LET.type.#3D.scb!scb_type#0A..UNL
ESS.type#3Dscbt_file.|.type#3Dscbt_ram.RESULTIS.FAL
SE#0A..posv!0.:#3D.scb!scb_block#0A..posv!1.:#3D.sc
b!scb_pos#0A//sawritef("DLIB:.note.#3D>.%n.%n*n",.p
osv!0,.posv!1)#0A..RESULTIS.TRUE#0A}#0A#0A//.Set.th
e.stream.position.to.that.specified.in.posv#2E..If.
the#0A//.new.position.is.in.a.different.block.the.b
uffer.may.have.to#0A//.be.written.out.and.new.data.
read.in#2E#0A//.It.returns.TRUE.if.successful,.even
.if.positioned.just.after.the#0A//.last.block.of.th
e.file,.ie.block#3Dlblock+1.and.pos#3Dend#3D0#2E#0A
//.It.returns.FALSE,.otherwise#2E.Possibly.because.
the.stream.is.not#0A//.pointable.or.the.posv.is.out
.of.range#2E#0AAND.point(scb,.posv).#3D.VALOF#0A{.L
ET.blkno..#3D.posv!0#0A..LET.pos....#3D.posv!1#0A..
LET.id.....#3D.scb!scb_id#0A..LET.block..#3D.scb!sc
b_block...//.Current.block.number#0A..LET.lblock.#3D
.scb!scb_lblock..//.Last.block.number.of.the.stream
#0A..LET.end....#3D.scb!scb_end#0A..LET.type...#3D.
scb!scb_type#0A//sawritef("DLIB:.point.posv!0#3D%n.
posv!1#3D%n*n",.posv!0,.posv!1)#0A#0A//sawritef("DL
IB:.point.block#3D%n.lblock#3D%n.blkno#3D%n.pos#3D%
n.end#3D%n*n",#0A//...............block,.lblock,..b
lkno,.pos,.end)#0A#0A...//.The.stream.must.be.a.rea
dable.disc.or.RAM.file#0A..UNLESS.(type#3Dscbt_file
.|.type#3Dscbt_ram).&#0A.........(id#3Did_inscb.|.i
d#3Did_inoutscb).RESULTIS.FALSE#0A#0A..IF.pos#3D0.&
.blkno#3Dlblock+1.DO.blkno,.pos.:#3D.lblock,.buflen
#0A.#0A//sawritef("DLIB:.point.block#3D%n.lblock#3D
%n.blkno#3D%n.pos#3D%n.end#3D%n*n",#0A//...........
....block,.lblock,..blkno,.pos,.end)#0A#0A//..IF.bl
kno<#3D0.DO.blkno,.pos.:#3D.0,.0.//.Cannot.position
.before.start.of.file#0A#0A..//.Safety.check#0A..//
.Make.sure.the.position.is.within.the.file#0A..IF.b
lkno<0.|.#0A.....blkno>lblock.|#0A.....blkno#3Dlblo
ck.&.pos.>.(block#3Dlblock.->.end,.scb!scb_ldata)..
DO#0A..{.sawritef("DLIB:.point.beyond.end.of.file,.
blkno#3D%n.pos#3D%n*n",.blkno,.pos)#0A....sawritef(
"block#3D%n.end#3D%n.lblock#3D%n.posv#3D(%n,%n)*n",
#0A..............block,.end,.lblock,.posv!0,.posv!1
)#0A....abort(999)#0A....RESULTIS.FALSE#0A..}#0A#0A
..IF.blkno#3Dblock.DO#0A..{.//.The.new.position.is.
in.the.current.block#0A....scb!scb_block.:#3D.blkno
#0A....scb!scb_pos...:#3D.pos#0A//sawritef("DLIB:.p
oint.setting.scb.block#3D%n.pos#3D%n*n",.blkno,.pos
)#0A....RESULTIS.TRUE.//.Success#0A..}#0A#0A..//.Th
e.move.is.to.a.different.block,.so.must.read.a.bloc
k#0A..//.but.first.check.if.the.current.block.must.
be.written#0A..IF.scb!scb_write.DO#0A..{.//sawritef
("DLIB:.point.write.block.%n*n",.scb!scb_block).#0A
....UNLESS.fh0putbuf(scb).DO.abort(5003)#0A..}#0A#0A
..scb!scb_block.:#3D.blkno..//.Set.the.new.position
#0A.#0A//sawritef("DLIB:.point.read.block.%n*n",.bl
kno)#0A#0A..UNLESS.fh0getbuf(scb).DO#0A..{.sawritef
("DLIB:.point.fh0getbuf.failed.block.%n.#3D>.%n*n",
.blkno,.end)#0A....abort(5004)#0A....RESULTIS.FALSE
#0A..}#0A#0A..//.Safety.check#0A..UNLESS.scb!scb_en
d#3Dbuflen.|#0A.........blkno#3Dlblock.&.end>#3Dscb
!scb_ldata.DO#0A..{.sawritef("DLIB.point:.safety.ch
eck.failed*n")#0A....sawritef("DLIB.point:.blkno.%n
.pos.%n*n",.blkno,.pos)#0A....sawritef("DLIB.point:
.end.%n.buflen.%n*n",.scb!scb_end,.buflen)#0A....sa
writef("DLIB.point:.block.%n.lblock.%n*n",.blkno,.l
block)#0A....sawritef("DLIB.point:.end.%n.ldata.%n*
n",.end,.scb!scb_ldata)#0A....abort(5005)#0A..}#0A#0A
..scb!scb_pos...:#3D.pos..//.Set.the.desired.offset
#0A#0A//sawritef("DLIB:.point(#2E#2E).#3D>.TRUE,.bl
kno.%n.pos.%n*n",.blkno,.pos)#0A..RESULTIS.TRUE#0A}
#0A#0AAND.fh0putbuf(scb).#3D.VALOF#0A//.This.is.onl
y.used.on.disc.file.streams.and.is.only.called.when
#0A//.the.write.field.is.TRUE#2E.It.writes.the.buff
er.to.file#2E#0A//.The.file.is.positioned.before.th
e.write#2E.If.the.last.block#0A//.is.being.written.
ldata.is.set.to.end.and.this.number.of.bytes.writte
n#0A//.to.disc#2E.(For.all.other.blocks.end#3Dbufle
n#2E)#0A//.Returns.TRUE,.if.successful,.having.set.
the.write.field.to.FALSE#2E#0A//.Returns.FALSE,.oth
erwise#2E#0A{.LET.end....#3D.scb!scb_end....//.Numb
er.of.bytes.of.valid.data.in.buf#0A..LET.block..#3D
.scb!scb_block#0A..LET.fd.....#3D.scb!scb_fd#0A..LE
T.offset.#3D.buflen*block...//.File.offset.of.buffe
r's.first.byte.MR.29/7/02#0A#0A..IF.end<#3D0.DO#0A.
.{.//.Nothing.in.the.buffer.to.write,.probably.a.mi
stake#2E#0A....//sawritef("DLIB:.fh0putbuf,.end#3D%
n*n",.end)#0A....scb!scb_write.:#3D.FALSE#0A....RES
ULTIS.TRUE#0A..}#0A#0A..//.The.size.of.a.file.can.o
nly.change.when.writing.its.last.block#0A..//.so.ld
ata.only.needs.correcting.when.this.happens#0A..IF.
block.#3D.scb!scb_lblock.DO.scb!scb_ldata.:#3D.end#0A
#0A//sawritef("DLIB:.putbuf.seeking.offset.%n.(bloc
k.%n)*n",.offset,.block)#0A..UNLESS.sys(Sys_seek,.f
d,.offset).RESULTIS.FALSE#0A#0A//sawritef("DLIB:.pu
tbuf.write.%n.bytes.at.offset.%n*n",.end,.offset)#0A
..IF.sys(Sys_write,.fd,.scb!scb_buf,.end).<.0#0A...
.RESULTIS.FALSE#0A..scb!scb_write.:#3D.FALSE.//.The
.buffer.has.been.written.successfully#0A..RESULTIS.
TRUE#0A}#0A#0A//.fh0getbuf.reads.a.block.into.the.s
cb's.buffer#2E#0A//.Returns.TRUE.if.successful#0A//
......having.set.pos#3D0.and.end.to.the.end.of.vali
d.data#0A//.Returns.FALSE,.otherwise#2E#0A#0AAND.fh
0getbuf(scb).#3D.VALOF#0A{.LET.fd......#3D.scb!scb_
fd#0A..LET.block...#3D.scb!scb_block#0A..LET.offset
..#3D.buflen*block....//.MR.29/7/02#0A..LET.end....
.#3D.?.#0A#0A//sawritef("DLIB:.fh0getbuf.seeking.st
art.of.block.%n.(offset.%n)*n",#0A//............blo
ck,.offset)#0A..UNLESS.sys(Sys_seek,.fd,.offset).RE
SULTIS.FALSE#0A//sawritef("DLIB:.fh0getbuf.file.pos
ition.now.%n*n",.sys(Sys_tell,.fd))#0A#0A//sawritef
("DLIB:.fh0getbuf.reading.block.%n.offset#3D%n*n",.
block,.offset)#0A..end.:#3D.sys(Sys_read,.fd,.scb!s
cb_buf,.buflen)#0A//sawritef("DLIB:.fh0getbuf.read.
#3D>.%n*n",.end)#0A//sawritef("DLIB:.fh0getbuf.bloc
k#3D%n.lblock#3D%n.ldata#3D%n*n",#0A//.............
..block,.scb!scb_lblock,.scb!scb_ldata)#0A..IF.end<
0.RESULTIS.FALSE.//.Unable.to.read#0A..scb!scb_pos,
.scb!scb_end.:#3D.0,.end.#0A..RESULTIS.TRUE#0A}#0A#0A
#0A

######natbcpl/sysc/clib.c#
/*#0A**.This.is.CLIB.for.BCPL.compiled.into.native.
code#0A**#0A**.It.is.based.on.cintsys#2Ec.from.the.
BCPL.Cintcode.system.and.is#0A**.meant.to.run.on.mo
st.machines.with.a.Unix-like.C.libraries#2E#0A**#0A
**.(c).Copyright:..Martin.Richards..4.September.200
9#0A**#0A*/#0A#0A//.Test.this.sort.of.comment#2E#0A
#0A/*#0AChange.History#0A#0A04/09/09#0AStarted.to.m
ake.changes.for.the.Vax.under.VMS#0A#0A10/04/06#0AM
ade.change.to.natbcpl.to.make.rdch.read.the.command
.argument.characters.before#0Areading.from.stdin,.f
or.compatibility.with.cintsys#2E#0A#0A21/04/04#0AMa
de.many.changes.and.improvements.suggested.by.Colin
.Liebenrood#0A#0A07/11/96#0ASystematic.changes.to.a
llow.64.bit.implementation.on.the.ALPHA#0A#0A23/07/
96#0AFirst.implementation#0A*/#0A#0A#23include.<std
io#2Eh>#0A#23include.<stdlib#2Eh>#0A#23include.<sig
nal#2Eh>#0A#23include.<string#2Eh>#0A#0A#23if.defin
ed(forVmsItanium).||.defined(forVmsVax)#0A#23includ
e.<timeb#2Eh>#0A#23else#0A#23include.<sys/timeb#2Eh
>#0A#23endif#0A#0A/*.bcpl#2Eh.contains.machine/syst
em.dependent.#23defines..*/#0A#23include."bcpl#2Eh"
#0A#0Astatic.BCPLWORD.result2;#0Astatic.BCPLWORD.pr
efix;#0ABCPLWORD.rootnode[Rtn_upb+1];#0Astatic.char
.*parms;../*.vector.of.command-line.arguments.*/#0A
static.int..parmp#3D1;./*.subscript.of.next.command
-line.character#2E.*/#0Astatic.int..ttyinp;../*.#3D
1.if.stdin.is.a.tty,.#3D0.otherwise.*/#0A#0A/*.prot
otypes.for.forward.references.*/#0Astatic.BCPLWORD.
muldiv(BCPLWORD.a,.BCPLWORD.b,.BCPLWORD.c);#0Astati
c.char.*b2c_fname(BCPLWORD.bstr,.char.*cstr);#0Asta
tic.char.*vmsfname(char.*name,.char.*vaxname);#0Ast
atic.char.*b2c_str(BCPLWORD.bstr,.char.*cstr);#0Ast
atic.BCPLWORD.c2b_str(char.*cstr,.BCPLWORD.bstr);#0A
#0A/*.Function.normally.defined.in.graphics#2Ec..*/
#0Aextern.BCPLWORD.sysGraphics(BCPLWORD.*p);#0ABCPL
WORD.sysGraphics(BCPLWORD.*p).{.return.0;.}./*.Dumm
y.definition.*/#0A#0A/*.Function.defined.in.mlib#2E
mar.*/#0ABCPLWORD.callstart(BCPLWORD.*p,.BCPLWORD.*
g);#0A#0A#23define.Globword......0x8F8F0000L#0A#23d
efine.Gn_result2....10#0A#0Aint.badimplementation(v
oid)#0A{.int.bad.#3D.0;#0A..int.A#3D'A';#0A..SIGNED
CHAR.c.#3D.(SIGNEDCHAR)255;#0A..if(sizeof(BCPLWORD)
!#3D(1<<B2Wsh)).{#0A.......PRINTF("Size.of.a.BCPL.w
ord.is.not.%d\n",.1<<B2Wsh);#0A.......bad.#3D.1;#0A
..}#0A..if(A!#3D65).{#0A.......PRINTF("Character.se
t.is.not.ASCII\n");#0A.......bad.#3D.1;#0A..}#0A..i
f.(c/-1.!#3D.1).{#0A....PRINTF("There.is.a.problem.
with.SIGNEDCHAR\n");#0A....bad.#3D.1;#0A..}#0A..ret
urn.bad;#0A}#0A#0Avoid.initfpvec(void)....{.return;
.}#0ABCPLWORD.newfno(FILE.*fp)...{.return.WD.fp;.}#0A
BCPLWORD.freefno(BCPLWORD.fno).{.return.fno;.}#0AFI
LE.*findfp(BCPLWORD.fno)..{.return.(FILE.*)fno;.}#0A
#0A/*.storage.for.SIGINT.handler.*/#0Avoid.(*old_ha
ndler)(int);#0A#0Avoid.handler(int.sig)#0A{.#0A..pr
intf("SIGINT.received\n");#0A..old_handler.#3D.sign
al(SIGINT,.old_handler);#0A..close_keyb();#0A..exit
(20);#0A}#0A#0Aint.main(int.argc,.char.*argv[])#0A{
.int.i;....../*.for.FOR.loops..*/#0A..BCPLWORD.*glo
bbase;#0A..BCPLWORD.*stackbase;#0A..BCPLWORD.res;#0A
#0A..if.(.badimplementation().)#0A..{.printf("This.
implementation.of.C.is.not.suitable\n");#0A....retu
rn.20;#0A..}#0A#0A../*.Try.to.reconstruct.the.comma
nd.line.arguments.from.argv.*/#0A..parms.#3D.(char.
*)(MALLOC(256));#0A#0A..{.int.p#3D0;#0A....parms[0]
.#3D.0;#0A#0A....for.(i#3D1;.i<argc;.i++).{#0A.....
.char.*arg.#3D.argv[i];#0A......int.len.#3D.strlen(
arg);#0A......int.j;#0A......int.is_string.#3D.0;./
*.#3D1.if.arg.contains.",.space,.or.newline#2Ewhite
.space.*/#0A....../*printf("clib:.getting.command.l
ine,.len#3D%d\n",.len);.*/#0A......for.(j#3D0;.j<le
n;.j++)#0A........if(.arg[j]#3D#3D'"'.||.arg[j]#3D#3D
'.'.||.arg[j]#3D#3D'\n').is_string.#3D.1;#0A....../
*printf("clib:.getting.command.line,.is_string#3D%d
\n",.is_string);.*/#0A......parms[++p].#3D.'.';#0A.
.....if(is_string)#0A......{.parms[++p].#3D.'"';#0A
........for.(j#3D0;.j<len;.j++)#0A........{.int.ch.
#3D.arg[j];#0A..........if(ch#3D#3D'\n').{.parms[p+
+].#3D.'*';.parms[++p].#3D.'n';.}#0A..........if(ch
#3D#3D'"')..{.parms[p++].#3D.'*';.parms[++p].#3D.'"
';.}#0A#09..else.parms[++p].#3D.ch;#0A........}#0A.
.......parms[++p].#3D.'"';#0A......}.else.{#0A.....
...for.(j#3D0;.j<len;.j++).parms[++p].#3D.arg[j];#0A
......}#0A....}#0A....parms[++p].#3D.'\n';../*.Put.
a.newline.at.the.end.of.the.argument.string.*/#0A..
..parms[0].#3D.p;./*.Fill.in.the.BCPL.string.length
.*/#0A....parmp.#3D.1;..../*.Subscript.of.the.first
.character.of.the.*/#0A................../*.command
-line.argument.*/#0A#0A..../*printf("clib:.args:.le
n#3D%d\n",.parms[0]);.*/#0A..../*for(i#3D1;.i<#3Dpa
rms[0];i++).printf("parm[%d]#3D%d\n",.i,.parms[i]);
.*/#0A..../*printf("\n");.*/#0A..}#0A#0A../*..parms
.#3D.(BCPLWORD.*)(MALLOC(argc+1));.*/#0A../*parms[0
].#3D.argc.>.1.?.argc.:.0;.*/#0A../*for.(i.#3D.0;.i
.<.argc;.i++).{.*/#0A../*..BCPLWORD.v.#3D.(BCPLWORD
)(MALLOC(1+strlen(argv[i]).>>.B2Wsh)).>>.B2Wsh;.*/#0A
../*..c2b_str(argv[i],.v);.*/#0A../*..parms[1+i].#3D
.v;.*/#0A../*}.*/#0A#0A..old_handler.#3D.signal(SIG
INT,.handler);#0A..initfpvec();#0A#0A..globbase..#3D
.(BCPLWORD.*)(calloc((gvecupb.+1),.1<<B2Wsh));#0A..
if(globbase#3D#3D0).#0A....{.printf("unable.to.allo
cate.space.for.globbase\n");#0A......exit(20);#0A..
..}#0A#0A..stackbase.#3D.(BCPLWORD.*)(calloc((stack
upb+1),.1<<B2Wsh));#0A..if(stackbase#3D#3D0).#0A...
.{.printf("unable.to.allocate.space.for.stackbase\n
");#0A......exit(20);#0A....}#0A#0A..for(i#3D0;.i<#3D
Rtn_upb;.i++).rootnode[i].#3D.0;#0A#0A..globbase[0]
.#3D.gvecupb;#0A#0A..for.(i#3D1;i<#3Dgvecupb;i++).g
lobbase[i].#3D.Globword.+.i;#0A..globbase[Gn_rootno
de].#3D.((BCPLWORD)rootnode)>>B2Wsh;#0A#0A..for.(i#3D
0;i<#3Dstackupb;i++).stackbase[i].#3D.0;#0A#0A../*.
.printf("clib:.gvecupb#3D%d.stackupb#3D%d\n",.gvecu
pb,.stackupb);.*/#0A../*.initsections,.gvecupb.and.
stackupb.are.defined.in.the.file.*/#0A../*.(typical
ly).initprog#2Ec.created.by.a.call.of.the.command.m
akeinit#2E.*/#0A#0A..initsections(globbase);#0A#0A/
/printf("globbase[1].#3D.%d\n",.globbase[1]);#0A#0A
..ttyinp.#3D.init_keyb();#0A#0A../*.Enter.BCPL.star
t.function:.callstart.is.defined.in.mlib#2Es.*/#0A.
.res.#3D.callstart(stackbase,.globbase);#0A#0A#0A..
close_keyb();#0A#0A..if.(res).printf("\nExecution.f
inished,.return.code.%ld\n",.(long)res);#0A#0A..fre
e(globbase);#0A..free(stackbase);#0A..free(parms);#0A
#0A..return.res;#0A}#0A#0A#0ABCPLWORD.muldiv(BCPLWO
RD.a,.BCPLWORD.b,.BCPLWORD.c)#0A{.unsigned.BCPLWORD
.q#3D0,.r#3D0,.qn,.rn;#0A..unsigned.BCPLWORD.ua,.ub
,.uc;#0A..int.qneg#3D0,.rneg#3D0;#0A../*..printf("m
uldiv:.a#3D%d.b#3D%d.c#3D%d\n",.a,.b,.c);.*/#0A..if
(c#3D#3D0).c#3D1;#0A..if(a<0).{.qneg#3D!qneg;.rneg#3D
!rneg;.ua.#3D.-a;.}#0A..else.......................
.......ua.#3D..a;#0A..if(b<0).{.qneg#3D!qneg;.rneg#3D
!rneg;.ub.#3D.-b;.}#0A..else.......................
.......ub.#3D..b;#0A..if(c<0).{.qneg#3D!qneg;......
.......uc.#3D.-c;.}#0A..else.......................
.......uc.#3D..c;#0A..#0A..qn.#3D.ub./.uc;#0A..rn.#3D
.ub.%.uc;#0A..#0A..while(ua)#0A..{.if(ua&1).{.q.+#3D
.qn;#0A...............r.+#3D.rn;#0A...............i
f(r>#3Dc).{.q++;.r.-#3D.uc;.}#0A.............}#0A..
..ua.>>#3D.1;#0A....qn.<<#3D.1;#0A....rn.<<#3D.1;#0A
....if(rn>#3Duc).{qn++;.rn.-#3D.uc;.}#0A..}#0A..res
ult2.#3D.rneg.?.-r.:.r;#0A..return.qneg.?.-q.:.q;#0A
}#0A#0Astatic.char.chbuf1[256],.chbuf2[256];./*.to.
hold.filenames.*/#0Astatic.char.chbuf3[256],.chbuf4
[256];./*.to.hold.filenames.*/#0A#0Aint.tracing.#3D
.0;#0Aint.filetracing.#3D.0;#0A#0Aint.relfilename(c
har.*name)#0A{.if(name[0]#3D#3DFILE_SEP_CH.||#0A...
../*.The.following.is.fiddle.for.MSDOS/Windows.*/#0A
.....FILE_SEP_CH#3D#3D'\\'.&&.'A'<#3Dname[0].&&.nam
e[0]<#3D'Z'.&&.name[1]#3D#3D':')#0A.......return.0;
./*.Absolute.file.names.don't.use.paths.*/#0A..retu
rn.1;.#0A}#0A#0A/*.pathinput.does.not.use.any.of.ch
buf1,.chbuf2.or.chbuf3#2E.*/#0AFILEPT.pathinput(cha
r.*name,.char.*pathname)#0A/*.If.pathname.is.not.nu
ll,.name.is.looked.up.in.the.directories#0A...it.sp
ecified,.otherwise.name.is.looked.up.in.the.current
.directory#0A*/#0A{.FILEPT.fp.#3D.0;#0A#0A../*.Look
.through.the.PATH.directories.if.pathname.is.given#2E
.*/#0A..if.(pathname).{#0A....char.str[256];#0A....
char.*filename.#3D.&str[0];#0A....int.itemsep.#3D.F
ILE_SEP_CH#3D#3D'/'.?.':'.:.';';#0A#23if.defined(fo
rVmsItanium).||.defined(forVmsVax)#0A....itemsep.#3D
.';';#0A#23endif#0A..../*PRINTFS("pathinput:.search
ing.for.%s.in.path.%s\n",.name,.pathname);.*/#0A...
.if.(relfilename(name))#0A....{.char.*path.#3D.gete
nv(pathname);#0A......if(filetracing).{#0A........P
RINTFS("pathinput:.using.%s",.pathname);#0A........
PRINTFS(".#3D.%s\n",.path);#0A......}#0A....../*PRI
NTFS("pathinput:.searching.directories.%s\n",.path)
;.*/#0A....../*.Try.prefixing.with.each.directory.i
n.the.path#2E.*/#0A......while(path.&&.fp#3D#3D0)#0A
......{.char.*f#3Dfilename;#0A........char.*n#3Dnam
e;#0A........while(*path#3D#3Ditemsep).path++;#0A..
......if(*path#3D#3D0).break;#0A......../*.Copy.the
.directory.name.into.filename.*/#0A........while(*p
ath!#3D0.&&.*path!#3Ditemsep)#0A........{.char.ch.#3D
.*path++;#0A..........if(ch#3D#3D'/'.||.ch#3D#3D'\\
').ch.#3D.FILE_SEP_CH;#0A..........*f++.#3D.ch;#0A.
.......}#0A......../*.Insert.a.filename.seperator.i
f.necessary#2E.*/#0A........if(f[-1]!#3DFILE_SEP_CH
).*f++.#3D.FILE_SEP_CH;#0A#0A......../*.Append.the.
given.file.name.*/#0A........while(*n)#0A........{.
char.ch.#3D.*n++;#0A..........if(ch#3D#3D'/'.||.ch#3D
#3D'\\').ch.#3D.FILE_SEP_CH;#0A..........*f++.#3D.c
h;#0A........}#0A........*f.#3D.0;#0A#23if.defined(
forVmsItanium).||.defined(forVmsVax)#0A........file
name.#3D.vmsfname(filename,.chbuf4);#0A#23endif#0A.
.......fp.#3D.fopen(filename,."rb");#0A........if(f
iletracing)#0A........{.PRINTFS("Trying:.%s.-.",.fi
lename);#0A#09..if(fp).{#0A............PRINTF("foun
d\n");#0A#09..}.else.{#0A............PRINTF("not.fo
und\n");#0A#09..}#0A........}#0A......}#0A....}#0A.
.}.else.{#0A..../*.If.pathname.was.NULL,.search.the
.current.directory.*/#0A..../*PRINTFS("Searching.fo
r.%s.in.the.current.directory\n",.name);.*/#0A#23if
.defined(forVmsItanium).||.defined(forVmsVax)#0A...
.fp.#3D.fopen(vmsfname(name,.chbuf4),."rb");#0A#23e
lse#0A....fp.#3D.fopen(name,."rb");#0A#23endif#0A..
..if(filetracing)#0A....{.PRINTFS("Trying:.%s.in.th
e.current.directory.-.",.name);#0A......if(fp).{#0A
........PRINTF("found\n");#0A......}.else.{#0A.....
...PRINTF("not.found\n");#0A......}#0A....}#0A..}#0A
#0A../*if(fp#3D#3D0).PRINTFS("pathinput:.failed.to.
find.%s.anywhere\n",.name);.*/#0A../*else......PRIN
TF("pathinput:.success\n");.*/#0A#0A..return.fp;#0A
}#0A/*#0AFILE.*pathinput(char.*name,.char.*pathname
)#0A{.FILE.*fp.#3D.fopen(name,."r");#0A..char.filen
ame[1024];#0A..int.itemsep.#3D.FILE_SEP_CH#3D#3D'/'
.?.':'.:.';';#0A..if.(fp#3D#3D0)#0A..{.if.(pathname
.&&.relfilename(name))#0A....{.char.*path.#3D.geten
v(pathname);#0A......while(path.&&.fp#3D#3D0)#0A...
...{.char.*f#3Dfilename,#0A.............*n#3Dname;#0A
........while(*path#3D#3Ditemsep).path++;#0A.......
.if(*path#3D#3D0).break;#0A........while(*path!#3D0
.&&.*path!#3Ditemsep).*f++.#3D.*path++;#0A........i
f(f[-1]!#3DFILE_SEP_CH).*f++.#3D.FILE_SEP_CH;#0A...
.....while(*n).*f++.#3D.*n++;#0A........*f.#3D.0;#0A
........fp.#3D.fopen(filename,."r");#0A......}#0A..
..}#0A..}#0A..return.fp;#0A}#0A*/#0A#0A/*.dosys(P,.
G).called.from.mlib#2Es.in.response.to#0A**.BCPL.ca
ll.res.:#3D.sys(n,.x,.y,.#2E#2E#2E#2E)#2E.Arguments
.p.&.g.are.the#0A**.OCODE.stack-pointer.P.and.Globa
l.vector.pointer.G#2E.The.arguments#0A**.to.sys().a
re.n.#3D.p[3],.x.#3D.p[4].#2E#2E#2E#2E#0A**.sys(0,.
r).is.trapped.in.mlib#2Es#0A*/#0A#0ABCPLWORD.dosys(
register.BCPLWORD.*p,.register.BCPLWORD.*g)#0A{.reg
ister.BCPLWORD.i;#0A#0A//printf("dosys:.p[3]#3D%d.p
[4]#3D%d\n",.p[3],.p[4]);#0A..switch((int)(p[3]))#0A
..{.default:.printf("\nBad.sys.%ld\n",.(long)p[3]);
..return.p[3];#0A..#0A..../*#0A....case.Sys_setcoun
t:.set.count...............--.done.in.cinterp#0A...
.case.Sys_quit:.....return.from.interpreter.--.done
.in.cinterp#0A#0A....case.Sys_rti:......sys(Sys_rti
,.regs)......--.done.in.cinterp..Cintpos#0A....case
.Sys_saveregs:.sys(Sys_saveregs,.regs).--.done.in.c
interp..Cintpos#0A....case.Sys_setst:....sys(Sys_se
tst,.st)......--.done.in.cinterp..Cintpos#0A....cas
e.Sys_tracing:..//.sys(Sys_tracing,.b).#0A......tra
cing.#3D.p[4];#0A......return.0;#0A....case.Sys_wat
ch:....sys(Sys_watch,.addr)....--.done.in.cinterp#0A
#0A....case..Sys_tally:.........//.sys(Sys_tally,.f
lag).#0A......if(p[4]).{#0A........tallylim.#3D.tal
lyupb;#0A........for(i#3D1;.i<#3Dtallylim;.i++).tal
lyv[i].#3D.0;#0A......}.else.{#0A........tallylim.#3D
.0;#0A......}#0A......return.0;#0A.....#0A....case.
Sys_interpret:.//.call.interpreter.(recursively).#0A
....{.BCPLWORD.regsv.#3D.p[4];#0A......if(W[regsv+7
]<0).return.CINTASM..(regsv,.W);#0A......return.int
erpret(regsv,.W);#0A....}#0A....*/#0A#0A....case.Sy
s_sardch:#0A....{.BCPLWORD.ch;#0A....../*printf("pa
rmp#3D%d.parms[0]#3D%d\n",.parmp,.parms[0]);.*/#0A.
.....if(parmp<#3Dparms[0]).{../*.Added.MR.10/04/06.
*/#0A......../*.Read.the.command.arguments.(without
.echo).first#2E.*/#0A......../*printf("sardch:.parm
p#3D%d.parms[0]#3D%d\n",.parmp,.parms[0]);.*/#0A...
...../*printf("sardch:.returning.%d\n",.parms[parmp
]);.*/#0A........return.parms[parmp++];#0A......}#0A
......ch.#3D.Readch();#0A......if.(ttyinp).{../*.ec
ho.tty.input.only.*/#0A........if.(ch>#3D0).putchar
((char)ch);#0A........if(ch#3D#3D13).{.ch.#3D.10;.p
utchar(10);.}#0A........fflush(stdout);#0A......}#0A
......return.ch;#0A....}#0A#0A....case.Sys_sawrch:#0A
......if(p[4].#3D#3D.10).putchar(13);#0A......putch
ar((char)p[4]);#0A......fflush(stdout);#0A......ret
urn.0;#0A#0A....case.Sys_read:../*.bytesread.:#3D.s
ys(Sys_read,.fp,.buf,.bytecount).*/#0A....{.FILE.*f
p.#3D.findfp(p[4]);#0A......char.*bbuf.#3D.(char.*)
(p[5]<<B2Wsh);#0A......BCPLWORD.len...#3D.p[6];#0A.
.....len.#3D.fread(bbuf,.(size_t)1,.(size_t)len,.fp
);#0A......return.len;#0A....}#0A#0A....case.Sys_wr
ite:#0A....{.FILE.*fp.#3D.findfp(p[4]);#0A......cha
r.*bbuf.#3D.(char.*)(p[5]<<B2Wsh);#0A......BCPLWORD
.len.#3D.p[6];#0A......len.#3D.WD.fwrite(bbuf,.(siz
e_t)1,.(size_t)len,.fp);#0A......fflush(fp);#0A....
..return.len;#0A....}#0A#0A....case.Sys_openread:#0A
....{.char.*name.#3D.b2c_fname(p[4],.chbuf1);#0A...
...FILEPT.fp;#0A#23if.defined(forVmsItanium).||.def
ined(forVmsVax)#0A......name.#3D.vmsfname(name,.chb
uf4);#0A#23endif#0A#0A......fp.#3D.pathinput(name,.
.................../*.Filename.*/#0A...............
......b2c_str(p[5],.chbuf2));../*.Environment.varia
ble.*/#0A......if(fp#3D#3D0).return.0L;#0A......ret
urn.newfno(fp);#0A....}#0A#0A....case.Sys_openwrite
:#0A....{.char.*name.#3D.b2c_fname(p[4],.chbuf1);#0A
......FILEPT.fp;#0A#23if.defined(forVmsItanium).||.
defined(forVmsVax)#0A......name.#3D.vmsfname(name,.
chbuf4);#0A#23endif#0A#0A......fp.#3D.fopen(name,."
wb");#0A......if(fp#3D#3D0).return.0L;#0A......retu
rn.newfno(fp);#0A....}#0A#0A....case.Sys_openreadwr
ite:#0A....{.char.*name.#3D.b2c_fname(p[4],.chbuf1)
;#0A......FILEPT.fp;#0A#23if.defined(forVmsItanium)
.||.defined(forVmsVax)#0A......name.#3D.vmsfname(na
me,.chbuf4);#0A#23endif#0A#0A.......fp.#3D.fopen(na
me,."rb+");#0A......if(fp#3D#3D0).fp.#3D.fopen(name
,."wb+");#0A......if(fp#3D#3D0).return.0L;#0A......
return.newfno(fp);#0A....}#0A#0A....case.Sys_close:
#0A....{.BCPLWORD.res.#3D.!.fclose(findfp(p[4]));#0A
......freefno(p[4]);#0A......return.res;#0A....}#0A
#0A....case.Sys_deletefile:#0A....{.char.*name.#3D.
b2c_fname(p[4],.chbuf1);#0A......FILEPT.fp;#0A#23if
.defined(forVmsItanium).||.defined(forVmsVax)#0A...
...name.#3D.vmsfname(name,.chbuf4);#0A......{./*.Ap
pend.';*'.to.name.*/#0A........int.len.#3D.0;#0A...
.....while(name[len]).len++;#0A........name[len].#3D
.';';#0A........name[len].#3D.'*';#0A........name[l
en].#3D.0;#0A......}#0A#23endif#0A......return.!.RE
MOVE(name);#0A....}#0A#0A....case.Sys_renamefile:#0A
....{.char.*name1.#3D.b2c_fname(p[4],.chbuf1);#0A..
....char.*name2.#3D.b2c_fname(p[5],.chbuf2);#0A....
..int.len.#3D.0;#0A#23if.defined(forVmsItanium).||.
defined(forVmsVax)#0A......name1.#3D.vmsfname(name1
,.chbuf3);#0A......name2.#3D.vmsfname(name2,.chbuf4
);#0A......{./*.Append.';*'.to.name2.*/#0A........l
en.#3D.0;#0A........while(name2[len]).len++;#0A....
....name2[len].#3D.';';#0A........name2[len].#3D.'*
';#0A........name2[len].#3D.0;#0A......}#0A#23endif
#0A......REMOVE(name2);#0A#23if.defined(forVmsItani
um).||.defined(forVmsVax)#0A......name2[len].#3D.0;
#0A#23endif#0A......return.!.rename(name1,.name2);#0A
....}#0A#0A....case.Sys_getvec:#0A......return.((BC
PLWORD)(malloc((1+p[4])<<B2Wsh)))>>B2Wsh;#0A#0A....
case.Sys_freevec:#0A......free((void.*)(p[4]<<B2Wsh
));.return.-1;#0A/*#0A....case.Sys_loadseg:#0A.....
.return.loadseg(b2c_str(p[4],.chbuf1));#0A....case.
Sys_globin:#0A......return.globin(p[4],.g);#0A....c
ase.Sys_unloadseg:#0A......unloadseg(p[4]);........
............return.0;#0A*/#0A#0A....case.Sys_muldiv
:#0A....{.BCPLWORD.res.#3D..muldiv(p[4],.p[5],.p[6]
);#0A......g[Gn_result2].#3D.result2;#0A......retur
n.res;#0A....}#0A#0A....case.Sys_intflag:#0A......r
eturn.intflag().?.-1L.:.0L;#0A#0A/*#0A....case.Sys_
setraster:#0A......return.setraster(p[4],.p[5]);#0A
*/#0A#0A....case.Sys_cputime:./*.Return.CPU.time.in
.milliseconds..*/#0A......return.muldiv(clock(),.10
00,.1000);./*TICKS_PER_SEC);*/#0A#0A....case.Sys_fi
lemodtime:./*.Return.time.of.last.modification.of.f
ile#0A.............................whose.name.is.in
.p[4]..*/#0A....{.struct.stat.buf;#0A......char.*na
me.#3D.b2c_fname(p[4],.chbuf1);#0A......FILEPT.fp;#0A
#23if.defined(forVmsItanium).||.defined(forVmsVax)#0A
......name.#3D.vmsfname(name,.chbuf4);#0A#23endif#0A
......if.(stat(name,.&buf)).return.0;#0A......retur
n.buf#2Est_mtime;#0A....}#0A#0A....case.Sys_setpref
ix:./*.Set.the.file.prefix.string..*/#0A......prefi
x.#3D.p[4];#0A......return.prefix;#0A#0A....case.Sy
s_getprefix:./*.Return.the.file.prefix.string..*/#0A
......return.prefix;#0A#0A....case.Sys_graphics:./*
.Perform.an.operation.on.the.graphics.window..*/#0A
......return.sysGraphics(p);#0A#0A....case.Sys_seek
:../*.res.:#3D.seek(fd,.pos)...*/#0A....{.FILEPT.fp
.#3D.findfp(p[4]);#0A......BCPLWORD.pos.#3D.p[5];#0A
......BCPLWORD.res.#3D.fseek(fp,.pos,.SEEK_SET);#0A
....../*printf("fseek.#3D>.res#3D%d.errno#3D%d\n",.
res,.errno);.*/#0A....../*g[Gn_result2].#3D.errno;.
*/#0A......return.res#3D#3D0.?.-1.:.0;./*.res#3D0.s
ucc,.res#3D.-1.error..*/#0A....}#0A#0A....case.Sys_
tell:./*.pos.:#3D.sys(Sys_tell,fd)..*/#0A....{.FILE
.*fp.#3D.findfp(p[4]);#0A......BCPLWORD.pos.#3D.fte
ll(fp);#0A....../*g[Gn_result2].#3D.errno;.*/#0A...
...return.pos;./*.>#3D0.succ,.-1#3Derror.*/#0A....}
#0A#0A....case.Sys_waitirq:./*.Wait.for.irq.*/#0A..
..../*#0A......pthread_mutex_lock..(.........&irq_m
utex);#0A......pthread_cond_wait...(&irq_cv,.&irq_m
utex);#0A......pthread_mutex_unlock(.........&irq_m
utex);#0A......*/#0A......return.0;#0A#0A....case.S
ys_lockirq:./*.Stop.all.devices.from.modifying.*/#0A
....................../*.packets.or.generating.inte
rrupts.*/#0A....../*#0A......pthread_mutex_lock(&ir
q_mutex);#0A......*/#0A......return.0;#0A#0A....cas
e.Sys_unlockirq:./*.Allow.devices.to.modify.packets
.*/#0A......................../*.and.generate.inter
rput.*/#0A....../*#0A......pthread_mutex_unlock(&ir
q_mutex);#0A......*/#0A......return.0;#0A#0A.....ca
se.Sys_devcom:./*.res.:#3D.sys(Sys_devcom,.com,.arg
).*/#0A.......return.0;./*devcommand(W[p+4],.W[p+5]
,.W[p+6]);.*/#0A#0A.....case.Sys_ftime:./*.return.r
esult.of.calling.ftime.*/#0A.....{.struct.timeb.tb;
#0A.......BCPLWORD.*v.#3D.(BCPLWORD*)(p[4]<<2);#0A.
......int.daylight#3D0;#0A.......int.timezone#3D0;#0A
.......ftime(&tb);#0A....#0A#0A......./*.**********
******.BEWARE.************************.*/#0A.......
/*.The.date.will.OVERFLOW.on.19-Jan-2038.at.3:14:07
.*/#0A.......v[0].#3D.0;./*(BCPLWORD)(tb#2Etime>>32
);.*/#0A.......v[1].#3D.(BCPLWORD)tb#2Etime;../*.Se
conds.since.epoch.*/#0A.......v[2].#3D.tb#2Emillitm
;...../*.milli-seconds.*/#0A......./*v[3].#3D.tb#2E
timezone;*/..../*.Minutes.west.of.Greenwich.*/#0A..
...../*v[4].#3D.tb#2Edstflag;.*/..../*.non.zero.#3D
>.Daylight.saving.time#0A..........................
.......applies.*/#0A#0A.......daylight.#3D.1;......
..../*.Fudge.for.windows.*/#0A.......daylight.#3D.0
;........../*.Fudge.for.windows.MR.31/10/03.*/#0A..
...../*tzset();*/.............../*.Should.be.done.s
eparately.*/#0A......./*#0A.......printf("cintpos:.
timezone#3D%d.daylight#3D%d.%s.%s\n",#0A...........
....(BCPLWORD)timezone,(BCPLWORD)daylight,.tzname[0
],#0A#09.......tzname[1]);#0A.......*/#0A.......if(
((BCPLWORD)timezone)%3600#3D#3D0)./*.Fudge.for.wind
ows.*/#0A.........v[1].-#3D.(BCPLWORD)timezone;....
/*.Correct.for.timezone.*/#0A.......if.(daylight)#0A
.........v[1].+#3D.60*60;............./*.Add.one.ho
ur.in.DST.*/#0A.......v[1].+#3D.rootnode[Rtn_adjclo
ck].*.60;./*.Add.adjustment.*/#0A.......return.-1;#0A
.....}#0A#0A.....case.Sys_usleep:./*.usleep.for.som
e.micro-seconds.*/#0A.......return.0;./*usleep(p[4]
);..*/#0A..............#0A.....case.Sys_filesize:..
/*.res.:#3D.sys(Sys_filesize,.fd)...*/#0A.....{.FIL
E.*fp...#3D.findfp(p[4]);#0A.......BCPLWORD.pos..#3D
.ftell(fp);#0A.......BCPLWORD.rc...#3D.fseek(fp,.0,
.SEEK_END);#0A.......BCPLWORD.size.#3D.ftell(fp);#0A
.......rc..#3D.fseek(fp,.pos,.SEEK_SET);#0A.......i
f.(rc).size.#3D.-1;#0A.......return.size;./*.>#3D0.
succ,.-1#3Derror..*/#0A.....}#0A#0A.....case.Sys_ge
tsysval:./*.res.:#3D.sys(Sys_getsysval,.addr).*/#0A
.....{.BCPLWORD.*addr.#3D.(BCPLWORD*)p[4];#0A......
.return.*addr;#0A.....}#0A#0A.....case.Sys_putsysva
l:./*.res.:#3D.sys(Sys_putsysval,.addr,.val).*/#0A.
....{.BCPLWORD.*addr.#3D.(BCPLWORD*)p[4];#0A.......
*addr.#3D.p[5];#0A.......return.0;#0A.....}#0A#0A..
...case.Sys_shellcom:./*.res.:#3D.sys(Sys_shellcom,
.comstr).*/#0A.....{.char.*comstr.#3D.(char*)(p[4]<
<2);#0A.......int.i;#0A.......char.com[256];#0A....
...int.len.#3D.strlen(comstr);#0A.......for(i#3D0;.
i<len;.i++).com[i].#3D.comstr[i+1];#0A.......com[le
n].#3D.0;#0A......./*#0A.......printf("\ndosys:.cal
ling.shell.command.%s\n",.com);#0A.......*/#0A.....
..return.system(com);#0A.....}#0A#0A.....case.Sys_g
etpid:./*.res.:#3D.sys(Sys_getpid).*/#0A.......retu
rn.0;.//getpid();#0A#0A.....case.Sys_dumpmem:./*.sy
s(Sys_dumpmem,.context).*/#0A.......printf("\nCintp
os.memory.not.dumped.to.DUMP#2Emem\n");#0A.......re
turn.0;#0A#0A.....case.Sys_callnative:#0A.....{./*.
Call.native.code#2E.*/#0A.......int(*rasmfn)(void).
#3D.(int(*)(void))&p[4];#0A.......return.rasmfn();#0A
.....}..............#0A#0A.....case.135:./*.Return.
system.date.and.time.in.VEC.5.*/#0A.....{.time_t.cl
k.#3D.time(0);#0A.......struct.tm.*now.#3D.gmtime(&
clk);#0A.......BCPLWORD.*arg.#3D.PT(p[4].<<.B2Wsh);
#0A.......arg[0].#3D.now->tm_year+1900;#0A.......ar
g[1].#3D.now->tm_mon+1;#0A.......arg[2].#3D.now->tm
_mday;#0A.......arg[3].#3D.now->tm_hour;#0A.......a
rg[4].#3D.now->tm_min;#0A.......arg[5].#3D.now->tm_
sec;#0A.......return.0;#0A.....}#0A#0A.....case.136
:./*.Return.current.directory.in.VEC.1.+.256/bytesp
erword.*/#0A.....{.//getcwd(chbuf1,.256);#0A.......
//c2b_str(chbuf1,.p[4]);#0A.......return.0;#0A.....
}#0A#0A....case.137:#0A......return.(BCPLWORD)parms
.>>.B2Wsh;#0A..}#0A}.#0A#0Achar.*vmsfname(char.*nam
e,.char.*vmsname).{#0A/*#0AThis.function.converts.a
.BCPL.filename.to.a.VMS.filename#0AExamples:#0A#0AN
ame.........................VMS.name#0A#0Aecho#2Eb.
......................echo#2Eb#0Acom/echo#2Eb......
.............[#2Ecom]echo#2Eb#0A/mrich177/distribut
ion/bcpl#2Eg/libhdr#2Eh#0A.........................
....[mrich177#2Edistribution#2Ebcpl#2Eg]libhdr#2Eh#0A
vd10$disk:/mrich177/junk#2Eb...vd10$disk:[mrich177]
junk#2Eb#0A#2E#2E/cintcode/com/bcplfe#2Eb.....[-#2E
cintcode#2Ecom]bcplfe#2Eb#0A*/#0A..int.ch,.i#3D0,.j
#3D0,.len#3D0,.lastslashpos#3D.-1;#0A../*.If.name.c
ontains.a.colon,.copy.all#0A.....characters.up.to.a
nd.including.the.colon#2E#0A..*/#0A..while.(1).{#0A
....int.ch.#3D.name[i];#0A....if.(ch#3D#3D0).break;
./*.No.colon.in.name.*/#0A....if.(ch#3D#3D':').{#0A
....../*.Copy.up.to.and.including.the.colon.*/#0A..
....while.(len<#3Di).{.vmsname[len].#3D.name[len];.
len++;.}#0A......j.#3D.len;#0A......break;#0A....}#0A
....i++;#0A..}#0A../*.Find.position.of.last.slash,.
if.any.*/#0A..while.(1).{#0A....int.ch.#3D.name[j];
#0A....if(ch#3D#3D0).break;#0A....if(ch#3D#3D'/').l
astslashpos.#3D.j;#0A....j++;#0A..}#0A#0A../*.No.sl
ashes..#3D>.nothing#0A.....Leading./...#3D>.[#0A...
..Slashes.but.no.leading.slash.so.insert.[#2E.or.[-
#0A#0A.....name.is.then.copied.converting.all.slash
es.except.the.leading#0A.....and.last.ones.to.dots,
.and.converting.the.last.slash.to.]#2E#0A..*/#0A..j
.#3D.i;#0A..if(name[j]#3D#3D'/').{#0A..../*.if.lead
ing.slash.but.not.the.last.convert.it.to.[.*/#0A...
.if.(j!#3Dlastslashpos).vmsname[len++].#3D.'[';#0A.
...j++;#0A..}.else.{#0A....if.(lastslashpos>#3D0).{
#0A....../*.Slashes.but.no.leading.slash,.so.insert
.[#2E.or.[-..*/#0A......vmsname[len++].#3D.'[';#0A.
.....if(name[j]!#3D'#2E'.||.name[j+1]!#3D'#2E').{#0A
........vmsname[len++].#3D.'#2E';#0A......}#0A....}
#0A..}#0A#0A..while.(1).{#0A..../*.Replace.last./.b
y.]#0A.......and.non.last./.by.#2E#0A.......and.#2E
#2E.by.-#0A....*/#0A....int.ch.#3D.name[j];#0A....i
f(ch#3D#3D'#2E'.&&.name[j+1]#3D#3D'#2E').{#0A......
/*.Convert.#2E#2E.to.-.*/#0A......ch.#3D.'-';#0A...
...j++;#0A....}#0A....if(ch#3D#3D'/').{#0A......if.
(j#3D#3Dlastslashpos).ch.#3D.']';#0A......else.....
............ch.#3D.'#2E';#0A....}#0A....vmsname[len
++].#3D.ch;#0A....if(ch#3D#3D0).break;#0A....j++;#0A
..}#0A..return.vmsname;#0A}#0A#0A/*.b2c_fname.conve
rts.the.BCPL.string.for.a.file.name.to.a.C.characte
r#0A**.string#2E..The.character.'/'.(or.'\').is.tre
ated.as.a.separator.and.is#0A**.converted.to.FILE_S
EP_CH.('/'.for.unix,.'\'.for.MSDOS.or.':'.for.MAC)#2E
#0A**.If.prefix.is.set.and.the.filename.is.relative
,.the.prefix.is.prepended#2E#0A*/#0Achar.*b2c_fname
(BCPLWORD.bstr,.char.*.cstr)#0A{..char.*bp.#3D.(cha
r*)(bstr<<2);#0A...int.len;#0A...int.i#3D0;#0A...if
.(bstr#3D#3D0).return.0;./*.No.path.given.*/#0A...l
en.#3D.*bp++;#0A...if.(prefix.&&.relfilename((char*
)bstr))#0A...{./*.Prepend.the.filename.with.prefix.
*/#0A.....char.*pfxp.#3D.(char*)(prefix<<2);#0A....
.int.pfxlen.#3D.*pfxp++;#0A.....while(pfxlen--)#0A.
....{.char.ch.#3D.*pfxp++;#0A.......if(ch#3D#3D'/'.
||.ch#3D#3D'\\'.||.ch#3D#3D':').ch.#3D.FILE_SEP_CH;
#0A.......cstr[i++].#3D.ch;#0A.....}#0A.....if.(cst
r[i-1].!#3D.FILE_SEP_CH).cstr[i++].#3D.FILE_SEP_CH;
#0A...}#0A#0A...while.(len--)#0A...{.char.ch.#3D.*b
p++;#0A.....if(ch#3D#3D'/'.||.ch#3D#3D'\\'.||.ch#3D
#3D':').ch.#3D.FILE_SEP_CH;#0A.....cstr[i++].#3D.ch
;#0A...}#0A...cstr[i].#3D.0;#0A.../*if.(prefix).pri
ntfs("filename.#3D.%s\n",.cstr);.*/#0A.../*printfs(
"b2c_fname:.cstr.#3D.%s\n",.cstr);.*/#0A...return.c
str;#0A}#0A#0A/*.b2c_str.converts.the.BCPL.string.f
or.a.file.name.to.a.C.character#0A**.string#2E..The
.character.'/'.(or.'\').is.treated.as.a.separator.a
nd.is#0A**.converted.to.FILE_SEP_CH.('/'.for.unix,.
'\'.for.MSDOS.or.':'.for.MAC)#0A*/#0Achar.*b2c_str(
BCPLWORD.bstr,.char.*.cstr)#0A{..char.*bp,.i,.len;#0A
...if.(bstr#3D#3D0).return.0;#0A...bp.#3D.(char.*)(
bstr<<B2Wsh);#0A...len.#3D.*bp++;#0A...for(i.#3D.0;
.i<len;.i++)#0A...{.char.ch.#3D.*bp++;#0A.....if(ch
#3D#3D'/'.||.ch#3D#3D'\\').ch.#3D.FILE_SEP_CH;#0A..
...cstr[i].#3D.ch;#0A...}#0A...cstr[len].#3D.0;#0A.
..return.cstr;#0A}.#0A#0A/*#0A**.c2b_str.converts.a
.C.string.into.a.BCPL.string#0A*/#0ABCPLWORD.c2b_st
r(char.*cstr,.BCPLWORD.bstr).{#0A..char.*bp.#3D.(ch
ar.*)(bstr.<<.B2Wsh);#0A..int.len.#3D.0;#0A..while.
(cstr[len]).{#0A....bp[len+1].#3D.cstr[len];#0A....
..++len;#0A..}#0A..bp[0].#3D.len;#0A..return.bstr;#0A
}#0A

######natbcpl/vax/mlib.mar#
;.Mlib.for.the.VAX.under.VMS.--.Under.development#0A
#0A;.Implemented.by.Martin.Richards.(c).7.September
.2009#0A#09#0A;.C.Linkage.on.the.Vax:#0A;...On.entr
y.0(SP)...is.the.return.address#0A;............4(AP
)...is.the.first.argument#0A;............8(AP)...is
.the.second.argument#0A;............etc#0A;#0A;...r
2-r11.must.be.preserved#0A;#0A;...return.using.RET#0A
;...result.in.R0#0A#0A.#2Epsect.MLIB,LONG#0A#0A;#09
#2EALIGN.4#0A#0A........#2Eentry.callstart,^M<r2,r3
,r4,r5,r6,r7,r8,r9,r10,r11>#0A#0A.MOVL.4(AP),R10...
.;.M/C.address.of.P#0A.MOVL.8(AP),R11....;.M/C.addr
ess.of.G#0A#0A;.Register.usage.while.executing.BCPL
.compiled.code#0A#0A;.R11...The.G.pointer#0A;.R10..
.The.P.pointer#0A;.R9....#3D.zero#0A;.R8....A..Firs
t.argument.at.a.function.call#0A;.R7....B#0A;.R6...
.C#0A;.R2....entry.address.at.call#0A;.R1....The.ne
w.P.pointer.at.function.call#0A#0A...clrl.r9#0A#0A.
..;.make.sure.global.3.(sys).is.defined#0A...MOVAL.
sys,.4*3(R11)#0A...;.make.sure.global.6.(changeco).
is.defined#0A...MOVAL.changeco,.4*6(R11)#0A...;.mak
e.sure.global.5.(muldiv).is.defined#0A...MOVAL.muld
iv,.4*5(R11)#0A#0A...;.BCPL.call.of.clihook(stackup
b)#0A...MOVL.stackupb,R8#0A...MOVL.R10,R1.........;
.Set.the.new.P.pointer#0A...MOVL.4*4(R11),R2....;.c
lihook#0A...JSB..(R2)#0A;movl.r2,r8#0A...MOVL.R8,R0
....;.return.the.result.of.start#0A#0A;.and.then.re
turn#0A...RET#0A#0A;...#09#2EALIGN.LONG#0A#0A...;.r
es.#3D.sys(n,.x,.y,.z)..the.BCPL.callable.sys.funct
ion#0A.#2Elong.^X0000DFDF#0A.#2Elong.^X7379730B#0A.
#2Elong.^X20202020#0A.#2Elong.^X20202020#0Asys:#0A.
MOVL..R10,(R1).....;.save.old.P#0A.MOVL..R1,R10....
...;.P.:#3D.<new.P>#0A.MOVL..(SP)+,4(R10).;.save.<r
eturn.address>#0A.MOVL..R2,8(R10)....;.Save.<entry.
address>#0A.MOVL..R8,12(R10)..;.Save.<first.arg>#0A
#0A.PUSHL.R11#0A.PUSHL.R10#0A.CALLS.#232,dosys...;.
calling.dosys(p,.g)#0A.MOVL..R0,R8........;.put.res
ult.in.Cintcode.A.register#0A#0A.MOVL..4(R10),R2...
.;.Get.<return.address>#0A.MOVL..(R10),R10....;.P.:
#3D.<old.P>#0A.JMP...(R2).........;.Jump.to.<return
.address>#0A#0A;.res.:#3D.changeco(val,.cptr)#0A.#2E
long.^X0000DFDF#0A.#2Elong.^X6168630B#0A.#2Elong.^X
6365676E#0A.#2Elong.^X2020206F#0Achangeco:#0A.MOVL.
R10,0(R1)...;.NP!0.:#3D.P#0A.POPL.R3..........;.R3.
#3D.<return.address>#0A.MOVL.R3,4(R1)....;.NP!1..:#3D
.return.address#0A.MOVL.R2,8(R1)....;.NP!2..:#3D.en
try.address#0A.MOVL.R8,12(R1)...;.NP!3..:#3D.arg1#0A
#0A.MOVL.4*7(R11),R2...;.R2.:#3D.currco#0A.MOVL.R10
,(R9)[R2]..;.!currco.:#3D.<old.P>#0A.MOVL.16(R1),R4
.....;.R4.:#3D.cptr#0A.MOVL.R4,4*7(R11)...;.currco.
:#3D.cptr#0A.MOVL.(R9)[R4],R10..;.R10.:#3D.!cptr#0A
.JMP.(R3)#0A#0A;.res,.result2.:#3D.muldiv(a,.b,.c)#0A
.#2Ealign.long#0A.#2Elong.^X0000DFDF#0A.#2Elong.^X6
C756D0B#0A.#2Elong.^X20766964#0A.#2Elong.^X20202020
#0Amuldiv:#0A.MOVL.R10,(R1)......;.Save.<old.P>#0A.
MOVL.R1,R10........;.R10.:#3D.<new.P>#0A.MOVL.(SP)+
,4(R10)..;.Save.<return.address>#0A.MOVL.R2,8(R10).
....;.Save.<entry.address>#0A.MOVL.R8,12(R10)....;.
Save.first.arg...#0A#0A.MOVL.4(R10),R7#0A.MOVL.8(R1
0),R6#0A.EMUL.R8,R7,#230,R4...;.R8.*.R7.#3D>.R4,.R5
#0A.EDIV.R6,R4,R8,4*10(R11)..;.(R4,R5)/R6.#3D>.R8,.
rem->result2#0A#0A.MOVL.4(R10),R2.....;.R2.:#3D.<re
turn.address>#0A.MOVL.(R10),R10.....;.R10.:#3D.<old
.P;#0A.JMP.(R2)...........;.Jump.to.<return.address
>#0A#0A.#2EEND#0A

######+#



------_=_NextPart_001_01CA41C5.8645FCBE
Content-Type: text/html;
	charset="iso-8859-1"
Content-Transfer-Encoding: quoted-printable

<HTML dir=3Dltr><HEAD><TITLE>files1-x</TITLE>=0A=
<META http-equiv=3DContent-Type content=3D"text/html; charset=3Dunicode">=0A=
<META content=3D"MSHTML 6.00.6000.16890" name=3DGENERATOR></HEAD>=0A=
<BODY>=0A=
<DIV id=3DidOWAReplyText66981 dir=3Dltr>=0A=
<DIV dir=3Dltr><FONT face=3DArial color=3D#000000 =
size=3D2></FONT>&nbsp;</DIV></DIV>=0A=
<DIV dir=3Dltr><BR>=0A=
<HR tabIndex=3D-1>=0A=
<FONT face=3DTahoma size=3D2><B>From:</B> mrich177@nepcsa.niehl.ford.com =
[mailto:mrich177@nepcsa.niehl.ford.com]<BR><B>Sent:</B> Wed 30/09/2009 =
13:56<BR><B>To:</B> Richards, Martin (M.)<BR><B>Subject:</B> =
files1-x<BR></FONT><BR></DIV>=0A=
<DIV><BR>=0A=
<P><FONT =
size=3D2>######cintcode/com/bcplfe.b#<BR>//.This.is.the.BCPL.syntax.analy=
ser#0A#0A//.Impleme<BR>nted.by.Martin.Richards.(c).May.2009#0A#0A#0A/*.Ch=
a<BR>nge.history#0A#0A10/07/09#0AStopped.'#2E'.terminati<BR>ng.GET.stream=
s.so.that.GET.streams.can.contain#0Ase<BR>veral.sections.separated.by.dot=
s#2E.BEWARE:.this.is<BR>.an.incompatible#0Achange,.since.the.first.sectio=
n.<BR>of.a.GET.stream.has.in.the.past.been#0Aused.as.a.he<BR>ader#2E#0ARe=
-organised.the.compiler.into.g/bcplfecg<BR>#2Eh,.bcplfe#2Eb.and.bcplcgcin=
#2Eb,#0Aand.reallocat<BR>ing.most.of.the.compiler.globals#2E#0A#0A08/05/0=
9#0A<BR>Increased.the.default.treesize.to.200000#2E#0A#0A03<BR>/07/07#0AM=
odified.the.treatment.of.*#23.escapes.in.<BR>string.and.character.constan=
ts#0Ato.allow.both.UTF8<BR>.and.GB2312.encoding#2E.Added.compiler.options=
.UTF8<BR>#0Aand.GB2312.to.set.the.default.encoding#2E.*#23U.<BR>and.*#23G=
.in.a.string.and#0Acharacter.constant.temp<BR>orarily.set.the.encoding.to=
.UTF8.and.GB2312,#0Aresp<BR>ectively,.overriding.the.default.setting#2E.I=
n.GB23<BR>12.mode,.*#23dddd#0Acontains.up.to.4.decimal.digits<BR>#2E.See.=
the.BCPL.manual#2E#0A#0A27/06/07#0AAdded.th<BR>e.Unicode.escape.sequences=
.*#23hhhh.and.*#23#23hhhh<BR>hhhh.to.string#0Aand.character.constants#2E.=
Within.<BR>string.they.are.converted.to.the#0Acorresponding.UT<BR>F8.sequ=
ence.of.bytes.and.within.a.character.constan<BR>t#0Athey.yield.the.corres=
ponding.Unicode.integer#2E<BR>.See.the.last.few.tests#0Ain.com/cmpltest#2=
Eb#0A#0A<BR>27/07/06#0AChanged.the.implementation.of.the.GET.di<BR>rectiv=
e.to.make.it.system#0Aindependent#2E.Performg<BR>et.now.obtains.the.heade=
rs.environment.variable#0Af<BR>rom.the.root.node.(rootnode!rtn_hdrsvar).t=
his.is.no<BR>rmally.either#0A"BCPLHDRS".or."POSHDRS"#2E.If.the.h<BR>eader=
.file.does.not.end.in.#2Eh.or.#2Eb,#0A#2Eh.is.<BR>appended#2E.The.search.=
order.is.as.follows:#0A#0A(1<BR>).The.current.directory#2E#0A(2).The.dire=
ctories.sp<BR>ecified.by.the.headers.environment.variable,#0A....<BR>if.s=
et#2E#0A(3).The.subdirectory.g/.of.the.root.spe<BR>cified.by.the.environm=
ent#0A....variable.rootnode!r<BR>tn_rootvar,.if.set#2E#0A#0A05/04/06#0AMe=
nded.a.bug.<BR>in.trans.concerning.the.tranlation.of.SKIP#2E#0A#0A<BR>18/=
01/06#0ABased.on.Dave.Lewis's.suggestion,#0Ain.o<BR>utputsection(),.add:#=
0A...IF.objline1%0.DO.writef("<BR>%s*n",.objline1)#0Awhere.objline1.is.th=
e.first.line<BR>.of.file.objline1.if.it.can.be.found#0Ain.the.curre<BR>nt=
.directory.or.in.the.HDRS.directory#2E.This.will.<BR>typically#0Aput.a.li=
ne.such.as:#0A#23!/usr/local/bi<BR>n/cintsys.-c#0Aas.the.first.line.of.th=
e.compiled.ob<BR>ject.module#2E.This.line.is.ignored#0Aby.the.CLI.bu<BR>t=
.may.be.useful.under.Linux#2E.If.objline1.cannot.b<BR>e.found#0Ano.such.l=
ine.is.inserted.at.the.start.of.<BR>the.object.module#2E#0A#0A30/8/05#0AD=
efined.the.fun<BR>ction.default_hdrs().near.the.start.to.allow.easy.c<BR>=
hange#0Afrom.cintsys.to.cintpos.versions.of.the.com<BR>piler#2E#0A.#0A22/=
6/05#0AAdded.the.empty.command.SK<BR>IP.and.let.empty.blocks.be.equivalen=
t.to#0ASKIP#2E.<BR>Empty.section.brackets.are.now.also.allowed.after.M<BR=
>ANIFEST,#0ASTATIC.and.GLOBAL#2E..These.changes.make<BR>.program.developm=
ent.marginally#0Aeasier#2E#0A#0A17<BR>/6/04#0AMade.GET.first.look.in.the.=
current.director<BR>y#2E#0AAdded.argument.HDRS.to.allow.the.environment<B=
R>.variable.specifying#0Athe.headers.directory.to.be.<BR>changed#2E.The.d=
efault.is.BCPLHDRS#2E#0A#0A23/4/04#0A<BR>Update.the.standard.BCPL.compile=
r.with.all.the.Cint<BR>pos.extensions#0Aincluding.cross.referencing.and.1=
1<BR>.character.names#2E#0AMake.GET.directives.use.the.B<BR>CPLHDRS.envir=
onment.variable#2E#0A#0A11/6/02#0AChan<BR>ged.square.brackets.to.mean.sub=
scription.with.same.<BR>precedence#0Aand.function.calls#2E#0A#0A18/3/02#0=
AU<BR>se.HDRPATH.and.BCPLPATH.in.GET.directives#2E#0A#0A1<BR>4/1/02#0AAdd=
ed.XREF.option.to.output.name.informati<BR>on.during.compilation#2E#0A#0A=
11/7/01#0AAdded.langu<BR>age.extensions.for.the.Ford.dialect.of.BCPL#2E#0=
Ai#2E<BR>e#2E.modified.performget#0A.....added.SLCT.and.OF.(<BR>also.::)#=
0A.....added.||.comments#0A.....treesize.s<BR>et.to.100000#0A#0A15/1/01#0=
AComplain.if.global.numb<BR>er.is.larger.than.65535#2E#0A#0A10/8/00#0ACha=
nge.th<BR>e.maximum.number.of.error.messages.from.30.to.10#2E<BR>#0A#0A14=
/12/99#0AMade./.*.#2E#2E#2E.*./..comments.n<BR>est#2E#0AAllow.the.constan=
ts.in.MANIFEST,.STATIC.an<BR>d.GLOBAL.declarations.#0Ato.be.optional#2E.I=
f.absen<BR>t.the.value.is.one.greater.than.the#0Aprevious.valu<BR>e#2E.Un=
less.specified.the.first.value.is.zero,.so#0A<BR>MANIFEST.{.a;.b#3D10;.c.=
}.declares.a,.b.and.c.to.be<BR>.0,.10.and.11,#0Arespectively#2E#0A#0A9/6/=
99#0AMade<BR>.changes.to.buffer.OCODE.in.memory#2E.When.bcpl.is.<BR>calle=
d#0Awithout.the.TO.argument.it.writes.numeric.<BR>ocode.to.the.file.ocode=
#2E#0ALex.treats.CR.(13).cor<BR>rectly.to.improve.convenience.when.runnin=
g#0Aunder.<BR>Windows.and.WindowsCE#2E#0A#0A26/2/99#0AAdded.BIN.o<BR>ptio=
n.to.the.compiler.to.generate.a.binary.(rather.<BR>than#0Ahex).hunk.forma=
t.for.the.compiled.code#2E.Th<BR>is.is.primarily.for.the#0AWindows.CE.ver=
sion.of.the<BR>.cintcode.system.where.compactness.is#0Aparticularl<BR>y.i=
mportant#2E.There.is.a.related.change.to.loadseg<BR>.in#0Acintmain#2Ec#0A=
#0A17/11/98#0AChanged.the.work<BR>spacesize.to.40000.and.added.the.SIZE.k=
eyword#0Ato.<BR>allow.the.user.to.specify.this.size#2E#0A#0A9/11/98<BR>#0=
AMade.GET.directives.search.the.current.working.d<BR>irectory#0Athen.dire=
ctories.given.by.the.shell.vari<BR>able.BCPLPATH,.if.set#2E#0AIt.uses.the=
.BLIB.functio<BR>n.pathfindinput#2E#0A#0A15/12/96#0ACorrect.a.bug.in<BR>.=
cellwithname#0A#0A16/8/96#0AAdded.one.line.to.read<BR>number.to.allow.und=
erscores.in.numbers.after.#0Athe<BR>.first.digit#2E#0A#0A7/6/96#0AImpleme=
nt.the.method.<BR>application.operator.for.object.oriented#0Aprogramm<BR>=
ing.in.BCPL#2E.E.#23.(E1,.E2,#2E#2E#2E,.En).is.equi<BR>valent.to#0A((!E1)=
!E)(E1,.E2,#2E#2E#2E,.En)#0A#0A24<BR>/12/95#0AImproved.the.efficiency.of.=
cellwithname.in<BR>.TRN.(using.the.hash.chain#0Alink.in.name.node)#2E#0A<=
BR>Improved.the.efficiency.of.outputsection.in.CG.by.i<BR>ntroducing#0Awr=
hex2.and.wrword_at#2E#0A#0A24/7/95#0A<BR>Removed.bug.in.atbinfo,.define.a=
ddinfo_b.change.som<BR>e.global.numbers#2E#0AImplement.constant.folding.i=
n<BR>.TRN#2E#0A#0A13/7/95#0AAllowed.{.and.}.to.represent<BR>.untagged.sec=
tion.brackets#2E#0A#0A22/6/93#0ARevers<BR>e.order.in.SWB.and.have.a.minim=
um.of.7.cases#0Ato.a<BR>llow.faster.interpreter#2E#0A#0A2/6/93#0AChanged.=
co<BR>de.for.SWB.to.use.heap-like.binary.tree#2E#0A#0A19/<BR>5/93#0APut.i=
n.code.to.compile.BTC.and.XPBYT.instruc<BR>tions#2E#0A#0A23/4/93#0AAllowe=
d.the.codegenerator.t<BR>o.compiler.the.S.instruction#2E#0A#0A21/12/92#0A=
Cur<BR>ed.bug.in.compilation.of.(b.-&gt;.f,.g)(1,2,3)#0A#0A24<BR>/11/92.#=
0ACured.bug.in.compilation.of.a,.b.:#3D.s%0<BR>.&gt;.0,.s%1.#3D.'!'#0A#0A=
23/7/92:#0ARenamed.nextlab.a<BR>s.newlab,.load.as.loadval.in.the.CG#2E#0A=
Put.back.s<BR>impler.hashing.function.in.lookupword#2E#0ARemoved.<BR>rdar=
gs.fudge#2E#0ARemoved.S2.compiler.option#2E#0AC<BR>ured.bug.concerning.th=
e.closing.of.gostream.when.eq<BR>ual.to.stdout#2E#0A*/#0A#0ASECTION."BCPL=
"#0A#0AGET.<BR>"libhdr"#0AGET."bcplfecg"#0A.#0ALET.default_hdrs().<BR>#3D=
.VALOF.//.Changed.MR.12/07/09#0A{.LET.hdrs.#3D.r<BR>ootnode!rtn_hdrsvar./=
/.Typically."BCPLHDRS".or."POS<BR>HDRS".or.0#0A..IF.hdrs.RESULTIS.hdrs#0A=
..RESULTIS."<BR>BCPLHDRS"#0A}#0A.#0AGLOBAL.{#0A//.Globals.used.in.L<BR>EX=
#0Achbuf:feg#0Adecval;.getstreams;.charv#0Ahdrs..<BR>//.MR.10/7/04#0A#0Aw=
orkvec#0Areadnumber;.rdstrch#0A<BR>token;.wordnode;.ch#0Ardtag;.performge=
t#0Alex;.dsw;<BR>.declsyswords;.nlpending#0Alookupword;.rch#0Asource<BR>n=
amev;.sourcefileno;.sourcefileupb#0Askiptag;.wrchb<BR>uf;.chcount;.lineno=
#0Anulltag;.rec_p;.rec_l#0A.#0A/<BR>/.Globals.used.in.SYN#0Ardblockbody;.=
.rdsect#0Arnam<BR>elist;.rname#0Ardef;.rcom#0Ardcdefs#0Aformtree;.syn<BR>=
err;.opname#0Arexplist;.rdseq#0Amk1;.mk2;.mk3#0Amk4<BR>;.mk5;.mk6;.mk7#0A=
newvec#0Arnexp;.rexp;.rbexp#0A}#0A<BR>.#0A.#0AMANIFEST.{#0Ac_backspace.#3=
D..8#0Ac_tab....<BR>...#3D..9#0Ac_newline...#3D.10#0Ac_newpage...#3D.12<B=
R>#0Ac_return....#3D.13#0Ac_escape....#3D.27#0Ac_spac<BR>e.....#3D.32#0A}=
#0A#0ALET.start().#3D.VALOF#0A{.LET<BR>.treesize.#3D.0#0A..AND.argv.#3D.V=
EC.50#0A..AND.arg<BR>form.#3D."FROM/A,TO/K,VER/K,SIZE/K/N,TREE/S,NONAMES<=
BR>/S,*#0A................*D1/S,D2/S,OENDER/S,EQCASES/<BR>S,BIN/S,XREF/S,=
GDEFS/S,HDRS/K,*#0A................*<BR>GB2312/S,UTF8/S,SAVESIZE/K/N"#0A.=
.LET.stdout.#3D.ou<BR>tput()#0A..LET.objline1vec.#3D.VEC.256/bytesperword=
<BR>#0A..objline1.:#3D.objline1vec#0A..objline1%0.:#3D.<BR>0#0A..errmax..=
.:#3D.10#0A..errcount.:#3D.0#0A..fin_<BR>p,.fin_l.:#3D.level(),.fin#0A#0A=
..treevec......:#3D<BR>.0#0A..obuf.........:#3D.0#0A..sourcestream.:#3D.0=
#0A<BR>..ocodeout.....:#3D.0#0A..gostream.....:#3D.0#0A..g<BR>etstreams..=
.:#3D.0#0A#0A..sysprint.:#3D.stdout#0A..<BR>selectoutput(sysprint)#0A.#0A=
..writef("*nBCPL.(7.Se<BR>pt.2009)*n")#0A#0A..//.Allocate.vector.for.sour=
ce.f<BR>ile.names#0A..sourcefileupb.:#3D.1000#0A..sourcenam<BR>ev.:#3D.ge=
tvec(sourcefileupb)#0A..UNLESS.sourcename<BR>v.DO#0A..{.writef("Insuffici=
ent.space.available*n")<BR>#0A....errcount.:#3D.1#0A....GOTO.fin#0A..}#0A=
..sou<BR>rcefileno.:#3D.0#0A..FOR.i.#3D.0.TO.sourcefileupb.D<BR>O.sourcen=
amev!0.:#3D.0...#0A.#0A..IF.rdargs(argform<BR>,.argv,.50)#3D0.DO.{.writes=
("Bad.arguments*n")#0A..<BR>....................................errcount.=
:#3D.1<BR>#0A......................................GOTO.fin#0A<BR>.......=
.............................}#0A..treesize.<BR>:#3D.200_000#0A..IF.argv!=
3.DO.treesize.:#3D.!argv!3<BR>#0A..IF.treesize&lt;10_000.DO.treesize.:#3D=
.10_000#0A.<BR>.obufsize.:#3D.treesize/4#0A#0A..prtree........:#3D<BR>.ar=
gv!4#0A..savespacesize.:#3D.3#0A#0A..//.Code.gen<BR>erator.options.#0A#0A=
..naming.:#3D.TRUE#0A..debug.:<BR>#3D.0#0A..bigender.:#3D.(!"AAA".&amp;.2=
55).#3D.'A'.//.#3D<BR>TRUE.if.running.on.a.bigender#0A..IF.argv!5.DO.nami=
<BR>ng...:#3D.FALSE..........//.NONAMES#0A..IF.argv!6.D<BR>O.debug....:#3=
D.debug+1........//.D1#0A..IF.argv!7.<BR>DO.debug....:#3D.debug+2........=
//.D2#0A..IF.argv!8<BR>.DO.bigender.:#3D.~bigender......//.OENDER#0A..eqc=
a<BR>ses..:#3D.argv!9......................//.EQCASES#0A<BR>..bining...:#=
3D.argv!10.....................//.BIN.<BR>(binary.hunk)#0A..xrefing..:#3D=
.argv!11............<BR>.........//.XREF#0A..gdefsing.:#3D.argv!12.......=
..<BR>............//.GDEFS#0A..hdrs.....:#3D.argv!13.....<BR>............=
....//.HDRS#0A..defaultencoding.:#3D.UT<BR>F8#0A..IF.argv!14.DO.defaulten=
coding.:#3D.GB2312.//<BR>.GB2312#0A..IF.argv!15.DO.defaultencoding.:#3D.U=
TF8<BR>...//.UTF8#0A..encoding.:#3D.defaultencoding#0A..IF<BR>.argv!16.DO=
.savespacesize.:#3D.!(argv!16).//.SAVESI<BR>ZE#0A#0A..UNLESS.hdrs.DO#0A..=
..hdrs.:#3D.default_hd<BR>rs()................//.Use.the.default.HDRS#0A.=
....<BR>.....................................//.(typically.<BR>BCPLHDRS.o=
r.POSHDRS)#0A#0A..{.//.Feature.added.by.M<BR>R.17/01/06#0A....//.If.file.=
objline1.can.be.found,.<BR>its.first.line.will.be.written#0A....//.at.the=
.star<BR>t.of.the.compiled.Cintcode.file#2E.It.first.looks.i<BR>n.the#0A.=
...//.current.directory.then.the.HDRS.dire<BR>ctory.and.finally.it.tries#=
0A....//.g/objline1.in.t<BR>he.system.root.directory#2E#0A....LET.line1st=
ream.#3D<BR>.findinput("objline1")#0A....LET.len.#3D.0#0A....UN<BR>LESS.l=
ine1stream.DO#0A......line1stream.:#3D.pathfi<BR>ndinput("objline1",.hdrs=
)#0A....UNLESS.line1stream.<BR>IF.rootnode!rtn_rootvar.DO#0A......line1st=
ream.:#3D<BR>.pathfindinput("g/objline1",.rootnode!rtn_rootvar)#0A<BR>...=
.#0A....IF.line1stream.DO#0A....{.//.Copy.first.<BR>line.of.objline1.into=
.string.objline1#0A......selec<BR>tinput(line1stream)#0A......WHILE.len&l=
t;255.DO#0A....<BR>..{.LET.ch.#3D.rdch()#0A........IF.ch#3D'*n'.|.ch#3D<B=
R>endstreamch.BREAK#0A........len.:#3D.len+1#0A......<BR>..objline1%len.:=
#3D.ch#0A......}#0A......endread()#0A<BR>....}#0A....objline1%0.:#3D.len#=
0A....objline1writt<BR>en.:#3D.FALSE#0A..}#0A#0A..sourcestream.:#3D.findi=
n<BR>put(argv!0)......//.FROM#0A..sourcenamev!0.:#3D.arg<BR>v!0#0A..sourc=
efileno..:#3D.0#0A#0A..IF.sourcestream<BR>#3D0.DO.{.writef("Trouble.with.=
file.%s*n",.argv!0)#0A<BR>.........................errcount.:#3D.1#0A....=
....<BR>.................GOTO.fin#0A.......................<BR>}#0A#0A..s=
electinput(sourcestream)#0A.#0A..TEST.arg<BR>v!1..........//.TO#0A..THEN.=
{.gostream.:#3D.findout<BR>put(argv!1)#0A.........IF.gostream#3D0.DO#0A..=
.....<BR>..{.writef("Trouble.with.code.file.%s*n",.argv!1)#0A<BR>........=
...errcount.:#3D.1#0A...........GOTO.fin#0A<BR>.........}#0A.......}#0A..=
ELSE.{.ocodeout.:#3D.find<BR>output("ocode")#0A.........IF.ocodeout#3D0.D=
O#0A...<BR>......{.writes("Trouble.with.file.ocode*n")#0A.....<BR>......e=
rrcount.:#3D.1#0A...........GOTO.fin#0A.....<BR>....}#0A.......}#0A#0A..t=
reevec.:#3D.getvec(treesiz<BR>e)#0A..obuf....:#3D.getvec(obufsize)#0A#0A.=
.IF.tree<BR>vec#3D0.|.obuf#3D0.DO#0A..{.writes("Insufficient.me<BR>mory*n=
")#0A....errcount.:#3D.1#0A....GOTO.fin#0A..}<BR>#0A...#0A..UNLESS.argv!2=
#3D0.DO.......//.VER#0A..{.<BR>sysprint.:#3D.findoutput(argv!2)#0A....IF.=
sysprint#3D<BR>0.DO#0A....{.sysprint.:#3D.stdout#0A......writef("T<BR>rou=
ble.with.file.%s*n",.argv!2)#0A......errcount.:#3D<BR>.1#0A......GOTO.fin=
#0A....}#0A..}#0A#0A..selectoutp<BR>ut(sysprint)#0A#0A..//.Now.syntax.ana=
lyse,.translat<BR>e.and.code-generate.each.section#0A..{.LET.b.#3D.VE<BR>=
C.64/bytesperword#0A....chbuf.:#3D.b#0A....FOR.i.#3D<BR>.0.TO.63.DO.chbuf=
%i.:#3D.0#0A....//.Sourcefile.0.is<BR>.always.the.FROM.argument.filename#=
0A....//.others.<BR>are.GET.files#0A....sourcenamev!0.:#3D.argv!0#0A...<B=
R>.sourcefileno.:#3D.0#0A....FOR.i.#3D.1.TO.sourcefil<BR>eupb.DO.sourcena=
mev!i.:#3D.0.//.Done.for.safety#0A.<BR>...chcount,.lineno.:#3D.0,.(source=
fileno&lt;&lt;20).+.1#0A<BR>....token,.decval.:#3D.0,.0#0A....rch()#0A.#0=
A....{<BR>.//.Start.of.loop.to.process.each.section#0A......L<BR>ET.tree.=
#3D.?#0A......treep.:#3D.treevec.+.treesize<BR>#0A......obufp.:#3D.0#0A..=
....obuft.:#3D.obufsize.*<BR>.bytesperword#0A#0A......tree.:#3D.formtree(=
)#0A...<BR>...IF.tree#3D0.BREAK#0A#0A......//writef("Tree.size<BR>.%n*n",=
.treesize+treevec-treep)#0A.#0A......IF.prtr<BR>ee.DO.{.writes("Parse.Tre=
e*n")#0A..................<BR>...plist(tree,.0,.20)#0A...................=
..newlin<BR>e()#0A...................}#0A..#0A......UNLESS.errc<BR>ount#3=
D0.GOTO.fin#0A.#0A......translate(tree)#0A#0A<BR>......obufq.:#3D.obufp..=
...//.Prepare.to.read.from.<BR>OCODE.buffer#0A......obufp.:#3D.0#0A#0A...=
...TEST.a<BR>rgv!1#3D0#0A......THEN.writeocode()..//.Write.OCODE<BR>.file=
.if.no.TO.argument#0A......ELSE.codegenerate(t<BR>reevec,.treesize)#0A...=
.}.REPEATWHILE.token#3Ds_dot<BR>#0A..}#0A...#0Afin:#0A..IF.getstreams....=
DO.{.LET.p<BR>.#3D.getstreams#0A........................getstream<BR>s.:#=
3D.!p#0A........................freevec(p)#0A..<BR>....................}#=
0A..IF.treevec.......DO.freev<BR>ec(treevec)#0A..IF.obuf..........DO.free=
vec(obuf)#0A<BR>..IF.sourcenamev...DO.freevec(sourcenamev)#0A..IF.s<BR>ou=
rcestream..DO.{.selectinput(sourcestream);.endrea<BR>d().}#0A..IF.ocodeou=
t......DO.{.selectoutput(ocodeo<BR>ut)#0A........................UNLESS.o=
codeout#3Dstd<BR>out.DO.endwrite()#0A......................}#0A..IF.<BR>g=
ostream......DO.{.selectoutput(gostream)#0A.......<BR>.................UN=
LESS.gostream#3Dstdout.DO.endwri<BR>te()#0A......................}#0A..UN=
LESS.sysprint#3D<BR>stdout.DO.{.selectoutput(sysprint);.endwrite().}#0A<B=
R>#0A..selectoutput(stdout)#0A//abort(7777)#0A..RESUL<BR>TIS.errcount#3D0=
.-&gt;.0,.20#0A}#0A#0A//.*************<BR>.OCODE.I/O.Routines.***********=
***************#0A#0A<BR>/*#0AThe.OCODE.buffer.variables.are:#0A#0Aobuf..=
...<BR>....is.the.OCODE.buffer.--.(obuf#3Dworkvec)#0Aobufp<BR>........pos=
ition.of.next.byte.in.the.OCODE.buffer#0A<BR>obufq........another.pointer=
.into.the.OCODE.buffer#0A<BR>obuft........end.of.the.OCODE.buffer#2E#0Aob=
ufsize.<BR>....size.of.obuf.(in.words)#0A*/#0A#0AAND.writeocod<BR>e().BE#=
0A{.LET.layout.#3D.0#0A..selectoutput(ocodeo<BR>ut)#0A#0A..UNTIL.obufp&gt=
;#3Dobufq.DO#0A..{.writef(".%<BR>n",.rdn())#0A....layout.:#3D.layout+1#0A=
....UNLESS.<BR>layout.REM.16.DO.newline()#0A..}#0A..newline()#0A..<BR>sel=
ectoutput(sysprint)#0A..writef("OCODE.size:.%i5/<BR>%n*n",.obufq,.obuft)#=
0A}#0A#0AAND.rdn().#3D.VALOF#0A<BR>{.LET.byte.#3D.obuf%obufp#0A..IF.obufp=
&gt;#3Dobufq.RES<BR>ULTIS.0#0A..obufp.:#3D.obufp+1#0A..IF.byte&lt;223.RES=
U<BR>LTIS.byte#0A..IF.byte#3D223.RESULTIS.-1#0A..RESULTI<BR>S.(byte&amp;3=
1).+.(rdn()&lt;&lt;5)#0A}#0A#0AAND.wrn(n).BE#0A{<BR>.IF.obufp&gt;#3Dobuft=
.DO#0A..{.errmax.:#3D.0.//.Make.i<BR>t.fatal#0A....trnerr("More.workspace=
.needed.for.OCO<BR>DE.buffer*n")#0A..}#0A..IF.-1&lt;#3Dn&lt;223.DO....//.=
Thi<BR>s.is.the.normal.case#0A..{.IF.n#3D-1.DO.n.:#3D.223#0A<BR>....obuf%=
obufp.:#3D.n#0A....obufp.:#3D.obufp.+.1#0A<BR>....RETURN#0A..}#0A..obuf%o=
bufp.:#3D.224.+.(n&amp;31)#0A<BR>..obufp.:#3D.obufp.+.1#0A..n.:#3D.n&gt;&=
gt;5#0A}.REPEAT#0A<BR>#0A//.*************.End.of..OCODE.I/O.Routines.****=
<BR>***************#0A..#0ALET.lex().BE#0A{.nlpending.:<BR>#3D.FALSE#0A.#=
0A..{.SWITCHON.ch.INTO#0A.#0A....{.DE<BR>FAULT:#0A............{.LET.badch=
.#3D.ch#0A.........<BR>.....ch.:#3D.'*s'#0A..............synerr("Illegal.=
c<BR>haracter.%x2",.badch)#0A............}#0A#0A......CA<BR>SE.'*n':#0A..=
.............lineno.:#3D.lineno.+.1#0A<BR>......CASE.'*p':#0A............=
...nlpending.:#3D.TR<BR>UE..//.IGNORABLE.CHARACTERS#0A......CASE.'*c':#0A=
..<BR>....CASE.'*t':#0A......CASE.'*s':#0A...............<BR>rch().REPEAT=
WHILE.ch#3D'*s'#0A...............LOOP#0A<BR>#0A......CASE.'0':CASE.'1':CA=
SE.'2':CASE.'3':CASE.'<BR>4':#0A......CASE.'5':CASE.'6':CASE.'7':CASE.'8'=
:CAS<BR>E.'9':#0A..............token.:#3D.s_number#0A......<BR>........de=
cval.:#3D.readnumber(10,.100)#0A.........<BR>.....RETURN#0A.#0A......CASE=
.'a':CASE.'b':CASE.'c':<BR>CASE.'d':CASE.'e':#0A......CASE.'f':CASE.'g':C=
ASE.'<BR>h':CASE.'i':CASE.'j':#0A......CASE.'k':CASE.'l':CAS<BR>E.'m':CAS=
E.'n':CASE.'o':#0A......CASE.'p':CASE.'q':<BR>CASE.'r':CASE.'s':CASE.'t':=
#0A......CASE.'u':CASE.'<BR>v':CASE.'w':CASE.'x':CASE.'y':#0A......CASE.'=
z':#0A<BR>......CASE.'A':CASE.'B':CASE.'C':CASE.'D':CASE.'E':<BR>#0A.....=
.CASE.'F':CASE.'G':CASE.'H':CASE.'I':CASE.'<BR>J':#0A......CASE.'K':CASE.=
'L':CASE.'M':CASE.'N':CAS<BR>E.'O':#0A......CASE.'P':CASE.'Q':CASE.'R':CA=
SE.'S':<BR>CASE.'T':#0A......CASE.'U':CASE.'V':CASE.'W':CASE.'<BR>X':CASE=
.'Y':#0A......CASE.'Z':#0A..............toke<BR>n.:#3D.lookupword(rdtag(c=
h))#0A..............IF.tok<BR>en#3Ds_get.DO.{.performget();.LOOP..}#0A...=
........<BR>...RETURN#0A.#0A......CASE.'$':#0A..............rch<BR>()#0A.=
.............IF.ch#3D'$'.|.ch#3D'&lt;'.|.ch#3D'&gt;<BR>'.DO#0A...........=
...{.LET.k.#3D.ch#0A.............<BR>...token.:#3D.lookupword(rdtag('&lt;=
'))#0A............<BR>....//.token.#3D.s_true.............if.the.tag.is.s=
<BR>et#0A................//......#3D.s_false.or.s_name.<BR>.otherwise#0A.=
#0A................//.$&gt;tag...marks.t<BR>he.end.of.a.conditional#0A...=
.............//.......<BR>..skipping.section#0A................IF.k#3D'&g=
t;'.DO#0A<BR>................{.IF.skiptag#3Dwordnode.DO#0A......<BR>.....=
...........skiptag.:#3D.0...//.Matching.$&gt;tag.<BR>found#0A............=
......LOOP#0A................}#0A<BR>.#0A................UNLESS.skiptag#3=
D0.LOOP#0A#0A..<BR>..............//.Only.process.$&lt;tag.and.$$tag.if.no=
<BR>t.skipping#0A.#0A................//.$$tag..compleme<BR>nts.the.value.=
of.a.tag#0A................IF.k#3D'$'<BR>.DO#0A................{.h1!wordn=
ode.:#3D.token#3Ds_<BR>true.-&gt;.s_false,.s_true#0A..................LOO=
P#0A<BR>................}#0A.#0A................//.$&lt;tag#0A<BR>.......=
.........IF.token#3Ds_true.LOOP......//.Don'<BR>t.skip.if.set#0A#0A......=
..........//.tag.is.false.<BR>so.skip.until.matching.$&gt;tag.or.EOF#0A..=
...........<BR>...skiptag.:#3D.wordnode#0A................UNTIL.sk<BR>ipt=
ag#3D0.|.token#3Ds_dot.|.token#3Ds_eof.DO.lex()#0A<BR>................ski=
ptag.:#3D.0#0A................RE<BR>TURN#0A..............}#0A.#0A........=
......UNLESS.c<BR>h#3D'('.|.ch#3D')'.DO.synerr("'$'.out.of.context")#0A<B=
R>..............token.:#3D.ch#3D'('.-&gt;.s_lsect,.s_rse<BR>ct#0A........=
......lookupword(rdtag('$'))#0A.......<BR>.......RETURN#0A.#0A......CASE.=
'{':.token,.wordnode<BR>.:#3D.s_lsect,.nulltag;.BREAK#0A......CASE.'}':.t=
ok<BR>en,.wordnode.:#3D.s_rsect,.nulltag;.BREAK#0A#0A....<BR>..CASE.'#23'=
:#0A..............token.:#3D.s_number#0A<BR>..............rch()#0A.......=
.......IF.'0'&lt;#3Dch&lt;#3D<BR>'7'.DO#0A..............{.decval.:#3D.rea=
dnumber(.8,<BR>.100)#0A................RETURN#0A..............}#0A<BR>...=
...........IF.ch#3D'b'.|.ch#3D'B'.DO#0A.........<BR>.....{.rch()#0A......=
..........decval.:#3D.readnumb<BR>er(.2,.100)#0A................RETURN#0A=
............<BR>..}#0A..............IF.ch#3D'o'.|.ch#3D'O'.DO#0A...<BR>..=
.........{.rch()#0A................decval.:#3D.re<BR>adnumber(.8,.100)#0A=
................RETURN#0A......<BR>........}#0A..............IF.ch#3D'x'.=
|.ch#3D'X'.DO<BR>#0A..............{.rch()#0A................decval.:<BR>#=
3D.readnumber(16,.100)#0A................RETURN#0A<BR>..............}#0A.=
.............token.:#3D.s_mthap#0A<BR>..............RETURN#0A.#0A......CA=
SE.'[':.token.:#3D<BR>.s_sbra;......BREAK#0A......CASE.']':.token.:#3D.s_=
<BR>sket;......BREAK#0A......CASE.'(':.token.:#3D.s_lpa<BR>ren;....BREAK#=
0A......CASE.')':.token.:#3D.s_rparen<BR>;....BREAK.#0A......CASE.'?':.to=
ken.:#3D.s_query;..<BR>...BREAK#0A......CASE.'+':.token.:#3D.s_plus;.....=
.<BR>BREAK#0A......CASE.',':.token.:#3D.s_comma;.....BRE<BR>AK#0A......CA=
SE.';':.token.:#3D.s_semicolon;.BREAK#0A<BR>......CASE.'@':.token.:#3D.s_=
lv;........BREAK#0A...<BR>...CASE.'&amp;':.token.:#3D.s_logand;....BREAK#=
0A......<BR>CASE.'#3D':.token.:#3D.s_eq;........BREAK#0A......C<BR>ASE.'!=
':.token.:#3D.s_vecap;.....BREAK#0A......CASE<BR>.'%':.token.:#3D.s_bytea=
p;....BREAK#0A......CASE.'*<BR>*':token.:#3D.s_mult;......BREAK#0A......C=
ASE.'|':.<BR>token.:#3D.s_logor;.....BREAK#0A......CASE.'#2E':.t<BR>oken.=
:#3D.s_dot;.......BREAK#0A#0A.#0A......CASE.'/<BR>':#0A..............rch(=
)#0A..............IF.ch#3D'\<BR>'.DO.{.token.:#3D.s_logand;.BREAK.}#0A...=
..........<BR>.IF.ch#3D'/'.DO#0A..............{.rch().REPEATUNTIL<BR>.ch#=
3D'*n'.|.ch#3Dendstreamch#0A................LOO<BR>P#0A..............}#0A=
.#0A..............IF.ch#3D'**<BR>'.DO#0A..............{.LET.depth.#3D.1#0=
A#0A.......<BR>.........{.rch()#0A..................IF.ch#3D'**'.D<BR>O#0=
A..................{.rch().REPEATWHILE.ch#3D'**'<BR>#0A..................=
..IF.ch#3D'/'.DO.{.depth.:#3D.<BR>depth-1;.LOOP.}#0A..................}#0=
A...........<BR>.......IF.ch#3D'/'.DO#0A..................{.rch()#0A<BR>.=
...................IF.ch#3D'**'.DO.{.depth.:#3D.de<BR>pth+1;.LOOP.}#0A...=
...............}#0A.............<BR>.....IF.ch#3D'*n'.DO.lineno.:#3D.line=
no+1#0A.......<BR>...........IF.ch#3Dendstreamch.DO.synerr("Missing.'<BR>=
**/'")#0A................}.REPEATUNTIL.depth#3D0#0A<BR>#0A...............=
.rch()#0A................LOOP#0A.<BR>.............}#0A#0A..............to=
ken.:#3D.s_div#0A<BR>..............RETURN#0A.#0A......CASE.'~':#0A......<=
BR>........rch()#0A..............IF.ch#3D'#3D'.DO.{.to<BR>ken.:#3D.s_ne;.=
....BREAK.}#0A..............token.:#3D<BR>.s_not#0A..............RETURN#0=
A.#0A......CASE.'\':<BR>#0A..............rch()#0A..............IF.ch#3D'/=
'.<BR>DO.{.token.:#3D.s_logor;..BREAK.}#0A..............I<BR>F.ch#3D'#3D'=
.DO.{.token.:#3D.s_ne;.....BREAK.}#0A..<BR>............token.:#3D.s_not#0=
A..............RETURN<BR>#0A.#0A......CASE.'&lt;':.rch()#0A..............=
IF.ch#3D<BR>'#3D'.DO.{.token.:#3D.s_le;.....BREAK.}#0A.........<BR>.....I=
F.ch#3D'&lt;'.DO.{.token.:#3D.s_lshift;.BREAK.}#0A<BR>..............token=
.:#3D.s_ls#0A..............RETUR<BR>N#0A.#0A......CASE.'&gt;':.rch()#0A..=
............IF.ch<BR>#3D'#3D'.DO.{.token.:#3D.s_ge;.....BREAK.}#0A......<=
BR>........IF.ch#3D'&gt;'.DO.{.token.:#3D.s_rshift;.BREAK<BR>.}#0A.......=
.......token.:#3D.s_gr#0A..............<BR>RETURN#0A.#0A......CASE.'-':.r=
ch()#0A..............<BR>IF.ch#3D'&gt;'.DO.{.token.:#3D.s_cond;.BREAK..}#=
0A....<BR>..........token.:#3D.s_minus#0A..............RETURN<BR>#0A.#0A.=
.....CASE.':':.rch()#0A..............IF.ch#3D<BR>'#3D'.DO.{.token.:#3D.s_=
ass;.BREAK..}#0A...........<BR>...IF.ch#3D':'.DO.{.token.:#3D.s_of;..BREA=
K..}..//.<BR>Inserted.11/7/01#0A..............token.:#3D.s_colon<BR>#0A..=
............RETURN#0A.#0A......CASE.'"':#0A...<BR>........{.LET.len.#3D.0=
#0A.............rch()#0A....<BR>.........encoding.:#3D.defaultencoding.//=
.encoding.<BR>for.*#23.escapes#0A#0A.............UNTIL.ch#3D'"'.D<BR>O#0A=
.............{.LET.code.#3D.rdstrch()#0A.......<BR>........TEST.result2#0=
A...............THEN.{.//.A..<BR>*#23.code.found#2E#0A...................=
...//.Conve<BR>rt.it.to.UTF8.or.GB2312.format#2E#0A...............<BR>...=
....TEST.encoding#3DGB2312#0A...................<BR>...THEN.{.//.Convert.=
to.GB2312.sequence#0A.........<BR>....................IF.code&gt;#23x7F.D=
O#0A...........<BR>..................{.LET.hi.#3D.code../..100.+.160#0A<B=
R>...............................LET.lo.#3D.code.MOD.<BR>100.+.160#0A....=
...........................IF.len&gt;#3D<BR>254.DO.synerr("Bad.string.con=
stant")#0A............<BR>...................TEST.bigender#0A............=
....<BR>...............THEN.{.charv%(len+1).:#3D.hi.#0A....<BR>..........=
........................charv%(len+2).:#3D<BR>.lo#0A.....................=
...............}#0A.....<BR>..........................ELSE.{.charv%(len+1=
).:#3D<BR>.lo.#0A......................................charv%<BR>(len+2).=
:#3D.hi#0A.................................<BR>...}#0A...................=
............len.:#3D.len.<BR>+.2#0A...............................LOOP#0A=
.......<BR>......................}#0A.........................<BR>....IF.=
len&gt;#3D255.DO.synerr("Bad.string.constant")#0A<BR>....................=
.........charv%(len+1).:#3D.cod<BR>e.//.Ordinary.ASCII.char#0A...........=
.............<BR>.....len.:#3D.len.+.1#0A...........................<BR>.=
.LOOP#0A...........................}#0A...........<BR>...........ELSE.{./=
/.Convert.to.UTF8.sequence#0A...<BR>..........................IF.code&lt;=
#3D#23x7F.DO#0A..<BR>...........................{.IF.len&gt;#3D255.DO.syn=
er<BR>r("Bad.string.constant")#0A........................<BR>.......charv=
%(len+1).:#3D.code...//.0xxxxxxx#0A....<BR>...........................len=
.:#3D.len.+.1#0A.....<BR>..........................LOOP#0A...............=
...<BR>...........}#0A.............................IF.code<BR>&lt;#3D#23x=
7FF.DO#0A.............................{.IF.<BR>len&gt;#3D254.DO.synerr("B=
ad.string.constant")#0A.....<BR>..........................charv%(len+1).:=
#3D.#23b11<BR>00_0000+(code&gt;&gt;6)..//.110xxxxx#0A..................<B=
R>.............charv%(len+2).:#3D.#23x80+(.code....&amp;#23<BR>x3F)..//.1=
0xxxxxx#0A...............................<BR>len.:#3D.len.+.2#0A.........=
......................L<BR>OOP#0A.............................}#0A.......=
.....<BR>.................IF.code&lt;#3D#23xFFFF.DO#0A.........<BR>......=
..............{.IF.len&gt;#3D253.DO.synerr("Bad.<BR>string.constant")#0A.=
..............................<BR>charv%(len+1).:#3D.#23b1110_0000+(code&=
gt;&gt;12).//.1110<BR>xxxx#0A...............................charv%(len+2)=
<BR>.:#3D.#23x80+((code&gt;&gt;6)&amp;#23x3F)..//.10xxxxxx#0A....<BR>....=
.......................charv%(len+3).:#3D.#23x8<BR>0+(.code....&amp;#23x3=
F)..//.10xxxxxx#0A...............<BR>................len.:#3D.len.+.3#0A.=
...............<BR>...............LOOP#0A.............................<BR=
>}#0A.............................IF.code&lt;#3D#23x1F_<BR>FFFF.DO#0A....=
.........................{.IF.len&gt;#3D<BR>252.DO.synerr("Bad.string.con=
stant")#0A............<BR>...................charv%(len+1).:#3D.#23b1111_=
0000<BR>+(code&gt;&gt;18).//.11110xxx#0A.........................<BR>....=
..charv%(len+2).:#3D.#23x80+((code&gt;&gt;12)&amp;#23x3F)<BR>.//.10xxxxxx=
#0A...............................charv<BR>%(len+3).:#3D.#23x80+((code&gt=
;&gt;.6)&amp;#23x3F).//.10xxxxx<BR>x#0A...............................cha=
rv%(len+4).:#3D<BR>.#23x80+(.code.....&amp;#23x3F).//.10xxxxxx#0A........=
.<BR>......................len.:#3D.len.+.4#0A..........<BR>.............=
........LOOP#0A.......................<BR>......}#0A.....................=
........IF.code&lt;#3D#23<BR>x3FF_FFFF.DO#0A.............................=
{.IF.le<BR>n&gt;#3D251.DO.synerr("Bad.string.constant")#0A.......<BR>....=
....................charv%(len+1).:#3D.#23b1111<BR>_1000+(code&gt;&gt;24)=
.//.111110xx#0A....................<BR>...........charv%(len+2).:#3D.#23x=
80+((code&gt;&gt;18)&amp;#23<BR>x3F).//.10xxxxxx#0A......................=
.........c<BR>harv%(len+3).:#3D.#23x80+((code&gt;&gt;12)&amp;#23x3F).//.1=
0x<BR>xxxxx#0A...............................charv%(len+4<BR>).:#3D.#23x8=
0+((code&gt;&gt;.6)&amp;#23x3F).//.10xxxxxx#0A...<BR>....................=
........charv%(len+5).:#3D.#23x<BR>80+(.code.....&amp;#23x3F).//.10xxxxxx=
#0A..............<BR>.................len.:#3D.len.+.5#0A...............<=
BR>................LOOP#0A............................<BR>.}#0A..........=
...................IF.code&lt;#3D#23x7F<BR>FF_FFFF.DO#0A.................=
............{.IF.len&gt;<BR>#3D250.DO.synerr("Bad.string.constant")#0A...=
......<BR>......................charv%(len+1).:#3D.#23b1111_1<BR>100+(cod=
e&gt;&gt;30).//.1111110x#0A......................<BR>.........charv%(len+=
2).:#3D.#23x80+((code&gt;&gt;24)&amp;#23x<BR>3F).//.10xxxxxx#0A..........=
.....................ch<BR>arv%(len+3).:#3D.#23x80+((code&gt;&gt;18)&amp;=
#23x3F).//.10xx<BR>xxxx#0A...............................charv%(len+4)<BR=
>.:#3D.#23x80+((code&gt;&gt;12)&amp;#23x3F).//.10xxxxxx#0A....<BR>.......=
....................charv%(len+5).:#3D.#23x8<BR>0+((code&gt;&gt;.6)&amp;#=
23x3F).//.10xxxxxx#0A...............<BR>................charv%(len+6).:#3=
D.#23x80+(.code...<BR>..&amp;#23x3F).//.10xxxxxx#0A......................=
....<BR>.....len.:#3D.len.+.6#0A...........................<BR>....LOOP#0=
A.............................}#0A.......<BR>......................synerr=
("Bad.Unicode.character<BR>")#0A...........................}#0A..........=
.....<BR>.....}#0A...............ELSE.{.//.Not.a.Unicode.cha<BR>racter#0A=
......................IF.len#3D255.DO.syne<BR>rr("Bad.string.constant")#0=
A......................l<BR>en.:#3D.len.+.1#0A......................charv=
%len.:<BR>#3D.code#0A....................}#0A.............}#0A<BR>.#0A...=
..........charv%0.:#3D.len#0A.............wo<BR>rdnode.:#3D.newvec(len/by=
tesperword+2)#0A..........<BR>...h1!wordnode.:#3D.s_string#0A............=
.FOR.i.#3D<BR>.0.TO.len.DO.(@h2!wordnode)%i.:#3D.charv%i#0A......<BR>....=
...token.:#3D.s_string#0A.............BREAK#0A.<BR>.........}#0A.#0A.....=
.CASE.'*'':#0A..............r<BR>ch()#0A..............encoding.:#3D.defau=
ltencoding#0A<BR>..............decval.:#3D.rdstrch()#0A.............<BR>.=
token.:#3D.s_number#0A..............UNLESS.ch#3D'*<BR>''.DO.synerr("Bad.c=
haracter.constant")#0A..........<BR>....BREAK#0A.#0A.#0A......CASE.endstr=
eamch:#0A.....<BR>.........IF.getstreams.DO#0A..............{.//.Retu<BR>=
rn.from.a.'GET'.stream#0A................LET.p.#3D.<BR>getstreams#0A.....=
...........endread()#0A..........<BR>......ch...........:#3D.h4!getstream=
s#0A...........<BR>.....lineno.......:#3D.h3!getstreams#0A............<BR=
>....sourcestream.:#3D.h2!getstreams#0A.............<BR>...getstreams...:=
#3D.h1!getstreams#0A..............<BR>..freevec(p).//.Free.the.GET.node#0=
A...............<BR>.selectinput(sourcestream)#0A................LOOP#0A<=
BR>..............}#0A..............//.endstreamch.#3D&gt;<BR>.EOF.only.at=
.outermost.GET.level.#0A..............t<BR>oken.:#3D.s_eof#0A............=
..RETURN#0A....}#0A..<BR>}.REPEAT#0A.#0A..rch()#0A}#0A.#0ALET.lookupword(=
wor<BR>d).#3D.VALOF#0A{.LET.len,.i.#3D.word%0,.0#0A..LET.h<BR>ashval.#3D.=
19609.//.This.and.31397.are.primes#2E#0A<BR>..FOR.j.#3D.0.TO.len.DO.hashv=
al.:#3D.(hashval.NEQV.<BR>word%j).*.31397#0A..hashval.:#3D.(hashval&gt;&g=
t;1).REM.n<BR>ametablesize#0A#0A..wordnode.:#3D.nametable!hashval<BR>#0A.=
#0A..UNTIL.wordnode#3D0.|.i&gt;len.TEST.(@h3!wordn<BR>ode)%i#3Dword%i#0A.=
..........................THEN.i<BR>.:#3D.i+1#0A.........................=
..ELSE.wordnod<BR>e,.i.:#3D.h2!wordnode,.0#0A.#0A..UNLESS.wordnode.DO<BR>=
#0A..{.wordnode.:#3D.newvec(len/bytesperword+2)#0A.<BR>...h1!wordnode,.h2=
!wordnode.:#3D.s_name,.nametable!<BR>hashval#0A....FOR.i.#3D.0.TO.len.DO.=
(@h3!wordnode)%<BR>i.:#3D.word%i#0A....nametable!hashval.:#3D.wordnode<BR=
>#0A..}#0A.#0A..RESULTIS.h1!wordnode#0A}#0A.#0AAND.d<BR>sw(word,.sym).BE.=
{.lookupword(word);.h1!wordnode.:#3D<BR>.sym..}#0A.#0AAND.declsyswords().=
BE#0A{.dsw("AND",.<BR>s_and)#0A..dsw("ABS",.s_abs)#0A..dsw("BE",.s_be)#0A=
<BR>..dsw("BREAK",.s_break)#0A..dsw("BY",.s_by)#0A..dsw<BR>("CASE",.s_cas=
e)#0A..dsw("DO",.s_do)#0A..dsw("DEFAU<BR>LT",.s_default)#0A..dsw("EQ",.s_=
eq)#0A..dsw("EQV",.<BR>s_eqv)#0A..dsw("ELSE",.s_else)#0A..dsw("ENDCASE",.=
s<BR>_endcase)#0A..dsw("FALSE",.s_false)#0A..dsw("FOR",.<BR>s_for)#0A..ds=
w("FINISH",.s_finish)#0A..dsw("GOTO",.<BR>s_goto)#0A..dsw("GE",.s_ge)#0A.=
.dsw("GR",.s_gr)#0A.<BR>.dsw("GLOBAL",.s_global)#0A..dsw("GET",.s_get)#0A=
..<BR>dsw("IF",.s_if)#0A..dsw("INTO",.s_into)#0A..dsw("LE<BR>T",.s_let)#0=
A..dsw("LV",.s_lv)#0A..dsw("LE",.s_le)#0A<BR>..dsw("LS",.s_ls)#0A..dsw("L=
OGOR",.s_logor)#0A..dsw<BR>("LOGAND",.s_logand)#0A..dsw("LOOP",.s_loop)#0=
A..ds<BR>w("LSHIFT",.s_lshift)#0A..dsw("MANIFEST",.s_manifes<BR>t)#0A..ds=
w("MOD",.s_rem)#0A..dsw("NE",.s_ne)#0A..ds<BR>w("NEEDS",.s_needs)#0A..dsw=
("NEQV",.s_neqv)#0A..dsw<BR>("NOT",.s_not)#0A..dsw("OF",.s_of)...........=
......<BR>..//.Inserted.11/7/01#0A..dsw("OR",.s_else)#0A..dsw<BR>("RESULT=
IS",.s_resultis)#0A..dsw("RETURN",.s_return<BR>)#0A..dsw("REM",.s_rem)#0A=
..dsw("RSHIFT",.s_rshift)<BR>#0A..dsw("RV",.s_rv)#0A..dsw("REPEAT",.s_rep=
eat)#0A<BR>..dsw("REPEATWHILE",.s_repeatwhile)#0A..dsw("REPEAT<BR>UNTIL",=
.s_repeatuntil)#0A..dsw("SECTION",.s_section<BR>)#0A..dsw("SKIP",.s_skip)=
...............//.Added.22<BR>/6/05#0A..dsw("SLCT",.s_slct)..............=
.//.Inse<BR>rted.11/7/01#0A..dsw("STATIC",.s_static)#0A..dsw("S<BR>WITCHO=
N",.s_switchon)#0A..dsw("TO",.s_to)#0A..dsw("<BR>TEST",.s_test)#0A..dsw("=
TRUE",.s_true)#0A..dsw("THE<BR>N",.s_do)#0A..dsw("TABLE",.s_table)#0A..ds=
w("UNLESS<BR>",.s_unless)#0A..dsw("UNTIL",.s_until)#0A..dsw("VEC<BR>",.s_=
vec)#0A..dsw("VALOF",.s_valof)#0A..dsw("WHILE"<BR>,.s_while)#0A..dsw("XOR=
",.s_neqv)#0A..dsw("$",.0)#0A<BR>.#0A..nulltag.:#3D.wordnode#0A}.#0A.#0AL=
ET.rch().BE<BR>#0A{.ch.:#3D.rdch()#0A..chcount.:#3D.chcount.+.1#0A<BR>..c=
hbuf%(chcount&amp;63).:#3D.ch#0A}#0A.#0AAND.wrchbuf(<BR>).BE#0A{.writes("=
*n#2E#2E#2E")#0A..FOR.p.#3D.chcoun<BR>t-63.TO.chcount.DO#0A..{.LET.k.#3D.=
chbuf%(p&amp;63)#0A.<BR>...IF.0&lt;k&lt;255.DO.wrch(k)#0A..}#0A..newline(=
)#0A}#0A<BR>.#0A.#0AAND.rdtag(ch1).#3D.VALOF#0A{.LET.len.#3D.1#0A<BR>..IF=
.eqcases.&amp;.'a'&lt;#3Dch1&lt;#3D'z'.DO.ch1.:#3D.ch1.+.<BR>'A'.-.'a'#0A=
..charv%1.:#3D.ch1#0A.#0A..{.rch()#0A..<BR>..UNLESS.'a'&lt;#3Dch&lt;#3D'z=
'.|.'A'&lt;#3Dch&lt;#3D'Z'.|#0A..<BR>.........'0'&lt;#3Dch&lt;#3D'9'.|.ch=
#3D'#2E'.|.ch#3D'_'.B<BR>REAK#0A....IF.eqcases.&amp;.'a'&lt;#3Dch&lt;#3D'=
z'.DO.ch.:#3D<BR>.ch.+.'A'.-.'a'#0A....len.:#3D.len+1#0A....charv%le<BR>n=
.:#3D.ch#0A..}.REPEAT#0A.#0A..charv%0.:#3D.len#0A.<BR>.RESULTIS.charv#0A}=
#0A#0AAND.catstr(s1,.s2).#3D.VAL<BR>OF#0A//.Concatenate.strings.s1.and.s2=
.leaving.the.r<BR>esult.in.s1#2E#0A//.s1.is.assumed.to.be.able.to.hol<BR>=
d.a.string.of.length.255#2E#0A//.The.resulting.stri<BR>ng.is.truncated.to=
.length.255,.if.necessary#2E.#0A{<BR>.LET.len.#3D.s1%0#0A..LET.n.#3D.len#=
0A..FOR.i.#3D.1<BR>.TO.s2%0.DO#0A..{.n.:#3D.n+1#0A....IF.n&gt;255.BREAK#0=
A<BR>....s1%n.:#3D.s2%i#0A..}#0A..s1%0.:#3D.n#0A}.#0A.#0A<BR>AND.performg=
et().BE#0A{.LET.stream.#3D.?#0A..LET.le<BR>n.#3D.0#0A..lex()#0A..UNLESS.t=
oken#3Ds_string.DO.sy<BR>nerr("Bad.GET.directive")#0A..len.:#3D.charv%0#0=
A#0A<BR>..//.Append.#2Eh.to.the.GET.filename.does.not.end.i<BR>n.#2Eh.or.=
#2Eb#0A..UNLESS.len&gt;#3D2.&amp;.charv%(len-1)#3D<BR>'#2E'.&amp;.#0A....=
.....(charv%len#3D'h'.|.charv%len#3D<BR>'b').DO#0A..{.len.:#3D.len+2#0A..=
..charv%0,.charv%(<BR>len-1),.charv%len.:#3D.len,.'#2E',.'h'#0A..}#0A#0A.=
<BR>.FOR.i.#3D.1.TO.charv%0.IF.charv%i#3D':'.DO.charv%i<BR>.:#3D.'/'#0A#0=
A..//.First.look.in.the.current.direc<BR>tory#0A..//writef("Searching.for=
.*"%s*".in.the.curr<BR>ent.directory*n",.charv)#0A..stream.:#3D.findinput=
(<BR>charv)#0A#0A..//.Then.try.the.headers.directories#0A<BR>..//UNLESS.s=
tream.DO.writef("Searching.for.*"%s*".i<BR>n.%s*n",.charv,.hdrs)#0A..UNLE=
SS.stream.DO.stream.:<BR>#3D.pathfindinput(charv,.hdrs)#0A#0A..//.Finally=
.pr<BR>epend.g/.and.lookup.in.the.system.root.directory#0A<BR>..UNLESS.st=
ream.DO#0A..{.LET.filename.#3D.VEC.256/b<BR>ytesperword#0A....filename%0.=
:#3D.0#0A....catstr(fi<BR>lename,."g/")#0A....catstr(filename,.charv)#0A.=
.../<BR>/writef("Searching.for.*"%s*".in.%s*n",.filename,.r<BR>ootnode!rt=
n_rootvar)#0A....stream.:#3D.pathfindinpu<BR>t(filename,.rootnode!rtn_roo=
tvar)#0A..}#0A#0A..UNLE<BR>SS.stream.DO#0A..{.synerr("Unable.to.find.GET.=
file.<BR>%s",.charv)#0A....RETURN#0A..}#0A#0A..IF.sourcefile<BR>no&gt;#3D=
sourcefileupb.DO#0A..{.synerr("Too.many.GET.f<BR>iles")#0A....RETURN#0A..=
}#0A#0A..{.LET.len.#3D.char<BR>v%0#0A....LET.node.#3D.getvec(4.+.len/byte=
sperword)<BR>#0A....LET.str.#3D.@node!4#0A#0A....UNLESS.node.DO.<BR>syner=
r("getvec.failure.in.performget")#0A#0A....FOR<BR>.i.#3D.0.TO.len.DO.str%=
i.:#3D.charv%i#0A....sourcef<BR>ileno.:#3D.sourcefileno+1#0A....sourcenam=
ev!sourcef<BR>ileno.:#3D.str#0A....node!0,.node!1,.node!2,.node!3<BR>.:#3=
D.getstreams,.sourcestream,.lineno,.ch#0A....ge<BR>tstreams.:#3D.node#0A.=
.}#0A..sourcestream.:#3D.stre<BR>am#0A..selectinput(sourcestream)#0A..lin=
eno.:#3D.(s<BR>ourcefileno&lt;&lt;20).+.1#0A..rch()#0A}#0A.#0AAND.readnu<=
BR>mber(radix,.digs).#3D.VALOF#0A//.Read.a.binary,.oct<BR>al,.decimal.or.=
hexadecimal.unsigned.number#0A//.wit<BR>h.between.1.and.digs.digits#2E.Un=
derlines.are.allow<BR>ed#2E#0A//.This.function.is.used.for.numerical.cons=
<BR>tants.and.numerical#0A//.escapes.in.string.and.char<BR>acter.constant=
s#2E#0A{.LET.i,.res.#3D.0,.0#0A.#0A..<BR>{.UNLESS.ch#3D'_'.DO.//.ignore.u=
nderlines#0A....{.L<BR>ET.d.#3D.value(ch)#0A......IF.d&gt;#3Dradix.BREAK#=
0A..<BR>....i.:#3D.i+1.......//.Increment.count.of.digits#0A<BR>......res=
.:#3D.radix*res.+.d#0A....}#0A....rch()#0A<BR>..}.REPEATWHILE.i&lt;digs#0=
A#0A..UNLESS.i.DO.synerr("B<BR>ad.number")#0A..RESULTIS.res#0A}#0A.#0A.#0=
AAND.valu<BR>e(ch).#3D.'0'&lt;#3Dch&lt;#3D'9'.-&gt;.ch-'0',#0A...........=
<BR>.....'A'&lt;#3Dch&lt;#3D'F'.-&gt;.ch-'A'+10,#0A.............<BR>...'a=
'&lt;#3Dch&lt;#3D'f'.-&gt;.ch-'a'+10,#0A...............<BR>.100#0A.#0AAND=
.rdstrch().#3D.VALOF#0A{.//.Return.th<BR>e.integer.code.for.the.next.stri=
ng.character#0A..//<BR>.Set.result2#3DTRUE.if.*#23.character.code.was.fou=
n<BR>d,.otherwise.FALSE#0A..LET.k.#3D.ch#0A#0A..IF.k#3D'<BR>*n'.|.k#3D'*p=
'.DO#0A..{.lineno.:#3D.lineno+1#0A....<BR>synerr("Unescaped.newline.chara=
cter")#0A..}#0A.#0A.<BR>.IF.k#3D'**'.DO#0A..{.rch()#0A....k.:#3D.ch#0A...=
.I<BR>F.'a'&lt;#3Dk&lt;#3D'z'.DO.k.:#3D.k.+.'A'.-.'a'#0A....SWI<BR>TCHON.=
k.INTO#0A....{.CASE.'*n':#0A......CASE.'*c':#0A<BR>......CASE.'*p':#0A...=
...CASE.'*s':#0A......CASE.'*<BR>t':.WHILE.ch#3D'*n'.|.ch#3D'*c'.|.ch#3D'=
*p'.|.ch#3D<BR>'*s'.|.ch#3D'*t'.DO#0A.................{.IF.ch#3D'*<BR>n'.=
DO.lineno.:#3D.lineno+1#0A...................rch<BR>()#0A................=
.}#0A.................IF.ch#3D<BR>'**'.DO.{.rch();.LOOP..}#0A#0A......DEF=
AULT:...syne<BR>rr("Bad.string.or.character.constant,.ch#3D%n",.ch)<BR>#0=
A.........#0A......CASE.'**':#0A......CASE.'*'':#0A<BR>......CASE.'"':...=
.................ENDCASE#0A......<BR>...#0A......CASE.'T':..k.:#3D.c_tab;=
.......ENDCASE#0A<BR>......CASE.'S':..k.:#3D.c_space;.....ENDCASE#0A....<=
BR>..CASE.'N':..k.:#3D.c_newline;...ENDCASE#0A......CA<BR>SE.'E':..k.:#3D=
.c_escape;....ENDCASE#0A......CASE.'<BR>B':..k.:#3D.c_backspace;.ENDCASE#=
0A......CASE.'P':.<BR>.k.:#3D.c_newpage;...ENDCASE#0A......CASE.'C':..k.:=
<BR>#3D.c_return;....ENDCASE#0A.........#0A......CASE.'<BR>X':..//.*xhh..=
--.A.character.escape.in.hexadecimal#0A<BR>.................rch()#0A.....=
............k.:#3D.re<BR>adnumber(16,2)#0A.................result2.:#3D.F=
ALS<BR>E#0A.................RESULTIS.k#0A#0A......CASE.'#23<BR>':..//.*#2=
3u...set.UTF8.mode#0A.................//.<BR>*#23g...set.GB2312.mode#0A..=
...............//.In.UT<BR>F8.mode#0A.................//.....*#23hhhh.or.=
*#23#23<BR>hhhhhhhh..--.a.Unicode.character#0A................<BR>.//.In.=
GB2312#0A.................//.....*#23dddd...<BR>..............--.A.GB2312=
.code#0A...............{.L<BR>ET.digs.#3D.4#0A.................rch()#0A..=
........<BR>.......IF.ch#3D'u'.|.ch#3D'U'.DO.{.encoding.:#3D.UT<BR>F8;...=
rch();.LOOP.}#0A.................IF.ch#3D'g'.<BR>|.ch#3D'G'.DO.{.encoding=
.:#3D.GB2312;.rch();.LOOP.}<BR>#0A.................TEST.encoding#3DGB2312=
#0A......<BR>...........THEN.{.#0A........................k.:#3D<BR>.read=
number(10,.digs)#0A//sawritef("rdstrch:.GB2312<BR>:.%i4*n",.k)#0A........=
..............}#0A..........<BR>.......ELSE.{.IF.ch#3D'#23'.DO.{.rch();.d=
igs.:#3D.8<BR>.}#0A........................k.:#3D.readnumber(16,.<BR>digs=
)#0A//sawritef("rdstrch:.Unicode:.%x4*n",.k)#0A<BR>......................=
}#0A.................result2.<BR>:#3D.TRUE#0A.................RESULTIS.k#=
0A.........<BR>......}#0A#0A......CASE.'0':CASE.'1':CASE.'2':CASE.<BR>'3'=
:CASE.'4':#0A......CASE.'5':CASE.'6':CASE.'7':#0A<BR>.................//.=
*ooo.--.A.character.escape.in.o<BR>ctal.#0A.................k.:#3D.readnu=
mber(8,3)#0A.<BR>................IF.k&gt;255.DO.#0A....................<B=
R>...synerr("Bad.string.or.character.constant")#0A...<BR>..............re=
sult2.:#3D.FALSE#0A................<BR>.RESULTIS.k#0A....}#0A..}#0A...#0A=
..rch()#0A..resul<BR>t2.:#3D.FALSE#0A..RESULTIS.k#0A}.REPEAT#0A#0ALET.ne<=
BR>wvec(n).#3D.VALOF#0A{.treep.:#3D.treep.-.n.-.1;#0A.<BR>.IF.treep&lt;#3=
Dtreevec.DO#0A..{.errmax.:#3D.0..//.Mak<BR>e.it.fatal#0A....synerr("More.=
workspace.needed")#0A<BR>..}#0A..RESULTIS.treep#0A}#0A.#0AAND.mk1(x).#3D.=
VAL<BR>OF#0A{.LET.p.#3D.newvec(0)#0A..p!0.:#3D.x#0A..RESUL<BR>TIS.p#0A}#0=
A.#0AAND.mk2(x,.y).#3D.VALOF#0A{.LET.p.#3D<BR>.newvec(1)#0A..p!0,.p!1.:#3=
D.x,.y#0A..RESULTIS.p#0A<BR>}#0A.#0AAND.mk3(x,.y,.z).#3D.VALOF#0A{.LET.p.=
#3D.ne<BR>wvec(2)#0A..p!0,.p!1,.p!2.:#3D.x,.y,.z#0A..RESULTIS<BR>.p#0A}#0=
A.#0AAND.mk4(x,.y,.z,.t).#3D.VALOF#0A{.LET.<BR>p.#3D.newvec(3)#0A..p!0,.p=
!1,.p!2,.p!3.:#3D.x,.y,.z<BR>,.t#0A..RESULTIS.p#0A}#0A.#0AAND.mk5(x,.y,.z=
,.t,.u)<BR>.#3D.VALOF#0A{.LET.p.#3D.newvec(4)#0A..p!0,.p!1,.p!<BR>2,.p!3,=
.p!4.:#3D.x,.y,.z,.t,.u#0A..RESULTIS.p#0A}#0A<BR>.#0AAND.mk6(x,.y,.z,.t,.=
u,.v).#3D.VALOF#0A{.LET.p.#3D<BR>.newvec(5)#0A..p!0,.p!1,.p!2,.p!3,.p!4,.=
p!5.:#3D.x,<BR>.y,.z,.t,.u,.v#0A..RESULTIS.p#0A}#0A.#0AAND.mk7(x,.<BR>y,.=
z,.t,.u,.v,.w).#3D.VALOF#0A{.LET.p.#3D.newvec(6)<BR>#0A..p!0,.p!1,.p!2,.p=
!3,.p!4,.p!5,.p!6.:#3D.x,.y,.z<BR>,.t,.u,.v,.w#0A..RESULTIS.p#0A}#0A.#0AA=
ND.formtree(<BR>).#3D..VALOF#0A{.LET.res.#3D.0#0A#0A..nametablesize<BR>.:=
#3D.541#0A#0A..charv......:#3D.newvec(256/bytespe<BR>rword).....#0A..name=
table..:#3D.newvec(nametablesiz<BR>e).#0A..FOR.i.#3D.0.TO.nametablesize.D=
O.nametable!i<BR>.:#3D.0#0A..skiptag.:#3D.0#0A..declsyswords()#0A.#0A<BR>=
..rec_p,.rec_l.:#3D.level(),.rec#0A.#0A..token,.dec<BR>val.:#3D.0,.0#0A#0=
A..lex()#0A//sawritef("formtree:.<BR>token#3D%n.cis#3D%n*n",.token,.cis)#=
0A..IF.token#3D<BR>s_query.DO............//.For.debugging.lex#2E#0A..{<BR=
>.lex()#0A....writef("token.#3D%i3.ln#3D%i5.%12t..de<BR>cval.#3D.%i8...ch=
arv.#3D.%s*n",#0A............token<BR>,.lineno&amp;#23xFFFFF,.opname(toke=
n),.decval,........c<BR>harv)#0A....IF.token#3Ds_eof.RESULTIS.0#0A..}.REP=
EA<BR>T#0A#0Arec:res.:#3D.token#3Ds_section.-&gt;.rprog(s_se<BR>ction),#0=
A...........token#3Ds_needs...-&gt;.rprog(s_n<BR>eeds),.rdblockbody(TRUE)=
#0A//sawritef("section.ende<BR>d.with.%s*n",.opname(token))#0A..UNLESS.to=
ken#3Ds_d<BR>ot.|.token#3Ds_eof.DO.synerr("Incorrect.termination<BR>")#0A=
.#0A..RESULTIS.res#0A}#0A.#0AAND.rprog(thing).<BR>#3D.VALOF#0A{.LET.a.#3D=
.0#0A..lex()#0A..a.:#3D.rbex<BR>p()#0A..UNLESS.h1!a#3Ds_string.DO.synerr(=
"Bad.SECTI<BR>ON.or.NEEDS.name")#0A..RESULTIS.mk3(thing,.a,#0A...<BR>....=
..........token#3Ds_needs.-&gt;.rprog(s_needs),#0A<BR>...................=
..............rdblockbody(TRUE))<BR>.//.TRUE#3Doutmost.level#0A}#0A.#0A.#=
0AAND.synerr(m<BR>ess,.a).BE#0A{.LET.fno.#3D.lineno&gt;&gt;20#0A..LET.ln.=
#3D<BR>.lineno.&amp;.#23xFFFFF#0A..LET.filename.#3D.sourcename<BR>v!fno#0=
A..errcount.:#3D.errcount.+.1#0A..writef("*n<BR>Error.near.")#0A..IF.file=
name.DO.writef("%s",.filen<BR>ame)#0A..writef("[%n]:..",.ln)#0A..writef(m=
ess,.a)#0A<BR>..wrchbuf()#0A..IF.errcount.&gt;.errmax.DO#0A..{.write<BR>s=
("*nCompilation.aborted*n")#0A....longjump(fin_p,.<BR>fin_l)#0A..}#0A..nl=
pending.:#3D.FALSE#0A.#0A..UNTIL<BR>.token#3Ds_lsect.|.token#3Ds_rsect.|#=
0A........toke<BR>n#3Ds_let.|.token#3Ds_and.|#0A........token#3Ds_dot<BR>=
.|.token#3Ds_eof.|.nlpending.DO.lex()#0A#0A..IF.tok<BR>en#3Ds_and.DO.toke=
n.:#3D.s_let#0A..longjump(rec_p,.<BR>rec_l)#0A}#0A.#0ALET.rdblockbody(out=
erlevel).#3D.VA<BR>LOF#0A{.LET.p,.l.#3D.rec_p,.rec_l#0A..LET.a,.ln.#3D<BR=
>.0,.?#0A.#0A..rec_p,.rec_l.:#3D.level(),.recover#0A<BR>#0Arecover:..#0A.=
.IF.token#3Ds_semicolon.DO.lex()#0A<BR>.#0A..ln.:#3D.lineno#0A...#0A..SWI=
TCHON.token.INTO#0A<BR>..{.CASE.s_manifest:#0A....CASE.s_static:#0A....CA=
S<BR>E.s_global:#0A..............{.LET.op.#3D.token#0A..<BR>.............=
.lex()#0A................a.:#3D.rdsect<BR>(rdcdefs,.op#3Ds_global-&gt;s_c=
olon,s_eq)#0A..........<BR>......a.:#3D.mk4(op,.a,.rdblockbody(outerlevel=
),.ln<BR>)#0A................ENDCASE#0A..............}#0A.#0A<BR>.#0A....=
CASE.s_let:.lex()#0A................a.:#3D.<BR>rdef(outerlevel)#0A.......=
.........WHILE.token#3Ds_<BR>and.DO#0A................{.LET.ln1.#3D.linen=
o#0A...<BR>...............lex()#0A..................a.:#3D.mk4<BR>(s_and,=
.a,.rdef(outerlevel),.ln1)#0A...............<BR>.}#0A................a.:#=
3D.mk4(s_let,.a,.rdblockbo<BR>dy(outerlevel),.ln)#0A................ENDCA=
SE#0A.#0A<BR>....DEFAULT:....IF.outerlevel.DO#0A................<BR>{.err=
max.:#3D.0.//.Make.it.fatal#2E#0A.............<BR>.....synerr("Bad.outer.=
level.declaration")#0A......<BR>..........}#0A................a.:#3D.rdse=
q()#0A....<BR>............UNLESS.token#3Ds_rsect.DO.synerr("Error<BR>.in.=
command")#0A.#0A....CASE.s_rsect:IF.outerlevel.<BR>DO.lex()#0A....CASE.s_=
dot:#0A....CASE.s_eof:#0A..}#0A<BR>.#0A..rec_p,.rec_l.:#3D.p,.l#0A..RESUL=
TIS.a#0A}#0A.<BR>#0AAND.rdseq().#3D.VALOF#0A{.LET.a.#3D.0#0A...IF.to<BR>k=
en#3Ds_semicolon.DO.lex()#0A...a.:#3D.rcom()#0A...<BR>IF.token#3Ds_rsect.=
|.token#3Ds_dot.|.token#3Ds_eof.<BR>RESULTIS.a#0A...RESULTIS.mk3(s_seq,.a=
,.rdseq())#0A}<BR>#0A#0AAND.rdcdefs(sep).#3D.VALOF#0A{.LET.res,.id.#3D<BR=
>.0,.0#0A...LET.ptr.#3D.@res#0A...LET.p,.l.#3D.rec_p<BR>,.rec_l#0A...LET.=
kexp.#3D.0#0A#0A.#0A...{.LET.ln.#3D<BR>.lineno#0A......rec_p,.rec_l.:#3D.=
level(),.recov#0A<BR>......kexp.:#3D.0#0A......id.:#3D.rname()#0A......I<=
BR>F.token#3Dsep.DO.kexp.:#3D.rnexp(0)#0A......!ptr.:#3D<BR>.mk5(s_constd=
ef,.0,.id,.kexp,.ln)#0A......ptr.:#3D.<BR>@h2!(!ptr)#0A#0Arecov:IF.token#=
3Ds_semicolon.DO.lex<BR>()#0A...}.REPEATWHILE.token#3Ds_name#0A.#0A...rec=
_p<BR>,.rec_l.:#3D.p,.l#0A...RESULTIS.res#0A}#0A.#0AAND.r<BR>dsect(r,.arg=
).#3D.VALOF#0A//.Used.only.for.MANIFEST<BR>,.STATIC.and.GLOBAL.declaratio=
ns,#0A//.SWITCHON.com<BR>mands.and.blocks#2E#0A{.LET.tag,.res.#3D.wordnod=
e,.<BR>0#0A...UNLESS.token#3Ds_lsect.DO.synerr("'{'.or.'$(<BR>'.expected"=
)#0A...lex()#0A...UNLESS.token#3Ds_rsect<BR>.DO.res.:#3D.r(arg).//.Allow.=
{.}..MR.22/6/05#0A...U<BR>NLESS.token#3Ds_rsect.DO.synerr("'}'.or.'$)'.ex=
pect<BR>ed")#0A...TEST.tag#3Dwordnode.THEN.lex()#0A........<BR>..........=
...ELSE.IF.wordnode#3Dnulltag.DO#0A......<BR>....................{.token.=
:#3D.0#0A..............<BR>..............synerr("Untagged.'$)'.mismatch")=
#0A..<BR>........................}#0A...//.res#3D0.for.empty<BR>.section.=
brackets.{.}#0A...RESULTIS.res#0A}#0A#0AAN<BR>D.rnamelist().#3D.VALOF#0A{=
.LET.a.#3D.rname()#0A...<BR>UNLESS.token#3Ds_comma.RESULTIS.a#0A...lex()#=
0A...R<BR>ESULTIS.mk3(s_comma,.a,.rnamelist())#0A}#0A#0AAND.r<BR>name().#=
3D.VALOF#0A{.LET.a.#3D.wordnode#0A...UNLESS<BR>.token#3Ds_name.DO.synerr(=
"Name.expected")#0A...lex<BR>()#0A...RESULTIS.a#0A}#0A.#0ALET.rbexp().#3D=
.VALOF#0A<BR>{.LET.a,.op.#3D.0,.token#0A.#0A...SWITCHON.token.IN<BR>TO#0A=
.#0A...{.DEFAULT:.synerr("Error.in.expression"<BR>)#0A#0A......CASE.s_que=
ry:..lex()#0A...............<BR>......RESULTIS.mk1(s_query)#0A.#0A......C=
ASE.s_true<BR>:#0A......CASE.s_false:#0A......CASE.s_name:#0A....<BR>..CA=
SE.s_string:.a.:#3D.wordnode#0A................<BR>.....lex()#0A.........=
............RESULTIS.a#0A.#0A<BR>......CASE.s_number:.a.:#3D.mk2(s_number=
,.decval)#0A<BR>.....................lex()#0A.....................R<BR>ES=
ULTIS.a#0A#0A......CASE.s_slct:.{.LET.len,.sh,.of<BR>fset.#3D.0,.0,.0..//=
.Inserted.11/7/01#0A#0A........<BR>.............//.Allow...SLCT.offset#0A=
.............<BR>........//.or......SLCT.sh:offset#0A...............<BR>.=
.....//.or......SLCT.len:sh:offset#0A#0A..........<BR>...........offset.:=
#3D.rnexp(0)#0A#0A..............<BR>.......IF.token#3Ds_colon.DO#0A......=
..............<BR>.{.sh.:#3D.offset#0A.......................offset.:<BR>=
#3D.rnexp(0)#0A.....................}#0A...........<BR>..........IF.token=
#3Ds_colon.DO#0A.................<BR>....{.len.:#3D.sh#0A................=
.......sh.:#3D.<BR>offset#0A.......................offset.:#3D.rnexp(0<BR=
>)#0A.....................}#0A#0A...................<BR>..RESULTIS.mk4(s_=
slct,.len,.sh,.offset)#0A.........<BR>..........}#0A.#0A......CASE.s_lpar=
en:.a.:#3D.rnexp<BR>(0)#0A.....................UNLESS.token#3Ds_rparen.<B=
R>DO.synerr("')'.missing")#0A.....................lex<BR>()#0A...........=
..........RESULTIS.a#0A.#0A......CA<BR>SE.s_valof:..lex()#0A.............=
........RESULTIS.<BR>mk2(s_valof,.rcom())#0A.#0A......CASE.s_vecap:..op.<=
BR>:#3D.s_rv#0A......CASE.s_lv:#0A......CASE.s_rv:....<BR>.RESULTIS.mk2(o=
p,.rnexp(7))#0A.#0A......CASE.s_plus<BR>:...RESULTIS.rnexp(5)#0A.#0A.....=
.CASE.s_minus:..a.<BR>:#3D.rnexp(5)#0A.....................TEST.h1!a#3Ds_=
<BR>number.THEN.h2!a.:#3D.-.h2!a#0A....................<BR>..............=
......ELSE.a.:#3D.mk2(s_neg,.a)#0A...<BR>..................RESULTIS.a#0A.=
#0A......CASE.s_abs<BR>:....RESULTIS.mk2(s_abs,.rnexp(5))#0A.#0A......CAS=
E<BR>.s_not:....RESULTIS.mk2(s_not,.rnexp(3))#0A.#0A....<BR>..CASE.s_tabl=
e:..lex()#0A.....................RESUL<BR>TIS.mk2(s_table,.rexplist())#0A=
..}#0A}#0A.#0AAND.rn<BR>exp(n).#3D.VALOF.{.lex();.RESULTIS.rexp(n).}#0A.#=
0A<BR>AND.rexp(n).#3D.VALOF#0A{.LET.a,.b,.p.#3D.rbexp(),.<BR>0,.0#0A#0A..=
.UNTIL.nlpending.DO.#0A...{.LET.op.#3D.<BR>token#0A.#0A......SWITCHON.op.=
INTO#0A.#0A......{.DE<BR>FAULT:.......RESULTIS.a#0A.#0A.........CASE.s_lp=
are<BR>n:.lex()#0A........................b.:#3D.0#0A.....<BR>...........=
........UNLESS.token#3Ds_rparen.DO.b.:#3D<BR>.rexplist()#0A..............=
..........UNLESS.token#3D<BR>s_rparen.DO.synerr("')'.missing")#0A........=
.......<BR>.........lex()#0A........................a.:#3D.mk4<BR>(s_fnap=
,.a,.b,.0)#0A........................LOOP#0A<BR>.#0A.........CASE.s_mthap=
:{.LET.e1.#3D.0#0A........<BR>.................lex()#0A..................=
.......U<BR>NLESS.token#3Ds_lparen.DO.synerr("'('.missing")#0A.<BR>......=
..................lex()#0A...................<BR>......b.:#3D.0#0A.......=
..................UNLESS.to<BR>ken#3Ds_rparen.DO.b.:#3D.rexplist()#0A....=
.........<BR>............IF.b#3D0.DO.synerr("argument.expression<BR>.miss=
ing")#0A.........................UNLESS.token#3D<BR>s_rparen.DO.synerr("'=
)'.missing")#0A...............<BR>..........lex()#0A.....................=
....TEST.h1!<BR>b#3Ds_comma#0A.........................THEN.e1.:#3D<BR>.h=
2!b#0A.........................ELSE.e1.:#3D.b#0A.<BR>....................=
....a.:#3D.mk3(s_vecap,.mk2(s_r<BR>v,.e1),.a)#0A.........................=
a.:#3D.mk4(s_<BR>fnap,.a,.b,.0)#0A.........................LOOP#0A..<BR>.=
...................}#0A.#0A.........CASE.s_sbra:..<BR>.b.:#3D.rnexp(0)...=
//.Inserted.11/6/02#0A..........<BR>..............UNLESS.token#3Ds_sket.D=
O.synerr("']'.<BR>missing")#0A........................lex()#0A.......<BR>=
.................a.:#3D.mk3(s_vecap,.a,.b)#0A......<BR>..................=
LOOP#0A.#0A.........CASE.s_of:...<BR>..p.:#3D.8;.ENDCASE.//.Inserted.11/7=
/01#0A#0A......<BR>...CASE.s_vecap:..p.:#3D.8;.ENDCASE#0A.........CASE<BR=
>.s_byteap:.p.:#3D.8;.ENDCASE.//.Changed.from.7.on.1<BR>6.Dec.1999#0A....=
.....CASE.s_mult:#0A.........CASE.<BR>s_div:#0A.........CASE.s_rem:....p.=
:#3D.6;.ENDCASE#0A<BR>.........CASE.s_plus:#0A.........CASE.s_minus:..p.:=
<BR>#3D.5;.ENDCASE#0A.#0A.........CASE.s_eq:CASE.s_le:C<BR>ASE.s_ls:#0A..=
.......CASE.s_ne:CASE.s_ge:CASE.s_gr:<BR>#0A........................IF.n&=
gt;#3D4.RESULTIS.a#0A.<BR>.......................b.:#3D.rnexp(4)#0A......=
....<BR>..............a.:#3D.mk3(op,.a,.b)#0A..............<BR>..........=
WHILE..s_eq&lt;#3Dtoken&lt;#3Ds_ge.DO#0A.......<BR>.................{.LET=
.c.#3D.b#0A..................<BR>.........op.:#3D.token#0A...............=
...........<BR>.b.:#3D.rnexp(4)#0A...........................a.:#3D<BR>.m=
k3(s_logand,.a,.mk3(op,.c,.b))#0A................<BR>........}#0A........=
................LOOP#0A.#0A....<BR>.....CASE.s_lshift:#0A.........CASE.s_=
rshift:.IF.n&gt;<BR>#3D4.RESULTIS.a#0A........................a.:#3D.mk<B=
R>3(op,.a,.rnexp(4))#0A........................LOOP#0A<BR>#0A.........CAS=
E.s_logand:.p.:#3D.3;.ENDCASE#0A....<BR>.....CASE.s_logor:..p.:#3D.2;.END=
CASE#0A.........CA<BR>SE.s_eqv:#0A.........CASE.s_neqv:...p.:#3D.1;.ENDCA=
<BR>SE#0A.#0A.........CASE.s_cond:...IF.n&gt;#3D1.RESULTIS<BR>.a#0A......=
..................b.:#3D.rnexp(0)#0A....<BR>....................UNLESS.to=
ken#3Ds_comma.DO#0A...<BR>............................synerr("Bad.conditi=
onal<BR>.expression")#0A........................a.:#3D.mk4(<BR>s_cond,.a,=
.b,.rnexp(0))#0A........................L<BR>OOP#0A......}#0A......#0A...=
...IF.n&gt;#3Dp.RESULTIS.a<BR>#0A......a.:#3D.mk3(op,.a,.rnexp(p))#0A...}=
#0A...#0A<BR>...RESULTIS.a#0A}#0A.#0ALET.rexplist().#3D.VALOF#0A<BR>{.LET=
.res,.a.#3D.0,.rexp(0)#0A...LET.ptr.#3D.@res#0A<BR>.#0A...WHILE.token#3Ds=
_comma.DO.{.!ptr.:#3D.mk3(s_c<BR>omma,.a,.0)#0A..........................=
..ptr.:#3D.<BR>@h3!(!ptr)#0A............................a.:#3D.rne<BR>xp(=
0)#0A.........................}#0A...!ptr.:#3D.a<BR>#0A...RESULTIS.res#0A=
}#0A.#0ALET.rdef(outerlevel).#3D<BR>.VALOF#0A{.LET.n.#3D.rnamelist()#0A..=
.LET.ln.#3D.li<BR>neno#0A#0A...SWITCHON.token.INTO#0A.#0A...{.CASE.s_<BR>=
lparen:#0A........{.LET.a.#3D.0#0A...........lex()#0A<BR>...........UNLES=
S.h1!n#3Ds_name.DO.synerr("Bad.form<BR>al.parameter")#0A...........IF.tok=
en#3Ds_name.DO.a.<BR>:#3D.rnamelist()#0A...........UNLESS.token#3Ds_rpar<=
BR>en.DO.synerr("')'.missing")#0A...........lex()#0A.#0A<BR>...........IF=
.token#3Ds_be.DO#0A...........{.lex()#0A<BR>..............RESULTIS.mk6(s_=
rtdef,.n,.a,.rcom(),.0<BR>,.ln)#0A...........}#0A.#0A...........IF.token#=
3Ds_<BR>eq.RESULTIS.mk6(s_fndef,.n,.a,.rnexp(0),.0,.ln)#0A.<BR>#0A.......=
....synerr("Bad.procedure.heading")#0A...<BR>.....}#0A.#0A......DEFAULT:.=
synerr("Bad.declaration<BR>")#0A.#0A......CASE.s_eq:#0A...........IF.oute=
rleve<BR>l.DO.synerr("Bad.outer.level.declaration")#0A......<BR>.....lex(=
)#0A...........IF.token#3Ds_vec.DO#0A.....<BR>......{.UNLESS.h1!n#3Ds_nam=
e.DO.synerr("Name.requir<BR>ed.before.#3D.VEC")#0A..............RESULTIS.=
mk4(s_<BR>vecdef,.n,.rnexp(0),.ln)#0A...........}#0A.........<BR>..RESULT=
IS.mk4(s_valdef,.n,.rexplist(),.ln)#0A...}#0A<BR>}#0A.#0ALET.rbcom().#3D.=
VALOF#0A{.LET.a,.b,.op,.ln.<BR>#3D.0,.0,.token,.lineno#0A.#0A..SWITCHON.t=
oken.INTO<BR>#0A..{.DEFAULT:.RESULTIS.0#0A.#0A....CASE.s_name:CA<BR>SE.s_=
number:CASE.s_string:CASE.s_lparen:#0A....CASE<BR>.s_true:CASE.s_false:CA=
SE.s_lv:CASE.s_rv:CASE.s_vec<BR>ap:#0A....CASE.s_slct:........//.Inserted=
.11/7/01#0A<BR>....CASE.s_plus:CASE.s_minus:CASE.s_abs:CASE.s_not:<BR>#0A=
....CASE.s_table:CASE.s_valof:CASE.s_query:#0A..<BR>..........//.All.toke=
ns.that.can.start.an.expressio<BR>n#2E#0A............a.:#3D.rexplist()#0A=
.#0A........<BR>....IF.token#3Ds_ass.DO#0A............{.op.:#3D.tok<BR>en=
#0A...............lex()#0A...............RESULTIS<BR>.mk4(op,.a,.rexplist=
(),.ln)#0A............}#0A.#0A.<BR>...........IF.token#3Ds_colon.DO#0A...=
.........{.UN<BR>LESS.h1!a#3Ds_name.DO.synerr("Unexpected.':'")#0A..<BR>.=
............lex()#0A...............RESULTIS.mk5(s_<BR>colon,.a,.rbcom(),.=
0,.ln)#0A............}#0A.#0A...<BR>.........IF.h1!a#3Ds_fnap.DO#0A......=
......{.h1!a,.<BR>h4!a.:#3D.s_rtap,.ln#0A...............RESULTIS.a#0A<BR>=
............}#0A.#0A............synerr("Error.in.co<BR>mmand")#0A........=
....RESULTIS.a#0A.#0A....CASE.s_g<BR>oto:#0A....CASE.s_resultis:#0A......=
......RESULTIS.<BR>mk3(op,.rnexp(0),.ln)#0A.#0A....CASE.s_if:#0A....CA<BR=
>SE.s_unless:#0A....CASE.s_while:#0A....CASE.s_until<BR>:#0A............a=
.:#3D.rnexp(0)#0A............IF.to<BR>ken#3Ds_do.DO.lex()#0A............R=
ESULTIS.mk4(op,.<BR>a,.rcom(),.ln)#0A.#0A....CASE.s_test:#0A...........<B=
R>.a.:#3D.rnexp(0)#0A............IF.token#3Ds_do.DO.l<BR>ex()#0A.........=
...b.:#3D.rcom()#0A............UNLE<BR>SS.token#3Ds_else.DO.synerr("ELSE.=
missing")#0A.....<BR>.......lex()#0A............RESULTIS.mk5(s_test,.a,.<=
BR>b,.rcom(),.ln)#0A.#0A....CASE.s_for:#0A.........{.L<BR>ET.i,.j,.k.#3D.=
0,.0,.0#0A............lex()#0A......<BR>......a.:#3D.rname()#0A..........=
..UNLESS.token#3Ds<BR>_eq.DO.synerr("'#3D'.missing")#0A............i.:#3D=
<BR>.rnexp(0)#0A............UNLESS.token#3Ds_to.DO.syne<BR>rr("TO.missing=
")#0A............j.:#3D.rnexp(0)#0A..<BR>..........IF.token#3Ds_by.DO.k.:=
#3D.rnexp(0)#0A....<BR>........IF.token#3Ds_do.DO.lex()#0A............RES=
U<BR>LTIS.mk7(s_for,.a,.i,.j,.k,.rcom(),.ln)#0A.........<BR>}#0A.#0A....C=
ASE.s_skip:#0A....CASE.s_loop:#0A....C<BR>ASE.s_break:#0A....CASE.s_retur=
n:#0A....CASE.s_fini<BR>sh:#0A....CASE.s_endcase:#0A............lex()#0A.=
..<BR>.........RESULTIS.mk2(op,.ln)#0A.#0A....CASE.s_swit<BR>chon:#0A....=
........a.:#3D.rnexp(0)#0A............U<BR>NLESS.token#3Ds_into.DO.synerr=
("INTO.missing")#0A..<BR>..........lex()#0A............{.LET.skipln.#3D.l=
ine<BR>no#0A..............b.:#3D.rdsect(rdseq)#0A.........<BR>.....UNLESS=
.b.DO#0A................b.:#3D.mk2(s_ski<BR>p,.skipln).........//.MR.5/4/=
06#0A............}#0A.<BR>...........RESULTIS.mk4(s_switchon,.a,.b,.ln)#0=
A.#0A<BR>....CASE.s_case:#0A............a.:#3D.rnexp(0)#0A..<BR>.........=
.UNLESS.token#3Ds_colon.DO.synerr("Bad.CAS<BR>E.label")#0A............lex=
()#0A............RESULTI<BR>S.mk4(s_case,.a,.rbcom(),.ln)#0A.#0A....CASE.=
s_defa<BR>ult:#0A............lex()#0A............UNLESS.token<BR>#3Ds_col=
on.DO.synerr("Bad.DEFAULT.label")#0A.......<BR>.....lex()#0A............R=
ESULTIS.mk3(s_default,.rb<BR>com(),.ln)#0A.#0A....CASE.s_lsect:#0A.......=
.....a.<BR>:#3D.rdsect(rdblockbody,.FALSE)#0A............UNLES<BR>S.a.DO#=
0A..............a.:#3D.mk2(s_skip,.ln)......<BR>..//.MR.5/4/06#0A........=
....RESULTIS.a#0A..}#0A}#0A<BR>#0AAND.rcom().#3D.VALOF#0A{.LET.a.#3D.rbco=
m()#0A.#0A<BR>...//.Empty.section.brackets.{.}.form.SKIP.nodes,.M<BR>R.22=
/6/05#0A...IF.a#3D0.DO.synerr("Error.in.command<BR>")#0A.#0A...WHILE.toke=
n#3Ds_repeat.|.token#3Ds_repe<BR>atwhile.|.token#3Ds_repeatuntil.DO#0A...=
{.LET.op,.l<BR>n.#3D.token,.lineno#0A......UNLESS.op#3Ds_repeat.{.<BR>a.:=
#3D.mk4(op,.a,.rnexp(0),.ln);.LOOP.}#0A......a.:<BR>#3D.mk3(op,.a,.ln)#0A=
......lex()#0A...}#0A.#0A...RE<BR>SULTIS.a#0A}#0A/*#0ALET.plist(x).BE#0A{=
.writef("*nN<BR>ame.table.contents,.size.#3D.%n*n",.nametablesize)#0A<BR>=
...FOR.i.#3D.0.TO.nametablesize-1.DO#0A...{.LET.p,.<BR>n.#3D.nametable!i,=
.0#0A......UNTIL.p#3D0.DO.p,.n.:#3D<BR>.p!1,.n+1#0A......writef("%i3:%n",=
.i,.n)#0A......p.<BR>:#3D.nametable!i#0A......UNTIL.p#3D0.DO.{.writef(".<=
BR>%s",.p+2);.p.:#3D.p!1..}#0A......newline()#0A...}#0A<BR>}#0A*/#0ALET.p=
list(x,.n,.d).BE#0A{.LET.size,.ln.#3D<BR>.0,.0#0A...LET.v.#3D.TABLE.0,0,0=
,0,0,0,0,0,0,0,0,0,<BR>0,0,0,0,0,0,0,0#0A#0A...IF.x#3D0.DO.{.writes("Nil"=
)<BR>;.RETURN..}#0A.#0A...SWITCHON.h1!x.INTO#0A...{.CASE<BR>.s_number:.wr=
iten(h2!x);.........RETURN#0A.#0A.....<BR>.CASE.s_name:...writes(x+2);...=
.......RETURN#0A.#0A<BR>......CASE.s_string:.writef("*"%s*"",x+1);.RETURN=
#0A<BR>.#0A......CASE.s_for:....size,.ln.:#3D.6,.h7!x;..EN<BR>DCASE#0A.#0=
A......CASE.s_fndef:CASE.s_rtdef:#0A....<BR>.................size,.ln.:#3=
D.4,.h6!x;..ENDCASE#0A<BR>#0A......CASE.s_cond:#0A......CASE.s_slct:.....=
..//<BR>.Inserted.11/7/01#0A.....................size.:#3D.<BR>4;........=
....ENDCASE#0A.#0A......CASE.s_test:CASE.<BR>s_constdef:#0A..............=
.......size,.ln.:#3D.4,<BR>.h5!x;..ENDCASE#0A.#0A......CASE.s_needs:CASE.=
s_sec<BR>tion:CASE.s_vecap:CASE.s_byteap:CASE.s_fnap:#0A....<BR>..CASE.s_=
of:..//.Inserted.11/7/01#0A......CASE.s_mu<BR>lt:CASE.s_div:CASE.s_rem:CA=
SE.s_plus:CASE.s_minus:#0A<BR>......CASE.s_eq:CASE.s_ne:CASE.s_ls:CASE.s_=
gr:CASE.<BR>s_le:CASE.s_ge:#0A......CASE.s_lshift:CASE.s_rshift<BR>:CASE.=
s_logand:CASE.s_logor:#0A......CASE.s_eqv:CAS<BR>E.s_neqv:CASE.s_comma:#0=
A......CASE.s_seq:#0A......<BR>...............size.:#3D.3;............END=
CASE#0A..<BR>...................#0A......CASE.s_valdef:CASE.s_ve<BR>cdef:=
#0A.....................size,.ln.:#3D.3,.h4!x;<BR>..ENDCASE#0A#0A......CA=
SE.s_colon:#0A..............<BR>.......size,.ln.:#3D.3,.h5!x;..ENDCASE#0A=
.#0A......<BR>CASE.s_and:#0A......CASE.s_ass:CASE.s_rtap:CASE.s_i<BR>f:CA=
SE.s_unless:#0A......CASE.s_while:CASE.s_until:<BR>CASE.s_repeatwhile:#0A=
......CASE.s_repeatuntil:#0A.<BR>.....CASE.s_switchon:CASE.s_case:CASE.s_=
let:#0A....<BR>..CASE.s_manifest:CASE.s_static:CASE.s_global:#0A..<BR>...=
................size,.ln.:#3D.3,.h4!x;..ENDCASE#0A<BR>.#0A......CASE.s_va=
lof:CASE.s_lv:CASE.s_rv:CASE.s_n<BR>eg:CASE.s_not:#0A......CASE.s_table:C=
ASE.s_abs:#0A.<BR>....................size.:#3D.2;............ENDCASE<BR>=
#0A.#0A......CASE.s_goto:CASE.s_resultis:CASE.s_rep<BR>eat:CASE.s_default=
:#0A.....................size,.ln<BR>.:#3D.2,.h3!x;..ENDCASE#0A.#0A......=
CASE.s_true:CAS<BR>E.s_false:CASE.s_query:#0A.....................size<BR=
>.:#3D.1;............ENDCASE#0A......#0A......CASE.s<BR>_skip:.//.MR.22/6=
/05#0A......CASE.s_loop:CASE.s_bre<BR>ak:CASE.s_return:#0A......CASE.s_fi=
nish:CASE.s_endc<BR>ase:#0A.....................size,.ln.:#3D.1,.h2!x;.<B=
R>.ENDCASE#0A#0A......DEFAULT:.......size.:#3D.1#0A..<BR>.}#0A.#0A...IF.n=
#3Dd.DO.{.writes("Etc");.RETURN.}#0A<BR>.#0A//...writef("Op.%n",.h1!x)#0A=
...writef(opname(h<BR>1!x),.h1!x)#0A//.IF.ln&gt;0.DO.writef("..line.%n",.=
ln)<BR>#0A...IF.ln&gt;0.DO#0A...{.LET.fno.#3D.ln&gt;&gt;20#0A.....L<BR>ET=
.lno.#3D.ln.&amp;.#23xFFFFF#0A.....LET.filename.#3D.s<BR>ourcenamev!fno#0=
A.....writef("..")#0A.....IF.filena<BR>me.DO.writef("%s",.filename)#0A...=
..writef("[%n]",.<BR>lno)#0A...}#0A...FOR.i.#3D.2.TO.size.DO.{.newline()<=
BR>#0A...........................FOR.j#3D0.TO.n-1.DO.w<BR>rites(.v!j.)#0A=
...........................writes("*<BR>*-")#0A..........................=
.v!n.:#3D.i#3Dsize<BR>-&gt;"..","!."#0A...........................plist(h=
1!(<BR>x+i-1),.n+1,.d)#0A........................}#0A}#0A.<BR>#0AAND.opna=
me(op).#3D.VALOF.SWITCHON.op.INTO#0A{.DE<BR>FAULT:............RESULTIS."O=
p.%n"#0A#0A..CASE.s_ab<BR>s:.........RESULTIS."ABS"#0A..CASE.s_and:......=
...R<BR>ESULTIS."AND"#0A..CASE.s_ass:.........RESULTIS."ASS<BR>"#0A..CASE=
.s_be:..........RESULTIS."BE"#0A..CASE.s_<BR>by:..........RESULTIS."BY"#0=
A..CASE.s_break:.......<BR>RESULTIS."BREAK"#0A..CASE.s_byteap:......RESUL=
TIS."<BR>BYTEAP"#0A..CASE.s_case:........RESULTIS."CASE"#0A.<BR>.CASE.s_c=
olon:.......RESULTIS."COLON"#0A..CASE.s_co<BR>mma:.......RESULTIS."COMMA"=
#0A..CASE.s_cond:.......<BR>.RESULTIS."COND"#0A..CASE.s_constdef:....RESU=
LTIS."<BR>CONSTDEF"#0A..CASE.s_default:.....RESULTIS."DEFAULT<BR>"#0A..CA=
SE.s_div:.........RESULTIS."DIV"#0A..CASE.s<BR>_do:..........RESULTIS."DO=
"#0A..CASE.s_dot:........<BR>.RESULTIS."DOT"#0A..CASE.s_else:........RESU=
LTIS."E<BR>LSE"#0A..CASE.s_eof:.........RESULTIS."EOF"#0A..CAS<BR>E.s_end=
case:.....RESULTIS."ENDCASE"#0A..CASE.s_eq:.<BR>.........RESULTIS."EQ"#0A=
..CASE.s_eqv:.........RESU<BR>LTIS."EQV"#0A..CASE.s_false:.......RESULTIS=
."FALSE"<BR>#0A..CASE.s_finish:......RESULTIS."FINISH"#0A..CASE<BR>.s_fna=
p:........RESULTIS."FNAP"#0A..CASE.s_fndef:..<BR>.....RESULTIS."FNDEF"#0A=
..CASE.s_for:.........RESUL<BR>TIS."FOR"#0A..CASE.s_ge:..........RESULTIS=
."GE"#0A.<BR>.CASE.s_get:.........RESULTIS."GET"#0A..CASE.s_glob<BR>al:..=
....RESULTIS."GLOBAL"#0A..CASE.s_goto:........<BR>RESULTIS."GOTO"#0A..CAS=
E.s_gr:..........RESULTIS."G<BR>R"#0A..CASE.s_if:..........RESULTIS."IF"#=
0A..CASE.s<BR>_into:........RESULTIS."INTO"#0A..CASE.s_le:.......<BR>...R=
ESULTIS."LE"#0A..CASE.s_let:.........RESULTIS."<BR>LET"#0A..CASE.s_logand=
:......RESULTIS."LOGAND"#0A..<BR>CASE.s_logor:.......RESULTIS."LOGOR"#0A.=
.CASE.s_loo<BR>p:........RESULTIS."LOOP"#0A..CASE.s_lparen:......R<BR>ESU=
LTIS."LPAREN"#0A..CASE.s_ls:..........RESULTIS."<BR>LS"#0A..CASE.s_lsect:=
.......RESULTIS."LSECT"#0A..CA<BR>SE.s_lshift:......RESULTIS."LSHIFT"#0A.=
.CASE.s_lv:.<BR>.........RESULTIS."LV"#0A..CASE.s_manifest:....RESU<BR>LT=
IS."MANIFEST"#0A..CASE.s_mthap:.......RESULTIS."M<BR>THAP"#0A..CASE.s_min=
us:.......RESULTIS."MINUS"#0A..<BR>CASE.s_mult:........RESULTIS."MULT"#0A=
..CASE.s_name<BR>:........RESULTIS."NAME"#0A..CASE.s_ne:..........RE<BR>S=
ULTIS."NE"#0A..CASE.s_needs:.......RESULTIS."NEEDS<BR>"#0A..CASE.s_neg:..=
.......RESULTIS."NEG"#0A..CASE.s<BR>_neqv:........RESULTIS."NEQV"#0A..CAS=
E.s_not:......<BR>...RESULTIS."NOT"#0A..CASE.s_number:......RESULTIS.<BR>=
"NUMBER"#0A..CASE.s_of:..........RESULTIS."OF"#0A..<BR>CASE.s_plus:......=
..RESULTIS."PLUS"#0A..CASE.s_quer<BR>y:.......RESULTIS."QUERY"#0A..CASE.s=
_rem:.........R<BR>ESULTIS."REM"#0A..CASE.s_repeat:......RESULTIS."REP<BR=
>EAT"#0A..CASE.s_repeatuntil:.RESULTIS."REPEATUNTIL"<BR>#0A..CASE.s_repea=
twhile:.RESULTIS."REPEATWHILE"#0A.<BR>.CASE.s_resultis:....RESULTIS."RESU=
LTIS"#0A..CASE.s<BR>_return:......RESULTIS."RETURN"#0A..CASE.s_rparen:.<B=
R>.....RESULTIS."RPAREN"#0A..CASE.s_rshift:......RESU<BR>LTIS."RSHIFT"#0A=
..CASE.s_rsect:.......RESULTIS."RSE<BR>CT"#0A..CASE.s_rtap:........RESULT=
IS."RTAP"#0A..CAS<BR>E.s_rtdef:.......RESULTIS."RTDEF"#0A..CASE.s_rv:...<=
BR>.......RESULTIS."RV"#0A..CASE.s_sbra:........RESULT<BR>IS."SBRA"#0A..C=
ASE.s_section:.....RESULTIS."SECTION<BR>"#0A..CASE.s_semicolon:...RESULTI=
S."SEMICOLON"#0A..<BR>CASE.s_seq:.........RESULTIS."SEQ"#0A..CASE.s_sket:=
<BR>........RESULTIS."SKET"#0A..CASE.s_skip:........RES<BR>ULTIS."SKIP"#0=
A..CASE.s_static:......RESULTIS."STAT<BR>IC"#0A..CASE.s_string:......RESU=
LTIS."STRING"#0A..C<BR>ASE.s_switchon:....RESULTIS."SWITCHON"#0A..CASE.s_=
t<BR>able:.......RESULTIS."TABLE"#0A..CASE.s_test:......<BR>..RESULTIS."T=
EST"#0A..CASE.s_to:..........RESULTIS.<BR>"TO"#0A..CASE.s_true:........RE=
SULTIS."TRUE"#0A..CA<BR>SE.s_unless:......RESULTIS."UNLESS"#0A..CASE.s_un=
ti<BR>l:.......RESULTIS."UNTIL"#0A..CASE.s_valdef:......R<BR>ESULTIS."VAL=
DEF"#0A..CASE.s_valof:.......RESULTIS."<BR>VALOF"#0A..CASE.s_vec:........=
.RESULTIS."VEC"#0A..C<BR>ASE.s_vecap:.......RESULTIS."VECAP"#0A..CASE.s_v=
ecd<BR>ef:......RESULTIS."VECDEF"#0A..CASE.s_while:.......<BR>RESULTIS."W=
HILE"#0A}#0A#0A//#2E#0A#0A//SECTION."TRN<BR>"#0A#0A//....TRNHDR#0A.#0A//G=
ET."libhdr"#0A//GET."b<BR>cplfecg"#0A.#0AGLOBAL..{#0Atrnext:trng#0Atrans;=
.dec<BR>lnames;.decldyn#0Adeclstat;.checkdistinct;.addname;<BR>.cellwithn=
ame#0Atransdef;.scanlabel#0Adecllabels;.u<BR>ndeclare#0Ajumpcond;.transsw=
itch;.transfor#0Aassign<BR>;.load;.fnbody;.loadlv;.loadlist#0Aisconst.eva=
lcons<BR>t;.transname;.xref#0Anextlab;.labnumber#0Anewblk#0A<BR>dvec;.dve=
ce;.dvecp;.dvect#0Acaselist;.casecount#0Ac<BR>ontext;.comline;.procname#0=
Aresultlab;.defaultlab;.<BR>endcaselab#0Alooplab;.breaklab;.ssp;.vecssp#0=
Agdefl<BR>ist;.gdefcount#0Aoutstring;.out1;.out2#0A}#0A#0ALET<BR>.nextlab=
().#3D.VALOF#0A{.labnumber.:#3D.labnumber.+<BR>.1#0A..RESULTIS.labnumber#=
0A}#0A.#0AAND.trnerr(mess<BR>,.a).BE#0A{.LET.fno.#3D.comline&gt;&gt;20#0A=
..LET.lno.#3D<BR>.comline.&amp;.#23xFFFFF#0A..LET.filename.#3D.sourcenam<=
BR>ev!fno#0A..writes("Error.")#0A..UNLESS.procname#3D0<BR>.DO.writef("in.=
%s.",.@h3!procname)#0A..writef("near<BR>.")#0A..IF.filename.DO.writef("%s=
",.filename)#0A..w<BR>ritef("[%n]:.",.lno)#0A..writef(mess,.a)#0A..newlin=
<BR>e()#0A..errcount.:#3D.errcount.+.1#0A..IF.errcount.<BR>&gt;#3D.errmax=
.DO.{.writes("*nCompilation.aborted*n")#0A<BR>...........................=
..longjump(fin_p,.fin_l)<BR>#0A...........................}#0A}#0A#0AAND.=
newblk<BR>(x,.y,.z).#3D.VALOF#0A{.LET.p.#3D.dvect.-.3#0A..IF.<BR>dvece&gt=
;p.DO.{.errmax.:#3D.0........//.Make.it.fatal#2E<BR>#0A..................=
trnerr("More.workspace.needed"<BR>)#0A................}#0A..p!0,.p!1,.p!2=
.:#3D.x,.y,.<BR>z#0A..dvect.:#3D.p#0A..RESULTIS.p#0A}#0A#0AAND.tran<BR>sl=
ate(x).BE#0A{.dvec,..dvect.:#3D.treevec,.treep#0A<BR>..h1!dvec,.h2!dvec,.=
h3!dvec.:#3D.0,.0,.0#0A..dvece.<BR>:#3D.dvec+3#0A..dvecp.:#3D.dvece#0A//s=
electoutput(s<BR>ysprint)#0A..FOR.i.#3D.0.TO.nametablesize-1.DO#0A..<BR>{=
.LET.name.#3D.nametable!i#0A....UNTIL.name#3D0.DO#0A<BR>....{.LET.next.#3=
D.h2!name#0A......h2!name.:#3D.0./<BR>/.Mark.undeclared#0A//...writef("Un=
declare.%s*n",.n<BR>ame+2)#0A......name.:#3D.next#0A....}#0A..}#0A#0A..<B=
R>gdeflist,.gdefcount.:#3D.0,.0#0A..caselist,.casecou<BR>nt,.defaultlab.:=
#3D.0,.-1,.0#0A..resultlab,.breakla<BR>b,.looplab,.endcaselab.:#3D.-2,.-2=
,.-2,.-2#0A..cont<BR>ext,.comline,.procname,.labnumber.:#3D.0,.1,.0,.0#0A=
<BR>..ssp,.vecssp.:#3D.savespacesize,.savespacesize#0A#0A<BR>..WHILE.x~#3=
D0.&amp;.(h1!x#3Ds_section.|.h1!x#3Ds_needs<BR>).DO#0A..{.LET.op,.a.#3D.h=
1!x,.h2!x#0A....out1(op)#0A<BR>....outstring(@h2!a)#0A....x:#3Dh3!x#0A..}=
#0A#0A..t<BR>rans(x,.0)#0A..out2(s_global,.gdefcount)#0A..UNTIL.<BR>gdefl=
ist#3D0.DO.{.out2(h2!gdeflist,.h3!gdeflist)#0A<BR>.......................=
.gdeflist.:#3D.h1!gdeflist#0A<BR>......................}..#0A}#0A#0ALET.t=
rnext(next)<BR>.BE.{.IF.next&lt;0.DO.out1(s_rtrn)#0A.................<BR>=
.....IF.next&gt;0.DO.out2(s_jump,.next)#0A............<BR>........}#0A.#0=
ALET.trans(x,.next).BE#0A//.x.......<BR>is.the.command.to.translate#0A//.=
next&lt;0..compile.x.<BR>followed.by.RTRN#0A//.next&gt;0..compile.x.follo=
wed.by<BR>.JUMP.next#0A//.next#3D0..compile.x.only#0A{.LET.sw<BR>.#3D.FAL=
SE#0A...IF.x#3D0.DO.{.trnext(next);.RETURN.<BR>}#0A.#0A...SWITCHON.h1!x.I=
NTO#0A...{.DEFAULT:.trner<BR>r("Compiler.error.in.Trans");.RETURN#0A.#0A.=
.....CA<BR>SE.s_let:#0A......{.LET.cc.#3D.casecount#0A........<BR>.LET.e,=
.s,.s1.#3D.dvece,.ssp,.0#0A.........LET.v.#3D<BR>.vecssp#0A.........casec=
ount.:#3D.-1.//.Disallow.CA<BR>SE.and.DEFAULT.labels#0A.........context,.=
comline.:<BR>#3D.x,.h4!x#0A.........declnames(h2!x)#0A.........c<BR>heckd=
istinct(e)#0A.........vecssp,.s1.:#3D.ssp,.ssp<BR>#0A.........ssp.:#3D.s#=
0A.........context,.comline.<BR>:#3D.x,.h4!x#0A.........transdef(h2!x)#0A=
.........U<BR>NLESS.ssp#3Ds1.DO.trnerr("Lhs.and.rhs.do.not.match"<BR>)#0A=
.........UNLESS.ssp#3Dvecssp.DO.{.ssp.:#3D.vecs<BR>sp;.out2(s_stack,.ssp)=
.}#0A.........out1(s_store)#0A<BR>.........decllabels(h3!x)#0A.........tr=
ans(h3!x,.ne<BR>xt)#0A.........vecssp.:#3D.v#0A.........UNLESS.ssp#3D<BR>=
s.DO.out2(s_stack,.s)#0A.........ssp.:#3D.s#0A.....<BR>....casecount.:#3D=
.cc#0A.........undeclare(e)#0A...<BR>......RETURN#0A......}#0A.#0A......C=
ASE.s_static:#0A<BR>......CASE.s_global:#0A......CASE.s_manifest:#0A...<B=
R>...{.LET.cc.#3D.casecount#0A.........LET.e,.s.#3D.d<BR>vece,.ssp#0A....=
.....AND.op.#3D.h1!x#0A.........AND<BR>.y,.n.#3D.h2!x,.0#0A.........LET.p=
revk.#3D.-1#0A...<BR>......#0A.........casecount.:#3D.-1.//.Disallow.CAS<=
BR>E.and.DEFAULT.labels#0A.........context,.comline.:#3D<BR>.x,.h4!x#0A.#=
0A.........UNTIL.y#3D0.DO#0A.........{<BR>.context,.comline.:#3D.y,.h5!y#=
0A............n.:#3D<BR>.h4!y.-&gt;.evalconst(h4!y),.prevk+1#0A..........=
..con<BR>text,.comline.:#3D.y,.h5!y#0A............prevk.:#3D<BR>.n#0A....=
........IF.op#3Ds_static.DO.{.LET.k.#3D.n#0A<BR>.........................=
........n.:#3D.nextlab()#0A<BR>.................................out2(s_da=
talab,.n)<BR>#0A.................................out2(s_itemn,.k<BR>)#0A.=
.............................}#0A............I<BR>F.op#3Ds_global.UNLESS.=
0&lt;#3Dn&lt;#3D65535.DO#0A.......<BR>........trnerr("Global.number.too.l=
arge.for:.%s*n",<BR>.@h3!(h3!y))#0A............addname(h3!y,.op,.n)#0A.<B=
R>...........IF.xrefing.DO.xref(h3!y,#0A.............<BR>................=
..(op#3Ds_global-&gt;"G:",op#3Ds_stati<BR>c-&gt;"S:","M:"),#0A...........=
....................n,#0A<BR>...............................s_constdef#0A=
.......<BR>.......................)#0A............y.:#3D.h2!y#0A<BR>.....=
....}#0A.#0A.........decllabels(h3!x)#0A......<BR>...trans(h3!x,.next)#0A=
.........ssp.:#3D.s#0A......<BR>...casecount.:#3D.cc#0A.........undeclare=
(e)#0A....<BR>.....RETURN#0A......}#0A.#0A.#0A......CASE.s_ass:#0A<BR>...=
......context,.comline.:#3D.x,.h4!x#0A.........a<BR>ssign(h2!x,.h3!x)#0A.=
........trnext(next)#0A.......<BR>..RETURN#0A.#0A......CASE.s_rtap:#0A...=
...{.LET.s.#3D<BR>.ssp#0A.........context,.comline.:#3D.x,.h4!x#0A...<BR>=
......ssp.:#3D.ssp+savespacesize#0A.........out2(s_<BR>stack,.ssp)#0A....=
.....loadlist(h3!x)#0A.........lo<BR>ad(h2!x)#0A.........out2(s_rtap,.s)#=
0A.........ssp.<BR>:#3D.s#0A.........trnext(next)#0A.........RETURN#0A<BR=
>......}#0A.#0A......CASE.s_goto:#0A.........context<BR>,.comline.:#3D.x,=
.h3!x#0A.........load(h2!x)#0A....<BR>.....out1(s_goto)#0A.........ssp.:#=
3D.ssp-1#0A.....<BR>....RETURN#0A.#0A......CASE.s_colon:#0A.........con<B=
R>text,.comline.:#3D.x,.h5!x#0A.........out2(s_lab,.h<BR>4!x)#0A.........=
trans(h3!x,.next)#0A.........RETURN<BR>#0A.#0A......CASE.s_unless:.sw.:#3=
D.TRUE#0A......CA<BR>SE.s_if:#0A.........context,.comline.:#3D.x,.h4!x#0A=
<BR>.........TEST.next&gt;0.THEN.{.jumpcond(h2!x,.sw,.next<BR>)#0A.......=
......................trans(h3!x,.next)#0A<BR>..........................}=
#0A.....................<BR>ELSE.{.LET.l.#3D.nextlab()#0A................=
......<BR>.......jumpcond(h2!x,.sw,.l)#0A....................<BR>........=
.trans(h3!x,.next)#0A......................<BR>.......out2(s_lab,.l)#0A..=
.........................<BR>..trnext(next)#0A..........................}=
#0A....<BR>.....RETURN#0A.#0A......CASE.s_test:#0A......{.LET.<BR>l,.m.#3=
D.nextlab(),.0#0A.........context,.comline.:<BR>#3D.x,.h5!x#0A.........ju=
mpcond(h2!x,.FALSE,.l)#0A.<BR>........#0A.........TEST.next#3D0.THEN.{.m.=
:#3D.nex<BR>tlab();.trans(h3!x,.m).}#0A.....................ELS<BR>E.tran=
s(h3!x,.next)#0A.....................#0A.....<BR>....out2(s_lab,.l)#0A...=
......trans(h4!x,.next)#0A.<BR>........UNLESS.m#3D0.DO.out2(s_lab,.m)#0A.=
........R<BR>ETURN#0A......}#0A.#0A......CASE.s_loop:#0A........<BR>.cont=
ext,.comline.:#3D.x,.h2!x#0A.........IF.loopla<BR>b&lt;0.DO.trnerr("Illeg=
al.use.of.LOOP")#0A.........IF.<BR>looplab#3D0.DO.looplab.:#3D.nextlab()#=
0A.........ou<BR>t2(s_jump,.looplab)#0A.........RETURN#0A.#0A......C<BR>A=
SE.s_break:#0A.........context,.comline.:#3D.x,.h2<BR>!x#0A.........IF.br=
eaklab#3D-2.DO.trnerr("Illegal.u<BR>se.of.BREAK")#0A.........IF.breaklab#=
3D-1.DO.{.out1<BR>(s_rtrn);.RETURN.}#0A.........IF.breaklab#3D.0.DO.b<BR>=
reaklab.:#3D.nextlab()#0A.........out2(s_jump,.brea<BR>klab)#0A.........R=
ETURN#0A.#0A......CASE.s_return:#0A<BR>.........context,.comline.:#3D.x,.=
h2!x#0A.........o<BR>ut1(s_rtrn)#0A.........RETURN#0A.#0A......CASE.s_sk<=
BR>ip:..//.MR.05/4/06#0A.........trnext(next)#0A......<BR>...RETURN#0A#0A=
......CASE.s_finish:#0A.........cont<BR>ext,.comline.:#3D.x,.h2!x#0A.....=
....out1(s_finish)<BR>#0A.........RETURN#0A.#0A......CASE.s_resultis:#0A.=
<BR>........context,.comline.:#3D.x,.h3!x#0A.........IF<BR>.resultlab#3D-=
1.DO.{.fnbody(h2!x);.RETURN.}#0A.....<BR>....UNLESS.resultlab&gt;0.DO.trn=
err("RESULTIS.out.of.c<BR>ontext")#0A.........load(h2!x)#0A.........out2(=
s_re<BR>s,.resultlab)#0A.........ssp.:#3D.ssp.-.1#0A.......<BR>..RETURN#0=
A.#0A......CASE.s_while:.sw.:#3D.TRUE#0A.<BR>.....CASE.s_until:#0A......{=
.LET.l,.m.#3D.nextlab()<BR>,.next#0A.........LET.bl,.ll.#3D.breaklab,.loo=
plab#0A<BR>.........context,.comline.:#3D.x,.h4!x#0A.........b<BR>reaklab=
,.looplab.:#3D.next,.0#0A.........IF.next&lt;#3D<BR>0.DO.m.:#3D.nextlab()=
#0A.........IF.next.#3D0.DO.br<BR>eaklab.:#3D.m#0A.........jumpcond(h2!x,=
.~sw,.m)#0A.<BR>........out2(s_lab,.l)#0A.........trans(h3!x,.0)#0A<BR>..=
.......UNLESS.looplab#3D0.DO.out2(s_lab,.looplab)<BR>#0A.........context,=
.comline.:#3D.x,.h4!x#0A.......<BR>..jumpcond(h2!x,.sw,.l)#0A.........IF.=
next&lt;#3D0.DO.<BR>out2(s_lab,.m)#0A.........trnext(next)#0A.........b<B=
R>reaklab,.looplab.:#3D.bl,.ll#0A.........RETURN#0A..<BR>....}#0A.#0A....=
..CASE.s_repeatwhile:.sw.:#3D.TRUE#0A<BR>......CASE.s_repeatuntil:#0A....=
..{.LET.l,.bl,.ll.#3D<BR>.nextlab(),.breaklab,.looplab#0A.........context=
,.c<BR>omline.:#3D.x,.h4!x#0A.........breaklab,.looplab.:#3D<BR>.next,.0#=
0A.........out2(s_lab,.l)#0A.........trans<BR>(h2!x,.0)#0A.........UNLESS=
.looplab#3D0.DO.out2(s_l<BR>ab,.looplab)#0A.........context,.comline.:#3D=
.x,.h4<BR>!x#0A.........jumpcond(h3!x,.sw,.l)#0A#0A//.......U<BR>NLESS.br=
eaklab#3D0.DO.out2(s_lab,.breaklab)#0A.....<BR>....IF.next#3D0.&amp;.brea=
klab&gt;0.DO.out2(s_lab,.breakla<BR>b)#0A#0A.........trnext(next)#0A.....=
....breaklab,.<BR>looplab.:#3D.bl,.ll#0A.........RETURN#0A......}#0A.<BR>=
#0A......CASE.s_repeat:#0A......{.LET.bl,.ll.#3D.br<BR>eaklab,.looplab#0A=
.........context,.comline.:#3D.x,<BR>.h4!x#0A.........breaklab,.looplab.:=
#3D.next,.nextl<BR>ab()#0A.........out2(s_lab,.looplab)#0A#0A.........<BR=
>trans(h2!x,.looplab)#0A#0A.........IF.next#3D0.&amp;.br<BR>eaklab&gt;0.D=
O.out2(s_lab,.breaklab)#0A#0A.........bre<BR>aklab,.looplab.:#3D.bl,.ll#0=
A.........RETURN#0A....<BR>..}#0A.#0A......CASE.s_case:#0A......{.LET.l,.=
k,.cl<BR>.#3D.nextlab(),.?,.caselist#0A.........context,.com<BR>line.:#3D=
.x,.h4!x#0A.........k.:#3D.evalconst(h2!x)<BR>#0A.........IF.casecount&lt=
;0.DO.trnerr("CASE.label.ou<BR>t.of.context")#0A.........UNTIL.cl#3D0.DO#=
0A.......<BR>..{.IF.h2!cl#3Dk.DO.trnerr("'CASE.%n:'.occurs.twice<BR>",.k)=
#0A............cl.:#3D.h1!cl#0A.........}#0A..<BR>.......caselist.:#3D.ne=
wblk(caselist,.k,.l)#0A.....<BR>....casecount.:#3D.casecount.+.1#0A......=
...out2(s_<BR>lab,.l)#0A.........trans(h3!x,.next)#0A.........RET<BR>URN#=
0A......}#0A.#0A......CASE.s_default:#0A.......<BR>..context,.comline.:#3=
D.x,.h3!x#0A.........IF.casec<BR>ount&lt;0.|.defaultlab~#3D0.DO.trnerr("B=
ad.DEFAULT.lab<BR>el")#0A.........defaultlab.:#3D.nextlab()#0A.......<BR>=
..out2(s_lab,.defaultlab)#0A.........trans(h2!x,.ne<BR>xt)#0A.........RET=
URN#0A.#0A......CASE.s_endcase:#0A<BR>.........context,.comline.:#3D.x,.h=
2!x#0A.........I<BR>F.endcaselab#3D-2.DO.trnerr("Illegal.use.of.ENDCASE<B=
R>")#0A.........IF.endcaselab#3D-1.DO.out1(s_rtrn)#0A<BR>.........//.endc=
aselab.is.never.equal.to.0#0A......<BR>...IF.endcaselab&gt;0..DO.out2(s_j=
ump,.endcaselab)#0A.<BR>........RETURN#0A.#0A......CASE.s_switchon:#0A...=
..<BR>....transswitch(x,.next)#0A.........RETURN#0A.#0A..<BR>....CASE.s_f=
or:#0A.........transfor(x,.next)#0A....<BR>.....RETURN#0A.#0A......CASE.s=
_seq:#0A.........tran<BR>s(h2!x,.0)#0A.........x.:#3D.h3!x#0A...}#0A}.REP=
EAT<BR>#0A#0ALET.declnames(x).BE.UNLESS.x#3D0.SWITCHON.h1!<BR>x.INTO#0A.#=
0A{..DEFAULT:.......trnerr("Compiler.err<BR>or.in.Declnames")#0A.........=
..........RETURN#0A.#0A<BR>....CASE.s_vecdef:#0A....CASE.s_valdef:.contex=
t,.co<BR>mline.:#3D.x,.h4!x#0A...................decldyn(h2!<BR>x)#0A....=
...............RETURN#0A.#0A....CASE.s_rtd<BR>ef:#0A....CASE.s_fndef:..co=
ntext,.comline.:#3D.x,.h<BR>6!x#0A...................h5!x.:#3D.nextlab()#=
0A....<BR>...............declstat(h2!x,.h5!x)#0A.............<BR>......RE=
TURN#0A.#0A....CASE.s_and:....declnames(h2!<BR>x)#0A...................de=
clnames(h3!x)#0A}#0A.#0AA<BR>ND.decldyn(x).BE.UNLESS.x#3D0.DO#0A.#0A{.IF.=
h1!x#3D<BR>s_name..DO.{.addname(x,.s_local,.ssp)#0A...........<BR>.......=
.......//IF.xrefing.DO.xref(x,."P:",.ssp,.h1<BR>!context)#0A.............=
............ssp.:#3D.ssp.+<BR>.1#0A.........................RETURN#0A....=
........<BR>..........}#0A.#0A...IF.h1!x#3Ds_comma.DO.{.addname<BR>(h2!x,=
.s_local,.ssp)#0A.........................//I<BR>F.xrefing.DO.xref(h2!x,.=
"P:",.ssp,.h1!context)#0A..<BR>.......................ssp.:#3D.ssp.+.1#0A=
.........<BR>................decldyn(h3!x)#0A...................<BR>.....=
.RETURN#0A......................}#0A.#0A...trn<BR>err("Compiler.error.in.=
Decldyn")#0A}#0A.#0AAND.decl<BR>stat(x,.lab).BE#0A{.LET.c.#3D.cellwithnam=
e(x)#0A.#0A<BR>..TEST.h2!c#3Ds_global.THEN.{.LET.gn.#3D.h3!c#0A...<BR>...=
......................gdeflist.:#3D.newblk(gdefl<BR>ist,.gn,.lab)#0A.....=
.......................gdefcou<BR>nt.:#3D.gdefcount.+.1#0A...............=
............<BR>.addname(x,.s_global,.gn)#0A.......................<BR>..=
...IF.xrefing.DO.xref(x,."G:",.gn,.h1!context)#0A<BR>....................=
........IF.gdefsing.DO.writef("<BR>G%i3.#3D.%s*n",.gn,.@h3!x)#0A.........=
.............<BR>....}#0A.....................ELSE.{.addname(x,.s_la<BR>b=
el,.lab)#0A............................IF.xrefing.<BR>DO.xref(x,."F:",.la=
b,.h1!context)#0A...............<BR>...........}#0A}#0A.#0AAND.decllabels=
(x).BE#0A{.LET<BR>.e.#3D.dvece#0A..scanlabels(x)#0A..checkdistinct(e)<BR>=
#0A}#0A.#0AAND.checkdistinct(p).BE#0A{.LET.lim.#3D.<BR>dvece.-.3#0A..FOR.=
q.#3D.p.TO.lim-3.BY.3.DO#0A..{.LE<BR>T.n.#3D.h1!q#0A....FOR.c.#3D.q+3.TO.=
lim.BY.3.DO#0A.<BR>.......IF.h1!c#3Dn.DO.trnerr("Name.%s.defined.twice<BR=
>",.@h3!n)#0A..}#0A}#0A.#0AAND.addname(name,.k,.a).B<BR>E#0A{.LET.p.#3D.d=
vece.+.3#0A..IF.p&gt;dvect.DO.trnerr(<BR>"More.workspace.needed")#0A..h1!=
dvece,.h2!dvece,.h3<BR>!dvece.:#3D.name,.k,.a#0A..h2!name.:#3D.dvece.//.R=
e<BR>member.the.declaration#0A..dvece.:#3D.p#0A}#0A.#0AA<BR>ND.undeclare(=
e).BE.#0A{.FOR.t.#3D.e.TO.dvece-3.BY.3<BR>.DO#0A..{.LET.name.#3D.h1!t#0A.=
...h2!name.:#3D.0...<BR>//.Forget.its.declaration#0A..}#0A..dvece.:#3D.e#=
0A<BR>}#0A#0AAND.cellwithname(n).#3D.VALOF#0A{.LET.t.#3D.<BR>h2!n#0A..IF.=
t.RESULTIS.t..//.It.has.been.looked.up.<BR>before#0A..t.:#3D.dvece#0A..t.=
:#3D.t.-.3.REPEATUNTI<BR>L.h1!t#3Dn.|.h1!t#3D0#0A..h2!n.:#3D.t..//.Associ=
ate<BR>.the.name.with.declaration.item#0A..RESULTIS.t#0A}#0A<BR>.#0AAND.s=
canlabels(x).BE.UNLESS.x#3D0.SWITCHON.h1!x<BR>.INTO#0A.#0A{.CASE.s_colon:=
...context,.comline.:#3D<BR>.x,.h5!x#0A..................h4!x.:#3D.nextla=
b()#0A<BR>..................declstat(h2!x,.h4!x)#0A.#0A..CASE<BR>.s_if:.C=
ASE.s_unless:.CASE.s_while:.CASE.s_until:#0A<BR>..CASE.s_switchon:.CASE.s=
_case:#0A.................<BR>.scanlabels(h3!x)#0A..................RETUR=
N#0A.#0A<BR>..CASE.s_seq:.....scanlabels(h3!x)#0A.#0A..CASE.s_r<BR>epeat:=
.CASE.s_repeatwhile:.CASE.s_repeatuntil:#0A..<BR>CASE.s_default:.scanlabe=
ls(h2!x)#0A................<BR>..RETURN#0A.#0A..CASE.s_test:....scanlabel=
s(h3!x)#0A<BR>..................scanlabels(h4!x)#0A..DEFAULT:....<BR>....=
RETURN#0A}#0A.#0AAND.transdef(x).BE#0A{.LET.ctx<BR>t,.ln.#3D.context,.com=
line#0A..transdyndefs(x)#0A..<BR>context,.comline.:#3D.ctxt,.ln#0A..IF.st=
atdefs(x).D<BR>O.{.LET.l,.s#3D.nextlab(),.ssp#0A..................<BR>...=
.out2(s_jump,.l)#0A......................transst<BR>atdefs(x)#0A.........=
.............ssp.:#3D.s#0A....<BR>..................out2(s_stack,.ssp)#0A=
............<BR>..........out2(s_lab,.l)#0A....................}#0A<BR>..=
context,.comline.:#3D.ctxt,.ln#0A}#0A.#0A.#0AAND.<BR>transdyndefs(x).BE.S=
WITCHON.h1!x.INTO#0A{.CASE.s_an<BR>d:....transdyndefs(h2!x)#0A...........=
......transdy<BR>ndefs(h3!x)#0A.................RETURN#0A.#0A..CASE.<BR>s=
_vecdef:.context,.comline.:#3D.x,.h4!x#0A.........<BR>........out2(s_llp,=
.vecssp)#0A.................ssp.<BR>:#3D.ssp.+.1#0A.................vecss=
p.:#3D.vecssp.<BR>+.1.+.evalconst(h3!x)#0A.................RETURN#0A.<BR>=
#0A..CASE.s_valdef:.context,.comline.:#3D.h3!x,.h4!<BR>x#0A..............=
...loadlist(h3!x)#0A.#0A..DEFAULT<BR>:.......RETURN#0A}#0A.#0AAND.transst=
atdefs(x).BE.SW<BR>ITCHON.h1!x.INTO#0A{.CASE.s_and:..transstatdefs(h2!<BR=
>x)#0A...............transstatdefs(h3!x)#0A.........<BR>......RETURN#0A.#=
0A..CASE.s_fndef:#0A..CASE.s_rtdef<BR>:#0A.............{.LET.e,.p.#3D.dve=
ce,.dvecp#0A....<BR>...........AND.oldpn.#3D.procname#0A...............<B=
R>AND.bl,.ll.#3D.breaklab,..looplab#0A...............<BR>AND.rl,.el.#3D.r=
esultlab,.endcaselab#0A............<BR>...AND.cl,.cc.#3D.caselist,..casec=
ount#0A..........<BR>.....breaklab,..looplab....:#3D.-2,.-2#0A..........<=
BR>.....resultlab,.endcaselab.:#3D.-2,.-2#0A..........<BR>.....caselist,.=
.casecount..:#3D..0,.-1#0A..........<BR>.....procname.:#3D.h2!x#0A.......=
........context,.c<BR>omline.:#3D.x,.h6!x#0A...............out2(s_entry,.=
<BR>h5!x)#0A...............outstring(@h3!procname)#0A..<BR>.............s=
sp.:#3D.savespacesize#0A.............<BR>..dvecp.:#3D.dvece#0A...........=
....context,.comlin<BR>e.:#3D.x,.h6!x#0A...............decldyn(h3!x)#0A..=
.<BR>............checkdistinct(e)#0A...............conte<BR>xt,.comline.:=
#3D.h4!x,.h6!x#0A...............declla<BR>bels(h4!x)#0A...............out=
2(s_save,.ssp)#0A...<BR>............context,.comline.:#3D.h4!x,.h6!x#0A..=
..<BR>...........TEST.h1!x#3Ds_rtdef.THEN.trans(h4!x,.-1)<BR>#0A.........=
........................ELSE.fnbody(h4!<BR>x)#0A...............out1(s_end=
proc)#0A.#0A.........<BR>......breaklab,..looplab....:#3D.bl,.ll#0A......=
...<BR>......resultlab,.endcaselab.:#3D.rl,.el#0A.........<BR>......casel=
ist,..casecount..:#3D.cl,.cc#0A.........<BR>......procname.:#3D.oldpn#0A.=
..............dvecp.:#3D<BR>.p#0A...............undeclare(e)#0A..........=
...}#0A<BR>.#0A..DEFAULT:.....RETURN#0A}#0A.#0AAND.statdefs(x)<BR>.#3D.h1=
!x#3Ds_fndef.|.h1!x#3Ds_rtdef.-&gt;.TRUE,#0A...<BR>...............h1!x.~#=
3D.s_and...............-&gt;.FAL<BR>SE,#0A..................statdefs(h2!x=
).............<BR>.-&gt;.TRUE,#0A..................statdefs(h3!x)#0A.#0A<=
BR>.#0ALET.jumpcond(x,.b,.l).BE#0A{.LET.sw.#3D.b#0A#0A<BR>..SWITCHON.h1!x=
.INTO#0A..{.CASE.s_false:..b.:#3D.NO<BR>T.b#0A....CASE.s_true:...IF.b.DO.=
out2(s_jump,.l)#0A<BR>...................RETURN#0A.#0A....CASE.s_not:....=
<BR>jumpcond(h2!x,.NOT.b,.l)#0A...................RETUR<BR>N#0A.#0A....CA=
SE.s_logand:.sw.:#3D.NOT.sw#0A....CAS<BR>E.s_logor:..TEST.sw.THEN.{.jumpc=
ond(h2!x,.b,.l)#0A.<BR>.................................jumpcond(h3!x,.b,=
.<BR>l)#0A..................................RETURN#0A...<BR>.............=
................}#0A.#0A..............<BR>.............ELSE.{.LET.m.#3D.n=
extlab()#0A.........<BR>.........................jumpcond(h2!x,.NOT.b,.m)=
#0A<BR>..................................jumpcond(h3!x,.b,<BR>.l)#0A.....=
.............................out2(s_lab,<BR>.m)#0A.......................=
...........RETURN#0A..<BR>..............................}#0A.#0A....DEFAU=
LT:.<BR>......load(x)#0A...................out2(b.-&gt;.s_jt,.<BR>s_jf,.l=
)#0A...................ssp.:#3D.ssp.-.1#0A..<BR>.................RETURN#0=
A..}#0A}#0A.#0AAND.transsw<BR>itch(x,.next).BE#0A{.LET.cl,.cc.#3D.caselis=
t,.casec<BR>ount.#0A..LET.dl,.el.#3D.defaultlab,.endcaselab#0A.<BR>.LET.l=
,.dlab.#3D.nextlab(),.?#0A..caselist,.casecou<BR>nt,.defaultlab.:#3D.0,.0=
,.0#0A..endcaselab.:#3D.nex<BR>t#3D0.-&gt;.nextlab(),.next#0A.#0A..contex=
t,.comline.:<BR>#3D.x,.h4!x#0A..out2(s_jump,.l)#0A..trans(h3!x,.end<BR>ca=
selab)#0A.#0A..context,.comline.:#3D.x,.h4!x#0A..<BR>out2(s_lab,.l)#0A..l=
oad(h2!x)#0A#0A..dlab.:#3D.defa<BR>ultlab&gt;0.-&gt;.defaultlab,#0A......=
....endcaselab&gt;0.-&gt;<BR>.endcaselab,#0A..........nextlab()#0A#0A..ou=
t2(s_sw<BR>itchon,.casecount);.out1(dlab).#0A..UNTIL.caselist#3D<BR>0.DO.=
{.out2(h2!caselist,.h3!caselist)#0A...........<BR>.............caselist.:=
#3D.h1!caselist#0A..........<BR>............}#0A..ssp.:#3D.ssp.-.1#0A#0A.=
.IF.next#3D<BR>0................DO...out2(s_lab,.endcaselab)#0A..I<BR>F.n=
ext&lt;0.&amp;.defaultlab#3D0.DO.{.out2(s_lab,.dlab)#0A<BR>..............=
..................out1(s_rtrn)#0A....<BR>..........................}#0A#0=
A..defaultlab,.endc<BR>aselab.:#3D.dl,.el#0A..caselist,...casecount..:#3D=
.<BR>cl,.cc#0A}#0A.#0AAND.transfor(x,.next).BE#0A{.LET.e<BR>,.m,.blab.#3D=
.dvece,.nextlab(),.0#0A..LET.bl,.ll.#3D<BR>.breaklab,.looplab#0A..LET.cc.=
#3D.casecount#0A..LET<BR>.k,.n,.step.#3D.0,.0,.1#0A..LET.s.#3D.ssp#0A#0A.=
.ca<BR>secount.:#3D.-1..//.Disallow.CASE.and.DEFAULT.label<BR>s#2E...#0A.=
.breaklab,.looplab.:#3D.next,.0#0A...#0A<BR>..context,.comline.:#3D.x,.h7=
!x#0A.#0A..addname(h2!<BR>x,.s_local,.s)#0A..load(h3!x).......//.The.init=
ial.<BR>value#0A.#0A..//.Set.k,.n.to.load.the.end.limit#0A.<BR>.TEST.h1!(=
h4!x)#3Ds_number.THEN....k,.n.:#3D.s_ln,.<BR>h2!(h4!x)#0A................=
..........ELSE.{.k,.n.:<BR>#3D.s_lp,.ssp#0A..............................=
...lo<BR>ad(h4!x)#0A...............................}#0A.#0A.<BR>.UNLESS.h=
5!x#3D0.DO.step.:#3D.evalconst(h5!x)#0A.#0A<BR>..out1(s_store)#0A...#0A..=
TEST.k#3Ds_ln.&amp;.h1!(h3!x)<BR>#3Ds_number..//.check.for.constant.limit=
s.#0A..THEN<BR>.{.LET.initval.#3D.h2!(h3!x)#0A.........IF.step&gt;#3D<BR>=
0.&amp;.initval&gt;n.|.step&lt;0.&amp;.initval&lt;n.DO#0A.........{.<BR>T=
EST.next&lt;0#0A...........THEN.out1(s_rtrn)#0A......<BR>.....ELSE.TEST.n=
ext&gt;0#0A................THEN.out2(s<BR>_jump,.next)#0A................=
ELSE.{.blab.:#3D.bre<BR>aklab&gt;0.-&gt;.breaklab,.nextlab()#0A..........=
........<BR>.....out2(s_jump,.blab)#0A.....................}#0A<BR>......=
...}#0A.......}#0A..ELSE.{.IF.next&lt;#3D0.DO.bl<BR>ab.:#3D.nextlab()#0A.=
........out2(s_lp,.s)#0A......<BR>...out2(k,.n)#0A.........out1(step&gt;#=
3D0.-&gt;.s_gr,.s_<BR>ls)#0A.........out2(s_jt,.next&gt;0.-&gt;.next,.bla=
b)#0A.<BR>......}#0A#0A..IF.breaklab#3D0.&amp;.blab&gt;0.DO.breaklab<BR>.=
:#3D.blab#0A...#0A..context,.comline.:#3D.x,.h7!x#0A<BR>..decllabels(h6!x=
)#0A..context,.comline.:#3D.x,.h7!<BR>x#0A..out2(s_lab,.m)#0A..trans(h6!x=
,.0)#0A..UNLESS.<BR>looplab#3D0.DO.out2(s_lab,.looplab)#0A..out2(s_lp,.<B=
R>s);.out2(s_ln,.step);.out1(s_plus);.out2(s_sp,.s)#0A<BR>..out2(s_lp,s);=
.out2(k,n);.out1(step&gt;#3D0.-&gt;.s_le,.<BR>s_ge)#0A..out2(s_jt,.m)#0A.=
#0A..IF.next&lt;#3D0.TEST.b<BR>lab&gt;0.#0A.............THEN.............=
.....out2(s_<BR>lab,.blab)#0A.............ELSE.IF.breaklab&gt;0.DO.out<BR=
>2(s_lab,.breaklab)#0A..trnext(next)#0A..casecount.:<BR>#3D.cc#0A..breakl=
ab,.looplab,.ssp.:#3D.bl,.ll,.s#0A<BR>..out2(s_stack,.ssp)#0A..undeclare(=
e)#0A}#0A.#0ALET<BR>.load(x).BE#0A{.LET.op.#3D.h1!x#0A#0A..IF.isconst(x<B=
R>).DO#0A..{.out2(s_ln,.evalconst(x))#0A....ssp.:#3D.<BR>ssp.+.1#0A....RE=
TURN#0A..}#0A.#0A..SWITCHON.op.INTO<BR>#0A..{.DEFAULT:..........trnerr("C=
ompiler.error.in.<BR>Load")#0A......................out2(s_ln,.0)#0A....<=
BR>..................ssp.:#3D.ssp.+.1#0A..............<BR>........RETURN#=
0A.#0A....CASE.s_of:......{.LET.slct<BR>.#3D.evalconst(h2!x).//.Inserted.=
11/7/01#0A........<BR>..............LET.len.#3D.slct&gt;&gt;24#0A........=
......<BR>........LET.sh..#3D.slct&gt;&gt;16.&amp;.255#0A..............<B=
R>........LET.offset.#3D.slct.&amp;.#23xFFFF#0A..........<BR>............=
load(h3!x)#0A......................IF.o<BR>ffset.DO.{.out2(s_ln,.offset);=
.out1(s_plus).}#0A...<BR>...................out1(s_rv)#0A................=
...<BR>...IF.sh.DO.{.out2(s_ln,.sh);.out1(s_rshift).}#0A..<BR>...........=
.........IF.len&gt;0.&amp;.len+sh&lt;32.DO....//.A<BR>ssume.a.32.bit.m/c#=
0A......................{.LET.ma<BR>sk.#3D.(1&lt;&lt;len)-1#0A...........=
.............out2(s_<BR>ln,.mask)#0A........................out1(s_logand=
)#0A<BR>......................}#0A......................RET<BR>URN#0A....=
................}#0A#0A....CASE.s_byteap:<BR>....op:#3Ds_getbyte#0A#0A...=
.CASE.s_div:.CASE.s_rem<BR>:.CASE.s_minus:#0A....CASE.s_ls:.CASE.s_gr:.CA=
SE.s_<BR>le:.CASE.s_ge:#0A....CASE.s_lshift:.CASE.s_rshift:#0A<BR>.......=
...............load(h2!x);.load(h3!x);.out1(<BR>op)#0A...................=
...ssp.:#3D.ssp.-.1#0A....<BR>..................RETURN#0A.#0A....CASE.s_v=
ecap:.CA<BR>SE.s_mult:.CASE.s_plus:.CASE.s_eq:.CASE.s_ne:#0A...<BR>.CASE.=
s_logand:.CASE.s_logor:.CASE.s_eqv:.CASE.s_ne<BR>qv:#0A.........{.LET.a,.=
b.#3D.h2!x,.h3!x#0A........<BR>...TEST.h1!a#3Ds_name.|#0A................=
h1!a#3Ds_<BR>number.THEN.{.load(b);.load(a).}#0A................<BR>.....=
.........ELSE.{.load(a);.load(b).}#0A.........<BR>..TEST.op#3Ds_vecap.THE=
N.out2(s_plus,.s_rv)#0A.....<BR>......................ELSE.out1(op)#0A...=
........ss<BR>p.:#3D.ssp.-.1#0A...........RETURN#0A.........}#0A.<BR>#0A.=
...CASE.s_neg:.CASE.s_not:.CASE.s_rv:.CASE.s_ab<BR>s:#0A.................=
.....load(h2!x)#0A...........<BR>...........out1(op)#0A..................=
....RETURN#0A<BR>.#0A....CASE.s_true:.CASE.s_false:.CASE.s_query:#0A<BR>.=
.....................out1(op)#0A..................<BR>....ssp.:#3D.ssp.+.=
1#0A......................RETURN<BR>#0A.#0A....CASE.s_lv:........loadlv(h=
2!x);.RETURN#0A<BR>.#0A....CASE.s_number:....out2(s_ln,.h2!x);.ssp.:#3D<B=
R>.ssp.+.1;.RETURN#0A.#0A....CASE.s_string:....out1(s<BR>_lstr)#0A.......=
...............outstring(@.h2!x)#0A<BR>......................ssp.:#3D.ssp=
.+.1#0A..........<BR>............RETURN#0A.#0A....CASE.s_name:......tran<=
BR>sname(x,.s_lp,.s_lg,.s_ll,.s_lf,.s_ln)#0A..........<BR>............ssp=
.:#3D.ssp.+.1#0A....................<BR>..RETURN#0A.#0A....CASE.s_valof:.=
..{.LET.e,.rl,.cc.<BR>#3D.dvece,.resultlab,.casecount#0A.................=
<BR>.....casecount.:#3D.-1.//.Disallow.CASE.&amp;.DEFAULT.l<BR>abels#0A..=
....................resultlab.:#3D.nextla<BR>b()#0A......................=
decllabels(h2!x)#0A....<BR>..................trans(h2!x,.0)#0A...........=
.....<BR>......out2(s_lab,.resultlab)#0A....................<BR>..out2(s_=
rstack,.ssp)#0A......................ssp.:<BR>#3D.ssp.+.1#0A.............=
.........resultlab,.case<BR>count.:#3D.rl,.cc#0A......................und=
eclare<BR>(e)#0A......................RETURN#0A..............<BR>......}#=
0A.#0A....CASE.s_fnap:....{.LET.s.#3D.ssp#0A<BR>......................ssp=
.:#3D.ssp.+.savespacesize#0A<BR>......................out2(s_stack,.ssp)#=
0A........<BR>..............loadlist(h3!x)#0A....................<BR>..lo=
ad(h2!x)#0A......................out2(s_fnap,.s<BR>)#0A..................=
....ssp.:#3D.s.+.1#0A........<BR>..............RETURN#0A.................=
...}#0A.#0A<BR>....CASE.s_cond:....{.LET.l,.m.#3D.nextlab(),.nextl<BR>ab(=
)#0A......................LET.s.#3D.ssp#0A......<BR>................jumpc=
ond(h2!x,.FALSE,.m)#0A........<BR>..............load(h3!x)#0A............=
..........ou<BR>t2(s_res,l)#0A......................ssp.:#3D.s;.out<BR>2(=
s_stack,.ssp)#0A......................out2(s_lab,<BR>.m)#0A..............=
........load(h4!x)#0A..........<BR>............out2(s_res,l)#0A..........=
............o<BR>ut2(s_lab,.l)#0A......................out2(s_rstack<BR>,=
s)#0A......................RETURN#0A..............<BR>......}#0A.#0A....C=
ASE.s_table:...{.LET.m.#3D.nextl<BR>ab()#0A......................out2(s_d=
atalab,.m)#0A.<BR>.....................x.:#3D.h2!x#0A................<BR>=
......WHILE.h1!x#3Ds_comma.DO#0A...................<BR>...{.out2(s_itemn,=
.evalconst(h2!x))#0A.............<BR>...........x.:#3D.h3!x#0A...........=
...........}#0A<BR>......................out2(s_itemn,.evalconst(x))#0A<B=
R>......................out2(s_lll,.m)#0A............<BR>..........ssp.:#=
3D.ssp.+.1#0A......................<BR>RETURN#0A....................}#0A.=
.}#0A}#0A#0AAND.f<BR>nbody(x).BE.SWITCHON.h1!x.INTO#0A{.DEFAULT:........<=
BR>.load(x)#0A...................out1(s_fnrn)#0A......<BR>.............ss=
p.:#3D.ssp.-.1#0A...................<BR>RETURN#0A...................#0A..=
CASE.s_valof:.{.LE<BR>T.e,.rl,.cc.#3D.dvece,.resultlab,.casecount#0A.....=
<BR>.............casecount.:#3D.-1.//.Disallow.CASE.&amp;.D<BR>EFAULT.lab=
els#0A..................resultlab.:#3D.-1<BR>#0A..................decllab=
els(h2!x)#0A...........<BR>.......trans(h2!x,.-1)#0A..................res=
ultla<BR>b,.casecount.:#3D.rl,.cc#0A..................undecl<BR>are(e)#0A=
..................RETURN#0A...............<BR>.}#0A#0A..CASE.s_cond:..{.L=
ET.l.#3D.nextlab()#0A...<BR>...............jumpcond(h2!x,.FALSE,.l)#0A...=
......<BR>.........fnbody(h3!x)#0A..................out2(s_la<BR>b,.l)#0A=
..................fnbody(h4!x)#0A..........<BR>......}#0A}#0A.#0A.#0AAND.=
loadlv(x).BE#0A{.UNLESS.x<BR>#3D0.SWITCHON.h1!x.INTO#0A..{.DEFAULT:......=
...ENDC<BR>ASE#0A.#0A....CASE.s_name:.....transname(x,.s_llp,.<BR>s_llg,.=
s_lll,.0,.0)#0A.....................ssp.:#3D<BR>.ssp.+.1#0A..............=
.......RETURN#0A.#0A....CA<BR>SE.s_rv:.......load(h2!x)#0A...............=
......RE<BR>TURN#0A.#0A....CASE.s_vecap:.{.LET.a,.b.#3D.h2!x,.h<BR>3!x#0A=
....................IF.h1!a#3Ds_name.DO.a,.b.<BR>:#3D.h3!x,.h2!x#0A......=
..............load(a)#0A...<BR>.................load(b)#0A...............=
.....out1<BR>(s_plus)#0A....................ssp.:#3D.ssp.-.1#0A.<BR>.....=
..............RETURN#0A..................}#0A.<BR>.}#0A#0A..trnerr("Ltype=
.expression.needed")#0A..out<BR>2(s_ln,.0)#0A..ssp.:#3D.ssp.+.1#0A}#0A.#0=
AAND.loadl<BR>ist(x).BE.UNLESS.x#3D0.TEST.h1!x#3Ds_comma#0A......<BR>....=
....................THEN.{.loadlist(h2!x);.load<BR>list(h3!x).}#0A.......=
.......................ELSE.l<BR>oad(x)#0A#0ALET.isconst(x).#3D.VALOF#0A{=
.IF.x#3D0.R<BR>ESULTIS.FALSE#0A.#0A..SWITCHON.h1!x.INTO#0A..{.CASE<BR>.s_=
name:#0A........{.LET.c.#3D.cellwithname(x)#0A..<BR>........RESULTIS.h2!c=
#3Ds_manifest#0A........}#0A.#0A<BR>....CASE.s_number:#0A....CASE.s_slct:=
#0A....CASE.s_<BR>true:#0A....CASE.s_false:..RESULTIS.TRUE#0A.#0A....<BR>=
CASE.s_neg:#0A....CASE.s_abs:#0A....CASE.s_not:....<BR>RESULTIS.isconst(h=
2!x)#0A.......#0A....CASE.s_mult:<BR>#0A....CASE.s_div:#0A....CASE.s_rem:=
#0A....CASE.s_p<BR>lus:#0A....CASE.s_minus:#0A....CASE.s_lshift:#0A...<BR=
>.CASE.s_rshift:#0A....CASE.s_logor:#0A....CASE.s_lo<BR>gand:#0A....CASE.=
s_eqv:#0A....CASE.s_neqv:...IF.isc<BR>onst(h2!x).&amp;.isconst(h3!x).RESU=
LTIS.TRUE#0A#0A....D<BR>EFAULT:.......RESULTIS.FALSE#0A#0A...}#0A}#0A#0AL=
ET<BR>.evalconst(x).#3D.VALOF#0A{.LET.a,.b.#3D.0,.0#0A#0A<BR>..IF.x#3D0.D=
O.{.trnerr("Compiler.error.in.Evalconst<BR>")#0A..............RESULTIS.0#=
0A............}#0A.#0A<BR>..SWITCHON.h1!x.INTO#0A..{.CASE.s_name:.{.LET.c=
.#3D<BR>.cellwithname(x)#0A...................LET.k,.a.#3D.<BR>h2!c,.h3!c=
#0A...................IF.k#3Ds_manifest.D<BR>O#0A...................{.IF.=
xrefing.DO.xref(x,."M:"<BR>,.a,.s_const)#0A.....................RESULTIS.=
a#0A.<BR>..................}#0A...................IF.k.DO.tr<BR>nerr("%s.=
must.be.a.manifest.constant",.@h3!x)#0A...<BR>................trnerr("Nam=
e.'%s'.not.declared",.@h<BR>3!x)#0A...................RESULTIS.0#0A......=
......<BR>.....}#0A.#0A....CASE.s_number:.RESULTIS.h2!x#0A...<BR>.CASE.s_=
true:...RESULTIS.TRUE#0A....CASE.s_false:..<BR>RESULTIS.FALSE#0A....CASE.=
s_query:..RESULTIS.0#0A.#0A<BR>....CASE.s_slct:.{.LET.len,.sh,.offset.#3D=
.0,.0,.0.<BR>....//.Inserted.11/7/01#0A...................IF.h2!<BR>x.DO.=
len....:#3D.evalconst(h2!x)#0A................<BR>...IF.h3!x.DO.sh.....:#=
3D.evalconst(h3!x)#0A.......<BR>............IF.h4!x.DO.offset.:#3D.evalco=
nst(h4!x)#0A<BR>...................UNLESS.0&lt;#3Dlen&lt;#3D255.&amp;.0&l=
t;#3Dsh<BR>&lt;#3D255.&amp;.0&lt;#3Doffset&lt;#3D#23xFFFF.DO#0A..........=
..<BR>...........trnerr("A.field.too.large.in.a.SLCT.expr<BR>ession")#0A.=
..................RESULTIS.len&lt;&lt;24.|.sh<BR>&lt;&lt;16.|.offset#0A..=
...............}#0A#0A....CASE.s_<BR>neg:#0A....CASE.s_abs:#0A....CASE.s_=
not:....a.:#3D.<BR>evalconst(h2!x)#0A...................ENDCASE#0A....<BR=
>...#0A....CASE.s_mult:#0A....CASE.s_div:#0A....CASE<BR>.s_rem:#0A....CAS=
E.s_plus:#0A....CASE.s_minus:#0A..<BR>..CASE.s_lshift:#0A....CASE.s_rshif=
t:#0A....CASE.s_<BR>logor:#0A....CASE.s_logand:#0A....CASE.s_eqv:#0A...<B=
R>.CASE.s_neqv:...a,.b.:#3D.evalconst(h2!x),.evalcons<BR>t(h3!x)#0A......=
.............ENDCASE#0A#0A....DEFAU<BR>LT:#0A..}#0A....#0A..SWITCHON.h1!x=
.INTO#0A..{.CASE.<BR>s_neg:....RESULTIS..-..a#0A....CASE.s_abs:....RESUL<=
BR>TIS.ABS.a#0A....CASE.s_not:....RESULTIS.NOT.a#0A...<BR>....#0A....CASE=
.s_mult:...RESULTIS.a...*....b#0A...<BR>.CASE.s_plus:...RESULTIS.a...+...=
.b#0A....CASE.s_mi<BR>nus:..RESULTIS.a...-....b#0A....CASE.s_lshift:.RESU=
<BR>LTIS.a...&lt;&lt;...b#0A....CASE.s_rshift:.RESULTIS.a...&gt;<BR>&gt;.=
..b#0A....CASE.s_logor:..RESULTIS.a...|....b#0A..<BR>..CASE.s_logand:.RES=
ULTIS.a...&amp;....b#0A....CASE.s_e<BR>qv:....RESULTIS.a..EQV...b#0A....C=
ASE.s_neqv:...RES<BR>ULTIS.a..NEQV..b#0A....CASE.s_div:....UNLESS.b#3D0.<=
BR>RESULTIS.a.../....b#0A....CASE.s_rem:....UNLESS.b#3D<BR>0.RESULTIS.a..=
REM...b#0A.......#0A....DEFAULT:#0A..<BR>}#0A#0A..trnerr("Error.in.manife=
st.expression")#0A.<BR>.RESULTIS.0#0A}#0A#0AAND.assign(x,.y).BE#0A{.IF.x#=
3D<BR>0.|.y#3D0.DO.{.trnerr("Compiler.error.in.assign")#0A<BR>...........=
.........RETURN#0A..................}#0A<BR>#0A..UNLESS.(h1!x#3Ds_comma)#=
3D(h1!y#3Ds_comma).DO#0A<BR>..................{.trnerr("Bad.simultaneous.=
assign<BR>ment")#0A....................RETURN#0A.............<BR>.....}#0=
A.#0A..SWITCHON.h1!x.INTO#0A..{.CASE.s_comm<BR>a:..assign(h2!x,.h2!y)#0A.=
..................assign(<BR>h3!x,.h3!y)#0A...................RETURN#0A.#=
0A....C<BR>ASE.s_name:...load(y)#0A...................transnam<BR>e(x,.s_=
sp,.s_sg,.s_sl,.0,.0)#0A...................s<BR>sp.:#3D.ssp.-.1#0A.......=
............RETURN#0A.#0A.<BR>...CASE.s_byteap:.load(y)#0A...............=
....load<BR>(h2!x)#0A...................load(h3!x)#0A..........<BR>......=
...out1(s_putbyte)#0A...................ssp:#3D<BR>ssp-3#0A..............=
.....RETURN#0A.#0A....CASE.s_<BR>rv:#0A....CASE.s_vecap:..load(y)#0A.....=
...........<BR>...loadlv(x)#0A...................out1(s_stind)#0A.<BR>...=
...............ssp.:#3D.ssp.-.2#0A..............<BR>.....RETURN#0A.#0A...=
.CASE.s_of:...{.LET.slct.#3D.e<BR>valconst(h2!x).//.Inserted.11/7/01#0A..=
............<BR>.....LET.len.#3D.slct&gt;&gt;24#0A...................LET.=
<BR>sh..#3D.slct&gt;&gt;16.&amp;.255#0A...................LET.off<BR>set.=
#3D.slct.&amp;.#23xFFFF#0A...................LET.ma<BR>sk.#3D.-1#0A......=
.............IF.len&gt;0.DO.mask.:#3D<BR>.(1&lt;&lt;len)-1#0A............=
.......mask.:#3D.mask&lt;&lt;sh<BR>#0A//writef("Compiling.(SLCT.%n:%n:%n)=
.OF.x.:#3D.y*<BR>n",.len,.sh,.offset)#0A//writef("Load.y*n")#0A.....<BR>.=
.............load(y)#0A...................IF.sh.DO<BR>#0A................=
...{.out2(s_ln,.sh)#0A..........<BR>...........out1(s_lshift)#0A//writef(=
"lshift.by.%n*<BR>n",.sh)#0A...................}#0A#0A...............<BR>=
....UNLESS.mask#3D-1.DO#0A...................{.load<BR>(h3!x)#0A.........=
............IF.offset.DO#0A......<BR>...............{.out2(s_ln,.offset)#=
0A.............<BR>..........out1(s_plus)#0A.....................}#0A.<BR=
>....................out1(s_rv)#0A..................<BR>...out1(s_neqv)#0=
A.....................ssp.:#3D.ssp<BR>-1#0A//writef("xor.x!%n*n",.offset)=
#0A.............<BR>........out2(s_ln,.mask)#0A.....................out<B=
R>1(s_logand).//.bits.to.change.in.x#0A//writef("mask<BR>.with.%bW*n",.ma=
sk)#0A#0A.....................load(<BR>h3!x)#0A.....................IF.of=
fset.DO#0A.......<BR>..............{.out2(s_ln,.offset)#0A..............<=
BR>.........out1(s_plus)#0A.....................}#0A..<BR>...............=
....out1(s_rv)#0A...................<BR>..out1(s_neqv)#0A//writef("xor.wi=
th.x!%n*n",.offset<BR>)#0A.....................ssp.:#3D.ssp-1#0A.........=
<BR>..........}#0A#0A...................load(h3!x)#0A..<BR>..............=
...IF.offset.DO#0A...................<BR>{.out2(s_ln,.offset)#0A.........=
............out1(s_<BR>plus)#0A...................}#0A...................=
o<BR>ut1(s_stind)#0A//writef("store.in.x!%n*n",.offset)#0A<BR>...........=
........ssp.:#3D.ssp-2#0A//writef("stind<BR>*n")#0A...................RET=
URN#0A................<BR>.}#0A#0A....DEFAULT:.......trnerr("Ltype.expres=
sion<BR>.needed")#0A..}#0A}#0A.#0A.#0AAND.transname(x,.p,.g<BR>,.l,.f,.n)=
.BE#0A{.LET.c.#3D.cellwithname(x)#0A..LET<BR>.k,.a.#3D.h2!c,.h3!c#0A.#0A.=
.SWITCHON.k.INTO#0A..{.<BR>DEFAULT:........trnerr("Name.'%s'.not.declared=
",.@h<BR>3!x)#0A...#0A....CASE.s_global:..out2(g,.a)#0A.....<BR>.........=
......IF.xrefing.DO.xref(x,."G:",.a,.g)#0A<BR>....................RETURN#=
0A.#0A....CASE.s_local:.<BR>..IF.c&lt;dvecp.DO#0A........................=
.trnerr("<BR>Dynamic.free.variable.'%s'.used",.@h3!x)#0A........<BR>.....=
.......out2(p,.a)#0A....................//IF.x<BR>refing.DO.xref(x,."P:",=
.a,.p)#0A...................<BR>.RETURN#0A.#0A....CASE.s_static:..out2(l,=
.a)#0A....<BR>................IF.xrefing.DO.xref(x,."S:",.a,.l)#0A<BR>...=
.................RETURN#0A.#0A....CASE.s_label:.<BR>..IF.f#3D0.DO#0A.....=
...............{.trnerr("Misus<BR>e.of.entry.name.'%s'",.@h3!x)#0A.......=
............<BR>...f.:#3D.p#0A....................}#0A.............<BR>..=
.....out2(f,.a)#0A....................IF.xrefing.<BR>DO.xref(x,."F:",.a,.=
f)#0A....................RETURN<BR>#0A#0A....CASE.s_manifest:IF.n#3D0.DO#=
0A...........<BR>.........{.trnerr("Misuse.of.MANIFEST.name.'%s'",.@<BR>h=
3!x)#0A......................n.:#3D.p#0A..........<BR>..........}#0A.....=
...............out2(n,.a)#0A....<BR>................IF.xrefing.DO.xref(x,=
."M:",.a,.n)#0A<BR>..}#0A}#0A#0AAND.xref(x,.kstr,.n,.op).BE#0A{.LET.na<BR=
>me.#3D.@h3!x#0A..LET.fno.#3D.comline&gt;&gt;20#0A..LET.ln<BR>o.#3D.comli=
ne.&amp;.#23xFFFFF#0A..LET.file.#3D.sourcena<BR>mev!fno#0A..writef("%s.%s=
%n.",.name,.kstr,.n)#0A#0A<BR>..SWITCHON.op.INTO#0A..{.DEFAULT:.........w=
ritef("o<BR>p%n",.op);.ENDCASE#0A....CASE.s_fndef:....writef("F<BR>N");..=
.....ENDCASE#0A....CASE.s_rtdef:....writef("R<BR>T");.......ENDCASE#0A...=
.CASE.s_valdef:...writef("V<BR>AL");......ENDCASE#0A....CASE.s_vecdef:...=
writef("V<BR>EC");......ENDCASE#0A....CASE.s_constdef:.writef("D<BR>EF");=
......ENDCASE#0A....CASE.s_const:....writef("M<BR>AN");......ENDCASE#0A..=
..CASE.s_colon:....writef("L<BR>AB");......ENDCASE#0A....CASE.s_sp:......=
.writef("S<BR>P");.......ENDCASE#0A....CASE.s_sg:.......writef("S<BR>G");=
.......ENDCASE#0A....CASE.s_sl:.......writef("S<BR>L");.......ENDCASE#0A.=
...CASE.s_llp:......writef("L<BR>LP");......ENDCASE#0A....CASE.s_llg:....=
..writef("L<BR>LG");......ENDCASE#0A....CASE.s_lll:......writef("L<BR>LL"=
);......ENDCASE#0A....CASE.s_lp:.......writef("L<BR>P");.......ENDCASE#0A=
....CASE.s_lg:.......writef("L<BR>G");.......ENDCASE#0A....CASE.s_ll:....=
...writef("L<BR>L");.......ENDCASE#0A....CASE.s_lf:.......writef("L<BR>F"=
);.......ENDCASE#0A....CASE.s_ln:.......writef("L<BR>N");.......ENDCASE#0=
A..}#0A..wrch('.')#0A..IF.file.<BR>DO.writef("%s",.file)#0A..writef("[%n]=
.",.lno)#0A#0A<BR>..prctxt(context)#0A#0A..newline()#0A}#0A#0AAND.prc<BR>=
txt(x).BE.IF.x.DO.#0A{.LET.op.#3D.h1!x#0A..SWITCHON<BR>.op.INTO#0A..{.DEF=
AULT:..prctxte(x,.4,.0);.RETURN#0A<BR>#0A....CASE.s_fndef:#0A.........wri=
tef("LET.")#0A..<BR>.......prctxte(h2!x,.5,.0)#0A.........wrch('(')#0A.<B=
R>........prctxte(h3!x,.7,.0)#0A.........writef(")#3D<BR>#2E#2E")#0A.....=
....RETURN#0A#0A....CASE.s_rtdef:#0A<BR>.........writef("LET.")#0A.......=
..prctxte(h2!x,.5,<BR>.0)#0A.........wrch('(')#0A.........prctxte(h3!x,.7=
<BR>,.0)#0A.........writef(")BE#2E#2E")#0A.........RETU<BR>RN#0A#0A....CA=
SE.s_valdef:#0A.........writef("LET."<BR>)#0A.........prctxte(h2!x,.5,.0)=
#0A.........writef(<BR>"#3D")#0A.........prctxte(h3!x,.5,.0)#0A.........R=
E<BR>TURN#0A#0A....CASE.s_vecdef:#0A.........writef("LET<BR>.")#0A.......=
..prctxte(h2!x,.5,.0)#0A.........write<BR>f("#3DVEC.")#0A.........prctxte=
(h3!x,.5,.0)#0A.....<BR>....RETURN#0A#0A....CASE.s_constdef:#0A.........p=
rc<BR>txte(h3!x,.5,.0)#0A.........writef("#3D")#0A.......<BR>..prctxte(h4=
!x,.5,.0)#0A.........RETURN#0A#0A....CA<BR>SE.s_let:#0A.........writef("L=
ET.")#0A.........prct<BR>xtd(h2!x,.2)#0A.........writef(";.")#0A.........=
prc<BR>txtc(h3!x,.2)#0A.........RETURN#0A.#0A....CASE.s_st<BR>atic:....wr=
itef("STATIC#2E#2E");....RETURN#0A....CA<BR>SE.s_global:....writef("GLOBA=
L#2E#2E");....RETURN#0A<BR>....CASE.s_manifest:..writef("MANIFEST#2E#2E")=
;..RE<BR>TURN#0A#0A....CASE.s_ass:#0A.........prctxte(h2!x,.<BR>4,.0)#0A.=
........writef(":#3D")#0A.........prctxte(<BR>h3!x,.4,.0)#0A.........RETU=
RN#0A.#0A....CASE.s_rtap<BR>:#0A.........prctxte(h2!x,.2,.12)#0A.........=
writef<BR>("(")#0A.........prctxte(h3!x,.3,.0)#0A.........wri<BR>tef(")")=
#0A.........RETURN#0A.#0A....CASE.s_goto:#0A<BR>.........writef("GOTO.")#=
0A.........prctxte(h2!x,.4<BR>,.0)#0A.........RETURN#0A.#0A....CASE.s_col=
on:#0A..<BR>.......prctxte(h2!x,.2,.0)#0A.........writef(":")#0A<BR>.....=
....prctxt(h3!x,.3)#0A.........RETURN#0A.#0A..<BR>..CASE.s_unless:#0A....=
CASE.s_if:#0A....CASE.s_whil<BR>e:#0A....CASE.s_until:#0A.........writef(=
op#3Ds_unl<BR>ess-&gt;"UNLESS.",#0A................op#3Ds_if-&gt;"IF.",<B=
R>#0A................op#3Ds_until-&gt;"UNTIL.",#0A......<BR>.........."WH=
ILE."#0A...............)#0A.........pr<BR>ctxte(h2!x,.4,.0)#0A.........wr=
itef(".DO.")#0A.....<BR>....prctxtc(h3!x,.3)#0A.........RETURN#0A#0A.#0A.=
..<BR>.CASE.s_test:#0A.........writef("TEST.")#0A........<BR>.prctxte(h2!=
x,.4,.0)#0A.........writef(".THEN.")#0A<BR>.........prctxtc(h3!x,.2)#0A..=
.......writef(".ELSE.<BR>")#0A.........prctxtc(h4!x,.2)#0A.........RETURN=
#0A<BR>.#0A....CASE.s_loop:#0A.........writef("LOOP")#0A..<BR>.......RETU=
RN#0A.#0A....CASE.s_skip:#0A.........wri<BR>tef("{}")#0A.........RETURN#0=
A.#0A....CASE.s_break:<BR>#0A.........writef("BREAK")#0A.........RETURN#0=
A.#0A<BR>....CASE.s_return:#0A.........writef("RETURN")#0A..<BR>.......RE=
TURN#0A.#0A....CASE.s_finish:#0A.........w<BR>ritef("FINISH")#0A.........=
RETURN#0A.#0A....CASE.s_<BR>resultis:#0A.........writef("RESULTIS.")#0A..=
......<BR>.prctxte(h2!x,.4,.0)#0A.........RETURN#0A.#0A....CA<BR>SE.s_rep=
eatwhile:#0A....CASE.s_repeatuntil:#0A.....<BR>....prctxtc(h2!x,.4)#0A...=
......writef(op#3Ds_repea<BR>twhile.-&gt;.".REPEATWHILE.",.".REPEATUNTIL.=
")#0A.....<BR>....prctxte(h3!x,.4,.0)#0A.........RETURN#0A.#0A...<BR>.CAS=
E.s_repeat:#0A.........prctxtc(h2!x,.4)#0A.....<BR>....writef(".REPEAT")#=
0A.........RETURN#0A.#0A....C<BR>ASE.s_case:#0A.........writef("CASE.")#0=
A.........p<BR>rctxte(h2!x,.4,.0)#0A.........writef(":#2E#2E.")#0A<BR>...=
......RETURN#0A.#0A....CASE.s_default:#0A.......<BR>..writef("DEFAULT:#2E=
#2E")#0A.........RETURN#0A.#0A<BR>....CASE.s_endcase:#0A.........writef("=
ENDCASE")#0A<BR>.........RETURN#0A.#0A....CASE.s_switchon:#0A......<BR>..=
.writef("SWITCHON.")#0A.........prctxte(h2!x,.4,.<BR>0)#0A.........writef=
(".INTO#2E#2E")#0A.........RETU<BR>RN#0A.#0A....CASE.s_for:#0A.........wr=
itef("FOR.")#0A<BR>.........prctxte(h2!x,.4,.0)#0A.........writef("#3D<BR=
>")#0A.........prctxte(h3!x,.4,.0)#0A.........writef<BR>(".TO.")#0A......=
...prctxte(h4!x,.4,.0)#0A.........<BR>IF.h5!x.DO.{.writef(".BY.");.prctxt=
e(h5!x,.4,.0).}#0A<BR>.........writef(".DO#2E#2E")#0A.........RETURN#0A.#=
0A<BR>....CASE.s_seq:#0A.........prctxtc(h2!x,.4)#0A.....<BR>....writef("=
;")#0A.........prctxtc(h3!x,.4)#0A.....<BR>....RETURN#0A..}#0A}#0A#0AAND.=
prctxtd(x,.d).BE.writ<BR>ef("#2E#2E")#0AAND.prctxtc(x,.d).BE.writef("#2E#=
2E"<BR>)#0A#0AAND.prctxte(x,.d,.prec).BE.IF.x.DO#0A{.LET.o<BR>p.#3D.h1!x#=
0A#0A..SWITCHON.op.INTO#0A..{.DEFAULT:.E<BR>NDCASE#0A#0A....CASE.s_number=
:.#0A.................<BR>{.LET.n.#3D.h2!x#0A...................TEST.-1_0=
00_0<BR>00&lt;#3Dn&lt;#3D1_000_000#0A...................THEN.writ<BR>ef("=
%n",.n)#0A...................ELSE.writef("#23x%<BR>x8",.n)#0A............=
.......RETURN#0A.............<BR>....}.#0A....CASE.s_name:...writef("%s",=
.@h3!x);...<BR>.....RETURN#0A....CASE.s_true:...writef("TRUE");...<BR>...=
.......RETURN#0A....CASE.s_false:..writef("FALSE<BR>");............RETURN=
#0A....CASE.s_query:..wrch('?'<BR>);..................RETURN#0A#0A....CAS=
E.s_string:.<BR>#0A.................{.LET.s.#3D.@h2!x#0A...........<BR>..=
......LET.len.#3D.s%0#0A...................wrch('<BR>"')#0A..............=
.....FOR.i.#3D.1.TO.len.DO#0A..<BR>.................{.LET.ch.#3D.s%i#0A..=
.............<BR>......IF.i#3D6.&amp;.len&gt;6+8.DO.{.writef("'");.LOOP.}=
#0A<BR>.....................IF.i&lt;#3D6.|.i&gt;len-8.DO.//.Firs<BR>t.5.a=
nd.last.8.chars#0A.....................{.SWITC<BR>HON.ch.INTO#0A.........=
..............{.CASE.'**':.w<BR>ritef("****");.LOOP#0A...................=
......CASE<BR>.'*"':.writef("***"");.LOOP#0A.....................<BR>....=
CASE.'*n':.writef("**n");..LOOP#0A.............<BR>..........}#0A........=
...............UNLESS.32&lt;#3Dc<BR>h&lt;#3D127.DO.ch.:#3D.'?'#0A........=
...............wr<BR>ch(ch)#0A.....................}#0A.................<=
BR>..}#0A...................wrch('"')#0A..............<BR>.....RETURN#0A.=
................}#0A#0A..}#0A#0A..IF<BR>.d#3D0.DO.{.writef("#2E#2E#2E");.=
RETURN.}#0A#0A..IF<BR>.prec&gt;#3D12.DO.{.wrch('(');.prctxte(x,.d,.0);.wr=
ch(<BR>')');.RETURN.}#0A#0A..SWITCHON.op.INTO#0A..{.DEFAUL<BR>T:.ENDCASE#=
0A#0A....CASE.s_fnap:#0A.........prctxte<BR>(h2!x,.d-1,.11)#0A.........wr=
ch('(')#0A.........prc<BR>txte(h3!x,.d-1,.0)#0A.........wrch(')')#0A.....=
....<BR>RETURN#0A..}#0A#0A..IF.prec&gt;#3D11.DO.{.wrch('(');.p<BR>rctxte(=
x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHO<BR>N.op.INTO#0A..{.DEFAULT:.=
ENDCASE#0A#0A....CASE.s_of<BR>:#0A....CASE.s_byteap:#0A....CASE.s_vecap:#=
0A......<BR>...prctxte(h2!x,.d-1,.10)#0A.........writes(op#3Ds_<BR>of-&gt=
;"::",.op#3Ds_byteap-&gt;"%",."!")#0A.........prctx<BR>te(h3!x,.d-1,.10)#=
0A.........RETURN#0A#0A....CASE.s<BR>_rv:#0A....CASE.s_lv:#0A.........wri=
tef(op#3Ds_rv-&gt;<BR>"!","@")#0A.........prctxte(h2!x,.d-1,.10)#0A......=
<BR>...RETURN#0A..}#0A#0A..IF.prec&gt;#3D10.DO.{.wrch('(')<BR>;.prctxte(x=
,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWIT<BR>CHON.op.INTO#0A..{.DEFAULT:.E=
NDCASE#0A....CASE.s_mu<BR>lt:.CASE.s_div:.CASE.s_rem:#0A.........prctxte(=
h2!x<BR>,.d-1,.9)#0A.........writef(op#3Ds_mult-&gt;"**",.op#3D<BR>s_div-=
&gt;"/",.".REM.")#0A.........prctxte(h3!x,.d-1,.<BR>9)#0A.........RETURN#=
0A..}#0A#0A..IF.prec&gt;#3D9.DO.{<BR>.wrch('(');.prctxte(x,.d,.0);.wrch('=
)');.RETURN.}#0A<BR>#0A..SWITCHON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A....<B=
R>CASE.s_plus:#0A....CASE.s_minus:#0A.........prctxte<BR>(h2!x,.d-1,.8)#0=
A.........writef(op#3Ds_plus-&gt;"+","<BR>-")#0A.........prctxte(h3!x,.d-=
1,.8)#0A.........RET<BR>URN#0A#0A....CASE.s_neg:#0A....CASE.s_abs:#0A....=
..<BR>...writef(op#3Ds_neg-&gt;"-","ABS.")#0A.........prctxt<BR>e(h2!x,.d=
-1,.8)#0A.........RETURN#0A#0A..}#0A#0A..I<BR>F.prec&gt;#3D8.DO.{.wrch('(=
');.prctxte(x,.d,.0);.wrch(<BR>')');.RETURN.}#0A#0A..SWITCHON.op.INTO#0A.=
.{.DEFAUL<BR>T:.ENDCASE#0A....CASE.s_eq:.CASE.s_ne:#0A.........p<BR>rctxt=
e(h2!x,.d-1,.7)#0A.........writef(op#3Ds_eq-&gt;"<BR>#3D","~#3D")#0A.....=
....prctxte(h3!x,.d-1,.7)#0A...<BR>......RETURN#0A....CASE.s_ls:.CASE.s_g=
r:#0A........<BR>.prctxte(h2!x,.d-1,.7)#0A.........writef(op#3Ds_ls-<BR>&=
gt;"&lt;","&gt;")#0A.........prctxte(h3!x,.d-1,.7)#0A......<BR>...RETURN#=
0A....CASE.s_le:.CASE.s_ge:#0A.........pr<BR>ctxte(h2!x,.d-1,.7)#0A......=
...writef(op#3Ds_le-&gt;"&lt;<BR>#3D","&gt;#3D")#0A.........prctxte(h3!x,=
.d-1,.7)#0A...<BR>......RETURN#0A..}#0A#0A..IF.prec&gt;#3D7.DO.{.wrch('(<=
BR>');.prctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SW<BR>ITCHON.op.INTO#=
0A..{.DEFAULT:.ENDCASE#0A....CASE.s_<BR>lshift:.CASE.s_rshift:#0A........=
.prctxte(h2!x,.d-1<BR>,.6)#0A.........writef(op#3Ds_lshift-&gt;"&lt;&lt;"=
,"&gt;&gt;")#0A<BR>.........prctxte(h3!x,.d-1,.6)#0A.........RETURN#0A<BR=
>..}#0A#0A..IF.prec&gt;#3D6.DO.{.wrch('(');.prctxte(x,.<BR>d,.0);.wrch(')=
');.RETURN.}#0A#0A..SWITCHON.op.INTO#0A<BR>..{.DEFAULT:.ENDCASE#0A....CAS=
E.s_not:#0A.........w<BR>rch('~')#0A.........prctxte(h2!x,.d-1,.5)#0A....=
...<BR>..RETURN#0A..}#0A#0A..IF.prec&gt;#3D5.DO.{.wrch('(');.<BR>prctxte(=
x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCH<BR>ON.op.INTO#0A..{.DEFAULT:.=
ENDCASE#0A....CASE.s_loga<BR>nd:#0A.........prctxte(h2!x,.d-1,.4)#0A.....=
....wrc<BR>h('&amp;')#0A.........prctxte(h3!x,.d-1,.4)#0A.........<BR>RET=
URN#0A..}#0A#0A..IF.prec&gt;#3D4.DO.{.wrch('(');.pr<BR>ctxte(x,.d,.0);.wr=
ch(')');.RETURN.}#0A#0A..SWITCHON<BR>.op.INTO#0A..{.DEFAULT:.ENDCASE#0A..=
..CASE.s_logor:<BR>#0A.........prctxte(h2!x,.d-1,.3)#0A.........wrch('<BR=
>|')#0A.........prctxte(h3!x,.d-1,.3)#0A.........RET<BR>URN#0A..}#0A#0A..=
IF.prec&gt;#3D3.DO.{.wrch('(');.prctx<BR>te(x,.d,.0);.wrch(')');.RETURN.}=
#0A#0A..SWITCHON.op<BR>.INTO#0A..{.DEFAULT:.ENDCASE#0A....CASE.s_eqv:#0A.=
.<BR>..CASE.s_neqv:#0A.........prctxte(h2!x,.d-1,.2)#0A.<BR>........write=
f(op#3Ds_eqv-&gt;".EQV.",".XOR.")#0A.....<BR>....prctxte(h3!x,.d-1,.2)#0A=
.........RETURN#0A#0A..<BR>}#0A#0A..IF.prec&gt;#3D2.DO.{.wrch('(');.prctx=
te(x,.d,<BR>.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.op.INTO#0A<BR>..{.DE=
FAULT:.ENDCASE#0A....CASE.s_cond:#0A.........<BR>prctxte(h2!x,.d-1,.1)#0A=
.........writef("-&gt;")#0A...<BR>......prctxte(h3!x,.d-1,.1)#0A.........=
writef(",")#0A<BR>.........prctxte(h4!x,.d-1,.1)#0A.........RETURN#0A<BR>=
..}#0A#0A..IF.prec&gt;#3D1.DO.{.wrch('(');.prctxte(x,.<BR>d,.0);.wrch(')'=
);.RETURN.}#0A#0A..SWITCHON.op.INTO#0A<BR>..{.DEFAULT:.writef("Op%n",.op)=
;.RETURN#0A#0A....CA<BR>SE.s_table:#0A.........writef("TABLE.")#0A.......=
..<BR>prctxte(h2!x,.d-1,.0)#0A.........RETURN#0A.........<BR>#0A....CASE.=
s_valof:#0A.........writef("VALOF.{")#0A<BR>.........prctxtc(h2!x,.d-1)#0=
A.........wrch('}')#0A<BR>.........RETURN#0A#0A....CASE.s_comma:#0A......=
...p<BR>rctxte(h2!x,.d-1,.0)#0A.........writef(",")#0A.....<BR>....prctxt=
e(h3!x,.d-1,.0)#0A.........RETURN#0A..}#0A<BR>}#0A#0A#0AAND.out1(x).BE.wr=
n(x)#0A.#0AAND.out2(x,.y<BR>).BE.{.out1(x);.out1(y).}#0A.#0AAND.outstring=
(s).BE<BR>.FOR.i.#3D.0.TO.s%0.DO.out1(s%i)#0A<BR><BR>######cintcode/com/s=
ial-vax.b#<BR>/*#0AThis.is.an.sial.to.vax.code.generator#0Aimplem<BR>ente=
d.by.Martin.Richards.(c).7.August.2009#0A#0AVax<BR>.register.usage#0A#0AR=
11...G,.m/c.address.of.global<BR>.0#0AR10...P,.m/c.address.of.the.current=
.function.s<BR>tack.frame#0AR9....#3D0.(to.simplify.indirection.an<BR>d.l=
ogical.right.shift)#0AR8....Sial.A.register#0AR7<BR>....Sial.B.register#0=
AR6....Sial.C.register#0AR2...<BR>.Function.entry.point.at.time.of.call#0=
AR1....P.poi<BR>nter.increment#0A#0A#0AP.stack.frame#0A#0A#2E#2E#2E<BR>..=
.&lt;old.P&gt;.&lt;return.address&gt;.&lt;entry.address&gt;.&lt;arg.1&gt;=
<BR>.#2E#2E#2E#0A........^#0A........|#0A........P.(#3D<BR>R10)#0A#0ASP.s=
tack.frame#0A#0A......&lt;entry.address&gt;<BR>.&lt;old.P&gt;.&lt;return.=
address&gt;..#2E#2E#2E#0A.......^#0A.<BR>......|#0A.......SP#0A..........=
...................<BR>.............#0ABCPL.Calling.sequence#0A#0A....KPG=
.<BR>k.n....#3D&gt;......First.argument,.if.any,.in.A.(R8)#0A<BR>........=
...............MOVL..4*n(R11),R2......;.R2.<BR>:#3D.G!n#0A...............=
........MOVAL.4*k(R10),R1<BR>......;.R1.:#3D.&lt;new.P&gt;#0A............=
...........JS<BR>B...(R2).............;.J.to.function#0A#0A#0A....EN<BR>T=
RY.n.Lm.C1.#2E#2E#2E.Cn.#3D.&gt;#0A..................<BR>................=
............;.first.arg,.if.any,.in<BR>.A.(#3DR8)#0A.....................=
.................<BR>........;.sp!0.#3D.&lt;return.address&gt;#0A........=
.....<BR>..........MOVL.R10,(R1)..........;.push.&lt;old.P&gt;#0A.<BR>...=
...................MOVL.R1,R10............;.P.:#3D<BR>.&lt;new.P&gt;#0A..=
.....................MOVL.(SP)+,4*1(R1<BR>0)....;.save.&lt;return.address=
&gt;#0A...................<BR>....MOVL.R2,4*2(R10).......;.save.&lt;entry=
.address&gt;#0A<BR>.......................MOVL.R8,4*3(R10).......;.Sto<BR=
>re.first.arg,.if.any#0A............................<BR>.................=
.;.Other.args.in.P!1,.P!2,.#2E#2E#2E<BR>#0A#0A....RTN.....#3D&gt;........=
.MOVL.4(R10),R2......<BR>...;.R2.#3D.&lt;return.address&gt;#0A...........=
.........<BR>...MOVL.(R10),R10.........;.P.:#3D.&lt;old.P&gt;#0A......<BR=
>.................JMP.(R2)...............;.Jump.to.&lt;<BR>return.address=
&gt;#0A#0A#0A*/#0A#0ASECTION."sial-vax"#0A<BR>#0AGET."libhdr"#0AGET."sial=
#2Eh"#0A#0AGLOBAL.{#0Asi<BR>alin:ug#0Aasmout#0Astdin#0Astdout#0Amodstarte=
d#0A#0A<BR>rdf;.rdp;.rdg;.rdk;.rdw;.rdl;.rdc#0Ardcode#0A#0Apva<BR>l;.gval=
;.kval;.wval;.lval;.mval#0A#0Ascan#0Acvf;.cv<BR>fp;.cvfg;.cvfk;.cvfw;.cvf=
l#0A#0Asectname;.modletter<BR>;.charv;.labnumber#0A}#0A#0ALET.start().#3D=
.VALOF#0A<BR>{.LET.argv.#3D.VEC.20#0A..LET.v....#3D.VEC.20#0A..L<BR>ET.cv=
...#3D.VEC.256/bytesperword#0A#0A..sectname.:#3D<BR>.v#0A..sectname%0.:#3=
D.0#0A..modstarted.:#3D.FALSE#0A<BR>#0A..modletter.:#3D.'A'#0A..charv.:#3=
D.cv#0A..labnu<BR>mber.:#3D.0#0A#0A..asmout.:#3D.0#0A..stdout.:#3D.ou<BR>=
tput()#0A..IF.rdargs("FROM,TO/K",.argv,.20)#3D0.DO#0A<BR>..{.writes("Bad.=
args.for.sial-vax*n")#0A....RESULTI<BR>S.20#0A..}#0A..IF.argv!0#3D0.DO.ar=
gv!0.:#3D."prog#2E<BR>sial"#0A..IF.argv!1#3D0.DO.argv!1.:#3D."prog#2Emar"=
<BR>#0A..sialin.:#3D.findinput(argv!0)#0A..IF.sialin#3D<BR>0.DO#0A..{.wri=
tef("Trouble.with.file.%s*n",.argv!0)<BR>#0A....RESULTIS.20#0A..}#0A..asm=
out.:#3D.findoutput<BR>(argv!1)#0A...#0A..UNLESS.asmout.DO#0A..{.writef("=
T<BR>rouble.with.file.%s*n",.argv!1)#0A.....RESULTIS.20#0A<BR>..}#0A...#0=
A..writef("Converting.%s.to.%s*n",.argv!<BR>0,.argv!1)#0A..selectinput(si=
alin)#0A..selectoutput<BR>(asmout)#0A#0A..writef(";.Code.generated.by.sia=
l-va<BR>x*n*n")#0A#0A..scan()#0A..endread()#0A..UNLESS.asmo<BR>ut#3Dstdou=
t.DO.endwrite()#0A..selectoutput(stdout)#0A<BR>..writef("Conversion.compl=
ete*n")#0A..RESULTIS.0#0A<BR>}#0A#0AAND.nextlab().#3D.VALOF#0A{.labnumber=
.:#3D.l<BR>abnumber+1#0A..RESULTIS.labnumber#0A}#0A#0A//.argum<BR>ent.may=
.be.of.form.Ln#0AAND.rdcode(let).#3D.VALOF#0A<BR>{.LET.a,.ch,.neg.#3D.0,.=
?,.FALSE#0A#0A..ch.:#3D.rdc<BR>h().REPEATWHILE.ch#3D'*s'.|.ch#3D'*n'#0A#0=
A..IF.ch#3D<BR>endstreamch.RESULTIS.-1#0A#0A..UNLESS.ch#3Dlet.DO.e<BR>rro=
r("Bad.item,.looking.for.%c.found.%c*n",.let,.ch<BR>)#0A#0A..ch.:#3D.rdch=
()#0A#0A..IF.ch#3D'-'.DO.{.neg<BR>.:#3D.TRUE;.ch.:#3D.rdch().}#0A#0A..WHI=
LE.'0'&lt;#3Dch<BR>&lt;#3D'9'.DO.{.a.:#3D.10*a.+.ch.-.'0';.ch.:#3D.rdch()=
<BR>..}#0A#0A..RESULTIS.neg.-&gt;.-a,.a#0A}#0A#0AAND.rdf()<BR>.#3D.rdcode=
('F')#0AAND.rdp().#3D.VALOF.{.pval.:#3D.<BR>rdcode('P');.RESULTIS.pval.}#=
0AAND.rdg().#3D.VALOF.<BR>{.gval.:#3D.rdcode('G');.RESULTIS.gval.}#0AAND.=
rdk(<BR>).#3D.VALOF.{.kval.:#3D.rdcode('K');.RESULTIS.kval.<BR>}#0AAND.rd=
w().#3D.VALOF.{.wval.:#3D.rdcode('W');.RE<BR>SULTIS.wval.}#0AAND.rdl().#3=
D.VALOF.{.lval.:#3D.rdc<BR>ode('L');.RESULTIS.lval.}#0AAND.rdm().#3D.VALO=
F.{.m<BR>val.:#3D.rdcode('M');.RESULTIS.mval.}#0AAND.rdc().#3D<BR>.rdcode=
('C')#0A#0AAND.error(mess,.a,.b,.c).BE#0A{.L<BR>ET.out.#3D.output()#0A..U=
NLESS.out#3Dstdout.DO#0A..<BR>{.selectoutput(stdout)#0A....writef(mess,.a=
,.b,.c)#0A<BR>....selectoutput(out)#0A..}#0A..writef(mess,.a,.b,.<BR>c)#0=
A}#0A#0AAND.scan().BE#0A{.LET.op.#3D.rdf()#0A#0A<BR>..IF.op#3D-1.RETURN./=
/.EOF.reached#0A#0A..UNLESS.mo<BR>dstarted.DO#0A..{.WHILE.op#3Df_section.=
|.op#3Df_mod<BR>start.TEST.op#3Df_section#0A....THEN.{.cvfs("SECTIO<BR>N"=
).//.Name.of.section#0A...........FOR.i.#3D.0.TO.<BR>charv%0.DO.sectname%=
i.:#3D.charv%i#0A...........op.<BR>:#3D.rdf()#0A.........}#0A....ELSE.{.c=
vf("MODSTART"<BR>).//.Start.of.module#0A...........op.:#3D.rdf()#0A.<BR>.=
.......}#0A#0A....//.If.there.is.no.section.name.t<BR>his.module.is.calle=
d.MAIN#0A....IF.sectname%0#3D0.D<BR>O#0A....{.LET.s.#3D."MAIN"#0A......FO=
R.i.#3D.0.TO.s<BR>%0.DO.sectname%i.:#3D.s%i#0A....}#0A#0A....writef("<BR>=
*n.#2EPSECT.%s,LONG",.sectname)#0A....writef("*n.#2E<BR>TITLE.%s.generate=
d.by.sial-vax",.sectname)#0A....wr<BR>itef("*n;%s::",.sectname)#0A....wri=
tef("*n.#2ELONG.<BR>L1000")#0A....modstarted.:#3D.TRUE#0A..}#0A#0A..SWI<B=
R>TCHON.op.INTO#0A#0A..{.DEFAULT:.......error(";.Bad.<BR>op.%n*n",.op);.L=
OOP#0A#0A....CASE.-1:.......RETURN#0A<BR>......#0A....CASE.f_lp:.....cvfp=
("LP").//.a.:#3D.P!<BR>n#0A...................writef("*n.MOVL.%n(R10),R8"=
,<BR>.4*pval)#0A...................ENDCASE#0A....CASE.f_<BR>lg:.....cvfg(=
"LG").//.a.:#3D.G!n#0A................<BR>...writef("*n.MOVL.%n(R11),R8",=
.4*gval)#0A.........<BR>..........ENDCASE#0A....CASE.f_ll:.....cvfl("LL")=
./<BR>/.a.:#3D.!Ln#0A...................writef("*n.MOVL.L<BR>%n,R8",.lval=
)#0A...................ENDCASE#0A#0A...<BR>.CASE.f_llp:....cvfp("LLP").//=
.a.:#3D.@.P!n#0A.....<BR>..............writef("*n.MOVAL.%n(R10),R8",.4*pv=
al)<BR>#0A...................writef("*n.DIVL2.#234,R8")#0A<BR>...........=
........ENDCASE#0A....CASE.f_llg:....cvf<BR>g("LLG").//.a.:#3D.@.G!n#0A..=
.................write<BR>f("*n.MOVAL.%n(R11),R8",.4*gval)#0A............=
....<BR>...writef("*n.DIVL2.#234,R8")#0A...................<BR>ENDCASE#0A=
....CASE.f_lll:....cvfl("LLL").//.a.:#3D.<BR>@.!Ln#0A...................w=
ritef("*n.MOVAL.L%n,R8"<BR>,.lval)#0A...................writef("*n.DIVL2.=
#234,<BR>R8")#0A...................ENDCASE#0A....CASE.f_lf:.<BR>....cvfl(=
"LF").//.a.:#3D.byte.address.of.Ln#0A.....<BR>..............writef("*n.MO=
VAL.L%n,R8",.lval)#0A...<BR>................ENDCASE#0A....CASE.f_lw:.....=
cvfm("<BR>LW")#0A...................writef("*n.MOVL.L%n,R8",.<BR>mval+100=
00)#0A...................ENDCASE#0A#0A....C<BR>ASE.f_l:......cvfk("L").//=
.a.:#3D.n#0A.............<BR>......IF.kval#3D0.DO.{.writef("*n.CLRL.R8");=
.ENDCAS<BR>E.}#0A...................writef("*n.MOVL.#23%n,R8",<BR>.kval)#=
0A...................ENDCASE#0A....CASE.f_lm<BR>:.....cvfk("LM").//.a.:#3=
D.-n#0A...................<BR>writef("*n.MOVL.#23-%n,R8",.kval)#0A.......=
........<BR>....ENDCASE#0A#0A....CASE.f_sp:.....cvfp("SP").//.P<BR>!n.:#3=
D.a#0A...................writef("*n.MOVL.R8,%<BR>n(R10)",.4*pval)#0A.....=
..............ENDCASE#0A...<BR>.CASE.f_sg:.....cvfg("SG").//.G!n.:#3D.a#0=
A........<BR>...........writef("*n.MOVL.R8,%n(R11)",.4*gval)#0A.<BR>.....=
.............ENDCASE#0A....CASE.f_sl:.....cvfl<BR>("SL").//.!Ln.:#3D.a#0A=
...................writef("*<BR>n.MOVL.R8,L%n",.lval)#0A.................=
..ENDCASE#0A<BR>#0A....CASE.f_ap:.....cvfp("AP").//.a.:#3D.a.+.P!n#0A<BR>=
...................writef("*n.ADDL2.%n(R10),R8",.4*<BR>pval)#0A..........=
.........ENDCASE#0A....CASE.f_ag:<BR>.....cvfg("AG").//.a.:#3D.a.+.G!n#0A=
...............<BR>....writef("*n.ADDL2.%n(R11),R8",.4*gval)#0A.......<BR=
>............ENDCASE#0A....CASE.f_a:......cvfk("A").<BR>//.a.:#3D.a.+.n#0=
A...................IF.kval#3D0.EN<BR>DCASE#0A...................IF.kval#=
3D1..DO.{.writef<BR>("*n.INCL.R8");.ENDCASE.}#0A...................IF.k<B=
R>val#3D-1.DO.{.writef("*n.DECL.R8");.ENDCASE.}#0A...<BR>................=
writef("*n.ADDL2.#23%n,R8",.kval)#0A<BR>...................ENDCASE#0A....=
CASE.f_s:......cvf<BR>k("S")..//.a.:#3D.a.-.k#0A...................IF.kva=
<BR>l#3D0.ENDCASE#0A...................IF.kval#3D1..DO.<BR>{.writef("*n.D=
ECL.R8");.ENDCASE.}#0A...............<BR>....IF.kval#3D-1.DO.{.writef("*n=
.INCL.R8");.ENDCASE<BR>.}#0A...................writef("*n.SUBL2.#23%n,R8"=
,<BR>.kval)#0A...................ENDCASE#0A#0A....CASE.f<BR>_lkp:....cvfk=
p("LKP").//.a.:#3D.P!n!k#0A...........<BR>........writef("*n.MOVL.%n(R10)=
,R1",.4*pval)#0A....<BR>...............writef("*n.MOVL.%n(R9)[R1],R8",.4*=
kv<BR>al)#0A...................ENDCASE#0A....CASE.f_lkg:.<BR>...cvfkg("LK=
G").//.a.:#3D.G!n!k#0A.................<BR>..writef("*n.MOVL.%n(R11),R1",=
.4*gval)#0A..........<BR>.........writef("*n.MOVL.%n(R9)[R1],R8",.4*kval)=
#0A<BR>...................ENDCASE#0A....CASE.f_rv:.....cvf<BR>("RV")..//.=
a.:#3D.!.a#0A...................writef("<BR>*n.MOVL.(R9)[R8],R8")#0A.....=
..............ENDCASE#0A<BR>....CASE.f_rvp:....cvfp("RVP").//.a.:#3D.P!n!=
a#0A..<BR>.................writef("*n.ADDL2.%n(R10),R8",.4*pv<BR>al)#0A..=
.................writef("*n.MOVL.(R9)[R8],R<BR>8")#0A...................E=
NDCASE#0A....CASE.f_rvk:.<BR>...cvfk("RVK").//.a.:#3D.a!k#0A.............=
......w<BR>ritef("*n.MOVL.%n(R9)[R8],R8",.4*kval)#0A..........<BR>.......=
..ENDCASE#0A....CASE.f_st:.....cvf("ST").//.<BR>!a.:#3D.b#0A.............=
......writef("*n.MOVL.R7,(<BR>R9)[R8]")#0A...................ENDCASE#0A..=
..CASE.f<BR>_stp:....cvfp("STP").//.P!n!a.:#3D.b#0A............<BR>......=
.writef("*n.MOVL.%n(R10),R1",.4*pval)#0A.....<BR>..............writef("*n=
.ADDL2.R8,R1")#0A..........<BR>.........writef("*n.MOVL.R7,(R9)[R1]")#0A.=
.........<BR>.........ENDCASE#0A....CASE.f_stk:....cvfk("STK")./<BR>/.a!k=
.:#3D.b#0A...................writef("*n.MOVL.R<BR>7,%n(R9)[R8]",.4*kval)#=
0A...................ENDCASE<BR>#0A....CASE.f_stkp:...cvfkp("STKP")..//.P=
!n!k.:#3D.<BR>a#0A...................writef("*n.MOVL.%n(R10),R1",<BR>..4*=
pval)#0A...................writef("*n.MOVL.R8,%<BR>n(R9)[R1]",.4*kval)#0A=
...................ENDCASE#0A<BR>.....CASE.f_skg:....cvfkg("SKG").//.G!n!=
k.:#3D.a#0A<BR>....................writef("*n.MOVL.%n(R11),R1",.4*<BR>gva=
l)#0A...................writef("*n.MOVL.R8,%n(R9<BR>)[R1]",.4*kval)#0A...=
................ENDCASE#0A....<BR>CASE.f_xst:....cvf("XST").//.!b.:#3D.a#=
0A..........<BR>..........writef("*n.MOVL.R8,(R9)[R7]")#0A.........<BR>..=
.........ENDCASE#0A#0A....CASE.f_k:......cvfp("K"<BR>).//.Call..a(b,#2E#2=
E#2E).incrementing.P.by.n#0A...<BR>................writef("*n.MOVL.R8,R2"=
)...//.R2.#3D<BR>.&lt;entry.point&gt;#0A...................writef("*n.MOV=
L<BR>.R7,R8")...//.R8.#3D.&lt;first.arg&gt;,.if.any#0A........<BR>.......=
....writef("*n.MOVAL.%n(R10),R1",.4*pval).//<BR>.R1.#3D.&lt;new.P&gt;#0A.=
..................writef("*n.JSB<BR>.(R2)").....//.Subroutine.jump#0A....=
..............<BR>.ENDCASE#0A#0A....CASE.f_kpg:....cvfpg("KPG").//.Ca<BR>=
ll.Gg(a,#2E#2E#2E).incrementing.P.by.k#0A..........<BR>.........writef("*=
n.MOVL.%n(R11),R2",.4*gval)#0A...<BR>................writef("*n.MOVAL.%n(=
R10),R1",.4*pva<BR>l)#0A...................writef("*n.JSB.(R2)")#0A...<BR=
>................ENDCASE#0A#0A....CASE.f_neg:....cvf<BR>("NEG").//.a.:#3D=
.-.a#0A...................writef("<BR>*n.MNEGL.R8,R8").#0A...............=
....ENDCASE#0A..<BR>..CASE.f_not:.....cvf("NOT").//.a.:#3D.~.a#0A......<B=
R>.............writef("*n.MCOML.R8,R8").#0A..........<BR>.........ENDCASE=
#0A....CASE.f_abs:....cvf("ABS").//<BR>.a.:#3D.ABS.a#0A..................=
{.LET.lab.#3D.nex<BR>tlab()#0A....................writef("*n.TSTL..R8")#0=
A<BR>....................writef("*n.BGEQ..X%n",.lab)#0A.<BR>.............=
......writef("*n.MNEGL.R8,R8")#0A.....<BR>..............writef("*nX%n:",.=
lab)#0A.............<BR>......ENDCASE#0A..................}#0A#0A....CASE=
.f<BR>_xdiv:...cvf("XDIV").//.a.:#3D.a./.b#0A............<BR>.......write=
f("*n.DIVL2.R7,R8")#0A.................<BR>..ENDCASE#0A....CASE.f_xrem:..=
.cvf("XREM").//.a.:#3D<BR>.a.REM.b#0A....................writef("*n.MOVL.=
.R8,<BR>R3")#0A....................writef("*n.ASHQ..#23-32,<BR>R2,R2")#0A=
....................writef("*n.EDIV..R7,R<BR>2,R8,R4")#0A................=
....writef("*n.MOVL..R4<BR>,R8")#0A....................ENDCASE#0A....CASE=
.f_xs<BR>ub:...cvf("XSUB").//.a.:#3D..a.-.b#0A..............<BR>.....writ=
ef("*n.SUBL2.R7,R8")#0A...................<BR>ENDCASE#0A#0A....CASE.f_mul=
:.....cvf("MUL").//.a.:#3D<BR>.b.*.a;.c.:#3D.?#0A....................writ=
ef("*n.M<BR>ULL2.R7,R8")#0A....................ENDCASE#0A....CA<BR>SE.f_d=
iv:....cvf("DIV")..//.a..:#3D.b./.a;.c.:#3D.?<BR>#0A...................wr=
itef("*n.DIVL3..R8,R7,R8")#0A<BR>...................ENDCASE#0A.....CASE.f=
_rem:....cv<BR>f("REM").//.a.:#3D.b.REM.a;.c.:#3D.?#0A............<BR>...=
....writef("*n.MOVL..R7,R3")#0A.................<BR>..writef("*n.ASHQ..#2=
3-32,R2,R2")#0A...............<BR>....writef("*n.EDIV..R8,R2,R7,R4")#0A..=
............<BR>.....writef("*n.MOVL..R4,R8")#0A...................<BR>.E=
NDCASE#0A....CASE.f_add:....cvf("ADD").//.a.:#3D.<BR>b.+.a#0A............=
.......writef("*n.ADDL2.R7,R8")<BR>#0A...................ENDCASE#0A.....C=
ASE.f_sub:...<BR>.cvf("SUB").//.a.:#3D.b.-.a#0A....................w<BR>r=
itef("*n.SUBL3.R8,R7,R8")#0A....................EN<BR>DCASE#0A#0A....CASE=
.f_eq:.....cvf("EQ").//.a.:#3D.b<BR>.#3D.a#0A.................{.LET.lab.#=
3D..nextlab()#0A<BR>...................writef("*n.CLRL.R4")#0A.........<B=
R>..........writef("*n.CMPL.R7,R8")#0A...............<BR>.....writef("*n.=
BNEQ.X%n",.lab)#0A.................<BR>...writef("*n.DECL.R4")#0A........=
............write<BR>f("*nX%n:",.lab)#0A...................writef("*n.MO<=
BR>VL.R4,R8")#0A...................ENDCASE#0A.........<BR>.........}#0A..=
..CASE.f_ne:.....cvf("NE").//.a.:#3D<BR>.b.~#3D.a#0A.................{.LE=
T.lab.#3D.nextlab(<BR>)#0A...................writef("*n.CLRL.R4")#0A.....=
<BR>..............writef("*n.CMPL.R7,R8")#0A...........<BR>.........write=
f("*n.BEQL.X%n",.lab)#0A.............<BR>.......writef("*n.DECL.R4")#0A..=
.................wr<BR>itef("*nX%n:",.lab)#0A...................writef("*=
n<BR>.MOVL.R4,R8")#0A...................ENDCASE#0A......<BR>...........}#=
0A....CASE.f_ls:.....cvf("LS").//.a.:#3D<BR>.b.&lt;.a#0A.................=
{.LET.lab.#3D.nextlab()#0A<BR>...................writef("*n.CLRL.R4")#0A.=
........<BR>..........writef("*n.CMPL.R7,R8")#0A...............<BR>....wr=
itef("*n.BGEQ.X%n",.lab)#0A..................<BR>.writef("*n.DECL.R4")#0A=
...................writef("<BR>*nX%n:",.lab)#0A...................writef(=
"*n.MOVL.<BR>R4,R8")#0A...................ENDCASE#0A............<BR>.....=
}#0A....CASE.f_gr:.....cvf("GR").//.a.:#3D.b.&gt;<BR>.a#0A...............=
..{.LET.lab.#3D.nextlab()#0A...<BR>................writef("*n.CLRL.R4")#0=
A............<BR>.......writef("*n.CMPL.R7,R8")#0A..................<BR>.=
writef("*n.BLEQ.X%n",.lab)#0A...................wr<BR>itef("*n.DECL.R4")#=
0A...................writef("*nX<BR>%n:",.lab)#0A...................write=
f("*n.MOVL.R4,<BR>R8")#0A...................ENDCASE#0A...............<BR>=
..}#0A....CASE.f_le:.....cvf("LE").//.a.:#3D.b.&lt;#3D<BR>.a#0A..........=
.......{.LET.lab.#3D.nextlab()#0A...<BR>................writef("*n.CLRL.R=
4")#0A............<BR>.......writef("*n.CMPL.R7,R8")#0A..................=
<BR>.writef("*n.BGTR.X%n",.lab)#0A...................wr<BR>itef("*n.DECL.=
R4")#0A...................writef("*nX<BR>%n:",.lab)#0A...................=
writef("*n.MOVL.R4,<BR>R8")#0A...................ENDCASE#0A..............=
.<BR>..}#0A....CASE.f_ge:.....cvf("GE").//.a.:#3D.b.&gt;#3D<BR>.a#0A.....=
............{.LET.lab.#3D.nextlab()#0A...<BR>................writef("*n.C=
LRL.R4")#0A............<BR>.......writef("*n.CMPL.R7,R8")#0A.............=
.....<BR>.writef("*n.BLSS.X%n",.lab)#0A...................wr<BR>itef("*n.=
DECL.R4")#0A...................writef("*nX<BR>%n:",.lab)#0A..............=
.....writef("*n.MOVL.R4,<BR>R8")#0A...................ENDCASE#0A.........=
......<BR>..}#0A....CASE.f_eq0:....cvf("EQ0").//.a.:#3D.a.#3D<BR>.0#0A...=
..............{.LET.lab.#3D.nextlab()#0A...<BR>................writef("*n=
.CLRL.R4")#0A............<BR>.......writef("*n.TSTL.R8")#0A..............=
.....wr<BR>itef("*n.BNEQ.X%n",.lab)#0A...................write<BR>f("*n.D=
ECL.R4")#0A...................writef("*nX%n:<BR>",.lab)#0A...............=
....writef("*n.MOVL.R4,R8"<BR>)#0A...................ENDCASE#0A..........=
.......}<BR>#0A....CASE.f_ne0:....cvf("NE0").//.a.:#3D.a.~#3D.0<BR>#0A...=
..............{.LET.lab.#3D.nextlab()#0A.....<BR>..............writef("*n=
.CLRL.R4")#0A..............<BR>.....writef("*n.TSTL.R8")#0A..............=
.....writ<BR>ef("*n.BEQL.X%n",.lab)#0A...................writef(<BR>"*n.D=
ECL.R4")#0A...................writef("*nX%n:",<BR>.lab)#0A...............=
....writef("*n.MOVL.R4,R8")#0A<BR>...................ENDCASE#0A..........=
.......}#0A.<BR>...CASE.f_ls0:....cvf("LS0").//.a.:#3D.a.&lt;.0#0A....<BR=
>...............writef("*n.ASHL.#23-32,R8,R8")#0A...<BR>................E=
NDCASE#0A....CASE.f_gr0:....cvf("G<BR>R0").//.a.:#3D.a.&gt;.0#0A.........=
..........writef("*<BR>n.SUBL3.#231,R8,R4")#0A...................writef("=
*<BR>n.BISL2.R8,R4")#0A...................writef("*n.ASH<BR>L.#23-32,R4,R=
8")#0A...................writef("*n.MC<BR>OML.R8,R8")#0A.................=
..ENDCASE#0A....CASE<BR>.f_le0:....cvf("LE0").//.a.:#3D.a.&lt;#3D.0#0A...=
.....<BR>...........writef("*n.SUBL3.#231,R8,R4")#0A........<BR>.........=
..writef("*n.BISL2.R8,R4")#0A.............<BR>......writef("*n.ASHL.#23-3=
2,R4,R8")#0A............<BR>.......ENDCASE#0A....CASE.f_ge0:....cvf("GE0"=
).//.a<BR>.:#3D.a.&gt;#3D.0#0A...................writef("*n.ASHL<BR>.#23-=
32,R8,R8")#0A...................writef("*n.MCO<BR>ML.R8,R8")#0A..........=
.........ENDCASE#0A#0A....CA<BR>SE.f_lsh:....cvf("LSH").//.a.:#3D.b.&lt;&=
lt;.a;.b.:#3D.?#0A<BR>...................writef("*n.ASHL.R8,R7,R8")#0A...=
<BR>................ENDCASE#0A....CASE.f_rsh:....cvf("R<BR>SH").//.a.:#3D=
.b.&gt;&gt;.a;.b.:#3D.?#0A.................<BR>..writef("*n.MNEGL.R8,R4")=
#0A...................wri<BR>tef("*n.MOVL.R7,R8")#0A...................wr=
itef("*<BR>n.ASHQ.R4,R8,R8")#0A...................ENDCASE#0A..<BR>..CASE.=
f_and:....cvf("AND").//.a.:#3D.b.&amp;.a#0A.....<BR>..............writef(=
"*n.MCOML.R7,R1").#0A.........<BR>..........writef("*n.BICL2.R1,R8").#0A.=
............<BR>......ENDCASE#0A....CASE.f_or:.....cvf("OR").//.a.:<BR>#3=
D.b.|.a.#0A...................writef("*n.BISL2.R7<BR>,R8").#0A...........=
........ENDCASE#0A....CASE.f_xo<BR>r:....cvf("XOR").//.a.:#3D.b.NEQV.a#0A=
.............<BR>......writef("*n.XORL2.R7,R8").#0A.................<BR>.=
.ENDCASE#0A....CASE.f_eqv:....cvf("EQV").//.a.:#3D<BR>.b.EQV.a.#0A.......=
............writef("*n.XORL2.R7,<BR>R8").#0A...................writef("*n=
.MCOML.R8,R8")<BR>.#0A...................ENDCASE#0A#0A....CASE.f_gbyt<BR>=
:...cvf("GBYT").//.a.:#3D.b.%.a#0A.................<BR>..writef("*n.MULL3=
.#234,R7,R4").#0A................<BR>...writef("*n.MOVZBL.(R4)[R8],R8").#=
0A.............<BR>......ENDCASE#0A....CASE.f_xgbyt:..cvf("XGBYT").//.<BR=
>a.:#3D.a.%.b.#0A...................writef("*n.MULL3<BR>.#234,R8,R4").#0A=
...................writef("*n.MOVZ<BR>BL.(R4)[R7],R8").#0A...............=
....ENDCASE#0A..<BR>..CASE.f_pbyt:...cvf("PBYT").//.b.%.a.:#3D.c#0A....<B=
R>...............writef("*n.MULL3.#234,R7,R4").#0A...<BR>................=
writef("*n.MOVB.R6,(R4)[R8]").#0A..<BR>.................ENDCASE#0A....CAS=
E.f_xpbyt:..cvf("<BR>XPBYT").//.a.%.b.:#3D.c.#0A...................write<=
BR>f("*n.MULL3.#234,R8,R4").#0A...................writ<BR>ef("*n.MOVB.R6,=
(R4)[R7]").#0A...................END<BR>CASE#0A#0A//.swb.......Kn.Ld.K1.L=
1.#2E#2E#2E.Kn.Ln.<BR>..Binary.chop.switch,.Ld.default#0A....CASE.f_swb:.=
<BR>...cvswb()#0A...................ENDCASE#0A#0A//.swl<BR>.......Kn.Ld.L=
1.#2E#2E#2E.Ln.........Label.vector.s<BR>witch,.Ld.default#0A....CASE.f_s=
wl:....cvswl()#0A..<BR>.................ENDCASE#0A#0A....CASE.f_xch:....c=
v<BR>f("XCH").//.swap.a.and.b#0A...................write<BR>f("*n.MOVL.R8=
,R4")#0A...................writef("*n.<BR>MOVL.R7,R8")#0A................=
...writef("*n.MOVL.R<BR>4,R7")#0A...................ENDCASE#0A....CASE.f_=
at<BR>b:....cvf("ATB").//.b.:#3D.a#0A...................w<BR>ritef("*n.MO=
VL.R8,R7")#0A...................ENDCASE<BR>#0A....CASE.f_atc:....cvf("ATC=
").//.c.:#3D.a#0A....<BR>...............writef("*n.MOVL.R8,R6")#0A.......=
...<BR>.........ENDCASE#0A....CASE.f_bta:....cvf("BTA").//<BR>.a.:#3D.b#0=
A...................writef("*n.MOVL.R7,R<BR>8")#0A...................ENDC=
ASE#0A....CASE.f_btc:.<BR>...cvf("BTC").//.c.:#3D.b#0A...................=
writ<BR>ef("*n.MOVL.R7,R6")#0A...................ENDCASE#0A<BR>....CASE.f=
_atblp:..cvfp("ATBLP").//.b.:#3D.a;.a.:#3D<BR>.P!n#0A...................w=
ritef("*n.MOVL.R8,R7")#0A<BR>...................writef("*n.MOVL.%n(R10),R=
8",.4*p<BR>val)#0A...................ENDCASE#0A....CASE.f_atbl<BR>g:..cvf=
g("ATBLG").//.b.:#3D.a;.a.:#3D.G!n#0A.......<BR>............writef("*n.MO=
VL.R8,R7")#0A.............<BR>......writef("*n.MOVL.%n(R11),R8",.4*gval)#=
0A......<BR>.............ENDCASE#0A....CASE.f_atbl:...cvfk("ATB<BR>L").//=
.b.:#3D.a;.a.:#3D.k#0A...................writ<BR>ef("*n.MOVL.R8,R7")#0A..=
.................writef("*n<BR>.MOVL.#23%n,R8",.kval)#0A.................=
..ENDCASE<BR>#0A#0A....CASE.f_j:......cvfl("J").//.jump.to.Ln#0A<BR>.....=
..............writef("*n.JMP.L%n",.lval)#0A...<BR>................ENDCASE=
#0A....CASE.f_rtn:....cvf("R<BR>TN").//.procedure.return#0A..............=
.....write<BR>f("*n.MOVL.4(R10),R2")..//.R2.#3D.&lt;return.address&gt;#0A=
<BR>...................writef("*n.MOVL.(R10),R10")..//.<BR>P.:#3D.old.P#0=
A...................writef("*n.JMP.(R<BR>2)")........//.Jump.to.&lt;retur=
n.address&gt;#0A.........<BR>..........ENDCASE#0A#0A....CASE.f_goto:...cv=
f("GOTO<BR>").//.jump.to.a#0A...................writef("*n.JMP<BR>.(R8)")=
#0A...................ENDCASE#0A#0A....CASE.<BR>f_ikp:....cvfkp("IKP").//=
.a.:#3D.P!n.+.k;.P!n.:#3D.<BR>a#0A...................writef("*n.MOVL.%n(R=
10),R8",<BR>.4*pval)#0A...................TEST.kval#3D1#0A.....<BR>......=
........THEN.writef("*n.INCL.R8")#0A.........<BR>..........ELSE.TEST.kval=
#3D-1#0A...................<BR>.....THEN.writef("*n.DECL.R8")#0A.........=
.........<BR>......ELSE.writef("*n.ADDL2.#23%n,R8",.kval)#0A....<BR>.....=
..........writef("*n.MOVL.R8,%n(R10)",.4*pval)<BR>#0A...................E=
NDCASE#0A....CASE.f_ikg:....<BR>cvfkg("IKG").//.a.:#3D.G!n.+.k;.G!n.:#3D.=
a#0A......<BR>.............writef("*n.MOVL.%n(R11),R8",.4*gval)#0A<BR>...=
................TEST.kval#3D1#0A................<BR>...THEN.writef("*n.IN=
CL.R8")#0A...................E<BR>LSE.TEST.kval#3D-1#0A..................=
......THEN.w<BR>ritef("*n.DECL.R8")#0A........................ELSE.<BR>wr=
itef("*n.ADDL2.#23%n,R8",.kval)#0A...............<BR>....writef("*n.MOVL.=
R8,%n(R11)",.4*gval)#0A........<BR>...........ENDCASE#0A....CASE.f_ikl:..=
..cvfkl("IKL"<BR>).//.a.:#3D.!Ln.+.k;.!Ln.:#3D.a#0A.................<BR>.=
.writef("*n.MOVL.L%n,R8",.lval)#0A................<BR>...TEST.kval#3D1#0A=
...................THEN.writef("<BR>*n.INCL.R8")#0A...................ELS=
E.TEST.kval#3D<BR>-1#0A........................THEN.writef("*n.DECL.R<BR>=
8")#0A........................ELSE.writef("*n.ADDL2<BR>.#23%n,R8",.kval)#=
0A...................writef("*n.M<BR>OVL.R8,L%n",.lval)#0A...............=
....ENDCASE#0A.<BR>...CASE.f_ip:.....cvfp("IP").//.a.:#3D.P!n.+.a;.P!n<BR=
>.:#3D.a#0A...................writef("*n.ADDL2.%n(R1<BR>0),R8",.4*pval)#0=
A...................writef("*n.MOV<BR>L.R8,%n(R10)",.4*pval)#0A..........=
.........ENDCASE<BR>#0A....CASE.f_ig:.....cvfg("IG").//.a.:#3D.G!n.+.a;<B=
R>.G!n.:#3D.a#0A...................writef("*n.ADDL2.%<BR>n(R11),R8",.4*gv=
al)#0A...................writef("*n<BR>.MOVL.R8,%n(R11)",.4*gval)#0A.....=
..............END<BR>CASE#0A....CASE.f_il:.....cvfl("IL").//.a.:#3D.!Ln.<=
BR>+.a;.!Ln.:#3D.a#0A...................writef("*n.ADD<BR>L2.L%n,R8",.lva=
l)#0A...................writef("*n.M<BR>OVL.R8,L%n",.lval)#0A............=
.......ENDCASE#0A#0A<BR>....CASE.f_jeq:....cvfl("JEQ").//.Jump.to.Ln.if.b=
.#3D<BR>.a#0A...................writef("*n.CMPL.R7,R8")#0A.<BR>..........=
........genBEQL(lval)#0A.................<BR>..ENDCASE#0A....CASE.f_jne:.=
...cvfl("JNE").//.Jump.<BR>to.Ln.if.b.~#3D.a#0A...................writef(=
"*n.C<BR>MPL.R7,R8")#0A...................genBNEQ(lval)#0A..<BR>.........=
........ENDCASE#0A....CASE.f_jls:....cvfl(<BR>"JLS").//.Jump.to.Ln.if.b.&=
lt;.a#0A...................<BR>writef("*n.CMPL.R7,R8")#0A................=
...genBLS<BR>S(lval)#0A...................ENDCASE#0A....CASE.f_j<BR>gr:..=
..cvfl("JGR").//.Jump.to.Ln.if.b.&gt;.a#0A.......<BR>............writef("=
*n.CMPL.R7,R8")#0A.............<BR>......genBGTR(lval)#0A................=
...ENDCASE#0A<BR>....CASE.f_jle:....cvfl("JLE").//.Jump.to.Ln.if.b.&lt;<B=
R>#3D.a#0A...................writef("*n.CMPL.R7,R8")#0A<BR>..............=
.....genBLEQ(lval)#0A................<BR>...ENDCASE#0A....CASE.f_jge:....=
cvfl("JGE").//.Jump<BR>.to.Ln.if.b.&gt;#3D.a#0A...................writef(=
"*n.<BR>CMPL.R7,R8")#0A...................genBGEQ(lval)#0A.<BR>..........=
........ENDCASE#0A#0A....CASE.f_jeq0:...c<BR>vfl("JEQ0").//.Jump.to.Ln.if=
.a.#3D.0#0A............<BR>.......writef("*n.TSTL.R8")#0A................=
...ge<BR>nBEQL(lval)#0A...................ENDCASE#0A....CASE<BR>.f_jne0:.=
..cvfl("JNE0").//.Jump.to.Ln.if.a.~#3D.0#0A<BR>...................writef(=
"*n.TSTL.R8")#0A.........<BR>..........genBNEQ(lval)#0A..................=
.ENDCAS<BR>E#0A....CASE.f_jls0:...cvfl("JLS0").//.Jump.to.Ln.i<BR>f.a.&lt=
;.0#0A...................writef("*n.TSTL.R8")#0A<BR>...................ge=
nBLSS(lval)#0A................<BR>...ENDCASE#0A....CASE.f_jgr0:...cvfl("J=
GR0").//.Jum<BR>p.to.Ln.if.a.&gt;.0#0A...................writef("*n.TS<BR=
>TL.R8")#0A...................genBGTR(lval)#0A......<BR>.............ENDC=
ASE#0A....CASE.f_jle0:...cvfl("JLE<BR>0").//.Jump.to.Ln.if.a.&lt;#3D.0#0A=
...................<BR>writef("*n.TSTL.R8")#0A...................genBLEQ(=
l<BR>val)#0A...................ENDCASE#0A....CASE.f_jge0<BR>:...cvfl("JGE=
0").//.Jump.to.Ln.if.a.&gt;#3D.0#0A......<BR>.............writef("*n.TSTL=
.R8")#0A...............<BR>....genBGEQ(lval)#0A...................ENDCASE=
#0A..<BR>..CASE.f_jge0m:..cvfm("JGE0M").//.Jump.to.Mn.if.a.&gt;<BR>#3D.0#=
0A...................writef("*n.TSTL.R8")#0A.<BR>..................genBGE=
Q(mval+10000)#0A...........<BR>........ENDCASE#0A#0A....//.The.following.=
five.opco<BR>des.are.never.generated.by#0A....//.the.BCPL.compil<BR>er#0A=
....CASE.f_brk:....cvf("BRK").//.Breakpoint.in<BR>struction#0A...........=
........writef("*n.unimpleme<BR>nted")#0A...................ENDCASE#0A...=
.CASE.f_no<BR>p:....cvf("NOP").//.No.operation#0A................<BR>...E=
NDCASE#0A....CASE.f_chgco:..cvf("CHGCO").//.Cha<BR>nge.coroutine#0A......=
.............writef("*n.unimp<BR>lemented")#0A...................ENDCASE#=
0A....CASE.<BR>f_mdiv:...cvf("MDIV").//.a.:#3D.Muldiv(P!3,.P!4,.P!<BR>5).=
#0A...................writef("*n.unimplemented")<BR>#0A..................=
.ENDCASE#0A....CASE.f_sys:....<BR>cvf("SYS").//.System.function#0A.......=
............<BR>writef("*n.unimplemented")#0A...................END<BR>CA=
SE#0A#0A....CASE.f_modend:...cvf("MODEND").//.End<BR>.of.module#0A.......=
..............writef("*nL1000:"<BR>).#0A.....................writef("*n.#=
2EEND*n").#0A<BR>.....................modletter.:#3D.modletter+1#0A.<BR>.=
...................modstarted.:#3D.FALSE#0A.......<BR>..............ENDCA=
SE#0A....CASE.f_global:...cvglob<BR>al().//.Global.initialisation.data#0A=
..............<BR>.......ENDCASE#0A....CASE.f_string:...cvstring().//<BR>=
.String.constant#0A.....................ENDCASE#0A.<BR>...CASE.f_const:..=
..cvconst().//.Large.integer.cons<BR>tant#0A.....................ENDCASE#=
0A#0A....CASE.f<BR>_static:...cvstatic().//.Static.variable.or.table#0A<B=
R>.....................ENDCASE#0A....CASE.f_mlab:....<BR>.cvfm("MLAB").//=
.Destination.of.jge0m#0A...........<BR>..........writef("*nL%n:",.mval+10=
000)#0A..........<BR>...........ENDCASE#0A....CASE.f_lab:......cvfl("LAB<=
BR>").//.Program.label#0A.....................writef("<BR>*nL%n:",.lval)#=
0A.....................ENDCASE#0A...<BR>.CASE.f_lstr:.....cvfm("LSTR").//=
.a.:#3D.Mn...(poin<BR>ter.to.string)#0A.....................writef("*n.MO=
<BR>VAL.W^L%n,R8",.mval+10000)#0A.....................w<BR>ritef("*n.DIVL=
2.#234,R8")#0A.....................EN<BR>DCASE#0A....CASE.f_entry:....cve=
ntry().//.Start.of.<BR>a.function#0A.....................ENDCASE#0A..}#0A=
#0A<BR>..newline()#0A}.REPEAT#0A#0AAND.cvf(s)...BE.writef(<BR>";.%s",.s)#=
0AAND.cvfp(s)..BE.writef(";.%t7.P%n",.s,<BR>.rdp())#0AAND.cvfkp(s).BE.wri=
tef(";.%t7.K%n.P%n",.s<BR>,.rdk(),.rdp())#0AAND.cvfg(s)..BE.writef(";.%t7=
.G%n<BR>",.s,.rdg())#0AAND.cvfkg(s).BE.writef(";.%t7.K%n.G%<BR>n",.s,.rdk=
(),.rdg())#0AAND.cvfkl(s).BE.writef(";.%t<BR>7.K%n.L%n",.s,.rdk(),.rdl())=
#0AAND.cvfpg(s).BE.writ<BR>ef(";.%t7.P%n.G%n",.s,.rdp(),.rdg())#0AAND.cvf=
k(s).<BR>.BE.writef(";.%t7.K%n",.s,.rdk())#0AAND.cvfw(s)..BE<BR>.writef("=
;.%t7.W%n",.s,.rdw())#0AAND.cvfl(s)..BE.wr<BR>itef(";.%t7.L%n",.s,.rdl())=
#0AAND.cvfm(s)..BE.write<BR>f(";.%t7.M%n",.s,.rdm())#0A#0AAND.cvswl().BE#=
0A{.LE<BR>T.n.#3D.rdk()#0A..LET.dlab.#3D.rdl()#0A..LET.lab.#3D<BR>.nextla=
b()#0A..writef(";.SWL.K%n.L%n",.n,.dlab)#0A.<BR>.writef("*n.TSTL.R8")#0A.=
.genBLSS(dlab)#0A..writef(<BR>"*n.CMPL.#23%n,R8",.n)#0A..genBLEQ(dlab)#0A=
writef("<BR>*n.MOVL.L^X%n(R9)[R8],R1",.lab)#0Awritef("*n.JMP.(R<BR>1)")#0=
A//..writef("*n.JMP.L^X%n(R9)[R8]",.lab)#0A..<BR>writef("*n.#2EALIGN.LONG=
")#0A..writef("*nX%n:",.lab<BR>)#0A..FOR.i.#3D.1.TO.n.DO#0A..{.writef("*n=
;.L%n",.r<BR>dl())#0A....writef("*n.#2ELONG.L%n",.lval)#0A..}#0A<BR>}#0A#=
0AAND.cvswb().BE#0A{.LET.n.#3D.rdk()#0A..LET.d<BR>lab.#3D.rdl()#0A..write=
f(";.SWB.K%n.L%n",.n,.dlab).<BR>.//.A.naive.implementation.of.swb#0A..FOR=
.i.#3D.1.T<BR>O.n.DO.#0A..{.LET.k.#3D.rdk()#0A....LET.lab.#3D.rdl<BR>()#0=
A....writef("*n;.K%n.L%n",.k,.lab)#0A....writef<BR>("*n.CMPL.#23%n,R8",.k=
)#0A....genBEQL(lab)#0A..}#0A<BR>..writef("*n.JMP.L%n",.dlab)#0A}#0A#0AAN=
D.cvglobal(<BR>).BE#0A{.LET.n.#3D.rdk()#0A..writef(";.GLOBAL.K%n*n<BR>",.=
n)#0A..IF.sectname%0#3D0.FOR.i.#3D.0.TO.4.DO.sec<BR>tname%i.:#3D."prog"%i=
#0A..writef("*n;#2Eglobl.%s*n"<BR>,.sectname)#0A..writef(";%s::*n",.sectn=
ame)#0A..wri<BR>tef(".#2Eentry.%s,0*n",.sectname)#0A..writef(".movl<BR>.4=
(ap),r1*n")#0A..FOR.i.#3D.1.TO.n.DO#0A..{.LET.g.#3D<BR>.rdg()#0A....LET.n=
.#3D.rdl()#0A....writef(";.G%n.L%<BR>n*n",.g,.n)#0A....writef(".MOVAL.L%n=
,%n(r1)*n",.n,.<BR>4*g)#0A..}#0A..writef(";.G%n",.rdg())#0A..writef("*<BR=
>n.RET*n")#0A}#0A#0AAND.cvglobal1().BE#0A{.LET.n.#3D<BR>.rdk()#0A..writef=
("*n;.GLOBAL.K%n",.n)#0A..IF.sectn<BR>ame%0#3D0.FOR.i.#3D.0.TO.4.DO.sectn=
ame%i.:#3D."prog<BR>"%i#0A..writef("*n#2EALIGN.LONG")#0A..writef("*n#2E<B=
R>LONG.-1")#0A..FOR.i.#3D.1.TO.n.DO#0A..{.LET.g.#3D.r<BR>dg()#0A....LET.n=
.#3D.rdl()#0A....writef("*n;.G%n.L%<BR>n*n",.g,.n)#0A....writef("*n.#2ELO=
NG.%i4,.L%n",.g,.<BR>n)#0A..}#0A..writef("*n;.G%n",.rdg())#0A..writef("*<=
BR>n.#2ELONG.%i4",.gval)#0A}#0A#0AAND.rdchars().#3D.VA<BR>LOF#0A{.LET.n.#=
3D.rdk()#0A..charv%0.:#3D.n#0A..FOR.<BR>i.#3D.1.TO.n.DO.charv%i.:#3D.rdc(=
)#0A..RESULTIS.n#0A<BR>}#0A#0AAND.cvstring().BE#0A{.LET.lab.#3D.rdm()#0A.=
.<BR>LET.n.#3D.rdchars()#0A..writef(";.STRING..M%n.K%n",<BR>.lab,.n)#0A..=
FOR.i.#3D.1.TO.n.DO.writef(".C%n",.cha<BR>rv%i)#0A..writef("*n.#2EALIGN.L=
ONG")#0A..writef("*n<BR>L%n:",.lab+10000)#0A..FOR.i.#3D.0.TO.n.DO.writef(=
"*<BR>n.#2EBYTE.%n",.charv%i)#0A}#0A#0AAND.cvconst().BE#0A<BR>{.LET.lab.#=
3D.rdm()#0A..LET.w.#3D.rdw()#0A..writef(<BR>";.CONST...M%n.W%n",.lab,.w)#=
0A..writef("*n.#2EALIG<BR>N.LONG")#0A..writef("*nL%n:",.lab+10000)#0A..wr=
itef<BR>("*n.#2ELONG.%n",.w)#0A}#0A#0AAND.cvstatic().BE#0A{<BR>.LET.lab.#=
3D.rdl()#0A..LET.n.#3D.rdk()#0A..writef("<BR>;.STATIC..L%n.K%n",.lab,.n)#=
0A..writef("*n.#2EALIGN<BR>.LONG")#0A..writef("*nL%n:",.lab)#0A..FOR.i.#3=
D.1.T<BR>O.n.DO.{.writef("*n;.W%n",.rdw())#0A...............<BR>.......wr=
itef("*n.#2ELONG.%n",.wval)#0A............<BR>........}#0A}#0A#0AAND.cvfs=
(s).BE#0A{.LET.n.#3D.rdc<BR>hars()#0A..writef(";.%t7.K%n",.s,.n)#0A..FOR.=
i.#3D.<BR>1.TO.n.DO.writef(".C%n",.charv%i)#0A}#0A#0AAND.cven<BR>try().BE=
#0A{.LET.n.#3D.rdchars()#0A..LET.op.#3D.rdf<BR>()#0A..LET.lab.#3D.rdl()#0=
A..writef("*n*n;.Entry.to<BR>:.%s*n",.charv)#0A..writef(";.%t7.K%n",."ENT=
RY",.n)<BR>#0A..FOR.i.#3D.1.TO.n.DO.writef(".C%n",.charv%i)#0A<BR>..newli=
ne()#0A..TEST.op#3Df_lab.THEN.writef(";.LAB.<BR>....L%n*n",.lab)#0A......=
..........ELSE.writef(";.B<BR>ad.op.F%n.L%n*n",.op,.lab)#0A..FOR.i.#3D.n+=
1.TO.11.<BR>DO.charv%i.:#3D.'.'#0A..IF.n&gt;11.DO.charv!0.:#3D.11#0A<BR>.=
.writef("*n.#2ELONG.^X%x8",entryword)#0A..writef("<BR>*n.#2ELONG.^X%x8",c=
harv!0)#0A..writef("*n.#2ELONG.^<BR>X%x8",charv!1)#0A..writef("*n.#2ELONG=
.^X%x8",charv!<BR>2)#0A#0A..writef("*nL%n:",.lab)#0A..writef("*n.MOVL<BR>=
.R10,(R1)").......//.Save.&lt;old.P&gt;#0A..writef("*n.MO<BR>VL.R1,R10").=
........//.P.:#3D.&lt;new.P&gt;#0A..writef("*<BR>n.MOVL.(SP)+,4(R10)").//=
.Save.&lt;return.address&gt;#0A..<BR>writef("*n.MOVL.R2,8(R10)")....//.Sa=
ve.&lt;entry.point<BR>&gt;#0A..writef("*n.MOVL.R8,12(R10)")....//.Save.fi=
rst<BR>.argument#0A}#0A#0AAND.genBEQL(lab).BE#0A{.LET.m.#3D<BR>.nextlab()=
#0A..writef("*n.BNEQ.X%n",.m)#0A..writef(<BR>"*n.JMP.L%n",.lab)#0A..write=
f("*nX%n:",.m)#0A}#0A#0A<BR>AND.genBNEQ(lab).BE#0A{.LET.m.#3D.nextlab()#0=
A..wri<BR>tef("*n.BEQL.X%n",.m)#0A..writef("*n.JMP.L%n",.lab)<BR>#0A..wri=
tef("*nX%n:",.m)#0A}#0A#0AAND.genBLSS(lab).<BR>BE#0A{.LET.m.#3D.nextlab()=
#0A..writef("*n.BGEQ.X%n"<BR>,.m)#0A..writef("*n.JMP.L%n",.lab)#0A..write=
f("*nX%<BR>n:",.m)#0A}#0A#0AAND.genBGTR(lab).BE#0A{.LET.m.#3D.<BR>nextlab=
()#0A..writef("*n.BLEQ.X%n",.m)#0A..writef("<BR>*n.JMP.L%n",.lab)#0A..wri=
tef("*nX%n:",.m)#0A}#0A#0A<BR>AND.genBLEQ(lab).BE#0A{.LET.m.#3D.nextlab()=
#0A..wri<BR>tef("*n.BGTR.X%n",.m)#0A..writef("*n.JMP.L%n",.lab)<BR>#0A..w=
ritef("*nX%n:",.m)#0A}#0A#0AAND.genBGEQ(lab).<BR>BE#0A{.LET.m.#3D.nextlab=
()#0A..writef("*n.BLSS.X%n"<BR>,.m)#0A..writef("*n.JMP.L%n",.lab)#0A..wri=
tef("*nX%<BR>n:",.m)#0A}#0A#0A#0A<BR><BR>######natbcpl/sysb/blib.b#<BR>//=
.(c)..Copyright:..Martin.Richards..29.May.2004#0A<BR>#0A/*#0A03/07/07#0AA=
dded.codewrch.to.write.extended<BR>.characters.using.UTF8.or#0AGB2312#2E.=
Added.%#23.su<BR>bstitution.item.in.writef.to.invoke.it#2E.Note.that<BR>#=
0A*xU,.*xG,.*#23hhhh,.*#23#23hhhhhhhh.and.*#23dddd<BR>.escapes.have.been.=
added.to#0ABCPL.string.and.chara<BR>cter.constants#2E#0A#0A29/6/02#0ARena=
med.IOLIB.as.D<BR>LIB.(the.system.Dependent.LIBrary)#2E.Put.system#0A<BR>=
independent.code.in.BLIB.and.the.rest.in.DLIB#2E#0A<BR>#0A24/4/04#0AMade.=
many.changed.to.make.BLIB.more.co<BR>mpatible.between.Cintpos.and#0Asingl=
e.threaded.Cint<BR>code.BCPL#2E#0A#0A21/3/2003#0AMake.instrcount(f,a,b<BR=
>,#2E#2E#2E).set.result2.to.result.of.f(a,b,c,#2E#2E<BR>#2E#2E)#0A#0A10/7=
/2000#0AChanged.the.definition.of.<BR>mkobj.to.take.up.to.11.initialisati=
on#0Aarguments#2E<BR>.See.bcplprogs/objdemo#2Eb#0A#0A28/2/2000#0AAdded.f<=
BR>unction.instrcount(f,a,b,c,e,f,r,g,h,i,j,k)#0Awhich<BR>.returns.the.nu=
mber.of.cintcode.instructions.execut<BR>ed#0Awhen.calling.f(a,b,#2E#2E#2E=
)#2E#0A#0A30/4/199<BR>6#0AAdded.function.flush()#0Awith.corresponding.cha=
<BR>nge.in.cintsys#2Ec#0A#0A7/6/1996#0ADefined.mkobj(up<BR>b,.fns,.a,.b).=
for.use.in.object.oriented.programmin<BR>g#2E#0ASee.bcplprogs/objdemo#2Eb=
..(args.a.and.b.add<BR>ed.30.March.1999)#2E#0A*/#0A#0ASECTION."BLIB"#0A#0=
A<BR>GET."libhdr"#0A#0ALET.stop(code).BE#0A{.//.Return.t<BR>o.the.CLI.wit=
h.a.return.code#2E#0A..//.It.must.be.c<BR>alled.from.the.command's.corout=
ine,#0A..//.not.an.i<BR>nner.coroutine#2E#0A..returncode.:#3D.code#0A..co=
wa<BR>it(code)#0A}#0A#0ALET.clihook(stackupb).#3D.VALOF#0A<BR>{.LET.v.#3D=
.VEC.rtn_upb#0A..rootnode.:#3D.v#0A..FOR<BR>.i.#3D.0.TO.rtn_upb.DO.rootno=
de!i.:#3D.0#0Asawritef<BR>("*nclihook.entered,.stackupb#3D%n*n",.stackupb=
)#0A<BR>..currentdir.:#3D.0#0A..selectoutput(findoutput("**<BR>"))#0A..se=
lectinput(findinput("**"))#0A#0A..//.The.<BR>native.code.command.argument=
s.are.automatically#0A.<BR>.//.prepended.to.stdin#2E.This.is.done.in.sard=
ch.in<BR>.dosys.of.sysc/clib#2Ec#0A#0A..currco.:#3D.@stackup<BR>b-3-6.//.=
Initialise.the.coroutine.environment#0A..c<BR>olist.:#3D.currco#0A..currc=
o!co_pptr...:#3D.0#0A..c<BR>urrco!co_parent.:#3D.-1..//.Mark.as.root.coro=
utine#2E<BR>#0A..currco!co_list...:#3D.0#0A#0A..currco!co_fn...<BR>:#3D.c=
lihook......//.fn#0A..currco!co_size.:#3D.sta<BR>ckupb.....//.stackupb.(f=
irst.arg.of.clihook)#0A..cu<BR>rrco!5.......:#3D.0............//.c#0A#0A.=
.RESULTIS<BR>.start(0)#0A}#0A#0AAND.intflag().#3D.sys(Sys_intfla<BR>g)../=
/.Returns.TRUE.if.user.interrupt#0A#0AAND.abor<BR>t(code).#3D.sys(Sys_qui=
t,.code)#0A#0AAND.level(p3).<BR>#3D.(@p3)!-3#0A#0AAND.longjump(lev,.lab).=
BE.{.LET.p<BR>.#3D.@lev.-.3;.p!0,.p!1.:#3D.lev,.lab.}#0A#0AAND.sa<BR>rdch=
()...#3D.sys(Sys_sardch)#0A#0AAND.sawrch(ch).#3D<BR>.sys(Sys_sawrch,ch)#0=
A#0A//.Set.the.timeout.field#0A<BR>//.msecs&gt;0...The.stream.timeout.val=
ue.in.milli-seco<BR>nds#0A//.msecs#3D0...No.timeout.value.(the.default)<B=
R>#0A//.msecs&lt;0...Only.perform.non.blocking.operation<BR>s.on.the.stre=
am#0A//.On.a.timeout.(on.TCP.streams)#0A<BR>//.act#3D.0....Repeat.the.cur=
rent.operation#0A//.ac<BR>t#3D-1....Make.timeout.have.the.effect.of.EOF#0=
A//.<BR>act#3D-2....Return.timeoutch#0AAND.settimeout(scb,.<BR>msecs,.act=
).BE#0A{.scb!scb_timeout.:#3D.msecs#0A..s<BR>cb!scb_timeoutact.:#3D.act#0=
A}#0A#0A//.Just.set.the<BR>.timeoutact.field#0AAND.settimeoutact(scb,.act=
).BE.<BR>scb!scb_timeoutact.:#3D.act#0A#0AAND.rdch().#3D.VAL<BR>OF#0A//.R=
eturns.the.next.byte.from.the.currently.se<BR>lected.input.stream,#0A//.b=
ut.ignores.CR#2E#0A//.If<BR>.the.buffer.is.empty,.it.calls.replenish.to.a=
ttempt<BR>.to.refill.it#2E#0A//.It.aborts.186.if.no.input.str<BR>eam.is.s=
elected#2E#0A{.LET.pos.#3D.cis!scb_pos.//.P<BR>osition.of.next.byte#0A#0A=
..UNLESS.cis.DO.abort(186<BR>)#0A..IF.pos&lt;cis!scb_end.DO.{.LET.ch.#3D.=
cis!scb_bu<BR>f%pos#0A..........................cis!scb_pos.:#3D.<BR>pos+=
1#0A..........................IF.ch#3D'*c'.LOOP<BR>.//.Ignore.CR#0A......=
....................RESULTIS.<BR>ch#0A........................}#0A..//.No=
.byte.avail<BR>able,.so.attempt.to.replenish.the.buffer#0A..//.If.<BR>rep=
lenish.returns.FALSE,.no.chars.were.placed.in.th<BR>e.buffer#0A..//.and.t=
he.reason.why.not.is.placed.in<BR>.result2.as.follows#0A..//....result2.#=
3D.-1....end<BR>.of.file#0A..//....result2.#3D.-2....timeout#0A..//<BR>..=
..result2.#3D.-3....polling.and.no.characters.ava<BR>ilable#2E#0A..//....=
result2.#3D.code..error.code#0A<BR>..UNTIL.replenish(cis).DO#0A..{.IF.res=
ult2#3D-2.DO#0A<BR>....{.LET.act.#3D.cis!scb_timeoutact.//.Look.at.tim<BR=
>eout.action#0A......IF.act#3D-2.RESULTIS.timeoutch#0A<BR>......IF.act#3D=
-1.RESULTIS.endstreamch#0A......LOOP<BR>..//.Try.replenishing.again#0A...=
.}#0A....RESULTIS.<BR>result2&lt;0.-&gt;.result2,.endstreamch#0A..}#0A../=
/.Succ<BR>essful.replenishment.so.try.rdch.again#0A..//.There<BR>.will.be=
.at.least.one.character.in.the.buffer#0A}.R<BR>EPEAT#0A#0AAND.binrdch().#=
3D.VALOF#0A//.Same.as.rdc<BR>h.but.does.not.ignore.CR#2E#0A{.LET.pos.#3D.=
cis!scb<BR>_pos.//.Position.of.next.byte#0A#0A..UNLESS.cis.DO.<BR>abort(1=
86)#0A..IF.pos&lt;cis!scb_end.DO.{.LET.ch.#3D.c<BR>is!scb_buf%pos#0A.....=
.....................cis!scb_<BR>pos.:#3D.pos+1#0A.......................=
...RESULTIS<BR>.ch#0A........................}#0A..//.No.byte.avai<BR>lab=
le,.so.attempt.to.replenish.the.buffer#0A..//.If<BR>.replenish.returns.FA=
LSE,.no.chars.were.placed.in.t<BR>he.buffer#0A..//.and.the.reason.why.not=
.is.placed.i<BR>n.result2.as.follows#0A..//....result2.#3D.-1....en<BR>d.=
of.file#0A..//....result2.#3D.-2....timeout#0A../<BR>/....result2.#3D.-3.=
...polling.and.no.characters.av<BR>ailable#2E#0A..//....result2.#3D.code.=
.error.code#0A<BR>..UNTIL.replenish(cis).DO#0A..{.IF.result2#3D-2.DO#0A<B=
R>....{.LET.act.#3D.cis!scb_timeoutact.//.Look.at.tim<BR>eout.action#0A..=
....IF.act#3D-2.RESULTIS.timeoutch#0A<BR>......IF.act#3D-1.RESULTIS.endst=
reamch#0A......LOOP<BR>..//.Try.replenishing.again#0A....}#0A....RESULTIS=
.<BR>result2&lt;0.-&gt;.result2,.endstreamch#0A..}#0A..//.Succ<BR>essful.=
replenishment.so.try.rdch.again#0A..//.There<BR>.will.be.at.least.one.ch.=
in.the.buffer#0A}.REPEAT#0A<BR>#0AAND.unrdch().#3D.VALOF#0A//.Attempt.to.=
step.inpu<BR>t.back.by.one.byte.position#2E#0A//.It.returns:.TRU<BR>E.if.=
successful,.and#0A//.............FALSE.otherwi<BR>se#0A//.After.a.call.of=
.rdch().it.will.always.be.su<BR>ccessful.at.least.once#2E#0A//.It.aborts:=
.186.if.no<BR>t.input.stream,.is.selected#2E#0A{.LET.pos.#3D.cis!<BR>scb_=
pos#0A..UNLESS.cis.DO.abort(186)#0A..IF.pos&lt;#3D<BR>0.RESULTIS.FALSE.//=
.Cannot.UNRDCH.past.origin#2E#0A<BR>..cis!scb_pos.:#3D.pos-1#0A..RESULTIS=
.TRUE#0A}#0A#0A<BR>AND.wrch(ch).#3D.VALOF#0A//.wrch(ch).writes.ch.to.t<BR=
>he.current.output.stream#2E#0A//.It.returns.TRUE.if<BR>.successful,.FALS=
E.otherwise#0A//.It.aborts:.187.if<BR>.no.stream.is.selected#0A//........=
....189.on.deple<BR>tion.failure#2E#0A{.LET.pos.#3D.cos!scb_pos#0A#0A..<B=
R>//.If.the.buffer.is.full.try.to.deplete.it#2E#0A..I<BR>F.pos.&gt;#3D.co=
s!scb_bufend.DO#0A..{.UNLESS.deplete(c<BR>os).RESULTIS.FALSE#0A....UNLESS=
.cos!scb_buf..RESULT<BR>IS.TRUE.//.Must.be.writing.to.NIL:#0A....pos.:#3D=
.c<BR>os!scb_pos#0A..}#0A#0A..//.Pack.the.character.and.a<BR>dvance.pos#2=
E#0A..cos!scb_buf%pos.:#3D.ch#0A..pos.:<BR>#3D.pos+1#0A..cos!scb_pos.:#3D=
.pos#0A..//.Advance.e<BR>nd.of.valid.data.pointer,.if.necessary#0A..IF.co=
s!s<BR>cb_end.&lt;.pos.DO.cos!scb_end.:#3D.pos#0A..cos!scb_wr<BR>ite.:#3D=
.TRUE.//.Set.flag.to.indicate.the.buffer.ha<BR>s.changed#2E#0A#0A..UNLESS=
.cos!scb_type&lt;0.&amp;.ch&lt;'*s'<BR>.RESULTIS.TRUE.//.Normal.return#0A=
#0A..//.The.strea<BR>m.is.interactive.and.ch.is.a.control.character#2E#0A=
<BR>#0A..IF.ch#3D'*n'.DO..wrch('*c')..//.Fiddle.for.Cyg<BR>win#0A#0A..//.=
Call.deplete.at.the.end.of.each.inter<BR>active.line#2E#0A..IF.ch#3D'*n'.=
|.ch#3D'*p'.RESULTI<BR>S.deplete(cos)#0A..RESULTIS.TRUE#0A}#0A#0AAND.binw=
r<BR>ch(ch).#3D.wrch(ch.|.256)#0A#0AAND.codewrch(code).B<BR>E#0A{.//.This=
.(misleadingly).writes.either.a.Unicod<BR>e.character.in#0A..//.UTF-8.for=
mat.or.a.code.in.GB2<BR>312.format#2E#0A..//.A.special.(negative).value.t=
o.<BR>select.the.current.encoding#0A..//.to.be.used.on.th<BR>e.currently.=
selected.output.stream.(cos)#2E#0A#0A..<BR>IF.code&lt;0.DO#0A..{.//.Set.t=
he.encoding.for.the.curr<BR>ently.selected#0A....//.output.stream#2E#0A..=
..cos!<BR>scb_encoding.:#3D.code.//.UTF8.(#3D-1).or.GB2312.(#3D<BR>-2)#0A=
....RETURN#0A..}#0A..//.Select.UTF8.unless.GB<BR>2312.explicitly.specifie=
d.in.the.SCB#2E#0A..TEST.co<BR>s!scb_encoding#3DGB2312#0A..THEN.gb2312wrc=
h(code)#0A<BR>..ELSE.utf8wrch(code)#0A}#0A#0AAND.gb2312wrch(code)<BR>.BE#=
0A{.//.I.believe.the.encoding.is.as.follows:#0A<BR>..//.code.#3D.0.-.127.=
#3D&gt;.code#0A..//.code.#3D.xxy<BR>y....#3D&gt;.&lt;xx.+.160&gt;.&lt;yy.=
+.160&gt;#0A..//.............<BR>......eg.4566.#3D&gt;.&lt;45+160&gt;.&lt=
;66+160&gt;.or.CD.E2#0A../<BR>/.Note.that.the.row.encoding.(CD).is.writte=
n.first,<BR>.followed#0A..//.by.the.column#2E#0A..TEST.code&lt;#3D<BR>127=
#0A..THEN.{.wrch(code)#0A//sawritef(".gb2312:.%x<BR>4.#3D&gt;.%x2*n",.cod=
e,.code)#0A.......}#0A..ELSE.{.LE<BR>T.hi.#3D.code../..100.+.160.//.Row.e=
ncoding#0A.....<BR>....LET.lo.#3D.code.MOD.100.+.160.//.Column.encodin<BR=
>g#0A.........wrch(hi)#0A.........wrch(lo)#0A//sawri<BR>tef(".gb2312:.%x4=
.#3D&gt;.%x2.%x2*n",.code,.hi,.lo)#0A<BR>.......}#0A}#0A#0AAND.utf8wrch(c=
ode).BE#0A{.//.Writ<BR>e.a.Unicode.character.in.RTF-8.format#0A..IF.code&=
lt;#3D<BR>#23x7F.DO#0A..{.wrch(code)...................//.0xx<BR>xxxxx#0A=
....RETURN#0A..}#0A..IF.code&lt;#3D#23x7FF.DO#0A<BR>..{.wrch(#23b1100_000=
0+(code&gt;&gt;6))..//.110xxxxx#0A..<BR>..wrch(#23x80+(.code....&amp;#23x=
3F))..//.10xxxxxx#0A..<BR>..RETURN#0A..}#0A..IF.code&lt;#3D#23xFFFF.DO#0A=
..{.wrc<BR>h(#23b1110_0000+(code&gt;&gt;12)).//.1110xxxx#0A....wrch(<BR>#=
23x80+((code&gt;&gt;6)&amp;#23x3F))..//.10xxxxxx#0A....wrch(<BR>#23x80+(.=
code....&amp;#23x3F))..//.10xxxxxx#0A....RETUR<BR>N#0A..}#0A..IF.code&lt;=
#3D#23x1F_FFFF.DO#0A..{.wrch(#23<BR>b1111_0000+(code&gt;&gt;18)).//.11110=
xxx#0A....wrch(#23x8<BR>0+((code&gt;&gt;12)&amp;#23x3F)).//.10xxxxxx#0A..=
..wrch(#23x8<BR>0+((code&gt;&gt;6)&amp;#23x3F))..//.10xxxxxx#0A....wrch(#=
23x8<BR>0+(.code....&amp;#23x3F))..//.10xxxxxx#0A....RETURN#0A.<BR>.}#0A.=
.IF.code&lt;#3D#23x3FF_FFFF.DO#0A..{.wrch(#23b11<BR>11_1000+(code&gt;&gt;=
24)).//.111110xx#0A....wrch(#23x80+(<BR>(code&gt;&gt;18)&amp;#23x3F)).//.=
10xxxxxx#0A....wrch(#23x80+(<BR>(code&gt;&gt;12)&amp;#23x3F)).//.10xxxxxx=
#0A....wrch(#23x80+(<BR>(code&gt;&gt;6)&amp;#23x3F))..//.10xxxxxx#0A....w=
rch(#23x80+(<BR>.code....&amp;#23x3F))..//.10xxxxxx#0A....RETURN#0A..}#0A=
<BR>..IF.code&lt;#3D#23x7FFF_FFFF.DO#0A..{.wrch(#23b1111_1<BR>100+(code&g=
t;&gt;30)).//.1111110x#0A....wrch(#23x80+((cod<BR>e&gt;&gt;24)&amp;#23x3F=
)).//.10xxxxxx#0A....wrch(#23x80+((cod<BR>e&gt;&gt;18)&amp;#23x3F)).//.10=
xxxxxx#0A....wrch(#23x80+((cod<BR>e&gt;&gt;12)&amp;#23x3F)).//.10xxxxxx#0=
A....wrch(#23x80+((cod<BR>e&gt;&gt;.6)&amp;#23x3F)).//.10xxxxxx#0A....wrc=
h(#23x80+(.cod<BR>e.....&amp;#23x3F)).//.10xxxxxx#0A....RETURN#0A..}#0A#0=
A<BR>..//.Bad.Unicode.character#0A..writef("#23%x4#23",.<BR>code)#0A}#0A#=
0AAND.readwords(vector,.count).#3D.VAL<BR>OF#0A{.LET.i,.lim.#3D.0,.count*=
bytesperword#0A//saw<BR>ritef("BLIB.co#3D%n:.readwords.count#3D%n.scb#3D%=
n.<BR>block#3D%n.pos#3D%n*n",#0A//..........currco,.count<BR>,.cis,.cis!s=
cb_block,.cis!scb_pos)#0A#0A..IF.count&lt;<BR>#3D0.RESULTIS.0#0A#0A..{.LE=
T.pos.#3D.cis!scb_pos.//<BR>.Position.of.next.byte#0A....AND.end.#3D.cis!=
scb_en<BR>d.//.Position.past.last.byte#0A....AND.buf.#3D.cis!<BR>scb_buf.=
//.Byte.buffer.--.replenish.might.change.bu<BR>f#0A#0A....WHILE.pos.&lt;.=
end.DO....//.Copy.bytes.--.m<BR>ore.needed#0A....{.//.At.least.one.byte.a=
vailable.a<BR>nd.needed#0A......vector%i.:#3D.buf%pos.......//.Co<BR>py.i=
t#0A......i,.pos.:#3D.i+1,.pos+1#0A......IF.i&lt;l<BR>im.LOOP............=
//.More.byte(s).needed#0A....../<BR>/.Successful.completion#0A......cis!s=
cb_pos.:#3D.po<BR>s#0A......RESULTIS.count#0A....}#0A#0A....cis!scb_p<BR>=
os.:#3D.pos#0A#0A....//.No.byte.available,.so.attem<BR>pt.to.replenish.th=
e.buffer#0A....UNLESS.replenish(c<BR>is).RESULTIS.i/bytesperword#0A....//=
.Successful.rep<BR>lenishment.so.copy.some.more.bytes#0A....//.There.w<BR=
>ill.be.at.least.one.byte.in.the.buffer#0A..}.REPEAT<BR>#0A}#0A#0AAND.wri=
tewords(vector,.count).#3D.VALOF#0A<BR>{.LET.i,.len.#3D.0,.count*bytesper=
word.//.Length.in<BR>.bytes#0A#0A//sawritef("BLIB.co#3D%n:.writewords.co<=
BR>unt#3D%n.scb#3D%n.block#3D%n.pos#3D%n*n",#0A//.....<BR>.....currco,.co=
unt,.cos,.cos!scb_block,.cos!scb_pos<BR>)#0A#0A..IF.len&lt;#3D0.RESULTIS.=
FALSE#0A#0A..{.LET.po<BR>s....#3D.cos!scb_pos#0A....AND.bufend.#3D.cos!sc=
b_b<BR>ufend#0A....AND.buf....#3D.cos!scb_buf#0A#0A....//.<BR>If.the.buff=
er.is.full.try.to.deplete.it#2E#0A....WH<BR>ILE.pos.&lt;.bufend.DO#0A....=
{.//.There.is.a.byte.avai<BR>lable.and.room.in.the.buffer#0A......buf%pos=
.:#3D.v<BR>ector%i....//.so.copy.it#0A......i,.pos.:#3D.i+1,.p<BR>os+1#0A=
......IF.i&lt;len.LOOP..........//.Loop.if.anot<BR>her.byte.available#0A#=
0A......cos!scb_pos.:#3D.pos.<BR>....//.Update.SCB.and.return.successfull=
y#0A....../<BR>/.Advance.end.of.valid.data,.if.necessary#0A......I<BR>F.c=
os!scb_end.&lt;.pos.DO.cos!scb_end.:#3D.pos#0A.....<BR>.cos!scb_write.:#3=
D.TRUE.//.At.least.one.byte.has.b<BR>een.written#0A#0A......RESULTIS.TRUE=
#0A....}#0A#0A.<BR>...//.The.buffer.is.full.so.update.the.SCB.and.depl<BR=
>ete#0A....cos!scb_pos.:#3D.pos#0A....//.Advance.end<BR>.of.valid.data,.i=
f.necessary#0A....IF.cos!scb_end.&lt;<BR>.pos.DO.cos!scb_end.:#3D.pos#0A.=
...IF.i&gt;0.DO.cos!sc<BR>b_write.:#3D.TRUE.//.TRUE.if.at.least.one.byte.=
has.<BR>been.written#0A#0A....UNLESS.deplete(cos).RESULTIS.<BR>FALSE#0A..=
}.REPEAT#0A}#0A#0A//.get_record.returns.T<BR>RUE.if.successful#0A//.it.re=
turns.FALSE.if.eof.is.e<BR>ncountered.before.the.whole.record#0A//.has.be=
en.re<BR>ad#2E#0A//.MR.29/7/02:.First.record.of.a.file.has.r<BR>ecord.num=
ber.0#0AAND.get_record.(vector,.recno,.scb<BR>).#3D.VALOF#0A{.LET.i...#3D=
.0..............//.Posit<BR>ion.of.next.byte.to.put.in.vector#2E#0A..LET.=
len.#3D<BR>.scb!scb_reclen.//.Length.of.the.record.in.bytes#2E<BR>#0A#0A.=
.IF.len&lt;#3D0.RESULTIS.FALSE.//.Fail,.no.reco<BR>rd.length.specified#2E=
#0A#0A//sawritef("BLIB.co#3D%<BR>n:.get_record.recno#3D%n.reclen#3D%n.blk=
#3D%n.pos#3D<BR>%n.end#3D%n*n",#0A//...currco,.recno,.scb!scb_recle<BR>n,=
.scb!scb_block,.scb!scb_pos,.scb!scb_end)#0A..rec<BR>ordpoint(scb,.recno)=
#0A#0A//sawritef("BLIB:.get_rec<BR>ord.recno#3D%n.reclen#3D%n.pos#3D%n.en=
d#3D%n*n",#0A<BR>//...........recno,.scb!scb_reclen,.scb!scb_pos,.sc<BR>b=
!scb_end)#0A#0A#0A..{.//.Start.of.reading.loop#0A.<BR>...LET.pos.#3D.scb!=
scb_pos.//.Position.of.next.byte<BR>#0A....AND.end.#3D.scb!scb_end.//.Pos=
ition.past.las<BR>t.byte#0A....AND.buf.#3D.scb!scb_buf.//.Byte.buffer<BR>=
.--.replenish.might.change.buf#0A#0A....WHILE.pos.&lt;<BR>.end.DO....//.C=
opy.bytes.--.more.needed#0A....{.//.<BR>At.least.one.byte.needed#0A......=
vector%i.:#3D.buf%<BR>pos#0A//sawritef("BLIB.co#3D%n:.get_record.byte#3D%=
<BR>x2*n",.currco,.vector%i)#0A......i,.pos.:#3D.i+1,.p<BR>os+1#0A......I=
F.i&lt;len.LOOP.......//.More.byte(s).ne<BR>eded#0A......//.Successful.co=
mpletion#0A......scb!s<BR>cb_pos.:#3D.pos#0A//sawritef("BLIB.co#3D%n:.get=
_rec<BR>ord.recno#3D%n.len#3D%n.successful*n",#0A//........<BR>..currco,.=
recno,.len)#0A......RESULTIS.TRUE#0A....}<BR>#0A#0A....scb!scb_pos.:#3D.p=
os#0A#0A....//.No.byte.<BR>available,.so.attempt.to.replenish.the.buffer#=
0A...<BR>.UNLESS.replenish(scb).DO#0A....{#0A//sawritef("BLI<BR>B.co#3D%n=
:.get_record.recno#3D%n.len#3D%n.hit.eof.a<BR>t.%n*n",#0A//..........curr=
co,.recno,.len,.i)#0A...<BR>...RESULTIS.FALSE..//.Failure.due.to.eof,.tim=
eout,.<BR>error.etc#0A....}#0A....//.Successful.replenishment<BR>.so.copy=
.some.more.bytes#0A....//.There.will.still.<BR>be.at.least.one.byte.in.th=
e.buffer#0A..}.REPEAT#0A}<BR>#0A#0A//.MR.29/7/02:.The.first.record.of.a.f=
ile.has<BR>.number.0.(not.1)#0A//.Returns.TRUE.if.successful#0A<BR>//.Ret=
urns.FALSE,.otherwise#2E#0AAND.put_record(vec<BR>tor,.recno,.scb).#3D.VAL=
OF#0A{.LET.i,.len.#3D.0,.sc<BR>b!scb_reclen#0A#0A..UNLESS.scb!scb_id#3Did=
_inoutscb<BR>.DO#0A..{.sawritef("BLIB.co#3D%n:.put_record.id.not<BR>.inou=
t*n",.currco)#0A....abort(999)#0A....RESULTIS.<BR>FALSE#0A..}#0A#0A..IF.l=
en&lt;#3D0.RESULTIS.FALSE.//.Er<BR>ror.--.no.record.length#0A#0A//sawrite=
f("BLIB:.put_<BR>record.recno#3D%n.reclen#3D%n.blk#3D%n.pos#3D%n.end<BR>#=
3D%n*n",#0A//...........recno,.scb!scb_reclen,.scb<BR>!scb_block,.scb!scb=
_pos,.scb!scb_end)#0A..UNLESS.re<BR>cordpoint(scb,.recno).RESULTIS.FALSE#=
0A//sawritef("<BR>BLIB:.put_record.recno#3D%n.reclen#3D%n.blk#3D%n.po<BR>=
s#3D%n.end#3D%n*n",#0A//...........recno,.scb!scb_r<BR>eclen,.scb!scb_blo=
ck,.scb!scb_pos,.scb!scb_end)#0A/<BR>/abort(2222)#0A..{.LET.pos....#3D.sc=
b!scb_pos#0A...<BR>.AND.bufend.#3D.scb!scb_bufend#0A....AND.buf....#3D<BR=
>.scb!scb_buf#0A#0A....//.If.the.buffer.is.full.try.<BR>to.deplete.it#2E#=
0A....WHILE.pos.&lt;.bufend.DO#0A....<BR>{.//.There.is.a.byte.available.a=
nd.room.in.the.buff<BR>er#0A......buf%pos.:#3D.vector%i....//.so.copy.it#=
0A<BR>......i,.pos.:#3D.i+1,.pos+1#0A......scb!scb_write.<BR>:#3D.TRUE../=
/.At.least.one.byte.has.been.written#0A<BR>......IF.i&lt;len.LOOP........=
..//.Loop.if.another.byt<BR>e.available#0A#0A......scb!scb_pos.:#3D.pos..=
...//.<BR>Update.SCB.and.return.successfully#0A......//.Advan<BR>ce.end.o=
f.valid.data,.if.necessary#0A......IF.scb!s<BR>cb_end.&lt;.pos.DO.scb!scb=
_end.:#3D.pos#0A//......scb!<BR>scb_write.:#3D.TRUE.//.At.least.one.byte.=
has.been.w<BR>ritten#0A#0A......RESULTIS.TRUE.........//.Successf<BR>ul.c=
ompletion#0A....}#0A#0A....//.The.buffer.is.ful<BR>l.so.update.the.SCB.an=
d.deplete#0A....scb!scb_pos.:<BR>#3D.pos#0A....//.Advance.end.of.valid.da=
ta,.if.nece<BR>ssary#0A....IF.scb!scb_end.&lt;.pos.DO.scb!scb_end.:#3D<BR=
>.pos#0A//..IF.i&gt;0.DO.scb!scb_write.:#3D.TRUE.//.if.<BR>at.least.one.b=
yte.has.been.written#0A#0A....UNLESS.<BR>deplete(scb).RESULTIS.FALSE#0A..=
}.REPEAT#0A}#0A#0A/<BR>/.replenish(scb).returns:#0A//...TRUE.............=
.<BR>..Successful.replenishment,.at.least.one.ch.read#0A<BR>//...FALSE.re=
sult2.#3D.-1..End.of.file,.no.chars.re<BR>ad.....//.MR.15/4/03#0A//...FAL=
SE.result2.#3D.-2..T<BR>imeout,.no.chars.read.--.none.yet.available#0A//.=
..<BR>FALSE.result2.#3D.-3..Polling,.no.chars.read.--.non<BR>e.available#=
0A//...FALSE.result2.......Error.code#0A<BR>#0AAND.replenish(scb).#3D.VAL=
OF#0A{.LET.rdfn.#3D.sc<BR>b!scb_rdfn#0A..result2.:#3D.-1#0A..//.The.condi=
tion<BR>.scb!scb_end&lt;0.indicates.that.the.stream.is.exhaust<BR>ed#0A..=
UNLESS.scb!scb_end&gt;#3D0.&amp;.rdfn.&amp;.rdfn(scb).R<BR>ESULTIS.FALSE#=
0A..RESULTIS.TRUE#0A}#0A#0A//.deplete<BR>(scb).returns:#0A//...TRUE..Succ=
essful.depletion,.o<BR>r#0A//...FALSE.otherwise#2E#0A//.It.aborts:.187.if=
.<BR>scb.is.not.a.suitable.stream#2E#0A#0AAND.deplete(sc<BR>b).#3D.VALOF#=
0A{.LET.wrfn.#3D.scb!scb_wrfn.#0A..IF.<BR>scb!scb_end&lt;0.RESULTIS.FALSE=
.///.?????.result2#0A..<BR>UNLESS.wrfn.DO.abort(187)#0A//sawritef("BLIB:.=
deple<BR>te.calling.wrfn(%n)*n",.scb)#0A..RESULTIS.wrfn(scb)<BR>#0A}#0A#0=
AAND.findinput....(string).......#3D..find<BR>stream(string,.id_inscb,...=
.0)#0A#0AAND.pathfindinp<BR>ut(string,.path).#3D..findstream(string,.id_i=
nscb,.<BR>path)#0A#0AAND.findoutput...(string).......#3D..fin<BR>dstream(=
string,.id_outscb,...0)#0A#0AAND.findinoutp<BR>ut.(string).......#3D..fin=
dstream(string,.id_inouts<BR>cb,.0)#0A#0AAND.findupdate...(string).......=
#3D..fi<BR>ndstream(string,.id_inoutscb,.0)#0A#0AAND.selectinp<BR>ut(scb)=
.BE.//.scb#3D0.is.occasionally.used#0A{.UNLE<BR>SS.scb#3D0.|.scb!scb_id#3=
Did_inscb.|.scb!scb_id#3Di<BR>d_inoutscb.DO.abort(186)#0A..cis.:#3D.scb#0=
A}#0A#0A<BR>AND.selectoutput(scb).BE.//.scb#3D0.is.occasionally<BR>.used#=
0A{.UNLESS.scb#3D0.|.scb!scb_id#3Did_outscb.|<BR>.scb!scb_id#3Did_inoutsc=
b.DO.abort(187)#0A..cos.:#3D<BR>.scb#0A}#0A#0AAND.endread().BE.endstream(=
cis)#0A#0A<BR>AND.endwrite().BE.endstream(cos)#0A#0AAND.endstream<BR>(scb=
).BE.TEST.scb&gt;0#0ATHEN.{.LET.endfn.#3D.scb!scb_<BR>endfn#0A.......LET.=
res2.#3D.result2#0A.......IF.end<BR>fn.DO.endfn(scb)#0A.......freevec(scb=
)#0A.......IF.<BR>cis.#3D.scb.DO.cis.:#3D.0#0A.......IF.cos.#3D.scb.D<BR>=
O.cos.:#3D.0#0A#0A.......result2.:#3D.res2#0A.....}<BR>#0AELSE.IF.scb&lt;=
0.DO.//.Safety.check#0A.....{.sawrit<BR>ef("*nBLIB:.endstream.given.negat=
ive.scb#3D%n*n",.s<BR>cb)#0A.......abort(999)#0A.....}#0A#0AAND.input().#=
3D<BR>.cis#0A#0AAND.output().#3D.cos#0A#0AAND.readn().#3D<BR>.VALOF#0A{.L=
ET.sum,.ch,.neg.#3D.0,.0,.FALSE#0A#0A..<BR>{.ch.:#3D.rdch()#0A....IF.'0'&=
lt;#3Dch&lt;#3D'9'.BREAK#0A<BR>....SWITCHON.ch.INTO#0A....{.DEFAULT:...un=
rdch()#0A<BR>.................result2.:#3D.-1#0A................<BR>.RESU=
LTIS.0#0A......CASE.'*s':#0A......CASE.'*t':#0A<BR>......CASE.'*n':.LOOP#=
0A#0A......CASE.'-':..neg.:#3D<BR>.TRUE#0A......CASE.'+':..ch.:#3D.rdch()=
#0A.........<BR>........BREAK#0A....}#0A..}.REPEAT#0A#0A..WHILE.'0'<BR>&l=
t;#3Dch&lt;#3D'9'.DO#0A..{.sum.:#3D.10.*.sum.+.ch.-.'0'<BR>#0A....ch.:#3D=
.rdch()#0A..}#0A..IF.neg.DO.sum.:#3D.<BR>-sum#0A..unrdch()#0A..result2.:#=
3D.0#0A..RESULTIS.s<BR>um#0A}#0A#0AAND.newline().BE.wrch('*n')#0A#0AAND.n=
e<BR>wpage().BE.wrch('*p')#0A#0AAND.writed(n,.d).BE.writ<BR>edz(n,.d,.FAL=
SE)#0A#0AAND.writez(n,.d).BE.writedz(n<BR>,.d,.TRUE)#0A#0AAND.writedz(n,.=
d,.zeroes).BE#0A{.LE<BR>T.t.#3D.VEC.10#0A..LET.i.#3D.0#0A..LET.k.#3D.-n#0=
A#0A<BR>..IF.n&lt;0.DO.{.d.:#3D.d.-.1;.k.:#3D.n.}#0A#0A..{.t!i<BR>.:#3D.-=
(k.REM.10)#0A....k...:#3D.k/10#0A....i...:#3D<BR>.i.+.1#0A..}.REPEATWHILE=
.k#0A#0A..IF.n&lt;0.&amp;.zeroes.D<BR>O.wrch('-')#0A..FOR.j.#3D.i+1.TO.d.=
DO.wrch(zeroes.-<BR>&gt;.'0',.'*s')#0A..IF.(n&lt;0).&amp;.~zeroes.DO.wrch=
('-')#0A<BR>..FOR.j.#3D.i-1.TO.0.BY.-1.DO.wrch(t!j+'0')#0A}#0A#0A<BR>AND.=
writen(n).BE.writed(n,.0)#0A#0AAND.writehex(n,.<BR>d).BE.#0A{.IF.d&gt;1.D=
O.writehex(n&gt;&gt;4,.d-1)#0A..wrch((<BR>n&amp;15)!TABLE.'0','1','2','3'=
,'4','5','6','7',#0A....<BR>................'8','9','A','B','C','D','E','=
F')#0A<BR>}#0A#0AAND.writeoct(n,.d).BE#0A{.IF.d.&gt;.1.DO.writeo<BR>ct(n&=
gt;&gt;3,.d-1)#0A..wrch((n&amp;7)+'0')#0A}#0A#0AAND.writ<BR>ebin(n,.d).BE=
#0A{.IF.d.&gt;.1.DO.writebin(n&gt;&gt;1,.d-1)#0A<BR>..wrch((n&amp;1)+'0')=
#0A}#0A#0AAND.writes(s).BE#0A{.//.<BR>UNLESS.0.&lt;.s.&lt;.rootnode!rtn_m=
emsize.DO.s.:#3D."#23#23<BR>Bad.string#23#23"#0A..FOR.i.#3D.1.TO.s%0.DO.w=
rch(s%<BR>i)#0A}#0A#0AAND.writet(s,.d).BE#0A{.writes(s)#0A..F<BR>OR.i.#3D=
.1.TO.d-s%0.DO.wrch('*s')#0A}#0A#0AAND.writ<BR>eu(n,.d).BE#0A{.LET.m.#3D.=
(n&gt;&gt;1)/5#0A..IF.m.DO.{.wr<BR>ited(m,.d-1);.d.:#3D.1.}#0A..writed(n-=
m*10,.d)#0A}#0A<BR>#0A#0A#0A/*#0A........The.following.routines.provid<BR=
>e.and.extended.version.of.writef#2E#0AThey.support.<BR>the.following.ext=
ra.substitution.items:#0A#0A......<BR>..1#2E.%F...-.Takes.next.argument.a=
s.a.writef.forma<BR>t.string.and#0A................calls.writef.recursi<B=
R>vely.using.the.remaining.arguments#2E#0A...........<BR>.....The.argumen=
t.pointer.is.positioned.to.the.next<BR>.available#0A................argum=
ent.on.return#2E#0A<BR>#0A........2#2E.%M...-.The.next.argument.is.taken.=
a<BR>s.a.message.number.and.processed#0A................<BR>as.for.%F.abo=
ve#2E.The.message.format.string.is.loo<BR>ked.up.by#0A................get=
_text(messno,.str,.u<BR>pb).where.str.is.a.vector.local.to#0A............=
..<BR>..writef.to.hold.the.message.string#2E.This.is.prov<BR>ided.to.easy=
#0A................the.generation.of.me<BR>ssages.in.different.languages#=
2E#0A#0A........3#2E.<BR>%+...-.The.argument.pointer.is.incremented.by.1#=
2E#0A<BR>#0A........4#2E.%-...-.The.argument.pointer.is.decr<BR>emented.b=
y.1#2E#0A#0A........5#2E.%P...-.Plural.for<BR>mation#2E.The.singular.form=
.is.use.if.and.only.if#0A<BR>................the.next.argument.is.one#2E.=
So.that<BR>.the.argument.can.be.used#0A................twice.i<BR>t.is.no=
rmal.to.preceed.or.follow.the.%P.item.with.%<BR>-#2E#0A................Th=
ere.are.two.forms.as.follo<BR>ws:#0A#0A................a#2E.%Pc..-.The.ch=
aracter.<BR>c.is.output.if.the.the.next.argument#0A............<BR>......=
......not.one#2E#0A#0A................b#2E.%P<BR>\singular\plural\..-.The=
.appropriate.text.is.printe<BR>d,#0A........................skipping.the.=
other#2E.<BR>The.'\'.chars.are.not.printed#2E#0A#0AExample:.FOR.<BR>count=
.#3D.0.TO.2.DO#0A............writef("There.%p\<BR>.is\are\.%-%n.thing%-%p=
s#2E*n",.count)#0Aoutputs:#0A<BR>.........There.are.0.things#2E#0A.......=
..There.is.<BR>.1.thing#2E#0A.........There.are.2.things#2E#0A#0A.<BR>...=
....6#2E.%nOp..eg.%12I.as.an.alternative.to.%IB#0A<BR>.................wh=
ere.n.is.a.decimal.number.and.Op<BR>.is.a.format.letter#0A...............=
..expecting.a.<BR>field.width#2E.If.n.is.given.it.specifies.the#0A...<BR>=
..............field.width.otherwise.it.is.specified<BR>,.as.before,.by.th=
e#0A.................single.chara<BR>cter.(0-9,.A-Z).following.Op#2E#0A#0=
A........7#2E.%<BR>n#2Emd..eg.%8#2E2d#0A..................print.a.fixe<BR=
>d.point.scaled.decimal.number.in.a.field#0A........<BR>..........width.o=
f.n.with.m.digits.after.the.decima<BR>l.point#2E.For#0A..................=
example.writef("<BR>%8#2E2d",.1234567).would.output:.12345#2E67#0A.....<B=
R>.............and.....writef("%8#2E0d",.1234567).wou<BR>ld.output:..1234=
567#0A#0A........8#2E.%#23.....Writ<BR>e.the.next.argument.using.codewrch=
,.ie.convert.the#0A<BR>..................next.argument.to.UTF-8.format#2E=
#0A<BR>*/#0A#0A//.The.following.version.of.writef.is.new.-<BR>-.MR.21/1/0=
4#0A#0A//.get_textblib.and.get_text.have<BR>.the.same.global.variable.num=
ber#0AAND.get_textblib<BR>(n,.str,.upb).#3D.VALOF..//.Default.definition.=
of.g<BR>et_text#0A.......................................//<BR>.This.is.n=
ormally.overridden.#0A...................<BR>....................//.by.ge=
t_text,.defined.elsewhe<BR>re#2E#0A{.LET.s.#3D."&lt;mess:%-%n&gt;"#0A..IF=
.upb&gt;s%0.DO<BR>.upb.:#3D.s%0#0A..str%0.:#3D.upb#0A..FOR.i.#3D.1.TO<BR>=
.upb.DO.str%i.:#3D.s%i#0A..RESULTIS.str#0A}#0A#0AAN<BR>D.writef(format,a,=
b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r<BR>,s,t,u,v,w,x,y,z).BE#0A{.LET.nextarg=
.#3D.@a#0A..wri<BR>te_format(format,.@nextarg)#0A}#0A#0AAND.sawritef(f<BR=
>ormat,a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w<BR>,x,y,z).BE#0A{.LE=
T.nextarg.#3D.@a#0A..LET.wch,.rch.<BR>#3D.wrch,.rdch#0A..wrch,.rdch.:#3D.=
sawrch,.sardch#0A<BR>..write_format(format,.@nextarg)#0A..wrch,.rdch.:#3D=
<BR>.wch,.rch#0A}#0A#0AAND.write_format(format,.lvnexta<BR>rg).BE#0A{.//.=
writef.and.sawritef.must.preserve.res<BR>ult2#0A..LET.res2.#3D.result2#0A=
#0A..//UNLESS.0.&lt;.f<BR>ormat.&lt;.rootnode!rtn_memsize.DO.format.:#3D.=
"#23#23<BR>Bad.format#23#23"#0A#0A..FOR.p.#3D.1.TO.format%0.DO<BR>#0A..{.=
LET.k,.type,.f,.n,.m,.arg.#3D.format%p,.?,.?<BR>,.?,.?,.?#0A....LET.width=
given.#3D.FALSE#0A....UNLE<BR>SS.k#3D'%'.DO.{.wrch(k);.LOOP.}#0A#0A....//=
.Deal.wi<BR>th.a.substitution.item#0A....p.:#3D.p.+.1#0A....typ<BR>e,.arg=
,.n,.m.:#3D.format%p,.!!lvnextarg,.0,.0#0A#0A<BR>sw:.SWITCHON.capitalch(t=
ype).INTO#0A....{.DEFAULT:.<BR>...wrch(type)#0A..................LOOP#0A#=
0A......C<BR>ASE.'0':CASE.'1':CASE.'2':CASE.'3':CASE.'4':#0A....<BR>..CAS=
E.'5':CASE.'6':CASE.'7':CASE.'8':CASE.'9':#0A.<BR>.................{.n.:#=
3D.10*n.+.type.-.'0'#0A.....<BR>...............p.:#3D.p+1#0A.............=
.......typ<BR>e.:#3D.format%p#0A....................widthgiven.:#3D<BR>.T=
RUE#0A..................}.REPEATWHILE.'0'&lt;#3Dtype<BR>&lt;#3D'9'#0A....=
..............IF.type#3D'#2E'.DO#0A..<BR>................{.p.:#3D.p+1#0A.=
...................<BR>type.:#3D.format%p#0A....................WHILE.'0'=
&lt;<BR>#3Dtype&lt;#3D'9'.DO#0A....................{.m.:#3D.10<BR>*m.+.ty=
pe.-.'0'#0A......................p.:#3D.p+1#0A<BR>......................t=
ype.:#3D.format%p#0A........<BR>............}#0A..................}#0A...=
..........<BR>.....GOTO.sw#0A#0A......CASE.'D':...IF.m.DO#0A.....<BR>....=
.........{.//.Write.a.number.of.the.form.nnn#2E<BR>nn#0A.................=
...LET.scale.#3D.1#0A........<BR>............FOR.i.#3D.1.TO.m.DO.scale.:#=
3D.scale.*.<BR>10#0A....................writed(arg/scale,.n-1-m)#0A<BR>..=
..................wrch('#2E')#0A.................<BR>...writez(.ABS.arg.R=
EM.scale,.m)#0A................<BR>....!lvnextarg.:#3D.!lvnextarg.+.1#0A.=
.............<BR>......LOOP#0A..................}#0A................<BR>.=
.f.:#3D.writed;....GOTO.getarg#0A#0A#0A......CASE.<BR>'S':...f.:#3D.write=
s;....GOTO.noargs#0A......CASE.'<BR>T':...f.:#3D.writet;....GOTO.getarg#0=
A......CASE.'C<BR>':...f.:#3D.wrch;......GOTO.noargs#0A......CASE.'#23<BR=
>':...f.:#3D.codewrch;...GOTO.noargs#0A......CASE.'O<BR>':...f.:#3D.write=
oct;..GOTO.getarg#0A......CASE.'X'<BR>:...f.:#3D.writehex;..GOTO.getarg#0=
A......CASE.'I':<BR>...f.:#3D.writed;....GOTO.getarg#0A......CASE.'N':.<B=
R>..f.:#3D.writen;....GOTO.noargs#0A......CASE.'U':..<BR>.f.:#3D.writeu;.=
...GOTO.getarg#0A......CASE.'Z':...<BR>f.:#3D.writez;....GOTO.getarg#0A..=
....CASE.'B':...f<BR>.:#3D.writebin;..GOTO.getarg#0A#0A....getarg:......<=
BR>.UNLESS.widthgiven.DO#0A..................{.p.:#3D.<BR>p.+.1#0A.......=
.............n.:#3D.capitalch(format<BR>%p)#0A....................n.:#3D.=
'0'.&lt;#3D.n.&lt;#3D.'9<BR>'.-&gt;.n.-.'0',.10.+.n.-.'A'#0A.............=
.....}#0A<BR>#0A....noargs:.......f(arg,.n)#0A..................<BR>!lvne=
xtarg.:#3D.!lvnextarg.+.1#0A..................<BR>LOOP#0A#0A......CASE.'$=
':#0A......CASE.'+':...!lvne<BR>xtarg.:#3D.!lvnextarg.+.1#0A.............=
.....LOOP#0A<BR>#0A......CASE.'-':...!lvnextarg.:#3D.!lvnextarg.-.1<BR>#0=
A..................LOOP#0A#0A......CASE.'M':.{.LE<BR>T.buf.#3D.VEC.256/by=
tesperword#0A..................<BR>!lvnextarg.:#3D.!lvnextarg.+.1#0A.....=
.............<BR>UNLESS.get_text(arg,.buf,.256/bytesperword).DO#0A..<BR>.=
.................buf.:#3D."&lt;&lt;mess:%-%n&gt;&gt;"..//.No.m<BR>essage.=
text#0A..................write_format(buf,.l<BR>vnextarg)#0A.............=
.....LOOP#0A..............<BR>..}#0A#0A......CASE.'F':...!lvnextarg.:#3D.=
!lvnexta<BR>rg.+.1#0A..................write_format(arg,.lvnext<BR>arg)#0=
A..................LOOP#0A#0A......CASE.'P':.<BR>{.LET.plural.#3D.arg.~#3=
D.1#0A..................!lv<BR>nextarg.:#3D.!lvnextarg.+.1#0A............=
......p.:<BR>#3D.p+1#0A..................type.:#3D.format%p#0A..<BR>.....=
...........IF.type.#3D.'\'.DO#0A..............<BR>....{.//.Deal.with.%P\s=
ingular\plural\.item#0A.....<BR>...............LET.skipping.#3D.plural#0A=
..........<BR>..........p.:#3D.p.+.1#0A....................UNTIL.<BR>p.&g=
t;.format%0.DO#0A....................{.LET.ch.#3D.<BR>format%p#0A........=
..............TEST.ch.#3D.'\'.TH<BR>EN.{.skipping.:#3D.~skipping#0A......=
..............<BR>.......................IF.skipping.#3D.plural.BREAK<BR>=
#0A.........................................}#0A...<BR>..................=
...............ELSE.UNLESS.skippi<BR>ng.DO.wrch(ch)#0A...................=
...p.:#3D.p.+.1<BR>#0A....................}#0A....................LOOP<BR=
>#0A..................}#0A#0A..................//.De<BR>al.with.simple.%P=
c.items#0A..................IF.plu<BR>ral.DO.wrch(type)#0A...............=
...LOOP#0A......<BR>..........}#0A....}.//.End.of.SWITCHON.#2E#2E#2E#0A<B=
R>..}.//.End.of.FOR.p.#3D.#2E#2E#2E#0A#0A..result2.:#3D<BR>.res2#0A}#0A#0=
ALET.randno(upb).#3D.VALOF..//.return<BR>.a.random.number.in.the.range.1.=
to.upb#0A{.randseed<BR>.:#3D.randseed*2147001325.+.715136305#0A..RESULTIS=
.<BR>(ABS(randseed/3)).REM.upb.+.1#0A}#0A#0AAND.setseed(<BR>newseed).#3D.=
VALOF.//.Added.by.MR.20/01/2000#0A{.LE<BR>T.oldseed.#3D.randseed#0A..rand=
seed.:#3D.newseed#0A<BR>..RESULTIS.oldseed#0A}#0A#0A//.muldiv.is.now.impl=
em<BR>ented.in.SYSLIB.using.the.MDIV.instruction#0A//.NO.<BR>--.MDIV.some=
times.causes.a.floating.point.exception<BR>#0AAND.muldiv(a,.b,.c).#3D.sys=
(Sys_muldiv,.a,.b,.c)<BR>#0A#0AAND.unpackstring(s,.v).BE.FOR.i.#3D.s%0.TO=
.0.<BR>BY.-1.DO.v!i.:#3D.s%i#0A#0AAND.packstring(v,.s).#3D<BR>.VALOF#0A{.=
LET.n.#3D.v!0.&amp;.255#0A..LET.size.#3D.n/b<BR>ytesperword#0A..FOR.i.#3D=
.0.TO.n.DO.s%i.:#3D.v!i#0A<BR>..FOR.i.#3D.n+1.TO.(size+1)*bytesperword-1.=
DO.s%i.:<BR>#3D.0#0A..RESULTIS.size#0A}#0A#0AAND.capitalch(ch).<BR>#3D.'a=
'.&lt;#3D.ch.&lt;#3D.'z'.-&gt;.ch.+.'A'.-.'a',.ch#0A#0A<BR>AND.compch(ch1=
,.ch2).#3D.capitalch(ch1).-.capitalch<BR>(ch2)#0A#0AAND.compstring(s1,.s2=
).#3D.VALOF#0A{.LET<BR>.lens1,.lens2.#3D.s1%0,.s2%0#0A..LET.smaller.#3D.l=
e<BR>ns1.&lt;.lens2.-&gt;.s1,.s2#0A..FOR.i.#3D.1.TO.smaller%0.<BR>DO#0A..=
{.LET.res.#3D.compch(s1%i,.s2%i)#0A....IF.re<BR>s.RESULTIS.res#0A..}#0A..=
IF.lens1.#3D.lens2.RESULTI<BR>S.0#0A..RESULTIS.smaller.#3D.s1.-&gt;.-1,.1=
#0A}#0A#0AA<BR>ND.str2numb(s).#3D.VALOF.//.Deprecated#0A{.LET.a.#3D<BR>.0=
#0A..FOR.i.#3D.1.TO.s%0.DO.{.LET.dig.#3D.s%i.-.'0<BR>'#0A................=
........IF.0&lt;#3Ddig&lt;#3D9.DO.a.:<BR>#3D.10*a.+.dig#0A...............=
.......}#0A..RESULT<BR>IS.s%1#3D'-'.-&gt;.-a,.a#0A}#0A#0AAND.getkey(keys,=
.i,.<BR>keyword).#3D.VALOF#0A{.LET.len.#3D.keys%0#0A..LET.n<BR>.#3D.0#0A.=
.LET.p.#3D.1#0A#0A..UNTIL.p&gt;len.DO#0A..{.<BR>UNLESS.i.BREAK#0A....IF.k=
eys%p#3D','.DO.i.:#3D.i-1#0A<BR>....p.:#3D.p+1#0A..}#0A#0A..WHILE.p.&lt;#=
3D.len.DO#0A.<BR>.{.LET.ch.#3D.keys%p#0A....IF.ch#3D'/'.|.ch#3D'#3D'<BR>.=
|.ch#3D','.BREAK#0A....n.:#3D.n.+.1#0A....keyword%<BR>n.:#3D.keys%p#0A...=
.p.:#3D.p.+.1#0A..}#0A#0A..keywo<BR>rd%0.:#3D.n#0A..RESULTIS.keyword#0A}#=
0A#0A/*.rdargs<BR>.provides.the.programmer.with.the.facility.to.read#0A<B=
R>...arguments.from.the.currently.selected.input.and.<BR>store.them.in.a#=
0A...vector.as.shown.below:#0A#0A..<BR>........................|---------=
-|#0A............<BR>..............|address1..|#0A......................<=
BR>....|__________|#0A..........................|.TRUE<BR>.....|&lt;-.log=
ic.switch.value#0A.....................<BR>.....|__________|.#0A.........=
.................|add<BR>ress2..|#0A..........................|----------=
|#0A<BR>..........................|item1.....|#0A..........<BR>..........=
......|__________|#0A....................<BR>......|item2.....|#0A.......=
...................|___<BR>_______|#0A#0AThe.possible.key.qualifiers.are:=
#0A#0A<BR>../k...keyed....--.argument.requires.the.keyword#0A<BR>../p...p=
rompted.--.prompt.will.be.displayed..(This.<BR>option.may.be.scrapped)#0A=
../a...required.--.if.thi<BR>s.argument.is.not.entered.an.error.will.foll=
ow#0A..<BR>/n...numeric..--.argument.has.to.be.a.number#0A../s<BR>...swit=
ch...--.exact.switch.word.has.to.be.entered.<BR>for.TRUE#0A*/..#0A#0AAND.=
rdargs(keys,.argv,.size).#3D<BR>.VALOF#0A{.MANIFEST#0A..{.required....#3D=
.1........<BR>..........//..1.../A#0A....keyed.......#3D.1.&lt;&lt;.1..<B=
R>...........//..2.../K#0A....switch......#3D.1.&lt;&lt;.2.<BR>..........=
..//..4.../S#0A....prompt......#3D.1.&lt;&lt;.3<BR>.............//..8.../=
P#0A....number......#3D.1.&lt;&lt;.<BR>4.............//.16.../N#0A....con=
trol.....#3D.(num<BR>ber.&lt;&lt;.1).-.1..//.31...All.the.flags#0A..}#0A#=
0A..L<BR>ET.w........#3D.argv.//.w.is.a.moving.positional.po<BR>inter.of.=
the.argv.vector#0A..LET.numbargs.#3D.?#0A.<BR>.LET.status...#3D.TRUE...//=
.Set.to.FALSE.when.an.er<BR>ror.is.encountered#0A..LET.keyword..#3D.VEC.3=
0#0A#0A<BR>..!w.:#3D.0#0A#0A////////////////.A.BIT.MAP.REPRESE<BR>NTING.T=
HE.KEY.QUALIFIERS.IS.///////////////#0A/////<BR>//////////..PUT.INTO.THE.=
TOP.LOCATIONS.OF.THE.VECTO<BR>R.....///////////////.#0A#0A..//.A.typical.=
key.stri<BR>ng.is:."FROM#3DDATA/A,TO/K,VAL/K/N,T#3DTRACE/S"#0A.<BR>.FOR.p=
.#3D.1.TO.keys%0.DO#0A..{.LET.kch.#3D.keys%p#0A<BR>#0A....IF.kch.#3D.'/'.=
DO#0A....{.LET.c.#3D.capitalc<BR>h(keys%(p+1))#0A......IF.c.#3D.'A'.DO.!w=
.:#3D.!w.|.<BR>required#0A......IF.c.#3D.'K'.DO.!w.:#3D.!w.|.keyed<BR>#0A=
......IF.c.#3D.'S'.DO.!w.:#3D.!w.|.switch#0A....<BR>..IF.c.#3D.'P'.DO.!w.=
:#3D.!w.|.prompt#0A......IF.c.<BR>#3D.'N'.DO.!w.:#3D.!w.|.number#0A....}#=
0A#0A....IF.<BR>kch.#3D.','.DO#0A....{.w.:#3D.w.+.1#0A......!w.:#3D<BR>.0=
#0A....}#0A..}#0A#0A..w.:#3D.w.+.1#0A..numbargs.:<BR>#3D.w.-.argv..//.as.=
deduced.from.the.keys.string#0A<BR>#0A#0A////////////////////////////////=
/////////////<BR>///////////////////////////#0A/////////////////////<BR>/=
//.BEGINNING.OF.REPEAT.LOOP.//////////////////////<BR>#0A////////////////=
////////////////////////////////<BR>////////////////////////#0A#0A..{.LET=
.argno.#3D.-1#0A<BR>....LET.wsize.#3D.size.-.(w.-.argv).//.Number.of.wo<B=
R>rds.remaining.in.argv#0A....LET.itemtype.#3D.rditem<BR>(w,.wsize)#0A//s=
awritef("BLIB:.rdargs..itemtype#3D%<BR>n*n",.itemtype)#0A....clear_words(=
keyword,.31)#0A#0A<BR>....SWITCHON.itemtype.INTO#0A....{.DEFAULT:.//.Unkn=
<BR>own.item.type#0Aerr:#0A.............{.LET.ch.#3D.?#0A<BR>//sawritef("=
BLIB:.rdargs.error.--.skipping.to.end.o<BR>f.line*n")#0A...............un=
rdch()...//.MR.14/7/0<BR>3#0A...............ch.:#3D.rdch().REPEATUNTIL.ch=
#3D<BR>'*n'.|#0A........................................ch<BR>#3D';'..|#0=
A.......................................<BR>.ch#3Dendstreamch#0A#0A......=
.........result2.:#3D.<BR>120..//.Fault:.Argument.line.#0A...............=
....<BR>............//.invalid.or.too.long#0A..............<BR>.RESULTIS.=
0......//.Error.result#0A.............}#0A<BR>#0A......CASE.0:..//.endstr=
eamch#0A......CASE.3:../<BR>/.newline#0A......CASE.4:..//.semicolon#0A//.=
These.<BR>item.types.mark.the.end.of.the.argument.list#2E#0A#0A<BR>//.Now=
.check.for.prompted.arguments#2E#0A#0A.......<BR>........FOR.i.#3D.0.TO.n=
umbargs.-1.IF.0&lt;#3Dargv!i&lt;#3D<BR>control.DO#0A...............{.//.U=
nset.argument.fou<BR>nd#0A.................LET.a.#3D.argv!i#0A#0A.......<=
BR>..........IF.status.&amp;.((a.&amp;.prompt).~#3D.0).DO#0A..<BR>.......=
........{.//.if.ok.so.far.&amp;.prompted#0A.....<BR>..............IF.cis!=
scb_type.#3D.scbt_console.&amp;#0A<BR>......................cos!scb_type.=
#3D.scbt_console<BR>.DO#0A...................{.writes(getkey(keys,.i,.k<B=
R>eyword))#0A.....................UNLESS.(a.&amp;.switch)<BR>.#3D.0.DO.wr=
ites(".(yes/no)")#0A...................<BR>..writes(".&gt;.").//.write.pr=
ompt#0A.................<BR>....deplete(cos).//.MR.13/1/03#0A#0A.........=
......<BR>......itemtype.:#3D.rditem(w,.wsize)#0A............<BR>........=
.SWITCHON.itemtype.INTO#0A.................<BR>....{.CASE.1:.//.Unquoted.=
item#0A..................<BR>.....CASE.2:.//.Quoted.item#0A//writef("*nva=
lue#3D%<BR>s*n",.w)#0A...............................IF.(a.&amp;.s<BR>wit=
ch).~#3D.0.DO#0A...............................{<BR>.IF.compstring(w,."ye=
s").#3D.0.DO#0A...............<BR>..................{.argv!i.:#3D.TRUE#0A=
............<BR>.......................LOOP.//.Find.next.uset.argum<BR>en=
t#0A.................................}#0A........<BR>....................=
.....IF.compstring(w,."no").#3D<BR>.0.DO#0A..............................=
...{.argv!i.:<BR>#3D.FALSE#0A...................................LOOP<BR>.=
//.Find.next.uset.argument#0A.....................<BR>............}#0A...=
............................}#0A<BR>#0A...............................IF.=
(a.&amp;.number).~<BR>#3D.0.DO#0A...............................{.argv!i.=
<BR>:#3D.w...//.numeric#0A.............................<BR>....IF.string_=
to_number(w).DO#0A...................<BR>..............{.!w.:#3D.result2#=
0A.................<BR>..................w..:#3D.w.+.1#0A................=
.<BR>..................LOOP.//.Find.next.uset.argument#0A<BR>............=
.....................}#0A..............<BR>...................status.:#3D=
.FALSE#0A............<BR>.....................argv!i.:#3D.0#0A...........=
...<BR>...................LOOP.//.Find.next.uset.argument#0A<BR>.........=
......................}#0A#0A.............<BR>..................//.Non.sw=
itch.non.numeric.argumen<BR>t#0A//writef("*nargv!%n.#3D.%s..non.switch/nu=
m*n",.<BR>i,.w)#0A...............................argv!i.:#3D.<BR>w#0A....=
...........................w.:#3D.w.+.w%0/b<BR>ytesperword.+.1#0A........=
.......................ws<BR>ize.:#3D.size.-.(w.-.argv).....#0A..........=
.......<BR>..............LOOP.//.Find.next.unset.argument#0A#0A<BR>......=
.................CASE.0:#0A..................<BR>.....CASE.3:#0A.........=
..............CASE.4:#0Awri<BR>tef("BLIB:.rdargs:.case.0,.3.or.4.reached*=
n")#0A...<BR>............................ENDCASE#0A#0A..........<BR>.....=
........DEFAULT:#0A...........................<BR>....status.:#3D.FALSE#0=
A...........................<BR>....LOOP#0A.....................}#0A.....=
..........<BR>....}#0A.................}#0A......................<BR>....=
..#0A.................TEST.(a.&amp;.required).#3D.0<BR>..//.final.check.f=
or.required#0A.................TH<BR>EN.argv!i.:#3D.0.........//.argument=
.-.clear.memory<BR>#0A.................ELSE.status.:#3D.FALSE.....//.i<BR=
>f.no.input.made.and.not.#0A........................<BR>.................=
.//.required#0A...............}.//<BR>.End.of.for-loop#0A#0A.............=
..UNLESS.status.<BR>GOTO.err#0A...............result2.:#3D.0#0A........<B=
R>.......FOR.i.#3D.0.TO.numbargs-1.IF.argv!i.DO.resul<BR>t2.:#3D.result2.=
+.1#0A...............//.result2.#3D<BR>.number.of.args.given#0A//........=
.......writef("*n<BR>itemtype#3D%n.calling.rdch().#3D&gt;.'%c'*n",.itemty=
pe<BR>,.rdch())#0A//...............writef("*nreturning.rd<BR>ch().#3D&gt;=
.'%c'*n",.rdch())#0A...............RESULTI<BR>S.w#0A#0A.....CASE.1:...//.=
Ordinary.item#0A........<BR>.......//.notice.that.the.CASE.1.and.CASE.2.s=
ection<BR>s.will#0A...............//.both.be.executed.consecu<BR>tively.f=
or.any.input.other.#0A...............//.the<BR>n.items.in.quotes#0A#0A...=
............argno.:#3D.fi<BR>ndarg(keys,.w)#0A//writef("Ordinary.item.%s.=
.argno#3D<BR>%n*n",.w,.argno)#0A#0A...............TEST.argno.&gt;#3D<BR>.=
0#0A...............THEN.{.UNLESS.0.&lt;#3D.argv!argno<BR>.&lt;#3D.control=
.GOTO.err#0A#0A......................I<BR>F.(argv!argno.&amp;.switch).~#3=
D.0.DO#0A...............<BR>.......{.argv!argno.:#3D.-1#0A...............=
......<BR>...LOOP#0A......................}#0A#0A............<BR>........=
..{.LET.item.#3D.rditem(w,.wsize)#0A#0A....<BR>....................IF.ite=
m.#3D.5.DO.item.:#3D.rdit<BR>em(w,.wsize).//.Skip.'#3D'#0A#0A............=
.......<BR>.....IF.item.&lt;#3D.0.|.item#3D3.|.item#3D4.|.item#3D<BR>5.GO=
TO.err#0A......................}#0A............<BR>........}#0A#0A.......=
........ELSE.TEST.rdch().#3D.<BR>'*n'.&amp;.compstring("?",.w).#3D.0#0A..=
...............<BR>...THEN.{.writef("%s:.",.keys)#0A..................<BR=
>.........deplete(cos).//.MR.13/1/03#0A.............<BR>..............END=
CASE#0A.........................}#0A<BR>....................ELSE.unrdch()=
#0A#0A//.Deliberat<BR>e.missing.'ENDCASE'#0A#0A............CASE.2:.//.ite=
<BR>m.was.not.a.keyword.or.was.put.in.quotes#0A........<BR>........IF.arg=
no.&lt;.0.DO......//.find.first.non-keye<BR>d,.non-switch#0A.............=
.....FOR.i.#3D.0.TO.nu<BR>mbargs.-.1.DO#0A....................IF.0.&lt;#3=
D.argv!<BR>i.&lt;#3D.control.&amp;#0A.......................(argv!i.&amp;=
<BR>.switch).#3D.0..&amp;#0A.......................(argv!i.<BR>&amp;.keye=
d)..#3D.0..DO.#0A....................{.argno.<BR>:#3D.i#0A...............=
.......BREAK#0A............<BR>........}#0A#0A//.The.FOR-loop.below.the.C=
ASE.2.end<BR>s.here#0A#0A................UNLESS.argno.&gt;#3D.0.DO#0A<BR>=
................{.//.keyword.is.not.recognized#0A..<BR>................GO=
TO.err.....//.MR.27/3/03#0A......<BR>............status.:#3D.FALSE#0A....=
..............L<BR>OOP#0A................}#0A#0A................UNLESS<BR=
>.0.&lt;#3D.argv!argno.&lt;#3D.control.GOTO.err#0A#0A//.Th<BR>is.part.of.=
the.module.is.always.executed.if.the.ent<BR>ered.argument.was#0A//.found.=
to.be.valid;.an.addres<BR>s.from.vector.is.stored.in.the.top.half#0A//.of=
.the<BR>.vector.argv#0A#0A................{.LET.a.#3D.argv!<BR>argno#0A#0=
A..................IF.(a.&amp;.number).~#3D.0<BR>.DO#0A..................=
{.IF.string_to_number(w).DO<BR>.//.check.if.the#0A....................{.a=
rgv!argno<BR>.:#3D.w#0A......................!w.:#3D.result2....<BR>.....=
..//.expected.numeric.input#0A................<BR>......w..:#3D.w.+.1....=
.........//.can.be.string.co<BR>nverted#0A......................LOOP#0A..=
..........<BR>........}#0A#0A....................//.Number.cannot<BR>.be.=
converted#0A....................status.:#3D.FAL<BR>SE#0A.................=
...argv!argno.:#3D.0#0A......<BR>..............LOOP#0A..................}=
#0A#0A.....<BR>.............//.Store.ordinary.argument.value#0A...<BR>...=
............argv!argno.:#3D.w#0A................<BR>..w.:#3D.w.+.w%0/byte=
sperword.+.1#0A...............<BR>...LOOP#0A................}#0A....}.//.=
End.of.main.<BR>switch#0A..}.REPEAT#0A}#0A#0A//.Read.an.item.from.c<BR>ur=
rent.input.stream#0A#0A//.returns.-1....error,.in<BR>put.too.long.or.unma=
tched.quote#0A//..........0....<BR>endstreamch............***.MR.change.1=
1/12/92#0A//.<BR>.........1....unquoted.item#0A//..........2....quot<BR>e=
d.item#0A//..........3....*n.....................*<BR>**.MR.change.11/12/=
92#0A//..........4....;.........<BR>.............***.MR.change.11/12/92#0=
A//..........5<BR>....#3D......................***.MR.change.12/07/03<BR>=
#0A#0A//.When.an.unquoted.item.is.read.its.terminat<BR>ing.character.is#0=
A//.unrdch-ed.so.that.it.can.be.r<BR>ead.again.by.the.next.call.of.rdch#2=
E#0A//.All.item<BR>s.other.items,.namely.strings,.newline,.';',.'#3D'.<BR=
>and#0A//.endstreamch,.are.self.terminating.and.so.d<BR>o.not.need.unrdch=
#0A//.to.be.called#2E#0A#0AAND.rdi<BR>tem(v,.upb).#3D.VALOF#0A{.LET.p,.pm=
ax.#3D.0,.(upb+1<BR>)*bytesperword-1#0A..//.With.bytesperword#3D4#0A../<B=
R>/.upb#3D0.#3D&gt;.pmax#3D3#0A..//.upb#3D1.#3D&gt;.pmax#3D<BR>7#0A..//.#=
2E#2E#2E#0A..LET.ch,.quoted.#3D.rdch(),.F<BR>ALSE#0A#0A..FOR.i.#3D.0.TO.u=
pb.DO.v!i.:#3D.0#0A#0A/<BR>/sawritef("*nrditem.first.ch.#3D.'%c'*n",.ch)#=
0A#0A<BR>..//.Skip.over.white.space#2E#0A..WHILE.ch#3D'*s'.|<BR>.ch#3D'*t=
'.|.ch#3D'*c'DO.ch.:#3D.rdch().#0A#0A..IF.<BR>ch#3Dendstreamch.RESULTIS..=
0...//.EOF#0A..IF.ch#3D'<BR>*n'........RESULTIS..3...//.'*n'#0A..IF.ch#3D=
';'...<BR>......RESULTIS..4...//.';'#0A..IF.ch#3D'#3D'.......<BR>..RESULT=
IS..5...//.'#3D'#0A#0A..IF.ch#3D'"'.DO.{.ch<BR>.:#3D..rdch()#0A..........=
.......IF.ch#3D'*c'.LOOP#0A<BR>.................IF.ch#3D'*n'.|.ch#3Dendst=
reamch.RE<BR>SULTIS.-1.//.Error#0A.................IF.ch#3D'"'.R<BR>ESULT=
IS.2.//.Found.a.quoted.string#2E#0A...........<BR>......IF.ch#3D'**'.DO.{=
.ch.:#3D.rdch()#0A..........<BR>.......................IF.capitalch(ch)#3=
D'N'..DO.c<BR>h.:#3D.'*n'#0A.................................IF.c<BR>apit=
alch(ch)#3D'*"'.DO.ch.:#3D.'*"'.//.MR.8/1/03#0A<BR>......................=
.........}#0A................<BR>.p.:#3D.p+1#0A.................IF.p&gt;p=
max.RESULTIS.-<BR>1.//.Error#0A.................v%0,.v%p.:#3D.p,.ch#0A<BR=
>...............}.REPEAT#0A#0A..//.Copy.chars.of.an.<BR>unquoted.item.int=
o.v#0A..UNTIL.ch#3D'*n'.|.ch#3D'*s<BR>'.|.ch#3D'*t'.|.ch#3D';'.|.ch#3D'#3=
D'.|.ch#3Dendstr<BR>eamch.DO#0A..{.p.:#3D.p+1#0A....IF.p&gt;pmax.RESULTIS=
.<BR>-1..............//.Error#0A....v%0,.v%p.:#3D.p,.ch#0A<BR>....ch.:#3D=
.rdch().REPEATWHILE.ch#3D'*c'#0A..}#0A..<BR>//.Unrdch.its.terminating.cha=
racter#0A#0A//sawritef<BR>("rditem.returning.type.1.%s,.ch#3D%x2.'%c'*n",=
.v,.<BR>ch,.ch)#0A..UNLESS.ch#3Dendstreamch.DO.unrdch()#0A.<BR>.RESULTIS.=
1............................//.Unquoted.<BR>item#0A}#0A#0AAND.findarg(ke=
ys,.w).#3D.VALOF#0A{.MA<BR>NIFEST.{.matching.#3D.0;.skipping.#3D.1.}#0A..=
LET.s<BR>tate,.wp,.argno.#3D.matching,.0,.0#0A..FOR.i.#3D.1.<BR>TO.keys%0=
.DO#0A..{.LET.kch#3Dkeys%i#0A....IF.state#3D<BR>matching.DO#0A....{.IF.(k=
ch#3D'#3D'.|.kch#3D'/'.|.k<BR>ch#3D',').&amp;.wp#3Dw%0.DO#0A........RESUL=
TIS.argno#0A<BR>......wp.:#3D.wp.+.1#0A......UNLESS.compch(kch,.w%w<BR>p)=
.#3D.0.DO.state.:#3D.skipping#0A....}#0A....IF.kc<BR>h#3D','.|.kch#3D'#3D=
'.DO.state,.wp.:#3D.matching,.0<BR>#0A....IF.kch.#3D.','.DO.argno.:#3D.ar=
gno.+.1#0A..}<BR>#0A..IF.state.#3D.matching.&amp;.wp.#3D.w%0.RESULTIS.ar<=
BR>gno#0A..RESULTIS.-1#0A}#0A#0AAND.createco(fn,.size)<BR>.#3D.VALOF#0A{.=
LET.c.#3D.getvec(size+6)#0A..UNLESS.<BR>c.RESULTIS.0#0A..FOR.i.#3D.6.TO.s=
ize+6.DO.c!i.:#3D.<BR>stackword#0A#0A..//.Using.P.to.denote.the.current.s=
<BR>tack.frame#0A..//.pointer,.the.following.assumption<BR>s.are.made:#0A=
..//..P!0,.P!1,.P!2.contain.the.retur<BR>n.link.information#0A..//..P!3..=
.is.the.variable.fn<BR>#0A..//..P!4...is.the.variable.size#0A..//..P!5...=
i<BR>s.the.variable.c#0A#0A..//.Now.make.the.vector.c.in<BR>to.a.valid.BC=
PL#0A..//.stack.frame.containg.copies.<BR>of.fn,.size#0A..//.and.c.in.the=
.same.relative.posit<BR>ions#2E#0A..//.Other.locations.in.the.new.stack.f=
ra<BR>me.#0A..//.are.used.for.other.purposes#2E#0A..c!0.:<BR>#3D.c&lt;&lt=
;B2Wsh.//.resumption.point#0A..c!1.:#3D.currc<BR>o...//.parent.link#0A..c=
!2.:#3D.colist...//.colist.<BR>chain#0A..c!3.:#3D.fn.......//.the.main.fu=
nction#0A<BR>..c!4.:#3D.size.....//.the.coroutine.size#0A..c!5.:<BR>#3D.c=
........//.the.new.coroutine.pointer#0A#0A..co<BR>list.:#3D.c..//.insert.=
into.the.list.of.coroutines#0A<BR>#0A..changeco(0,.c)#0A#0A..//.Execution=
.now.continu<BR>es.with.the.P.pointer.set.to.c&lt;&lt;B2Wsh,#0A..//.and.s=
<BR>o..the.vector.c.becomes.the.current.stack.frame#2E#0A<BR>..//.The.com=
piler.will.have.generated.code.on#0A../<BR>/.the.assumption.that.fn.and.c=
.are.the.third.and.fi<BR>fth#0A..//.words.of.the.stack.frame,.and,.since.=
c!3<BR>.and.c!5#0A..//.were.initialised.to.fn.and.c,.the.f<BR>ollowing.re=
peated#0A..//.statement.will.have.the.ef<BR>fect.(naively).expected#2E#0A=
..//.Note.that.the.fir<BR>st.call.of.cowait.causes.a.return#0A..//.from.c=
reat<BR>eco.with.result.c#2E#0A#0A..c.:#3D.fn(cowait(c)).RE<BR>PEAT#0A}#0=
A#0AAND.deleteco(cptr).#3D.VALOF#0A{.LET.<BR>a.#3D.@colist#0A#0A..{.LET.c=
o.#3D.!a#0A....UNLESS.c<BR>o.DO#0A....{.sawritef("BLIB.co#3D%n:.cannot.de=
letec<BR>o.%n.--.not.found*n",#0A.........currco,.cptr)#0A..<BR>....abort=
(112)#0A......RESULTIS.FALSE#0A....}#0A...<BR>.IF.co#3Dcptr.BREAK#0A....a=
.:#3D.@.co!co_list#0A..}<BR>.REPEAT#0A#0A..IF.cptr!co_parent.DO#0A..{.saw=
ritef(<BR>"BLIB.co#3D%n:.cannot.deleteco.%n.--.has.a.parent*n<BR>",#0A...=
....currco,.cptr)#0A....abort(112)#0A....RE<BR>SULTIS.FALSE#0A..}#0A#0A..=
!a.:#3D.cptr!co_list.....<BR>.//.Remove.the.coroutine.from.colist#2E#0A..=
freevec<BR>(cptr)...........//.Free.the.coroutine.stack#2E#0A.<BR>.RESULT=
IS.TRUE#0A}#0A#0AAND.callco(cptr,.a).#3D.VAL<BR>OF#0A{.IF.cptr!co_parent.=
DO.abort(110)#0A..cptr!co_<BR>parent.:#3D.currco#0A..RESULTIS.changeco(a,=
.cptr)#0A<BR>}#0A#0AAND.resumeco(cptr,.a).#3D.VALOF#0A{.LET.pare<BR>nt.#3=
D.currco!co_parent#0A..currco!co_parent.:#3D.0<BR>#0A..IF.cptr!co_parent.=
DO.abort(111)#0A..cptr!co_pa<BR>rent.:#3D.parent#0A..RESULTIS.changeco(a,=
.cptr)#0A}<BR>#0A#0AAND.cowait(a).#3D.VALOF#0A{.LET.parent.#3D.cu<BR>rrco=
!co_parent#0A..currco!co_parent.:#3D.0#0A..RESU<BR>LTIS.changeco(a,.paren=
t)#0A}#0A#0AAND.initco(fn,.si<BR>ze,.a,.b,.c,.d,.e,.f,.g,.h,.i,.j,.k).#3D=
.VALOF#0A{.<BR>LET.cptr.#3D.createco(fn,.size)#0A..IF.cptr.DO.call<BR>co(=
cptr,.@a)#0A..RESULTIS.cptr#0A}#0A#0A/*......res<BR>.:#3D.startco(body,.a=
rg,.stsize)#0A#0A........The.r<BR>outine.'body'.is.created.as.a.coroutine=
.with.a.stac<BR>ksize.'stsize'#0A........and.'arg'.passed.as.an.arg<BR>um=
ent#2E..The.result.is.the.stackbase.of#0A........<BR>the.coroutine#2E#0A*=
/#0A#0AAND.startco(body,.arg,.s<BR>tsize).#3D.VALOF#0A{.LET.newco.#3D.cre=
ateco(body,.s<BR>tsize)#0A//sawritef("BLIB:.callco(%n,%n)*n",.newco,<BR>.=
arg)#0A...IF.newco.DO.callco(newco,.arg)#0A...RESU<BR>LTIS.newco#0A}#0A#0=
A//.object.making.function#0AAND<BR>.mkobj(upb,.fns,.a,.b,.c,.d,.e,.f,.g,=
.h,.i,.j,.k).#3D<BR>.VALOF#0A{.LET.obj.#3D.getvec(upb)#0A..UNLESS.obj#3D<=
BR>0.DO#0A..{.!obj.:#3D.fns#0A....InitObj#23(obj,.@a).<BR>//.Send.the.Ini=
tObj.message.to.the.object#0A..}#0A.<BR>.RESULTIS.obj#0A}#0A#0AAND.instrc=
ount(fn,.a,b,c,d,e<BR>,f,g,h,i,j,k).#3D.VALOF#0A{.LET.res.#3D.0#0A..LET.c=
<BR>ount.#3D.sys(Sys_setcount,.maxint)..//.Set.count.re<BR>gister.to.maxi=
nt#0A..result2.:#3D.fn(a,b,c,d,e,f,g,<BR>h,i,j,k)#0A..res.:#3D.sys(Sys_se=
tcount,.count).....<BR>...//.Restore.previous.value#0A...................=
.<BR>...........//.returning.the.modified.count#0A..RESU<BR>LTIS.maxint.-=
.res.-.32...//.Correct.for.overhead#0A<BR>}#0A#0AAND.datstring(v).#3D.VAL=
OF#0A{.LET.datv.#3D.<BR>VEC.2#0A..datstamp(datv)#0A..dat_to_strings(datv,=
.v<BR>)#0A..RESULTIS.v#0A}#0A#0AAND.dat_to_strings(datv,.<BR>v).#3D.VALOF=
#0A#0A//.Returns.v.containing.3.strings<BR>.representing.the#0A//.time.an=
d.date.given.in.datv,<BR>.where#0A//.datv!0.#3D.days,.datv!1.#3D.mins,.da=
tv!<BR>2.#3D.ticks#2E#0A//.On.return,.v.contains.a.the.dat<BR>e.in.the.fo=
rm#0A//.DD-MMM-YY,.v+5.contains.the.time<BR>.in.the.format#0A//.HH:MM:SS,=
.and.V+10.contains.the<BR>.day.of.the.week#2E#0A//.Vector.v.should.have.a=
n.up<BR>perbound.of.14#0A//.If.the.date.is.unset.(days.#3D.<BR>0).then.th=
e.strings#0A//.are.all.set.to."&lt;unset&gt;"#0A<BR>#0A{.LET.days,..mins,=
..ticks.#3D.datv!0,.datv!1,.da<BR>tv!2#0A..LET.datestr,.timestr,.dowstr.#=
3D.v,.v+5,.v<BR>+10#0A..LET.dayofweek.#3D.days.REM.7#0A..LET.dowtem<BR>p.=
#3D.?#0A..LET.year.#3D.1978.//.Cintpos.base.year#0A<BR>..LET.month.#3D.1#=
0A..LET.hours,.secs.#3D.?,.?#0A..<BR>LET.monthtab.....#3D.TABLE...0,.31,.=
59,.90,120,151,<BR>#0A...........................181,212,243,273,304,3<BR=
>34,365#0A..LET.leapmonthtab.#3D.TABLE...0,.31,.60,.<BR>91,121,152,#0A...=
........................182,213,24<BR>4,274,305,335,366#0A..LET.mchars.#3=
D."JanFebMarAprM<BR>ayJunJulAugSepOctNovDec"#0A..LET.mcharbase.#3D.?#0A<B=
R>..LET.mtable.#3D.?#0A#0A//sawritef("BLIB:.dat_to_st<BR>ring:.entered*n"=
)#0A#0A..//.Deal.with.case.of.unset<BR>.date#0A..IF.days.#3D.0.DO#0A..{.L=
ET.unset.#3D."&lt;un<BR>set&gt;"#0A....FOR.z.#3D.0.TO.unset%0.DO.#0A....{=
.LET.<BR>c.#3D.unset%z#0A......datestr%z.:#3D.c#0A......time<BR>str%z.:#3=
D.c#0A......dowstr%z..:#3D.c#0A....}#0A...<BR>.RESULTIS.v#0A..}#0A#0A..da=
ys.:#3D.days.+.1#0A..FOR<BR>.j#3D0.TO.9.DO.datestr%j.:#3D."DD-MMM-YY"%j#0=
A..FOR<BR>.j#3D0.TO.8.DO.timestr%j.:#3D."HH:MM:SS"%j#0A#0A../<BR>/.Constr=
uct.date#0A#0A..{.//.Loop.to.get.year#0A...<BR>.LET.yearlen.#3D.isleap(ye=
ar).-&gt;.366,.365#0A....IF.<BR>0.&lt;.days.&lt;#3D.yearlen.BREAK#0A....d=
ays,.year.:#3D.d<BR>ays.-.yearlen,.year.+.1#0A..}.REPEAT#0A#0A..datestr<B=
R>%8.:#3D.year/10.REM.10.+.'0'#0A..datestr%9.:#3D.yea<BR>r....REM.10.+.'0=
'#0A.#0A..//.Find.month#0A..mtable.<BR>:#3D.isleap(year).-&gt;.leapmontht=
ab,.monthtab#0A#0A..<BR>{.IF.days.&lt;#3D.mtable.!.month.BREAK#0A....mont=
h.:#3D<BR>.month.+.1#0A..}.REPEAT#0A#0A..mcharbase.:#3D.month<BR>*3.-.2#0=
A..FOR.j#3D0.TO.2.DO.datestr%(4+j).:#3D.mch<BR>ars.%.(mcharbase.+.j)#0A..=
days.:#3D.days.-.mtable.!<BR>.(month.-.1)#0A..datestr%1.:#3D.days/10.+.'0=
'#0A..d<BR>atestr%2.:#3D.days.REM.10.+.'0'#0A#0A..//.Construct<BR>.time#0=
A#0A..hours.:#3D.mins/60#0A..mins.:#3D.mins.<BR>REM.60#0A#0A..//.treat.ti=
cks.as.unsigned.integers#0A<BR>..secs.:#3D.(ticks&gt;&gt;1)./.(ticksperse=
cond&gt;&gt;1)#0A#0A.<BR>.timestr%1.:#3D.hours/10.+.'0'#0A..timestr%2.:#3=
D.h<BR>ours.REM.10.+.'0'#0A..timestr%4.:#3D.mins/10.+.'0'#0A<BR>..timestr=
%5.:#3D.mins.REM.10.+.'0'#0A..timestr%7.:#3D<BR>.secs/10.REM.10.+.'0'#0A.=
.timestr%8.:#3D.secs.REM.1<BR>0.+.'0'#0A#0A..//.Get.day.of.week#0A....#0A=
..dowtem<BR>p.:#3D.VALOF.SWITCHON.dayofweek.INTO#0A......{.CASE<BR>.0:.RE=
SULTIS."Sunday"#0A........CASE.1:.RESULTIS."M<BR>onday"#0A........CASE.2:=
.RESULTIS."Tuesday"#0A.....<BR>...CASE.3:.RESULTIS."Wednesday"#0A........=
CASE.4:.R<BR>ESULTIS."Thursday"#0A........CASE.5:.RESULTIS."Frid<BR>ay"#0=
A........CASE.6:.RESULTIS."Saturday"#0A......}<BR>#0A#0A..FOR.j.#3D.0.TO.=
dowtemp%0.DO.dowstr%j.:#3D.d<BR>owtemp%j#0A#0A..RESULTIS.v#0A}#0A#0AAND.i=
sleap(year<BR>).#3D.year.REM.400.#3D.0.-&gt;.TRUE,#0A...............<BR>.=
...year.REM.100.#3D.0.-&gt;.FALSE,#0A................<BR>...year.REM...4.=
#3D.0.-&gt;.TRUE,#0A..................<BR>.....................FALSE#0A#0=
AAND.testbit(bitno,.<BR>bitvec).#3D.VALOF#0A//.This.function.returns.a.no=
n.<BR>zero.value.if.the.specified.bit.in#0A//.bitvec.is.a<BR>.one,.otherw=
ise.it.returns.zero#2E#0A//.Bits.are.nu<BR>mbered.from.zero.starting.at.t=
he.least.significant.<BR>bit#0A//.of.bitvec!0#2E#0A//.bitvec!0.holds.bits=
.0.<BR>to.bitsperword-1#0A//.bitvec!1.holds.bits.bitsperwo<BR>rd.to.2*bit=
sperword-1#0A//.etc#0A{.LET.i.#3D.bitno.<BR>./..bitsperword#0A..AND.s.#3D=
.bitno.REM.bitsperword<BR>#0A..RESULTIS.bitvec!i.&amp;.(1&lt;&lt;s)#0A}#0=
A#0AAND.setbit<BR>(bitno,.bitvec,.state).#3D.VALOF#0A//.This.function<BR>=
.sets.the.specified.bit.in.bitvec.to.1.or.0.dependi<BR>ng#0A//.on.whether=
.state.is.TRUE.or.FALSE,.respecti<BR>vely#2E.It.returns.a#0A//.non-zero.v=
alue.if.the.pre<BR>vious.setting.of.the.bit.was.a.one,.otherwise#0A//.<BR=
>it.returns.zero#2E.See.testbit.above#2E#0A{.LET.i.#3D<BR>.bitno../..bits=
perword#0A..AND.s.#3D.bitno.REM.bits<BR>perword#0A..LET.mask.#3D.1.&lt;&l=
t;.s#0A..LET.oldstate.#3D<BR>.bitvec!i.&amp;.mask#0A..TEST.state.THEN.bit=
vec!i.:#3D.<BR>bitvec!i.|..mask#0A.............ELSE.bitvec!i.:#3D.<BR>bit=
vec!i.&amp;.~mask#0A..RESULTIS.oldstate#0A}#0A#0AAND<BR>.string_to_number=
(s).#3D.VALOF#0A//.Return.TRUE.if.<BR>OK.with.value.in.result2#0A//......=
..FALSE.and.resu<BR>lt2#3D0.if.s.is.not.a.number#0A//.Example.strings:.<B=
R>#0A//...'A'#0A//..123....-99....+63#0A//..#23377...<BR>-#23x7FF.+#23b10=
11011.#0A{.LET.p,.len.#3D.1,.s%0#0A<BR>..LET.neg,.radix.#3D.FALSE,.10#0A.=
.LET.ch.#3D.?#0A#0A<BR>..result2.:#3D.0#0A..UNLESS.len.RESULTIS.FALSE#0A.=
.<BR>ch.:#3D.capitalch(s%p)#0A..IF.ch.#3D.'*''.&amp;.len.#3D<BR>.3.&amp;.=
s%3.#3D.'*''.DO#0A..{.result2.:#3D.s%2#0A....R<BR>ESULTIS.TRUE#0A..}#0A#0=
A..IF.ch.#3D.'+'.|.ch.#3D.'-<BR>'.DO#0A..{.neg.:#3D.ch.#3D.'-'#0A....IF.p=
.#3D.len.R<BR>ESULTIS.TRUE#0A....p.:#3D.p.+.1#0A....ch.:#3D.capit<BR>alch=
(s%p)#0A..}#0A..IF.ch.#3D.'#23'.DO#0A..{.radix.<BR>:#3D.8#0A....IF.p.#3D.=
len.RESULTIS.TRUE#0A....p.:#3D<BR>.p.+.1#0A....ch.:#3D.capitalch(s%p)#0A.=
...IF.ch.#3D<BR>.'O'.|.ch.#3D.'X'.|.ch.#3D.'B'.DO#0A....{.IF.ch.#3D<BR>.'=
X'.DO.radix.:#3D.16#0A......IF.ch.#3D.'B'.DO.radi<BR>x.:#3D.2#0A......IF.=
p.#3D.len.RESULTIS.TRUE#0A.....<BR>.p.:#3D.p.+.1#0A......ch.:#3D.capitalc=
h(s%p)#0A....<BR>}#0A..}#0A..{.LET.n.#3D.'0'.&lt;#3D.ch.&lt;#3D.'9'.-&gt;=
.ch.<BR>-.'0',#0A............'A'.&lt;#3D.ch.&lt;#3D.'Z'.-&gt;.ch.-.'<BR>A=
'.+.10,.1000#0A....UNLESS.n.&lt;.radix.RESULTIS.FALSE<BR>#0A....result2.:=
#3D.result2.*.radix.+.n#0A....p.:#3D<BR>.p.+.1#0A....IF.p.&gt;.len.BREAK#=
0A....ch.:#3D.capital<BR>ch(s%p)#0A..}.REPEAT#0A#0A..IF.neg.DO.result2.:#=
3D.<BR>-result2#0A..RESULTIS.TRUE#0A}#0A#0AAND.string_to_d<BR>at().#3D.VA=
LOF#0A{.sawritef("function.string_to_dat<BR>.not.implemented.(BLIB)*n")#0=
A..RESULTIS.0#0A}#0A#0A<BR>//.Get.the.ith.element.of.vector.v.of.16-bit.u=
nsign<BR>ed.words#0AAND.getword(v,.i).#3D.VALOF#0A{.LET.j.#3D<BR>.i+i#0A.=
.LET.res.#3D.v%j.+.(v%(j+1)&lt;&lt;8)..//.Assumes<BR>.little.ender.m/c.??=
????????#0A..RESULTIS.res#0A}#0A<BR>#0A//.Store.least.sig.16.bits.of.w.in=
.the.ith.eleme<BR>nt.of.vector.v.of.16-bit.words#0AAND.putword(v,.i,.<BR>=
w).BE....//.store.16.bit.word#0A{.LET.j.#3D.i+i#0A.<BR>.v%j,.v%(j+1).:#3D=
.w,.w&gt;&gt;8..//.Assumes.little.ender<BR>.m/c..?????????????#0A}#0A#0AA=
ND.copystring(from,.t<BR>o).BE#0A..FOR.i.#3D.0.TO.from%0.DO.to%i.:#3D.fro=
m%i<BR>#0A#0AAND.copy_words(from,.to,.n).BE#0A..FOR.i.#3D.<BR>0.TO.n-1.DO=
.to!i.:#3D.from!i#0A#0AAND.clear_words(v<BR>,.n).BE#0A..FOR.i.#3D.0.TO.n-=
1.DO.v!i.:#3D.0#0A#0AA<BR>ND.copy_bytes(fromlen,.from,.fillch,.tolen,.to)=
.#3D<BR>.VALOF#0A//.This.is.an.implementation.of.the.VAX.MO<BR>VC5.instru=
ction#0A//.for.copying.bytes#2E#0A{.LET.n<BR>.#3D.fromlen#0A..//.from.and=
.to.are.byte.addresses!<BR>!!!!#0A..IF.n&gt;tolen.DO.n.:#3D.tolen#0A..//.=
This.cod<BR>e.need.checking!!!!!#0A..FOR.i.#3D.0.TO.n-1.DO.0%(t<BR>o+i).:=
#3D.0%(from+i)#0A..FOR.i.#3D.n.TO.tolen-1.DO.<BR>0%(to+i).:#3D.fillch#0A.=
.RESULTIS.fromlen-n.//.Numb<BR>er.of.non.copied.characters#0A}#0A#0A#0A#0=
AAND.getv<BR>ec(upb).#3D.VALOF#0A{.IF.upb&lt;0.DO#0A..{.sawritef("B<BR>LI=
B:.getvec(%n).called*n",.upb)#0A....abort(1000)#0A<BR>..}#0A..RESULTIS.sy=
s(Sys_getvec,.upb)#0A}#0A#0AAND.<BR>freevec(ptr).BE.IF.ptr.UNLESS.sys(Sys=
_freevec,.ptr)<BR>.DO#0A{.sawritef("BLIB.co#3D%n:.freevec.failure,.pt<BR>=
r#3D%n*n",.currco,.ptr)#0A..abort(999)#0A}#0A#0AAND<BR>.loadseg(name).#3D=
.sys(Sys_loadseg,.name)#0A#0AAND.<BR>globin(segl).#3D.sys(Sys_globin,.seg=
l)#0A#0AAND.unl<BR>oadseg(segl).BE.sys(Sys_unloadseg,.segl)#0A#0AAND.c<BR=
>allseg(file,.arg1,.arg2,.arg3,.arg4).#3D.VALOF#0A{.<BR>LET.res.#3D.0#0A.=
.LET.seg.#3D.loadseg(file)#0A..LET<BR>.s.#3D.start#0A//sawritef("BLIB:.ca=
llseg.%s.entered<BR>*n",.file)#0A#0A..TEST.seg.&amp;.globin(seg)#0A..THEN=
.r<BR>es.:#3D.start(arg1,.arg2,.arg3,.arg4)#0A..ELSE.{.sa<BR>writef("BLIB=
:.Unable.to.callseg.%s.seg#3D%n*n",.fil<BR>e,.seg)#0A.........abort(999)#=
0A.........start.:#3D<BR>.s#0A.........RESULTIS.0#0A.......}#0A..unloadse=
g(s<BR>eg)#0A..start.:#3D.s#0A..RESULTIS.res#0A}#0A#0AAND.<BR>deletefile(=
name).#3D.sys(Sys_deletefile,.name)#0A#0A<BR>AND.renamefile(fromname,.ton=
ame).#3D.sys(Sys_rename<BR>file,.fromname,.toname)#0A#0AAND.setlogname(lo=
gname<BR>,.logvalue).#3D.VALOF#0A{.LET.a.#3D.@rootnode!rtn_e<BR>nvlist#0A=
#0A..//.First.delete.current.entry.if.it.e<BR>xists#2E#0A..{.LET.p.#3D.!a=
#0A....UNLESS.p.BREAK#0A<BR>....IF.compstring(logname,.p!1)#3D0.DO#0A....=
{.!a.:<BR>#3D.!p#0A......freevec(p)#0A......BREAK#0A....}#0A.<BR>...a.:#3=
D.p#0A..}.REPEAT#0A#0A..IF.logvalue.DO.//.I<BR>nsert.new.entry#0A..{.LET.=
upb1.#3D.logname%0../.byt<BR>esperword#0A....LET.upb2.#3D.logvalue%0./.by=
tesperw<BR>ord#0A....LET.p.#3D.getvec(4.+.upb1.+.upb2).//.3.+.<BR>upb1+1.=
+.upb2+1.-.1#0A....LET.s1.#3D.p.+.3#0A....LE<BR>T.s2.#3D.s1.+.upb1.+.1#0A=
....UNLESS.p.RESULTIS.0#0A<BR>....FOR.i.#3D.0.TO.upb1.DO.s1!i.:#3D.lognam=
e!i#0A..<BR>..FOR.i.#3D.0.TO.upb2.DO.s2!i.:#3D.logvalue!i#0A...<BR>.p!1,.=
p!2.:#3D.s1,.s2#0A....!p.:#3D.rootnode!rtn_en<BR>vlist#0A....rootnode!rtn=
_envlist.:#3D.p#0A....RESUL<BR>TIS.p#0A..}#0A#0A//sawritef("BLIB:.not.add=
ing.%s*n"<BR>,.logname)#0A..RESULTIS.0#0A}#0A#0AAND.getlogname(l<BR>ognam=
e).#3D.VALOF#0A{.LET.p.#3D.rootnode!rtn_envlis<BR>t#0A..WHILE.p.DO#0A..{.=
IF.compstring(logname,.p!1)#3D<BR>0.RESULTIS.p!2#0A....p.:#3D.!p#0A..}#0A=
..RESULTIS.0<BR>#0A}#0A#0A//.Example.calls.of.splitname.give.the.fo<BR>ll=
owing.results#0A#0A//.splitname(prefix,.':',."TCP<BR>:shep:9000",..1).#3D=
&gt;..5,.prefix#3D"TCP"#0A//.split<BR>name(prefix,.':',."TCP:shep:9000",.=
.5).#3D&gt;.10,.pre<BR>fix#3D"shep"#0A//.splitname(prefix,.':',."TCP::900=
0<BR>",......5).#3D&gt;..6,.prefix#3D""#0A//.splitname(pref<BR>ix,.':',."=
TCP:shep",.......5).#3D&gt;..0,.prefix#3D"sh<BR>ep"#0A//.splitname(prefix=
,.':',."TCP:shep:",......5<BR>).#3D&gt;.10,.prefix#3D"shep"#0A//.splitnam=
e(prefix,.'<BR>:',."TCP:shep:",.....10).#3D&gt;..0,.prefix#3D""#0A//.<BR>=
splitname(prefix,.':',."TCP:shep:9000",.10).#3D&gt;..0<BR>,.prefix#3D"900=
0"#0A#0AAND.splitname(prefix,.ch,.st<BR>ring,.ptr).#3D.VALOF#0A{.LET.len.=
#3D.string%0#0A..L<BR>ET.res,.pos.#3D.0,.0#0A#0A..WHILE.ptr&lt;#3Dlen.DO#=
0A.<BR>.{.LET.k.#3D.string%ptr#0A....IF.k#3Dch.DO.{.prefix<BR>%0.:#3D.pos=
;.RESULTIS..ptr+1.}#0A....pos,.ptr.:#3D.<BR>pos+1,.ptr+1#0A....prefix%pos=
.:#3D.k.#0A..}#0A..pre<BR>fix%0.:#3D.pos#0A..RESULTIS.0#0A}#0A#0A//.Not.u=
sed#0A<BR>AND.open_for_output(name,.recsiz,.maxrec).#3D.VALOF<BR>#0A{.saw=
ritef("DLIB:.open_for_output(%s,%n,%n).call<BR>ed*n",.name,.recsiz,.maxre=
c).#0A..RESULTIS.findstre<BR>am(name,.id_outscb,.recsiz.&lt;&lt;.2,.maxre=
c)#0A}#0A#0AA<BR>ND.open_for_input(name).#3D.findstream(name,.id_ins<BR>c=
b,.0)#0A#0AAND.open_for_update(name).#3D.findstrea<BR>m(name,.id_inoutscb=
,.0)#0A#0AAND.setrecordlength(sc<BR>b,.length).#3D.VALOF..//.length.is.in=
.bytes.--.MR.1<BR>2/7/04#0A{.LET.old.#3D.scb!scb_reclen#0A..scb!scb_r<BR>=
eclen.:#3D.length.//.in.bytes#0A..RESULTIS.old#0A}#0A<BR>#0AAND.recordnot=
e(scb).#3D.VALOF.//.The.first.recor<BR>d.has.number.0#0A//.Returns.the.re=
cord.number.corre<BR>sponding.to.the.current.position#0A//.........of.th<=
BR>e.stream#2E#0A//.Returns.-1.if.the.stream.is.not.su<BR>itable#2E#0A{.L=
ET.blkno.#3D.scb!scb_block....//.The<BR>.blocksize.is.the.buffer.size.in.=
bytes#0A..AND.recl<BR>en.#3D.scb!scb_reclen..//.in.bytes#0A..IF.blkno&gt;=
#3D<BR>0.&amp;.reclen&gt;0.DO.//.Modified.by.MR.12/7/04#0A..{.LET<BR>.rec=
no.#3D.muldiv(blkno,.scb!scb_bufend,.reclen)#0A<BR>....RESULTIS.recno.+.(=
result2.+.scb!scb_pos)/reclen<BR>..//.MR.12/2/04#0A..}#0A..sawritef("BLIB=
:.recordnot<BR>e:.result.-1*n")#0A..RESULTIS.-1...//.MR.26/7/04#0A<BR>}#0=
A#0AAND.recordpoint(scb,.recno).#3D.VALOF#0A//.M<BR>R.28/7/02:.The.first.=
record.of.a.file.has.number.0#0A<BR>//.Returns.TRUE.if.successful#0A//.Re=
turns.FALSE,.o<BR>therwise#2E#0A{.LET.pvec.#3D.VEC.1#0A..LET.type.#3D<BR>=
.scb!scb_type#0A..UNLESS.type#3Dscbt_file.|.type#3D<BR>scbt_ram.DO#0A..{.=
sawritef("FLIB.recordpoint:.only.<BR>works.on.a.disc.or.RAM.file*n")#0A..=
..abort(999)#0A<BR>....RESULTIS.FALSE#0A..}#0A..IF.recno&lt;0.DO...//.The=
<BR>.first.record.has.number.0#0A..{.sawritef("DLIB:.re<BR>cordpoint.recn=
o#3D%n*n",.recno)#0A....abort(1000)#0A<BR>....recno.:#3D.0#0A..}#0A//sawr=
itef("DLIB:.recordpo<BR>int:.muldiv(%n,%n,%n)*n",#0A//..........scb!scb_r=
ec<BR>len,.recno,.scb!scb_bufend)#0A//abort(1000)#0A..pve<BR>c!0.:#3D.mul=
div(scb!scb_reclen,.recno,.scb!scb_bufe<BR>nd).//.MR.29/7/02#0A..pvec!1.:=
#3D.result2#0A//sawri<BR>tef("DLIB:.recordpoint:.recno.%n.#3D&gt;.%n.%n*n=
",#0A/<BR>/..........recno,.pvec!0,.pvec!1)#0A//abort(1000)#0A<BR>//IF.pv=
ec!0&gt;2.DO.abort(8888)#0A..RESULTIS.point(scb<BR>,.pvec)#0A}#0A#0A//.Po=
sition.an.inout.stream.to.its<BR>.end#0A//.This.should.be.removed#2E#0AAN=
D.appendstr<BR>eam(scb).#3D.VALOF.//?????????????????????????????#0A<BR>$=
(..LET.lblock.#3D.scb!scb_lblock#0A....LET.ldata.#3D<BR>.scb!scb_ldata#0A=
....LET.pvec.#3D.VEC.1#0A//sawrite<BR>f("DLIB:.appendstream.called*n");.a=
bort(999)#0A....<BR>UNLESS.scb!scb_id#3Did_inoutscb.RESULTIS.FALSE#0A..<B=
R>..IF.scb!scb_block#3Dlblock.&amp;.scb!scb_end&gt;ldata.DO#0A<BR>.......=
.ldata.:#3D.scb!scb_end#0A....pvec!0,.pvec!1<BR>.:#3D.lblock,.ldata#0A...=
.UNLESS.point(scb,.pvec).R<BR>ESULTIS.FALSE#0A//....scb!scb_pos.:#3D.scb!=
scb_end#0A<BR>....RESULTIS.TRUE#0A}#0A#0A//.Position.to.start.of.<BR>stre=
am#0AAND.rewindstream(scb).#3D.VALOF.//.MR.17/3<BR>/02#0A{.LET.pvec.#3D.V=
EC.1#0A..pvec!0,.pvec!1.:#3D.<BR>0,.0......//.MR.6/8/02#0A..RESULTIS.poin=
t(scb,.pvec<BR>)#0A}#0A#0A//.Advance.stream.position.by.n.words#0A<BR>AND=
.stepstream(scb,.n).#3D.VALOF#0A{.LET.pvec.#3D.V<BR>EC.1#0A..LET.bytes,.l=
en.#3D.n.*.bytesperword,.scb!s<BR>cb_bufend#0A..LET.blocks.#3D.bytes./.le=
n#0A..bytes.<BR>:#3D.bytes.REM.len#0A..note(scb,.pvec)#0A..pvec!1.:<BR>#3=
D.pvec!1.+.bytes#0A..IF.pvec!1.&lt;.0...DO.pvec!0,.p<BR>vec!1.:#3D.pvec!0=
.-.1,.pvec!1.+.len#0A..IF.pvec!1.&gt;<BR>.len.DO.pvec!0,.pvec!1.:#3D.pvec=
!0.+.1,.pvec!1.-.le<BR>n#0A..pvec!0.:#3D.pvec!0.+.blocks#0A..RESULTIS.pve=
c<BR>!0.&lt;.1.-&gt;.FALSE,.point(scb,.pvec)#0A}#0A#0A//.Creat<BR>e.a.RAM=
.stream.for.input.and.output.using.the.given<BR>#0A//.vector,.v,.with.upp=
er.bound.upb.as.the.buffer<BR>,.and.end.is#0A//.the.byte.subscript.of.the=
.end.of.<BR>valid.data#2E#0AAND.mkramstream(buf,.bufend,.end).#3D<BR>.VAL=
OF#0A{.LET.scb.#3D.getvec(scb_upb)#0A..UNLESS.s<BR>cb.RESULTIS.0#0A..FOR.=
i.#3D.0.TO.scb_upb.DO.scb!i.:<BR>#3D.0#0A..scb!scb_id......:#3D.id_inouts=
cb#0A..scb!<BR>scb_type....:#3D.scbt_ram#0A..scb!scb_buf.....:#3D.<BR>buf=
#0A..scb!scb_end.....:#3D.end.....//.End.of.vali<BR>d.data#0A..scb!scb_rd=
fn....:#3D.falsefn.//.No.read#0A<BR>..scb!scb_wrfn....:#3D.falsefn.//.or.=
write.function<BR>s#0A..scb!scb_endfn...:#3D.ramendfn#0A..scb!scb_buf<BR>=
end..:#3D.bufend..//.Length.in.bytes#0A..scb!scb_wr<BR>ite...:#3D.FALSE..=
.//.No.data.waiting.to.be.written<BR>#0A..scb!scb_ldata...:#3D.end.....//=
.Number.of.byte<BR>s.in.the.last.(only).block#0A..RESULTIS.scb#0A}#0A#0A<=
BR>AND.falsefn().#3D.FALSE#0A#0AAND.ramendfn(scb).#3D.<BR>TRUE.//.Always.=
successful#0A#0AAND.freeobj(obj).BE.<BR>freevec(obj)#0A#0AAND.copydir(dir=
).#3D.VALOF#0A{.LE<BR>T.v.#3D.getvec((dir%0)/bytesperword)#0A..IF.v.FOR.i=
<BR>.#3D.0.TO.dir%0.DO.v%i.:#3D.dir%i#0A//sawritef("BLI<BR>B:.copydir.cal=
led*n")#0A//abort(999)#0A..RESULTIS.v<BR>#0A}#0A#0A//.Write.the.specified=
.number.of.records.<BR>of.zeroes.to.the.opened.file#0AAND.setbulk(scb,.no=
_<BR>records).#3D.VALOF#0A{.LET.oldout.#3D.output()#0A..<BR>LET.n.#3D.no_=
records.....*.//.Number.of.bytes.to.wr<BR>ite#0A..........scb!scb_reclen#=
0A..MANIFEST.{.bytes<BR>.#3D.2048;.words#3Dbytes/bytesperword.}#0A..LET.v=
.#3D<BR>.VEC.words#0A//sawritef("BLIB:.setbulk:.clearing.v!<BR>0.to.v!%n*=
n",.words-1)#0A..FOR.p.#3D.@v!0.TO.@v!wor<BR>ds-1.DO.!p.:#3D.0#0A#0A..rew=
indstream(scb)#0A..sele<BR>ctoutput(scb)#0A..//.Used.writewords.to.write.=
2048.<BR>bytes.at.a.time#0A//sawritef("BLIB:.setbulk:.writin<BR>g.%n.byte=
s.to.file*n",.n)#0A..WHILE.n&gt;#3Dbytes.DO.{<BR>.writewords(v,.words);.n=
.:#3D.n-bytes.}#0A..//.and.<BR>then.write.the.few.remaining.bytes,.if.any=
#2E#0A//s<BR>awritef("BLIB:.setbulk:.writing.the.remaining.%n.by<BR>tes.t=
o.file*n",.n)#0A..FOR.i.#3D.1.TO.n.DO.binwrch(<BR>0)#0A..rewindstream(scb=
)#0A..selectoutput(oldout)#0A<BR>..RESULTIS.TRUE#0A}#0A#0AAND.datstamp(v)=
.#3D.VALOF#0A<BR>{.LET.tv....#3D.VEC.5#0A..LET.days..#3D.0#0A..LET.m<BR>i=
ns..#3D.0#0A..LET.secs..#3D.0#0A..LET.msecs.#3D.0#0A<BR>.#0A..MANIFEST.{.=
secsperday.#3D.60*60*24.}#0A#0A..s<BR>ys(Sys_ftime,.tv)#0A#0A..secs..:#3D=
.tv!1.-.2922*sec<BR>sperday..//.Change.from.Unix.to.Tripos.epoc#0A..mse<B=
R>cs.:#3D.tv!2#0A..//.secs.#3D.(unsigned).seconds.sin<BR>ce.00:00:00.on.1=
.Jan.1978#0A..//.****.It.will.ovefl<BR>ow.on.06:28:15.Friday.6.Feb.2114.*=
***#0A..//.secs.:<BR>#3D.#23xFFFFFFFF..//.Corresponds.to.06:28:15.Friday<=
BR>.6.Feb.2114#0A#0A..//.secsperday*10000.#3D.864_000_<BR>000#0A..//.The.=
following.loop.will.never.do.more.th<BR>an.3.iterations#0A..WHILE.secs&lt=
;0.DO.{.//.To.avoid.o<BR>verflow.problems#0A....secs,.days.:#3D.secs-secs=
per<BR>day*10000,.days+10000#0A....//sawritef("days#3D%n*n<BR>",.days)#0A=
..}#0A..days..:#3D.days.+.secs./.secsper<BR>day#0A..secs..:#3D.secs.REM.s=
ecsperday#0A..mins..:#3D<BR>.secs./.60#0A..secs..:#3D.secs.REM.60#0A..mse=
cs.:#3D<BR>.secs*1000.+.msecs#0A#0A..v!0.:#3D.days#0A..v!1.:#3D<BR>.mins#=
0A..v!2.:#3D.msecs.*.tickspersecond./.1000#0A<BR>..RESULTIS.0#0A}#0A#0A<B=
R><BR>######natbcpl/sysb/dlib.b#<BR>//.This.is.DLIB.(system.dependent.lib=
rary).for.sing<BR>le.threaded#0A//.Cintcode.BCPL#0A#0A//.It.contains.<BR>=
functions.that.have.different.definitions.in.Cintpo<BR>s#0A#0A/*#0AChange=
.log#0A#0A9/11/06#0AChange.treatm<BR>ent.of.RUBOUT.(#23x7F)#0A#0A*/#0A#0A=
SECTION."DLIB"#0A<BR>#0AGET."libhdr"#0A#0AMANIFEST.{#0A..char_bs.#3D.8#0A=
<BR>..buflen..#3D.4096.//.Must.equal.the.block.size#0A}<BR>#0A#0ALET.find=
stream(name,.id,.path).#3D.VALOF.//.M<BR>R.8/5/03#0A{.LET.console.#3D.com=
pstring("**",.name)<BR>#3D0#0A..LET.scb.#3D.?#0A..LET.res.#3D.0#0A..LET.p=
r<BR>efix.#3D.VEC.31#0A#0A//TEST.path#0A//THEN.sawritef(<BR>"DLIB:.findst=
ream(%s,.%n,.%s)*n",.name,.id,.path)#0A<BR>//ELSE.sawritef("DLIB:.findstr=
eam(%s,.%n,.0)*n",.na<BR>me,.id)#0A//sawritef("DLIB:.currentdir#3D%n*n",.=
cur<BR>rentdir)#0A#0A..IF.console.DO#0A..{.IF.id#3Did_insc<BR>b.&amp;.roo=
tnode!rtn_keyboard.RESULTIS.rootnode!rtn_key<BR>board#0A....IF.id#3Did_ou=
tscb.&amp;.rootnode!rtn_screen<BR>..RESULTIS.rootnode!rtn_screen#0A..}.#0=
A#0A..scb.:#3D<BR>.getvec(scb_upb)#0A..UNLESS.scb.RESULTIS.0#0A#0A..F<BR>=
OR.i.#3D.0.TO.scb_upb.DO.scb!i.:#3D.0#0A#0A..scb!sc<BR>b_id......:#3D.id#=
0A..scb!scb_rdfn....:#3D.0#0A..sc<BR>b!scb_wrfn....:#3D.0#0A..scb!scb_end=
fn...:#3D.0#0A#0A<BR>..//.Copy.(truncated).stream.name.into.the.scb#0A..<=
BR>{.LET.len.#3D.name%0#0A....LET.scbname.#3D.@scb!scb<BR>_name#0A....LET=
.maxlen.#3D.scb_maxnamelen#0A....IF.<BR>len&gt;scb_maxnamelen.DO.len.:#3D=
.scb_maxnamelen#0A...<BR>.FOR.i.#3D.1.TO.len.DO.scbname%i.:#3D.name%i#0A.=
...<BR>scbname%0.:#3D.len#0A..}#0A#0A..IF.console.DO#0A..{<BR>.//.Console=
.stream#0A....LET.buf.#3D.getvec(4095/by<BR>tesperword).//.Room.for.4096.=
bytes#0A....UNLESS.buf<BR>.DO.{.freevec(scb);.RESULTIS.0.}#0A....scb!scb_=
type<BR>....:#3D.scbt_console#0A....scb!scb_buf.....:#3D.bu<BR>f#0A....sc=
b!scb_bufend..:#3D.4096#0A#0A....IF.id#3D<BR>id_inscb.DO#0A....{.scb!scb_=
rdfn...:#3D.cnslrdfn.//<BR>.fn.to.replenish.current.buffer#0A......rootno=
de!rt<BR>n_keyboard.:#3D.scb#0A......RESULTIS.scb#0A....}#0A<BR>....IF.id=
#3Did_outscb.DO#0A....{.scb!scb_wrfn...:#3D<BR>.cnslwrfn.//.fn.to.output.=
current.buffer#0A......ro<BR>otnode!rtn_screen.:#3D.scb#0A......RESULTIS.=
scb#0A.<BR>...}#0A....freevec(scb)#0A....RESULTIS.0#0A..}#0A#0A<BR>..spli=
tname(prefix,.':',.name,.1)#0A..IF.compstring<BR>(prefix,."NIL")#3D0.DO#0=
A..{.//.On.reading.always.g<BR>ive.eof#0A....//.On.writing.always.throws.=
away.the.<BR>data#0A....scb!scb_wrfn....:#3D.nilrdfn#0A....scb!s<BR>cb_en=
dfn...:#3D.nilwrfn#0A//sawritef("DLIB:.Opening<BR>.stream.to/from.NIL:*n"=
)#0A....RESULTIS.scb.#0A..}#0A<BR>#0A..IF.compstring(prefix,."TCP")#3D0.|=
.compstring(<BR>prefix,."NET")#3D0.DO#0A..{.sawritef("TCP.connectio<BR>ns=
.not.yet.available*n")#0A....freevec(scb)#0A....R<BR>ESULTIS.0#0A..}#0A#0=
A..//.Open.a.file.stream#0A//sa<BR>writef("DLIB:.%s.must.be.a.file*n",.na=
me)#0A#0A..IF<BR>.id#3Did_inscb....&amp;.fh0findinput...(scb,.name,.path<=
BR>).RESULTIS.scb#0A..IF.id#3Did_outscb...&amp;.fh0findout<BR>put..(scb,.=
name).......RESULTIS.scb#0A..IF.id#3Did_<BR>inoutscb.&amp;.fh0findinoutpu=
t(scb,.name).......RESULTI<BR>S.scb#0A#0A..freevec(scb)#0A..RESULTIS.0#0A=
}#0A#0AA<BR>ND.nilrdfn(scb).#3D.FALSE#0A#0AAND.nilwrfn(scb).#3D<BR>.VALOF=
#0A{.scb!scb_pos.:#3D.0.//.Throw.away.the.buf<BR>fer.contents.(if.any)#0A=
..RESULTIS.TRUE#0A}#0A#0AAN<BR>D.cnslrdfn(scb).#3D.VALOF#0A{.LET.buf,.p.#=
3D.scb!sc<BR>b_buf,.0#0A#0A//sawritef("DLIB:.cnslrdfn:.scb#3D%n*<BR>n",.s=
cb)#0A..{.LET.ch.#3D.sys(Sys_sardch)#0A....SWI<BR>TCHON.ch.INTO#0A....{.D=
EFAULT:..........buf%p.:#3D.<BR>ch#0A........................p.:#3D.p+1#0=
A.........<BR>...............IF.p&lt;4096.LOOP#0A...................<BR>.=
....BREAK#0A#0A......CASE.endstreamch:.IF.p.BREAK#0A<BR>.................=
.......//.No.characters.in.the.buf<BR>fer#0A........................resul=
t2.:#3D.endstrea<BR>mch.//.#3D-1#0A........................RESULTIS.FAL<B=
R>SE#0A#0A......CASE.'*n':........buf%p.:#3D.ch#0A...<BR>................=
.....p.:#3D.p+1#0A.................<BR>.......BREAK#0A#0A......CASE.#23x7=
F:........//.Rubo<BR>ut#0A........................sys(Sys_sawrch,.char_b<=
BR>s)#0A........................sys(Sys_sawrch,.'.')..<BR>...//.MR.9/11/0=
6#0A........................sys(Sys_<BR>sawrch,.char_bs)#0A......CASE.cha=
r_bs:.....IF.p&gt;0.D<BR>O.p.:#3D.p-1#0A........................sys(Sys_s=
awr<BR>ch,.'.')#0A........................sys(Sys_sawrch,.<BR>char_bs)#0A=
........................LOOP#0A....}#0A.<BR>.}.REPEAT#0A//sawritef("DLIB:=
.cnslrdfn:.line.read*n<BR>")#0A//FOR.i.#3D.0.TO.p-1.DO.sawrch(buf%i)#0A..=
scb!<BR>scb_pos,.scb!scb_end.:#3D.0,.p#0A..RESULTIS.TRUE#0A<BR>}#0A#0AAND=
.cnslwrfn(scb).#3D.VALOF#0A{.LET.buf.#3D.<BR>scb!scb_buf#0A//sawritef("DL=
IB:.cnslwrfn(%n).called<BR>*n",.scb)#0A//sawritef("DLIB:.cnslwrfn:.buf#3D=
%n.po<BR>s#3D%n.end#3D%n*n",#0A//..........scb!scb_buf,.scb!<BR>scb_pos,.=
scb!scb_end)#0A#0A..FOR.i.#3D.0.TO.scb!scb<BR>_pos-1.DO.sys(Sys_sawrch,.b=
uf%i)#0A..scb!scb_pos.:#3D<BR>.0#0A..scb!scb_end.:#3D.0..//.No.valid.data=
#0A..RES<BR>ULTIS.TRUE#0A}#0A#0AAND.flush().#3D.VALOF#0A{.IF.co<BR>s#3D0.=
|.cos!scb_id~#3Did_outscb.DO.abort(187)#0A..R<BR>ESULTIS.fh0wrfn(cos)#0A}=
..#0A#0AAND.getremipaddr(sc<BR>b).#3D.VALOF#0A{#0Asawritef("DLIB:.getremi=
paddr.not<BR>.yet.available*n")#0ARESULTIS.0#0A...UNLESS.scb!scb<BR>_type=
#3Dscbt_tcp.|.scb!scb_type#3Dscbt_net.DO#0A..{<BR>.result2.:#3D.0#0A....R=
ESULTIS.0#0A..}#0A..RESULTIS<BR>.0.//sendpkt(-1,.scb!scb_task,.Action_get=
remipaddr,<BR>.0,0,.scb)#0A}#0A#0AAND.relfilename(name).#3D.VALOF<BR>#0A{=
.//.Absolute.file.names.are.(eg):#0A..//.."/abc<BR>"...."\xyz"..."pqr:vuw=
"#0A..LET.len.#3D.name%0#0A..<BR>UNLESS.len.RESULTIS.TRUE#0A..IF.name%1#3=
D'/'.|.name<BR>%1#3D'\'.RESULTIS.FALSE#0A..FOR.i.#3D.1.TO.len.IF.n<BR>ame=
%i#3D':'.RESULTIS.FALSE#0A..RESULTIS.TRUE#0A}#0A<BR>#0AAND.trfilename(nam=
e,.filename).BE#0A{.LET.p.#3D.<BR>0#0A#0A//IF.currentdir.DO#0A//...sawrit=
ef("DLIB:.tr<BR>filename:.name#3D%s.currentdir#3D%n*n",.name,.curre<BR>nt=
dir)#0A#0A..IF.currentdir.&amp;.relfilename(name).DO#0A<BR>..{.LET.len.#3=
D.currentdir%0#0A....LET.lastch.#3D.c<BR>urrentdir%len#0A....IF.lastch#3D=
'/'.|.lastch#3D':'.<BR>DO.len.:#3D.len-1#0A....IF.len.DO#0A....{.FOR.i.#3=
D<BR>.1.TO.len.DO.{.p.:#3D..p+1;.filename%p.:#3D.current<BR>dir%i.}#0A...=
...p.:#3D.p+1#0A......filename%p.:#3D.<BR>'/'#0A....}#0A..}#0A..FOR.i.#3D=
.1.TO.name%0.DO.{.p.<BR>:#3D..p+1;.filename%p.:#3D.name%i.}#0A..filename%=
0.<BR>:#3D.p#0A..FOR.i.#3D.1.TO.p.IF.filename%i#3D':'.DO.<BR>filename%i.:=
#3D.'/'#0A//TEST.currentdir#0A//THEN.sa<BR>writef("DLIB:.trfilename.%s.%s=
.#3D&gt;.%s*n",.currentd<BR>ir,.name,.filename)#0A//ELSE.sawritef("DLIB:.=
trfile<BR>name.%s.#3D&gt;.%s*n",.name,.filename)#0A}#0A#0AAND.fh<BR>0find=
input(scb,.name,.path).#3D.VALOF#0A//.Returns.<BR>TRUE...if.successful#0A=
//.Returns.FALSE,.result2#3D<BR>100..Can't.open.file#0A//................=
result2#3D<BR>101..Can't.allocate.buffer#0A{.LET.fp,.buf.#3D.0,.0<BR>#0A.=
.LET.filesize.#3D.0#0A..LET.filename.#3D.VEC.50<BR>#0A..trfilename(name,.=
filename)#0A#0A//sawritef("DL<BR>IB:.fh0findinput.calling.sys_openread.%s=
.%s*n",#0A/<BR>/..........filename,.path-&gt;path,"null")#0A..//.Open<BR>=
.the.file.for.input#0A..fp.:#3D.sys(Sys_openread,.f<BR>ilename,.path)..//=
.MR.8/5/03#0A..UNLESS.fp.DO#0A..{<BR>#0A//sawritef("DLIB:.fh0findinput.sy=
s_openread.%s.f<BR>ailed*n",.filename)#0A....result2.:#3D.100#0A....RE<BR=
>SULTIS.FALSE#0A..}#0A#0A//sawritef("DLIB:.%s.opened<BR>*n",.filename)#0A=
..filesize.:#3Dsys(Sys_filesize,.f<BR>p)#0A//sawritef("DLIB:.filesize#3D%=
n*n",.filesize)#0A<BR>#0A..//.allocate.a.buffer#0A..buf.:#3D.getvec(bufle=
<BR>n/bytesperword)#0A..UNLESS.buf.DO#0A..{.sys(Sys_clo<BR>se,.fp).//.Fir=
st.close.the.file#0A....result2.:#3D.<BR>101#0A....RESULTIS.0#0A..}#0A//s=
awritef("DLIB:.fh0f<BR>indinput.scb.%n.fp.%n.buf.%n*n",.scb,.fp,.buf)#0A.=
.<BR>..#0A..scb!scb_type....:#3D.scbt_file#0A..scb!scb_t<BR>ask....:#3D.0=
#0A..scb!scb_buf.....:#3D.buf#0A..scb!<BR>scb_rdfn....:#3D.fh0rdfn#0A..sc=
b!scb_wrfn....:#3D.0<BR>.......//.An.input.stream.cannot.be.depleted#0A..=
sc<BR>b!scb_endfn...:#3D.fh0endfn#0A..scb!scb_fd......:#3D<BR>.fp#0A..scb=
!scb_bufend..:#3D.buflen#0A..scb!scb_wri<BR>te...:#3D.FALSE...//.No.data.=
waiting.to.be.written#0A<BR>..scb!scb_blength.:#3D.buflen..//.MR.15/3/02#=
0A..sc<BR>b!scb_block...:#3D.0.......//.MR.29/7/02#0A..scb!sc<BR>b_lblock=
..:#3D.filesize/buflen.//+.1..//.MR.16/4/02<BR>.MR.29/7/02#0A..scb!scb_ld=
ata...:#3D.filesize.REM.b<BR>uflen..//.MR.16/4/02#0A//sawritef("fh0findin=
put:.lb<BR>lock#3D%n*n",.scb!scb_lblock)#0A#0A..//.Initialise.<BR>the.buf=
fer.by.reading.the.first.block#0A..fh0getbuf<BR>(scb)#0A..RESULTIS.scb#0A=
}#0A#0AAND.fh0findoutput(s<BR>cb,.name).#3D.VALOF#0A//.Returns.TRUE...if.=
successf<BR>ul#0A//.Returns.FALSE,.result2#3D100..Can't.open.fi<BR>le#0A/=
/................result2#3D101..Can't.allocat<BR>e.buffer#0A{.LET.fp,.buf=
.#3D.0,.0#0A..LET.filename.<BR>#3D.VEC.50#0A..trfilename(name,.filename)#=
0A#0A..//<BR>.Open.the.file.for.output#0A..fp.:#3D.sys(Sys_openw<BR>rite,=
.filename)#0A..UNLESS.fp.DO#0A..{.result2.:#3D<BR>.100#0A....RESULTIS.FAL=
SE#0A..}#0A#0A..//.allocate.<BR>a.buffer#0A..buf.:#3D.getvec(buflen/bytes=
perword)#0A<BR>..UNLESS.buf.DO#0A..{.sys(Sys_close,.fp).//.First.c<BR>los=
e.the.file#0A....result2.:#3D.101#0A....RESULTIS<BR>.FALSE#0A..}#0A#0A//s=
awritef("DLIB:.fh0findoutput.s<BR>cb.%n..%n..buf.%n*n",.scb,.fp,.buf)#0A#=
0A..scb!scb_<BR>type....:#3D.scbt_file#0A..scb!scb_task....:#3D.0#0A<BR>.=
.scb!scb_buf.....:#3D.buf#0A..scb!scb_rdfn....:#3D<BR>.0.......//.Can't.r=
eplenish.output.streams#0A..scb!<BR>scb_wrfn....:#3D.fh0wrfn#0A..scb!scb_=
endfn...:#3D.f<BR>h0endfn#0A..scb!scb_fd......:#3D.fp#0A..scb!scb_buf<BR>=
end..:#3D.buflen#0A..scb!scb_write...:#3D.FALSE.../<BR>/.No.data.waiting.=
to.be.written#0A..scb!scb_blength<BR>.:#3D.buflen#0A..scb!scb_block...:#3=
D.0.......//.MR<BR>.29/7/02#0A..scb!scb_lblock..:#3D.0.......//.This.i<BR=
>s.an.empty.file.currently,.MR.29/7/02#0A..scb!scb_l<BR>data...:#3D.0#0A/=
/sawritef("fh0findoutput:.lblock#3D<BR>%n*n",.scb!scb_lblock)#0A#0A..scb!=
scb_pos.....:#3D.<BR>0.......//.The.buffer.has.no.valid.data.initially#0A=
<BR>..scb!scb_end.....:#3D.0#0A#0A..result2.:#3D.0#0A..<BR>RESULTIS.TRUE#=
0A}#0A#0AAND.fh0findinoutput(scb,.nam<BR>e).#3D.VALOF#0A//.Returns.TRUE..=
.if.successful#0A//<BR>.Returns.FALSE,.result2#3D100..Can't.open.file#0A/=
/<BR>................result2#3D101..Can't.allocate.buffe<BR>r#0A{.LET.fp,=
.buf,.res1,.res2.#3D.0,.0,.1,.0#0A..LE<BR>T.filesize.#3D.0#0A..LET.filena=
me.#3D.VEC.50#0A..tr<BR>filename(name,.filename)#0A#0A..//.open.the.file.=
fo<BR>r.input.and.output#0A..fp.:#3D.sys(Sys_openreadwrit<BR>e,.filename)=
#0A//sawritef("DLIB:.open.%s.in.inout.m<BR>ode.#3D&gt;.%n*n",.filename,.f=
p)#0A..UNLESS.fp.DO#0A..<BR>{.result2.:#3D.100#0A....RESULTIS.FALSE#0A..}=
#0A#0A<BR>..filesize.:#3Dsys(Sys_filesize,.fp)#0A//sawritef("<BR>BLIB:.fi=
lesize#3D%n*n",.filesize)#0A#0A..//.allocat<BR>e.a.buffer#0A..buf.:#3D.ge=
tvec(buflen/bytesperword)<BR>#0A..UNLESS.buf.DO#0A..{.sys(Sys_close,.fp).=
//.Firs<BR>t.close.the.file#0A....result2.:#3D.101#0A....RESUL<BR>TIS.FAL=
SE#0A..}#0A//sawritef("DLIB:.buflen.#3D.%n*n<BR>",.buflen)#0A//sawritef("=
DLIB:.fh0findinoutput.scb.<BR>%n..%n..buf.%n*n",.scb,.fp,.buf)#0A#0A..scb=
!scb_typ<BR>e....:#3D.scbt_file#0A..scb!scb_buf.....:#3D.buf#0A<BR>..scb!=
scb_rdfn....:#3D.fh0rdfn#0A..scb!scb_wrfn....<BR>:#3D.fh0wrfn#0A..scb!scb=
_endfn...:#3D.fh0endfn#0A..<BR>scb!scb_fd......:#3D.fp#0A..scb!scb_bufend=
..:#3D.bu<BR>flen#0A..scb!scb_write...:#3D.FALSE...//.No.data.wa<BR>iting=
.to.be.written#0A..scb!scb_blength.:#3D.buflen<BR>..//.MR.15/3/02#0A..scb=
!scb_block...:#3D.0.//1.MR.2<BR>9/7/02#0A..scb!scb_lblock..:#3D.filesize/=
buflen.//+<BR>.1..//.MR.16/4/02.MR.29/7/02#0A..scb!scb_ldata...:#3D<BR>.f=
ilesize.REM.buflen..//.MR.16/4/02#0A//sawritef("f<BR>h0findinoutput:.lblo=
ck#3D%n*n",.scb!scb_lblock)#0A#0A<BR>..//.Initialise.the.buffer.by.readin=
g.the.first.blo<BR>ck#0A..UNLESS.fh0getbuf(scb).DO#0A..{.//.Failed.to.<BR=
>fill.the.buffer.with.data#0A....sawritef("DLIB:.fh0<BR>getbuf(%n).failed=
*n",.scb)#0A....RESULTIS.FALSE#0A.<BR>.}#0A..res2.:#3D.result2#0A..RESULT=
IS.TRUE#0A}#0A#0A<BR>AND.fh0falsefn(scb)..#3D.FALSE#0A#0A#0AAND.fh0rdfn(<=
BR>scb)..#3D.VALOF#0A//.This.is.only.used.for.disc.fil<BR>es#2E.The.field=
.end.will.equal#0A//.buflen.for.all.<BR>blocks.except.possibly.the.last.o=
ne#2E#0A//.If.the.<BR>buffer.contains.data.from.the.last.block.and.pos#3D=
<BR>end,#0A//.then.EOF.has.been.reached#2E.If.pos#3Dend<BR>.data.from.the=
.next.block#0A//.must.be.read#2E.But.<BR>the.current.block.will.first.hav=
e.to.be#0A//.writte<BR>n.to.disc,.if.the.write.field.is.TRUE#2E#0A//.Retu=
r<BR>ns.TRUE,..if.successful#2E.There.will.be.valid.data<BR>.between#0A//=
................pos.and.end.in.the.buf<BR>fer#2E#0A//.Returns.FALSE,.resu=
lt2#3D-1.on.EOF#0A//<BR>.........FALSE,.result2#3Derrorcode,.otherwise#2E=
#0A<BR>{.LET.block,.lblock.#3D.scb!scb_block,.scb!scb_lblo<BR>ck#0A..LET.=
pos,...end....#3D.scb!scb_pos,...scb!scb<BR>_end#0A//sawritef("DLIB:.fh0r=
eadfn.scb.%n.pos.%n.en<BR>d.%n*n",.scb,.pos,.end)#0A//sawritef("DLIB:.fh0=
read<BR>fn.block.%n.lblock.%n*n",.block,.lblock)#0A..IF.pos<BR>&lt;end...=
...RESULTIS.TRUE..//.Data.still.available.in<BR>.current.buffer#0A..IF.bl=
ock#3Dlblock.DO.{.result2.<BR>:#3D.-1;.RESULTIS.FALSE.}.//.End-of-file#0A=
#0A..IF.<BR>scb!scb_write.DO.fh0putbuf(scb)..//.Write.block.if.<BR>necess=
ary#0A#0A..IF.end&gt;#3Dbuflen.DO.block.:#3D.blo<BR>ck+1..//.Advance.bloc=
k.if.necessary#0A..scb!scb_blo<BR>ck,.scb!scb_pos.:#3D.block,.0#0A//sawri=
tef("DLIB:.f<BR>h0rdfn.block.%n.pos.%n.end.%n*n",.scb!scb_block,.po<BR>s,=
.end)#0A#0A..UNLESS.fh0getbuf(scb).DO#0A..{.sawri<BR>tef("DLIB:.fh0getbuf=
(%n).failed*n",.scb)#0A....RESU<BR>LTIS.FALSE..//.Read.data.into.the.buff=
er#0A..}#0A#0A<BR>..//.Safety.check#0A..end.:#3D.scb!scb_end#0A..UNLE<BR>=
SS.end#3Dbuflen.|.lblock.#3D.scb!scb_block.DO#0A..{<BR>.sawritef("DLIB:.f=
h0rdfn.block#3D%n.lblock#3D%n.pos<BR>#3D%n.end#3D%n*n",#0A..............s=
cb!scb_block,.l<BR>block,.scb!scb_pos,.end)#0A....abort(9999)#0A..}#0A<BR=
>..#0A..RESULTIS.TRUE..............//.The.buffer.is.<BR>not.empty#0A}..#0=
A...#0AAND.fh0wrfn(scb).#3D.VALOF#0A<BR>//.Write.the.current.buffer.to.fi=
le,.if.the.write.f<BR>lag.is.set#0A//.Return.TRUE,.if.successful#0A//.Ret=
<BR>urn.FALSE.otherwise#2E#0A{.LET.block,.lblock.#3D.sc<BR>b!scb_block,.s=
cb!scb_lblock#0A..LET.pos,.end.#3D.sc<BR>b!scb_pos,.scb!scb_end#0A..LET.l=
en.#3D.?#0A//sawrit<BR>ef("DLIB:.fh0wrfn.scb.%n.pos.%n.end.%n*n",.scb,.po=
s<BR>,.end)#0A//sawritef("DLIB:.fh0wrfn.block.%n.lblock.<BR>%n*n",.block,=
.lblock)#0A..IF.scb!scb_write.DO.//.Wr<BR>ite.current.block.if.necessary#=
0A....UNLESS.fh0putb<BR>uf(scb).RESULTIS.FALSE#0A#0A//..IF.pos&lt;scb!scb=
_bufe<BR>nd.DO#0A//sawritef("DLIB:.return0.from.fh0wrfn.bloc<BR>k#3D%n.lb=
lock#3D%n.pos#3D%n.end#3D%n*n",#0A//......<BR>....scb!scb_block,.scb!scb_=
lblock,.pos,.end)#0A#0A.<BR>.IF.pos.&lt;.scb!scb_bufend.RESULTIS.TRUE..//=
.Still.ro<BR>om.in.the.buffer#0A..//.Move.to.next.block#0A..bloc<BR>k.:#3=
D.block+1#0A..scb!scb_block,.scb!scb_pos,.scb!<BR>scb_end.:#3D.block,.0,.=
0#0A..IF.block&gt;lblock.DO#0A.<BR>.{.scb!scb_lblock.:#3D.block....//.Las=
t.block.is.em<BR>pty#0A//sawritef("DLIB:.return1.from.fh0wrfn.block#3D<BR=
>%n.lblock#3D%n.pos#3D%n.end#3D%n*n",#0A//..........<BR>scb!scb_block,.sc=
b!scb_lblock,.pos,.end)#0A....RESU<BR>LTIS.TRUE#0A..}#0A#0A..IF.scb!scb_i=
d#3Did_inoutscb.<BR>UNLESS.fh0getbuf(scb).DO#0A..{.sawritef("DLIB:.fh0w<B=
R>rfn.getbuf.failed.block#3D%n.lblock#3D%n.pos#3D%n.e<BR>nd#3D%n*n",#0A..=
............scb!scb_block,.scb!scb_<BR>lblock,.pos,.end)#0A....abort(1102=
)#0A..}#0A#0A//sa<BR>writef("DLIB:.return2.from.fh0wrfn.block#3D%n.lbloc<=
BR>k#3D%n.pos#3D%n.end#3D%n*n",#0A//..........scb!scb_<BR>block,.scb!scb_=
lblock,.pos,.end)#0A#0A..RESULTIS.TR<BR>UE#0A}..#0A#0A...#0AAND.fh0endfn(=
scb).#3D.VALOF#0A/<BR>/.Write.the.buffer,.if.necessary,.and.free.it#2E#0A=
<BR>//.Close.the.file#2E#0A//.Return.TRUE,.if.successfu<BR>l#0A//.Return.=
FALSE.otherwise#2E#0A{#0A//sawritef("<BR>DLIB:.fh0endfn.scb.%n,.write.fla=
g#3D%n*n",.scb,.scb<BR>!scb_write)#0A//sawritef("DLIB:.fh0endfn.pos#3D%n.=
e<BR>nd#3D%n*n",.scb!scb_pos,.scb!scb_end)#0A..IF.scb!sc<BR>b_write.UNLES=
S.fh0putbuf(scb).RESULTIS.FALSE#0A//sa<BR>writef("DLIB:.fh0endfn.freeing.=
buf#3D%n*n",.scb!scb<BR>_buf)#0A..freevec(scb!scb_buf)#0A..RESULTIS.sys(S=
ys<BR>_close,.scb!scb_fd)#0A}#0A#0A//.Result.TRUE:.posv.c<BR>ontains.the.=
stream.block.and.pos#0A//.......FALSE:.<BR>scb.was.not.a.file.or.RAM.stre=
am#0AAND.note(scb,.po<BR>sv).#3D.VALOF#0A{.LET.type.#3D.scb!scb_type#0A..=
UNL<BR>ESS.type#3Dscbt_file.|.type#3Dscbt_ram.RESULTIS.FAL<BR>SE#0A..posv=
!0.:#3D.scb!scb_block#0A..posv!1.:#3D.sc<BR>b!scb_pos#0A//sawritef("DLIB:=
.note.#3D&gt;.%n.%n*n",.p<BR>osv!0,.posv!1)#0A..RESULTIS.TRUE#0A}#0A#0A//=
.Set.th<BR>e.stream.position.to.that.specified.in.posv#2E..If.<BR>the#0A/=
/.new.position.is.in.a.different.block.the.b<BR>uffer.may.have.to#0A//.be=
.written.out.and.new.data.<BR>read.in#2E#0A//.It.returns.TRUE.if.successf=
ul,.even<BR>.if.positioned.just.after.the#0A//.last.block.of.th<BR>e.file=
,.ie.block#3Dlblock+1.and.pos#3Dend#3D0#2E#0A<BR>//.It.returns.FALSE,.oth=
erwise#2E.Possibly.because.<BR>the.stream.is.not#0A//.pointable.or.the.po=
sv.is.out<BR>.of.range#2E#0AAND.point(scb,.posv).#3D.VALOF#0A{.L<BR>ET.bl=
kno..#3D.posv!0#0A..LET.pos....#3D.posv!1#0A..<BR>LET.id.....#3D.scb!scb_=
id#0A..LET.block..#3D.scb!sc<BR>b_block...//.Current.block.number#0A..LET=
.lblock.#3D<BR>.scb!scb_lblock..//.Last.block.number.of.the.stream<BR>#0A=
..LET.end....#3D.scb!scb_end#0A..LET.type...#3D.<BR>scb!scb_type#0A//sawr=
itef("DLIB:.point.posv!0#3D%n.<BR>posv!1#3D%n*n",.posv!0,.posv!1)#0A#0A//=
sawritef("DL<BR>IB:.point.block#3D%n.lblock#3D%n.blkno#3D%n.pos#3D%<BR>n.=
end#3D%n*n",#0A//...............block,.lblock,..b<BR>lkno,.pos,.end)#0A#0=
A...//.The.stream.must.be.a.rea<BR>dable.disc.or.RAM.file#0A..UNLESS.(typ=
e#3Dscbt_file<BR>.|.type#3Dscbt_ram).&amp;#0A.........(id#3Did_inscb.|.i<=
BR>d#3Did_inoutscb).RESULTIS.FALSE#0A#0A..IF.pos#3D0.&amp;<BR>.blkno#3Dlb=
lock+1.DO.blkno,.pos.:#3D.lblock,.buflen<BR>#0A.#0A//sawritef("DLIB:.poin=
t.block#3D%n.lblock#3D<BR>%n.blkno#3D%n.pos#3D%n.end#3D%n*n",#0A//.......=
....<BR>....block,.lblock,..blkno,.pos,.end)#0A#0A//..IF.bl<BR>kno&lt;#3D=
0.DO.blkno,.pos.:#3D.0,.0.//.Cannot.position<BR>.before.start.of.file#0A#=
0A..//.Safety.check#0A..//<BR>.Make.sure.the.position.is.within.the.file#=
0A..IF.b<BR>lkno&lt;0.|.#0A.....blkno&gt;lblock.|#0A.....blkno#3Dlblo<BR>=
ck.&amp;.pos.&gt;.(block#3Dlblock.-&gt;.end,.scb!scb_ldata)..<BR>DO#0A..{=
.sawritef("DLIB:.point.beyond.end.of.file,.<BR>blkno#3D%n.pos#3D%n*n",.bl=
kno,.pos)#0A....sawritef(<BR>"block#3D%n.end#3D%n.lblock#3D%n.posv#3D(%n,=
%n)*n",<BR>#0A..............block,.end,.lblock,.posv!0,.posv!1<BR>)#0A...=
.abort(999)#0A....RESULTIS.FALSE#0A..}#0A#0A<BR>..IF.blkno#3Dblock.DO#0A.=
.{.//.The.new.position.is.<BR>in.the.current.block#0A....scb!scb_block.:#=
3D.blkno<BR>#0A....scb!scb_pos...:#3D.pos#0A//sawritef("DLIB:.p<BR>oint.s=
etting.scb.block#3D%n.pos#3D%n*n",.blkno,.pos<BR>)#0A....RESULTIS.TRUE.//=
.Success#0A..}#0A#0A..//.Th<BR>e.move.is.to.a.different.block,.so.must.re=
ad.a.bloc<BR>k#0A..//.but.first.check.if.the.current.block.must.<BR>be.wr=
itten#0A..IF.scb!scb_write.DO#0A..{.//sawritef<BR>("DLIB:.point.write.blo=
ck.%n*n",.scb!scb_block).#0A<BR>....UNLESS.fh0putbuf(scb).DO.abort(5003)#=
0A..}#0A#0A<BR>..scb!scb_block.:#3D.blkno..//.Set.the.new.position<BR>#0A=
.#0A//sawritef("DLIB:.point.read.block.%n*n",.bl<BR>kno)#0A#0A..UNLESS.fh=
0getbuf(scb).DO#0A..{.sawritef<BR>("DLIB:.point.fh0getbuf.failed.block.%n=
.#3D&gt;.%n*n",<BR>.blkno,.end)#0A....abort(5004)#0A....RESULTIS.FALSE<BR=
>#0A..}#0A#0A..//.Safety.check#0A..UNLESS.scb!scb_en<BR>d#3Dbuflen.|#0A..=
.......blkno#3Dlblock.&amp;.end&gt;#3Dscb<BR>!scb_ldata.DO#0A..{.sawritef=
("DLIB.point:.safety.ch<BR>eck.failed*n")#0A....sawritef("DLIB.point:.blk=
no.%n<BR>.pos.%n*n",.blkno,.pos)#0A....sawritef("DLIB.point:<BR>.end.%n.b=
uflen.%n*n",.scb!scb_end,.buflen)#0A....sa<BR>writef("DLIB.point:.block.%=
n.lblock.%n*n",.blkno,.l<BR>block)#0A....sawritef("DLIB.point:.end.%n.lda=
ta.%n*<BR>n",.end,.scb!scb_ldata)#0A....abort(5005)#0A..}#0A#0A<BR>..scb!=
scb_pos...:#3D.pos..//.Set.the.desired.offset<BR>#0A#0A//sawritef("DLIB:.=
point(#2E#2E).#3D&gt;.TRUE,.bl<BR>kno.%n.pos.%n*n",.blkno,.pos)#0A..RESUL=
TIS.TRUE#0A}<BR>#0A#0AAND.fh0putbuf(scb).#3D.VALOF#0A//.This.is.onl<BR>y.=
used.on.disc.file.streams.and.is.only.called.when<BR>#0A//.the.write.fiel=
d.is.TRUE#2E.It.writes.the.buff<BR>er.to.file#2E#0A//.The.file.is.positio=
ned.before.th<BR>e.write#2E.If.the.last.block#0A//.is.being.written.<BR>l=
data.is.set.to.end.and.this.number.of.bytes.writte<BR>n#0A//.to.disc#2E.(=
For.all.other.blocks.end#3Dbufle<BR>n#2E)#0A//.Returns.TRUE,.if.successfu=
l,.having.set.<BR>the.write.field.to.FALSE#2E#0A//.Returns.FALSE,.oth<BR>=
erwise#2E#0A{.LET.end....#3D.scb!scb_end....//.Numb<BR>er.of.bytes.of.val=
id.data.in.buf#0A..LET.block..#3D<BR>.scb!scb_block#0A..LET.fd.....#3D.sc=
b!scb_fd#0A..LE<BR>T.offset.#3D.buflen*block...//.File.offset.of.buffe<BR=
>r's.first.byte.MR.29/7/02#0A#0A..IF.end&lt;#3D0.DO#0A.<BR>.{.//.Nothing.=
in.the.buffer.to.write,.probably.a.mi<BR>stake#2E#0A....//sawritef("DLIB:=
.fh0putbuf,.end#3D%<BR>n*n",.end)#0A....scb!scb_write.:#3D.FALSE#0A....RE=
S<BR>ULTIS.TRUE#0A..}#0A#0A..//.The.size.of.a.file.can.o<BR>nly.change.wh=
en.writing.its.last.block#0A..//.so.ld<BR>ata.only.needs.correcting.when.=
this.happens#0A..IF.<BR>block.#3D.scb!scb_lblock.DO.scb!scb_ldata.:#3D.en=
d#0A<BR>#0A//sawritef("DLIB:.putbuf.seeking.offset.%n.(bloc<BR>k.%n)*n",.=
offset,.block)#0A..UNLESS.sys(Sys_seek,.f<BR>d,.offset).RESULTIS.FALSE#0A=
#0A//sawritef("DLIB:.pu<BR>tbuf.write.%n.bytes.at.offset.%n*n",.end,.offs=
et)#0A<BR>..IF.sys(Sys_write,.fd,.scb!scb_buf,.end).&lt;.0#0A...<BR>.RESU=
LTIS.FALSE#0A..scb!scb_write.:#3D.FALSE.//.The<BR>.buffer.has.been.writte=
n.successfully#0A..RESULTIS.<BR>TRUE#0A}#0A#0A//.fh0getbuf.reads.a.block.=
into.the.s<BR>cb's.buffer#2E#0A//.Returns.TRUE.if.successful#0A//<BR>....=
..having.set.pos#3D0.and.end.to.the.end.of.vali<BR>d.data#0A//.Returns.FA=
LSE,.otherwise#2E#0A#0AAND.fh<BR>0getbuf(scb).#3D.VALOF#0A{.LET.fd......#=
3D.scb!scb_<BR>fd#0A..LET.block...#3D.scb!scb_block#0A..LET.offset<BR>..#=
3D.buflen*block....//.MR.29/7/02#0A..LET.end....<BR>.#3D.?.#0A#0A//sawrit=
ef("DLIB:.fh0getbuf.seeking.st<BR>art.of.block.%n.(offset.%n)*n",#0A//...=
.........blo<BR>ck,.offset)#0A..UNLESS.sys(Sys_seek,.fd,.offset).RE<BR>SU=
LTIS.FALSE#0A//sawritef("DLIB:.fh0getbuf.file.pos<BR>ition.now.%n*n",.sys=
(Sys_tell,.fd))#0A#0A//sawritef<BR>("DLIB:.fh0getbuf.reading.block.%n.off=
set#3D%n*n",.<BR>block,.offset)#0A..end.:#3D.sys(Sys_read,.fd,.scb!s<BR>c=
b_buf,.buflen)#0A//sawritef("DLIB:.fh0getbuf.read.<BR>#3D&gt;.%n*n",.end)=
#0A//sawritef("DLIB:.fh0getbuf.bloc<BR>k#3D%n.lblock#3D%n.ldata#3D%n*n",#=
0A//.............<BR>..block,.scb!scb_lblock,.scb!scb_ldata)#0A..IF.end&l=
t;<BR>0.RESULTIS.FALSE.//.Unable.to.read#0A..scb!scb_pos,<BR>.scb!scb_end=
.:#3D.0,.end.#0A..RESULTIS.TRUE#0A}#0A#0A<BR>#0A<BR><BR>######natbcpl/sys=
c/clib.c#<BR>/*#0A**.This.is.CLIB.for.BCPL.compiled.into.native.<BR>code#=
0A**#0A**.It.is.based.on.cintsys#2Ec.from.the.<BR>BCPL.Cintcode.system.an=
d.is#0A**.meant.to.run.on.mo<BR>st.machines.with.a.Unix-like.C.libraries#=
2E#0A**#0A<BR>**.(c).Copyright:..Martin.Richards..4.September.200<BR>9#0A=
**#0A*/#0A#0A//.Test.this.sort.of.comment#2E#0A<BR>#0A/*#0AChange.History=
#0A#0A04/09/09#0AStarted.to.m<BR>ake.changes.for.the.Vax.under.VMS#0A#0A1=
0/04/06#0AM<BR>ade.change.to.natbcpl.to.make.rdch.read.the.command<BR>.ar=
gument.characters.before#0Areading.from.stdin,.f<BR>or.compatibility.with=
.cintsys#2E#0A#0A21/04/04#0AMa<BR>de.many.changes.and.improvements.sugges=
ted.by.Colin<BR>.Liebenrood#0A#0A07/11/96#0ASystematic.changes.to.a<BR>ll=
ow.64.bit.implementation.on.the.ALPHA#0A#0A23/07/<BR>96#0AFirst.implement=
ation#0A*/#0A#0A#23include.&lt;std<BR>io#2Eh&gt;#0A#23include.&lt;stdlib#=
2Eh&gt;#0A#23include.&lt;sig<BR>nal#2Eh&gt;#0A#23include.&lt;string#2Eh&g=
t;#0A#0A#23if.defin<BR>ed(forVmsItanium).||.defined(forVmsVax)#0A#23inclu=
d<BR>e.&lt;timeb#2Eh&gt;#0A#23else#0A#23include.&lt;sys/timeb#2Eh<BR>&gt;=
#0A#23endif#0A#0A/*.bcpl#2Eh.contains.machine/syst<BR>em.dependent.#23def=
ines..*/#0A#23include."bcpl#2Eh"<BR>#0A#0Astatic.BCPLWORD.result2;#0Astat=
ic.BCPLWORD.pr<BR>efix;#0ABCPLWORD.rootnode[Rtn_upb+1];#0Astatic.char<BR>=
.*parms;../*.vector.of.command-line.arguments.*/#0A<BR>static.int..parmp#=
3D1;./*.subscript.of.next.command<BR>-line.character#2E.*/#0Astatic.int..=
ttyinp;../*.#3D<BR>1.if.stdin.is.a.tty,.#3D0.otherwise.*/#0A#0A/*.prot<BR=
>otypes.for.forward.references.*/#0Astatic.BCPLWORD.<BR>muldiv(BCPLWORD.a=
,.BCPLWORD.b,.BCPLWORD.c);#0Astati<BR>c.char.*b2c_fname(BCPLWORD.bstr,.ch=
ar.*cstr);#0Asta<BR>tic.char.*vmsfname(char.*name,.char.*vaxname);#0Ast<B=
R>atic.char.*b2c_str(BCPLWORD.bstr,.char.*cstr);#0Ast<BR>atic.BCPLWORD.c2=
b_str(char.*cstr,.BCPLWORD.bstr);#0A<BR>#0A/*.Function.normally.defined.i=
n.graphics#2Ec..*/<BR>#0Aextern.BCPLWORD.sysGraphics(BCPLWORD.*p);#0ABCPL=
<BR>WORD.sysGraphics(BCPLWORD.*p).{.return.0;.}./*.Dumm<BR>y.definition.*=
/#0A#0A/*.Function.defined.in.mlib#2E<BR>mar.*/#0ABCPLWORD.callstart(BCPL=
WORD.*p,.BCPLWORD.*<BR>g);#0A#0A#23define.Globword......0x8F8F0000L#0A#23=
d<BR>efine.Gn_result2....10#0A#0Aint.badimplementation(v<BR>oid)#0A{.int.=
bad.#3D.0;#0A..int.A#3D'A';#0A..SIGNED<BR>CHAR.c.#3D.(SIGNEDCHAR)255;#0A.=
.if(sizeof(BCPLWORD)<BR>!#3D(1&lt;&lt;B2Wsh)).{#0A.......PRINTF("Size.of.=
a.BCPL.w<BR>ord.is.not.%d\n",.1&lt;&lt;B2Wsh);#0A.......bad.#3D.1;#0A<BR>=
..}#0A..if(A!#3D65).{#0A.......PRINTF("Character.se<BR>t.is.not.ASCII\n")=
;#0A.......bad.#3D.1;#0A..}#0A..i<BR>f.(c/-1.!#3D.1).{#0A....PRINTF("Ther=
e.is.a.problem.<BR>with.SIGNEDCHAR\n");#0A....bad.#3D.1;#0A..}#0A..ret<BR=
>urn.bad;#0A}#0A#0Avoid.initfpvec(void)....{.return;<BR>.}#0ABCPLWORD.new=
fno(FILE.*fp)...{.return.WD.fp;.}#0A<BR>BCPLWORD.freefno(BCPLWORD.fno).{.=
return.fno;.}#0AFI<BR>LE.*findfp(BCPLWORD.fno)..{.return.(FILE.*)fno;.}#0=
A<BR>#0A/*.storage.for.SIGINT.handler.*/#0Avoid.(*old_ha<BR>ndler)(int);#=
0A#0Avoid.handler(int.sig)#0A{.#0A..pr<BR>intf("SIGINT.received\n");#0A..=
old_handler.#3D.sign<BR>al(SIGINT,.old_handler);#0A..close_keyb();#0A..ex=
it<BR>(20);#0A}#0A#0Aint.main(int.argc,.char.*argv[])#0A{<BR>.int.i;.....=
./*.for.FOR.loops..*/#0A..BCPLWORD.*glo<BR>bbase;#0A..BCPLWORD.*stackbase=
;#0A..BCPLWORD.res;#0A<BR>#0A..if.(.badimplementation().)#0A..{.printf("T=
his.<BR>implementation.of.C.is.not.suitable\n");#0A....retu<BR>rn.20;#0A.=
.}#0A#0A../*.Try.to.reconstruct.the.comma<BR>nd.line.arguments.from.argv.=
*/#0A..parms.#3D.(char.<BR>*)(MALLOC(256));#0A#0A..{.int.p#3D0;#0A....par=
ms[0]<BR>.#3D.0;#0A#0A....for.(i#3D1;.i&lt;argc;.i++).{#0A.....<BR>.char.=
*arg.#3D.argv[i];#0A......int.len.#3D.strlen(<BR>arg);#0A......int.j;#0A.=
.....int.is_string.#3D.0;./<BR>*.#3D1.if.arg.contains.",.space,.or.newlin=
e#2Ewhite<BR>.space.*/#0A....../*printf("clib:.getting.command.l<BR>ine,.=
len#3D%d\n",.len);.*/#0A......for.(j#3D0;.j&lt;le<BR>n;.j++)#0A........if=
(.arg[j]#3D#3D'"'.||.arg[j]#3D#3D<BR>'.'.||.arg[j]#3D#3D'\n').is_string.#=
3D.1;#0A....../<BR>*printf("clib:.getting.command.line,.is_string#3D%d<BR=
>\n",.is_string);.*/#0A......parms[++p].#3D.'.';#0A.<BR>.....if(is_string=
)#0A......{.parms[++p].#3D.'"';#0A<BR>........for.(j#3D0;.j&lt;len;.j++)#=
0A........{.int.ch.<BR>#3D.arg[j];#0A..........if(ch#3D#3D'\n').{.parms[p=
+<BR>+].#3D.'*';.parms[++p].#3D.'n';.}#0A..........if(ch<BR>#3D#3D'"')..{=
.parms[p++].#3D.'*';.parms[++p].#3D.'"<BR>';.}#0A#09..else.parms[++p].#3D=
.ch;#0A........}#0A.<BR>.......parms[++p].#3D.'"';#0A......}.else.{#0A...=
..<BR>...for.(j#3D0;.j&lt;len;.j++).parms[++p].#3D.arg[j];#0A<BR>......}#=
0A....}#0A....parms[++p].#3D.'\n';../*.Put.<BR>a.newline.at.the.end.of.th=
e.argument.string.*/#0A..<BR>..parms[0].#3D.p;./*.Fill.in.the.BCPL.string=
.length<BR>.*/#0A....parmp.#3D.1;..../*.Subscript.of.the.first<BR>.charac=
ter.of.the.*/#0A................../*.command<BR>-line.argument.*/#0A#0A..=
../*printf("clib:.args:.le<BR>n#3D%d\n",.parms[0]);.*/#0A..../*for(i#3D1;=
.i&lt;#3Dpa<BR>rms[0];i++).printf("parm[%d]#3D%d\n",.i,.parms[i]);<BR>.*/=
#0A..../*printf("\n");.*/#0A..}#0A#0A../*..parms<BR>.#3D.(BCPLWORD.*)(MAL=
LOC(argc+1));.*/#0A../*parms[0<BR>].#3D.argc.&gt;.1.?.argc.:.0;.*/#0A../*=
for.(i.#3D.0;.i<BR>.&lt;.argc;.i++).{.*/#0A../*..BCPLWORD.v.#3D.(BCPLWORD=
<BR>)(MALLOC(1+strlen(argv[i]).&gt;&gt;.B2Wsh)).&gt;&gt;.B2Wsh;.*/#0A<BR>=
../*..c2b_str(argv[i],.v);.*/#0A../*..parms[1+i].#3D<BR>.v;.*/#0A../*}.*/=
#0A#0A..old_handler.#3D.signal(SIG<BR>INT,.handler);#0A..initfpvec();#0A#=
0A..globbase..#3D<BR>.(BCPLWORD.*)(calloc((gvecupb.+1),.1&lt;&lt;B2Wsh));=
#0A..<BR>if(globbase#3D#3D0).#0A....{.printf("unable.to.allo<BR>cate.spac=
e.for.globbase\n");#0A......exit(20);#0A..<BR>..}#0A#0A..stackbase.#3D.(B=
CPLWORD.*)(calloc((stack<BR>upb+1),.1&lt;&lt;B2Wsh));#0A..if(stackbase#3D=
#3D0).#0A...<BR>.{.printf("unable.to.allocate.space.for.stackbase\n<BR>")=
;#0A......exit(20);#0A....}#0A#0A..for(i#3D0;.i&lt;#3D<BR>Rtn_upb;.i++).r=
ootnode[i].#3D.0;#0A#0A..globbase[0]<BR>.#3D.gvecupb;#0A#0A..for.(i#3D1;i=
&lt;#3Dgvecupb;i++).g<BR>lobbase[i].#3D.Globword.+.i;#0A..globbase[Gn_roo=
tno<BR>de].#3D.((BCPLWORD)rootnode)&gt;&gt;B2Wsh;#0A#0A..for.(i#3D<BR>0;i=
&lt;#3Dstackupb;i++).stackbase[i].#3D.0;#0A#0A../*.<BR>.printf("clib:.gve=
cupb#3D%d.stackupb#3D%d\n",.gvecu<BR>pb,.stackupb);.*/#0A../*.initsection=
s,.gvecupb.and.<BR>stackupb.are.defined.in.the.file.*/#0A../*.(typical<BR=
>ly).initprog#2Ec.created.by.a.call.of.the.command.m<BR>akeinit#2E.*/#0A#=
0A..initsections(globbase);#0A#0A/<BR>/printf("globbase[1].#3D.%d\n",.glo=
bbase[1]);#0A#0A<BR>..ttyinp.#3D.init_keyb();#0A#0A../*.Enter.BCPL.star<B=
R>t.function:.callstart.is.defined.in.mlib#2Es.*/#0A.<BR>.res.#3D.callsta=
rt(stackbase,.globbase);#0A#0A#0A..<BR>close_keyb();#0A#0A..if.(res).prin=
tf("\nExecution.f<BR>inished,.return.code.%ld\n",.(long)res);#0A#0A..fre<=
BR>e(globbase);#0A..free(stackbase);#0A..free(parms);#0A<BR>#0A..return.r=
es;#0A}#0A#0A#0ABCPLWORD.muldiv(BCPLWO<BR>RD.a,.BCPLWORD.b,.BCPLWORD.c)#0=
A{.unsigned.BCPLWORD<BR>.q#3D0,.r#3D0,.qn,.rn;#0A..unsigned.BCPLWORD.ua,.=
ub<BR>,.uc;#0A..int.qneg#3D0,.rneg#3D0;#0A../*..printf("m<BR>uldiv:.a#3D%=
d.b#3D%d.c#3D%d\n",.a,.b,.c);.*/#0A..if<BR>(c#3D#3D0).c#3D1;#0A..if(a&lt;=
0).{.qneg#3D!qneg;.rneg#3D<BR>!rneg;.ua.#3D.-a;.}#0A..else...............=
........<BR>.......ua.#3D..a;#0A..if(b&lt;0).{.qneg#3D!qneg;.rneg#3D<BR>!=
rneg;.ub.#3D.-b;.}#0A..else.......................<BR>.......ub.#3D..b;#0=
A..if(c&lt;0).{.qneg#3D!qneg;......<BR>.......uc.#3D.-c;.}#0A..else......=
.................<BR>.......uc.#3D..c;#0A..#0A..qn.#3D.ub./.uc;#0A..rn.#3=
D<BR>.ub.%.uc;#0A..#0A..while(ua)#0A..{.if(ua&amp;1).{.q.+#3D<BR>.qn;#0A.=
..............r.+#3D.rn;#0A...............i<BR>f(r&gt;#3Dc).{.q++;.r.-#3D=
.uc;.}#0A.............}#0A..<BR>..ua.&gt;&gt;#3D.1;#0A....qn.&lt;&lt;#3D.=
1;#0A....rn.&lt;&lt;#3D.1;#0A<BR>....if(rn&gt;#3Duc).{qn++;.rn.-#3D.uc;.}=
#0A..}#0A..res<BR>ult2.#3D.rneg.?.-r.:.r;#0A..return.qneg.?.-q.:.q;#0A<BR=
>}#0A#0Astatic.char.chbuf1[256],.chbuf2[256];./*.to.<BR>hold.filenames.*/=
#0Astatic.char.chbuf3[256],.chbuf4<BR>[256];./*.to.hold.filenames.*/#0A#0=
Aint.tracing.#3D<BR>.0;#0Aint.filetracing.#3D.0;#0A#0Aint.relfilename(c<B=
R>har.*name)#0A{.if(name[0]#3D#3DFILE_SEP_CH.||#0A...<BR>../*.The.followi=
ng.is.fiddle.for.MSDOS/Windows.*/#0A<BR>.....FILE_SEP_CH#3D#3D'\\'.&amp;&=
amp;.'A'&lt;#3Dname[0].&amp;&amp;.nam<BR>e[0]&lt;#3D'Z'.&amp;&amp;.name[1=
]#3D#3D':')#0A.......return.0;<BR>./*.Absolute.file.names.don't.use.paths=
.*/#0A..retu<BR>rn.1;.#0A}#0A#0A/*.pathinput.does.not.use.any.of.ch<BR>bu=
f1,.chbuf2.or.chbuf3#2E.*/#0AFILEPT.pathinput(cha<BR>r.*name,.char.*pathn=
ame)#0A/*.If.pathname.is.not.nu<BR>ll,.name.is.looked.up.in.the.directori=
es#0A...it.sp<BR>ecified,.otherwise.name.is.looked.up.in.the.current<BR>.=
directory#0A*/#0A{.FILEPT.fp.#3D.0;#0A#0A../*.Look<BR>.through.the.PATH.d=
irectories.if.pathname.is.given#2E<BR>.*/#0A..if.(pathname).{#0A....char.=
str[256];#0A....<BR>char.*filename.#3D.&amp;str[0];#0A....int.itemsep.#3D=
.F<BR>ILE_SEP_CH#3D#3D'/'.?.':'.:.';';#0A#23if.defined(fo<BR>rVmsItanium)=
.||.defined(forVmsVax)#0A....itemsep.#3D<BR>.';';#0A#23endif#0A..../*PRIN=
TFS("pathinput:.search<BR>ing.for.%s.in.path.%s\n",.name,.pathname);.*/#0=
A...<BR>.if.(relfilename(name))#0A....{.char.*path.#3D.gete<BR>nv(pathnam=
e);#0A......if(filetracing).{#0A........P<BR>RINTFS("pathinput:.using.%s"=
,.pathname);#0A........<BR>PRINTFS(".#3D.%s\n",.path);#0A......}#0A......=
/*PRI<BR>NTFS("pathinput:.searching.directories.%s\n",.path)<BR>;.*/#0A..=
..../*.Try.prefixing.with.each.directory.i<BR>n.the.path#2E.*/#0A......wh=
ile(path.&amp;&amp;.fp#3D#3D0)#0A<BR>......{.char.*f#3Dfilename;#0A......=
..char.*n#3Dnam<BR>e;#0A........while(*path#3D#3Ditemsep).path++;#0A..<BR=
>......if(*path#3D#3D0).break;#0A......../*.Copy.the<BR>.directory.name.i=
nto.filename.*/#0A........while(*p<BR>ath!#3D0.&amp;&amp;.*path!#3Ditemse=
p)#0A........{.char.ch.#3D<BR>.*path++;#0A..........if(ch#3D#3D'/'.||.ch#=
3D#3D'\\<BR>').ch.#3D.FILE_SEP_CH;#0A..........*f++.#3D.ch;#0A.<BR>......=
.}#0A......../*.Insert.a.filename.seperator.i<BR>f.necessary#2E.*/#0A....=
....if(f[-1]!#3DFILE_SEP_CH<BR>).*f++.#3D.FILE_SEP_CH;#0A#0A......../*.Ap=
pend.the.<BR>given.file.name.*/#0A........while(*n)#0A........{.<BR>char.=
ch.#3D.*n++;#0A..........if(ch#3D#3D'/'.||.ch#3D<BR>#3D'\\').ch.#3D.FILE_=
SEP_CH;#0A..........*f++.#3D.c<BR>h;#0A........}#0A........*f.#3D.0;#0A#2=
3if.defined(<BR>forVmsItanium).||.defined(forVmsVax)#0A........file<BR>na=
me.#3D.vmsfname(filename,.chbuf4);#0A#23endif#0A.<BR>.......fp.#3D.fopen(=
filename,."rb");#0A........if(f<BR>iletracing)#0A........{.PRINTFS("Tryin=
g:.%s.-.",.fi<BR>lename);#0A#09..if(fp).{#0A............PRINTF("foun<BR>d=
\n");#0A#09..}.else.{#0A............PRINTF("not.fo<BR>und\n");#0A#09..}#0=
A........}#0A......}#0A....}#0A.<BR>.}.else.{#0A..../*.If.pathname.was.NU=
LL,.search.the<BR>.current.directory.*/#0A..../*PRINTFS("Searching.fo<BR>=
r.%s.in.the.current.directory\n",.name);.*/#0A#23if<BR>.defined(forVmsIta=
nium).||.defined(forVmsVax)#0A...<BR>.fp.#3D.fopen(vmsfname(name,.chbuf4)=
,."rb");#0A#23e<BR>lse#0A....fp.#3D.fopen(name,."rb");#0A#23endif#0A..<BR=
>..if(filetracing)#0A....{.PRINTFS("Trying:.%s.in.th<BR>e.current.directo=
ry.-.",.name);#0A......if(fp).{#0A<BR>........PRINTF("found\n");#0A......=
}.else.{#0A.....<BR>...PRINTF("not.found\n");#0A......}#0A....}#0A..}#0A<=
BR>#0A../*if(fp#3D#3D0).PRINTFS("pathinput:.failed.to.<BR>find.%s.anywher=
e\n",.name);.*/#0A../*else......PRIN<BR>TF("pathinput:.success\n");.*/#0A=
#0A..return.fp;#0A<BR>}#0A/*#0AFILE.*pathinput(char.*name,.char.*pathname=
<BR>)#0A{.FILE.*fp.#3D.fopen(name,."r");#0A..char.filen<BR>ame[1024];#0A.=
.int.itemsep.#3D.FILE_SEP_CH#3D#3D'/'<BR>.?.':'.:.';';#0A..if.(fp#3D#3D0)=
#0A..{.if.(pathname<BR>.&amp;&amp;.relfilename(name))#0A....{.char.*path.=
#3D.geten<BR>v(pathname);#0A......while(path.&amp;&amp;.fp#3D#3D0)#0A...<=
BR>...{.char.*f#3Dfilename,#0A.............*n#3Dname;#0A<BR>........while=
(*path#3D#3Ditemsep).path++;#0A.......<BR>.if(*path#3D#3D0).break;#0A....=
....while(*path!#3D0<BR>.&amp;&amp;.*path!#3Ditemsep).*f++.#3D.*path++;#0=
A........i<BR>f(f[-1]!#3DFILE_SEP_CH).*f++.#3D.FILE_SEP_CH;#0A...<BR>....=
.while(*n).*f++.#3D.*n++;#0A........*f.#3D.0;#0A<BR>........fp.#3D.fopen(=
filename,."r");#0A......}#0A..<BR>..}#0A..}#0A..return.fp;#0A}#0A*/#0A#0A=
/*.dosys(P,.<BR>G).called.from.mlib#2Es.in.response.to#0A**.BCPL.ca<BR>ll=
.res.:#3D.sys(n,.x,.y,.#2E#2E#2E#2E)#2E.Arguments<BR>.p.&amp;.g.are.the#0=
A**.OCODE.stack-pointer.P.and.Globa<BR>l.vector.pointer.G#2E.The.argument=
s#0A**.to.sys().a<BR>re.n.#3D.p[3],.x.#3D.p[4].#2E#2E#2E#2E#0A**.sys(0,.<=
BR>r).is.trapped.in.mlib#2Es#0A*/#0A#0ABCPLWORD.dosys(<BR>register.BCPLWO=
RD.*p,.register.BCPLWORD.*g)#0A{.reg<BR>ister.BCPLWORD.i;#0A#0A//printf("=
dosys:.p[3]#3D%d.p<BR>[4]#3D%d\n",.p[3],.p[4]);#0A..switch((int)(p[3]))#0=
A<BR>..{.default:.printf("\nBad.sys.%ld\n",.(long)p[3]);<BR>..return.p[3]=
;#0A..#0A..../*#0A....case.Sys_setcoun<BR>t:.set.count...............--.d=
one.in.cinterp#0A...<BR>.case.Sys_quit:.....return.from.interpreter.--.do=
ne<BR>.in.cinterp#0A#0A....case.Sys_rti:......sys(Sys_rti<BR>,.regs).....=
.--.done.in.cinterp..Cintpos#0A....case<BR>.Sys_saveregs:.sys(Sys_savereg=
s,.regs).--.done.in.c<BR>interp..Cintpos#0A....case.Sys_setst:....sys(Sys=
_se<BR>tst,.st)......--.done.in.cinterp..Cintpos#0A....cas<BR>e.Sys_traci=
ng:..//.sys(Sys_tracing,.b).#0A......tra<BR>cing.#3D.p[4];#0A......return=
.0;#0A....case.Sys_wat<BR>ch:....sys(Sys_watch,.addr)....--.done.in.cinte=
rp#0A<BR>#0A....case..Sys_tally:.........//.sys(Sys_tally,.f<BR>lag).#0A.=
.....if(p[4]).{#0A........tallylim.#3D.tal<BR>lyupb;#0A........for(i#3D1;=
.i&lt;#3Dtallylim;.i++).tal<BR>lyv[i].#3D.0;#0A......}.else.{#0A........t=
allylim.#3D<BR>.0;#0A......}#0A......return.0;#0A.....#0A....case.<BR>Sys=
_interpret:.//.call.interpreter.(recursively).#0A<BR>....{.BCPLWORD.regsv=
.#3D.p[4];#0A......if(W[regsv+7<BR>]&lt;0).return.CINTASM..(regsv,.W);#0A=
......return.int<BR>erpret(regsv,.W);#0A....}#0A....*/#0A#0A....case.Sy<B=
R>s_sardch:#0A....{.BCPLWORD.ch;#0A....../*printf("pa<BR>rmp#3D%d.parms[0=
]#3D%d\n",.parmp,.parms[0]);.*/#0A.<BR>.....if(parmp&lt;#3Dparms[0]).{../=
*.Added.MR.10/04/06.<BR>*/#0A......../*.Read.the.command.arguments.(witho=
ut<BR>.echo).first#2E.*/#0A......../*printf("sardch:.parm<BR>p#3D%d.parms=
[0]#3D%d\n",.parmp,.parms[0]);.*/#0A...<BR>...../*printf("sardch:.returni=
ng.%d\n",.parms[parmp<BR>]);.*/#0A........return.parms[parmp++];#0A......=
}#0A<BR>......ch.#3D.Readch();#0A......if.(ttyinp).{../*.ec<BR>ho.tty.inp=
ut.only.*/#0A........if.(ch&gt;#3D0).putchar<BR>((char)ch);#0A........if(=
ch#3D#3D13).{.ch.#3D.10;.p<BR>utchar(10);.}#0A........fflush(stdout);#0A.=
.....}#0A<BR>......return.ch;#0A....}#0A#0A....case.Sys_sawrch:#0A<BR>...=
...if(p[4].#3D#3D.10).putchar(13);#0A......putch<BR>ar((char)p[4]);#0A...=
...fflush(stdout);#0A......ret<BR>urn.0;#0A#0A....case.Sys_read:../*.byte=
sread.:#3D.s<BR>ys(Sys_read,.fp,.buf,.bytecount).*/#0A....{.FILE.*f<BR>p.=
#3D.findfp(p[4]);#0A......char.*bbuf.#3D.(char.*)<BR>(p[5]&lt;&lt;B2Wsh);=
#0A......BCPLWORD.len...#3D.p[6];#0A.<BR>.....len.#3D.fread(bbuf,.(size_t=
)1,.(size_t)len,.fp<BR>);#0A......return.len;#0A....}#0A#0A....case.Sys_w=
r<BR>ite:#0A....{.FILE.*fp.#3D.findfp(p[4]);#0A......cha<BR>r.*bbuf.#3D.(=
char.*)(p[5]&lt;&lt;B2Wsh);#0A......BCPLWORD<BR>.len.#3D.p[6];#0A......le=
n.#3D.WD.fwrite(bbuf,.(siz<BR>e_t)1,.(size_t)len,.fp);#0A......fflush(fp)=
;#0A....<BR>..return.len;#0A....}#0A#0A....case.Sys_openread:#0A<BR>....{=
.char.*name.#3D.b2c_fname(p[4],.chbuf1);#0A...<BR>...FILEPT.fp;#0A#23if.d=
efined(forVmsItanium).||.def<BR>ined(forVmsVax)#0A......name.#3D.vmsfname=
(name,.chb<BR>uf4);#0A#23endif#0A#0A......fp.#3D.pathinput(name,.<BR>....=
.............../*.Filename.*/#0A...............<BR>......b2c_str(p[5],.ch=
buf2));../*.Environment.varia<BR>ble.*/#0A......if(fp#3D#3D0).return.0L;#=
0A......ret<BR>urn.newfno(fp);#0A....}#0A#0A....case.Sys_openwrite<BR>:#0=
A....{.char.*name.#3D.b2c_fname(p[4],.chbuf1);#0A<BR>......FILEPT.fp;#0A#=
23if.defined(forVmsItanium).||.<BR>defined(forVmsVax)#0A......name.#3D.vm=
sfname(name,.<BR>chbuf4);#0A#23endif#0A#0A......fp.#3D.fopen(name,."<BR>w=
b");#0A......if(fp#3D#3D0).return.0L;#0A......retu<BR>rn.newfno(fp);#0A..=
..}#0A#0A....case.Sys_openreadwr<BR>ite:#0A....{.char.*name.#3D.b2c_fname=
(p[4],.chbuf1)<BR>;#0A......FILEPT.fp;#0A#23if.defined(forVmsItanium)<BR>=
.||.defined(forVmsVax)#0A......name.#3D.vmsfname(na<BR>me,.chbuf4);#0A#23=
endif#0A#0A.......fp.#3D.fopen(na<BR>me,."rb+");#0A......if(fp#3D#3D0).fp=
.#3D.fopen(name<BR>,."wb+");#0A......if(fp#3D#3D0).return.0L;#0A......<BR=
>return.newfno(fp);#0A....}#0A#0A....case.Sys_close:<BR>#0A....{.BCPLWORD=
.res.#3D.!.fclose(findfp(p[4]));#0A<BR>......freefno(p[4]);#0A......retur=
n.res;#0A....}#0A<BR>#0A....case.Sys_deletefile:#0A....{.char.*name.#3D.<=
BR>b2c_fname(p[4],.chbuf1);#0A......FILEPT.fp;#0A#23if<BR>.defined(forVms=
Itanium).||.defined(forVmsVax)#0A...<BR>...name.#3D.vmsfname(name,.chbuf4=
);#0A......{./*.Ap<BR>pend.';*'.to.name.*/#0A........int.len.#3D.0;#0A...=
<BR>.....while(name[len]).len++;#0A........name[len].#3D<BR>.';';#0A.....=
...name[len].#3D.'*';#0A........name[l<BR>en].#3D.0;#0A......}#0A#23endif=
#0A......return.!.RE<BR>MOVE(name);#0A....}#0A#0A....case.Sys_renamefile:=
#0A<BR>....{.char.*name1.#3D.b2c_fname(p[4],.chbuf1);#0A..<BR>....char.*n=
ame2.#3D.b2c_fname(p[5],.chbuf2);#0A....<BR>..int.len.#3D.0;#0A#23if.defi=
ned(forVmsItanium).||.<BR>defined(forVmsVax)#0A......name1.#3D.vmsfname(n=
ame1<BR>,.chbuf3);#0A......name2.#3D.vmsfname(name2,.chbuf4<BR>);#0A.....=
.{./*.Append.';*'.to.name2.*/#0A........l<BR>en.#3D.0;#0A........while(na=
me2[len]).len++;#0A....<BR>....name2[len].#3D.';';#0A........name2[len].#=
3D.'*<BR>';#0A........name2[len].#3D.0;#0A......}#0A#23endif<BR>#0A......=
REMOVE(name2);#0A#23if.defined(forVmsItani<BR>um).||.defined(forVmsVax)#0=
A......name2[len].#3D.0;<BR>#0A#23endif#0A......return.!.rename(name1,.na=
me2);#0A<BR>....}#0A#0A....case.Sys_getvec:#0A......return.((BC<BR>PLWORD=
)(malloc((1+p[4])&lt;&lt;B2Wsh)))&gt;&gt;B2Wsh;#0A#0A....<BR>case.Sys_fre=
evec:#0A......free((void.*)(p[4]&lt;&lt;B2Wsh<BR>));.return.-1;#0A/*#0A..=
..case.Sys_loadseg:#0A.....<BR>.return.loadseg(b2c_str(p[4],.chbuf1));#0A=
....case.<BR>Sys_globin:#0A......return.globin(p[4],.g);#0A....c<BR>ase.S=
ys_unloadseg:#0A......unloadseg(p[4]);........<BR>............return.0;#0=
A*/#0A#0A....case.Sys_muldiv<BR>:#0A....{.BCPLWORD.res.#3D..muldiv(p[4],.=
p[5],.p[6]<BR>);#0A......g[Gn_result2].#3D.result2;#0A......retur<BR>n.re=
s;#0A....}#0A#0A....case.Sys_intflag:#0A......r<BR>eturn.intflag().?.-1L.=
:.0L;#0A#0A/*#0A....case.Sys_<BR>setraster:#0A......return.setraster(p[4]=
,.p[5]);#0A<BR>*/#0A#0A....case.Sys_cputime:./*.Return.CPU.time.in<BR>.mi=
lliseconds..*/#0A......return.muldiv(clock(),.10<BR>00,.1000);./*TICKS_PE=
R_SEC);*/#0A#0A....case.Sys_fi<BR>lemodtime:./*.Return.time.of.last.modif=
ication.of.f<BR>ile#0A.............................whose.name.is.in<BR>.p=
[4]..*/#0A....{.struct.stat.buf;#0A......char.*na<BR>me.#3D.b2c_fname(p[4=
],.chbuf1);#0A......FILEPT.fp;#0A<BR>#23if.defined(forVmsItanium).||.defi=
ned(forVmsVax)#0A<BR>......name.#3D.vmsfname(name,.chbuf4);#0A#23endif#0A=
<BR>......if.(stat(name,.&amp;buf)).return.0;#0A......retur<BR>n.buf#2Est=
_mtime;#0A....}#0A#0A....case.Sys_setpref<BR>ix:./*.Set.the.file.prefix.s=
tring..*/#0A......prefi<BR>x.#3D.p[4];#0A......return.prefix;#0A#0A....ca=
se.Sy<BR>s_getprefix:./*.Return.the.file.prefix.string..*/#0A<BR>......re=
turn.prefix;#0A#0A....case.Sys_graphics:./*<BR>.Perform.an.operation.on.t=
he.graphics.window..*/#0A<BR>......return.sysGraphics(p);#0A#0A....case.S=
ys_seek<BR>:../*.res.:#3D.seek(fd,.pos)...*/#0A....{.FILEPT.fp<BR>.#3D.fi=
ndfp(p[4]);#0A......BCPLWORD.pos.#3D.p[5];#0A<BR>......BCPLWORD.res.#3D.f=
seek(fp,.pos,.SEEK_SET);#0A<BR>....../*printf("fseek.#3D&gt;.res#3D%d.err=
no#3D%d\n",.<BR>res,.errno);.*/#0A....../*g[Gn_result2].#3D.errno;.<BR>*/=
#0A......return.res#3D#3D0.?.-1.:.0;./*.res#3D0.s<BR>ucc,.res#3D.-1.error=
..*/#0A....}#0A#0A....case.Sys_<BR>tell:./*.pos.:#3D.sys(Sys_tell,fd)..*/=
#0A....{.FILE<BR>.*fp.#3D.findfp(p[4]);#0A......BCPLWORD.pos.#3D.fte<BR>l=
l(fp);#0A....../*g[Gn_result2].#3D.errno;.*/#0A...<BR>...return.pos;./*.&=
gt;#3D0.succ,.-1#3Derror.*/#0A....}<BR>#0A#0A....case.Sys_waitirq:./*.Wai=
t.for.irq.*/#0A..<BR>..../*#0A......pthread_mutex_lock..(.........&amp;ir=
q_m<BR>utex);#0A......pthread_cond_wait...(&amp;irq_cv,.&amp;irq_m<BR>ute=
x);#0A......pthread_mutex_unlock(.........&amp;irq_m<BR>utex);#0A......*/=
#0A......return.0;#0A#0A....case.S<BR>ys_lockirq:./*.Stop.all.devices.fro=
m.modifying.*/#0A<BR>....................../*.packets.or.generating.inte<=
BR>rrupts.*/#0A....../*#0A......pthread_mutex_lock(&amp;ir<BR>q_mutex);#0=
A......*/#0A......return.0;#0A#0A....cas<BR>e.Sys_unlockirq:./*.Allow.dev=
ices.to.modify.packets<BR>.*/#0A......................../*.and.generate.i=
nter<BR>rput.*/#0A....../*#0A......pthread_mutex_unlock(&amp;ir<BR>q_mute=
x);#0A......*/#0A......return.0;#0A#0A.....ca<BR>se.Sys_devcom:./*.res.:#=
3D.sys(Sys_devcom,.com,.arg<BR>).*/#0A.......return.0;./*devcommand(W[p+4=
],.W[p+5]<BR>,.W[p+6]);.*/#0A#0A.....case.Sys_ftime:./*.return.r<BR>esult=
.of.calling.ftime.*/#0A.....{.struct.timeb.tb;<BR>#0A.......BCPLWORD.*v.#=
3D.(BCPLWORD*)(p[4]&lt;&lt;2);#0A.<BR>......int.daylight#3D0;#0A.......in=
t.timezone#3D0;#0A<BR>.......ftime(&amp;tb);#0A....#0A#0A......./*.******=
****<BR>******.BEWARE.************************.*/#0A.......<BR>/*.The.dat=
e.will.OVERFLOW.on.19-Jan-2038.at.3:14:07<BR>.*/#0A.......v[0].#3D.0;./*(=
BCPLWORD)(tb#2Etime&gt;&gt;32<BR>);.*/#0A.......v[1].#3D.(BCPLWORD)tb#2Et=
ime;../*.Se<BR>conds.since.epoch.*/#0A.......v[2].#3D.tb#2Emillitm<BR>;..=
.../*.milli-seconds.*/#0A......./*v[3].#3D.tb#2E<BR>timezone;*/..../*.Min=
utes.west.of.Greenwich.*/#0A..<BR>...../*v[4].#3D.tb#2Edstflag;.*/..../*.=
non.zero.#3D<BR>&gt;.Daylight.saving.time#0A..........................<BR=
>.......applies.*/#0A#0A.......daylight.#3D.1;......<BR>..../*.Fudge.for.=
windows.*/#0A.......daylight.#3D.0<BR>;........../*.Fudge.for.windows.MR.=
31/10/03.*/#0A..<BR>...../*tzset();*/.............../*.Should.be.done.s<B=
R>eparately.*/#0A......./*#0A.......printf("cintpos:.<BR>timezone#3D%d.da=
ylight#3D%d.%s.%s\n",#0A...........<BR>....(BCPLWORD)timezone,(BCPLWORD)d=
aylight,.tzname[0<BR>],#0A#09.......tzname[1]);#0A.......*/#0A.......if(<=
BR>((BCPLWORD)timezone)%3600#3D#3D0)./*.Fudge.for.wind<BR>ows.*/#0A......=
...v[1].-#3D.(BCPLWORD)timezone;....<BR>/*.Correct.for.timezone.*/#0A....=
...if.(daylight)#0A<BR>.........v[1].+#3D.60*60;............./*.Add.one.h=
o<BR>ur.in.DST.*/#0A.......v[1].+#3D.rootnode[Rtn_adjclo<BR>ck].*.60;./*.=
Add.adjustment.*/#0A.......return.-1;#0A<BR>.....}#0A#0A.....case.Sys_usl=
eep:./*.usleep.for.som<BR>e.micro-seconds.*/#0A.......return.0;./*usleep(=
p[4]<BR>);..*/#0A..............#0A.....case.Sys_filesize:..<BR>/*.res.:#3=
D.sys(Sys_filesize,.fd)...*/#0A.....{.FIL<BR>E.*fp...#3D.findfp(p[4]);#0A=
.......BCPLWORD.pos..#3D<BR>.ftell(fp);#0A.......BCPLWORD.rc...#3D.fseek(=
fp,.0,<BR>.SEEK_END);#0A.......BCPLWORD.size.#3D.ftell(fp);#0A<BR>.......=
rc..#3D.fseek(fp,.pos,.SEEK_SET);#0A.......i<BR>f.(rc).size.#3D.-1;#0A...=
....return.size;./*.&gt;#3D0.<BR>succ,.-1#3Derror..*/#0A.....}#0A#0A.....=
case.Sys_ge<BR>tsysval:./*.res.:#3D.sys(Sys_getsysval,.addr).*/#0A<BR>...=
..{.BCPLWORD.*addr.#3D.(BCPLWORD*)p[4];#0A......<BR>.return.*addr;#0A....=
.}#0A#0A.....case.Sys_putsysva<BR>l:./*.res.:#3D.sys(Sys_putsysval,.addr,=
.val).*/#0A.<BR>....{.BCPLWORD.*addr.#3D.(BCPLWORD*)p[4];#0A.......<BR>*a=
ddr.#3D.p[5];#0A.......return.0;#0A.....}#0A#0A..<BR>...case.Sys_shellcom=
:./*.res.:#3D.sys(Sys_shellcom,<BR>.comstr).*/#0A.....{.char.*comstr.#3D.=
(char*)(p[4]&lt;<BR>&lt;2);#0A.......int.i;#0A.......char.com[256];#0A...=
.<BR>...int.len.#3D.strlen(comstr);#0A.......for(i#3D0;.<BR>i&lt;len;.i++=
).com[i].#3D.comstr[i+1];#0A.......com[le<BR>n].#3D.0;#0A......./*#0A....=
...printf("\ndosys:.cal<BR>ling.shell.command.%s\n",.com);#0A.......*/#0A=
.....<BR>..return.system(com);#0A.....}#0A#0A.....case.Sys_g<BR>etpid:./*=
.res.:#3D.sys(Sys_getpid).*/#0A.......retu<BR>rn.0;.//getpid();#0A#0A....=
.case.Sys_dumpmem:./*.sy<BR>s(Sys_dumpmem,.context).*/#0A.......printf("\=
nCintp<BR>os.memory.not.dumped.to.DUMP#2Emem\n");#0A.......re<BR>turn.0;#=
0A#0A.....case.Sys_callnative:#0A.....{./*.<BR>Call.native.code#2E.*/#0A.=
......int(*rasmfn)(void).<BR>#3D.(int(*)(void))&amp;p[4];#0A.......return=
.rasmfn();#0A<BR>.....}..............#0A#0A.....case.135:./*.Return.<BR>s=
ystem.date.and.time.in.VEC.5.*/#0A.....{.time_t.cl<BR>k.#3D.time(0);#0A..=
.....struct.tm.*now.#3D.gmtime(&amp;<BR>clk);#0A.......BCPLWORD.*arg.#3D.=
PT(p[4].&lt;&lt;.B2Wsh);<BR>#0A.......arg[0].#3D.now-&gt;tm_year+1900;#0A=
.......ar<BR>g[1].#3D.now-&gt;tm_mon+1;#0A.......arg[2].#3D.now-&gt;tm<BR=
>_mday;#0A.......arg[3].#3D.now-&gt;tm_hour;#0A.......a<BR>rg[4].#3D.now-=
&gt;tm_min;#0A.......arg[5].#3D.now-&gt;tm_<BR>sec;#0A.......return.0;#0A=
.....}#0A#0A.....case.136<BR>:./*.Return.current.directory.in.VEC.1.+.256=
/bytesp<BR>erword.*/#0A.....{.//getcwd(chbuf1,.256);#0A.......<BR>//c2b_s=
tr(chbuf1,.p[4]);#0A.......return.0;#0A.....<BR>}#0A#0A....case.137:#0A..=
....return.(BCPLWORD)parms<BR>.&gt;&gt;.B2Wsh;#0A..}#0A}.#0A#0Achar.*vmsf=
name(char.*nam<BR>e,.char.*vmsname).{#0A/*#0AThis.function.converts.a<BR>=
.BCPL.filename.to.a.VMS.filename#0AExamples:#0A#0AN<BR>ame...............=
..........VMS.name#0A#0Aecho#2Eb.<BR>......................echo#2Eb#0Acom=
/echo#2Eb......<BR>.............[#2Ecom]echo#2Eb#0A/mrich177/distribut<BR=
>ion/bcpl#2Eg/libhdr#2Eh#0A.........................<BR>....[mrich177#2Ed=
istribution#2Ebcpl#2Eg]libhdr#2Eh#0A<BR>vd10$disk:/mrich177/junk#2Eb...vd=
10$disk:[mrich177]<BR>junk#2Eb#0A#2E#2E/cintcode/com/bcplfe#2Eb.....[-#2E=
<BR>cintcode#2Ecom]bcplfe#2Eb#0A*/#0A..int.ch,.i#3D0,.j<BR>#3D0,.len#3D0,=
.lastslashpos#3D.-1;#0A../*.If.name.c<BR>ontains.a.colon,.copy.all#0A....=
.characters.up.to.a<BR>nd.including.the.colon#2E#0A..*/#0A..while.(1).{#0=
A<BR>....int.ch.#3D.name[i];#0A....if.(ch#3D#3D0).break;<BR>./*.No.colon.=
in.name.*/#0A....if.(ch#3D#3D':').{#0A<BR>....../*.Copy.up.to.and.includi=
ng.the.colon.*/#0A..<BR>....while.(len&lt;#3Di).{.vmsname[len].#3D.name[l=
en];.<BR>len++;.}#0A......j.#3D.len;#0A......break;#0A....}#0A<BR>....i++=
;#0A..}#0A../*.Find.position.of.last.slash,.<BR>if.any.*/#0A..while.(1).{=
#0A....int.ch.#3D.name[j];<BR>#0A....if(ch#3D#3D0).break;#0A....if(ch#3D#=
3D'/').l<BR>astslashpos.#3D.j;#0A....j++;#0A..}#0A#0A../*.No.sl<BR>ashes.=
.#3D&gt;.nothing#0A.....Leading./...#3D&gt;.[#0A...<BR>..Slashes.but.no.l=
eading.slash.so.insert.[#2E.or.[-<BR>#0A#0A.....name.is.then.copied.conve=
rting.all.slash<BR>es.except.the.leading#0A.....and.last.ones.to.dots,<BR=
>.and.converting.the.last.slash.to.]#2E#0A..*/#0A..j<BR>.#3D.i;#0A..if(na=
me[j]#3D#3D'/').{#0A..../*.if.lead<BR>ing.slash.but.not.the.last.convert.=
it.to.[.*/#0A...<BR>.if.(j!#3Dlastslashpos).vmsname[len++].#3D.'[';#0A.<B=
R>...j++;#0A..}.else.{#0A....if.(lastslashpos&gt;#3D0).{<BR>#0A....../*.S=
lashes.but.no.leading.slash,.so.insert<BR>.[#2E.or.[-..*/#0A......vmsname=
[len++].#3D.'[';#0A.<BR>.....if(name[j]!#3D'#2E'.||.name[j+1]!#3D'#2E').{=
#0A<BR>........vmsname[len++].#3D.'#2E';#0A......}#0A....}<BR>#0A..}#0A#0=
A..while.(1).{#0A..../*.Replace.last./.b<BR>y.]#0A.......and.non.last./.b=
y.#2E#0A.......and.#2E<BR>#2E.by.-#0A....*/#0A....int.ch.#3D.name[j];#0A.=
...i<BR>f(ch#3D#3D'#2E'.&amp;&amp;.name[j+1]#3D#3D'#2E').{#0A......<BR>/*=
.Convert.#2E#2E.to.-.*/#0A......ch.#3D.'-';#0A...<BR>...j++;#0A....}#0A..=
..if(ch#3D#3D'/').{#0A......if.<BR>(j#3D#3Dlastslashpos).ch.#3D.']';#0A..=
....else.....<BR>............ch.#3D.'#2E';#0A....}#0A....vmsname[len<BR>+=
+].#3D.ch;#0A....if(ch#3D#3D0).break;#0A....j++;#0A<BR>..}#0A..return.vms=
name;#0A}#0A#0A/*.b2c_fname.conve<BR>rts.the.BCPL.string.for.a.file.name.=
to.a.C.characte<BR>r#0A**.string#2E..The.character.'/'.(or.'\').is.tre<BR=
>ated.as.a.separator.and.is#0A**.converted.to.FILE_S<BR>EP_CH.('/'.for.un=
ix,.'\'.for.MSDOS.or.':'.for.MAC)#2E<BR>#0A**.If.prefix.is.set.and.the.fi=
lename.is.relative<BR>,.the.prefix.is.prepended#2E#0A*/#0Achar.*b2c_fname=
<BR>(BCPLWORD.bstr,.char.*.cstr)#0A{..char.*bp.#3D.(cha<BR>r*)(bstr&lt;&l=
t;2);#0A...int.len;#0A...int.i#3D0;#0A...if<BR>.(bstr#3D#3D0).return.0;./=
*.No.path.given.*/#0A...l<BR>en.#3D.*bp++;#0A...if.(prefix.&amp;&amp;.rel=
filename((char*<BR>)bstr))#0A...{./*.Prepend.the.filename.with.prefix.<BR=
>*/#0A.....char.*pfxp.#3D.(char*)(prefix&lt;&lt;2);#0A....<BR>.int.pfxlen=
.#3D.*pfxp++;#0A.....while(pfxlen--)#0A.<BR>....{.char.ch.#3D.*pfxp++;#0A=
.......if(ch#3D#3D'/'.<BR>||.ch#3D#3D'\\'.||.ch#3D#3D':').ch.#3D.FILE_SEP=
_CH;<BR>#0A.......cstr[i++].#3D.ch;#0A.....}#0A.....if.(cst<BR>r[i-1].!#3=
D.FILE_SEP_CH).cstr[i++].#3D.FILE_SEP_CH;<BR>#0A...}#0A#0A...while.(len--=
)#0A...{.char.ch.#3D.*b<BR>p++;#0A.....if(ch#3D#3D'/'.||.ch#3D#3D'\\'.||.=
ch#3D<BR>#3D':').ch.#3D.FILE_SEP_CH;#0A.....cstr[i++].#3D.ch<BR>;#0A...}#=
0A...cstr[i].#3D.0;#0A.../*if.(prefix).pri<BR>ntfs("filename.#3D.%s\n",.c=
str);.*/#0A.../*printfs(<BR>"b2c_fname:.cstr.#3D.%s\n",.cstr);.*/#0A...re=
turn.c<BR>str;#0A}#0A#0A/*.b2c_str.converts.the.BCPL.string.f<BR>or.a.fil=
e.name.to.a.C.character#0A**.string#2E..The<BR>.character.'/'.(or.'\').is=
.treated.as.a.separator.a<BR>nd.is#0A**.converted.to.FILE_SEP_CH.('/'.for=
.unix,.<BR>'\'.for.MSDOS.or.':'.for.MAC)#0A*/#0Achar.*b2c_str(<BR>BCPLWOR=
D.bstr,.char.*.cstr)#0A{..char.*bp,.i,.len;#0A<BR>...if.(bstr#3D#3D0).ret=
urn.0;#0A...bp.#3D.(char.*)(<BR>bstr&lt;&lt;B2Wsh);#0A...len.#3D.*bp++;#0=
A...for(i.#3D.0;<BR>.i&lt;len;.i++)#0A...{.char.ch.#3D.*bp++;#0A.....if(c=
h<BR>#3D#3D'/'.||.ch#3D#3D'\\').ch.#3D.FILE_SEP_CH;#0A..<BR>...cstr[i].#3=
D.ch;#0A...}#0A...cstr[len].#3D.0;#0A.<BR>..return.cstr;#0A}.#0A#0A/*#0A*=
*.c2b_str.converts.a<BR>.C.string.into.a.BCPL.string#0A*/#0ABCPLWORD.c2b_=
st<BR>r(char.*cstr,.BCPLWORD.bstr).{#0A..char.*bp.#3D.(ch<BR>ar.*)(bstr.&=
lt;&lt;.B2Wsh);#0A..int.len.#3D.0;#0A..while.<BR>(cstr[len]).{#0A....bp[l=
en+1].#3D.cstr[len];#0A....<BR>..++len;#0A..}#0A..bp[0].#3D.len;#0A..retu=
rn.bstr;#0A<BR>}#0A<BR><BR>######natbcpl/vax/mlib.mar#<BR>;.Mlib.for.the.=
VAX.under.VMS.--.Under.development#0A<BR>#0A;.Implemented.by.Martin.Richa=
rds.(c).7.September<BR>.2009#0A#09#0A;.C.Linkage.on.the.Vax:#0A;...On.ent=
r<BR>y.0(SP)...is.the.return.address#0A;............4(AP<BR>)...is.the.fi=
rst.argument#0A;............8(AP)...is<BR>.the.second.argument#0A;.......=
.....etc#0A;#0A;...r<BR>2-r11.must.be.preserved#0A;#0A;...return.using.RE=
T#0A<BR>;...result.in.R0#0A#0A.#2Epsect.MLIB,LONG#0A#0A;#09<BR>#2EALIGN.4=
#0A#0A........#2Eentry.callstart,^M&lt;r2,r3<BR>,r4,r5,r6,r7,r8,r9,r10,r1=
1&gt;#0A#0A.MOVL.4(AP),R10...<BR>.;.M/C.address.of.P#0A.MOVL.8(AP),R11...=
.;.M/C.addr<BR>ess.of.G#0A#0A;.Register.usage.while.executing.BCPL<BR>.co=
mpiled.code#0A#0A;.R11...The.G.pointer#0A;.R10..<BR>.The.P.pointer#0A;.R9=
....#3D.zero#0A;.R8....A..Firs<BR>t.argument.at.a.function.call#0A;.R7...=
.B#0A;.R6...<BR>.C#0A;.R2....entry.address.at.call#0A;.R1....The.ne<BR>w.=
P.pointer.at.function.call#0A#0A...clrl.r9#0A#0A.<BR>..;.make.sure.global=
.3.(sys).is.defined#0A...MOVAL.<BR>sys,.4*3(R11)#0A...;.make.sure.global.=
6.(changeco).<BR>is.defined#0A...MOVAL.changeco,.4*6(R11)#0A...;.mak<BR>e=
.sure.global.5.(muldiv).is.defined#0A...MOVAL.muld<BR>iv,.4*5(R11)#0A#0A.=
..;.BCPL.call.of.clihook(stackup<BR>b)#0A...MOVL.stackupb,R8#0A...MOVL.R1=
0,R1.........;<BR>.Set.the.new.P.pointer#0A...MOVL.4*4(R11),R2....;.c<BR>=
lihook#0A...JSB..(R2)#0A;movl.r2,r8#0A...MOVL.R8,R0<BR>....;.return.the.r=
esult.of.start#0A#0A;.and.then.re<BR>turn#0A...RET#0A#0A;...#09#2EALIGN.L=
ONG#0A#0A...;.r<BR>es.#3D.sys(n,.x,.y,.z)..the.BCPL.callable.sys.funct<BR=
>ion#0A.#2Elong.^X0000DFDF#0A.#2Elong.^X7379730B#0A.<BR>#2Elong.^X2020202=
0#0A.#2Elong.^X20202020#0Asys:#0A.<BR>MOVL..R10,(R1).....;.save.old.P#0A.=
MOVL..R1,R10....<BR>...;.P.:#3D.&lt;new.P&gt;#0A.MOVL..(SP)+,4(R10).;.sav=
e.&lt;r<BR>eturn.address&gt;#0A.MOVL..R2,8(R10)....;.Save.&lt;entry.<BR>a=
ddress&gt;#0A.MOVL..R8,12(R10)..;.Save.&lt;first.arg&gt;#0A<BR>#0A.PUSHL.=
R11#0A.PUSHL.R10#0A.CALLS.#232,dosys...;.<BR>calling.dosys(p,.g)#0A.MOVL.=
.R0,R8........;.put.res<BR>ult.in.Cintcode.A.register#0A#0A.MOVL..4(R10),=
R2...<BR>.;.Get.&lt;return.address&gt;#0A.MOVL..(R10),R10....;.P.:<BR>#3D=
.&lt;old.P&gt;#0A.JMP...(R2).........;.Jump.to.&lt;return<BR>.address&gt;=
#0A#0A;.res.:#3D.changeco(val,.cptr)#0A.#2E<BR>long.^X0000DFDF#0A.#2Elong=
.^X6168630B#0A.#2Elong.^X<BR>6365676E#0A.#2Elong.^X2020206F#0Achangeco:#0=
A.MOVL.<BR>R10,0(R1)...;.NP!0.:#3D.P#0A.POPL.R3..........;.R3.<BR>#3D.&lt=
;return.address&gt;#0A.MOVL.R3,4(R1)....;.NP!1..:#3D<BR>.return.address#0=
A.MOVL.R2,8(R1)....;.NP!2..:#3D.en<BR>try.address#0A.MOVL.R8,12(R1)...;.N=
P!3..:#3D.arg1#0A<BR>#0A.MOVL.4*7(R11),R2...;.R2.:#3D.currco#0A.MOVL.R10<=
BR>,(R9)[R2]..;.!currco.:#3D.&lt;old.P&gt;#0A.MOVL.16(R1),R4<BR>.....;.R4=
.:#3D.cptr#0A.MOVL.R4,4*7(R11)...;.currco.<BR>:#3D.cptr#0A.MOVL.(R9)[R4],=
R10..;.R10.:#3D.!cptr#0A<BR>.JMP.(R3)#0A#0A;.res,.result2.:#3D.muldiv(a,.=
b,.c)#0A<BR>.#2Ealign.long#0A.#2Elong.^X0000DFDF#0A.#2Elong.^X6<BR>C756D0=
B#0A.#2Elong.^X20766964#0A.#2Elong.^X20202020<BR>#0Amuldiv:#0A.MOVL.R10,(=
R1)......;.Save.&lt;old.P&gt;#0A.<BR>MOVL.R1,R10........;.R10.:#3D.&lt;ne=
w.P&gt;#0A.MOVL.(SP)+<BR>,4(R10)..;.Save.&lt;return.address&gt;#0A.MOVL.R=
2,8(R10).<BR>....;.Save.&lt;entry.address&gt;#0A.MOVL.R8,12(R10)....;.<BR=
>Save.first.arg...#0A#0A.MOVL.4(R10),R7#0A.MOVL.8(R1<BR>0),R6#0A.EMUL.R8,=
R7,#230,R4...;.R8.*.R7.#3D&gt;.R4,.R5<BR>#0A.EDIV.R6,R4,R8,4*10(R11)..;.(=
R4,R5)/R6.#3D&gt;.R8,.<BR>rem-&gt;result2#0A#0A.MOVL.4(R10),R2.....;.R2.:=
#3D.&lt;re<BR>turn.address&gt;#0A.MOVL.(R10),R10.....;.R10.:#3D.&lt;old<B=
R>.P;#0A.JMP.(R2)...........;.Jump.to.&lt;return.address<BR>&gt;#0A#0A.#2=
EEND#0A<BR><BR>######+#<BR></FONT></P></DIV></BODY></HTML>
------_=_NextPart_001_01CA41C5.8645FCBE--
