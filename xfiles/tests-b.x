
######bcplprogs/tests/bench100.b#
//.header.file.for.the.bench.mark.test#0A#0ASECTION
."bench100"#0A.#0AMANIFEST.$(.//.Comment.out.one.of
.the.following.lines#0A//Count#3D10000;......Qpktco
untval#3D23246;...Holdcountval#3D9297#0A..Count#3D1
0000*100;..Qpktcountval#3D2326410;.Holdcountval#3D9
30563#0A$)#0A#0AGET."libhdr"#0A.#0AMANIFEST.$(#0Ai_
idle.......#3D.1#0Ai_work.......#3D.2#0Ai_handlera.
..#3D.3#0Ai_handlerb...#3D.4#0Ai_deva.......#3D.5#0A
i_devb.......#3D.6#0Atasktab_upb..#3D.10#0A.#0Ap_li
nk.#3D.0#0Ap_id...#3D.1#0Ap_kind.#3D.2#0Ap_a1...#3D
.3#0Ap_a2...#3D.4#0Apkt_upb#3D.8#0A.#0At_link.#3D.0
#0At_id...#3D.1#0At_pri..#3D.2#0At_wkq..#3D.3#0At_s
tate#3D.4#0At_fn...#3D.5#0At_v1...#3D.6#0At_v2...#3D
.7#0Atcb_upb#3D.7#0A.#0Abufsize.#3D.3#0A.#0Apktbit.
........#3D.1#0Awaitbit........#3D.2#0Aholdbit.....
...#3D.4#0A.#0Anotpktbit......#3D.NOT.pktbit#0Anotw
aitbit.....#3D.NOT.waitbit#0Anotholdbit.....#3D.NOT
.holdbit#0A.#0As_run..........#3D.0#0As_runpkt.....
..#3D.pktbit#0As_wait.........#3D.waitbit#0As_waitp
kt......#3D.waitbit.+.pktbit#0As_hold.........#3D.h
oldbit#0As_holdpkt......#3D.holdbit.+.pktbit#0As_ho
ldwait.....#3D.holdbit.+.waitbit#0As_holdwaitpkt..#3D
.holdbit.+.waitbit.+.pktbit#0A.#0Ak_dev...#3D.1000#0A
k_work..#3D.1001#0A$)#0A.#0AGLOBAL.$(#0Atasktab..:.
250#0Atasklist.:.251#0Atcb......:.252#0Ataskid...:.
253#0Av1.......:.254#0Av2.......:.255#0A.#0Atrace..
..:.259#0Aschedule.:.260#0Aqpkt.....:.261#0Await...
..:.262#0Aholdself.:.263#0Arelease..:.264#0A.#0Aidl
efn...:.270#0Aworkfn...:.271#0Ahandlerfn:.272#0Adev
fn....:.273#0A.#0Aqpktcount:.280#0Aholdcount:.281#0A
tracing..:.282#0Alayout...:.283#0A$)#0A.#0A//#2E#0A
.#0A//SECTION."main"#0A.#0A//GET."HDR"#0A#0ALET.sta
rt().#3D.VALOF#0A$(.LET.wkq.#3D.0#0A#0A...writef("*
Nbench.mark.starting,.Count#3D%n*N",.Count)#0A.#0A.
..tasktab.:#3D.getvec(tasktab_upb)#0A...tasktab!0.:
#3D.tasktab_upb#0A...FOR.taskno.#3D.1.TO.tasktab_up
b.DO.tasktab!taskno.:#3D.0#0A.#0A...tasklist.:#3D.0
#0A.#0A...createtask(i_idle,.0,.wkq,.s_run,.idlefn,
.1,.Count)#0A.#0A...wkq.:#3D.pkt(0,...0,.k_work)#0A
...wkq.:#3D.pkt(wkq,.0,.k_work)#0A...createtask(i_w
ork,.1000,.wkq,.s_waitpkt,.workfn,.i_handlera,.0)#0A
.#0A...wkq.:#3D.pkt(0,...i_deva,.k_dev)#0A...wkq.:#3D
.pkt(wkq,.i_deva,.k_dev)#0A...wkq.:#3D.pkt(wkq,.i_d
eva,.k_dev)#0A...createtask(i_handlera,.2000,.wkq,.
s_waitpkt,.handlerfn,.0,.0)#0A.#0A...wkq.:#3D.pkt(0
,...i_devb,.k_dev)#0A...wkq.:#3D.pkt(wkq,.i_devb,.k
_dev)#0A...wkq.:#3D.pkt(wkq,.i_devb,.k_dev)#0A...cr
eatetask(i_handlerb,.3000,.wkq,.s_waitpkt,.handlerf
n,.0,.0)#0A.#0A...wkq.:#3D.0#0A...createtask(i_deva
,.4000,.wkq,.s_wait,.devfn,.0,.0)#0A...createtask(i
_devb,.5000,.wkq,.s_wait,.devfn,.0,.0)#0A.#0A...tcb
.:#3D.tasklist#0A.#0A...qpktcount,.holdcount.:#3D.0
,.0#0A.#0A...writes("*Nstarting*N")#0A//.writef("st
arting.time.#3D.%n*N",.time())#0A...tracing,.layout
.:#3D.FALSE,.0#0A...schedule()#0A...writes("*Nfinis
hed*N")#0A//.writef("*Nfinishing.time.#3D.%n*N",.ti
me())#0A.#0A...writef("qpkt.count.#3D.%n..holdcount
.#3D.%n*N",#0A...........qpktcount,.......holdcount
)#0A.#0A...writes("these.results.are.")#0A...TEST.q
pktcount#3DQpktcountval.&.holdcount#3DHoldcountval#0A
...THEN.writes("correct")#0A...ELSE.writes("incorre
ct")#0A.#0A...writes("*Nend.of.run*N")#0A...RESULTI
S.0#0A$)#0A.#0AAND.createtask(id,.pri,.wkq,.state,.
fn,.v1,.v2).BE#0A$(.LET.t.#3D.getvec(tcb_upb)#0A...
tasktab!id.:#3D.t..//.insert.in.the.task.table#0A..
.t_link!t.:#3D.tasklist#0A...t_id!t...:#3D.id#0A...
t_pri!t..:#3D.pri#0A...t_wkq!t..:#3D.wkq#0A...t_sta
te!t:#3D.state#0A...t_fn!t...:#3D.fn#0A...t_v1!t...
:#3D.v1#0A...t_v2!t...:#3D.v2#0A...tasklist.:#3D.t#0A
$)#0A.#0AAND.pkt(link,.id,.kind).#3D.VALOF#0A$(.LET
.p.#3D.getvec(pkt_upb)#0A...FOR.i.#3D.0.TO.pkt_upb.
DO.p!i.:#3D.0#0A...p_link!p....:#3D.link#0A...p_id!
p......:#3D.id#0A...p_kind!p....:#3D.kind#0A...RESU
LTIS.p#0A$)#0A.#0A.#0AAND.trace(ch).BE#0A$(.layout.
:#3D.layout.-.1#0A...IF.layout<#3D0.DO#0A...$(.newl
ine()#0A......layout.:#3D.50#0A...$)#0A...wrch(ch)#0A
...ch.:#3D.7#0A$)#0A.#0A//#2E#0A.#0A//SECTION."benc
h"#0A.#0A//GET."HDR"#0A.#0ALET.schedule().BE.UNTIL.
tcb#3D0.DO#0A//......................*106605#0A$(.L
ET.pkt,.newtcb.#3D.0,.?#0A//.*106604#0A#0A...SWITCH
ON.t_state!tcb.INTO#0A...$(.CASE.s_waitpkt:....pkt.
:#3D.t_wkq!tcb#0A//.......................*23250#0A
.........................t_wkq!tcb.:#3D.p_link!pkt#0A
.........................t_state!tcb.:#3D.t_wkq!tcb
#3D0.->.s_run,.s_runpkt#0A//.......................
*23250........................*14760.*8490#0A......
CASE.s_run:#0A......CASE.s_runpkt:.....taskid,.v1,.
v2.:#3D.t_id!tcb,.t_v1!tcb,.t_v2!tcb#0A//..........
.............*65790#0A.........................IF.t
racing.DO.trace(taskid+'0')#0A//...................
..................*0#0A.........................new
tcb.:#3D.(t_fn!tcb)(pkt)#0A//......................
.*65790#0A.........................t_v1!tcb,.t_v2!t
cb.:#3D.v1,.v2#0A.........................tcb.:#3D.
newtcb#0A.........................LOOP#0A.#0A......
CASE.s_wait:#0A......CASE.s_hold:#0A......CASE.s_ho
ldpkt:#0A......CASE.s_holdwait:#0A......CASE.s_hold
waitpkt:tcb.:#3D.t_link!tcb#0A//...................
....*40814#0A.........................LOOP#0A.#0A..
....DEFAULT:...........RETURN#0A//.................
......*0#0A...$)#0A$)#0A.#0AAND.qpkt(pkt).#3D.VALOF
#0A$(.LET.t.#3D.findtcb(p_id!pkt)#0A//.*23246#0A...
IF.t#3D0.RESULTIS.0#0A//........*0#0A...qpktcount.:
#3D.qpktcount.+.1#0A//.*23246#0A.#0A...p_link!pkt,.
p_id!pkt.:#3D.0,.taskid#0A//.*23246#0A...TEST.t_wkq
!t#3D0#0A...THEN.$(.t_wkq!t.:#3D.pkt#0A//.........*
14759#0A...........t_state!t.:#3D.t_state!t.|.pktbi
t#0A...........IF.t_pri!t.>.t_pri!tcb.RESULTIS.t#0A
//................................*3140#0A........$
)#0A...ELSE.append(pkt,.@.t_wkq!t)#0A//......*11619
#0A...RESULTIS.tcb#0A//.*23246#0A$)#0A.#0AAND.wait(
).#3D.VALOF#0A$(.t_state!tcb.:#3D.t_state!tcb.|.wai
tbit#0A//.*23248#0A...RESULTIS.tcb#0A$)#0A.#0AAND.h
oldself().#3D.VALOF#0A$(.holdcount.:#3D.holdcount.+
.1#0A//.*9297#0A...t_state!tcb.:#3D.t_state!tcb.|.h
oldbit#0A...RESULTIS.t_link!tcb#0A$)#0A.#0AAND.rele
ase(id).#3D.VALOF#0A$(.LET.t.#3D.findtcb(id)#0A//.*
9999#0A...IF.t#3D0.RESULTIS.0#0A//........*0#0A.#0A
...t_state!t.:#3D.t_state!t.&.notholdbit#0A//.*9999
#0A...IF.t_pri!t.>.t_pri!tcb.RESULTIS.t#0A//.......
.................*9999#0A...RESULTIS.tcb#0A//.*0#0A
$)#0A.#0AAND.findtcb(id).#3D.VALOF#0A$(.LET.t.#3D.0
#0A//.*33245#0A...IF.1.<#3D.id.<#3D.tasktab!0.DO.t.
:#3D.tasktab!id#0A//............................*33
245#0A...IF.t#3D0.DO.writes("*Nbad.task.id*N")#0A//
...........*0#0A...RESULTIS.t#0A//.*33245#0A$)#0A.#0A
AND.idlefn(pkt).#3D.VALOF#0A$(.v2.:#3D.v2.-.1#0A//.
*10000#0A...IF.v2#3D0.RESULTIS.holdself()#0A//.....
....*1#0A...TEST.(v1&1)#3D0#0A//.*9999#0A...THEN.$(
.v1.:#3D.v1>>1#0A//.........*5007#0A...........RESU
LTIS.release(i_deva)#0A........$)#0A...ELSE.$(.v1.:
#3D.v1>>1.NEQV.#23XD008#0A//.........*4992#0A......
.....RESULTIS.release(i_devb)#0A........$)#0A$)#0A.
#0AAND.workfn(pkt).#3D.VALOF.TEST.pkt#3D0#0A//.....
.................*4654#0A...THEN.RESULTIS.wait()#0A
//......*2327#0A...ELSE.$(.LET.buf.#3D.@.p_a2!pkt#0A
//.........*2327#0A...........v1.:#3D.i_handlera.+.
i_handlerb.-.v1#0A...........//.v1.is.alternately.i
>handlera.AND.i_handlerb#0A.#0A...........p_id!pkt.
:#3D.v1...//.set.the.destination.task.id#0A........
...p_a1!pkt.:#3D.0....//.set.the.buffer.subscript#0A
...........FOR.i.#3D.0.TO.bufsize.DO#0A...........$
(.v2.:#3D.v2.+.1#0A//............*9308#0A..........
....IF.v2>26.DO.v2.:#3D.1#0A//.....................
...*358#0A..............buf%i.:#3D."ABCDEFGHIJKLMNO
PQRSTUVWXYZ"%v2#0A...........$)#0A...........RESULT
IS.qpkt(pkt)#0A//.........*2327#0A........$)#0A.#0A
AND.handlerfn(pkt).#3D.VALOF#0A$(.UNLESS.pkt#3D0.DO
.append(pkt,.p_kind!pkt#3Dk_work.->.@v1,..@v2)#0A//
.*23252..........*11627...........................*
2327.*9300#0A...UNLESS.v1#3D0.DO#0A//.*23252#0A...$
(.LET.workpkt.#3D.v1#0A//....*20310#0A......LET.cou
nt,.buf.#3D.p_a1!workpkt,.@.p_a2!workpkt#0A......IF
.count>bufsize.DO#0A......$(.v1.:#3D.p_link!v1#0A//
.......*2325#0A.........RESULTIS.qpkt(workpkt)..//.
send.back.the.exhausted.a.work.packet#0A......$)#0A
......UNLESS.v2#3D0.DO#0A//....*17985#0A......$(.LE
T.devpkt.#3D.v2#0A.........v2.:#3D.p_link!v2#0A....
.....p_a1!devpkt.:#3D.buf%count..//.copy.character.
into.it#0A.........p_a1!workpkt.:#3D.count+1...//.i
ncrementing.the.character.count#0A.........RESULTIS
.qpkt(devpkt).....//.send.the.packet.to.the.device.
task#0A......$)#0A...$)#0A.#0A...//.cannot.proceed.
for.lack.of.a.packet.so.wait.for.one#0A...RESULTIS.
wait()#0A//.*11627#0A$)#0A.#0AAND.devfn(pkt).#3D.VA
LOF.TEST.pkt#3D0#0A//...............*27884#0A....TH
EN.$(.IF.v1#3D0.RESULTIS.wait()#0A//..........*1858
8..*9294#0A............pkt.:#3D.v1#0A//..........*9
294#0A............v1.:#3D.0#0A............RESULTIS.
qpkt(pkt)#0A.........$)#0A....ELSE.$(.v1.:#3D.pkt#0A
//..........*9296#0A............IF.tracing.DO.trace
(p_a1!pkt)#0A............RESULTIS.holdself()#0A....
.....$)#0A.#0AAND.append(pkt,.ptr).BE#0A$(.p_link!p
kt.:#3D.0#0A//.*20114#0A...UNTIL.!ptr#3D0.DO.ptr.:#3D
.!ptr#0A//.......*39877....*10467#0A...!ptr.:#3D.pk
t#0A//.*20114#0A$)#0A

######bcplprogs/tests/bench.b#
//.header.file.for.the.bench.mark.test#0A#0AMANIFES
T.$(.//.Comment.out.one.of.the.following.lines#0A..
Count#3D10000;......Qpktcountval#3D23246;...Holdcou
ntval#3D9297#0A//Count#3D10000*100;..Qpktcountval#3D
2326410;.Holdcountval#3D930563#0A$)#0A#0AGET."libhd
r"#0A.#0AMANIFEST.$(#0Ai_idle.......#3D.1#0Ai_work.
......#3D.2#0Ai_handlera...#3D.3#0Ai_handlerb...#3D
.4#0Ai_deva.......#3D.5#0Ai_devb.......#3D.6#0Atask
tab_upb..#3D.10#0A.#0Ap_link.#3D.0#0Ap_id...#3D.1#0A
p_kind.#3D.2#0Ap_a1...#3D.3#0Ap_a2...#3D.4#0Apkt_up
b#3D.8#0A.#0At_link.#3D.0#0At_id...#3D.1#0At_pri..#3D
.2#0At_wkq..#3D.3#0At_state#3D.4#0At_fn...#3D.5#0At
_v1...#3D.6#0At_v2...#3D.7#0Atcb_upb#3D.7#0A.#0Abuf
size.#3D.3#0A.#0Apktbit.........#3D.1#0Awaitbit....
....#3D.2#0Aholdbit........#3D.4#0A.#0Anotpktbit...
...#3D.NOT.pktbit#0Anotwaitbit.....#3D.NOT.waitbit#0A
notholdbit.....#3D.NOT.holdbit#0A.#0As_run.........
.#3D.0#0As_runpkt.......#3D.pktbit#0As_wait........
.#3D.waitbit#0As_waitpkt......#3D.waitbit.+.pktbit#0A
s_hold.........#3D.holdbit#0As_holdpkt......#3D.hol
dbit.+.pktbit#0As_holdwait.....#3D.holdbit.+.waitbi
t#0As_holdwaitpkt..#3D.holdbit.+.waitbit.+.pktbit#0A
.#0Ak_dev...#3D.1000#0Ak_work..#3D.1001#0A$)#0A.#0A
GLOBAL.$(#0Atasktab..:.250#0Atasklist.:.251#0Atcb..
....:.252#0Ataskid...:.253#0Av1.......:.254#0Av2...
....:.255#0A.#0Atrace....:.259#0Aschedule.:.260#0Aq
pkt.....:.261#0Await.....:.262#0Aholdself.:.263#0Ar
elease..:.264#0A.#0Aidlefn...:.270#0Aworkfn...:.271
#0Ahandlerfn:.272#0Adevfn....:.273#0A.#0Aqpktcount:
.280#0Aholdcount:.281#0Atracing..:.282#0Alayout...:
.283#0A$)#0A.#0A//#2E#0A.#0A//SECTION."main"#0A.#0A
//GET."HDR"#0A#0ALET.start().#3D.VALOF#0A$(.LET.wkq
.#3D.0#0A#0A...writef("*Nbench.mark.starting,.Count
#3D%n*N",.Count)#0A.#0A...tasktab.:#3D.getvec(taskt
ab_upb)#0A...tasktab!0.:#3D.tasktab_upb#0A...FOR.ta
skno.#3D.1.TO.tasktab_upb.DO.tasktab!taskno.:#3D.0#0A
.#0A...tasklist.:#3D.0#0A.#0A...createtask(i_idle,.
0,.wkq,.s_run,.idlefn,.1,.Count)#0A.#0A...wkq.:#3D.
pkt(0,...0,.k_work)#0A...wkq.:#3D.pkt(wkq,.0,.k_wor
k)#0A...createtask(i_work,.1000,.wkq,.s_waitpkt,.wo
rkfn,.i_handlera,.0)#0A.#0A...wkq.:#3D.pkt(0,...i_d
eva,.k_dev)#0A...wkq.:#3D.pkt(wkq,.i_deva,.k_dev)#0A
...wkq.:#3D.pkt(wkq,.i_deva,.k_dev)#0A...createtask
(i_handlera,.2000,.wkq,.s_waitpkt,.handlerfn,.0,.0)
#0A.#0A...wkq.:#3D.pkt(0,...i_devb,.k_dev)#0A...wkq
.:#3D.pkt(wkq,.i_devb,.k_dev)#0A...wkq.:#3D.pkt(wkq
,.i_devb,.k_dev)#0A...createtask(i_handlerb,.3000,.
wkq,.s_waitpkt,.handlerfn,.0,.0)#0A.#0A...wkq.:#3D.
0#0A...createtask(i_deva,.4000,.wkq,.s_wait,.devfn,
.0,.0)#0A...createtask(i_devb,.5000,.wkq,.s_wait,.d
evfn,.0,.0)#0A.#0A...tcb.:#3D.tasklist#0A.#0A...qpk
tcount,.holdcount.:#3D.0,.0#0A.#0A...writes("*Nstar
ting*N")#0A//.writef("starting.time.#3D.%n*N",.time
())#0A...tracing,.layout.:#3D.FALSE,.0#0A...schedul
e()#0A...writes("*Nfinished*N")#0A//.writef("*Nfini
shing.time.#3D.%n*N",.time())#0A.#0A...writef("qpkt
.count.#3D.%n..holdcount.#3D.%n*N",#0A...........qp
ktcount,.......holdcount)#0A.#0A...writes("these.re
sults.are.")#0A...TEST.qpktcount#3DQpktcountval.&.h
oldcount#3DHoldcountval#0A...THEN.writes("correct")
#0A...ELSE.writes("incorrect")#0A.#0A...writes("*Ne
nd.of.run*N")#0A...RESULTIS.0#0A$)#0A.#0AAND.create
task(id,.pri,.wkq,.state,.fn,.v1,.v2).BE#0A$(.LET.t
.#3D.getvec(tcb_upb)#0A...tasktab!id.:#3D.t..//.ins
ert.in.the.task.table#0A...t_link!t.:#3D.tasklist#0A
...t_id!t...:#3D.id#0A...t_pri!t..:#3D.pri#0A...t_w
kq!t..:#3D.wkq#0A...t_state!t:#3D.state#0A...t_fn!t
...:#3D.fn#0A...t_v1!t...:#3D.v1#0A...t_v2!t...:#3D
.v2#0A...tasklist.:#3D.t#0A$)#0A.#0AAND.pkt(link,.i
d,.kind).#3D.VALOF#0A$(.LET.p.#3D.getvec(pkt_upb)#0A
...FOR.i.#3D.0.TO.pkt_upb.DO.p!i.:#3D.0#0A...p_link
!p....:#3D.link#0A...p_id!p......:#3D.id#0A...p_kin
d!p....:#3D.kind#0A...RESULTIS.p#0A$)#0A.#0A.#0AAND
.trace(ch).BE#0A$(.layout.:#3D.layout.-.1#0A...IF.l
ayout<#3D0.DO#0A...$(.newline()#0A......layout.:#3D
.50#0A...$)#0A...wrch(ch)#0A...ch.:#3D.7#0A$)#0A.#0A
//#2E#0A.#0A//SECTION."bench"#0A.#0A//GET."HDR"#0A.
#0ALET.schedule().BE.UNTIL.tcb#3D0.DO#0A//.........
.............*106605#0A$(.LET.pkt,.newtcb.#3D.0,.?#0A
//.*106604#0A#0A...SWITCHON.t_state!tcb.INTO#0A...$
(.CASE.s_waitpkt:....pkt.:#3D.t_wkq!tcb#0A//.......
................*23250#0A.........................t
_wkq!tcb.:#3D.p_link!pkt#0A........................
.t_state!tcb.:#3D.t_wkq!tcb#3D0.->.s_run,.s_runpkt#0A
//.......................*23250....................
....*14760.*8490#0A......CASE.s_run:#0A......CASE.s
_runpkt:.....taskid,.v1,.v2.:#3D.t_id!tcb,.t_v1!tcb
,.t_v2!tcb#0A//.......................*65790#0A....
.....................IF.tracing.DO.trace(taskid+'0'
)#0A//.....................................*0#0A...
......................newtcb.:#3D.(t_fn!tcb)(pkt)#0A
//.......................*65790#0A.................
........t_v1!tcb,.t_v2!tcb.:#3D.v1,.v2#0A..........
...............tcb.:#3D.newtcb#0A..................
.......LOOP#0A.#0A......CASE.s_wait:#0A......CASE.s
_hold:#0A......CASE.s_holdpkt:#0A......CASE.s_holdw
ait:#0A......CASE.s_holdwaitpkt:tcb.:#3D.t_link!tcb
#0A//.......................*40814#0A..............
...........LOOP#0A.#0A......DEFAULT:...........RETU
RN#0A//.......................*0#0A...$)#0A$)#0A.#0A
AND.qpkt(pkt).#3D.VALOF#0A$(.LET.t.#3D.findtcb(p_id
!pkt)#0A//.*23246#0A...IF.t#3D0.RESULTIS.0#0A//....
....*0#0A...qpktcount.:#3D.qpktcount.+.1#0A//.*2324
6#0A.#0A...p_link!pkt,.p_id!pkt.:#3D.0,.taskid#0A//
.*23246#0A...TEST.t_wkq!t#3D0#0A...THEN.$(.t_wkq!t.
:#3D.pkt#0A//.........*14759#0A...........t_state!t
.:#3D.t_state!t.|.pktbit#0A...........IF.t_pri!t.>.
t_pri!tcb.RESULTIS.t#0A//..........................
......*3140#0A........$)#0A...ELSE.append(pkt,.@.t_
wkq!t)#0A//......*11619#0A...RESULTIS.tcb#0A//.*232
46#0A$)#0A.#0AAND.wait().#3D.VALOF#0A$(.t_state!tcb
.:#3D.t_state!tcb.|.waitbit#0A//.*23248#0A...RESULT
IS.tcb#0A$)#0A.#0AAND.holdself().#3D.VALOF#0A$(.hol
dcount.:#3D.holdcount.+.1#0A//.*9297#0A...t_state!t
cb.:#3D.t_state!tcb.|.holdbit#0A...RESULTIS.t_link!
tcb#0A$)#0A.#0AAND.release(id).#3D.VALOF#0A$(.LET.t
.#3D.findtcb(id)#0A//.*9999#0A...IF.t#3D0.RESULTIS.
0#0A//........*0#0A.#0A...t_state!t.:#3D.t_state!t.
&.notholdbit#0A//.*9999#0A...IF.t_pri!t.>.t_pri!tcb
.RESULTIS.t#0A//........................*9999#0A...
RESULTIS.tcb#0A//.*0#0A$)#0A.#0AAND.findtcb(id).#3D
.VALOF#0A$(.LET.t.#3D.0#0A//.*33245#0A...IF.1.<#3D.
id.<#3D.tasktab!0.DO.t.:#3D.tasktab!id#0A//........
....................*33245#0A...IF.t#3D0.DO.writes(
"*Nbad.task.id*N")#0A//...........*0#0A...RESULTIS.
t#0A//.*33245#0A$)#0A.#0AAND.idlefn(pkt).#3D.VALOF#0A
$(.v2.:#3D.v2.-.1#0A//.*10000#0A...IF.v2#3D0.RESULT
IS.holdself()#0A//.........*1#0A...TEST.(v1&1)#3D0#0A
//.*9999#0A...THEN.$(.v1.:#3D.v1>>1#0A//.........*5
007#0A...........RESULTIS.release(i_deva)#0A.......
.$)#0A...ELSE.$(.v1.:#3D.v1>>1.NEQV.#23XD008#0A//..
.......*4992#0A...........RESULTIS.release(i_devb)#0A
........$)#0A$)#0A.#0AAND.workfn(pkt).#3D.VALOF.TES
T.pkt#3D0#0A//......................*4654#0A...THEN
.RESULTIS.wait()#0A//......*2327#0A...ELSE.$(.LET.b
uf.#3D.@.p_a2!pkt#0A//.........*2327#0A...........v
1.:#3D.i_handlera.+.i_handlerb.-.v1#0A...........//
.v1.is.alternately.i>handlera.AND.i_handlerb#0A.#0A
...........p_id!pkt.:#3D.v1...//.set.the.destinatio
n.task.id#0A...........p_a1!pkt.:#3D.0....//.set.th
e.buffer.subscript#0A...........FOR.i.#3D.0.TO.bufs
ize.DO#0A...........$(.v2.:#3D.v2.+.1#0A//.........
...*9308#0A..............IF.v2>26.DO.v2.:#3D.1#0A//
........................*358#0A..............buf%i.
:#3D."ABCDEFGHIJKLMNOPQRSTUVWXYZ"%v2#0A...........$
)#0A...........RESULTIS.qpkt(pkt)#0A//.........*232
7#0A........$)#0A.#0AAND.handlerfn(pkt).#3D.VALOF#0A
$(.UNLESS.pkt#3D0.DO.append(pkt,.p_kind!pkt#3Dk_wor
k.->.@v1,..@v2)#0A//.*23252..........*11627........
...................*2327.*9300#0A...UNLESS.v1#3D0.D
O#0A//.*23252#0A...$(.LET.workpkt.#3D.v1#0A//....*2
0310#0A......LET.count,.buf.#3D.p_a1!workpkt,.@.p_a
2!workpkt#0A......IF.count>bufsize.DO#0A......$(.v1
.:#3D.p_link!v1#0A//.......*2325#0A.........RESULTI
S.qpkt(workpkt)..//.send.back.the.exhausted.a.work.
packet#0A......$)#0A......UNLESS.v2#3D0.DO#0A//....
*17985#0A......$(.LET.devpkt.#3D.v2#0A.........v2.:
#3D.p_link!v2#0A.........p_a1!devpkt.:#3D.buf%count
..//.copy.character.into.it#0A.........p_a1!workpkt
.:#3D.count+1...//.incrementing.the.character.count
#0A.........RESULTIS.qpkt(devpkt).....//.send.the.p
acket.to.the.device.task#0A......$)#0A...$)#0A.#0A.
..//.cannot.proceed.for.lack.of.a.packet.so.wait.fo
r.one#0A...RESULTIS.wait()#0A//.*11627#0A$)#0A.#0AA
ND.devfn(pkt).#3D.VALOF.TEST.pkt#3D0#0A//..........
.....*27884#0A....THEN.$(.IF.v1#3D0.RESULTIS.wait()
#0A//..........*18588..*9294#0A............pkt.:#3D
.v1#0A//..........*9294#0A............v1.:#3D.0#0A.
...........RESULTIS.qpkt(pkt)#0A.........$)#0A....E
LSE.$(.v1.:#3D.pkt#0A//..........*9296#0A..........
..IF.tracing.DO.trace(p_a1!pkt)#0A............RESUL
TIS.holdself()#0A.........$)#0A.#0AAND.append(pkt,.
ptr).BE#0A$(.p_link!pkt.:#3D.0#0A//.*20114#0A...UNT
IL.!ptr#3D0.DO.ptr.:#3D.!ptr#0A//.......*39877....*
10467#0A...!ptr.:#3D.pkt#0A//.*20114#0A$)#0A

######bcplprogs/tests/cmpltest.b#
SECTION."cmpltest"#0A#0AGET."libhdr"#0A#0A//.THIS.I
S.A.UNIVERSAL.CODE-GENERATOR.TEST.PROGRAM#0A//.WRIT
TEN.BY.M#2E.RICHARDS.ORIGINALLY.TO.TEST.THE#0A//.CI
I.10070.CODE-GENERATOR#2E#0A#0A//.The.version.inclu
des.tests.for.the.BCPL.Cintcode.compiler#0A//.and.t
he.version.using.the.compact.internal.assembly.lang
uage#0A//.ie.it.will.test.all.patterns.generated.by
.cvsial386,.for.instance#2E#0A#0A//.The.ONLY.free.v
ariable.of.this.program.is:.sys..(or.wrch)#0A#0AGLO
BAL.$(.f:200;.g:401;.h:602#0A..........testno:203;.
failcount:204#0A..........v:205;.testcount:206;.qui
et:207;.t:208#0A..........bitsperword:210;.msb:211;
.allones:212..$)#0A#0ASTATIC.$(.a#3D10;.b#3D11;.c#3D
12;.w#3D0..$)#0A#0AMANIFEST.$(.k0#3D0;.k1#3D1;.k2#3D
2..$)#0A#0ALET.wrc(ch).BE.sys(11,ch)...//wrch(ch)#0A
#0AAND.wrs(s).BE#0A..FOR.i.#3D.1.TO.s%0.DO.wrc(s%i)
#0A#0AAND.nl().BE.wrc('*n')#0A#0AAND.wrd(n,.d).BE./
/wrx(n,8)#0A///*#0A$(.LET.t.#3D.VEC.30#0A...AND.i,.
k.#3D.0,.-n#0A...IF.n<0.DO.d,.k.:#3D.d-1,.n#0A...t!
i,.i,.k.:#3D.-(k.REM.10),.i+1,.k/10.REPEATUNTIL.k#3D
0#0A...FOR.j.#3D.i+1.TO.d.DO.wrc('*s')#0A...IF.n<0.
DO.wrc('-')#0A...FOR.j.#3D.i-1.TO.0.BY.-1.DO.wrc(t!
j+'0')#0A$)#0A//*/#0AAND.wrn(n).BE.wrd(n,.0)#0A#0AA
ND.wrx(n,.d).BE#0A$(.IF.d>1.DO.wrx(n>>4,.d-1)#0A...
wrc((n&15)!TABLE.'0','1','2','3','4','5','6','7',#0A
....................'8','9','A','B','C','D','E','F'
.)#0A$)#0A#0ALET.t(x,.y).#3D.VALOF#0A...$(.testcoun
t.:#3D.testcount.+.1#0A......wrd(testno,.3)#0A.....
.wrc('.')#0A......wrd(x,.21)#0A......wrc('.')#0A...
...TEST.x#3Dy#0A.........THEN.wrs("OK")#0A.........
ELSE.$(.wrs("FAILED,.it.should.be.")#0A............
.....wrd(y,.21)#0A.................failcount.:#3D.f
ailcount.+.1..$)#0A......nl()#0A......testno.:#3D.t
estno.+.1#0A......RESULTIS.y..$)#0A#0A#0ALET.t1(a,b
,c,d,e,f,g).#3D.t(a+b+c+d+e+f,.g)#0A#0ALET.start(pa
rm).#3D.VALOF#0A$(..LET.v1.#3D.VEC.200#0A....AND.v2
.#3D.VEC.200#0A....wrs("*nCgtester.on.a.")#0A....bi
tsperword,.msb,.allones.:#3D.1,.1,.1#0A....UNTIL.(m
sb<<1)#3D0.DO#0A......bitsperword,.msb,.allones.:#3D
.bitsperword+1,.msb<<1,.allones<<1.|.1#0A...#0A...w
rd(bitsperword,.0)#0A...wrs(".bit.implementation.of
.BCPL*n*n")#0A....#0A....tester(0,.1,.2,.v1,.v2)#0A
#0A//{.LET.n.#3D.1...//.special.test.for.the.<<.and
.>>.operators#0A//..FOR.i.#3D.-5.TO.80.DO.writef("%
i4.%xP*n",.i,.1<<i)#0A//..FOR.i.#3D.-5.TO.80.DO.wri
tef("%i4.%xP*n",.i,.msb>>i)#0A//}#0A....#0A....RESU
LTIS.0#0A$)#0A#0A#0AAND.tester(x,.y,.z,.v1,.v2).BE#0A
$(.LET.n0,.n1,.n2,.n3,.n4.#3D.0,.1,.2,.3,.4#0A...LE
T.n5,.n6,.n7,.n8,.n9.#3D.5,.6,.7,.8,.9#0A...LET.oct
1775.#3D.#231775#0A#0A//..wrs("*NCgtester.entered*N
")#0A#0A//..FIRST.INITIALIZE.CERTAIN.VARIABLES#0A#0A
....f,.g,.h.:#3D.100,.101,.102#0A....testno,.testco
unt,.failcount.:#3D.0,.0,.0#0A....v,.w.:#3D.v1,.v2#0A
#0A....FOR.i.#3D.0.TO.200.DO.v!i,.w!i.:#3D.1000+i,.
10000+i#0A#0A#0A....quiet.:#3D.FALSE#0A#0A//..TEST.
SIMPLE.VARIABLES.AND.EXPRESSIONS#0A#0A....testno.:#3D
.1#0A#0A....t(a+b+c,.33)........//.1#0A....t(f+g+h,
.303)#0A....t(x+y+z,.3)#0A#0A....t(123+321-400,.44)
..//.4#0A....t(x#3D0,.TRUE)#0A....t(y#3D0,.FALSE)#0A
....t(!(@y+x),.1)#0A....t(!(@b+x),.11)#0A....t(!(@g
+x),.101)#0A#0A....x,.a,.f.:#3D.5,.15,.105#0A....t(
x,.5)............//.10#0A....t(a,.15)#0A....t(f,.10
5)#0A#0A....v!1,.v!2.:#3D.1234,.5678#0A....t(v!1,.1
234).......//.13#0A....t(v!z,.5678)#0A#0A....t(x*a,
.75).........//..15#0A....t(1*x+2*y+3*z+f*4,433)#0A
....t(x*a+a*x,.150)#0A#0A....t(100/(a-a+2),.50).//.
.18#0A....t(a/x,.3)#0A....t(a/-x,.-3)#0A....t((-a)/
x,.-3)#0A....t((-a)/(-x),.3)#0A....t((a+a)/a,.2)#0A
....t((a*x)/(x*a),.1)#0A....t((a+b)*(x+y)*123/(6*12
3),.26)#0A#0A....t(n7.REM.2,.1)......//..26#0A....t
(f.REM.100,.5)#0A....t(a.REM.x,.0)#0A#0A....t(-f,.-
105).......//..29#0A#0A....f.:#3D.105#0A....t(f.#3D
.105,.TRUE)...//.30#0A....t(f~#3D.105,.FALSE)#0A...
.t(f.<.105,.FALSE)#0A....t(f>#3D.105,.TRUE)#0A....t
(f.>.105,.FALSE)#0A....t(f<#3D.105,.TRUE)#0A#0A....
f.:#3D.104#0A....t(f.#3D.105,.FALSE)..//.36#0A....t
(f~#3D.105,.TRUE)#0A....t(f.<.105,.TRUE)#0A....t(f>
#3D.105,.FALSE)#0A....t(f.>.105,.FALSE)#0A....t(f<#3D
.105,.TRUE)#0A#0A....f.:#3D.0#0A....t(f.#3D.0,.TRUE
)....//.42#0A....t(f~#3D.0,.FALSE)#0A....t(f.<.0,.F
ALSE)#0A....t(f>#3D.0,.TRUE)#0A....t(f.>.0,.FALSE)#0A
....t(f<#3D.0,.TRUE)#0A#0A....f.:#3D.1#0A....t(f.#3D
.0,.FALSE)...//.48#0A....t(f~#3D.0,.TRUE)#0A....t(f
.<.0,.FALSE)#0A....t(f>#3D.0,.TRUE)#0A....t(f.>.0,.
TRUE)#0A....t(f<#3D.0,.FALSE)#0A#0A....testno.:#3D.
60#0A#0A....t(oct1775<<3,.#2317750)..//.60#0A....t(
oct1775>>3,.#23177)#0A....t(oct1775<<z+1,.#2317750)
#0A....t(oct1775>>z+1,.#23177)#0A#0A..{.LET.b1100.#3D
.#23b1100#0A....LET.b1010.#3D.#23b1010#0A....LET.ye
s,.no.#3D.TRUE,.FALSE#0A#0A....testno.:#3D.70#0A#0A
....t(b1100&#23B1010,.#23B1000)....//..70#0A....t(b
1100.|.#23B1010,.#23B1110)#0A....t((b1100.EQV...#23
B1010).&.#23B11111,.#23B11001)#0A....t(b1100.NEQV..
#23B1010,.#23B0110)#0A#0A....t(NOT.yes,.no)........
.//.74#0A....t(NOT.no,.yes)#0A....t(NOT(b1100.EQV.-
b1010),.b1100.NEQV.-b1010)#0A..}#0A....testno.:#3D.
80#0A....f.:#3D.105#0A....t(-f,.-105)..............
.//.80#0A#0A....t(!v,.1000)...............//.81#0A.
...t(v!0,.1000)#0A....t(v!1,.1234)#0A....t(v!(!v-99
8),.5678)#0A#0A....testno.:#3D.90#0A#0A....t(!w,.10
000)..............//.90#0A....t(w!0,.10000)#0A....t
(0!w,.10000)#0A....t(1!w,.10001)#0A....t(w!1,.10001
)#0A....t(!(w+200),.10200)#0A#0A....a.:#3D.TRUE#0A.
...b.:#3D.FALSE#0A#0A....IF.a.DO.x.:#3D.16#0A....t(
x,.16)..................//.96#0A....x.:#3D.16#0A#0A
....IF.b.DO.x.:#3D.15#0A....t(x,.16)...............
...//.97#0A....x.:#3D.15#0A#0A....$(.LET.w.#3D.VEC.
20#0A.......a.:#3D.l1#0A.......GOTO.a#0A....l2:.wrs
("GOTO.ERROR*N")#0A........failcount.:#3D.failcount
+1..$)#0A#0Al1:.a.:#3D.VALOF.RESULTIS.11#0A....t(a,
.11)..................//.98#0A#0A....testno.:#3D.10
0..//.TEST.SIMULATED.STACK.ROUTINES#0A#0A....$(.LET
.v1.#3D.VEC.1#0A.......v1!0,.v1!1.:#3D.-1,.-2#0A...
....$(.LET.v2.#3D.VEC.10#0A..........FOR.i.#3D.0.TO
.10.DO.v2!i.:#3D.-i#0A..........t(v2!5,.-5)..$)....
...//..101#0A.......t(v1!1,.-2)..$)..........//..10
2#0A#0A....x.:#3D.x.+.t(x,15,.t(f,.105),.t(a,.11)).
-.15...//.103-105#0A....t(x,.15)...................
..................//.106#0A#0A....x.:#3D.x+1#0A....
t(x,.16)...//.107#0A....x.:#3D.x-1#0A....t(x,.15)..
.//.108#0A....x.:#3D.x+7#0A....t(x,22)....//.109#0A
....x.:#3D.x-22#0A....t(x,.0)....//.110#0A....x.:#3D
.x+15#0A....t(x,.15)...//.111#0A....x.:#3D.x.+.f#0A
....t(x,.120)..//.112#0A....x.:#3D.1#0A#0A....testn
o.:#3D.130#0A....f.:#3D.105#0A....t(f.#3D.105.->.1,
.2,.1)...//.130#0A....t(f~#3D.105.->.1,.2,.2)#0A...
.t(f.<.105.->.1,.2,.2)#0A....t(f>#3D.105.->.1,.2,.1
)#0A....t(f.>.105.->.1,.2,.2)#0A....t(f<#3D.105.->.
1,.2,.1)#0A#0A....f.:#3D.104#0A....t(f.#3D.105.->.1
,.2,.2)..//.136#0A....t(f~#3D.105.->.1,.2,.1)#0A...
.t(f.<.105.->.1,.2,.1)#0A....t(f>#3D.105.->.1,.2,.2
)#0A....t(f.>.105.->.1,.2,.2)#0A....t(f<#3D.105.->.
1,.2,.1)#0A#0A....f.:#3D.0#0A....t(f.#3D.0.->.1,.2,
.1)....//.142#0A....t(f~#3D.0.->.1,.2,.2)#0A....t(f
.<.0.->.1,.2,.2)#0A....t(f>#3D.0.->.1,.2,.1)#0A....
t(f.>.0.->.1,.2,.2)#0A....t(f<#3D.0.->.1,.2,.1)#0A#0A
....f.:#3D.1#0A....t(f.#3D.0.->.1,.2,.2)...//.148#0A
....t(f~#3D.0.->.1,.2,.1)#0A....t(f.<.0.->.1,.2,.2)
#0A....t(f>#3D.0.->.1,.2,.1)#0A....t(f.>.0.->.1,.2,
.1)#0A....t(f<#3D.0.->.1,.2,.2)#0A#0A....testno.:#3D
.200..//.TEST.SWITCHON.COMMANDS#0A#0A$(sw.LET.s1,.s
1f.#3D.0,.0#0A.....AND.s2,.s2f.#3D.0,.0#0A.....AND.
s3,.s3f.#3D.0,.0#0A.....FOR.i.#3D.-200.TO.200.DO#0A
.....$(.LET.x.#3D.7#0A........SWITCHON.i.INTO#0A...
......$(.DEFAULT:.s1.:#3D.s1+1000;.ENDCASE#0A......
......CASE.-1000:.s1f.:#3D.s1f.+.i;.ENDCASE#0A.....
.......CASE.-200:.s1.:#3D.s1.+.1#0A............CASE
.-190:.s1.:#3D.s1.+.1#0A............CASE.-180:.s1.:
#3D.s1.+.1#0A............CASE...-5:.s1.:#3D.s1.+.1#0A
............CASE....0:.s1.:#3D.s1.+.1#0A...........
.CASE.-145:.s1.:#3D.s1.+.1#0A............CASE....7:
.s1.:#3D.s1.+.1#0A............CASE....8:.s1.:#3D.s1
.+.1#0A............CASE..200:.s1.:#3D.s1.+.1#0A....
........CASE..190:.s1.:#3D.s1.+.1#0A............CAS
E..100:.s1.:#3D.s1.+.1#0A............CASE...90:.s1.
:#3D.s1.+.1#0A............CASE..199:.s1.:#3D.s1.+.1
#0A............CASE...95:.s1.:#3D.s1.+.1#0A........
....CASE...76:.s1.:#3D.s1.+.1#0A............CASE...
88:.s1.:#3D.s1.+.1#0A............CASE...99:.s1.:#3D
.s1.+.1#0A............CASE..-98:.s1.:#3D.s1.+.1#0A.
...........CASE...11:.s1.:#3D.s1.+.1#0A............
CASE...12:.s1.:#3D.s1.+.1#0A............CASE...13:.
s1.:#3D.s1.+.1#0A............CASE...41:.s1.:#3D.s1.
+.1#0A............CASE...91:.s1.:#3D.s1.+.1#0A.....
.......CASE...92:.s1.:#3D.s1.+.1#0A............CASE
...71:.s1.:#3D.s1.+.1#0A............CASE...73:.s1.:
#3D.s1.+.1#0A............CASE...74:.s1.:#3D.s1.+.1#0A
............CASE...81:.s1.:#3D.s1.+.1#0A...........
.CASE...82:.s1.:#3D.s1.+.1#0A............CASE...61:
.s1.:#3D.s1.+.1#0A............CASE.-171:.s1.:#3D.s1
.+.1#0A............CASE.-162:.s1.:#3D.s1.+.1..$)#0A
#0A........SWITCHON.i+10000.INTO#0A.........$(.DEFA
ULT:.s2.:#3D.s2+1000;.ENDCASE#0A............CASE.10
020:.s2.:#3D.s2.+.1#0A............CASE.10021:.s2.:#3D
.s2.+.1#0A............CASE.10022:.s2.:#3D.s2.+.1#0A
............CASE.10023:.s2.:#3D.s2.+.1#0A..........
..CASE.10024:.s2.:#3D.s2.+.1#0A............CASE.100
25:.s2.:#3D.s2.+.1#0A............CASE.10026:.s2.:#3D
.s2.+.1#0A............CASE.10027:.s2.:#3D.s2.+.1#0A
............CASE.10028:.s2.:#3D.s2.+.1#0A..........
..CASE.10029:.s2.:#3D.s2.+.1#0A............CASE.100
10:.s2.:#3D.s2.+.1#0A............CASE.10011:.s2.:#3D
.s2.+.1#0A............CASE.10012:.s2.:#3D.s2.+.1#0A
............CASE.10013:.s2.:#3D.s2.+.1#0A..........
..CASE.10014:.s2.:#3D.s2.+.1#0A............CASE.100
15:.s2.:#3D.s2.+.1..$)#0A#0A........SWITCHON.i*100.
INTO#0A.........$(.DEFAULT:.s3.:#3D.s3+1000;.ENDCAS
E#0A............CASE.-100000:.s3f.:#3D.s3f.+.i;.END
CASE#0A............CASE.-20000:.s3.:#3D.s3.+.1#0A..
..........CASE.-19000:.s3.:#3D.s3.+.1#0A...........
.CASE.-18000:.s3.:#3D.s3.+.1#0A............CASE...-
500:.s3.:#3D.s3.+.1#0A............CASE....000:.s3.:
#3D.s3.+.1#0A............CASE.-14500:.s3.:#3D.s3.+.
1#0A............CASE....700:.s3.:#3D.s3.+.1#0A.....
.......CASE....800:.s3.:#3D.s3.+.1#0A............CA
SE..20000:.s3.:#3D.s3.+.1#0A............CASE..19000
:.s3.:#3D.s3.+.1#0A............CASE..10000:.s3.:#3D
.s3.+.1#0A............CASE...9000:.s3.:#3D.s3.+.1#0A
............CASE..19900:.s3.:#3D.s3.+.1#0A.........
...CASE...9500:.s3.:#3D.s3.+.1#0A............CASE..
.7600:.s3.:#3D.s3.+.1#0A............CASE...8800:.s3
.:#3D.s3.+.1#0A............CASE...9900:.s3.:#3D.s3.
+.1#0A............CASE..-9800:.s3.:#3D.s3.+.1#0A...
.........CASE...1100:.s3.:#3D.s3.+.1#0A............
CASE...1200:.s3.:#3D.s3.+.1#0A............CASE...13
00:.s3.:#3D.s3.+.1#0A............CASE...4100:.s3.:#3D
.s3.+.1#0A............CASE...9100:.s3.:#3D.s3.+.1#0A
............CASE...9200:.s3.:#3D.s3.+.1#0A.........
...CASE...7100:.s3.:#3D.s3.+.1#0A............CASE..
.7300:.s3.:#3D.s3.+.1#0A............CASE...7400:.s3
.:#3D.s3.+.1#0A............CASE...8100:.s3.:#3D.s3.
+.1#0A............CASE...8200:.s3.:#3D.s3.+.1#0A...
.........CASE...6100:.s3.:#3D.s3.+.1#0A............
CASE.-17100:.s3.:#3D.s3.+.1#0A............CASE.-162
00:.s3.:#3D.s3.+.1..$)#0A#0A.....$)#0A.....t(s1f,.0
)........................................//.200#0A.
....t(s2f,.0)......................................
..//.201#0A.....t(s3f,.0)..........................
..............//.202#0A.....t(s1,.(401-32)*1000.+.3
2*(32+1)/2)..//369528.....//.203#0A.....t(s2,.(401-
16)*1000.+.16*(16+1)/2)..//385136.....//.204#0A....
.t(s3,.(401-32)*1000.+.32*(32+1)/2)..//369528...../
/.205#0A$)sw#0A#0A....testno.:#3D.250..//.TEST.FUNC
TION.CALLING#0A#0A......t1(1,2,3,4,5,6,.21)#0A.....
.t1(t(1,1),.t(2,2),.t(3,3),.t(4,4),.t(5,5),.t(6,6),
#0A.........t(21,21))#0A......t1(VALOF.RESULTIS.1,#0A
.........VALOF.RESULTIS.2,#0A.........VALOF.RESULTI
S.3,#0A.........VALOF.RESULTIS.4,#0A.........VALOF.
RESULTIS.5,#0A.........VALOF.RESULTIS.6,#0A........
.21)#0A......t1(VALOF.RESULTIS.1,#0A.........t(2,2)
,#0A.........VALOF.RESULTIS.3,#0A.........t(4,4),#0A
.........VALOF.RESULTIS.5,#0A.........t(6,6),#0A...
......21)#0A.....t1(.1,.t(2,2),.VALOF.RESULTIS.3,#0A
.........4,.t(5,5),.VALOF.RESULTIS.6,#0A.........21
)#0A.....t1(!v,v!0,v!200,!w,w!0,w!200,.2*1000+1200+
2*10000+10200)#0A.....(t1+(x+x)/x-2)(1,1,1,1,1,1,6)
#0A#0A.....testno.:#3D.300..//.TEST.EXPRESSION.OPER
ATORS#0A#0A.....f.:#3D.105#0A.....t((2+3)+f+6,116)#0A
.....t(f+2+3+6,116)#0A.....t(6+3+2+f,.116)#0A.....t
(f-104,.1)#0A.....t((x+2)#3D(x+2)->99,98,.99)#0A...
..t(f<f+1->21,22,.21)#0A.....t(f>f+1->31,32,.32)#0A
.....t(f<#3D105->41,42,.41)#0A.....t(f>#3D105->51,5
2,.51)#0A#0A....testno.:#3D.400..//.TEST.REGISTER.A
LLOCATION.ETC#2E#0A#0A....x.:#3D.0#0A....y.:#3D.1#0A
....z.:#3D.2#0A....t(x,.0)#0A....t(y,.1)#0A....t(z,
.2)#0A....f,g,h.:#3D.101,102,103#0A....a,b,c.:#3D.1
1,12,13#0A....t(x+1,1)#0A....t(f+1,.102)#0A....t(a+
1,.12)#0A....t(!(@a*2/2+f-101),11)#0A....a.:#3D.@f#0A
....t(!a,.101)#0A....b.:#3D.@g#0A....a.:#3D.@b#0A..
..t(!!a,.102)#0A....w!0.:#3D.@w!1#0A....w!1.:#3D.@h
#0A....t(z*y+(w!0)!0!0-2,.103)#0A....t(z*y+w!1!0-2,
.103)#0A....t(t(123,123),t(123,123))#0A#0A....testn
o.:#3D.500.//.test.16.and.32..bit.cintcode.operands
#0A#0A....x.:#3D.100#0A....t(x*x,.10000)...........
....//.LH#0A....t(x*x*x*x,.100000000).......//.LW#0A
....t(x*x+10000,.20000).........//.AH#0A....t(x*x+1
00000000,.100010000).//.AW#0A....t(x*x-10000,.0)...
..........//.SH#0A....t(x*x-100000000,.-99990000)./
/.AW#0A#0A....testno.:#3D.600#0A#0A....locals(103,1
04,105,106,107,108,109,110,111,112,113,114,115,116,
117)#0A#0A#0A....testno.:#3D.700#0A#0A....a.:#3D.1#0A
....b.:#3D.msb#0A....c.:#3D..allones#0A....t(a<<0,.
1)#0A....t(a<<1,.2)#0A....t(a<<2,.4)#0A....t(a<<bit
sperword-1,.msb)#0A....t(a<<bitsperword,.....0)#0A.
...t(a<<bitsperword+1,...0)#0A#0A....t(a>>0,.1)#0A.
...t(b>>bitsperword-1,.1)#0A....t(c>>bitsperword-1,
.1)#0A....t(b>>bitsperword,...0)#0A....t(c>>bitsper
word,...0)#0A#0A....testno.:#3D.800#0A....a,.b,.c.:
#3D.20,.-30,.0#0A....t(ABS.a,.20)#0A....t(ABS.b,.30
)#0A....t(ABS.c,.0)#0A#0A....v!0.:#3D.1001#0A....t(
v!0,.1001)#0A....v!1.:#3D.1002#0A....t(v!1,.1002)#0A
....v!2.:#3D.1003#0A....t(v!2,.1003)#0A....v!3.:#3D
.1004#0A....t(v!3,.1004)#0A....v!4.:#3D.1005#0A....
t(v!4,.1005)#0A#0A....w!0.:#3D.2001#0A....t(w!0,.20
01)#0A....w!1.:#3D.2002#0A....t(w!1,.2002)#0A....w!
2.:#3D.2003#0A....t(w!2,.2003)#0A....w!3.:#3D.2004#0A
....t(w!3,.2004)#0A....w!4.:#3D.2005#0A....t(w!4,.2
005)#0A#0A....w%0.:#3D.21#0A....t(w%0,.21)#0A....w%
1.:#3D.22#0A....t(w%1,.22)#0A....w%2.:#3D.23#0A....
t(w%2,.23)#0A....w%3.:#3D.3#0A....t(w%3,.3).//.comp
iles.xpbyt.instruction#0A#0A....a.:#3D.10#0A....b.:
#3D.a<<5#0A....w%4.:#3D.a..//.compiles.a.btc.instru
ction#0A....t(w%4,.10)#0A#0A....a,.b,.g.:#3D.100,10
1,300#0A....a.:#3D.a+1#0A....t(a,.101)#0A....a.:#3D
.a+b#0A....t(a,.202)#0A....g.:#3D.g+b#0A....t(g,.40
1)#0A#0A....g.:#3D.8#0A....b.:#3D.3#0A....a.:#3D.g.
REM.b#0A....t(a,.2)#0A#0A....g.:#3D.20#0A....b.:#3D
.12#0A....a.:#3D.g.-.b#0A....t(a,.8)#0A#0A....testn
o.:#3D.850#0A#0A....nl()#0A....wrn(testcount)#0A...
.wrs(".TESTS.COMPLETED,.")#0A....wrn(failcount)#0A.
...wrs(".FAILURE(S)*N")#0A$)#0A#0A#0A#0AAND.locals(
p3,p4,p5,p6,p7,p8,p9,p10,p11,p12,p13,p14,p15,p16,p1
7).BE#0A$(.t(p3,.103)#0A...t(p4,.104)#0A...t(p5,.10
5)#0A...t(p6,.106)#0A...t(p7,.107)#0A...t(p8,.108)#0A
...t(p9,.109)#0A...t(p10,110)#0A...t(p11,111)#0A...
t(p12,112)#0A...t(p13,113)#0A...t(p14,114)#0A...t(p
15,115)#0A...t(p16,116)#0A...t(p17,117)#0A#0A$)#0A

######bcplprogs/tests/cobench.b#
//.This.is.a.benchmark.program.for.the.coroutine.me
chanism#0A#0A//.Implemented.in.BCPL.by.Martin.Richa
rds.(c).March.2004#0A#0A//SECTION."cobench"#0A#0AGE
T."libhdr"#0A#0AGLOBAL.{#0A..kill_co:.ug........//.
The.killer.coroutine#0A..source_co#0A..tracing#0A}#0A
#0ALET.start().#3D.VALOF#0A{.LET.argv.#3D.VEC.50#0A
..LET.k,.n.#3D.10_000,.500#0A..LET.cptr.#3D.0#0A#0A
..UNLESS.rdargs("-k,-n,-t/S",.argv,.50)#0A..{.write
f("Bad.arguments.for.cobench*n")#0A....RETURN#0A..}
#0A#0A..IF.argv!0.&.string#2Eto#2Enumber(argv!0).DO
.k.:#3D.result2.//.-k#0A..IF.argv!1.&.string#2Eto#2E
number(argv!1).DO.n.:#3D.result2.//.-n#0A..tracing.
:#3D.argv!2....................................//.-
t#0A#0A..writef("*nCobench.sending.%n.numbers.via.%
n.copy.coroutines*n*n",.k,.n)#0A#0A..kill_co.:#3D.c
reateco(deleteco,.150)#0A#0A..cptr.:#3D.createco(si
nkfn,.150)#0A#0A..FOR.i.#3D.1.TO.n.DO#0A..{.LET.co.
#3D.createco(copyfn,.150)#0A....callco(co,.cptr)#0A
....cptr.:#3D.co#0A..}#0A#0A..source_co.:#3D.create
co(sourcefn,.150)#0A..callco(source_co,.cptr)#0A#0A
..IF.tracing.DO.writef("All.coroutines.created*n*n"
)#0A#0A..callco(source_co,.k).//.Tell.sourceco.to.s
end.k.numbers.#0A#0A..deleteco(kill_co)#0A#0A..writ
ef("*nCobench.done*n")#0A..RESULTIS.0#0A}#0A#0AAND.
sourcefn(nextco).BE#0A{.LET.k.#3D.cowait()#0A..LET.
channel.#3D.0#0A..LET.out_chan_ptr.#3D.@channel#0A#0A
..callco(nextco,.out_chan_ptr)#0A.#0A..IF.tracing.D
O#0A....writef("sourcefn:.co#3D%n.out_chan_ptr#3D%n
.k#3D%n*n*n",.currco,.out_chan_ptr,.k)#0A#0A..FOR.v
al.#3D.1.TO.k.DO#0A..{.IF.tracing.DO.writef("source
fn:.co#3D%n.sending.number.%n*n",.currco,.val)#0A..
..cowrite(out_chan_ptr,.val)#0A..}#0A..IF.tracing.D
O.writef("sourcefn:.co#3D%n.sending.number.%n*n",.c
urrco,.0)#0A..cowrite(out_chan_ptr,.0)#0A..IF.traci
ng.DO.writef("sourcefn:.co#3D%n.dying*n",.currco)#0A
..die()#0A}#0A#0AAND.copyfn(nextco).BE#0A{.LET.chan
nel.#3D.0#0A..LET.in_chan_ptr,.out_chan_ptr.#3D.cow
ait(),.@channel#0A..callco(nextco,.out_chan_ptr)#0A
..IF.tracing.DO.writef("copyfn:...co#3D%n.in_chan_p
tr#3D%n.out_chan_ptr#3D%n*n",#0A...................
.....currco,.in_chan_ptr,.out_chan_ptr)#0A#0A..{.LE
T.val.#3D.coread(in_chan_ptr)#0A....IF.tracing.DO.w
ritef("copyfn:...co#3D%n.copying.number.%n*n",.curr
co,.val)#0A....cowrite(out_chan_ptr,.val)#0A....UNL
ESS.val.BREAK#0A..}.REPEAT#0A#0A..IF.tracing.DO.wri
tef("copyfn:...co#3D%n.dying*n",.currco)#0A..die()#0A
}#0A#0AAND.sinkfn(in_chan_ptr).BE#0A{.IF.tracing.DO
.writef("sinkfn:...co#3D%n.in_chan_ptr#3D%n*n",.cur
rco,.in_chan_ptr)#0A#0A..{.LET.val.#3D.coread(in_ch
an_ptr)#0A....IF.tracing.DO.writef("sinkfn:...co#3D
%n.recving.number.%n*n",.currco,.val)#0A....UNLESS.
val.BREAK#0A..}.REPEAT#0A#0A..IF.tracing.DO.writef(
"sinkfn:...co#3D%n.dying*n",.currco)#0A#0A..die()#0A
}#0A#0AAND.coread(ptr).#3D.VALOF#0A{.LET.cptr.#3D.!
ptr#0A..TEST.cptr#0A..THEN.{.!ptr.:#3D.0...........
..//.Clear.the.channel.word#0A.........RESULTIS.res
umeco(cptr,.currco)#0A.......}#0A..ELSE.{.!ptr.:#3D
.currco....//.Set.channel.word.to.this.coroutine#0A
.........RESULTIS.cowait().//.Wait.for.value.from.c
owrite#0A.......}#0A}#0A#0AAND.cowrite(ptr,.val).BE
#0A{.LET.cptr.#3D.!ptr#0A..TEST.cptr#0A..THEN.{.!pt
r.:#3D.0#0A.........callco(cptr,.val).//.Send.val.t
o.coread#0A.......}#0A..ELSE.{.!ptr.:#3D.currco#0A.
.........callco(cowait(),.val)#0A.......}#0A}#0A#0A
AND.die().BE.resumeco(kill_co,.currco)#0A#0A#0A

######bcplprogs/tests/cotest.b#
//.This.tests.the.functionality.of.the.coroutine.#0A
//.functions:.callco,.cowait.and.resumeco#2E#0A#0A/
/.Implemented.by.Martin.Richards.(c).March.2004#0A#0A
GET."libhdr"#0A#0AGLOBAL.{.a_co:ug;.b_co;.c_co.}#0A
#0ALET.start().#3D.VALOF#0A{.a_co.:#3D.createco(a_f
n,.200)#0A..b_co.:#3D.createco(b_fn,.200)#0A..c_co.
:#3D.createco(c_fn,.200)#0A#0A..writef("*nTest:.roo
t.->.a.->.root*n")#0A..writef("root:.callco(a_co,..
100)*n")#0A..writef("root:.callco(a_co,..100).#3D>.
%n*n",.callco(a_co,.100))#0A#0A..writef("*nTest:.ro
ot.->.a.->.root,.ie.check:.c:#3Dfn(cowait(c)).REPEA
T*n")#0A..writef("root:.callco(a_co,..200)*n")#0A..
writef("root:.callco(a_co,..200).#3D>.%n*n",.callco
(a_co,.200))#0A#0A..writef("*nTest:.root.->.b.->.a.
->.b.->.root*n")#0A..writef("root:.callco(b_co,..30
0)*n")#0A..writef("root:.callco(a_co,..300).#3D>.%n
*n",.callco(b_co,.300))#0A#0A..writef("*nTest:.root
.->.b.->.a.->.b.->.root..again*n")#0A..writef("root
:.callco(b_co,..400)*n")#0A..writef("root:.callco(b
_co,..400).#3D>.%n*n",.callco(b_co,.400))#0A#0A..wr
itef("*nTest:.root.->.c.->.a.->.root,.ie.check.resu
meco.in.c_co*n")#0A..writef("root:.callco(c_co,..50
0)*n")#0A..writef("root:.callco(c_co,..500).#3D>.%n
*n",.callco(c_co,.500))#0A#0A..writef("*nTest:.root
.->.c.->.root*n")#0A..writef("root:.callco(c_co,..6
00)*n")#0A..writef("root:.callco(c_co,..600).#3D>.%
n*n",.callco(c_co,.600))#0A#0A..deleteco(a_co)#0A..
deleteco(b_co)#0A..deleteco(c_co)#0A#0A..writef("*n
End.of.test*n")#0A..RESULTIS.0#0A}#0A#0AAND.a_fn(x)
.#3D.VALOF#0A{.writef("a_co:.entered*n")#0A..writef
("a_co:.returning.%n*n",.x+10)#0A..RESULTIS.x+10#0A
}#0A#0AAND.b_fn(x).#3D.VALOF#0A{.writef("b_co:.ente
red*n")#0A..writef("b_co:.callco(a_co,.2000)*n")#0A
..writef("b_co:.callco(a_co,.2000).#3D>.%n*n",.call
co(a_co,.2000))#0A..writef("b_co:.returning.%n*n",.
x+20)#0A..RESULTIS.x+20#0A}#0A#0AAND.c_fn(x).#3D.VA
LOF#0A{.writef("c_co:.entered*n")#0A..writef("c_co:
.resumeco(a_co,.3000)*n")#0A..writef("c_co:.resumec
o(a_co,.3000).#3D>.%n*n",.resumeco(a_co,3000))#0A..
writef("c_co:.returning.%n*n",.x+30)#0A..RESULTIS.x
+30#0A}#0A#0A/*.This.program.should.generate.the.fo
llowing.output:#0A#0ATest:.root.->.a.->.root#0Aroot
:.callco(a_co,..100)#0Aa_co:.entered#0Aa_co:.return
ing.110#0Aroot:.callco(a_co,..100).#3D>.110#0A#0ATe
st:.root.->.a.->.root,.ie.check:.c:#3Dfn(cowait(c))
.REPEAT#0Aroot:.callco(a_co,..200)#0Aa_co:.entered#0A
a_co:.returning.210#0Aroot:.callco(a_co,..200).#3D>
.210#0A#0ATest:.root.->.b.->.a.->.b.->.root#0Aroot:
.callco(b_co,..300)#0Ab_co:.entered#0Ab_co:.callco(
a_co,.2000)#0Aa_co:.entered#0Aa_co:.returning.2010#0A
b_co:.callco(a_co,.2000).#3D>.2010#0Ab_co:.returnin
g.320#0Aroot:.callco(a_co,..300).#3D>.320#0A#0ATest
:.root.->.b.->.a.->.b.->.root..again#0Aroot:.callco
(b_co,..400)#0Ab_co:.entered#0Ab_co:.callco(a_co,.2
000)#0Aa_co:.entered#0Aa_co:.returning.2010#0Ab_co:
.callco(a_co,.2000).#3D>.2010#0Ab_co:.returning.420
#0Aroot:.callco(b_co,..400).#3D>.420#0A#0ATest:.roo
t.->.c.->.a.->.root,.ie.check.resumeco.in.c_co#0Aro
ot:.callco(c_co,..500)#0Ac_co:.entered#0Ac_co:.resu
meco(a_co,.3000)#0Aa_co:.entered#0Aa_co:.returning.
3010#0Aroot:.callco(c_co,..500).#3D>.3010#0A#0ATest
:.root.->.c.->.root#0Aroot:.callco(c_co,..600)#0Ac_
co:.resumeco(a_co,.3000).#3D>.600#0Ac_co:.returning
.530#0Aroot:.callco(c_co,..600).#3D>.530#0A#0AEnd.o
f.test#0A#0A*/#0A#0A#0A

######bcplprogs/tests/counts.b#
GET."libhdr"#0A#0AGLOBAL.{.nullfn:200;.f.}#0A#0ALET
.nullfn(x).#3D.2*x+1#0A#0ALET.f(n).#3D.n#3D0.->.1,.
n*f(n-1)#0A#0ALET.start().#3D.VALOF#0A{.writef("%i7
*n",.instrcount(nullfn,.23))#0A..FOR.i.#3D.1.TO.8.D
O.writef("%i7*n",.instrcount(f,.i))#0A..RESULTIS.0#0A
}#0A#0A

######bcplprogs/tests/gb2312.b#
//.This.is.to.test.the.output.of.extended.character
s.in.GB2312.format#2E#0A#0AGET."libhdr"#0A#0ALET.st
art().#3D.VALOF#0A{.LET.stdout,.outstream.#3D.outpu
t(),.0#0A..LET.argv.#3D.VEC.20#0A#0A..UNLESS.rdargs
("TO",.argv,.20).DO#0A..{.writef("Bad.args.for.char
s*n")#0A....RESULTIS.0#0A..}#0A#0A..IF.argv!0.DO.ou
tstream.:#3D.findoutput(argv!0)#0A#0A..IF.outstream
.DO#0A..{.writef("Writing.characters.in.GB2312.form
at.to.stream.%s*n",#0A............argv!0)#0A....sel
ectoutput(outstream)#0A..}#0A#0A//..FOR.k.#3D.#23x2
000.TO.#23x2200.DO#0A..{.writef("*#23gExtended.GB23
12.character.2154.prints.as:.'*#232154'*n")#0A....w
ritef("%%#23.in.writef.can.also.be.used:.'%#23'*n",
.2154)#0A..}#0A//GOTO.fin#0A#0A..codewrch(GB2312)./
/.Select.GB2312.encoding.for.this.stream#0A..tst("F
oreign.sign.",.4566)...//.Write.'foreign'.#3D>.CD.E
2#0A..newline()#0A#0A..FOR.row.#3D.1.TO.87.FOR.col.
#3D.1.TO.94.DO#0A....tst("code",.row*100.+.col)#0A#0A
fin:#0A..newline()#0A#0A..IF.outstream.DO.endstream
(outstream)#0A..selectoutput(stdout)#0A..RESULTIS.0
#0A}#0A#0AAND.tst(mess,.ch).BE#0A{.writef("%s:.%i4,
.hex:.%x4.%#23.",.mess,.ch,.ch,.ch)#0A..wr_gb2312(w
rx,.ch).//.Write.the.gb2312.code.in.hex#0A..newline
()#0A}#0A#0AAND.wr_gb2312(f,.ch).BE#0A{.//.Convert.
a.Unicode.character.to.GB2312.format#0A..IF.ch<#3D#23
x7F.DO#0A..{.f(ch)#0A....RETURN#0A..}#0A#0A..f(ch/1
00.+.160)......//.High.byte#0A..f(ch.MOD.100.+.160)
..//.Low.byte#0A}#0A#0AAND.wrx(byte).BE#0A{.writef(
"%x2.",.byte)#0A}#0A

######bcplprogs/tests/inputtst.b#
GET."libhdr"#0A#0ALET.start().#3D.VALOF#0A{#0A..saw
ritef("*n")#0A#0A..{.LET.ch.#3D.rdch()#0A....IF.ch#3D
endstreamch.|.ch#3D'#2E'.BREAK#0A....sawritef("%i3:
.%c*n",.ch,.ch)#0A..}.REPEAT#0A#0A..sawritef("*n")#0A
..RESULTIS.0#0A}#0A

######bcplprogs/tests/inscounts.b#
GET."libhdr"#0A#0AGLOBAL.{.nullfn:200;.fact.}#0A#0A
LET.nullfn().BE.RETURN#0A#0ALET.fact(n).#3D.n#3D0.-
>.1,.n*fact(n-1)#0A#0ALET.start().#3D.VALOF#0A{.wri
tef("*nnullfn.takes.%n.Cintcode.instructions*n*n",.
instrcount(nullfn,.23))#0A..FOR.i.#3D.1.TO.8.DO.wri
tef("fact(%n).takes.%i3.Cintcode.instructions*n",#0A
...........................i,..instrcount(fact,.i))
#0A..RESULTIS.0#0A}#0A

######bcplprogs/tests/ltst.b#
GET."libhdr"#0A#0AGLOBAL.$(.count:200;.byte:201;.ou
tstr:202#0Apxlsize:.203#0Adotxsize:.204#0Adotysize:
.205#0Axupb:.206;.xlo:.207;.xhi:.208#0Ayupb:.209;.y
lo:.210;.yhi:.211#0Amag:.212#0Adatalen:.213#0A$)#0A
.#0A//.For.datalen#3D2,.pxlsize#3D3,.dotxsize#3D2,.
dotysize#3D1,#0A//.the.frame.is.as.follows:#0A//#0A
//.....*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*..1#0A//...
..*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*#0A//.....*.*.*.
*.*.*.*.*.*.*.*.*.*.*.*.*.*#0A//.....*.*.*.........
..............*.*.*#0A//.....*.*.*.................
......*.*.*#0A//.....*.*.*.......-----------.....*.
*.*..ylo#0A//.....*.*.*......|a.a...b.b..|....*.*.*
#0A//.....*.*.*......|...........|....*.*.*#0A//...
..*.*.*......|...........|....*.*.*#0A//.....*.*.*.
.....|c.c...d.d..|....*.*.*#0A//.....*.*.*......|..
.........|....*.*.*#0A//.....*.*.*......|..........
.|....*.*.*..yhi#0A//.....*.*.*.......-----------..
...*.*.*#0A//.....*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*
#0A//.....*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*#0A//...
..*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*.*..yupb#0A//.....
1...........x.........x.........x#0A//.............
....l.........h.........u#0A//.................o...
......i.........p#0A//.............................
........b#0A#0ALET.ranbit().#3D.VALOF#0A$(.STATIC.$
(.seed.#3D.12345.$)#0A...seed.:#3D.seed*2147001325.
+.715136305#0A...RESULTIS.(seed>>24).&.1#0A$)#0A#0A
LET.start().BE#0A$(.LET.argv.#3D.VEC.50#0A...LET.v.
#3D.0#0A...LET.sysout.#3D.output()#0A#0A...IF.rdarg
s("X,Y,PXLSIZE,DATATLEN,MAG,TO/K",.argv,.50)#3D0.DO
#0A...$(.writes("Bad.argument*n")#0A......RETURN#0A
...$)#0A#0A...datalen.:#3D.256#0A...mag.:#3D.1#0A..
.pxlsize.:#3D.3#0A...dotxsize.:#3D.2#0A...dotysize.
:#3D.1#0A#0A...UNLESS.argv!0#3D0.DO.dotxsize.:#3D.s
tr2numb(argv!0)#0A...UNLESS.argv!1#3D0.DO.dotysize.
:#3D.str2numb(argv!1)#0A...UNLESS.argv!2#3D0.DO.pxl
size..:#3D.str2numb(argv!2)#0A...UNLESS.argv!3#3D0.
DO.datalen..:#3D.str2numb(argv!3)#0A...UNLESS.argv!
4#3D0.DO.mag......:#3D.str2numb(argv!4)#0A#0A...xup
b.:#3D.(2+datalen+1)*pxlsize.+.dotxsize#0A...xlo.:#3D
.1....+.2*pxlsize#0A...xhi.:#3D.xupb.-.pxlsize.-.do
txsize#0A...yupb.:#3D.xupb#0A...ylo..:#3D.xlo#0A...
yhi..:#3D.xhi#0A#0A...v.:#3D.getvec(yupb)#0A#0A...I
F.argv!5#3D0.DO.argv!5.:#3D."test#2Eps"#0A#0A...out
str.:#3D.findoutput(argv!5)#0A...IF.outstr#3D0.DO#0A
...$(.writef("Trouble.with.file.%s*n",.argv!5)#0A..
....RETURN#0A...$)#0A#0A...selectoutput(outstr)#0A#0A
...wrl("%%!PS-Adobe-0#2E0")#0A#0A...wrl("/Courier.f
indfont")#0A...wrl("50.scalefont.setfont")#0A#0A...
wrl("/pl.{.dup")#0A...wrl("......length.8.mul.1.tru
e.[.1.0.0.1.0.0.]")#0A...wrl("......4.index")#0A...
wrl("......imagemask")#0A...wrl("......pop")#0A...w
rl("......0.-1.translate")#0A...wrl("....}.bind.def
")#0A#0A#0A...wrl("72.300.div.dup.scale")#0A...wrl(
"100.3000.translate")#0A...wrl("0.50.moveto")#0A#0A
...writef("(dot.size.%nx%n.in.%nx%n.square,..mag.#3D
.%n).show*n",#0A............dotxsize,.dotysize,.pxl
size,.pxlsize,.mag)#0A#0A...writef("%n.%n.scale*n",
.mag,.mag)#0A#0A...FOR.x.#3D.1.TO.xupb.DO.v%x.:#3D.
1#0A...FOR.i.#3D.1.TO.pxlsize.DO.outrow(v,.xupb)#0A
#0A...FOR.x.#3D.1+pxlsize.TO.xupb-pxlsize.DO.v%x.:#3D
.0#0A...FOR.i.#3D.1.TO.pxlsize.DO.outrow(v,.xupb)#0A
#0A...FOR.y.#3D.1.TO.datalen.DO.#0A...$(.FOR.x.#3D.
0.TO.datalen-1.DO#0A......$(.LET.bit.#3D.ranbit()#0A
.........LET.i.#3D.xlo.+.x*pxlsize#0A.........FOR.j
.#3D.i..........TO.i+dotxsize-1.DO.v%j.:#3D.bit#0A.
........FOR.j.#3D.i+dotxsize.TO.i+pxlsize....DO.v%j
.:#3D.0#0A......$)#0A#0A......FOR.i.#3D.1.TO.dotysi
ze.DO.outrow(v,.xupb)#0A......FOR.x.#3D.xlo.TO.xhi.
DO.v%x.:#3D.0#0A......FOR.i#3D.dotysize+1.TO.pxlsiz
e.DO.outrow(v,.xupb)#0A...$)#0A#0A...FOR.i.#3D.1.TO
.dotysize.DO.outrow(v,.yupb)#0A#0A...FOR.x.#3D.1+px
lsize.TO.xupb-pxlsize.DO.v%x.:#3D.1#0A...FOR.i.#3D.
1.TO.pxlsize.DO.outrow(v,.xupb)#0A#0A...wrl("*nshow
page")#0A#0A...UNLESS.sysout#3Doutput().DO.endwrite
()#0A$)#0A#0AAND.wrl(s).BE.writef("%s*n",.s)#0A#0AA
ND.outrow(v,.upb).BE#0A$(.writes("<*n")#0A...count,
.byte.:#3D.0,.0#0A...FOR.i.#3D.1.TO.upb.DO.wrbit(v%
i)#0A...UNTIL.count.REM.8.#3D.0.DO.wrbit(0)#0A...wr
ites(">pl")#0A$)#0A#0AAND.wrbit(b).BE#0A$(.count,.b
yte.:#3D.count+1,.byte<<1.|.b#0A...UNLESS.count.REM
.8.#3D.0.RETURN#0A...writef("%x2",.byte).#0A...IF.c
ount.REM.256.#3D.0.DO.newline()#0A...byte.:#3D.0#0A
$)#0A...#0A#0A#0A#0A#0A#0A

######bcplprogs/tests/mkjunk.b#
SECTION."mkjunk"#0A#0AGET."libhdr"#0A#0ALET.start()
.#3D.VALOF#0A{.LET.argv.#3D.VEC.30#0A..LET.stdout.#3D
.output()#0A..LET.scb,.size.#3D.0,.4096+20.//.in.by
tes#0A..LET.pv.#3D.VEC.1#0A#0A..UNLESS.rdargs("SIZE
,NAME",.argv,.30).DO#0A..{.writef("Bad.arguments.fo
r.mkjunk*n")#0A....stop(20)#0A..}#0A#0A..IF.argv!0.
&.string#2Eto#2Enumber(argv!0).DO.size.:#3D.result2
#0A#0A..UNLESS.argv!1.DO.argv!1.:#3D."junk"#0A#0A..
writef("mkjunk:.%s..size:.%n*n",.argv!1,.size)#0A#0A
..scb.:#3D.findoutput(argv!1)#0A..UNLESS.scb.DO#0A.
.{.writef("Can't.open.file.'%s'*n",.argv!1)#0A....s
top(20)#0A..}#0A..selectoutput(scb)#0A#0A..{.LET.ro
wstart.#3D.0#0A....FOR.i.#3D.1.TO.size.DO.#0A....{.
LET.col.#3D.i.REM.50#0A......LET.ch.#3D.i-1#0A.....
.IF.col#3D1.DO.ch.:#3D.rowstart/10000#0A......IF.co
l#3D2.DO.ch.:#3D.rowstart/1000#0A......IF.col#3D3.D
O.ch.:#3D.rowstart/100#0A......IF.col#3D4.DO.ch.:#3D
.rowstart/10#0A......IF.col#3D5.DO.ch.:#3D.rowstart
#0A......ch.:#3D.ch.REM.10.+.'0'#0A......IF.col#3D6
.DO.ch.:#3D.':'#0A......IF.col#3D0.DO.ch,.rowstart.
:#3D.'*n',.i#0A......binwrch(ch)#0A....}#0A..}#0A..
endwrite()#0A#0A..selectoutput(stdout)#0A..RESULTIS
.0#0A}#0A#0A#0A

######bcplprogs/tests/pathtest.b#
//.This.a.test.for.the.pathfindinput.function#2E.It
.is.based.on#0A//.the.type.program#2E.It.type.a.fil
e.searched.for.on.the#0A//.path.given.by.the.BCPLCM
DS.shell.variable#2E#0A#0ASECTION."PATHTEST"#0A#0AG
ET."libhdr"#0A#0AGLOBAL#0A$(#0Ainputstream:150#0Aou
tputstream:151#0Anumbers:152#0Alinenumber:153#0A$)#0A
#0ALET.start().#3D.VALOF#0A$(.LET.argv.#3D.VEC.50#0A
...LET.rc.#3D.0#0A...LET.ch.#3D.0#0A...LET.oldoutpu
t.#3D.output()#0A#0A...inputstream.:#3D.0#0A...outp
utstream.:#3D.0#0A#0A...IF.rdargs("FROM/A,TO,N/S",.
argv,.50).#3D.0.DO#0A...$(.writes("Bad.args*n")#0A.
.....rc.:#3D.20#0A......GOTO.exit#0A...$)#0A#0A...i
nputstream.:#3D.pathfindinput(argv!0,."BCPLPATH")#0A
...IF.inputstream.#3D.0.DO.$(.writef("Can*'t.open.%
s*n",.argv!0)#0A............................rc.:#3D
.20#0A............................GOTO.exit#0A.....
....................$)#0A...selectinput(inputstream
)#0A#0A...UNLESS.argv!1#3D0.DO.$(.outputstream.:#3D
.findoutput(argv!1)#0A.........................IF.o
utputstream#3D0.DO#0A.........................$(.wr
itef("Can*'t.open.%s*n",.argv!1)#0A................
............rc.:#3D.20#0A..........................
..GOTO.exit#0A.........................$)#0A.......
..................selectoutput(outputstream)#0A....
..................$)#0A#0A...numbers.:#3D.argv!2#0A
#0A...linenumber.:#3D.1#0A#0A...$(.LET.tab.#3D.0#0A
#0A......$(.ch.:#3D.rdch()#0A.........IF.intflag().
DO.$(.UNLESS.tab#3D0.DO.wrch('*n')#0A..............
..............selectoutput(oldoutput)#0A...........
.................writes("****BREAK*n")#0A..........
..................rc.:#3D.5#0A.....................
.......GOTO.exit#0A.........................$)#0A..
.......IF.tab#3D0.DO.$(.IF.ch#3Dendstreamch.GOTO.ex
it#0A........................IF.numbers.DO.writef("
%I5..",.linenumber)#0A.....................$)#0A...
......SWITCHON.ch.INTO#0A.........$(.CASE.'*c':.CAS
E.'*n':.CASE.'*p':#0A.......................linenum
ber.:#3D.linenumber+1;.wrch(ch);.BREAK#0A#0A.......
.....CASE.'*e':.linenumber.:#3D.linenumber+1;.tab.:
#3D.8;.LOOP#0A#0A............CASE.'*t':#0A.........
...........$(.wrch('*s')#0A.......................t
ab.:#3D.tab+1#0A....................$).REPEATUNTIL.
tab.REM.8.#3D.0#0A.......................LOOP#0A#0A
............DEFAULT:...wrch(ch);..............tab.:
#3D.tab+1;..LOOP#0A#0A............CASE.endstreamch:
#0A.......................wrch('*n');..............
.............GOTO.exit#0A.........$)#0A......$).REP
EAT#0A...$).REPEAT#0A#0Aexit:#0A...UNLESS.inputstre
am#3D0..DO.$(.selectinput(inputstream);...endread()
..$)#0A...UNLESS.outputstream#3D0.DO.$(.selectoutpu
t(outputstream);.endwrite().$)#0A...RESULTIS.rc#0A$
)#0A

######bcplprogs/tests/ranio.b#
//.This.program.test.random.access.to.files#0A//.fo
r.both.binary.character.i/o.and.record.i/o#2E#0A#0A
//.Implemented.by.Martin.Richards.12/7/04#0A#0ASECT
ION."ranio"#0A#0AGET."libhdr"#0A#0AGLOBAL.{#0A..rec
len:.ug#0A..recno...........//.current.record.numbe
r,.unless.reclen#3D1#0A..rec.............//.The.rec
ord.buffer,.unless.reclen#3D1#0A..mode............/
/.#3D.'C'.or.'X'#0A}#0A#0ALET.start().#3D.VALOF#0A{
.LET.posv.#3D.VEC.1#0A..LET.file,.ramv.#3D.0,.0#0A.
.LET.res.#3D.0#0A..LET.filename.#3D."junk"#0A..LET.
stdin,.stdout.#3D.input(),.output()#0A..LET.argv.#3D
.VEC.30#0A#0A..UNLESS.rdargs("FILE",.argv,.30).DO#0A
..{.writef("Bad.arguments.for.seek*n")#0A....stop(2
0)#0A..}#0A#0A..IF.argv!0.DO.filename.:#3D.argv!0#0A
#0A..writef("*nFile:.%s*n",.filename)#0A#0A..TEST.c
ompstring(filename,."ram")#3D0#0A..THEN.{.LET.bufen
d.#3D.1000.//.Ie.room.for.1000.bytes#0A.........LET
.end.#3D.100#0A.........ramv.:#3D.getvec((bufend-1)
/bytesperword)#0A.........FOR.i.#3D.0.TO.bufend-1.D
O.ramv%i.:#3D.0#0A.........FOR.i.#3D.0.TO.end-1.DO.
ramv%i.:#3D.'A'.+.i.REM.26#0A.........IF.ramv.DO.fi
le.:#3D.mkramstream(ramv,.bufend,.end)#0A.........w
ritef("RAM.stream.%n.bufen#3D%n..end#3D%n.bytes.cre
ated*n",.file,.bufend,.end)#0A.......}.#0A..ELSE.fi
le.:#3D.findinoutput(filename)#0A#0A..UNLESS.file.D
O#0A..{.writef("Can't.open.file.'%s'*n",.filename)#0A
....stop(20)#0A..}#0A#0A..reclen,.recno,.rec,.mode.
:#3D.1,.0,.0,.'C'#0A..posv!0,.posv!1.:#3D.0,.0#0A#0A
..writef("Current.position.is.0.in.character.mode*n
*n")#0A#0Ahelp:#0A..writef("*nPossible.commands:*n*
n")#0A..writef("H.....Output.help.information*n")#0A
..writef("Q.....Quit*n")#0A..writef("D.....Enter.th
e.debugger*n")#0A..writef("P.n...Point.to.position.
n.in.the.file*n")#0A..writef("L.n...Set.the.record.
length.to.n.(n>0)*n")#0A..writef("N.....Output.the.
current.file.position*n")#0A..writef("R.....Read.an
d.display.on.record.from.this.position*n")#0A..writ
ef("C.....Set.character.mode*n")#0A..writef("X.....
Set.hex.mode*n")#0A..writef("Wc....Write.a.record.f
illed.with.c's.at.this.position*n*n")#0A#0A..{.LET.
ch.#3D.?#0A....writef("*c#23.")#0A....deplete(cos)#0A
....ch.:#3D.rdch()#0A....SWITCHON.capitalch(ch).INT
O#0A....{.DEFAULT:..writef("*nUnexpected.ch#3D%n.'%
c'*n",.ch,.ch);.LOOP#0A......CASE.'H':.GOTO.help#0A
#0A......CASE.'*s':#0A......CASE.'*n':.LOOP#0A#0A..
....CASE.endstreamch:#0A......CASE.'Q':.BREAK#0A#0A
......CASE.'D':.abort(1000);.LOOP#0A....#0A......CA
SE.'P':.TEST.reclen#3D1....................//.Set.f
ile.position#0A................THEN.{.posv!1.:#3D.r
dn()#0A.......................posv!0.:#3D.posv!1../
..4096#0A.......................posv!1.:#3D.posv!1.
REM.4096#0A.......................point(file,.posv)
#0A.....................}#0A................ELSE.{.
recno.:#3D.rdn()#0A.......................IF.recno<
0.DO.recno.:#3D.0#0A.....................}#0A......
..........//.Intentional.fall.through#0A#0A......CA
SE.'N':.TEST.reclen#3D1....................//.Displ
ay.file.position#0A................THEN.{.note(file
,.posv)#0A.......................writef("*nBlock.#3D
.%i4.Pos.#3D.%i4*n",.posv!0,.posv!1)#0A............
...........LOOP#0A.....................}#0A........
........ELSE.{.UNLESS.recordpoint(file,.recno).DO#0A
.......................{.writef("Unable.to.point.to
.record.%n*n",.recno)#0A.........................LO
OP#0A.......................}#0A...................
....recno.:#3D.recordnote(file)#0A.................
......writef("Record.length:.%i6*n",.reclen)#0A....
...................writef("Record.number:.%i6*n",.r
ecno)#0A.....................}#0A................LO
OP#0A#0A......CASE.'L':.reclen.:#3D.rdn()#0A.......
.........UNLESS.reclen>0.DO.reclen.:#3D.1#0A.......
.........IF.rec.DO#0A................{.freevec(rec)
..//.Free.the.record.buffer,.if.any#0A.............
.....rec.:#3D.0#0A................}#0A.............
...IF.reclen#3D1.LOOP........//.Loop.if.single.char
acter.mode#0A................//.Allocate.the.record
.buffer#0A................rec.:#3D.getvec((reclen-1
)/bytesperword)#0A................UNLESS.rec.DO#0A.
...............{.writef("*nCannot.allocate.a.buffer
.for.%n.bytes*n",.reclen)#0A..................recle
n.:#3D.1#0A..................LOOP#0A...............
.}#0A................setrecordlength(file,.reclen)#0A
................writef("Record.length.set.to.%n*n",
.reclen)#0A................LOOP#0A#0A......CASE.'R'
:.TEST.reclen#3D1#0A................THEN.{.selectin
put(file)#0A.......................note(file,.posv)
#0A.......................writef("*nBlock.#3D.%i4.P
os.#3D.%i4..Read:..",#0A...........................
....posv!0,.posv!1)#0A.......................ch.:#3D
.binrdch()#0A.......................selectinput(std
in)#0A.......................TEST.ch#3Dendstreamch#0A
.......................THEN.writef(".EOF*n")#0A....
...................ELSE.writef(".ch.#3D.%i3.'%c'*n"
,.ch,.ch)#0A.....................}#0A..............
..ELSE.{.writef("Record.%i3.(len#3D%n).is:*n",.recn
o,.reclen)#0A.......................TEST.get#2Ereco
rd(rec,.recno,.file)#0A.......................THEN.
{.wrrec(rec)#0A..............................recno.
:#3D.recno+1#0A............................}#0A....
...................ELSE.{.writef(".EOF*n")#0A......
......................}#0A.....................}#0A
................LOOP#0A#0A......CASE.'W':.TEST.recl
en#3D1#0A................THEN.{.note(file,.posv)#0A
.......................ch.:#3D.rdch()#0A...........
............IF.ch#3D'*n'.LOOP#0A...................
....IF.ch#3Dendstreamch.BREAK#0A...................
....writef("*nBlock.#3D.%i4.Pos.#3D.%i4..Write:..ch
.#3D.%i3.'%c'*n",#0A...............................
posv!0,.posv!1,.ch,.ch)#0A.......................se
lectoutput(file)#0A.......................UNLESS.bi
nwrch(ch).DO#0A.......................{.selectoutpu
t(stdout)#0A.........................writef("Unable
.to.write.'%c'*n",.ch)#0A.......................}#0A
.......................selectoutput(stdout)#0A.....
................}#0A................ELSE.{.ch.:#3D.
rdch()#0A.......................FOR.i.#3D.0.TO.recl
en-1.DO.rec%i.:#3D.ch#0A.......................UNLE
SS.put#2Erecord(rec,.recno,.file).DO#0A............
...........{.writef("unable.to.write.record.number.
%n*n",#0A.................................recno)#0A
.........................LOOP#0A...................
....}#0A.......................writef("record.of.'%
c's.written.at.record.number.%n*n",#0A.............
..................ch,.recno)#0A....................
...recno.:#3D.recno+1#0A.....................}#0A..
..............LOOP#0A#0A......CASE.'C':.mode.:#3D.'
C'#0A................writef("Now.in.character.mode*
n")#0A................LOOP#0A......CASE.'X':.mode.:
#3D.'X'#0A................writef("Now.in.hex.mode*n
")#0A................LOOP#0A....}#0A..}.REPEAT#0A#0A
..newline()#0A#0A..IF.file.DO.endstream(file)#0A..I
F.ramv.DO.freevec(ramv)#0A..RESULTIS.0#0A}#0A#0AAND
.rdn().#3D.VALOF#0A{.LET.res.#3D.0#0A..LET.ch.#3D.r
dch()#0A..WHILE.ch#3D'*s'.DO.ch.:#3D.rdch()#0A..WHI
LE.'0'<#3Dch<#3D'9'.DO#0A..{.res.:#3D.10*res.+.ch.-
'0'#0A....ch.:#3D.rdch()#0A..}#0A..unrdch()#0A..RES
ULTIS.res#0A}#0A#0AAND.wrrec(rec).BE.TEST.mode#3D'C
'#0ATHEN.{.FOR.i.#3D.0.TO.reclen-1.DO#0A.......{.wr
ch(rec%i)#0A.........IF.i.REM.50.#3D.49.DO.newline(
)#0A.......}#0A.......UNLESS.reclen.REM.50.#3D.0.DO
.newline()#0A.......newline()#0A.....}#0AELSE.{.FOR
.i.#3D.0.TO.reclen-1.DO#0A.......{.writef(".%x2",.r
ec%i)#0A.........IF.i.REM.20.#3D.19.DO.newline()#0A
.......}#0A.......UNLESS.reclen.REM.20.#3D.0.DO.new
line()#0A.....}#0A

######bcplprogs/tests/rctest.b#
GET."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.LET.arg
v.#3D.VEC.10#0A..LET.rc.#3D.0#0A#0A..UNLESS.rdargs(
"RETCODE/N",.argv,.10).DO#0A..{.writef("Bad.argumen
ts.for.rctest*n")#0A....RESULTIS.0#0A..}#0A..IF.arg
v!0.DO.rc.:#3D.!(argv!0)#0A..writef("start:.returni
ng.value.%n*n",.rc)#0A..RESULTIS.rc#0A}#0A

######bcplprogs/tests/rdchtest.b#
SECTION."prog"#0A#0AGET."libhdr"#0A#0ALET.start().#3D
.VALOF.{#0A..LET.argv.#3D.VEC.50#0A..LET.buf..#3D.V
EC.50#0A..LET.len..#3D.0#0A#0A..UNLESS.rdargs("x,y/
K,sw/S",.argv,.50).DO#0A..{.writes("Bad.arguments.f
or.PROG*n")#0A....RESULTIS.20#0A..}#0A..writes("The
.arguments.were:*n*n")#0A#0A..writef("arg1:.keyword
.x:....%s*n",.argv!0.->.argv!0,."<not.given>")#0A..
writef("arg1:.keyword.y/K:..%s*n",.argv!1.->.argv!1
,."<not.given>")#0A..writef("arg1:.keyword.sw/S:.%s
*n",.argv!2.->."TRUE",."FALSE")#0A#0A..writes("*nTy
pe.a.line.of.input:.")#0A..deplete(cos)#0A#0A..{.LE
T.ch.#3D.rdch()#0A....IF.ch#3D'*n'.|.ch#3Dendstream
ch.BREAK#0A....len.:#3D.len+1#0A....buf%len.:#3D.ch
#0A..}.REPEAT#0A#0A..buf%0.:#3D.len#0A#0A..writef("
You.typed:.%s*n*n",.buf)#0A..RESULTIS.0#0A}#0A

######bcplprogs/tests/swtest.b#
GET."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.FOR.i.#3D
.0.TO.32.SWITCHON.1<<i.INTO#0A..{.DEFAULT:....write
f("%n.BAD*n",.i);.LOOP#0A....CASE.1<<.0:.writef("%n
.OK*n",.i);.LOOP#0A....CASE.1<<.1:.writef("%n.OK*n"
,.i);.LOOP#0A....CASE.1<<.2:.writef("%n.OK*n",.i);.
LOOP#0A....CASE.1<<.3:.writef("%n.OK*n",.i);.LOOP#0A
....CASE.1<<.4:.writef("%n.OK*n",.i);.LOOP#0A....CA
SE.1<<.5:.writef("%n.OK*n",.i);.LOOP#0A....CASE.1<<
.6:.writef("%n.OK*n",.i);.LOOP#0A....CASE.1<<.7:.wr
itef("%n.OK*n",.i);.LOOP#0A....CASE.1<<.8:.writef("
%n.OK*n",.i);.LOOP#0A....CASE.1<<.9:.writef("%n.OK*
n",.i);.LOOP#0A....CASE.1<<10:.writef("%n.OK*n",.i)
;.LOOP#0A....CASE.1<<11:.writef("%n.OK*n",.i);.LOOP
#0A....CASE.1<<12:.writef("%n.OK*n",.i);.LOOP#0A...
.CASE.1<<13:.writef("%n.OK*n",.i);.LOOP#0A....CASE.
1<<14:.writef("%n.OK*n",.i);.LOOP#0A....CASE.1<<15:
.writef("%n.OK*n",.i);.LOOP#0A....CASE.1<<16:.write
f("%n.OK*n",.i);.LOOP#0A....CASE.1<<17:.writef("%n.
OK*n",.i);.LOOP#0A....CASE.1<<18:.writef("%n.OK*n",
.i);.LOOP#0A....CASE.1<<19:.writef("%n.OK*n",.i);.L
OOP#0A....CASE.1<<20:.writef("%n.OK*n",.i);.LOOP#0A
....CASE.1<<21:.writef("%n.OK*n",.i);.LOOP#0A....CA
SE.1<<22:.writef("%n.OK*n",.i);.LOOP#0A....CASE.1<<
23:.writef("%n.OK*n",.i);.LOOP#0A....CASE.1<<24:.wr
itef("%n.OK*n",.i);.LOOP#0A....CASE.1<<25:.writef("
%n.OK*n",.i);.LOOP#0A....CASE.1<<26:.writef("%n.OK*
n",.i);.LOOP#0A....CASE.1<<27:.writef("%n.OK*n",.i)
;.LOOP#0A....CASE.1<<28:.writef("%n.OK*n",.i);.LOOP
#0A....CASE.1<<29:.writef("%n.OK*n",.i);.LOOP#0A...
.CASE.1<<30:.writef("%n.OK*n",.i);.LOOP#0A....CASE.
1<<31:.writef("%n.OK*n",.i);.LOOP#0A..}#0A}#0A

######bcplprogs/tests/t8.b#
GET."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.writef(
"Unicode.Character.Set*n*n")#0A#0A..FOR.code.#3D.0.
TO.#23x3FFF.DO#0A..{.IF.code.MOD.16.#3D.0.DO.writef
(."*n%x4:.",.code)#0A....writef(".%#23",.code)#0A..
}#0A..newline()#0A..RESULTIS.0#0A}#0A

######bcplprogs/tests/test.b#
GLOBAL.{.f:234.}#0A#0ALET.f(n).#3D.n+1#0A#0A#2E#0A#0A
GET."libhdr"#0A#0AGLOBAL.{.f:234.}#0A#0ALET.start()
.#3D.VALOF#0A{.LET.n.#3D.100#0A..writef("f(%n).#3D.
%n*n",.n,.f(n))#0A..RESULTIS.0#0A}#0A#0A#2E#0A#0A

######bcplprogs/tests/trnerrs.b#
//.This.is.a.BCPL.program.designed.to.test.the#0A//
.translation.phase.error.messages.of.the.BCPL.compi
ler#2E#0A#0AGLOBAL.$(.g200:200;.g201:201..$)#0A#0AS
TATIC.$(.S1#3D0;.s2#3D0..$)#0A#0AMANIFEST.$(.m1#3D1
;.m2#3D2..$)#0A#0ALET.start().BE#0A$(.LET.a,.b,.c,.
d.#3D.1,.2,.3,.4#0A#0A...trans()#0A$)#0A#0AAND.tran
s().BE#0A$(.LET.x,.y,.z.#3D.1,.2,.3#0A...LET.p,.q.#3D
.5,.6,.7#0A...UNTIL.x#3D0.DO#0A...$(.IF.x#3D0.BREAK
#0A......IF.y#3D0.LOOP#0A......IF.z#3D0.FINISH#0A..
....IF.g200#3D0.ENDCASE#0A......IF.g201#3D0.RESULTI
S.1234#0A......#0A......CASE.12345:#0A.......#0A...
...x.:#3D.1#0A.......#0A......DEFAULT:#0A......x:#3D
2#0A......SWITCHON.x.INTO#0A......$(.CASE.1:#0A....
.....CASE.2:#0A.........DEFAULT:#0A.........CASE.3:
#0A.........CASE.1+1:#0A.........DEFAULT:.ENDCASE#0A
......$)#0A.......#0A......x:#3D.x-1#0A...$)#0A....
#0A...$(.LET.aaa,bbb,ccc,aaa.#3D.1,2,3,4#0A......AN
D.bbb.#3D.5#0A......LET.f(p,q).#3D.x*p.+.g201+y#0A.
.....x.:#3D.@(x+1)#0A......x.:#3D.@.m1#0A......FOR.
i.#3D.1.TO.10.BY.3/(m1-1).DO.x.:#3D.x+1#0A......x,y
.:#3D.1#0A......x,y.:#3D.1,2,3#0A...$)#0A$)#0A#0A

######bcplprogs/tests/tstcalls.b#
GET."libhdr"#0A#0AGLOBAL.{#0A.g11:11#0A.g300:300#0A
.g400:400#0A.g600:600#0A.argv:ug#0A}#0A#0ALET.start
().#3D.VALOF#0A{.LET.a,b,c,d.#3D.g400,0,0,0#0A..arg
v.:#3D.TABLE.0,0,0,0,0,.0,0,0,0,0,#0A..............
..0,0,0,0,0,.0,0,0,0,0,.0#0A..UNLESS.rdargs("K7/S,K
7G/S,K7G1/S,K7GH/S,K/S,KH/S,KW/S,G1/S,G2/S,G3/S",#0A
.................argv,.20).DO#0A..{.writef("Bad.arg
uments.for.tstcalls*n")#0A....RESULTIS.0#0A..}#0A#0A
..writef("Testing.Cintcode.calling.instructions*n")
#0A#0A..IF.argv!0.DO.a().....//.K7#0A..IF.argv!1.DO
.g11()...//.K7G#0A..IF.argv!2.DO.g300()..//.K7G1#0A
..IF.argv!3.DO.g600()..//.K7GH#0A#0A..IF.argv!4.DO#0A
..{.LET.v.#3D.VEC.100#0A....g11()...//.K.109#0A..}#0A
#0A..IF.argv!5.DO#0A..{.LET.v.#3D.VEC.5000#0A....g3
00()...//.KH.5009#0A..}#0A#0A..IF.argv!6.DO#0A..{.L
ET.v.#3D.VEC.70000#0A....g600()...//.KW.70009#0A..}
#0A#0A..IF.argv!7.GOTO.0#0A..IF.argv!8.GOTO.-1#0A..
IF.argv!9.GOTO.-1000000000#0A#0A..RESULTIS.0#0A}#0A


######bcplprogs/tests/tstinput.b#
GET."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.writef(
"Read.characters.from.so.called.standard.input*n")#0A
#0A..FOR.i.#3D.1.TO.50.DO#0A..{.LET.ch.#3D.rdch()#0A
....TEST.ch#3Dendstreamch#0A....THEN.{.writef("ch#3D
endstreamch*n")#0A...........BREAK#0A.........}#0A.
...ELSE.writef("ch#3D.%i3.'%c'*n",.ch,.ch)#0A....IF
.ch#3D'#2E'.|.ch#3Dendstreamch.BREAK#0A..}#0A#0A..w
ritef("*nEnd.of.test*n")#0A}#0A

######bcplprogs/tests/tstmdiv.b#
GET."libhdr"#0A#0AGLOBAL.{.errors:ug;.verbose.}#0A#0A
LET.start().#3D.VALOF#0A{.LET.a,.b,.c,.count.#3D.0,
.0,.0,.0#0A..LET.argv.#3D.VEC.50#0A#0A..UNLESS.rdar
gs("COUNT,V/S",.argv,.50).DO#0A..{.writef("Bad.argu
ments.for.TSTMDIV*n")#0A....RESULTIS.20#0A..}#0A#0A
..errors.:#3D.0#0A#0A..UNLESS.argv!0.DO#0A..{.{.wri
tes("*nType.three.numbers.for.muldiv:..")#0A......a
.:#3D.readn()#0A......b.:#3D.readn()#0A......c.:#3D
.readn()#0A......IF.c#3D0.BREAK#0A......writef("...
.muldiv(%n,.%n,.%n).gives.%n..",.a,.b,.c,.muldiv(a,
.b,.c))#0A......writef("remainder.%n*n",.result2)#0A
......writef("old.muldiv(%n,.%n,.%n).gives.%n..",.a
,.b,.c,.sys(26,.a,.b,.c))#0A......writef("remainder
.%n*n",.result2)#0A....}.REPEAT#0A#0A....writef("*n
End.of.test*n")#0A....RESULTIS.0#0A..}#0A#0A..count
.:#3D.str2numb(argv!0)#0A..verbose.:#3D.argv!1#0A#0A
..FOR.i.#3D.0.TO.count.DO#0A..{.LET.rana.#3D.randno
(1000000000).#0A....LET.ranb.#3D.randno(1000000000)
#0A....LET.ranc.#3D.randno(1000000000)#0A#0A....IF.
verbose.DO.writef("*ntest.%n/%n*n",.i,.count)#0A#0A
....try(maxint+i,.maxint+i,.maxint+i)#0A....try(max
int+i,.maxint+i,.maxint-i)#0A....try(maxint+i,.maxi
nt-i,.maxint+i)#0A....try(maxint+i,.maxint-i,.maxin
t-i)#0A....try(maxint-i,.maxint+i,.maxint+i)#0A....
try(maxint-i,.maxint+i,.maxint-i)#0A....try(maxint-
i,.maxint-i,.maxint+i)#0A....try(maxint-i,.maxint-i
,.maxint-i)#0A#0A....try(.rana,..ranb,..ranc)#0A...
.try(.rana,..ranb,.-ranc)#0A....try(.rana,.-ranb,..
ranc)#0A....try(.rana,.-ranb,.-ranc)#0A....try(-ran
a,..ranb,..ranc)#0A....try(-rana,..ranb,.-ranc)#0A.
...try(-rana,.-ranb,..ranc)#0A....try(-rana,.-ranb,
.-ranc)#0A#0A....try(.maxint+i,..ranb,..ranc)#0A...
.try(.maxint+i,..ranb,.-ranc)#0A....try(.maxint+i,.
-ranb,..ranc)#0A....try(.maxint+i,.-ranb,.-ranc)#0A
....try(-maxint+i,..ranb,..ranc)#0A....try(-maxint+
i,..ranb,.-ranc)#0A....try(-maxint+i,.-ranb,..ranc)
#0A....try(-maxint+i,.-ranb,.-ranc)#0A#0A....try(.m
axint-i,..ranb,..ranc)#0A....try(.maxint-i,..ranb,.
-ranc)#0A....try(.maxint-i,.-ranb,..ranc)#0A....try
(.maxint-i,.-ranb,.-ranc)#0A....try(-maxint-i,..ran
b,..ranc)#0A....try(-maxint-i,..ranb,.-ranc)#0A....
try(-maxint-i,.-ranb,..ranc)#0A....try(-maxint-i,.-
ranb,.-ranc)#0A..}#0A#0A..TEST.errors#0A..THEN.writ
ef("There.were.%n.errors*n",.errors)#0A..ELSE.write
f("There.were.no.errors*n")#0A..RESULTIS.0#0A}#0A#0A
AND.try(a,.b,.c).BE#0A{.try1(a,b,c)#0A..try1(a,c,b)
#0A..try1(b,a,c)#0A..try1(b,c,a)#0A..try1(c,a,b)#0A
..try1(c,b,a)#0A}#0A#0AAND.try1(a,.b,.c).BE#0A{.LET
.q1,.r1,.q2,.r2.#3D.0,.0,.0,.0#0A..IF.c#3D0.RETURN#0A
..IF.verbose.DO.writef("%x8.**.%x8./.%x8",.a,.b,.c)
....#0A..q1.:#3D.muldiv(a,.b,.c)#0A..r1.:#3D.result
2#0A..IF.verbose.DO.writef(".#3D>.%x8.remainder.%x8
*n",.q1,.r1)#0A..q2.:#3D.sys(26,.a,.b,.c)#0A..r2.:#3D
.result2#0A#0A..IF.q1~#3Dq2.|.r1~#3Dr2.DO#0A..{.wri
tef("....muldiv(%x8,.%x8,.%x8).#3D>.%x8..",.a,.b,.c
,.q1)#0A....writef("remainder.%x8*n",.r1)#0A....wri
tef("old.muldiv(%x8,.%x8,.%x8).#3D>.%x8..",.a,.b,.c
,.q2)#0A....writef("remainder.%x8*n",.r2)#0A....err
ors.:#3D.errors+1#0A..}#0A}#0A

######bcplprogs/tests/tstmic.b#
GET."libhdr"#0A#0AMANIFEST.{#0A..bufsize.#3D.1024#0A
..bufbytes.#3D.bufsize.*.bytesperword#0A}#0A#0ALET.
start().#3D.VALOF#0A{.LET.audio_fd.#3D.0#0A..LET.mi
cname.#3D."/dev/dsp1"#0A..LET.format.#3D.16..//.S16
_LE#0A..LET.channels.#3D.1.//.Mono#0A..LET.rate.#3D
.44100.//.Samples.per.second#0A..LET.buf.#3D.VEC.bu
fsize-1#0A#0A..writef("tstmic.entered*n")#0A#0A..wr
itef("sys(Sys_sound,.0,#2E#2E#2E).#3D>.%n*n",.sys(S
ys_sound,.0,.11,.22,.33,.44))#0A#0A..UNLESS.sys(Sys
_sound,.0,.11,.22,.33,.44).DO#0A..{.writef("Sound.n
ot.available*n")#0A....RESULTIS.0#0A..}#0A#0A..writ
ef("Trying.to.open.device.%s*n",.micname)#0A#0A..au
dio_fd.:#3D.sys(Sys_sound,.1,.micname,.format,.chan
nels,.rate)#0A#0A..writef("audio_fd.#3D.%n*n",.audi
o_fd)#0A#0A..FOR.i.#3D.1.TO.8.DO#0A..{.LET.len.#3D.
sys(Sys_sound,.2,.audio_fd,.buf,.bufbytes,.0)#0A...
.writef("len#3D%n*n",.len)#0A....FOR.i.#3D.0.TO.buf
size-1.DO#0A....{.LET.w.#3D.buf!i#0A......LET.a.#3D
.(w.<<.16)./.#23x1_0000#0A......LET.b.#3D.w./.#23x1
_0000#0A......IF.i.MOD.8.#3D.0.DO.newline()#0A.....
.writef(".%i6.%i6",.a,.b)#0A....}#0A....newline()#0A
..}#0A#0A..writef("Closing.audio_fd*n")#0A#0A..audi
o_fd.:#3D.sys(Sys_sound,.3,.audio_fd,.0,.0,.0)#0A#0A
..writef("return.code.#3D.%n*n",.audio_fd)#0A#0A..R
ESULTIS.0#0A}#0A

######bcplprogs/tests/tstsardch.b#
GET."libhdr"#0A#0AGLOBAL.{.nullfn:200;.f.}#0A#0ALET
.start().#3D.VALOF#0A{.LET.v.#3D.VEC.10#0A..LET.n.#3D
.0#0A..writef("*nType.10.characters,.or.terminate.w
ith.a.dot(#2E)*n*n")#0A#0A..{.LET.ch.#3D.sardch()#0A
....n.:#3D.n+1#0A....v!n.:#3D.ch#0A....IF.ch#3D'#2E
'.BREAK#0A..}.REPEATUNTIL.n>#3D10#0A#0A..writef("*n
*n%n.characters.were.received.as.follows:*n*n",.n)#0A
..FOR.i.#3D.1.TO.n.DO.writef("%i2:.%i3..<%c>*n",.i,
.v!i,.v!i)#0A#0A..RESULTIS.0#0A}#0A

######bcplprogs/tests/tstskip.b#
GLOBAL.{.start:1.}#0A#0ALET.start().BE#0A{.#0A}#0A

######bcplprogs/tests/tstslct.b#
GET."libhdr"#0A#0AMANIFEST.{#0A.a.#3D.SLCT.1#0A.b.#3D
.SLCT.8:1#0A.c.#3D.SLCT.8:13:1#0A}#0A#0ALET.start()
.#3D.VALOF#0A{.LET.v.#3D.VEC.10#0A..LET.x,.y,.z.#3D
.0,.0,.0#0A..LET.opts.#3D."abc"#0A..FOR.i.#3D.0.TO.
10.DO.v!i.:#3D.0#0A..FOR.i.#3D.0.TO.opts%0.DO.v!i.:
#3D.0#0A..v!1.:#3D.#23b11100011_00101000_11111111_1
0110111#0A..x.:#3D.a.OF.v#0A..y.:#3D.b.::.v#0A..z.:
#3D.c.OF.v#0A#0A..writef("..........%bW*n",.v!1)#0A
..writef("%x8:.%bW*n",.a,.x)#0A..writef("%x8:.%bW*n
",.b,.y)#0A..writef("%x8:.%bW*n",.c,.z)#0A#0A..a.OF
.v.:#3D.10#0A..b::v.:#3D.11#0A..c::v.:#3D.12#0A..wr
itef("..........%bW*n",.v!1)#0A..RESULTIS.0#0A}

######bcplprogs/tests/tstsound.b#
GET."libhdr"#0A#0AMANIFEST.{#0A..bufsize.#3D.1024#0A
}#0A#0ALET.start().#3D.VALOF#0A{.LET.audio_fd.#3D.0
#0A..LET.micname.#3D."/dev/dsp1"#0A..LET.format.#3D
.16..//.S16_LE#0A..LET.channels.#3D.1.//.Mono#0A..L
ET.rate.#3D.48000.//.Samples.per.second#0A..LET.buf
.#3D.VEC.bufsize-1#0A#0A..writef("tstsound.entered*
n")#0A#0A..writef("sys(Sys_sound,.0,#2E#2E#2E).#3D>
.%n*n",.sys(Sys_sound,.0,.11,.22,.33,.44))#0A#0A..U
NLESS.sys(Sys_sound,.0,.11,.22,.33,.44).DO#0A..{.wr
itef("Sound.not.available*n")#0A....RESULTIS.0#0A..
}#0A#0A..writef("Trying.to.open.device.%s*n",.micna
me)#0A#0A..audio_fd.:#3D.sys(Sys_sound,.1,.micname,
.format,.channels,.rate)#0A#0A..writef("audio_fd.#3D
.%n*n",.audio_fd)#0A#0A..FOR.i.#3D.1.TO.10.DO#0A..{
.LET.len.#3D.sys(Sys_sound,.2,.audio_fd,.buf,.bufsi
ze,.0)#0A....writef("len#3D%n*n",.len)#0A....FOR.i.
#3D.0.TO.bufsize-1.DO#0A....{.LET.w.#3D.buf!i#0A...
...LET.a.#3D.(w.<<.16)./.#23x1000#0A......LET.b.#3D
.w./.#23x1000#0A......IF.i.MOD.8.#3D.0.DO.newline()
#0A......writef(".%i6.%i6",.a,.b)#0A....}#0A....new
line()#0A..}#0A#0A..writef("Closing.audio_fd*n")#0A
#0A..audio_fd.:#3D.sys(Sys_sound,.3,.audio_fd,.0,.0
,.0)#0A#0A..writef("return.code.#3D.%n*n",.audio_fd
)#0A#0A..RESULTIS.0#0A}#0A

######bcplprogs/tests/tstwin32wav.b#
/*#0AThis.is.a.test.program.for.wave.input.and.wave
.output.devices#2E#0A#0AImplemented.by.Martin.Richa
rds.(c).September.2008#0A#0AUsage:.tstwin32wav."SEC
S/N,TO/K"#0A#0ARecord.<secs>.worth.of.samples.into.
a.buffer.of.signed.integers#2E#0AIf.TO.is.specified
.output.the.samples.as.a.#2Ewav.file#2E#0A#0AThe.de
fault.for.SECS.is.one#0Aand.the.default.#2Ewav.file
name.is.res#2Ewav#0A#0A#0A*/#0A#0AGET."libhdr"#0AGE
T."sound#2Eh"#0A#0AGLOBAL.{#0A..buf:ug#0A..bufsize.
//.Number.of.samples.in.the.buffer#0A..secs....//.N
umber.of.seconds.of.recorded.data#0A..tofilename.//
.#2Ewav.file.name#0A..tostream#0A..stdout#0A..play#0A
}#0A#0ALET.start().#3D.VALOF#0A{.LET.waveInCB.#3D.0
#0A..LET.devname.#3D.0#0A..LET.format.#3D.16..//.S1
6_LE#0A..LET.channels.#3D.1.//.Mono#0A..LET.rate.#3D
.44100.//.Samples.per.second#0A..LET.argv.#3D.VEC.5
0#0A#0A..stdout.:#3D.output()#0A..tostream.:#3D.0#0A
..play.:#3D.FALSE#0A#0A..writef("tstwin32wav.entere
d*n")#0A#0A..UNLESS.rdargs("SECS/N,TO/K,PLAY/S",.ar
gv,.50).DO#0A..{.writef("Bad.arguments.for.tstwin32
wav*n")#0A....RESULTIS.0#0A..}#0A#0A..secs.:#3D.5#0A
..tofilename.:#3D."res#2Ewav"#0A..IF.argv!0.DO.secs
.:#3D.!(argv!0).....//.SECS/N#0A..IF.argv!1.DO.tofi
lename.:#3D.argv!1..//.TO/K#0A..play.:#3D.argv!2...
..................//.PLAY/S#0A#0A..bufsize.:#3D.rat
e.*.secs.*.channels#0A#0A..TEST.sys(Sys_sound,.snd_
test)#3D-1#0A..THEN.writef("Sound.is.available*n")#0A
..ELSE.writef("Sound.is.not.available*n")#0A#0A..bu
f.:#3D.getvec(bufsize-1)#0A..UNLESS.buf.DO#0A..{.wr
itef("Unable.to.allocate.a.buffer.of.size.%n*n",.bu
fsize)#0A....RESULTIS.0#0A..}#0A#0A..//writef("Tryi
ng.to.open.wave.input.device.%n*n",.devname)#0A#0A.
.waveInCB.:#3D.sys(Sys_sound,.snd_waveInOpen,.devna
me,.format,.channels,.rate)#0A#0A..//writef("waveIn
CB.#3D.%n*n",.waveInCB)#0A#0A..IF.waveInCB#3D-1.DO#0A
..{.writef("Cannot.open.wave.input.device*n")#0A...
.GOTO.fin#0A..}#0A#0A..writef("*nRecording.%n.secon
d%-%ps.of.samples*n",.secs)#0A#0A..{.LET.count.#3D.
0.//.Count.of.samples.read#0A#0A....UNTIL.count>#3D
bufsize.DO#0A....{.LET.len.#3D.sys(Sys_sound,#0A...
.................snd_waveInRead,.waveInCB,.buf+coun
t,.bufsize-count,.0)#0A......count.:#3D.count+len#0A
......//IF.len.DO.writef("len.#3D.%i5.count.#3D.%i7
.bufsize#3D%i7*n",#0A......//.................len,.
count,.bufsize)#0A....}#0A#0AIF.FALSE.DO#0A....FOR.
i.#3D.0.TO.bufsize-1.DO#0A....{.IF.i.MOD.10.#3D.0.D
O.writef("*n%i8:.",.i)#0A......writef(".%i6",.buf!i
)#0A....}#0A....newline()#0A..}#0A#0A..//writef("Cl
osing.waveInCB*n")#0A#0A..waveInCB.:#3D.sys(Sys_sou
nd,.snd_waveInClose,.waveInCB)#0A#0A..//.Output.the
.#2Ewav.file#0A..tostream.:#3D.findoutput(tofilenam
e)#0A..UNLESS.tostream.DO#0A..{.writef("Unable.to.o
pen.%s.for.output*n",.tofilename)#0A....GOTO.fin#0A
..}#0A..#0A..selectoutput(tostream)#0A#0A..riffhdr(
1,.........//.mode.#3D.mono#0A..........rate,......
//.typically.44100#0A..........16,........//.bits.p
er.sample#0A..........bufsize*2).//.number.of.bytes
.of.data#0A..FOR.i.#3D.0.TO.bufsize-1.DO#0A..{.LET.
w.#3D.buf!i#0A....binwrch(w)#0A....binwrch(w>>8)#0A
..}#0A..endwrite()#0A..tostream.:#3D.0#0A#0A..selec
toutput(stdout)#0A#0A..IF.play.DO.playvec(buf,.bufs
ize,.format,.channels,.rate)#0A#0Afin:#0A..IF.buf.D
O.freevec(buf)#0A..IF.tostream.DO.endstream(tostrea
m)#0A..selectoutput(stdout)#0A..//writef("return.co
de.#3D.%n*n",.0)#0A#0A..RESULTIS.0#0A}#0A#0AAND.rif
fhdr(mode,.rate,.bits,.databytes).BE#0A{.LET.bytes_
per_sample.#3D.bits/8.*.mode#0A..LET.byte_rate.#3D.
bytes_per_sample.*.rate#0A..writes("RIFF")......../
/..0:.R.I.F.F#0A..wr4(36+0).............//..4:.size
.of.this.file.-.8#0A..writes("WAVE")........//..8:.
W.A.V.E#0A..writes("fmt.")........//.12:.f.m.t#0A..
wr4(16)...............//.16:.fmt.subchunk.size.is.1
6#0A..wr2(1)................//.20:.1.#3D.linear.qua
ntisation#0A..wr2(mode).............//.22:.1.#3D.mo
no,.2#3Dstereo#0A..wr4(rate).............//.24:.sam
ples.per.second#0A..wr4(byte_rate)........//.28:.by
tes.per.second#0A..wr2(bytes_per_sample).//.32:.bit
s/8.*.mode..#3D.1,.2.or.4#0A..wr2(bits)............
.//.34:.bits.per.sample..#3D.8.or.16#0A..writes("da
ta")........//.36:.d.a.t.a#0A..//wr4(byte_rate.*.1)
....//.40:.number.of.bytes.of.data.or.zero#0A..wr4(
databytes)........//.40:.number.of.bytes.of.data.or
.-1#0A}#0A#0AAND.wr2(w).BE#0A{.LET.s.#3D.@w#0A..bin
wrch(s%0)#0A..binwrch(s%1)#0A}#0A#0AAND.wr4(w).BE#0A
{.LET.s.#3D.@w#0A..binwrch(s%0)#0A..binwrch(s%1)#0A
..binwrch(s%2)#0A..binwrch(s%3)#0A}#0A#0AAND.playve
c(buf,.bufsize,.format,.channels,.rate).BE#0A{.LET.
waveOutCB.#3D.sys(Sys_sound,#0A....................
..snd_waveOutOpen,.0,.format,.channels,.rate)#0A#0A
..//writef("waveOutCB.#3D.%n.format#3D%n.channels#3D
%n.rate#3D%n*n",#0A..//.......waveOutCB,.format,.ch
annels,.rate)#0A#0A..IF.waveOutCB#3D-1.DO#0A..{.wri
tef("Cannot.open.wave.output.device*n")#0A....RETUR
N#0A..}#0A#0A..//writef("*nPlaying.%n.samples*n",.b
ufsize)#0A#0A..{.LET.count.#3D.0.//.Count.of.sample
s.sent.and.accepted#0A#0A....UNTIL.count>#3Dbufsize
.DO#0A....{.LET.len.#3D.sys(Sys_sound,#0A..........
..........snd_waveOutWrite,.waveOutCB,.buf+count,.b
ufsize-count)#0A......count.:#3D.count+len#0A......
//IF.len.DO.writef("len.#3D.%i5.count.#3D.%i7.bufsi
ze#3D%i7*n",#0A......//.................len,.count,
.bufsize)#0A......IF.len<0.BREAK#0A//writef("Delayi
ng.1.second*n")#0A......sys(Sys_delay,.1)#0A....}#0A
#0A..}#0A#0A..sys(Sys_sound,.snd_waveOutClose,.wave
OutCB)#0A}#0A

######bcplprogs/tests/tstwritef.b#
SECTION."tstwritef"#0A#0AGET."libhdr"#0A#0AGLOBAL.{
.g:ug.}#0A#0AMANIFEST.{.}#0A#0ASTATIC.{}#0A#0AGLOBA
L.{}#0A#0ALET.start().#3D.VALOF#0A{.//LET.a.#3D.""#0A
..//LET.b.#3D."A"#0A..//LET.c.#3D."AB"#0A..//LET.d.
#3D."ABC"#0A..//LET.e.#3D."ABCD"#0A..//LET.f.#3D."A
BCDE"#0A..//LET.g.#3D."ABCDEF"#0A..//LET.h.#3D."ABC
DEFG"#0A..//LET.i.#3D."ABCDEFGH"#0A..//LET.j.#3D."A
BCDEFGHI"#0A..LET.plat.#3D.sys(Sys_platform)#0A..wr
itef("Platform.number.#3D.%n*n",.plat)#0A#0A..write
f("Test.new.writef.formats*n")#0A#0A..writef("%10i*
n",.1234)#0A..writef("%iA*n",.1234)#0A..writef("%10
#2E2d*n",.1234)#0A..writef("%10#2E2d*n",.-1234)#0A.
.writef("%10#2E0d*n",.1234)#0A..writef("%10#2E0d*n"
,.-1234)#0A#0A..FOR.d.#3D.100.TO.500.BY.25.DO.//.Sc
aled.decimal.with.2.digit.after#0A.................
.............//.the.decimal.point#0A..{.writef("Del
ay.for.%4#2E2d.seconds*n",.d)#0A....sys(Sys_delay,.
(tickspersecond*d)/100)#0A..}#0A#0A..RESULTIS.0#0A}
#0A#0A

######bcplprogs/tests/unicode.b#
//.This.is.to.test.the.Unicode.feature.of.the.syste
m#2E#0A#0AGET."libhdr"#0A#0ALET.start().#3D.VALOF#0A
{.LET.stdout,.outstream.#3D.output(),.0#0A..LET.arg
v.#3D.VEC.20#0A#0A..UNLESS.rdargs("TO",.argv,.20).D
O#0A..{.writef("Bad.args.for.chars*n")#0A....RESULT
IS.0#0A..}#0A#0A..IF.argv!0.DO.outstream.:#3D.findo
utput(argv!0)#0A#0A..IF.outstream.DO#0A..{.writef("
Writing.Unicode.characters.in.UTF-8.format.to.strea
m.%s*n",#0A............argv!0)#0A....selectoutput(o
utstream)#0A..}#0A#0A..//binwrch(27);.writes("%@").
//.Return.to.ISO-2022.mode#0A..//binwrch(27);.write
s("%G").//.Enter.RTF-8.mode#0A#0A..writef("char.con
stant.%x4*n",.'*#2312FE')#0A..writef("Using.string.
escapes:.**#2300a9:.*#2300a9*n")#0A..writef("Using.
string.escapes:.**#232260:.*#232260*n")#0A..writef(
"Using.string.escapes:.**#238140:.*#238140*n")#0A..
writef("Using.string.escapes:.**#238141:.*#238141*n
")#0A..writef("Using.string.escapes:.**#238142:.*#23
8142*n")#0A..writef("Using.string.escapes:.**#23312
0:.*#233120*n")#0A..writef("Using.string.escapes:.*
*#233121:.*#233121*n")#0A..writef("Using.string.esc
apes:.**#233122:.*#233122*n")#0A..writef("Using.str
ing.escapes:.**#233123:.*#233123*n")#0A..writef("Us
ing.string.escapes:.**#233124:.*#233124*n")#0A..wri
tef("Using.string.escapes:.**#233125:.*#233125*n")#0A
#0A..newline()#0A..tst("copyright.sign.",.#23xa9)#0A
..tst("not.equals.sign",.#23x2260)#0A..tst("a.chine
se.char.",.#23x8140)#0A..tst("a.chinese.char.",.#23
x8141)#0A..tst("a.chinese.char.",.#23x8142)#0A..FOR
.i.#3D.0.TO.12.DO#0A....tst("a.chinese.char.",.#23x
3120+i)#0A#0A..//binwrch(27);.writes("%@").//.Retur
n.to.ISO-2022.mode#0A..newline()#0A#0A..IF.outstrea
m.DO.endstream(outstream)#0A..selectoutput(stdout)#0A
..RESULTIS.0#0A}#0A#0AAND.tst(mess,.ch).BE#0A{.writ
ef("%s:.Unicode.%x4.%#23.",.mess,.ch,.ch)#0A..wr_ut
f8(wrb8,.ch).//.Write.the.UTF-8.code.in.binary#0A..
newline()#0A}#0A#0AAND.wr_utf8(f,.ch).BE#0A{.//.Con
vert.a.Unicode.character.to.RTF-8.format#0A..IF.ch<
#3D#23x7F.DO#0A..{.f(ch)...................//.0xxxx
xxx#0A....RETURN#0A..}#0A..IF.ch<#3D#23x7FF.DO#0A..
{.f(#23b1100_0000+(ch>>6))..//.110xxxxx#0A....f(#23
x80+(.ch....&#23x3F))..//.10xxxxxx#0A....RETURN#0A.
.}#0A..IF.ch<#3D#23xFFFF.DO#0A..{.f(#23b1110_0000+(
ch>>12)).//.1110xxxx#0A....f(#23x80+((ch>>6)&#23x3F
))..//.10xxxxxx#0A....f(#23x80+(.ch....&#23x3F))../
/.10xxxxxx#0A....RETURN#0A..}#0A..IF.ch<#3D#23x1F_F
FFF.DO#0A..{.f(#23b1111_0000+(ch>>18)).//.11110xxx#0A
....f(#23x80+((ch>>12)&#23x3F)).//.10xxxxxx#0A....f
(#23x80+((ch>>6)&#23x3F))..//.10xxxxxx#0A....f(#23x
80+(.ch....&#23x3F))..//.10xxxxxx#0A....RETURN#0A..
}#0A..IF.ch<#3D#23x3FF_FFFF.DO#0A..{.f(#23b1111_100
0+(ch>>24)).//.111110xx#0A....f(#23x80+((ch>>18)&#23
x3F)).//.10xxxxxx#0A....f(#23x80+((ch>>12)&#23x3F))
.//.10xxxxxx#0A....f(#23x80+((ch>>6)&#23x3F))..//.1
0xxxxxx#0A....f(#23x80+(.ch....&#23x3F))..//.10xxxx
xx#0A....RETURN#0A..}#0A..IF.ch<#3D#23x7FFF_FFFF.DO
#0A..{.f(#23b1111_1100+(ch>>30)).//.1111110x#0A....
f(#23x80+((ch>>24)&#23x3F)).//.10xxxxxx#0A....f(#23
x80+((ch>>18)&#23x3F)).//.10xxxxxx#0A....f(#23x80+(
(ch>>12)&#23x3F)).//.10xxxxxx#0A....f(#23x80+((ch>>
.6)&#23x3F)).//.10xxxxxx#0A....f(#23x80+(.ch.....&#23
x3F)).//.10xxxxxx#0A....RETURN#0A..}#0A}#0A#0AAND.w
rb8(byte).BE#0A{.writef("%b8.",.byte)#0A}#0A

######+#
