
######cintcode/g/libhdr.h#
//.Standard.BCPL.header#0A#0A//.Modified.by.Martin.
Richards.(c).27.June.2007#0A#0A/*#0A11/02/04.MR#0AA
dded.binwrch,.removed.packstring,.unpackstring.and.
dqpkt#0A21/10/02.MR#0AMade.compatible.with.libhdr.o
f.the.standard.BCPL.distribution#0A*/#0A#0A#0A//.Gl
obals.used.in.the.standard.(single.threaded).BCPL.C
intcode.System#0AGLOBAL.{#0Aglobsize:............0#0A
start:...............1#0Astop:................2#0As
ys:.................3..//SYSLIB...MR.18/7/01#0Aclih
ook:.............4#0Amuldiv:..............5..//SYSL
IB...changed.to.G:5.MR.6/5/05#0Achangeco:..........
..6..//SYSLIB...MR.6/5/04#0Acurrco:..............7#0A
colist:..............8#0Arootnode:............9..//
.For.compatibility.with.native.BCPL#0Aresult2:.....
.......10#0Areturncode:.........11#0Acis:..........
......12#0Acos:................13#0Acurrentdir:....
.....14#0Alevel:..............15#0Alongjump:.......
....16#0Acreateco:...........17#0Adeleteco:........
...18#0Acallco:.............19#0Acowait:...........
..20#0Aresumeco:...........21#0Ainitco:............
.22#0Astartco:............23#0Aglobin:.............
24#0Agetvec:.............25#0A#0Afreevec:..........
..27#0Aabort:..............28#0Asysabort:..........
.29#0Apackstring:.........30#0Aunpackstring:.......
31#0Agetword:............32#0Aputword:............3
3#0Arandno:.............34#0Asetseed:............35
#0Asardch:.............36#0Asawrch:.............37#0A
rdch:...............38#0Abinrdch:............39#0Au
nrdch:.............40#0Awrch:...............41#0Abi
nwrch:............42#0Adeplete:............43#0Area
dwords:..........44#0Awritewords:.........45#0Ainit
io:.............46#0Asplitname:..........47#0Afindi
nput:..........48#0Afindoutput:.........49#0Afindin
output:.......50#0Afindupdate:.........51#0Afindstr
eam:.........52#0Apathfindinput:......53#0Agetremip
addr:.......54#0Asettimeout:.........55#0Aselectinp
ut:........56#0Aselectoutput:.......57#0Ainput:....
..........58#0Aoutput:.............59#0Aendread:...
.........60#0Aendwrite:...........61#0Aendstream:..
........62#0Anote:...............63#0Apoint:.......
.......64#0Arewindstream:.......65#0Aappendstream:.
......66#0Astepstream:.........67#0Asetrecordlength
:....68#0Arecordpoint:........69#0Arecordnote:.....
....70#0Aget_record:.........71#0Aput_record:......
...72#0Aget_index_record:...73..//.Not.yet.implemen
ted#0Aput_index_record:...74..//.Not.yet.implemente
d#0Acopyobj:............75#0Adeletefile:.........76
#0Arenamefile:.........77#0Afreeobj:............78#0A
copydir:............79#0Alocatedir:..........80#0Al
ocateobj:..........81#0Acreatedir:..........82#0Are
adn:..............83#0Anewline:............84#0Awri
ted:.............85#0Awriten:.............86#0Awrit
ehex:...........87#0Awriteoct:...........88#0Awrite
s:.............89#0Awritet:.............90#0Awriteu
:.............91#0Awritez:.............92#0Aget_tex
tblib:.......93..//BLIB.version#0Aget_text:........
...93..//BLIB.overridden.version#0Awritef:.........
....94..//BLIB#0Asawritef:...........95#0Acapitalch
:..........96#0Acompch:.............97#0Acompstring
:.........98#0Acopystring:.........99#0Astring_to_n
umber:..100#0Astr2numb:..........101#0Ardargs:.....
.......102#0Arditem:............103#0Afindarg:.....
......104#0Aloadseg:...........105#0Aunloadseg:....
.....106#0Acallseg:...........107#0Adatstring:.....
....108#0Adatstamp:..........109#0Adat_to_strings:.
...110#0Astring_to_dat:.....111#0Asetbit:..........
..112#0Atestbit:...........113#0Acopy_words:.......
.114#0Aclear_words:.......115#0Acopy_bytes:........
116#0Asetlogname:........117#0Agetlogname:........1
18#0Aintflag:...........119#0Anewpage:...........12
0#0Ainstrcount:........121#0Asetbulk:...........122
#0Amkramstream:.......123#0Asettimeoutact:.....124#0A
deleteself:........125#0Acodewrch:..........126.//.
Write.an.extended.character.in.UTF8.or.GB2312.forma
t#0Arandseed:..........127#0Auserenv:...........128
.//.User.environment.not.reset.between.commands#0A.
......................//.Initialised.to.zero.when.a
.CLI.starts#0Adelay:.............128.//.delay(msecs
)#0Adelayuntil:........129.//.delayuntil(days,.msec
s)#0A#0A//#23#23#23#23#23.CLI.uses.globals.133.-.14
9.#23#23#23#23#23#0A#0A//#23#23#23#23#23.Cintpos.us
es.globals.150.-.199.#23#23#23#23#23#0A}#0A#0AMANIF
EST.{#0AB2Wsh.#3D.2..//.for.32-.bit.implementations
#0A//B2Wsh#3D3....//.for.64-bit.implementations#0A#0A
tg.#3D.190...//.First.user.global.not.reset.between
.CLI.commands#0Aug.#3D.200...//.First.user.global#0A
#0Abytesperword....#3D.1<<B2Wsh#0Abitsperbyte#09#3D
.8#0Abitsperword#09#3D.bitsperbyte.*.bytesperword#0A
mcaddrinc#09#3D.bytesperword#0Aminint..........#3D.
1<<(bitsperword-1)..//.#3D.#23x80#2E#2E#2E#2E0#0Ama
xint..........#3D.minint.-.1..........//.#3D.#23x7F
#2E#2E#2E#2EF#0A#0Aendstreamch#09#3D.-1..//.ch.retu
rned.at.EOF#0Atimeoutch#09#3D.-2..//.ch.returned.wh
en.none.available.before.timeout#0Apollingch#09#3D.
-3..//.ch.returned.when.none.available.when.polling
#0A#0A//.Object.module.format.types#0A#0At_hunk....
#3D.1000.//.A.hunk.in.ASCII.hex#0At_reloc...#3D.100
1#0At_end.....#3D.1002#0At_hunk64..#3D.2000.//.A.hu
nk.in.ASCII.hex.for.64-bit.Cintcode#0At_reloc64.#3D
.2001#0At_end64...#3D.2002#0At_bhunk...#3D.3000.//.
A.hunk.in.binary#0At_bhunk64.#3D.4000.//.A.hunk.in.
binary.for.64-bit.Cintcode#0A#0Aglobword..#3D.#23xF
FFFFFFF8F8F0000..//.MR.7/9/2006.(for.64-bit.version
)#0Astackword.#3D.#23xFFFFFFFFABCD1234#0Adeadcode..
#3D.#23xFFFFFFFFDEADC0DE#0Asectword..#3D.#23x000000
000000FDDF#0Aentryword.#3D.#23x000000000000DFDF#0A#0A
//.Important.global.variable.numbers#0Ag_globsize.#3D
.0#0Ag_sys......#3D.3#0Ag_currco...#3D.7#0Ag_colist
...#3D.8#0Ag_rootnode.#3D.9#0A#0A//.co-routine.stac
kbase.offsets#0A#0Aco_pptr.#3D.0#0Aco_parent#0Aco_l
ist#0Aco_fn#0Aco_size#0Aco_c#0A#0AInitObj..#3D.0../
/.Initialisation.and.closing.methods.for.objects#0A
CloseObj.#3D.1#0A#0A//.Rootnode.manifests#0A#0Aroot
nodeaddr.#3D.100..//.MR.21/10/02.for.compatibility.
with.Cintpos#0A....................//.Not.used.in.n
ative.code.versions#0A#0Artn_tasktab.#3D.0#0Artn_de
vtab#0Artn_tcblist#0Artn_crntask#0Artn_blklist#0Art
n_tallyv#0A#0Artn_clkintson#0Artn_lastch.........//
.For.sadebug.polling.input#0Artn_insadebug......//.
Looked.at.by.ttyin.device#0A#0Artn_bptaddr......../
/.Breakpoint.addresses......).MR.20/9/02#0Artn_bpti
nstr.......//.Breakpoint.instructions...)#0Artn_dbg
vars........//.The.Standalone.Debug.variables#0A#0A
rtn_clwkq#0Artn_membase#0Artn_memsize#0Artn_info#0A
rtn_sys#0Artn_boot...........//.BOOT.code#0Artn_kli
b...........//.KLIB.code.segments#0Artn_blib.......
....//.BLIB.code.segments#0Artn_keyboard.......//.K
eyboard.stream#0Artn_screen.........//.Screen.strea
m#0A#0Artn_vecstatsv#0Artn_vecstatsvupb#0A#0Artn_in
tflag........//.Set.to.TRUE.by.ctrl-c.and.FALSE.by.
sadebug#0Artn_dumpflag.......//.#3DTRUE.for.memory.
dump.to.DUMP#2Emem#0Artn_envlist........//.List.of.
logical.name.value.pairs#0A...................//.us
ed.by.setlogval.and.getlogval#0Artn_abortcode......
//.Latest.reason.for.leaving.the.interpreter#0Artn_
context........//.Context.of.DUMP#2Emem#0A.........
..........//.1.dump.caused.by.second.SIGINT#0A.....
..............//.2.dump.caused.by.SIGSEGV#0A.......
............//.3.fault.in.BOOT.or.standalone.debug#0A
...................//.4.dump.by.user.calling.sys(Sy
s_quit,.-2)#0A...................//.5.dump.caused.b
y.non.zero.user.fault.code#0A...................//.
6.dump.requestested.from.standalone.debug#0A#0Artn_
lastp..........//.Latest.setting.of.p.pointer.at.SI
GINT.or.SIGSEGV#0Artn_lastg..........//.Latest.sett
ing.of.p.pointer.at.SIGINT.or.SIGSEGV#0Artn_lastst.
........//.Latest.setting.of.st#0A.................
..//.st.#3D.0....in.a.user.task,.interrupts.enabled
#0A...................//.st.#3D.1....in.BOOT,......
..interrupts.disabled#0A...................//.st.#3D
.2....in.KLIB,........interrupts.disabled#0A.......
............//.st.#3D.3....in.the.ISR......interrup
ts.disabled#0A#0Artn_idletcb........//.The.IDLE.TCB
.(for.debugging)#0Artn_adjclock.......//.Real.time.
clock.adjustment.in.minutes#0A#0Artn_dcountv.......
.//.the.Debug.Counts.vectors#0A#0A//.The.following.
four.variables.are.set.by.boot#2Eb#0A//.and.used.by
.programs.such.as.cli#2Eb,.bcpl#2Eb.and.c#2Eb#0A#0A
rtn_rootvar........//.The.environment.variable.givi
ng.the#0A...................//.system.root.director
y,.eg."BCPLROOT".or."POSROOT"#0Artn_pathvar........
//.The.environment.variable.giving.the.directories#0A
...................//.searched.by.loadseg,.eg."BCPL
PATH".or."POSPATH"#0Artn_hdrsvar........//.The.envi
ronment.variable.giving.the.directories#0A.........
..........//.containing.BCPL.headers,.eg."BCPLHDRS"
.or."POSHDRS"#0Artn_scriptsvar.....//.The.environme
nt.variable.giving.the.directories#0A..............
.....//.containing.cli.scripts,.eg."BCPLSCRIPTS".or
."POSSCRIPTS"#0Artn_boottrace......//.#3D0,.1,.2.or
.3.as.set.by.-v.and.-V.options.to#0A...............
....//.trace.the.progress.of.booting.the.system#2E#0A
#0Artn_days...........//.Days.since.1.jan.1970#0Art
n_msecs..........//.Milliseconds.since.midnight#0A#0A
rtn_mc0............//.Machine.address.of.the.start.
of.the#0A...................//.Cintcode.memory#2E#0A
rtn_mc1............//.Other.values.used.by.the.MC.p
ackage#2E#0Artn_mc2..........#0Artn_mc3..........#0A
#0Artn_upb..........#3D.50..//.Leave.some.unused.en
tries#0A#0A//.SYS.functions#0ASys_setcount........#3D
..-1#0ASys_quit............#3D...0#0ASys_rti.......
......#3D...1#0ASys_saveregs........#3D...2#0ASys_s
etst...........#3D...3#0ASys_tracing.........#3D...
4#0ASys_watch...........#3D...5#0ASys_tally........
...#3D...6#0ASys_interpret.......#3D...7#0A#0ASys_s
ardch..........#3D..10#0ASys_sawrch..........#3D..1
1#0ASys_read............#3D..12#0ASys_write........
...#3D..13#0ASys_openread........#3D..14#0ASys_open
write.......#3D..15#0ASys_close...........#3D..16#0A
Sys_deletefile......#3D..17#0ASys_renamefile......#3D
..18#0A#0ASys_getvec..........#3D..21#0ASys_freevec
.........#3D..22#0ASys_loadseg.........#3D..23#0ASy
s_globin..........#3D..24#0ASys_unloadseg.......#3D
..25#0ASys_muldiv..........#3D..26#0ASys_intflag...
......#3D..28#0ASys_setraster.......#3D..29#0ASys_c
putime.........#3D..30#0ASys_filemodtime.....#3D..3
1#0ASys_setprefix.......#3D..32#0ASys_getprefix....
...#3D..33#0ASys_graphics........#3D..34..//.Not.im
plemented#0A#0ASys_seek............#3D..38..//.MR.1
0/11/01#0ASys_tell............#3D..39..//.MR.10/11/
01#0ASys_waitirq.........#3D..40..//.MR..4/02/02#0A
Sys_lockirq.........#3D..41..//.MR.24/02/03#0ASys_u
nlockirq.......#3D..42..//.MR.24/02/03#0ASys_devcom
..........#3D..43..//.MR..4/02/02#0ASys_datstamp...
.....#3D..44..//.MR.29/03/10#0A#0ASys_filesize.....
...#3D..46..//.MR.15/03/02#0ASys_openreadwrite...#3D
..47..//.MR.19/03/02#0ASys_getsysval.......#3D..48.
.//.MR.18/11/02#0ASys_putsysval.......#3D..49..//.M
R.18/11/02#0ASys_shellcom........#3D..50..//.MR.13/
01/03#0ASys_getpid..........#3D..51..//.MR..7/10/03
#0ASys_dumpmem.........#3D..52..//.MR.29/10/03.Used
.only.in.BOOT#2Eb#0ASys_callnative......#3D..53..//
.MR.24/04/04#0ASys_platform........#3D..54..//.MR.0
6/04/05.architecture.and.OS#0ASys_inc.............#3D
..55..//.MR.17/12/04#0ASys_buttons.........#3D..56.
.//.MR.21/06/06.Button.on.the.GP2X#0ASys_delay.....
......#3D..57..//.MR.01/05/10.Delay.until.a.specifi
ed.date.and.time#0ASys_sound...........#3D..58..//.
MR.11/09/07.Sound.functions#0ASys_callc...........#3D
..59..//.MR.28/01/09.Call.the.C.function#0A........
...................//.............callc(args,g)#0AS
ys_trpush..........#3D..60..//.MR.05/02/10.Push.a.t
race.value#0ASys_settrcount......#3D..61..//.MR.05/
02/10.Set.trcount#0ASys_gettrval........#3D..62..//
.MR.05/02/10.Get.a.pushed.trace.value#0A#0Abootregs
.#3D.11.....//.registers.used.by.cintpos.to.start.B
OOT#0Acliregs..#3D.21.....//.registers.used.by.BOOT
.to.start.the.CLI#0A//saveregs.#3D.31.....//.The.re
gisters.are.saved.here.on.interrupt#0A//isrregs..#3D
.41.....//.Registers.for.the.interrupt.service.rout
ine#0A#0Aid_inscb#09#3D.#23x81..//.MR.21/10/02#0Aid
_outscb#09#3D.#23x82..//.MR.21/10/02#0Aid_inoutscb#09
#3D.#23x83..//.MR.21/10/02#0A#0Ascbt_net.....#3D..2
..//.Non.interactive.TCP/IP.stream#0Ascbt_file....#3D
..1..//.Non.interactive.disc.file.stream#0Ascbt_ram
.....#3D..0..//.Non.interactive.RAM.stream#0Ascbt_c
onsole.#3D.-1..//.Interactive.--.output.triggered.b
y.'*n'.etc#0Ascbt_mbx.....#3D.-2..//.Interactive.MB
X.stream#0Ascbt_tcp.....#3D.-3..//.Interactive.TCP/
IP.stream#0A#0Ascb_maxnamelen.#3D.31#0A#0Ascb_id.#3D
.0.........//.id_inscb,.id_outscb.or.id_inoutscb#0A
scb_type...........//.<#3D0.interactive.stream,.>0.
block.file#0Ascb_task...........//.0.or.the.task.as
sociated.with.this.stream#0Ascb_buf............//.0
.or.the.byte.buffer.for.this.stream#0Ascb_pos......
......//.position.of.next.character.to.be.transferr
ed#0Ascb_end............//.number.of.valid.bytes.in
.the.buffer.or.-1#0Ascb_rdfn...........//.zero.or.f
unction.to.replenish.the.buffer#0Ascb_wrfn.........
..//.zero.or.function.to.deplete.the.buffer#0Ascb_e
ndfn..........//.zero.or.function.to.close.down.the
.stream#0Ascb_block..........//.Current.block.numbe
r.of.a.disc.file#0Ascb_write..........//.Buf.writte
n.to.but.not.yet.written.to.disc#0Ascb_bufend......
...//.Size.of.buf.in.bytes#0Ascb_lblock.........//.
Number.of.last.block.of.a.disc.file#0Ascb_ldata....
......//.Bytes.in.last.block.of.a.disc.file#0Ascb_b
length........//.Length.of.a.disc.block.in.bytes.(t
ypically.4096)#0Ascb_reclen.........//.Record.lengt
h.in.bytes.for.some.files#0Ascb_fd.............//.F
ile.or.mailbox.descriptor.MR.18/4/02#0Ascb_timeout.
.......//.The.stream.timeout.value.in.milli-seconds
.MR.26/3/02#0A...................//.#3D.0..means.no
.time.out.is.to.be.applied#0A...................//.
#3D-1..only.transfer.data.that.is.immediately.possi
ble#0Ascb_timeoutact.....//.Action.if.a.timeout.occ
urs#0A...................//.#3D.0..Try.the.operatio
n.again#0A...................//.#3D-1..Abort.the.op
eration#0A...................//.#3D-2..Return.timeo
utch#0Ascb_encoding.......//.Unicode.encoding:.UTF8
.(#3D-1).or.GB2312.(#3D-2),#0A...................//
.used.by.uniwrch#2E#0Ascb_name...........//.Pointer
.to.name.of.stream,.see.below#0A#0Ascb_nameeend.#3D
.scb_name.+.scb_maxnamelen/bytesperword#0A.........
..........//.Last.word.of.space.for.name#0A#0Ascb_s
ize#0Ascb_upb.#3D.scb_size-1#0A#0A}#0A#0AMANIFEST.{
.//.Unicode.encodings#0AUTF8.#3D.-1#0AGB2312.#3D.-2
#0A}#0A

######cintcode/g/bcplfecg.h#
//.This.header.file.contains.the.interface.between.
the.standard#0A//.BCPL.compiler.front.end.and.its.c
odegenerators#2E#0A#0AMANIFEST.{#0A#0A//.Interface.
globals.are.betweeb.ug.and.feg-1#0Aintg#3Dug.....//
.First.of.the.interface.globals,.ie.those#0A.......
.....//.common.to.Lex,.Syn,.Trn.and.the.codegenerat
or#2E#0Afeg#3Dintg+50.//.First.of.the.Lex/Syn.globa
ls#0Atrng#3Dfeg+60.//.First.of.the.TRN.globals#0Acg
g#3Dtrng+60.//.CG.globals.are.cgg.and.above#0A#0A//
..Selectors#0Ah1#3D0;.h2;.h3;.h4;.h5;.h6;.h7#0A#0A/
/.BCPL.lexical.tokens,.tree.and.ocode.operators#0A#0A
s_number#3D1;.s_name;.s_string;.s_true;.s_false#0As
_valof;.s_lv;.s_rv;.s_vecap;.s_fnap#0As_mult;.s_div
;.s_rem;.s_plus;.s_minus;.s_query;.s_neg;.s_abs#0As
_eq;.s_ne;.s_ls;.s_gr;.s_le;.s_ge#0As_slct;.s_of...
................//.Inserted.11/7/01#0As_byteap;.s_m
thap#0As_not;.s_lshift;.s_rshift;.s_logand;.s_logor
#0As_eqv;.s_neqv;.s_cond;.s_comma;.s_table#0As_need
s;.s_section#0As_ass;.s_rtap;.s_goto;.s_resultis;.s
_colon#0As_test;.s_for;.s_if;.s_unless#0As_while;.s
_until;.s_repeat;.s_repeatwhile;.s_repeatuntil#0As_
skip.//.Added.22/6/05#0As_loop;.s_break;.s_return;.
s_finish#0As_endcase;.s_switchon;.s_case;.s_default
#0As_seq;.s_let;.s_and;.s_manifest;.s_global;.s_sta
tic#0As_valdef;.s_vecdef;.s_constdef;.s_const#0As_f
ndef;.s_rtdef;.s_local;.s_label#0A#0A//.Othe.lexica
l.token#0As_be;.s_lsect;.s_rsect;.s_get#0As_semicol
on;.s_into;.s_to;.s_by;.s_do;.s_else#0As_vec;.s_lpa
ren;.s_rparen;.s_sbra;.s_sket;.s_dot;.s_eof#0A#0A//
.Used.in.the.code.generators#0As_none#0A#0A//.Ocode
.operators#0As_lf;.s_lp;.s_lg;.s_ln;.s_lstr;.s_ll;.
s_llp;.s_llg;.s_lll.#0As_sp;.s_sg;.s_sl;.s_stind;.s
_jump;.s_jt;.s_jf;.s_endfor#0As_lab;.s_stack;.s_sto
re;.s_rstack;.s_entry#0As_save;.s_fnrn;.s_rtrn;.s_r
es;.s_datalab;.s_itemn#0As_endproc;.s_getbyte;.s_pu
tbyte#0A#0A}#0A#0AGLOBAL.{#0A//.Option.variables,.a
nd.fe-cg.interface.variables#0A#0Anametable:intg;.n
ametablesize#0Afin_p;.fin_l;.plist;.treep;.treevec#0A
#0A//.OCODE.buffer.variables#0Aobuf;.obufp;.obufq;.
obuft;.obufsize#0Ardn;.wrn..#0A#0Atrnerr#0Atranslat
e#0Asavespacesize#0Acodegenerate#0A#0Abigender#0Ana
ming#0Adebug#0Abining#0Axrefing#0Agdefsing#0A#0Aobj
line1.........//.either."".or.of.form."#23!#2E#2E#2E
"#0Aobjline1written#0Aencoding.........//.Current.e
ncoding.#3DRTF8.or.GB2312#0Adefaultencoding..//.Def
ault.encoding,.set.by.command.args#2E#0A#0Aerrcount
;.errmax#0Asourcestream;.sysprint;.ocodeout#0Agostr
eam;.eqcases;.prtree#0Asourcenamev......//.Fileno.t
o.string.mapping#0A#0A}#0A#0A

######cintcode/g/clihdr.h#
//.Header.for.TRIPOS.CLI.and.some.commands#2E#0A//.
...(e#2Eg#2E.C,.SPOOL,.STACK,.etc#2E)#0A#0AMANIFEST
#0A{#0Areturn_severe....#3D..20#0Areturn_hard......
#3D..10#0Areturn_soft......#3D...5#0Areturn_ok.....
...#3D...0#0Acli_module_gn....#3D..149#0Acli_initia
lstack.#3D..50000.......//.Changed.21/5/2001#0Acli_
initialfaillevel.#3D.return_hard#0A#0A#0A#0A//.cli_
state.flags#0Aclibit_noprompt..#3D..#23b000000001..
//.Don't.output.a.prompt#0Aclibit_eofdel....#3D..#23
b000000010..//.Delete.this.task.if.EOF.received#0Ac
libit_comcom....#3D..#23b000000100..//.Currently.ex
ecution.a.command-command#0Aclibit_maincli...#3D..#23
b000001000..//.Executing.the.main.CLI#0Aclibit_newc
li....#3D..#23b000010000..//.Executing.a.new.CLI#0A
clibit_runcli....#3D..#23b000100000..//.Executing.a
.CLI.invoked.by.run#0Aclibit_mbxcli....#3D..#23b001
000000..//.Executing.an.MBX.CLI#0Aclibit_tcpcli....
#3D..#23b010000000..//.Execution.a.TCP.CLI#0Aclibit
_endcli....#3D..#23b100000000..//.endcli.has.been.e
xecuted.on.this.CLI#0A}#0A#0AGLOBAL#0A{#0Acli_faill
evel:.....131#0Acli_tallyflag:.....132#0Acli_result
2:.......134#0Acli_data:..........135..//.CLI.depen
dent.data..MR.10/7/03#0Acli_commanddir:....136#0Acl
i_returncode:....137#0Acli_commandname:...138#0Acli
_prompt:........140#0Acli_standardinput:.141#0Acli_
currentinput:..142#0Acli_commandfile:...143..//.Nam
e.of.temporary.command.file.used.in#0A.............
...........//.command-commands#0Acli_status:.......
.144..//.Contains.the.CLI.status.flags#0Acli_intera
ctive:...144.//.old#0Acli_background:....145.//.Cin
tpos.variable#0Acli_preloadlist:...145#0Acli_defaul
tstack:..147#0Acli_standardoutput:148#0Acli_module:
........149#0A}#0A

######cintcode/sysb/blib.b#
//.(c)..Copyright:..Martin.Richards..23.April.2010#0A
#0A/*#0A29/03/10#0AChanged.the.units.of.time.to.be.
msecs.instead.of.the.system.dependent#0Aticks#2E.Ti
ckspersecond.has.been.removed.and.the.datstamp.form
at.changed.to:#0Adatv!0.#3D.days..since.1.Jan.1970#0A
datv!1.#3D.msecs..since.midnight#0Asys(Sys_delay,.m
secs).performs.a.delay.in.msecs.(not.ticks)#2E#0ATh
e.cli.prompt.is.now.written.using#0Awritef(promptst
ring,.cputime,.taskid,.hours,.mins,.secs,.msecs)#0A
Try.the.command:.prompt."%+%+%z2:%z2:%z2#2E%z3>."#0A
#0A01/10/07#0AModified.initco.to.return.a.second.re
sult.in.result2#0A#0A03/07/07#0AAdded.codewrch.to.w
rite.extended.characters.using.UTF8.or#0AGB2312#2E.
Added.%#23.substitution.item.in.writef.to.invoke.it
#2E.Note.that#0A*xU,.*xG,.*#23hhhh,.*#23#23hhhhhhhh
.and.*#23dddd.escapes.have.been.added.to#0ABCPL.str
ing.and.character.constants#2E#0A#0A29/6/02#0ARenam
ed.IOLIB.as.DLIB.(the.system.Dependent.Library)#2E.
Put.system#0Aindependent.code.in.BLIB.and.the.rest.
in.DLIB#2E#0A#0A24/4/04#0AMade.many.changed.to.make
.BLIB.more.compatible.between.Cintpos.and#0Asingle.
threaded.Cintcode.BCPL#2E#0A#0A21/3/2003#0AMake.ins
trcount(f,a,b,#2E#2E#2E).set.result2.to.result.of.f
(a,b,c,#2E#2E#2E#2E)#0A#0A10/7/2000#0AChanged.the.d
efinition.of.mkobj.to.take.up.to.11.initialisation#0A
arguments#2E.See.bcplprogs/objdemo#2Eb#0A#0A28/2/20
00#0AAdded.function.instrcount(f,a,b,c,e,f,r,g,h,i,
j,k)#0Awhich.returns.the.number.of.cintcode.instruc
tions.executed#0Awhen.calling.f(a,b,#2E#2E#2E)#2E#0A
#0A30/4/1996#0AAdded.function.flush()#0Awith.corres
ponding.change.in.cintmain#2Ec#0A#0A7/6/1996#0ADefi
ned.mkobj(upb,.fns,.a,.b).for.use.in.object.oriente
d.programming#2E#0ASee.bcplprogs/objdemo#2Eb..(args
.a.and.b.added.30.March.1999)#2E#0A*/#0A#0ASECTION.
"BLIB"#0A#0AGET."libhdr"#0A#0ALET.stop(code).BE#0A{
.//.Return.to.the.CLI.with.a.return.code#2E#0A..//.
It.must.be.called.from.the.command's.coroutine,#0A.
.//.not.an.inner.coroutine#2E#0A..returncode.:#3D.c
ode#0A..cowait(code)#0A}#0A#0AAND.fault(code).BE.sa
writef("BLIB:.fault:.code#3D%n*n",.code)#0A#0AAND.c
lihook(a1).#3D.start(a1)#0A#0AAND.intflag().#3D.sys
(Sys_intflag)..//.Returns.TRUE.if.user.interrupt#0A
#0AAND.abort(code).#3D.sys(Sys_quit,.code)#0A#0AAND
.level(p3).#3D.(@p3)!-3#0A#0AAND.longjump(lev,.lab)
.BE.{.LET.p.#3D.@lev.-.3;.p!0,.p!1.:#3D.lev,.lab.}#0A
#0AAND.sardch()...#3D.sys(Sys_sardch)#0A#0AAND.sawr
ch(ch).#3D.sys(Sys_sawrch,ch)#0A#0A//.Set.the.timeo
ut.field#0A//.msecs>0...The.stream.timeout.value.in
.milli-seconds#0A//.msecs#3D0...No.timeout.value.(t
he.default)#0A//.msecs<0...Only.perform.non.blockin
g.operations.on.the.stream#0A//.On.a.timeout.(on.TC
P.streams)#0A//.act#3D.0....Repeat.the.current.oper
ation#0A//.act#3D-1....Make.timeout.have.the.effect
.of.EOF#0A//.act#3D-2....Return.timeoutch#0AAND.set
timeout(scb,.msecs,.act).BE#0A{.scb!scb_timeout.:#3D
.msecs#0A..scb!scb_timeoutact.:#3D.act#0A}#0A#0A//.
Just.set.the.timeoutact.field#0AAND.settimeoutact(s
cb,.act).BE.scb!scb_timeoutact.:#3D.act#0A#0AAND.rd
ch().#3D.VALOF#0A//.Returns.the.next.byte.from.the.
currently.selected.input.stream,#0A//.but.ignores.C
R#2E#0A//.If.the.buffer.is.empty,.it.calls.replenis
h.to.attempt.to.refill.it#2E#0A//.It.aborts.186.if.
no.input.stream.is.selected#2E#0A{.LET.pos.#3D.cis!
scb_pos.//.Position.of.next.byte#0A#0A..UNLESS.cis.
DO.abort(186)#0A..IF.pos<cis!scb_end.DO.{.LET.ch.#3D
.cis!scb_buf%pos#0A..........................cis!sc
b_pos.:#3D.pos+1#0A..........................IF.ch#3D
'*c'.LOOP.//.Ignore.CR#0A..........................
RESULTIS.ch#0A........................}#0A..//.No.b
yte.available,.so.attempt.to.replenish.the.buffer#0A
..//.If.replenish.returns.FALSE,.no.chars.were.plac
ed.in.the.buffer#0A..//.and.the.reason.why.not.is.p
laced.in.result2.as.follows#0A..//....result2.#3D.-
1....end.of.file#0A..//....result2.#3D.-2....timeou
t#0A..//....result2.#3D.-3....polling.and.no.charac
ters.available#2E#0A..//....result2.#3D.code..error
.code#0A..UNTIL.replenish(cis).DO#0A..{.IF.result2#3D
-2.DO#0A....{.LET.act.#3D.cis!scb_timeoutact.//.Loo
k.at.timeout.action#0A......IF.act#3D-2.RESULTIS.ti
meoutch#0A......IF.act#3D-1.RESULTIS.endstreamch#0A
......LOOP..//.Try.replenishing.again#0A....}#0A...
.RESULTIS.result2<0.->.result2,.endstreamch#0A..}#0A
..//.Successful.replenishment.so.try.rdch.again#0A.
.//.There.will.be.at.least.one.character.in.the.buf
fer#0A}.REPEAT#0A#0AAND.binrdch().#3D.VALOF#0A//.Sa
me.as.rdch.but.does.not.ignore.CR#2E#0A{.LET.pos.#3D
.cis!scb_pos.//.Position.of.next.byte#0A#0A..UNLESS
.cis.DO.abort(186)#0A..IF.pos<cis!scb_end.DO.{.LET.
ch.#3D.cis!scb_buf%pos#0A..........................
cis!scb_pos.:#3D.pos+1#0A..........................
RESULTIS.ch#0A........................}#0A..//.No.b
yte.available,.so.attempt.to.replenish.the.buffer#0A
..//.If.replenish.returns.FALSE,.no.chars.were.plac
ed.in.the.buffer#0A..//.and.the.reason.why.not.is.p
laced.in.result2.as.follows#0A..//....result2.#3D.-
1....end.of.file#0A..//....result2.#3D.-2....timeou
t#0A..//....result2.#3D.-3....polling.and.no.charac
ters.available#2E#0A..//....result2.#3D.code..error
.code#0A..UNTIL.replenish(cis).DO#0A..{.IF.result2#3D
-2.DO#0A....{.LET.act.#3D.cis!scb_timeoutact.//.Loo
k.at.timeout.action#0A......IF.act#3D-2.RESULTIS.ti
meoutch#0A......IF.act#3D-1.RESULTIS.endstreamch#0A
......LOOP..//.Try.replenishing.again#0A....}#0A...
.RESULTIS.result2<0.->.result2,.endstreamch#0A..}#0A
..//.Successful.replenishment.so.try.rdch.again#0A.
.//.There.will.be.at.least.one.ch.in.the.buffer#0A}
.REPEAT#0A#0AAND.unrdch().#3D.VALOF#0A//.Attempt.to
.step.input.back.by.one.byte.position#2E#0A//.It.re
turns:.TRUE.if.successful,.and#0A//.............FAL
SE.otherwise#0A//.After.a.call.of.rdch().it.will.al
ways.be.successful.at.least.once#2E#0A//.It.aborts:
.186.if.not.input.stream,.is.selected#2E#0A{.LET.po
s.#3D.cis!scb_pos#0A..UNLESS.cis.DO.abort(186)#0A..
IF.pos<#3D0.RESULTIS.FALSE.//.Cannot.UNRDCH.past.or
igin#2E#0A..cis!scb_pos.:#3D.pos-1#0A..RESULTIS.TRU
E#0A}#0A#0AAND.wrch(ch).#3D.VALOF#0A//.wrch(ch).wri
tes.ch.to.the.current.output.stream#2E#0A//.It.retu
rns.TRUE.if.successful,.FALSE.otherwise#0A//.It.abo
rts:.187.if.no.stream.is.selected#0A//............1
89.on.depletion.failure#2E#0A{.LET.pos.#3D.cos!scb_
pos#0A#0A..//.If.the.buffer.is.full.try.to.deplete.
it#2E#0A..IF.pos.>#3D.cos!scb_bufend.DO#0A..{.UNLES
S.deplete(cos).RESULTIS.FALSE#0A....UNLESS.cos!scb_
buf..RESULTIS.TRUE.//.Must.be.writing.to.NIL:#0A...
.pos.:#3D.cos!scb_pos#0A..}#0A#0A..//.Pack.the.char
acter.and.advance.pos#2E#0A..cos!scb_buf%pos.:#3D.c
h#0A..pos.:#3D.pos+1#0A..cos!scb_pos.:#3D.pos#0A../
/.Advance.end.of.valid.data.pointer,.if.necessary#0A
..IF.cos!scb_end.<.pos.DO.cos!scb_end.:#3D.pos#0A..
cos!scb_write.:#3D.TRUE.//.Set.flag.to.indicate.the
.buffer.has.changed#2E#0A#0A..UNLESS.cos!scb_type<0
.&.ch<'*s'.RESULTIS.TRUE.//.Normal.return#0A#0A..//
.The.stream.is.interactive.and.ch.is.a.control.char
acter#2E#0A#0A..IF.ch#3D'*n'.DO..wrch('*c')..//.Fid
dle.for.Cygwin#0A#0A..//.Call.deplete.at.the.end.of
.each.interactive.line#2E#0A..IF.ch#3D'*n'.|.ch#3D'
*p'.RESULTIS.deplete(cos)#0A..RESULTIS.TRUE#0A}#0A#0A
AND.binwrch(ch).#3D.wrch(ch.|.256)#0A#0AAND.codewrc
h(code).BE#0A{.//.This.(misleadingly).writes.either
.a.Unicode.character.in#0A..//.UTF-8.format.or.a.co
de.in.GB2312.format#2E#0A..//.A.special.(negative).
value.to.select.the.current.encoding#0A..//.to.be.u
sed.on.the.currently.selected.output.stream.(cos)#2E
#0A#0A..IF.code<0.DO#0A..{.//.Set.the.encoding.for.
the.currently.selected#0A....//.output.stream#2E#0A
....cos!scb_encoding.:#3D.code.//.UTF8.(#3D-1).or.G
B2312.(#3D-2)#0A....RETURN#0A..}#0A..//.Select.UTF8
.unless.GB2312.explicitly.specified.in.the.SCB#2E#0A
..TEST.cos!scb_encoding#3DGB2312#0A..THEN.gb2312wrc
h(code)#0A..ELSE.utf8wrch(code)#0A}#0A#0AAND.gb2312
wrch(code).BE#0A{.//.I.believe.the.encoding.is.as.f
ollows:#0A..//.code.#3D.0.-.127.#3D>.code#0A..//.co
de.#3D.xxyy....#3D>.<xx.+.160>.<yy.+.160>#0A..//...
................eg.4566.#3D>.<45+160>.<66+160>.or.C
D.E2#0A..//.Note.that.the.row.encoding.(CD).is.writ
ten.first,.followed#0A..//.by.the.column#2E#0A..TES
T.code<#3D127#0A..THEN.{.wrch(code)#0A//sawritef(".
gb2312:.%x4.#3D>.%x2*n",.code,.code)#0A.......}#0A.
.ELSE.{.LET.hi.#3D.code../..100.+.160.//.Row.encodi
ng#0A.........LET.lo.#3D.code.MOD.100.+.160.//.Colu
mn.encoding#0A.........wrch(hi)#0A.........wrch(lo)
#0A//sawritef(".gb2312:.%x4.#3D>.%x2.%x2*n",.code,.
hi,.lo)#0A.......}#0A}#0A#0AAND.utf8wrch(code).BE#0A
{.//.Write.a.Unicode.character.in.RTF-8.format#0A..
IF.code<#3D#23x7F.DO#0A..{.wrch(code)..............
.....//.0xxxxxxx#0A....RETURN#0A..}#0A..IF.code<#3D
#23x7FF.DO#0A..{.wrch(#23b1100_0000+(code>>6))..//.
110xxxxx#0A....wrch(#23x80+(.code....&#23x3F))..//.
10xxxxxx#0A....RETURN#0A..}#0A..IF.code<#3D#23xFFFF
.DO#0A..{.wrch(#23b1110_0000+(code>>12)).//.1110xxx
x#0A....wrch(#23x80+((code>>6)&#23x3F))..//.10xxxxx
x#0A....wrch(#23x80+(.code....&#23x3F))..//.10xxxxx
x#0A....RETURN#0A..}#0A..IF.code<#3D#23x1F_FFFF.DO#0A
..{.wrch(#23b1111_0000+(code>>18)).//.11110xxx#0A..
..wrch(#23x80+((code>>12)&#23x3F)).//.10xxxxxx#0A..
..wrch(#23x80+((code>>6)&#23x3F))..//.10xxxxxx#0A..
..wrch(#23x80+(.code....&#23x3F))..//.10xxxxxx#0A..
..RETURN#0A..}#0A..IF.code<#3D#23x3FF_FFFF.DO#0A..{
.wrch(#23b1111_1000+(code>>24)).//.111110xx#0A....w
rch(#23x80+((code>>18)&#23x3F)).//.10xxxxxx#0A....w
rch(#23x80+((code>>12)&#23x3F)).//.10xxxxxx#0A....w
rch(#23x80+((code>>6)&#23x3F))..//.10xxxxxx#0A....w
rch(#23x80+(.code....&#23x3F))..//.10xxxxxx#0A....R
ETURN#0A..}#0A..IF.code<#3D#23x7FFF_FFFF.DO#0A..{.w
rch(#23b1111_1100+(code>>30)).//.1111110x#0A....wrc
h(#23x80+((code>>24)&#23x3F)).//.10xxxxxx#0A....wrc
h(#23x80+((code>>18)&#23x3F)).//.10xxxxxx#0A....wrc
h(#23x80+((code>>12)&#23x3F)).//.10xxxxxx#0A....wrc
h(#23x80+((code>>.6)&#23x3F)).//.10xxxxxx#0A....wrc
h(#23x80+(.code.....&#23x3F)).//.10xxxxxx#0A....RET
URN#0A..}#0A#0A..//.Bad.Unicode.character#0A..write
f("#23%x4#23",.code)#0A}#0A#0AAND.readwords(vector,
.count).#3D.VALOF#0A//.count.is.the.number.of.words
.to.read#2E#0A{.LET.i,.lim.#3D.0,.count*bytesperwor
d#0A..//.lim.is.the.number.of.bytes.still.needed#2E
#0A#0A//sawritef("BLIB.co#3D%n:.readwords.count#3D%
n.scb#3D%n.block#3D%n.pos#3D%n*n",#0A//..........cu
rrco,.count,.cis,.cis!scb_block,.cis!scb_pos)#0A#0A
..IF.count<#3D0.RESULTIS.0#0A#0A..{.LET.pos.#3D.cis
!scb_pos.//.Position.of.next.byte#0A....AND.end.#3D
.cis!scb_end.//.Position.past.last.byte#0A....AND.b
uf.#3D.cis!scb_buf.//.Byte.buffer.--.replenish.migh
t.change.buf#0A#0A....WHILE.pos.<.end.DO....//.Copy
.bytes.--.more.needed#0A....{.//.At.least.one.byte.
available.and.needed#0A......vector%i.:#3D.buf%pos.
......//.Copy.it#0A......i,.pos.:#3D.i+1,.pos+1#0A.
.....IF.i<lim.LOOP............//.More.byte(s).neede
d#0A......//.Successful.completion#0A......cis!scb_
pos.:#3D.pos#0A......RESULTIS.count#0A....}#0A#0A..
..cis!scb_pos.:#3D.pos#0A#0A....//.No.byte.availabl
e,.so.attempt.to.replenish.the.buffer#0A....UNLESS.
replenish(cis).RESULTIS.i/bytesperword#0A....//.Suc
cessful.replenishment.so.copy.some.more.bytes#0A...
.//.There.will.be.at.least.one.byte.in.the.buffer#0A
..}.REPEAT#0A}#0A#0AAND.writewords(vector,.count).#3D
.VALOF#0A{.LET.i,.len.#3D.0,.count*bytesperword.//.
Length.in.bytes#0A#0A//sawritef("BLIB.co#3D%n:.writ
ewords.count#3D%n.scb#3D%n.block#3D%n.pos#3D%n*n",#0A
//..........currco,.count,.cos,.cos!scb_block,.cos!
scb_pos)#0A#0A..IF.len<#3D0.RESULTIS.FALSE#0A#0A..{
.LET.pos....#3D.cos!scb_pos#0A....AND.bufend.#3D.co
s!scb_bufend#0A....AND.buf....#3D.cos!scb_buf#0A#0A
....//.If.the.buffer.is.full.try.to.deplete.it#2E#0A
....WHILE.pos.<.bufend.DO#0A....{.//.There.is.a.byt
e.available.and.room.in.the.buffer#0A......buf%pos.
:#3D.vector%i....//.so.copy.it#0A......i,.pos.:#3D.
i+1,.pos+1#0A......IF.i<len.LOOP..........//.Loop.i
f.another.byte.available#0A#0A......cos!scb_pos.:#3D
.pos.....//.Update.SCB.and.return.successfully#0A..
....//.Advance.end.of.valid.data,.if.necessary#0A..
....IF.cos!scb_end.<.pos.DO.cos!scb_end.:#3D.pos#0A
......cos!scb_write.:#3D.TRUE.//.At.least.one.byte.
has.been.written#0A#0A......RESULTIS.TRUE#0A....}#0A
#0A....//.The.buffer.is.full.so.update.the.SCB.and.
deplete#0A....cos!scb_pos.:#3D.pos#0A....//.Advance
.end.of.valid.data,.if.necessary#0A....IF.cos!scb_e
nd.<.pos.DO.cos!scb_end.:#3D.pos#0A....IF.i>0.DO.co
s!scb_write.:#3D.TRUE.//.TRUE.if.at.least.one.byte.
has.been.written#0A#0A....UNLESS.deplete(cos).RESUL
TIS.FALSE#0A..}.REPEAT#0A}#0A#0A//.get_record.retur
ns.TRUE.if.successful#0A//.it.returns.FALSE.if.eof.
is.encountered.before.the.whole.record#0A//.has.bee
n.read#2E#0A//.MR.29/7/02:.First.record.of.a.file.h
as.record.number.0#0AAND.get_record.(vector,.recno,
.scb).#3D.VALOF#0A{.LET.i...#3D.0..............//.P
osition.of.next.byte.to.put.in.vector#2E#0A..LET.le
n.#3D.scb!scb_reclen.//.Length.of.the.record.in.byt
es#2E#0A#0A..IF.len<#3D0.RESULTIS.FALSE.//.Fail,.no
.record.length.specified#2E#0A#0A//sawritef("BLIB.c
o#3D%n:.get_record.recno#3D%n.reclen#3D%n.blk#3D%n.
pos#3D%n.end#3D%n*n",#0A//...currco,.recno,.scb!scb
_reclen,.scb!scb_block,.scb!scb_pos,.scb!scb_end)#0A
..recordpoint(scb,.recno)#0A#0A//sawritef("BLIB:.ge
t_record.recno#3D%n.reclen#3D%n.pos#3D%n.end#3D%n*n
",#0A//...........recno,.scb!scb_reclen,.scb!scb_po
s,.scb!scb_end)#0A#0A#0A..{.//.Start.of.reading.loo
p#0A....LET.pos.#3D.scb!scb_pos.//.Position.of.next
.byte#0A....AND.end.#3D.scb!scb_end.//.Position.pas
t.last.byte#0A....AND.buf.#3D.scb!scb_buf.//.Byte.b
uffer.--.replenish.might.change.buf#0A#0A....WHILE.
pos.<.end.DO....//.Copy.bytes.--.more.needed#0A....
{.//.At.least.one.byte.needed#0A......vector%i.:#3D
.buf%pos#0A//sawritef("BLIB.co#3D%n:.get_record.byt
e#3D%x2*n",.currco,.vector%i)#0A......i,.pos.:#3D.i
+1,.pos+1#0A......IF.i<len.LOOP.......//.More.byte(
s).needed#0A......//.Successful.completion#0A......
scb!scb_pos.:#3D.pos#0A//sawritef("BLIB.co#3D%n:.ge
t_record.recno#3D%n.len#3D%n.successful*n",#0A//...
.......currco,.recno,.len)#0A......RESULTIS.TRUE#0A
....}#0A#0A....scb!scb_pos.:#3D.pos#0A#0A....//.No.
byte.available,.so.attempt.to.replenish.the.buffer#0A
....UNLESS.replenish(scb).DO#0A....{#0A//sawritef("
BLIB.co#3D%n:.get_record.recno#3D%n.len#3D%n.hit.eo
f.at.%n*n",#0A//..........currco,.recno,.len,.i)#0A
......RESULTIS.FALSE..//.Failure.due.to.eof,.timeou
t,.error.etc#0A....}#0A....//.Successful.replenishm
ent.so.copy.some.more.bytes#0A....//.There.will.sti
ll.be.at.least.one.byte.in.the.buffer#0A..}.REPEAT#0A
}#0A#0A//.MR.29/7/02:.The.first.record.of.a.file.ha
s.number.0.(not.1)#0A//.Returns.TRUE.if.successful#0A
//.Returns.FALSE,.otherwise#2E#0AAND.put_record(vec
tor,.recno,.scb).#3D.VALOF#0A{.LET.i,.len.#3D.0,.sc
b!scb_reclen#0A#0A..UNLESS.scb!scb_id#3Did_inoutscb
.DO#0A..{.sawritef("BLIB.co#3D%n:.put_record.id.not
.inout*n",.currco)#0A....abort(999)#0A....RESULTIS.
FALSE#0A..}#0A#0A..IF.len<#3D0.RESULTIS.FALSE.//.Er
ror.--.no.record.length#0A#0A//sawritef("BLIB:.put_
record.recno#3D%n.reclen#3D%n.blk#3D%n.pos#3D%n.end
#3D%n*n",#0A//...........recno,.scb!scb_reclen,.scb
!scb_block,.scb!scb_pos,.scb!scb_end)#0A..UNLESS.re
cordpoint(scb,.recno).RESULTIS.FALSE#0A//sawritef("
BLIB:.put_record.recno#3D%n.reclen#3D%n.blk#3D%n.po
s#3D%n.end#3D%n*n",#0A//...........recno,.scb!scb_r
eclen,.scb!scb_block,.scb!scb_pos,.scb!scb_end)#0A/
/abort(2222)#0A..{.LET.pos....#3D.scb!scb_pos#0A...
.AND.bufend.#3D.scb!scb_bufend#0A....AND.buf....#3D
.scb!scb_buf#0A#0A....//.If.the.buffer.is.full.try.
to.deplete.it#2E#0A....WHILE.pos.<.bufend.DO#0A....
{.//.There.is.a.byte.available.and.room.in.the.buff
er#0A......buf%pos.:#3D.vector%i....//.so.copy.it#0A
......i,.pos.:#3D.i+1,.pos+1#0A......scb!scb_write.
:#3D.TRUE..//.At.least.one.byte.has.been.written#0A
......IF.i<len.LOOP..........//.Loop.if.another.byt
e.available#0A#0A......scb!scb_pos.:#3D.pos.....//.
Update.SCB.and.return.successfully#0A......//.Advan
ce.end.of.valid.data,.if.necessary#0A......IF.scb!s
cb_end.<.pos.DO.scb!scb_end.:#3D.pos#0A//......scb!
scb_write.:#3D.TRUE.//.At.least.one.byte.has.been.w
ritten#0A#0A......RESULTIS.TRUE.........//.Successf
ul.completion#0A....}#0A#0A....//.The.buffer.is.ful
l.so.update.the.SCB.and.deplete#0A....scb!scb_pos.:
#3D.pos#0A....//.Advance.end.of.valid.data,.if.nece
ssary#0A....IF.scb!scb_end.<.pos.DO.scb!scb_end.:#3D
.pos#0A//..IF.i>0.DO.scb!scb_write.:#3D.TRUE.//.if.
at.least.one.byte.has.been.written#0A#0A....UNLESS.
deplete(scb).RESULTIS.FALSE#0A..}.REPEAT#0A}#0A#0A/
/.replenish(scb).returns:#0A//...TRUE..............
..Successful.replenishment,.at.least.one.ch.read#0A
//...FALSE.result2.#3D.-1..End.of.file,.no.chars.re
ad.....//.MR.15/4/03#0A//...FALSE.result2.#3D.-2..T
imeout,.no.chars.read.--.none.yet.available#0A//...
FALSE.result2.#3D.-3..Polling,.no.chars.read.--.non
e.available#0A//...FALSE.result2.......Error.code#0A
#0AAND.replenish(scb).#3D.VALOF#0A{.LET.rdfn.#3D.sc
b!scb_rdfn#0A..result2.:#3D.-1#0A..//.The.condition
.scb!scb_end<0.indicates.that.the.stream.is.exhaust
ed#0A..UNLESS.scb!scb_end>#3D0.&.rdfn.&.rdfn(scb).R
ESULTIS.FALSE#0A..RESULTIS.TRUE#0A}#0A#0A//.deplete
(scb).returns:#0A//...TRUE..Successful.depletion,.o
r#0A//...FALSE.otherwise#2E#0A//.It.aborts:.187.if.
scb.is.not.a.suitable.stream#2E#0A#0AAND.deplete(sc
b).#3D.VALOF#0A{.LET.wrfn.#3D.scb!scb_wrfn.#0A..IF.
scb!scb_end<0.RESULTIS.FALSE.///.?????.result2#0A..
UNLESS.wrfn.DO.abort(187)#0A//sawritef("BLIB:.deple
te.calling.wrfn(%n)*n",.scb)#0A..RESULTIS.wrfn(scb)
#0A}#0A#0AAND.findinput....(string).......#3D..find
stream(string,.id_inscb,....0)#0A#0AAND.pathfindinp
ut(string,.path).#3D..findstream(string,.id_inscb,.
path)#0A#0AAND.findoutput...(string).......#3D..fin
dstream(string,.id_outscb,...0)#0A#0AAND.findinoutp
ut.(string).......#3D..findstream(string,.id_inouts
cb,.0)#0A#0AAND.findupdate...(string).......#3D..fi
ndstream(string,.id_inoutscb,.0)#0A#0AAND.selectinp
ut(scb).BE.//.scb#3D0.is.occasionally.used#0A{.UNLE
SS.scb#3D0.|.scb!scb_id#3Did_inscb.|.scb!scb_id#3Di
d_inoutscb.DO.abort(186)#0A..cis.:#3D.scb#0A}#0A#0A
AND.selectoutput(scb).BE.//.scb#3D0.is.occasionally
.used#0A{.UNLESS.scb#3D0.|.scb!scb_id#3Did_outscb.|
.scb!scb_id#3Did_inoutscb.DO.abort(187)#0A..cos.:#3D
.scb#0A}#0A#0AAND.endread().BE.endstream(cis)#0A#0A
AND.endwrite().BE.endstream(cos)#0A#0AAND.endstream
(scb).BE.TEST.scb>0#0ATHEN.{.LET.endfn.#3D.scb!scb_
endfn#0A.......LET.res2.#3D.result2#0A.......IF.end
fn.DO.endfn(scb)#0A.......freevec(scb)#0A.......IF.
cis.#3D.scb.DO.cis.:#3D.0#0A.......IF.cos.#3D.scb.D
O.cos.:#3D.0#0A#0A.......result2.:#3D.res2#0A.....}
#0AELSE.IF.scb<0.DO.//.Safety.check#0A.....{.sawrit
ef("*nBLIB:.endstream.given.negative.scb#3D%n*n",.s
cb)#0A.......abort(999)#0A.....}#0A#0AAND.input().#3D
.cis#0A#0AAND.output().#3D.cos#0A#0AAND.readn().#3D
.VALOF#0A{.LET.sum,.ch,.neg.#3D.0,.0,.FALSE#0A#0A..
{.ch.:#3D.rdch()#0A....IF.'0'<#3Dch<#3D'9'.BREAK#0A
....SWITCHON.ch.INTO#0A....{.DEFAULT:...unrdch()#0A
.................result2.:#3D.-1#0A................
.RESULTIS.0#0A......CASE.'*s':#0A......CASE.'*t':#0A
......CASE.'*n':.LOOP#0A#0A......CASE.'-':..neg.:#3D
.TRUE#0A......CASE.'+':..ch.:#3D.rdch()#0A.........
........BREAK#0A....}#0A..}.REPEAT#0A#0A..WHILE.'0'
<#3Dch<#3D'9'.DO#0A..{.sum.:#3D.10.*.sum.+.ch.-.'0'
#0A....ch.:#3D.rdch()#0A..}#0A..IF.neg.DO.sum.:#3D.
-sum#0A..unrdch()#0A..result2.:#3D.0#0A..RESULTIS.s
um#0A}#0A#0AAND.newline().BE.wrch('*n')#0A#0AAND.ne
wpage().BE.wrch('*p')#0A#0AAND.writed(n,.d).BE.writ
edz(n,.d,.FALSE,.n<0)#0A#0AAND.writez(n,.d).BE.writ
edz(n,.d,.TRUE,..n<0)#0A#0AAND.writedz(n,.d,.zeroes
,.neg).BE#0A{.LET.t.#3D.VEC.10#0A..LET.i.#3D.0#0A..
LET.k.#3D.-n#0A#0A..IF.neg.DO.{.d.:#3D.d.-.1;.k.:#3D
.n.}#0A#0A..{.t!i.:#3D.-(k.MOD.10)#0A....k...:#3D.k
/10#0A....i...:#3D.i.+.1#0A..}.REPEATWHILE.k#0A#0A.
.IF.neg.&.zeroes.DO.wrch('-')#0A..FOR.j.#3D.i+1.TO.
d.DO.wrch(zeroes.->.'0',.'*s')#0A..IF.neg.&.~zeroes
.DO.wrch('-')#0A..FOR.j.#3D.i-1.TO.0.BY.-1.DO.wrch(
t!j+'0')#0A}#0A#0AAND.writen(n).BE.writed(n,.0)#0A#0A
AND.writehex(n,.d).BE.#0A{.IF.d>1.DO.writehex(n>>4,
.d-1)#0A..wrch((n&15)!TABLE.'0','1','2','3','4','5'
,'6','7',#0A....................'8','9','A','B','C'
,'D','E','F')#0A}#0A#0AAND.writeoct(n,.d).BE#0A{.IF
.d.>.1.DO.writeoct(n>>3,.d-1)#0A..wrch((n&7)+'0')#0A
}#0A#0AAND.writebin(n,.d).BE#0A{.IF.d.>.1.DO.writeb
in(n>>1,.d-1)#0A..wrch((n&1)+'0')#0A}#0A#0AAND.writ
es(s).BE#0A{.UNLESS.0.<.s.<.rootnode!rtn_memsize.DO
.s.:#3D."#23#23Bad.string#23#23"#0A..FOR.i.#3D.1.TO
.s%0.DO.wrch(s%i)#0A}#0A#0AAND.writet(s,.d).BE#0A{.
writes(s)#0A..FOR.i.#3D.1.TO.d-s%0.DO.wrch('*s')#0A
}#0A#0AAND.writeu(n,.d).BE#0A{.LET.m.#3D.(n>>1)/5#0A
..IF.m.DO.{.writed(m,.d-1);.d.:#3D.1.}#0A..writed(n
-m*10,.d)#0A}#0A#0A#0A/*#0A........The.following.ro
utines.provide.and.extended.version.of.writef#2E#0A
They.support.the.following.extra.substitution.items
:#0A#0A........1#2E.%F...-.Takes.next.argument.as.a
.writef.format.string.and#0A................calls.w
ritef.recursively.using.the.remaining.arguments#2E#0A
................The.argument.pointer.is.positioned.
to.the.next.available#0A................argument.on
.return#2E#0A#0A........2#2E.%M...-.The.next.argume
nt.is.taken.as.a.message.number.and.processed#0A...
.............as.for.%F.above#2E.The.message.format.
string.is.looked.up.by#0A................get_text(m
essno,.str,.upb).where.str.is.a.vector.local.to#0A.
...............writef.to.hold.the.message.string#2E
.This.is.provided.to.easy#0A................the.gen
eration.of.messages.in.different.languages#2E#0A#0A
........3#2E.%+...-.The.argument.pointer.is.increme
nted.by.1#2E#0A#0A........4#2E.%-...-.The.argument.
pointer.is.decremented.by.1#2E#0A#0A........5#2E.%P
...-.Plural.formation#2E.The.singular.form.is.use.i
f.and.only.if#0A................the.next.argument.i
s.one#2E.So.that.the.argument.can.be.used#0A.......
.........twice.it.is.normal.to.preceed.or.follow.th
e.%P.item.with.%-#2E#0A................There.are.tw
o.forms.as.follows:#0A#0A................a#2E.%Pc..
-.The.character.c.is.output.if.the.the.next.argumen
t#0A........................not.one#2E#0A#0A.......
.........b#2E.%P\singular\plural\..-.The.appropriat
e.text.is.printed,#0A........................skippi
ng.the.other#2E.The.'\'.chars.are.not.printed#2E#0A
#0AExample:.FOR.count.#3D.0.TO.2.DO#0A............w
ritef("There.%p\.is\are\.%-%n.thing%-%ps#2E*n",.cou
nt)#0Aoutputs:#0A.........There.are.0.things#2E#0A.
........There.is..1.thing#2E#0A.........There.are.2
.things#2E#0A#0A........6#2E.%nOp..eg.%12i.as.an.al
ternative.to.%iB#0A.................where.n.is.a.de
cimal.number.and.Op.is.a.format.letter#0A..........
.......expecting.a.field.width#2E.If.n.is.given.it.
specifies.the#0A.................field.width.otherw
ise.it.is.specified,.as.before,.by.the#0A..........
.......single.character.(0-9,.A-Z).following.Op#2E#0A
#0A........7#2E.%n#2Emd..eg.%8#2E2d#0A.............
.....print.a.fixed.point.scaled.decimal.number.in.a
.field#0A..................width.of.n.with.m.digits
.after.the.decimal.point#2E.For#0A.................
.example.writef("%8#2E2d",.1234567).would.output:.1
2345#2E67#0A..................and.....writef("%8#2E
0d",.1234567).would.output:..1234567#0A#0A........8
#2E.%#23.....Write.the.next.argument.using.codewrch
,.ie.convert.the#0A..................next.argument.
to.UTF-8.format#2E#0A*/#0A#0A//.The.following.versi
on.of.writef.is.new.--.MR.21/1/04#0A///*#0A#0A//.ge
t_textblib.and.get_text.have.the.same.global.variab
le.number#0AAND.get_textblib(n,.str,.upb).#3D.VALOF
..//.Default.definition.of.get_text#0A.............
..........................//.This.is.normally.overr
idden.#0A.......................................//.
by.get_text,.defined.elsewhere#2E#0A{.LET.s.#3D."<m
ess:%-%n>"#0A..IF.upb>s%0.DO.upb.:#3D.s%0#0A..str%0
.:#3D.upb#0A..FOR.i.#3D.1.TO.upb.DO.str%i.:#3D.s%i#0A
..RESULTIS.str#0A}#0A#0AAND.writef(format,a,b,c,d,e
,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z).BE#0A{.
LET.nextarg.#3D.@a#0A..write_format(format,.@nextar
g)#0A}#0A#0AAND.sawritef(format,a,b,c,d,e,f,g,h,i,j
,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z).BE#0A{.LET.nextar
g.#3D.@a#0A..LET.wch,.rch.#3D.wrch,.rdch#0A..wrch,.
rdch.:#3D.sawrch,.sardch#0A..write_format(format,.@
nextarg)#0A..wrch,.rdch.:#3D.wch,.rch#0A}#0A#0AAND.
write_format(format,.lvnextarg).BE#0A{.//.writef.an
d.sawritef.must.preserve.result2#0A..LET.res2.#3D.r
esult2#0A#0A..UNLESS.0.<.format.<.rootnode!rtn_mems
ize.DO.format.:#3D."#23#23Bad.format#23#23"#0A#0A..
FOR.p.#3D.1.TO.format%0.DO#0A..{.LET.k,.type,.f,.n,
.m,.arg.#3D.format%p,.?,.?,.?,.?,.?#0A....LET.width
given.#3D.FALSE#0A....UNLESS.k#3D'%'.DO.{.wrch(k);.
LOOP.}#0A#0A....//.Deal.with.a.substitution.item#0A
....p.:#3D.p.+.1#0A....type,.arg,.n,.m.:#3D.format%
p,.!!lvnextarg,.0,.0#0A#0Asw:.SWITCHON.capitalch(ty
pe).INTO#0A....{.DEFAULT:....wrch(type)#0A.........
.........LOOP#0A#0A......CASE.'0':CASE.'1':CASE.'2'
:CASE.'3':CASE.'4':#0A......CASE.'5':CASE.'6':CASE.
'7':CASE.'8':CASE.'9':#0A..................{.n.:#3D
.10*n.+.type.-.'0'#0A....................p.:#3D.p+1
#0A....................type.:#3D.format%p#0A.......
.............widthgiven.:#3D.TRUE#0A...............
...}.REPEATWHILE.'0'<#3Dtype<#3D'9'#0A.............
.....IF.type#3D'#2E'.DO#0A..................{.p.:#3D
.p+1#0A....................type.:#3D.format%p#0A...
.................WHILE.'0'<#3Dtype<#3D'9'.DO#0A....
................{.m.:#3D.10*m.+.type.-.'0'#0A......
................p.:#3D.p+1#0A......................
type.:#3D.format%p#0A....................}#0A......
............}#0A..................GOTO.sw#0A#0A....
..CASE.'D':...IF.m.DO#0A..................{.//.Writ
e.a.number.of.the.form.nnn#2Enn#0A.................
...LET.scale.#3D.1#0A....................FOR.i.#3D.
1.TO.m.DO.scale.:#3D.scale.*.10#0A.................
...writedz(arg/scale,.n-1-m,.FALSE,.arg<0)#0A......
..............wrch('#2E')#0A....................wri
tez(.ABS.arg.MOD.scale,.m)#0A....................!l
vnextarg.:#3D.!lvnextarg.+.1#0A....................
LOOP#0A..................}#0A..................f.:#3D
.writed;....GOTO.getarg#0A#0A#0A......CASE.'S':...f
.:#3D.writes;....GOTO.noargs#0A......CASE.'T':...f.
:#3D.writet;....GOTO.getarg#0A......CASE.'C':...f.:
#3D.wrch;......GOTO.noargs#0A......CASE.'#23':...f.
:#3D.codewrch;...GOTO.noargs#0A......CASE.'O':...f.
:#3D.writeoct;..GOTO.getarg#0A......CASE.'X':...f.:
#3D.writehex;..GOTO.getarg#0A......CASE.'I':...f.:#3D
.writed;....GOTO.getarg#0A......CASE.'N':...f.:#3D.
writen;....GOTO.noargs#0A......CASE.'U':...f.:#3D.w
riteu;....GOTO.getarg#0A......CASE.'Z':...f.:#3D.wr
itez;....GOTO.getarg#0A......CASE.'B':...f.:#3D.wri
tebin;..GOTO.getarg#0A#0A....getarg:.......UNLESS.w
idthgiven.DO#0A..................{.p.:#3D.p.+.1#0A.
...................n.:#3D.capitalch(format%p)#0A...
.................n.:#3D.'0'.<#3D.n.<#3D.'9'.->.n.-.
'0',.10.+.n.-.'A'#0A..................}#0A#0A....no
args:.......f(arg,.n)#0A..................!lvnextar
g.:#3D.!lvnextarg.+.1#0A..................LOOP#0A#0A
......CASE.'$':#0A......CASE.'+':...!lvnextarg.:#3D
.!lvnextarg.+.1#0A..................LOOP#0A#0A.....
.CASE.'-':...!lvnextarg.:#3D.!lvnextarg.-.1#0A.....
.............LOOP#0A#0A......CASE.'M':.{.LET.buf.#3D
.VEC.256/bytesperword#0A..................!lvnextar
g.:#3D.!lvnextarg.+.1#0A..................UNLESS.ge
t_text(arg,.buf,.256/bytesperword).DO#0A...........
.........buf.:#3D."<<mess:%-%n>>"..//.No.message.te
xt#0A..................write_format(buf,.lvnextarg)
#0A..................LOOP#0A................}#0A#0A
......CASE.'F':...!lvnextarg.:#3D.!lvnextarg.+.1#0A
..................write_format(arg,.lvnextarg)#0A..
................LOOP#0A#0A......CASE.'P':.{.LET.plu
ral.#3D.arg.~#3D.1#0A..................!lvnextarg.:
#3D.!lvnextarg.+.1#0A..................p.:#3D.p+1#0A
..................type.:#3D.format%p#0A............
......IF.type.#3D.'\'.DO#0A..................{.//.D
eal.with.%P\singular\plural\.item#0A...............
.....LET.skipping.#3D.plural#0A....................
p.:#3D.p.+.1#0A....................UNTIL.p.>.format
%0.DO#0A....................{.LET.ch.#3D.format%p#0A
......................TEST.ch.#3D.'\'.THEN.{.skippi
ng.:#3D.~skipping#0A...............................
............IF.skipping.#3D.plural.BREAK#0A........
.................................}#0A..............
......................ELSE.UNLESS.skipping.DO.wrch(
ch)#0A......................p.:#3D.p.+.1#0A........
............}#0A....................LOOP#0A........
..........}#0A#0A..................//.Deal.with.sim
ple.%Pc.items#0A..................IF.plural.DO.wrch
(type)#0A..................LOOP#0A................}
#0A....}.//.End.of.SWITCHON.#2E#2E#2E#0A..}.//.End.
of.FOR.p.#3D.#2E#2E#2E#0A#0A..result2.:#3D.res2#0A}
#0A#0ALET.randno(upb).#3D.VALOF..//.return.a.random
.number.in.the.range.1.to.upb#0A{.randseed.:#3D.ran
dseed*2147001325.+.715136305#0A..RESULTIS.(ABS(rand
seed/3)).MOD.upb.+.1#0A}#0A#0AAND.setseed(newseed).
#3D.VALOF.//.Added.by.MR.20/01/2000#0A{.LET.oldseed
.#3D.randseed#0A..randseed.:#3D.newseed#0A..RESULTI
S.oldseed#0A}#0A#0A//.muldiv.is.now.implemented.in.
SYSLIB.using.the.MDIV.instruction#0A//.NO.--.MDIV.s
ometimes.causes.a.floating.point.exception#0AAND.mu
ldiv(a,.b,.c).#3D.sys(Sys_muldiv,.a,.b,.c)#0A#0AAND
.unpackstring(s,.v).BE.FOR.i.#3D.s%0.TO.0.BY.-1.DO.
v!i.:#3D.s%i#0A#0AAND.packstring(v,.s).#3D.VALOF#0A
{.LET.n.#3D.v!0.&.255#0A..LET.size.#3D.n/bytesperwo
rd#0A..FOR.i.#3D.0.TO.n.DO.s%i.:#3D.v!i#0A..FOR.i.#3D
.n+1.TO.(size+1)*bytesperword-1.DO.s%i.:#3D.0#0A..R
ESULTIS.size#0A}#0A#0AAND.capitalch(ch).#3D.'a'.<#3D
.ch.<#3D.'z'.->.ch.+.'A'.-.'a',.ch#0A#0AAND.compch(
ch1,.ch2).#3D.capitalch(ch1).-.capitalch(ch2)#0A#0A
AND.compstring(s1,.s2).#3D.VALOF#0A{.LET.lens1,.len
s2.#3D.s1%0,.s2%0#0A..LET.smaller.#3D.lens1.<.lens2
.->.s1,.s2#0A..FOR.i.#3D.1.TO.smaller%0.DO#0A..{.LE
T.res.#3D.compch(s1%i,.s2%i)#0A....IF.res.RESULTIS.
res#0A..}#0A..IF.lens1.#3D.lens2.RESULTIS.0#0A..RES
ULTIS.smaller.#3D.s1.->.-1,.1#0A}#0A#0AAND.str2numb
(s).#3D.VALOF.//.Deprecated#0A{.LET.a.#3D.0#0A..FOR
.i.#3D.1.TO.s%0.DO.{.LET.dig.#3D.s%i.-.'0'#0A......
..................IF.0<#3Ddig<#3D9.DO.a.:#3D.10*a.+
.dig#0A......................}#0A..RESULTIS.s%1#3D'
-'.->.-a,.a#0A}#0A#0AAND.getkey(keys,.i,.keyword).#3D
.VALOF#0A{.LET.len.#3D.keys%0#0A..LET.n.#3D.0#0A..L
ET.p.#3D.1#0A#0A..UNTIL.p>len.DO#0A..{.UNLESS.i.BRE
AK#0A....IF.keys%p#3D','.DO.i.:#3D.i-1#0A....p.:#3D
.p+1#0A..}#0A#0A..WHILE.p.<#3D.len.DO#0A..{.LET.ch.
#3D.keys%p#0A....IF.ch#3D'/'.|.ch#3D'#3D'.|.ch#3D',
'.BREAK#0A....n.:#3D.n.+.1#0A....keyword%n.:#3D.key
s%p#0A....p.:#3D.p.+.1#0A..}#0A#0A..keyword%0.:#3D.
n#0A..RESULTIS.keyword#0A}#0A#0A/*.rdargs.provides.
the.programmer.with.the.facility.to.read#0A...argum
ents.from.the.currently.selected.input.and.store.th
em.in.a#0A...vector.as.shown.below:#0A#0A..........
................|----------|#0A....................
......|address1..|#0A..........................|___
_______|#0A..........................|.TRUE.....|<-
.logic.switch.value#0A..........................|__
________|.#0A..........................|address2..|
#0A..........................|----------|#0A.......
...................|item1.....|#0A.................
.........|__________|#0A..........................|
item2.....|#0A..........................|__________
|#0A#0AThe.possible.key.qualifiers.are:#0A#0A../k..
.keyed....--.argument.requires.the.keyword#0A../p..
.prompted.--.prompt.will.be.displayed..(This.option
.may.be.scrapped)#0A../a...required.--.if.this.argu
ment.is.not.entered.an.error.will.follow#0A../n...n
umeric..--.argument.has.to.be.a.number#0A../s...swi
tch...--.exact.switch.word.has.to.be.entered.for.TR
UE#0A*/..#0A#0AAND.rdargs(keys,.argv,.size).#3D.VAL
OF#0A{.MANIFEST#0A..{.required....#3D.1............
......//..1.../A#0A....keyed.......#3D.1.<<.1......
.......//..2.../K#0A....switch......#3D.1.<<.2.....
........//..4.../S#0A....prompt......#3D.1.<<.3....
.........//..8.../P#0A....number......#3D.1.<<.4...
..........//.16.../N#0A....control.....#3D.(number.
<<.1).-.1..//.31...All.the.flags#0A..}#0A#0A..LET.w
........#3D.argv.//.w.is.a.moving.positional.pointe
r.of.the.argv.vector#0A..LET.numbargs.#3D.?#0A..LET
.status...#3D.TRUE...//.Set.to.FALSE.when.an.error.
is.encountered#0A..LET.keyword..#3D.VEC.30#0A#0A..!
w.:#3D.0#0A#0A////////////////.A.BIT.MAP.REPRESENTI
NG.THE.KEY.QUALIFIERS.IS.///////////////#0A////////
///////..PUT.INTO.THE.TOP.LOCATIONS.OF.THE.VECTOR..
...///////////////.#0A#0A..//.A.typical.key.string.
is:."FROM#3DDATA/A,TO/K,VAL/K/N,T#3DTRACE/S"#0A..FO
R.p.#3D.1.TO.keys%0.DO#0A..{.LET.kch.#3D.keys%p#0A#0A
....IF.kch.#3D.'/'.DO#0A....{.LET.c.#3D.capitalch(k
eys%(p+1))#0A......IF.c.#3D.'A'.DO.!w.:#3D.!w.|.req
uired#0A......IF.c.#3D.'K'.DO.!w.:#3D.!w.|.keyed#0A
......IF.c.#3D.'S'.DO.!w.:#3D.!w.|.switch#0A......I
F.c.#3D.'P'.DO.!w.:#3D.!w.|.prompt#0A......IF.c.#3D
.'N'.DO.!w.:#3D.!w.|.number#0A....}#0A#0A....IF.kch
.#3D.','.DO#0A....{.w.:#3D.w.+.1#0A......!w.:#3D.0#0A
....}#0A..}#0A#0A..w.:#3D.w.+.1#0A..numbargs.:#3D.w
.-.argv..//.as.deduced.from.the.keys.string#0A#0A#0A
///////////////////////////////////////////////////
/////////////////////#0A////////////////////////.BE
GINNING.OF.REPEAT.LOOP.//////////////////////#0A///
///////////////////////////////////////////////////
//////////////////#0A#0A..{.LET.argno.#3D.-1#0A....
LET.wsize.#3D.size.-.(w.-.argv).//.Number.of.words.
remaining.in.argv#0A....LET.itemtype.#3D.rditem(w,.
wsize)#0A//sawritef("BLIB:.rdargs..itemtype#3D%n*n"
,.itemtype)#0A....clear_words(keyword,.31)#0A#0A...
.SWITCHON.itemtype.INTO#0A....{.DEFAULT:.//.Unknown
.item.type#0Aerr:#0A.............{.LET.ch.#3D.?#0A/
/sawritef("BLIB:.rdargs.error.--.skipping.to.end.of
.line*n")#0A...............unrdch()...//.MR.14/7/03
#0A...............ch.:#3D.rdch().REPEATUNTIL.ch#3D'
*n'.|#0A........................................ch#3D
';'..|#0A........................................ch
#3Dendstreamch#0A#0A...............result2.:#3D.120
..//.Fault:.Argument.line.#0A......................
.........//.invalid.or.too.long#0A...............RE
SULTIS.0......//.Error.result#0A.............}#0A#0A
......CASE.0:..//.endstreamch#0A......CASE.3:..//.n
ewline#0A......CASE.4:..//.semicolon#0A//.These.ite
m.types.mark.the.end.of.the.argument.list#2E#0A#0A/
/.Now.check.for.prompted.arguments#2E#0A#0A........
.......FOR.i.#3D.0.TO.numbargs.-1.IF.0<#3Dargv!i<#3D
control.DO#0A...............{.//.Unset.argument.fou
nd#0A.................LET.a.#3D.argv!i#0A#0A.......
..........IF.status.&.((a.&.prompt).~#3D.0).DO#0A..
...............{.//.if.ok.so.far.&.prompted#0A.....
..............IF.cis!scb_type.#3D.scbt_console.&#0A
......................cos!scb_type.#3D.scbt_console
.DO#0A...................{.writes(getkey(keys,.i,.k
eyword))#0A.....................UNLESS.(a.&.switch)
.#3D.0.DO.writes(".(yes/no)")#0A...................
..writes(".>.").//.write.prompt#0A.................
....deplete(cos).//.MR.13/1/03#0A#0A...............
......itemtype.:#3D.rditem(w,.wsize)#0A............
.........SWITCHON.itemtype.INTO#0A.................
....{.CASE.1:.//.Unquoted.item#0A..................
.....CASE.2:.//.Quoted.item#0A//writef("*nvalue#3D%
s*n",.w)#0A...............................IF.(a.&.s
witch).~#3D.0.DO#0A...............................{
.IF.compstring(w,."yes").#3D.0.DO#0A...............
..................{.argv!i.:#3D.TRUE#0A............
.......................LOOP.//.Find.next.uset.argum
ent#0A.................................}#0A........
.........................IF.compstring(w,."no").#3D
.0.DO#0A.................................{.argv!i.:
#3D.FALSE#0A...................................LOOP
.//.Find.next.uset.argument#0A.....................
............}#0A...............................}#0A
#0A...............................IF.(a.&.number).~
#3D.0.DO#0A...............................{.argv!i.
:#3D.w...//.numeric#0A.............................
....IF.string_to_number(w).DO#0A...................
..............{.!w.:#3D.result2#0A.................
..................w..:#3D.w.+.1#0A.................
..................LOOP.//.Find.next.uset.argument#0A
.................................}#0A..............
...................status.:#3D.FALSE#0A............
.....................argv!i.:#3D.0#0A..............
...................LOOP.//.Find.next.uset.argument#0A
...............................}#0A#0A.............
..................//.Non.switch.non.numeric.argumen
t#0A//writef("*nargv!%n.#3D.%s..non.switch/num*n",.
i,.w)#0A...............................argv!i.:#3D.
w#0A...............................w.:#3D.w.+.w%0/b
ytesperword.+.1#0A...............................ws
ize.:#3D.size.-.(w.-.argv).....#0A.................
..............LOOP.//.Find.next.unset.argument#0A#0A
.......................CASE.0:#0A..................
.....CASE.3:#0A.......................CASE.4:#0Awri
tef("BLIB:.rdargs:.case.0,.3.or.4.reached*n")#0A...
............................ENDCASE#0A#0A..........
.............DEFAULT:#0A...........................
....status.:#3D.FALSE#0A...........................
....LOOP#0A.....................}#0A...............
....}#0A.................}#0A......................
......#0A.................TEST.(a.&.required).#3D.0
..//.final.check.for.required#0A.................TH
EN.argv!i.:#3D.0.........//.argument.-.clear.memory
#0A.................ELSE.status.:#3D.FALSE.....//.i
f.no.input.made.and.not.#0A........................
..................//.required#0A...............}.//
.End.of.for-loop#0A#0A...............UNLESS.status.
GOTO.err#0A...............result2.:#3D.0#0A........
.......FOR.i.#3D.0.TO.numbargs-1.IF.argv!i.DO.resul
t2.:#3D.result2.+.1#0A...............//.result2.#3D
.number.of.args.given#0A//...............writef("*n
itemtype#3D%n.calling.rdch().#3D>.'%c'*n",.itemtype
,.rdch())#0A//...............writef("*nreturning.rd
ch().#3D>.'%c'*n",.rdch())#0A...............RESULTI
S.w#0A#0A.....CASE.1:...//.Ordinary.item#0A........
.......//.notice.that.the.CASE.1.and.CASE.2.section
s.will#0A...............//.both.be.executed.consecu
tively.for.any.input.other.#0A...............//.the
n.items.in.quotes#0A#0A...............argno.:#3D.fi
ndarg(keys,.w)#0A//writef("Ordinary.item.%s..argno#3D
%n*n",.w,.argno)#0A#0A...............TEST.argno.>#3D
.0#0A...............THEN.{.UNLESS.0.<#3D.argv!argno
.<#3D.control.GOTO.err#0A#0A......................I
F.(argv!argno.&.switch).~#3D.0.DO#0A...............
.......{.argv!argno.:#3D.-1#0A.....................
...LOOP#0A......................}#0A#0A............
..........{.LET.item.#3D.rditem(w,.wsize)#0A#0A....
....................IF.item.#3D.5.DO.item.:#3D.rdit
em(w,.wsize).//.Skip.'#3D'#0A#0A...................
.....IF.item.<#3D.0.|.item#3D3.|.item#3D4.|.item#3D
5.GOTO.err#0A......................}#0A............
........}#0A#0A...............ELSE.TEST.rdch().#3D.
'*n'.&.compstring("?",.w).#3D.0#0A.................
...THEN.{.writef("%s:.",.keys)#0A..................
.........deplete(cos).//.MR.13/1/03#0A.............
..............ENDCASE#0A.........................}#0A
....................ELSE.unrdch()#0A#0A//.Deliberat
e.missing.'ENDCASE'#0A#0A............CASE.2:.//.ite
m.was.not.a.keyword.or.was.put.in.quotes#0A........
........IF.argno.<.0.DO......//.find.first.non-keye
d,.non-switch#0A..................FOR.i.#3D.0.TO.nu
mbargs.-.1.DO#0A....................IF.0.<#3D.argv!
i.<#3D.control.&#0A.......................(argv!i.&
.switch).#3D.0..&#0A.......................(argv!i.
&.keyed)..#3D.0..DO.#0A....................{.argno.
:#3D.i#0A......................BREAK#0A............
........}#0A#0A//.The.FOR-loop.below.the.CASE.2.end
s.here#0A#0A................UNLESS.argno.>#3D.0.DO#0A
................{.//.keyword.is.not.recognized#0A..
................GOTO.err.....//.MR.27/3/03#0A......
............status.:#3D.FALSE#0A..................L
OOP#0A................}#0A#0A................UNLESS
.0.<#3D.argv!argno.<#3D.control.GOTO.err#0A#0A//.Th
is.part.of.the.module.is.always.executed.if.the.ent
ered.argument.was#0A//.found.to.be.valid;.an.addres
s.from.vector.is.stored.in.the.top.half#0A//.of.the
.vector.argv#0A#0A................{.LET.a.#3D.argv!
argno#0A#0A..................IF.(a.&.number).~#3D.0
.DO#0A..................{.IF.string_to_number(w).DO
.//.check.if.the#0A....................{.argv!argno
.:#3D.w#0A......................!w.:#3D.result2....
.......//.expected.numeric.input#0A................
......w..:#3D.w.+.1.............//.can.be.string.co
nverted#0A......................LOOP#0A............
........}#0A#0A....................//.Number.cannot
.be.converted#0A....................status.:#3D.FAL
SE#0A....................argv!argno.:#3D.0#0A......
..............LOOP#0A..................}#0A#0A.....
.............//.Store.ordinary.argument.value#0A...
...............argv!argno.:#3D.w#0A................
..w.:#3D.w.+.w%0/bytesperword.+.1#0A...............
...LOOP#0A................}#0A....}.//.End.of.main.
switch#0A..}.REPEAT#0A}#0A#0A//.Read.an.item.from.c
urrent.input.stream#0A#0A//.returns.-1....error,.in
put.too.long.or.unmatched.quote#0A//..........0....
endstreamch............***.MR.change.11/12/92#0A//.
.........1....unquoted.item#0A//..........2....quot
ed.item#0A//..........3....*n.....................*
**.MR.change.11/12/92#0A//..........4....;.........
.............***.MR.change.11/12/92#0A//..........5
....#3D......................***.MR.change.12/07/03
#0A#0A//.When.an.unquoted.item.is.read.its.terminat
ing.character.is#0A//.unrdch-ed.so.that.it.can.be.r
ead.again.by.the.next.call.of.rdch#2E#0A//.All.item
s.other.items,.namely.strings,.newline,.';',.'#3D'.
and#0A//.endstreamch,.are.self.terminating.and.so.d
o.not.need.unrdch#0A//.to.be.called#2E#0A#0AAND.rdi
tem(v,.upb).#3D.VALOF#0A{.LET.p,.pmax.#3D.0,.(upb+1
)*bytesperword-1#0A..//.With.bytesperword#3D4#0A../
/.upb#3D0.#3D>.pmax#3D3#0A..//.upb#3D1.#3D>.pmax#3D
7#0A..//.#2E#2E#2E#0A..LET.ch,.quoted.#3D.rdch(),.F
ALSE#0A#0A..FOR.i.#3D.0.TO.upb.DO.v!i.:#3D.0#0A#0A/
/sawritef("*nrditem.first.ch.#3D.'%c'*n",.ch)#0A#0A
..//.Skip.over.white.space#2E#0A..WHILE.ch#3D'*s'.|
.ch#3D'*t'.|.ch#3D'*c'DO.ch.:#3D.rdch().#0A#0A..IF.
ch#3Dendstreamch.RESULTIS..0...//.EOF#0A..IF.ch#3D'
*n'........RESULTIS..3...//.'*n'#0A..IF.ch#3D';'...
......RESULTIS..4...//.';'#0A..IF.ch#3D'#3D'.......
..RESULTIS..5...//.'#3D'#0A#0A..IF.ch#3D'"'.DO.{.ch
.:#3D..rdch()#0A.................IF.ch#3D'*c'.LOOP#0A
.................IF.ch#3D'*n'.|.ch#3Dendstreamch.RE
SULTIS.-1.//.Error#0A.................IF.ch#3D'"'.R
ESULTIS.2.//.Found.a.quoted.string#2E#0A...........
......IF.ch#3D'**'.DO.{.ch.:#3D.rdch()#0A..........
.......................IF.capitalch(ch)#3D'N'..DO.c
h.:#3D.'*n'#0A.................................IF.c
apitalch(ch)#3D'*"'.DO.ch.:#3D.'*"'.//.MR.8/1/03#0A
...............................}#0A................
.p.:#3D.p+1#0A.................IF.p>pmax.RESULTIS.-
1.//.Error#0A.................v%0,.v%p.:#3D.p,.ch#0A
...............}.REPEAT#0A#0A..//.Copy.chars.of.an.
unquoted.item.into.v#0A..UNTIL.ch#3D'*n'.|.ch#3D'*s
'.|.ch#3D'*t'.|.ch#3D';'.|.ch#3D'#3D'.|.ch#3Dendstr
eamch.DO#0A..{.p.:#3D.p+1#0A....IF.p>pmax.RESULTIS.
-1..............//.Error#0A....v%0,.v%p.:#3D.p,.ch#0A
....ch.:#3D.rdch().REPEATWHILE.ch#3D'*c'#0A..}#0A..
//.Unrdch.its.terminating.character#0A#0A//sawritef
("rditem.returning.type.1.%s,.ch#3D%x2.'%c'*n",.v,.
ch,.ch)#0A..UNLESS.ch#3Dendstreamch.DO.unrdch()#0A.
.RESULTIS.1............................//.Unquoted.
item#0A}#0A#0AAND.findarg(keys,.w).#3D.VALOF#0A{.MA
NIFEST.{.matching.#3D.0;.skipping.#3D.1.}#0A..LET.s
tate,.wp,.argno.#3D.matching,.0,.0#0A..FOR.i.#3D.1.
TO.keys%0.DO#0A..{.LET.kch#3Dkeys%i#0A....IF.state#3D
matching.DO#0A....{.IF.(kch#3D'#3D'.|.kch#3D'/'.|.k
ch#3D',').&.wp#3Dw%0.DO#0A........RESULTIS.argno#0A
......wp.:#3D.wp.+.1#0A......UNLESS.compch(kch,.w%w
p).#3D.0.DO.state.:#3D.skipping#0A....}#0A....IF.kc
h#3D','.|.kch#3D'#3D'.DO.state,.wp.:#3D.matching,.0
#0A....IF.kch.#3D.','.DO.argno.:#3D.argno.+.1#0A..}
#0A..IF.state.#3D.matching.&.wp.#3D.w%0.RESULTIS.ar
gno#0A..RESULTIS.-1#0A}#0A#0AAND.createco(fn,.size)
.#3D.VALOF#0A{.LET.c.#3D.getvec(size+6)#0A..UNLESS.
c.RESULTIS.0#0A..FOR.i.#3D.6.TO.size+6.DO.c!i.:#3D.
stackword#0A#0A..//.Using.P.to.denote.the.current.s
tack.frame#0A..//.pointer,.the.following.assumption
s.are.made:#0A..//..P!0,.P!1,.P!2.contain.the.retur
n.link.information#0A..//..P!3...is.the.variable.fn
#0A..//..P!4...is.the.variable.size#0A..//..P!5...i
s.the.variable.c#0A#0A..//.Now.make.the.vector.c.in
to.a.valid.BCPL#0A..//.stack.frame.containg.copies.
of.fn,.size#0A..//.and.c.in.the.same.relative.posit
ions#2E#0A..//.Other.locations.in.the.new.stack.fra
me.#0A..//.are.used.for.other.purposes#2E#0A..c!0.:
#3D.c<<B2Wsh.//.resumption.point#0A..c!1.:#3D.currc
o...//.parent.link#0A..c!2.:#3D.colist...//.colist.
chain#0A..c!3.:#3D.fn.......//.the.main.function#0A
..c!4.:#3D.size.....//.the.coroutine.size#0A..c!5.:
#3D.c........//.the.new.coroutine.pointer#0A#0A..co
list.:#3D.c..//.insert.into.the.list.of.coroutines#0A
#0A..changeco(0,.c)#0A#0A..//.Execution.now.continu
es.with.the.P.pointer.set.to.c<<B2Wsh,#0A..//.and.s
o..the.vector.c.becomes.the.current.stack.frame#2E#0A
..//.The.compiler.will.have.generated.code.on#0A../
/.the.assumption.that.fn.and.c.are.the.third.and.fi
fth#0A..//.words.of.the.stack.frame,.and,.since.c!3
.and.c!5#0A..//.were.initialised.to.fn.and.c,.the.f
ollowing.repeated#0A..//.statement.will.have.the.ef
fect.(naively).expected#2E#0A..//.Note.that.the.fir
st.call.of.cowait.causes.a.return#0A..//.from.creat
eco.with.result.c#2E#0A#0A..c.:#3D.fn(cowait(c)).RE
PEAT#0A}#0A#0AAND.deleteco(cptr).#3D.VALOF#0A{.LET.
a.#3D.@colist#0A#0A..{.LET.co.#3D.!a#0A....UNLESS.c
o.DO#0A....{.sawritef("BLIB.co#3D%n:.cannot.deletec
o.%n.--.not.found*n",#0A.........currco,.cptr)#0A..
....abort(112)#0A......RESULTIS.FALSE#0A....}#0A...
.IF.co#3Dcptr.BREAK#0A....a.:#3D.@.co!co_list#0A..}
.REPEAT#0A#0A..IF.cptr!co_parent.DO#0A..{.sawritef(
"BLIB.co#3D%n:.cannot.deleteco.%n.--.has.a.parent*n
",#0A.......currco,.cptr)#0A....abort(112)#0A....RE
SULTIS.FALSE#0A..}#0A#0A..!a.:#3D.cptr!co_list.....
.//.Remove.the.coroutine.from.colist#2E#0A..freevec
(cptr)...........//.Free.the.coroutine.stack#2E#0A.
.RESULTIS.TRUE#0A}#0A#0AAND.callco(cptr,.a).#3D.VAL
OF#0A{.IF.cptr!co_parent.DO.abort(110)#0A..cptr!co_
parent.:#3D.currco#0A..RESULTIS.changeco(a,.cptr)#0A
}#0A#0AAND.resumeco(cptr,.a).#3D.VALOF#0A{.LET.pare
nt.#3D.currco!co_parent#0A..currco!co_parent.:#3D.0
#0A..IF.cptr!co_parent.DO.abort(111)#0A..cptr!co_pa
rent.:#3D.parent#0A..RESULTIS.changeco(a,.cptr)#0A}
#0A#0AAND.cowait(a).#3D.VALOF#0A{.LET.parent.#3D.cu
rrco!co_parent#0A..currco!co_parent.:#3D.0#0A..RESU
LTIS.changeco(a,.parent)#0A}#0A#0AAND.initco(fn,.si
ze,.a,.b,.c,.d,.e,.f,.g,.h,.i,.j,.k).#3D.VALOF#0A{.
LET.cptr.#3D.createco(fn,.size)#0A..result2.:#3D.0#0A
..IF.cptr.DO.result2.:#3D.callco(cptr,.@a)#0A..RESU
LTIS.cptr#0A}#0A#0A/*......res.:#3D.startco(body,.a
rg,.stsize)#0A#0A........The.routine.'body'.is.crea
ted.as.a.coroutine.with.a.stacksize.'stsize'#0A....
....and.'arg'.passed.as.an.argument#2E..The.result.
is.the.stackbase.of#0A........the.coroutine#2E#0A*/
#0A#0AAND.startco(body,.arg,.stsize).#3D.VALOF#0A{.
LET.newco.#3D.createco(body,.stsize)#0A//sawritef("
BLIB:.callco(%n,%n)*n",.newco,.arg)#0A...IF.newco.D
O.callco(newco,.arg)#0A...RESULTIS.newco#0A}#0A#0A/
/.object.making.function#0AAND.mkobj(upb,.fns,.a,.b
,.c,.d,.e,.f,.g,.h,.i,.j,.k).#3D.VALOF#0A{.LET.obj.
#3D.getvec(upb)#0A..UNLESS.obj#3D0.DO#0A..{.!obj.:#3D
.fns#0A....InitObj#23(obj,.@a).//.Send.the.InitObj.
message.to.the.object#0A..}#0A..RESULTIS.obj#0A}#0A
#0AAND.instrcount(fn,.a,b,c,d,e,f,g,h,i,j,k).#3D.VA
LOF#0A{.LET.res.#3D.0#0A..LET.count.#3D.sys(Sys_set
count,.maxint)..//.Set.count.register.to.maxint#0A.
.result2.:#3D.fn(a,b,c,d,e,f,g,h,i,j,k)#0A..res.:#3D
.sys(Sys_setcount,.count)........//.Restore.previou
s.value#0A...............................//.returni
ng.the.modified.count#0A..RESULTIS.maxint.-.res.-.3
2...//.Correct.for.overhead#0A}#0A#0AAND.datstring(
v).#3D.VALOF#0A{.LET.datv.#3D.VEC.1#0A..datstamp(da
tv)#0A..dat_to_strings(datv,.v)#0A..RESULTIS.v#0A}#0A
#0AAND.dat_to_strings(datv,.v).#3D.VALOF#0A#0A//.Re
turns.v.containing.3.strings.representing.the#0A//.
time.and.date.given.in.datv,.where#0A//.datv!0.#3D.
days.since.1.Jan.1970#0A//.datv!1.#3D.msecs.since.m
idnight#0A//.On.return,.v.contains.a.the.date.in.th
e.form#0A//.DD-MMM-YYYY,.v+5.contains.the.time.in.t
he.format#0A//.HH:MM:SS,.and.V+10.contains.the.day.
of.the.week#2E#0A//.Vector.v.should.have.an.upperbo
und.of.14#0A//.If.the.date.is.unset.(days.#3D.0).th
en.the.strings#0A//.are.all.set.to."<unset>"#0A#0A{
.LET.days,.msecs.#3D.datv!0,.datv!1#0A..LET.datestr
,.timestr,.dowstr.#3D.v,.v+5,.v+10#0A..LET.year.#3D
.1970.//.BCPL,.Unix.and.Windows.epoc#0A..LET.month.
#3D.1#0A..LET.dayofweek.#3D.(days+4).MOD.7.//.1.Jan
.1970.was.a.Thursday.(code#3D4)#0A..LET.dowtemp.#3D
.?#0A..LET.hours,.mins.#3D.?,.?#0A..LET.monthtab...
..#3D.TABLE...0,.31,.59,.90,120,151,#0A............
...............181,212,243,273,304,334,365#0A..LET.
leapmonthtab.#3D.TABLE...0,.31,.60,.91,121,152,#0A.
..........................182,213,244,274,305,335,3
66#0A..LET.mchars.#3D."JanFebMarAprMayJunJulAugSepO
ctNovDec"#0A..LET.mcharbase.#3D.?#0A..LET.mtable.#3D
.?#0A..LET.secs.#3D.msecs/1000....//.Seconds.since.
midnight#0A..msecs.:#3D.msecs.MOD.1000..//.msecs.si
nce.start.of.current.second#0A#0A//sawritef("dat_to
_strings:.days#3D%n.secs#3D%n.msecs#3D%n*n",.days,.
secs,.msecs)#0A..//.Deal.with.case.of.unset.date#0A
..IF.days.<#3D.0.DO#0A..{.LET.unset.#3D."<unset>"#0A
....FOR.i.#3D.0.TO.unset%0.DO.#0A....{.LET.c.#3D.un
set%i#0A......datestr%i.:#3D.c#0A......timestr%i.:#3D
.c#0A......dowstr%i..:#3D.c#0A....}#0A....RESULTIS.
v#0A..}#0A#0A..days.:#3D.days.+.1#0A..FOR.j#3D0.TO.
9.DO.datestr%j.:#3D."DD-MMM-YYYY"%j#0A..FOR.j#3D0.T
O.8.DO.timestr%j.:#3D."HH:MM:SS"%j#0A#0A..//.Constr
uct.date#0A#0A..{.//.Loop.to.get.year#0A....LET.yea
rlen.#3D.isleap(year).->.366,.365#0A....IF.days.<#3D
.yearlen.BREAK#0A....days,.year.:#3D.days.-.yearlen
,.year.+.1#0A..}.REPEAT#0A#0A..datestr%8..:#3D.year
/1000.MOD.10.+.'0'#0A..datestr%9..:#3D.year/100..MO
D.10.+.'0'#0A..datestr%10.:#3D.year/10...MOD.10.+.'
0'#0A..datestr%11.:#3D.year......MOD.10.+.'0'#0A.#0A
..//.Find.the.month#0A..mtable.:#3D.isleap(year).->
.leapmonthtab,.monthtab#0A#0A..//.1.<#3D.days.<#3D.
366#0A..month.:#3D.1.+.days./.32.//.Actual.month.or
.one.less#0A..IF.days.>.mtable.!.month.DO.month.:#3D
.month+1#0A#0A..mcharbase.:#3D.month*3.-.2#0A..FOR.
j.#3D.0.TO.2.DO.datestr%(4+j).:#3D.mchars.%.(mcharb
ase.+.j)#0A..days.:#3D.days.-.mtable.!.(month.-.1)#0A
..datestr%1.:#3D.days/10.+.'0'#0A..datestr%2.:#3D.d
ays.MOD.10.+.'0'#0A#0A..//.Construct.time#0A#0A..mi
ns..:#3D.secs../..60#0A..hours.:#3D.mins../..60#0A.
.mins..:#3D.mins.MOD.60#0A..secs..:#3D.secs.MOD.60#0A
#0A..timestr%1.:#3D.hours/10.+.'0'#0A..timestr%2.:#3D
.hours.MOD.10.+.'0'#0A..timestr%4.:#3D.mins/10.+.'0
'#0A..timestr%5.:#3D.mins.MOD.10.+.'0'#0A..timestr%
7.:#3D.secs/10.MOD.10.+.'0'#0A..timestr%8.:#3D.secs
.MOD.10.+.'0'#0A#0A..//.Get.day.of.week#0A....#0A..
dowtemp.:#3D.VALOF.SWITCHON.dayofweek.INTO#0A......
{.CASE.0:.RESULTIS."Sunday"#0A........CASE.1:.RESUL
TIS."Monday"#0A........CASE.2:.RESULTIS."Tuesday"#0A
........CASE.3:.RESULTIS."Wednesday"#0A........CASE
.4:.RESULTIS."Thursday"#0A........CASE.5:.RESULTIS.
"Friday"#0A........CASE.6:.RESULTIS."Saturday"#0A..
....}#0A#0A..FOR.j.#3D.0.TO.dowtemp%0.DO.dowstr%j.:
#3D.dowtemp%j#0A#0A..RESULTIS.v#0A}#0A#0AAND.isleap
(year).#3D.year.MOD.400.#3D.0.->.TRUE,#0A..........
.........year.MOD.100.#3D.0.->.FALSE,#0A...........
........year.MOD...4.#3D.0.->.TRUE,#0A.............
..........................FALSE#0A#0AAND.testbit(bi
tno,.bitvec).#3D.VALOF#0A//.This.function.returns.a
.non.zero.value.if.the.specified.bit.in#0A//.bitvec
.is.a.one,.otherwise.it.returns.zero#2E#0A//.Bits.a
re.numbered.from.zero.starting.at.the.least.signifi
cant.bit#0A//.of.bitvec!0#2E#0A//.bitvec!0.holds.bi
ts.0.to.bitsperword-1#0A//.bitvec!1.holds.bits.bits
perword.to.2*bitsperword-1#0A//.etc#0A{.LET.i.#3D.b
itno../..bitsperword#0A..AND.s.#3D.bitno.MOD.bitspe
rword#0A..RESULTIS.bitvec!i.&.(1<<s)#0A}#0A#0AAND.s
etbit(bitno,.bitvec,.state).#3D.VALOF#0A//.This.fun
ction.sets.the.specified.bit.in.bitvec.to.1.or.0.de
pending#0A//.on.whether.state.is.TRUE.or.FALSE,.res
pectively#2E.It.returns.a#0A//.non-zero.value.if.th
e.previous.setting.of.the.bit.was.a.one,.otherwise#0A
//.it.returns.zero#2E.See.testbit.above#2E#0A{.LET.
i.#3D.bitno../..bitsperword#0A..AND.s.#3D.bitno.MOD
.bitsperword#0A..LET.mask.#3D.1.<<.s#0A..LET.oldsta
te.#3D.bitvec!i.&.mask#0A..TEST.state.THEN.bitvec!i
.:#3D.bitvec!i.|..mask#0A.............ELSE.bitvec!i
.:#3D.bitvec!i.&.~mask#0A..RESULTIS.oldstate#0A}#0A
#0AAND.string_to_number(s).#3D.VALOF#0A//.Return.TR
UE.if.OK.with.value.in.result2#0A//........FALSE.an
d.result2#3D0.if.s.is.not.a.number#0A//.Example.str
ings:.#0A//...'A'#0A//..123....-99....+63#0A//..#23
377...-#23x7FF.+#23b1011011.#0A{.LET.p,.len.#3D.1,.
s%0#0A..LET.neg,.radix.#3D.FALSE,.10#0A..LET.ch.#3D
.?#0A#0A..result2.:#3D.0#0A..UNLESS.len.RESULTIS.FA
LSE#0A..ch.:#3D.capitalch(s%p)#0A..IF.ch.#3D.'*''.&
.len.#3D.3.&.s%3.#3D.'*''.DO#0A..{.result2.:#3D.s%2
#0A....RESULTIS.TRUE#0A..}#0A#0A..IF.ch.#3D.'+'.|.c
h.#3D.'-'.DO#0A..{.neg.:#3D.ch.#3D.'-'#0A....IF.p.#3D
.len.RESULTIS.TRUE#0A....p.:#3D.p.+.1#0A....ch.:#3D
.capitalch(s%p)#0A..}#0A..IF.ch.#3D.'#23'.DO#0A..{.
radix.:#3D.8#0A....IF.p.#3D.len.RESULTIS.TRUE#0A...
.p.:#3D.p.+.1#0A....ch.:#3D.capitalch(s%p)#0A....IF
.ch.#3D.'O'.|.ch.#3D.'X'.|.ch.#3D.'B'.DO#0A....{.IF
.ch.#3D.'X'.DO.radix.:#3D.16#0A......IF.ch.#3D.'B'.
DO.radix.:#3D.2#0A......IF.p.#3D.len.RESULTIS.TRUE#0A
......p.:#3D.p.+.1#0A......ch.:#3D.capitalch(s%p)#0A
....}#0A..}#0A..{.LET.n.#3D.'0'.<#3D.ch.<#3D.'9'.->
.ch.-.'0',#0A............'A'.<#3D.ch.<#3D.'Z'.->.ch
.-.'A'.+.10,.1000#0A....UNLESS.n.<.radix.RESULTIS.F
ALSE#0A....result2.:#3D.result2.*.radix.+.n#0A....p
.:#3D.p.+.1#0A....IF.p.>.len.BREAK#0A....ch.:#3D.ca
pitalch(s%p)#0A..}.REPEAT#0A#0A..IF.neg.DO.result2.
:#3D.-result2#0A..RESULTIS.TRUE#0A}#0A#0AAND.string
_to_dat().#3D.VALOF#0A{.sawritef("function.string_t
o_dat.not.implemented.(BLIB)*n")#0A..RESULTIS.0#0A}
#0A#0A//.Get.the.ith.element.of.vector.v.of.16-bit.
unsigned.words#0AAND.getword(v,.i).#3D.VALOF#0A{.LE
T.j.#3D.i+i#0A..LET.res.#3D.v%j.+.(v%(j+1)<<8)..//.
Assumes.little.ender.m/c.??????????#0A..RESULTIS.re
s#0A}#0A#0A//.Store.least.sig.16.bits.of.w.in.the.i
th.element.of.vector.v.of.16-bit.words#0AAND.putwor
d(v,.i,.w).BE....//.store.16.bit.word#0A{.LET.j.#3D
.i+i#0A..v%j,.v%(j+1).:#3D.w,.w>>8..//.Assumes.litt
le.ender.m/c..?????????????#0A}#0A#0AAND.copystring
(from,.to).BE#0A..FOR.i.#3D.0.TO.from%0.DO.to%i.:#3D
.from%i#0A#0AAND.copy_words(from,.to,.n).BE#0A..FOR
.i.#3D.0.TO.n-1.DO.to!i.:#3D.from!i#0A#0AAND.clear_
words(v,.n).BE#0A..FOR.i.#3D.0.TO.n-1.DO.v!i.:#3D.0
#0A#0AAND.copy_bytes(fromlen,.from,.fillch,.tolen,.
to).#3D.VALOF#0A//.This.is.an.implementation.of.the
.VAX.MOVC5.instruction#0A//.for.copying.bytes#2E#0A
{.LET.n.#3D.fromlen#0A..//.from.and.to.are.byte.add
resses!!!!!#0A..IF.n>tolen.DO.n.:#3D.tolen#0A..//.T
his.code.need.checking!!!!!#0A..FOR.i.#3D.0.TO.n-1.
DO.0%(to+i).:#3D.0%(from+i)#0A..FOR.i.#3D.n.TO.tole
n-1.DO.0%(to+i).:#3D.fillch#0A..RESULTIS.fromlen-n.
//.Number.of.non.copied.characters#0A}#0A#0A#0A#0AA
ND.getvec(upb).#3D.VALOF#0A{.IF.upb<0.DO#0A..{.sawr
itef("BLIB:.getvec(%n).called*n",.upb)#0A....abort(
1000)#0A..}#0A..RESULTIS.sys(Sys_getvec,.upb)#0A}#0A
#0AAND.freevec(ptr).BE.IF.ptr.UNLESS.sys(Sys_freeve
c,.ptr).DO#0A{.sawritef("BLIB.co#3D%n:.freevec.fail
ure,.ptr#3D%n*n",.currco,.ptr)#0A..abort(999)#0A}#0A
#0AAND.loadseg(name).#3D.sys(Sys_loadseg,.name)#0A#0A
AND.globin(segl).#3D.sys(Sys_globin,.segl)#0A#0AAND
.unloadseg(segl).BE.sys(Sys_unloadseg,.segl)#0A#0AA
ND.callseg(file,.arg1,.arg2,.arg3,.arg4).#3D.VALOF#0A
{.LET.res.#3D.0#0A..LET.seg.#3D.loadseg(file)#0A..L
ET.s.#3D.start#0A//sawritef("BLIB:.callseg.%s.enter
ed*n",.file)#0A#0A//.BEWARE:.The.called.segment.mus
t.be.careful.which.globals.it.uses!#0A..TEST.seg.&.
globin(seg)#0A..THEN.res.:#3D.start(arg1,.arg2,.arg
3,.arg4)#0A..ELSE.{.sawritef("BLIB:.Unable.to.calls
eg.%s.seg#3D%n*n",.file,.seg)#0A.........abort(999)
#0A.........start.:#3D.s#0A.........RESULTIS.0#0A..
.....}#0A..unloadseg(seg)#0A..start.:#3D.s#0A..RESU
LTIS.res#0A}#0A#0AAND.deletefile(name).#3D.sys(Sys_
deletefile,.name)#0A#0AAND.renamefile(fromname,.ton
ame).#3D.sys(Sys_renamefile,.fromname,.toname)#0A#0A
AND.setlogname(logname,.logvalue).#3D.VALOF#0A{.LET
.a.#3D.@rootnode!rtn_envlist#0A#0A..//.First.delete
.current.entry.if.it.exists#2E#0A..{.LET.p.#3D.!a#0A
....UNLESS.p.BREAK#0A....IF.compstring(logname,.p!1
)#3D0.DO#0A....{.!a.:#3D.!p#0A......freevec(p)#0A..
....BREAK#0A....}#0A....a.:#3D.p#0A..}.REPEAT#0A#0A
..IF.logvalue.DO.//.Insert.new.entry#0A..{.LET.upb1
.#3D.logname%0../.bytesperword#0A....LET.upb2.#3D.l
ogvalue%0./.bytesperword#0A....LET.p.#3D.getvec(4.+
.upb1.+.upb2).//.3.+.upb1+1.+.upb2+1.-.1#0A....LET.
s1.#3D.p.+.3#0A....LET.s2.#3D.s1.+.upb1.+.1#0A....U
NLESS.p.RESULTIS.0#0A....FOR.i.#3D.0.TO.upb1.DO.s1!
i.:#3D.logname!i#0A....FOR.i.#3D.0.TO.upb2.DO.s2!i.
:#3D.logvalue!i#0A....p!1,.p!2.:#3D.s1,.s2#0A....!p
.:#3D.rootnode!rtn_envlist#0A....rootnode!rtn_envli
st.:#3D.p#0A....RESULTIS.p#0A..}#0A#0A//sawritef("B
LIB:.not.adding.%s*n",.logname)#0A..RESULTIS.0#0A}#0A
#0AAND.getlogname(logname).#3D.VALOF#0A{.LET.p.#3D.
rootnode!rtn_envlist#0A..WHILE.p.DO#0A..{.IF.compst
ring(logname,.p!1)#3D0.RESULTIS.p!2#0A....p.:#3D.!p
#0A..}#0A..RESULTIS.0#0A}#0A#0A//.Example.calls.of.
splitname.give.the.following.results#0A#0A//.splitn
ame(prefix,.':',."TCP:shep:9000",..1).#3D>..5,.pref
ix#3D"TCP"#0A//.splitname(prefix,.':',."TCP:shep:90
00",..5).#3D>.10,.prefix#3D"shep"#0A//.splitname(pr
efix,.':',."TCP::9000",......5).#3D>..6,.prefix#3D"
"#0A//.splitname(prefix,.':',."TCP:shep",.......5).
#3D>..0,.prefix#3D"shep"#0A//.splitname(prefix,.':'
,."TCP:shep:",......5).#3D>.10,.prefix#3D"shep"#0A/
/.splitname(prefix,.':',."TCP:shep:",.....10).#3D>.
.0,.prefix#3D""#0A//.splitname(prefix,.':',."TCP:sh
ep:9000",.10).#3D>..0,.prefix#3D"9000"#0A#0AAND.spl
itname(prefix,.ch,.string,.ptr).#3D.VALOF#0A{.LET.l
en.#3D.string%0#0A..LET.res,.pos.#3D.0,.0#0A#0A..WH
ILE.ptr<#3Dlen.DO#0A..{.LET.k.#3D.string%ptr#0A....
IF.k#3Dch.DO.{.prefix%0.:#3D.pos;.RESULTIS..ptr+1.}
#0A....pos,.ptr.:#3D.pos+1,.ptr+1#0A....prefix%pos.
:#3D.k.#0A..}#0A..prefix%0.:#3D.pos#0A..RESULTIS.0#0A
}#0A#0A//.Not.used#0AAND.open_for_output(name,.recs
iz,.maxrec).#3D.VALOF#0A{.sawritef("DLIB:.open_for_
output(%s,%n,%n).called*n",.name,.recsiz,.maxrec).#0A
..RESULTIS.findstream(name,.id_outscb,.recsiz.<<.2,
.maxrec)#0A}#0A#0AAND.open_for_input(name).#3D.find
stream(name,.id_inscb,.0)#0A#0AAND.open_for_update(
name).#3D.findstream(name,.id_inoutscb,.0)#0A#0AAND
.setrecordlength(scb,.length).#3D.VALOF..//.length.
is.in.bytes.--.MR.12/7/04#0A{.LET.old.#3D.scb!scb_r
eclen#0A..scb!scb_reclen.:#3D.length.//.in.bytes#0A
..RESULTIS.old#0A}#0A#0AAND.recordnote(scb).#3D.VAL
OF.//.The.first.record.has.number.0#0A//.Returns.th
e.record.number.corresponding.to.the.current.positi
on#0A//.........of.the.stream#2E#0A//.Returns.-1.if
.the.stream.is.not.suitable#2E#0A{.LET.blkno.#3D.sc
b!scb_block....//.The.blocksize.is.the.buffer.size.
in.bytes#0A..AND.reclen.#3D.scb!scb_reclen..//.in.b
ytes#0A..IF.blkno>#3D0.&.reclen>0.DO.//.Modified.by
.MR.12/7/04#0A..{.LET.recno.#3D.muldiv(blkno,.scb!s
cb_bufend,.reclen)#0A....RESULTIS.recno.+.(result2.
+.scb!scb_pos)/reclen..//.MR.12/2/04#0A..}#0A..sawr
itef("BLIB:.recordnote:.result.-1*n")#0A..RESULTIS.
-1...//.MR.26/7/04#0A}#0A#0AAND.recordpoint(scb,.re
cno).#3D.VALOF#0A//.MR.28/7/02:.The.first.record.of
.a.file.has.number.0#0A//.Returns.TRUE.if.successfu
l#0A//.Returns.FALSE,.otherwise#2E#0A{.LET.pvec.#3D
.VEC.1#0A..LET.type.#3D.scb!scb_type#0A..UNLESS.typ
e#3Dscbt_file.|.type#3Dscbt_ram.DO#0A..{.sawritef("
FLIB.recordpoint:.only.works.on.a.disc.or.RAM.file*
n")#0A....abort(999)#0A....RESULTIS.FALSE#0A..}#0A.
.IF.recno<0.DO...//.The.first.record.has.number.0#0A
..{.sawritef("DLIB:.recordpoint.recno#3D%n*n",.recn
o)#0A....abort(1000)#0A....recno.:#3D.0#0A..}#0A//s
awritef("DLIB:.recordpoint:.muldiv(%n,%n,%n)*n",#0A
//..........scb!scb_reclen,.recno,.scb!scb_bufend)#0A
//abort(1000)#0A..pvec!0.:#3D.muldiv(scb!scb_reclen
,.recno,.scb!scb_bufend).//.MR.29/7/02#0A..pvec!1.:
#3D.result2#0A//sawritef("DLIB:.recordpoint:.recno.
%n.#3D>.%n.%n*n",#0A//..........recno,.pvec!0,.pvec
!1)#0A//abort(1000)#0A//IF.pvec!0>2.DO.abort(8888)#0A
..RESULTIS.point(scb,.pvec)#0A}#0A#0A//.Position.an
.inout.stream.to.its.end#0A//.This.should.be.remove
d#2E#0AAND.appendstream(scb).#3D.VALOF.//??????????
???????????????????#0A$(..LET.lblock.#3D.scb!scb_lb
lock#0A....LET.ldata.#3D.scb!scb_ldata#0A....LET.pv
ec.#3D.VEC.1#0A//sawritef("DLIB:.appendstream.calle
d*n");.abort(999)#0A....UNLESS.scb!scb_id#3Did_inou
tscb.RESULTIS.FALSE#0A....IF.scb!scb_block#3Dlblock
.&.scb!scb_end>ldata.DO#0A........ldata.:#3D.scb!sc
b_end#0A....pvec!0,.pvec!1.:#3D.lblock,.ldata#0A...
.UNLESS.point(scb,.pvec).RESULTIS.FALSE#0A//....scb
!scb_pos.:#3D.scb!scb_end#0A....RESULTIS.TRUE#0A}#0A
#0A//.Position.to.start.of.stream#0AAND.rewindstrea
m(scb).#3D.VALOF.//.MR.17/3/02#0A{.LET.pvec.#3D.VEC
.1#0A..pvec!0,.pvec!1.:#3D.0,.0......//.MR.6/8/02#0A
..RESULTIS.point(scb,.pvec)#0A}#0A#0A//.Advance.str
eam.position.by.n.words#0AAND.stepstream(scb,.n).#3D
.VALOF#0A{.LET.pvec.#3D.VEC.1#0A..LET.bytes,.len.#3D
.n.*.bytesperword,.scb!scb_bufend#0A..LET.blocks.#3D
.bytes./.len#0A..bytes.:#3D.bytes.MOD.len#0A..note(
scb,.pvec)#0A..pvec!1.:#3D.pvec!1.+.bytes#0A..IF.pv
ec!1.<.0...DO.pvec!0,.pvec!1.:#3D.pvec!0.-.1,.pvec!
1.+.len#0A..IF.pvec!1.>.len.DO.pvec!0,.pvec!1.:#3D.
pvec!0.+.1,.pvec!1.-.len#0A..pvec!0.:#3D.pvec!0.+.b
locks#0A..RESULTIS.pvec!0.<.1.->.FALSE,.point(scb,.
pvec)#0A}#0A#0A//.Create.a.RAM.stream.for.input.and
.output.using.the.given#0A//.vector,.v,.with.upper.
bound.upb.as.the.buffer,.and.end.is#0A//.the.byte.s
ubscript.of.the.end.of.valid.data#2E#0AAND.mkramstr
eam(buf,.bufend,.end).#3D.VALOF#0A{.LET.scb.#3D.get
vec(scb_upb)#0A..UNLESS.scb.RESULTIS.0#0A..FOR.i.#3D
.0.TO.scb_upb.DO.scb!i.:#3D.0#0A..scb!scb_id......:
#3D.id_inoutscb#0A..scb!scb_type....:#3D.scbt_ram#0A
..scb!scb_buf.....:#3D.buf#0A..scb!scb_end.....:#3D
.end.....//.End.of.valid.data#0A..scb!scb_rdfn....:
#3D.falsefn.//.No.read#0A..scb!scb_wrfn....:#3D.fal
sefn.//.or.write.functions#0A..scb!scb_endfn...:#3D
.ramendfn#0A..scb!scb_bufend..:#3D.bufend..//.Lengt
h.in.bytes#0A..scb!scb_write...:#3D.FALSE...//.No.d
ata.waiting.to.be.written#0A..scb!scb_ldata...:#3D.
end.....//.Number.of.bytes.in.the.last.(only).block
#0A..RESULTIS.scb#0A}#0A#0AAND.falsefn().#3D.FALSE#0A
#0AAND.ramendfn(scb).#3D.TRUE.//.Always.successful#0A
#0AAND.freeobj(obj).BE.freevec(obj)#0A#0AAND.copydi
r(dir).#3D.VALOF#0A{.LET.v.#3D.getvec((dir%0)/bytes
perword)#0A..IF.v.FOR.i.#3D.0.TO.dir%0.DO.v%i.:#3D.
dir%i#0A//sawritef("BLIB:.copydir.called*n")#0A//ab
ort(999)#0A..RESULTIS.v#0A}#0A#0A//.Write.the.speci
fied.number.of.records.of.zeroes.to.the.opened.file
#0AAND.setbulk(scb,.no_records).#3D.VALOF#0A{.LET.o
ldout.#3D.output()#0A..LET.n.#3D.no_records.....*./
/.Number.of.bytes.to.write#0A..........scb!scb_recl
en#0A..MANIFEST.{.bytes.#3D.2048;.words#3Dbytes/byt
esperword.}#0A..LET.v.#3D.VEC.words#0A//sawritef("B
LIB:.setbulk:.clearing.v!0.to.v!%n*n",.words-1)#0A.
.FOR.p.#3D.@v!0.TO.@v!words-1.DO.!p.:#3D.0#0A#0A..r
ewindstream(scb)#0A..selectoutput(scb)#0A..//.Used.
writewords.to.write.2048.bytes.at.a.time#0A//sawrit
ef("BLIB:.setbulk:.writing.%n.bytes.to.file*n",.n)#0A
..WHILE.n>#3Dbytes.DO.{.writewords(v,.words);.n.:#3D
.n-bytes.}#0A..//.and.then.write.the.few.remaining.
bytes,.if.any#2E#0A//sawritef("BLIB:.setbulk:.writi
ng.the.remaining.%n.bytes.to.file*n",.n)#0A..FOR.i.
#3D.1.TO.n.DO.binwrch(0)#0A..rewindstream(scb)#0A..
selectoutput(oldout)#0A..RESULTIS.TRUE#0A}#0A#0AAND
.datstamp(v).#3D.sys(Sys_datstamp,.v)#0A

######cintcode/sysb/dlib.b#
//.This.is.DLIB.(system.dependent.library).for.sing
le.threaded#0A//.Cintcode.BCPL#0A#0A//.It.contains.
functions.that.have.different.definitions.in.Cintpo
s#0A#0A/*#0AChange.log#0A#0A9/11/06#0AChange.treatm
ent.of.RUBOUT.(#23x7F)#0A#0A*/#0A#0ASECTION."DLIB"#0A
#0AGET."libhdr"#0A#0AMANIFEST.{#0A..char_bs.#3D.8#0A
..buflen..#3D.4096.//.Must.equal.the.block.size#0A}
#0A#0ALET.findstream(name,.id,.path).#3D.VALOF.//.M
R.8/5/03#0A{.LET.console.#3D.compstring("**",.name)
#3D0#0A..LET.scb.#3D.?#0A..LET.res.#3D.0#0A..LET.pr
efix.#3D.VEC.31#0A#0A//TEST.path#0A//THEN.sawritef(
"DLIB:.findstream(%s,.%n,.%s)*n",.name,.id,.path)#0A
//ELSE.sawritef("DLIB:.findstream(%s,.%n,.0)*n",.na
me,.id)#0A//sawritef("DLIB:.currentdir#3D%n*n",.cur
rentdir)#0A#0A..IF.console.DO#0A..{.IF.id#3Did_insc
b.&.rootnode!rtn_keyboard.RESULTIS.rootnode!rtn_key
board#0A....IF.id#3Did_outscb.&.rootnode!rtn_screen
..RESULTIS.rootnode!rtn_screen#0A..}.#0A#0A..scb.:#3D
.getvec(scb_upb)#0A..UNLESS.scb.RESULTIS.0#0A#0A..F
OR.i.#3D.0.TO.scb_upb.DO.scb!i.:#3D.0#0A#0A..scb!sc
b_id......:#3D.id#0A..//scb!scb_rdfn....:#3D.0#0A..
//scb!scb_wrfn....:#3D.0#0A..//scb!scb_endfn...:#3D
.0#0A#0A..//.Copy.(truncated).stream.name.into.the.
scb#0A..{.LET.len.#3D.name%0#0A....LET.scbname.#3D.
@scb!scb_name#0A....LET.maxlen.#3D.scb_maxnamelen#0A
....IF.len>scb_maxnamelen.DO.len.:#3D.scb_maxnamele
n#0A....FOR.i.#3D.1.TO.len.DO.scbname%i.:#3D.name%i
#0A....scbname%0.:#3D.len#0A..}#0A#0A..IF.console.D
O#0A..{.//.Console.stream.being.opened.for.the.firs
t.time#0A....LET.buf.#3D.getvec(4095/bytesperword).
//.Room.for.4096.bytes#0A....UNLESS.buf.DO.{.freeve
c(scb);.RESULTIS.0.}#0A....scb!scb_type....:#3D.scb
t_console#0A....scb!scb_buf.....:#3D.buf#0A....scb!
scb_bufend..:#3D.4096#0A#0A....IF.id#3Did_inscb.DO#0A
....{.scb!scb_rdfn...:#3D.cnslrdfn.//.fn.to.repleni
sh.current.buffer#0A......rootnode!rtn_keyboard.:#3D
.scb#0A......RESULTIS.scb#0A....}#0A....IF.id#3Did_
outscb.DO#0A....{.scb!scb_wrfn...:#3D.cnslwrfn.//.f
n.to.output.current.buffer#0A......rootnode!rtn_scr
een.:#3D.scb#0A......RESULTIS.scb#0A....}#0A....//.
Bad.stream.id#0A....freevec(scb)#0A....RESULTIS.0#0A
..}#0A#0A..splitname(prefix,.':',.name,.1)#0A..IF.c
ompstring(prefix,."NIL")#3D0.DO#0A..{.//.On.reading
.always.give.eof#0A....//.On.writing.always.throws.
away.the.data#0A....scb!scb_wrfn....:#3D.nilrdfn#0A
....scb!scb_endfn...:#3D.nilwrfn#0A//sawritef("DLIB
:.Opening.stream.to/from.NIL:*n")#0A....RESULTIS.sc
b.#0A..}#0A#0A..IF.compstring(prefix,."TCP")#3D0.|.
compstring(prefix,."NET")#3D0.DO#0A..{.sawritef("TC
P.connections.not.yet.available*n")#0A....freevec(s
cb)#0A....RESULTIS.0#0A..}#0A#0A..//.Open.a.file.st
ream#0A//sawritef("DLIB:.%s.must.be.a.file*n",.name
)#0A#0A..IF.id#3Did_inscb....&.fh0findinput...(scb,
.name,.path).RESULTIS.scb#0A..IF.id#3Did_outscb...&
.fh0findoutput..(scb,.name).......RESULTIS.scb#0A..
IF.id#3Did_inoutscb.&.fh0findinoutput(scb,.name)...
....RESULTIS.scb#0A#0A..freevec(scb)#0A..RESULTIS.0
#0A}#0A#0AAND.nilrdfn(scb).#3D.FALSE#0A#0AAND.nilwr
fn(scb).#3D.VALOF#0A{.scb!scb_pos.:#3D.0.//.Throw.a
way.the.buffer.contents.(if.any)#0A..RESULTIS.TRUE#0A
}#0A#0AAND.cnslrdfn(scb).#3D.VALOF#0A{.LET.buf,.p.#3D
.scb!scb_buf,.0#0A#0A//sawritef("DLIB:.cnslrdfn:.sc
b#3D%n*n",.scb)#0A..{.LET.ch.#3D.sys(Sys_sardch)#0A
....SWITCHON.ch.INTO#0A....{.DEFAULT:..........buf%
p.:#3D.ch#0A........................p.:#3D.p+1#0A..
......................IF.p<4096.LOOP#0A............
............BREAK#0A#0A......CASE.endstreamch:.IF.p
.BREAK#0A........................//.No.characters.i
n.the.buffer#0A........................result2.:#3D
.endstreamch.//.#3D-1#0A........................RES
ULTIS.FALSE#0A#0A......CASE.'*n':........buf%p.:#3D
.ch#0A........................p.:#3D.p+1#0A........
................BREAK#0A#0A......CASE.#23x7F:......
..//.Rubout#0A........................sys(Sys_sawrc
h,.char_bs)#0A......CASE.char_bs:.....//.Backspace.
--.already.echoed#0A........................sys(Sys
_sawrch,.'.').....//.MR.9/11/06#0A.................
.......sys(Sys_sawrch,.char_bs)#0A.................
.......IF.p>0.DO.p.:#3D.p-1#0A.....................
...LOOP#0A....}#0A..}.REPEAT#0A//sawritef("DLIB:.cn
slrdfn:.line.read*n")#0A//FOR.i.#3D.0.TO.p-1.DO.saw
rch(buf%i)#0A..scb!scb_pos,.scb!scb_end.:#3D.0,.p#0A
..RESULTIS.TRUE#0A}#0A#0AAND.cnslwrfn(scb).#3D.VALO
F#0A{.LET.buf.#3D.scb!scb_buf#0A//sawritef("DLIB:.c
nslwrfn(%n).called*n",.scb)#0A//sawritef("DLIB:.cns
lwrfn:.buf#3D%n.pos#3D%n.end#3D%n*n",#0A//.........
.scb!scb_buf,.scb!scb_pos,.scb!scb_end)#0A#0A..FOR.
i.#3D.0.TO.scb!scb_pos-1.DO.sys(Sys_sawrch,.buf%i)#0A
..scb!scb_pos.:#3D.0#0A..scb!scb_end.:#3D.0..//.No.
valid.data#0A..RESULTIS.TRUE#0A}#0A#0AAND.flush().#3D
.VALOF#0A{.IF.cos#3D0.|.cos!scb_id~#3Did_outscb.DO.
abort(187)#0A..RESULTIS.fh0wrfn(cos)#0A}..#0A#0AAND
.getremipaddr(scb).#3D.VALOF#0A{#0Asawritef("DLIB:.
getremipaddr.not.yet.available*n")#0ARESULTIS.0#0A.
..UNLESS.scb!scb_type#3Dscbt_tcp.|.scb!scb_type#3Ds
cbt_net.DO#0A..{.result2.:#3D.0#0A....RESULTIS.0#0A
..}#0A..RESULTIS.0.//sendpkt(-1,.scb!scb_task,.Acti
on_getremipaddr,.0,0,.scb)#0A}#0A#0AAND.relfilename
(name).#3D.VALOF#0A{.//.Absolute.file.names.are.(eg
):#0A..//.."/abc"...."\xyz"..."pqr:vuw"#0A..LET.len
.#3D.name%0#0A..UNLESS.len.RESULTIS.TRUE#0A..IF.nam
e%1#3D'/'.|.name%1#3D'\'.RESULTIS.FALSE#0A..FOR.i.#3D
.1.TO.len.IF.name%i#3D':'.RESULTIS.FALSE#0A..RESULT
IS.TRUE#0A}#0A#0AAND.trfilename(name,.filename).BE#0A
{.LET.p.#3D.0#0A#0A//IF.currentdir.DO#0A//...sawrit
ef("DLIB:.trfilename:.name#3D%s.currentdir#3D%n*n",
.name,.currentdir)#0A#0A..IF.currentdir.&.relfilena
me(name).DO#0A..{.LET.len.#3D.currentdir%0#0A....LE
T.lastch.#3D.currentdir%len#0A....IF.lastch#3D'/'.|
.lastch#3D':'.DO.len.:#3D.len-1#0A....IF.len.DO#0A.
...{.FOR.i.#3D.1.TO.len.DO.{.p.:#3D..p+1;.filename%
p.:#3D.currentdir%i.}#0A......p.:#3D.p+1#0A......fi
lename%p.:#3D.'/'#0A....}#0A..}#0A..FOR.i.#3D.1.TO.
name%0.DO.{.p.:#3D..p+1;.filename%p.:#3D.name%i.}#0A
..filename%0.:#3D.p#0A..//FOR.i.#3D.1.TO.p.IF.filen
ame%i#3D':'.DO.filename%i.:#3D.'/'#0A//TEST.current
dir#0A//THEN.sawritef("DLIB:.trfilename.%s.%s.#3D>.
%s*n",.currentdir,.name,.filename)#0A//ELSE.sawrite
f("DLIB:.trfilename.%s.#3D>.%s*n",.name,.filename)#0A
}#0A#0AAND.fh0findinput(scb,.name,.path).#3D.VALOF#0A
//.Returns.TRUE...if.successful#0A//.Returns.FALSE,
.result2#3D100..Can't.open.file#0A//...............
.result2#3D101..Can't.allocate.buffer#0A{.LET.fp,.b
uf.#3D.0,.0#0A..LET.filesize.#3D.0#0A..LET.filename
.#3D.VEC.50#0A..trfilename(name,.filename)#0A#0A//s
awritef("DLIB:.fh0findinput.calling.sys_openread.%s
.%s*n",#0A//..........filename,.path->path,"null")#0A
..//.Open.the.file.for.input#0A..fp.:#3D.sys(Sys_op
enread,.filename,.path)..//.MR.8/5/03#0A..UNLESS.fp
.DO#0A..{#0A//sawritef("DLIB:.fh0findinput.sys_open
read.%s.failed*n",.filename)#0A....result2.:#3D.100
#0A....RESULTIS.FALSE#0A..}#0A#0A//sawritef("DLIB:.
%s.opened*n",.filename)#0A..filesize.:#3Dsys(Sys_fi
lesize,.fp)#0A//sawritef("DLIB:.filesize#3D%n*n",.f
ilesize)#0A#0A..//.allocate.a.buffer#0A..buf.:#3D.g
etvec(buflen/bytesperword)#0A..UNLESS.buf.DO#0A..{.
sys(Sys_close,.fp).//.First.close.the.file#0A....re
sult2.:#3D.101#0A....RESULTIS.0#0A..}#0A//sawritef(
"DLIB:.fh0findinput.scb.%n.fp.%n.buf.%n*n",.scb,.fp
,.buf)#0A....#0A..scb!scb_type....:#3D.scbt_file#0A
..scb!scb_task....:#3D.0#0A..scb!scb_buf.....:#3D.b
uf#0A..scb!scb_rdfn....:#3D.fh0rdfn#0A..scb!scb_wrf
n....:#3D.0.......//.An.input.stream.cannot.be.depl
eted#0A..scb!scb_endfn...:#3D.fh0endfn#0A..scb!scb_
fd......:#3D.fp#0A..scb!scb_bufend..:#3D.buflen#0A.
.scb!scb_write...:#3D.FALSE...//.No.data.waiting.to
.be.written#0A..scb!scb_blength.:#3D.buflen..//.MR.
15/3/02#0A..scb!scb_block...:#3D.0.......//.MR.29/7
/02#0A..scb!scb_lblock..:#3D.filesize/buflen.//+.1.
.//.MR.16/4/02.MR.29/7/02#0A..scb!scb_ldata...:#3D.
filesize.REM.buflen..//.MR.16/4/02#0A//sawritef("fh
0findinput:.lblock#3D%n*n",.scb!scb_lblock)#0A#0A..
//.Initialise.the.buffer.by.reading.the.first.block
#0A..fh0getbuf(scb)#0A..RESULTIS.scb#0A}#0A#0AAND.f
h0findoutput(scb,.name).#3D.VALOF#0A//.Returns.TRUE
...if.successful#0A//.Returns.FALSE,.result2#3D100.
.Can't.open.file#0A//................result2#3D101.
.Can't.allocate.buffer#0A{.LET.fp,.buf.#3D.0,.0#0A.
.LET.filename.#3D.VEC.50#0A..trfilename(name,.filen
ame)#0A#0A..//.Open.the.file.for.output#0A..fp.:#3D
.sys(Sys_openwrite,.filename)#0A..UNLESS.fp.DO#0A..
{.result2.:#3D.100#0A....RESULTIS.FALSE#0A..}#0A#0A
..//.allocate.a.buffer#0A..buf.:#3D.getvec(buflen/b
ytesperword)#0A..UNLESS.buf.DO#0A..{.sys(Sys_close,
.fp).//.First.close.the.file#0A....result2.:#3D.101
#0A....RESULTIS.FALSE#0A..}#0A#0A//sawritef("DLIB:.
fh0findoutput.scb.%n..%n..buf.%n*n",.scb,.fp,.buf)#0A
#0A..scb!scb_type....:#3D.scbt_file#0A..scb!scb_tas
k....:#3D.0#0A..scb!scb_buf.....:#3D.buf#0A..scb!sc
b_rdfn....:#3D.0.......//.Can't.replenish.output.st
reams#0A..scb!scb_wrfn....:#3D.fh0wrfn#0A..scb!scb_
endfn...:#3D.fh0endfn#0A..scb!scb_fd......:#3D.fp#0A
..scb!scb_bufend..:#3D.buflen#0A..scb!scb_write...:
#3D.FALSE...//.No.data.waiting.to.be.written#0A..sc
b!scb_blength.:#3D.buflen#0A..scb!scb_block...:#3D.
0.......//.MR.29/7/02#0A..scb!scb_lblock..:#3D.0...
....//.This.is.an.empty.file.currently,.MR.29/7/02#0A
..scb!scb_ldata...:#3D.0#0A//sawritef("fh0findoutpu
t:.lblock#3D%n*n",.scb!scb_lblock)#0A#0A..scb!scb_p
os.....:#3D.0.......//.The.buffer.has.no.valid.data
.initially#0A..scb!scb_end.....:#3D.0#0A#0A..result
2.:#3D.0#0A..RESULTIS.TRUE#0A}#0A#0AAND.fh0findinou
tput(scb,.name).#3D.VALOF#0A//.Returns.TRUE...if.su
ccessful#0A//.Returns.FALSE,.result2#3D100..Can't.o
pen.file#0A//................result2#3D101..Can't.a
llocate.buffer#0A{.LET.fp,.buf,.res1,.res2.#3D.0,.0
,.1,.0#0A..LET.filesize.#3D.0#0A..LET.filename.#3D.
VEC.50#0A..trfilename(name,.filename)#0A#0A..//.ope
n.the.file.for.input.and.output#0A..fp.:#3D.sys(Sys
_openreadwrite,.filename)#0A//sawritef("DLIB:.open.
%s.in.inout.mode.#3D>.%n*n",.filename,.fp)#0A..UNLE
SS.fp.DO#0A..{.result2.:#3D.100#0A....RESULTIS.FALS
E#0A..}#0A#0A..filesize.:#3Dsys(Sys_filesize,.fp)#0A
//sawritef("BLIB:.filesize#3D%n*n",.filesize)#0A#0A
..//.allocate.a.buffer#0A..buf.:#3D.getvec(buflen/b
ytesperword)#0A..UNLESS.buf.DO#0A..{.sys(Sys_close,
.fp).//.First.close.the.file#0A....result2.:#3D.101
#0A....RESULTIS.FALSE#0A..}#0A//sawritef("DLIB:.buf
len.#3D.%n*n",.buflen)#0A//sawritef("DLIB:.fh0findi
noutput.scb.%n..%n..buf.%n*n",.scb,.fp,.buf)#0A#0A.
.scb!scb_type....:#3D.scbt_file#0A..scb!scb_buf....
.:#3D.buf#0A..scb!scb_rdfn....:#3D.fh0rdfn#0A..scb!
scb_wrfn....:#3D.fh0wrfn#0A..scb!scb_endfn...:#3D.f
h0endfn#0A..scb!scb_fd......:#3D.fp#0A..scb!scb_buf
end..:#3D.buflen#0A..scb!scb_write...:#3D.FALSE.../
/.No.data.waiting.to.be.written#0A..scb!scb_blength
.:#3D.buflen..//.MR.15/3/02#0A..scb!scb_block...:#3D
.0.//1.MR.29/7/02#0A..scb!scb_lblock..:#3D.filesize
/buflen.//+.1..//.MR.16/4/02.MR.29/7/02#0A..scb!scb
_ldata...:#3D.filesize.REM.buflen..//.MR.16/4/02#0A
//sawritef("fh0findinoutput:.lblock#3D%n*n",.scb!sc
b_lblock)#0A#0A..//.Initialise.the.buffer.by.readin
g.the.first.block#0A..UNLESS.fh0getbuf(scb).DO#0A..
{.//.Failed.to.fill.the.buffer.with.data#0A....sawr
itef("DLIB:.fh0getbuf(%n).failed*n",.scb)#0A....RES
ULTIS.FALSE#0A..}#0A..res2.:#3D.result2#0A..RESULTI
S.TRUE#0A}#0A#0AAND.fh0falsefn(scb)..#3D.FALSE#0A#0A
#0AAND.fh0rdfn(scb)..#3D.VALOF#0A//.This.is.only.us
ed.for.disc.files#2E.The.field.end.will.equal#0A//.
buflen.for.all.blocks.except.possibly.the.last.one#2E
#0A//.If.the.buffer.contains.data.from.the.last.blo
ck.and.pos#3Dend,#0A//.then.EOF.has.been.reached#2E
.If.pos#3Dend.data.from.the.next.block#0A//.must.be
.read#2E.But.the.current.block.will.first.have.to.b
e#0A//.written.to.disc,.if.the.write.field.is.TRUE#2E
#0A//.Returns.TRUE,..if.successful#2E.There.will.be
.valid.data.between#0A//................pos.and.end
.in.the.buffer#2E#0A//.Returns.FALSE,.result2#3D-1.
on.EOF#0A//.........FALSE,.result2#3Derrorcode,.oth
erwise#2E#0A{.LET.block,.lblock.#3D.scb!scb_block,.
scb!scb_lblock#0A..LET.pos,...end....#3D.scb!scb_po
s,...scb!scb_end#0A//sawritef("DLIB:.fh0readfn.scb.
%n.pos.%n.end.%n*n",.scb,.pos,.end)#0A//sawritef("D
LIB:.fh0readfn.block.%n.lblock.%n*n",.block,.lblock
)#0A..IF.pos<end......RESULTIS.TRUE..//.Data.still.
available.in.current.buffer#0A..IF.block#3Dlblock.D
O.{.result2.:#3D.-1;.RESULTIS.FALSE.}.//.End-of-fil
e#0A#0A..IF.scb!scb_write.DO.fh0putbuf(scb)..//.Wri
te.block.if.necessary#0A#0A..IF.end>#3Dbuflen.DO.bl
ock.:#3D.block+1..//.Advance.block.if.necessary#0A.
.scb!scb_block,.scb!scb_pos.:#3D.block,.0#0A//sawri
tef("DLIB:.fh0rdfn.block.%n.pos.%n.end.%n*n",.scb!s
cb_block,.pos,.end)#0A#0A..UNLESS.fh0getbuf(scb).DO
#0A..{.sawritef("DLIB:.fh0getbuf(%n).failed*n",.scb
)#0A....RESULTIS.FALSE..//.Read.data.into.the.buffe
r#0A..}#0A#0A..//.Safety.check#0A..end.:#3D.scb!scb
_end#0A..UNLESS.end#3Dbuflen.|.lblock.#3D.scb!scb_b
lock.DO#0A..{.sawritef("DLIB:.fh0rdfn.block#3D%n.lb
lock#3D%n.pos#3D%n.end#3D%n*n",#0A..............scb
!scb_block,.lblock,.scb!scb_pos,.end)#0A....abort(9
999)#0A..}#0A..#0A..RESULTIS.TRUE..............//.T
he.buffer.is.not.empty#0A}..#0A...#0AAND.fh0wrfn(sc
b).#3D.VALOF#0A//.Write.the.current.buffer.to.file,
.if.the.write.flag.is.set#0A//.Return.TRUE,.if.succ
essful#0A//.Return.FALSE.otherwise#2E#0A{.LET.block
,.lblock.#3D.scb!scb_block,.scb!scb_lblock#0A..LET.
pos,.end.#3D.scb!scb_pos,.scb!scb_end#0A..LET.len.#3D
.?#0A//sawritef("DLIB:.fh0wrfn.scb.%n.pos.%n.end.%n
*n",.scb,.pos,.end)#0A//sawritef("DLIB:.fh0wrfn.blo
ck.%n.lblock.%n*n",.block,.lblock)#0A..IF.scb!scb_w
rite.DO.//.Write.current.block.if.necessary#0A....U
NLESS.fh0putbuf(scb).RESULTIS.FALSE#0A#0A//..IF.pos
<scb!scb_bufend.DO#0A//sawritef("DLIB:.return0.from
.fh0wrfn.block#3D%n.lblock#3D%n.pos#3D%n.end#3D%n*n
",#0A//..........scb!scb_block,.scb!scb_lblock,.pos
,.end)#0A#0A..IF.pos.<.scb!scb_bufend.RESULTIS.TRUE
..//.Still.room.in.the.buffer#0A..//.Move.to.next.b
lock#0A..block.:#3D.block+1#0A..scb!scb_block,.scb!
scb_pos,.scb!scb_end.:#3D.block,.0,.0#0A..IF.block>
lblock.DO#0A..{.scb!scb_lblock.:#3D.block....//.Las
t.block.is.empty#0A//sawritef("DLIB:.return1.from.f
h0wrfn.block#3D%n.lblock#3D%n.pos#3D%n.end#3D%n*n",
#0A//..........scb!scb_block,.scb!scb_lblock,.pos,.
end)#0A....RESULTIS.TRUE#0A..}#0A#0A..IF.scb!scb_id
#3Did_inoutscb.UNLESS.fh0getbuf(scb).DO#0A..{.sawri
tef("DLIB:.fh0wrfn.getbuf.failed.block#3D%n.lblock#3D
%n.pos#3D%n.end#3D%n*n",#0A..............scb!scb_bl
ock,.scb!scb_lblock,.pos,.end)#0A....abort(1102)#0A
..}#0A#0A//sawritef("DLIB:.return2.from.fh0wrfn.blo
ck#3D%n.lblock#3D%n.pos#3D%n.end#3D%n*n",#0A//.....
.....scb!scb_block,.scb!scb_lblock,.pos,.end)#0A#0A
..RESULTIS.TRUE#0A}..#0A#0A...#0AAND.fh0endfn(scb).
#3D.VALOF#0A//.Write.the.buffer,.if.necessary,.and.
free.it#2E#0A//.Close.the.file#2E#0A//.Return.TRUE,
.if.successful#0A//.Return.FALSE.otherwise#2E#0A{#0A
//sawritef("DLIB:.fh0endfn.scb.%n,.write.flag#3D%n*
n",.scb,.scb!scb_write)#0A//sawritef("DLIB:.fh0endf
n.pos#3D%n.end#3D%n*n",.scb!scb_pos,.scb!scb_end)#0A
..IF.scb!scb_write.UNLESS.fh0putbuf(scb).RESULTIS.F
ALSE#0A//sawritef("DLIB:.fh0endfn.freeing.buf#3D%n*
n",.scb!scb_buf)#0A..freevec(scb!scb_buf)#0A..RESUL
TIS.sys(Sys_close,.scb!scb_fd)#0A}#0A#0A//.Result.T
RUE:.posv.contains.the.stream.block.and.pos#0A//...
....FALSE:.scb.was.not.a.file.or.RAM.stream#0AAND.n
ote(scb,.posv).#3D.VALOF#0A{.LET.type.#3D.scb!scb_t
ype#0A..UNLESS.type#3Dscbt_file.|.type#3Dscbt_ram.R
ESULTIS.FALSE#0A..posv!0.:#3D.scb!scb_block#0A..pos
v!1.:#3D.scb!scb_pos#0A//sawritef("DLIB:.note.#3D>.
%n.%n*n",.posv!0,.posv!1)#0A..RESULTIS.TRUE#0A}#0A#0A
//.Set.the.stream.position.to.that.specified.in.pos
v#2E..If.the#0A//.new.position.is.in.a.different.bl
ock.the.buffer.may.have.to#0A//.be.written.out.and.
new.data.read.in#2E#0A//.It.returns.TRUE.if.success
ful,.even.if.positioned.just.after.the#0A//.last.bl
ock.of.the.file,.ie.block#3Dlblock+1.and.pos#3Dend#3D
0#2E#0A//.It.returns.FALSE,.otherwise#2E.Possibly.b
ecause.the.stream.is.not#0A//.pointable.or.the.posv
.is.out.of.range#2E#0AAND.point(scb,.posv).#3D.VALO
F#0A{.LET.blkno..#3D.posv!0#0A..LET.pos....#3D.posv
!1#0A..LET.id.....#3D.scb!scb_id#0A..LET.block..#3D
.scb!scb_block...//.Current.block.number#0A..LET.lb
lock.#3D.scb!scb_lblock..//.Last.block.number.of.th
e.stream#0A..LET.end....#3D.scb!scb_end#0A..LET.typ
e...#3D.scb!scb_type#0A//sawritef("DLIB:.point.posv
!0#3D%n.posv!1#3D%n*n",.posv!0,.posv!1)#0A#0A//sawr
itef("DLIB:.point.block#3D%n.lblock#3D%n.blkno#3D%n
.pos#3D%n.end#3D%n*n",#0A//...............block,.lb
lock,..blkno,.pos,.end)#0A#0A...//.The.stream.must.
be.a.readable.disc.or.RAM.file#0A..UNLESS.(type#3Ds
cbt_file.|.type#3Dscbt_ram).&#0A.........(id#3Did_i
nscb.|.id#3Did_inoutscb).RESULTIS.FALSE#0A#0A..IF.p
os#3D0.&.blkno#3Dlblock+1.DO.blkno,.pos.:#3D.lblock
,.buflen#0A.#0A//sawritef("DLIB:.point.block#3D%n.l
block#3D%n.blkno#3D%n.pos#3D%n.end#3D%n*n",#0A//...
............block,.lblock,..blkno,.pos,.end)#0A#0A/
/..IF.blkno<#3D0.DO.blkno,.pos.:#3D.0,.0.//.Cannot.
position.before.start.of.file#0A#0A..//.Safety.chec
k#0A..//.Make.sure.the.position.is.within.the.file#0A
..IF.blkno<0.|.#0A.....blkno>lblock.|#0A.....blkno#3D
lblock.&.pos.>.(block#3Dlblock.->.end,.scb!scb_ldat
a)..DO#0A..{.sawritef("DLIB:.point.beyond.end.of.fi
le,.blkno#3D%n.pos#3D%n*n",.blkno,.pos)#0A....sawri
tef("block#3D%n.end#3D%n.lblock#3D%n.posv#3D(%n,%n)
*n",#0A..............block,.end,.lblock,.posv!0,.po
sv!1)#0A....abort(999)#0A....RESULTIS.FALSE#0A..}#0A
#0A..IF.blkno#3Dblock.DO#0A..{.//.The.new.position.
is.in.the.current.block#0A....scb!scb_block.:#3D.bl
kno#0A....scb!scb_pos...:#3D.pos#0A//sawritef("DLIB
:.point.setting.scb.block#3D%n.pos#3D%n*n",.blkno,.
pos)#0A....RESULTIS.TRUE.//.Success#0A..}#0A#0A..//
.The.move.is.to.a.different.block,.so.must.read.a.b
lock#0A..//.but.first.check.if.the.current.block.mu
st.be.written#0A..IF.scb!scb_write.DO#0A..{.//sawri
tef("DLIB:.point.write.block.%n*n",.scb!scb_block).
#0A....UNLESS.fh0putbuf(scb).DO.abort(5003)#0A..}#0A
#0A..scb!scb_block.:#3D.blkno..//.Set.the.new.posit
ion#0A.#0A//sawritef("DLIB:.point.read.block.%n*n",
.blkno)#0A#0A..UNLESS.fh0getbuf(scb).DO#0A..{.sawri
tef("DLIB:.point.fh0getbuf.failed.block.%n.#3D>.%n*
n",.blkno,.end)#0A....abort(5004)#0A....RESULTIS.FA
LSE#0A..}#0A#0A..//.Safety.check#0A..UNLESS.scb!scb
_end#3Dbuflen.|#0A.........blkno#3Dlblock.&.end>#3D
scb!scb_ldata.DO#0A..{.sawritef("DLIB.point:.safety
.check.failed*n")#0A....sawritef("DLIB.point:.blkno
.%n.pos.%n*n",.blkno,.pos)#0A....sawritef("DLIB.poi
nt:.end.%n.buflen.%n*n",.scb!scb_end,.buflen)#0A...
.sawritef("DLIB.point:.block.%n.lblock.%n*n",.blkno
,.lblock)#0A....sawritef("DLIB.point:.end.%n.ldata.
%n*n",.end,.scb!scb_ldata)#0A....abort(5005)#0A..}#0A
#0A..scb!scb_pos...:#3D.pos..//.Set.the.desired.off
set#0A#0A//sawritef("DLIB:.point(#2E#2E).#3D>.TRUE,
.blkno.%n.pos.%n*n",.blkno,.pos)#0A..RESULTIS.TRUE#0A
}#0A#0AAND.fh0putbuf(scb).#3D.VALOF#0A//.This.is.on
ly.used.on.disc.file.streams.and.is.only.called.whe
n#0A//.the.write.field.is.TRUE#2E.It.writes.the.buf
fer.to.file#2E#0A//.The.file.is.positioned.before.t
he.write#2E.If.the.last.block#0A//.is.being.written
.ldata.is.set.to.end.and.this.number.of.bytes.writt
en#0A//.to.disc#2E.(For.all.other.blocks.end#3Dbufl
en#2E)#0A//.Returns.TRUE,.if.successful,.having.set
.the.write.field.to.FALSE#2E#0A//.Returns.FALSE,.ot
herwise#2E#0A{.LET.end....#3D.scb!scb_end....//.Num
ber.of.bytes.of.valid.data.in.buf#0A..LET.block..#3D
.scb!scb_block#0A..LET.fd.....#3D.scb!scb_fd#0A..LE
T.offset.#3D.buflen*block...//.File.offset.of.buffe
r's.first.byte.MR.29/7/02#0A#0A..IF.end<#3D0.DO#0A.
.{.//.Nothing.in.the.buffer.to.write,.probably.a.mi
stake#2E#0A....//sawritef("DLIB:.fh0putbuf,.end#3D%
n*n",.end)#0A....scb!scb_write.:#3D.FALSE#0A....RES
ULTIS.TRUE#0A..}#0A#0A..//.The.size.of.a.file.can.o
nly.change.when.writing.its.last.block#0A..//.so.ld
ata.only.needs.correcting.when.this.happens#0A..IF.
block.#3D.scb!scb_lblock.DO.scb!scb_ldata.:#3D.end#0A
#0A//sawritef("DLIB:.putbuf.seeking.offset.%n.(bloc
k.%n)*n",.offset,.block)#0A..UNLESS.sys(Sys_seek,.f
d,.offset).RESULTIS.FALSE#0A#0A//sawritef("DLIB:.pu
tbuf.write.%n.bytes.at.offset.%n*n",.end,.offset)#0A
..IF.sys(Sys_write,.fd,.scb!scb_buf,.end).<.0#0A...
.RESULTIS.FALSE#0A..scb!scb_write.:#3D.FALSE.//.The
.buffer.has.been.written.successfully#0A..RESULTIS.
TRUE#0A}#0A#0A//.fh0getbuf.reads.a.block.into.the.s
cb's.buffer#2E#0A//.Returns.TRUE.if.successful#0A//
......having.set.pos#3D0.and.end.to.the.end.of.vali
d.data#0A//.Returns.FALSE,.otherwise#2E#0A#0AAND.fh
0getbuf(scb).#3D.VALOF#0A{.LET.fd......#3D.scb!scb_
fd#0A..LET.block...#3D.scb!scb_block#0A..LET.offset
..#3D.buflen*block....//.MR.29/7/02#0A..LET.end....
.#3D.?.#0A#0A//sawritef("DLIB:.fh0getbuf.seeking.st
art.of.block.%n.(offset.%n)*n",#0A//............blo
ck,.offset)#0A..UNLESS.sys(Sys_seek,.fd,.offset).RE
SULTIS.FALSE#0A//sawritef("DLIB:.fh0getbuf.file.pos
ition.now.%n*n",.sys(Sys_tell,.fd))#0A#0A//sawritef
("DLIB:.fh0getbuf.reading.block.%n.offset#3D%n*n",.
block,.offset)#0A..end.:#3D.sys(Sys_read,.fd,.scb!s
cb_buf,.buflen)#0A//sawritef("DLIB:.fh0getbuf.read.
#3D>.%n*n",.end)#0A//sawritef("DLIB:.fh0getbuf.bloc
k#3D%n.lblock#3D%n.ldata#3D%n*n",#0A//.............
..block,.scb!scb_lblock,.scb!scb_ldata)#0A..IF.end<
0.RESULTIS.FALSE.//.Unable.to.read#0A..scb!scb_pos,
.scb!scb_end.:#3D.0,.end.#0A..RESULTIS.TRUE#0A}#0A#0A
AND.delay(ms).#3D.VALOF#0A{.LET.days,.msecs.#3D.?,.
?#0A..MANIFEST.{.msperday.#3D.24*60*60*1000.}#0A..d
atstamp(@days)#0A//sawritef("delay:.time.now.......
days#3D%i5.msecs#3D%n*n",.days,.msecs)#0A..msecs.:#3D
.msecs+ms#0A..IF.ms>msperday.DO.days,.msecs.:#3D.da
ys+1,.msecs-msperday#0A//sawritef("delay:.delaying.
until.days#3D%i5.msecs#3D%n*n",.days,.msecs)#0A..RE
SULTIS.delayuntil(days,.msecs)#0A}#0A#0AAND.delayun
til(days,.msecs).BE#0A{.LET.ds,.ms.#3D.0,.0#0A..dat
stamp(@ds)#0A..IF.ds<days.RETURN#0A..IF.ds#3Ddays.&
.ms<#3Dmsecs.RETURN#0A..sys(Sys_delay,.1).//.Sleep.
for.1.msec#0A}.REPEAT#0A#0A#0A#0A

######cintcode/sysb/boot.b#
//.(c).Copyright:.Martin.Richards...23.Jan.2007#0A#0A
/*#0AChange.log#0A#0A8/11/06#0AMade.several.changes
.for.the.-v.and.-d.options,.and.for.dumpsys#2E#0A#0A
27/07/06#0AStored.the.default.environment.variable.
names.for.the.system.root,#0Athe.headers.and.the.cl
i.path.directories.in.the.rootnode#2E.#0A#0A05/07/0
6#0AChanged.to.use.mainly.lowercase.file.names#2E#0A
#0A12/01/06#0AAs.suggested.by.Dave.Lewis,.saved.cli
_returncode.from.the.CLI.global#0Avector.in.the.BOO
T.global.vector,.so.that.this.value.can.be.returned
#0Ato.the.(Unix).shell#2E#0A*/#0A#0ASECTION."BOOT"#0A
#0AGET."libhdr"#0AGET."clihdr"..//.MR.17/1/2006#0A#0A
GLOBAL.{#0Asadebug:ug#0Acheckaddr#0Acont#0Adebug#0A
error#0Agb#0Agh#0Agsb#0Agsh#0Agw#0Ainstrtype#0Afnam
e#0Anextpc#0Apraddr#0Aprinstr#0Aprint#0Ardval#0Ardv
araddr#0Arch#0Awrcortn#0Awrframe#0Awritearg#0A#0Abp
t........//.The.current.breakpoint.number.or.-1#0Ab
pt_addr...//.Vector.of.breakpoint.PC.values#0Abpt_i
nstr..//.Vector.of.breakpoint.first.bytes.(op.codes
)#0Abrkstep....//.#3DTRUE.when.resuming.from.a.brea
kpoint#0Asnglstep...//.#3DTRUE.when.single.stepping
.(\.command)#0A#0Agptr.......//.Currently.selected.
G.pointer#0Acptr.......//.Currently.selected.corout
ine#0Apptr.......//.Currently.selected.P.pointer#0A
fsize......//.Size.of.currently.selected.stack.fram
e#0A#0Amembase#0Amemlim#0Aoldcount#0Arecp#0Arecl#0A
regs.......//.The.register.set.of.the.selected.task
#0Atrapregs...//.regs.on.entry.to.sadebug,.ie.the.s
et.that.caused#0A...........//.cinterp.to.return.wi
th.a.non.zero.result#2E#0Astyle#0Aval........//.Cur
rent.value#0Avars.......//.Vector.of.variables.(V1.
#2E#2E.V9)#0A#0Acrntcb.....//.Currently.selected.TC
B,.if.in.Cintpos#0Ach#0Alch#0A}#0A#0ASTATIC.{.debug
started.#3D.FALSE.}.//.For.Cintpos.only#0A#0AMANIFE
ST#0A{#0Ag_globsize#3D0;.g_sys#3D3;.g_currco#3D7;.g
_colist#3D8;.g_rootnode#3D9#0A#0Af_brk...#3D.2#0A#0A
r_a.....#3D.0#0Ar_b.....#3D.1#0Ar_c.....#3D.2#0Ar_p
.....#3D.3#0Ar_g.....#3D.4#0Ar_st....#3D.5#0Ar_pc..
..#3D.6#0Ar_count.#3D.7#0Ar_mw....#3D.8#0Ar_upb...#3D
.8#0A#0Aroot_stackupb.#3D..500..//.MR.25/1/07#0Aroo
t_gvecupb..#3D.1000..//.MR.25/1/07#0Agn_cli_returnc
ode.#3D.137..//.dtl.25-09-06,.matches.declaration.f
or.cli_returncode#0A#0A//.Cintpos.only#0Atasktabupb
.#3D.200..//.MR.18/10/04#0Adevtabupb..#3D.1000#0A}#0A
#0ALET.start(fn,.size,.c).BE#0A//.This.is.the.very.
first.BCPL.code.to.be.entered.(from.cintsys/cintpos
)#0A//.Its.stack.and.globals.are.already.setup#0A//
.globsize.(G0).is.already.set.--.MR.25/1/07#0A//.ro
otnode.(G9).is.already.set.--.MR.25/1/07#0A//.p!0.h
olds.the.stack.size#0A//.sys.is.in.rootnode!rtn_sys
#0A{.//.First.make.the.boot.stack.into.a.coroutine.
stack#0A..//.for.debugging.purposes#2E#0A..LET.cosz
.#3D.?#0A..currco.:#3D.@fn-3...............//.currc
o.#3D.base.of.the.boot.stack#0A..cosz.:#3D.currco!0
..............//.The.size.as.supplied.by.cintsys/ci
ntpos#0A#0A..colist.:#3D.currco#0A..currco!co_pptr.
....:#3D..0#0A..currco!co_parent...:#3D.-1......//.
Mark.as.root.coroutine#0A..currco!co_list.....:#3D.
.0#0A..currco!co_fn.......:#3D..start..//.These.are
.the.same.locations.as.fn#0A..currco!co_size.....:#3D
..cosz...//.................................size#0A
..currco!co_c........:#3D..0......//...............
..............and.c#0A#0A..boot()#0A}#0A#0AAND.boot
().BE#0A//.This.is.the.very.first.BCPL.code.to.be.e
ntered.(from.cintsys/cintpos)#2E#0A//.Its.stack.is.
allocated.and.initialised.with.#23xABCD1234.but#0A/
/.must.be.made.into.a.root.coroutine.stack#2E.The.g
lobal.vector#0A//.is.allocated.and.fully.initilalis
e.with.all.the.entry.points#0A//.in:.boot,.blib,.sy
slib.and.dlib#2E#0A#0A//.Most.rootnode.fields.have.
been.initialised.by.cintsys/cintpos,#0A//.including
#0A#0A//.rtn_boot...The.module.boot.ie.this.module#0A
//.rtn_blib...The.module.blib,.syslib.and.dlib#0A//
.rtn_sys....The.function.sys#0A#0A{.LET.g,.p.#3D.0,
.0#0A...#0A..IF.rootnode!rtn_boottrace.DO#0A..{.saw
ritef("BOOT.stack.is.at.%n*n",.currco)#0A....sawrit
ef("BOOT.global.vector.is.at.%n*n",.@globsize)#0A..
}#0A#0A..//.Allocate.the.root.stack.and.global.vect
or.(for.klib.or.cli)#0A..p.:#3D.getvec(root_stackup
b+6)..//.The.root.coroutine.stack#0A..g.:#3D.getvec
(root_gvecupb).....//.The.root.global.vector#0A#0A.
.//.boot.only.uses.standalone.i/o#0A..rdch,.wrch.:#3D
.sardch,.sawrch#0A#0A..IF.rootnode!rtn_boottrace>1.
DO#0A..{.sys(Sys_tracing,.FALSE)#0A....sawritef("bo
ot:.instruction.tracing.turned.off*n")#0A..}#0A#0A.
.UNLESS.p.&.g.DO#0A..{.sawritef("System.error.in.bo
ot:.getvec.failed*n")#0A....sys(Sys_quit,.0)#0A..}#0A
#0A..IF.rootnode!rtn_boottrace.DO#0A..{.sawritef("C
LI.stack.allocated.at.%n*n",.p)#0A....sawritef("CLI
.global.vector.allocated.at.%n*n",.g)#0A..}#0A#0A..
//.Clear.the.root.global.vector.and.stack.(for.klib
.to.cli)#0A..g!0.:#3D.root_gvecupb#0A..p!0.:#3D.roo
t_stackupb#0A..FOR.i.#3D.1.TO.g!0.DO.g!i.:#3D.globw
ord.+.i;#0A..FOR.i.#3D.1.TO.p!0+6.DO.p!i.:#3D.stack
word#0A.#0A..writef("*nBCPL.Cintcode.System.(6.May.
2008)*n")#0A#0A..IF.rootnode!rtn_boottrace>1.DO#0A.
.{.sawritef("boot:.turning.on.instruction.tracing*n
")#0A....sys(Sys_tracing,.TRUE)#0A..}#0A#0A..//.Set
.the.environment.variable.names.for.this.system.in.
the.rootnode#0A..//.BCPL.Cintcode.uses.BCPLROOT,...
BCPLPATH...and.BCPLHDRS#0A..//.BCPL64........uses.B
CPL64ROOT,.BCPL64PATH.and.BCPL64HDRS#0A..//.Cintpos
.......uses.POSROOT,....POSPATH....and.POSHDRS#0A..
{.LET.rootvar,.pathvar,.hdrsvar,.scriptsvar.#3D.#0A
........"BCPLROOT",..."BCPLPATH",..."BCPLHDRS",..."
BCPLSCRIPTS"#0A......//"BCPL64ROOT",."BCPL64PATH",.
"BCPL64HDRS",."BCPL64SCRIPTS"#0A......//"POSROOT",.
..."POSPATH",...."POSHDRS",...."POSSCRIPTS"#0A....r
ootnode!rtn_rootvar....:#3D.rootvar#0A....rootnode!
rtn_pathvar....:#3D.pathvar#0A....rootnode!rtn_hdrs
var....:#3D.hdrsvar#0A....rootnode!rtn_scriptsvar.:
#3D.scriptsvar.//.Not.used.yet#0A..}#0A#0A//writef(
"Type.5.characters.to.test.standalone.rdch*n")#0A//
FOR.i.#3D.1.TO.5.DO#0A//{.LET.ch.#3D.sardch()#0A//.
.sawritef("ch.#3D.%n.'%c'*n",.ch,.ch)#0A//..IF.ch#3D
'#2E'.BREAK#0A//}#0A#0A#0A..g!g_globsize.:#3D.root_
gvecupb#0A..g!g_sys......:#3D.sys#0A..g!g_rootnode.
:#3D.rootnode#0A..g!g_currco...:#3D.0..........//.T
hese.are.initialised.to.simplify#0A..g!g_colist...:
#3D.0..........//.the.initial.debugging.of.cintasm#2E
#0A...#0A..//.Initialise.the.standalone.debugger.va
riables#0A..membase...:#3D.rootnode!rtn_membase#0A.
.memlim....:#3D.membase.+.rootnode!rtn_memsize#0A..
vars......:#3D.TABLE.0,0,0,0,0,0,0,0,0,0#0A..bpt_ad
dr..:#3D.TABLE.0,0,0,0,0,0,0,0,0,0#0A..bpt_instr.:#3D
.TABLE.0,0,0,0,0,0,0,0,0,0#0A..style.....:#3D.'F'..
.................//.Default.printing.style#0A..val.
......:#3D.0#0A..brkstep...:#3D.FALSE#0A..snglstep.
.:#3D.FALSE#0A#0A..crntcb....:#3D.0.......//.For.Ci
ntpos.only#0A#0A..//.Breakpoints.may.be.set.and.cle
ared.by.the.debug.task.so#0A..//.bpt_addr.and.bpt_i
nstr.must.be.accessible.to.it#2E.These.fields#0A../
/.are.also.used.by.the.dumpdebug.command#2E#0A..roo
tnode!rtn_bptaddr..:#3D.bpt_addr#0A..rootnode!rtn_b
ptinstr.:#3D.bpt_instr#0A..rootnode!rtn_dbgvars..:#3D
.vars........//.MR.25/08/05#0A#0A..regs.........:#3D
.cliregs#0A..regs!r_a.....:#3D.0..........//.A#0A..
regs!r_b.....:#3D.0..........//.B#0A..regs!r_c.....
:#3D.0..........//.C#0A..regs!r_p.....:#3D.p<<B2Wsh
...//.P#0A..regs!r_g.....:#3D.g<<B2Wsh...//.G#0A..r
egs!r_st....:#3D.1..........//.Cintpos.only.--.In.k
lib,.interrupts.disabled#0A..regs!r_pc....:#3D.star
troot..//.PC#0A..regs!r_count.:#3D.-1.........//.Co
unt..(-1.#3D.infinity)#0A..regs!r_mw....:#3D.0.....
.....//.MW.(used.by.64-bit.Cintcode)#0A#0A..{.LET.s
w.#3D.1..//.1#3Dcintasm..2#3Dinterpret#0A....IF.roo
tnode!rtn_boottrace>1.DO.sw.:#3D.2#0A....regs!r_cou
nt.:#3D.sw#3D1.->.-1,.1_000_000_000#0A..}#0A#0A..IF
.rootnode!rtn_boottrace>1.DO#0A..{.sys(Sys_tracing,
.FALSE)#0A....sawritef("boot:.instruction.tracing.t
urned.off*n")#0A..}#0A#0A..IF.rootnode!rtn_boottrac
e.DO#0A..{.sawritef("boot.about.to.call.the.interpr
eter.recursively*n")#0A....sawritef("It.should.star
t.executing.the.boot.function:.startroot*n")#0A..}#0A
#0A..{.//.In.this.loop.a.private.copy.of.the.sys.fu
nction.is.made#0A....//.so.that.breakpoints.can.be.
set.in.the.normal.sys.fuction#0A....//.without.inte
rferring.with.the.sys.calls.used.here#2E#0A....LET.
res.#3D.0#0A....LET.sysf.#3D.(rootnode!rtn_sys>>B2W
sh)-4#0A....LET.sysv.#3D.VEC.4.......//.The.vector.
to.hold.the.private.copy.sys#2E#0A.................
..........//.This.copy.will.work.on.big.and.little#0A
...........................//.ender.machines.runnin
g.using.either.32-#0A...........................//.
or.64-bit.Cintcode#2E#0A....//.Copy.the.standard.ve
rsion.of.sys.including.its.name#0A....//.into.priva
te.work.space#2E#0A....FOR.i.#3D.0.TO.4.DO.sysv!i.:
#3D.sysf!i#0A....//writef("sysf.#3D.%n*n",.sysf)#0A
....//FOR.i.#3D.0.TO.4.DO.writef("sysv!%n.#3D.%x8*n
",.i,.sysv!i)#0A....sys.:#3D.(sysv+4)<<B2Wsh.//.Upd
ate.the.sys.function.in.boot's.global#0A...........
................//.vector.to.point.to.this.private.
version#2E#0A#0A....//sysv%0.:#3D.#23x91......//.SY
S#0A....//sysv%1.:#3D.#23x7B......//.RTN#0A....//sy
s.:#3D.sysv<<B2Wsh..//.Update.the.sys.function.in.b
oot's.global#0A........................//.vector.to
.point.to.this.private.version#2E#0A#0A....IF.rootn
ode!rtn_boottrace.DO#0A....{.sawritef("boot:.about.
to.call.sys(Sys_interpret,#2E#2E#2E)*n")#0A....}#0A
#0A....IF.rootnode!rtn_boottrace>1.DO#0A....{.sawri
tef("boot:.after.turning.instruction.tracing.on*n")
#0A......sys(Sys_tracing,.TRUE)#0A....}#0A#0A....re
s.:#3D.sys(Sys_interpret,.regs)..//.Call.the.interp
reter#0A#0A....//.Save.cli_returncode.from.CLI.glob
al.vector.in.BOOT.global.vector#0A....cli_returncod
e.:#3D.g!gn_cli_returncode.//.MR.17/1/06#0A#0A....U
NLESS.res.DO.sys(Sys_quit,.0)..//.Exit.from.cintsys
.or.cintpos#0A....IF.res#3D-1.LOOP........//.Re-ent
er.the.interpreter.immediately#0A..................
........//.to.allow.a.different.interpreter.to#0A..
........................//.be.entered#2E#0A#0A....I
F.res#3D-2.DO..........//.Used.by.the.dumpmem.comma
nd.to#0A....{.sys(Sys_dumpmem,.4).//.dump.the.memor
y.(context#3D4).and#0A......LOOP................//.
re-enter.the.interpreter#2E#0A....}#0A....rootnode!
rtn_abortcode.:#3D.res#0A#0A....IF.rootnode!rtn_dum
pflag.DO#0A....{.rootnode!rtn_dumpflag.:#3D.FALSE./
/.To.stop.memory.being.dumped.twice#2E#0A......sys(
Sys_dumpmem,.5).//.Dump.the.memory.(context#3D5).an
d.quit#0A......//.Memory.has.been.dumped.so.just.le
ave.Cintpos#0A......sys(Sys_quit,.0)#0A....}#0A#0A.
...val.:#3D.regs!r_pc......//.Debug's.current.value
#0A#0A....IF.rootnode!rtn_boottrace>1.DO#0A....{.sy
s(Sys_tracing,.FALSE)#0A......sawritef("boot:.instr
uction.tracing.turned.off*n")#0A....}#0A#0A....UNLE
SS.sadebug(res).DO#0A....{.sawritef("Standalone.deb
ug.could.not.cope*n")#0A......sys(Sys_quit,.res)#0A
....}#0A#0A..}.REPEAT.//.to.re-enter.the.interprete
r#2E#0A}#0A#0AAND.startroot(fn,.size,.c).BE#0A{.//.
On.entry.the.base.of.the.stack.is.at.@fn-3,#0A..//.
and.the.P.pointer.is.set.to.this.value#2E#0A..//.Al
l.the.stack.elements.are.set.to.#23xABCD1234,.excep
t#0A..//.for.the.zeroth.word.which.holds.the.stacks
ize#2E#0A#0A..//.The.base.of.the.global.vector.is.a
t.@globsize.(#3DGlobal.0),#0A..//.all.its.elements.
are.filled.with.words.of.the.form#0A..//.globword+n
.(#3D#238F8F0000+n),.except.for.the.follow.few.crit
ical#0A..//.global.variables:#0A#0A..//.globsize..-
-.set.to.the.upper.bound#0A..//.sys.......--.set.to
.the.entry.point.of.the.function.sys#0A..//.rootnod
e..--.set.to.point.to.the.root.node.(typically.#3D.
100)#0A..//.currco....--.set.to.zero#0A..//.colist.
...--.set.to.zero#0A#0A..LET.stacksize.#3D.0#0A#0A.
.//.Make.the.stack.into.a.root.coroutine.stack#2E#0A
..currco.:#3D.@fn-3#0A..colist.:#3D.currco#0A#0A..s
tacksize........:#3D.currco!0#0A#0A..currco!co_pptr
...:#3D..0#0A..currco!co_parent.:#3D.-1..........//
.Mark.as.root.coroutine#0A..currco!co_list...:#3D..
0#0A..currco!co_fn.....:#3D..startroot..//.These.ar
e.the.same.locations.as.fn#0A..currco!co_size...:#3D
..stacksize..//.................................siz
e#0A..currco!co_c......:#3D..0..........//.........
....................and.c#0A#0A..rootcode()#0A}#0A#0A
AND.rootcode().BE#0A{#0A..crntcb.:#3D.0.//.Cintpos.
only.--.no.current.task.yet#0A#0A..//.Set.the.globa
ls.defined.in.blib,.syslib.and.dlib#0A..sys(Sys_glo
bin,.rootnode!rtn_blib)#0A...#0A..rootnode!rtn_keyb
oard.:#3D.0#0A..rootnode!rtn_screen...:#3D.0#0A..cu
rrentdir............:#3D.0#0A#0A..IF.rootnode!rtn_b
oottrace>1.DO#0A..{.sys(Sys_tracing,.FALSE)#0A....s
awritef("rootcode:.instruction.tracing.turned.off*n
")#0A..}#0A#0A..selectinput(findinput("**"))#0A..se
lectoutput(findoutput("**"))#0A#0A..//.We.can.now.d
o.normal.stream.IO.(using.rdch.and.wrch),#0A..//.fo
r.example:#0A..//writes("Hello*n")#0A#0A..IF.rootno
de!rtn_boottrace.DO#0A..{.sawritef("startroot:.can.
now.use.normal.stream.i/o*n")#0A....sawritef("start
root:.trying.to.load.syscin/cli*n")#0A..}#0A#0A#0A.
.UNLESS.globin(loadseg("syscin/cli")).DO#0A..{.sawr
itef("Unable.to.start.the.CLI#2E*n")#0A....sys(Sys_
quit,.0)#0A..}#0A#0A..IF.rootnode!rtn_boottrace.DO#0A
..{.sawritef("startroot:.loaded.syscin/cli.successf
ully*n")#0A....sawritef("startroot:.now.entering.th
e.cli*n")#0A..}#0A...#0A..start()..........//.Enter
.the.newly.loaded.CLI#0A..sys(Sys_quit,.0)#0A}#0A#0A
AND.sadebug(code).#3D.VALOF#0A//.Enter.standalone.d
ebug#0A//.Only.entered.as.a.result.of.the.interpret
er.encountering#0A//.a.fault#2E.The.Cintcode.regist
ers.in.regs.represent.the.state.at#0A//.that.moment
#2E#0A#0A{.IF.sawrch<0.DO.....//.Test.if.the.system
.is.sufficiently.initialised#0A....................
.//.to.run.standalone.debug#2E#0A..{.LET.mess.#3D."
Fault.occurred.before.the.system.was.initialised*n"
#0A....FOR.i.#3D.1.TO.mess%0.DO.sys(Sys_sawrch,.mes
s%i)#0A....sys(Sys_quit,.code)#0A....RESULTIS.FALSE
#0A..}#0A#0A..trapregs.:#3D.regs.//.Save.the.regist
er.set.at.time.of.entering.sadebug#0A..............
.....//.(In.Cintpos,.regs.changes.when.selecting.di
fferent#0A...................//.tasks)#0A..........
.........//.On.exit.from.sadebug.regs.must.equal.tr
apregs#2E#0A#0A..recp..:#3D.@code-3.<<.B2Wsh.//.lev
el().without.using.BLIB#2E#0A..recl..:#3D.recover#0A
..bpt...:#3D.-1#0A#0A..gptr..:#3D.regs!r_g.>>.B2Wsh
#0A..cptr..:#3D.gptr!g_currco#0A..pptr..:#3D.regs!r
_p.>>.B2Wsh#0A..fsize.:#3D.cptr.+.6.+.cptr!co_size#0A
..val...:#3D.regs!r_pc#0A#0A..IF.code#3D3.DO.......
...//.Zero.count#2E#0A..{.IF.brkstep.DO#0A....{.brk
step.:#3D.FALSE..//.Breakpoint.continuation#2E#0A..
....IF.oldcount>0.DO.oldcount.:#3D.oldcount-1#0A...
...trapregs!r_count.:#3D.oldcount#0A......GOTO.ret.
.........//.Restore.BRK.instructions.and.continue#2E
#0A....}#0A....IF.snglstep.DO#0A....{.snglstep.:#3D
.FALSE.//.Single.step#2E#0A......IF.oldcount>0.DO.o
ldcount.:#3D.oldcount-1#0A......trapregs!r_count.:#3D
.oldcount#0A......writes(".A#3D");.print(regs!r_a)#0A
......writes(".B#3D");.print(regs!r_b)#0A......prin
str(val)#0A......newline()#0A......GOTO.recover#0A.
...}#0A..}#0A#0A..FOR.i.#3D.0.TO.9.DO............//
.Remove.all.BRK.instructions#0A..{.LET.ba.#3D.bpt_a
ddr!i#0A....IF.ba~#3D0.&.0%ba#3Df_brk.DO.0%ba.:#3D.
bpt_instr!i#0A..}#0A#0A..IF.code#3D2.DO..//.BRK.ins
truction#0A....FOR.i.#3D.0.TO.9.IF.bpt_addr!i#3Dval
.DO#0A....{.bpt.:#3D.i#0A......writef("*n!!.BPT.%n:
..",.bpt)#0A......writearg(val)#0A......writes("*n.
..")#0A......writes(".A#3D");.print(regs!r_a)#0A...
...writes(".B#3D");.print(regs!r_b)#0A......prinstr
(val)#0A......newline()#0A......GOTO.recover#0A....
}#0A#0A..IF.code#3D10.DO.//.Cintasm.single.step#0A.
.{.writes(".A#3D");.print(regs!r_a)#0A....writes(".
B#3D");.print(regs!r_b)#0A....prinstr(val)#0A....ne
wline()#0A....GOTO.recover#0A..}#0A#0A..{.LET.gn.#3D
.regs!r_pc.-.globword#0A....LET.mess.#3D..VALOF.SWI
TCHON.code.INTO#0A................{.CASE...1:.RESUL
TIS."Illegal.instruction"#0A..................CASE.
..2:.RESULTIS."BRK.instruction"#0A.................
.CASE...3:.RESULTIS."Zero.count"#0A................
..CASE...4:.TEST.0<#3Dgn<#3Dgptr!0#0A..............
..............THEN.RESULTIS."G%n.unassigned"#0A....
........................ELSE.RESULTIS."Negative.pc"
#0A..................CASE...5:.RESULTIS."Division.b
y.zero"#0A..................CASE..10:.RESULTIS."Cin
tasm.single.step"#0A..................CASE..11:.RES
ULTIS."Watch.addr:.%+%i7.value:.%i8"#0A............
......CASE..12:.RESULTIS."Indirect.address.out.of.r
ange:.%+%+%+%n"#0A..................CASE..13:.RESUL
TIS."SIGINT.received"#0A..................CASE..99:
.RESULTIS."User.requested"#0A..................CASE
.110:.RESULTIS."Callco.fault"#0A..................C
ASE.111:.RESULTIS."Resumeco.fault"#0A..............
....CASE.112:.RESULTIS."Deleteco.fault"#0A.........
.........CASE.180:.RESULTIS."Unable.to.delete.a.tas
k"#0A..................CASE.181:.RESULTIS."Unable.t
o.send.a.packet"#0A..................CASE.182:.RESU
LTIS."Unexpected.pkt.received"#0A..................
CASE.186:.RESULTIS."Bad.input.stream"#0A...........
.......CASE.187:.RESULTIS."Bad.output.stream"#0A...
...............CASE.188:.RESULTIS."Unable.to.replen
ish.input"#0A..................CASE.189:.RESULTIS."
Wrch.fault"#0A..................CASE.190:.RESULTIS.
"Endread.fault"#0A..................CASE.191:.RESUL
TIS."Endwrite.fault"#0A..................CASE.197:.
RESULTIS."Store.chain.fault"#0A..................DE
FAULT:..RESULTIS."Unknown.fault"#0A................
}#0A....sawritef("*n!!.ABORT.%n:.",.code)#0A....saw
ritef(mess,.gn,.!1,.!2,.!3)#0A....sawrch('*n')#0A..
}#0A#0Arecover:#0A..ch.:#3D.'*n'#0Anxt:............
...........//.Main.loop.for.debug.commands#0A..IF.c
h#3D'*n'.DO.writes("**.")#0A..rch()#0Asw:#0A..SWITC
HON.ch.INTO#0A#0A..{.DEFAULT:.error()#0A#0A....CASE
.endstreamch:#0A....CASE.'Q':.sawritef("*n");.sys(S
ys_quit,.0)...//.Quit#0A.........#0A......#0A....CA
SE.'*s':#0A....CASE.'*t':#0A....CASE.'*n':.GOTO.nxt
#0A#0A....CASE.'?':#0A.......writes("*n?...........
.Print.list.of.debug.commands*n")#0A.......writes("
Gn.Pn.Rn.Vn................Variables*n")#0A.......w
rites("G..P..R..V.................Pointers*n")#0A..
.....writes("123.#23o377.#23FF03.'c.........Constan
ts*n")#0A.......writes("**e./e.%e.+e.-e.|e.&e......
.Dyadic.operators*n")#0A.......writes("!e..........
...............Subscription*n")#0A.......writes("<.
>........................Shift.left/right.one.place
*n")#0A.......writes("$b.$c.$d.$f.$o.$s.$u.$x....Se
t.the.print.style*n")#0A.......writes("SGn.SPn.SRn.
SVn.SAn........Store.in.variable*n")#0A.......write
s("#3D..........Print.current.value*n")#0A.......wr
ites("Tn.........Print.n.consecutive.locations*n")#0A
.......writes("I..........Print.current.instruction
*n")#0A.......writes("N..........Print.next.instruc
tion*n")#0A.......writes("D..........Dump.Cintcode.
memory.to.DUMP#2Emem*n")#0A.......writes("Q........
..Quit.--.leave.the.cintpos.system*n")#0A.......wri
tes("M..........Set/Reset.memory.watch.address*n")#0A
.......writes("B.0Bn.eBn..List,.Unset.or.Set.breakp
oints*n")#0A.......writes("X..(G4B9C).Set.breakpoin
t.9.at.start.of.clihook*n")#0A.......writes("Z..(P1
B9C).Set.breakpoint.9.at.return.of.current.function
*n")#0A.......writes("C..........Continue.normal.ex
ecution*n")#0A.......writes("\..........Single.step
.execute.one.Cintcode.instruction*n")#0A.......writ
es("#2E.;.[.]....Move.to.current/parent/first/next.
coroutine*n")#0A.......writes(",..........Move.down
.one.stack.frame*n")#0A.......GOTO.recover#0A#0A...
.CASE.'0':.CASE.'1':.CASE.'2':#0A....CASE.'3':.CASE
.'4':.CASE.'5':#0A....CASE.'6':.CASE.'7':.CASE.'8':
#0A....CASE.'9':.CASE.'#23':.CASE.'*'':#0A....CASE.
'G':.CASE.'P':.CASE.'R':#0A....CASE.'V':.CASE.'A':#0A
..............val.:#3D.rdval();.................GOT
O.sw#0A#0A....CASE.'!':.rch();.val.:#3D.cont(val..+
..rdval());..GOTO.sw#0A....CASE.'+':.rch();.val.:#3D
.val..+..rdval();........GOTO.sw#0A....CASE.'-':.rc
h();.val.:#3D.val..-..rdval();........GOTO.sw#0A...
.CASE.'**':rch();.val.:#3D.val..*..rdval();........
GOTO.sw#0A....CASE.'/':.rch();.{.LET.a.#3D.rdval()#0A
.......................UNLESS.a.DO.error()#0A......
.................val.:#3D.val./.a#0A...............
........GOTO.sw#0A.....................}#0A....CASE
.'%':.rch();.{.LET.a.#3D.rdval()#0A................
.......UNLESS.a.DO.error()#0A......................
.val.:#3D.val.REM.a#0A.......................GOTO.s
w#0A.....................}#0A....CASE.'|':.rch();.v
al.:#3D.val..|..rdval();..GOTO.sw#0A....CASE.'&':.r
ch();.val.:#3D.val..&..rdval();..GOTO.sw#0A#0A....C
ASE.'<':.val.:#3D.val.<<.1;................GOTO.nxt
#0A....CASE.'>':.val.:#3D.val.>>.1;................
GOTO.nxt#0A#0A....CASE.'#3D':.print(val);.newline()
;..........GOTO.recover#0A#0A....CASE.'S':.{.LET.ty
pe.#3D.rch()#0A................rch()#0A............
....!rdvaraddr(type).:#3D.val#0A................GOT
O.sw#0A..............}#0A#0A....CASE.'T':.rch()#0A.
...........{.LET.n.#3D.rdn()#0A..............LET.k.
#3D.bitsperword#3D32.->.5,.4#0A..............IF.n<#3D
0.DO.n.:#3D.1#0A..............FOR.i#3D0.TO.n-1.DO#0A
..............{.IF.i.REM.k.#3D.0.DO.praddr(val+i)#0A
................print(cont(val+i))#0A..............
}#0A..............newline()#0A..............GOTO.sw
#0A............}#0A#0A....CASE.'$':.rch()#0A.......
.......UNLESS.ch#3D'B'.|.ch#3D'C'.|.ch#3D'D'.|.ch#3D
'F'.|#0A.....................ch#3D'O'.|.ch#3D'S'.|.
ch#3D'U'.|.ch#3D'X'.DO#0A..............{.writef("Va
lid.style.letters.are:.BCDFOSUX*n")#0A.............
...GOTO.nxt#0A..............}#0A..............style
.:#3D.ch#0A..............GOTO.nxt#0A#0A....CASE.'D'
:.writef("*nCintcode.memory.dumped.to.DUMP#2Emem*n"
)#0A..............sys(Sys_dumpmem,.6).//.Dump.the.m
emory.(context#3D6)#0A..............GOTO.recover#0A
#0A....CASE.'N':.val.:#3D.nextpc(val)#0A....CASE.'I
':.prinstr(val);.newline();.GOTO.recover#0A#0A....C
ASE.'X':..//.Equivalent.to.G4B9C#0A.........val.:#3D
.gptr!4..//.set.breakpoint.9.at.clihook.and.resume#0A
.........GOTO.caseb#0A#0A....CASE.'Z':..//.Equivale
nt.to.P1B9C#0A.........val.:#3D.pptr!1..//.set.brea
kpoint.9.to.current.return.address.and.resume#0A#0A
....caseb:#0A....CASE.'B':..//.Set,.clear.or.displa
y.breakpoints#2E#0A.....{.LET.comch.#3D.ch#0A......
.TEST.comch#3D'B'.THEN.rch().......//.For.B#0A.....
.................ELSE.ch.:#3D.'9'...//.For.X.or.Z#0A
.......IF.'0'<#3Dch<#3D'9'.DO#0A.......{.LET.n.#3D.
ch.-.'0'..//.Set.or.Clear.a.break.point#2E#0A......
...bpt_addr!n.:#3D.0#0A.........IF.val#3D0.GOTO.nxt
#0A.........checkaddr(val>>B2Wsh)#0A.........FOR.i.
#3D.0.TO.9.IF.bpt_addr!i#3Dval.DO.bpt_addr!i.:#3D.0
#0A.........bpt_addr!n,.bpt_instr!n.:#3D.val,.0%val
#0A.........GOTO.comch#3D'B'.->.nxt,.resume#0A.....
..}#0A.......UNLESS.ch#3D'*n'.DO.newline()#0A......
.FOR.i.#3D.0.TO.9.DO..//.List.all.breakpoints#2E#0A
.......{.LET.ba#3Dbpt_addr!i#0A.........UNLESS.ba#3D
0.DO#0A.........{.writef("%n:..",.i)#0A...........w
ritearg(ba)#0A...........newline()#0A.........}#0A.
......}#0A.......GOTO.recover#0A.....}#0A#0A....CAS
E.'M':..//.Set.or.clear.memory.watch.address#0A....
...........checkaddr(val)#0A...............TEST.val
.THEN.writef("*nWatch.address:.%n*n",.val)#0A......
..................ELSE.writef("*nWatch.unset*n")#0A
...............sys(Sys_watch,.val)#0A..............
.GOTO.recover#0A#0Aresume:#0A....CASE.'C':.//.Conti
nue.Cintcode.execution#2E#0A.............{.LET.pc.#3D
.trapregs!r_pc#0A...............newline()#0A.......
........FOR.i.#3D.0.TO.9.IF.pc#3Dbpt_addr!i.DO#0A..
.............{.//.We.are.resuming.at.a.break.point#0A
.................oldcount.:#3D.trapregs!r_count#0A.
................trapregs!r_count.:#3D.1.//.Set.it.u
p.to.execute.just#0A.................brkstep.:#3D.T
RUE...//.one.instruction#0A.................GOTO.re
tstep#0A...............}#0A...............GOTO.ret.
.//.Resume.execution#2E#0A.............}#0A#0A....C
ASE.'\':.oldcount.:#3D.trapregs!r_count.//.Single.s
tep.execution#2E#0A..............trapregs!r_count.:
#3D.1#0A..............snglstep.:#3D.TRUE#0A........
......GOTO.retstep#0A#0A....CASE.',':..//.Move.down
.one.stack.frame.and.output.it#2E#0A.............{.
LET.a.#3D.pptr!0>>B2Wsh#0A...............IF.pptr#3D
cptr.DO.{.writef(".Base.of.stack*n")#0A............
.....................GOTO.recover#0A...............
................}#0A...............fsize.:#3D.pptr-
a#0A...............pptr.:#3D.a#0A...............wrf
rame()#0A...............GOTO.recover#0A............
.}#0A#0A....CASE.';':.IF.cptr.DO#0A..............{.
LET.c.#3D.cont(cptr+co_parent)#0A................IF
.c<#3D0.DO#0A................{.writef(".A.root.coro
utine.has.no.parent*n")#0A..................GOTO.re
cover#0A................}#0A................cptr.:#3D
.c#0A..............}#0A..............GOTO.newc#0A#0A
....CASE.'#2E':.cptr.:#3D.cont(gptr+g_currco)#0A...
...........GOTO.newc#0A#0A....CASE.']':.cptr.:#3D.c
ont(cptr+co_list)#0A..............IF.cptr#3D0.DO.{.
writef(".End.of.coroutine.list*n")#0A..............
...............GOTO.recover#0A.....................
......}#0A..............GOTO.newc#0A#0A....CASE.'['
:.cptr.:#3D.cont(gptr+g_colist)#0A#0Anewc:.........
UNLESS.cptr.DO#0A..............{.writef("No.such.co
routine*n")#0A................GOTO.recover#0A......
........}#0A..............TEST.cptr#3Dcont(gptr+g_c
urrco)#0A..............THEN.pptr.:#3D.regs!r_p>>B2W
sh#0A..............ELSE.pptr.:#3D.cont(cptr+co_pptr
)>>B2Wsh#0A..............fsize.:#3D.cptr.+.6.+.cptr
!co_size.-.pptr#0A..............wrcortn()#0A.......
.......GOTO.recover#0A#0A..}#0A#0Aret:#0A..//.Set.B
RK.instructions.at.the.breakpoint.and.resume#2E#0A.
.FOR.i.#3D.0.TO.9.DO.{.LET.ba#3Dbpt_addr!i.//.Set.a
ll.breakpoints#2E#0A......................IF.ba.DO.
0%ba.:#3D.f_brk#0A....................}#0Aretstep:#0A
..//.Resume.execution.without.setting.BRK.instructi
ons.at.the.breakpoints#2E#0A..//.This.is.used.by.th
e.'\'.command.and.when.resuming.from.a.breakpoint#2E
#0A#0A..//.Must.ensure.that.regs.is.restored.to.its
.original.value#2E#0A..regs.:#3D.trapregs#0A#0A//sa
writef("sadebug:.retstep.reached*n")#0A//..rtn_insa
debug!rootnode.:#3D.FALSE#0A..RESULTIS.TRUE..//.Suc
cessful.return.from.sadebug#0A}#0A#0AAND.prprompt()
.BE#0A{.#0A..writef("**.")..//.Standalone.prompt#0A
}#0A#0AAND.wrcortn().BE#0A{.LET.size.#3D.cont(cptr+
co_size)#0A..LET.hwm.#3D.size+6#0A..writef(".%i7:."
,.cptr)#0A..writes("..Coroutine:")#0A..writearg(con
t(cptr+co_fn))#0A..writef("..Parent.%n",.cptr!co_pa
rent)#0A..WHILE.cont(cptr+hwm)#3Dstackword.DO.hwm:#3D
hwm-1#0A..writef("..Stack.%n/%n*n",.hwm-6,.size)#0A
..prprompt()#0A..wrch('.')#0A..wrframe()#0A}#0A#0AA
ND.wrframe().BE#0A{.writef("%i8:",.pptr)#0A..TEST.p
ptr#3Dcptr#0A..THEN.writef("..#23StackBase#23")#0A.
.ELSE.writearg(pptr!2)#0A..FOR.i#3D3.TO.6.UNLESS.i>
#3Dfsize.DO.print(cont(pptr+i))#0A..newline()#0A..I
F.fsize>7.DO#0A..{.prprompt()#0A....writef(".......
...")#0A....FOR.i.#3D.7.TO.11.UNLESS.i>#3Dfsize.DO.
print(cont(pptr+i))#0A....newline()#0A..}#0A..IF.fs
ize>11.DO#0A..{.prprompt()#0A....writef("..........
")#0A....FOR.i.#3D.11.TO.15.UNLESS.i>#3Dfsize.DO.pr
int(cont(pptr+i))#0A....newline()#0A..}#0A}#0A#0AAN
D.writearg(n).BE#0A{.LET.name.#3D.fname(n)#0A..TEST
.bitsperword#3D32#0A..THEN.//.Write.value.in.a.fiel
d.width.of.21#0A.......TEST.name#0A.......THEN.{.LE
T.len.#3D.name%0#0A..............WHILE.len>0.&.name
%len#3D'.'.DO.len.:#3D.len-1#0A..............FOR.i.
#3D.len+1.TO.13.DO.wrch('.')#0A..............FOR.i.
#3D.1.TO.len.DO.wrch(name%i)..//.MR.17/11/06#0A....
........}#0A.......ELSE.TEST.globword<#3Dn<#3Dglobw
ord+gptr!0#0A............THEN.writef(".......#23G%z
3#23",.n-globword)#0A............ELSE.TEST.-1000000
0<#3Dn<#3D10000000#0A.................THEN.writef("
..%iB",.n)#0A.................ELSE.writef("...#23x%
x8",.n)#0A..ELSE.//.Write.value.in.a.field.width.of
.21#0A.......TEST.name#0A.......THEN.{.LET.len.#3D.
name%0#0A..............WHILE.len>0.&.name%len#3D'.'
.DO.len.:#3D.len-1#0A..............FOR.i.#3D.len+1.
TO.21.DO.wrch('.')#0A..............FOR.i.#3D.1.TO.l
en.DO.wrch(name%i)..//.MR.17/11/06#0A............}#0A
.......ELSE.TEST.globword<#3Dn<#3Dglobword+gptr!0#0A
............THEN.writef("...............#23G%z3#23"
,.n-globword)#0A............ELSE.TEST.-10000000<#3D
n<#3D10000000#0A.................THEN.writef("..%iJ
",.n)#0A.................ELSE.writef("...#23x%xG",.
n)#0A}#0A#0AAND.fname(f).#3D.VALOF#0A{.LET.nameoffs
et.#3D.bitsperword#3D32.->.3,.2#0A..LET.n.#3D.(f>>B
2Wsh).-.nameoffset#0A..UNLESS.(f&(bytesperword-1))#3D
0.&#0A.........membase+2<n<#3Dmemlim.RESULTIS.0.//.
MR.25/9/03#0A..IF.n!-1#3Dentryword.&.n%0#3D11.RESUL
TIS.n.#0A..RESULTIS.0#0A}#0A#0AAND.rdn().#3D.VALOF#0A
{.LET.res.#3D.0#0A..WHILE.'0'<#3Dch<#3D'9'.DO.{.res
.:#3D.res*10.+.ch.-.'0';.rch().}#0A..RESULTIS.res#0A
}#0A#0AAND.rdvaraddr(type).#3D.VALOF#0A{.LET.base,.
lim,.n.#3D.?,.?,.?#0A..UNLESS.'0'<#3Dch<#3D'9'.DO.e
rror()#0A..n.:#3D.rdn()#0A..SWITCHON.type.INTO#0A..
{.DEFAULT:...error()#0A....CASE.'P':.base,.lim.:#3D
.pptr,...fsize;...........ENDCASE#0A....CASE.'G':.b
ase,.lim.:#3D.gptr,...gptr!g_globsize;.ENDCASE#0A..
..CASE.'R':.base,.lim.:#3D.regs,...r_upb;..........
.ENDCASE#0A....CASE.'V':.base,.lim.:#3D.vars,...9;.
..............ENDCASE#0A..//CASE.'W':.base,.lim.:#3D
.crntcb,.tcb_upb;.........ENDCASE#0A....CASE.'A':.b
ase,.lim.:#3D.0,......memlim;..........ENDCASE#0A..
}#0A..UNLESS.0<#3Dn<#3Dlim.DO.error()#0A..RESULTIS.
base.+.n#0A}#0A#0AAND.rdval().#3D.VALOF#0A{.LET.res
,.radix.#3D.0,.10#0A#0A..SWITCHON.ch.INTO#0A..{.DEF
AULT:...error()#0A#0A....CASE.'G':..rch()#0A.......
........IF.'0'<#3Dch<#3D'9'.RESULTIS.!rdvaraddr('G'
)#0A...............RESULTIS.gptr#0A#0A....CASE.'P':
..rch()#0A...............IF.'0'<#3Dch<#3D'9'.RESULT
IS.!rdvaraddr('P')#0A...............RESULTIS.pptr#0A
#0A....CASE.'R':..rch()#0A...............IF.'0'<#3D
ch<#3D'9'.RESULTIS.!rdvaraddr('R')#0A..............
.RESULTIS.regs#0A#0A....CASE.'V':..rch()#0A........
.......IF.'0'<#3Dch<#3D'9'.RESULTIS.!rdvaraddr('V')
#0A...............RESULTIS.vars#0A#0A....CASE.'A':.
.rch()#0A...............IF.'0'<#3Dch<#3D'9'.RESULTI
S.!rdvaraddr('A')#0A...............RESULTIS.0#0A#0A
....CASE.'*'':.rch();.res.:#3D.lch;.rch();..RESULTI
S.res#0A#0A....CASE.'#23':..radix.:#3D.16#0A.......
........rch()#0A...............IF.ch#3D'O'.DO.{.rad
ix.:#3D.8;.rch().}#0A#0A....CASE.'0':.CASE.'1':.CAS
E.'2':.CASE.'3':.CASE.'4':.#0A....CASE.'5':.CASE.'6
':.CASE.'7':.CASE.'8':.CASE.'9':.#0A...............
{.LET.d.#3D.100#0A.................IF.'0'<#3Dch<#3D
'9'.DO.d.:#3D.ch-'0'#0A.................IF.'A'<#3Dc
h<#3D'F'.DO.d.:#3D.ch-'A'+10#0A.................IF.
d>#3Dradix.RESULTIS.res#0A.................res.:#3D
.res*radix+d#0A.................rch()#0A...........
....}.REPEAT#0A..}#0A}#0A#0AAND.praddr(a).BE#0A{.LE
T.type,.base.#3D.'A',.0#0A..IF.pptr.<#3D.a.<#3D.ppt
r+fsize...........DO.type,.base.:#3D.'P',.pptr#0A..
IF.gptr.<#3D.a.<#3D.gptr+gptr!g_globsize.DO.type,.b
ase.:#3D.'G',.gptr#0A..IF.vars.<#3D.a.<#3D.vars+9..
.............DO.type,.base.:#3D.'V',.vars#0A..IF.re
gs.<#3D.a.<#3D.regs+r_upb...........DO.type,.base.:
#3D.'R',.regs#0A..writef("*n%c%i5:",.type,.a-base)#0A
}#0A#0AAND.print(n).BE#0ATEST.bitsperword#3D32#0ATH
EN.//.Write.value.in.given.style.in.a.field.width.o
f.13#0A.....SWITCHON.style.INTO#0A.....{.DEFAULT:..
.error();.................RETURN#0A.......CASE.'C':
..{.LET.p.#3D.@n#0A....................writes("....
.....")#0A....................FOR.i.#3D.0.TO.3.DO#0A
....................{.LET.ch.#3D.p%i#0A............
..........wrch(32<#3Dch<#3D127.->.ch,.'#2E')#0A....
................}#0A....................RETURN#0A..
................}#0A.......CASE.'B':..writef(."..%b
W",.n);.....RETURN#0A.......CASE.'D':..writef(."..%
IB",.n);.....RETURN#0A.......CASE.'F':..writearg(n)
;.............RETURN#0A.......CASE.'O':..writef(.".
.%OB",.n);.....RETURN#0A.......CASE.'S':..checkaddr
(n)#0A..................writef(."..%S",..n);.....RE
TURN#0A.......CASE.'U':..writef(."..%UB",.n);.....R
ETURN#0A.......CASE.'X':..writef(.".....%X8",.n);..
...RETURN#0A.....}#0AELSE.//.Write.value.in.given.s
tyle.in.a.field.width.of.21#0A.....SWITCHON.style.I
NTO#0A.....{.DEFAULT:...error();.................RE
TURN#0A.......CASE.'C':..{.LET.p.#3D.@n#0A.........
...........writes(".")#0A....................FOR.i.
#3D.0.TO.3.DO#0A....................{.LET.ch.#3D.p%
i#0A......................wrch(32<#3Dch<#3D127.->.c
h,.'#2E')#0A....................}#0A...............
.....RETURN#0A..................}#0A.......CASE.'B'
:..writef(.".%bW.",.n);.....RETURN#0A.......CASE.'D
':..writef(.".%IA.",.n);.....RETURN#0A.......CASE.'
F':..writearg(n);.............RETURN#0A.......CASE.
'O':..writef(.".%OB.",.n);.....RETURN#0A.......CASE
.'S':..checkaddr(n)#0A..................writef(.".%
S.",..n);.....RETURN#0A.......CASE.'U':..writef(.".
%UA.",.n);.....RETURN#0A.......CASE.'X':..writef(."
.%X8.",.n);.....RETURN#0A.....}#0A#0AAND.checkaddr(
a).#3D.VALOF#0A{.UNLESS.membase<#3Da<#3Dmemlim.DO.e
rror()#0A..RESULTIS.a#0A}#0A#0AAND.cont(a).#3D.!che
ckaddr(a)#0A#0AAND.error().BE.{.writes("..??*n");.l
ongjump(recp,.recl).}#0A#0AAND.wrfcode(f).BE#0A{.LE
T.s.#3D.VALOF.SWITCHON.f&31.INTO#0A..{.DEFAULT:#0A.
...CASE..0:.RESULTIS.".....-.....K...LLP.....L....L
P....SP....AP.....A"#0A....CASE..1:.RESULTIS.".....
-....KH..LLPH....LH...LPH...SPH...APH....AH"#0A....
CASE..2:.RESULTIS."...BRK....KW..LLPW....LW...LPW..
.SPW...APW....AW"#0A....CASE..3:.RESULTIS."....K3..
.K3G..K3G1..K3GH...LP3...SP3...AP3..L0P3"#0A....CAS
E..4:.RESULTIS."....K4...K4G..K4G1..K4GH...LP4...SP
4...AP4..L0P4"#0A....CASE..5:.RESULTIS."....K5...K5
G..K5G1..K5GH...LP5...SP5...AP5..L0P5"#0A....CASE..
6:.RESULTIS."....K6...K6G..K6G1..K6GH...LP6...SP6..
.AP6..L0P6"#0A....CASE..7:.RESULTIS."....K7...K7G..
K7G1..K7GH...LP7...SP7...AP7..L0P7"#0A....CASE..8:.
RESULTIS."....K8...K8G..K8G1..K8GH...LP8...SP8...AP
8..L0P8"#0A....CASE..9:.RESULTIS."....K9...K9G..K9G
1..K9GH...LP9...SP9...AP9..L0P9"#0A....CASE.10:.RES
ULTIS."...K10..K10G.K10G1.K10GH..LP10..SP10..AP10.L
0P10"#0A....CASE.11:.RESULTIS."...K11..K11G.K11G1.K
11GH..LP11..SP11..AP11.L0P11"#0A....CASE.12:.RESULT
IS."....LF...S0G..S0G1..S0GH..LP12..SP12..AP12.L0P1
2"#0A....CASE.13:.RESULTIS."...LF$...L0G..L0G1..L0G
H..LP13..SP13.XPBYT.....S"#0A....CASE.14:.RESULTIS.
"....LM...L1G..L1G1..L1GH..LP14..SP14...LMH....SH"#0A
....CASE.15:.RESULTIS."...LM1...L2G..L2G1..L2GH..LP
15..SP15...BTC..MDIV"#0A....CASE.16:.RESULTIS."....
L0....LG...LG1...LGH..LP16..SP16...NOP.CHGCO"#0A...
.CASE.17:.RESULTIS."....L1....SG...SG1...SGH...SYS.
...S1....A1...NEG"#0A....CASE.18:.RESULTIS."....L2.
..LLG..LLG1..LLGH...SWB....S2....A2...NOT"#0A....CA
SE.19:.RESULTIS."....L3....AG...AG1...AGH...SWL....
S3....A3..L1P3"#0A....CASE.20:.RESULTIS."....L4...M
UL...ADD....RV....ST....S4....A4..L1P4"#0A....CASE.
21:.RESULTIS."....L5...DIV...SUB...RV1...ST1...XCH.
...A5..L1P5"#0A....CASE.22:.RESULTIS."....L6...REM.
..LSH...RV2...ST2..GBYT..RVP3..L1P6"#0A....CASE.23:
.RESULTIS."....L7...XOR...RSH...RV3...ST3..PBYT..RV
P4..L2P3"#0A....CASE.24:.RESULTIS."....L8....SL...A
ND...RV4..STP3...ATC..RVP5..L2P4"#0A....CASE.25:.RE
SULTIS."....L9...SL$....OR...RV5..STP4...ATB..RVP6.
.L2P5"#0A....CASE.26:.RESULTIS."...L10....LL...LLL.
..RV6..STP5.....J..RVP7..L3P3"#0A....CASE.27:.RESUL
TIS."..FHOP...LL$..LLL$...RTN..GOTO....J$.ST0P3..L3
P4"#0A....CASE.28:.RESULTIS."...JEQ...JNE...JLS...J
GR...JLE...JGE.ST0P4..L4P3"#0A....CASE.29:.RESULTIS
."..JEQ$..JNE$..JLS$..JGR$..JLE$..JGE$.ST1P3..L4P4"
#0A....CASE.30:.RESULTIS."..JEQ0..JNE0..JLS0..JGR0.
.JLE0..JGE0.ST1P4.....-"#0A....CASE.31:.RESULTIS.".
JEQ0$.JNE0$.JLS0$.JGR0$.JLE0$.JGE0$....MW.....-"#0A
..}#0A..LET.n.#3D.f>>5.&.7#0A..FOR.i.#3D.6*n+1.TO.6
*(n+1).DO.wrch(s%i)#0A}#0A#0AAND.prinstr(pc).BE#0A{
.LET.a.#3D.0#0A..writef(".%i7:.",.pc)#0A..checkaddr
(pc>>B2Wsh)#0A..wrfcode(0%pc)#0A..SWITCHON.instrtyp
e(0%pc).INTO#0A..{.DEFAULT:#0A....CASE.'0':........
..............................RETURN#0A....CASE.'1'
:.a..:#3D.gb(pc+1);......................ENDCASE#0A
....CASE.'2':.a..:#3D.gh(pc+1);....................
..ENDCASE#0A....CASE.'4':.a..:#3D.gw(pc+1);........
..............ENDCASE#0A....CASE.'R':.a..:#3D.pc+1.
+.gsb(pc+1);..............ENDCASE#0A....CASE.'I':.p
c.:#3D.pc+1.+.2*gb(pc+1).&.#23xFFFFFFFE#0A.........
.....a..:#3D.pc.+.gsh(pc);..................ENDCASE
#0A..}#0A..writef("..%n",.a)#0A..vars!9.:#3D.a#0A}#0A
#0AAND.gb(pc).#3D.0%pc#0A#0AAND.gsb(pc).#3D.0%pc<#3D
127.->.0%pc,.0%pc-256#0A#0AAND.gsh(pc).#3D.VALOF#0A
{.LET.h.#3D.gh(pc)#0A..RESULTIS.h<#3D#23x7FFF.->.h,
.h.-.#23x10000#0A}#0A#0AAND.gh(pc).#3D.VALOF#0A{.LE
T.w.#3D.?#0A..LET.p.#3D.@w..//.Designed.to.work.on.
both.Big.and.Little.Ender.M/Cs#2E#0A..p%0,.p%1,.p%2
,.p%3.:#3D.0%pc,.0%(pc+1),.0%pc,.0%(pc+1)#0A..RESUL
TIS.w.&.#23xFFFF#0A}#0A#0AAND.gw(pc).#3D.VALOF#0A{.
LET.w.#3D.?#0A..LET.p.#3D.@w..//.Designed.to.work.o
n.both.Big.and.Little.Ender.M/Cs#2E#0A..p%0,.p%1,.p
%2,.p%3.:#3D.0%pc,.0%(pc+1),.0%(pc+2),.0%(pc+3)#0A.
.RESULTIS.w#0A}#0A#0AAND.instrtype(f).#3D."?0000000
000RI10000000000000RIRI*#0A..................*12411
1111111111111110000RIRIRIRI*#0A..................*1
2411111111111111111000000RIRIRI*#0A................
..*1242222222222222222200000000RIRI*#0A............
......*124000000000000000BL00000000RIRI*#0A........
..........*12400000000000000000000000RIRIRI*#0A....
..............*1240000000000?2?0000000000000004*#0A
..................*124000000000012?00000000000000??
"%f#0A#0AAND.nextpc(pc).#3D.VALOF.SWITCHON.instrtyp
e(0%pc).INTO#0A.......................{.DEFAULT:#0A
.........................CASE.'0':.RESULTIS.pc+1#0A
.........................CASE.'1':#0A..............
...........CASE.'R':#0A.........................CAS
E.'I':.RESULTIS.pc+2#0A.........................CAS
E.'2':.RESULTIS.pc+3#0A.........................CAS
E.'4':.RESULTIS.pc+5#0A.........................CAS
E.'B':.pc.:#3D.pc+2.&.#23xFFFFFFFE#0A..............
.....................RESULTIS.pc.+.4*gh(pc).+.6#0A.
........................CASE.'L':.pc.:#3D.pc+2.&.#23
xFFFFFFFE#0A...................................RESU
LTIS.pc.+.2*gh(pc).+.6#0A.......................}#0A
#0AAND.rch().BE.{.lch.:#3D.rdch();.ch.:#3D.capitalc
h(lch).}#0A#0A

######cintcode/sysb/cli.b#
//.(c).Copyright.M#2E.Richards,.23.April.2010#0A#0A
/*.Change.log#0A#0A23/04/10#0AChanged.to.new.datsta
mp.format#2E#0A#0A27/06/07#0AAdded.setseed(12345).s
ince.the.random.number.seed.is.now.a.global#0Avaria
ble.(not.a.static)#2E#0A#0A17/01/06#0AAs.suggested.
by.Dave.Lewis,.ignore.commands.starting.with.a.#23#2E
.This#0Aenables.executable.Unix.command.scripts.usi
ng.text.like:#0A#23!/usr/local/bin/cintsys.-s#0Aas.
the.first.line.of.the.script.file#2E#0A21/5/2001#0A
Changed.manifest.cli_initialstack.to.50000.in.CLIHD
R.(previously.5000)#0A*/#0A#0ASECTION."CLI"#0A#0AGE
T."libhdr"#0AGET."clihdr"#0A#0AMANIFEST#0A{.namemax
...#3D.25#0A..promptmax.#3D.15#0A..filemax...#3D.10
#0A}#0A#0ALET.start(parm_pkt).BE.//.parm_pkt.only.u
sed.in.Cintpos#0A{.LET.prompt......#3D.VEC.promptma
x#0A..LET.commandname.#3D.VEC.namemax#0A..LET.comma
ndfile.#3D.VEC.filemax..//.Command-command.file.nam
e,.if.in.use#0A..LET.globbase....#3D.@globsize..../
/.globsize.is.global.0#0A..LET.initprompt.#3D."%5#2E
3d>."#0A..//LET.initprompt.#3D."%5#2E3d.%+%2i:%2z:%
2z#2E%3z>.".//.Useful.for.debugging#0A..LET.datavec
.....#3D.VEC.10.......//.Used.as.private.data.by.so
me.CLIs#0A.................................//.tcpcl
i.uses.it.to.hold.the.TCP#0A.......................
..........//.stream.name#2E#0A..FOR.i.#3D.0.TO.10.D
O.datavec!i.:#3D.0#0A...#0A//..cli_data........:#3D
.datavec.......//.MR.10/7/03#0A//..cli_status......
:#3D.0.............//.MR.10/7/03#0A..cli_prompt....
..:#3D.prompt#0A..cli_commandname.:#3D.commandname#0A
..cli_commandfile.:#3D.commandfile#0A#0A..FOR.i.#3D
.0.TO.initprompt%0.DO#0A.......cli_prompt%i.:#3D.in
itprompt%i#0A#0A..cli_standardinput.:#3D.input()#0A
..cli_currentinput.:#3D.cli_standardinput#0A..cli_s
tandardoutput.:#3D.output()#0A..cli_commandname%0.:
#3D.0#0A..cli_commandfile%0.:#3D.0#0A..cli_defaults
tack.:#3D.cli_initialstack#0A..cli_returncode.:#3D.
0#0A..cli_result2.:#3D.0#0A..cli_module.:#3D.0#0A..
cli_preloadlist.:#3D.0#0A..cli_tallyflag.:#3D.FALSE
#0A..cli_faillevel.:#3D.cli_initialfaillevel#0A#0A.
.setseed(12345).//.MR.27/6/07#0A#0A..IF.rootnode!rt
n_boottrace.DO#0A....sawritef("cli:.now.entering.th
e.main.CLI.loop*n")#0A#0A..{.LET.ch,.item.#3D.'*n',
.?#0A....LET.cpumsecs.#3D.0#0A#0A....{.//.Start.of.
main.command.loop#0A......cli_interactive.:#3D..cli
_currentinput#3Dcli_standardinput#0A#0A......//.Pos
sibly.output.the.prompt#0A......IF.ch#3D'*n'.&.cli_
currentinput#3Dcli_standardinput.DO#0A......{.LET.h
ours,.mins,.secs.#3D.0,.0,.0#0A........LET.days,.ms
ecs.#3D.0,.0.#0A........datstamp(@days)#0A........s
ecs..:#3D.msecs/1000#0A........msecs.:#3D.msecs.MOD
.1000#0A........mins..:#3D.secs../..60#0A........ho
urs.:#3D.mins../..60#0A........mins..:#3D.mins.REM.
60#0A........secs..:#3D.secs.REM.60#0A#0A........wr
itef(cli_prompt,#0A...............cpumsecs,.//.msec
s.used.by.last.command#0A...............0,......../
/.The.task.number,.if.running.under.Cintpos#0A.....
..........hours,.mins,.secs,.msecs).//.The.time.of.
day#0A........deplete(cos)#0A......}#0A#0A......ite
m.:#3D.rditem(cli_commandname,.namemax)#0A#0A......
SWITCHON.item.INTO#0A......{.CASE.0:.//.The.item.wa
s:.eof#0A................IF.cli_currentinput#3Dcli_
standardinput.DO.sys(Sys_quit,.0)#0A...............
.BREAK#0A#0A........CASE.1:.//.The.item.was:.unquot
ed.name#0A........CASE.2:.//.The.item.was:.quoted.n
ame#0A..............{.LET.p,.coptr.#3D.cli_preloadl
ist,.0#0A#0A................//.If.the.command.name.
is.#23.or.starts.with.a.#23,#0A................//.t
reat.the.command.as.a.comment,#0A................//
.ie.skip.to.just.before.EOL,.;,.or.EOF#2E#0A.......
.........IF.cli_commandname%0.>.0.&.cli_commandname
%1.#3D.'#23'.DO#0A................{.LET.ch.#3D.?#0A
..................ch.:#3D.rdch().REPEATUNTIL.ch#3D'
*n'.|.ch#3D';'.|.ch#3Dendstreamch#0A...............
...IF.ch#3D'*n'.|.ch#3D';'.DO.unrdch()#0A..........
........LOOP#0A................}#0A.#0A............
....WHILE.p.DO............//.Search.in.preloadlist#2E
#0A................{.IF.compstring(cli_commandname,
.@p!2)#3D0.DO#0A..................{.cli_module.:#3D
.p!1#0A....................BREAK.............//.Mod
ule.found#2E#0A..................}#0A..............
....p.:#3D.!p#0A................}#0A...............
.IF.cli_module#3D0.DO#0A..................cli_modul
e.:#3D.loadseg(cli_commandname)#0A#0A..............
..start.:#3D.globword+1.//.Unset.start#0A..........
......UNLESS.globin(cli_module)#3D0.DO#0A..........
........coptr.:#3D.createco(clihook,.cli_defaultsta
ck)#0A................TEST.coptr#3D0#0A............
....THEN.{.cli_result2.:#3D.result2#0A.............
..........writef("Can't.load.%s*n",.cli_commandname
)#0A.....................}#0A................ELSE.{
.cpumsecs.:#3D.sys(Sys_cputime)#0A.................
......IF.cli_tallyflag.DO#0A.......................
{.cli_tallyflag.:#3D.FALSE#0A......................
...sys(Sys_tally,.TRUE)...//.Turn.on.tallying#0A...
....................}#0A#0A......................./
/.Transfer.control.to.the.command,#0A..............
.........//.and.save.the.return.code#2E#0A.........
..............cli_returncode.:#3D.callco(coptr,.0)#0A
#0A.......................sys(Sys_tally,.FALSE)....
//.Turn.off.tallying#0A.......................cli_r
esult2.:#3D.result2#0A#0A.......................cpu
msecs.:#3D.sys(Sys_cputime).-.cpumsecs#0A#0A.......
................//.Unset.user.globals#0A...........
............FOR.i.#3D.ug.TO.globsize.DO#0A.........
...................globbase!i.:#3D.globword.+.i#0A#0A
.......................//.Restore.the.library.globa
ls#0A.......................globin(rootnode!rtn_bli
b)#0A.......................//globin(rootnode!rtn_c
li)#0A#0A.......................deleteco(coptr)#0A.
......................selectinput.(cli_currentinput
)#0A.......................selectoutput(cli_standar
doutput)#0A#0A.......................UNLESS.cli_ret
urncode.<.cli_faillevel.DO#0A......................
...writef("%s.failed.returncode.%n*n",#0A..........
.......................cli_commandname,.cli_returnc
ode)#0A.....................}#0A#0A................
IF.p#3D0.&.cli_module.DO.unloadseg(cli_module)#0A..
..............cli_module.:#3D.0#0A..............}#0A
#0A........CASE.3:.//.The.item.was:.'*n'#0A........
CASE.4:.//.The.item.was:.';'#0A................ENDC
ASE#0A#0A........DEFAULT://.Unknown.item#2E.#0A....
............writes("Error.in.command.name*n")#0A...
...}#0A#0A......ch.:#3D.'*n'#0A......IF.unrdch().DO
.ch.:#3D.rdch()#0A......//.Skip.to.end.of.line.unle
ss.last.command.terminated.by.nl.or.;#0A......UNTIL
.ch#3D'*n'.|.ch#3D';'.|.ch#3Dendstreamch.DO.ch.:#3D
.rdch()#0A#0A......IF.intflag().DO.{.writes("****BR
EAK.-.CLI*N")#0A........................BREAK#0A...
...................}#0A....}.REPEAT#0A#0A....UNLESS
.cli_currentinput#3Dcli_standardinput.DO#0A....{.//
.If.we.were.within.a.command-command,.close.the.str
eam#0A......//.and.delete.the.temporary.file#0A....
..endread()#0A......IF.cli_commandfile%0.DO.{.sys(S
ys_deletefile,.cli_commandfile)#0A.................
...............cli_commandfile%0.:#3D.0#0A.........
.....................}#0A......cli_currentinput.:#3D
.cli_standardinput#0A......selectinput(cli_currenti
nput)#0A....}#0A..}.REPEAT#0A}#0A

######cintcode/sysc/cintsys.c#
/*#0A**.This.is.a.32.bit.CINTCODE.interpreter.writt
en.in.C.designed#0A**.to.run.on.most.machines.with.
Unix-like.C.libraries#2E#0A**#0A**.(c).Copyright:..
Martin.Richards..26.May.2010#0A**#0A*/#0A#0A/*#0A03
/05/10#0ARemoved.Sys_usleep.and.reimplemented.Sys_d
elay.to.sleep.for.a.time#0Ain.msecs.(possibly.>#3D.
1000)#2E#0A#0A07/04/10#0AChange.BCPL.epoc.of.1.Jan.
1978.to.1.Jan.1970.to.be.the.same#0Aas.that.used.by
.Unix.and.Windows#2E.Made.corresponding.changes#0At
o.blib#2E#0AChanged.INT32.and.INT64.to.BCPLINT32.an
d.BCPLINT64#0AChanged.CHAR.to.UNSIGNEDCHAR#0A#0A29/
03/10#0AMade.systematic.changes.to.measure.time.in.
msecs.rather.than.ticks#2E#0AThis.is.equivalent.to.
setting.tickspersecond.to.1000,.but.the.code.is#0As
impler#2E#0A#0A05/02/10#0AAdded.the.low.level.trace
.functions.trpush,.settrcount.and.gettrcount,#0Atog
ether.with.the.sys.operations.Sys_trpush,.Sys_settr
count.and.Sys_gettrval#2E#0AThese.can.all.be.safely
.called.from.any.thread#2E.The.circular.trace.buffe
r#0Acan.hold.4096.values#2E#0A#0A07/10/09#0ARenamed
.files.cinterp#2Eh.to.cintsys#2Eh.(and.for.cintpos,
.cinterp#2Eh.to#0Acintpos#2Eh).to.distinguish.betwe
en.the.two.versions.of.cinterp#2Eh#0A#0A05/10/09#0A
Moved.some.some.configuration.statements.to.cintsys
#2Eh.and.added.VMSNAMES#0A#0A17/07/09#0AAdded.forVm
sItanium.and.forVmsVax.features,.including.the.foll
owing:#0AImplemented.vmsfile(filename,.vmsfilename)
.to.convert#0Amost.Linux.file.names.to.Vax.filename
s#2E#0A#0A19/02/08#0ARound.up.the.address.of.the.Ci
ntcode.memory.to.a.double.word.boundary#2E..(malloc
#0Aprobably.already.does.this)#2E#0A#0A07/12/07#0AA
dded.and.initialised.the.rootnode.fields.rtn_mc0.to
.rtn_mc3.to.hold.the.m/c#0Aaddress.of.the.Cintcode.
memory.and.other.system.dependent.values.used.by.th
e.MC#0Adynamic.native.code.package#2E#0A#0A21/11/06
#0AForce.sardch.to.treat.RUBOUT.(ie.the.backspace.k
ey).to.return.Backspace.(#3D8)#0Anot.rubout.(#3D127
)#2E.Add.sys(Sys_delay,.ticks).and.tickspersecond.t
o.delay#0Afor.a.given.number.of.ticks.using.sleep.a
nd.usleep#2E#0A#0A10/11/06#0AAdded.the.-slow.option
.to.force.using.the.slow.interpreter.(interpret).al
l#0Athe.time#2E.This.is.useful.if.there.seems.to.be
.a.bug.in.cinterp.or.fasterp#2E#0A#0A08/11/06#0AAdd
ed.the.-d.option.to.set.the.dump.flag.in.the.rootno
de.(equivalent.to.calling#0Athe.command:.dumpmem.on
)#2E.This.will.cause.the.entire.Cintcode.memory.to.
be#0Adumped.to.DUMP#2Emem.in.a.compacted.form.if.th
e.Cintcode.system.returns.with.a#0Anon.zero.return.
code#2E.The.file.DUMP#2Emem.can.be.printed.in.a.rea
dable.form.using#0Athe.dumpsys.command.(always.assu
ming.you.have.a.working.BCPL.system)#2E#0A#0A07/11/
06#0AAdded.-v.option.to.trace.the.progress.of.the.b
ooting.process#2E.This.is.primarily#0Ato.help.peopl
e.a.new.installation.of.Cintcode.BCPL#2E#0AAdded.-v
-v.option.to.trace.the.progress.of.the.booting.proc
ess#2E.It.behaves.like#0A-v.above.but.also.does.som
e.Cintcode.instruction.level.tracing#2E#0AAdded.-f.
option.to.cintsys.to.trace.the.use.of.environment.v
ariables.such.as#0ABCPLPATH.by.pathinput#2E.This.is
.helps.to.track.down.installation.problems#2E#0A#0A
26/07/06#0AMade.changes.to.cause.loadseg.to.look.fi
rst.in.the.BCPLPATH.directories.then#0Athe.current.
directory.and.finally.in.the.cin.directory.of.BCPLR
OOT#2E..To#0Asimplify.this.change,.the.first.argume
nt.of.pathinput.was.changes.from.a.BCPL#0Astring.to
.a.C.string,.together.with.related.changes#2E..Ther
e.are.now.three.work#0AC.strings.chbuf1,.chbuf2.and
.chbuf3#2E.Made.cintsys#2Ec.more.compatible.with#0A
cintpos#2Ec#0A#0A22/06/06#0AMaking.a.version.for.th
e.GP2X.handheld.Linux.machine#2E#0A#0A21/06/06#0ADe
fined.CHAR.in.cintpos#2Eh.and.cintsys#2Eh.to.be.uns
igned.char.and.replaced.nearly#0Aall.occurences.of.
char.with.CHAR#2E.This.avoids.a.warning.from.some.c
ompilers#2E#0AChanged.most.file.names.to.lower.case
.to.simplify.use.of.windows.machines#2E#0A#0A18/01/
06#0AAdded.-s,.-c.and.--.parameters.to.cintpos,.to.
prepend.characters.before.the#0Astart.of.stdin.(as.
suggested.by.Dave.Lewis)#2E#0A#0A01/01/06#0AChange.
-m.and.-t.options.to.specify.sizes.in.words.(not.th
ousands.of.words)#2E#0A#0A24/04/04#0AMade.many.chan
ges.to.make.cintsys.more.compatible.with.cintpos#0A
#0A22/06/00#0AMade.a.correction.to.muldiv.to.stop.i
t.looping.on.#23x8000000.This.Cintcode#0Ainstructio
n.MDIV.is.now.not.invoked.since.it.sometimes.causes
.a.floating#0Apoint(!!).exception.on.a.Pentium#2E#0A
#0A05/04/00#0AAdded.-m.and.-t.command.line.options.
to.specify.the.Cintcode.memory.size.and#0Atally.vec
tor.size.in.thousands.of.words#2E..Added.the.-h.opt
ion#2E#0A#0A06/01/00#0AMade.changes.to.make.cintsys
#2Ec.more.compatible.with.the.Windows.CE.version#2E
#0A#0A26/2/99#0AChanged.loadseg.to.accept.binary.hu
nks.as.well.as.hex.hunks#2E#0A#0A6/11/98#0AImplemen
ted.changes.to.replace.sys(14,name).by.sys(14,name,
pathname)#2E.If#0Apathname.is.0.or.the.specified.sh
ell.variable.is.unset,.there.should.be.no#0Anoticea
ble.difference#2E.The.new.version.searches.for.the.
file.in.the.current#0Aworking.directory,.then.the.d
irectories.given.by.the.shell.variable.pathname#0Au
ntil.successfully.opened#2E..It.is.designed.to.work
.on.both.Windows.and#0Aunix#2E.The.convention.will.
be.that.if.the.shell.variable.is.set.it.will.specif
y#0Aa.path.used.by.loadseg.(ie.the.initial.loading.
of.SYSLIB,.BOOT,.BLIB,.CLI.and#0ACLI.commands).as.w
ell.as.for.header.files#2E.There.are.small.related.
changes.to#0Alibhdr,.BLIB#2Eb.and.bcpl#2Eb#2E#0A#0A
5/11/98#0AThe.comment.character.in.object.modules.h
as.changed.from.semicolon(';').to.hash#0A('#23')#2E
#0A#0A12/6/96.Move.the.definition.of#0AINT32pt,.WD,
.UWD,.PT,.BP,.SBP,.HP.and.SHP.to.cintpos#2Eh,.and.d
efine.SIGNEDCHAR#0Ain.cintpos#2Eh.to.solve.a.proble
m.with.char.being.unsigned.on.some#0Aimplementation
s#2E#0A#0A31/5/96#0AAdded.handler.for.SIGINT.to.res
tore.tty.settings#0A#0A30/4/96#0AAdded.call.of.fflu
sh(fp).to.case.13:.in.dosys,.with.corresponding.cha
nges.to#0Alibhdr.and.BLIB#2Eb.(added.flush())#0A#0A
24/11/95#0AImproved.the.efficiency.of.the.calls.of.
fread.and.fwrite#0AReduced.the.size.of.chbuf.from.1
024.to.256#0A#0A25/10/95#0AUse.ANSI.clock().instead
.of.ftime(),.adding.TICKS_PER_MS#2E..Change.#23defi
ne.names#0Ato.forMAC,.forMIPS,.forSUN4.etc.Add.and.
set.external.tallyv#0A#0A*/#0A#0A/*.cintsys#2Eh.con
tains.machine/OS.dependent.#23defines..*/#0A#23incl
ude."cintsys#2Eh"#0A#0A/*.Function.defined.in.callc
#2Ec..*/#0Aextern.BCPLWORD.callc(BCPLWORD.*args,.BC
PLWORD.*g);#0A#0ABCPLWORD.trcount.#3D.-1;.//.trpush
.initially.disabled#0ABCPLWORD.trvec[4096];..//.409
6.elements.in.the.trpush.circular.buffer#0A#0A/*.Lo
w.level.trace.functions.*/#0A#0Avoid.trpush(BCPLWOR
D.val);#0ABCPLWORD.settrcount(BCPLWORD.count);.//.S
et.trcount.and.returns.its.old.value#0ABCPLWORD.get
trval(BCPLWORD.count);.//.Get.the.specified.trace.v
alue#0A#0A#0A/*.Functions.defined.in.kblib#2Ec..*/#0A
extern.int.Readch(void);#0Aextern.int.init_keyb(voi
d);#0Aextern.int.close_keyb(void);#0Aextern.int.int
flag(void);#0A#0A/*.Function.defined.in.soundfn#2Ec
.*/#0ABCPLWORD.soundfn(BCPLWORD.*args,.BCPLWORD.*g)
;#0A#0A/*.Functions.defined.in.rastlib#2Ec.(or.null
rastlib#2Ec)..*/#0Aextern.BCPLWORD.setraster(BCPLWO
RD.n,.BCPLWORD.val);#0A#0A/*.Function.defined.in.gr
aphics#2Ec..*/#0A#23ifdef.forWinCE#0Aextern.BCPLWOR
D.sysGraphics(BCPLWORD.p);#0A#23else#0ABCPLWORD.sys
Graphics(BCPLWORD.p).{.return.0;.}./*.Dummy.definit
ion.*/#0A#23endif#0A#0A#23define.Stackupb.....500L#0A
#23define.Globupb.....1000L#0A#0ABCPLWORDpt.W;../*.
This.will.hold.the.pointer.to.the.Cintcode.memory.*
/#0A#0ABCPLWORD.*lastWp;..../*.Latest.setting.of.Wp
..*/#0ABCPLWORD.*lastWg;..../*.Latest.setting.of.Wg
..*/#0ABCPLWORD..lastst;..../*.Latest.setting.of.st
..*/#0A#0ABCPLWORD.prefix.#3D.0;./*.Position.in.the
.Cintcode.memory.of.the.filename.*/#0A.............
......../*.prefix#2E.Zero.means.no.prefix#2E.The.pr
efix.is.*/#0A...................../*.prepended.to.a
ll.non.absolute.file.names#2E.*/#0A................
...../*.prefix.is.set.by.sys(Sys_setprefix,.str).*/
#0A...................../*.and.read.by.sys(Sys_getp
refix)#2E.*/#0A#0ABCPLWORD.stackbase,#0A......globb
ase,#0A......result2;#0A#0Astatic.char.chbuf1[256];
./*.These.buffers.are.used.to.hold.filenames.*/#0As
tatic.char.chbuf2[256];#0Astatic.char.chbuf3[256];#0A
static.char.chbuf4[256];#0Astatic.char*.pathvar.#3D
."BCPLPATH";./*.The.default.setting.*/#0A#0A#0Aint.
tracing.#3D.0;#0Aint.filetracing.#3D.0;#0Aint.dumpf
lag.#3D.0;#0Aint.pathvarstr.#3D.0;#0Aint.slowflag.#3D
.0;.../*.If.non.zero.always.use.the.slow.interprete
r.*/#0Aint.boottrace.#3D.0;#0A#0ABCPLWORD.memupb;#0A
BCPLWORD.tallyupb,.tallyvec,.*tallyv,.tallylim#3D0;
#0ABCPLWORD.vecstatsvupb,.vecstatsvec,.*vecstatsv;.
.../*.Stats.of.getvec/freevec.*/#0A#0ABCPLWORD.task
name[4];........./*.Used.in.getvec.for.debugging.*/
#0A#0ABCPLWORD.concatsegs(BCPLWORD.seg1,.BCPLWORD.s
eg2);#0ABCPLWORD.loadsysseg(char.*name);#0ABCPLWORD
.loadseg(char.*name);#0Avoid..unloadseg(BCPLWORD.se
gl);#0ABCPLWORD.rdhex(FILEPT.fp);#0ABCPLWORD.globin
(BCPLWORD.segl,.BCPLWORD.g);#0ABCPLWORD.getvec(BCPL
WORD.upb);#0ABCPLWORD.freevec(BCPLWORD.p);#0ABCPLWO
RD.muldiv(BCPLWORD.a,.BCPLWORD.b,.BCPLWORD.c);#0AFI
LEPT.pathinput(char.*name,.char.*pathname);#0ABCPLW
ORD.dosys(BCPLWORD.p,.BCPLWORD.g);#0Achar.*b2c_fnam
e(BCPLWORD.bstr,.char.*cstr);#0Achar.*vmsfname(char
.*name,.char.*vmsname);#0Achar.*b2c_str(BCPLWORD.bs
tr,.char.*cstr);#0ABCPLWORD.syscin2b_str(char.*cstr
,.BCPLWORD.bstr);#0Achar.*catstr2c_str(char.*cstr1,
.char.*cstr2,.char.*str);#0ABCPLWORD.c2b_str(char.*
cstr,.BCPLWORD.bstr);#0Avoid..wrcode(char.*form,.BC
PLWORD.f,.BCPLWORD.a);#0Avoid..wrfcode(BCPLWORD.f);
#0Avoid..trace(BCPLWORD.pc,.BCPLWORD.p,.BCPLWORD.a,
.BCPLWORD.b);#0Avoid..dumpmem(BCPLWORD.*mem,.BCPLWO
RD.upb,.BCPLWORD.context);#0ABCPLWORD.timestamp(BCP
LWORD.*v);#0A#0Aextern.int.cintasm(BCPLWORD.regs,.B
CPLWORDpt.mem);#0Aextern.int.interpret(BCPLWORD.reg
s,.BCPLWORDpt.mem);#0A#0A#23define.Globword..0x8F8F
0000#0A#0A#23define.Gn_globsize....0#0A#23define.Gn
_start.......1#0A#23define.Gn_sys.........3#0A#23de
fine.Gn_currco......7#0A#23define.Gn_colist......8#0A
#23define.Gn_rootnode....9#0A#23define.Gn_result2..
..10#0A#23define.Gn_cli_returncode....137#0A#0A/*.r
elocatable.object.blocks..*/#0A#23define.T_hunk....
1000L#0A#23define.T_reloc...1001L#0A#23define.T_end
.....1002L#0A#23define.T_hunk64..2000L#0A#23define.
T_reloc64.2001L#0A#23define.T_end64...2002L#0A#23de
fine.T_bhunk...3000L#0A#23define.T_bhunk64.4000L#0A
#0Aint.badimplementation(void)#0A{.int.bad.#3D.0,.A
#3D'A';#0A..SIGNEDCHAR.c.#3D.(SIGNEDCHAR)255;#0A..i
f(sizeof(BCPLWORD)!#3D(1<<B2Wsh)).{#0A.......PRINTF
("Size.of.a.BCPL.word.is.not.%d\n",.1<<B2Wsh);#0A..
.....bad.#3D.1;#0A..}#0A..if(A!#3D65).{#0A.......PR
INTF("Character.set.is.not.ASCII\n");#0A.......bad.
#3D.1;#0A..}#0A..if.(c/-1.!#3D.1).{#0A....PRINTF("T
here.is.a.problem.with.SIGNEDCHAR\n");#0A....bad.#3D
.1;#0A..}#0A../*.Test.vmsfname.*/#0A../*#0A..vmsfna
me("echo#2Eb",.chbuf4);#0A..vmsfname("com/echo#2Eb"
,.chbuf4);#0A..vmsfname("/mrich177/distribution/bcp
l/g/libhdr#2Eh",.chbuf4);#0A..vmsfname("vd10$disk:/
mrich177/junk#2Eb",.chbuf4);#0A..vmsfname("#2E#2E/c
intcode/com/bcplfe#2Eb",.chbuf4);#0A..vmsfname("/ju
nk",.chbuf4);#0A..*/#0A..return.bad;#0A}#0A#0A/*.Th
e.following.four.functions.are.necessary.since.the.
type.FILE*#0A**.is.too.large.for.a.BCPL.word.on.som
e.machines.(such.as.the.DEC.Alpha)#0A*/#0A#0A#23if.
defined(forALPHA).||.defined(forLINUXAMD64)#0A#23de
fine.Fnolim.100#0A#0AFILEPT.fpvec[Fnolim];#0A#0Aint
.initfpvec(void)#0A{.BCPLWORD.i;#0A..for(i#3D1;i<Fn
olim;i++).fpvec[i]#3DNULL;#0A..return.0;#0A}#0A#0AB
CPLWORD.newfno(FILEPT.fp)#0A{.BCPLWORD.i;#0A..for(i
#3D1;i<Fnolim;i++).if(fpvec[i]#3D#3DNULL){.fpvec[i]
#3Dfp;.return.i;.}#0A..return.0;#0A}#0A#0ABCPLWORD.
freefno(BCPLWORD.fno)#0A{.if(0<fno.&&.fno<Fnolim){f
pvec[fno]#3DNULL;.return.1;.}#0A..return.0;#0A}#0A#0A
FILEPT.findfp(BCPLWORD.fno)#0A{.if(0<fno.&&.fno<Fno
lim).return.fpvec[fno];#0A..return.0;#0A}#0A#0A#23e
lse#0A#0Aint...initfpvec(void)....{.return.0;.}#0AB
CPLWORD.newfno(FILEPT.fp)...{.return.WD.(long)fp;.}
#0ABCPLWORD.freefno(BCPLWORD.fno).{.return.fno;.}#0A
FILEPT.findfp(BCPLWORD.fno)..{.return.(FILEPT.)(lon
g)fno;.}#0A#0A#23endif#0A#0Aint.mainpid#3D0;#0Aexte
rn.BCPLWORD.exitflag;./*.Set.to.one.on.receiving.SI
GINT.or.SIGGEGV.*/#0A#0A#23ifndef.forWinCE#0Avoid.(
*old_inthandler)(int);#0Avoid.(*old_segvhandler)(in
t);#0A#0Avoid.inthandler(int.sig)#0A{.#0A..PRINTF("
\nSIGINT.received\n");#0A..old_inthandler.#3D.signa
l(SIGINT,.old_inthandler);#0A#0A..close_keyb();#0A.
.PRINTF("Leaving.Cintsys\n");#0A..if(W[rootnode+Rtn
_dumpflag])#0A..{.W[rootnode+Rtn_lastp].#3D.lastWp-
W;#0A....W[rootnode+Rtn_lastg].#3D.lastWg-W;#0A....
dumpmem(W,.memupb,.1);#0A....PRINTF("\nMemory.dumpe
d.to.DUMP#2Emem,.context#3D1\n");#0A..}#0A../*if(ma
inpid).{.kill(mainpid,.SIGKILL);.mainpid.#3D.0;.}.*
/#0A..exit(0);#0A}#0A#0Avoid.segvhandler(int.sig)#0A
{.#0A..PRINTF("\nSIGSEGV.received\n");#0A..old_segv
handler..#3D.signal(SIGSEGV,..old_segvhandler);#0A#0A
..close_keyb();#0A..PRINTF("Leaving.Cintsys\n");#0A
..if(W[rootnode+Rtn_dumpflag])#0A..{.W[rootnode+Rtn
_lastp].#3D.lastWp-W;#0A....W[rootnode+Rtn_lastg].#3D
.lastWg-W;#0A....dumpmem(W,.memupb,.2);#0A....PRINT
F("\nMemory.dumped.to.DUMP#2Emem,.context#3D2\n");#0A
..}#0A../*if(mainpid).{.kill(mainpid,.SIGKILL);.mai
npid.#3D.0;.}.*/#0A..exit(0);#0A}#0A#23endif#0A#0Ac
har.*inbuf.#3D.NULL;#09/*.Buffer.for.input.to.inter
preter.*/#0Aint.reattach_stdin.#3D.0;#09/*.FALSE,.i
f.true.switch.to.stdin.after.inbuf.is.empty.*/#0A#0A
/*.Replacement.for.Readch().when.taking.stdin.from.
a.command.line.parameter.*/#0Aint.inbuf_next()#0A{#0A
..static.int.idx.#3D.0;#0A..int.c.#3D.inbuf[idx];#0A
..if.(c).{#0A....idx++;#0A....return.c;#0A..}#0A..e
lse.return.EOF;./*.-1.*/#0A}#0A#0A/*#0ASet.up.a.str
eam.of.characters.to.be.prepended.to.the.standard.i
nput,.for.the#0Acli.to.read.before.those.in.the.nor
mal.input.stream#2E..If.leading_string.is#0Aprovide
d,.it.is.prepended.to.stream.of.characters#2E..This
.is.used.to.support#0Aexecutable.cintcode.files.and
.CLI.scripts.on.Unix.systems#2E.The.leading_string#0A
feature.permits.support.of.scripts.by.running.the."
c".command.followed.by.its#0Acommand.line.arguments
#2E#0A*/#0Avoid.prepend_stdin(char.*leading_string,
.int.argc,.char*.argv[],.int.argvpos).{#0A..int.j;#0A
..int.inbuf_len;#0A../*.Total.number.of.fields.to.p
repend.to.standard.input.stream.*/#0A..int.field_co
unt.#3D.(leading_string?1:0).+.argc.-.argvpos.-.1;#0A
..if.(field_count.#3D#3D.0).{#0A....return;./*.noth
ing.to.prepend.*/#0A..}#0A../*.Count.space.to.alloc
ate,.beginning.with.leading_string.*/#0A..inbuf_len
.#3D.leading_string.?.strlen(leading_string).:.0;#0A
../*.Add.space.for.remaining.fields.*/#0A..for.(j#3D
argvpos+1;.j<argc;.j++).{#0A....inbuf_len.+#3D.strl
en(argv[j]);#0A..}#0A../*.Add.room.for.spaces.betwe
en.fields.plus.a.trailing.<cr>.*/#0A../*.plus.a.nul
l.terminator.*/#0A..inbuf_len.+#3D.field_count.+.1;
#0A../*.Allocate.buffer.for.input.stream.*/#0A..if.
(!(inbuf.#3D.malloc(inbuf_len))).{#0A....perror("ma
lloc");#0A....exit(-1);#0A..}#0A..inbuf[0].#3D.0;#0A
../*.Fill.the.buffer.*/#0A../*.First.prepend.the.le
ading.string,.if.any.*/#0A..if.(leading_string).str
cat(inbuf,.leading_string);#0A../*.Concatenate.rema
ining.args,.separated.by.spaces.*/#0A..for.(argvpos
++;.argvpos<argc;.argvpos++).{#0A....if.(inbuf[0]).
strcat(inbuf,.".");#0A....strcat(inbuf,.argv[argvpo
s]);#0A..}#0A..strcat(inbuf,."\n");./*.Simulate.int
eractive.end.of.line.*/#0A#0A../*PRINTFS("\nPrepend
ed.string:\n%s\n",.inbuf);.*/#0A}#0A#0A/*.The.MC.pa
ckage.printf.function.*/#0ABCPLWORD.mcprf(char.*for
mat,.BCPLWORD.a).{#0A..printf(format,.a);#0A..retur
n.0;#0A}#0A#0Aint.main(int.argc,.char*.argv[])#0A{.
int.rc;#0A..BCPLWORD.i;....../*.for.FOR.loops..*/#0A
..BCPLWORD.res;..../*.result.of.interpret..*/#0A#0A
../*#0A..printf("BCPLWORD.size.#3D.%d.bytes\n",.siz
eof(BCPLWORD));#0A..*/#0A#0A..for.(i#3D0;.i<4;.i++)
.taskname[i].#3D.0;#0A#0A#23ifdef.forWinCE#0A..argc
.#3D.0;...../*.temporary.fiddle.for.Windows.CE.*/#0A
..memupb...#3D.2000000L;#0A..tallyupb.#3D..200000L;
#0A#23else#0A..memupb...#3D.4000000L;#0A..tallyupb.
#3D.1000000L;#0A#23endif#0A#0A..vecstatsvupb.#3D.20
000L;#0A#0A#23ifndef.forWinCE#0A..mainpid.#3D.getpi
d();#0A#23endif#0A#0A../*for.(i#3D0;.i<argc;.i++).p
rintf("%2d:.%s\n",.i,.argv[i]);.*/#0A#0A..for.(i#3D
1;.i<argc;.i++).{#0A#0A....if.(strcmp(argv[i],."-m"
)#3D#3D0).{#0A......memupb...#3D.atoi(argv[++i]);#0A
......continue;#0A....}#0A#0A....if.(strcmp(argv[i]
,."-t")#3D#3D0).{#0A......tallyupb.#3D.atoi(argv[++
i]);#0A......continue;#0A....}#0A#0A....if.(strcmp(
argv[i],."-cin")#3D#3D0).{#0A......pathvar.#3D.argv
[++i];#0A......continue;#0A....}#0A#0A....if.(strcm
p(argv[i],."-f")#3D#3D0).{#0A......filetracing.#3D.
1;#0A......continue;#0A....}#0A#0A....if.(strcmp(ar
gv[i],."-d")#3D#3D0).{#0A......dumpflag.#3D.1;#0A..
....continue;#0A....}#0A#0A....if.(strcmp(argv[i],.
"-slow")#3D#3D0).{#0A......slowflag.#3D.1;#0A......
continue;#0A....}#0A#0A....if.(strcmp(argv[i],."-s"
)#3D#3D0).{#0A....../*#0A......Invoke.a.CLI.command
.interpreter.giving.it.the.current.file.to#0A......
execute.as.a.sequence.of.commands#2E..It.is.used.to
.enable.executable.CLI#0A......scripts.to.be.invoke
.from.Unix#2E#0A#0A......Example:.Make.and.executab
le.file.test1.containing.something.like:#0A#0A.....
.#23!/home/mr/distribution/Cintpos/cintpos/cintpos.
-s#0A......bcpl.com/bcpl#2Eb.to.junk#0A......echo."
*nCompilation.done*n"#0A#0A......#23!/home/mr/distr
ibution/BCPL/cintcode/cintsys.-s#0A......bcpl.com/b
cpl#2Eb.to.junk#0A......echo."*nCompilation.done*n"
#0A#0A......and.run.it.by.typing.the.Unix.command:.
test1#0A......*/#0A#0A......char.*fname.#3D.argv[i.
+.1];#0A......if.(!fname).{#0A........fprintf(stder
r,."missing.parameter.for.-s\n");#0A........exit(-1
);#0A......}#0A......prepend_stdin("c",.argc,.argv,
.i);#0A......break;#0A....}#0A#0A....if.(strcmp(arg
v[i],."--")#3D#3D.0).{#0A....../*.Like.-c.but.reatt
ach.standard.input.after.exhausting.command.*/#0A..
..../*.line.characters#2E.*/#0A......reattach_stdin
.#3D.1;./*.TRUE.*/#0A....}#0A#0A....if.(strcmp(argv
[i],."-c")#3D#3D.0.||.strcmp(argv[i],."--")#3D#3D.0
).{#0A....../*.Allocate.a.buffer.to.hold.remaining.
args.as.a.string.and.pass#0A......**.remainder.of.c
ommand.line.to.the.interpreter#2E#0A#0A......**.Typ
ical.usage:#0A#0A......**.cintpos.-c.bcpl.com/bcpl#2E
b.to.junk#0A......**.cintsys.-c.bcpl.com/bcpl#2Eb.t
o.junk#0A......*/#0A#0A......prepend_stdin(NULL,.ar
gc,.argv,.i);#0A......break;#0A....}#0A#0A....if.(s
trcmp(argv[i],."-v")#3D#3D.0).{.boottrace++;.contin
ue;.}#0A#0A....if.(strcmp(argv[i],."-h")!#3D0).PRIN
TF("Unknown.command.option:.%s\n",.argv[i]);#0A#0A.
...PRINTF("\nValid.arguments:\n\n").;#0A....PRINTF(
"-h............Output.this.help.information\n");#0A
....PRINTF("-m.n..........Set.Cintcode.memory.size.
to.n.words\n");#0A....PRINTF("-t.n..........Set.Tal
ly.vector.size.to.n.words\n");#0A....PRINTF("-c.arg
s......."#0A..........."Pass.args.to.interpreter.as
.standard.input.(executable.bytecode)\n");#0A....PR
INTF("--.args......."#0A..........."Pass.args.to.in
terpreter.standard.input,.then.re-attach.stdin\n");
#0A....PRINTF("-s.file.args.."#0A..........."Invoke
.command.interpreter.on.file.with.args.(executable.
scripts)\n");#0A....PRINTF("-cin.name.....Set.the.p
athvar.environment.variable.name\n");#0A....PRINTF(
"-f............Trace.the.use.of.environment.variabl
es.in.pathinput\n");#0A....PRINTF("-v............Tr
ace.the.bootstrapping.process\n");#0A....PRINTF("-v
.-v.........As.-v,.but.also.include.some.Cincode.le
vel.tracing\n");#0A#0A....PRINTF("-d............Cau
se.a.dump.of.the.Cintcode.memory.to.DUMP#2Emem\n");
#0A....PRINTF("..............if.a.fault/error.is.en
countered\n");#0A#0A....PRINTF("-slow.........Force
.the.slow.interpreter.to.always.be.selected\n");#0A
#0A....return.0;#0A..}#0A#0A..if(boottrace>0).PRINT
FD("Boot.tracing.level.is.set.to.%d\n",.boottrace);
#0A#0A..if.(memupb<50000.||.tallyupb<0).{#0A....PRI
NTF("Bad.-m.or.-t.size\n");#0A....return.10;#0A..}#0A
#0A..if(badimplementation())#0A..{.PRINTF("This.imp
lementation.of.C.is.not.suitable\n");#0A....return.
0;#0A..}#0A#0A..initfpvec();#0A#0A..W.#3D.PT.malloc
((memupb+tallyupb+vecstatsvupb+7)<<B2Wsh);#0A#0A..i
f(W#3D#3DNULL)#0A..{.PRINTF("Insufficient.memory.fo
r.memvec\n");#0A....return.0;#0A..}#0A../*..printf(
"Cintcode.memory.%8x.(unrounded)\n",.(long)W);.*/#0A
..W.#3D.PT(((long).W.+.7L).&.-8L);#0A../*..printf("
Cintcode.memory.%8x.(rounded)\n",.(long)W);..*/#0A#0A
..lastWp.#3D.W;#0A..lastWg.#3D.W;#0A..lastst.#3D.3;
./*.Pretend.to.be.in.the.interrupt.service.routine.
*/#0A#0A..for.(i#3D0;.i<memupb;.i++).W[i].#3D.0xDEA
DC0DE;#0A#0A..if.(boottrace>0).PRINTFD("Cintcode.me
mory.(upb#3D%d).allocated\n",.memupb);#0A#0A..W[0].
#3D.memupb+1;../*.Initialise.heap.space.*/#0A..W[me
mupb].#3D.0;#0A#0A..tallylim.#3D.0;#0A..tallyvec.#3D
.memupb+1;#0A..tallyv.#3D.&W[tallyvec];#0A..tallyv[
0].#3D.tallyupb;#0A..for(i#3D1;.i<#3Dtallyupb;.i++)
.tallyv[i].#3D.0;#0A#0A..vecstatsvec.#3D.tallyvec.+
.tallyupb.+.1;#0A..vecstatsv.#3D.&W[vecstatsvec];#0A
..for(i#3D0;.i<#3Dvecstatsvupb;.i++).vecstatsv[i].#3D
.0;#0A.#0A..getvec(200L);../*.Allocate.space.for.in
terrupt.vectors#0A....................and.the.rootn
ode..*/#0A#0A..{.//.Convert.pathvar.to.BCPL.string.
format#0A....int.len.#3D.0;#0A....char.*p.#3D.pathv
ar;#0A....char*.str;#0A....pathvarstr.#3D.getvec(10
);#0A....str.#3D.((char*)(W+pathvarstr));#0A....whi
le.(*p.&&.len<32).str[++len].#3D.*p++;.#0A....str[0
].#3D.len;#0A..}#0A#0A..stackbase.#3D.getvec(Stacku
pb+6);../*.+6.because.it.will.be.a.coroutine.*/#0A.
.globbase..#3D.getvec(Globupb);#0A..result2.#3D.0L;
#0A#0A..if.(boottrace>0).PRINTF("Boot's.stack.alloc
ated.at.%d\n",.stackbase);#0A#0A..W[stackbase].#3D.
Stackupb;./*.Tell.boot.how.large.its.stack.is#2E.*/
#0A..for(i#3D1;.i<#3DStackupb+6;.i++).W[stackbase+i
].#3D.0xABCD1234;#0A../*.boot.will.turn.this.stack.
into.a.coroutine.stack.*/#0A#0A..if.(boottrace>0).P
RINTF("Boot's.global.vector.allocated.at.%d\n",.glo
bbase);#0A#0A..for(i.#3D.0;.i<#3DGlobupb;.i++).W[gl
obbase+i].#3D.Globword+i;#0A..W[globbase+Gn_globsiz
e].#3D.Globupb;#0A..W[globbase+Gn_rootnode].#3D.roo
tnode;#0A#0A..for(i#3D0;.i<#3DRtn_upb;.i++).W[rootn
ode+i].#3D.0;#0A#0A..W[rootnode+Rtn_membase]......#3D
.0;#0A..W[rootnode+Rtn_memsize]......#3D.memupb;#0A
..W[rootnode+Rtn_blklist]......#3D.0;#0A..W[rootnod
e+Rtn_tallyv].......#3D.tallyvec;#0A..W[rootnode+Rt
n_vecstatsv]....#3D.vecstatsvec;#0A..W[rootnode+Rtn
_vecstatsvupb].#3D.vecstatsvupb;#0A..W[rootnode+Rtn
_boottrace]....#3D.boottrace;#0A..W[rootnode+Rtn_du
mpflag].....#3D.dumpflag;#0A..W[rootnode+Rtn_mc0]..
........#3D.(BCPLWORD).W;#0A..W[rootnode+Rtn_mc1]..
........#3D.0;#0A..W[rootnode+Rtn_mc2]..........#3D
.(BCPLWORD).mcprf;./*.The.MC.prf.fn.*/#0A..W[rootno
de+Rtn_mc3]..........#3D.0;#0A..W[rootnode+Rtn_path
var]......#3D.pathvarstr;#0A#0A..if.(boottrace>0).P
RINTF("Rootnode.allocated.at.%d\n",.rootnode);#0A#0A
..if.(boottrace>0).PRINTF("Loading.all.resident.pro
grams.and.libraries\n");#0A#0A..{.BCPLWORD.seg.#3D.
loadsysseg("boot");#0A....if(seg#3D#3D0).{.PRINTF("
Trouble.with.boot\n");.return.20;.}#0A....W[rootnod
e+Rtn_boot].#3D.globin(seg,.globbase);#0A....if(W[r
ootnode+Rtn_boot]#3D#3D0).{#0A......PRINTF("Can't.g
lobin.boot\n");#0A......return.20;#0A....}#0A#0A...
.if.(boottrace>0).PRINTF("syscin/boot.loaded.succes
sfully\n");#0A#0A....seg.#3D.loadsysseg("blib");#0A
....if(seg#3D#3D0).{.PRINTF("Can't.load.blib\n");.r
eturn.20;.}#0A....if.(boottrace>0).PRINTF("syscin/b
lib.loaded.successfully\n");#0A#0A....seg.#3D.conca
tsegs(seg,.loadsysseg("syslib"));#0A....if(seg#3D#3D
0).{.PRINTF("Can't.load.syslib\n");.return.20;.}#0A
....if.(boottrace>0).PRINTF("syscin/syslib.loaded.s
uccessfully\n");#0A#0A....seg.#3D.concatsegs(seg,.l
oadsysseg("dlib"));#0A....if(seg#3D#3D0).{.PRINTF("
Can't.load.dlib\n");.return.20;.}#0A....if.(boottra
ce>0).PRINTF("syscin/dlib.loaded.successfully\n");#0A
#0A....W[rootnode+Rtn_blib].#3D.globin(seg,.globbas
e);#0A....if(W[rootnode+Rtn_blib]#3D#3D0).{#0A.....
.PRINTF("Can't.globin.{blib,syslib,dlib}\n");#0A...
...return.20;#0A....}#0A..}#0A#0A#23ifndef.forWinCE
#0A../*.Set.handler.for.CTRL-C.*/#0A..old_inthandle
r..#3D.signal(SIGINT,.inthandler);./*.To.catch.CTRL
-C.*/#0A../*.Set.handler.for.segment.violation.*/#0A
..old_segvhandler..#3D.signal(SIGSEGV,.segvhandler)
;./*.To.catch.segv.*/#0A#23endif#0A#0A../*.Make.sys
.available.via.the.root.node.*/#0A..W[rootnode+Rtn_
sys].#3D.W[globbase+Gn_sys];#0A#0A../*#0A..boot.has
.no.coroutine.environment#2E..Note.that.boot's.glob
al.vector.is.also#0A..used.by.interrupt.service.rou
tines#2E.The.chain.of.stack.frames.in.such.an#0A..e
nvironment.must.be.terminated.by.a.zero.link.(for.D
EBUG.to.work.properly)#2E#0A..*/#0A..W[globbase+Gn_
currco].#3D.0;#0A..W[globbase+Gn_colist].#3D.0;#0A#0A
../*.Set.the.boot.registers.ready.for.the.Cintcode.
interpreter.*/#0A#0A..W[bootregs+0].#3D.0;.........
......./*.A.*/#0A..W[bootregs+1].#3D.0;............
..../*.B.*/#0A..W[bootregs+2].#3D.0;...............
./*.C.*/#0A..W[bootregs+3].#3D.stackbase<<B2Wsh;./*
.P.*/#0A..W[bootregs+4].#3D.globbase<<B2Wsh;../*.G.
*/#0A..W[bootregs+5].#3D.2;................/*.ST.--
.in.boot,.interrupts.disabled.*/#0A..W[bootregs+6].
#3D.W[globbase+1];..../*.PC.(start.in.boot).*/#0A..
W[bootregs+7].#3D.-1;.............../*.Count.*/#0A.
.W[bootregs+8].#3D.0;................/*.MW.*/#0A#0A
../*.A.debbugging.aid!!.*/#0A../*.tracing.#3D.1;.*/
#0A#0A..init_keyb();#0A../*.Call.the.slow.interpret
er.even.though.Count#3D-1.*/#0A..if.(boottrace>0).P
RINTF("cintpos.calling.the.interpreter\n");#0A..if.
(boottrace>1)#0A..{.PRINTF("Turning.instruction.tra
cing.on\n");#0A....tracing.#3D.1;#0A..}#0A#0A..res.
#3D.interpret(bootregs,.W);#0A..if.(boottrace>0)#0A
....PRINTFD("interpreter.returned.control.to.cintsy
s,.res#3D%ld\n",.(long)res);#0A#0A..close_keyb();#0A
#0A..if.(res).{#0A....PRINTFD("\nExecution.finished
,.return.code.%ld\n",.(long)res);#0A#0A....if.(res.
&&.W[rootnode+Rtn_dumpflag]).{#0A......dumpmem(W,.m
emupb,.3);#0A......PRINTF("\nCintpos.memory.dumped.
to.DUMP#2Emem,.context#3D3\n");#0A....}#0A..}#0A..P
RINTF("\n");#0A../*Change.suggested.by.Dave.Lewis.-
.return.cli_returncode.rather.than.res.*/#0A..retur
n.W[globbase+Gn_cli_returncode];./*.MR.17/01/06.*/#0A
../*return.res;.*/#0A}#0A#0ABCPLWORD.concatsegs(BCP
LWORD.seg1,.BCPLWORD.seg2).{#0A..BCPLWORD.p.#3D.seg
1;#0A..if(p#3D#3D0.||.seg2#3D#3D0).return.0;#0A..wh
ile(W[p]).p.#3D.W[p];#0A../*PRINTFD("concatsegs:.se
g1.%d.",.seg1);.*/#0A../*PRINTFD("seg2.%d.",.seg2);
.*/#0A../*PRINTFD("p.%d\n",.p);.*/#0A..W[p].#3D.seg
2;#0A..return.seg1;#0A}#0A#0ABCPLWORD.loadsysseg(ch
ar.*name).{#0A..return.loadseg(catstr2c_str("syscin
/",.name,.chbuf3));#0A}#0A#0ABCPLWORD.loadseg(char.
*file)#0A{.BCPLWORD.list..#3D.0;#0A..BCPLWORD.liste
.#3D.0;#0A#0A..//.First.look.in.the.current.directo
ry#0A..FILEPT.fp.#3D.pathinput(file,.0);#0A#0A..//.
Then.look.in.the.directories.specified.by.the.envir
onment#0A..//.variable.whose.name.is.in.pathvar#2E#0A
..if(fp#3D#3DNULL).{#0A..../*PRINTFS("loadseg:.sear
ching.for.%s.in.the.pathvar.directories\n",.file);.
*/#0A....fp.#3D.pathinput(file,.pathvar);#0A..}#0A#0A
..if(fp#3D#3DNULL).{#0A....char.chbuf[256];#0A..../
*.It.was.not.found.in.the.BCPLPATH.directories.so.*
/#0A..../*.look.in.<BCPLROOT>/cin,.ie.preprend.cin/
.to.file.*/#0A..../*PRINTFS("loadseg:.searching.for
.%s.in.$BCPLROOT/cin\n",.file);.*/#0A....fp.#3D.pat
hinput(catstr2c_str("cin/",.file,.chbuf),."BCPLROOT
");#0A..}#0A..if(fp#3D#3DNULL).return.0;#0A#0A../*P
RINTF("loadseg:.loading.a.file.%s\n",.file);.*/#0A.
.for(;;)#0A..{.BCPLWORD.type.#3D.rdhex(fp);#0A..../
*PRINTFD("loadsegtype.#3D.%d\n",.type);.*/#0A....sw
itch((int)type)#0A....{.default:#0A..........err:..
.unloadseg(list);#0A.................list.#3D.0;#0A
......case.-1:...fclose(fp);#0A.................ret
urn.list;#0A#09#09.#0A......case.T_hunk:#0A........
.......{.BCPLWORD.i,.n#3Drdhex(fp);#0A.............
....BCPLWORD.space.#3D.getvec(n);#0A#09#09./*PRINTF
D("loading.hunk.size.%d.",.n);.*/#0A#09#09./*PRINTF
D("to.%d\n",.space);.*/#0A.................if(space
#3D#3D0).goto.err;#0A.................W[space].#3D.
0;#0A.................for(i.#3D.1;.i<#3Dn;.i++).W[s
pace+i].#3D.rdhex(fp);#0A.................if(list#3D
#3D0).list#3Dspace;#0A.................else.W[liste
].#3D.space;#0A.................liste.#3D.space;#0A
.................continue;#0A...............}#0A#09
#09.#0A......case.T_bhunk:./*.For.hunks.in.binary.(
not.hex).*/#0A................{.BCPLWORD.n;#0A.....
.............BCPLWORD.space;#0A..................in
t.len.#3D.fread((char.*)&n,.(size_t)4,.(size_t)1,.f
p);#0A..................if.(len!#3D1.&&.len!#3D4).g
oto.err;#0A..................space.#3D.getvec(n);#0A
..................if(space#3D#3D0).goto.err;#0A....
..............W[space].#3D.0;#0A..................l
en.#3D.fread((char.*)&W[space+1],.(size_t)4,.(size_
t)n,.fp);#0A..................if.(len!#3Dn.&&.len!#3D
4*n).goto.err;#0A..................if(list#3D#3D0).
list#3Dspace;#0A..................else.W[liste].#3D
.space;#0A..................liste.#3D.space;#0A....
..............continue;#0A................}#0A#09#09
.#0A......case.T_end:#0A#09..........break;#0A....}
#09#09.#0A..}#09#09.#0A}.#09#09.#0A#09#09.#0Avoid.u
nloadseg(BCPLWORD.segl)#0A{.while(segl).{.BCPLWORD.
s.#3D.W[segl];#0A................freevec(segl);#0A.
...............segl.#3D.s;#0A..............}#0A}#0A
#0A/*.rdhex.reads.in.one.hex.number.including.the.t
erminating.character#0A...and.returns.its.BCPLWORD.
value#2E.EOF.returns.-1#2E#0A*/#0ABCPLWORD.rdhex(FI
LEPT.fp)#0A{..BCPLWORD.w.#3D.0;#0A...int.ch.#3D.fge
tc(fp);#0A#0A...while(ch#3D#3D'.'.||.ch#3D#3D'\n'.|
|.ch#3D#3D'\r').ch.#3D.fgetc(fp);#0A#0A...if.(ch#3D
#3D'#23').{./*.remove.comments.from.object.modules.
*/#0A..................while.(ch.!#3D.'\n'.&&.ch.!#3D
.EOF).ch.#3D.fgetc(fp);#0A..................return.
rdhex(fp);#0A................}#0A#0A...for(;;)#0A..
.{..int.d.#3D.100;#0A......if('0'<#3Dch.&&.ch<#3D'9
').d.#3D.ch-'0';#0A......if('A'<#3Dch.&&.ch<#3D'F')
.d.#3D.ch-'A'+10;#0A......if('a'<#3Dch.&&.ch<#3D'f'
).d.#3D.ch-'a'+10;#0A#09#09.#0A......if(d#3D#3D100)
.return.ch#3D#3DEOF.?.-1.:.w;#0A......w.#3D.(w<<4).
|.d;#0A......ch.#3D.fgetc(fp);#0A...}#09#09.#0A}#09
#09.#0A#09#09.#0ABCPLWORD.globin(BCPLWORD.segl,.BCP
LWORD.g)#0A{.BCPLWORD..a.#3D.segl,.globsize.#3D.W[g
];#0A../*PRINTFD("globin.segl.#3D.%6ld..",.segl);.*
/#0A../*PRINTFD("g.#3D.%6ld\n",.g);.*/#0A..while.(a
).{.BCPLWORD.base.#3D.(a+1)<<B2Wsh;#0A.............
.BCPLWORD.i.#3D.a.+.W[a+1];#0A..............if.(W[i
]>globsize).return.0;#0A#09....../*PRINTFD("globin:
..base.%6ld..",.a+1);.*/.#0A#09....../*PRINTFD("to.
%6ld..",.i);.*/#0A#09....../*PRINTFD("size:.%5ld\n"
,.W[a+1]);.*/.#0A..............for(;;).{.i.-#3D.2;#0A
........................if.(W[i+1]#3D#3D0).break;#0A
........................W[g+W[i]].#3D.base.+.W[i+1]
;#0A#09#09#09/*PRINTFD("globin:..g[%3ld].",.W[i]);.
.*/#0A#09#09#09/*PRINTFD("#3D.%6ld\n",.base+W[i+1])
;.*/#0A......................}#0A..............a.#3D
.W[a];#0A............}#0A..return.segl;#0A}#0A#0ABC
PLWORD.getvec(BCPLWORD.requpb)#0A{.BCPLWORD.upb.#3D
.requpb+4+4;../*.Allocate.4.words.at.the.end.for.sa
fety.*/#0A............................../*.plus.4.w
ords.of.task.name#2E.*/#0A..BCPLWORD.p;#0A..BCPLWOR
D.q.#3D.0;./*.the.start.of.the.block.list.*/#0A..BC
PLWORD.n.#3D.(upb+1+1+1).&.0xFFFFFFFE;../*.Add.1.wo
rd.for.size.and.alloc.bit#0A.......................
...................and.1.word.for.word.zero.and#0A.
.........................................then.round
.up.to.an.even.size.*/#0A..#0A..do#0A..{.p.#3D.q;#0A
....for(;;).{.BCPLWORD.size.#3D.W[p];#0A...........
...if((size&1).!#3D.0).break;#0A..............if(.s
ize.#3D#3D.0)....return.0;#0A..............p.+#3D.s
ize;#0A............}#0A....q.#3D.p;../*.find.next.u
sed.block.*/#0A....for(;;).{.BCPLWORD.size.#3D.W[q]
;#0A..............if((size&1).#3D#3D.0).break;#0A..
............q.+#3D.size-1;#0A............}#0A..}.wh
ile(q-p<n);#0A..#0A..if(p+n!#3Dq).W[p+n].#3D.q-p-n+
1;#0A..W[p].#3D.n;#0A../*.The.following.is.intended
.to.improve.the.safety.of.memory.allocation.*/#0A..
/*.by.adding.checkable.redundancy.*/#0A..W[p+n-9].#3D
.0xCCCCCCCC;../*.Funny.pattern.for.possible.roundup
.word.*/#0A..W[p+n-8].#3D.0x55555555;../*.Special.p
atterns.*/#0A..W[p+n-7].#3D.0xAAAAAAAA;#0A..W[p+n-6
].#3D.requpb;....../*.The.requested.upb.*/#0A#0A..W
[p+n-5].#3D.taskname[0];./*.The.taskname,.if.any.*/
#0A..W[p+n-4].#3D.taskname[1];./*.The.taskname,.if.
any.*/#0A..W[p+n-3].#3D.taskname[2];./*.The.tasknam
e,.if.any.*/#0A..W[p+n-2].#3D.taskname[3];./*.The.t
askname,.if.any.*/#0A#0A..W[p+n-1].#3D.p;..........
./*.Pointer.to.base.of.this.memory.block.*/#0A../*P
RINTFD("getvec:.allocating.block.%6d..",.p);.*/#0A.
./*PRINTFD("upb.%4d\n",.upb);.*/#0A#0A..if(requpb>v
ecstatsvupb).requpb.#3D.vecstatsvupb;#0A..W[vecstat
svec+requpb]++;#0A..return.p+1;#0A}#0A#0ABCPLWORD.f
reevec(BCPLWORD.p)#0A{.BCPLWORD.res.#3D.-1;../*.#3D
TRUE.*/#0A..BCPLWORD.n,.upb;#0A#0A..if(p#3D#3D0).re
turn.res;#0A#0A..p--;......./*.All.getvec'ed.blocks
.start.on.odd.addresses.*/#0A..n.#3D.W[p];#0A#0A..i
f(n.&.1).{#0A....PRINTFD("\n#23#23#23#23.freevec:.b
lock.at.%ld.already.free\n",.p);#0A....return.0;#0A
..}#0A#0A../*PRINTFD("#23#23#23#23.freevec:.Freeing
.block.at.%ld\n",.p);.*/#0A#0A..if(W[p+n-1]!#3Dp.||
#0A.....W[p+n-7]!#3D0xAAAAAAAA.||#0A.....W[p+n-8]!#3D
0x55555555).{#0A.......PRINTFD("\n#23#23#23#23.free
vec:.block.at.%ld.",.p);#0A.......PRINTFD("size.%ld
.corrupted",.n);#0A.......PRINTFD("\n#23#23#23#23.f
reevec:.last.4.words.%8x.",.W[p+n-8]);#0A.......PRI
NTFD("%8x.",..............................W[p+n-7])
;#0A.......PRINTFD("%6d.",.........................
.....W[p+n-6]);#0A.......PRINTFD("%7d",............
...................W[p+n-1]);#0A.......PRINTFD("\n#23
#23#23#23.freevec:.should.be....55555555.AAAAAAAA.r
equpb.%7d\n\n",#0A................p);#0A.......res.
#3D.0;#0A..}#0A..W[p].|#3D.1;#0A../*.Deal.with.getv
ec.allocation.statistics.*/#0A..upb.#3D.W[p+n-6];..
...../*.The.requested.size.*/#0A..if(upb>vecstatsvu
pb).upb.#3D.vecstatsvupb;#0A..W[vecstatsvec+upb]--;
./*.Decrement.count.of.block.of.this.size.*/#0A..re
turn.res;#0A}#0A#0ABCPLWORD.muldiv(BCPLWORD.a,.BCPL
WORD.b,.BCPLWORD.c)#0A{.unsigned.BCPLWORD.q#3D0,.r#3D
0,.qn,.rn;#0A..unsigned.BCPLWORD.ua,.ub,.uc;#0A..in
t.qneg#3D0,.rneg#3D0;#0A..if(c#3D#3D0).c#3D1;#0A..i
f(a<0).{.qneg#3D!qneg;.rneg#3D!rneg;.ua.#3D.-a;.}#0A
..else..............................ua.#3D..a;#0A..
if(b<0).{.qneg#3D!qneg;.rneg#3D!rneg;.ub.#3D.-b;.}#0A
..else..............................ub.#3D..b;#0A..
if(c<0).{.qneg#3D!qneg;.............uc.#3D.-c;.}#0A
..else..............................uc.#3D..c;#0A..
#0A..qn.#3D.ub./.uc;#0A..rn.#3D.ub.%.uc;#0A..#0A..w
hile(ua)#0A..{.if(ua&1).{.q.+#3D.qn;#0A............
...r.+#3D.rn;#0A...............if(r>#3Duc).{.q++;.r
.-#3D.uc;.}#0A.............}#0A....ua.>>#3D.1;#0A..
..qn.<<#3D.1;#0A....rn.<<#3D.1;#0A....if(rn>#3Duc).
{qn++;.rn.-#3D.uc;.}#0A..}#0A..result2.#3D.rneg.?.-
(BCPLWORD)r.:.r;#0A..return.qneg.?.-(BCPLWORD)q.:.q
;#0A}#0A#0Aint.relfilename(char.*name).{#0A..if(nam
e[0]#3D#3D'/'.||.name[0]#3D#3D'\\'.||#0A...../*.The
.following.is.fiddle.for.MSDOS/Windows.*/#0A.....FI
LE_SEP_CH#3D#3D'\\'.&&.'A'<#3Dname[0].&&.name[0]<#3D
'Z'.&&.name[1]#3D#3D':')#0A.......return.0;./*.Abso
lute.file.names.don't.use.paths.*/#0A..return.1;.#0A
}#0A#0A/*.pathinput.does.not.use.any.of.chbuf1,.chb
uf2.or.chbuf3#2E.*/#0AFILEPT.pathinput(char.*name,.
char.*pathname)#0A/*.If.pathname.is.not.null,.name.
is.looked.up.in.the.directories#0A...it.specifies,.
otherwise.name.is.looked.up.in.the.current.director
y#0A*/#0A{.FILEPT.fp.#3D.0;#0A#0A../*.Look.through.
the.PATH.directories.if.pathname.is.given#2E.*/#0A.
.if.(pathname).{#0A....char.str[256];#0A....char.*f
ilename.#3D.&str[0];#0A....int.itemsep.#3D.FILE_SEP
_CH#3D#3D'/'.?.':'.:.';';#0A#23ifdef.VMSNAMES#0A...
.itemsep.#3D.';';#0A#23endif#0A..../*PRINTFS("pathi
nput:.searching.for.%s.in.path.%s\n",.name,.pathnam
e);.*/#0A....if.(relfilename(name))#0A....{.char.*p
ath.#3D.getenv(pathname);#0A......if(filetracing).{
#0A........PRINTFS("pathinput:.using.%s",.pathname)
;#0A........PRINTFS(".#3D.%s\n",.path);#0A......}#0A
....../*PRINTFS("pathinput:.searching.directories.%
s\n",.path);.*/#0A....../*.Try.prefixing.with.each.
directory.in.the.path#2E.*/#0A......while(path.&&.f
p#3D#3D0)#0A......{.char.*f#3Dfilename;#0A........c
har.*n#3Dname;#0A........while(*path#3D#3Ditemsep).
path++;#0A........if(*path#3D#3D0).break;#0A.......
./*.Copy.the.directory.name.into.filename.*/#0A....
....while(*path!#3D0.&&.*path!#3Ditemsep)#0A.......
.{.char.ch.#3D.*path++;#0A..........if(ch#3D#3D'/'.
||.ch#3D#3D'\\').ch.#3D.FILE_SEP_CH;#0A..........*f
++.#3D.ch;#0A........}#0A......../*.Insert.a.filena
me.seperator.if.necessary#2E.*/#0A........if(f[-1]!
#3DFILE_SEP_CH).*f++.#3D.FILE_SEP_CH;#0A#0A........
/*.Append.the.given.file.name.*/#0A........while(*n
)#0A........{.char.ch.#3D.*n++;#0A..........if(ch#3D
#3D'/'.||.ch#3D#3D'\\').ch.#3D.FILE_SEP_CH;#0A.....
.....*f++.#3D.ch;#0A........}#0A........*f.#3D.0;#0A
#23ifdef.VMSNAMES#0A........filename.#3D.vmsfname(f
ilename,.chbuf4);#0A#23endif#0A........fp.#3D.fopen
(filename,."rb");#0A........if(filetracing)#0A.....
...{.PRINTFS("Trying:.%s.-.",.filename);#0A#09..if(
fp).{#0A............PRINTF("found\n");#0A#09..}.els
e.{#0A............PRINTF("not.found\n");#0A#09..}#0A
........}#0A......}#0A....}#0A..}.else.{#0A..../*.I
f.pathname.was.NULL,.search.the.current.directory.*
/#0A..../*PRINTFS("Searching.for.%s.in.the.current.
directory\n",.name);.*/#0A#23ifdef.VMSNAMES#0A....f
p.#3D.fopen(vmsfname(name,.chbuf4),."rb");#0A#23els
e#0A....fp.#3D.fopen(name,."rb");#0A#23endif#0A....
if(filetracing)#0A....{.PRINTFS("Trying:.%s.in.the.
current.directory.-.",.name);#0A......if(fp).{#0A..
......PRINTF("found\n");#0A......}.else.{#0A.......
.PRINTF("not.found\n");#0A......}#0A....}#0A..}#0A#0A
../*if(fp#3D#3D0).PRINTFS("pathinput:.failed.to.fin
d.%s.anywhere\n",.name);.*/#0A../*else......PRINTF(
"pathinput:.success\n");.*/#0A#0A..return.fp;#0A}#0A
#0ABCPLWORD.dosys(register.BCPLWORD.p,.register.BCP
LWORD.g)#0A{.register.BCPLWORD.i;#0A../*PRINTFD("do
sys(%d,.",.p);.*/#0A../*PRINTFD("%d",.g);.*/#0A../*
PINTFD(").P3#3D%d.",.(long)W[p+3]);.*/#0A../*PRINTF
D("P4#3D%d\n",..(long)W[p+4]);.*/#0A..switch((int)(
W[p+3]))#0A..{.default:.PRINTFD("\nBad.sys.number:.
%ld\n",.(long)W[p+3]);#0A.............return.W[p+3]
;#0A#0A..../*.case.Sys_setcount:.set.count.........
......--.done.in.cinterp#0A....**.case.Sys_quit:...
..return.from.interpreter.--.done.in.cinterp#0A#0A.
...**.case.Sys_rti:......sys(Sys_rti,.regs)......--
.done.in.cinterp..Cintpos#0A....**.case.Sys_savereg
s:.sys(Sys_saveregs,.regs).--.done.in.cinterp..Cint
pos#0A....**.case.Sys_setst:....sys(Sys_setst,.st).
.....--.done.in.cinterp..Cintpos#0A....*/#0A....cas
e.Sys_tracing:../*.sys(Sys_tracing,.b).*/#0A.......
.....tracing.#3D.W[p+4];#0A............return.0;#0A
..../*.case.Sys_watch:....sys(Sys_watch,.addr)....-
-.done.in.cinterp#0A....*/#0A#0A....case..Sys_tally
:........./*.sys(Sys_tally,.flag).....*/#0A........
.....if(W[p+4]).{#0A................tallylim.#3D.ta
llyupb;#0A................for(i#3D1;.i<#3Dtallylim;
.i++).tallyv[i].#3D.0;#0A..............}.else.{#0A.
...............tallylim.#3D.0;#0A..............}#0A
..............return.0;#0A.....#0A....case.Sys_inte
rpret:./*.call.interpreter.(recursively).*/#0A.....
.......{.BCPLWORD.regsv.#3D.W[p+4];#0A.............
.if(W[regsv+7]>#3D0.||.slowflag).return.interpret(r
egsv,.W);#0A..............return.CINTASM..(regsv,.W
);#0A............}#0A#0A....case.Sys_sardch:#0A....
..........{.int.ch;#0A#0A................if.(inbuf)
.{#0A................../*.Input.taken.from.command.
line.*/#0A..................ch.#3D.inbuf_next();#0A
..................if.(ch.#3D#3D.EOF).{./*.inbuf.is.
now.empty.*/#0A....................if.(reattach_std
in).{#0A......................free(inbuf);#0A......
................inbuf.#3D.0;./*.Don't.try.to.read.m
ore.characters.*/#0A#09#09................./*.from.
the.buffer.*/#0A....................../*.Continue.w
ith.normal.read.from.stdin.*/#0A...................
.}.else.{#0A......................return.ch;./*.EOF
.*/#0A....................}#0A..................}.e
lse.{#0A....................return.ch;./*.valid.cha
racter.*/#0A..................}#0A................}
#0A................/*.Normal.case,.stdin.input.to.i
nterpreter.*/#0A#0A................ch.#3D.Readch();
./*.get.the.keyboard.character..*/#0A#09#09/*PRINTF
D("Sys_sardch:.ch.#3D.%d\n",.ch);.*/#0A#09#09if(ch#3D
#3D127)./*.RUBOUT.from.the.keyboard.*/#0A#09#09..ch
.#3D.8;.../*.Replace.by.BS.*/#0A................if.
(ch>#3D0).putchar(ch);#0A................if(ch#3D#3D
13).{.ch.#3D.10;.putchar(10);.}#0A................f
flush(stdout);#0A#09#09/*PRINTFD("Sys_sardch.return
ing.ch.#3D.%d\n",.ch);.*/#0A................return.
ch;#0A..............}#0A#0A....case.Sys_sawrch:#0A#23
ifdef.forCYGWIN32#0A..............if(W[p+4].#3D#3D.
10).putchar(13);#0A#23endif#0A..............putchar
((char)W[p+4]);#0A..............fflush(stdout);#0A.
.............return.0;#0A#0A....case.Sys_read:../*.
bytesread.:#3D.sys(Sys_read,.fp,.buf,.bytecount).*/
#0A..............{.FILEPT.fp.#3D.findfp(W[p+4]);#0A
................BCPLWORD.bbuf.#3D.W[p+5]<<B2Wsh;#0A
................BCPLWORD.len...#3D.(int).W[p+6];#0A
#23ifndef.forWinCE#0A................clearerr(fp);.
/*.clear.eof.and.error.flag.*/#0A#23endif#0A.......
.........len.#3D.fread(&(BP.W)[bbuf],.(size_t)1,.(s
ize_t)len,.fp);#0A#23ifndef.forWinCE#0A............
....if(ferror(fp)).{.perror("sys_read");#0A........
.........................return.-1;./*.check.for.er
rors.*/#0A#09#09}#0A#23endif#0A................retu
rn.len;#0A..............}#0A#0A....case.Sys_write:#0A
......{.FILEPT.fp.#3D.findfp(W[p+4]);#0A........BCP
LWORD.bbuf.#3D.W[p+5]<<B2Wsh;#0A........BCPLWORD.le
n.#3D.W[p+6];#0A......../*fseek(fp,.0L,.SEEK_CUR);.
*/./*.Why??.MR.9/7/04.*/#0A........len.#3D.WD.fwrit
e(&(BP.W)[bbuf],.(size_t)1,.(size_t)len,.fp);#0A...
.....fflush(fp);#0A........return.len;#0A......}#0A
#0A....case.Sys_openread:#0A......{.char.*name.#3D.
b2c_fname(W[p+4],.chbuf1);#0A#09FILEPT.fp;#0A#23ifd
ef.VMSNAMES#0A#09name.#3D.vmsfname(name,.chbuf4);#0A
#23endif#0A#0A#09fp.#3D.pathinput(name,............
........../*.Filename.*/#0A#09...............b2c_st
r(W[p+5],.chbuf2));../*.Environment#0A#09......#09#09
#09#09.............variable.*/#0A........if(fp#3D#3D
0).return.0L;#0A........return.newfno(fp);#0A......
}#0A#0A....case.Sys_openwrite:#0A......{.char.*name
.#3D.b2c_fname(W[p+4],.chbuf1);#0A#09FILEPT.fp;#0A#23
ifdef.VMSNAMES#0A#09name.#3D.vmsfname(name,.chbuf4)
;#0A#23endif#0A........fp.#3D.fopen(name,."wb");#0A
........if(fp#3D#3D0).return.0L;#0A........return.n
ewfno(fp);#0A......}#0A#0A....case.Sys_openreadwrit
e:#0A......{.char.*name.#3D.b2c_fname(W[p+4],.chbuf
1);#0A#09FILEPT.fp;#0A#23ifdef.VMSNAMES#0A#09name.#3D
.vmsfname(name,.chbuf4);#0A#23endif#0A........fp.#3D
.fopen(name,."rb+");#0A........if(fp#3D#3D0).fp.#3D
.fopen(name,."wb+");#0A........if(fp#3D#3D0).return
.0L;#0A........return.newfno(fp);#0A......}#0A#0A..
..case.Sys_close:#0A......{.BCPLWORD.res.#3D.fclose
(findfp(W[p+4]));#0A........freefno(W[p+4]);#0A....
....return.res#3D#3D0.?.-1.:.0;./*.res#3D0.means.su
ccess.*/#0A......}#0A#0A....case.Sys_deletefile:#0A
......{.char.*name.#3D.b2c_fname(W[p+4],.chbuf1);#0A
#09FILEPT.fp;#0A#23ifdef.VMSNAMES#0A#09name.#3D.vms
fname(name,.chbuf4);#0A#09..{./*.Append.';*'.to.nam
e.*/#0A............int.len.#3D.0;#0A............whi
le.(name[len]).len++;#0A............name[len++].#3D
.';';#0A............name[len++].#3D.'*';#0A........
....name[len].#3D.0;#0A..........}#0A#23endif#0A...
.....return.!.REMOVE(name);#0A......}#0A#0A....case
.Sys_renamefile:#0A......{.char.*name1.#3D.b2c_fnam
e(W[p+4],.chbuf1);#0A........char.*name2.#3D.b2c_fn
ame(W[p+5],.chbuf2);#0A........int.len.#3D.0;#0A#23
ifdef.VMSNAMES#0A#09name1.#3D.vmsfname(name1,.chbuf
3);#0A#09name2.#3D.vmsfname(name2,.chbuf4);#0A#09..
{./*.Append.';*'.to.name2.*/#0A............while.(n
ame2[len]).len++;#0A............name2[len]...#3D.';
';#0A............name2[len+1].#3D.'*';#0A..........
..name2[len+2].#3D.0;#0A..........}#0A#23endif#0A..
......REMOVE(name2);#0A#23ifdef.VMSNAMES#0A........
name2[len].#3D.0;#0A#23endif#0A........return.!.ren
ame(name1,.name2);#0A......}#0A#0A....case.Sys_getv
ec:#0A..............{.BCPLWORD.tcb.#3D.W[rootnode+R
tn_crntask];#0A................BCPLWORD.*tn.#3D.&W[
tcb+Tcb_namebase];#0A#09........taskname[0].#3D.(tc
b#3D#3D0).?.0.:.tn[0];#0A#09........taskname[1].#3D
.(tcb#3D#3D0).?.0.:.tn[1];#0A#09........taskname[2]
.#3D.(tcb#3D#3D0).?.0.:.tn[2];#0A#09........tasknam
e[3].#3D.(tcb#3D#3D0).?.0.:.tn[3];#0A..............
..return.getvec(W[p+4]);#0A#09......}#0A#0A....case
.Sys_freevec:#0A................return.freevec(W[p+
4]);#0A#0A....case.Sys_loadseg:#0A..............{.B
CPLWORD.tcb.#3D.W[rootnode+Rtn_crntask];#0A........
........BCPLWORD.*tn.#3D.&W[tcb+Tcb_namebase];#0A..
..............char.*name.#3D.b2c_fname(W[p+4],.chbu
f2);#0A#09........taskname[0].#3D.(tcb#3D#3D0).?.0.
:.tn[0];#0A#09........taskname[1].#3D.(tcb#3D#3D0).
?.0.:.tn[1];#0A#09........taskname[2].#3D.(tcb#3D#3D
0).?.0.:.tn[2];#0A#09........taskname[3].#3D.(tcb#3D
#3D0).?.0.:.tn[3];#0A................return.loadseg
(name);#0A#09......}#0A#0A....case.Sys_globin:#0A..
..............return.globin(W[p+4],.g);#0A#0A....ca
se.Sys_unloadseg:#0A................unloadseg(W[p+4
]);....................return.0;#0A#0A....case.Sys_
muldiv:#0A..............{.BCPLWORD.res.#3D..muldiv(
W[p+4],.W[p+5],.W[p+6]);#0A................W[g+Gn_r
esult2].#3D.result2;#0A................return.res;#0A
..............}#0A#0A....case.Sys_intflag:#0A......
..........return.intflag().?.-1L.:.0L;#0A#0A....cas
e.Sys_setraster:#0A................return.setraster
(W[p+4],.W[p+5]);#0A#0A....case.Sys_cputime:./*.Ret
urn.CPU.time.in.milliseconds..*/#0A..............re
turn.muldiv(clock(),.1000,.TICKS_PER_SEC);#0A#0A#23
ifndef.forWinCE#0A....case.Sys_filemodtime:./*.Retu
rn.time.of.last.modification.of.file#0A............
.................whose.name.is.in.p[4]..*/#0A......
........{.struct.stat.buf;#0A................char.*
name.#3D.b2c_fname(W[p+4],.chbuf1);#0A#23ifdef.VMSN
AMES#0A#09......name.#3D.vmsfname(name,.chbuf4);#0A
#23endif#0A................if.(stat(name,.&buf)).re
turn.0;#0A................return.buf#2Est_mtime;#0A
..............}#0A#23endif#0A#0A....case.Sys_setpre
fix:./*.Set.the.file.prefix.string..*/#0A..........
....prefix.#3D.W[p+4];#0A..............return.prefi
x;#0A#0A....case.Sys_getprefix:./*.Return.the.file.
prefix.string..*/#0A..............return.prefix;#0A
#0A....case.Sys_graphics:./*.Perform.an.operation.o
n.the.graphics.window..*/#0A..............return.sy
sGraphics(p);#0A#0A....case.35:./*.Return.TRUE.if.n
o.keyboard.character.is.available.*/#0A#23ifdef.for
WinCE#0A..............return.chBufEmpty().?.-1.:.0;
#0A#23else#0A..............return.-1;#0A#23endif#0A
#0A....case.36:...return.0;./*.Spare.*/#0A#0A....ca
se.37:...return.0;./*.Spare..*/#0A#0A....case.Sys_s
eek:../*.res.:#3D.seek(fd,.pos)...*/#0A............
..{.FILEPT.fp.#3D.findfp(W[p+4]);#0A#09........BCPL
WORD.pos.#3D.W[p+5];#0A................BCPLWORD.res
.#3D.fseek(fp,.pos,.SEEK_SET);#0A................W[
g+Gn_result2].#3D.errno;#0A#09#09/*PRINTFD("fseek.p
os#3D%d.",.pos);.*/#0A#09#09/*PRINTFD("#3D>.res#3D%
d\n",.res);.*/#0A#09#09/*PRINTFD("errno#3D%d\n",.er
rno);.*/#0A................return.res#3D#3D0.?.-1.:
.0;./*.res#3D0.succ,.res#3D-1.error..*/#0A#09......
}#0A#0A....case.Sys_tell:./*.pos.:#3D.sys(Sys_tell,
fd)..*/#0A..............{.FILEPT.fp.#3D.findfp(W[p+
4]);#0A................BCPLWORD.pos.#3D.ftell(fp);#0A
................W[g+Gn_result2].#3D.errno;#0A#09#09
/*PRINTFD("tell.#3D>.%d\n",.pos);.*/#0A............
....return.pos;./*.>#3D0.succ,.-1#3Derror.*/#0A#09.
.....}#0A#0A....case.Sys_waitirq:./*.Wait.for.irq.*
/#0A............../*#0A................pthread_mute
x_lock..(.........&irq_mutex);#0A................pt
hread_cond_wait...(&irq_cv,.&irq_mutex);#0A........
........pthread_mutex_unlock(.........&irq_mutex);#0A
#09......*/#0A................return.0;#0A#0A....ca
se.Sys_lockirq:.../*.Stop.all.devices.from.modifyin
g.*/#0A......................../*.packets.or.genera
ting.interrupts.*/#0A....../*#0A................pth
read_mutex_lock..(.........&irq_mutex);#0A......*/#0A
................return.0;#0A#0A....case.Sys_unlocki
rq:./*.Allow.devices.to.modify.packets.*/#0A.......
................./*.and.generate.interrupts.*/#0A..
..../*#0A................pthread_mutex_unlock(.....
....&irq_mutex);#0A......*/#0A................retur
n.0;#0A#0A....case.Sys_devcom:./*.res.:#3D.sys(Sys_
devcom,.dcb,.com,.arg).*/#0A................return.
0;./*devcommand(W[p+4],.W[p+5],.W[p+6]);.*/#0A#0A..
..case.Sys_datstamp:./*.res.:#3D.sys(Sys_datstamp,.
v)..*/#0A....//.Set.v!0.#3D.days..since.1.January.1
970#0A....//.....v!1.#3D.msecs.since.midnight#0A...
.//.Return.-1.if.successful#0A................retur
n.timestamp(&W[W[p+4]]);#0A#0A....case.Sys_filesize
:../*.res.:#3D.sys(Sys_filesize,.fd)...*/#0A.......
.......{.FILEPT.fp...#3D.findfp(W[p+4]);#0A........
........long.pos..#3D.ftell(fp);#0A................
BCPLWORD.rc...#3D.fseek(fp,.0,.SEEK_END);#0A.......
.........BCPLWORD.size.#3D.ftell(fp);#0A...........
.....rc..#3D.fseek(fp,.pos,.SEEK_SET);#0A..........
......if.(rc).size.#3D.-1;#0A................return
.size;./*.>#3D0.succ,.-1#3Derror..*/#0A#09......}#0A
#0A....case.Sys_getsysval:./*.res.:#3D.sys(Sys_gets
ysval,.addr).*/#0A..............{.BCPLWORD.addr.#3D
.W[p+4];#0A................return.W[addr];#0A......
........}#0A#0A....case.Sys_putsysval:./*.res.:#3D.
sys(Sys_putsysval,.addr,.val).*/#0A..............{.
BCPLWORD.addr.#3D.W[p+4];#0A................W[addr]
.#3D.W[p+5];#0A................return.0;#0A........
......}#0A#0A#23ifndef.forWinCE#0A....case.Sys_shel
lcom:./*.res.:#3D.sys(Sys_shellcom,.comstr).*/#0A..
............{.BCPLWORD.comstr.#3D.W[p+4]<<B2Wsh;#0A
#09........int.i;#0A................char.com[256];#0A
................int.len.#3D.((char.*)W)[comstr];#0A
................for(i#3D0;.i<len;.i++).com[i].#3D.(
(char.*)W)[comstr+i+1];#0A................com[len].
#3D.0;#0A#09#09/*PRINTFS("\nmain:.calling.shell.com
mand.%s\n",.com);.*/#0A................return.syste
m(com);#0A..............}#0A#23endif#0A#0A#23ifndef
.forWinCE#0A....case.Sys_getpid:./*.res.:#3D.sys(Sy
s_getpid).*/#0A................return.getpid();#0A#23
endif#0A#0A....case.Sys_dumpmem:./*.sys(Sys_dumpmem
,.context).*/#0A................dumpmem(W,.memupb,.
W[p+4]);#0A................PRINTFD("\nMemory.dumped
.to.DUMP#2Emem,.context#3D%d\n",#0A................
........W[p+4]);#0A................return.0;#0A#0A.
...case.Sys_callnative:./*.res.:#3D.sys(Sys_callnat
ive,.fn,.a1,.a2,.a3).*/#0A..............{./*.Call.n
ative.code#2E.*/#0A................union.{./*.To.al
low.conversion.from.pointer.to.function.*/#0A#09#09
..BCPLWORD.*p;#0A#09#09..BCPLWORD(*f)(BCPLWORD,.BCP
LWORD,.BCPLWORD);#0A................}.func;#0A#0A..
..............func#2Ep.#3D.&W[W[p+4]];#0A..........
......return.(func#2Ef)(W[p+5],W[p+6],W[p+7]);#0A..
............}#0A#0A....case.Sys_platform:#0A.......
.......{./*.Return.platform.code,.0.if.unknown.*/#0A
#09#09BCPLWORD.res.#3D.0;#0A#23ifdef.forMAC#0A#09#09
res.#3D.1;#0A#23endif#0A#23ifdef.forMIPS#0A#09#09re
s.#3D.2;#0A#23endif#0A#23ifdef.forSGI#0A#09#09res.#3D
.3;#0A#23endif#0A#23ifdef.forARM#0A#09#09res.#3D.4;
#0A#23endif#0A#23ifdef.forLINUX#0A#09#09res.#3D.5;#0A
#23endif#0A#23ifdef.forLINUXamd64#0A#09#09res.#3D.6
;#0A#23endif#0A#23ifdef.forCYGWIN32#0A#09#09res.#3D
.7;#0A#23endif#0A#23ifdef.forLINUXPPC#0A#09#09res.#3D
.8;#0A#23endif#0A#23ifdef.forSUN4#0A#09#09res.#3D.9
;#0A#23endif#0A#23ifdef.forSPARC#0A#09#09res.#3D.10
;#0A#23endif#0A#23ifdef.forALPHA#0A#09#09res.#3D.11
;#0A#23endif#0A#23ifdef.forMSDOS#0A#09#09res.#3D.12
;#0A#23endif#0A#23ifdef.forOS2#0A#09#09res.#3D.13;#0A
#23endif#0A#23ifdef.forSHwinCE#0A#09#09res.#3D.14;#0A
#23endif#0A#23ifdef.forMIPSwinCE#0A#09#09res.#3D.15
;#0A#23endif#0A................return.res;#0A......
........}..............#0A#0A....case.Sys_inc:./*.n
ewval.:#3D.sys(Sys_inc,.ptr,.amount).*/#0A.........
.....{./*.!ptr.:#3D.!ptr.+.amount;.RESULTIS.!ptr.*/
#0A................return.W[W[p+4]].+#3D.W[p+5];#0A
..............}#0A#0A....case.Sys_buttons:./*.Retur
n.bit.pattern.of.buttons.currently#0A..............
............pressed.on.the.GP2X.*/#0A#23ifdef.forGP
2X#0A..............{.unsigned.long.buttons.#3D.0;#0A
#09........int.fd.#3D.open("/dev/GPIO",.O_RDWR.|.O_
NDELAY);#0A#09........if.(fd<0).return.-1;#0A......
..........if.(read(fd,.&buttons,.4).!#3D.4).return.
-2;#0A................close(fd);#0A................
return.(BCPLWORD)buttons;#0A..............}#0A#23el
se#0A..............return.-3;#0A#0A#23endif#0A#0A..
..case.Sys_delay:./*.sys(Sys_delay,.msecs).*/#0A#23
if.(defined(forWIN32).||.defined(forWinCE))#0A.....
.........{.unsigned.int.msecs.#3D.(unsigned.int)W[p
+4];#0A................Sleep(msecs);#0A............
....return.0;#0A..............}#0A#23else#0A.......
.......{.unsigned.int.msecs.#3D.(unsigned.int)W[p+4
];#0A................while(msecs>#3D1000).{#0A.....
.............usleep(990000);#0A..................ms
ecs.-#3D.990;#0A................}#0A...............
.if.(msecs<#3D0).return.0;#0A................usleep
(msecs*1000);#0A................return.0;#0A.......
.......}#0A#23endif#0A#0A....case.Sys_sound:./*.res
.:#3D.sys(Sys_sound,.fno,.a1,.a2,#2E#2E#2E).*/#0A#23
ifdef.SOUND#0A................return.soundfn(&W[p+4
],.&W[g]);#0A#23else#0A................return.0;#0A
#23endif#0A#0A....case.Sys_callc:./*.res.:#3D.sys(S
ys_callc,.fno,.a1,.a2,#2E#2E#2E).*/#0A#23ifdef.CALL
C#0A....../*#0A................printf("dosys:.sys(S
ys_callc,.%d,.%d,.%d,.#2E#2E#2E)\n",#0A............
............W[p+4],.W[p+5],.W[p+6]);#0A......*/#0A.
...............return.callc(&W[p+4],.&W[g]);#0A#23e
lse#0A................return.-1;#0A#23endif#0A#0A..
..case.Sys_trpush:./*.sys(Sys_trpush,.val).*/#0A...
.............trpush(W[p+4]);#0A................retu
rn.0;#0A#0A....case.Sys_settrcount:./*.res.:#3D.sys
(Sys_settrcount,.count).*/#0A................return
.settrcount(W[p+4]);#0A#0A....case.Sys_gettrval:./*
.res.:#3D.sys(Sys_gettrval,.count).*/#0A...........
.....return.gettrval(W[p+4]);#0A#0A#23ifndef.forWin
CE#0A....case.135:.{./*.Return.system.date.and.time
.in.VEC.5.*/#0A................time_t.clk.#3D.time(
0);#0A#09........struct.tm.*now.#3D.gmtime(&clk);#0A
#09........BCPLWORD.*arg.#3D.&W[W[p+4]];#0A........
........arg[0].#3D.now->tm_year+1900;#0A#09........
arg[1].#3D.now->tm_mon+1;#0A#09........arg[2].#3D.n
ow->tm_mday;#0A#09........arg[3].#3D.now->tm_hour;#0A
#09........arg[4].#3D.now->tm_min;#0A#09........arg
[5].#3D.now->tm_sec;#0A#09#09PRINTFD("%d.",..arg[0]
);#0A#09#09PRINTFD("%d.",..arg[1]);#0A#09#09PRINTFD
("%d.",..arg[2]);#0A#09#09PRINTFD("%d.",..arg[3]);#0A
#09#09PRINTFD("%d.",..arg[4]);#0A#09#09PRINTFD("%d\
n",.arg[5]);#0A................return.0;#0A........
......}#0A#23endif#0A#0A..}#0A..return.0;#0A}#0A#0A
BCPLWORD.timestamp(BCPLWORD.*v).{#0A..//.Set.v[0].#3D
.days.since.1.January.1970#0A..//.....v[1].#3D.msec
s.since.midnight#0A..//.Return.-1.if.successful#0A#23
if.defined(forWinCE).||.defined(forMacOSPPC)#0A..v[
0]#3Dv[1]#3D0;#0A..return.0;.../*.To.indicate.failu
re.*/#0A#23else#0A..unsigned.int.days..#3D.0;#0A..B
CPLINT64....secs.#3D.0;#0A..unsigned.int.msecs.#3D.
0;#0A#0A..const.unsigned.int.secsperday.#3D.60*60*2
4;#0A#0A#23if.defined(forWIN32).||.defined(forCYGWI
N32).||.defined(forLINUX)#0A..{.//.Code.for.Windows
,.Cygwin.and.Linux#0A....//.ftime.is.obsolete.and.t
he.advice.is.to.use#0A....//.gettimeofday.or.clock_
gettime#0A....//.neither.of.these.are.widely.availa
ble.yet#2E#0A....struct.timeb.tb;#0A....ftime(&tb);
#0A....secs.#3D.tb#2Etime;#0A....//if(tb#2Edstflag)
.secs.+#3D.60*60;#0A....secs.-#3D.tb#2Etimezone.*.6
0;#0A....//printf("tb#2Edstflag#3D%d.tb#2Etimezone#3D
%d\n",.tb#2Edstflag,.tb#2Etimezone);#0A....msecs.#3D
.tb#2Emillitm;#0A..}#0A#23else#0A..//.Code.for.syst
ems.having.the.function.gettimeofday#2E#0A..struct.
timeval.tv;#0A..gettimeofday(&tv,.NULL);#0A..secs.#3D
.tv#2Etv_sec;#0A..msecs.#3D.tv#2Etv_usec./.1000;#0A
..secs.+#3D.60*60;...../*.Fudge.--.Add.one.hour.for
.BST.*/#0A#23endif#0A#0A..//.secs..#3D.seconds.sinc
e.1.January.1970#0A..//.msecs.#3D.micro.seconds.sin
ce.start.of.current.second#0A#0A..secs.+#3D.W[rootn
ode+Rtn_adjclock].*.60;./*.Add.adjustment.*/#0A#0A.
.days..+#3D.secs./.secsperday;.//.convert.secs.to.d
ays#0A..secs..%#3D.secsperday;.//.Seconds.since.mid
night#0A..msecs.+#3D.secs*1000;..//.milliseconds.si
nce.midnight#0A#0A..v[0].#3D.days;..//.days..since.
on.1.January.1970#0A..v[1].#3D.msecs;.//.msecs..sin
ce.midnight#0A..//..printf("days#3D%d.msecs#3D%d\n"
,.days,.msecs);#0A..return.-1;.../*.To.indicate.suc
cess.*/#0A#23endif#0A}#0A#0Achar.*vmsfname(char.*na
me,.char.*vmsname).{#0A/*#0AThis.function.converts.
a.BCPL.filename.to.a.VMS.filename#0AExamples:#0A#0A
Name.......................VMS.name#0A#0Aecho#2Eb..
...................echo#2Eb#0Acom/echo#2Eb.........
........[#2Ecom]echo#2Eb#0A/mrich177/distribution/b
cpl/g/libhdr#2Eh#0A...........................[mric
h177#2Edistribution#2Ebcpl#2Eg]libhdr#2Eh#0Avd10$di
sk:/mrich177/junk#2Eb.vd10$disk:[mrich177]junk#2Eb#0A
#2E#2E/cintcode/com/bcplfe#2Eb...[-#2Ecintcode#2Eco
m]bcplfe#2Eb#0A*/#0A..int.ch;#0A..int.i#3D0;.//.Nex
t.character.in.name#0A..int.j#3D0;.//.Next.characte
r.in.vmsname#0A..int.lastslashpos#3D-1;.//.Position
.of.last.slash.in.name#0A#0A../*.If.name.contains.a
.colon,.copy.all#0A.....characters.up.to.and.includ
ing.the.colon#2E#0A..*/#0A..while.(1).{#0A....int.c
h.#3D.name[i];#0A....if.(ch#3D#3D0).{#0A....../*.No
.colon.in.name.*/#0A......i.#3D.0;#0A......break;#0A
....}#0A....if.(ch#3D#3D':').{#0A....../*.Copy.up.t
o.and.including.the.colon.*/#0A......while.(j<#3Di)
.{.vmsname[j].#3D.name[j];.j++;.}#0A......i.#3D.j;#0A
......break;#0A....}#0A....i++;#0A..}#0A../*.Find.p
osition.of.last.slash,.if.any.*/#0A..while.(1).{#0A
....int.ch.#3D.name[i];#0A....if(ch#3D#3D0).break;#0A
....if(ch#3D#3D'/').lastslashpos.#3D.i;#0A....i++;#0A
..}#0A#0A../*.No.slashes..#3D>.nothing#0A.....Leadi
ng./...#3D>.[#0A.....Slashes.but.no.leading.slash.s
o.insert.[#2E.or.[-#0A#0A.....name.is.then.copied.c
onverting.all.slashes.except.the.leading#0A.....and
.last.ones.to.dots,.and.converting.the.last.slash.t
o.]#2E#0A..*/#0A..i.#3D.j;#0A..if(name[i]#3D#3D'/')
.{#0A..../*.if.leading.slash.but.not.the.last.conve
rt.it.to.[.*/#0A....if.(i!#3Dlastslashpos).vmsname[
j++].#3D.'[';#0A..../*.Otherwise.skip.over.this.lea
ding.slash.*/#0A....i++;#0A..}.else.{#0A....if.(las
tslashpos>#3D0).{#0A....../*.Slashes.but.no.leading
.slash,.so.insert.[#2E.or.[-..*/#0A......vmsname[j+
+].#3D.'[';#0A......if(name[i]!#3D'#2E'.||.name[i+1
]!#3D'#2E').{#0A........vmsname[j++].#3D.'#2E';#0A.
.....}#0A....}#0A..}#0A#0A..while.(1).{#0A..../*.Co
py.characters#0A.......replacing.last./......by.]#0A
.......and.......non.last./..by.#2E#0A.......and...
....#2E#2E..........by.-#0A....*/#0A....int.ch.#3D.
name[i];#0A....if(ch#3D#3D'#2E'.&&.name[i+1]#3D#3D'
#2E').{#0A....../*.Convert.#2E#2E.to.-.*/#0A......c
h.#3D.'-';#0A......i++;#0A....}#0A....if(ch#3D#3D'/
').{#0A......if.(i#3D#3Dlastslashpos).ch.#3D.']';#0A
......else.................ch.#3D.'#2E';#0A....}#0A
....vmsname[j++].#3D.ch;#0A....if(ch#3D#3D0).break;
#0A....i++;#0A..}#0A../*#0A..printf("vmsfname.of.%s
\n",.name);#0A..printf("gives:......%s\n",.vmsname)
;#0A..*/#0A#0A..return.vmsname;#0A}#0A#0A/*.b2c_fna
me.converts.the.BCPL.string.for.a.file.name.to.a.C.
character#0A**.string#2E..The.character.'/'.(or.'\'
).is.treated.as.a.separator.and.is#0A**.converted.t
o.FILE_SEP_CH.('/'.for.unix,.'\'.for.MSDOS.or.':'.f
or.MAC)#2E#0A**.If.prefix.is.set.and.the.filename.i
s.relative,.the.prefix.is.prepended#2E#0A*/#0Achar.
*b2c_fname(BCPLWORD.bstr,.char.*cstr)#0A{.BCPLWORD.
bp.#3D.bstr<<B2Wsh;#0A..int.len.#3D.(BP.W)[bp++];#0A
..int.i#3D0;#0A..if.(bstr#3D#3D0).return.0;#0A..if.
(prefix.&&.relfilename(b2c_str(bstr,.chbuf3)))#0A..
{./*.Prepend.the.filename.with.prefix.*/#0A....BCPL
WORD.pfxp.#3D.prefix<<B2Wsh;#0A....int.pfxlen.#3D.(
BP.W)[pfxp++];#0A....while(pfxlen--)#0A....{.char.c
h.#3D.(BP.W)[pfxp++];#0A......if(ch#3D#3D'/'.||.ch#3D
#3D'\\').ch.#3D.FILE_SEP_CH;#0A......cstr[i++].#3D.
ch;#0A....}#0A....if.(cstr[i-1].!#3D.FILE_SEP_CH).c
str[i++].#3D.FILE_SEP_CH;#0A..}#0A#0A..while.(len--
)#0A..{.char.ch.#3D.(BP.W)[bp++];#0A....if(ch#3D#3D
'/'.||.ch#3D#3D'\\').ch.#3D.FILE_SEP_CH;#0A....cstr
[i++].#3D.ch;#0A..}#0A..cstr[i].#3D.0;#0A../*if.(pr
efix).{.PRINTFS("filename.#3D.%s\n",.cstr);.busywai
t(2000);.}.*/#0A..return.cstr;#0A}#0A#0A/*.b2c_str.
converts.a.BCPL.string.to.a.C.character.string#2E.*
/#0Achar.*b2c_str(BCPLWORD.bstr,.char.*.cstr)#0A{..
BCPLWORD.bp.#3D.bstr<<B2Wsh;#0A...char.*p.#3D.cstr;
#0A...int.len.#3D.(BP.W)[bp++];#0A...if.(bstr#3D#3D
0).return.0;#0A...while.(len--).*p++.#3D.(BP.W)[bp+
+];#0A...*p.#3D.0;#0A...return.cstr;#0A}#0A#0A/*.sy
scin2b_str.converts.a.syscin.filename.string.to.a.B
CPL.string#2E.*/#0ABCPLWORD.syscin2b_str(char.*cstr
,.BCPLWORD.bstr)#0A{..char.*prfx.#3D."syscin/";....
/*.System.cin.directory.*/#0A...char.*bp.#3D.&(BP.W
)[bstr<<B2Wsh];#0A...int.len.#3D.0;#0A...int.i.#3D.
0;#0A...while.(prfx[i]).{.bp[++len].#3D.prfx[i++];.
}#0A...i.#3D.0;#0A...while.(cstr[i]).{.bp[++len].#3D
.cstr[i++];.}#0A...bp[0].#3D.len;#0A...return.bstr;
#0A}#0A#0A/*.catstr2c_str.concatenates.two.optional
.C.strings.into.str#2E.*/#0Achar.*catstr2c_str(char
.*cstr1,.char.*cstr2,.char.*str).{#0A..char.*p.#3D.
str;#0A..if.(cstr1)#0A....while(*cstr1).*p++.#3D.*c
str1++;#0A..if.(cstr1)#0A....while(*cstr2).*p++.#3D
.*cstr2++;#0A..*p.#3D.0;#0A..return.str;#0A}#0A#0Av
oid.wrcode(char.*form,.BCPLWORD.f,.BCPLWORD.a)#0A{.
.wrfcode(f);#0A...PRINTF.("..");#0A...PRINTFD(form,
.(long)a);#0A...PRINTF.("\n");#0A}.#0A#0Avoid.wrfco
de(BCPLWORD.f)#0A{.char.*s;#0A..int.i,.n.#3D.(f>>5)
.&.7;#0A..switch((int)f&31)#0A..{.default:#0A....ca
se..0:.s.#3D.".....-.....K...LLP.....L....LP....SP.
...AP.....A";.break;#0A....case..1:.s.#3D.".....-..
..KH..LLPH....LH...LPH...SPH...APH....AH";.break;#0A
....case..2:.s.#3D."...BRK....KW..LLPW....LW...LPW.
..SPW...APW....AW";.break;#0A....case..3:.s.#3D."..
..K3...K3G..K3G1..K3GH...LP3...SP3...AP3..L0P3";.br
eak;#0A....case..4:.s.#3D."....K4...K4G..K4G1..K4GH
...LP4...SP4...AP4..L0P4";.break;#0A....case..5:.s.
#3D."....K5...K5G..K5G1..K5GH...LP5...SP5...AP5..L0
P5";.break;#0A....case..6:.s.#3D."....K6...K6G..K6G
1..K6GH...LP6...SP6...AP6..L0P6";.break;#0A....case
..7:.s.#3D."....K7...K7G..K7G1..K7GH...LP7...SP7...
AP7..L0P7";.break;#0A....case..8:.s.#3D."....K8...K
8G..K8G1..K8GH...LP8...SP8...AP8..L0P8";.break;#0A.
...case..9:.s.#3D."....K9...K9G..K9G1..K9GH...LP9..
.SP9...AP9..L0P9";.break;#0A....case.10:.s.#3D."...
K10..K10G.K10G1.K10GH..LP10..SP10..AP10.L0P10";.bre
ak;#0A....case.11:.s.#3D."...K11..K11G.K11G1.K11GH.
.LP11..SP11..AP11.L0P11";.break;#0A....case.12:.s.#3D
."....LF...S0G..S0G1..S0GH..LP12..SP12..AP12.L0P12"
;.break;#0A....case.13:.s.#3D."...LF$...L0G..L0G1..
L0GH..LP13..SP13.XPBYT.....S";.break;#0A....case.14
:.s.#3D."....LM...L1G..L1G1..L1GH..LP14..SP14...LMH
....SH";.break;#0A....case.15:.s.#3D."...LM1...L2G.
.L2G1..L2GH..LP15..SP15...BTC..MDIV";.break;#0A....
case.16:.s.#3D."....L0....LG...LG1...LGH..LP16..SP1
6...NOP.CHGCO";.break;#0A....case.17:.s.#3D."....L1
....SG...SG1...SGH...SYS....S1....A1...NEG";.break;
#0A....case.18:.s.#3D."....L2...LLG..LLG1..LLGH...S
WB....S2....A2...NOT";.break;#0A....case.19:.s.#3D.
"....L3....AG...AG1...AGH...SWL....S3....A3..L1P3";
.break;#0A....case.20:.s.#3D."....L4...MUL...ADD...
.RV....ST....S4....A4..L1P4";.break;#0A....case.21:
.s.#3D."....L5...DIV...SUB...RV1...ST1...XCH....A5.
.L1P5";.break;#0A....case.22:.s.#3D."....L6...REM..
.LSH...RV2...ST2..GBYT..RVP3..L1P6";.break;#0A....c
ase.23:.s.#3D."....L7...XOR...RSH...RV3...ST3..PBYT
..RVP4..L2P3";.break;#0A....case.24:.s.#3D."....L8.
...SL...AND...RV4..STP3...ATC..RVP5..L2P4";.break;#0A
....case.25:.s.#3D."....L9...SL$....OR...RV5..STP4.
..ATB..RVP6..L2P5";.break;#0A....case.26:.s.#3D."..
.L10....LL...LLL...RV6..STP5.....J..RVP7..L3P3";.br
eak;#0A....case.27:.s.#3D."..FHOP...LL$..LLL$...RTN
..GOTO....J$.ST0P3..L3P4";.break;#0A....case.28:.s.
#3D."...JEQ...JNE...JLS...JGR...JLE...JGE.ST0P4..L4
P3";.break;#0A....case.29:.s.#3D."..JEQ$..JNE$..JLS
$..JGR$..JLE$..JGE$.ST1P3..L4P4";.break;#0A....case
.30:.s.#3D."..JEQ0..JNE0..JLS0..JGR0..JLE0..JGE0.ST
1P4.....-";.break;#0A....case.31:.s.#3D.".JEQ0$.JNE
0$.JLS0$.JGR0$.JLE0$.JGE0$....MW.....-";.break;#0A.
.}#0A#0A..for(i.#3D.6*n;.i<#3D6*n+5;.i++).putchar(s
[i]);#0A}.#0A#0Avoid.trval(BCPLWORD.w).{#0A..int.gw
.#3D.w.&.0xFFFF0000;#0A..int.gn.#3D.w.&.0x0000FFFF;
#0A....if(gw#3D#3DGlobword.&&.gn<#3D1000).{#0A.....
.PRINTFD(".....#23G%03d#23.",.gn);#0A....}.else.{#0A
......if(-10000000<#3Dw.&&.w<#3D10000000).{#0A.....
...PRINTFD(".%10ld.",.(long)w);#0A......}.else.{#0A
........PRINTFD(".#23x%8x.",.(long)w);#0A......}#0A
....}#0A}#0A#0Avoid.trace(BCPLWORD.pc,.BCPLWORD.p,.
BCPLWORD.a,.BCPLWORD.b)#0A{.PRINTFD("%9ld:.",.(long
)pc);#0A..PRINTFD("A#3D");.trval(a);#0A..PRINTFD("B
#3D");.trval(b);#0A..PRINTFD("P#3D%5ld.",.(long)p);
#0A..wrcode("(%3ld)",.WD.(BP.W)[pc],.WD.(BP.W)[pc+1
]);#0A..putchar(13);#0A}#0A#0Avoid.dumpmem(BCPLWORD
.*mem,.BCPLWORD.upb,.BCPLWORD.context)#0A{.FILEPT.f
p;#0A..BCPLWORD.count.#3D.upb;#0A..BCPLWORD.p#3D0,.
q,.r#3D0;#0A..int.len.#3D.0;#0A..BCPLWORD.datstamp[
2];#0A#0A..fp.#3D.fopen("DUMP#2Emem",."wb");#0A..if
(fp#3D#3D0).goto.bad;#0A#0A..mem[rootnode.+.Rtn_las
tp]...#3D.lastWp-W;#0A..mem[rootnode.+.Rtn_lastg]..
.#3D.lastWg-W;#0A..mem[rootnode.+.Rtn_lastst]..#3D.
lastst;#0A#0A..mem[rootnode.+.Rtn_context].#3D.cont
ext;#0A../*.context.#3D.1...SIGINT.received........
.........(lastp,.lastg)#0A..**.context.#3D.2...SIGS
EGV.received................(lastp,.lastg)#0A..**.c
ontext.#3D.3...fault.while.running.boot........(boo
tregs)#0A..**.context.#3D.4...user.called.sys(Sys_q
uit,.-2)...(klibregs)#0A..**.context.#3D.5...fault.
while.user.running........(klibregs)#0A..*/#0A#0A..
datstamp[0]#3Ddatstamp[1]#3D0;#0A..timestamp(datsta
mp);#0A..mem[rootnode.+.Rtn_days]..#3D.datstamp[0];
.//.days#0A..mem[rootnode.+.Rtn_msecs].#3D.datstamp
[1];.//.msecs#0A#0A../*.Write.out.size.of.cintcode.
memory.*/#0A../*PRINTFD("\n%8d.Memory.upb\n",.upb);
.*/#0A..len.#3D.fwrite((char*)&count,.(size_t)4,.(s
ize_t)1,.fp);#0A..if(len!#3D1).goto.bad;#0A#0A..whi
le(r<#3Dupb)#0A..{.BCPLWORD.dataword.#3D.mem[r];#0A
....q.#3D.r;#0A....while(r<#3Dupb.&&.mem[++r]#3D#3D
dataword).continue;#0A....if(r<#3Dupb.&&.r-q.<.200)
.continue;#0A#0A..../*.mem[p]#2E#2Emem[q-1].is.the.
block#0A....**.mem[q]#2E#2Emem[r-1].are.repeated.oc
currences.of.dataword#0A....**.Write.out.count.of.w
ords.in.next.block#0A....*/#0A....count.#3D.q-p;./*
.count>#3D0.*/#0A....if(count)#0A....{./*PRINTFD("%
8d.BLOCK\n",.count);.*/#0A......len.#3D.fwrite((cha
r*)&count,.(size_t)4,.(size_t)1,.fp);#0A......if(le
n!#3D1).goto.bad;#0A......len.#3D.fwrite((char*)&me
m[p],.(size_t)4,.(size_t)count,.fp);#0A......if(len
!#3Dcount).goto.bad;#0A....}#0A#0A..../*.Write.out.
repetition.count.(negated).followed.by.the.data.wor
d.*/#0A....count.#3D.q-r;./*.count<#3D0.*/#0A....if
(count).{#0A....../*printf("%8d.x.%8X\n",.-count,.d
ataword);.*/#0A......len.#3D.fwrite((char*)&count,.
...(size_t)4,.(size_t)1,.fp);#0A......if(len!#3D1).
goto.bad;#0A......len.#3D.fwrite((char*)&dataword,.
(size_t)4,.(size_t)1,.fp);#0A......if(len!#3D1).got
o.bad;#0A....}#0A#0A....p.#3D.r;#0A..}#0A#0A.bad:#0A
..if(fp).fclose(fp);#0A../*PRINTFD("\nMemory.dumped
.to.DUMP#2Emem,.context#3D%d\n",.context);.*/#0A..r
eturn;.#0A}#0A#0Avoid.trpush(BCPLWORD.val).{#0A..//
.If.trcount>#3D0.push.val.into.the.circular.trace.b
uffer#0A..//.Note.that.trpush.is.disabled.if.trcoun
t#3D-1#0A../*..pthread_mutex_lock(&trpush_mutex);.*
/#0A..if(trcount>#3D0).{#0A#23if.defined(forWinCE).
||.defined(forMacOSPPC)#0A#23else#0A....BCPLWORD.v[
2];#0A....BCPLWORD.msecs;#0A....timestamp(v);#0A...
.msecs.#3D.v[1];./*.milli-seconds.since.midnight.*/
#0A....//.Push.the.time.stamp:.ss#2Emmm#0A....trvec
[trcount++.&.4095].#3D.0x66000000.+.msecs%60000;#0A
#23endif#0A....trvec[trcount++.&.4095].#3D.val;#0A.
.}#0A../*..pthread_mutex_unlock(&trpush_mutex);.*/#0A
}#0A#0ABCPLWORD.settrcount(BCPLWORD.count).{#0A..//
.Set.trcount.returning.the.previous.value#0A..BCPLW
ORD.res;#0A../*.pthread_mutex_lock(&trpush_mutex);.
*/#0A..res.#3D.trcount;#0A..trcount.#3D.count;#0A..
/*.pthread_mutex_unlock(&trpush_mutex);.*/#0A..retu
rn.res;#0A}#0A#0ABCPLWORD.gettrval(BCPLWORD.count).
{#0A..//.Return.the.trace.value.corresponding.to.po
sition.count#2E#0A..//.The.result.is.only.valid.if.
the.circular.buffer.has.not.overflowed#0A..BCPLWORD
.res;#0A..//pthread_mutex_lock(&trpush_mutex);#0A..
res.#3D.trvec[count.&.4095];#0A..//pthread_mutex_un
lock(&trpush_mutex);#0A..return.res;#0A}#0A#0A#23if
def.SOUND#0A#23include."soundfn#2Ec"#0A#23endif#0A

######cintcode/sysc/cintsys.h#
/*.This.header.file.contains.machine/system.depende
nt.#23defines#0A**.These.are.dependent.on.the.-D.pa
rameter.specified.in.Makefile#2E#0A**.The.possible.
-D.parameters.are:#0A**#0A**..-DforMAC...........fo
r.Apple.MAC.(not.recently.tested)#0A**..-DforMIPS..
........for.DEC.R2000/3000.Workstations.under.Ultri
x.4#2E3#0A**..-DforSGI...........for.SGI.MIPS.machi
nes.under.Ultrix#0A**..-DforARM...........for.ARM.u
nder.RISC.OS.(under.development)#0A**..-DforLINUX..
.......for.Linux.on.a.Pentium#0A**..-DforVmsItanium
....for.the.Itanium.under.VMS#0A**..-DforVmsVax....
....for.the.Vax.under.VMS#0A**..-DforLINUX64.......
for.64-bit.Linux#0A**..-DforGP2X..........for.the.G
P2X.handheld.Linux.gaming.machine#0A**..-DforLINUXA
MD64....for.Linux.on.the.AMD.64#0A**..-DforLINUXPPC
......for.Linux.on.a.PowerMac.G4#0A**..-DforMacOSPP
C......for.Mac.OS.X.on.a.Mac.Power.PC.G4#0A**..-Dfo
rSUN4..........for.Sun4m.under.SunOS.4#2E1#2E3#0A**
..-DforSPARC.........for.Sun4m.spac.under.SunOS.5#2E
4#0A**..-DforALPHA.........for.DEC.Alpha.under.OSF1
.V3#2E2.17#0A**..-DforMSDOS.........for.MSDOS.32.bi
t.protected.mode.usinf.Borland.C.v4#2E0#0A**..-Dfor
Win32.........for.Windows.(eg.XP).using.Microsoft.V
isual.C#0A**..-DforCYGWIN32......for.Windows.(eg.XP
).using.GNU.Cygnus.Solutions#0A**..-DforBC4........
...for.Windows.(eg.XP).using.Borland.C.4#2E0.and.TA
SM#0A**..-DforOS2...........for.OS/2.V2#2E1.using.C
set/2.and.Borland.Tasm#0A**..-DforSHwinCE.......for
.WinCE.2#2E0.(SH3.processor)#0A*/#0A#0A/*.INT#2Eh.i
s.created.by.mkint-h.(source.mkint-h#2Ec),.it.defin
es#0A**.the.macros.BCPLINT32.and.BCPLINT64#0A*/#0A#23
include."INT#2Eh"#0A#0A#0A#23ifndef.forWinCE#0A#23i
nclude.<stdio#2Eh>#0A#23include.<stdlib#2Eh>#0A#23i
nclude.<string#2Eh>#0A#23include.<signal#2Eh>#0A#23
include.<time#2Eh>#0A#23include.<errno#2Eh>#0A#23en
dif#0A#0A/*.For.32-bit.implementations.--.uncomment
.the.following.*/#0A#23define.B2Wsh.2#0A#23define.B
perW.32#0A#23define.BCPLWORD.BCPLINT32#0A#0A/*.For.
64-bit.implementations.--.uncomment.the.following.*
/#0A/*#0A#23define.B2Wsh.3#0A#23define.BperW.64#0A#23
define.BCPLWORD.BCPLINT64#0A*/#0A#0A#0A/*.The.MAC.v
ersion.just.about.works.on.a.Power.Macintosh.7100/6
6#0A**.using.Symantec.Think.C.6#2E0#0A**.I.used.cin
tsys#2Ec.cinterp#2Ec.kblib#2Ec.and.nullrastlib#2Ec.
linked#0A**.with.the.standard.libraries.ANSI.and.un
ix#2E.The.partition.size.was.5000K#0A**.and.#23defi
ne.forMAC.was.edited.into.this.file#2E.(I.don't.kno
w.how.to#0A**.get.Think.C.to.do.that.#23definition.
for.me)#2E#0A**.The.command.command.files.bc.bs.bp.
bco.and.bso.had.to.be.edited.to#0A**.change./s.to.:
s.and.#2E#2E/.to.::.etc#2E.These.versions.are.in.sy
s/MAC#2E#0A**.If.someone.would.suggest.how.to.get.a
.visible.cursor.I.would.be.grateful#2E#0A*/#0A#0A/*
#0A**.Cintsys/Cintpos.and.cinterp.need.the.type.sig
ned.char.but.this.is#0A**.not.available.on.all.impl
ementations.of.C#2E.On.some.the.type.char#0A**.is.s
igned,.and.on.some.(if.fact.most).signed.char.is.al
lowed#2E#0A**.Comment.out.of.the.following.definiti
ons.of.SIGNEDCHAR#2E.A.test.in#0A**.the.function.ba
dimplementation.will.determine.whether.you.have.mad
e#0A**.the.right.choice#2E#0A*/#0A#0A#23define.UNSI
GNEDCHAR.unsigned.char#0A#23define.SIGNEDCHAR.signe
d.char#0A/*.#23define.SIGNEDCHAR.char.*/#0A#0A#0A/*
.Note.that#0A**...#23define.CINTASM.cintasm........
will.use.a.hand.written.cintcode#0A**..............
....................interpreter.in.addition.to.the#0A
**..................................one.implemented
.in.C#2E#0A**...#23define.CINTASM.interpreter....wi
ll.only.use.the.interperter#0A**...................
...............written.in.C,.this.typically.runs#0A
**..................................2-3.times.slowe
r#2E#0A*/#0A#0A/*#0A**.CINTASM.is.now.always.define
d.to.be.cintasm#2E.The.function.cintasm#0A**.is.eit
her.defined.in.files.such.as.sysasm/LINUX/cintasm#2E
s.of#0A**.in.cinterp#2Ec.when.compiled.with.FASTyes
.defined#2E#0A*/#0A#23define.CINTASM.cintasm#0A#0A#23
define.UNSIGNEDCHAR.unsigned.char#0A#23define.SIGNE
DCHAR.signed.char#0A/*.#23define.SIGNEDCHAR.char.*/
#0A#0A#23ifdef.forMAC#0A#23include.<unix#2Eh>#0A#23
include.<time#2Eh>#0A#23include.<sys/timeb#2Eh>#0A#23
define.MALLOC(n).malloc((n)<<B2Wsh)#0A#23define.TIC
KS_PER_SEC.(CLOCKS_PER_SEC)#0A#23define.REMOVE.unli
nk#0A#23define.FILE_SEP_CH.':'#0A#23define.BIGENDER
#0A#23endif#0A#0A#23ifdef.forMIPS#0A#23include.<sys
/types#2Eh>#0A#23include.<sys/stat#2Eh>#0A#23includ
e.<time#2Eh>#0A#23include.<sys/timeb#2Eh>#0A#23defi
ne.MALLOC(n).malloc((n)<<B2Wsh)#0A#23define.TICKS_P
ER_SEC.(CLOCKS_PER_SEC)#0A#23define.REMOVE.unlink#0A
#23define.FILE_SEP_CH.'/'#0A#23endif#0A#0A#23ifdef.
forSGI#0A#23include.<sys/types#2Eh>#0A#23include.<s
ys/stat#2Eh>#0A#23include.<time#2Eh>#0A#23include.<
sys/timeb#2Eh>#0A#23define.MALLOC(n).malloc((n)<<B2
Wsh)#0A#23define.TICKS_PER_SEC.(CLOCKS_PER_SEC)#0A#23
define.REMOVE.unlink#0A#23define.FILE_SEP_CH.'/'#0A
#23endif#0A#0A#23ifdef.forARM#0A#23include.<sys/typ
es#2Eh>#0A#23include.<sys/stat#2Eh>#0A#23include.<t
ime#2Eh>#0A#23include.<sys/timeb#2Eh>#0A#23define.M
ALLOC(n).malloc((n)<<B2Wsh)#0A#23define.TICKS_PER_S
EC.(CLOCKS_PER_SEC)#0A#23define.REMOVE.unlink#0A#23
define.FILE_SEP_CH.'/'#0A#23endif#0A#0A#23ifdef.for
LINUX#0A#23include.<sys/stat#2Eh>#0A#23include.<tim
e#2Eh>#0A#23include.<fcntl#2Eh>#0A#23include.<sys/w
ait#2Eh>#0A#23include.<sys/time#2Eh>#0A#23include.<
sys/timeb#2Eh>#0A#23ifdef.SOUND#0A#23include.<sys/i
octl#2Eh>#0A#23include.<sys/unistd#2Eh>#0A#23includ
e.<sys/fcntl#2Eh>#0A#23include.<sys/soundcard#2Eh>#0A
#23endif#0A#23define.MALLOC(n).malloc((n)<<B2Wsh)#0A
#23define.TICKS_PER_SEC.(CLOCKS_PER_SEC)#0A#23defin
e.REMOVE.unlink#0A#23define.FILE_SEP_CH.'/'#0A#23en
dif#0A#0A#23ifdef.forVmsItanium#0A#23define.VMSNAME
S#0A#23include.<stat#2Eh>#0A#23include.<time#2Eh>#0A
#23include.<fcntl#2Eh>#0A#23include.<wait#2Eh>#0A#23
include.<time#2Eh>#0A#23include.<timeb#2Eh>#0A#23in
clude.<unistd#2Eh>#0A#23define.MALLOC(n).malloc((n)
<<B2Wsh)#0A#23define.TICKS_PER_SEC.(1000)#0A#23defi
ne.REMOVE.unlink#0A#23define.FILE_SEP_CH.'/'#0A#23e
ndif#0A#0A#23ifdef.forVmsVax#0A#23define.VMSNAMES#0A
#23include.<stat#2Eh>#0A#23include.<time#2Eh>#0A#23
include.<fcntl#2Eh>#0A#23include.<wait#2Eh>#0A#23in
clude.<time#2Eh>#0A#23include.<timeb#2Eh>#0A#23incl
ude.<unistd#2Eh>#0A#23define.MALLOC(n).malloc((n)<<
B2Wsh)#0A#23define.TICKS_PER_SEC.(1000)#0A#23define
.REMOVE.unlink#0A#23define.FILE_SEP_CH.'/'#0A#23end
if#0A#0A#23ifdef.forGP2X#0A#23include.<sys/stat#2Eh
>#0A#23include.<time#2Eh>#0A#23include.<fcntl#2Eh>#0A
#23include.<sys/wait#2Eh>#0A#23include.<sys/time#2E
h>#0A#23include.<sys/timeb#2Eh>#0A#23define.MALLOC(
n).malloc((n)<<B2Wsh)#0A#23define.TICKS_PER_SEC.(CL
OCKS_PER_SEC)#0A#23define.REMOVE.unlink#0A#23define
.FILE_SEP_CH.'/'#0A#23endif#0A#0A#23ifdef.forLINUXA
MD64#0A#23include.<sys/stat#2Eh>#0A#23include.<time
#2Eh>#0A#23include.<sys/timeb#2Eh>#0A#23define.MALL
OC(n).malloc((n)<<B2Wsh)#0A#23define.TICKS_PER_SEC.
(CLOCKS_PER_SEC)#0A#23define.REMOVE.unlink#0A#23def
ine.FILE_SEP_CH.'/'#0A#23endif#0A#0A#23ifdef.forMac
OSPPC#0A#23include.<sys/stat#2Eh>#0A#23include.<tim
e#2Eh>#0A#23include.<sys/timeb#2Eh>#0A#23define.MAL
LOC(n).malloc((n)<<B2Wsh)#0A#23define.TICKS_PER_SEC
.(CLOCKS_PER_SEC)#0A#23define.REMOVE.unlink#0A#23de
fine.FILE_SEP_CH.'/'#0A#23define.BIGENDER#0A#23endi
f#0A#0A#23ifdef.forCYGWIN32#0A#23include.<sys/stat#2E
h>#0A#23include.<time#2Eh>#0A#23include.<sys/timeb#2E
h>#0A#23define.MALLOC(n).malloc((n)<<B2Wsh)#0A#23de
fine.TICKS_PER_SEC.(CLOCKS_PER_SEC)#0A#23define.REM
OVE.unlink#0A#23define.FILE_SEP_CH.'/'#0A#23endif#0A
#0A#23ifdef.forLINUXPPC#0A#23include.<sys/stat#2Eh>
#0A#23include.<time#2Eh>#0A#23include.<sys/timeb#2E
h>#0A#23define.MALLOC(n).malloc((n)<<B2Wsh)#0A#23de
fine.TICKS_PER_SEC.(CLOCKS_PER_SEC)#0A#23define.REM
OVE.unlink#0A#23define.FILE_SEP_CH.'/'#0A#23define.
BIGENDER#0A#23endif#0A#0A#23ifdef.forSUN4#0A#23incl
ude.<sys/stat#2Eh>#0A#23include.<sys/time#2Eh>#0A#23
include.<sys/timeb#2Eh>#0A#23define.MALLOC(n).mallo
c((n)<<B2Wsh)#0A#23define.TICKS_PER_SEC.(1000000)#0A
#23define.REMOVE.unlink#0A#23define.FILE_SEP_CH.'/'
#0A#23define.BIGENDER#0A#23endif#0A#0A#23ifdef.forS
PARC#0A#23include.<sys/stat#2Eh>#0A#23include.<time
#2Eh>#0A#23include.<sys/timeb#2Eh>#0A#23define.MALL
OC(n).malloc((n)<<B2Wsh)#0A#23define.TICKS_PER_SEC.
(CLOCKS_PER_SEC)#0A#23define.REMOVE.unlink#0A#23def
ine.FILE_SEP_CH.'/'#0A#23define.BIGENDER#0A#23endif
#0A#0A#23ifdef.forALPHA#0A#23include.<sys/stat#2Eh>
#0A#23include.<sys/time#2Eh>#0A#23include.<sys/time
b#2Eh>#0A#23include.<stdlib#2Eh>#0A#23define.MALLOC
(n).malloc((n)<<B2Wsh)#0A#23define.TICKS_PER_SEC.(C
LOCKS_PER_SEC)#0A#23define.REMOVE.unlink#0A#23defin
e.FILE_SEP_CH.'/'#0A#23endif#0A#0A#23ifdef.forMSDOS
#0A#23include.<sys\stat#2Eh>#0A#23include.<time#2Eh
>#0A#23include.<sys/timeb#2Eh>#0A#23define.MALLOC(n
).malloc((n)<<B2Wsh)#0A#23define.TICKS_PER_SEC.(CLK
_TCK)#0A#23define.REMOVE.unlink#0A#23define.FILE_SE
P_CH.'\\'#0A#23endif#0A#0A#23ifdef.forBC4#0A#23incl
ude.<sys\stat#2Eh>#0A#23include.<time#2Eh>#0A#23inc
lude.<sys/timeb#2Eh>#0A#23define.MALLOC(n).malloc((
n)<<B2Wsh)#0A#23define.TICKS_PER_SEC.(CLK_TCK)#0A#23
define.REMOVE.unlink#0A#23define.FILE_SEP_CH.'\\'#0A
#23endif#0A#0A#23ifdef.forOS2#0A#23include.<sys/sta
t#2Eh>#0A#23include.<sys/time#2Eh>#0A#23include.<sy
s/timeb#2Eh>#0A#23define.MALLOC(n).malloc((n)<<B2Ws
h)#0A#23define.TICKS_PER_SEC.(CLOCKS_PER_SEC)#0A#23
define.REMOVE.remove#0A#23define.FILE_SEP_CH.'\\'#0A
#23endif#0A#0A#23ifdef.forWIN32#0A#23include.<sys/s
tat#2Eh>#0A#23include.<time#2Eh>#0A#23include.<sys/
timeb#2Eh>#0A#23include.<windows#2Eh>#0A#23include.
<mmsystem#2Eh>#0A#23define.MALLOC(n).malloc((n)<<B2
Wsh)#0A#23define.TICKS_PER_SEC.(CLK_TCK)#0A#23defin
e.REMOVE._unlink#0A#23define.tzset._tzset#0A#23defi
ne.FILE_SEP_CH.'\\'#0A#23endif#0A#0A#23ifdef.forSHw
inCE#0A#23define.forWinCE#0A#23endif#0A#0A#23ifdef.
forWinCE#0A#23undef.BCPLWORD#0A#23define.BCPLWORD.l
ong#0A#23define.MALLOC(n).LocalAlloc(LPTR,.(n)<<B2W
sh)#0A#23define.TICKS_PER_SEC.1000#0A#23define.REMO
VE.unlink#0A#23define.FILE_SEP_CH.'\\'#0A/*#23inclu
de.<sys\stat#2Eh>.*/#0A/*#23include.<time#2Eh>.*/#0A
#23include.<windows#2Eh>........./*.For.all.that.Wi
ndows.stuff.*/#0A#23include.<commctrl#2Eh>......../
*.Command.bar.includes.*/#0A#23include."#2E#2E/sysa
sm/shWinCE/ceBCPL#2Eh"./*.Program-specific.stuff.*/
#0A#23include."Objidl#2Eh"#0A#23include.<stdlib#2Eh
>#0A#0A#23define.PRINTFS.printfs#0A#23define.PRINTF
D.printfd#0A#23define.PRINTF(s).printfd(s,.0)#0A#23
define.FILEPT.HANDLE#0A#0A/*.Unix.style.library.dec
larations.*/#0A#0A#23define.FILEPT.HANDLE#0A#0A#23d
efine.SEEK_SET.FILE_BEGIN#0A#23define.SEEK_END.FILE
_END#0A#0Aint.fclose(FILEPT.fp);#0Aint.fgetc(FILEPT
.fp);#0Avoid.putchar(char.ch);#0Avoid.fflush(FILEPT
.fp);#0AFILEPT.fopen(char.*,.char.*);#0Aint.fread(c
har.*buf,.size_t.size,.size_t.len,.FILEPT.fp);#0Ain
t.fwrite(char.*buf,.size_t.size,.size_t.len,.FILEPT
.fp);#0Aint.fseek(FILEPT.fp,.long.pos,.int.method);
#0Aint.ftell(FILEPT.fp);#0Aint.unlink(char.*);#0Ain
t.rename(char.*,.char.*);#0Aint.clock();#0Achar.*ge
tenv(char.*);#0Aint.main();#0A#0AFILEPT.stdout#3D0;
#0A#0A#23define.EOF.-1#0A#0A#23else#0A#0A#23define.
PRINTFS.printf#0A#23define.PRINTFD.printf#0A#23defi
ne.PRINTF.printf#0A#23define.FILEPT.FILE*#0A#0A#23e
ndif#0A#0Avoid.trpush(BCPLWORD.val);#0A#0Atypedef.B
CPLWORD.*BCPLWORDpt;#0A#0A#23define.WD.(BCPLWORD)#0A
#23define.UWD.(unsigned.BCPLWORD)#0A#23define.PT.(B
CPLWORD.*)#0A#23define.BP.(unsigned.char.*)#0A#23de
fine.SBP.(SIGNEDCHAR.*)#0A#23define.HP.(unsigned.sh
ort.*)#0A#23define.SHP.(short.*)#0A#0A#23define.Gn_
sys.........3#0A#23define.Gn_currco......7#0A#23def
ine.Gn_colist......8#0A#23define.Gn_rootnode....9#0A
#23define.Gn_result2....10#0A#0A#23define.bootregs.
.11#0A#23define.klibregs..21#0A#23define.saveregs..
31#0A#23define.isrregs...41#0A#0A#23define.rootnode
.100#0A#0A#23define.Rtn_tasktab.......0L#0A#23defin
e.Rtn_devtab........1L#0A#23define.Rtn_tcblist.....
..2L#0A#23define.Rtn_crntask.......3L#0A#23define.R
tn_blklist.......4L#0A#23define.Rtn_tallyv........5
L#0A#0A#23define.Rtn_clkintson.....6L#0A#23define.R
tn_lastch........7L#0A#23define.Rtn_insadebug.....8
L#0A#0A#23define.Rtn_bptaddr.......9L#0A#23define.R
tn_bptinstr.....10L#0A#23define.Rtn_dbgvars......11
L#0A#0A#23define.Rtn_clwkq........12L#0A#23define.R
tn_membase......13L#0A#23define.Rtn_memsize......14
L#0A#23define.Rtn_info.........15L#0A#23define.Rtn_
sys..........16L#0A#23define.Rtn_boot.........17L#0A
#23define.Rtn_klib.........18L#0A#23define.Rtn_blib
.........19L#0A#23define.Rtn_keyboard.....20L#0A#23
define.Rtn_screen.......21L#0A#0A#23define.Rtn_vecs
tatsv....22L#0A#23define.Rtn_vecstatsvupb.23L#0A#0A
#23define.Rtn_intflag......24L#0A#23define.Rtn_dump
flag.....25L#0A#23define.Rtn_envlist......26L#0A#23
define.Rtn_abortcode....27L#0A#23define.Rtn_context
......28L#0A#0A#23define.Rtn_lastp........29L#0A#23
define.Rtn_lastg........30L#0A#23define.Rtn_lastst.
......31L#0A#0A#23define.Rtn_idletcb......32L#0A#23
define.Rtn_adjclock.....33L#0A#0A#23define.Rtn_dcou
ntv......34L#0A#23define.Rtn_rootvar......35L#0A#23
define.Rtn_pathvar......36L#0A#23define.Rtn_hdrsvar
......37L#0A#23define.Rtn_scriptsvar...38L#0A#0A#23
define.Rtn_boottrace....39L#0A#0A#23define.Rtn_days
.........40L#0A#23define.Rtn_msecs........41L#0A#0A
#23define.Rtn_mc0..........42L#0A#23define.Rtn_mc1.
.........43L#0A#23define.Rtn_mc2..........44L#0A#23
define.Rtn_mc3..........45L#0A#0A#23define.Rtn_upb.
.........50L#0A#0A#0A#23define.Tcb_namebase.....19L
./*.Space.for.upto.15.chars.of.task.name.*/#0A#0A#0A
/*.SYS.functions.*/#0A#0A#23define.Sys_setcount....
..(-1)#0A#23define.Sys_quit............0#0A#23defin
e.Sys_rti.............1#0A#23define.Sys_saveregs...
.....2#0A#23define.Sys_setst...........3#0A#23defin
e.Sys_tracing.........4#0A#23define.Sys_watch......
.....5#0A#23define.Sys_tally...........6#0A#23defin
e.Sys_interpret.......7#0A#0A#23define.Sys_sardch..
.......10#0A#23define.Sys_sawrch.........11#0A#23de
fine.Sys_read...........12#0A#23define.Sys_write...
.......13#0A#23define.Sys_openread.......14#0A#23de
fine.Sys_openwrite......15#0A#23define.Sys_close...
.......16#0A#23define.Sys_deletefile.....17#0A#23de
fine.Sys_renamefile.....18#0A#0A#23define.Sys_getve
c.........21#0A#23define.Sys_freevec........22#0A#23
define.Sys_loadseg........23#0A#23define.Sys_globin
.........24#0A#23define.Sys_unloadseg......25#0A#23
define.Sys_muldiv.........26#0A#23define.Sys_intfla
g........28#0A#23define.Sys_setraster......29#0A#23
define.Sys_cputime........30#0A#23define.Sys_filemo
dtime....31#0A#23define.Sys_setprefix......32#0A#23
define.Sys_getprefix......33#0A#23define.Sys_graphi
cs.......34......./*.Windows.CE.only.*/#0A#0A#23def
ine.Sys_seek...........38#0A#23define.Sys_tell.....
......39#0A#23define.Sys_waitirq........40#0A#23def
ine.Sys_lockirq........41#0A#23define.Sys_unlockirq
......42#0A#23define.Sys_devcom.........43#0A#23def
ine.Sys_datstamp.......44#0A#0A#23define.Sys_filesi
ze.......46#0A#23define.Sys_openreadwrite..47#0A#23
define.Sys_getsysval......48#0A#23define.Sys_putsys
val......49#0A#23define.Sys_shellcom.......50#0A#23
define.Sys_getpid.........51#0A#23define.Sys_dumpme
m........52#0A#23define.Sys_callnative.....53#0A#23
define.Sys_platform.......54#0A#23define.Sys_inc...
.........55#0A#23define.Sys_buttons........56#0A#23
define.Sys_delay..........57#0A#23define.Sys_sound.
.........58#0A#23define.Sys_callc..........59#0A#23
define.Sys_trpush.........60#0A#23define.Sys_settrc
ount.....61#0A#23define.Sys_gettrval.......62#0A

######cintcode/sysc/mkint-h.c#
/*#0AThis.is.a.program.that.writes.a.file.(INT#2Eh)
.that#0Acontains.C.#23define.statements.that.define
.BCPLINT32.and.BCPLINT64#0Afor.the.architecture.tha
t.this.program.is.running.on#2E.#0A*/#0A#0A#23inclu
de.<stdio#2Eh>#0A#0Aint.main().{#0A..printf("/*.Thi
s.file.was.generated.by.mkint-h.*/\n\n");#0A#0A..//
.define.BCPLINT32#0A..if.(sizeof(int)#3D#3D4).{#0A.
...printf("#23define.BCPLINT32.int\n");#0A....}.els
e.if.(sizeof(long)#3D#3D4).{#0A....printf("#23defin
e.BCPLINT32.long\n");#0A..}#0A#0A..//.define.BCPLIN
T64#0A..if.(sizeof(int)#3D#3D8){#0A....printf("#23d
efine.BCPLINT64.int\n");#0A..}.else.if.(sizeof(long
)#3D#3D8).{#0A....printf("#23define.BCPLINT64.long\
n");#0A..}.else.if.(sizeof(long.long)#3D#3D8).{#0A.
...printf("#23define.BCPLINT64.long.long\n");#0A..}
#0A..return.0;#0A}#0A

######cintcode/sysc/INT.h#
/*.This.file.was.generated.by.mkint-h.*/#0A#0A#23de
fine.BCPLINT32.int#0A#23define.BCPLINT64.long.long#0A


######cintcode/sysc/kblib.c#
/*.this.module.defines.the.machine.dependent.keyboa
rd.interface#0A#0A...int.Readch(void).....returns.t
he.ASCII.code.for.the.next.key.pressed#0A..........
..............without.echo#2E#0A...int.init_keyb(vo
id)..initialises.the.keyboard.interface#2E#0A...int
.close_keyb(void).restores.the.keyboard.to.its.orig
inal.state#2E#0A...int.intflag(void)....returns.1.i
f.interrupt.key.combination.pressed#2E#0A*/#0A#0A#23
ifndef.forSHwinCE#0A#23include.<stdio#2Eh>#0A#23inc
lude.<stdlib#2Eh>#0A#23endif#0A#0A/*.cintsys#2Eh.co
ntains.machine/system.dependent.#23defines..*/#0A#23
include."cintsys#2Eh"#0A#0A#23if.defined(forMIPS).|
|.defined(forSUN4).||.defined(forALPHA).||.\#0A....
defined(forLINUXPPC).||.defined(forMacOSPPC)#0A#23i
nclude.<sys/ioctl#2Eh>#0A#23include.<sgtty#2Eh>#0A#0A
int.init_keyb(void)#0A{.struct.sgttyb.ttyb;#0A#0A..
ioctl(0,.TIOCGETP,.&ttyb);#0A..ttyb#2Esg_flags.#3D.
CBREAK+EVENP+ODDP+CRMOD;#0A..ioctl(0,.TIOCSETP,.&tt
yb);#0A..return.0;#0A}#0A#0Aint.close_keyb(void)#0A
{.struct.sgttyb.ttyb;#0A..ioctl(0,.TIOCGETP,.&ttyb)
;#0A..ttyb#2Esg_flags.#3D.ECHO+EVENP+ODDP+CRMOD;#0A
..ioctl(0,.TIOCSETP,.&ttyb);#0A..return.0;#0A}#0A#0A
int.Readch(void)#0A{.return.getchar();#0A}#0A#0Aint
.intflag(void)#0A{.return.0;#0A}#0A#23endif#0A#0A#23
if.defined(forVmsItanium)#0A//include.<sys/ioctl#2E
h>#0A//include.<sgtty#2Eh>#0A#0Aint.init_keyb(void)
#0A{.//struct.sgttyb.ttyb;#0A#0A..//ioctl(0,.TIOCGE
TP,.&ttyb);#0A..//ttyb#2Esg_flags.#3D.CBREAK+EVENP+
ODDP+CRMOD;#0A..//ioctl(0,.TIOCSETP,.&ttyb);#0A..re
turn.0;#0A}#0A#0Aint.close_keyb(void)#0A{.//struct.
sgttyb.ttyb;#0A..//ioctl(0,.TIOCGETP,.&ttyb);#0A../
/ttyb#2Esg_flags.#3D.ECHO+EVENP+ODDP+CRMOD;#0A..//i
octl(0,.TIOCSETP,.&ttyb);#0A..return.0;#0A}#0A#0Ain
t.Readch(void)#0A{.return.getchar();#0A}#0A#0Aint.i
ntflag(void)#0A{.return.0;#0A}#0A#23endif#0A#0A#23i
f.defined(forLINUX)||defined(forCYGWIN32)||defined(
forSPARC)||\#0A....defined(forGP2X)||defined(forLIN
UXAMD64)#0A#23include.<unistd#2Eh>#0A#23include.<st
dio#2Eh>#0A#23include.<stdlib#2Eh>#0A#23include.<te
rmios#2Eh>#0A#23include.<errno#2Eh>#0A#0A/*.Use.thi
s.variable.to.remember.original.terminal.attributes
#2E..*/#0A.....#0Astruct.termios.saved_attributes;#0A
.....#0Avoid#0Areset_input_mode.(void)#0A{#0A..tcse
tattr.(STDIN_FILENO,.TCSANOW,.&saved_attributes);#0A
}#0A.....#0Avoid#0Aset_input_mode.(void)#0A{#0A..st
ruct.termios.tattr;#0A#0A..if.(!isatty(STDIN_FILENO
)).return;..#0A...#0A../*.Save.the.terminal.attribu
tes.so.we.can.restore.them.later#2E..*/#0A..tcgetat
tr.(STDIN_FILENO,.&saved_attributes);#0A..atexit.(r
eset_input_mode);#0A#0A../*.Set.the.funny.terminal.
modes#2E..*/#0A..tcgetattr.(STDIN_FILENO,.&tattr);#0A
..tattr#2Ec_lflag.&#3D.~(ICANON|ECHO);./*.Clear.ICA
NON.and.ECHO#2E...*/#0A..tattr#2Ec_cc[VMIN].#3D.1;#0A
..tattr#2Ec_cc[VTIME].#3D.0;#0A..tcsetattr.(STDIN_F
ILENO,.TCSAFLUSH,.&tattr);#0A}#0A.....#0Aint.Readch
()#0A{.char.ch;#0A..int.rc.#3D.read(STDIN_FILENO,.&
ch,.1);#0A..if(rc#3D#3D0).ch.#3D.-1;#0A..//if(rc#3D
#3D0).#0A..//printf("rc#3D%d.ch#3D%3d.errno#3D%d\n"
,.rc,.ch,.errno);#0A..return.ch;#0A}#0A#0Aint.init_
keyb(void)#0A{.set_input_mode();#0A..return.0;#0A}#0A
#0Aint.close_keyb(void)#0A{.return.0;#0A}#0A#0Aint.
intflag(void)#0A{.return.0;#0A}#0A#23endif#0A#0A#23
ifdef.forMAC#0A#23include.<console#2Eh>#0A#0Aint.Re
adch(void)#0A{.int.ch.#3D.EOF;#0A..while.(ch#3D#3DE
OF).ch.#3D.getchar();./*.horrible!!!!.*/#0A..return
.ch;#0A}#0A#0Aint.init_keyb(void)#0A{.console_optio
ns#2Etitle.#3D."\pBCPL.Cintcode";#0A..console_optio
ns#2Epause_atexit.#3D.0;#0A..cshow(stdin);#0A..cset
mode(C_RAW,.stdin);#0A..return.0;#0A}#0A#0Aint.clos
e_keyb()#0A{.return.0;#0A}#0A#0Aint.intflag(void)#0A
{.long.theKeys[4];#0A..GetKeys(theKeys);#0A..return
.theKeys[1]#3D#3D0x8005;../*.Command-Option-Shift.d
epressed..*/#0A}#0A#23endif#0A#0A#23if.defined(forM
SDOS).||.defined(forBC4).||.defined(forWIN32)#0A#23
include.<signal#2Eh>#0A#0Aextern.int.getch(void);#0A
#0Aint.Readch()#0A{.int.ch#3Dgetch();#0A..if(ch#3D#3D
3).{./*.ctrl-C.*/#0A....raise(SIGINT);#0A..}#0A..re
turn.ch;#0A}#0A#0Aint.init_keyb(void)#0A{.return.0;
#0A}#0A#0Aint.close_keyb(void)#0A{.return.0;#0A}#0A
#0Aint.intflag(void)#0A{.return.0;#0A}#0A#23endif#0A
#0A#23ifdef.forOS2#0A#23include.<conio#2Eh>#0A#0Ain
t.Readch(void)#0A{.int.ch.#3D.getch();#0A..return.c
h;#0A}#0A#0Aint.init_keyb(void)#0A{.return.0;#0A}#0A
#0Aint.close_keyb(void)#0A{.return.0;#0A}#0A#0Aint.
intflag(void)#0A{.return.0;#0A}#0A#23endif#0A#0A#23
ifdef.forSHwinCE#0A#0Aextern.int.getch(void);#0A#0A
int.Readch()#0A{.return.chBufGet();#0A}#0A#0Aint.in
it_keyb(void)#0A{.return.0;#0A}#0A#0Aint.close_keyb
(void)#0A{.return.0;#0A}#0A#0Aint.intflag(void)#0A{
.INT32.flag.#3D.Interrupted;#0A..Interrupted.#3D.0;
#0A..return.flag;#0A}#0A#0A/*.Unix.style.library.*/
#0A#0AFILEPT.fopen(char.*name,.char.*str).{#0A#09FI
LEPT.fp#3DNULL;#0A#09TCHAR.szName[100];#0A#09DWORD.
access.#3D.0;#0A#09DWORD.mode.#3D.0;#0A........DWOR
D.share.#3D.0;#0A........DWORD.creation.#3D.0;#0A..
......DWORD.attrs.#3D.0;#0A#09int.i;#0A#09for.(i#3D
0;.*name;.i++).szName[i].#3D.*name++;#0A#09szName[i
].#3D.0;#0A#0A#09while(*str).{#0A#09..if.(str[0]#3D
#3D'r').{#0A............access.#3D...GENERIC_READ;#0A
............share.#3D....FILE_SHARE_READ;#0A.......
.....creation.#3D.OPEN_EXISTING;./*.fail.if.doesn't
.exist.*/#0A............attrs.#3D....FILE_ATTRIBUTE
_NORMAL;#0A..........}#0A..........if(*str#3D#3D'w'
).{#0A............access.#3D...GENERIC_WRITE;#0A...
.........share.#3D....FILE_SHARE_WRITE;#0A.........
...creation.#3D.CREATE_ALWAYS;./*.create.or.truncat
e.*/#0A............attrs.#3D....FILE_ATTRIBUTE_NORM
AL;#0A#09..}#0A..........if(*str#3D#3D'+').{#0A....
........access.#3D...GENERIC_READ.|.GENERIC_WRITE;#0A
............share.#3D....FILE_SHARE_READ.|.FILE_SHA
RE_WRITE;#0A............creation.#3D.OPEN_ALWAYS;./
*.Open.or.create,.no.truncation.*/#0A............at
trs.#3D....FILE_FLAG_RANDOM_ACCESS;#0A#09..}#0A....
......str++;#0A#09}#0A........fp.#3D.CreateFile(szN
ame,.access,.share,.NULL,.creation,.attrs,.0);#0A#09
if.(fp#3D#3DINVALID_HANDLE_VALUE).fp.#3D.0;#0A#09re
turn.fp;#0A}#0A#0Aint.fclose(FILEPT.fp).{#0A#09retu
rn.CloseHandle(fp).?.0.:.1;#0A}#0A#0Aint.clock().{#0A
#09return.GetTickCount();#0A}#0A#0Avoid.putchar(cha
r.ch).{#0A#09Wrch(ch);#0A}#0A#0Avoid.fflush(FILEPT.
fp).{#0A#09return;#0A}#0A#0Aint.fread(char.*buf,.si
ze_t.size,.size_t.len,.FILEPT.fp).{#0A#09DWORD.n#3D
0;#0A#09BOOL.rc.#3D.ReadFile(fp,.buf,.(DWORD)size*l
en,.&n,.NULL);#0A#09if(!rc).{#0A..........DWORD.err
.#3D.GetLastError();#0A#09../*#0A..........PRINTFD(
"fread:.ReadFile,.err#3D%d\n",.(DWORD)err);#0A#09..
*/#0A..........return.-1;#0A#09}#0A#09/*#0A#09PRINT
FD("fread.trying.to.read.from.fd#3D%ld\n",.(DWORD)f
p);#0A#09PRINTFD("fread.trying.to.read.%ld.bytes,."
,.(DWORD)(size*len));#0A#09PRINTFD("got.%ld\n",.n);
#0A#09*/#0A#09return.n;#0A}#0A#0Aint.fwrite(char.*b
uf,.size_t.size,.size_t.len,.FILEPT.fp).{#0A#09DWOR
D.n#3D0;#0A#09if(WriteFile(fp,.buf,.(DWORD)size*len
,.&n,.NULL))#0A#09..return.n;./*.Success.*/#0A#09re
turn.-1;#0A}#0A#0Aint.fseek(FILEPT.fp,.INT32.pos,.i
nt.method).{./*.Set.the.file.position.*/#0A..SetFil
ePointer(fp,.(LONG)pos,.NULL,.method);#0A..return.0
;#0A}#0A#0Aint.ftell(FILEPT.fp).{./*.Return.the.cur
rent.file.position.*/#0A..return.SetFilePointer(fp,
.0,.NULL,.FILE_CURRENT);#0A}#0A#0A#0Aint.unlink(cha
r.*name).{#0A......../*.Delete.(remove).a.named.fil
e#2E.*/#0A#09TCHAR.szName[100];#0A#09int.i;#0A#09fo
r.(i#3D0;.*name;.i++).szName[i].#3D.*name++;#0A#09s
zName[i].#3D.0;#0A#09return.!.DeleteFile(szName);#0A
}#0A#0Aint.rename(char.*from,.char.*to).{#0A#09TCHA
R.szFrom[100];#0A#09TCHAR.szTo[100];#0A#09int.i;#0A
#09for.(i#3D0;.*from;.i++).szFrom[i].#3D.*from++;#0A
#09szFrom[i].#3D.0;#0A#09for.(i#3D0;.*to;.i++).szTo
[i].#3D.*to++;#0A#09szTo[i].#3D.0;#0A#09return.!.Mo
veFile(szFrom,.szTo);#0A}#0A#0Aint.fgetc(FILEPT.fp)
.{#0A#09BYTE.ch;#0A#09DWORD.n#3D0;#0A#09ReadFile(fp
,.&ch,.1,.&n,.NULL);#0A#0A#09return.n#3D#3D0.?.EOF.
:.ch;#0A}#0A#0Aint.eqstr(char.*s1,.char.*s2).{#0A..
while(*s1.&&.*s2).if(*s1++.!#3D.*s2++).return.0;#0A
..return.*s1#3D#3D*s2;#0A}#0A#0Achar.*getenv(char.*
name).{#0A.if(eqstr(name,."BCPLPATH")).return."\\BC
PL\\cintcode\\cin";#0A.if(eqstr(name,."BCPLROOT")).
return."\\BCPL\\cintcode";#0A.if(eqstr(name,."BCPLH
DRS")).return."\\BCPL\\cintcode\\g";#0A.return."";#0A
}#0A#23endif#0A#0A

######cintcode/sysc/nrastlib.c#
/*.cinterp#2Eh.contains.machine/system.dependent.#23
defines..*/#0A#0A#23include."cintsys#2Eh"#0A#0ABCPL
WORD.setraster(BCPLWORD.n,.BCPLWORD.val)#0A{.#0A..r
eturn.-1;.../*.To.indicate.rastering.not.available.
*/#0A}#0A#0Avoid.rasterpoint(BCPLWORD.p)#0A{.#0A..r
eturn;#0A}#0A#0A#0A

######cintcode/sysc/rastlib.c#
/*.rastlib.generates.a.relatively.compact.represent
ation.of#0A**.raster.lines.using.run.length.encodin
g#2E#0A**#0A**.K1000.S12..........1000.instruction.
per.raster.line,.scale.12#0A**.W10B3W1345B1N......1
0.white.3.black.1345.white.1.black.newline#0A**.W13
B3W12B2N........etc#0A**.#2E#2E#2E#0A*/#0A#0A#23inc
lude.<stdio#2Eh>#0A#23include.<stdlib#2Eh>#0A#0A/*.
cintsys#2Eh.contains.machine/system.dependent.#23de
fines..*/#0A#23include."cintsys#2Eh"#0A#0A/*.Upb.of
.address.references.buffer.*/#0A#23define.UPB.50000
#0A#0Astatic.FILE.*rasterfile;#0Astatic.BCPLWORD.ad
dr[UPB+1],.addp;#0Astatic.BCPLWORD.p#3D0;#0Astatic.
BCPLWORD.count#3D1000,.scale#3D12,.fcounttrig;#0ABC
PLWORD.fcount;#0A#0Aextern.char.*b2c_fname(BCPLWORD
.bstr,.char.*cstr);#0A#0Astatic.void.wrline(void);#0A
#0Astatic.int.initraster(char.*filename)#0A{.fcount
trig.#3D.count;#0A..addp.#3D.0;#0A..fcount.#3D.0;#0A
..rasterfile.#3D.fopen(filename,."w");#0A..fprintf(
rasterfile,."K%d.S%d\n",.count,.scale);#0A..if(rast
erfile).return.0;#0A..return.1;#0A}#0A#0A#0Astatic.
int.endraster(void)#0A{.if.(rasterfile)#0A..{.wrlin
e();#0A....return.fclose(rasterfile);./*.Return.0.i
f.successful.*/#0A..}#0A..return.-1;#0A}#0A#0ABCPLW
ORD.setraster(BCPLWORD.n,.BCPLWORD.val)#0A{.char.ch
buf[256];#0A..switch((int)n)#0A..{.case.0:.if.(val)
.return.initraster(b2c_fname(val,.chbuf));#0A....el
se.....return.endraster();./*.Return.0.if.successfu
l.*/#0A............return.1;#0A....case.1:.if(val>#3D
0).count.#3D.val;.return.count;#0A....case.2:.if(va
l>#3D0).scale.#3D.val;.return.scale;#0A....case.3:.
return.0;../*.Rastering.is.available.*/#0A..}#0A}#0A
#0Avoid.sort(BCPLWORD.p,.BCPLWORD.q)#0A{.if(p<q)#0A
..{.BCPLWORD.t;#0A....BCPLWORD.m.#3D.addr[(p+q)>>1]
;#0A....BCPLWORD.i#3Dp,.j#3Dq;#0A....while(1)#0A...
.{.while(addr[i]<m).i++;#0A....../*.all.k.in.p#2E#2E
i-1.#3D>.addr[k]<m#0A......**.addr[i].>#3D.m#0A....
..*/#0A......while(j>i.&&.addr[j]>#3Dm).j--;#0A....
../*.all.k.in.j+1.#2E#2E.q.#3D>.addr[k]>#3Dm#0A....
..**.j>#3Di#0A......*/#0A......if(i#3D#3Dj).break;#0A
....../*.j>i.and.addr[i]>m.and.addr[j]<m#0A......*/
#0A......t.#3D.addr[i];#0A......addr[i].#3D.addr[j]
;#0A......addr[j].#3D.t;#0A....../*.j>i.and.addr[i]
<m.and.addr[j]>m#0A......*/#0A......i++;#0A....}#0A
....sort(p,.i-1);#0A....j.#3D.q;#0A....while(1)#0A.
...{.while(i<#3Dj.&&.addr[i]#3D#3Dm).i++;#0A......w
hile(addr[j]!#3Dm).j--;#0A......if.(j<i).break;#0A.
.....addr[j].#3D.addr[i];#0A......addr[i].#3D.m;#0A
......i++;#0A....}#0A....sort(i,.q);#0A..}#0A}#0A#0A
static.void.wrline(void)#0A{.BCPLWORD.i#3D1,.k,.a#3D
0,.b;#0A..sort(1,.addp);#0A..while(i<#3Daddp.&&.add
r[i]<0).i++;#0A..#0A..while(i<#3Daddp)#0A..{.#0A...
.b.#3D.addr[i++];./*.addr.of.next.black.*/#0A....k.
#3D.b-a;......./*.white.count,.possibly.zero.*/#0A.
...fprintf(rasterfile,."W%ld",.(long)k);#0A....a.#3D
.b;./*.start.of.next.black.region.*/#0A..../*.find.
next.white.*/#0A....b++;#0A....while.(i<#3Daddp.&&.
addr[i]<#3Db).b#3Daddr[i++]+1;.#0A....k.#3D.b-a;#0A
....a.#3D.b;./*.start.of.next.white.region.*/#0A...
.fprintf(rasterfile,."B%ld",.(long)k);#0A..}#0A..fp
rintf(rasterfile,."N\n");#0A..addp.#3D.0;#0A..fcoun
ttrig.+#3D.count;#0A..if(fcount%1000000#3D#3D0).pri
ntf("fcount.#3D.%ld\n",.(long)fcount);#0A}#0A#0Avoi
d.rasterpoint(BCPLWORD.p)#0A{.BCPLWORD.a.#3D.p/scal
e;#0A..if.(addp<UPB).addr[++addp].#3D.a;#0A/*..prin
tf("%7ld.%7ld\n",.(long)addp,.(long)a);*/#0A..if.(f
count.>#3D.fcounttrig).wrline();#0A}#0A#0A#0A#0A#0A
#0A

######cintcode/sysc/rasterp.c#
/*#0A**.This.is.a.version.of.the.CINTCODE.interpret
er.that.can.genearate#0A**.memory.reference.data.th
at.allows.memory.address/time.graphs#0A**.to.be.con
structed#2E.It.should.be.linked.as.a.replacement.fo
r.cintasm#2E#0A**.When.linked.with.rastlib.it.is.ca
pable.of.generating.Postscript.pictures#0A**.of.the
.execution.history.of.a.program#2E#0A**#0A**.(c).Co
pyright:..Martin.Richards..26.October.1995#0A*/#0A#0A
#0A#23include.<stdio#2Eh>#0A#0A/*.cintsys#2Eh.conta
ins.machine/system.dependent.#23defines..*/#0A#23in
clude."cintsys#2Eh"#0A#0Aextern.BCPLWORD.result2;#0A
#0Aextern.BCPLWORD.tallylim;#0A#0Aextern.BCPLWORD.d
osys(BCPLWORD.p,.BCPLWORD.g);#0Aextern.BCPLWORD.mul
div(BCPLWORD.a,.BCPLWORD.b,.BCPLWORD.c);#0A#0A#0A/*
.functions.in.rastlib#2Ec..*/#0Aextern.BCPLWORD.fco
unt;#0Aextern.BCPLWORD.setraster(BCPLWORD,.BCPLWORD
);./*.not.called.from.this.module.*/#0Aextern.void.
rasterpoint(BCPLWORD);#0A#0A#23define.Gn_currco....
..7#0A#23define.Gn_result2....10#0A#0A/*.CINTCODE.f
unction.codes..*/#0A#0A#23define.F_0.......0#0A#0A#23
define.F_brk.....2#0A#23define.F_k0......0#0A#23def
ine.F_lf.....12#0A#23define.F_lm.....14#0A#23define
.F_lm1....15#0A#23define.F_l0.....16#0A#23define.F_
fhop...27#0A#23define.F_jeq....28#0A#0A#23define.F_
k......32#0A#23define.F_kh.....33#0A#23define.F_kw.
....34#0A#23define.F_k0g....32#0A#23define.F_k0g1..
.(F_k0g+32)#0A#23define.F_k0gh...(F_k0g+64)#0A#23de
fine.F_s0g....44#0A#23define.F_s0g1...(F_s0g+32)#0A
#23define.F_s0gh...(F_s0g+64)#0A#23define.F_l0g....
45#0A#23define.F_l0g1...(F_l0g+32)#0A#23define.F_l0
gh...(F_l0g+64)#0A#23define.F_l1g....46#0A#23define
.F_l1g1...(F_l1g+32)#0A#23define.F_l1gh...(F_l1g+64
)#0A#23define.F_l2g....47#0A#23define.F_l2g1...(F_l
2g+32)#0A#23define.F_l2gh...(F_l2g+64)#0A#23define.
F_lg.....48#0A#23define.F_lg1....(F_lg+32)#0A#23def
ine.F_lgh....(F_lg+64)#0A#23define.F_sg.....49#0A#23
define.F_sg1....(F_sg+32)#0A#23define.F_sgh....(F_s
g+64)#0A#23define.F_llg....50#0A#23define.F_llg1...
(F_llg+32)#0A#23define.F_llgh...(F_llg+64)#0A#23def
ine.F_ag.....51#0A#23define.F_ag1....(F_ag+32)#0A#23
define.F_agh....(F_ag+64)#0A#23define.F_mul....52#0A
#23define.F_div....53#0A#23define.F_rem....54#0A#23
define.F_xor....55#0A#23define.F_sl.....56#0A#23def
ine.F_ll.....58#0A#23define.F_jne....60#0A#0A#23def
ine.F_llp....64#0A#23define.F_llph...65#0A#23define
.F_llpw...66#0A#23define.F_add....84#0A#23define.F_
sub....85#0A#23define.F_lsh....86#0A#23define.F_rsh
....87#0A#23define.F_and....88#0A#23define.F_or....
.89#0A#23define.F_lll....90#0A#23define.F_jls....92
#0A#0A#23define.F_l......96#0A#23define.F_lh.....97
#0A#23define.F_lw.....98#0A#23define.F_rv....116#0A
#23define.F_rtn...123#0A#23define.F_jgr...124#0A#0A
#23define.F_lp....128#0A#23define.F_lph...129#0A#23
define.F_lpw...130#0A#23define.F_lp0...128#0A#23def
ine.F_sys...145#0A#23define.F_swb...146#0A#23define
.F_swl...147#0A#23define.F_st....148#0A#23define.F_
st0...148#0A#23define.F_stp0..149#0A#23define.F_got
o..155#0A#23define.F_jle...156#0A#0A#23define.F_sp.
...160#0A#23define.F_sph...161#0A#23define.F_spw...
162#0A#23define.F_sp0...160#0A#23define.F_s0....176
#0A#23define.F_xch...181#0A#23define.F_gbyt..182#0A
#23define.F_pbyt..183#0A#23define.F_atc...184#0A#23
define.F_atb...185#0A#23define.F_j.....186#0A#23def
ine.F_jge...188#0A#0A#23define.F_ap....192#0A#23def
ine.F_aph...193#0A#23define.F_apw...194#0A#23define
.F_ap0...192#0A#0A#23define.F_xpbyt.205#0A#23define
.F_lmh...206#0A#23define.F_btc...207#0A#23define.F_
nop...208#0A#23define.F_a0....208#0A#23define.F_rvp
0..211#0A#23define.F_st0p0.216#0A#23define.F_st1p0.
218#0A#0A#23define.F_a.....224#0A#23define.F_ah....
225#0A#23define.F_aw....226#0A#23define.F_l0p0..224
#0A#23define.F_s.....237#0A#23define.F_sh....238#0A
#0A#23define.F_mdiv..239#0A#23define.F_chgco.240#0A
#23define.F_neg...241#0A#23define.F_not...242#0A#23
define.F_l1p0..240#0A#23define.F_l2p0..244#0A#23def
ine.F_l3p0..247.#0A#23define.F_l4p0..249#0A#0A#23de
fine.F_255...255#0A#0A#0A/*.The.function.cintasm.is
.designed.to.be.separately.compiled,#0A**.and.possi
bly.implemented.in.assembly.language.for.speed#2E#0A
**#0A**.mem..is.the.pointer.to.the.cintcode.memory#2E
#0A**.regs.is.the.position.in.the.Cintcode.memory.w
here.the.initial#0A**......value.of.the.Cintcode.re
gisters#2E#0A**#0A**.interpret.(or.cintasm).execute
s.Cintcode.instructions.and.returns.with#0A**.an.in
teger.result.as.follows:#0A**.....0......sys(0,.0).
called#0A**.....1......Non.existant.instruction#0A*
*.....2......Brk.instruction#0A**.....3......Zero.c
ount#0A**.....4......Negative.pc#0A**.....5......Di
vision.by.zero#0A**.....n......sys(0,.n).called#0A*
*#0A**.On.return.the.Cintcode.registers.are.dumped.
back.in.the.vector.regs#0A*/#0A#0A#0Avoid.Rb(BCPLWO
RD.a)#0A{#0A..if.(tallylim).rasterpoint(a);#0A}#0A#0A
void.Rh(BCPLWORD.a)#0A{#0A..if.(tallylim).rasterpoi
nt(a<<1);#0A}#0A#0Avoid.Rw(BCPLWORD.a)#0A{#0A..if.(
tallylim).rasterpoint(a<<B2Wsh);#0A}#0A#0A#0Aint.ci
ntasm(BCPLWORD.regs,.BCPLWORDpt.mem)#0A{.register.B
CPLWORDpt.W.#3D.mem;#0A#0A#23define.B.(BP.W)#0A#23d
efine.SB.(SBP.W)#0A#23define.H.(HP.W)#0A#23define.S
H.(SHP.W)#0A#0A#23ifdef.BIGENDER#0A#23define.GH(x).
((WD.B[x+0]<<8).|.B[x+1])#0A#23define.GW(x).((((((W
D.B[x]<<8)|B[x+1])<<8)|B[x+2])<<8)|B[x+3])#0A#23els
e#0A#23define.GH(x).((WD.B[x+1]<<8).|.B[x])#0A#23de
fine.GW(x).((((((WD.B[x+3]<<8)|B[x+2])<<8)|B[x+1])<
<8)|B[x])#0A#23endif#0A#0A...register.BCPLWORD.....
......a..#3D.W[regs+0];#0A...register.BCPLWORD.....
......b..#3D.W[regs+1];#0A...BCPLWORD..............
......c..#3D.W[regs+2];#0A...register.BCPLWORD.....
......p..#3D.W[regs+3]>>B2Wsh;#0A...register.BCPLWO
RD...........g..#3D.W[regs+4]>>B2Wsh;#0A...BCPLWORD
....................st.#3D.W[regs+5];#0A...register
.BCPLWORD...........pc.#3D.W[regs+6];#0A...register
.BCPLWORD........count.#3D.W[regs+7];#0A...BCPLWORD
....................mw.#3D.W[regs+8];#0A#0A...regis
ter.BCPLWORDpt.Wp..#3D.W+p,..../*.Optimise.access.t
o.the.stack.*/#0A....................Wg..#3D.W+g,..
../*.Optimise.access.to.the.global.vector.*/#0A....
................Wg1.#3D.W+g+256;#0A#0A...BCPLWORD..
res,.k,.i;#0A...Rw(regs+0);.#0A...Rw(regs+1);.#0A..
.Rw(regs+2);.#0A...Rw(regs+3);.#0A...Rw(regs+4);.#0A
...Rw(regs+5);.#0A...Rw(regs+6);.#0A...Rw(regs+7);.
#0A...Rw(regs+8);.#0A#0A...if.(pc<0).goto.negpc;#0A
...#0Afetch:#0A...if.(tallylim).fcount++;#0A...Rb(p
c);#0A...switch((int).B[pc++])#0A#0A{..default:....
../*.Cases.F_0.and.F_255.have.been.added.explicitly
.to...*/#0A...case.F_0:...../*.improve.the.compiled
.code.(with.luck)...............*/#0A...case.F_255:
...res.#3D.1;.pc--;.goto.ret;./*.Unimplemented.inst
ruction..*/#0A#0A...case.F_mul:...a.#3D.b.*.a;.....
...goto.fetch;#0A...case.F_div:...if(a#3D#3D0).{res
.#3D.5;.pc--;.goto.ret;.}./*.Division.by.zero.*/#0A
.................a.#3D.b./.a;........goto.fetch;#0A
...case.F_rem:...if(a#3D#3D0).{res.#3D.5;.pc--;.got
o.ret;.}./*.Division.by.zero.*/#0A.................
a.#3D.b.%.a;........goto.fetch;#0A...case.F_add:...
a.#3D.b.+.a;........goto.fetch;#0A...case.F_sub:...
a.#3D.b.-.a;........goto.fetch;#0A...case.F_neg:...
a.#3D.-.a;..........goto.fetch;#0A#0A...case.F_fhop
:..a.#3D.0;.pc++;......goto.fetch;#0A#0A...case.F_l
sh:...if.(a>31).b#3D0;./*.bug.*/#0A................
.a.#3D.b.<<.a;.......goto.fetch;#0A...case.F_rsh:..
.if.(a>31).b#3D0;./*.bug.*/#0A.................a.#3D
.WD((UWD.b)>>a);.goto.fetch;#0A...case.F_not:...a.#3D
.~.a;..........goto.fetch;#0A...case.F_and:...a.#3D
.b.&.a;........goto.fetch;#0A...case.F_or:....a.#3D
.b.|.a;........goto.fetch;#0A...case.F_xor:...a.#3D
.b.^.a;........goto.fetch;#0A#0A...case.F_goto:..pc
.#3D.a;...........goto.fetch;#0A#0A...case.F_brk:..
.res.#3D.2;.pc--;.goto.ret;../*.BREAKPOINT..*/#0A..
...............#0A...case.F_rv+6:..Rw(a+6);.a.#3D.W
[a+6];.goto.fetch;#0A...case.F_rv+5:..Rw(a+5);.a.#3D
.W[a+5];.goto.fetch;#0A...case.F_rv+4:..Rw(a+4);.a.
#3D.W[a+4];.goto.fetch;#0A...case.F_rv+3:..Rw(a+3);
.a.#3D.W[a+3];.goto.fetch;#0A...case.F_rv+2:..Rw(a+
2);.a.#3D.W[a+2];.goto.fetch;#0A...case.F_rv+1:..Rw
(a+1);.a.#3D.W[a+1];.goto.fetch;#0A...case.F_rv:...
.Rw(a+0);.a.#3D.W[a+0];.goto.fetch;#0A#0A...case.F_
st+3:..Rw(a+3);.W[a+3].#3D.b;.goto.fetch;#0A...case
.F_st+2:..Rw(a+2);.W[a+2].#3D.b;.goto.fetch;#0A...c
ase.F_st+1:..Rw(a+1);.W[a+1].#3D.b;.goto.fetch;#0A.
..case.F_st:....Rw(a+0);.W[a+0].#3D.b;.goto.fetch;#0A
#0A...case.F_chgco:.Rw(p+0);.Rw(g+Gn_currco);.Rw(Wg
[Gn_currco]);.#0A.................W[Wg[Gn_currco]].
#3D.Wp[0];...../*.!currco.:#3D.!p....*/#0A.........
........Rw(p+1);.#0A.................pc.#3D.Wp[1];.
................../*.pc......:#3D.p!1...*/#0A......
...........Rw(p+4);.Rw(g+Gn_currco);.#0A...........
......Wg[Gn_currco].#3D.Wp[4];......../*.currco..:#3D
.cptr..*/#0A.................Rw(p+4);.Rw(Wp[4]);.#0A
.................p.#3D.W[Wp[4]]>>B2Wsh;............
../*.p.......:#3D.!cptr.*/#0A.................Wp.#3D
.W+p;#0A.................goto.fetch;#0A#0A...case.F
_mdiv:..Rw(p+3);.Rw(p+4);.Rw(p+5);.#0A.............
....a.#3D.muldiv(Wp[3],.Wp[4],.Wp[5]);#0A..........
.......Rw(g+Gn_result2);.#0A.................Wg[Gn_
result2].#3D.result2;#0A................./*.fall.th
rough.to.return..*/#0A...case.F_rtn:...Rw(p+1);.#0A
.................pc.#3D.Wp[1];#0A.................R
w(p+0);.#0A.................p..#3D.Wp[0]>>B2Wsh;..W
p.#3D.W+p;.goto.fetch;#0A#0A...case.F_gbyt:.Rb(a+(b
<<B2Wsh));#0A................a.#3D.B[a+(b<<B2Wsh)];
............goto.fetch;#0A...case.F_pbyt:.Rb(a+(b<<
B2Wsh));#0A................B[a+(b<<B2Wsh)].#3D.c;..
..........goto.fetch;#0A...case.F_xpbyt:Rb(b+(a<<B2
Wsh));#0A................B[b+(a<<B2Wsh)].#3D.c;....
........goto.fetch;#0A...case.F_atc:..c.#3D.a;.....
.................goto.fetch;#0A...case.F_btc:..c.#3D
.b;......................goto.fetch;#0A...case.F_at
b:..b.#3D.a;......................goto.fetch;#0A...
case.F_xch:..a.#3D.a^b;.b.#3D.a^b;.a.#3D.a^b;..goto
.fetch;#0A#0A...case.F_swb:.{.BCPLWORD.n,k,val,i#3D
1;#0A.................k.#3D.(pc+1)>>1;#0A..........
.......Rh(k);#0A.................n.#3D.H[k];#0A....
.............while(i<#3Dn)#0A.................{.i.#3D
.i+i;#0A...................Rh(k+i);#0A.............
......val.#3D.H[k+i];#0A...................if.(a#3D
#3Dval).{.k.+#3D.i;.break;.}#0A...................i
f.(a<val).i++;#0A.................}#0A.............
....k++;#0A.................Rh(k);#0A..............
...pc.#3D.(k<<1).+.SH[k];#0A.................goto.f
etch;#0A...............}#0A#0A...case.F_swl:.{.BCPL
WORD.n,q;#0A.................q.#3D.(pc+1)>>1;#0A...
..............Rh(q);#0A.................n.#3D.H[q++
];#0A.................if(0<#3Da.&&.a<n).q.#3D.q.+.a
.+.1;#0A.................Rh(q);#0A.................
pc.#3D.(q<<1).+.SH[q];#0A.................goto.fetc
h;#0A...............}#0A#0A...case.F_sys:.switch(a)
.{#0A..#09#09default:./*.system.call.--.general.cas
e.*/#0A.#0A..#09#09.........W[regs+0]..#3D.a;..../*
.Save.the.registers.*/#0A#09#09.........W[regs+1]..
#3D.b;..../*.for.debugging.purposes.*/#0A..........
...............W[regs+2]..#3D.c;#0A................
.........W[regs+3]..#3D.p<<B2Wsh;#0A...............
..........W[regs+4]..#3D.g<<B2Wsh;#0A..............
...........W[regs+5]..#3D.st;#0A...................
......W[regs+6]..#3D.pc;#0A........................
.W[regs+7]..#3D.count;#0A.........................W
[regs+8]..#3D.mw;#0A..#0A.........................a
.#3D.dosys(p,.g);.#0A.........................goto.
fetch;#0A#0A.................case.Sys_setcount:#0A.
......................../*.oldcount.:#3D.sys(Sys_se
tcount,.newcount)..*/#0A.........................a.
#3D.count;.#0A#09#09.........Rw(p+4);.count.#3D.Wp[
4];#0A.........................res.#3D.-1;./*.Leave
.and.immediately.re-enter.*/#0A....................
.....goto.ret;./*.the.interpreter.*/#0A#0A.........
........case.Sys_quit:#0A.........................R
w(p+4);.res.#3D.Wp[4];#0A.........................g
oto.ret;#0A#0A#09#09./*#0A#09#09.case.Sys_rti:.//..
sys(Sys_rti,.regs)#0A.................case.Sys_save
regs:.//.sys(Sys_saveregs,.regs)#0A................
.case.Sys_setst:.//.sys(Sys_setst,.st)#0A#09#09.*/#0A
................./*.case.Sys_watch:.*/./*.sys(Sys_w
atch,.addr).*/#0A...............}#0A#0A...case.F_lp
0+16:..b.#3D.a;.Rw(p+16);.a.#3D.Wp[16];.goto.fetch;
#0A...case.F_lp0+15:..b.#3D.a;.Rw(p+15);.a.#3D.Wp[1
5];.goto.fetch;#0A...case.F_lp0+14:..b.#3D.a;.Rw(p+
14);.a.#3D.Wp[14];.goto.fetch;#0A...case.F_lp0+13:.
.b.#3D.a;.Rw(p+13);.a.#3D.Wp[13];.goto.fetch;#0A...
case.F_lp0+12:..b.#3D.a;.Rw(p+12);.a.#3D.Wp[12];.go
to.fetch;#0A...case.F_lp0+11:..b.#3D.a;.Rw(p+11);.a
.#3D.Wp[11];.goto.fetch;#0A...case.F_lp0+10:..b.#3D
.a;.Rw(p+10);.a.#3D.Wp[10];.goto.fetch;#0A...case.F
_lp0+9:...b.#3D.a;.Rw(p+9);..a.#3D.Wp[9];..goto.fet
ch;#0A...case.F_lp0+8:...b.#3D.a;.Rw(p+8);..a.#3D.W
p[8];..goto.fetch;#0A...case.F_lp0+7:...b.#3D.a;.Rw
(p+7);..a.#3D.Wp[7];..goto.fetch;#0A...case.F_lp0+6
:...b.#3D.a;.Rw(p+6);..a.#3D.Wp[6];..goto.fetch;#0A
...case.F_lp0+5:...b.#3D.a;.Rw(p+5);..a.#3D.Wp[5];.
.goto.fetch;#0A...case.F_lp0+4:...b.#3D.a;.Rw(p+4);
..a.#3D.Wp[4];..goto.fetch;#0A...case.F_lp0+3:...b.
#3D.a;.Rw(p+3);..a.#3D.Wp[3];..goto.fetch;#0A#0A...
case.F_lp:...Rb(pc);.Rw(p+B[pc]);#0A...............
.b.#3D.a;.a.#3D.Wp[B[pc++]];..........goto.fetch;#0A
...case.F_lph:..Rb(pc);.Rw(p+GH(pc));#0A...........
.....b.#3D.a;.a.#3D.Wp[GH(pc)];..pc.+#3D.2;.goto.fe
tch;#0A...case.F_lpw:..Rb(pc);.Rw(p+GW(pc));#0A....
............b.#3D.a;.a.#3D.Wp[GW(pc)];..pc.+#3D.4;.
goto.fetch;#0A#0A...case.F_llp:..b.#3D.a;..Rb(pc);.
a.#3D.p+B[pc++];.............goto.fetch;#0A...case.
F_llph:.b.#3D.a;..Rb(pc);.a.#3D.p+GH(pc);.....pc.+#3D
.2;.goto.fetch;#0A...case.F_llpw:.b.#3D.a;..Rb(pc);
.a.#3D.p+GW(pc);.....pc.+#3D.4;.goto.fetch;#0A#0A..
.case.F_sp0+16:.Rw(p+16);.Wp[16].#3D.a;.goto.fetch;
#0A...case.F_sp0+15:.Rw(p+15);.Wp[15].#3D.a;.goto.f
etch;#0A...case.F_sp0+14:.Rw(p+14);.Wp[14].#3D.a;.g
oto.fetch;#0A...case.F_sp0+13:.Rw(p+13);.Wp[13].#3D
.a;.goto.fetch;#0A...case.F_sp0+12:.Rw(p+12);.Wp[12
].#3D.a;.goto.fetch;#0A...case.F_sp0+11:.Rw(p+11);.
Wp[11].#3D.a;.goto.fetch;#0A...case.F_sp0+10:.Rw(p+
10);.Wp[10].#3D.a;.goto.fetch;#0A...case.F_sp0+9:..
Rw(p+9);..Wp[9]..#3D.a;.goto.fetch;#0A...case.F_sp0
+8:..Rw(p+8);..Wp[8]..#3D.a;.goto.fetch;#0A...case.
F_sp0+7:..Rw(p+7);..Wp[7]..#3D.a;.goto.fetch;#0A...
case.F_sp0+6:..Rw(p+6);..Wp[6]..#3D.a;.goto.fetch;#0A
...case.F_sp0+5:..Rw(p+5);..Wp[5]..#3D.a;.goto.fetc
h;#0A...case.F_sp0+4:..Rw(p+4);..Wp[4]..#3D.a;.goto
.fetch;#0A...case.F_sp0+3:..Rw(p+3);..Wp[3]..#3D.a;
.goto.fetch;#0A#0A...case.F_sp:....Rb(pc);.Rw(p+B[p
c]);#0A.................Wp[B[pc++]].#3D.a;.........
.........goto.fetch;#0A...case.F_sph:...Rb(pc);.Rw(
p+GH(pc));#0A.................Wp[GH(pc)]..#3D.a;...
......pc.+#3D.2;.goto.fetch;#0A...case.F_spw:...Rb(
pc);.Rw(p+GW(pc));#0A.................Wp[GW(pc)]..#3D
.a;.........pc.+#3D.4;.goto.fetch;#0A#0A...case.F_l
gh:...Rb(pc);.Rw(g+GH(pc));#0A.................b.#3D
.a;.a.#3D.Wg[GH(pc)];...pc.+#3D.2;.goto.fetch;#0A..
.case.F_lg1:...Rb(pc);.Rw(g+256+B[pc]);#0A.........
........b.#3D.a;.a.#3D.Wg1[B[pc++]];..........goto.
fetch;#0A...case.F_lg:....Rb(pc);.Rw(g+B[pc]);#0A..
...............b.#3D.a;.a.#3D.Wg[B[pc++]];.........
..goto.fetch;#0A#0A...case.F_sgh:...Rb(pc);.Rw(g+GH
(pc));#0A.................Wg[GH(pc)]...#3D.a;......
..pc.+#3D.2;.goto.fetch;#0A...case.F_sg1:...Rb(pc);
.Rw(g+256+B[pc]);#0A.................Wg1[B[pc++]].#3D
.a;.................goto.fetch;#0A...case.F_sg:....
Rb(pc);.Rw(g+B[pc]);#0A.................Wg[B[pc++]]
..#3D.a;.................goto.fetch;#0A#0A...case.F
_llgh:.b.#3D.a;.Rb(pc);.a.#3D.g+GH(pc);......pc.+#3D
.2;.goto.fetch;#0A...case.F_llg1:.b.#3D.a;.Rb(pc);.
a.#3D.g+256+B[pc++];..........goto.fetch;#0A...case
.F_llg:..b.#3D.a;.Rb(pc);.a.#3D.g+B[pc++];.........
.....goto.fetch;#0A#0A...case.F_ll+1:.Rb(pc);.i.#3D
.(pc>>1).+.B[pc];#0A................Rh(i);..i.#3D.(
i<<1).+.SH[i];#0A................Rw(i>>B2Wsh);.b.#3D
.a;.a.#3D.W[i>>B2Wsh];..........pc++;.goto.fetch;#0A
#0A...case.F_ll:...Rb(pc);.Rw((pc+SB[pc])>>B2Wsh);#0A
................b.#3D.a;.a.#3D.W[(pc+SB[pc])>>B2Wsh
];pc++;.goto.fetch;#0A#0A...case.F_sl+1:.Rb(pc);.i.
#3D.(pc>>1).+.B[pc];#0A................Rh(i);.i.#3D
.(i<<1).+.SH[i];#0A................Rw(i>>B2Wsh);.W[
i>>B2Wsh].#3D.a;.................pc++;.goto.fetch;#0A
#0A...case.F_sl:...Rb(pc);.Rw((pc+SB[pc])>>B2Wsh);#0A
................W[(pc+SB[pc])>>B2Wsh].#3D.a;.......
pc++;.goto.fetch;#0A...#0A...case.F_lll+1:Rb(pc);.i
.#3D.(pc>>1).+.B[pc];#0A................Rh(i);.i.#3D
.(i<<1).+.SH[i];#0A................b.#3D.a;.a.#3D.i
>>B2Wsh;.............pc++;.goto.fetch;#0A#0A...case
.F_lll:..Rb(pc);.b.#3D.a;.a.#3D.(pc+SB[pc])>>B2Wsh;
...pc++;.goto.fetch;#0A...#0A...case.F_l0+10:.b.#3D
.a;.a.#3D.10;.goto.fetch;#0A...case.F_l0+9:..b.#3D.
a;.a.#3D..9;.goto.fetch;#0A...case.F_l0+8:..b.#3D.a
;.a.#3D..8;.goto.fetch;#0A...case.F_l0+7:..b.#3D.a;
.a.#3D..7;.goto.fetch;#0A...case.F_l0+6:..b.#3D.a;.
a.#3D..6;.goto.fetch;#0A...case.F_l0+5:..b.#3D.a;.a
.#3D..5;.goto.fetch;#0A...case.F_l0+4:..b.#3D.a;.a.
#3D..4;.goto.fetch;#0A...case.F_l0+3:..b.#3D.a;.a.#3D
..3;.goto.fetch;#0A...case.F_l0+2:..b.#3D.a;.a.#3D.
.2;.goto.fetch;#0A...case.F_l0+1:..b.#3D.a;.a.#3D..
1;.goto.fetch;#0A...case.F_l0:....b.#3D.a;.a.#3D..0
;.goto.fetch;#0A...case.F_l0-1:..b.#3D.a;.a.#3D.-1;
.goto.fetch;.#0A#0A...case.F_l:.....Rb(pc);.b.#3D.a
;.a.#3D.B[pc++];...............goto.fetch;#0A...cas
e.F_lh:....Rb(pc);.b.#3D.a;.a.#3D.GH(pc);.......pc.
+#3D.2;.goto.fetch;#0A...case.F_lw:....Rb(pc);.b.#3D
.a;.a.#3D.GW(pc);.......pc.+#3D.4;.goto.fetch;#0A#0A
...case.F_lm:....Rb(pc);.b.#3D.a;.a.#3D.-.WD(B[pc++
]);.........goto.fetch;#0A...case.F_lmh:...Rb(pc);.
b.#3D.a;.a.#3D.-.WD(GH(pc));.pc.+#3D.2;.goto.fetch;
#0A................#0A...case.F_lf+1:..b.#3D.a;#0A.
................Rb(pc);.a.#3D.(pc>>1).+.B[pc];#0A..
...............Rh(a);.a.#3D.(a<<1).+.SH[a];........
.pc++;.goto.fetch;#0A#0A...case.F_lf:....Rb(pc);.b.
#3D.a;.a.#3D.pc.+.SB[pc];.....pc++;.goto.fetch;#0A.
#0A...case.F_k0gh+11:.Rw(p+11);.Wp[11].#3D.p<<B2Wsh
;.p.+#3D.11;.goto.applygh;#0A...case.F_k0gh+10:.Rw(
p+10);.Wp[10].#3D.p<<B2Wsh;.p.+#3D.10;.goto.applygh
;#0A...case.F_k0gh+9:..Rw(p+9);..Wp[.9].#3D.p<<B2Ws
h;.p.+#3D..9;.goto.applygh;#0A...case.F_k0gh+8:..Rw
(p+8);..Wp[.8].#3D.p<<B2Wsh;.p.+#3D..8;.goto.applyg
h;#0A...case.F_k0gh+7:..Rw(p+7);..Wp[.7].#3D.p<<B2W
sh;.p.+#3D..7;.goto.applygh;#0A...case.F_k0gh+6:..R
w(p+6);..Wp[.6].#3D.p<<B2Wsh;.p.+#3D..6;.goto.apply
gh;#0A...case.F_k0gh+5:..Rw(p+5);..Wp[.5].#3D.p<<B2
Wsh;.p.+#3D..5;.goto.applygh;#0A...case.F_k0gh+4:..
Rw(p+4);..Wp[.4].#3D.p<<B2Wsh;.p.+#3D..4;.goto.appl
ygh;#0A...case.F_k0gh+3:..Rw(p+3);..Wp[.3].#3D.p<<B
2Wsh;.p.+#3D..3;#0A...applygh:........Wp....#3D.W+p
;#0A...................Rw(p+1);.Wp[1].#3D.pc.+.2;#0A
...................Rb(pc);.Rw(g+GH(pc));.pc....#3D.
Wg[GH(pc)];#0A...................Rw(p+2);.Wp[2].#3D
.pc;#0A...................Rw(p+3);.Wp[3].#3D..a;#0A
...................if.(pc>#3D0).goto.fetch;#0A.....
..............goto.negpc;#0A#0A...case.F_k0g1+11:.R
w(p+11);.Wp[11].#3D.p<<B2Wsh;.p.+#3D.11;.goto.apply
g1;#0A...case.F_k0g1+10:.Rw(p+10);.Wp[10].#3D.p<<B2
Wsh;.p.+#3D.10;.goto.applyg1;#0A...case.F_k0g1+9:..
Rw(p+9);..Wp[.9].#3D.p<<B2Wsh;.p.+#3D..9;.goto.appl
yg1;#0A...case.F_k0g1+8:..Rw(p+8);..Wp[.8].#3D.p<<B
2Wsh;.p.+#3D..8;.goto.applyg1;#0A...case.F_k0g1+7:.
.Rw(p+7);..Wp[.7].#3D.p<<B2Wsh;.p.+#3D..7;.goto.app
lyg1;#0A...case.F_k0g1+6:..Rw(p+6);..Wp[.6].#3D.p<<
B2Wsh;.p.+#3D..6;.goto.applyg1;#0A...case.F_k0g1+5:
..Rw(p+5);..Wp[.5].#3D.p<<B2Wsh;.p.+#3D..5;.goto.ap
plyg1;#0A...case.F_k0g1+4:..Rw(p+4);..Wp[.4].#3D.p<
<B2Wsh;.p.+#3D..4;.goto.applyg1;#0A...case.F_k0g1+3
:..Rw(p+3);..Wp[.3].#3D.p<<B2Wsh;.p.+#3D..3;#0A...a
pplyg1:........Wp....#3D.W+p;#0A...................
Rw(p+1);.Wp[1].#3D.pc.+.1;#0A...................Rb(
pc);.Rw(g+256+B[pc]);.pc....#3D.Wg1[B[pc]];#0A.....
..............Rw(p+2);.Wp[2].#3D.pc;#0A............
.......Rw(p+3);.Wp[3].#3D.a;#0A...................i
f.(pc>#3D0).goto.fetch;#0A...................goto.n
egpc;#0A.#0A...case.F_k0g+11:.Rw(p+11);.Wp[11].#3D.
p<<B2Wsh;.p.+#3D.11;.goto.applyg;#0A...case.F_k0g+1
0:.Rw(p+10);.Wp[10].#3D.p<<B2Wsh;.p.+#3D.10;.goto.a
pplyg;#0A...case.F_k0g+9:..Rw(p+9);..Wp[.9].#3D.p<<
B2Wsh;.p.+#3D..9;.goto.applyg;#0A...case.F_k0g+8:..
Rw(p+8);..Wp[.8].#3D.p<<B2Wsh;.p.+#3D..8;.goto.appl
yg;#0A...case.F_k0g+7:..Rw(p+7);..Wp[.7].#3D.p<<B2W
sh;.p.+#3D..7;.goto.applyg;#0A...case.F_k0g+6:..Rw(
p+6);..Wp[.6].#3D.p<<B2Wsh;.p.+#3D..6;.goto.applyg;
#0A...case.F_k0g+5:..Rw(p+5);..Wp[.5].#3D.p<<B2Wsh;
.p.+#3D..5;.goto.applyg;#0A...case.F_k0g+4:..Rw(p+4
);..Wp[.4].#3D.p<<B2Wsh;.p.+#3D..4;.goto.applyg;#0A
...case.F_k0g+3:..Rw(p+3);..Wp[.3].#3D.p<<B2Wsh;.p.
+#3D..3;#0A...applyg:........Wp....#3D.W+p;#0A.....
.............Rw(p+1);.Wp[1].#3D.pc.+.1;#0A.........
.........Rb(pc);.Rw(g+B[pc]);.pc....#3D.Wg[B[pc]];#0A
..................Rw(p+2);.Wp[2].#3D.pc;#0A........
..........Rw(p+3);.Wp[3].#3D.a;#0A.................
.if.(pc>#3D0).goto.fetch;#0A..................goto.
negpc;#0A.#0A...case.F_k0+11:..Rw(p+11);.Wp[11].#3D
.p<<B2Wsh;.p.+#3D.11;.goto.applyk;#0A...case.F_k0+1
0:..Rw(p+10);.Wp[10].#3D.p<<B2Wsh;.p.+#3D.10;.goto.
applyk;#0A...case.F_k0+9:...Rw(p+9);..Wp[.9].#3D.p<
<B2Wsh;.p.+#3D..9;.goto.applyk;#0A...case.F_k0+8:..
.Rw(p+8);..Wp[.8].#3D.p<<B2Wsh;.p.+#3D..8;.goto.app
lyk;#0A...case.F_k0+7:...Rw(p+7);..Wp[.7].#3D.p<<B2
Wsh;.p.+#3D..7;.goto.applyk;#0A...case.F_k0+6:...Rw
(p+6);..Wp[.6].#3D.p<<B2Wsh;.p.+#3D..6;.goto.applyk
;#0A...case.F_k0+5:...Rw(p+5);..Wp[.5].#3D.p<<B2Wsh
;.p.+#3D..5;.goto.applyk;#0A...case.F_k0+4:...Rw(p+
4);..Wp[.4].#3D.p<<B2Wsh;.p.+#3D..4;.goto.applyk;#0A
...case.F_k0+3:...Rw(p+3);..Wp[.3].#3D.p<<B2Wsh;.p.
+#3D..3;#0A...applyk:........Wp....#3D.W+p;#0A.....
.............Rw(p+1);.Wp[1].#3D.WD.pc;#0A..........
........pc....#3D.a;#0A..................Rw(p+2);.W
p[2].#3D.pc;#0A..................Rw(p+3);.Wp[3].#3D
.a.#3D.b;#0A..................if.(pc>#3D0).goto.fet
ch;#0A..................goto.negpc;#0A#0A...case.F_
k:......Rb(pc);.k.#3D.B[pc];.Rw(p+k);.Wp[k].#3D.p<<
B2Wsh;.p.+#3D..k;#0A..................Wp....#3D.W+p
;#0A..................Rw(p+1);.Wp[1].#3D.pc.+.1;#0A
..................pc....#3D.a;#0A..................
Rw(p+2);.Wp[2].#3D.pc;#0A..................Rw(p+3);
.Wp[3].#3D.a.#3D.b;#0A..................if.(pc>#3D0
).goto.fetch;#0A..................goto.negpc;#0A#0A
...case.F_kh:.....Rb(pc);.k.#3D.GH(pc);.Rw(p+k);.Wp
[k].#3D.p<<B2Wsh;.p.+#3D..k;#0A..................Wp
....#3D.W+p;#0A..................Rw(p+1);.Wp[1].#3D
.pc.+.2;#0A..................pc....#3D.a;#0A.......
...........Rw(p+2);.Wp[2].#3D.pc;#0A...............
...Rw(p+3);.Wp[3].#3D.a.#3D.b;#0A..................
if.(pc>#3D0).goto.fetch;#0A..................goto.n
egpc;#0A#0A...case.F_kw:.....Rb(pc);.k.#3D.GW(pc);.
Rw(p+k);.Wp[k].#3D.p<<B2Wsh;.p.+#3D..k;#0A.........
.........Wp....#3D.W+p;#0A..................Rw(p+1)
;.Wp[1].#3D.pc.+.4;#0A..................pc....#3D.a
;#0A..................Rw(p+2);.Wp[2].#3D.pc;#0A....
..............Rw(p+3);.Wp[3].#3D.a.#3D.b;#0A.......
...........if.(pc>#3D0).goto.fetch;#0A.............
.....goto.negpc;#0A#0A...case.F_jeq:...if(b#3D#3Da)
.{.Rb(pc);.pc.+#3D.SB[pc];...goto.fetch;.}#0A......
...........pc++;.goto.fetch;#0A...case.F_jeq+1:.if(
b#3D#3Da).goto.indjump;#0A.................pc++;.go
to.fetch;#0A...case.F_jeq+2:.if(a#3D#3D0).{.Rb(pc);
.pc.+#3D.SB[pc];...goto.fetch;.}#0A................
.pc++;.goto.fetch;#0A...case.F_jeq+3:.if(a#3D#3D0).
goto.indjump;#0A.................pc++;.goto.fetch;#0A
#0A...case.F_jne:...if(b!#3Da).{.Rb(pc);.pc.+#3D.SB
[pc];...goto.fetch;.}#0A.................pc++;.goto
.fetch;#0A...case.F_jne+1:.if(b!#3Da).goto.indjump;
#0A.................pc++;.goto.fetch;#0A...case.F_j
ne+2:.if(a!#3D0).{.Rb(pc);.pc.+#3D.SB[pc];...goto.f
etch;.}#0A.................pc++;.goto.fetch;#0A...c
ase.F_jne+3:.if(a!#3D0).goto.indjump;#0A...........
......pc++;.goto.fetch;#0A#0A...case.F_jls:...if(b<
a).{.Rb(pc);.pc.+#3D.SB[pc];...goto.fetch;.}#0A....
.............pc++;.goto.fetch;#0A...case.F_jls+1:.i
f(b<a).goto.indjump;#0A.................pc++;.goto.
fetch;#0A...case.F_jls+2:.if(a<0).{.Rb(pc);.pc.+#3D
.SB[pc];...goto.fetch;.}#0A.................pc++;.g
oto.fetch;#0A...case.F_jls+3:.if(a<0).goto.indjump;
#0A.................pc++;.goto.fetch;#0A#0A...case.
F_jgr:...if(b>a).{.Rb(pc);.pc.+#3D.SB[pc];...goto.f
etch;.}#0A.................pc++;.goto.fetch;#0A...c
ase.F_jgr+1:.if(b>a).goto.indjump;#0A..............
...pc++;.goto.fetch;#0A...case.F_jgr+2:.if(a>0).{.R
b(pc);.pc.+#3D.SB[pc];...goto.fetch;.}#0A..........
.......pc++;.goto.fetch;#0A...case.F_jgr+3:.if(a>0)
.goto.indjump;#0A.................pc++;.goto.fetch;
#0A#0A...case.F_jle:...if(b<#3Da).{Rb(pc);..pc.+#3D
.SB[pc];...goto.fetch;.}#0A.................pc++;.g
oto.fetch;#0A...case.F_jle+1:.if(b<#3Da).goto.indju
mp;#0A.................pc++;.goto.fetch;#0A...case.
F_jle+2:.if(a<#3D0).{.Rb(pc);.pc.+#3D.SB[pc];...got
o.fetch;.}#0A.................pc++;.goto.fetch;#0A.
..case.F_jle+3:.if(a<#3D0).goto.indjump;#0A........
.........pc++;.goto.fetch;#0A#0A...case.F_jge:...if
(b>#3Da).{.Rb(pc);.pc.+#3D.SB[pc];...goto.fetch;.}#0A
.................pc++;.goto.fetch;#0A...case.F_jge+
1:.if(b>#3Da).goto.indjump;#0A.................pc++
;.goto.fetch;#0A...case.F_jge+2:.if(a>#3D0).{.Rb(pc
);.pc.+#3D.SB[pc];...goto.fetch;.}#0A..............
...pc++;.goto.fetch;#0A...case.F_jge+3:.if(a>#3D0).
goto.indjump;#0A.................pc++;.goto.fetch;#0A
#0A...case.F_j:.....Rb(pc);.pc.+#3D.SB[pc];........
goto.fetch;#0A#0A.indjump:#0A...case.F_j+1:...Rb(pc
);.pc.#3D.(pc>>1).+.B[pc];#0A.................Rh(pc
);.pc.#3D.(pc<<1).+.SH[pc];#0A.................goto
.fetch;#0A#0A...case.F_ap0+12:.Rw(p+12);.a.#3D.a.+.
Wp[12];.goto.fetch;#0A...case.F_ap0+11:.Rw(p+11);.a
.#3D.a.+.Wp[11];.goto.fetch;#0A...case.F_ap0+10:.Rw
(p+10);.a.#3D.a.+.Wp[10];.goto.fetch;#0A...case.F_a
p0+9:..Rw(p+9);..a.#3D.a.+.Wp[.9];.goto.fetch;#0A..
.case.F_ap0+8:..Rw(p+8);..a.#3D.a.+.Wp[.8];.goto.fe
tch;#0A...case.F_ap0+7:..Rw(p+7);..a.#3D.a.+.Wp[.7]
;.goto.fetch;#0A...case.F_ap0+6:..Rw(p+6);..a.#3D.a
.+.Wp[.6];.goto.fetch;#0A...case.F_ap0+5:..Rw(p+5);
..a.#3D.a.+.Wp[.5];.goto.fetch;#0A...case.F_ap0+4:.
.Rw(p+4);..a.#3D.a.+.Wp[.4];.goto.fetch;#0A...case.
F_ap0+3:..Rw(p+3);..a.#3D.a.+.Wp[.3];.goto.fetch;#0A
#0A...case.F_ap:....Rb(pc);.Rw(p+B[pc]);.....a.+#3D
.Wp[B[pc++]];.........goto.fetch;#0A...case.F_aph:.
..Rb(pc);.Rw(p+GH(pc));....a.+#3D.Wp[GH(pc)];.pc.+#3D
.2;.goto.fetch;#0A...case.F_apw:...Rb(pc);.Rw(p+GW(
pc));....a.+#3D.Wp[GW(pc)];.pc.+#3D.4;.goto.fetch;#0A
...case.F_agh:...Rb(pc);.Rw(g+GH(pc));....a.+#3D.Wg
[GH(pc)];.pc.+#3D.2;.goto.fetch;#0A...case.F_ag1:..
.Rb(pc);.Rw(g+256+B[pc]);.a.+#3D.Wg1[B[pc++]];.....
...goto.fetch;#0A...case.F_ag:....Rb(pc);.Rw(g+B[pc
]);.....a.+#3D.Wg[B[pc++]];.........goto.fetch;#0A#0A
...case.F_a0+5:.a.+#3D.5;.goto.fetch;#0A...case.F_a
0+4:.a.+#3D.4;.goto.fetch;#0A...case.F_a0+3:.a.+#3D
.3;.goto.fetch;#0A...case.F_a0+2:.a.+#3D.2;.goto.fe
tch;#0A...case.F_a0+1:.a.+#3D.1;.goto.fetch;#0A...c
ase.F_nop:..........goto.fetch;#0A#0A...case.F_a:..
..Rb(pc);.a.+#3D.B[pc++];...........goto.fetch;#0A.
..case.F_ah:...Rb(pc);.a.+#3D.GH(pc);...pc.+#3D.2;.
goto.fetch;#0A...case.F_aw:...Rb(pc);.a.+#3D.GW(pc)
;...pc.+#3D.4;.goto.fetch;#0A...case.F_s:....Rb(pc)
;.a.-#3D.B[pc++];...........goto.fetch;#0A...case.F
_sh:...Rb(pc);.a.-#3D.GH(pc);...pc.+#3D.2;.goto.fet
ch;#0A#0A...case.F_s0+4:.a.-#3D.4;.goto.fetch;#0A..
.case.F_s0+3:.a.-#3D.3;.goto.fetch;#0A...case.F_s0+
2:.a.-#3D.2;.goto.fetch;#0A...case.F_s0+1:.a.-#3D.1
;.goto.fetch;#0A#0A...case.F_l0p0+12:.Rw(p+12);.Rw(
Wp[12]+0);#0A...................b.#3D.a;.a.#3D.W[Wp
[12]+0];.goto.fetch;#0A...case.F_l0p0+11:.Rw(p+11);
.Rw(Wp[11]+0);#0A...................b.#3D.a;.a.#3D.
W[Wp[11]+0];.goto.fetch;#0A...case.F_l0p0+10:.Rw(p+
10);.Rw(Wp[10]+0);#0A...................b.#3D.a;.a.
#3D.W[Wp[10]+0];.goto.fetch;#0A...case.F_l0p0+9:..R
w(p+9);...Rw(Wp[9]+0);#0A...................b.#3D.a
;.a.#3D.W[Wp[.9]+0];.goto.fetch;#0A...case.F_l0p0+8
:..Rw(p+8);...Rw(Wp[8]+0);#0A...................b.#3D
.a;.a.#3D.W[Wp[.8]+0];.goto.fetch;#0A...case.F_l0p0
+7:..Rw(p+7);...Rw(Wp[7]+0);#0A...................b
.#3D.a;.a.#3D.W[Wp[.7]+0];.goto.fetch;#0A...case.F_
l0p0+6:..Rw(p+6);...Rw(Wp[6]+0);#0A................
...b.#3D.a;.a.#3D.W[Wp[.6]+0];.goto.fetch;#0A...cas
e.F_l0p0+5:..Rw(p+5);...Rw(Wp[5]+0);#0A............
.......b.#3D.a;.a.#3D.W[Wp[.5]+0];.goto.fetch;#0A..
.case.F_l0p0+4:..Rw(p+4);...Rw(Wp[4]+0);#0A........
...........b.#3D.a;.a.#3D.W[Wp[.4]+0];.goto.fetch;#0A
...case.F_l0p0+3:..Rw(p+3);...Rw(Wp[3]+0);#0A......
.............b.#3D.a;.a.#3D.W[Wp[.3]+0];.goto.fetch
;#0A#0A...case.F_l1p0+6:..Rw(p+6);...Rw(Wp[6]+1);#0A
...................b.#3D.a;.a.#3D.W[Wp[.6]+1];.goto
.fetch;#0A...case.F_l1p0+5:..Rw(p+5);...Rw(Wp[5]+1)
;#0A...................b.#3D.a;.a.#3D.W[Wp[.5]+1];.
goto.fetch;#0A...case.F_l1p0+4:..Rw(p+4);...Rw(Wp[4
]+1);#0A...................b.#3D.a;.a.#3D.W[Wp[.4]+
1];.goto.fetch;#0A...case.F_l1p0+3:..Rw(p+3);...Rw(
Wp[3]+1);#0A...................b.#3D.a;.a.#3D.W[Wp[
.3]+1];.goto.fetch;#0A#0A...case.F_l2p0+5:..Rw(p+5)
;...Rw(Wp[5]+2);#0A...................b.#3D.a;.a.#3D
.W[Wp[.5]+2];.goto.fetch;#0A...case.F_l2p0+4:..Rw(p
+4);...Rw(Wp[4]+2);#0A...................b.#3D.a;.a
.#3D.W[Wp[.4]+2];.goto.fetch;#0A...case.F_l2p0+3:..
Rw(p+3);...Rw(Wp[3]+2);#0A...................b.#3D.
a;.a.#3D.W[Wp[.3]+2];.goto.fetch;#0A#0A...case.F_l3
p0+4:..Rw(p+4);...Rw(Wp[4]+3);#0A..................
.b.#3D.a;.a.#3D.W[Wp[.4]+3];.goto.fetch;#0A...case.
F_l3p0+3:..Rw(p+3);...Rw(Wp[3]+3);#0A..............
.....b.#3D.a;.a.#3D.W[Wp[.3]+3];.goto.fetch;#0A#0A.
..case.F_l4p0+4:..Rw(p+4);...Rw(Wp[4]+4);#0A.......
............b.#3D.a;.a.#3D.W[Wp[.4]+4];.goto.fetch;
#0A...case.F_l4p0+3:..Rw(p+3);...Rw(Wp[3]+4);#0A...
................b.#3D.a;.a.#3D.W[Wp[.3]+4];.goto.fe
tch;#0A#0A...case.F_l0gh:..Rb(pc);.Rw(g+GH(pc));.Rw
(Wg[GH(pc)]+0);#0A.................b.#3D.a;.a.#3D.W
[Wg[GH(pc)]+0];.pc.+#3D.2;.goto.fetch;#0A...case.F_
l1gh:..Rb(pc);.Rw(g+GH(pc));.Rw(Wg[GH(pc)]+1);#0A..
...............b.#3D.a;.a.#3D.W[Wg[GH(pc)]+1];.pc.+
#3D.2;.goto.fetch;#0A...case.F_l2gh:..Rb(pc);.Rw(g+
GH(pc));.Rw(Wg[GH(pc)]+2);#0A.................b.#3D
.a;.a.#3D.W[Wg[GH(pc)]+2];.pc.+#3D.2;.goto.fetch;#0A
...case.F_l0g1:..Rb(pc);.Rw(g+256+B[pc]);.Rw(Wg1[B[
pc]]+0);#0A.................b.#3D.a;.a.#3D.W[Wg1[B[
pc++]]+0];........goto.fetch;#0A...case.F_l1g1:..Rb
(pc);.Rw(g+256+B[pc]);.Rw(Wg1[B[pc]]+1);#0A........
.........b.#3D.a;.a.#3D.W[Wg1[B[pc++]]+1];........g
oto.fetch;#0A...case.F_l2g1:..Rb(pc);.Rw(g+256+B[pc
]);.Rw(Wg1[B[pc]]+2);#0A.................b.#3D.a;.a
.#3D.W[Wg1[B[pc++]]+2];........goto.fetch;#0A...cas
e.F_l0g:...Rb(pc);.Rw(g+B[pc]);.Rw(Wg[B[pc]]+0);#0A
.................b.#3D.a;.a.#3D.W[Wg[B[pc++]]+0];..
.......goto.fetch;#0A...case.F_l1g:...Rb(pc);.Rw(g+
B[pc]);.Rw(Wg[B[pc]]+1);#0A.................b.#3D.a
;.a.#3D.W[Wg[B[pc++]]+1];.........goto.fetch;#0A...
case.F_l2g:...Rb(pc);.Rw(g+B[pc]);.Rw(Wg[B[pc]]+2);
#0A.................b.#3D.a;.a.#3D.W[Wg[B[pc++]]+2]
;.........goto.fetch;#0A#0A...case.F_s0gh:..Rb(pc);
.Rw(g+GH(pc));.Rw(Wg[GH(pc)]+0);#0A................
.W[Wg[GH(pc)]+0].#3D.a;........pc.+#3D.2;.goto.fetc
h;#0A...case.F_s0g1:..Rb(pc);.Rw(g+256+B[pc]);.Rw(W
g1[B[pc]]+0);#0A.................W[Wg1[B[pc++]]+0].
#3D.a;...............goto.fetch;#0A...case.F_s0g:..
.Rb(pc);.Rw(g+B[pc]);.Rw(Wg[B[pc]]+0);#0A..........
.......W[Wg[B[pc++]]+0].#3D.a;................goto.
fetch;#0A#0A...case.F_stp0+5:.Rw(p+5);.Rw(a+Wp[5]);
.W[a+Wp[5]].#3D.b;.goto.fetch;#0A...case.F_stp0+4:.
Rw(p+4);.Rw(a+Wp[4]);.W[a+Wp[4]].#3D.b;.goto.fetch;
#0A...case.F_stp0+3:.Rw(p+3);.Rw(a+Wp[3]);.W[a+Wp[3
]].#3D.b;.goto.fetch;#0A#0A...case.F_st0p0+4:.Rw(p+
4);.Rw(Wp[4]+0);.W[Wp[4]+0].#3D.a;.goto.fetch;#0A..
.case.F_st0p0+3:.Rw(p+3);.Rw(Wp[3]+0);.W[Wp[3]+0].#3D
.a;.goto.fetch;#0A#0A...case.F_st1p0+4:.Rw(p+4);.Rw
(Wp[4]+1);.W[Wp[4]+1].#3D.a;.goto.fetch;#0A...case.
F_st1p0+3:.Rw(p+3);.Rw(Wp[3]+1);.W[Wp[3]+1].#3D.a;.
goto.fetch;#0A...#0A...case.F_rvp0+7:.Rw(p+7);.Rw(a
+Wp[7]);.a.#3D.W[a+Wp[7]];.goto.fetch;#0A...case.F_
rvp0+6:.Rw(p+6);.Rw(a+Wp[6]);.a.#3D.W[a+Wp[6]];.got
o.fetch;#0A...case.F_rvp0+5:.Rw(p+5);.Rw(a+Wp[5]);.
a.#3D.W[a+Wp[5]];.goto.fetch;#0A...case.F_rvp0+4:.R
w(p+4);.Rw(a+Wp[4]);.a.#3D.W[a+Wp[4]];.goto.fetch;#0A
...case.F_rvp0+3:.Rw(p+3);.Rw(a+Wp[3]);.a.#3D.W[a+W
p[3]];.goto.fetch;#0A...}#0A#0Anegpc:#0A...res.#3D.
4;../*.negative.pc..*/.#0Aret:#0A...Rw(regs+0);.W[r
egs+0]..#3D.a;..../*.Save.the.machine.registers..*/
#0A...Rw(regs+1);.W[regs+1]..#3D.b;#0A...Rw(regs+2)
;.W[regs+2]..#3D.c;#0A...Rw(regs+3);.W[regs+3]..#3D
.p<<B2Wsh;#0A...Rw(regs+4);.W[regs+4]..#3D.g<<B2Wsh
;#0A...Rw(regs+5);.W[regs+5]..#3D.st;#0A...Rw(regs+
6);.W[regs+6]..#3D.pc;#0A...Rw(regs+7);.W[regs+7]..
#3D.count;#0A...Rw(regs+8);.W[regs+8]..#3D.mw;#0A..
.#0A...return.res;#0A}#0A#0A

######cintcode/com/prompt.b#
//.(C).Copyright.1978.Tripos.Research.Group#0A//...
..University.of.Cambridge#0A//.....Computer.Laborat
ory#0A#0ASECTION."PROMPT"#0A#0AGET."libhdr"#0AGET."
clihdr"#0A#0ALET.start().#3D.VALOF#0A{.LET.prompt.#3D
."%5#2E3d>."#0A..LET.v.#3D.VEC.15#0A#0A..UNLESS.rda
rgs("PROMPT,P0/S,P1/S,P2/S,P3/S,P4/S,NO/S",v,15).DO
#0A..{.writes("Parameters.no.good.for.PROMPT*N")#0A
....RETURN#0A..}#0A#0A..IF.v!0.DO.prompt.:#3D.v!0..
.......................//.PROMPT#0A..IF.v!1.DO.prom
pt.:#3D.">."........................//.P0/S#0A..IF.
v!2.DO.prompt.:#3D."%+%+%n:%2z:%2z>."..........//.P
1/S#0A..IF.v!3.DO.prompt.:#3D."%+%+%n:%2z:%2z#2E%3z
>."......//.P2/S#0A..IF.v!4.DO.prompt.:#3D."%5#2E3d
.%+%n:%2z:%2z>."......//.P3/S#0A..IF.v!5.DO.prompt.
:#3D."%5#2E3d.%+%n:%2z:%2z#2E%3z>."..//.P3/S#0A#0A.
.IF.prompt.FOR.i.#3D.0.TO.prompt%0.DO.cli_prompt%i.
:#3D.prompt%i#0A#0A..TEST.v!6......................
..................//.NO/S#0A..THEN.cli_status.:#3D.
cli_status.|..clibit_noprompt#0A..ELSE.cli_status.:
#3D.cli_status.&.~clibit_noprompt#0A}#0A

######cintcode/com/bin-x8.b#
//.This.is.a.program.convert.a.binary.file.into.a.f
ile.of.32-bit.hex.words#2E#0A#0A//.Implemented.by.M
artin.Richards.(c).Aug.2002#0A#0A//.Usage:#0A#0A//.
bin-x8.filename.[[TO].tofile]#0A#0A/*#0AIt.will.con
vert.the.file:#0A#0AABCDEFGHIJKLMNOPQRSTUVWXYZ#0A12
34567890#0A#0Ato:#0A#0A44434241.48474645.4C4B4A49.5
04F4E4D.54535251.58575655.310A5A59.35343332.#0A3938
3736.00000A30.#0A#0A*/#0A#0AGET."libhdr"#0A#0AGLOBA
L.{#0A.eof:.ug#0A.sysin#0A.sysout#0A.fromname#0A.to
name#0A.fromstream#0A.tostream#0A.count#0A}#0A#0ALE
T.start().#3D.VALOF#0A{.LET.argv....#3D.VEC.50#0A..
sysin......:#3D.input()#0A..sysout.....:#3D.output(
)#0A..fromname...:#3D.0#0A..toname.....:#3D."JUNK"#0A
..fromstream.:#3D.0#0A..tostream...:#3D.0#0A..count
......:#3D.0#0A#0A..UNLESS.rdargs("FROM/A,TO/K",.ar
gv,.50).DO#0A..{.writes("Bad.arguments.for.bin-x8,.
format:.FROM/A,TO/K*n")#0A....stop(20)#0A..}#0A#0A.
.fromname.:#3D.argv!0......................//.FROM#0A
..IF.argv!1.DO.toname...:#3D.argv!1.........//.TO#0A
.#0A..fromstream.:#3D.findinput(fromname)#0A..UNLES
S.fromstream.DO#0A..{.writef("can't.open.%s*n",.fro
mname)#0A....stop(20)#0A..}#0A#0A..tostream.:#3D.fi
ndoutput(toname)#0A..UNLESS.tostream.DO#0A..{.write
f("can't.open.%s*n",.toname)#0A....endread()#0A....
stop(20)#0A..}#0A..selectoutput(tostream)#0A#0A..se
lectinput(fromstream)#0A#0A..{.LET.word.#3D.0#0A...
.LET.s.#3D.@word#0A....LET.ch.#3D.binrdch()#0A....I
F.ch#3Dendstreamch.BREAK#0A....s%0.:#3D.ch#0A....ch
.:#3D.binrdch()#0A....IF.ch#3Dendstreamch.GOTO.wr#0A
....s%1.:#3D.ch#0A....ch.:#3D.binrdch()#0A....IF.ch
#3Dendstreamch.GOTO.wr#0A....s%2.:#3D.ch#0A....ch.:
#3D.binrdch()#0A....IF.ch#3Dendstreamch.GOTO.wr#0A.
...s%3.:#3D.ch#0Awr:#0A....writef("%x8.",.word)#0A.
...count.:#3D.count+1#0A....IF.count.REM.8.#3D.0.DO
.newline()#0A..}.REPEAT#0A#0A..UNLESS.count.REM.8.#3D
.0.DO.newline()#0A#0A..UNLESS.sysout#3Dtostream.DO.
endwrite()#0A..endread()#0A#0A..selectoutput(sysout
)#0A..writef("%n.words.written.to.file.*"%s*"*n",.c
ount,.toname)#0A..RESULTIS.0#0A}#0A#0AAND.rdhexword
().#3D.VALOF#0A{.LET.word,.byte.#3D.0,.0#0A..//.Ski
p.initial.white.space#0A..byte.:#3D.rdch().REPEATWH
ILE.byte#3D'.'.|.byte#3D'*n'.|.byte#3D'*c'#0A..resu
lt2.:#3D.-1#0A#0A..{.LET.val.#3D.value(byte)#0A....
UNLESS.0<#3Dval<#3D15.RESULTIS.word#0A....word.:#3D
.(word<<4).+.val#0A....result2.:#3D.0#0A....byte.:#3D
.rdch()#0A....result2.:#3D.0#0A..}.REPEAT#0A}#0A#0A
AND.value(ch).#3D.'0'<#3Dch<#3D'9'.->.ch.-.'0',#0A.
...............'A'<#3Dch<#3D'F'.->.ch.-.'A'.+.10,#0A
................'a'<#3Dch<#3D'f'.->.ch.-.'a'.+.10,#0A
................100#0A#0AAND.wrword(word).BE#0A{.LE
T.s.#3D.@word#0A..binwrch(s%0)#0A..binwrch(s%1)#0A.
.binwrch(s%2)#0A..binwrch(s%3)#0A}#0A#0A#0A#0A#0A#0A
#0A

######cintcode/com/wait.b#
//.(C).Copyright.1978.Tripos.Research.Group#0A//...
..University.of.Cambridge#0A//.....Computer.Laborat
ory#0A#0ASECTION."WAIT"#0A#0AGET."libhdr"#0A#0AMANI
FEST.{#0A..msecspermin.#3D.60000#0A..msecsperhour.#3D
.msecspermin*60#0A..msecsperday.#3D.msecsperhour*24
#0A}#0A#0ALET.start().#3D.VALOF#0A{.LET.argv.#3D.VE
C.50#0A..LET.days,.msecs.#3D.0,.0#0A..LET.daysnow,.
msecsnow.#3D.0,.0#0A..LET.n.#3D.0#0A#0A..//.Get.the
.date.and.time.now#0A..datstamp(@daysnow)#0A#0A..UN
LESS.rdargs("N/N,SEC#3DSECS/S,MIN#3DMINS/S,UNTIL/K"
,.argv,.50).DO#0A..{.error(1)#0A....RESULTIS.20#0A.
.}#0A#0A..UNLESS.argv!3.DO...................//.UNT
IL/K#0A..{.n.:#3D.1#0A....IF.argv!0.DO.n.:#3D.!(arg
v!0)......//.N/N#0A#0A....TEST.argv!2..............
........//.MINS/S#0A....THEN.msecs.:#3D.n.*.60000#0A
....ELSE.msecs.:#3D.n.*.1000#0A....msecs.:#3D.msecs
.+.msecsnow#0A....days.:#3D.daysnow#0A....IF.msecs.
>.msecsperday.DO.days,.msecs.:#3D.days+1,.msecs-mse
csperday#0A..}#0A..IF.argv!3.DO....................
...//.UNTIL/K#0A..{.LET.s.#3D.argv!3#0A....LET.hour
.#3D.0#0A....LET.min.#3D.0#0A....UNLESS.s%0#3D5.DO.
{.error(3);.RESULTIS.20.}#0A....FOR.i#3D1.TO.5.UNLE
SS.i#3D3.->.s%i#3D':',.'0'<#3Ds%i<#3D'9'.DO#0A....{
.error(3)#0A......RESULTIS.20#0A....}#0A....hour.:#3D
.(s%1-'0')*10+s%2-'0'#0A....IF.hour>#3D24.DO.error(
3)#0A....min.:#3D.(s%4-'0')*10+s%5-'0'#0A....IF.min
>#3D60.DO#0A....{.error(3)#0A......RESULTIS.20#0A..
..}#0A....msecs.:#3D.hour*msecsperhour.+.min*60000#0A
....days.:#3D.daysnow#0A....IF.msecs<msecsnow.DO.da
ys.:#3D.days+1#0A..}#0A#0A..{.LET.str.#3D.VEC.14#0A
....dat_to_strings(@days,.str)#0A....//sawritef("De
laying.until.%s.%s*n",.str,.str+5)#0A..}#0A#0A#0A..
//sawritef("Delaying.for.%n.mins.%n.secs*n",.mins,.
secs)#0A..//sawritef("ie.for.%n.secs*n",.60*mins+se
cs)#0A#0A..{.LET.ds,.ms.#3D.?,.?#0A....datstamp(@ds
)#0A....IF.(ds>days).|#0A.......(ds#3Ddays.&.ms>#3D
msecs).BREAK#0A....delay(500).//.Sleep.for.1/2.seco
nd#0A....//IF.testflags(flag_b).DO#0A....//{.writes
("****BREAK*N")#0A....//..RESULTIS.10#0A....//}#0A.
.}.REPEAT#0A#0A..RESULTIS.0#0A}#0A#0A#0AAND.error(n
).BE#0A{.writes(n#3D1.->."Bad.args*N",#0A.........n
#3D2.->."Error.in.number*N",#0A................"Tim
e.should.be.HH:MM*N")#0A}#0A

######cintcode/com/testtime.b#
GET."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.LET.v.#3D
.VEC.5#0A..LET.days.#3D.0#0A..LET.hours.#3D.0#0A..L
ET.mins.#3D.0#0A..LET.secs.#3D.0#0A..LET.msecs.#3D.
0#0A.#0A..MANIFEST.{.secspermin#3D60;.secsperhour#3D
60*60;.secsperday.#3D.60*60*24.}#0A#0A..sys(Sys_dat
stamp,.v)#0A..//.v!0.#3D.days.since.1.Jan.1970#0A..
//.v!1.#3D.msecs.since.midnight#0A..//FOR.i.#3D.0.T
O.1.DO.writef(".%i9",.v!i)#0A..//newline()#0A#0A..d
ays.:#3D.v!0#0A..msecs.:#3D.v!1#0A..secs.:#3D.msecs
/1000#0A..mins.:#3D.secs/60#0A..hours.:#3D.mins/60#0A
..mins.:#3D.mins.MOD.60#0A..secs.:#3D.secs.MOD.60#0A
..msecs.:#3D.msecs.MOD.1000#0A#0A..writef("days#3D%
n.hours#3D%n.mins#3D%n.secs#3D%n.msecs#3D%n*n",#0A.
.........days,.hours,.mins,.secs,.msecs)#0A#0A#0A..
RESULTIS.0#0A}#0A#0A

######cintcode/com/dumpdebug.b#
//.The.program.allows.the.user.to.inspect.the.compa
cted.memory#0A//.dump.of.the.Cintpos.system#2E#0A#0A
//.Martin.Richards.(c).November.2006#0A#0A//.Usage:
#0A#0A//.dumpsys.[FROM.<image>]#0A#0A//.The.FROM.ar
gument.specifies.the.dump.image.file,#0A//.the.defa
ult.DUMP#2Emem#0A#0A//.The.program.is.a.combination
.of.the.sadebug.function.in.sysb/boot#2Eb#0A//.and.
com/dumpsys#2Eb#0A#0A#0A#0ASECTION.".dumpdebug"#0A#0A
GET."libhdr"#0AGET."clihdr"#0A#0A#0AGLOBAL#0A{.eof:
.ug#0A..pptr#0A..gptr#0A..cptr#0A..fsize#0A#0A..reg
s#0A..membase#0A..memlim#0A..memupb#0A..context#0A.
.ch#0A..lch#0A..rch#0A..val#0A..vars#0A..style#0A..
bpt_addr#0A..bpt_instr#0A#0A..imagefilename..//.0.o
r.name.of.the.image.file#0A..imagedata......//.Raw.
DUMP#2Emem.file.(#3D0.if.no.image.given)#0A..addrv.
.........//.memory.addresses#0A..datav..........//.
corresponding.pointers.into.imagedata#0A..datavupb#0A
..imagep..#0A#0A..rec_p;.rec_l...//.Recovery.label.
for.longjump#0A}#0A#0AMANIFEST.{#0A..maxpri....#3D.
maxint#0A#0A..sectnamesize.#3D.(11.+.bytesperword)/
bytesperword#0A..routnamesize.#3D.(11.+.bytesperwor
d)/bytesperword#0A..nameoffset...#3D.-routnamesize#0A
..vecupb.......#3D.5000#0A#0A..g_globsize#3D0;.g_sy
s#3D3;.g_currco#3D7;.g_colist#3D8.#0A#0A..r_a#3D0#0A
..r_b#0A..r_c#0A..r_p#0A..r_g#0A..r_st#0A..r_pc#0A.
.r_count#0A..r_mw#0A..r_upb.#3D.r_mw#0A}#0A#0ALET.r
ch().BE#0A{.lch.:#3D.sys(Sys_sardch).//.This.is.for
.BCPL.Cintcode,.not.Cintpos#2E#0A..ch.:#3D.capitalc
h(lch)#0A}#0A#0ALET.start().BE#0A{.LET.argv.......#3D
.VEC.50#0A..AND.datv.......#3D.VEC.1#0A..AND.datstr
ings.#3D.VEC.12#0A..AND.sysin......#3D.input()#0A..
AND.sysout.....#3D.output()#0A..AND.imagefilename.#3D
."DUMP#2Emem"#0A#0A..UNLESS.rdargs("FROM",.argv,.50
).DO#0A..{.writes("bad.arguments.for.DUMPDEBUG*n")#0A
....stop(20)#0A..}#0A#0A..IF.argv!0.DO.imagefilenam
e.:#3D.argv!0#0A..IF.imagefilename.UNLESS.getimage(
imagefilename).DO#0A..{.writef("Unable.to.load.imag
e.file.%s*n",.imagefilename)#0A....RETURN#0A..}#0A#0A
..rec_p,.rec_l.:#3D.level(),.fin#0A#0A..membase.:#3D
.mem(rootnode+rtn_membase)#0A..memlim..:#3D.mem(roo
tnode+rtn_memsize)#0A..context.:#3D.mem(rootnode+rt
n_context)#0A..//.context.#3D.1...SIGINT.received#0A
..//.context.#3D.2...SIGSEGV.received#0A..//.contex
t.#3D.3...dump.caused.by.fault.in.BOOT.of.standalon
e.debug#0A..//.context.#3D.4...dump.requested.by.us
er.calling.sys(Sys_quit,.-2)#0A..//.context.#3D.5..
.non.zero.user.fault.code#0A..//.context.#3D.6...du
mp.requested.in.standalone.debug#0A#0A..writef("*nI
mage.File:.%s",.imagefilename)#0A..IF.memdatstamp(d
atv).DO#0A..{.dat_to_strings(datv,.datstrings)#0A#0A
....writef("...........Dated:..%s.%s*n",.@datstring
s!0,.@datstrings!5)#0A..}#0A..newline()#0A#0A..SWIT
CHON.context.INTO#0A..{.DEFAULT:..writef("Unknown.r
eason.(%n).for.dumping.memory",.context)#0A........
......ENDCASE#0A....CASE.1:...writef("Dump.caused.b
y.signal.SIGINT")#0A..............ENDCASE#0A....CAS
E.2:...writef("Dump.caused.by.signal.SIGSEGV")#0A..
............ENDCASE#0A....CASE.3:...writef("Dump.ca
used.by.fault.in.BOOT.or.standalone.debug")#0A.....
.........ENDCASE#0A....CASE.4:...writef("Dump.by.us
er.probably.calling:.dumpmem")#0A..............ENDC
ASE#0A....CASE.5:...writef("Dump.caused.by.non.zero
.user.fault.code")#0A..............ENDCASE#0A....CA
SE.6:...writef("Dump.requested.in.standalone.debug"
)#0A..............ENDCASE#0A..}#0A..newline()#0A..#0A
..dumprootnode()#0A#0A..debug()#0A#0Afin:#0A..IF.im
agedata.DO.freevec(imagedata)#0A..IF.addrv.....DO.f
reevec(addrv)#0A..IF.datav.....DO.freevec(datav)#0A
}#0A#0AAND.memdatstamp(v).#3D.VALOF#0A{.LET.tv.#3D.
rootnode+rtn_days#0A.#0A..UNLESS.0<#3Dtv<#3Dmemupb.
RESULTIS.FALSE#0A#0A..v!0.:#3D.mem(tv+0)#0A..v!1.:#3D
.mem(tv+1)#0A#0A..RESULTIS.TRUE#0A}#0A#0AAND.debug(
).#3D.VALOF#0A{.#0A..rec_p,.rec_l.:#3D.level(),.rec
over.//.recovery.point.for.error()#0A#0A..//.Initia
lise.the.standalone.debugger#0A..membase.:#3D.mem(r
ootnode+rtn_membase)#0A..memlim..:#3D.membase.+.mem
(rootnode+rtn_memsize)#0A#0A..//.Get.the.breakpoint
.vectors.from.the.rootnode#0A..bpt_addr..:#3D.mem(r
ootnode+rtn_bptaddr)#0A..bpt_instr.:#3D.mem(rootnod
e+rtn_bptinstr)#0A#0A..//.Get.the.variable.vector.f
rom.the.rootnode#0A..//.so.that.vt10.will.work,.but
.note.that.our.image#0A..//.of.the.dumped.Cintcode.
memory.must.be.writable.so#0A..//.that.1234SV3..wil
l.work.(and.the.removal.of.breakpoints)#2E#0A..vars
..:#3D.mem(rootnode+rtn_dbgvars)#0A#0A..style.:#3D.
'F'.................//.Default.printing.style#0A..v
al...:#3D.0#0A/*#0A..FOR.i.#3D.0.TO.9.DO...........
.//.Remove.all.BRK.instructions.(if.any)#0A..{.LET.
ba.#3D.mem(bpt_addr+i)#0A....//writef("bpt.%n:.addr
:.%i6....instr:.%n*n",.i,.ba,.mem(bpt_instr+i))#0A.
...IF.ba.DO.setmemb(0,.ba,.mem(bpt_instr+i))#0A..}#0A
*/#0A..selectprog(1).//.Select.the.CLI.program#0A#0A
..{.LET.gn.#3D.mem(regs+r_pc).-.globword#0A....LET.
code.#3D.mem(rootnode.+.rtn_abortcode)#0A....LET.me
ss.#3D..VALOF.SWITCHON.code.INTO#0A................
{.CASE...1:.RESULTIS."Illegal.instruction"#0A......
............CASE...2:.RESULTIS."BRK.instruction"#0A
..................CASE...3:.RESULTIS."Zero.count"#0A
..................CASE...4:.TEST.0<#3Dgn<#3Dmem(gpt
r+0)#0A............................THEN.RESULTIS."G
%n.unassigned"#0A............................ELSE.R
ESULTIS."Negative.pc"#0A..................CASE...5:
.RESULTIS."Division.by.zero"#0A..................CA
SE..10:.RESULTIS."Cintasm.single.step"#0A..........
........CASE..11:.RESULTIS."Watch.addr:.%+%i7.value
:.%i8"#0A..................CASE..12:.RESULTIS."Indi
rect.address.out.of.range:.%+%+%+%n"#0A............
......CASE..99:.RESULTIS."User.requested"#0A.......
...........CASE.110:.RESULTIS."Callco.fault"#0A....
..............CASE.111:.RESULTIS."Resumeco.fault"#0A
..................CASE.112:.RESULTIS."Deleteco.faul
t"#0A..................CASE.180:.RESULTIS."Unable.t
o.delete.a.task"#0A..................CASE.181:.RESU
LTIS."Unable.to.send.a.packet"#0A..................
CASE.182:.RESULTIS."Unexpected.pkt.received"#0A....
..............CASE.186:.RESULTIS."Bad.input.stream"
#0A..................CASE.187:.RESULTIS."Bad.output
.stream"#0A..................CASE.188:.RESULTIS."Un
able.to.replenish.input"#0A..................CASE.1
89:.RESULTIS."Wrch.fault"#0A..................CASE.
190:.RESULTIS."Endread.fault"#0A..................C
ASE.191:.RESULTIS."Endwrite.fault"#0A..............
....CASE.197:.RESULTIS."Store.chain.fault"#0A......
............DEFAULT:..RESULTIS."Unknown.fault"#0A..
..............}#0A#0A....writef("*nAbort.code:.%n..
",.mem(rootnode+rtn_abortcode))#0A....writef(mess,.
gn,.mem(1),.mem(2),.mem(3))#0A....newline()#0A..}#0A
#0Arecover:#0A..ch.:#3D.'*n'#0Anxt:................
..........//.Main.loop.for.debug.commands#0A..IF.ch
#3D'*n'.DO.prprompt()#0A#0A..rch().REPEATWHILE.ch#3D
'*s'#0Asw:#0A..SWITCHON.ch.INTO#0A#0A..{.DEFAULT:.e
rror()#0A#0A....CASE.endstreamch:#0A.......newline(
)#0A.......RETURN#0A#0A....CASE.'*s':#0A....CASE.'*
n':GOTO.nxt#0A......#0A....CASE.'?':#0A.......write
s("*n?..........Print.list.of.debug.commands*n")#0A
.......writes("Gn.Pn.Rn.Vn.Wn.An..........Variables
*n")#0A.......writes("G..P..R..V..W..A...........Po
inters*n")#0A.......writes("123.#23o377.#23FF03.'c.
........Constants*n")#0A.......writes("**e./e.%e.+e
.-e.|e.&e.......Dyadic.operators*n")#0A.......write
s("!e.........................Subscription*n")#0A..
.....writes("<.>........................Left/Right.
shift.one.place*n")#0A.......writes("$c.$d.$f.$b.$o
.$s.$u.$x....Set.the.print.style*n")#0A.......write
s("SGn.SPn.SRn.SVn.SAn........Store.current.value*n
")#0A.......writes("S0.S1...Select.the.Boot/CLI.pro
gram*n")#0A.......writes("#3D.......Print.current.v
alue*n")#0A.......writes("Tn......Print.n.consecuti
ve.locations*n")#0A.......writes("Bn......Print.n.b
locks.from.current.position*n")#0A.......writes("I.
......Print.current.instruction*n")#0A.......writes
("N.......Print.next.instruction*n")#0A.......write
s("Q.......Quit.--.exit.from.dumpdebug*n")#0A......
.writes("#2E.......Move.to.current.coroutine*n")#0A
.......writes(",.......Move.down.one.stack.frame*n"
)#0A.......writes(";.......Move.to.parent.coroutine
*n")#0A.......writes("[.......Move.to.first.corouti
ne*n")#0A.......writes("].......Move.to.next.corout
ine*n")#0A.......GOTO.recover#0A#0A....CASE.'0':.CA
SE.'1':.CASE.'2':#0A....CASE.'3':.CASE.'4':.CASE.'5
':#0A....CASE.'6':.CASE.'7':.CASE.'8':#0A....CASE.'
9':.CASE.'#23':.CASE.'*'':#0A....CASE.'G':.CASE.'P'
:.CASE.'R':#0A....CASE.'V':.CASE.'A':#0A...........
...val.:#3D.rdval();.................GOTO.sw#0A#0A.
...CASE.'!':.rch();.val.:#3D.cont(val..+..rdval());
..GOTO.sw#0A....CASE.'+':.rch();.val.:#3D.val..+..r
dval();........GOTO.sw#0A....CASE.'-':.rch();.val.:
#3D.val..-..rdval();........GOTO.sw#0A....CASE.'**'
:rch();.val.:#3D.val..*..rdval();........GOTO.sw#0A
....CASE.'/':.rch();.{.LET.a.#3D.rdval()#0A........
...............UNLESS.a.DO.error()#0A..............
.........val.:#3D.val./.a#0A.......................
GOTO.sw#0A.....................}#0A....CASE.'%':.rc
h();.{.LET.a.#3D.rdval()#0A.......................U
NLESS.a.DO.error()#0A.......................val.:#3D
.val.REM.a#0A.......................GOTO.sw#0A.....
................}#0A....CASE.'|':.rch();.val.:#3D.v
al..|..rdval();........GOTO.sw#0A....CASE.'&':.rch(
);.val.:#3D.val..&..rdval();........GOTO.sw#0A#0A..
..CASE.'<':.val.:#3D.val.<<.1;................GOTO.
nxt#0A....CASE.'>':.val.:#3D.val.>>.1;.............
...GOTO.nxt#0A#0A....CASE.'#3D':.print(val);.newlin
e();..........GOTO.recover#0A#0A....CASE.'S':.{.LET
.type.#3D.?#0A................rch()#0A.............
...//.Is.it.a.program.selection?#0A................
IF.ch#3D'0'.DO.{.selectprog(0);...GOTO.recover.}#0A
................IF.ch#3D'1'.DO.{.selectprog(1);...G
OTO.recover.}#0A................//.No.--.it.must.be
.a.store.instruction#0A................type.:#3D.ch
#0A................rch()#0A................setmem(r
dvaraddr(type),.val)#0A................GOTO.sw#0A..
............}#0A#0A....CASE.'T':.rch()#0A..........
..{.LET.n.#3D.rdn()#0A..............LET.k.#3D.bitsp
erword#3D32.->.5,.4#0A..............IF.n<#3D0.DO.n.
:#3D.1#0A..............FOR.i#3D0.TO.n-1.DO#0A......
........{.IF.i.REM.k.#3D.0.DO.praddr(val+i)#0A.....
...........print(cont(val+i))#0A..............}#0A.
.............newline()#0A..............GOTO.sw#0A..
..........}#0A#0A....CASE.'B':.rch()#0A............
{.LET.n.#3D.rdn()#0A..............IF.n<#3D0.DO.n.:#3D
.1#0A#0A..............{.LET.size.#3D.0#0A..........
......LET.blk.#3D.findblock(val)#0A................
IF.blk<0.BREAK..//.No.suitable.block.found#0A......
..........val.:#3D.blk#0A................size.:#3D.
mem(val).&.-2#0A................prblock(val)#0A....
............n.:#3D.n-1#0A................UNLESS.n.&
.size.BREAK#0A................val.:#3D.val+size#0A.
.............}.REPEAT#0A#0A..............newline()#0A
..............GOTO.sw#0A............}#0A#0A....CASE
.'$':.rch()#0A..............UNLESS.ch#3D'B'.|.ch#3D
'C'.|.ch#3D'D'.|.ch#3D'F'.|#0A.....................
ch#3D'O'.|.ch#3D'S'.|.ch#3D'U'.|.ch#3D'X'.DO#0A....
..........{.writef("Valid.style.letters.are:.BCDFOS
UX*n")#0A................GOTO.nxt#0A..............}
#0A..............style.:#3D.ch#0A..............GOTO
.nxt#0A#0A....CASE.'Q':.newline()#0A..............R
ETURN#0A.........#0A....CASE.'N':.val.:#3D.nextpc(v
al)#0A....CASE.'I':.prinstr(val);.newline();.GOTO.r
ecover#0A#0A....CASE.',':..//.Move.down.one.stack.f
rame.and.output.it#2E#0A.............{.LET.a.#3D.co
nt(pptr)>>2#0A...............IF.a#3D0.DO.{.writef("
.Base.of.stack*n")#0A...........................GOT
O.recover#0A.........................}#0A..........
.....fsize.:#3D.pptr-a#0A...............pptr.:#3D.a
#0A...............wrframe()#0A...............GOTO.r
ecover#0A.............}#0A#0A....CASE.';':.IF.cptr.
DO#0A..............{.LET.c.#3D.cont(cptr+co_parent)
#0A................IF.c<#3D0.DO#0A................{
.writef(".A.root.coroutine.has.no.parent*n")#0A....
..............GOTO.recover#0A................}#0A..
..............cptr.:#3D.c#0A..............}#0A.....
.........GOTO.newc#0A#0A....CASE.'#2E':.cptr.:#3D.c
ont(gptr+g_currco)#0A..............GOTO.newc#0A#0A.
...CASE.']':.cptr.:#3D.cont(cptr+co_list)#0A.......
.......IF.cptr#3D0.DO.{.writef(".End.of.coroutine.l
ist*n")#0A.............................GOTO.recover
#0A...........................}#0A..............GOT
O.newc#0A#0A....CASE.'[':.cptr.:#3D.cont(gptr+g_col
ist)#0A#0Anewc:.........UNLESS.cptr.DO#0A..........
....{.writef("No.such.coroutine*n")#0A.............
...GOTO.recover#0A..............}#0A..............T
EST.cptr#3Dcont(gptr+g_currco)#0A..............THEN
.pptr.:#3D.cont(regs+r_p)>>2#0A..............ELSE.p
ptr.:#3D.cont(cptr+co_pptr)>>2#0A..............fsiz
e.:#3D.cptr.+.6.+.cont(cptr+co_size).-.pptr#0A.....
.........wrcortn()#0A..............GOTO.recover#0A.
.}#0A}#0A#0AAND.prprompt().BE#0A{.TEST.regs#3Dbootr
egs#0A..THEN.writef("#23.")#0A..ELSE.writef("**.")#0A
..deplete(cos)#0A}#0A#0AAND.dumprootnode().BE#0A{.w
ritef("*nRootnode.at.%n*n*n",.rootnode)#0A#0A..writ
ef("..blklist....%i8*n",.cont(rtn_blklist+rootnode)
)#0A..writef("..memsize....%i8*n",.cont(rtn_memsize
+rootnode))#0A..writef("..info.......%i8*n",.cont(r
tn_info+rootnode))#0A..writef("..sys........%i8*n",
.cont(rtn_sys+rootnode))#0A..writef("..blib.......%
i8*n",.cont(rtn_blib+rootnode))#0A..writef("..boot.
......%i8*n",.cont(rtn_boot+rootnode))#0A..writef("
..abortcode..%i8*n",.cont(rtn_abortcode+rootnode))#0A
..writef("..context....%i8*n",.cont(rtn_context+roo
tnode))#0A..writef("..lastp......%i8*n",.cont(rtn_l
astp+rootnode))#0A..writef("..lastg......%i8*n",.co
nt(rtn_lastg+rootnode))#0A#0A}#0A#0AAND.findblock(a
ddr).#3D.VALOF#0A{.//.Find.the.base.of.the.block.co
ntain.addr#0A..//.return.-1.if.no.such.block#0A..LE
T.blocklist..#3D.cont(rootnode+rtn_blklist)#0A..LET
.topofstore.#3D.cont(rootnode+rtn_memsize)#0A..LET.
a.#3D.blocklist#0A..LET.free,.used,.n.#3D.0,.0,.0#0A
#0A..{.LET.size.#3D.cont(a).&.-2..........//.Mask.o
ff.the.size#0A....UNLESS.size.BREAK................
//.End.of.block.chain.reached#0A#0A....UNLESS.a.<#3D
.a+size.<#3D.topofstore.DO#0A....{.writef("******St
ore.chain.corrupt!!*n*#0A..............*Noticed.at.
%n*n",.a)#0A......RESULTIS.a#0A....}#0A....IF.a.<#3D
.addr.<.a+size.RESULTIS.a.//.Found.the.base.of.the.
block#0A....a.:#3D.a+size#0A..}.REPEAT#0A#0A..RESUL
TIS.-1..//.End.of.block.chain.reached#0A}#0A#0AAND.
prblock(a).BE#0A{.LET.size.#3D.cont(a)#0A..LET.free
blk.#3D.(size&1)#3D1#0A..size.:#3D.size.&.-2#0A#0A.
.writef("%i8:%i7.",.a,.size)#0A..IF.freeblk.DO.{.wr
ites("free.");.GOTO.nxt.}#0A#0A..IF.a.#3D.(rootnode
-1).DO.{.writes("Rootnode");.GOTO.nxt.}#0A..IF.cont
(a+3).#3D.sectword.&.memb(a+4,.0).#3D.11.DO#0A..{.L
ET.name.#3D.a+4#0A....writef("Section.")#0A....FOR.
i.#3D.1.TO.memb(name,.0).DO.wrch(memb(name,.i))#0A.
...GOTO.nxt#0A..}#0A#0A..IF.a+1#3D(cont(cliregs+r_g
)>>2).DO.{.writef("CLI.Global.vector");.GOTO.nxt.}#0A
..IF.a+1#3D(cont(bootregs+r_g)>>2).DO.{.writef("Boo
t.Global.vector");.GOTO.nxt.}#0A..{.LET.p.#3D.cont(
cliregs+r_p)>>2#0A....IF.a.<#3D.p.<#3D.a.+.size.DO.
{.writef("a.CLI.coroutine.stack");.GOTO.nxt.}#0A...
.p.:#3D.cont(bootregs+r_p)>>2#0A....IF.a.<#3D.p.<#3D
.a.+.size.DO.{.writef("a.Boot.coroutine.stack");.GO
TO.nxt.}#0A..}#0Adump:#0A..FOR.i.#3D.1.TO.5.DO.{.LE
T.n.#3D.cont(a+i)#0A......................TEST.-10_
000_000<#3Dn<#3D10_000_000#0A......................
THEN.writef("%iA.",.n)#0A......................ELSE
.writef("#23x%x8.",.n)#0A....................}#0Anx
t:#0A..newline()#0A}#0A#0A#0AAND.dumpmemory().BE#0A
{.LET.blocklist..#3D.cont(rootnode+rtn_membase)#0A.
.LET.topofstore.#3D.cont(rootnode+rtn_memsize)#0A..
LET.a.#3D.blocklist#0A..LET.free,.used,.n.#3D.0,.0,
.0#0A..LET.largest_free.#3D.0#0A..LET.joinfree.#3D.
0#0A..LET.sectnames,.routnames,.globinit.#3D.0,.0,.
0#0A..LET.constr.#3D.output()#0A..LET.outstr.#3D.0#0A
#0A..writef("*nMap.of.free.and.allocated.blocks.in.
%n#2E#2E%n*n*n",.membase,.memlim)#0A#0A..WHILE.cont
(a).DO#0A..{.LET.size.#3D.cont(a)#0A....LET.freeblk
.#3D.(size&1)#3D1#0A#0A....TEST.freeblk#0A....THEN.
{.//.Free.block#0A...........size.:#3D.size-1#0A...
........free.:#3D.free.+.size#0A...........joinfree
.:#3D.joinfree.+.size#0A...........IF.joinfree.>.la
rgest_free.DO.largest_free.:#3D.joinfree#0A........
.}#0A....ELSE.{.//.Used.block#0A...........used.:#3D
.used.+.size#0A...........joinfree.:#3D.0#0A.......
..}#0A#0A....UNLESS.size>#3D0.&.a+size<#3Dtopofstor
e.DO#0A....{.writef("******Store.chain.corrupt!!*n*
#0A..............*Noticed.at.%n*n",.a)#0A......BREA
K#0A....}#0A#0A....writef("%i8:%i7.",.a,.size)#0A..
..IF.freeblk.DO.{.writes("free.");.GOTO.nxt.}#0A#0A
....IF.a.#3D.(rootnode-1).DO.{.writes("Rootnode");.
GOTO.nxt.}#0A....IF.cont(a+3).#3D.sectword.&.memb(a
+4,.0).#3D.11.DO#0A....{.LET.name.#3D.a+4#0A......w
ritef("Section.")#0A......FOR.i.#3D.1.TO.memb(name,
.0).DO.wrch(memb(name,.i))#0A......GOTO.nxt#0A....}
#0A/*#0A....FOR.id.#3D.1.TO.cont(tasktab).DO#0A....
{.LET.t.#3D.cont(tasktab+id)#0A......IF.t.DO#0A....
..{.LET.p,.g.#3D.cont(t+tcb_sbase),.cont(t+tcb_gbas
e)#0A........IF.a+1#3Dp.DO.{.writef("Task.%n.stack"
,.id);.GOTO.nxt.}#0A........IF.a+1#3Dg.DO.{.writef(
"Task.%n.global.vector",.id);.GOTO.nxt.}#0A........
IF.a+1#3Dt.DO.{.writef("Task.%n.TCB",.id);.GOTO.nxt
.}#0A........IF.g.&.a>500.FOR.gn.#3D.1.TO.cont(g).I
F.a+1#3Dcont(g+gn).DO#0A.....................{.writ
ef("Task.%n.G%n.#3D>.",.id,.gn)#0A.................
......GOTO.dump#0A.....................}#0A......}#0A
....}#0A*/#0Adump:#0A....FOR.i.#3D.1.TO.5.DO.{.LET.
n.#3D.cont(a+i)#0A........................TEST.-10_
000_000<#3Dn<#3D10_000_000#0A......................
..THEN.writef("%iA.",.n)#0A........................
ELSE.writef("#23x%x8.",.n)#0A......................
}#0Anxt:.#0A....newline()#0A....a.:#3D.a.+.size#0A.
.}#0A#0A..writef("End.of.block.list.#3D.%n*n",.a)#0A
..topofstore.:#3D.a#0A#0A..writef("*nLargest.contig
uous.free.area:.%n.words*n",.largest_free)#0A..writ
ef("Totals:.%n.words.available,.%n.used,.%n.free*n*
n",#0A..........used+free,.used,.free)#0A#0Aexit:#0A
}#0A#0AAND.wrregs(str,.regs).BE#0A{.writef("*n%s:*n
",.str)#0A..writef("a#3D%n.b#3D%n.c#3D%n.",.mem(reg
s+r_a),.mem(regs+r_b),.mem(regs+r_c))#0A..writef("p
#3D%n(%n).g#3D%n(%n).",.mem(regs+r_p),.mem(regs+r_p
)>>2,#0A...............................mem(regs+r_g
),.mem(regs+r_g)>>2)#0A..writef("st#3D%n.pc#3D%n.co
unt#3D%n.mw#3D%n*n",.mem(regs+r_st),.mem(regs+r_pc)
,#0A...................................mem(regs+r_c
ount),mem(regs+r_mw))#0A}#0A#0AAND.write_sectname(s
).BE#0A{.LET.name.#3D.s+3#0A..TEST.(cont(s+2).#3D.s
ectword).&.(memb(s+3,.0).#3D.11)#0A..THEN.FOR.i.#3D
.1.TO.11.DO.wrch(memb(name,.i))#0A..ELSE.writes("??
?????????")#0A}#0A#0AAND.checkaddr(a).#3D.VALOF#0A{
.UNLESS.membase<#3Da<#3Dmemlim.DO#0A..{.writef("*nB
ad.address.%n.not.in.range.%n--%n*n",.a,.membase,.m
emlim)#0A....RESULTIS.0#0A..}#0A..RESULTIS.a#0A}#0A
#0AAND.cont(a).#3D.mem(checkaddr(a))#0A#0AAND.wrcor
tn().BE#0A{.LET.size.#3D.cont(cptr+co_size)#0A..LET
.hwm.#3D.size+6#0A..writef(".%i7:.",.cptr)#0A..writ
es("..Coroutine:")#0A..writearg(cont(cptr+co_fn))#0A
..writef("..Parent.%n",.mem(cptr+co_parent))#0A..WH
ILE.cont(cptr+hwm)#3Dstackword.DO.hwm:#3Dhwm-1#0A..
writef("..Stack.%n/%n*n",.size,.hwm-6)#0A..prprompt
()#0A..wrch('.')#0A..wrframe()#0A}#0A#0AAND.wrframe
().BE#0A{.writef("%i8:",.pptr)#0A..TEST.pptr#3Dcptr
#0A..THEN.writef("..#23StackBase#23")#0A..ELSE.writ
earg(mem(pptr+2))#0A..FOR.i#3D3.TO.6.UNLESS.i>#3Dfs
ize.DO.writearg(cont(pptr+i))#0A..newline()#0A..IF.
fsize>7.DO#0A..{.writef("............")#0A....FOR.i
.#3D.7.TO.11.UNLESS.i>#3Dfsize.DO.writearg(cont(ppt
r+i))#0A....newline()#0A..}#0A..IF.fsize>12.DO#0A..
{.writef("............")#0A....FOR.i.#3D.12.TO.16.U
NLESS.i>#3Dfsize.DO.writearg(cont(pptr+i))#0A....ne
wline()#0A..}#0A}#0A#0AAND.writearg(n).BE#0A//.Writ
e.an.argument.in.a.field.width.of.13.characters#0A.
.TEST.isfun(n)#0A..THEN.{.LET.s.#3D.(n>>2)-3..//.MR
.1/11/03#0A.........LET.len.#3D.memb(s,.0)#0A......
...WHILE.len>0.&.memb(s,.len)#3D'.'.DO.len.:#3D.len
-1#0A.........FOR.i.#3D.len+1.TO.13.DO.wrch('.')#0A
.........FOR.i.#3D.1.TO.len.DO.wrch(memb(s,.i))#0A.
......}#0A..ELSE.TEST.globword<#3Dn<#3Dglobword+100
0..//.MR.1/11/03#0A.......THEN.writef(".......#23G%
z3#23",.n-globword)#0A.......ELSE.TEST.-10_000_000<
#3Dn<#3D10_000_000#0A............THEN.writef("..%iB
",.n)#0A............ELSE.writef("...#23x%x8",.n)#0A
#0AAND.isfun(f).#3D.VALOF#0A{.LET.a.#3D.f>>2#0A//sa
writef("isfun(%n)*n",.f)#0A..UNLESS.(f&3)#3D0.&.mem
base+4<a<#3Dmemlim.RESULTIS.FALSE.//.MR.25/9/03#0A/
/sawritef("isfun:.a#3D%n*n",.a)#0A..IF.mem(a-4)#3De
ntryword.&.memb(a-3,.0)#3D11.RESULTIS.TRUE.#0A//saw
ritef("isfun:.returning.FALSE*n")#0A..RESULTIS.FALS
E#0A}#0A#0AAND.getimage(filename).#3D.VALOF#0A{.LET
.res.#3D.FALSE#0A..LET.oldin.#3D.input()#0A..LET.sc
b.#3D.findinput(filename)#0A..LET.size,.upb,.wordsr
ead.#3D.0,.0,.0#0A#0A..imagedata,.addrv,.datav.:#3D
.0,.0,.0#0A#0A..UNLESS.scb.RESULTIS.FALSE#0A..size.
:#3D.sys(Sys_filesize,.scb!scb_fd)....//.Size.in.by
tes#0A..IF.size.DO.upb..:#3D.(size-1)/bytesperword.
//.UPB.in.words......#0A#0A..imagedata.:#3D.getvec(
upb)#0A..UNLESS.imagedata.DO#0A..{.writef("Unable.t
o.allocate.a.vector.with.upb#3D%n*n",.upb)#0A....GO
TO.ret#0A..}#0A..selectinput(scb)#0A..wordsread.:#3D
.readwords(imagedata,.upb+1)#0A..UNLESS.upb+1#3Dwor
dsread.DO#0A..{.writef("Read.%n.words.from.%s,.it.s
hould.have.been.%n*n",#0A............wordsread,.fil
ename,.upb+1)#0A....GOTO.ret#0A..}#0A..//writef("Re
ad.%n.words.from.%s*n",.wordsread,.filename)#0A..//
FOR.i.#3D.0.TO.upb>31->31,.upb.DO.writef("%i5:.%x8*
n",.i,.imagedata!i)#0A#0A..memupb.:#3D.imagedata!0#0A
..imagep.:#3D.1#0A#0A..datavupb.:#3D.0#0A..{.LET.ad
dr,.imagep.#3D.0,.1#0A....UNTIL.addr.>.memupb.DO#0A
....{.LET.n.#3D.imagedata!imagep#0A#0A//TEST.n>#3D0
.THEN.writef("%i9:.%i9.BLOCK*n",.addr,.n)#0A//.....
.....ELSE.writef("%i9:.%i9.x.%x8*n",.addr,.-n,.imag
edata!(imagep+1))#0A......UNLESS.n.BREAK#0A#0A.....
.TEST.n>0.THEN.imagep.:#3D.imagep.+.n.+.1#0A.......
........ELSE.imagep.:#3D.imagep.+.2#0A......datavup
b.:#3D.datavupb.+.1#0A......//addrv!datavupb.:#3D.a
ddr#0A......//datav!datavupb.:#3D.p#0A......addr.:#3D
.addr.+.ABS.n#0A....}#0A....UNLESS.addr.#3D.memupb+
1.DO#0A....{.writef("Image.file.is.corrupt,.addr#3D
%n.memupb#3D%n*n",.addr,.memupb)#0A......GOTO.ret#0A
....}#0A..}#0A//..writef("Image.file.ok,.datavupb#3D
%n*n",.datavupb)#0A#0A..addrv.:#3D.getvec(datavupb)
#0A..datav.:#3D.getvec(datavupb)#0A..UNLESS.addrv.&
.datav.DO#0A..{.writef("More.space.needed*n")#0A...
.GOTO.ret#0A..}#0A#0A..datavupb.:#3D.0#0A#0A..{.LET
.addr,.imagep.#3D.0,.1#0A....UNTIL.addr.>.memupb.DO
#0A....{.LET.n.#3D.imagedata!imagep#0A#0A......UNLE
SS.n.BREAK#0A#0A......datavupb.:#3D.datavupb.+.1#0A
......addrv!datavupb.:#3D.addr#0A......datav!datavu
pb.:#3D.imagep#0A#0A......TEST.n>0.THEN.imagep.:#3D
.imagep.+.n.+.1#0A...............ELSE.imagep.:#3D.i
magep.+.2#0A......addr.:#3D.addr.+.ABS.n#0A....}#0A
#0A....UNLESS.addr.#3D.memupb+1.DO#0A....{.writef("
Image.file.is.corrupt,.addr#3D%n.memupb#3D%n*n",.ad
dr,.memupb)#0A......GOTO.ret#0A....}#0A..}#0A#0A..r
es.:#3D.TRUE#0Aret:#0A..IF.scb.DO.endstream(scb)#0A
..selectinput(oldin)#0A..RESULTIS.res#0A}#0A#0AAND.
mem(p).#3D.VALOF.//.Get.a.word.of.dumped.memory#0A{
.LET.i,.j,.len,.res.#3D.1,.datavupb+1,.0,.0#0A..UNL
ESS.0<#3Dp<#3Dmemupb.DO#0A..{.writef("*nBad.Cintpos
.memory.address.%x8..%n*n",.p,.p)#0A....longjump(re
c_p,.rec_l)#0A....RESULTIS.#23xBAD00BAD#0A..}#0A#0A
..{.LET.m.#3D.(i+j)/2#0A//....writef("addrv!m#3D%i9
.p#3D%n..i#3D%i2.m#3D%i2.j#3D%i2*n",.addrv!m,.p,.i,
.m,.j)#0A//abort(1000)#0A....IF.i#3Dm.BREAK#0A....T
EST.addrv!m.<#3D.p.THEN.i.:#3D.m#0A................
......ELSE.j.:#3D.m#0A..}.REPEAT#0A#0A..len.:#3D.im
agedata!(datav!i)#0A..//writef("len.#3D.%n..datav!i
#3D%n*n*n",.len,.datav!i)#0A..TEST.len>0.THEN.res.:
#3D.imagedata!(datav!i.+.p-addrv!i+1)#0A...........
..ELSE.res.:#3D.imagedata!(datav!i.+.1)#0A..//write
f("mem(%n).#3D>.%x8..%i9*n",.p,.res,.res)#0A..RESUL
TIS.res#0A}#0A#0AAND.setmem(p,.val).BE.//.Set.a.wor
d.of.dumped.memory#0A{.LET.i,.j,.len,.res.#3D.1,.da
tavupb+1,.0,.0#0A..UNLESS.0<#3Dp<#3Dmemupb.DO#0A..{
.writef("*nBad.Cintpos.memory.address.%x8..%n*n",.p
,.p)#0A....longjump(rec_p,.rec_l)#0A..}#0A#0A..{.LE
T.m.#3D.(i+j)/2#0A//....writef("addrv!m#3D%i9.p#3D%
n..i#3D%i2.m#3D%i2.j#3D%i2*n",.addrv!m,.p,.i,.m,.j)
#0A//abort(1000)#0A....IF.i#3Dm.BREAK#0A....TEST.ad
drv!m.<#3D.p.THEN.i.:#3D.m#0A......................
ELSE.j.:#3D.m#0A..}.REPEAT#0A#0A..len.:#3D.imagedat
a!(datav!i)#0A..//writef("len.#3D.%n..datav!i#3D%n*
n*n",.len,.datav!i)#0A..IF.len<#3D0.DO#0A..{.writef
("Unable.to.write.%x8.to.location.%n*n",.val,.p)#0A
....RETURN#0A..}#0A..imagedata!(datav!i.+.p-addrv!i
+1).:#3D.val#0A}#0A#0AAND.memb(p,.n).#3D.VALOF.//.R
ead.a.byte.of.dumped.memory#0A{.LET.word.#3D.mem(p+
(n>>2))#0A..RESULTIS.(@word)%(n&3)#0A}#0A#0AAND.set
memb(p,.n,.byte).#3D.VALOF.//.Set.a.byte.of.dumped.
memory#0A{.LET.word.#3D.mem(p+(n>>2))#0A..(@word)%(
n&3).:#3D.byte#0A..setmem(p+(n>>2),.word)#0A}#0A#0A
AND.rdn().#3D.VALOF#0A{.LET.res.#3D.0#0A..WHILE.'0'
<#3Dch<#3D'9'.DO.{.res.:#3D.res*10.+.ch.-.'0';.rch(
).}#0A..RESULTIS.res#0A}#0A#0AAND.rdvaraddr(type).#3D
.VALOF#0A{.LET.base,.lim,.n.#3D.?,.?,.?#0A..UNLESS.
'0'<#3Dch<#3D'9'.DO.error()#0A..n.:#3D.rdn()#0A..SW
ITCHON.type.INTO#0A..{.DEFAULT:...error()#0A....CAS
E.'P':.base,.lim.:#3D.pptr,.fsize;...........ENDCAS
E#0A....CASE.'G':.base,.lim.:#3D.gptr,.gptr!g_globs
ize;.ENDCASE#0A....CASE.'R':.base,.lim.:#3D.regs,.r
_upb;...........ENDCASE#0A....CASE.'V':.base,.lim.:
#3D.vars,.9;...............ENDCASE#0A....CASE.'A':.
base,.lim.:#3D....0,.memlim;..........ENDCASE#0A..}
#0A..UNLESS.0<#3Dn<#3Dlim.DO.error()#0A..RESULTIS.b
ase.+.n#0A}#0A#0AAND.rdval().#3D.VALOF#0A{.LET.res,
.radix.#3D.0,.10#0A#0A..SWITCHON.ch.INTO#0A..{.DEFA
ULT:...error()#0A#0A....CASE.'G':..rch()#0A........
.......IF.'0'<#3Dch<#3D'9'.RESULTIS.mem(rdvaraddr('
G'))#0A...............RESULTIS.gptr#0A#0A....CASE.'
P':..rch()#0A...............IF.'0'<#3Dch<#3D'9'.RES
ULTIS.mem(rdvaraddr('P'))#0A...............RESULTIS
.pptr#0A#0A....CASE.'R':..rch()#0A...............IF
.'0'<#3Dch<#3D'9'.RESULTIS.mem(rdvaraddr('R'))#0A..
.............RESULTIS.regs#0A#0A....CASE.'V':..rch(
)#0A...............IF.'0'<#3Dch<#3D'9'.RESULTIS.mem
(rdvaraddr('V'))#0A...............RESULTIS.vars#0A#0A
....CASE.'A':..rch()#0A...............IF.'0'<#3Dch<
#3D'9'.RESULTIS.mem(rdvaraddr('A'))#0A.............
..RESULTIS.0#0A#0A....CASE.'*'':.rch();.res.:#3D.lc
h;.rch();..RESULTIS.res#0A#0A....CASE.'#23':..radix
.:#3D.16#0A...............rch()#0A...............IF
.ch#3D'O'.DO.{.radix.:#3D.8;.rch().}#0A#0A....CASE.
'0':.CASE.'1':.CASE.'2':.CASE.'3':.CASE.'4':.#0A...
.CASE.'5':.CASE.'6':.CASE.'7':.CASE.'8':.CASE.'9':.
#0A...............{.LET.d.#3D.100#0A...............
..IF.'0'<#3Dch<#3D'9'.DO.d.:#3D.ch-'0'#0A..........
.......IF.'A'<#3Dch<#3D'F'.DO.d.:#3D.ch-'A'+10#0A..
...............IF.d>#3Dradix.RESULTIS.res#0A.......
..........res.:#3D.res*radix+d#0A.................r
ch()#0A...............}.REPEAT#0A..}#0A}#0A#0AAND.p
raddr(a).BE#0A{.LET.type,.base.#3D.'A',.0#0A..IF.pp
tr.<#3D.a.<#3D.pptr+fsize................DO.type,.b
ase.:#3D.'P',.pptr#0A..IF.gptr.<#3D.a.<#3D.gptr+mem
(gptr+g_globsize).DO.type,.base.:#3D.'G',.gptr#0A..
IF.vars.<#3D.a.<#3D.vars+9....................DO.ty
pe,.base.:#3D.'V',.vars#0A..IF.regs.<#3D.a.<#3D.reg
s+r_upb................DO.type,.base.:#3D.'R',.regs
#0A..writef("*n%c%i5:",.type,.a-base)#0A}#0A#0AAND.
print1(n).BE#0A{.sawritef("*nprint:.n#3D%n*n",.n)#0A
..print1(n)#0A}#0A#0AAND.print(n).BE.SWITCHON.style
.INTO#0A{.DEFAULT:...error();.................RETUR
N#0A..CASE.'C':..{.LET.p.#3D.@n#0A...............wr
ites(".")#0A...............FOR.i.#3D.0.TO.3.DO#0A..
.............{.LET.ch.#3D.p%i#0A.................wr
ch(32<#3Dch<#3D127.->.ch,.'#2E')#0A...............}
#0A...............RETURN#0A.............}#0A..CASE.
'B':..writef(.".%bW.",.n);.....RETURN#0A..CASE.'D':
..writef(.".%IA.",.n);.....RETURN#0A..CASE.'F':..wr
itearg(n);.............RETURN#0A..CASE.'O':..writef
(.".%OC.",.n);.....RETURN#0A..CASE.'S':..checkaddr(
n)#0A.............writef(.".%S.",..n);.....RETURN#0A
..CASE.'U':..writef(.".%UA.",.n);.....RETURN#0A..CA
SE.'X':..writef(.".%X8.",.n);.....RETURN#0A}#0A#0AA
ND.selectprog(id).BE#0A{.//.id#3D0.selects.the.boot
.program,.and#0A..//.id#3D1.selects.the.CLI.program
#0A..//.It.selects.the.appropriate.register.set,.et
c#0A..//.ie.it.sets:.regs,.gptr,.pptr,.cptr.and.fsi
ze#0A#0A..TEST.id#3D0.#0A..THEN.regs.:#3D.bootregs.
....//.regs.of.crntask.at.time.of.fault#0A..ELSE.re
gs.:#3D.cliregs......//.regs.at.time.of.fault#0A#0A
..gptr..:#3D.mem(r_g.+.regs).>>.2#0A..pptr..:#3D.me
m(r_p.+.regs).>>.2#0A#0A..//.Set.current.coroutine.
if.in.user.or.kernel.mode.and.the.task#0A..//.is.ac
tive#0A..cptr.:#3D.mem(gptr+g_currco)#0A#0A..//.Uns
et.cptr.if.there.is.a.problem#0A..UNLESS.cptr.<#3D.
pptr.<#3D.cptr.+.mem(cptr+co_size).+.6.DO.cptr.:#3D
.0#0A#0A..fsize.:#3D.100#0A//sawritef("cptr#3D%n*n"
,.cptr)#0A..IF.cptr.DO.fsize.:#3D.cptr.+.6.+.mem(cp
tr+co_size).-.pptr#0A//sawritef("fsize#3D%n*n",.fsi
ze)#0A#0A..TEST.id#3D0#0A..THEN.writef("*nBoot.prog
ram.selected*n")#0A..ELSE.writef("*nCLI.program.sel
ected*n")#0A}#0A#0AAND.error().BE.{.writes("..??*n"
);.longjump(rec_p,.rec_l).}#0A#0AAND.wrfcode(f).BE#0A
{.LET.s.#3D.VALOF.SWITCHON.f&31.INTO#0A..{.DEFAULT:
#0A....CASE..0:.RESULTIS.".....-.....K...LLP.....L.
...LP....SP....AP.....A"#0A....CASE..1:.RESULTIS.".
....-....KH..LLPH....LH...LPH...SPH...APH....AH"#0A
....CASE..2:.RESULTIS."...BRK....KW..LLPW....LW...L
PW...SPW...APW....AW"#0A....CASE..3:.RESULTIS."....
K3...K3G..K3G1..K3GH...LP3...SP3...AP3..L0P3"#0A...
.CASE..4:.RESULTIS."....K4...K4G..K4G1..K4GH...LP4.
..SP4...AP4..L0P4"#0A....CASE..5:.RESULTIS."....K5.
..K5G..K5G1..K5GH...LP5...SP5...AP5..L0P5"#0A....CA
SE..6:.RESULTIS."....K6...K6G..K6G1..K6GH...LP6...S
P6...AP6..L0P6"#0A....CASE..7:.RESULTIS."....K7...K
7G..K7G1..K7GH...LP7...SP7...AP7..L0P7"#0A....CASE.
.8:.RESULTIS."....K8...K8G..K8G1..K8GH...LP8...SP8.
..AP8..L0P8"#0A....CASE..9:.RESULTIS."....K9...K9G.
.K9G1..K9GH...LP9...SP9...AP9..L0P9"#0A....CASE.10:
.RESULTIS."...K10..K10G.K10G1.K10GH..LP10..SP10..AP
10.L0P10"#0A....CASE.11:.RESULTIS."...K11..K11G.K11
G1.K11GH..LP11..SP11..AP11.L0P11"#0A....CASE.12:.RE
SULTIS."....LF...S0G..S0G1..S0GH..LP12..SP12..AP12.
L0P12"#0A....CASE.13:.RESULTIS."...LF$...L0G..L0G1.
.L0GH..LP13..SP13.XPBYT.....S"#0A....CASE.14:.RESUL
TIS."....LM...L1G..L1G1..L1GH..LP14..SP14...LMH....
SH"#0A....CASE.15:.RESULTIS."...LM1...L2G..L2G1..L2
GH..LP15..SP15...BTC..MDIV"#0A....CASE.16:.RESULTIS
."....L0....LG...LG1...LGH..LP16..SP16...NOP.CHGCO"
#0A....CASE.17:.RESULTIS."....L1....SG...SG1...SGH.
..SYS....S1....A1...NEG"#0A....CASE.18:.RESULTIS.".
...L2...LLG..LLG1..LLGH...SWB....S2....A2...NOT"#0A
....CASE.19:.RESULTIS."....L3....AG...AG1...AGH...S
WL....S3....A3..L1P3"#0A....CASE.20:.RESULTIS."....
L4...MUL...ADD....RV....ST....S4....A4..L1P4"#0A...
.CASE.21:.RESULTIS."....L5...DIV...SUB...RV1...ST1.
..XCH....A5..L1P5"#0A....CASE.22:.RESULTIS."....L6.
..REM...LSH...RV2...ST2..GBYT..RVP3..L1P6"#0A....CA
SE.23:.RESULTIS."....L7...XOR...RSH...RV3...ST3..PB
YT..RVP4..L2P3"#0A....CASE.24:.RESULTIS."....L8....
SL...AND...RV4..STP3...ATC..RVP5..L2P4"#0A....CASE.
25:.RESULTIS."....L9...SL$....OR...RV5..STP4...ATB.
.RVP6..L2P5"#0A....CASE.26:.RESULTIS."...L10....LL.
..LLL...RV6..STP5.....J..RVP7..L3P3"#0A....CASE.27:
.RESULTIS."..FHOP...LL$..LLL$...RTN..GOTO....J$.ST0
P3..L3P4"#0A....CASE.28:.RESULTIS."...JEQ...JNE...J
LS...JGR...JLE...JGE.ST0P4..L4P3"#0A....CASE.29:.RE
SULTIS."..JEQ$..JNE$..JLS$..JGR$..JLE$..JGE$.ST1P3.
.L4P4"#0A....CASE.30:.RESULTIS."..JEQ0..JNE0..JLS0.
.JGR0..JLE0..JGE0.ST1P4.....-"#0A....CASE.31:.RESUL
TIS.".JEQ0$.JNE0$.JLS0$.JGR0$.JLE0$.JGE0$....MW....
.-"#0A..}#0A..LET.n.#3D.f>>5.&.7#0A..FOR.i.#3D.6*n+
1.TO.6*(n+1).DO.wrch(s%i)#0A}#0A#0AAND.prinstr(pc).
BE#0A{.LET.a.#3D.0#0A..writef(".%i7:.",.pc)#0A..che
ckaddr(pc>>2)#0A..wrfcode(gb(pc))#0A..SWITCHON.inst
rtype(gb(pc)).INTO#0A..{.DEFAULT:#0A....CASE.'0':..
....................................RETURN#0A....CA
SE.'1':.a..:#3D.gb(pc+1);......................ENDC
ASE#0A....CASE.'2':.a..:#3D.gh(pc+1);..............
........ENDCASE#0A....CASE.'4':.a..:#3D.gw(pc+1);..
....................ENDCASE#0A....CASE.'R':.a..:#3D
.pc+1.+.gsb(pc+1);..............ENDCASE#0A....CASE.
'I':.pc.:#3D.pc+1.+.2*gb(pc+1).&.#23xFFFFFFFE#0A...
...........a..:#3D.pc.+.gsh(pc);..................E
NDCASE#0A..}#0A..writef("..%n",.a)#0A..vars!9.:#3D.
a#0A}#0A#0AAND.gb(pc).#3D.memb(0,.pc)#0A#0AAND.gsb(
pc).#3D.gb(pc)<#3D127.->.gb(pc),.gb(pc)-256#0A#0AAN
D.gsh(pc).#3D.VALOF#0A{.LET.h.#3D.gh(pc)#0A..RESULT
IS.h<#3D#23x7FFF.->.h,.h.-.#23x10000#0A}#0A#0AAND.g
h(pc).#3D.VALOF#0A{.LET.w.#3D.0#0A..LET.p.#3D.@w../
/.Designed.to.work.on.both.Big.and.Little.Ender.M/C
s#2E#0A..p%0,.p%1,.p%2,.p%3.:#3D.gb(pc),.gb(pc+1),.
gb(pc),.gb(pc+1)#0A..RESULTIS.w.&.#23xFFFF#0A}#0A#0A
AND.gw(pc).#3D.VALOF#0A{.LET.w.#3D.0#0A..LET.p.#3D.
@w..//.Designed.to.work.on.both.Big.and.Little.Ende
r.M/Cs#2E#0A..p%0,.p%1,.p%2,.p%3.:#3D.gb(pc),.gb(pc
+1),.gb(pc+2),.gb(pc+3)#0A..RESULTIS.w#0A}#0A#0AAND
.instrtype(f).#3D."?0000000000RI10000000000000RIRI*
#0A..................*124111111111111111110000RIRIR
IRI*#0A..................*1241111111111111111100000
0RIRIRI*#0A..................*124222222222222222220
0000000RIRI*#0A..................*12400000000000000
0BL00000000RIRI*#0A..................*1240000000000
0000000000000RIRIRI*#0A..................*124000000
0000?2?0000000000000004*#0A..................*12400
0000000012?00000000000000??"%f#0A#0AAND.nextpc(pc).
#3D.VALOF.SWITCHON.instrtype(gb(pc)).INTO#0A.......
................{.DEFAULT:#0A......................
...CASE.'0':.RESULTIS.pc+1#0A......................
...CASE.'1':#0A.........................CASE.'R':#0A
.........................CASE.'I':.RESULTIS.pc+2#0A
.........................CASE.'2':.RESULTIS.pc+3#0A
.........................CASE.'4':.RESULTIS.pc+5#0A
.........................CASE.'B':.pc.:#3D.pc+2.&.#23
xFFFFFFFE#0A...................................RESU
LTIS.pc.+.4*gh(pc).+.6#0A.........................C
ASE.'L':.pc.:#3D.pc+2.&.#23xFFFFFFFE#0A............
.......................RESULTIS.pc.+.2*gh(pc).+.6#0A
.......................}#0A#0A

######cintcode/com/dumpsys.b#
//.This.is.a.program.to.convert.a.compacted.dump.of
.the.entire#0A//.Cintcode.memory.(normally.written.
to.DUMP#2Emem).into.a.readable.form#2E#0A//.It.is.b
ased.on.the.dumpsys#2Eb.program.of.the.Cintpos.syst
em#2E#0A#0A//.Martin.Richards.(c).November.2006#0A#0A
//.Usage:#0A#0A//.dumpsys.[FROM.<image>].[TO.<file>
]#0A#0A//.The.FROM.argument.specifies.the.dump.imag
e.file,#0A//.the.default.DUMP#2Emem#0A//.The.TO.arg
ument.specifies.where.to.send.the.output#2E#0A#0A//
.The.program.dumps.the.rootnode,.the.CLI's.global.v
ector.and.its#0A//.coroutine.stacks,folled.by.a.dum
p.of.all.all.memory.blocks#2E#0A#0ASECTION.".dumpsy
s"#0A#0AGET."libhdr"#0AGET."clihdr"#0A#0A#0AGLOBAL#0A
{.eof:.ug#0A..pptr#0A..gptr#0A..cptr#0A..fsize#0A#0A
..regs#0A..membase#0A..memlim#0A..memupb#0A..contex
t#0A#0A..imagefilename..//.0.or.name.of.the.image.f
ile#0A..imagedata......//.Raw.DUMP#2Emem.file.(#3D0
.if.no.image.given)#0A..addrv..........//.memory.ad
dresses#0A..datav..........//.corresponding.pointer
s.into.imagedata#0A..datavupb#0A..imagep..#0A#0A..r
ec_p;.rec_l...//.Recovery.label.for.longjump#0A}#0A
#0AMANIFEST.{#0A..maxpri.#3D.maxint#0A#0A..sectname
size.#3D.(11.+.bytesperword)/bytesperword#0A..routn
amesize.#3D.(11.+.bytesperword)/bytesperword#0A..na
meoffset...#3D.-routnamesize#0A..vecupb.......#3D.5
000#0A#0A..g_globsize#3D0;.g_sys#3D3;.g_currco#3D7;
.g_colist#3D8.#0A#0A..r_a#3D0#0A..r_b#0A..r_c#0A..r
_p#0A..r_g#0A..r_st#0A..r_pc#0A..r_count#0A..r_mw#0A
..r_upb.#3D.r_mw#0A}#0A#0ALET.start().BE#0A{.LET.ar
gv.......#3D.VEC.50#0A..AND.datv.......#3D.VEC.1#0A
..AND.datstrings.#3D.VEC.12#0A..AND.sysin......#3D.
input()#0A..AND.sysout.....#3D.output()#0A..AND.ton
ame.....#3D.0#0A..AND.tostream...#3D.0#0A..AND.imag
efilename.#3D."DUMP#2Emem"#0A..AND.taskcount..#3D.0
#0A#0A..UNLESS.rdargs("FROM,TO/K",.argv,.50).DO#0A.
.{.writes("bad.arguments.for.DUMPSYS*n")#0A....stop
(20)#0A..}#0A#0A..IF.argv!0.DO.imagefilename.:#3D.a
rgv!0#0A..IF.imagefilename.UNLESS.getimage(imagefil
ename).DO#0A..{.writef("Unable.to.load.image.file.%
s*n",.imagefilename)#0A....RETURN#0A..}#0A#0A..rec_
p,.rec_l.:#3D.level(),.fin#0A#0A..membase.:#3D.mem(
rootnode+rtn_membase)#0A..memlim..:#3D.mem(rootnode
+rtn_memsize)#0A..context.:#3D.mem(rootnode+rtn_con
text)#0A..//.context.#3D.1...SIGINT.received#0A..//
.context.#3D.2...SIGSEGV.received#0A..//.context.#3D
.3...dump.caused.by.fault.in.BOOT.of.standalone.deb
ug#0A..//.context.#3D.4...dump.requested.by.user.ca
lling.sys(Sys_quit,.-2)#0A..//.context.#3D.5...non.
zero.user.fault.code#0A..//.context.#3D.6...dump.re
quested.in.standalone.debug#0A#0A..toname.:#3D.argv
!1#0A.#0A..IF.toname.DO#0A..{.tostream.:#3D.findout
put(toname)#0A....UNLESS.tostream.DO#0A....{.writef
("can't.open.%s*n",.toname)#0A......GOTO.fin#0A....
}#0A....selectoutput(tostream)#0A..}#0A#0A..writef(
"*nImage.File:.%s",.imagefilename)#0A..IF.memdatsta
mp(datv).DO#0A..{.dat_to_strings(datv,.datstrings)#0A
//sawritef("dumpsys:.datv.#3D.[%n.%n]*n",.datv!0,.d
atv!1)#0A....writef("...........Dated:..%s.%s*n",.@
datstrings!0,.@datstrings!5)#0A..}#0A..newline()#0A
#0A..SWITCHON.context.INTO#0A..{.DEFAULT:..writef("
Unknown.reason.(%n).for.dumping.memory",.context)#0A
..............ENDCASE#0A....CASE.1:...writef("Dump.
caused.by.signal.SIGINT")#0A..............ENDCASE#0A
....CASE.2:...writef("Dump.caused.by.signal.SIGSEGV
")#0A..............ENDCASE#0A....CASE.3:...writef("
Dump.caused.by.fault.in.BOOT.or.standalone.debug")#0A
..............ENDCASE#0A....CASE.4:...writef("Dump.
by.user.probably.calling:.dumpmem")#0A.............
.ENDCASE#0A....CASE.5:...writef("Dump.caused.by.non
.zero.user.fault.code")#0A..............ENDCASE#0A.
...CASE.6:...writef("Dump.requested.in.standalone.d
ebug")#0A..............ENDCASE#0A..}#0A..newline()#0A
..#0A..writef("*nLast.abort.code:.%n*n",.mem(rootno
de+rtn_abortcode))#0A#0A..dumprootnode()#0A#0A..dum
ptask("Boot",.bootregs).#0A..dumptask("CLI",.clireg
s)#0A.#0A..dumpmemory()#0A#0Afin:#0A..IF.tostream.U
NLESS.sysout#3Dtostream.DO.endstream(tostream)#0A..
IF.imagedata.DO.freevec(imagedata)#0A..IF.addrv....
.DO.freevec(addrv)#0A..IF.datav.....DO.freevec(data
v)#0A}#0A#0AAND.memdatstamp(v).#3D.VALOF#0A{.LET.tv
.#3D.rootnode+rtn_days#0A.#0A..UNLESS.0<#3Dtv<#3Dme
mupb.RESULTIS.FALSE#0A#0A..v!0.:#3D.mem(tv+0)#0A..v
!1.:#3D.mem(tv+1)#0A#0A..RESULTIS.TRUE#0A}#0A#0AAND
.dumprootnode().BE#0A{.writef("*nRootnode.at.%n*n*n
",.rootnode)#0A#0A..writef("..blklist....%iA*n",.me
m(rtn_blklist+rootnode))#0A..writef("..memsize....%
iA*n",.mem(rtn_memsize+rootnode))#0A..writef("..inf
o.......%iA*n",.mem(rtn_info+rootnode))#0A..writef(
"..sys........%iA*n",.mem(rtn_sys+rootnode))#0A..wr
itef("..blib.......%iA*n",.mem(rtn_blib+rootnode))#0A
..writef("..boot.......%iA*n",.mem(rtn_boot+rootnod
e))#0A..writef("..abortcode..%iA*n",.mem(rtn_abortc
ode+rootnode))#0A..writef("..context....%iA*n",.mem
(rtn_context+rootnode))#0A..writef("..lastp......%i
A*n",.mem(rtn_lastp+rootnode))#0A..writef("..lastg.
.....%iA*n",.mem(rtn_lastg+rootnode))#0A..writef(".
.days.......%iA*n",.mem(rtn_days+rootnode))#0A..wri
tef("..msecs......%iA*n",.mem(rtn_msecs+rootnode))#0A
}#0A#0AAND.dumpmemory().BE#0A{.LET.blocklist..#3D.m
em(rootnode+rtn_membase)#0A..LET.topofstore.#3D.mem
(rootnode+rtn_memsize)#0A..LET.a.#3D.blocklist#0A..
LET.free,.used,.n.#3D.0,.0,.0#0A..LET.largest_free.
#3D.0#0A..LET.joinfree.#3D.0#0A..LET.sectnames,.rou
tnames,.globinit.#3D.0,.0,.0#0A..LET.constr.#3D.out
put()#0A..LET.outstr.#3D.0#0A#0A..writef("*nMap.of.
free.and.allocated.blocks.in.%n#2E#2E%n*n*n",.memba
se,.memlim)#0A#0A..WHILE.mem(a).DO#0A..{.LET.size.#3D
.mem(a)#0A....LET.freeblk.#3D.(size&1)#3D1#0A#0A...
.TEST.freeblk#0A....THEN.{.//.Free.block#0A........
...size.:#3D.size-1#0A...........free.:#3D.free.+.s
ize#0A...........joinfree.:#3D.joinfree.+.size#0A..
.........IF.joinfree.>.largest_free.DO.largest_free
.:#3D.joinfree#0A.........}#0A....ELSE.{.//.Used.bl
ock#0A...........used.:#3D.used.+.size#0A..........
.joinfree.:#3D.0#0A.........}#0A#0A....UNLESS.size>
#3D0.&.a+size<#3Dtopofstore.DO#0A....{.writef("****
**Store.chain.corrupt!!*n*#0A..............*Noticed
.at.%n*n",.a)#0A......BREAK#0A....}#0A#0A....writef
("%i8:%i7.",.a,.size)#0A....IF.freeblk.DO.{.writes(
"free.");.GOTO.nxt.}#0A#0A....IF.a.#3D.(rootnode-1)
.DO.{.writes("Rootnode");.GOTO.nxt.}#0A....IF.mem(a
+3).#3D.sectword.&.memb(a+4,.0).#3D.11.DO#0A....{.L
ET.name.#3D.a+4#0A......writef("Section.")#0A......
FOR.i.#3D.1.TO.memb(name,.0).DO.wrch(memb(name,.i))
#0A......GOTO.nxt#0A....}#0A/*#0A....FOR.id.#3D.1.T
O.mem(tasktab).DO#0A....{.LET.t.#3D.mem(tasktab+id)
#0A......IF.t.DO#0A......{.LET.p,.g.#3D.mem(t+tcb_s
base),.mem(t+tcb_gbase)#0A........IF.a+1#3Dp.DO.{.w
ritef("Task.%n.stack",.id);.GOTO.nxt.}#0A........IF
.a+1#3Dg.DO.{.writef("Task.%n.global.vector",.id);.
GOTO.nxt.}#0A........IF.a+1#3Dt.DO.{.writef("Task.%
n.TCB",.id);.GOTO.nxt.}#0A........IF.g.&.a>500.FOR.
gn.#3D.1.TO.mem(g).IF.a+1#3Dmem(g+gn).DO#0A........
.............{.writef("Task.%n.G%n.#3D>.",.id,.gn)#0A
.......................GOTO.dump#0A................
.....}#0A......}#0A....}#0A*/#0Adump:#0A....FOR.i.#3D
.1.TO.5.DO.{.LET.n.#3D.mem(a+i)#0A.................
.......TEST.-10_000_000<#3Dn<#3D10_000_000#0A......
..................THEN.writef("%iA.",.n)#0A........
................ELSE.writef("#23x%x8.",.n)#0A......
................}#0Anxt:.#0A....newline()#0A....a.:
#3D.a.+.size#0A..}#0A#0A..writef("End.of.block.list
.#3D.%n*n",.a)#0A..topofstore.:#3D.a#0A#0A..writef(
"*nLargest.contiguous.free.area:.%n.words*n",.large
st_free)#0A..writef("Totals:.%n.words.available,.%n
.used,.%n.free*n*n",#0A..........used+free,.used,.f
ree)#0A#0Aexit:#0A}#0A#0AAND.dumptask(name,.regs).B
E#0A{.writef("*n*n#23#23#23#23#23#23#23#23#23#23#23
#23#23#23#23#23#23#23#23#23#23#23#23#23#23.Program.
%s.",.name)#0A..FOR.i.#3D.name%0+1.TO.15+16.DO.wrch
('#23')#0A..writef("*n")#0A#0A..gptr.:#3D.mem(regs+
r_g).>>.2#0A..pptr.:#3D.mem(regs+r_p).>>.2#0A..cptr
.:#3D.mem(gptr+g_currco)#0A#0A..UNLESS.cptr.<#3D.pp
tr.<#3D.cptr.+.mem(cptr+co_size.+.6).DO.cptr.:#3D.0
#0A#0A..fsize.:#3D.100#0A//sawritef("cptr#3D%n*n",.
cptr)#0A..IF.cptr.DO.fsize.:#3D.cptr.+.6.+.mem(cptr
+co_size).-.pptr#0A#0A..wrregs("Registers",.regs)#0A
#0A..IF.gptr.DO#0A..{.LET.gupb.#3D.mem(gptr)#0A....
writef("*nGlobal.variables.at.G.#3D.%n:*n",.gptr)#0A
....FOR.gn.#3D.0.TO.gupb.DO#0A....{.LET.w.#3D.mem(g
ptr+gn)#0A......IF.gn.REM.5.#3D.0.DO#0A......{.LET.
v,.gw.#3D.gptr+gn,.globword+gn#0A........IF........
......mem(v+0)#3Dgw+0.&#0A...........(gn+1>gupb.|.m
em(v+1)#3Dgw+1).&#0A...........(gn+2>gupb.|.mem(v+2
)#3Dgw+2).&#0A...........(gn+3>gupb.|.mem(v+3)#3Dgw
+3).&#0A...........(gn+4>gupb.|.mem(v+4)#3Dgw+4).DO
.{.gn.:#3D.gn+4;.LOOP.}#0A........writef("*nG%i3:",
.gn)#0A......}#0A......writearg(w)#0A....}#0A....ne
wline()#0A..}#0A#0A..writef("*nCoroutine.stacks.for
.program.%s:*n",.name)..#0A..wrcortns(regs)#0A}#0A#0A
AND.wrregs(str,.regs).BE#0A{.writef("*n%s:*n",.str)
#0A..writef("a#3D%n.b#3D%n.c#3D%n.",.mem(regs+r_a),
.mem(regs+r_b),.mem(regs+r_c))#0A..writef("p#3D%n(%
n).g#3D%n(%n).",.mem(regs+r_p),.mem(regs+r_p)>>2,#0A
...............................mem(regs+r_g),.mem(r
egs+r_g)>>2)#0A..writef("st#3D%n.pc#3D%n.count#3D%n
.mw#3D%n*n",.mem(regs+r_st),.mem(regs+r_pc),#0A....
...............................mem(regs+r_count),me
m(regs+r_mw))#0A}#0A#0AAND.write_sectname(s).BE#0A{
.LET.name.#3D.s+3#0A..TEST.(mem(s+2).#3D.sectword).
&.(memb(s+3,.0).#3D.11)#0A..THEN.FOR.i.#3D.1.TO.11.
DO.wrch(memb(name,.i))#0A..ELSE.writes("???????????
")#0A}#0A#0AAND.checkaddr(a).#3D.VALOF#0A{.UNLESS.m
embase<#3Da<#3Dmemlim.DO#0A..{.writef("*nBad.addres
s.%n.not.in.range.%n--%n*n",.a,.membase,.memlim)#0A
....RESULTIS.0#0A..}#0A..RESULTIS.a#0A}#0A#0AAND.co
nt(a).#3D.mem(checkaddr(a))#0A#0AAND.wrcortns(regs)
.BE#0A{.#0A//sawritef("cptr#3D%n.pptr#3D%n.gptr#3D%
n*n",.cptr,.pptr,.gptr)#0A..cptr.:#3D.cont(gptr+g_c
olist)#0A#0A..WHILE.0<cptr<#3Dmemlim.DO#0A..{.//.Ou
tput.a.coroutine.stack#0A....TEST.cptr#3Dcont(gptr+
g_currco)#0A....THEN.pptr.:#3D.cont(regs+r_p)>>2#0A
....ELSE.pptr.:#3D.cont(cptr+co_pptr)>>2#0A....fsiz
e.:#3D.cptr.+.6.+.cont(cptr+co_size).-.pptr#0A....w
rcortn()#0A#0A....//.Find.next.coroutine.in.the.lis
t#0A....cptr.:#3D.cont(cptr+co_list)#0A..}#0A..TEST
.cptr.THEN.writef("*nCorrupt.coroutine.list*n")#0A.
...........ELSE.writef("*nEnd.of.coroutine.list*n")
#0A}#0A#0AAND.wrcortn().BE#0A{.LET.size.#3D.cont(cp
tr+co_size)#0A..LET.hwm.#3D.size+6#0A..writef("*n%i
8:.",.cptr)#0A..IF.cptr#3Dmem(gptr+g_currco).DO.wri
tes("Current.")#0A..writes("Coroutine.")#0A..writea
rg(cont(cptr+co_fn))#0A..writef("..Parent.%n",.mem(
cptr+co_parent))#0A..WHILE.cont(cptr+hwm)#3Dstackwo
rd.DO.hwm:#3Dhwm-1#0A..writef("..Stack.%n/%n*n",.si
ze,.hwm-6)#0A..wrframe()#0A#0A..WHILE.pptr>.cptr.DO
#0A..{.LET.a.#3D.cont(pptr)>>2#0A....fsize.:#3D.ppt
r-a#0A....pptr.:#3D.a#0A....wrframe()#0A..}#0A#0A..
writef(".Base.of.stack*n")#0A}#0A#0AAND.wrframe().B
E#0A{.writef("%i8:",.pptr)#0A..TEST.pptr#3Dcptr#0A.
.THEN.writef("..#23StackBase#23")#0A..ELSE.writearg
(mem(pptr+2))#0A..FOR.i#3D3.TO.6.UNLESS.i>#3Dfsize.
DO.writearg(cont(pptr+i))#0A..newline()#0A..IF.fsiz
e>7.DO#0A..{.writef(".........")#0A....FOR.i.#3D.7.
TO.11.UNLESS.i>#3Dfsize.DO.writearg(cont(pptr+i))#0A
....newline()#0A..}#0A..IF.fsize>12.DO#0A..{.writef
(".........")#0A....FOR.i.#3D.12.TO.16.UNLESS.i>#3D
fsize.DO.writearg(cont(pptr+i))#0A....newline()#0A.
.}#0A}#0A#0AAND.writearg(n).BE#0A//.Write.an.argume
nt.in.a.field.width.of.13.characters#0A..TEST.isfun
(n)#0A..THEN.{.LET.s.#3D.(n>>2)-3..//.MR.1/11/03#0A
.........LET.len.#3D.memb(s,.0)#0A.........WHILE.le
n>0.&.memb(s,.len)#3D'.'.DO.len.:#3D.len-1#0A......
...FOR.i.#3D.len+1.TO.13.DO.wrch('.')#0A.........FO
R.i.#3D.1.TO.len.DO.wrch(memb(s,.i))#0A.......}#0A.
.ELSE.TEST.globword<#3Dn<#3Dglobword+1000..//.MR.1/
11/03#0A.......THEN.writef(".......#23G%z3#23",.n-g
lobword)#0A.......ELSE.TEST.-10_000_000<#3Dn<#3D10_
000_000#0A............THEN.writef("..%iB",.n)#0A...
.........ELSE.writef("...#23x%x8",.n)#0A#0AAND.isfu
n(f).#3D.VALOF#0A{.LET.a.#3D.f>>2#0A//sawritef("isf
un(%n)*n",.f)#0A..UNLESS.(f&3)#3D0.&.membase+4<a<#3D
memlim.RESULTIS.FALSE.//.MR.25/9/03#0A//sawritef("i
sfun:.a#3D%n*n",.a)#0A..IF.mem(a-4)#3Dentryword.&.m
emb(a-3,.0)#3D11.RESULTIS.TRUE.#0A//sawritef("isfun
:.returning.FALSE*n")#0A..RESULTIS.FALSE#0A}#0A#0AA
ND.getimage(filename).#3D.VALOF#0A{.LET.res.#3D.FAL
SE#0A..LET.oldin.#3D.input()#0A..LET.scb.#3D.findin
put(filename)#0A..LET.size,.upb,.wordsread.#3D.0,.0
,.0#0A#0A..imagedata,.addrv,.datav.:#3D.0,.0,.0#0A#0A
..UNLESS.scb.RESULTIS.FALSE#0A..size.:#3D.sys(Sys_f
ilesize,.scb!scb_fd)....//.Size.in.bytes#0A..IF.siz
e.DO.upb..:#3D.(size-1)/bytesperword.//.UPB.in.word
s......#0A#0A..imagedata.:#3D.getvec(upb)#0A..UNLES
S.imagedata.DO#0A..{.writef("Unable.to.allocate.a.v
ector.with.upb#3D%n*n",.upb)#0A....GOTO.ret#0A..}#0A
..selectinput(scb)#0A..wordsread.:#3D.readwords(ima
gedata,.upb+1)#0A..UNLESS.upb+1#3Dwordsread.DO#0A..
{.writef("Read.%n.words.from.%s,.it.should.have.bee
n.%n*n",#0A............wordsread,.filename,.upb+1)#0A
....GOTO.ret#0A..}#0A..//writef("Read.%n.words.from
.%s*n",.wordsread,.filename)#0A..//FOR.i.#3D.0.TO.u
pb>31->31,.upb.DO.writef("%i5:.%x8*n",.i,.imagedata
!i)#0A#0A..memupb.:#3D.imagedata!0#0A..imagep.:#3D.
1#0A#0A..datavupb.:#3D.0#0A..{.LET.addr,.imagep.#3D
.0,.1#0A....UNTIL.addr.>.memupb.DO#0A....{.LET.n.#3D
.imagedata!imagep#0A#0A//TEST.n>#3D0.THEN.writef("%
i9:.%i9.BLOCK*n",.addr,.n)#0A//..........ELSE.write
f("%i9:.%i9.x.%x8*n",.addr,.-n,.imagedata!(imagep+1
))#0A......UNLESS.n.BREAK#0A#0A......TEST.n>0.THEN.
imagep.:#3D.imagep.+.n.+.1#0A...............ELSE.im
agep.:#3D.imagep.+.2#0A......datavupb.:#3D.datavupb
.+.1#0A......//addrv!datavupb.:#3D.addr#0A......//d
atav!datavupb.:#3D.p#0A......addr.:#3D.addr.+.ABS.n
#0A....}#0A....UNLESS.addr.#3D.memupb+1.DO#0A....{.
writef("Image.file.is.corrupt,.addr#3D%n.memupb#3D%
n*n",.addr,.memupb)#0A......GOTO.ret#0A....}#0A..}#0A
//..writef("Image.file.ok,.datavupb#3D%n*n",.datavu
pb)#0A#0A..addrv.:#3D.getvec(datavupb)#0A..datav.:#3D
.getvec(datavupb)#0A..UNLESS.addrv.&.datav.DO#0A..{
.writef("More.space.needed*n")#0A....GOTO.ret#0A..}
#0A#0A..datavupb.:#3D.0#0A#0A..{.LET.addr,.imagep.#3D
.0,.1#0A....UNTIL.addr.>.memupb.DO#0A....{.LET.n.#3D
.imagedata!imagep#0A#0A......UNLESS.n.BREAK#0A#0A..
....datavupb.:#3D.datavupb.+.1#0A......addrv!datavu
pb.:#3D.addr#0A......datav!datavupb.:#3D.imagep#0A#0A
......TEST.n>0.THEN.imagep.:#3D.imagep.+.n.+.1#0A..
.............ELSE.imagep.:#3D.imagep.+.2#0A......ad
dr.:#3D.addr.+.ABS.n#0A....}#0A#0A....UNLESS.addr.#3D
.memupb+1.DO#0A....{.writef("Image.file.is.corrupt,
.addr#3D%n.memupb#3D%n*n",.addr,.memupb)#0A......GO
TO.ret#0A....}#0A..}#0A#0A..res.:#3D.TRUE#0Aret:#0A
..IF.scb.DO.endstream(scb)#0A..selectinput(oldin)#0A
..RESULTIS.res#0A}#0A#0AAND.mem(p).#3D.VALOF.//.Get
.a.word.of.dumped.memory#0A{.LET.i,.j,.len,.res.#3D
.1,.datavupb+1,.0,.0#0A..UNLESS.0<#3Dp<#3Dmemupb.DO
#0A..{.writef("*nBad.Cintpos.memory.address.%x8..%n
*n",.p,.p)#0A....longjump(rec_p,.rec_l)#0A....RESUL
TIS.#23xBAD00BAD#0A..}#0A#0A..{.LET.m.#3D.(i+j)/2#0A
//....writef("addrv!m#3D%i9.p#3D%n..i#3D%i2.m#3D%i2
.j#3D%i2*n",.addrv!m,.p,.i,.m,.j)#0A//abort(1000)#0A
....IF.i#3Dm.BREAK#0A....TEST.addrv!m.<#3D.p.THEN.i
.:#3D.m#0A......................ELSE.j.:#3D.m#0A..}
.REPEAT#0A#0A..len.:#3D.imagedata!(datav!i)#0A..//w
ritef("len.#3D.%n..datav!i#3D%n*n*n",.len,.datav!i)
#0A..TEST.len>0.THEN.res.:#3D.imagedata!(datav!i.+.
p-addrv!i+1)#0A.............ELSE.res.:#3D.imagedata
!(datav!i.+.1)#0A..//writef("mem(%n).#3D>.%x8..%i9*
n",.p,.res,.res)#0A..RESULTIS.res#0A}#0A#0AAND.memb
(p,.n).#3D.VALOF#0A{.LET.word.#3D.mem(p+(n>>2))#0A.
.RESULTIS.(@word)%(n&3)#0A}#0A

######cintcode/com/clktest.b#
GET."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.LET.k.#3D
.sys(Sys_settrcount,.0)#0A..LET.p.#3D.0#0A..LET.cou
nt.#3D.0#0A..LET.msecs.#3D.rootnode!rtn_msecs#0A#0A
..writef("initial.trcount#3D%n*n",.k)#0A#0A..//.Bus
y.loop.for.a.while#0A..FOR.i.#3D.0.TO.1000.DO#0A..{
.WHILE.msecs.#3D.rootnode!rtn_msecs.DO.count.:#3D.c
ount+1#0A....sys(Sys_trpush,.#23xFF000000.+.count)#0A
....msecs.:#3D.rootnode!rtn_msecs#0A....count.:#3D.
0#0A..}#0A#0A#0A..//.Stop.trpushing#0A..k.:#3D.sys(
Sys_settrcount,.-1)#0A..writef("Number.of.trpush.va
lues.#3D.%n*n",.k)#0A..p.:#3D.k.-.4096#0A..IF.p<0.D
O.p.:#3D.0#0A..FOR.i.#3D.p.TO.k-1.DO#0A..{.LET.val.
#3D.sys(Sys_gettrval,.i)#0A....LET.flag.#3D.val>>24
#0A....val.:#3D.val.&.#23xFFFFFF#0A....IF.(i-p).MOD
.8.#3D.0.DO.writef("*n%i4:",.i-p)#0A....TEST.flag#3D
#23x66#0A....THEN.writef("..%6#2E3d:",.val).//.Time
.item.inserted.by.trpush#0A....ELSE.writef("%6i/%x2
",.val,.flag).#0A..}#0A..newline()#0A..#0A..RESULTI
S.0#0A}#0A

######cintcode/com/testtr.b#
GET."libhdr"#0A#0ALET.start().#3D.VALOF#0A{.LET.k.#3D
.sys(Sys_settrcount,.0)#0A..LET.p.#3D.0#0A#0A..writ
ef("initial.trcount#3D%n*n",.k)#0A#0A..FOR.i.#3D.0.
TO.4100.DO.sys(Sys_trpush,.#23xDD000000+i)#0A#0A../
/.Stop.trpushing#0A..k.:#3D.sys(Sys_settrcount,.-1)
#0A..writef("Number.of.trpush.values.#3D.%n*n",.k)#0A
..p.:#3D.k.-.4096#0A..IF.p<0.DO.p.:#3D.0#0A..FOR.i.
#3D.p.TO.k-1.DO#0A..{.LET.val.#3D.sys(Sys_gettrval,
.i)#0A....LET.flag.#3D.val>>24#0A....val.:#3D.val.&
.#23xFFFFFF#0A....IF.(i-p).MOD.8.#3D.0.DO.writef("*
n%i4:",.i-p)#0A....TEST.flag#3D#23x66#0A....THEN.wr
itef("..%6#2E3d:",.val).//.Time.item.inserted.by.tr
push#0A....ELSE.writef("%6i/%x2",.val,.flag).#0A..}
#0A..newline()#0A..#0A..RESULTIS.0#0A}#0A

######cintcode/com/cotest.b#
//.This.tests.the.functionality.of.the.coroutine.#0A
//.functions:.callco,.cowait.and.resumeco#2E#0A#0A/
/.Implemented.by.Martin.Richards.(c).April.2005#0A#0A
SECTION."cotest"#0A#0AGET."libhdr"#0A#0AGLOBAL.{.a_
co:ug;.b_co;.c_co;.d_co.}#0A#0ALET.start().#3D.VALO
F#0A{.a_co.:#3D.createco(a_fn,.200)#0A..b_co.:#3D.c
reateco(b_fn,.200)#0A..c_co.:#3D.createco(c_fn,.200
)#0A..d_co.:#3D.createco(d_fn,.200)#0A#0A..writef("
*nTest:.root.->.a.->.root*n")#0A..writef("root:.cal
ling.callco(a_co,..100)*n")#0A..writef("root:.callc
o(a_co,..100).#3D>.%n*n",.callco(a_co,.100))#0A#0A.
.writef("*nTest:.root.->.a.->.root,.ie.check:.c:#3D
fn(cowait(c)).REPEAT*n")#0A..writef("root:.calling.
callco(a_co,..200)*n")#0A..writef("root:.callco(a_c
o,..200).#3D>.%n*n",.callco(a_co,.200))#0A#0A..writ
ef("*nTest:.root.->.b.->.a.->.b.->.root*n")#0A..wri
tef("root:.calling.callco(b_co,..300)*n")#0A..write
f("root:.callco(a_co,..300).#3D>.%n*n",.callco(b_co
,.300))#0A#0A..writef("*nTest:.root.->.b.->.a.->.b.
->.root..again*n")#0A..writef("root:.calling.callco
(b_co,..400)*n")#0A..writef("root:.callco(b_co,..40
0).#3D>.%n*n",.callco(b_co,.400))#0A#0A..writef("*n
Test:.root.->.c.->.a.->.root,.ie.check.resumeco.in.
c_co*n")#0A..writef("root:.calling.callco(c_co,..50
0)*n")#0A..writef("root:.callco(c_co,..500).#3D>.%n
*n",.callco(c_co,.500))#0A#0A..writef("*nTest:.root
.->.c.->.root*n")#0A..writef("root:.calling.callco(
c_co,..600)*n")#0A..writef("root:.callco(c_co,..600
).#3D>.%n*n",.callco(c_co,.600))#0A#0A..writef("*nT
est:.root.->.d.->.d.->.root,.ie.can.resumeco.call.i
tself*n")#0A..writef("root:.calling.callco(d_co,..7
00)*n")#0A..writef("root:.callco(d_co,..700).#3D>.%
n*n",.callco(d_co,.700))#0A#0A..deleteco(a_co)#0A..
deleteco(b_co)#0A..deleteco(c_co)#0A..deleteco(d_co
)#0A#0A..writef("*nEnd.of.test*n")#0A..RESULTIS.0#0A
}#0A#0AAND.a_fn(x).#3D.VALOF#0A{.writef("a_co:.ente
red.with.value.%n*n",.x)#0A..writef("a_co:.returnin
g.%n*n",.x+10)#0A..RESULTIS.x+10#0A}#0A#0AAND.b_fn(
x).#3D.VALOF#0A{.writef("b_co:.entered.with.value.%
n*n",.x)#0A..writef("b_co:.calling.callco(a_co,.200
0)*n")#0A..writef("b_co:.callco(a_co,.2000).#3D>.%n
*n",.callco(a_co,.2000))#0A..writef("b_co:.returnin
g.%n*n",.x+20)#0A..RESULTIS.x+20#0A}#0A#0AAND.c_fn(
x).#3D.VALOF#0A{.writef("c_co:.entered.with.value.%
n*n",.x)#0A..writef("c_co:.calling.resumeco(a_co,.3
000)*n")#0A..writef("c_co:.resumeco(a_co,.3000).#3D
>.%n*n",.resumeco(a_co,3000))#0A..writef("c_co:.ret
urning.%n*n",.x+30)#0A..RESULTIS.x+30#0A}#0A#0AAND.
d_fn(x).#3D.VALOF#0A{.writef("d_co:.entered.with.va
lue.%n*n",.x)#0A..writef("d_co:.calling.resumeco(d_
co,.4000)*n")#0A..writef("d_co:.resumeco(d_co,.4000
).#3D>.%n*n",.resumeco(d_co,4000))#0A..writef("d_co
:.returning.%n*n",.x+40)#0A..RESULTIS.x+40#0A}#0A#0A
/*.This.program.should.generate.the.following.outpu
t:#0A#0ATest:.root.->.a.->.root#0Aroot:.calling.cal
lco(a_co,..100)#0Aa_co:.entered.with.value.100#0Aa_
co:.returning.110#0Aroot:.callco(a_co,..100).#3D>.1
10#0A#0ATest:.root.->.a.->.root,.ie.check:.c:#3Dfn(
cowait(c)).REPEAT#0Aroot:.calling.callco(a_co,..200
)#0Aa_co:.entered.with.value.200#0Aa_co:.returning.
210#0Aroot:.callco(a_co,..200).#3D>.210#0A#0ATest:.
root.->.b.->.a.->.b.->.root#0Aroot:.calling.callco(
b_co,..300)#0Ab_co:.entered.with.value.300#0Ab_co:.
calling.callco(a_co,.2000)#0Aa_co:.enteredwith.valu
e.2000#0Aa_co:.returning.2010#0Ab_co:.callco(a_co,.
2000).#3D>.2010#0Ab_co:.returning.320#0Aroot:.callc
o(a_co,..300).#3D>.320#0A#0ATest:.root.->.b.->.a.->
.b.->.root..again#0Aroot:.calling.callco(b_co,..400
)#0Ab_co:.entered.with.value.400#0Ab_co:.calling.ca
llco(a_co,.2000)#0Aa_co:.entered.with.value.2000#0A
a_co:.returning.2010#0Ab_co:.callco(a_co,.2000).#3D
>.2010#0Ab_co:.returning.420#0Aroot:.callco(b_co,..
400).#3D>.420#0A#0ATest:.root.->.c.->.a.->.root,.ie
.check.resumeco.in.c_co#0Aroot:.calling.callco(c_co
,..500)#0Ac_co:.entered.with.value.500#0Ac_co:.call
ing.resumeco(a_co,.3000)#0Aa_co:.entered.with.value
.3000#0Aa_co:.returning.3010#0Aroot:.callco(c_co,..
500).#3D>.3010#0A#0ATest:.root.->.c.->.root#0Aroot:
.calling.callco(c_co,..600)#0Ac_co:.entered.with.va
lue.600#0Ac_co:.resumeco(a_co,.3000).#3D>.600#0Ac_c
o:.returning.530#0Aroot:.callco(c_co,..600).#3D>.53
0#0A#0ATest:.root.->.d.->.d.->.root,.ie.can.resumec
o.call.itself#0Aroot:.calling.callco(d_co,..700)#0A
d_co:.entered.with.value.700#0Ad_co:.calling.resume
co(d_co,.4000)#0Ad_co:.resumeco.called.#3D>.d_co#0A
d_co:.resumeco(d_co,.4000).#3D>.4000#0Ad_co:.return
ing.740#0Aroot:.callco(c_co,..700).#3D>.740#0A#0AEn
d.of.test#0A*/#0A#0A#0A

######cintcode/com/cobench.b#
//.This.is.a.benchmark.program.for.the.coroutine.me
chanism#0A#0A//.Implemented.in.BCPL.by.Martin.Richa
rds.(c).March.2004#0A#0ASECTION."cobench"#0A#0AGET.
"libhdr"#0A#0AGLOBAL.{#0A..kill_co:.ug........//.Th
e.killer.coroutine#0A..source_co#0A..tracing#0A}#0A
#0ALET.start().#3D.VALOF#0A{.LET.argv.#3D.VEC.50#0A
..LET.k,.n.#3D.10_000,.500#0A..LET.cptr.#3D.0#0A#0A
..UNLESS.rdargs("-k,-n,-t/S",.argv,.50).DO#0A..{.wr
itef("Bad.arguments.for.cobench*n")#0A....RESULTIS.
0#0A..}#0A#0A..IF.argv!0.&.string_to_number(argv!0)
.DO.k.:#3D.result2.//.-k#0A..IF.argv!1.&.string_to_
number(argv!1).DO.n.:#3D.result2.//.-n#0A..tracing.
:#3D.argv!2....................................//.-
t#0A#0A..writef("*nCobench.sending.%n.numbers.via.%
n.copy.coroutines*n*n",.k,.n)#0A#0A..kill_co.:#3D.c
reateco(deleteco,.150)#0A#0A..cptr.:#3D.createco(si
nkfn,.150)#0A#0A..FOR.i.#3D.1.TO.n.DO#0A..{.LET.co.
#3D.createco(copyfn,.150)#0A....callco(co,.cptr)#0A
....cptr.:#3D.co#0A..}#0A#0A..source_co.:#3D.create
co(sourcefn,.150)#0A..callco(source_co,.cptr)#0A#0A
..IF.tracing.DO.writef("All.coroutines.created*n*n"
)#0A#0A..callco(source_co,.k).//.Tell.sourceco.to.s
end.k.numbers.#0A#0A..deleteco(kill_co)#0A#0A..writ
ef("*nCobench.done*n")#0A..RESULTIS.0#0A}#0A#0AAND.
sourcefn(nextco).BE#0A{.LET.k.#3D.cowait()#0A..LET.
channel.#3D.0#0A..LET.out_chan_ptr.#3D.@channel#0A#0A
..callco(nextco,.out_chan_ptr)#0A.#0A..//IF.tracing
.DO#0A..//..writef("srcefn:.co#3D%n.out_chan_ptr#3D
%n.k#3D%n*n*n",#0A..//..........currco,.out_chan_pt
r,.k)#0A#0A..FOR.val.#3D.1.TO.k.DO#0A..{.IF.tracing
.DO.writef("srcefn:.sending.number.%n*n",.val)#0A..
..cowrite(out_chan_ptr,.val)#0A..}#0A..IF.tracing.D
O.writef("srcefn:.sending.number.0*n")#0A..cowrite(
out_chan_ptr,.0)#0A..//IF.tracing.DO.writef("srcefn
:.dying*n")#0A..die()#0A}#0A#0AAND.copyfn(nextco).B
E#0A{.LET.channel.#3D.0#0A..LET.in_chan_ptr,.out_ch
an_ptr.#3D.cowait(),.@channel#0A#0A..callco(nextco,
.out_chan_ptr)#0A#0A..{.LET.val.#3D.coread(in_chan_
ptr)#0A....IF.tracing.DO.writef("copyfn:.copying.nu
mber.%n*n",.val)#0A....cowrite(out_chan_ptr,.val)#0A
....UNLESS.val.BREAK#0A..}.REPEAT#0A#0A..//IF.traci
ng.DO.writef("copyfn:.dying*n")#0A..die()#0A}#0A#0A
AND.sinkfn(in_chan_ptr).BE#0A{.//IF.tracing.DO.writ
ef("sinkfn:...co#3D%n.in_chan_ptr#3D%n*n",#0A..//..
....................currco,.in_chan_ptr)#0A#0A..{.L
ET.val.#3D.coread(in_chan_ptr)#0A....IF.tracing.DO.
writef("sinkfn:.recving.number.%n*n",.val)#0A....UN
LESS.val.BREAK#0A..}.REPEAT#0A#0A..//IF.tracing.DO.
writef("sinkfn:.dying*n")#0A#0A..die()#0A}#0A#0AAND
.coread(ptr).#3D.VALOF#0A{.LET.cptr.#3D.!ptr#0A..TE
ST.cptr#0A..THEN.{.!ptr.:#3D.0.........//.Clear.the
.channel.word#0A.........RESULTIS.resumeco(cptr,.cu
rrco)#0A.......}#0A..ELSE.{.!ptr.:#3D.currco....//.
Set.channel.word.to.this.coroutine#0A.........RESUL
TIS.cowait().//.Wait.for.value.from.cowrite#0A.....
..}#0A}#0A#0AAND.cowrite(ptr,.val).BE#0A{.LET.cptr.
#3D.!ptr#0A..TEST.cptr#0A..THEN.{.!ptr.:#3D.0#0A...
......callco(cptr,.val).//.Send.val.to.coread#0A...
....}#0A..ELSE.{.!ptr.:#3D.currco#0A..........callc
o(cowait(),.val)#0A.......}#0A}#0A#0AAND.die().BE.r
esumeco(kill_co,.currco)#0A#0A#0A

######cintcode/com/cosim.b#
//.A.Discrete.event.simulation.benchmark.#0A//.Desi
gned.and.implemented.by.Martin.Richards.(c).June.20
04.#0A#0A//.This.is.a.benchmark.test.for.a.discrete
.event.simulator.using#0A//.BCPL.style.coroutines#2E
.It.simulates.a.network.of.n.nodes.which#0A//.each.
receive,.queue,.process.and.transmit.messages.to.ot
her.nodes#2E#0A//.The.nodes.are.uniformly.spaced.on
.a.straight.line.and.the.network#0A//.delay.is.assu
med.to.be.proportional.to.the.linear.distance.betwe
en#0A//.the.source.and.the.destination#2E.On.arriva
l,.if.the.receiving.node.is#0A//.busy.the.message.i
s.queued,.otherwise.it.is.processed.immediately#2E#0A
//.After.processing.the.message.for.random.time.it.
is.sent.to.another#0A//.random.node#2E.If.the.node.
has.a.non.empty.queue.it.dequeues.its.first#0A//.me
ssage.and.starts.to.process.it,.otherwise.it.become
s.suspended#2E#0A//.Initially.every.node.is.process
ing.a.message.and.every.queue.is#0A//.empty#2E.Ther
e.are.n.coroutines.to.simulate.the..progress.of.eac
h#0A//.message.and.the.discrete.event.priority.queu
e.is.implemented.using#0A//.the.heapsort.heap.struc
ture#2E.The.simulation.stops.at.a.specified#0A//.si
mulated.time#2E.The.result.is.the.number.of.message
s.that.have.been#0A//.processed#2E.A.machine.indepe
ndent.random.number.generator.is.used#0A//.so.the.r
esulting.value.should.be.indepent.of.implementation
#0A//.language.and.machine.being.used#2E#0A#0A//.Sp
ecial.comment.lines.have.been.included,.eg:#0A#0A//
........IF.j<priqn.&.min>priq!(j+1)!0.DO.j.:#3D.j+1
#0A//......//...^7499862..^7463825............^3477
178#0A#0A//.These.give.counts.of.how.many.times.the
.statements.above#0A//.the.^s.were.executed.when.co
sim.was.run#2E.These.counts#0A//.were.obtained.usin
g.the.stats.command#2E#0A#0ASECTION."cosim"#0A#0AGE
T."libhdr"#0A#0AGLOBAL.{#0A..priq:ug....//.The.vect
or.holding.the.priority.queue#0A..priqupb....//.The
.upper.bound#0A..priqn......//.Number.of.items.in.t
he.priority.queue#0A..wkqv.......//.The.vector.of.w
ork.queues#0A..count......//.count.of.messages.proc
essed#0A..nodes......//.The.number.of.nodes#0A..ptm
ax......//.The.maximum.processing.time#0A..stopco..
...//.The.stop.coroutine#0A..cov........//.Vector.o
f.message.coroutines#0A..ranv.......//.A.vector.use
d.by.the.random.number.generator#0A..rani;.ranj.//.
subscripts.of.ranv#0A..simtime....//.Simulated.time
#0A..stoptime...//.Time.to.stop.the.simulation#0A..
tracing#0A#0A//.Functions#0A..rnd#0A..initrnd#0A..c
losernd#0A..prq#0A..insertevent#0A..upheap#0A..down
heap#0A..getevent#0A..waitfor#0A..prwaitq#0A..qitem
#0A..dqitem#0A..stopcofn#0A..messcofn#0A}#0A#0A//.#23
#23#23#23#23#23#23#23#23#23#23#23#23#23#23#23#23#23
#23.Random.number.generator.#23#23#23#23#23#23#23#23
#23#23#23#23#23#23#23#23#23#23#23#23#23#23#23#0A#0A
//.The.following.random.number.generator.is.based.o
n.one.give#0A//.in.Knuth:.The.art.of.programming,.v
ol.2,.p.26#2E#0ALET.rnd(n).#3D.VALOF#0A{.LET.val.#3D
.(ranv!rani.+.ranv!ranj).&.#23x_FFF_FFFF#0A//^10043
10#0A..ranv!rani.:#3D.val#0A..rani.:#3D.(rani.+.1).
MOD.55#0A..ranj.:#3D.(ranj.+.1).MOD.55#0A..RESULTIS
.val.MOD.n#0A}#0A#0AAND.initrnd(seed).#3D.VALOF#0A{
.LET.a,.b.#3D.#23x_234_5678+seed,.#23x_536_2781#0A/
/^1#0A..ranv.:#3D.getvec(54)#0A..UNLESS.ranv.RESULT
IS.FALSE#0A..FOR.i.#3D.0.TO.54.DO#0A..{.LET.t.#3D.(
a+b).&.#23x_FFF_FFFF#0A//..^55#0A....a.:#3D.b#0A...
.b.:#3D.t#0A....ranv!i.:#3D.t#0A..}#0A..rani,.ranj.
:#3D.55-55,.55-24..//.ie:.0,.31#0A//^1#0A..RESULTIS
.TRUE#0A}#0A#0AAND.closernd().BE.IF.ranv.DO.freevec
(ranv)#0A//................^1.........^1#0A#0A//.#23
#23#23#23#23#23#23#23#23#23#23#23#23#23#23#23#23#23
#23.Priority.Queue.functions.#23#23#23#23#23#23#23#23
#23#23#23#23#23#23#23#23#23#23#23#23#23#23#0A#0AAND
.prq().BE#0A{.FOR.i.#3D.1.TO.priqn.DO.writef(".%i4"
,.priq!i!0)#0A//^0#0A..newline()#0A}#0A#0AAND.inser
tevent(event).BE#0A{.priqn.:#3D.priqn+1........//.I
ncrement.number.of.events#0A//^1004063#0A..//writef
("insertevent:.at.time:.%n..co#3D%n*n",.event!0,.ev
ent!1)#0A..upheap(event,.priqn)#0A}#0A#0AAND.upheap
(event,.i).BE#0A{.LET.eventtime.#3D.event!0#0A//^20
07777#0A//writef("upheap:.eventtime#3D%n.i#3D%n*n",
.eventtime,.i)#0A#0A..{.LET.p.#3D.i/2..........//.P
arent.of.i#0A//..^3066788#0A....UNLESS.p.&.eventtim
e.<.priq!p!0.DO#0A//.............^3064920#0A....{.p
riq!i.:#3D.event#0A//....^2007777#0A//prq()#0A.....
.RETURN#0A....}#0A....priq!i.:#3D.priq!p.....//.Dem
ote.the.parent#0A//..^1059011#0A//prq()#0A....i.:#3D
.p#0A..}.REPEAT#0A}#0A#0AAND.downheap(event,.i).BE#0A
{.LET.j,.min.#3D.2*i,.?.//.j.is.left.child,.if.pres
ent#0A//^8503576#0A//writef("downheap:.eventtime#3D
%n.i#3D%n*n",.event!0,.i)#0A//prq()#0A..IF.j.>.priq
n.DO#0A..{.upheap(event,.i)#0A//..^1003714#0A....RE
TURN#0A..}#0A..min.:#3D.priq!j!0#0A//^7499862#0A../
/.Look.at.other.child,.if.it.exists#0A..IF.j<priqn.
&.min>priq!(j+1)!0.DO.j.:#3D.j+1#0A//...^7499862..^
7463825............^3477178#0A..//.promote.earlier.
child#0A..priq!i.:#3D.priq!j#0A//^7499862#0A..i.:#3D
.j#0A}.REPEAT#0A#0AAND.getevent().#3D.VALOF#0A{.LET
.event.#3D.priq!1......//.Get.the.earliest.event#0A
//^1003714#0A..LET.last..#3D.priq!priqn..//.Get.the
.event.at.the.end.of.the.heap#0A//writef("getevent:
.priq:")#0A//prq()#0A..UNLESS.priqn>0.RESULTIS.0.//
.No.events.in.the.priority.queue#0A//..............
.^0#0A..priqn.:#3D.priqn-1........//.Decrement.the.
heap.size#0A//^1003714#0A..downheap(last,.1).......
//.Re-insert.last.event#0A..RESULTIS.event#0A}#0A#0A
AND.waitfor(ticks).BE#0A{.//.Make.an.event.item.int
o.the.priority.queue#0A..LET.eventtime,.co.#3D.simt
ime+ticks,.currco#0A//^1004063#0A//writef("waitfor:
.simtime#3D%n.ticks#3D%n*n",.simtime,.ticks)#0A..in
sertevent(@eventtime).//.Insert.into.the.priority.q
ueue#0A..cowait()................//.Wait.for.the.sp
ecified.number.of.ticks#0A}#0A#0A//.#23#23#23#23#23
#23#23#23#23#23#23#23#23#23#23#23#23#23#23#23#23#23
.Queueing.functions.#23#23#23#23#23#23#23#23#23#23#23
#23#23#23#23#23#23#23#23#23#23#23#23#23#23#0A#0AAND
.prwaitq(node).BE#0A{.LET.p.#3D.wkqv!node#0A//^0#0A
//abort(997)#0A..IF.-1.<#3D.p.<#3D.0.DO.{.writef("w
kq.for.node.%n:.%n*n",.node,.p);.RETURN.}#0A..write
f("wkq.for.node.%n:",.node)#0A..WHILE.p.DO#0A..{.wr
itef(".%n",.p!1)#0A....p.:#3D.!p#0A..}#0A..newline(
)#0A}#0A#0AAND.qitem(node).BE#0A//.The.message.has.
reached.this.node#0A//.I.currently.not.busy,.mark.a
s.busy.and.return.to.process#0A//.the.message,.othe
r.append.it.to.the.end.of.the.work.queue#0A//.for.t
his.node#2E#0A{.//.Make.a.queue.item#0A..LET.link,.
co.#3D.0,.currco#0A//^502305#0A..LET.p.#3D.wkqv!nod
e#0A//writef("qitem:.entered*n")#0A//prwaitq(node)#0A
..UNLESS.p.DO#0A..{.//.The.node.was.not.busy#0A....
wkqv!node.:#3D.-1..//.Mark.node.as.busy#0A//..^2516
11#0A....IF.tracing.DO#0A......writef("%i8:.node.%i
4:.node.not.busy*n",.simtime,.node)#0A//....^0#0A//
writef("qitem:.wkqv!%n#3D%n*n",.node,.wkqv!node)#0A
....//prwaitq(node)#0A//abort(998)#0A....RETURN#0A/
/..^251611#0A..}#0A..//.Append.item.to.the.end.of.t
his.queue#0A//abort(1000)#0A..IF.tracing.DO#0A//.^2
50694#0A....writef("%i8:.node.%i4:.busy.so.appendin
g.message.to.end.of.work.queue*n",#0A............si
mtime,.node)#0A//..^0#0A//abort(1000)#0A..TEST.p#3D
-1#0A//^250694#0A..THEN.wkqv!node.:#3D.@link.....//
.Form.a.unit.list#0A//.....^146286#0A..ELSE.{.WHILE
.!p.DO.p.:#3D.!p..//.Find.the.end.of.the.wkq#0A//..
.....^104408.....^61303#0A.........!p.:#3D.@link...
.......//.Append.to.end.of.wkq#0A//.......^104408#0A
.......}#0A..//prwaitq(node)#0A..cowait().//.Wait.t
o.be.activated.(by.dqitem)#0A//^250694#0A}#0A#0AAND
.dqitem(node).BE#0A//.A.message.has.just.been.proce
ssed.by.this.node.and.is.ready.to.process#0A//.the.
next,.if.any#2E#0A{.LET.item.#3D.wkqv!node.//.Curre
nt.item.(~#3D0)#0A//^501907#0A//writef("dqitem(%n):
.entered,.item#3D%n*n",.node,.item)#0A..UNLESS.item
.DO.abort(999)#0A//...............^0#0A//prwaitq(no
de)#0A..TEST.item#3D-1#0A//^501907#0A..THEN.wkqv!no
de.:#3D.0..................//.The.node.is.no.longer
.busy#0A//.....^251363#0A..ELSE.{.LET.next.#3D.item
!0#0A//.......^250544#0A.........AND.co...#3D.item!
1#0A.........wkqv!node.:#3D.next.->.next,.-1.//.De-
queue.the.item#0A//............................^104
356^146188#0A//prwaitq(node)#0A.........callco(co).
...................//.Process.the.next.message#0A//
.......^250544#0A.......}#0A}#0A#0A//.#23#23#23#23#23
#23#23#23#23#23#23#23#23#23#23#23#23#23#23#23#23#23
#23#23.Coroutine.Bodies.#23#23#23#23#23#23#23#23#23
#23#23#23#23#23#23#23#23#23#23#23#23#23#23#23#23#23
#0A#0AAND.stopcofn(arg).#3D.VALOF#0A{.waitfor(stopt
ime)#0A//^1#0A..IF.tracing.DO#0A....writef("%i8:.St
op.time.reached*n",.simtime)#0A//..^0#0A..RESULTIS.
0#0A//^1#0A}#0A.#0AAND.messcofn(node).#3D.VALOF#0A{
.qitem(node)...//.Put.the.message.on.the.work.queue
.for.this.node#0A//^500#0A#0A..{.//.Start.processin
g.the.first.message#0A....LET.prtime...#3D.rnd(ptma
x).....//.a.random.processing.time#0A//..^502155#0A
....LET.dest.....#3D.rnd(nodes).+.1.//.a.random.des
tination.node#0A....LET.netdelay.#3D.ABS(node-dest)
.//.the.network.delay#0A#0A//writef("prtime#3D%i3.d
est#3D%i3*n",.prtime,.dest)#0A//abort(1001)#0A....I
F.tracing.DO#0A......writef("%i8:.node.%i4:.process
ing.message.until.%n*n",#0A..............simtime,.n
ode,.simtime+prtime)#0A//....^0#0A....waitfor(prtim
e)#0A//..^502155#0A....count.:#3D.count.+.1.//.One.
more.message.processed#0A//..^501907#0A....IF.traci
ng.DO#0A......writef("%i8:.node.%i4:.message.proces
sed*n",#0A..............simtime,.node,.dest,.simtim
e+netdelay)#0A//....^0#0A#0A//prwaitq(node)#0A....d
qitem(node).//.De-queue.current.item.and.activate.t
he.next,.if.any#0A//..^501907#0A//prwaitq(node)#0A.
...IF.tracing.DO#0A......writef("%i8:.node.%i4:.sen
ding.message.to.node.%n.to.arrive.at.%n*n",#0A.....
.........simtime,.node,.dest,.simtime+netdelay)#0A/
/....^0#0A#0A....waitfor(netdelay)#0A//..^501907#0A
....node.:#3D.dest......//.The.message.has.arrived.
at.the.destination.node#0A//..^501805#0A....IF.trac
ing.DO#0A......writef("%i8:.node.%i4:.message.reach
ed.this.node*n",#0A..............simtime,.node)#0A/
/....^0#0A....qitem(node)...//.Queue.the.message.if
.necessary#0A//..^500636#0A....//.The.node.can.now.
process.the.first.message.on.its.work.queue#0A..}.R
EPEAT#0A//..^500469#0A}#0A//.#23#23#23#23#23#23#23#23
#23#23#23#23#23#23#23#23#23#23#23#23#23#23#23#23#23
.Main.Program.#23#23#23#23#23#23#23#23#23#23#23#23#23
#23#23#23#23#23#23#23#23#23#23#23#23#23#23#23#0A#0A
LET.start().#3D.VALOF#0A{.LET.seed.#3D.0#0A//^1#0A.
.LET.argv.#3D.VEC.50#0A//abort(1002)#0A#0A..UNLESS.
rdargs("-n,-s,-p,-r,-t/S",.argv,.50).DO#0A//.......
^1#0A..{.writef("Bad.arguments.for.cosim*n")#0A//..
^0#0A....RESULTIS.0#0A..}#0A#0A..nodes,.stoptime,.p
tmax.:#3D.500,.1_000_000,.1000#0A//^1#0A..IF.argv!0
.&.string_to_number(argv!0).DO.nodes....:#3D.result
2.//.-k#0A//...^1.......^0.........................
.^0#0A..IF.argv!1.&.string_to_number(argv!1).DO.sto
ptime.:#3D.result2.//.-s#0A//...^1.......^0........
..................^0#0A..IF.argv!2.&.string_to_numb
er(argv!2).DO.ptmax....:#3D.result2.//.-p#0A//...^1
.......^0..........................^0#0A..IF.argv!3
.&.string_to_number(argv!3).DO.seed.....:#3D.result
2.//.-r#0A//...^1.......^0.........................
.^0#0A..tracing.:#3D.argv!4........................
...................//.-t#0A//^1#0A..writef("*nCosim
.entered*n*n")#0A..writef("Network.nodes:.......%n*
n",.nodes)#0A..writef("Stop.time:...........%n*n",.
stoptime)#0A..writef("Max.processing.time:.%n*n",.p
tmax)#0A..writef("Random.number.seed:..%n*n",.seed)
#0A..newline()#0A#0A..UNLESS.initrnd(seed).DO#0A..{
.writef("Can't.initialise.the.random.number.generat
or*n")#0A//..^0#0A....RESULTIS.0#0A..}#0A#0AIF.FALS
E.DO#0A..FOR.i.#3D.1.TO.100.DO.//.Test.the.random.n
umber.generator#0A..{.writef(".%i4",.rnd(10000))#0A
....IF.i.MOD.10.#3D.0.DO.newline()#0A..}#0A#0A..sto
pco.:#3D.0#0A//^1#0A..wkqv,.priq,.cov.:#3D.getvec(n
odes),.getvec(nodes+1),.getvec(nodes)#0A..UNLESS.wk
qv.&.priq.&.cov.DO..#0A..{.writef("Can't.allocate.s
pace.for.the.node.work.queues*n")#0A//..^0#0A....GO
TO.ret#0A..}#0A#0A..FOR.i.#3D.1.TO.nodes.DO.wkqv!i,
.cov!i.:#3D.0,.0#0A//^1....................^500#0A.
.priqn.:#3D.0..//.Number.of.events.in.the.priority.
queue#0A//^1#0A..count.:#3D.0..//.Count.of.message.
processed#0A..simtime.:#3D.0.//.Simulated.time#0A#0A
..IF.tracing.DO.writef("%i8:.Starting.simulation*n"
,.simtime)#0A//..............^0#0A#0A//writef("rnd(
10000)#3D%n*n",.rnd(10000))#0A..//.Create.and.start
.the.stop.coroutine#0A..stopco.:#3D.createco(stopco
fn,.200)#0A//^1#0A..IF.stopco.DO.callco(stopco)#0A/
/.............^1#0A..//.Create.and.start.the.messag
e.coroutines#0A..FOR.i.#3D.1.TO.nodes.DO#0A//^1#0A.
.{.LET.co.#3D.createco(messcofn,.200)#0A//..^500#0A
....IF.co.DO.callco(co,.i)#0A//...........^500#0A..
..cov!i.:#3D.co#0A//..^500#0A..}#0A#0A..//.Run.the.
event.loop#0A#0A..{.LET.event.#3D.getevent()....../
/.Get.the.earliest.event#0A//..^1003714#0A....UNLES
S.event.BREAK#0A//...............^0#0A....simtime.:
#3D.event!0..........//.Set.the.simulated.time#0A..
..//IF.tracing.DO.writef("%i8:.calling.co#3D%n*n",.
simtime,.event!1)#0A....IF.simtime.>.stoptime.BREAK
#0A//........................^1#0A....callco(event!
1)#0A//..^1003713#0A..}.REPEAT#0A#0A..IF.tracing.DO
.writef("*nSimulation.stopped*n*n")#0A//^1.........
...^0#0A..writef("Messages.processed:.%n*n",.count)
#0A//^1#0A#0Aret:#0A..FOR.i.#3D.nodes.TO.1.BY.-1.IF
.cov!i.DO.deleteco(cov!i)#0A//^1...................
....^500........^500#0A..IF.cov....DO.freevec(cov)#0A
//^1...........^1#0A..IF.wkqv...DO.freevec(wkqv)#0A
//^1...........^1#0A..IF.priq...DO.freevec(priq)#0A
//^1...........^1#0A..IF.stopco.DO.deleteco(stopco)
#0A//^1...........^1#0A..closernd()#0A//^1#0A..RESU
LTIS.0#0A#0Afail:#0A..writef("Unable.to.initialise.
the.simulator*n")#0A//^0#0A..GOTO.ret#0A}#0A#0A//.T
otal.number.of.Cintcode.instructions.executed:.435,
363,350#0A//.Number.of.coroutine.changes:..........
............2,510,520#0A

######cintcode/com/bcplcgcin.b#
//.This.is.the.OCODE.to.Cintcode.codegenerator#2E#0A
#0A//.Implemented.by.Martin.Richards.(c).May.2009#0A
#0A#0A/*.Change.history#0A#0A10/07/09#0ASeparated.t
he.compiler.into.bcplfe#2Eb.and.codegenerators#0Abc
plcgcin#2Eb.and.bcplcgsial#2Eb.and.added.the.interf
ace#0Aheader.g/bcplfecg#2Eh#0A#0A18/01/06#0ABased.o
n.Dave.Lewis's.suggestion,#0Ain.outputsection(),.ad
d:#0A...IF.objline1%0.DO.writef("%s*n",.objline1)#0A
where.objline1.is.the.first.line.of.file.objline1.i
f.it.can.be.found#0Ain.the.current.directory.or.in.
the.HDRS.directory#2E.This.will.typically#0Aput.a.l
ine.such.as:#0A#23!/usr/local/bin/cintsys.-c#0Aas.t
he.first.line.of.the.compiled.object.module#2E.This
.line.is.ignored#0Aby.the.CLI.but.may.be.useful.und
er.Linux#2E.If.objline1.cannot.be.found#0Ano.such.l
ine.is.inserted.at.the.start.of.the.object.module#2E
#0A#0A26/2/99#0AAdded.BIN.option.to.the.compiler.to
.generate.a.binary.(rather.than#0Ahex).hunk.format.
for.the.compiled.code#2E.This.is.primarily.for.the#0A
Windows.CE.version.of.the.cintcode.system.where.com
pactness.is#0Aparticularly.important#2E.There.is.a.
related.change.to.loadseg.in#0Acintmain#2Ec#0A#0A24
/12/95#0AImproved.the.efficiency.of.outputsection.i
n.CG.by.introducing#0Awrhex2.and.wrword_at#2E#0A#0A
24/7/95#0ARemoved.bug.in.atbinfo,.define.addinfo_b.
change.some.global.numbers#2E#0AImplement.constant.
folding.in.TRN#2E#0A#0A22/6/93#0AReverse.order.in.S
WB.and.have.a.minimum.of.7.cases#0Ato.allow.faster.
interpreter#2E#0A#0A2/6/93#0AChanged.code.for.SWB.t
o.use.heap-like.binary.tree#2E#0A#0A19/5/93#0APut.i
n.code.to.compile.BTC.and.XPBYT.instructions#2E#0A#0A
23/4/93#0AAllowed.the.codegenerator.to.compiler.the
.S.instruction#2E#0A#0A21/12/92#0ACured.bug.in.comp
ilation.of.(b.->.f,.g)(1,2,3)#0A#0A24/11/92.#0ACure
d.bug.in.compilation.of.a,.b.:#3D.s%0.>.0,.s%1.#3D.
'!'#0A#0A23/7/92:#0ARenamed.nextlab.as.newlab,.load
.as.loadval.in.the.CG#2E#0APut.back.simpler.hashing
.function.in.lookupword#2E#0ARemoved.rdargs.fudge#2E
#0ARemoved.S2.compiler.option#2E#0ACured.bug.concer
ning.the.closing.of.gostream.when.equal.to.stdout#2E
#0A*/#0A#0ASECTION."BCPLCGCIN"#0A#0A//.Header.file.
for.the.CINTCODE32.code-generator#0A//.based.on.the
.original.CINTCODE.code-generator.(1980)#2E#0A//.Co
pyright..M#2ERichards..3.January.2006#2E#0A#0AGET."
libhdr"#0AGET."bcplfecg"#0A#0A#0AGLOBAL.{#0A//.Glob
al.procedures#2E#0Acgsects:.cgg#0Ardl#0Ardgn#0Anewl
ab#0Achecklab#0Acgerror#0A#0Ainitstack#0Astack#0Ast
ore#0Ascan#0Acgpendingop#0Aloadval#0Aloadba#0Asetba
#0A#0Agenxch#0Agenatb#0Aloada#0Apush#0Aloadboth#0Ai
nreg_a#0Ainreg_b#0Aaddinfo_a#0Aaddinfo_b#0Apushinfo
#0Axchinfo#0Aatbinfo#0A#0Aforget_a#0Aforget_b#0Afor
getall#0Aforgetvar#0Aforgetallvars#0A#0Aiszero#0Ast
oret#0Agensp#0Agenlp#0Aloadt#0Alose1#0Aswapargs#0Ac
gstind#0Astorein#0A#0Acgrv#0Acgplus#0Acgaddk#0Acggl
obal#0Acgentry#0Acgapply#0Acgjump#0Ajmpfn#0Ajfn0#0A
revjfn#0Acompjfn#0Aprepj#0A#0Aswlpos#0Aswrpos#0Afin
dpos#0Arootpos#0A#0Acgswitch#0Aswitcht#0Aswitchseg#0A
switchb#0Aswitchl#0Acgstring#0Asetlab#0Acgstatics#0A
getblk#0Afreeblk#0Afreeblks#0A#0Ainitdatalists#0A#0A
geng#0Agen#0Agenb#0Agenr#0Agenh#0Agenw#0Acheckspace
#0Acodeb#0Acode2b#0Acode4b#0Apack4b#0Acodeh#0Acodew
#0Acoder#0A#0Agetw#0Aputh#0Aputw#0Aalign#0Achkrefs#0A
dealwithrefs#0Agenindword#0Ainrange_d#0Ainrange_i#0A
fillref_d#0Afillref_i#0Arelref#0A#0Aoutputsection#0A
wrword#0Awrhex2#0Awrword_at#0Adboutput#0Awrkn#0Awrc
ode#0Awrfcode#0A#0A//.Global.variables#2E#0Aarg1#0A
arg2#0A#0Assp#0A#0Atempt#0Atempv#0Astv#0Astvp#0A#0A
ch#0A#0Adp#0Afreelist#0A#0Aincode#0Alabv#0A#0Acasek
#0Acasel#0A#0Amaxgn#0Amaxlab#0Amaxssp#0A#0Aop#0Alab
number#0Apendingop#0Aprocdepth#0A#0Aprogsize#0A#0Ai
nfo_a#0Ainfo_b#0Areflist#0Arefliste#0Arlist#0Arlist
e#0Anlist#0Anliste#0Askiplab#0A}#0A#0AMANIFEST#0A{#0A
//.Value.descriptors#2E#0Ak_none#3D0;.k_numb#3D1;.k
_fnlab#3D2#0Ak_lvloc#3D3;.k_lvglob#3D4;.k_lvlab#3D5
#0Ak_a#3D6;.k_b#3D7;.k_c#3D8#0Ak_loc#3D9;.k_glob#3D
10;.k_lab#3D11;.#0Ak_loc0#3D12;.k_loc1#3D13;.k_loc2
#3D14;.k_loc3#3D15;.k_loc4#3D16#0Ak_glob0#3D17;.k_g
lob1#3D18;.k_glob2#3D19#0A#0Aswapped#3DTRUE;.notswa
pped#3DFALSE#0A#0A//.Global.routine.numbers#2E#0Agn
_stop#3D2#0A}#0A#0A//.CINTCODE.op.codes#2E#0AMANIFE
ST.{#0Af_k0...#3D...0#0Af_lf...#3D..12#0Af_lm...#3D
..14#0Af_lm1..#3D..15#0Af_l0...#3D..16#0Af_fhop.#3D
..27#0Af_jeq..#3D..28#0Af_jeq0.#3D..30#0A#0Af_k....
#3D..32#0Af_kh...#3D..33#0Af_kw...#3D..34#0Af_k0g..
#3D..32#0Af_s0g..#3D..44#0Af_l0g..#3D..45#0Af_l1g..
#3D..46#0Af_l2g..#3D..47#0Af_lg...#3D..48#0Af_sg...
#3D..49#0Af_llg..#3D..50#0Af_ag...#3D..51#0Af_mul..
#3D..52#0Af_div..#3D..53#0Af_rem..#3D..54#0Af_xor..
#3D..55#0Af_sl...#3D..56#0Af_ll...#3D..58#0Af_jne..
#3D..60#0Af_jne0.#3D..62#0A#0Af_llp..#3D..64#0Af_ll
ph.#3D..65#0Af_llpw.#3D..66#0Af_add..#3D..84#0Af_su
b..#3D..85#0Af_lsh..#3D..86#0Af_rsh..#3D..87#0Af_an
d..#3D..88#0Af_or...#3D..89#0Af_lll..#3D..90#0Af_jl
s..#3D..92#0Af_jls0.#3D..94#0A#0Af_l....#3D..96#0Af
_lh...#3D..97#0Af_lw...#3D..98#0Af_rv...#3D.116#0Af
_rtn..#3D.123#0Af_jgr..#3D.124#0Af_jgr0.#3D.126#0A#0A
f_lp...#3D.128#0Af_lph..#3D.129#0Af_lpw..#3D.130#0A
f_lp0..#3D.128#0Af_swb..#3D.146#0Af_swl..#3D.147#0A
f_st...#3D.148#0Af_st0..#3D.148#0Af_goto.#3D.155#0A
f_jle..#3D.156#0Af_jle0.#3D.158#0A#0Af_sp...#3D.160
#0Af_sph..#3D.161#0Af_spw..#3D.162#0Af_sp0..#3D.160
#0Af_s0...#3D.176#0Af_xch..#3D.181#0Af_gbyt.#3D.182
#0Af_pbyt.#3D.183#0Af_atc..#3D.184#0Af_atb..#3D.185
#0Af_j....#3D.186#0Af_jge..#3D.188#0Af_jge0.#3D.190
#0A#0Af_ap...#3D.192#0Af_aph..#3D.193#0Af_apw..#3D.
194#0Af_ap0..#3D.192#0Af_xpbyt#3D.205#0Af_lmh..#3D.
206#0Af_btc..#3D.207#0Af_nop..#3D.208#0Af_a0...#3D.
208#0Af_rvp0.#3D.211#0Af_st0p0#3D.216#0Af_st1p0#3D.
218#0A#0Af_a....#3D.224#0Af_ah...#3D.225#0Af_aw...#3D
.226#0Af_l0p0.#3D.224#0Af_s....#3D.237#0Af_sh...#3D
.238#0Af_mdiv.#3D.239#0Af_chgco#3D.240#0Af_neg..#3D
.241#0Af_not..#3D.242#0Af_l1p0.#3D.240#0Af_l2p0.#3D
.244#0Af_l3p0.#3D.247#0Af_l4p0.#3D.249#0A}#0A#0ALET
.codegenerate(workspace,.workspacesize).BE#0A{.//wr
ites("CIN32CG.9.June.1999*n")#0A#0A...IF.workspaces
ize<2000.DO.{.cgerror("Too.little.workspace")#0A...
............................errcount.:#3D.errcount+
1#0A...............................longjump(fin_p,.
fin_l)#0A............................}#0A#0A...prog
size.:#3D.0#0A#0A...op.:#3D.rdn()#0A#0A...cgsects(w
orkspace,.workspacesize)#0A...writef("Code.size.#3D
.%i5.bytes*n",.progsize)#0A}#0A#0A#0AAND.cgsects(wo
rkvec,.vecsize).BE.UNTIL.op#3D0.DO#0A{.LET.p.#3D.wo
rkvec#0A...tempv.:#3D.p#0A...p.:#3D.p+90#0A...tempt
.:#3D.p#0A...casek.:#3D.p#0A...p.:#3D.p+400#0A...ca
sel.:#3D.p#0A...p.:#3D.p+400#0A...labv.:#3D.p#0A...
dp.:#3D.workvec+vecsize#0A...labnumber.:#3D.(dp-p)/
10+10#0A...p.:#3D.p+labnumber#0A...FOR.lp.#3D.labv.
TO.p-1.DO.!lp.:#3D.-1#0A...stv.:#3D.p#0A...stvp.:#3D
.0#0A...incode.:#3D.FALSE#0A...maxgn.:#3D.0#0A...ma
xlab.:#3D.0#0A...maxssp.:#3D.0#0A...procdepth.:#3D.
0#0A...info_a,.info_b.:#3D.0,.0#0A...initstack(3)#0A
...initdatalists()#0A#0A...codew(0)..//.For.size.of
.module#2E#0A...IF.op#3Ds_section.DO#0A...{.MANIFES
T.{.upb#3D11.}.//.Max.length.of.entry.name#0A......
LET.n.#3D.rdn()#0A......LET.v.#3D.VEC.upb/bytesperw
ord#0A......v%0.:#3D.upb#0A......//.Pack.up.to.11.c
haracter.of.the.name.into.v.including#0A......//.th
e.first.and.last.five#2E#0A......TEST.n<#3D11#0A...
...THEN.{.FOR.i.#3D.1.TO.n.DO.v%i.:#3D.rdn()#0A....
.........FOR.i.#3D.n+1.TO.11.DO.v%i.:#3D.'*s'#0A...
........}#0A......ELSE.{.FOR.i.#3D.1.TO.5...DO.v%i.
:#3D.rdn()#0A.............FOR.i.#3D.6.TO.n-6.DO.rdn
().//.Ignore.the.middle.characters#0A.............F
OR.i.#3D.6.TO.11..DO.v%i.:#3D.rdn()#0A.............
IF.n>11.DO.v%6.:#3D.'*''#0A...........}#0A......IF.
naming.DO.{.codew(sectword)#0A.....................
.codew(pack4b(v%0,.v%1,.v%.2,.v%.3))#0A............
..........codew(pack4b(v%4,.v%5,.v%.6,.v%.7))#0A...
...................codew(pack4b(v%8,.v%9,.v%10,.v%1
1))#0A...................}#0A......op.:#3D.rdn()#0A
...}#0A#0A...scan()#0A...op.:#3D.rdn()#0A...putw(0,
.stvp/4)..//.Plant.size.of.module#2E#0A...outputsec
tion()#0A...progsize.:#3D.progsize.+.stvp#0A}#0A#0A
#0A//.Read.an.OCODE.operator.or.argument#2E#0A/*#0A
AND.rdn().#3D.VALOF#0A{.LET.a,.sign.#3D.0,.'+'#0A..
.ch.:#3D.rdch().REPEATWHILE.ch#3D'*s'.|.ch#3D'*n'#0A
...IF.ch#3Dendstreamch.RESULTIS.0#0A...IF.ch#3D'-'.
DO.{.sign.:#3D.'-';.ch.:#3D.rdch().}#0A...WHILE.'0'
<#3Dch<#3D'9'.DO.{.a.:#3D.10*a.+.ch.-.'0';.ch.:#3D.
rdch()..}#0A...IF.sign#3D'-'.RESULTIS.-a#0A...RESUL
TIS.a#0A}#0A*/#0A//.Read.in.an.OCODE.label#2E#0AAND
.rdl().#3D.VALOF#0A{.LET.l.#3D.rdn()#0A...IF.maxlab
<l.DO.{.maxlab.:#3D.l;.checklab().}#0A...RESULTIS.l
#0A}#0A#0A//.Read.in.a.global.number#2E#0AAND.rdgn(
).#3D.VALOF#0A{.LET.g.#3D.rdn()#0A...IF.maxgn<g.DO.
maxgn.:#3D.g#0A...RESULTIS.g#0A}#0A#0A#0A//.Generat
e.next.label.number#2E#0AAND.newlab().#3D.VALOF#0A{
.labnumber.:#3D.labnumber-1#0A...checklab()#0A...RE
SULTIS.labnumber#0A}#0A#0A#0AAND.checklab().BE.IF.m
axlab>#3Dlabnumber.DO#0A{.cgerror("Too.many.labels.
-.increase.workspace")#0A...errcount.:#3D.errcount+
1#0A...longjump(fin_p,.fin_l)#0A}#0A#0A#0AAND.cgerr
or(mes,.a).BE#0A{.writes("*nError:.")#0A...writef(m
es,.a)#0A...newline()#0A...errcount.:#3D.errcount+1
#0A...IF.errcount>errmax.DO.{.writes("Too.many.erro
rs*n")#0A............................longjump(fin_p
,.fin_l)#0A.........................}#0A}#0A#0A#0A/
/.Initialize.the.simulated.stack.(SS)#2E#0ALET.init
stack(n).BE#0A{.arg2,.arg1,.ssp.:#3D.tempv,.tempv+3
,.n#0A...pendingop.:#3D.s_none#0A...h1!arg2,.h2!arg
2,.h3!arg2.:#3D.k_loc,.ssp-2,.ssp-2#0A...h1!arg1,.h
2!arg1,.h3!arg1.:#3D.k_loc,.ssp-1,.ssp-1#0A...IF.ma
xssp<ssp.DO.maxssp.:#3D.ssp#0A}#0A#0A#0A//.Move.sim
ulated.stack.(SS).pointer.to.N#2E#0AAND.stack(n).BE
#0A{.IF.maxssp<n.DO.maxssp.:#3D.n#0A...IF.n>#3Dssp+
4.DO.{.store(0,ssp-1)#0A.....................initst
ack(n)#0A.....................RETURN#0A............
......}#0A#0A...WHILE.n>ssp.DO.loadt(k_loc,.ssp)#0A
#0A...UNTIL.n#3Dssp.DO#0A...{.IF.arg2#3Dtempv.DO#0A
......{.TEST.n#3Dssp-1#0A.........THEN.{.ssp.:#3D.n
#0A.................h1!arg1,.h2!arg1,.h3!arg1.:#3D.
h1!arg2,.h2!arg2,.ssp-1#0A.................h1!arg2,
.h2!arg2,.h3!arg2.:#3D.k_loc,.ssp-2,.ssp-2#0A......
........}#0A.........ELSE.initstack(n)#0A.........R
ETURN#0A......}#0A#0A......arg1,.arg2,.ssp.:#3D.arg
1-3,.arg2-3,.ssp-1#0A...}#0A}#0A#0A#0A#0A//.Store.a
ll.SS.items.from.S1.to.S2.in.their.true#0A//.locati
ons.on.the.stack#2E#0A//.It.may.corrupt.both.regist
ers.A.and.B#2E#0AAND.store(s1,.s2).BE.FOR.p.#3D.tem
pv.TO.arg1.BY.3.DO#0A.....................{.LET.s.#3D
.h3!p#0A.......................IF.s>s2.RETURN#0A...
....................IF.s>#3Ds1.DO.storet(p)#0A.....
................}#0A#0A#0AAND.scan().BE#0A{.IF.debu
g>1.DO.{.writef("OP#3D%i3.PND#3D%i3.",.op,.pendingo
p)#0A..................dboutput()#0A...............
.}#0A#0A..SWITCHON.op.INTO#0A#0A..{.DEFAULT:.....cg
error("Bad.OCODE.op.%n",.op)#0A.................END
CASE#0A#0A....CASE.0:......RETURN#0A......#0A....CA
SE.s_needs:#0A...............{.LET.n.#3D.rdn()..//.
Ignore.NEEDS.directives#2E#0A.................FOR.i
.#3D.1.TO.n.DO.rdn()#0A.................ENDCASE#0A.
..............}#0A#0A....CASE.s_lp:...loadt(k_loc,.
..rdn());...ENDCASE#0A....CASE.s_lg:...loadt(k_glob
,..rdgn());..ENDCASE#0A....CASE.s_ll:...loadt(k_lab
,...rdl());...ENDCASE#0A....CASE.s_lf:...loadt(k_fn
lab,.rdl());...ENDCASE#0A....CASE.s_ln:...loadt(k_n
umb,..rdn());...ENDCASE#0A#0A....CASE.s_lstr:.cgstr
ing(rdn());.........ENDCASE#0A#0A....CASE.s_true:.l
oadt(k_numb,.-1);.......ENDCASE#0A....CASE.s_false:
loadt(k_numb,..0);.......ENDCASE#0A#0A....CASE.s_ll
p:..loadt(k_lvloc,..rdn());..ENDCASE#0A....CASE.s_l
lg:..loadt(k_lvglob,.rdgn());.ENDCASE#0A....CASE.s_
lll:..loadt(k_lvlab,..rdl());..ENDCASE#0A#0A....CAS
E.s_sp:...storein(k_loc,..rdn());..ENDCASE#0A....CA
SE.s_sg:...storein(k_glob,.rdgn());.ENDCASE#0A....C
ASE.s_sl:...storein(k_lab,..rdl());..ENDCASE#0A#0A.
...CASE.s_stind:cgstind();.ENDCASE#0A#0A....CASE.s_
rv:...cgrv();.ENDCASE#0A#0A....CASE.s_mult:CASE.s_d
iv:CASE.s_rem:#0A....CASE.s_plus:CASE.s_minus:#0A..
..CASE.s_eq:.CASE.s_ne:#0A....CASE.s_ls:CASE.s_gr:C
ASE.s_le:CASE.s_ge:#0A....CASE.s_lshift:CASE.s_rshi
ft:#0A....CASE.s_logand:CASE.s_logor:CASE.s_eqv:CAS
E.s_neqv:#0A....CASE.s_not:CASE.s_neg:CASE.s_abs:#0A
.................cgpendingop()#0A.................p
endingop.:#3D.op#0A.................ENDCASE#0A#0A..
..CASE.s_jt:...cgjump(TRUE,.rdl());..ENDCASE#0A#0A.
...CASE.s_jf:...cgjump(FALSE,.rdl());.ENDCASE#0A#0A
....CASE.s_goto:.cgpendingop()#0A.................s
tore(0,.ssp-2)#0A.................TEST.h1!arg1#3Dk_
fnlab#0A.................THEN.genr(f_j,.h2!arg1)#0A
.................ELSE.{.loada(arg1);.gen(f_goto).}#0A
.................stack(ssp-1)#0A.................in
code.:#3D.FALSE#0A.................//.This.is.a.goo
d.place.to.deal.with#0A.................//.some.out
standing.forward.refs#2E#0A.................chkrefs
(50)#0A.................ENDCASE#0A#0A....CASE.s_lab
:..cgpendingop()#0A.................UNLESS.incode.D
O.chkrefs(30)#0A.................store(0,.ssp-1)#0A
.................setlab(rdl())#0A.................f
orgetall()#0A.................incode.:#3D.procdepth
>0#0A.................ENDCASE#0A#0A....CASE.s_query
:loadt(k_loc,.ssp);..............ENDCASE#0A#0A....C
ASE.s_stack:cgpendingop();.stack(rdn());....ENDCASE
#0A#0A....CASE.s_store:cgpendingop();.store(0,.ssp-
1);.ENDCASE#0A#0A....CASE.s_entry:#0A..............
.{.LET.l.#3D.rdl()#0A.................LET.n.#3D.rdn
()#0A.................cgentry(l,.n)#0A.............
....procdepth.:#3D.procdepth.+.1#0A................
.ENDCASE#0A...............}#0A#0A....CASE.s_save:#0A
...............{.LET.n.#3D.rdn()#0A................
.initstack(n)#0A.................IF.n>3.DO.addinfo_
a(k_loc,.3)#0A.................ENDCASE#0A..........
.....}#0A#0A....CASE.s_fnap:#0A....CASE.s_rtap:.cga
pply(op,.rdn());.ENDCASE#0A#0A....CASE.s_rtrn:.cgpe
ndingop()#0A.................gen(f_rtn)#0A.........
........incode.:#3D.FALSE#0A.................ENDCAS
E#0A...................#0A....CASE.s_fnrn:.cgpendin
gop()#0A.................loada(arg1)#0A............
.....gen(f_rtn)#0A.................stack(ssp-1)#0A.
................incode.:#3D.FALSE#0A...............
..ENDCASE#0A#0A....CASE.s_endproc:#0A..............
...cgstatics()#0A.................procdepth.:#3D.pr
ocdepth.-.1#0A.................ENDCASE#0A#0A....CAS
E.s_res:#0A....CASE.s_jump:#0A...............{.LET.
l.#3D.rdl()#0A#0A.................cgpendingop()#0A.
................store(0,.ssp-2)#0A.................
TEST.op#3Ds_jump#0A.................THEN.storet(arg
1)#0A.................ELSE.{.loada(arg1);.stack(ssp
-1).}#0A#0A.................{.op.:#3D.rdn()#0A.....
..............UNLESS.op#3Ds_stack.BREAK#0A.........
..........stack(rdn())#0A.................}.REPEAT#0A
#0A.................TEST.op#3Ds_lab#0A.............
....THEN.{.LET.m.#3D.rdl()#0A......................
..UNLESS.l#3Dm.DO.genr(f_j,.l)#0A..................
......setlab(m)#0A........................forgetall
()#0A........................incode.:#3D.procdepth>
0#0A........................op.:#3D.rdn()#0A.......
...............}#0A.................ELSE.{.genr(f_j
,.l)#0A........................incode.:#3D.FALSE#0A
........................//.Deal.with.some.refs#2E#0A
........................chkrefs(50)#0A.............
.........}#0A#0A.................LOOP#0A...........
....}#0A#0A....//.rstack.always.occurs.immediately.
after.a.lab.statement#0A....//.at.a.time.when.cgpen
dingop().and.store(0,.ssp-2).have#0A....//.been.cal
led#2E#0A....CASE.s_rstack:#0A.................stac
k(rdn());.loadt(k_a,.0);.ENDCASE#0A#0A....CASE.s_fi
nish:..//.Compile.code.for:..stop(0)#2E#0A.........
......{.LET.k.#3D.ssp#0A.................stack(ssp+
3)#0A.................loadt(k_numb,.0)#0A..........
.......loadt(k_numb,.0)#0A.................loadt(k_
glob,.gn_stop)#0A.................cgapply(s_rtap,.k
)....//.Simulate.the.call:.stop(0,.0)#0A...........
......ENDCASE#0A...............}#0A#0A....CASE.s_sw
itchon:#0A.................cgswitch();.ENDCASE#0A#0A
....CASE.s_getbyte:#0A.................cgpendingop(
)#0A.................loadba(arg2,.arg1)#0A.........
........gen(f_gbyt)#0A.................forget_a()#0A
.................lose1(k_a,.0)#0A.................E
NDCASE#0A#0A#0A....CASE.s_putbyte:#0A..............
...cgpendingop()#0A#0A.................//.First.mov
e.arg3.to.C#2E#0A.................{.LET.arg3.#3D.ar
g2.-.3#0A...................TEST.arg3-tempv.<.0.#0A
...................THEN.{.loadt(k_loc,.ssp-3)#0A...
.......................loada(arg1)#0A..............
............gen(f_atc)#0A..........................
stack(ssp-1)#0A........................}#0A........
...........ELSE.{.TEST.inreg_b(h1!arg3,.h2!arg3)#0A
..........................THEN....gen(f_btc)#0A....
......................ELSE.{.loada(arg3)#0A........
.........................gen(f_atc)#0A.............
..................}#0A..........................h1!
arg3.:#3D.k_c#0A........................}#0A.......
............TEST.loadboth(arg2,.arg1)#3Dswapped#0A.
..................THEN.gen(f_xpbyt)#0A.............
......ELSE.gen(f_pbyt)#0A...................forgeta
llvars()#0A...................stack(ssp-3)#0A......
.............ENDCASE#0A.................}#0A#0A....
CASE.s_global:.cgglobal(rdn());.RETURN#0A#0A....CAS
E.s_datalab:#0A.................{.LET.lab.#3D.rdl()
.#0A...................op.:#3D.rdn()#0A#0A.........
..........WHILE.op#3Ds_itemn.DO#0A.................
..{.!nliste.:#3D.getblk(0,lab,rdn())#0A............
..........nliste,.lab,.op.:#3D.!nliste,.0,.rdn()#0A
...................}#0A...................LOOP#0A..
...............}#0A..}#0A#0A..op.:#3D.rdn()#0A}.REP
EAT#0A#0A#0A//.Compiles.code.to.deal.with.any.pendi
ng.op#2E#0ALET.cgpendingop().BE#0A{.LET.f.#3D.0#0A.
..LET.sym.#3D.TRUE#0A...LET.pndop.#3D.pendingop#0A.
..pendingop.:#3D.s_none#0A#0A...SWITCHON.pndop.INTO
#0A...{.DEFAULT:......cgerror("Bad.pendingop.%n",.p
ndop)#0A#0A......CASE.s_none:..RETURN#0A#0A......CA
SE.s_abs:...loada(arg1)#0A....................chkre
fs(3)#0A....................genb(jfn0(f_jgr),.2).//
.Conditionally.skip#0A....................gen(f_neg
)...........//.over.this.NEG.instruction#2E#0A.....
...............forget_a()#0A....................RET
URN#0A#0A......CASE.s_neg:...loada(arg1)#0A........
............gen(f_neg)#0A....................forget
_a()#0A....................RETURN#0A#0A......CASE.s
_not:...loada(arg1)#0A....................gen(f_not
)#0A....................forget_a()#0A..............
......RETURN#0A#0A......CASE.s_eq:.CASE.s_ne:#0A...
...CASE.s_ls:.CASE.s_gr:#0A......CASE.s_le:.CASE.s_
ge:#0A....................f.:#3D.prepj(jmpfn(pndop)
)#0A....................chkrefs(4)#0A..............
......genb(f,.2)....//.Jump.to....---#0A...........
.........gen(f_fhop)...//...............|#0A.......
.............gen(f_lm1)....//.this.point..<-#0A....
................lose1(k_a,.0)#0A...................
.forget_a()#0A....................forget_b()#0A....
................RETURN#0A#0A......CASE.s_minus:.UNL
ESS.k_numb#3Dh1!arg1.DO#0A....................{.f,.
sym.:#3D.f_sub,.FALSE#0A.......................ENDC
ASE#0A....................}#0A....................h
2!arg1.:#3D.-h2!arg1#0A#0A......CASE.s_plus:..cgplu
s();.RETURN#0A#0A......CASE.s_mult:..f......:#3D.f_
mul;........ENDCASE#0A......CASE.s_div:...f,.sym.:#3D
.f_div,.FALSE;.ENDCASE#0A......CASE.s_rem:...f,.sym
.:#3D.f_rem,.FALSE;.ENDCASE#0A......CASE.s_lshift:f
,.sym.:#3D.f_lsh,.FALSE;.ENDCASE#0A......CASE.s_rsh
ift:f,.sym.:#3D.f_rsh,.FALSE;.ENDCASE#0A......CASE.
s_logand:f......:#3D.f_and;........ENDCASE#0A......
CASE.s_logor:.f......:#3D.f_or;.........ENDCASE#0A.
.....CASE.s_eqv:#0A......CASE.s_neqv:..f......:#3D.
f_xor;........ENDCASE#0A...}#0A#0A...TEST.sym.THEN.
loadboth(arg2,.arg1)#0A............ELSE.loadba(arg2
,.arg1)#0A#0A...gen(f)#0A...forget_a()#0A...IF.pndo
p#3Ds_eqv.THEN.gen(f_not)#0A#0A...lose1(k_a,.0)#0A}
#0A#0ALET.loada(x)...BE.{.loadval(x,.FALSE);.setba(
0,.x).}#0A#0AAND.push(x,.y).BE.{.loadval(y,.TRUE);.
.setba(x,.y).}#0A#0AAND.loadval(x,.pushing).BE..//.
ONLY.called.from.loada.and.push#2E#0A//.Load.compil
es.code.to.have.the.following.effect:#0A//.If.pushi
ng#3DTRUE....B.:#3D.A;.A.:#3D.<x>#2E#0A//.If.pushin
g#3DFALSE...B.:#3D.?;.A.:#3D.<x>#2E#0A{.LET.k,.n.#3D
.h1!x,.h2!x#0A#0A...UNLESS.pushing.|.k#3Dk_a.DO..//
.Dump.A.register.if.necessary#2E#0A.....FOR.t.#3D.a
rg1.TO.tempv.BY.-3.IF.h1!t#3Dk_a.DO.{.storet(t);.BR
EAK.}#0A#0A...TEST.inreg_a(k,.n).THEN.setba(0,.x)#0A
......................ELSE.IF.inreg_b(k,.n).DO.{.ge
nxch(0,.0)#0A......................................
............RETURN#0A..............................
.................}#0A...SWITCHON.h1!x.INTO#0A...{.D
EFAULT:..cgerror("in.loada.%n",.k)#0A#0A......CASE.
k_a:.IF.pushing.UNLESS.inreg_b(k,.n).DO.genatb(0,.0
)#0A................RETURN#0A#0A......CASE.k_numb:#0A
........TEST.-1<#3Dn<#3D10#0A........THEN.gen(f_l0+
n)#0A........ELSE.TEST.0<#3Dn<#3D255#0A............
.THEN.genb(f_l,.n)#0A.............ELSE.TEST.-255<#3D
n<#3D0#0A..................THEN.genb(f_lm,.-n)#0A..
................ELSE.TEST.0<#3Dn<#3D#23xFFFF#0A....
...................THEN.genh(f_lh,.n)#0A...........
............ELSE.TEST.-#23xFFFF<#3Dn<#3D0#0A.......
.....................THEN.genh(f_lmh,.-n)#0A.......
.....................ELSE.genw(f_lw,.n)#0A........E
NDCASE#0A#0A......CASE.k_loc:..genlp(n);........END
CASE#0A......CASE.k_glob:.geng(f_lg,.n);...ENDCASE#0A
......CASE.k_lab:..genr(f_ll,.n);...ENDCASE#0A.....
.CASE.k_fnlab:genr(f_lf,.n);...ENDCASE#0A#0A......C
ASE.k_lvloc:TEST.0<#3Dn<#3D255#0A..................
.THEN.genb(f_llp,.n)#0A...................ELSE.TEST
.0<#3Dn<#3D#23xFFFF#0A........................THEN.
genh(f_llph,.n)#0A........................ELSE.genw
(f_llpw,.n)#0A...................ENDCASE#0A#0A.....
.CASE.k_lvglob:geng(f_llg,.n);.ENDCASE#0A......CASE
.k_lvlab:.genr(f_lll,.n);.ENDCASE#0A......CASE.k_lo
c0:..gen(f_l0p0+n);..ENDCASE#0A......CASE.k_loc1:..
gen(f_l1p0+n);..ENDCASE#0A......CASE.k_loc2:..gen(f
_l2p0+n);..ENDCASE#0A......CASE.k_loc3:..gen(f_l3p0
+n);..ENDCASE#0A......CASE.k_loc4:..gen(f_l4p0+n);.
.ENDCASE#0A......CASE.k_glob0:.geng(f_l0g,.n);.ENDC
ASE#0A......CASE.k_glob1:.geng(f_l1g,.n);.ENDCASE#0A
......CASE.k_glob2:.geng(f_l2g,.n);.ENDCASE#0A...}#0A
#0A...//.A.loading.instruction.has.just.been.compil
ed#2E#0A...pushinfo(h1!x,.h2!x)#0A}#0A#0AAND.loadba
(x,.y).BE.IF.loadboth(x,.y)#3Dswapped.DO.genxch(x,.
y)#0A#0AAND.setba(x,.y).BE#0A{.UNLESS.x#3D0.DO.h1!x
.:#3D.k_b#0A...UNLESS.y#3D0.DO.h1!y.:#3D.k_a#0A}#0A
#0AAND.genxch(x,.y).BE.{.gen(f_xch);.xchinfo();.set
ba(x,.y).}#0A#0AAND.genatb(x,.y).BE.{.gen(f_atb);.a
tbinfo();.setba(x,.y).}#0A#0AAND.loadboth(x,.y).#3D
.VALOF#0A//.Compiles.code.to.cause#0A//...either...
.x.->.[B]..and..y.->.[A]#0A//.............giving.re
sult.NOTSWAPPED#0A//...or........x.->.[A]..and..y.-
>.[B]#0A//.............giving.result.SWAPPED#2E#0A/
/.LOADBOTH.only.swaps.if.this.saves.code#2E#0A{.//.
First.ensure.that.no.other.stack.item.uses.reg.A#2E
#0A...FOR.t.#3D.tempv.TO.arg1.BY.3.DO#0A.......IF.h
1!t#3Dk_a.UNLESS.t#3Dx.|.t#3Dy.DO.storet(t)#0A#0A..
.{.LET.xa,.ya.#3D.inreg_a(h1!x,.h2!x),.inreg_a(h1!y
,.h2!y)#0A......AND.xb,.yb.#3D.inreg_b(h1!x,.h2!x),
.inreg_b(h1!y,.h2!y)#0A#0A......IF.xb.&.ya.DO.{.set
ba(x,y);...............RESULTIS.notswapped.}#0A....
..IF.xa.&.yb.DO.{.setba(y,x);...............RESULTI
S.swapped....}#0A......IF.xa.&.ya.DO.{.genatb(x,y);
..............RESULTIS.notswapped.}#0A......IF.xb.&
.yb.DO.{.genxch(0,y);.genatb(x,y);.RESULTIS.notswap
ped.}#0A......#0A......IF.xa.DO.{..............push
(x,y);.RESULTIS.notswapped.}#0A......IF.ya.DO.{....
..........push(y,x);.RESULTIS.swapped....}#0A......
IF.xb.DO.{.genxch(0,x);.push(x,y);.RESULTIS.notswap
ped.}#0A......IF.yb.DO.{.genxch(0,y);.push(y,x);.RE
SULTIS.swapped....}#0A......#0A......loada(x)#0A...
...push(x,.y)#0A......RESULTIS.notswapped#0A...}#0A
}#0A#0ALET.inreg_a(k,.n).#3D.VALOF#0A{.LET.p.#3D.in
fo_a#0A...IF.k#3Dk_a.RESULTIS.TRUE#0A...UNTIL.p#3D0
.DO.{.IF.k#3Dh2!p.&.n#3Dh3!p.RESULTIS.TRUE#0A......
.............p.:#3D.!p#0A................}#0A...RES
ULTIS.FALSE#0A}#0A#0AAND.inreg_b(k,.n).#3D.VALOF#0A
{.LET.p.#3D.info_b#0A...IF.k#3Dk_b.RESULTIS.TRUE#0A
...UNTIL.p#3D0.DO.{.IF.k#3Dh2!p.&.n#3Dh3!p.RESULTIS
.TRUE#0A...................p.:#3D.!p#0A............
....}#0A...RESULTIS.FALSE#0A}#0A#0AAND.addinfo_a(k,
.n).BE.info_a.:#3D.getblk(info_a,.k,.n)#0A#0AAND.ad
dinfo_b(k,.n).BE.info_b.:#3D.getblk(info_b,.k,.n)#0A
#0AAND.pushinfo(k,.n).BE#0A{.forget_b()#0A...info_b
.:#3D.info_a#0A...info_a.:#3D.getblk(0,.k,.n)#0A}#0A
#0AAND.xchinfo().BE#0A{.LET.t.#3D.info_a#0A...info_
a.:#3D.info_b#0A...info_b.:#3D.t#0A}#0A#0AAND.atbin
fo().BE#0A{.LET.p.#3D.info_a#0A...forget_b()#0A...U
NTIL.p#3D0.DO.{.addinfo_b(h2!p,.h3!p);.p.:#3D.!p.}#0A
}#0A#0AAND.forget_a().BE.{.freeblks(info_a);.info_a
.:#3D.0.}#0A#0AAND.forget_b().BE.{.freeblks(info_b)
;.info_b.:#3D.0.}#0A#0AAND.forgetall().BE.{.forget_
a();.forget_b().}#0A#0A//.Forgetvar.is.called.just.
after.a.simple.variable.(k,.n).has.been#0A//.update
d#2E..k.is.k_loc,.k_glob.or.k_lab#2E..Note.that.reg
ister#0A//.infomation.about.indirect.local.and.glob
al.values#0A//.must.also.be.thrown.away#2E#0AAND.fo
rgetvar(k,.n).BE#0A{.LET.p.#3D.info_a#0A...UNTIL.p#3D
0.DO.{.IF.h2!p>#3Dk_loc0.|.h2!p#3Dk.&.h3!p#3Dn.DO.h
2!p.:#3D.k_none#0A...................p.:#3D.!p#0A..
..............}#0A...p.:#3D.info_b#0A...UNTIL.p#3D0
.DO.{.IF.h2!p>#3Dk_loc0.|.h2!p#3Dk.&.h3!p#3Dn.DO.h2
!p.:#3D.k_none#0A...................p.:#3D.!p#0A...
.............}#0A}#0A#0AAND.forgetallvars().BE..//.
Called.after.STIND.or.PUTBYTE#2E#0A{.LET.p.#3D.info
_a#0A...UNTIL.p#3D0.DO.{.IF.h2!p>#3Dk_loc.DO.h2!p.:
#3D.k_none#0A...................p.:#3D.!p#0A.......
.........}#0A...p.:#3D.info_b#0A...UNTIL.p#3D0.DO.{
.IF.h2!p>#3Dk_loc.DO.h2!p.:#3D.k_none#0A...........
........p.:#3D.!p#0A................}#0A}#0A#0AAND.
iszero(a).#3D.h1!a#3Dk_numb.&.h2!a#3D0.->.TRUE,.FAL
SE#0A#0A//.Store.the.value.of.a.SS.item.in.its.true
.stack.location#2E#0AAND.storet(x).BE#0A{.LET.s.#3D
.h3!x#0A...IF.h1!x#3Dk_loc.&.h2!x#3Ds.RETURN#0A...l
oada(x)#0A...gensp(s)#0A...forgetvar(k_loc,.s)#0A..
.addinfo_a(k_loc,.s)#0A...h1!x,.h2!x.:#3D.k_loc,.s#0A
}#0A#0AAND.gensp(s).BE.TEST.3<#3Ds<#3D16#0A........
........THEN.gen(f_sp0+s)#0A................ELSE.TE
ST.0<#3Ds<#3D255#0A.....................THEN.genb(f
_sp,.s)#0A.....................ELSE.TEST.0<#3Ds<#3D
#23xFFFF#0A..........................THEN.genh(f_sp
h,.s)#0A..........................ELSE.genw(f_spw,.
s)#0A#0AAND.genlp(n).BE.TEST.3<#3Dn<#3D16#0A.......
.........THEN.gen(f_lp0+n)#0A................ELSE.T
EST.0<#3Dn<#3D255#0A.....................THEN.genb(
f_lp,.n)#0A.....................ELSE.TEST.0<#3Dn<#3D
#23xFFFF#0A..........................THEN.genh(f_lp
h,.n)#0A..........................ELSE.genw(f_lpw,.
n)#0A#0A//.Load.an.item.(K,N).onto.the.SS#2E.It.may
.move.SS.items#2E#0AAND.loadt(k,.n).BE#0A{.cgpendin
gop()#0A...TEST.arg1+3#3Dtempt#0A...THEN.{.storet(t
empv)..//.SS.stack.overflow#2E#0A...........FOR.t.#3D
.tempv.TO.arg2+2.DO.t!0.:#3D.t!3#0A........}#0A...E
LSE.arg2,.arg1.:#3D.arg2+3,.arg1+3#0A...h1!arg1,h2!
arg1,h3!arg1.:#3D.k,n,ssp#0A...ssp.:#3D.ssp.+.1#0A.
..IF.maxssp<ssp.DO.maxssp.:#3D.ssp#0A}#0A#0A#0A//.R
eplace.the.top.two.SS.items.by.(K,N).and.set.PENDIN
GOP#3DS_NONE#2E#0AAND.lose1(k,.n).BE#0A{.ssp.:#3D.s
sp.-.1#0A...TEST.arg2#3Dtempv#0A...THEN.{.h1!arg2,h
2!arg2.:#3D.k_loc,ssp-2#0A...........h3!arg2.:#3D.s
sp-2#0A........}#0A...ELSE.{.arg1.:#3D.arg2#0A.....
......arg2.:#3D.arg2-3#0A........}#0A...h1!arg1,.h2
!arg1,.h3!arg1.:#3D.k,n,ssp-1#0A...pendingop.:#3D.s
_none#0A}#0A#0AAND.swapargs().BE#0A{.LET.k,.n.#3D.h
1!arg1,.h2!arg1#0A...h1!arg1,.h2!arg1.:#3D.h1!arg2,
.h2!arg2#0A...h1!arg2,.h2!arg2.:#3D.k,.n#0A}#0A#0AA
ND.cgstind().BE#0A{.LET.t.#3D.VALOF#0A...{.IF.pendi
ngop#3Ds_plus.DO#0A......{.IF.k_numb#3Dh1!arg2.DO.s
wapargs()#0A.........IF.k_numb#3Dh1!arg1.DO#0A.....
....{.LET.n.#3D.h2!arg1#0A............IF.0<#3Dn<#3D
3.DO.{.stack(ssp-1)#0A.............................
pendingop.:#3D.s_none#0A...........................
..RESULTIS.n#0A..........................}#0A......
...}#0A#0A.........IF.h1!arg2#3Dk_loc.&.3<#3Dh2!arg
2<#3D5.DO.swapargs()#0A.........IF.h1!arg1#3Dk_loc.
&.3<#3Dh2!arg1<#3D5.DO#0A.........{.LET.n.#3D.h2!ar
g1#0A............stack(ssp-1)#0A............pending
op.:#3D.s_none#0A............RESULTIS.n+1..//.The.c
odes.for.P3,.P4.and.P5#2E#0A.........}#0A#0A.......
..UNLESS.arg2#3Dtempv.DO#0A.........{.LET.arg3.#3D.
arg2.-.3#0A............IF.h1!arg3#3Dk_a.DO#0A......
......{.IF.h1!arg2#3Dk_loc.|#0A..................h1
!arg2#3Dk_glob.|#0A..................h1!arg2#3Dk_nu
mb.DO.swapargs()#0A...............IF.h1!arg1#3Dk_lo
c.|#0A..................h1!arg1#3Dk_glob.|#0A......
............h1!arg1#3Dk_numb.DO#0A...............//
.Optimize.the.case..<arg2>!<arg1>.:#3D.<arg3>#0A...
............//.where.<arg3>.is.already.in.A#0A.....
..........//.and.<arg1>.is.a.local,.a.global.or.a.n
umber#2E#0A...............{.push(arg3,.arg2)#0A....
..............cgplus()..//.Compiles.an.A,.AP.or.AG.
instr#2E#0A..................gen(f_st)#0A..........
........stack(ssp-2)#0A..................forgetallv
ars()#0A..................RETURN#0A...............}
#0A............}#0A.........}#0A......}#0A#0A......
cgpendingop()#0A......RESULTIS.0#0A...}#0A#0A...//.
Now.compile.code.for.S!<arg1>.:#3D.<arg2>#0A...//.w
here...........S.is.0,.1,.2,.3,.P3,.P4.or.P5#0A.../
/.depending.on....T.#3D..0,.1,.2,.3,..4,..5.or..6#0A
#0A...{.LET.k,.n.#3D.h1!arg1,.h2!arg1#0A...#0A.....
.IF.k#3Dk_glob.&.t#3D0.DO.{.loada(arg2)#0A.........
.....................geng(f_s0g,.n)#0A.............
.................stack(ssp-2)#0A...................
...........forgetallvars()#0A......................
........RETURN#0A...........................}#0A#0A
......IF.k#3Dk_loc.&.3<#3Dn<#3D4.&.t<#3D1.DO.{.load
a(arg2)#0A........................................g
en(t#3D0.->.f_st0p0+n,#0A..........................
.........................f_st1p0+n)#0A.............
...........................stack(ssp-2)#0A.........
...............................forgetallvars()#0A..
......................................RETURN#0A....
.................................}#0A#0A......loadb
a(arg2,.arg1)#0A......gen(f_st+t)#0A......stack(ssp
-2)#0A......forgetallvars()#0A...}#0A}#0A#0A#0A//.S
tore.the.top.item.of.the.SS.in.(K,N)#2E#0AAND.store
in(k,.n).BE#0A//.K.is.K_LOC,.K_GLOB.or.K_LAB#2E#0A{
.cgpendingop()#0A...loada(arg1)#0A#0A...SWITCHON.k.
INTO#0A...{.DEFAULT:.....cgerror("in.storein.%n",.k
)#0A......CASE.k_loc:..gensp(n);.......ENDCASE#0A..
....CASE.k_glob:.geng(f_sg,.n);..ENDCASE#0A......CA
SE.k_lab:..genr(f_sl,.n);..ENDCASE#0A...}#0A...forg
etvar(k,.n)#0A...addinfo_a(k,.n)#0A...stack(ssp-1)#0A
}#0A#0ALET.cgrv().BE#0A{.LET.t.#3D.VALOF#0A...{.IF.
pendingop#3Ds_plus.DO#0A......{.IF.k_numb#3Dh1!arg2
.DO.swapargs()#0A.........IF.k_numb#3Dh1!arg1.DO#0A
.........{.LET.n.#3D.h2!arg1#0A............IF.0<#3D
n<#3D6.DO.{.stack(ssp-1)#0A........................
.....pendingop.:#3D.s_none#0A......................
.......RESULTIS.n#0A..........................}#0A.
........}#0A#0A.........IF.h1!arg2#3Dk_loc.&.3<#3Dh
2!arg2<#3D7.DO.swapargs()#0A.........IF.h1!arg1#3Dk
_loc.&.3<#3Dh2!arg1<#3D7.DO.{.LET.n.#3D.h2!arg1#0A.
...............................................stac
k(ssp-1)#0A........................................
........pendingop.:#3D.s_none#0A...................
.............................RESULTIS.10.+.n#0A....
.........................................}#0A......
}#0A......cgpendingop()#0A......RESULTIS.0#0A...}#0A
#0A...//.Now.compile.code.for.S!<arg1>#0A...//.wher
e..........S.is.0,#2E#2E#2E,.6,.P3,#2E#2E#2E,.P7#0A
...//.depending.on...T.#3D..0,#2E#2E#2E,.6,.13,#2E#2E
#2E,.17#0A#0A...LET.k,.n.#3D.h1!arg1,.h2!arg1#0A...
#0A...IF.k#3Dk_glob.&.0<#3Dt<#3D2.DO.{.h1!arg1.:#3D
.k_glob0.+.t;.RETURN.}#0A#0A...IF.k#3Dk_loc.&.n>#3D
3.DO#0A......IF.t#3D0.&.n<#3D12.|#0A.........t#3D1.
&.n<#3D6..|#0A.........t#3D2.&.n<#3D5..|#0A........
.t#3D3.&.n<#3D4..|#0A.........t#3D4.&.n<#3D4..DO.{.
h1!arg1.:#3D.k_loc0.+.t;.RETURN.}#0A#0A...loada(arg
1)#0A...TEST.t<#3D6.THEN.gen(f_rv+t)#0A............
.ELSE.gen(f_rvp0.+.t.-.10)#0A...forget_a()#0A...h1!
arg1,.h2!arg1.:#3D.k_a,.0#0A}#0A#0AAND.cgplus().BE#0A
//.Compiles.code.to.compute.<arg2>.+.<arg1>#2E#0A//
.It.does.not.look.at.PENDINGOP#2E#0A#0A{.IF.iszero(
arg1).DO.{.stack(ssp-1);.RETURN.}#0A#0A...IF.iszero
(arg2).DO#0A...{.IF.h2!arg1#3Dssp-1.&#0A.........(h
1!arg1#3Dk_loc.|.k_loc0<#3Dh1!arg1<#3Dk_loc4).DO.lo
ada(arg1)#0A......lose1(h1!arg1,.h2!arg1)#0A......R
ETURN#0A...}#0A#0A...TEST.inreg_a(h1!arg1,.h2!arg1)
#0A...THEN.loada(arg1)#0A...ELSE.IF.inreg_a(h1!arg2
,.h2!arg2).DO.loada(arg2)#0A#0A...IF.h1!arg1#3Dk_a.
DO.swapargs()#0A#0A...IF.h1!arg2#3Dk_loc.&.3<#3Dh2!
arg2<#3D12.DO.swapargs()#0A...IF.h1!arg1#3Dk_loc.&.
3<#3Dh2!arg1<#3D12.DO.{.loada(arg2)#0A.............
..............................gen(f_ap0.+.h2!arg1)#0A
...........................................forget_a
()#0A...........................................los
e1(k_a,.0)#0A......................................
.....RETURN#0A.....................................
...}#0A#0A...IF.h1!arg2#3Dk_numb.&.-4<#3Dh2!arg2<#3D
5.DO.swapargs()#0A...IF.h1!arg1#3Dk_numb.&.-4<#3Dh2
!arg1<#3D5.DO.{.loada(arg2)#0A.....................
.......................cgaddk(h2!arg1)#0A..........
..................................lose1(k_a,.0)#0A.
...........................................RETURN#0A
.........................................}#0A#0A...
IF.h1!arg2#3Dk_loc.DO.swapargs()#0A...IF.h1!arg1#3D
k_loc.DO#0A...{.LET.n.#3D.h2!arg1#0A......loada(arg
2)#0A......TEST.3<#3Dn<#3D12.THEN.gen(f_ap0.+.n)#0A
....................ELSE.TEST.0<#3Dn<#3D255#0A.....
....................THEN.genb(f_ap,.n)#0A..........
...............ELSE.TEST.0<#3Dn<#3D#23xFFFF#0A.....
.........................THEN.genh(f_aph,.n)#0A....
..........................ELSE.genw(f_apw,.n)#0A...
...forget_a()#0A......lose1(k_a,.0)#0A......RETURN#0A
...}#0A#0A...IF.h1!arg2#3Dk_glob.DO.swapargs()#0A..
.IF.h1!arg1#3Dk_glob.DO.{.loada(arg2)#0A...........
................geng(f_ag,.h2!arg1)#0A.............
..............forget_a()#0A........................
...lose1(k_a,.0)#0A...........................RETUR
N#0A........................}#0A#0A...IF.h1!arg2#3D
k_numb.DO.swapargs()#0A...IF.h1!arg1#3Dk_numb.DO.{.
LET.n.#3D.h2!arg1#0A...........................load
a(arg2)#0A...........................cgaddk(n)#0A..
.........................lose1(k_a,.0)#0A..........
.................RETURN#0A........................}
#0A...loadboth(arg2,.arg1)#0A...gen(f_add)#0A...for
get_a()#0A...lose1(k_a,.0)#0A}#0A#0AAND.cgaddk(k).B
E.UNLESS.k#3D0.DO..//.Compile.code.to.add.k.to.A#2E
#0A{.TEST.-4<#3Dk<#3D5#0A...THEN.TEST.k<0.THEN.gen(
f_s0.-.k)#0A.................ELSE.gen(f_a0.+.k)#0A.
..ELSE.TEST.-255<#3Dk<#3D255#0A........THEN.TEST.k>
0.THEN.genb(f_a,.k)#0A......................ELSE.ge
nb(f_s,.-k)#0A........ELSE.TEST.0<#3Dk<#3D#23xFFFF#0A
.............THEN.genh(f_ah,.k)#0A.............ELSE
.TEST.-#23xFFFF<#3Dk<#3D0#0A..................THEN.
genh(f_sh,.-k)#0A..................ELSE.genw(f_aw,.
k)#0A...forget_a()#0A}#0A#0AAND.cgglobal(n).BE#0A{.
incode.:#3D.FALSE#0A...cgstatics()#0A...chkrefs(512
)...//.Deal.with.ALL.outstanding.refs#2E#0A...align
(4)#0A...codew(0).......//.Compile.Global.initialis
ation.data#2E#0A...FOR.i.#3D.1.TO.n.DO.{.codew(rdgn
());.codew(labv!rdl()).}#0A...codew(maxgn)#0A}#0A#0A
#0AAND.cgentry(l,.n).BE#0A{.MANIFEST.{.upb#3D11.}./
/.Max.length.of.entry.name#0A...LET.v.#3D.VEC.upb/b
ytesperword#0A...v%0.:#3D.upb#0A...//.Pack.up.to.11
.character.of.the.name.into.v.including#0A...//.the
.first.and.last.five#2E#0A...TEST.n<#3D11#0A...THEN
.{.FOR.i.#3D.1.TO.n.DO.v%i.:#3D.rdn()#0A..........F
OR.i.#3D.n+1.TO.11.DO.v%i.:#3D.'*s'#0A........}#0A.
..ELSE.{.FOR.i.#3D.1.TO.5...DO.v%i.:#3D.rdn()#0A...
.......FOR.i.#3D.6.TO.n-6.DO.rdn().//.Ignore.the.mi
ddle.characters#0A..........FOR.i.#3D.6.TO.11..DO.v
%i.:#3D.rdn()#0A..........IF.n>11.DO.v%6.:#3D.'*''#0A
........}#0A#0A...chkrefs(80)..//.Deal.with.some.fo
rward.refs#2E#0A...align(4)#0A...IF.naming.DO.{.cod
ew(entryword)#0A..................codew(pack4b(v%0,
.v%1,.v%.2,.v%.3))#0A..................codew(pack4b
(v%4,.v%5,.v%.6,.v%.7))#0A..................codew(p
ack4b(v%8,.v%9,.v%10,.v%11))#0A................}#0A
...IF.debug>0.DO.writef("//.Entry.to:...%s*n",.v)#0A
...setlab(l)#0A...incode.:#3D.TRUE#0A...forgetall()
#0A}#0A#0A//.Function.or.routine.call#2E#0AAND.cgap
ply(op,.k).BE#0A{.LET.sa.#3D.k+3..//.Stack.address.
of.first.arg.(if.any)#2E#0A..AND.a1.#3D.0....//.SS.
item.for.first.arg.if.found#2E#0A#0A..cgpendingop()
#0A#0A//.Deal.with.non.args#2E#0A...FOR.t.#3D.tempv
.TO.arg2.BY.3.DO.{.IF.h3!t>#3Dk.BREAK#0A...........
.........................IF.h1!t#3Dk_a.DO.storet(t)
#0A.................................}#0A#0A//.Deal.
with.args.2,.3.#2E#2E#2E#0A...FOR.t.#3D.tempv.TO.ar
g2.BY.3.DO#0A...{.LET.s.#3D.h3!t#0A......IF.s#3Dsa.
DO#0A......{.a1.:#3D.t..//.We.have.found.the.SS.ite
m.for.the.first.arg#2E#0A.........IF.h1!t#3Dk_a.&.t
+3#3Darg2.DO#0A.........//.Two.argument.call.with.t
he.first.arg.already.in.A#2E#0A.........{.push(t,.a
rg2)#0A............storet(arg2)....//.Store.second.
arg#2E#0A............genxch(0,.t)....//.Restore.fir
st.arg.back.to.A#2E#0A............BREAK#0A.........
}#0A......}#0A......IF.s>sa.DO.storet(t)#0A...}#0A#0A
...//.Move.first.arg.(if.any).into.A#2E#0A...IF.sa<
ssp-1.TEST.a1#3D0#0A...............THEN.genlp(sa)..
//.First.arg.exists.but.not.in.SS#2E#0A............
...ELSE.loada(a1)..//.First.arg.exists.in.SS#0A#0A.
..//.First.arg.(if.any).is.now.in.A#2E#0A#0A...TEST
.h1!arg1#3Dk_glob.&.3<#3Dk<#3D11#0A...THEN.geng(f_k
0g+k,.h2!arg1)#0A...ELSE.{.push(a1,.arg1)#0A.......
....//.First.arg.(if.any).is.now.in.B#0A...........
//.and.the.procedure.address.is.in.A#2E#0A.........
..TEST.3<#3Dk<#3D11#0A...........THEN.gen(f_k0+k)#0A
...........ELSE.TEST.0<#3Dk<#3D255#0A..............
..THEN.genb(f_k,.k)#0A................ELSE.TEST.0<#3D
k<#3D#23xFFFF#0A.....................THEN.genh(f_kh
,.k)#0A.....................ELSE.genw(f_kw,.k)#0A..
......}#0A#0A...forgetall()#0A...stack(k)#0A...IF.o
p#3Ds_fnap.DO.loadt(k_a,.0)#0A}#0A#0A//.Used.for.OC
ODE.operators.JT.and.JF#2E#0AAND.cgjump(b,l).BE#0A{
.LET.f.#3D.jmpfn(pendingop)#0A...IF.f#3D0.DO.{.load
t(k_numb,0);.f.:#3D.f_jne.}#0A...pendingop.:#3D.s_n
one#0A...UNLESS.b.DO.f.:#3D.compjfn(f)#0A...store(0
,ssp-3)#0A...genr(prepj(f),l)#0A...stack(ssp-2)#0A}
#0A#0AAND.jmpfn(op).#3D.VALOF.SWITCHON.op.INTO#0A{.
DEFAULT:..RESULTIS.0#0A...CASE.s_eq:.RESULTIS.f_jeq
#0A...CASE.s_ne:.RESULTIS.f_jne#0A...CASE.s_ls:.RES
ULTIS.f_jls#0A...CASE.s_gr:.RESULTIS.f_jgr#0A...CAS
E.s_le:.RESULTIS.f_jle#0A...CASE.s_ge:.RESULTIS.f_j
ge#0A}#0A#0AAND.jfn0(f).#3D.f+2.//.Change.F_JEQ.int
o.F_JEQ0..etc#2E#2E#2E#0A#0AAND.revjfn(f).#3D.f#3Df
_jls.->.f_jgr,#0A................f#3Df_jgr.->.f_jls
,#0A................f#3Df_jle.->.f_jge,#0A.........
.......f#3Df_jge.->.f_jle,#0A................f#0A#0A
AND.compjfn(f).#3D.f#3Df_jeq.->.f_jne,#0A..........
.......f#3Df_jne.->.f_jeq,#0A.................f#3Df
_jls.->.f_jge,#0A.................f#3Df_jge.->.f_jl
s,#0A.................f#3Df_jgr.->.f_jle,#0A.......
..........f#3Df_jle.->.f_jgr,#0A.................f#0A
#0AAND.prepj(f).#3D.VALOF..//.Returns.the.appropria
te.m/c.fn#2E#0A{.IF.iszero(arg2).DO.{.swapargs();.f
.:#3D.revjfn(f).}#0A...IF.iszero(arg1).DO.{.loada(a
rg2);.RESULTIS.jfn0(f).}#0A...IF.loadboth(arg2,.arg
1)#3Dswapped.RESULTIS.revjfn(f)#0A...RESULTIS.f#0A}
#0A#0A//.Compiles.code.for.SWITCHON#2E#0ALET.cgswit
ch().BE#0A{.LET.n.#3D.rdn().....//.Number.of.cases#2E
#0A...LET.dlab.#3D.rdl()..//.Default.label#2E#0A#0A
...//.Read.and.sort.(K,L).pairs#2E#0A...FOR.i.#3D.1
.TO.n.DO#0A...{.LET.k.#3D.rdn()#0A......LET.l.#3D.r
dl()#0A......LET.j.#3D.i-1#0A......UNTIL.j#3D0.DO..
{.IF.k.>.casek!j.BREAK#0A.......................cas
ek!(j+1),.casel!(j+1).:#3D.casek!j,.casel!j#0A.....
..................j.:#3D.j.-.1#0A..................
..}#0A......casek!(j+1),.casel!(j+1).:#3D.k,.l#0A..
.}#0A#0A...cgpendingop()#0A...store(0,.ssp-2)#0A...
loada(arg1)#0A...stack(ssp-1)#0A...switcht(1,.n,.dl
ab)#0A}#0A#0A//.Code.has.already.been.compiled.to.s
et.A.to.the.#0A//.value.of.the.switch.expression#2E
#0AAND.switcht(p,.q,.dlab).BE#0A{.UNLESS.p<#3Dq.DO.
{.genr(f_j,.dlab);.RETURN.}#0A#0A..IF.0.<#3D.casek!
q.-.casek!p.<#3D.#23xFFFF.DO...//.Care.with.overflo
w!#0A..{.switchseg(p,.q,.dlab)#0A....RETURN#0A..}#0A
...#0A..{.LET.r.#3D.(p+q)/2..//.p<q..and.so..r~#3Dq
#0A....LET.s.#3D.r#0A#0A....WHILE.p<r.&.0.<#3D.case
k!s-casek!(r-1).<#3D.#23xFFFF.DO.r.:#3D.r-1#0A....W
HILE.s<q.&.0.<#3D.casek!r-casek!(s+1).<#3D.#23xFFFF
.DO.s.:#3D.s+1#0A#09#0A....//.Note.that:.if.r#3Dp.t
hen.s~#3Dq#0A....IF.r-p.<#3D.q-s.DO.r.:#3D.s+1#0A..
..//.r.is.now.set.to.the.pivot.position#2E.Note:.r~
#3Dp#0A#0A....cgaddk(-casek!r)#0A#09#0A....//.Now.s
ubtract.casek!r.from.all.case.constants#0A....//.an
d.re-sort.if.necessary#2E#0A....r.:#3D.offsetcases(
p,.q,.r)#0A....//.r.is.chosen.so.that.casek!r#3D0#0A
#0A....TEST.r#3Dp#0A....THEN.genr(f_jls0,.dlab)#0A.
...ELSE.{.LET.lab.#3D.newlab()#0A...........genr(f_
jge0,.lab)#0A...........switcht(p,.r-1,.dlab)..//.A
ll.cases.<.0#0A...........setlab(lab)#0A.........}#0A
....switcht(r,.q,.dlab)............//.All.cases.>#3D
.0#0A..}#0A}#0A#0AAND.offsetcases(p,.q,.r).#3D.VALO
F#0A{.LET.offset.#3D.casek!r#0A..IF.offset#3D0.RESU
LTIS.r..//.Nothing.to.do#2E#0A...#0A..FOR.i.#3D.p.T
O.q..DO.casek!i.:#3D.casek!i.-.offset#0A..IF.casek!
p.<.casek!q.RESULTIS.r..//.No.overflow.occurred#2E#0A
...#0A..//.Re-sort.the.cases.because.wrap.round.occ
urred#2E#0A..FOR.i.#3D.p+1.TO.q.DO#0A..{.LET.j.#3D.
i#0A....LET.k,.l.#3D.casek!i,.casel!i#0A....UNTIL.j
>p.&.casek!(j-1).>.k.DO#0A....{.casek!j,.casel!j.:#3D
.casek!(j-1),.casel!(j-1)#0A......j.:#3D.j-1#0A....
}#0A....casek!j,.casel!j.:#3D.k,.l#0A..}#0A...#0A..
//.Find.the.new.pivot.point#2E#0A..FOR.i.#3D.p.TO.q
.IF.casek!i#3D0.RESULTIS.i#0A..cgerror("in.offsetca
ses")#0A..RESULTIS.p#0A}#0A#0AAND.switchseg(p,.q,.d
lab).BE#0A{.//.Only.called.when..0.<#3D.casek!q.-.c
asek!p.<#3D.#23xFFFF#0A..//..............and..p.<#3D
.q#0A..LET.n.#3D.q-p+1..//.The.number.of.cases.(>#3D
1)#2E#0A#0A..IF.n#3D1.DO.{.cgaddk(-casek!p)#0A.....
.........genr(f_jeq0,.casel!p)#0A..............genr
(f_j,.dlab)#0A..............RETURN#0A............}#0A
#0A..TEST.2*n.<.casek!q.-.casek!p..//.Which.is.smal
ler?#0A..THEN.switchb(p,.q,.dlab)......//.Binary.ch
op.switch#2E#0A..ELSE.switchl(p,.q,.dlab)......//.L
abel.vector.switch#2E#0A}#0A#0AAND.switchb(p,.q,.dl
ab).BE..//.Binary.chop.switch#2E#0A{.//.Only.called
.when..0.<#3D.casek!q.-.casek!p.<#3D.#23xFFFF#0A../
/..............and..p.<.q#0A..LET.n.#3D.q-p+1...//.
Number.of.cases.(>1)#2E#0A..LET.n1.#3D.n>7.->n,.7#0A
...#0A..//.Ensure.that.all.case.constants.can.be.re
presented.by#0A..//.unsigned.16.bit.integers#2E#0A.
.IF.casek!p<0.|.casek!q>#23xFFFF.DO#0A..{.cgaddk(-c
asek!p)#0A.....offsetcases(p,.q,.p)#0A..}#0A...#0A.
.chkrefs(6+4*n1).//.allow.for.padding.to.7.cases#0A
..gen(f_swb)#0A..align(2)#0A..codeh(n)#0A..coder(dl
ab)#0A..FOR.i.#3D.p.TO.q.DO.{.LET.pos.#3D.q.+.1.-.f
indpos(i-p+1,.q-p+1)#0A......................codeh(
casek!pos)#0A......................coder(casel!pos)
#0A....................}#0A..FOR.i.#3D.q+1.TO.p+6.D
O.{.codeh(0).//.pad.out.to.7.cases#0A..............
............coder(dlab)#0A........................}
#0A}#0A#0A//.If.the.integers.1#2E#2En.were.stored.i
n.a.balanced.binary#0A//.tree.using.the.tree.struct
ure.of.heap.sort,.then#0A//.integer.i.would.be.at.p
osition.findpos(i,.n)#2E#0AAND.findpos(i,.n).#3D.VA
LOF#0A{.LET.r.#3D.?#0A..IF.i.#3D.1.DO.{.swlpos,.swr
pos.:#3D.0,.n#0A................RESULTIS.rootpos(0,
.n)#0A..............}#0A..r.:#3D.findpos(i/2,.n)#0A
..TEST.(i&1).#3D.0.THEN.swrpos.:#3D.r-1#0A.........
........ELSE.swlpos.:#3D.r#0A..RESULTIS.rootpos(swl
pos,.swrpos)#0A}#0A#0AAND.rootpos(p,.q).#3D.VALOF#0A
{.LET.n.#3D.q-p#0A..LET.s,.r.#3D.2,.?#0A..UNTIL.s>n
.DO.s.:#3D.s+s#0A..s.:#3D.s/2#0A..r.:#3D.n-s+1#0A..
IF.s.<#3D.r+r.RESULTIS.p.+.s#0A..RESULTIS.p.+.s/2.+
.r#0A}#0A#0AAND.switchl(p,.q,.dlab).BE..//.Label.ve
ctor.switch#2E#0A{.//.Only.called.when..0.<#3D.case
k!q.-.casek!p.<#3D.#23xFFFF#0A..//..............and
..p.<.q#0A#0A..LET.n,.t.#3D.?,.p#0A#0A..//.Adjust.c
ase.constants.to.suit.SWL.instruction#2E#0A..IF.cas
ek!p<0.|.casek!p>1.|.casek!q>#23xFFFF.DO#0A..{.cgad
dk(-casek!p)#0A....offsetcases(p,.q,.p)#0A..}#0A...
#0A..n.:#3D.casek!q.+.1...//.Number.of.entries.in.t
he.label.vector#2E#0A..chkrefs(2*n+6)#0A..gen(f_swl
)#0A..align(2)#0A..codeh(n)#0A..coder(dlab)........
//.Default.label#2E#0A#0A..FOR.k#3D.0.TO.casek!q.TE
ST.casek!t#3Dk#0A......................THEN.{.coder
(casel!t)#0A.............................t.:#3D.t+1
#0A...........................}#0A.................
.....ELSE.coder(dlab)#0A}#0A#0AAND.cgstring(n).BE#0A
{.LET.l,.a.#3D.newlab(),.n#0A..loadt(k_lvlab,l)#0A.
.{.LET.b,.c,.d.#3D.0,.0,.0#0A....IF.n>0.DO.b.:#3D.r
dn()#0A....IF.n>1.DO.c.:#3D.rdn()#0A....IF.n>2.DO.d
.:#3D.rdn()#0A....!nliste.:#3D.getblk(0,l,pack4b(a,
.b,.c,.d))#0A....nliste.:#3D.!nliste#0A....l.:#3D.0
#0A....IF.n<#3D3.BREAK#0A....n,.a.:#3D.n-4,.rdn()#0A
..}.REPEAT#0A}#0A#0AAND.setlab(l).BE#0A{.LET.p.#3D.
@rlist#0A#0A...IF.debug>0.DO.writef("%i4:.L%n:*n",.
stvp,.l)#0A#0A...labv!l.:#3D.stvp..//.Set.the.label
#2E#0A#0A...//.Fill.in.all.refs.that.are.in.range#2E
#0A...{.LET.r.#3D.!p#0A......IF.r#3D0.BREAK#0A.....
.TEST.h3!r#3Dl.&.inrange_d(h2!r,.stvp)#0A......THEN
.{.fillref_d(h2!r,.stvp)#0A..............!p.:#3D.!r
...//.Remove.item.from.RLIST#2E#0A..............fre
eblk(r)#0A...........}#0A......ELSE.p.:#3D.r..//.Ke
ep.the.item#2E#0A...}.REPEAT#0A...rliste.:#3D.p....
.//.Ensure.that.RLISTE.is.sensible#2E#0A#0A...p.:#3D
.@reflist#0A#0A...{.LET.r.#3D.!p#0A......IF.r#3D0.B
REAK#0A......TEST.h3!r#3Dl#0A......THEN.{.LET.a.#3D
.h2!r#0A..............puth(a,stvp-a).//.Plant.rel.a
ddress#2E#0A..............!p.:#3D.!r.......//.Remov
e.item.from.REFLIST#2E#0A..............freeblk(r)#0A
...........}#0A......ELSE.p.:#3D.r..//.Keep.item#2E
#0A...}.REPEAT#0A#0A...refliste.:#3D.p...//.Ensure.
REFLISTE.is.sensible#2E#0A}#0A#0A#0A#0AAND.cgstatic
s().BE.UNTIL.nlist#3D0.DO#0A{.LET.len,.nl.#3D.0,.nl
ist#0A#0A...nliste.:#3D.@nlist..//.All.NLIST.items.
will.be.freed#2E#0A#0A...len,.nl.:#3D.len+4,.!nl.RE
PEATUNTIL.nl#3D0.|.h2!nl.~#3D.0#0A#0A...chkrefs(len
+3)..//.+3.because.align(4).may.generate.3.bytes#2E
#0A...align(4)#0A#0A...setlab(h2!nlist)..//.NLIST.a
lways.starts.labelled#2E#0A#0A...{.LET.blk.#3D.nlis
t#0A......nlist.:#3D.!nlist#0A......freeblk(blk)#0A
......codew(h3!blk)#0A...}.REPEATUNTIL.nlist#3D0.|.
h2!nlist.~#3D.0#0A}#0A#0A#0A#0AAND.getblk(a,.b,.c).
#3D.VALOF#0A{.LET.p.#3D.freelist#0A...TEST.p#3D0.TH
EN.{.dp.:#3D.dp-3;.checkspace();.p.:#3D.dp.}#0A....
........ELSE.freelist.:#3D.!p#0A...h1!p,.h2!p,.h3!p
.:#3D.a,.b,.c#0A...RESULTIS.p#0A}#0A#0A#0AAND.freeb
lk(p).BE.{.!p.:#3D.freelist;.freelist.:#3D.p.}#0A#0A
AND.freeblks(p).BE.UNLESS.p#3D0.DO#0A{.LET.oldfreel
ist.#3D.freelist#0A...freelist.:#3D.p#0A...UNTIL.!p
#3D0.DO.p.:#3D.!p#0A...!p.:#3D.oldfreelist#0A}#0A#0A
#0AAND.initdatalists().BE#0A{.reflist,.refliste.:#3D
.0,.@reflist#0A...rlist,...rliste...:#3D.0,.@rlist#0A
...nlist,...nliste...:#3D.0,.@nlist#0A...freelist.:
#3D.0#0A}#0A#0ALET.geng(f,.n).BE.TEST.n<256#0A.....
.............THEN.genb(f,.n)#0A..................EL
SE.TEST.n<512#0A.......................THEN.genb(f+
32,.n-256)#0A.......................ELSE.genh(f+64,
.n)#0A#0ALET.gen(f).BE.IF.incode.DO#0A{.chkrefs(1)#0A
...IF.debug.DO.wrcode(f,."")#0A...codeb(f)#0A}#0A#0A
LET.genb(f,.a).BE.IF.incode.DO#0A{.chkrefs(2)#0A...
IF.debug>0.DO.wrcode(f,."%i3",.a)#0A...codeb(f)#0A.
..codeb(a)#0A}#0A#0ALET.genr(f,.n).BE.IF.incode.DO#0A
{.chkrefs(2)#0A...IF.debug>0.DO.wrcode(f,."L%n",.n)
#0A...codeb(f)#0A...codeb(0)#0A...relref(stvp-2,.n)
#0A}#0A#0ALET.genh(f,.h).BE.IF.incode.DO..//.Assume
.0.<#3D.h.<#3D.#23xFFFF#0A{.chkrefs(3)#0A...IF.debu
g>0.DO.wrcode(f,."%n",.h)#0A...codeb(f)#0A...code2b
(h)#0A}#0A#0ALET.genw(f,.w).BE.IF.incode.DO#0A{.chk
refs(5)#0A...IF.debug>0.DO.wrcode(f,."%n",.w)#0A...
codeb(f)#0A...code4b(w)#0A}#0A#0AAND.checkspace().B
E.IF.stvp/4>dp-stv.DO#0A{.cgerror("Program.too.larg
e,.%n.bytes.compiled",.stvp)#0A...errcount.:#3D.err
count+1#0A...longjump(fin_p,.fin_l)#0A}#0A#0A#0AAND
.codeb(byte).BE#0A{.stv%stvp.:#3D.byte#0A...stvp.:#3D
.stvp.+.1#0A...checkspace()#0A}#0A#0AAND.code2b(h).
BE.TEST.bigender#0ATHEN.{.codeb(h>>8.);.codeb(h....
)..}#0AELSE.{.codeb(h....);.codeb(h>>8.)..}#0A#0AAN
D.code4b(w).BE.TEST.bigender#0ATHEN.{.codeb(w>>24);
.codeb(w>>16);.codeb(w>>8.);.codeb(w....)..}#0AELSE
.{.codeb(w....);.codeb(w>>8.);.codeb(w>>16);.codeb(
w>>24)..}#0A#0AAND.pack4b(b0,.b1,.b2,.b3).#3D#0A..b
igender.->.b0<<24.|.b1<<16.|.b2<<8.|.b3,#0A........
......b3<<24.|.b2<<16.|.b1<<8.|.b0#0A#0AAND.codeh(h
).BE#0A{.IF.debug>0.DO.writef("%i4:..DATAH.%n*n",.s
tvp,.h)#0A...code2b(h)#0A}#0A#0AAND.codew(w).BE#0A{
.IF.debug>0.DO.writef("%i4:..DATAW.0x%x8*n",.stvp,.
w)#0A...code4b(w)#0A}#0A#0AAND.coder(n).BE#0A{.LET.
labval.#3D.labv!n#0A...IF.debug>0.DO.writef("%i4:..
DATAH.L%n-$*n",.stvp,.n)#0A...code2b(0)#0A...TEST.l
abval#3D-1.THEN.{.!refliste.:#3D.getblk(0,.stvp-2,.
n)#0A..........................refliste.:#3D.!refli
ste#0A.......................}#0A..................
ELSE.puth(stvp-2,.labval-stvp+2)#0A}#0A#0AAND.getw(
a).#3D.#0A...bigender.->.stv%a<<24.|.stv%(a+1)<<16.
|.stv%(a+2)<<8..|.stv%(a+3),#0A...............stv%a
.....|.stv%(a+1)<<8..|.stv%(a+2)<<16.|.stv%(a+3)<<2
4#0A#0AAND.puth(a,.w).BE#0A...TEST.bigender#0A...TH
EN.stv%a,.....stv%(a+1).:#3D.w>>8,.w#0A...ELSE.stv%
(a+1),.stv%a.....:#3D.w>>8,.w#0A#0AAND.putw(a,.w).B
E#0A...TEST.bigender#0A...THEN.stv%a,.stv%(a+1),.st
v%(a+2),.stv%(a+3).:#3D.w>>24,w>>16,.w>>8,.w#0A...E
LSE.stv%(a+3),.stv%(a+2),.stv%(a+1),.stv%a.:#3D.w>>
24,w>>16,.w>>8,.w#0A#0AAND.align(n).BE.UNTIL.stvp.R
EM.n.#3D.0.DO.codeb(0)#0A#0AAND.chkrefs(n).BE..//.R
esolve.references.until.it.is.possible#0A..........
.........//.to.compile.n.bytes.without.a.reference#0A
...................//.going.out.of.range#2E#0A{.LET
.p.#3D.@rlist#0A#0A...skiplab.:#3D.0#0A#0A...UNTIL.
!p#3D0.DO#0A...{.LET.r.#3D.!p#0A......LET.a.#3D.h2!
r.//.RLIST.is.ordered.in.increasing.A#2E#0A#0A.....
.IF.(stv%a.&.1).#3D.0.DO#0A......//.An.unresolved.r
eference.at.address.A#0A......{.IF.inrange_i(a,.stv
p+n+3).BREAK#0A.........//.This.point.is.reached.if
.there.is#0A.........//.an.unresolved.ref.at.A.whic
h.cannot#0A.........//.directly.relative.address.ST
VP+N+3#0A.........//.and.so.an.indirect.data.word.m
ust#0A.........//.be.compiled#2E#0A.........//.The.
+3.is.to.allow.for.a.possible#0A.........//.skip.ju
mp.instruction.and.possibly#0A.........//.one.fille
r.byte#2E#0A.........genindword(h3!r)#0A......}#0A#0A
......//.At.this.point.the.reference.at.A#0A....../
/.is.in.range.of.a.resolving.indirect#0A......//.da
ta.word.and.should.be.removed.from#0A......//.RLIST
.if.there.is.no.chance.that.it#0A......//.can.be.re
solved.by.a.direct.relative#0A......//.address#2E#0A
......TEST.inrange_d(a,.stvp)#0A......THEN.p.:#3D.r
........//.Keep.the.item#2E#0A......ELSE.{.!p.:#3D.
!r...//.Free.item.if.already.resolved#0A...........
...freeblk(r).//.and.no.longer.in.direct.range#2E#0A
..............IF.!p#3D0.DO.rliste.:#3D.p..//.Correc
t.RLISTE#2E#0A...........}#0A...}#0A#0A...//.At.thi
s.point.all.necessary.indirect.data.words.have#0A..
.//.been.compiled#2E#0A#0A...UNLESS.skiplab#3D0.DO.
{.setlab(skiplab)#0A..........................skipl
ab,.incode.:#3D.0,.TRUE#0A.......................}#0A
}#0A#0AAND.genindword(l).BE..//.Called.only.from.CH
KREFS#2E#0A{.LET.r.#3D.rlist......//.Assume.RLIST.~
#3D.0#0A#0A...IF.incode.DO#0A...{.skiplab.:#3D.newl
ab()#0A......//.genr(f_j,.skiplab).without.the.call
.of.chkrefs(2)#2E#0A......IF.debug>0.DO.wrcode(f_j,
."L%n",.skiplab)#0A......codeb(f_j)#0A......codeb(0
)#0A......relref(stvp-2,.skiplab)#0A......incode.:#3D
.FALSE#0A...}#0A#0A...align(2)#0A#0A...UNTIL.r#3D0.
DO#0A...{.IF.h3!r#3Dl.&.(stv%(h2!r).&.1)#3D0.DO.fil
lref_i(h2!r,.stvp)#0A......r.:#3D.!r#0A...}#0A#0A..
.coder(l)#0A}#0A#0AAND.inrange_d(a,.p).#3D.a-127.<#3D
.p.<#3D.a+128#0A//.The.result.is.TRUE.if.direct.rel
ative.instr.(eg.J).at#0A//.A.can.address.location.P
.directly#2E#0A#0AAND.inrange_i(a,.p).#3D.VALOF#0A/
/.The.result.is.TRUE.if.indirect.relative.instr.(eg
.J}#0A//.at.A.can.address.a.resolving.word.at.P#2E#0A
{.LET.rel.#3D.(p-a)/2#0A...RESULTIS.0.<#3D.rel.<#3D
.255#0A}#0A#0AAND.fillref_d(a,.p).BE#0A{.stv%a.:#3D
.stv%a.&.254..//.Back.to.direct.form.if.neccessary#2E
#0A...stv%(a+1).:#3D.p-a-1#0A}#0A#0AAND.fillref_i(a
,.p).BE..//.P.is.even#2E#0A{.stv%a.:#3D.stv%a.|.1..
.//.Force.indirect.form#2E#0A...stv%(a+1).:#3D.(p-a
)/2#0A}#0A#0AAND.relref(a,.l).BE#0A//.RELREF.is.onl
y.called.just.after.compiling#0A//.a.relative.refer
ence.instruction.at#0A//.address.A.(#3Dstvp-2)#2E#0A
{.LET.labval.#3D.labv!l#0A#0A...IF.labval>#3D0.&.in
range_d(a,.labval).DO.{.fillref_d(a,.labval)#0A....
.........................................RETURN#0A.
.........................................}#0A#0A...
//.All.other.references.in.RLIST.have#0A...//.addre
sses.smaller.than.A.and.so.RLIST.will#0A...//.remai
n.properly.ordered.if.this.item#0A...//.is.added.to
.the.end#2E#0A...!rliste.:#3D.getblk(0,.a,.l)#0A...
rliste.:#3D.!rliste#0A}#0A#0ALET.outputsection().BE
#0A{.LET.outstream.#3D.output()#0A...UNTIL.reflist#3D
0.DO.{.cgerror("Label.L%n.unset",.h3!reflist)#0A...
......................reflist.:#3D.!reflist#0A.....
.................}#0A#0A...selectoutput(gostream)..
//.Output.a.HUNK.or.BHUNK#2E#0A#0A...UNLESS.objline
1written.IF.objline1%0.DO#0A...{.writef("%s*n",.obj
line1)#0A.....objline1written.:#3D.TRUE#0A...}#0A#0A
...TEST.bining#0A...THEN.{.writef("%X3.",.t_bhunk).
.........//.writes.4.chars."BB8."#0A..........FOR.p
#3D0.TO.3......DO.wrch(stv%p).//.write.bhunk.size#0A
..........FOR.p#3D0.TO.stvp-1.DO.wrch(stv%p).//.wri
te.the.bhunk#0A........}#0A...ELSE.{.newline()#0A..
........wrword(t_hunk)#0A..........wrword(stvp/4)#0A
..........FOR.p#3D0.TO.stvp-4.BY.4.DO#0A..........{
.IF.p.REM.20.#3D.0.DO.newline()#0A.............wrwo
rd_at(p)#0A..........}#0A..........newline()#0A....
....}#0A...selectoutput(outstream)#0A}#0A#0AAND.wrw
ord(a).BE.writef("%X8.",.a)#0A#0AAND.wrhex2(byte).B
E#0A{.LET.t.#3D.TABLE.'0','1','2','3','4','5','6','
7',#0A................'8','9','A','B','C','D','E','
F'#0A..wrch(t!(byte>>4))#0A..wrch(t!(byte&15))#0A}#0A
#0AAND.wrword_at(a).BE#0A{.TEST.bigender.THEN.{.wrh
ex2(stv%a)#0A.......................wrhex2(stv%(a+1
))#0A.......................wrhex2(stv%(a+2))#0A...
....................wrhex2(stv%(a+3))#0A...........
..........}#0A................ELSE.{.wrhex2(stv%(a+
3))#0A.......................wrhex2(stv%(a+2))#0A..
.....................wrhex2(stv%(a+1))#0A..........
.............wrhex2(stv%(a))#0A....................
.}#0A..wrch('.')#0A}#0A#0AAND.dboutput().BE#0A{.LET
.p.#3D.info_a#0A..writes("A#3D(")#0A..UNTIL.p#3D0.D
O.{.wrkn(h2!p,.h3!p)#0A.................p.:#3D.!p#0A
.................UNLESS.p#3D0.DO.wrch('*s')#0A.....
..........}#0A....#0A..p.:#3D.info_b#0A..writes(").
B#3D(")#0A..UNTIL.p#3D0.DO.{.wrkn(h2!p,.h3!p)#0A...
..............p.:#3D.!p#0A.................UNLESS.p
#3D0.DO.wrch('*s')#0A...............}#0A..wrch(')')
#0A...#0A..IF.debug#3D2.DO.{.writes("..STK:.")#0A..
................FOR.p#3Dtempv.TO.arg1.BY.3..DO#0A..
................{.IF.(p-tempv).REM.30.#3D.10.DO.new
line()#0A....................wrkn(h1!p,h2!p)#0A....
................wrch('*s')#0A..................}#0A
................}#0A...#0A..IF.debug#3D3.DO.{.LET.l
.#3D.rlist#0A..................writes("*nREFS.")#0A
..................UNTIL.l#3D0.DO.{.writef("%n.L%n..
",.l!1,.l!2)#0A.................................l.:
#3D.!l#0A...............................}#0A.......
.........}#0A..newline()#0A}#0A#0A#0AAND.wrkn(k,n).
BE#0A{.LET.s.#3D.VALOF.SWITCHON.k.INTO#0A..{.DEFAUL
T:.......k.:#3D.n#0A...................RESULTIS."?"
#0A....CASE.k_none:...RESULTIS."-"#0A....CASE.k_num
b:...RESULTIS."N"#0A....CASE.k_fnlab:..RESULTIS."F"
#0A....CASE.k_lvloc:..RESULTIS."@P"#0A....CASE.k_lv
glob:.RESULTIS."@G"#0A....CASE.k_lvlab:..RESULTIS."
@L"#0A....CASE.k_a:......RESULTIS."A"#0A....CASE.k_
b:......RESULTIS."B"#0A....CASE.k_c:......RESULTIS.
"C"#0A....CASE.k_loc:....RESULTIS."P"#0A....CASE.k_
glob:...RESULTIS."G"#0A....CASE.k_lab:....RESULTIS.
"L"#0A....CASE.k_loc0:...RESULTIS."0P"#0A....CASE.k
_loc1:...RESULTIS."1P"#0A....CASE.k_loc2:...RESULTI
S."2P"#0A....CASE.k_loc3:...RESULTIS."3P"#0A....CAS
E.k_loc4:...RESULTIS."4P"#0A....CASE.k_glob0:..RESU
LTIS."0G"#0A....CASE.k_glob1:..RESULTIS."1G"#0A....
CASE.k_glob2:..RESULTIS."2G"#0A..}#0A..writes(s)#0A
..UNLESS.k#3Dk_none.|.k#3Dk_a.|.k#3Dk_b.|.k#3Dk_c.D
O.writen(n)#0A}#0A#0AAND.wrcode(f,.form,.a,.b).BE#0A
{.IF.debug#3D2.DO.dboutput()#0A..writef("%i4:.",.st
vp)#0A..wrfcode(f)#0A..writes("..")#0A..writef(form
,.a,.b)#0A..newline()#0A}#0A#0AAND.wrfcode(f).BE#0A
{.LET.s.#3D.VALOF.SWITCHON.f&31.INTO#0A..{.DEFAULT:
#0A....CASE..0:.RESULTIS.".....-.....K...LLP.....L.
...LP....SP....AP.....A"#0A....CASE..1:.RESULTIS.".
....-....KH..LLPH....LH...LPH...SPH...APH....AH"#0A
....CASE..2:.RESULTIS."...BRK....KW..LLPW....LW...L
PW...SPW...APW....AW"#0A....CASE..3:.RESULTIS."....
K3...K3G..K3G1..K3GH...LP3...SP3...AP3..L0P3"#0A...
.CASE..4:.RESULTIS."....K4...K4G..K4G1..K4GH...LP4.
..SP4...AP4..L0P4"#0A....CASE..5:.RESULTIS."....K5.
..K5G..K5G1..K5GH...LP5...SP5...AP5..L0P5"#0A....CA
SE..6:.RESULTIS."....K6...K6G..K6G1..K6GH...LP6...S
P6...AP6..L0P6"#0A....CASE..7:.RESULTIS."....K7...K
7G..K7G1..K7GH...LP7...SP7...AP7..L0P7"#0A....CASE.
.8:.RESULTIS."....K8...K8G..K8G1..K8GH...LP8...SP8.
..AP8..L0P8"#0A....CASE..9:.RESULTIS."....K9...K9G.
.K9G1..K9GH...LP9...SP9...AP9..L0P9"#0A....CASE.10:
.RESULTIS."...K10..K10G.K10G1.K10GH..LP10..SP10..AP
10.L0P10"#0A....CASE.11:.RESULTIS."...K11..K11G.K11
G1.K11GH..LP11..SP11..AP11.L0P11"#0A....CASE.12:.RE
SULTIS."....LF...S0G..S0G1..S0GH..LP12..SP12..AP12.
L0P12"#0A....CASE.13:.RESULTIS."...LF$...L0G..L0G1.
.L0GH..LP13..SP13.XPBYT.....S"#0A....CASE.14:.RESUL
TIS."....LM...L1G..L1G1..L1GH..LP14..SP14...LMH....
SH"#0A....CASE.15:.RESULTIS."...LM1...L2G..L2G1..L2
GH..LP15..SP15...BTC..MDIV"#0A....CASE.16:.RESULTIS
."....L0....LG...LG1...LGH..LP16..SP16...NOP.CHGCO"
#0A....CASE.17:.RESULTIS."....L1....SG...SG1...SGH.
..SYS....S1....A1...NEG"#0A....CASE.18:.RESULTIS.".
...L2...LLG..LLG1..LLGH...SWB....S2....A2...NOT"#0A
....CASE.19:.RESULTIS."....L3....AG...AG1...AGH...S
WL....S3....A3..L1P3"#0A....CASE.20:.RESULTIS."....
L4...MUL...ADD....RV....ST....S4....A4..L1P4"#0A...
.CASE.21:.RESULTIS."....L5...DIV...SUB...RV1...ST1.
..XCH....A5..L1P5"#0A....CASE.22:.RESULTIS."....L6.
..REM...LSH...RV2...ST2..GBYT..RVP3..L1P6"#0A....CA
SE.23:.RESULTIS."....L7...XOR...RSH...RV3...ST3..PB
YT..RVP4..L2P3"#0A....CASE.24:.RESULTIS."....L8....
SL...AND...RV4..STP3...ATC..RVP5..L2P4"#0A....CASE.
25:.RESULTIS."....L9...SL$....OR...RV5..STP4...ATB.
.RVP6..L2P5"#0A....CASE.26:.RESULTIS."...L10....LL.
..LLL...RV6..STP5.....J..RVP7..L3P3"#0A....CASE.27:
.RESULTIS."..FHOP...LL$..LLL$...RTN..GOTO....J$.ST0
P3..L3P4"#0A....CASE.28:.RESULTIS."...JEQ...JNE...J
LS...JGR...JLE...JGE.ST0P4..L4P3"#0A....CASE.29:.RE
SULTIS."..JEQ$..JNE$..JLS$..JGR$..JLE$..JGE$.ST1P3.
.L4P4"#0A....CASE.30:.RESULTIS."..JEQ0..JNE0..JLS0.
.JGR0..JLE0..JGE0.ST1P4.....-"#0A....CASE.31:.RESUL
TIS.".JEQ0$.JNE0$.JLS0$.JGR0$.JLE0$.JGE0$.....-....
.-"#0A..}#0A..LET.n.#3D.f>>5.&.7#0A..FOR.i.#3D.6*n+
1.TO.6*(n+1).DO.wrch(s%i)#0A}#0A#0A#0A#0A

######cintcode/com/bcplfe.b#
//.This.is.the.BCPL.syntax.analyser#0A#0A//.Impleme
nted.by.Martin.Richards.(c).20.October.2009#0A#0A#0A
/*.Change.history#0A#0A20/10/09#0ACorrected.bug.in.
performget.relating.to.sourcefile.names.and#0Anumbe
rs#2E#0A#0A10/07/09#0AStopped.'#2E'.terminating.GET
.streams.so.that.GET.streams.can.contain#0Aseveral.
sections.separated.by.dots#2E.BEWARE:.this.is.an.in
compatible#0Achange,.since.the.first.section.of.a.G
ET.stream.has.in.the.past.been#0Aused.as.a.header#2E
#0ARe-organised.the.compiler.into.g/bcplfecg#2Eh,.b
cplfe#2Eb.and.bcplcgcin#2Eb,#0Aand.reallocating.mos
t.of.the.compiler.globals#2E#0A#0A08/05/09#0AIncrea
sed.the.default.treesize.to.200000#2E#0A#0A03/07/07
#0AModified.the.treatment.of.*#23.escapes.in.string
.and.character.constants#0Ato.allow.both.UTF8.and.G
B2312.encoding#2E.Added.compiler.options.UTF8#0Aand
.GB2312.to.set.the.default.encoding#2E.*#23U.and.*#23
G.in.a.string.and#0Acharacter.constant.temporarily.
set.the.encoding.to.UTF8.and.GB2312,#0Arespectively
,.overriding.the.default.setting#2E.In.GB2312.mode,
.*#23dddd#0Acontains.up.to.4.decimal.digits#2E.See.
the.BCPL.manual#2E#0A#0A27/06/07#0AAdded.the.Unicod
e.escape.sequences.*#23hhhh.and.*#23#23hhhhhhhh.to.
string#0Aand.character.constants#2E.Within.string.t
hey.are.converted.to.the#0Acorresponding.UTF8.seque
nce.of.bytes.and.within.a.character.constant#0Athey
.yield.the.corresponding.Unicode.integer#2E.See.the
.last.few.tests#0Ain.com/cmpltest#2Eb#0A#0A27/07/06
#0AChanged.the.implementation.of.the.GET.directive.
to.make.it.system#0Aindependent#2E.Performget.now.o
btains.the.headers.environment.variable#0Afrom.the.
root.node.(rootnode!rtn_hdrsvar).this.is.normally.e
ither#0A"BCPLHDRS".or."POSHDRS"#2E.If.the.header.fi
le.does.not.end.in.#2Eh.or.#2Eb,#0A#2Eh.is.appended
#2E.The.search.order.is.as.follows:#0A#0A(1).The.cu
rrent.directory#2E#0A(2).The.directories.specified.
by.the.headers.environment.variable,#0A....if.set#2E
#0A(3).The.subdirectory.g/.of.the.root.specified.by
.the.environment#0A....variable.rootnode!rtn_rootva
r,.if.set#2E#0A#0A05/04/06#0AMended.a.bug.in.trans.
concerning.the.tranlation.of.SKIP#2E#0A#0A18/01/06#0A
Based.on.Dave.Lewis's.suggestion,#0Ain.outputsectio
n(),.add:#0A...IF.objline1%0.DO.writef("%s*n",.objl
ine1)#0Awhere.objline1.is.the.first.line.of.file.ob
jline1.if.it.can.be.found#0Ain.the.current.director
y.or.in.the.HDRS.directory#2E.This.will.typically#0A
put.a.line.such.as:#0A#23!/usr/local/bin/cintsys.-c
#0Aas.the.first.line.of.the.compiled.object.module#2E
.This.line.is.ignored#0Aby.the.CLI.but.may.be.usefu
l.under.Linux#2E.If.objline1.cannot.be.found#0Ano.s
uch.line.is.inserted.at.the.start.of.the.object.mod
ule#2E#0A#0A30/8/05#0ADefined.the.function.default_
hdrs().near.the.start.to.allow.easy.change#0Afrom.c
intsys.to.cintpos.versions.of.the.compiler#2E#0A.#0A
22/6/05#0AAdded.the.empty.command.SKIP.and.let.empt
y.blocks.be.equivalent.to#0ASKIP#2E.Empty.section.b
rackets.are.now.also.allowed.after.MANIFEST,#0ASTAT
IC.and.GLOBAL#2E..These.changes.make.program.develo
pment.marginally#0Aeasier#2E#0A#0A17/6/04#0AMade.GE
T.first.look.in.the.current.directory#2E#0AAdded.ar
gument.HDRS.to.allow.the.environment.variable.speci
fying#0Athe.headers.directory.to.be.changed#2E.The.
default.is.BCPLHDRS#2E#0A#0A23/4/04#0AUpdate.the.st
andard.BCPL.compiler.with.all.the.Cintpos.extension
s#0Aincluding.cross.referencing.and.11.character.na
mes#2E#0AMake.GET.directives.use.the.BCPLHDRS.envir
onment.variable#2E#0A#0A11/6/02#0AChanged.square.br
ackets.to.mean.subscription.with.same.precedence#0A
and.function.calls#2E#0A#0A18/3/02#0AUse.HDRPATH.an
d.BCPLPATH.in.GET.directives#2E#0A#0A14/1/02#0AAdde
d.XREF.option.to.output.name.information.during.com
pilation#2E#0A#0A11/7/01#0AAdded.language.extension
s.for.the.Ford.dialect.of.BCPL#2E#0Ai#2Ee#2E.modifi
ed.performget#0A.....added.SLCT.and.OF.(also.::)#0A
.....added.||.comments#0A.....treesize.set.to.10000
0#0A#0A15/1/01#0AComplain.if.global.number.is.large
r.than.65535#2E#0A#0A10/8/00#0AChange.the.maximum.n
umber.of.error.messages.from.30.to.10#2E#0A#0A14/12
/99#0AMade./.*.#2E#2E#2E.*./..comments.nest#2E#0AAl
low.the.constants.in.MANIFEST,.STATIC.and.GLOBAL.de
clarations.#0Ato.be.optional#2E.If.absent.the.value
.is.one.greater.than.the#0Aprevious.value#2E.Unless
.specified.the.first.value.is.zero,.so#0AMANIFEST.{
.a;.b#3D10;.c.}.declares.a,.b.and.c.to.be.0,.10.and
.11,#0Arespectively#2E#0A#0A9/6/99#0AMade.changes.t
o.buffer.OCODE.in.memory#2E.When.bcpl.is.called#0Aw
ithout.the.TO.argument.it.writes.numeric.ocode.to.t
he.file.ocode#2E#0ALex.treats.CR.(13).correctly.to.
improve.convenience.when.running#0Aunder.Windows.an
d.WindowsCE#2E#0A#0A26/2/99#0AAdded.BIN.option.to.t
he.compiler.to.generate.a.binary.(rather.than#0Ahex
).hunk.format.for.the.compiled.code#2E.This.is.prim
arily.for.the#0AWindows.CE.version.of.the.cintcode.
system.where.compactness.is#0Aparticularly.importan
t#2E.There.is.a.related.change.to.loadseg.in#0Acint
main#2Ec#0A#0A17/11/98#0AChanged.the.workspacesize.
to.40000.and.added.the.SIZE.keyword#0Ato.allow.the.
user.to.specify.this.size#2E#0A#0A9/11/98#0AMade.GE
T.directives.search.the.current.working.directory#0A
then.directories.given.by.the.shell.variable.BCPLPA
TH,.if.set#2E#0AIt.uses.the.BLIB.function.pathfindi
nput#2E#0A#0A15/12/96#0ACorrect.a.bug.in.cellwithna
me#0A#0A16/8/96#0AAdded.one.line.to.readnumber.to.a
llow.underscores.in.numbers.after.#0Athe.first.digi
t#2E#0A#0A7/6/96#0AImplement.the.method.application
.operator.for.object.oriented#0Aprogramming.in.BCPL
#2E.E.#23.(E1,.E2,#2E#2E#2E,.En).is.equivalent.to#0A
((!E1)!E)(E1,.E2,#2E#2E#2E,.En)#0A#0A24/12/95#0AImp
roved.the.efficiency.of.cellwithname.in.TRN.(using.
the.hash.chain#0Alink.in.name.node)#2E#0AImproved.t
he.efficiency.of.outputsection.in.CG.by.introducing
#0Awrhex2.and.wrword_at#2E#0A#0A24/7/95#0ARemoved.b
ug.in.atbinfo,.define.addinfo_b.change.some.global.
numbers#2E#0AImplement.constant.folding.in.TRN#2E#0A
#0A13/7/95#0AAllowed.{.and.}.to.represent.untagged.
section.brackets#2E#0A#0A22/6/93#0AReverse.order.in
.SWB.and.have.a.minimum.of.7.cases#0Ato.allow.faste
r.interpreter#2E#0A#0A2/6/93#0AChanged.code.for.SWB
.to.use.heap-like.binary.tree#2E#0A#0A19/5/93#0APut
.in.code.to.compile.BTC.and.XPBYT.instructions#2E#0A
#0A23/4/93#0AAllowed.the.codegenerator.to.compiler.
the.S.instruction#2E#0A#0A21/12/92#0ACured.bug.in.c
ompilation.of.(b.->.f,.g)(1,2,3)#0A#0A24/11/92.#0AC
ured.bug.in.compilation.of.a,.b.:#3D.s%0.>.0,.s%1.#3D
.'!'#0A#0A23/7/92:#0ARenamed.nextlab.as.newlab,.loa
d.as.loadval.in.the.CG#2E#0APut.back.simpler.hashin
g.function.in.lookupword#2E#0ARemoved.rdargs.fudge#2E
#0ARemoved.S2.compiler.option#2E#0ACured.bug.concer
ning.the.closing.of.gostream.when.equal.to.stdout#2E
#0A*/#0A#0ASECTION."BCPL"#0A#0AGET."libhdr"#0AGET."
bcplfecg"#0A.#0ALET.default_hdrs().#3D.VALOF.//.Cha
nged.MR.12/07/09#0A{.LET.hdrs.#3D.rootnode!rtn_hdrs
var.//.Typically."BCPLHDRS".or."POSHDRS".or.0#0A..I
F.hdrs.RESULTIS.hdrs#0A..RESULTIS."BCPLHDRS"#0A}#0A
.#0AGLOBAL.{#0A//.Globals.used.in.LEX#0Achbuf:feg#0A
decval;.getstreams;.charv#0Ahdrs..//.MR.10/7/04#0A#0A
workvec#0Areadnumber;.rdstrch#0Atoken;.wordnode;.ch
#0Ardtag;.performget#0Alex;.dsw;.declsyswords;.nlpe
nding#0Alookupword;.rch#0Asourcenamev;.sourcefileno
;.sourcefileupb#0Askiptag;.wrchbuf;.chcount;.lineno
#0Anulltag;.rec_p;.rec_l#0A.#0A//.Globals.used.in.S
YN#0Ardblockbody;..rdsect#0Arnamelist;.rname#0Ardef
;.rcom#0Ardcdefs#0Aformtree;.synerr;.opname#0Arexpl
ist;.rdseq#0Amk1;.mk2;.mk3#0Amk4;.mk5;.mk6;.mk7#0An
ewvec#0Arnexp;.rexp;.rbexp#0A}#0A.#0A.#0AMANIFEST.{
#0Ac_backspace.#3D..8#0Ac_tab.......#3D..9#0Ac_newl
ine...#3D.10#0Ac_newpage...#3D.12#0Ac_return....#3D
.13#0Ac_escape....#3D.27#0Ac_space.....#3D.32#0A}#0A
#0ALET.start().#3D.VALOF#0A{.LET.treesize.#3D.0#0A.
.AND.argv.#3D.VEC.50#0A..AND.argform.#3D."FROM/A,TO
/K,VER/K,SIZE/K/N,TREE/S,NONAMES/S,*#0A............
....*D1/S,D2/S,OENDER/S,EQCASES/S,BIN/S,XREF/S,GDEF
S/S,HDRS/K,*#0A................*GB2312/S,UTF8/S,SAV
ESIZE/K/N"#0A..LET.stdout.#3D.output()#0A..LET.objl
ine1vec.#3D.VEC.256/bytesperword#0A..objline1.:#3D.
objline1vec#0A..objline1%0.:#3D.0#0A..errmax...:#3D
.10#0A..errcount.:#3D.0#0A..fin_p,.fin_l.:#3D.level
(),.fin#0A#0A..treevec......:#3D.0#0A..obuf........
.:#3D.0#0A..sourcestream.:#3D.0#0A..ocodeout.....:#3D
.0#0A..gostream.....:#3D.0#0A..getstreams...:#3D.0#0A
#0A..sysprint.:#3D.stdout#0A..selectoutput(sysprint
)#0A.#0A..writef("*nBCPL.(20.Oct.2009)*n")#0A#0A../
/.Allocate.vector.for.source.file.names#0A..sourcef
ileupb.:#3D.1000#0A..sourcenamev.:#3D.getvec(source
fileupb)#0A..UNLESS.sourcenamev.DO#0A..{.writef("In
sufficient.space.available*n")#0A....errcount.:#3D.
1#0A....GOTO.fin#0A..}#0A..sourcefileno.:#3D.0#0A..
FOR.i.#3D.0.TO.sourcefileupb.DO.sourcenamev!0.:#3D.
0...#0A.#0A..IF.rdargs(argform,.argv,.50)#3D0.DO.{.
writes("Bad.arguments*n")#0A.......................
...............errcount.:#3D.1#0A..................
....................GOTO.fin#0A....................
................}#0A..treesize.:#3D.200_000#0A..IF.
argv!3.DO.treesize.:#3D.!argv!3#0A..IF.treesize<10_
000.DO.treesize.:#3D.10_000#0A..obufsize.:#3D.trees
ize/4#0A#0A..prtree........:#3D.argv!4#0A..savespac
esize.:#3D.3#0A#0A..//.Code.generator.options.#0A#0A
..naming.:#3D.TRUE#0A..debug.:#3D.0#0A..bigender.:#3D
.(!"AAA".&.255).#3D.'A'.//.#3DTRUE.if.running.on.a.
bigender#0A..IF.argv!5.DO.naming...:#3D.FALSE......
....//.NONAMES#0A..IF.argv!6.DO.debug....:#3D.debug
+1........//.D1#0A..IF.argv!7.DO.debug....:#3D.debu
g+2........//.D2#0A..IF.argv!8.DO.bigender.:#3D.~bi
gender......//.OENDER#0A..eqcases..:#3D.argv!9.....
.................//.EQCASES#0A..bining...:#3D.argv!
10.....................//.BIN.(binary.hunk)#0A..xre
fing..:#3D.argv!11.....................//.XREF#0A..
gdefsing.:#3D.argv!12.....................//.GDEFS#0A
..hdrs.....:#3D.argv!13.....................//.HDRS
#0A..defaultencoding.:#3D.UTF8#0A..IF.argv!14.DO.de
faultencoding.:#3D.GB2312.//.GB2312#0A..IF.argv!15.
DO.defaultencoding.:#3D.UTF8...//.UTF8#0A..encoding
.:#3D.defaultencoding#0A..IF.argv!16.DO.savespacesi
ze.:#3D.!(argv!16).//.SAVESIZE#0A#0A..UNLESS.hdrs.D
O#0A....hdrs.:#3D.default_hdrs()................//.
Use.the.default.HDRS#0A............................
..............//.(typically.BCPLHDRS.or.POSHDRS)#0A
#0A..{.//.Feature.added.by.MR.17/01/06#0A....//.If.
file.objline1.can.be.found,.its.first.line.will.be.
written#0A....//.at.the.start.of.the.compiled.Cintc
ode.file#2E.It.first.looks.in.the#0A....//.current.
directory.then.the.HDRS.directory.and.finally.it.tr
ies#0A....//.g/objline1.in.the.system.root.director
y#2E#0A....LET.line1stream.#3D.findinput("objline1"
)#0A....LET.len.#3D.0#0A....UNLESS.line1stream.DO#0A
......line1stream.:#3D.pathfindinput("objline1",.hd
rs)#0A....UNLESS.line1stream.IF.rootnode!rtn_rootva
r.DO#0A......line1stream.:#3D.pathfindinput("g/objl
ine1",.rootnode!rtn_rootvar)#0A....#0A....IF.line1s
tream.DO#0A....{.//.Copy.first.line.of.objline1.int
o.string.objline1#0A......selectinput(line1stream)#0A
......WHILE.len<255.DO#0A......{.LET.ch.#3D.rdch()#0A
........IF.ch#3D'*n'.|.ch#3Dendstreamch.BREAK#0A...
.....len.:#3D.len+1#0A........objline1%len.:#3D.ch#0A
......}#0A......endread()#0A....}#0A....objline1%0.
:#3D.len#0A....objline1written.:#3D.FALSE#0A..}#0A#0A
..sourcestream.:#3D.findinput(argv!0)......//.FROM#0A
..sourcenamev!0.:#3D.argv!0....//.Fileno.zero.is.th
e.FROM.file#0A..sourcefileno..:#3D.0#0A#0A..IF.sour
cestream#3D0.DO.{.writef("Trouble.with.file.%s*n",.
argv!0)#0A.........................errcount.:#3D.1#0A
.........................GOTO.fin#0A...............
........}#0A#0A..selectinput(sourcestream)#0A.#0A..
TEST.argv!1..........//.TO#0A..THEN.{.gostream.:#3D
.findoutput(argv!1)#0A.........IF.gostream#3D0.DO#0A
.........{.writef("Trouble.with.code.file.%s*n",.ar
gv!1)#0A...........errcount.:#3D.1#0A...........GOT
O.fin#0A.........}#0A.......}#0A..ELSE.{.ocodeout.:
#3D.findoutput("ocode")#0A.........IF.ocodeout#3D0.
DO#0A.........{.writes("Trouble.with.file.ocode*n")
#0A...........errcount.:#3D.1#0A...........GOTO.fin
#0A.........}#0A.......}#0A#0A..treevec.:#3D.getvec
(treesize)#0A..obuf....:#3D.getvec(obufsize)#0A#0A.
.IF.treevec#3D0.|.obuf#3D0.DO#0A..{.writes("Insuffi
cient.memory*n")#0A....errcount.:#3D.1#0A....GOTO.f
in#0A..}#0A...#0A..UNLESS.argv!2#3D0.DO.......//.VE
R#0A..{.sysprint.:#3D.findoutput(argv!2)#0A....IF.s
ysprint#3D0.DO#0A....{.sysprint.:#3D.stdout#0A.....
.writef("Trouble.with.file.%s*n",.argv!2)#0A......e
rrcount.:#3D.1#0A......GOTO.fin#0A....}#0A..}#0A#0A
..selectoutput(sysprint)#0A#0A..//.Now.syntax.analy
se,.translate.and.code-generate.each.section#0A..{.
LET.b.#3D.VEC.64/bytesperword#0A....chbuf.:#3D.b#0A
....FOR.i.#3D.0.TO.63.DO.chbuf%i.:#3D.0#0A....//.So
urcefile.0.is.the.FROM.filename#0A....//.others.are
.GET.files.of.the.current.section#0A....sourcenamev
!0.:#3D.argv!0#0A....sourcefileno.:#3D.0#0A....FOR.
i.#3D.1.TO.sourcefileupb.DO.sourcenamev!i.:#3D.0.//
.Done.for.safety#0A....chcount,.lineno.:#3D.0,.(sou
rcefileno<<20).+.1#0A....token,.decval.:#3D.0,.0#0A
....rch()#0A.#0A....{.//.Start.of.loop.to.process.e
ach.section#0A......LET.tree.#3D.?#0A......treep.:#3D
.treevec.+.treesize#0A......obufp.:#3D.0#0A......ob
uft.:#3D.obufsize.*.bytesperword#0A#0A......tree.:#3D
.formtree()#0A......UNLESS.tree.BREAK#0A#0A......//
writef("Tree.size.%n*n",.treesize+treevec-treep)#0A
.#0A......IF.prtree.DO.{.writes("Parse.Tree*n")#0A.
....................plist(tree,.0,.20)#0A..........
...........newline()#0A...................}#0A..#0A
......IF.errcount.GOTO.fin#0A.#0A......translate(tr
ee)#0A#0A......obufq.:#3D.obufp.....//.Prepare.to.r
ead.from.OCODE.buffer#0A......obufp.:#3D.0#0A#0A...
...TEST.argv!1#3D0#0A......THEN.writeocode()..//.Wr
ite.OCODE.file.if.no.TO.argument#0A......ELSE.codeg
enerate(treevec,.treesize)#0A....}.REPEATWHILE.toke
n#3Ds_dot#0A..}#0A...#0Afin:#0A..IF.getstreams....D
O.{.LET.p.#3D.getstreams#0A........................
getstreams.:#3D.!p#0A........................freeve
c(p)#0A......................}#0A..FOR.i.#3D.1.TO.s
ourcefileno.DO#0A..{.LET.str.#3D.sourcenamev!i#0A..
..IF.str.DO#0A....{.//sawritef("freeing.fileno.%n.%
s*n",.i,.str)#0A......freevec(str)#0A....}#0A..}#0A
..IF.sourcenamev...DO.freevec(sourcenamev)#0A#0A..I
F.treevec.......DO.freevec(treevec)#0A..IF.obuf....
......DO.freevec(obuf)#0A..IF.sourcestream..DO.{.se
lectinput(sourcestream);.endread().}#0A..IF.ocodeou
t......DO.{.selectoutput(ocodeout)#0A..............
..........UNLESS.ocodeout#3Dstdout.DO.endwrite()#0A
......................}#0A..IF.gostream......DO.{.s
electoutput(gostream)#0A........................UNL
ESS.gostream#3Dstdout.DO.endwrite()#0A.............
.........}#0A..UNLESS.sysprint#3Dstdout.DO.{.select
output(sysprint);.endwrite().}#0A#0A..selectoutput(
stdout)#0A//abort(7777)#0A..RESULTIS.errcount#3D0.-
>.0,.20#0A}#0A#0A//.*************.OCODE.I/O.Routine
s.**************************#0A#0A/*#0AThe.OCODE.bu
ffer.variables.are:#0A#0Aobuf.........is.the.OCODE.
buffer.--.(obuf#3Dworkvec)#0Aobufp........position.
of.next.byte.in.the.OCODE.buffer#0Aobufq........ano
ther.pointer.into.the.OCODE.buffer#0Aobuft........e
nd.of.the.OCODE.buffer#2E#0Aobufsize.....size.of.ob
uf.(in.words)#0A*/#0A#0AAND.writeocode().BE#0A{.LET
.layout.#3D.0#0A..selectoutput(ocodeout)#0A#0A..UNT
IL.obufp>#3Dobufq.DO#0A..{.writef(".%n",.rdn())#0A.
...layout.:#3D.layout+1#0A....UNLESS.layout.REM.16.
DO.newline()#0A..}#0A..newline()#0A..selectoutput(s
ysprint)#0A..writef("OCODE.size:.%i5/%n*n",.obufq,.
obuft)#0A}#0A#0AAND.rdn().#3D.VALOF#0A{.LET.byte.#3D
.obuf%obufp#0A..IF.obufp>#3Dobufq.RESULTIS.0#0A..ob
ufp.:#3D.obufp+1#0A..IF.byte<223.RESULTIS.byte#0A..
IF.byte#3D223.RESULTIS.-1#0A..RESULTIS.(byte&31).+.
(rdn()<<5)#0A}#0A#0AAND.wrn(n).BE#0A{.IF.obufp>#3Do
buft.DO#0A..{.errmax.:#3D.0.//.Make.it.fatal#0A....
trnerr("More.workspace.needed.for.OCODE.buffer*n")#0A
..}#0A..IF.-1<#3Dn<223.DO....//.This.is.the.normal.
case#0A..{.IF.n#3D-1.DO.n.:#3D.223#0A....obuf%obufp
.:#3D.n#0A....obufp.:#3D.obufp.+.1#0A....RETURN#0A.
.}#0A..obuf%obufp.:#3D.224.+.(n&31)#0A..obufp.:#3D.
obufp.+.1#0A..n.:#3D.n>>5#0A}.REPEAT#0A#0A//.******
*******.End.of..OCODE.I/O.Routines.****************
***#0A..#0ALET.lex().BE#0A{.nlpending.:#3D.FALSE#0A
.#0A..{.SWITCHON.ch.INTO#0A.#0A....{.DEFAULT:#0A...
.........{.LET.badch.#3D.ch#0A..............ch.:#3D
.'*s'#0A..............synerr("Illegal.character.%x2
",.badch)#0A............}#0A#0A......CASE.'*n':#0A.
..............lineno.:#3D.lineno.+.1#0A......CASE.'
*p':#0A...............nlpending.:#3D.TRUE..//.IGNOR
ABLE.CHARACTERS#0A......CASE.'*c':#0A......CASE.'*t
':#0A......CASE.'*s':#0A...............rch().REPEAT
WHILE.ch#3D'*s'#0A...............LOOP#0A#0A......CA
SE.'0':CASE.'1':CASE.'2':CASE.'3':CASE.'4':#0A.....
.CASE.'5':CASE.'6':CASE.'7':CASE.'8':CASE.'9':#0A..
............token.:#3D.s_number#0A..............dec
val.:#3D.readnumber(10,.100)#0A..............RETURN
#0A.#0A......CASE.'a':CASE.'b':CASE.'c':CASE.'d':CA
SE.'e':#0A......CASE.'f':CASE.'g':CASE.'h':CASE.'i'
:CASE.'j':#0A......CASE.'k':CASE.'l':CASE.'m':CASE.
'n':CASE.'o':#0A......CASE.'p':CASE.'q':CASE.'r':CA
SE.'s':CASE.'t':#0A......CASE.'u':CASE.'v':CASE.'w'
:CASE.'x':CASE.'y':#0A......CASE.'z':#0A......CASE.
'A':CASE.'B':CASE.'C':CASE.'D':CASE.'E':#0A......CA
SE.'F':CASE.'G':CASE.'H':CASE.'I':CASE.'J':#0A.....
.CASE.'K':CASE.'L':CASE.'M':CASE.'N':CASE.'O':#0A..
....CASE.'P':CASE.'Q':CASE.'R':CASE.'S':CASE.'T':#0A
......CASE.'U':CASE.'V':CASE.'W':CASE.'X':CASE.'Y':
#0A......CASE.'Z':#0A..............token.:#3D.looku
pword(rdtag(ch))#0A..............IF.token#3Ds_get.D
O.{.performget();.LOOP..}#0A..............RETURN#0A
.#0A......CASE.'$':#0A..............rch()#0A.......
.......IF.ch#3D'$'.|.ch#3D'<'.|.ch#3D'>'.DO#0A.....
.........{.LET.k.#3D.ch#0A................token.:#3D
.lookupword(rdtag('<'))#0A................//.token.
#3D.s_true.............if.the.tag.is.set#0A........
........//......#3D.s_false.or.s_name..otherwise#0A
.#0A................//.$>tag...marks.the.end.of.a.c
onditional#0A................//.........skipping.se
ction#0A................IF.k#3D'>'.DO#0A...........
.....{.IF.skiptag#3Dwordnode.DO#0A.................
.....skiptag.:#3D.0...//.Matching.$>tag.found#0A...
...............LOOP#0A................}#0A.#0A.....
...........UNLESS.skiptag#3D0.LOOP#0A#0A...........
.....//.Only.process.$<tag.and.$$tag.if.not.skippin
g#0A.#0A................//.$$tag..complements.the.v
alue.of.a.tag#0A................IF.k#3D'$'.DO#0A...
.............{.h1!wordnode.:#3D.token#3Ds_true.->.s
_false,.s_true#0A..................LOOP#0A.........
.......}#0A.#0A................//.$<tag#0A.........
.......IF.token#3Ds_true.LOOP......//.Don't.skip.if
.set#0A#0A................//.tag.is.false.so.skip.u
ntil.matching.$>tag.or.EOF#0A................skipta
g.:#3D.wordnode#0A................UNTIL.skiptag#3D0
.|.token#3Ds_dot.|.token#3Ds_eof.DO.lex()#0A.......
.........skiptag.:#3D.0#0A................RETURN#0A
..............}#0A.#0A..............UNLESS.ch#3D'('
.|.ch#3D')'.DO.synerr("'$'.out.of.context")#0A.....
.........token.:#3D.ch#3D'('.->.s_lsect,.s_rsect#0A
..............lookupword(rdtag('$'))#0A............
..RETURN#0A.#0A......CASE.'{':.token,.wordnode.:#3D
.s_lsect,.nulltag;.BREAK#0A......CASE.'}':.token,.w
ordnode.:#3D.s_rsect,.nulltag;.BREAK#0A#0A......CAS
E.'#23':#0A..............token.:#3D.s_number#0A....
..........rch()#0A..............IF.'0'<#3Dch<#3D'7'
.DO#0A..............{.decval.:#3D.readnumber(.8,.10
0)#0A................RETURN#0A..............}#0A...
...........IF.ch#3D'b'.|.ch#3D'B'.DO#0A............
..{.rch()#0A................decval.:#3D.readnumber(
.2,.100)#0A................RETURN#0A..............}
#0A..............IF.ch#3D'o'.|.ch#3D'O'.DO#0A......
........{.rch()#0A................decval.:#3D.readn
umber(.8,.100)#0A................RETURN#0A.........
.....}#0A..............IF.ch#3D'x'.|.ch#3D'X'.DO#0A
..............{.rch()#0A................decval.:#3D
.readnumber(16,.100)#0A................RETURN#0A...
...........}#0A..............token.:#3D.s_mthap#0A.
.............RETURN#0A.#0A......CASE.'[':.token.:#3D
.s_sbra;......BREAK#0A......CASE.']':.token.:#3D.s_
sket;......BREAK#0A......CASE.'(':.token.:#3D.s_lpa
ren;....BREAK#0A......CASE.')':.token.:#3D.s_rparen
;....BREAK.#0A......CASE.'?':.token.:#3D.s_query;..
...BREAK#0A......CASE.'+':.token.:#3D.s_plus;......
BREAK#0A......CASE.',':.token.:#3D.s_comma;.....BRE
AK#0A......CASE.';':.token.:#3D.s_semicolon;.BREAK#0A
......CASE.'@':.token.:#3D.s_lv;........BREAK#0A...
...CASE.'&':.token.:#3D.s_logand;....BREAK#0A......
CASE.'#3D':.token.:#3D.s_eq;........BREAK#0A......C
ASE.'!':.token.:#3D.s_vecap;.....BREAK#0A......CASE
.'%':.token.:#3D.s_byteap;....BREAK#0A......CASE.'*
*':token.:#3D.s_mult;......BREAK#0A......CASE.'|':.
token.:#3D.s_logor;.....BREAK#0A......CASE.'#2E':.t
oken.:#3D.s_dot;.......BREAK#0A#0A.#0A......CASE.'/
':#0A..............rch()#0A..............IF.ch#3D'\
'.DO.{.token.:#3D.s_logand;.BREAK.}#0A.............
.IF.ch#3D'/'.DO#0A..............{.rch().REPEATUNTIL
.ch#3D'*n'.|.ch#3Dendstreamch#0A................LOO
P#0A..............}#0A.#0A..............IF.ch#3D'**
'.DO#0A..............{.LET.depth.#3D.1#0A#0A.......
.........{.rch()#0A..................IF.ch#3D'**'.D
O#0A..................{.rch().REPEATWHILE.ch#3D'**'
#0A....................IF.ch#3D'/'.DO.{.depth.:#3D.
depth-1;.LOOP.}#0A..................}#0A...........
.......IF.ch#3D'/'.DO#0A..................{.rch()#0A
....................IF.ch#3D'**'.DO.{.depth.:#3D.de
pth+1;.LOOP.}#0A..................}#0A.............
.....IF.ch#3D'*n'.DO.lineno.:#3D.lineno+1#0A.......
...........IF.ch#3Dendstreamch.DO.synerr("Missing.'
**/'")#0A................}.REPEATUNTIL.depth#3D0#0A
#0A................rch()#0A................LOOP#0A.
.............}#0A#0A..............token.:#3D.s_div#0A
..............RETURN#0A.#0A......CASE.'~':#0A......
........rch()#0A..............IF.ch#3D'#3D'.DO.{.to
ken.:#3D.s_ne;.....BREAK.}#0A..............token.:#3D
.s_not#0A..............RETURN#0A.#0A......CASE.'\':
#0A..............rch()#0A..............IF.ch#3D'/'.
DO.{.token.:#3D.s_logor;..BREAK.}#0A..............I
F.ch#3D'#3D'.DO.{.token.:#3D.s_ne;.....BREAK.}#0A..
............token.:#3D.s_not#0A..............RETURN
#0A.#0A......CASE.'<':.rch()#0A..............IF.ch#3D
'#3D'.DO.{.token.:#3D.s_le;.....BREAK.}#0A.........
.....IF.ch#3D'<'.DO.{.token.:#3D.s_lshift;.BREAK.}#0A
..............token.:#3D.s_ls#0A..............RETUR
N#0A.#0A......CASE.'>':.rch()#0A..............IF.ch
#3D'#3D'.DO.{.token.:#3D.s_ge;.....BREAK.}#0A......
........IF.ch#3D'>'.DO.{.token.:#3D.s_rshift;.BREAK
.}#0A..............token.:#3D.s_gr#0A..............
RETURN#0A.#0A......CASE.'-':.rch()#0A..............
IF.ch#3D'>'.DO.{.token.:#3D.s_cond;.BREAK..}#0A....
..........token.:#3D.s_minus#0A..............RETURN
#0A.#0A......CASE.':':.rch()#0A..............IF.ch#3D
'#3D'.DO.{.token.:#3D.s_ass;.BREAK..}#0A...........
...IF.ch#3D':'.DO.{.token.:#3D.s_of;..BREAK..}..//.
Inserted.11/7/01#0A..............token.:#3D.s_colon
#0A..............RETURN#0A.#0A......CASE.'"':#0A...
........{.LET.len.#3D.0#0A.............rch()#0A....
.........encoding.:#3D.defaultencoding.//.encoding.
for.*#23.escapes#0A#0A.............UNTIL.ch#3D'"'.D
O#0A.............{.LET.code.#3D.rdstrch()#0A.......
........TEST.result2#0A...............THEN.{.//.A..
*#23.code.found#2E#0A......................//.Conve
rt.it.to.UTF8.or.GB2312.format#2E#0A...............
.......TEST.encoding#3DGB2312#0A...................
...THEN.{.//.Convert.to.GB2312.sequence#0A.........
....................IF.code>#23x7F.DO#0A...........
..................{.LET.hi.#3D.code../..100.+.160#0A
...............................LET.lo.#3D.code.MOD.
100.+.160#0A...............................IF.len>#3D
254.DO.synerr("Bad.string.constant")#0A............
...................TEST.bigender#0A................
...............THEN.{.charv%(len+1).:#3D.hi.#0A....
..................................charv%(len+2).:#3D
.lo#0A....................................}#0A.....
..........................ELSE.{.charv%(len+1).:#3D
.lo.#0A......................................charv%
(len+2).:#3D.hi#0A.................................
...}#0A...............................len.:#3D.len.
+.2#0A...............................LOOP#0A.......
......................}#0A.........................
....IF.len>#3D255.DO.synerr("Bad.string.constant")#0A
.............................charv%(len+1).:#3D.cod
e.//.Ordinary.ASCII.char#0A........................
.....len.:#3D.len.+.1#0A...........................
..LOOP#0A...........................}#0A...........
...........ELSE.{.//.Convert.to.UTF8.sequence#0A...
..........................IF.code<#3D#23x7F.DO#0A..
...........................{.IF.len>#3D255.DO.syner
r("Bad.string.constant")#0A........................
.......charv%(len+1).:#3D.code...//.0xxxxxxx#0A....
...........................len.:#3D.len.+.1#0A.....
..........................LOOP#0A..................
...........}#0A.............................IF.code
<#3D#23x7FF.DO#0A.............................{.IF.
len>#3D254.DO.synerr("Bad.string.constant")#0A.....
..........................charv%(len+1).:#3D.#23b11
00_0000+(code>>6)..//.110xxxxx#0A..................
.............charv%(len+2).:#3D.#23x80+(.code....&#23
x3F)..//.10xxxxxx#0A...............................
len.:#3D.len.+.2#0A...............................L
OOP#0A.............................}#0A............
.................IF.code<#3D#23xFFFF.DO#0A.........
....................{.IF.len>#3D253.DO.synerr("Bad.
string.constant")#0A...............................
charv%(len+1).:#3D.#23b1110_0000+(code>>12).//.1110
xxxx#0A...............................charv%(len+2)
.:#3D.#23x80+((code>>6)&#23x3F)..//.10xxxxxx#0A....
...........................charv%(len+3).:#3D.#23x8
0+(.code....&#23x3F)..//.10xxxxxx#0A...............
................len.:#3D.len.+.3#0A................
...............LOOP#0A.............................
}#0A.............................IF.code<#3D#23x1F_
FFFF.DO#0A.............................{.IF.len>#3D
252.DO.synerr("Bad.string.constant")#0A............
...................charv%(len+1).:#3D.#23b1111_0000
+(code>>18).//.11110xxx#0A.........................
......charv%(len+2).:#3D.#23x80+((code>>12)&#23x3F)
.//.10xxxxxx#0A...............................charv
%(len+3).:#3D.#23x80+((code>>.6)&#23x3F).//.10xxxxx
x#0A...............................charv%(len+4).:#3D
.#23x80+(.code.....&#23x3F).//.10xxxxxx#0A.........
......................len.:#3D.len.+.4#0A..........
.....................LOOP#0A.......................
......}#0A.............................IF.code<#3D#23
x3FF_FFFF.DO#0A.............................{.IF.le
n>#3D251.DO.synerr("Bad.string.constant")#0A.......
........................charv%(len+1).:#3D.#23b1111
_1000+(code>>24).//.111110xx#0A....................
...........charv%(len+2).:#3D.#23x80+((code>>18)&#23
x3F).//.10xxxxxx#0A...............................c
harv%(len+3).:#3D.#23x80+((code>>12)&#23x3F).//.10x
xxxxx#0A...............................charv%(len+4
).:#3D.#23x80+((code>>.6)&#23x3F).//.10xxxxxx#0A...
............................charv%(len+5).:#3D.#23x
80+(.code.....&#23x3F).//.10xxxxxx#0A..............
.................len.:#3D.len.+.5#0A...............
................LOOP#0A............................
.}#0A.............................IF.code<#3D#23x7F
FF_FFFF.DO#0A.............................{.IF.len>
#3D250.DO.synerr("Bad.string.constant")#0A.........
......................charv%(len+1).:#3D.#23b1111_1
100+(code>>30).//.1111110x#0A......................
.........charv%(len+2).:#3D.#23x80+((code>>24)&#23x
3F).//.10xxxxxx#0A...............................ch
arv%(len+3).:#3D.#23x80+((code>>18)&#23x3F).//.10xx
xxxx#0A...............................charv%(len+4)
.:#3D.#23x80+((code>>12)&#23x3F).//.10xxxxxx#0A....
...........................charv%(len+5).:#3D.#23x8
0+((code>>.6)&#23x3F).//.10xxxxxx#0A...............
................charv%(len+6).:#3D.#23x80+(.code...
..&#23x3F).//.10xxxxxx#0A..........................
.....len.:#3D.len.+.6#0A...........................
....LOOP#0A.............................}#0A.......
......................synerr("Bad.Unicode.character
")#0A...........................}#0A...............
.....}#0A...............ELSE.{.//.Not.a.Unicode.cha
racter#0A......................IF.len#3D255.DO.syne
rr("Bad.string.constant")#0A......................l
en.:#3D.len.+.1#0A......................charv%len.:
#3D.code#0A....................}#0A.............}#0A
.#0A.............charv%0.:#3D.len#0A.............wo
rdnode.:#3D.newvec(len/bytesperword+2)#0A..........
...h1!wordnode.:#3D.s_string#0A.............FOR.i.#3D
.0.TO.len.DO.(@h2!wordnode)%i.:#3D.charv%i#0A......
.......token.:#3D.s_string#0A.............BREAK#0A.
.........}#0A.#0A......CASE.'*'':#0A..............r
ch()#0A..............encoding.:#3D.defaultencoding#0A
..............decval.:#3D.rdstrch()#0A.............
.token.:#3D.s_number#0A..............UNLESS.ch#3D'*
''.DO.synerr("Bad.character.constant")#0A..........
....BREAK#0A.#0A.#0A......CASE.endstreamch:#0A.....
.........IF.getstreams.DO#0A..............{.//.Retu
rn.from.a.'GET'.stream#0A................LET.p.#3D.
getstreams#0A................endread()#0A..........
......ch...........:#3D.h4!getstreams#0A...........
.....lineno.......:#3D.h3!getstreams#0A............
....sourcestream.:#3D.h2!getstreams#0A.............
...getstreams...:#3D.h1!getstreams#0A..............
..freevec(p).//.Free.the.GET.node#0A...............
.selectinput(sourcestream)#0A................LOOP#0A
..............}#0A..............//.endstreamch.#3D>
.EOF.only.at.outermost.GET.level.#0A..............t
oken.:#3D.s_eof#0A..............RETURN#0A....}#0A..
}.REPEAT#0A.#0A..rch()#0A}#0A.#0ALET.lookupword(wor
d).#3D.VALOF#0A{.LET.len,.i.#3D.word%0,.0#0A..LET.h
ashval.#3D.19609.//.This.and.31397.are.primes#2E#0A
..FOR.j.#3D.0.TO.len.DO.hashval.:#3D.(hashval.NEQV.
word%j).*.31397#0A..hashval.:#3D.(hashval>>1).REM.n
ametablesize#0A#0A..wordnode.:#3D.nametable!hashval
#0A.#0A..UNTIL.wordnode#3D0.|.i>len.TEST.(@h3!wordn
ode)%i#3Dword%i#0A...........................THEN.i
.:#3D.i+1#0A...........................ELSE.wordnod
e,.i.:#3D.h2!wordnode,.0#0A.#0A..UNLESS.wordnode.DO
#0A..{.wordnode.:#3D.newvec(len/bytesperword+2)#0A.
...h1!wordnode,.h2!wordnode.:#3D.s_name,.nametable!
hashval#0A....FOR.i.#3D.0.TO.len.DO.(@h3!wordnode)%
i.:#3D.word%i#0A....nametable!hashval.:#3D.wordnode
#0A..}#0A.#0A..RESULTIS.h1!wordnode#0A}#0A.#0AAND.d
sw(word,.sym).BE.{.lookupword(word);.h1!wordnode.:#3D
.sym..}#0A.#0AAND.declsyswords().BE#0A{.dsw("AND",.
s_and)#0A..dsw("ABS",.s_abs)#0A..dsw("BE",.s_be)#0A
..dsw("BREAK",.s_break)#0A..dsw("BY",.s_by)#0A..dsw
("CASE",.s_case)#0A..dsw("DO",.s_do)#0A..dsw("DEFAU
LT",.s_default)#0A..dsw("EQ",.s_eq)#0A..dsw("EQV",.
s_eqv)#0A..dsw("ELSE",.s_else)#0A..dsw("ENDCASE",.s
_endcase)#0A..dsw("FALSE",.s_false)#0A..dsw("FOR",.
s_for)#0A..dsw("FINISH",.s_finish)#0A..dsw("GOTO",.
s_goto)#0A..dsw("GE",.s_ge)#0A..dsw("GR",.s_gr)#0A.
.dsw("GLOBAL",.s_global)#0A..dsw("GET",.s_get)#0A..
dsw("IF",.s_if)#0A..dsw("INTO",.s_into)#0A..dsw("LE
T",.s_let)#0A..dsw("LV",.s_lv)#0A..dsw("LE",.s_le)#0A
..dsw("LS",.s_ls)#0A..dsw("LOGOR",.s_logor)#0A..dsw
("LOGAND",.s_logand)#0A..dsw("LOOP",.s_loop)#0A..ds
w("LSHIFT",.s_lshift)#0A..dsw("MANIFEST",.s_manifes
t)#0A..dsw("MOD",.s_rem)#0A..dsw("NE",.s_ne)#0A..ds
w("NEEDS",.s_needs)#0A..dsw("NEQV",.s_neqv)#0A..dsw
("NOT",.s_not)#0A..dsw("OF",.s_of).................
..//.Inserted.11/7/01#0A..dsw("OR",.s_else)#0A..dsw
("RESULTIS",.s_resultis)#0A..dsw("RETURN",.s_return
)#0A..dsw("REM",.s_rem)#0A..dsw("RSHIFT",.s_rshift)
#0A..dsw("RV",.s_rv)#0A..dsw("REPEAT",.s_repeat)#0A
..dsw("REPEATWHILE",.s_repeatwhile)#0A..dsw("REPEAT
UNTIL",.s_repeatuntil)#0A..dsw("SECTION",.s_section
)#0A..dsw("SKIP",.s_skip)...............//.Added.22
/6/05#0A..dsw("SLCT",.s_slct)...............//.Inse
rted.11/7/01#0A..dsw("STATIC",.s_static)#0A..dsw("S
WITCHON",.s_switchon)#0A..dsw("TO",.s_to)#0A..dsw("
TEST",.s_test)#0A..dsw("TRUE",.s_true)#0A..dsw("THE
N",.s_do)#0A..dsw("TABLE",.s_table)#0A..dsw("UNLESS
",.s_unless)#0A..dsw("UNTIL",.s_until)#0A..dsw("VEC
",.s_vec)#0A..dsw("VALOF",.s_valof)#0A..dsw("WHILE"
,.s_while)#0A..dsw("XOR",.s_neqv)#0A..dsw("$",.0)#0A
.#0A..nulltag.:#3D.wordnode#0A}.#0A.#0ALET.rch().BE
#0A{.ch.:#3D.rdch()#0A..chcount.:#3D.chcount.+.1#0A
..chbuf%(chcount&63).:#3D.ch#0A}#0A.#0AAND.wrchbuf(
).BE#0A{.writes("*n#2E#2E#2E")#0A..FOR.p.#3D.chcoun
t-63.TO.chcount.DO#0A..{.LET.k.#3D.chbuf%(p&63)#0A.
...IF.0<k<255.DO.wrch(k)#0A..}#0A..newline()#0A}#0A
.#0A.#0AAND.rdtag(ch1).#3D.VALOF#0A{.LET.len.#3D.1#0A
..IF.eqcases.&.'a'<#3Dch1<#3D'z'.DO.ch1.:#3D.ch1.+.
'A'.-.'a'#0A..charv%1.:#3D.ch1#0A.#0A..{.rch()#0A..
..UNLESS.'a'<#3Dch<#3D'z'.|.'A'<#3Dch<#3D'Z'.|#0A..
.........'0'<#3Dch<#3D'9'.|.ch#3D'#2E'.|.ch#3D'_'.B
REAK#0A....IF.eqcases.&.'a'<#3Dch<#3D'z'.DO.ch.:#3D
.ch.+.'A'.-.'a'#0A....len.:#3D.len+1#0A....charv%le
n.:#3D.ch#0A..}.REPEAT#0A.#0A..charv%0.:#3D.len#0A.
.RESULTIS.charv#0A}#0A#0AAND.catstr(s1,.s2).#3D.VAL
OF#0A//.Concatenate.strings.s1.and.s2.leaving.the.r
esult.in.s1#2E#0A//.s1.is.assumed.to.be.able.to.hol
d.a.string.of.length.255#2E#0A//.The.resulting.stri
ng.is.truncated.to.length.255,.if.necessary#2E.#0A{
.LET.len.#3D.s1%0#0A..LET.n.#3D.len#0A..FOR.i.#3D.1
.TO.s2%0.DO#0A..{.n.:#3D.n+1#0A....IF.n>255.BREAK#0A
....s1%n.:#3D.s2%i#0A..}#0A..s1%0.:#3D.n#0A}.#0A.#0A
AND.performget().BE#0A{.LET.stream.#3D.?#0A..LET.le
n.#3D.0#0A..lex()#0A..UNLESS.token#3Ds_string.DO.sy
nerr("Bad.GET.directive")#0A..len.:#3D.charv%0#0A#0A
..//.Append.#2Eh.to.the.GET.filename.does.not.end.i
n.#2Eh.or.#2Eb#0A..UNLESS.len>#3D2.&.charv%(len-1)#3D
'#2E'.&.#0A.........(charv%len#3D'h'.|.charv%len#3D
'b').DO#0A..{.len.:#3D.len+2#0A....charv%0,.charv%(
len-1),.charv%len.:#3D.len,.'#2E',.'h'#0A..}#0A#0A.
.//.Treat.filenames.like.sys:xxx.as.sys/xxx.--.depr
ecated.feature.#0A..FOR.i.#3D.1.TO.charv%0.IF.charv
%i#3D':'.DO.charv%i.:#3D.'/'#0A#0A..//.First.look.i
n.the.current.directory#0A..//writef("Searching.for
.*"%s*".in.the.current.directory*n",.charv)#0A..str
eam.:#3D.findinput(charv)#0A#0A..//.Then.try.the.he
aders.directories#0A..//UNLESS.stream.DO.writef("Se
arching.for.*"%s*".in.%s*n",.charv,.hdrs)#0A..//.Th
e.value.of.hdrs.is.typically:.#2E#2E#2E#2E#2E/BCPL/
cintcode/g#0A..UNLESS.stream.DO.stream.:#3D.pathfin
dinput(charv,.hdrs)#0A#0A..//.Finally.prepend.g/.an
d.lookup.in.the.system.root.directory#0A..UNLESS.st
ream.DO#0A..{.LET.filename.#3D.VEC.256/bytesperword
#0A....filename%0.:#3D.0#0A....catstr(filename,."g/
")#0A....catstr(filename,.charv)#0A....//writef("Se
arching.for.*"%s*".in.%s*n",.filename,.rootnode!rtn
_rootvar)#0A....//.The.value.of.rootvar.is.typicall
y:.#2E#2E#2E#2E#2E/BCPL/cintcode#0A....stream.:#3D.
pathfindinput(filename,.rootnode!rtn_rootvar)#0A..}
#0A#0A..UNLESS.stream.DO#0A..{.synerr("Unable.to.fi
nd.GET.file.%s",.charv)#0A....RETURN#0A..}#0A#0A..I
F.sourcefileno>#3Dsourcefileupb.DO#0A..{.synerr("To
o.many.GET.files")#0A....RETURN#0A..}#0A#0A..{.LET.
len.#3D.charv%0#0A....LET.node.#3D.getvec(3)..//.Fr
eed.at.end.of.GET.insertion#0A....LET.str..#3D.getv
ec(len/bytesperword).//.Freed.at.end.of.compilation
#0A#0A....UNLESS.node.&.str.DO#0A....{.IF.node.DO.f
reevec(node)#0A......IF.str..DO.freevec(str)#0A....
..synerr("getvec.failure.in.performget")#0A....}#0A
....FOR.i.#3D.0.TO.len.DO.str%i.:#3D.charv%i#0A....
sourcefileno.:#3D.sourcefileno+1#0A....sourcenamev!
sourcefileno.:#3D.str#0A//sawritef("performget:.fil
e.%n.is.%s*n",.sourcefileno,.str)#0A....node!0,.nod
e!1,.node!2,.node!3.:#3D.getstreams,.sourcestream,.
lineno,.ch#0A....getstreams.:#3D.node#0A..}#0A..sou
rcestream.:#3D.stream#0A..selectinput(sourcestream)
#0A..lineno.:#3D.(sourcefileno<<20).+.1#0A..rch()#0A
}#0A.#0AAND.readnumber(radix,.digs).#3D.VALOF#0A//.
Read.a.binary,.octal,.decimal.or.hexadecimal.unsign
ed.number#0A//.with.between.1.and.digs.digits#2E.Un
derlines.are.allowed#2E#0A//.This.function.is.used.
for.numerical.constants.and.numerical#0A//.escapes.
in.string.and.character.constants#2E#0A{.LET.i,.res
.#3D.0,.0#0A.#0A..{.UNLESS.ch#3D'_'.DO.//.ignore.un
derlines#0A....{.LET.d.#3D.value(ch)#0A......IF.d>#3D
radix.BREAK#0A......i.:#3D.i+1.......//.Increment.c
ount.of.digits#0A......res.:#3D.radix*res.+.d#0A...
.}#0A....rch()#0A..}.REPEATWHILE.i<digs#0A#0A..UNLE
SS.i.DO.synerr("Bad.number")#0A..RESULTIS.res#0A}#0A
.#0A.#0AAND.value(ch).#3D.'0'<#3Dch<#3D'9'.->.ch-'0
',#0A................'A'<#3Dch<#3D'F'.->.ch-'A'+10,
#0A................'a'<#3Dch<#3D'f'.->.ch-'a'+10,#0A
................100#0A.#0AAND.rdstrch().#3D.VALOF#0A
{.//.Return.the.integer.code.for.the.next.string.ch
aracter#0A..//.Set.result2#3DTRUE.if.*#23.character
.code.was.found,.otherwise.FALSE#0A..LET.k.#3D.ch#0A
#0A..IF.k#3D'*n'.|.k#3D'*p'.DO#0A..{.lineno.:#3D.li
neno+1#0A....synerr("Unescaped.newline.character")#0A
..}#0A.#0A..IF.k#3D'**'.DO#0A..{.rch()#0A....k.:#3D
.ch#0A....IF.'a'<#3Dk<#3D'z'.DO.k.:#3D.k.+.'A'.-.'a
'#0A....SWITCHON.k.INTO#0A....{.CASE.'*n':#0A......
CASE.'*c':#0A......CASE.'*p':#0A......CASE.'*s':#0A
......CASE.'*t':.WHILE.ch#3D'*n'.|.ch#3D'*c'.|.ch#3D
'*p'.|.ch#3D'*s'.|.ch#3D'*t'.DO#0A.................
{.IF.ch#3D'*n'.DO.lineno.:#3D.lineno+1#0A..........
.........rch()#0A.................}#0A.............
....IF.ch#3D'**'.DO.{.rch();.LOOP..}#0A#0A......DEF
AULT:...synerr("Bad.string.or.character.constant,.c
h#3D%n",.ch)#0A.........#0A......CASE.'**':#0A.....
.CASE.'*'':#0A......CASE.'"':....................EN
DCASE#0A.........#0A......CASE.'T':..k.:#3D.c_tab;.
......ENDCASE#0A......CASE.'S':..k.:#3D.c_space;...
..ENDCASE#0A......CASE.'N':..k.:#3D.c_newline;...EN
DCASE#0A......CASE.'E':..k.:#3D.c_escape;....ENDCAS
E#0A......CASE.'B':..k.:#3D.c_backspace;.ENDCASE#0A
......CASE.'P':..k.:#3D.c_newpage;...ENDCASE#0A....
..CASE.'C':..k.:#3D.c_return;....ENDCASE#0A........
.#0A......CASE.'X':..//.*xhh..--.A.character.escape
.in.hexadecimal#0A.................rch()#0A........
.........k.:#3D.readnumber(16,2)#0A................
.result2.:#3D.FALSE#0A.................RESULTIS.k#0A
#0A......CASE.'#23':..//.*#23u...set.UTF8.mode#0A..
...............//.*#23g...set.GB2312.mode#0A.......
..........//.In.UTF8.mode#0A.................//....
.*#23hhhh.or.*#23#23hhhhhhhh..--.a.Unicode.characte
r#0A.................//.In.GB2312#0A...............
..//.....*#23dddd.................--.A.GB2312.code#0A
...............{.LET.digs.#3D.4#0A.................
rch()#0A.................IF.ch#3D'u'.|.ch#3D'U'.DO.
{.encoding.:#3D.UTF8;...rch();.LOOP.}#0A...........
......IF.ch#3D'g'.|.ch#3D'G'.DO.{.encoding.:#3D.GB2
312;.rch();.LOOP.}#0A.................TEST.encoding
#3DGB2312#0A.................THEN.{.#0A............
............k.:#3D.readnumber(10,.digs)#0A//sawrite
f("rdstrch:.GB2312:.%i4*n",.k)#0A..................
....}#0A.................ELSE.{.IF.ch#3D'#23'.DO.{.
rch();.digs.:#3D.8.}#0A........................k.:#3D
.readnumber(16,.digs)#0A//sawritef("rdstrch:.Unicod
e:.%x4*n",.k)#0A......................}#0A.........
........result2.:#3D.TRUE#0A.................RESULT
IS.k#0A...............}#0A#0A......CASE.'0':CASE.'1
':CASE.'2':CASE.'3':CASE.'4':#0A......CASE.'5':CASE
.'6':CASE.'7':#0A.................//.*ooo.--.A.char
acter.escape.in.octal.#0A.................k.:#3D.re
adnumber(8,3)#0A.................IF.k>255.DO.#0A...
....................synerr("Bad.string.or.character
.constant")#0A.................result2.:#3D.FALSE#0A
.................RESULTIS.k#0A....}#0A..}#0A...#0A.
.rch()#0A..result2.:#3D.FALSE#0A..RESULTIS.k#0A}.RE
PEAT#0A#0ALET.newvec(n).#3D.VALOF#0A{.treep.:#3D.tr
eep.-.n.-.1;#0A..IF.treep<#3Dtreevec.DO#0A..{.errma
x.:#3D.0..//.Make.it.fatal#0A....synerr("More.works
pace.needed")#0A..}#0A..RESULTIS.treep#0A}#0A.#0AAN
D.mk1(x).#3D.VALOF#0A{.LET.p.#3D.newvec(0)#0A..p!0.
:#3D.x#0A..RESULTIS.p#0A}#0A.#0AAND.mk2(x,.y).#3D.V
ALOF#0A{.LET.p.#3D.newvec(1)#0A..p!0,.p!1.:#3D.x,.y
#0A..RESULTIS.p#0A}#0A.#0AAND.mk3(x,.y,.z).#3D.VALO
F#0A{.LET.p.#3D.newvec(2)#0A..p!0,.p!1,.p!2.:#3D.x,
.y,.z#0A..RESULTIS.p#0A}#0A.#0AAND.mk4(x,.y,.z,.t).
#3D.VALOF#0A{.LET.p.#3D.newvec(3)#0A..p!0,.p!1,.p!2
,.p!3.:#3D.x,.y,.z,.t#0A..RESULTIS.p#0A}#0A.#0AAND.
mk5(x,.y,.z,.t,.u).#3D.VALOF#0A{.LET.p.#3D.newvec(4
)#0A..p!0,.p!1,.p!2,.p!3,.p!4.:#3D.x,.y,.z,.t,.u#0A
..RESULTIS.p#0A}#0A.#0AAND.mk6(x,.y,.z,.t,.u,.v).#3D
.VALOF#0A{.LET.p.#3D.newvec(5)#0A..p!0,.p!1,.p!2,.p
!3,.p!4,.p!5.:#3D.x,.y,.z,.t,.u,.v#0A..RESULTIS.p#0A
}#0A.#0AAND.mk7(x,.y,.z,.t,.u,.v,.w).#3D.VALOF#0A{.
LET.p.#3D.newvec(6)#0A..p!0,.p!1,.p!2,.p!3,.p!4,.p!
5,.p!6.:#3D.x,.y,.z,.t,.u,.v,.w#0A..RESULTIS.p#0A}#0A
.#0AAND.formtree().#3D..VALOF#0A{.LET.res.#3D.0#0A#0A
..nametablesize.:#3D.541#0A#0A..charv......:#3D.new
vec(256/bytesperword).....#0A..nametable..:#3D.newv
ec(nametablesize).#0A..FOR.i.#3D.0.TO.nametablesize
.DO.nametable!i.:#3D.0#0A..skiptag.:#3D.0#0A..decls
yswords()#0A.#0A..rec_p,.rec_l.:#3D.level(),.rec#0A
.#0A..token,.decval.:#3D.0,.0#0A#0A..lex()#0A//sawr
itef("formtree:.token#3D%n.cis#3D%n*n",.token,.cis)
#0A..IF.token#3Ds_query.DO............//.For.debugg
ing.lex#2E#0A..{.lex()#0A....writef("token.#3D%i3.l
n#3D%i5.%12t..decval.#3D.%i8...charv.#3D.%s*n",#0A.
...........token,.lineno&#23xFFFFF,.opname(token),.
decval,........charv)#0A....IF.token#3Ds_eof.RESULT
IS.0#0A..}.REPEAT#0A#0Arec:res.:#3D.token#3Ds_secti
on.->.rprog(s_section),#0A...........token#3Ds_need
s...->.rprog(s_needs),.rdblockbody(TRUE)#0A//sawrit
ef("section.ended.with.%s*n",.opname(token))#0A..UN
LESS.token#3Ds_dot.|.token#3Ds_eof.DO.synerr("Incor
rect.termination")#0A.#0A..RESULTIS.res#0A}#0A.#0AA
ND.rprog(thing).#3D.VALOF#0A{.LET.a.#3D.0#0A..lex()
#0A..a.:#3D.rbexp()#0A..UNLESS.h1!a#3Ds_string.DO.s
ynerr("Bad.SECTION.or.NEEDS.name")#0A..RESULTIS.mk3
(thing,.a,#0A.................token#3Ds_needs.->.rp
rog(s_needs),#0A.................................rd
blockbody(TRUE)).//.TRUE#3Doutmost.level#0A}#0A.#0A
.#0AAND.synerr(mess,.a).BE#0A{.LET.fno.#3D.lineno>>
20#0A..LET.ln.#3D.lineno.&.#23xFFFFF#0A..LET.filena
me.#3D.sourcenamev!fno#0A..errcount.:#3D.errcount.+
.1#0A..writef("*nError.near.")#0A..IF.filename.DO.w
ritef("%s",.filename)#0A..writef("[%n]:..",.ln)#0A.
.writef(mess,.a)#0A..wrchbuf()#0A..IF.errcount.>.er
rmax.DO#0A..{.writes("*nCompilation.aborted*n")#0A.
...longjump(fin_p,.fin_l)#0A..}#0A..nlpending.:#3D.
FALSE#0A.#0A..UNTIL.token#3Ds_lsect.|.token#3Ds_rse
ct.|#0A........token#3Ds_let.|.token#3Ds_and.|#0A..
......token#3Ds_dot.|.token#3Ds_eof.|.nlpending.DO.
lex()#0A#0A..IF.token#3Ds_and.DO.token.:#3D.s_let#0A
..longjump(rec_p,.rec_l)#0A}#0A.#0ALET.rdblockbody(
outerlevel).#3D.VALOF#0A{.LET.p,.l.#3D.rec_p,.rec_l
#0A..LET.a,.ln.#3D.0,.?#0A.#0A..rec_p,.rec_l.:#3D.l
evel(),.recover#0A#0Arecover:..#0A..IF.token#3Ds_se
micolon.DO.lex()#0A.#0A..ln.:#3D.lineno#0A...#0A..S
WITCHON.token.INTO#0A..{.CASE.s_manifest:#0A....CAS
E.s_static:#0A....CASE.s_global:#0A..............{.
LET.op.#3D.token#0A................lex()#0A........
........a.:#3D.rdsect(rdcdefs,.op#3Ds_global->s_col
on,s_eq)#0A................a.:#3D.mk4(op,.a,.rdbloc
kbody(outerlevel),.ln)#0A................ENDCASE#0A
..............}#0A.#0A.#0A....CASE.s_let:.lex()#0A.
...............a.:#3D.rdef(outerlevel)#0A..........
......WHILE.token#3Ds_and.DO#0A................{.LE
T.ln1.#3D.lineno#0A..................lex()#0A......
............a.:#3D.mk4(s_and,.a,.rdef(outerlevel),.
ln1)#0A................}#0A................a.:#3D.m
k4(s_let,.a,.rdblockbody(outerlevel),.ln)#0A.......
.........ENDCASE#0A.#0A....DEFAULT:....IF.outerleve
l.DO#0A................{.errmax.:#3D.0.//.Make.it.f
atal#2E#0A..................synerr("Bad.outer.level
.declaration")#0A................}#0A..............
..a.:#3D.rdseq()#0A................UNLESS.token#3Ds
_rsect.DO.synerr("Error.in.command")#0A.#0A....CASE
.s_rsect:IF.outerlevel.DO.lex()#0A....CASE.s_dot:#0A
....CASE.s_eof:#0A..}#0A.#0A..rec_p,.rec_l.:#3D.p,.
l#0A..RESULTIS.a#0A}#0A.#0AAND.rdseq().#3D.VALOF#0A
{.LET.a.#3D.0#0A...IF.token#3Ds_semicolon.DO.lex()#0A
...a.:#3D.rcom()#0A...IF.token#3Ds_rsect.|.token#3D
s_dot.|.token#3Ds_eof.RESULTIS.a#0A...RESULTIS.mk3(
s_seq,.a,.rdseq())#0A}#0A#0AAND.rdcdefs(sep).#3D.VA
LOF#0A{.LET.res,.id.#3D.0,.0#0A...LET.ptr.#3D.@res#0A
...LET.p,.l.#3D.rec_p,.rec_l#0A...LET.kexp.#3D.0#0A
#0A.#0A...{.LET.ln.#3D.lineno#0A......rec_p,.rec_l.
:#3D.level(),.recov#0A......kexp.:#3D.0#0A......id.
:#3D.rname()#0A......IF.token#3Dsep.DO.kexp.:#3D.rn
exp(0)#0A......!ptr.:#3D.mk5(s_constdef,.0,.id,.kex
p,.ln)#0A......ptr.:#3D.@h2!(!ptr)#0A#0Arecov:IF.to
ken#3Ds_semicolon.DO.lex()#0A...}.REPEATWHILE.token
#3Ds_name#0A.#0A...rec_p,.rec_l.:#3D.p,.l#0A...RESU
LTIS.res#0A}#0A.#0AAND.rdsect(r,.arg).#3D.VALOF#0A/
/.Used.only.for.MANIFEST,.STATIC.and.GLOBAL.declara
tions,#0A//.SWITCHON.commands.and.blocks#2E#0A{.LET
.tag,.res.#3D.wordnode,.0#0A...UNLESS.token#3Ds_lse
ct.DO.synerr("'{'.or.'$('.expected")#0A...lex()#0A.
..UNLESS.token#3Ds_rsect.DO.res.:#3D.r(arg).//.Allo
w.{.}..MR.22/6/05#0A...UNLESS.token#3Ds_rsect.DO.sy
nerr("'}'.or.'$)'.expected")#0A...TEST.tag#3Dwordno
de.THEN.lex()#0A.....................ELSE.IF.wordno
de#3Dnulltag.DO#0A..........................{.token
.:#3D.0#0A............................synerr("Untag
ged.'$)'.mismatch")#0A..........................}#0A
...//.res#3D0.for.empty.section.brackets.{.}#0A...R
ESULTIS.res#0A}#0A#0AAND.rnamelist().#3D.VALOF#0A{.
LET.a.#3D.rname()#0A...UNLESS.token#3Ds_comma.RESUL
TIS.a#0A...lex()#0A...RESULTIS.mk3(s_comma,.a,.rnam
elist())#0A}#0A#0AAND.rname().#3D.VALOF#0A{.LET.a.#3D
.wordnode#0A...UNLESS.token#3Ds_name.DO.synerr("Nam
e.expected")#0A...lex()#0A...RESULTIS.a#0A}#0A.#0AL
ET.rbexp().#3D.VALOF#0A{.LET.a,.op.#3D.0,.token#0A.
#0A...SWITCHON.token.INTO#0A.#0A...{.DEFAULT:.syner
r("Error.in.expression")#0A#0A......CASE.s_query:..
lex()#0A.....................RESULTIS.mk1(s_query)#0A
.#0A......CASE.s_true:#0A......CASE.s_false:#0A....
..CASE.s_name:#0A......CASE.s_string:.a.:#3D.wordno
de#0A.....................lex()#0A.................
....RESULTIS.a#0A.#0A......CASE.s_number:.a.:#3D.mk
2(s_number,.decval)#0A.....................lex()#0A
.....................RESULTIS.a#0A#0A......CASE.s_s
lct:.{.LET.len,.sh,.offset.#3D.0,.0,.0..//.Inserted
.11/7/01#0A#0A.....................//.Allow...SLCT.
offset#0A.....................//.or......SLCT.sh:of
fset#0A.....................//.or......SLCT.len:sh:
offset#0A#0A.....................offset.:#3D.rnexp(
0)#0A#0A.....................IF.token#3Ds_colon.DO#0A
.....................{.sh.:#3D.offset#0A...........
............offset.:#3D.rnexp(0)#0A................
.....}#0A.....................IF.token#3Ds_colon.DO
#0A.....................{.len.:#3D.sh#0A...........
............sh.:#3D.offset#0A......................
.offset.:#3D.rnexp(0)#0A.....................}#0A#0A
.....................RESULTIS.mk4(s_slct,.len,.sh,.
offset)#0A...................}#0A.#0A......CASE.s_l
paren:.a.:#3D.rnexp(0)#0A.....................UNLES
S.token#3Ds_rparen.DO.synerr("')'.missing")#0A.....
................lex()#0A.....................RESULT
IS.a#0A.#0A......CASE.s_valof:..lex()#0A...........
..........RESULTIS.mk2(s_valof,.rcom())#0A.#0A.....
.CASE.s_vecap:..op.:#3D.s_rv#0A......CASE.s_lv:#0A.
.....CASE.s_rv:.....RESULTIS.mk2(op,.rnexp(7))#0A.#0A
......CASE.s_plus:...RESULTIS.rnexp(5)#0A.#0A......
CASE.s_minus:..a.:#3D.rnexp(5)#0A..................
...TEST.h1!a#3Ds_number.THEN.h2!a.:#3D.-.h2!a#0A...
.....................................ELSE.a.:#3D.mk
2(s_neg,.a)#0A.....................RESULTIS.a#0A.#0A
......CASE.s_abs:....RESULTIS.mk2(s_abs,.rnexp(5))#0A
.#0A......CASE.s_not:....RESULTIS.mk2(s_not,.rnexp(
3))#0A.#0A......CASE.s_table:..lex()#0A............
.........RESULTIS.mk2(s_table,.rexplist())#0A..}#0A
}#0A.#0AAND.rnexp(n).#3D.VALOF.{.lex();.RESULTIS.re
xp(n).}#0A.#0AAND.rexp(n).#3D.VALOF#0A{.LET.a,.b,.p
.#3D.rbexp(),.0,.0#0A#0A...UNTIL.nlpending.DO.#0A..
.{.LET.op.#3D.token#0A.#0A......SWITCHON.op.INTO#0A
.#0A......{.DEFAULT:.......RESULTIS.a#0A.#0A.......
..CASE.s_lparen:.lex()#0A........................b.
:#3D.0#0A........................UNLESS.token#3Ds_r
paren.DO.b.:#3D.rexplist()#0A......................
..UNLESS.token#3Ds_rparen.DO.synerr("')'.missing")#0A
........................lex()#0A...................
.....a.:#3D.mk4(s_fnap,.a,.b,.0)#0A................
........LOOP#0A.#0A.........CASE.s_mthap:{.LET.e1.#3D
.0#0A.........................lex()#0A.............
............UNLESS.token#3Ds_lparen.DO.synerr("'('.
missing")#0A.........................lex()#0A......
...................b.:#3D.0#0A.....................
....UNLESS.token#3Ds_rparen.DO.b.:#3D.rexplist()#0A
.........................IF.b#3D0.DO.synerr("argume
nt.expression.missing")#0A.........................
UNLESS.token#3Ds_rparen.DO.synerr("')'.missing")#0A
.........................lex()#0A..................
.......TEST.h1!b#3Ds_comma#0A......................
...THEN.e1.:#3D.h2!b#0A.........................ELS
E.e1.:#3D.b#0A.........................a.:#3D.mk3(s
_vecap,.mk2(s_rv,.e1),.a)#0A.......................
..a.:#3D.mk4(s_fnap,.a,.b,.0)#0A...................
......LOOP#0A......................}#0A.#0A........
.CASE.s_sbra:...b.:#3D.rnexp(0)...//.Inserted.11/6/
02#0A........................UNLESS.token#3Ds_sket.
DO.synerr("']'.missing")#0A........................
lex()#0A........................a.:#3D.mk3(s_vecap,
.a,.b)#0A........................LOOP#0A.#0A.......
..CASE.s_of:.....p.:#3D.8;.ENDCASE.//.Inserted.11/7
/01#0A#0A.........CASE.s_vecap:..p.:#3D.8;.ENDCASE#0A
.........CASE.s_byteap:.p.:#3D.8;.ENDCASE.//.Change
d.from.7.on.16.Dec.1999#0A.........CASE.s_mult:#0A.
........CASE.s_div:#0A.........CASE.s_rem:....p.:#3D
.6;.ENDCASE#0A.........CASE.s_plus:#0A.........CASE
.s_minus:..p.:#3D.5;.ENDCASE#0A.#0A.........CASE.s_
eq:CASE.s_le:CASE.s_ls:#0A.........CASE.s_ne:CASE.s
_ge:CASE.s_gr:#0A........................IF.n>#3D4.
RESULTIS.a#0A........................b.:#3D.rnexp(4
)#0A........................a.:#3D.mk3(op,.a,.b)#0A
........................WHILE..s_eq<#3Dtoken<#3Ds_g
e.DO#0A........................{.LET.c.#3D.b#0A....
.......................op.:#3D.token#0A............
...............b.:#3D.rnexp(4)#0A..................
.........a.:#3D.mk3(s_logand,.a,.mk3(op,.c,.b))#0A.
.......................}#0A........................
LOOP#0A.#0A.........CASE.s_lshift:#0A.........CASE.
s_rshift:.IF.n>#3D4.RESULTIS.a#0A..................
......a.:#3D.mk3(op,.a,.rnexp(4))#0A...............
.........LOOP#0A#0A.........CASE.s_logand:.p.:#3D.3
;.ENDCASE#0A.........CASE.s_logor:..p.:#3D.2;.ENDCA
SE#0A.........CASE.s_eqv:#0A.........CASE.s_neqv:..
.p.:#3D.1;.ENDCASE#0A.#0A.........CASE.s_cond:...IF
.n>#3D1.RESULTIS.a#0A........................b.:#3D
.rnexp(0)#0A........................UNLESS.token#3D
s_comma.DO#0A...............................synerr(
"Bad.conditional.expression")#0A...................
.....a.:#3D.mk4(s_cond,.a,.b,.rnexp(0))#0A.........
...............LOOP#0A......}#0A......#0A......IF.n
>#3Dp.RESULTIS.a#0A......a.:#3D.mk3(op,.a,.rnexp(p)
)#0A...}#0A...#0A...RESULTIS.a#0A}#0A.#0ALET.rexpli
st().#3D.VALOF#0A{.LET.res,.a.#3D.0,.rexp(0)#0A...L
ET.ptr.#3D.@res#0A.#0A...WHILE.token#3Ds_comma.DO.{
.!ptr.:#3D.mk3(s_comma,.a,.0)#0A...................
.........ptr.:#3D.@h3!(!ptr)#0A....................
........a.:#3D.rnexp(0)#0A.........................
}#0A...!ptr.:#3D.a#0A...RESULTIS.res#0A}#0A.#0ALET.
rdef(outerlevel).#3D.VALOF#0A{.LET.n.#3D.rnamelist(
)#0A...LET.ln.#3D.lineno#0A#0A...SWITCHON.token.INT
O#0A.#0A...{.CASE.s_lparen:#0A........{.LET.a.#3D.0
#0A...........lex()#0A...........UNLESS.h1!n#3Ds_na
me.DO.synerr("Bad.formal.parameter")#0A...........I
F.token#3Ds_name.DO.a.:#3D.rnamelist()#0A..........
.UNLESS.token#3Ds_rparen.DO.synerr("')'.missing")#0A
...........lex()#0A.#0A...........IF.token#3Ds_be.D
O#0A...........{.lex()#0A..............RESULTIS.mk6
(s_rtdef,.n,.a,.rcom(),.0,.ln)#0A...........}#0A.#0A
...........IF.token#3Ds_eq.RESULTIS.mk6(s_fndef,.n,
.a,.rnexp(0),.0,.ln)#0A.#0A...........synerr("Bad.p
rocedure.heading")#0A........}#0A.#0A......DEFAULT:
.synerr("Bad.declaration")#0A.#0A......CASE.s_eq:#0A
...........IF.outerlevel.DO.synerr("Bad.outer.level
.declaration")#0A...........lex()#0A...........IF.t
oken#3Ds_vec.DO#0A...........{.UNLESS.h1!n#3Ds_name
.DO.synerr("Name.required.before.#3D.VEC")#0A......
........RESULTIS.mk4(s_vecdef,.n,.rnexp(0),.ln)#0A.
..........}#0A...........RESULTIS.mk4(s_valdef,.n,.
rexplist(),.ln)#0A...}#0A}#0A.#0ALET.rbcom().#3D.VA
LOF#0A{.LET.a,.b,.op,.ln.#3D.0,.0,.token,.lineno#0A
.#0A..SWITCHON.token.INTO#0A..{.DEFAULT:.RESULTIS.0
#0A.#0A....CASE.s_name:CASE.s_number:CASE.s_string:
CASE.s_lparen:#0A....CASE.s_true:CASE.s_false:CASE.
s_lv:CASE.s_rv:CASE.s_vecap:#0A....CASE.s_slct:....
....//.Inserted.11/7/01#0A....CASE.s_plus:CASE.s_mi
nus:CASE.s_abs:CASE.s_not:#0A....CASE.s_table:CASE.
s_valof:CASE.s_query:#0A............//.All.tokens.t
hat.can.start.an.expression#2E#0A............a.:#3D
.rexplist()#0A.#0A............IF.token#3Ds_ass.DO#0A
............{.op.:#3D.token#0A...............lex()#0A
...............RESULTIS.mk4(op,.a,.rexplist(),.ln)#0A
............}#0A.#0A............IF.token#3Ds_colon.
DO#0A............{.UNLESS.h1!a#3Ds_name.DO.synerr("
Unexpected.':'")#0A...............lex()#0A.........
......RESULTIS.mk5(s_colon,.a,.rbcom(),.0,.ln)#0A..
..........}#0A.#0A............IF.h1!a#3Ds_fnap.DO#0A
............{.h1!a,.h4!a.:#3D.s_rtap,.ln#0A........
.......RESULTIS.a#0A............}#0A.#0A...........
.synerr("Error.in.command")#0A............RESULTIS.
a#0A.#0A....CASE.s_goto:#0A....CASE.s_resultis:#0A.
...........RESULTIS.mk3(op,.rnexp(0),.ln)#0A.#0A...
.CASE.s_if:#0A....CASE.s_unless:#0A....CASE.s_while
:#0A....CASE.s_until:#0A............a.:#3D.rnexp(0)
#0A............IF.token#3Ds_do.DO.lex()#0A.........
...RESULTIS.mk4(op,.a,.rcom(),.ln)#0A.#0A....CASE.s
_test:#0A............a.:#3D.rnexp(0)#0A............
IF.token#3Ds_do.DO.lex()#0A............b.:#3D.rcom(
)#0A............UNLESS.token#3Ds_else.DO.synerr("EL
SE.missing")#0A............lex()#0A............RESU
LTIS.mk5(s_test,.a,.b,.rcom(),.ln)#0A.#0A....CASE.s
_for:#0A.........{.LET.i,.j,.k.#3D.0,.0,.0#0A......
......lex()#0A............a.:#3D.rname()#0A........
....UNLESS.token#3Ds_eq.DO.synerr("'#3D'.missing")#0A
............i.:#3D.rnexp(0)#0A............UNLESS.to
ken#3Ds_to.DO.synerr("TO.missing")#0A............j.
:#3D.rnexp(0)#0A............IF.token#3Ds_by.DO.k.:#3D
.rnexp(0)#0A............IF.token#3Ds_do.DO.lex()#0A
............RESULTIS.mk7(s_for,.a,.i,.j,.k,.rcom(),
.ln)#0A.........}#0A.#0A....CASE.s_skip:#0A....CASE
.s_loop:#0A....CASE.s_break:#0A....CASE.s_return:#0A
....CASE.s_finish:#0A....CASE.s_endcase:#0A........
....lex()#0A............RESULTIS.mk2(op,.ln)#0A.#0A
....CASE.s_switchon:#0A............a.:#3D.rnexp(0)#0A
............UNLESS.token#3Ds_into.DO.synerr("INTO.m
issing")#0A............lex()#0A............{.LET.sk
ipln.#3D.lineno#0A..............b.:#3D.rdsect(rdseq
)#0A..............UNLESS.b.DO#0A................b.:
#3D.mk2(s_skip,.skipln).........//.MR.5/4/06#0A....
........}#0A............RESULTIS.mk4(s_switchon,.a,
.b,.ln)#0A.#0A....CASE.s_case:#0A............a.:#3D
.rnexp(0)#0A............UNLESS.token#3Ds_colon.DO.s
ynerr("Bad.CASE.label")#0A............lex()#0A.....
.......RESULTIS.mk4(s_case,.a,.rbcom(),.ln)#0A.#0A.
...CASE.s_default:#0A............lex()#0A..........
..UNLESS.token#3Ds_colon.DO.synerr("Bad.DEFAULT.lab
el")#0A............lex()#0A............RESULTIS.mk3
(s_default,.rbcom(),.ln)#0A.#0A....CASE.s_lsect:#0A
............a.:#3D.rdsect(rdblockbody,.FALSE)#0A...
.........UNLESS.a.DO#0A..............a.:#3D.mk2(s_s
kip,.ln)........//.MR.5/4/06#0A............RESULTIS
.a#0A..}#0A}#0A#0AAND.rcom().#3D.VALOF#0A{.LET.a.#3D
.rbcom()#0A.#0A...//.Empty.section.brackets.{.}.for
m.SKIP.nodes,.MR.22/6/05#0A...IF.a#3D0.DO.synerr("E
rror.in.command")#0A.#0A...WHILE.token#3Ds_repeat.|
.token#3Ds_repeatwhile.|.token#3Ds_repeatuntil.DO#0A
...{.LET.op,.ln.#3D.token,.lineno#0A......UNLESS.op
#3Ds_repeat.{.a.:#3D.mk4(op,.a,.rnexp(0),.ln);.LOOP
.}#0A......a.:#3D.mk3(op,.a,.ln)#0A......lex()#0A..
.}#0A.#0A...RESULTIS.a#0A}#0A/*#0ALET.plist(x).BE#0A
{.writef("*nName.table.contents,.size.#3D.%n*n",.na
metablesize)#0A...FOR.i.#3D.0.TO.nametablesize-1.DO
#0A...{.LET.p,.n.#3D.nametable!i,.0#0A......UNTIL.p
#3D0.DO.p,.n.:#3D.p!1,.n+1#0A......writef("%i3:%n",
.i,.n)#0A......p.:#3D.nametable!i#0A......UNTIL.p#3D
0.DO.{.writef(".%s",.p+2);.p.:#3D.p!1..}#0A......ne
wline()#0A...}#0A}#0A*/#0ALET.plist(x,.n,.d).BE#0A{
.LET.size,.ln.#3D.0,.0#0A...LET.v.#3D.TABLE.0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0#0A#0A...IF.x#3D0.D
O.{.writes("Nil");.RETURN..}#0A.#0A...SWITCHON.h1!x
.INTO#0A...{.CASE.s_number:.writen(h2!x);.........R
ETURN#0A.#0A......CASE.s_name:...writes(x+2);......
....RETURN#0A.#0A......CASE.s_string:.writef("*"%s*
"",x+1);.RETURN#0A.#0A......CASE.s_for:....size,.ln
.:#3D.6,.h7!x;..ENDCASE#0A.#0A......CASE.s_fndef:CA
SE.s_rtdef:#0A.....................size,.ln.:#3D.4,
.h6!x;..ENDCASE#0A#0A......CASE.s_cond:#0A......CAS
E.s_slct:.......//.Inserted.11/7/01#0A.............
........size.:#3D.4;............ENDCASE#0A.#0A.....
.CASE.s_test:CASE.s_constdef:#0A...................
..size,.ln.:#3D.4,.h5!x;..ENDCASE#0A.#0A......CASE.
s_needs:CASE.s_section:CASE.s_vecap:CASE.s_byteap:C
ASE.s_fnap:#0A......CASE.s_of:..//.Inserted.11/7/01
#0A......CASE.s_mult:CASE.s_div:CASE.s_rem:CASE.s_p
lus:CASE.s_minus:#0A......CASE.s_eq:CASE.s_ne:CASE.
s_ls:CASE.s_gr:CASE.s_le:CASE.s_ge:#0A......CASE.s_
lshift:CASE.s_rshift:CASE.s_logand:CASE.s_logor:#0A
......CASE.s_eqv:CASE.s_neqv:CASE.s_comma:#0A......
CASE.s_seq:#0A.....................size.:#3D.3;....
........ENDCASE#0A.....................#0A......CAS
E.s_valdef:CASE.s_vecdef:#0A.....................si
ze,.ln.:#3D.3,.h4!x;..ENDCASE#0A#0A......CASE.s_col
on:#0A.....................size,.ln.:#3D.3,.h5!x;..
ENDCASE#0A.#0A......CASE.s_and:#0A......CASE.s_ass:
CASE.s_rtap:CASE.s_if:CASE.s_unless:#0A......CASE.s
_while:CASE.s_until:CASE.s_repeatwhile:#0A......CAS
E.s_repeatuntil:#0A......CASE.s_switchon:CASE.s_cas
e:CASE.s_let:#0A......CASE.s_manifest:CASE.s_static
:CASE.s_global:#0A.....................size,.ln.:#3D
.3,.h4!x;..ENDCASE#0A.#0A......CASE.s_valof:CASE.s_
lv:CASE.s_rv:CASE.s_neg:CASE.s_not:#0A......CASE.s_
table:CASE.s_abs:#0A.....................size.:#3D.
2;............ENDCASE#0A.#0A......CASE.s_goto:CASE.
s_resultis:CASE.s_repeat:CASE.s_default:#0A........
.............size,.ln.:#3D.2,.h3!x;..ENDCASE#0A.#0A
......CASE.s_true:CASE.s_false:CASE.s_query:#0A....
.................size.:#3D.1;............ENDCASE#0A
......#0A......CASE.s_skip:.//.MR.22/6/05#0A......C
ASE.s_loop:CASE.s_break:CASE.s_return:#0A......CASE
.s_finish:CASE.s_endcase:#0A.....................si
ze,.ln.:#3D.1,.h2!x;..ENDCASE#0A#0A......DEFAULT:..
.....size.:#3D.1#0A...}#0A.#0A...IF.n#3Dd.DO.{.writ
es("Etc");.RETURN.}#0A.#0A//...writef("Op.%n",.h1!x
)#0A...writef(opname(h1!x),.h1!x)#0A//.IF.ln>0.DO.w
ritef("..line.%n",.ln)#0A...IF.ln>0.DO#0A...{.LET.f
no.#3D.ln>>20#0A.....LET.lno.#3D.ln.&.#23xFFFFF#0A.
....LET.filename.#3D.sourcenamev!fno#0A.....writef(
"..")#0A.....IF.filename.DO.writef("%s",.filename)#0A
.....writef("[%n]",.lno)#0A...}#0A...FOR.i.#3D.2.TO
.size.DO.{.newline()#0A...........................F
OR.j#3D0.TO.n-1.DO.writes(.v!j.)#0A................
...........writes("**-")#0A........................
...v!n.:#3D.i#3Dsize->"..","!."#0A.................
..........plist(h1!(x+i-1),.n+1,.d)#0A.............
...........}#0A}#0A.#0AAND.opname(op).#3D.VALOF.SWI
TCHON.op.INTO#0A{.DEFAULT:............RESULTIS."Op.
%n"#0A#0A..CASE.s_abs:.........RESULTIS."ABS"#0A..C
ASE.s_and:.........RESULTIS."AND"#0A..CASE.s_ass:..
.......RESULTIS."ASS"#0A..CASE.s_be:..........RESUL
TIS."BE"#0A..CASE.s_by:..........RESULTIS."BY"#0A..
CASE.s_break:.......RESULTIS."BREAK"#0A..CASE.s_byt
eap:......RESULTIS."BYTEAP"#0A..CASE.s_case:.......
.RESULTIS."CASE"#0A..CASE.s_colon:.......RESULTIS."
COLON"#0A..CASE.s_comma:.......RESULTIS."COMMA"#0A.
.CASE.s_cond:........RESULTIS."COND"#0A..CASE.s_con
stdef:....RESULTIS."CONSTDEF"#0A..CASE.s_default:..
...RESULTIS."DEFAULT"#0A..CASE.s_div:.........RESUL
TIS."DIV"#0A..CASE.s_do:..........RESULTIS."DO"#0A.
.CASE.s_dot:.........RESULTIS."DOT"#0A..CASE.s_else
:........RESULTIS."ELSE"#0A..CASE.s_eof:.........RE
SULTIS."EOF"#0A..CASE.s_endcase:.....RESULTIS."ENDC
ASE"#0A..CASE.s_eq:..........RESULTIS."EQ"#0A..CASE
.s_eqv:.........RESULTIS."EQV"#0A..CASE.s_false:...
....RESULTIS."FALSE"#0A..CASE.s_finish:......RESULT
IS."FINISH"#0A..CASE.s_fnap:........RESULTIS."FNAP"
#0A..CASE.s_fndef:.......RESULTIS."FNDEF"#0A..CASE.
s_for:.........RESULTIS."FOR"#0A..CASE.s_ge:.......
...RESULTIS."GE"#0A..CASE.s_get:.........RESULTIS."
GET"#0A..CASE.s_global:......RESULTIS."GLOBAL"#0A..
CASE.s_goto:........RESULTIS."GOTO"#0A..CASE.s_gr:.
.........RESULTIS."GR"#0A..CASE.s_if:..........RESU
LTIS."IF"#0A..CASE.s_into:........RESULTIS."INTO"#0A
..CASE.s_le:..........RESULTIS."LE"#0A..CASE.s_let:
.........RESULTIS."LET"#0A..CASE.s_logand:......RES
ULTIS."LOGAND"#0A..CASE.s_logor:.......RESULTIS."LO
GOR"#0A..CASE.s_loop:........RESULTIS."LOOP"#0A..CA
SE.s_lparen:......RESULTIS."LPAREN"#0A..CASE.s_ls:.
.........RESULTIS."LS"#0A..CASE.s_lsect:.......RESU
LTIS."LSECT"#0A..CASE.s_lshift:......RESULTIS."LSHI
FT"#0A..CASE.s_lv:..........RESULTIS."LV"#0A..CASE.
s_manifest:....RESULTIS."MANIFEST"#0A..CASE.s_mthap
:.......RESULTIS."MTHAP"#0A..CASE.s_minus:.......RE
SULTIS."MINUS"#0A..CASE.s_mult:........RESULTIS."MU
LT"#0A..CASE.s_name:........RESULTIS."NAME"#0A..CAS
E.s_ne:..........RESULTIS."NE"#0A..CASE.s_needs:...
....RESULTIS."NEEDS"#0A..CASE.s_neg:.........RESULT
IS."NEG"#0A..CASE.s_neqv:........RESULTIS."NEQV"#0A
..CASE.s_not:.........RESULTIS."NOT"#0A..CASE.s_num
ber:......RESULTIS."NUMBER"#0A..CASE.s_of:.........
.RESULTIS."OF"#0A..CASE.s_plus:........RESULTIS."PL
US"#0A..CASE.s_query:.......RESULTIS."QUERY"#0A..CA
SE.s_rem:.........RESULTIS."REM"#0A..CASE.s_repeat:
......RESULTIS."REPEAT"#0A..CASE.s_repeatuntil:.RES
ULTIS."REPEATUNTIL"#0A..CASE.s_repeatwhile:.RESULTI
S."REPEATWHILE"#0A..CASE.s_resultis:....RESULTIS."R
ESULTIS"#0A..CASE.s_return:......RESULTIS."RETURN"#0A
..CASE.s_rparen:......RESULTIS."RPAREN"#0A..CASE.s_
rshift:......RESULTIS."RSHIFT"#0A..CASE.s_rsect:...
....RESULTIS."RSECT"#0A..CASE.s_rtap:........RESULT
IS."RTAP"#0A..CASE.s_rtdef:.......RESULTIS."RTDEF"#0A
..CASE.s_rv:..........RESULTIS."RV"#0A..CASE.s_sbra
:........RESULTIS."SBRA"#0A..CASE.s_section:.....RE
SULTIS."SECTION"#0A..CASE.s_semicolon:...RESULTIS."
SEMICOLON"#0A..CASE.s_seq:.........RESULTIS."SEQ"#0A
..CASE.s_sket:........RESULTIS."SKET"#0A..CASE.s_sk
ip:........RESULTIS."SKIP"#0A..CASE.s_static:......
RESULTIS."STATIC"#0A..CASE.s_string:......RESULTIS.
"STRING"#0A..CASE.s_switchon:....RESULTIS."SWITCHON
"#0A..CASE.s_table:.......RESULTIS."TABLE"#0A..CASE
.s_test:........RESULTIS."TEST"#0A..CASE.s_to:.....
.....RESULTIS."TO"#0A..CASE.s_true:........RESULTIS
."TRUE"#0A..CASE.s_unless:......RESULTIS."UNLESS"#0A
..CASE.s_until:.......RESULTIS."UNTIL"#0A..CASE.s_v
aldef:......RESULTIS."VALDEF"#0A..CASE.s_valof:....
...RESULTIS."VALOF"#0A..CASE.s_vec:.........RESULTI
S."VEC"#0A..CASE.s_vecap:.......RESULTIS."VECAP"#0A
..CASE.s_vecdef:......RESULTIS."VECDEF"#0A..CASE.s_
while:.......RESULTIS."WHILE"#0A}#0A#0A//#2E#0A#0A/
/SECTION."TRN"#0A#0A//....TRNHDR#0A.#0A//GET."libhd
r"#0A//GET."bcplfecg"#0A.#0AGLOBAL..{#0Atrnext:trng
#0Atrans;.declnames;.decldyn#0Adeclstat;.checkdisti
nct;.addname;.cellwithname#0Atransdef;.scanlabel#0A
decllabels;.undeclare#0Ajumpcond;.transswitch;.tran
sfor#0Aassign;.load;.fnbody;.loadlv;.loadlist#0Aisc
onst.evalconst;.transname;.xref#0Anextlab;.labnumbe
r#0Anewblk#0Advec;.dvece;.dvecp;.dvect#0Acaselist;.
casecount#0Acontext;.comline;.procname#0Aresultlab;
.defaultlab;.endcaselab#0Alooplab;.breaklab;.ssp;.v
ecssp#0Agdeflist;.gdefcount#0Aoutstring;.out1;.out2
#0A}#0A#0ALET.nextlab().#3D.VALOF#0A{.labnumber.:#3D
.labnumber.+.1#0A..RESULTIS.labnumber#0A}#0A.#0AAND
.trnerr(mess,.a).BE#0A{.LET.fno.#3D.comline>>20#0A.
.LET.lno.#3D.comline.&.#23xFFFFF#0A..LET.filename.#3D
.sourcenamev!fno#0A..writes("Error.")#0A..UNLESS.pr
ocname#3D0.DO.writef("in.%s.",.@h3!procname)#0A..wr
itef("near.")#0A..IF.filename.DO.writef("%s",.filen
ame)#0A..writef("[%n]:.",.lno)#0A..writef(mess,.a)#0A
..newline()#0A..errcount.:#3D.errcount.+.1#0A..IF.e
rrcount.>#3D.errmax.DO.{.writes("*nCompilation.abor
ted*n")#0A.............................longjump(fin
_p,.fin_l)#0A...........................}#0A}#0A#0A
AND.newblk(x,.y,.z).#3D.VALOF#0A{.LET.p.#3D.dvect.-
.3#0A..IF.dvece>p.DO.{.errmax.:#3D.0........//.Make
.it.fatal#2E#0A..................trnerr("More.works
pace.needed")#0A................}#0A..p!0,.p!1,.p!2
.:#3D.x,.y,.z#0A..dvect.:#3D.p#0A..RESULTIS.p#0A}#0A
#0AAND.translate(x).BE#0A{.dvec,..dvect.:#3D.treeve
c,.treep#0A..h1!dvec,.h2!dvec,.h3!dvec.:#3D.0,.0,.0
#0A..dvece.:#3D.dvec+3#0A..dvecp.:#3D.dvece#0A//sel
ectoutput(sysprint)#0A..FOR.i.#3D.0.TO.nametablesiz
e-1.DO#0A..{.LET.name.#3D.nametable!i#0A....UNTIL.n
ame#3D0.DO#0A....{.LET.next.#3D.h2!name#0A......h2!
name.:#3D.0.//.Mark.undeclared#0A//...writef("Undec
lare.%s*n",.name+2)#0A......name.:#3D.next#0A....}#0A
..}#0A#0A..gdeflist,.gdefcount.:#3D.0,.0#0A..caseli
st,.casecount,.defaultlab.:#3D.0,.-1,.0#0A..resultl
ab,.breaklab,.looplab,.endcaselab.:#3D.-2,.-2,.-2,.
-2#0A..context,.comline,.procname,.labnumber.:#3D.0
,.1,.0,.0#0A..ssp,.vecssp.:#3D.savespacesize,.saves
pacesize#0A#0A..WHILE.x~#3D0.&.(h1!x#3Ds_section.|.
h1!x#3Ds_needs).DO#0A..{.LET.op,.a.#3D.h1!x,.h2!x#0A
....out1(op)#0A....outstring(@h2!a)#0A....x:#3Dh3!x
#0A..}#0A#0A..trans(x,.0)#0A..out2(s_global,.gdefco
unt)#0A..UNTIL.gdeflist#3D0.DO.{.out2(h2!gdeflist,.
h3!gdeflist)#0A........................gdeflist.:#3D
.h1!gdeflist#0A......................}..#0A}#0A#0AL
ET.trnext(next).BE.{.IF.next<0.DO.out1(s_rtrn)#0A..
....................IF.next>0.DO.out2(s_jump,.next)
#0A....................}#0A.#0ALET.trans(x,.next).B
E#0A//.x.......is.the.command.to.translate#0A//.nex
t<0..compile.x.followed.by.RTRN#0A//.next>0..compil
e.x.followed.by.JUMP.next#0A//.next#3D0..compile.x.
only#0A{.LET.sw.#3D.FALSE#0A...IF.x#3D0.DO.{.trnext
(next);.RETURN.}#0A.#0A...SWITCHON.h1!x.INTO#0A...{
.DEFAULT:.trnerr("Compiler.error.in.Trans");.RETURN
#0A.#0A......CASE.s_let:#0A......{.LET.cc.#3D.casec
ount#0A.........LET.e,.s,.s1.#3D.dvece,.ssp,.0#0A..
.......LET.v.#3D.vecssp#0A.........casecount.:#3D.-
1.//.Disallow.CASE.and.DEFAULT.labels#0A.........co
ntext,.comline.:#3D.x,.h4!x#0A.........declnames(h2
!x)#0A.........checkdistinct(e)#0A.........vecssp,.
s1.:#3D.ssp,.ssp#0A.........ssp.:#3D.s#0A.........c
ontext,.comline.:#3D.x,.h4!x#0A.........transdef(h2
!x)#0A.........UNLESS.ssp#3Ds1.DO.trnerr("Lhs.and.r
hs.do.not.match")#0A.........UNLESS.ssp#3Dvecssp.DO
.{.ssp.:#3D.vecssp;.out2(s_stack,.ssp).}#0A........
.out1(s_store)#0A.........decllabels(h3!x)#0A......
...trans(h3!x,.next)#0A.........vecssp.:#3D.v#0A...
......UNLESS.ssp#3Ds.DO.out2(s_stack,.s)#0A........
.ssp.:#3D.s#0A.........casecount.:#3D.cc#0A........
.undeclare(e)#0A.........RETURN#0A......}#0A.#0A...
...CASE.s_static:#0A......CASE.s_global:#0A......CA
SE.s_manifest:#0A......{.LET.cc.#3D.casecount#0A...
......LET.e,.s.#3D.dvece,.ssp#0A.........AND.op.#3D
.h1!x#0A.........AND.y,.n.#3D.h2!x,.0#0A.........LE
T.prevk.#3D.-1#0A.........#0A.........casecount.:#3D
.-1.//.Disallow.CASE.and.DEFAULT.labels#0A.........
context,.comline.:#3D.x,.h4!x#0A.#0A.........UNTIL.
y#3D0.DO#0A.........{.context,.comline.:#3D.y,.h5!y
#0A............n.:#3D.h4!y.->.evalconst(h4!y),.prev
k+1#0A............context,.comline.:#3D.y,.h5!y#0A.
...........prevk.:#3D.n#0A............IF.op#3Ds_sta
tic.DO.{.LET.k.#3D.n#0A............................
.....n.:#3D.nextlab()#0A...........................
......out2(s_datalab,.n)#0A........................
.........out2(s_itemn,.k)#0A.......................
.......}#0A............IF.op#3Ds_global.UNLESS.0<#3D
n<#3D65535.DO#0A...............trnerr("Global.numbe
r.too.large.for:.%s*n",.@h3!(h3!y))#0A............a
ddname(h3!y,.op,.n)#0A............IF.xrefing.DO.xre
f(h3!y,#0A...............................(op#3Ds_gl
obal->"G:",op#3Ds_static->"S:","M:"),#0A...........
....................n,#0A..........................
.....s_constdef#0A..............................)#0A
............y.:#3D.h2!y#0A.........}#0A.#0A........
.decllabels(h3!x)#0A.........trans(h3!x,.next)#0A..
.......ssp.:#3D.s#0A.........casecount.:#3D.cc#0A..
.......undeclare(e)#0A.........RETURN#0A......}#0A.
#0A.#0A......CASE.s_ass:#0A.........context,.comlin
e.:#3D.x,.h4!x#0A.........assign(h2!x,.h3!x)#0A....
.....trnext(next)#0A.........RETURN#0A.#0A......CAS
E.s_rtap:#0A......{.LET.s.#3D.ssp#0A.........contex
t,.comline.:#3D.x,.h4!x#0A.........ssp.:#3D.ssp+sav
espacesize#0A.........out2(s_stack,.ssp)#0A........
.loadlist(h3!x)#0A.........load(h2!x)#0A.........ou
t2(s_rtap,.s)#0A.........ssp.:#3D.s#0A.........trne
xt(next)#0A.........RETURN#0A......}#0A.#0A......CA
SE.s_goto:#0A.........context,.comline.:#3D.x,.h3!x
#0A.........load(h2!x)#0A.........out1(s_goto)#0A..
.......ssp.:#3D.ssp-1#0A.........RETURN#0A.#0A.....
.CASE.s_colon:#0A.........context,.comline.:#3D.x,.
h5!x#0A.........out2(s_lab,.h4!x)#0A.........trans(
h3!x,.next)#0A.........RETURN#0A.#0A......CASE.s_un
less:.sw.:#3D.TRUE#0A......CASE.s_if:#0A.........co
ntext,.comline.:#3D.x,.h4!x#0A.........TEST.next>0.
THEN.{.jumpcond(h2!x,.sw,.next)#0A.................
............trans(h3!x,.next)#0A...................
.......}#0A.....................ELSE.{.LET.l.#3D.ne
xtlab()#0A.............................jumpcond(h2!
x,.sw,.l)#0A.............................trans(h3!x
,.next)#0A.............................out2(s_lab,.
l)#0A.............................trnext(next)#0A..
........................}#0A.........RETURN#0A.#0A.
.....CASE.s_test:#0A......{.LET.l,.m.#3D.nextlab(),
.0#0A.........context,.comline.:#3D.x,.h5!x#0A.....
....jumpcond(h2!x,.FALSE,.l)#0A.........#0A........
.TEST.next#3D0.THEN.{.m.:#3D.nextlab();.trans(h3!x,
.m).}#0A.....................ELSE.trans(h3!x,.next)
#0A.....................#0A.........out2(s_lab,.l)#0A
.........trans(h4!x,.next)#0A.........UNLESS.m#3D0.
DO.out2(s_lab,.m)#0A.........RETURN#0A......}#0A.#0A
......CASE.s_loop:#0A.........context,.comline.:#3D
.x,.h2!x#0A.........IF.looplab<0.DO.trnerr("Illegal
.use.of.LOOP")#0A.........IF.looplab#3D0.DO.looplab
.:#3D.nextlab()#0A.........out2(s_jump,.looplab)#0A
.........RETURN#0A.#0A......CASE.s_break:#0A.......
..context,.comline.:#3D.x,.h2!x#0A.........IF.break
lab#3D-2.DO.trnerr("Illegal.use.of.BREAK")#0A......
...IF.breaklab#3D-1.DO.{.out1(s_rtrn);.RETURN.}#0A.
........IF.breaklab#3D.0.DO.breaklab.:#3D.nextlab()
#0A.........out2(s_jump,.breaklab)#0A.........RETUR
N#0A.#0A......CASE.s_return:#0A.........context,.co
mline.:#3D.x,.h2!x#0A.........out1(s_rtrn)#0A......
...RETURN#0A.#0A......CASE.s_skip:..//.MR.05/4/06#0A
.........trnext(next)#0A.........RETURN#0A#0A......
CASE.s_finish:#0A.........context,.comline.:#3D.x,.
h2!x#0A.........out1(s_finish)#0A.........RETURN#0A
.#0A......CASE.s_resultis:#0A.........context,.coml
ine.:#3D.x,.h3!x#0A.........IF.resultlab#3D-1.DO.{.
fnbody(h2!x);.RETURN.}#0A.........UNLESS.resultlab>
0.DO.trnerr("RESULTIS.out.of.context")#0A.........l
oad(h2!x)#0A.........out2(s_res,.resultlab)#0A.....
....ssp.:#3D.ssp.-.1#0A.........RETURN#0A.#0A......
CASE.s_while:.sw.:#3D.TRUE#0A......CASE.s_until:#0A
......{.LET.l,.m.#3D.nextlab(),.next#0A.........LET
.bl,.ll.#3D.breaklab,.looplab#0A.........context,.c
omline.:#3D.x,.h4!x#0A.........breaklab,.looplab.:#3D
.next,.0#0A.........IF.next<#3D0.DO.m.:#3D.nextlab(
)#0A.........IF.next.#3D0.DO.breaklab.:#3D.m#0A....
.....jumpcond(h2!x,.~sw,.m)#0A.........out2(s_lab,.
l)#0A.........trans(h3!x,.0)#0A.........UNLESS.loop
lab#3D0.DO.out2(s_lab,.looplab)#0A.........context,
.comline.:#3D.x,.h4!x#0A.........jumpcond(h2!x,.sw,
.l)#0A.........IF.next<#3D0.DO.out2(s_lab,.m)#0A...
......trnext(next)#0A.........breaklab,.looplab.:#3D
.bl,.ll#0A.........RETURN#0A......}#0A.#0A......CAS
E.s_repeatwhile:.sw.:#3D.TRUE#0A......CASE.s_repeat
until:#0A......{.LET.l,.bl,.ll.#3D.nextlab(),.break
lab,.looplab#0A.........context,.comline.:#3D.x,.h4
!x#0A.........breaklab,.looplab.:#3D.next,.0#0A....
.....out2(s_lab,.l)#0A.........trans(h2!x,.0)#0A...
......UNLESS.looplab#3D0.DO.out2(s_lab,.looplab)#0A
.........context,.comline.:#3D.x,.h4!x#0A.........j
umpcond(h3!x,.sw,.l)#0A#0A//.......UNLESS.breaklab#3D
0.DO.out2(s_lab,.breaklab)#0A.........IF.next#3D0.&
.breaklab>0.DO.out2(s_lab,.breaklab)#0A#0A.........
trnext(next)#0A.........breaklab,.looplab.:#3D.bl,.
ll#0A.........RETURN#0A......}#0A.#0A......CASE.s_r
epeat:#0A......{.LET.bl,.ll.#3D.breaklab,.looplab#0A
.........context,.comline.:#3D.x,.h4!x#0A.........b
reaklab,.looplab.:#3D.next,.nextlab()#0A.........ou
t2(s_lab,.looplab)#0A#0A.........trans(h2!x,.loopla
b)#0A#0A.........IF.next#3D0.&.breaklab>0.DO.out2(s
_lab,.breaklab)#0A#0A.........breaklab,.looplab.:#3D
.bl,.ll#0A.........RETURN#0A......}#0A.#0A......CAS
E.s_case:#0A......{.LET.l,.k,.cl.#3D.nextlab(),.?,.
caselist#0A.........context,.comline.:#3D.x,.h4!x#0A
.........k.:#3D.evalconst(h2!x)#0A.........IF.casec
ount<0.DO.trnerr("CASE.label.out.of.context")#0A...
......UNTIL.cl#3D0.DO#0A.........{.IF.h2!cl#3Dk.DO.
trnerr("'CASE.%n:'.occurs.twice",.k)#0A............
cl.:#3D.h1!cl#0A.........}#0A.........caselist.:#3D
.newblk(caselist,.k,.l)#0A.........casecount.:#3D.c
asecount.+.1#0A.........out2(s_lab,.l)#0A.........t
rans(h3!x,.next)#0A.........RETURN#0A......}#0A.#0A
......CASE.s_default:#0A.........context,.comline.:
#3D.x,.h3!x#0A.........IF.casecount<0.|.defaultlab~
#3D0.DO.trnerr("Bad.DEFAULT.label")#0A.........defa
ultlab.:#3D.nextlab()#0A.........out2(s_lab,.defaul
tlab)#0A.........trans(h2!x,.next)#0A.........RETUR
N#0A.#0A......CASE.s_endcase:#0A.........context,.c
omline.:#3D.x,.h2!x#0A.........IF.endcaselab#3D-2.D
O.trnerr("Illegal.use.of.ENDCASE")#0A.........IF.en
dcaselab#3D-1.DO.out1(s_rtrn)#0A.........//.endcase
lab.is.never.equal.to.0#0A.........IF.endcaselab>0.
.DO.out2(s_jump,.endcaselab)#0A.........RETURN#0A.#0A
......CASE.s_switchon:#0A.........transswitch(x,.ne
xt)#0A.........RETURN#0A.#0A......CASE.s_for:#0A...
......transfor(x,.next)#0A.........RETURN#0A.#0A...
...CASE.s_seq:#0A.........trans(h2!x,.0)#0A........
.x.:#3D.h3!x#0A...}#0A}.REPEAT#0A#0ALET.declnames(x
).BE.UNLESS.x#3D0.SWITCHON.h1!x.INTO#0A.#0A{..DEFAU
LT:.......trnerr("Compiler.error.in.Declnames")#0A.
..................RETURN#0A.#0A....CASE.s_vecdef:#0A
....CASE.s_valdef:.context,.comline.:#3D.x,.h4!x#0A
...................decldyn(h2!x)#0A................
...RETURN#0A.#0A....CASE.s_rtdef:#0A....CASE.s_fnde
f:..context,.comline.:#3D.x,.h6!x#0A...............
....h5!x.:#3D.nextlab()#0A...................declst
at(h2!x,.h5!x)#0A...................RETURN#0A.#0A..
..CASE.s_and:....declnames(h2!x)#0A................
...declnames(h3!x)#0A}#0A.#0AAND.decldyn(x).BE.UNLE
SS.x#3D0.DO#0A.#0A{.IF.h1!x#3Ds_name..DO.{.addname(
x,.s_local,.ssp)#0A.........................//IF.xr
efing.DO.xref(x,."P:",.ssp,.h1!context)#0A.........
................ssp.:#3D.ssp.+.1#0A................
.........RETURN#0A......................}#0A.#0A...
IF.h1!x#3Ds_comma.DO.{.addname(h2!x,.s_local,.ssp)#0A
.........................//IF.xrefing.DO.xref(h2!x,
."P:",.ssp,.h1!context)#0A.........................
ssp.:#3D.ssp.+.1#0A.........................decldyn
(h3!x)#0A.........................RETURN#0A........
..............}#0A.#0A...trnerr("Compiler.error.in.
Decldyn")#0A}#0A.#0AAND.declstat(x,.lab).BE#0A{.LET
.c.#3D.cellwithname(x)#0A.#0A..TEST.h2!c#3Ds_global
.THEN.{.LET.gn.#3D.h3!c#0A.........................
...gdeflist.:#3D.newblk(gdeflist,.gn,.lab)#0A......
......................gdefcount.:#3D.gdefcount.+.1#0A
............................addname(x,.s_global,.gn
)#0A............................IF.xrefing.DO.xref(
x,."G:",.gn,.h1!context)#0A........................
....IF.gdefsing.DO.writef("G%i3.#3D.%s*n",.gn,.@h3!
x)#0A..........................}#0A................
.....ELSE.{.addname(x,.s_label,.lab)#0A............
................IF.xrefing.DO.xref(x,."F:",.lab,.h1
!context)#0A..........................}#0A}#0A.#0AA
ND.decllabels(x).BE#0A{.LET.e.#3D.dvece#0A..scanlab
els(x)#0A..checkdistinct(e)#0A}#0A.#0AAND.checkdist
inct(p).BE#0A{.LET.lim.#3D.dvece.-.3#0A..FOR.q.#3D.
p.TO.lim-3.BY.3.DO#0A..{.LET.n.#3D.h1!q#0A....FOR.c
.#3D.q+3.TO.lim.BY.3.DO#0A........IF.h1!c#3Dn.DO.tr
nerr("Name.%s.defined.twice",.@h3!n)#0A..}#0A}#0A.#0A
AND.addname(name,.k,.a).BE#0A{.LET.p.#3D.dvece.+.3#0A
..IF.p>dvect.DO.trnerr("More.workspace.needed")#0A.
.h1!dvece,.h2!dvece,.h3!dvece.:#3D.name,.k,.a#0A..h
2!name.:#3D.dvece.//.Remember.the.declaration#0A..d
vece.:#3D.p#0A}#0A.#0AAND.undeclare(e).BE.#0A{.FOR.
t.#3D.e.TO.dvece-3.BY.3.DO#0A..{.LET.name.#3D.h1!t#0A
....h2!name.:#3D.0...//.Forget.its.declaration#0A..
}#0A..dvece.:#3D.e#0A}#0A#0AAND.cellwithname(n).#3D
.VALOF#0A{.LET.t.#3D.h2!n#0A..IF.t.RESULTIS.t..//.I
t.has.been.looked.up.before#0A..t.:#3D.dvece#0A..t.
:#3D.t.-.3.REPEATUNTIL.h1!t#3Dn.|.h1!t#3D0#0A..h2!n
.:#3D.t..//.Associate.the.name.with.declaration.ite
m#0A..RESULTIS.t#0A}#0A.#0AAND.scanlabels(x).BE.UNL
ESS.x#3D0.SWITCHON.h1!x.INTO#0A.#0A{.CASE.s_colon:.
..context,.comline.:#3D.x,.h5!x#0A.................
.h4!x.:#3D.nextlab()#0A..................declstat(h
2!x,.h4!x)#0A.#0A..CASE.s_if:.CASE.s_unless:.CASE.s
_while:.CASE.s_until:#0A..CASE.s_switchon:.CASE.s_c
ase:#0A..................scanlabels(h3!x)#0A.......
...........RETURN#0A.#0A..CASE.s_seq:.....scanlabel
s(h3!x)#0A.#0A..CASE.s_repeat:.CASE.s_repeatwhile:.
CASE.s_repeatuntil:#0A..CASE.s_default:.scanlabels(
h2!x)#0A..................RETURN#0A.#0A..CASE.s_tes
t:....scanlabels(h3!x)#0A..................scanlabe
ls(h4!x)#0A..DEFAULT:........RETURN#0A}#0A.#0AAND.t
ransdef(x).BE#0A{.LET.ctxt,.ln.#3D.context,.comline
#0A..transdyndefs(x)#0A..context,.comline.:#3D.ctxt
,.ln#0A..IF.statdefs(x).DO.{.LET.l,.s#3D.nextlab(),
.ssp#0A......................out2(s_jump,.l)#0A....
..................transstatdefs(x)#0A..............
........ssp.:#3D.s#0A......................out2(s_s
tack,.ssp)#0A......................out2(s_lab,.l)#0A
....................}#0A..context,.comline.:#3D.ctx
t,.ln#0A}#0A.#0A.#0AAND.transdyndefs(x).BE.SWITCHON
.h1!x.INTO#0A{.CASE.s_and:....transdyndefs(h2!x)#0A
.................transdyndefs(h3!x)#0A.............
....RETURN#0A.#0A..CASE.s_vecdef:.context,.comline.
:#3D.x,.h4!x#0A.................out2(s_llp,.vecssp)
#0A.................ssp.:#3D.ssp.+.1#0A............
.....vecssp.:#3D.vecssp.+.1.+.evalconst(h3!x)#0A...
..............RETURN#0A.#0A..CASE.s_valdef:.context
,.comline.:#3D.h3!x,.h4!x#0A.................loadli
st(h3!x)#0A.#0A..DEFAULT:.......RETURN#0A}#0A.#0AAN
D.transstatdefs(x).BE.SWITCHON.h1!x.INTO#0A{.CASE.s
_and:..transstatdefs(h2!x)#0A...............transst
atdefs(h3!x)#0A...............RETURN#0A.#0A..CASE.s
_fndef:#0A..CASE.s_rtdef:#0A.............{.LET.e,.p
.#3D.dvece,.dvecp#0A...............AND.oldpn.#3D.pr
ocname#0A...............AND.bl,.ll.#3D.breaklab,..l
ooplab#0A...............AND.rl,.el.#3D.resultlab,.e
ndcaselab#0A...............AND.cl,.cc.#3D.caselist,
..casecount#0A...............breaklab,..looplab....
:#3D.-2,.-2#0A...............resultlab,.endcaselab.
:#3D.-2,.-2#0A...............caselist,..casecount..
:#3D..0,.-1#0A...............procname.:#3D.h2!x#0A.
..............context,.comline.:#3D.x,.h6!x#0A.....
..........out2(s_entry,.h5!x)#0A...............outs
tring(@h3!procname)#0A...............ssp.:#3D.saves
pacesize#0A...............dvecp.:#3D.dvece#0A......
.........context,.comline.:#3D.x,.h6!x#0A..........
.....decldyn(h3!x)#0A...............checkdistinct(e
)#0A...............context,.comline.:#3D.h4!x,.h6!x
#0A...............decllabels(h4!x)#0A..............
.out2(s_save,.ssp)#0A...............context,.comlin
e.:#3D.h4!x,.h6!x#0A...............TEST.h1!x#3Ds_rt
def.THEN.trans(h4!x,.-1)#0A........................
.........ELSE.fnbody(h4!x)#0A...............out1(s_
endproc)#0A.#0A...............breaklab,..looplab...
.:#3D.bl,.ll#0A...............resultlab,.endcaselab
.:#3D.rl,.el#0A...............caselist,..casecount.
.:#3D.cl,.cc#0A...............procname.:#3D.oldpn#0A
...............dvecp.:#3D.p#0A...............undecl
are(e)#0A.............}#0A.#0A..DEFAULT:.....RETURN
#0A}#0A.#0AAND.statdefs(x).#3D.h1!x#3Ds_fndef.|.h1!
x#3Ds_rtdef.->.TRUE,#0A..................h1!x.~#3D.
s_and...............->.FALSE,#0A..................s
tatdefs(h2!x)..............->.TRUE,#0A.............
.....statdefs(h3!x)#0A.#0A.#0ALET.jumpcond(x,.b,.l)
.BE#0A{.LET.sw.#3D.b#0A#0A..SWITCHON.h1!x.INTO#0A..
{.CASE.s_false:..b.:#3D.NOT.b#0A....CASE.s_true:...
IF.b.DO.out2(s_jump,.l)#0A...................RETURN
#0A.#0A....CASE.s_not:....jumpcond(h2!x,.NOT.b,.l)#0A
...................RETURN#0A.#0A....CASE.s_logand:.
sw.:#3D.NOT.sw#0A....CASE.s_logor:..TEST.sw.THEN.{.
jumpcond(h2!x,.b,.l)#0A............................
......jumpcond(h3!x,.b,.l)#0A......................
............RETURN#0A..............................
..}#0A.#0A...........................ELSE.{.LET.m.#3D
.nextlab()#0A..................................jump
cond(h2!x,.NOT.b,.m)#0A............................
......jumpcond(h3!x,.b,.l)#0A......................
............out2(s_lab,.m)#0A......................
............RETURN#0A..............................
..}#0A.#0A....DEFAULT:.......load(x)#0A............
.......out2(b.->.s_jt,.s_jf,.l)#0A.................
..ssp.:#3D.ssp.-.1#0A...................RETURN#0A..
}#0A}#0A.#0AAND.transswitch(x,.next).BE#0A{.LET.cl,
.cc.#3D.caselist,.casecount.#0A..LET.dl,.el.#3D.def
aultlab,.endcaselab#0A..LET.l,.dlab.#3D.nextlab(),.
?#0A..caselist,.casecount,.defaultlab.:#3D.0,.0,.0#0A
..endcaselab.:#3D.next#3D0.->.nextlab(),.next#0A.#0A
..context,.comline.:#3D.x,.h4!x#0A..out2(s_jump,.l)
#0A..trans(h3!x,.endcaselab)#0A.#0A..context,.comli
ne.:#3D.x,.h4!x#0A..out2(s_lab,.l)#0A..load(h2!x)#0A
#0A..dlab.:#3D.defaultlab>0.->.defaultlab,#0A......
....endcaselab>0.->.endcaselab,#0A..........nextlab
()#0A#0A..out2(s_switchon,.casecount);.out1(dlab).#0A
..UNTIL.caselist#3D0.DO.{.out2(h2!caselist,.h3!case
list)#0A........................caselist.:#3D.h1!ca
selist#0A......................}#0A..ssp.:#3D.ssp.-
.1#0A#0A..IF.next#3D0................DO...out2(s_la
b,.endcaselab)#0A..IF.next<0.&.defaultlab#3D0.DO.{.
out2(s_lab,.dlab)#0A...............................
.out1(s_rtrn)#0A..............................}#0A#0A
..defaultlab,.endcaselab.:#3D.dl,.el#0A..caselist,.
..casecount..:#3D.cl,.cc#0A}#0A.#0AAND.transfor(x,.
next).BE#0A{.LET.e,.m,.blab.#3D.dvece,.nextlab(),.0
#0A..LET.bl,.ll.#3D.breaklab,.looplab#0A..LET.cc.#3D
.casecount#0A..LET.k,.n,.step.#3D.0,.0,.1#0A..LET.s
.#3D.ssp#0A#0A..casecount.:#3D.-1..//.Disallow.CASE
.and.DEFAULT.labels#2E...#0A..breaklab,.looplab.:#3D
.next,.0#0A...#0A..context,.comline.:#3D.x,.h7!x#0A
.#0A..addname(h2!x,.s_local,.s)#0A..load(h3!x).....
..//.The.initial.value#0A.#0A..//.Set.k,.n.to.load.
the.end.limit#0A..TEST.h1!(h4!x)#3Ds_number.THEN...
.k,.n.:#3D.s_ln,.h2!(h4!x)#0A......................
....ELSE.{.k,.n.:#3D.s_lp,.ssp#0A..................
...............load(h4!x)#0A.......................
........}#0A.#0A..UNLESS.h5!x#3D0.DO.step.:#3D.eval
const(h5!x)#0A.#0A..out1(s_store)#0A...#0A..TEST.k#3D
s_ln.&.h1!(h3!x)#3Ds_number..//.check.for.constant.
limits.#0A..THEN.{.LET.initval.#3D.h2!(h3!x)#0A....
.....IF.step>#3D0.&.initval>n.|.step<0.&.initval<n.
DO#0A.........{.TEST.next<0#0A...........THEN.out1(
s_rtrn)#0A...........ELSE.TEST.next>0#0A...........
.....THEN.out2(s_jump,.next)#0A................ELSE
.{.blab.:#3D.breaklab>0.->.breaklab,.nextlab()#0A..
.....................out2(s_jump,.blab)#0A.........
............}#0A.........}#0A.......}#0A..ELSE.{.IF
.next<#3D0.DO.blab.:#3D.nextlab()#0A.........out2(s
_lp,.s)#0A.........out2(k,.n)#0A.........out1(step>
#3D0.->.s_gr,.s_ls)#0A.........out2(s_jt,.next>0.->
.next,.blab)#0A.......}#0A#0A..IF.breaklab#3D0.&.bl
ab>0.DO.breaklab.:#3D.blab#0A...#0A..context,.comli
ne.:#3D.x,.h7!x#0A..decllabels(h6!x)#0A..context,.c
omline.:#3D.x,.h7!x#0A..out2(s_lab,.m)#0A..trans(h6
!x,.0)#0A..UNLESS.looplab#3D0.DO.out2(s_lab,.loopla
b)#0A..out2(s_lp,.s);.out2(s_ln,.step);.out1(s_plus
);.out2(s_sp,.s)#0A..out2(s_lp,s);.out2(k,n);.out1(
step>#3D0.->.s_le,.s_ge)#0A..out2(s_jt,.m)#0A.#0A..
IF.next<#3D0.TEST.blab>0.#0A.............THEN......
............out2(s_lab,.blab)#0A.............ELSE.I
F.breaklab>0.DO.out2(s_lab,.breaklab)#0A..trnext(ne
xt)#0A..casecount.:#3D.cc#0A..breaklab,.looplab,.ss
p.:#3D.bl,.ll,.s#0A..out2(s_stack,.ssp)#0A..undecla
re(e)#0A}#0A.#0ALET.load(x).BE#0A{.LET.op.#3D.h1!x#0A
#0A..IF.isconst(x).DO#0A..{.out2(s_ln,.evalconst(x)
)#0A....ssp.:#3D.ssp.+.1#0A....RETURN#0A..}#0A.#0A.
.SWITCHON.op.INTO#0A..{.DEFAULT:..........trnerr("C
ompiler.error.in.Load")#0A......................out
2(s_ln,.0)#0A......................ssp.:#3D.ssp.+.1
#0A......................RETURN#0A.#0A....CASE.s_of
:......{.LET.slct.#3D.evalconst(h2!x).//.Inserted.1
1/7/01#0A......................LET.len.#3D.slct>>24
#0A......................LET.sh..#3D.slct>>16.&.255
#0A......................LET.offset.#3D.slct.&.#23x
FFFF#0A......................load(h3!x)#0A.........
.............IF.offset.DO.{.out2(s_ln,.offset);.out
1(s_plus).}#0A......................out1(s_rv)#0A..
....................IF.sh.DO.{.out2(s_ln,.sh);.out1
(s_rshift).}#0A......................IF.len>0.&.len
+sh<32.DO....//.Assume.a.32.bit.m/c#0A.............
.........{.LET.mask.#3D.(1<<len)-1#0A..............
..........out2(s_ln,.mask)#0A......................
..out1(s_logand)#0A......................}#0A......
................RETURN#0A....................}#0A#0A
....CASE.s_byteap:....op:#3Ds_getbyte#0A#0A....CASE
.s_div:.CASE.s_rem:.CASE.s_minus:#0A....CASE.s_ls:.
CASE.s_gr:.CASE.s_le:.CASE.s_ge:#0A....CASE.s_lshif
t:.CASE.s_rshift:#0A......................load(h2!x
);.load(h3!x);.out1(op)#0A......................ssp
.:#3D.ssp.-.1#0A......................RETURN#0A.#0A
....CASE.s_vecap:.CASE.s_mult:.CASE.s_plus:.CASE.s_
eq:.CASE.s_ne:#0A....CASE.s_logand:.CASE.s_logor:.C
ASE.s_eqv:.CASE.s_neqv:#0A.........{.LET.a,.b.#3D.h
2!x,.h3!x#0A...........TEST.h1!a#3Ds_name.|#0A.....
...........h1!a#3Ds_number.THEN.{.load(b);.load(a).
}#0A..............................ELSE.{.load(a);.l
oad(b).}#0A...........TEST.op#3Ds_vecap.THEN.out2(s
_plus,.s_rv)#0A...........................ELSE.out1
(op)#0A...........ssp.:#3D.ssp.-.1#0A...........RET
URN#0A.........}#0A.#0A....CASE.s_neg:.CASE.s_not:.
CASE.s_rv:.CASE.s_abs:#0A......................load
(h2!x)#0A......................out1(op)#0A.........
.............RETURN#0A.#0A....CASE.s_true:.CASE.s_f
alse:.CASE.s_query:#0A......................out1(op
)#0A......................ssp.:#3D.ssp.+.1#0A......
................RETURN#0A.#0A....CASE.s_lv:........
loadlv(h2!x);.RETURN#0A.#0A....CASE.s_number:....ou
t2(s_ln,.h2!x);.ssp.:#3D.ssp.+.1;.RETURN#0A.#0A....
CASE.s_string:....out1(s_lstr)#0A..................
....outstring(@.h2!x)#0A......................ssp.:
#3D.ssp.+.1#0A......................RETURN#0A.#0A..
..CASE.s_name:......transname(x,.s_lp,.s_lg,.s_ll,.
s_lf,.s_ln)#0A......................ssp.:#3D.ssp.+.
1#0A......................RETURN#0A.#0A....CASE.s_v
alof:...{.LET.e,.rl,.cc.#3D.dvece,.resultlab,.casec
ount#0A......................casecount.:#3D.-1.//.D
isallow.CASE.&.DEFAULT.labels#0A...................
...resultlab.:#3D.nextlab()#0A.....................
.decllabels(h2!x)#0A......................trans(h2!
x,.0)#0A......................out2(s_lab,.resultlab
)#0A......................out2(s_rstack,.ssp)#0A...
...................ssp.:#3D.ssp.+.1#0A.............
.........resultlab,.casecount.:#3D.rl,.cc#0A.......
...............undeclare(e)#0A.....................
.RETURN#0A....................}#0A.#0A....CASE.s_fn
ap:....{.LET.s.#3D.ssp#0A......................ssp.
:#3D.ssp.+.savespacesize#0A......................ou
t2(s_stack,.ssp)#0A......................loadlist(h
3!x)#0A......................load(h2!x)#0A.........
.............out2(s_fnap,.s)#0A....................
..ssp.:#3D.s.+.1#0A......................RETURN#0A.
...................}#0A.#0A....CASE.s_cond:....{.LE
T.l,.m.#3D.nextlab(),.nextlab()#0A.................
.....LET.s.#3D.ssp#0A......................jumpcond
(h2!x,.FALSE,.m)#0A......................load(h3!x)
#0A......................out2(s_res,l)#0A..........
............ssp.:#3D.s;.out2(s_stack,.ssp)#0A......
................out2(s_lab,.m)#0A..................
....load(h4!x)#0A......................out2(s_res,l
)#0A......................out2(s_lab,.l)#0A........
..............out2(s_rstack,s)#0A..................
....RETURN#0A....................}#0A.#0A....CASE.s
_table:...{.LET.m.#3D.nextlab()#0A.................
.....out2(s_datalab,.m)#0A......................x.:
#3D.h2!x#0A......................WHILE.h1!x#3Ds_com
ma.DO#0A......................{.out2(s_itemn,.evalc
onst(h2!x))#0A........................x.:#3D.h3!x#0A
......................}#0A......................out
2(s_itemn,.evalconst(x))#0A......................ou
t2(s_lll,.m)#0A......................ssp.:#3D.ssp.+
.1#0A......................RETURN#0A...............
.....}#0A..}#0A}#0A#0AAND.fnbody(x).BE.SWITCHON.h1!
x.INTO#0A{.DEFAULT:.........load(x)#0A.............
......out1(s_fnrn)#0A...................ssp.:#3D.ss
p.-.1#0A...................RETURN#0A...............
....#0A..CASE.s_valof:.{.LET.e,.rl,.cc.#3D.dvece,.r
esultlab,.casecount#0A..................casecount.:
#3D.-1.//.Disallow.CASE.&.DEFAULT.labels#0A........
..........resultlab.:#3D.-1#0A..................dec
llabels(h2!x)#0A..................trans(h2!x,.-1)#0A
..................resultlab,.casecount.:#3D.rl,.cc#0A
..................undeclare(e)#0A..................
RETURN#0A................}#0A#0A..CASE.s_cond:..{.L
ET.l.#3D.nextlab()#0A..................jumpcond(h2!
x,.FALSE,.l)#0A..................fnbody(h3!x)#0A...
...............out2(s_lab,.l)#0A..................f
nbody(h4!x)#0A................}#0A}#0A.#0A.#0AAND.l
oadlv(x).BE#0A{.UNLESS.x#3D0.SWITCHON.h1!x.INTO#0A.
.{.DEFAULT:.........ENDCASE#0A.#0A....CASE.s_name:.
....transname(x,.s_llp,.s_llg,.s_lll,.0,.0)#0A.....
................ssp.:#3D.ssp.+.1#0A................
.....RETURN#0A.#0A....CASE.s_rv:.......load(h2!x)#0A
.....................RETURN#0A.#0A....CASE.s_vecap:
.{.LET.a,.b.#3D.h2!x,.h3!x#0A....................IF
.h1!a#3Ds_name.DO.a,.b.:#3D.h3!x,.h2!x#0A..........
..........load(a)#0A....................load(b)#0A.
...................out1(s_plus)#0A.................
...ssp.:#3D.ssp.-.1#0A....................RETURN#0A
..................}#0A..}#0A#0A..trnerr("Ltype.expr
ession.needed")#0A..out2(s_ln,.0)#0A..ssp.:#3D.ssp.
+.1#0A}#0A.#0AAND.loadlist(x).BE.UNLESS.x#3D0.TEST.
h1!x#3Ds_comma#0A..............................THEN
.{.loadlist(h2!x);.loadlist(h3!x).}#0A.............
.................ELSE.load(x)#0A#0ALET.isconst(x).#3D
.VALOF#0A{.IF.x#3D0.RESULTIS.FALSE#0A.#0A..SWITCHON
.h1!x.INTO#0A..{.CASE.s_name:#0A........{.LET.c.#3D
.cellwithname(x)#0A..........RESULTIS.h2!c#3Ds_mani
fest#0A........}#0A.#0A....CASE.s_number:#0A....CAS
E.s_slct:#0A....CASE.s_true:#0A....CASE.s_false:..R
ESULTIS.TRUE#0A.#0A....CASE.s_neg:#0A....CASE.s_abs
:#0A....CASE.s_not:....RESULTIS.isconst(h2!x)#0A...
....#0A....CASE.s_mult:#0A....CASE.s_div:#0A....CAS
E.s_rem:#0A....CASE.s_plus:#0A....CASE.s_minus:#0A.
...CASE.s_lshift:#0A....CASE.s_rshift:#0A....CASE.s
_logor:#0A....CASE.s_logand:#0A....CASE.s_eqv:#0A..
..CASE.s_neqv:...IF.isconst(h2!x).&.isconst(h3!x).R
ESULTIS.TRUE#0A#0A....DEFAULT:.......RESULTIS.FALSE
#0A#0A...}#0A}#0A#0ALET.evalconst(x).#3D.VALOF#0A{.
LET.a,.b.#3D.0,.0#0A#0A..IF.x#3D0.DO.{.trnerr("Comp
iler.error.in.Evalconst")#0A..............RESULTIS.
0#0A............}#0A.#0A..SWITCHON.h1!x.INTO#0A..{.
CASE.s_name:.{.LET.c.#3D.cellwithname(x)#0A........
...........LET.k,.a.#3D.h2!c,.h3!c#0A..............
.....IF.k#3Ds_manifest.DO#0A...................{.IF
.xrefing.DO.xref(x,."M:",.a,.s_const)#0A...........
..........RESULTIS.a#0A...................}#0A.....
..............IF.k.DO.trnerr("%s.must.be.a.manifest
.constant",.@h3!x)#0A...................trnerr("Nam
e.'%s'.not.declared",.@h3!x)#0A...................R
ESULTIS.0#0A.................}#0A.#0A....CASE.s_num
ber:.RESULTIS.h2!x#0A....CASE.s_true:...RESULTIS.TR
UE#0A....CASE.s_false:..RESULTIS.FALSE#0A....CASE.s
_query:..RESULTIS.0#0A.#0A....CASE.s_slct:.{.LET.le
n,.sh,.offset.#3D.0,.0,.0.....//.Inserted.11/7/01#0A
...................IF.h2!x.DO.len....:#3D.evalconst
(h2!x)#0A...................IF.h3!x.DO.sh.....:#3D.
evalconst(h3!x)#0A...................IF.h4!x.DO.off
set.:#3D.evalconst(h4!x)#0A...................UNLES
S.0<#3Dlen<#3D255.&.0<#3Dsh<#3D255.&.0<#3Doffset<#3D
#23xFFFF.DO#0A.......................trnerr("A.fiel
d.too.large.in.a.SLCT.expression")#0A..............
.....RESULTIS.len<<24.|.sh<<16.|.offset#0A.........
........}#0A#0A....CASE.s_neg:#0A....CASE.s_abs:#0A
....CASE.s_not:....a.:#3D.evalconst(h2!x)#0A.......
............ENDCASE#0A.......#0A....CASE.s_mult:#0A
....CASE.s_div:#0A....CASE.s_rem:#0A....CASE.s_plus
:#0A....CASE.s_minus:#0A....CASE.s_lshift:#0A....CA
SE.s_rshift:#0A....CASE.s_logor:#0A....CASE.s_logan
d:#0A....CASE.s_eqv:#0A....CASE.s_neqv:...a,.b.:#3D
.evalconst(h2!x),.evalconst(h3!x)#0A...............
....ENDCASE#0A#0A....DEFAULT:#0A..}#0A....#0A..SWIT
CHON.h1!x.INTO#0A..{.CASE.s_neg:....RESULTIS..-..a#0A
....CASE.s_abs:....RESULTIS.ABS.a#0A....CASE.s_not:
....RESULTIS.NOT.a#0A.......#0A....CASE.s_mult:...R
ESULTIS.a...*....b#0A....CASE.s_plus:...RESULTIS.a.
..+....b#0A....CASE.s_minus:..RESULTIS.a...-....b#0A
....CASE.s_lshift:.RESULTIS.a...<<...b#0A....CASE.s
_rshift:.RESULTIS.a...>>...b#0A....CASE.s_logor:..R
ESULTIS.a...|....b#0A....CASE.s_logand:.RESULTIS.a.
..&....b#0A....CASE.s_eqv:....RESULTIS.a..EQV...b#0A
....CASE.s_neqv:...RESULTIS.a..NEQV..b#0A....CASE.s
_div:....UNLESS.b#3D0.RESULTIS.a.../....b#0A....CAS
E.s_rem:....UNLESS.b#3D0.RESULTIS.a..REM...b#0A....
...#0A....DEFAULT:#0A..}#0A#0A..trnerr("Error.in.ma
nifest.expression")#0A..RESULTIS.0#0A}#0A#0AAND.ass
ign(x,.y).BE#0A{.IF.x#3D0.|.y#3D0.DO.{.trnerr("Comp
iler.error.in.assign")#0A....................RETURN
#0A..................}#0A#0A..UNLESS.(h1!x#3Ds_comm
a)#3D(h1!y#3Ds_comma).DO#0A..................{.trne
rr("Bad.simultaneous.assignment")#0A...............
.....RETURN#0A..................}#0A.#0A..SWITCHON.
h1!x.INTO#0A..{.CASE.s_comma:..assign(h2!x,.h2!y)#0A
...................assign(h3!x,.h3!y)#0A...........
........RETURN#0A.#0A....CASE.s_name:...load(y)#0A.
..................transname(x,.s_sp,.s_sg,.s_sl,.0,
.0)#0A...................ssp.:#3D.ssp.-.1#0A.......
............RETURN#0A.#0A....CASE.s_byteap:.load(y)
#0A...................load(h2!x)#0A................
...load(h3!x)#0A...................out1(s_putbyte)#0A
...................ssp:#3Dssp-3#0A.................
..RETURN#0A.#0A....CASE.s_rv:#0A....CASE.s_vecap:..
load(y)#0A...................loadlv(x)#0A..........
.........out1(s_stind)#0A...................ssp.:#3D
.ssp.-.2#0A...................RETURN#0A.#0A....CASE
.s_of:...{.LET.slct.#3D.evalconst(h2!x).//.Inserted
.11/7/01#0A...................LET.len.#3D.slct>>24#0A
...................LET.sh..#3D.slct>>16.&.255#0A...
................LET.offset.#3D.slct.&.#23xFFFF#0A..
.................LET.mask.#3D.-1#0A................
...IF.len>0.DO.mask.:#3D.(1<<len)-1#0A.............
......mask.:#3D.mask<<sh#0A//writef("Compiling.(SLC
T.%n:%n:%n).OF.x.:#3D.y*n",.len,.sh,.offset)#0A//wr
itef("Load.y*n")#0A...................load(y)#0A...
................IF.sh.DO#0A...................{.out
2(s_ln,.sh)#0A.....................out1(s_lshift)#0A
//writef("lshift.by.%n*n",.sh)#0A..................
.}#0A#0A...................UNLESS.mask#3D-1.DO#0A..
.................{.load(h3!x)#0A...................
..IF.offset.DO#0A.....................{.out2(s_ln,.
offset)#0A.......................out1(s_plus)#0A...
..................}#0A.....................out1(s_r
v)#0A.....................out1(s_neqv)#0A..........
...........ssp.:#3D.ssp-1#0A//writef("xor.x!%n*n",.
offset)#0A.....................out2(s_ln,.mask)#0A.
....................out1(s_logand).//.bits.to.chang
e.in.x#0A//writef("mask.with.%bW*n",.mask)#0A#0A...
..................load(h3!x)#0A....................
.IF.offset.DO#0A.....................{.out2(s_ln,.o
ffset)#0A.......................out1(s_plus)#0A....
.................}#0A.....................out1(s_rv
)#0A.....................out1(s_neqv)#0A//writef("x
or.with.x!%n*n",.offset)#0A.....................ssp
.:#3D.ssp-1#0A...................}#0A#0A...........
........load(h3!x)#0A...................IF.offset.D
O#0A...................{.out2(s_ln,.offset)#0A.....
................out1(s_plus)#0A...................}
#0A...................out1(s_stind)#0A//writef("sto
re.in.x!%n*n",.offset)#0A...................ssp.:#3D
.ssp-2#0A//writef("stind*n")#0A...................R
ETURN#0A.................}#0A#0A....DEFAULT:.......
trnerr("Ltype.expression.needed")#0A..}#0A}#0A.#0A.
#0AAND.transname(x,.p,.g,.l,.f,.n).BE#0A{.LET.c.#3D
.cellwithname(x)#0A..LET.k,.a.#3D.h2!c,.h3!c#0A.#0A
..SWITCHON.k.INTO#0A..{.DEFAULT:........trnerr("Nam
e.'%s'.not.declared",.@h3!x)#0A...#0A....CASE.s_glo
bal:..out2(g,.a)#0A....................IF.xrefing.D
O.xref(x,."G:",.a,.g)#0A....................RETURN#0A
.#0A....CASE.s_local:...IF.c<dvecp.DO#0A...........
..............trnerr("Dynamic.free.variable.'%s'.us
ed",.@h3!x)#0A....................out2(p,.a)#0A....
................//IF.xrefing.DO.xref(x,."P:",.a,.p)
#0A....................RETURN#0A.#0A....CASE.s_stat
ic:..out2(l,.a)#0A....................IF.xrefing.DO
.xref(x,."S:",.a,.l)#0A....................RETURN#0A
.#0A....CASE.s_label:...IF.f#3D0.DO#0A.............
.......{.trnerr("Misuse.of.entry.name.'%s'",.@h3!x)
#0A......................f.:#3D.p#0A...............
.....}#0A....................out2(f,.a)#0A.........
...........IF.xrefing.DO.xref(x,."F:",.a,.f)#0A....
................RETURN#0A#0A....CASE.s_manifest:IF.
n#3D0.DO#0A....................{.trnerr("Misuse.of.
MANIFEST.name.'%s'",.@h3!x)#0A.....................
.n.:#3D.p#0A....................}#0A...............
.....out2(n,.a)#0A....................IF.xrefing.DO
.xref(x,."M:",.a,.n)#0A..}#0A}#0A#0AAND.xref(x,.kst
r,.n,.op).BE#0A{.LET.name.#3D.@h3!x#0A..LET.fno.#3D
.comline>>20#0A..LET.lno.#3D.comline.&.#23xFFFFF#0A
..LET.file.#3D.sourcenamev!fno#0A..writef("%s.%s%n.
",.name,.kstr,.n)#0A#0A..SWITCHON.op.INTO#0A..{.DEF
AULT:.........writef("op%n",.op);.ENDCASE#0A....CAS
E.s_fndef:....writef("FN");.......ENDCASE#0A....CAS
E.s_rtdef:....writef("RT");.......ENDCASE#0A....CAS
E.s_valdef:...writef("VAL");......ENDCASE#0A....CAS
E.s_vecdef:...writef("VEC");......ENDCASE#0A....CAS
E.s_constdef:.writef("DEF");......ENDCASE#0A....CAS
E.s_const:....writef("MAN");......ENDCASE#0A....CAS
E.s_colon:....writef("LAB");......ENDCASE#0A....CAS
E.s_sp:.......writef("SP");.......ENDCASE#0A....CAS
E.s_sg:.......writef("SG");.......ENDCASE#0A....CAS
E.s_sl:.......writef("SL");.......ENDCASE#0A....CAS
E.s_llp:......writef("LLP");......ENDCASE#0A....CAS
E.s_llg:......writef("LLG");......ENDCASE#0A....CAS
E.s_lll:......writef("LLL");......ENDCASE#0A....CAS
E.s_lp:.......writef("LP");.......ENDCASE#0A....CAS
E.s_lg:.......writef("LG");.......ENDCASE#0A....CAS
E.s_ll:.......writef("LL");.......ENDCASE#0A....CAS
E.s_lf:.......writef("LF");.......ENDCASE#0A....CAS
E.s_ln:.......writef("LN");.......ENDCASE#0A..}#0A.
.wrch('.')#0A..IF.file.DO.writef("%s",.file)#0A..wr
itef("[%n].",.lno)#0A#0A..prctxt(context)#0A#0A..ne
wline()#0A}#0A#0AAND.prctxt(x).BE.IF.x.DO.#0A{.LET.
op.#3D.h1!x#0A..SWITCHON.op.INTO#0A..{.DEFAULT:..pr
ctxte(x,.4,.0);.RETURN#0A#0A....CASE.s_fndef:#0A...
......writef("LET.")#0A.........prctxte(h2!x,.5,.0)
#0A.........wrch('(')#0A.........prctxte(h3!x,.7,.0
)#0A.........writef(")#3D#2E#2E")#0A.........RETURN
#0A#0A....CASE.s_rtdef:#0A.........writef("LET.")#0A
.........prctxte(h2!x,.5,.0)#0A.........wrch('(')#0A
.........prctxte(h3!x,.7,.0)#0A.........writef(")BE
#2E#2E")#0A.........RETURN#0A#0A....CASE.s_valdef:#0A
.........writef("LET.")#0A.........prctxte(h2!x,.5,
.0)#0A.........writef("#3D")#0A.........prctxte(h3!
x,.5,.0)#0A.........RETURN#0A#0A....CASE.s_vecdef:#0A
.........writef("LET.")#0A.........prctxte(h2!x,.5,
.0)#0A.........writef("#3DVEC.")#0A.........prctxte
(h3!x,.5,.0)#0A.........RETURN#0A#0A....CASE.s_cons
tdef:#0A.........prctxte(h3!x,.5,.0)#0A.........wri
tef("#3D")#0A.........prctxte(h4!x,.5,.0)#0A.......
..RETURN#0A#0A....CASE.s_let:#0A.........writef("LE
T.")#0A.........prctxtd(h2!x,.2)#0A.........writef(
";.")#0A.........prctxtc(h3!x,.2)#0A.........RETURN
#0A.#0A....CASE.s_static:....writef("STATIC#2E#2E")
;....RETURN#0A....CASE.s_global:....writef("GLOBAL#2E
#2E");....RETURN#0A....CASE.s_manifest:..writef("MA
NIFEST#2E#2E");..RETURN#0A#0A....CASE.s_ass:#0A....
.....prctxte(h2!x,.4,.0)#0A.........writef(":#3D")#0A
.........prctxte(h3!x,.4,.0)#0A.........RETURN#0A.#0A
....CASE.s_rtap:#0A.........prctxte(h2!x,.2,.12)#0A
.........writef("(")#0A.........prctxte(h3!x,.3,.0)
#0A.........writef(")")#0A.........RETURN#0A.#0A...
.CASE.s_goto:#0A.........writef("GOTO.")#0A........
.prctxte(h2!x,.4,.0)#0A.........RETURN#0A.#0A....CA
SE.s_colon:#0A.........prctxte(h2!x,.2,.0)#0A......
...writef(":")#0A.........prctxt(h3!x,.3)#0A.......
..RETURN#0A.#0A....CASE.s_unless:#0A....CASE.s_if:#0A
....CASE.s_while:#0A....CASE.s_until:#0A.........wr
itef(op#3Ds_unless->"UNLESS.",#0A................op
#3Ds_if->"IF.",#0A................op#3Ds_until->"UN
TIL.",#0A................"WHILE."#0A...............
)#0A.........prctxte(h2!x,.4,.0)#0A.........writef(
".DO.")#0A.........prctxtc(h3!x,.3)#0A.........RETU
RN#0A#0A.#0A....CASE.s_test:#0A.........writef("TES
T.")#0A.........prctxte(h2!x,.4,.0)#0A.........writ
ef(".THEN.")#0A.........prctxtc(h3!x,.2)#0A........
.writef(".ELSE.")#0A.........prctxtc(h4!x,.2)#0A...
......RETURN#0A.#0A....CASE.s_loop:#0A.........writ
ef("LOOP")#0A.........RETURN#0A.#0A....CASE.s_skip:
#0A.........writef("{}")#0A.........RETURN#0A.#0A..
..CASE.s_break:#0A.........writef("BREAK")#0A......
...RETURN#0A.#0A....CASE.s_return:#0A.........write
f("RETURN")#0A.........RETURN#0A.#0A....CASE.s_fini
sh:#0A.........writef("FINISH")#0A.........RETURN#0A
.#0A....CASE.s_resultis:#0A.........writef("RESULTI
S.")#0A.........prctxte(h2!x,.4,.0)#0A.........RETU
RN#0A.#0A....CASE.s_repeatwhile:#0A....CASE.s_repea
tuntil:#0A.........prctxtc(h2!x,.4)#0A.........writ
ef(op#3Ds_repeatwhile.->.".REPEATWHILE.",.".REPEATU
NTIL.")#0A.........prctxte(h3!x,.4,.0)#0A.........R
ETURN#0A.#0A....CASE.s_repeat:#0A.........prctxtc(h
2!x,.4)#0A.........writef(".REPEAT")#0A.........RET
URN#0A.#0A....CASE.s_case:#0A.........writef("CASE.
")#0A.........prctxte(h2!x,.4,.0)#0A.........writef
(":#2E#2E.")#0A.........RETURN#0A.#0A....CASE.s_def
ault:#0A.........writef("DEFAULT:#2E#2E")#0A.......
..RETURN#0A.#0A....CASE.s_endcase:#0A.........write
f("ENDCASE")#0A.........RETURN#0A.#0A....CASE.s_swi
tchon:#0A.........writef("SWITCHON.")#0A.........pr
ctxte(h2!x,.4,.0)#0A.........writef(".INTO#2E#2E")#0A
.........RETURN#0A.#0A....CASE.s_for:#0A.........wr
itef("FOR.")#0A.........prctxte(h2!x,.4,.0)#0A.....
....writef("#3D")#0A.........prctxte(h3!x,.4,.0)#0A
.........writef(".TO.")#0A.........prctxte(h4!x,.4,
.0)#0A.........IF.h5!x.DO.{.writef(".BY.");.prctxte
(h5!x,.4,.0).}#0A.........writef(".DO#2E#2E")#0A...
......RETURN#0A.#0A....CASE.s_seq:#0A.........prctx
tc(h2!x,.4)#0A.........writef(";")#0A.........prctx
tc(h3!x,.4)#0A.........RETURN#0A..}#0A}#0A#0AAND.pr
ctxtd(x,.d).BE.writef("#2E#2E")#0AAND.prctxtc(x,.d)
.BE.writef("#2E#2E")#0A#0AAND.prctxte(x,.d,.prec).B
E.IF.x.DO#0A{.LET.op.#3D.h1!x#0A#0A..SWITCHON.op.IN
TO#0A..{.DEFAULT:.ENDCASE#0A#0A....CASE.s_number:.#0A
.................{.LET.n.#3D.h2!x#0A...............
....TEST.-1_000_000<#3Dn<#3D1_000_000#0A...........
........THEN.writef("%n",.n)#0A...................E
LSE.writef("#23x%x8",.n)#0A...................RETUR
N#0A.................}.#0A....CASE.s_name:...writef
("%s",.@h3!x);........RETURN#0A....CASE.s_true:...w
ritef("TRUE");.............RETURN#0A....CASE.s_fals
e:..writef("FALSE");............RETURN#0A....CASE.s
_query:..wrch('?');..................RETURN#0A#0A..
..CASE.s_string:.#0A.................{.LET.s.#3D.@h
2!x#0A...................LET.len.#3D.s%0#0A........
...........wrch('"')#0A...................FOR.i.#3D
.1.TO.len.DO#0A...................{.LET.ch.#3D.s%i#0A
.....................IF.i#3D6.&.len>6+8.DO.{.writef
("'");.LOOP.}#0A.....................IF.i<#3D6.|.i>
len-8.DO.//.First.5.and.last.8.chars#0A............
.........{.SWITCHON.ch.INTO#0A.....................
..{.CASE.'**':.writef("****");.LOOP#0A.............
............CASE.'*"':.writef("***"");.LOOP#0A.....
....................CASE.'*n':.writef("**n");..LOOP
#0A.......................}#0A.....................
..UNLESS.32<#3Dch<#3D127.DO.ch.:#3D.'?'#0A.........
..............wrch(ch)#0A.....................}#0A.
..................}#0A...................wrch('"')#0A
...................RETURN#0A.................}#0A#0A
..}#0A#0A..IF.d#3D0.DO.{.writef("#2E#2E#2E");.RETUR
N.}#0A#0A..IF.prec>#3D12.DO.{.wrch('(');.prctxte(x,
.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.op.INTO
#0A..{.DEFAULT:.ENDCASE#0A#0A....CASE.s_fnap:#0A...
......prctxte(h2!x,.d-1,.11)#0A.........wrch('(')#0A
.........prctxte(h3!x,.d-1,.0)#0A.........wrch(')')
#0A.........RETURN#0A..}#0A#0A..IF.prec>#3D11.DO.{.
wrch('(');.prctxte(x,.d,.0);.wrch(')');.RETURN.}#0A
#0A..SWITCHON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A#0A.
...CASE.s_of:#0A....CASE.s_byteap:#0A....CASE.s_vec
ap:#0A.........prctxte(h2!x,.d-1,.10)#0A.........wr
ites(op#3Ds_of->"::",.op#3Ds_byteap->"%",."!")#0A..
.......prctxte(h3!x,.d-1,.10)#0A.........RETURN#0A#0A
....CASE.s_rv:#0A....CASE.s_lv:#0A.........writef(o
p#3Ds_rv->"!","@")#0A.........prctxte(h2!x,.d-1,.10
)#0A.........RETURN#0A..}#0A#0A..IF.prec>#3D10.DO.{
.wrch('(');.prctxte(x,.d,.0);.wrch(')');.RETURN.}#0A
#0A..SWITCHON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A....
CASE.s_mult:.CASE.s_div:.CASE.s_rem:#0A.........prc
txte(h2!x,.d-1,.9)#0A.........writef(op#3Ds_mult->"
**",.op#3Ds_div->"/",.".REM.")#0A.........prctxte(h
3!x,.d-1,.9)#0A.........RETURN#0A..}#0A#0A..IF.prec
>#3D9.DO.{.wrch('(');.prctxte(x,.d,.0);.wrch(')');.
RETURN.}#0A#0A..SWITCHON.op.INTO#0A..{.DEFAULT:.END
CASE#0A....CASE.s_plus:#0A....CASE.s_minus:#0A.....
....prctxte(h2!x,.d-1,.8)#0A.........writef(op#3Ds_
plus->"+","-")#0A.........prctxte(h3!x,.d-1,.8)#0A.
........RETURN#0A#0A....CASE.s_neg:#0A....CASE.s_ab
s:#0A.........writef(op#3Ds_neg->"-","ABS.")#0A....
.....prctxte(h2!x,.d-1,.8)#0A.........RETURN#0A#0A.
.}#0A#0A..IF.prec>#3D8.DO.{.wrch('(');.prctxte(x,.d
,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.op.INTO#0A
..{.DEFAULT:.ENDCASE#0A....CASE.s_eq:.CASE.s_ne:#0A
.........prctxte(h2!x,.d-1,.7)#0A.........writef(op
#3Ds_eq->"#3D","~#3D")#0A.........prctxte(h3!x,.d-1
,.7)#0A.........RETURN#0A....CASE.s_ls:.CASE.s_gr:#0A
.........prctxte(h2!x,.d-1,.7)#0A.........writef(op
#3Ds_ls->"<",">")#0A.........prctxte(h3!x,.d-1,.7)#0A
.........RETURN#0A....CASE.s_le:.CASE.s_ge:#0A.....
....prctxte(h2!x,.d-1,.7)#0A.........writef(op#3Ds_
le->"<#3D",">#3D")#0A.........prctxte(h3!x,.d-1,.7)
#0A.........RETURN#0A..}#0A#0A..IF.prec>#3D7.DO.{.w
rch('(');.prctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A
..SWITCHON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A....CAS
E.s_lshift:.CASE.s_rshift:#0A.........prctxte(h2!x,
.d-1,.6)#0A.........writef(op#3Ds_lshift->"<<",">>"
)#0A.........prctxte(h3!x,.d-1,.6)#0A.........RETUR
N#0A..}#0A#0A..IF.prec>#3D6.DO.{.wrch('(');.prctxte
(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.op.I
NTO#0A..{.DEFAULT:.ENDCASE#0A....CASE.s_not:#0A....
.....wrch('~')#0A.........prctxte(h2!x,.d-1,.5)#0A.
........RETURN#0A..}#0A#0A..IF.prec>#3D5.DO.{.wrch(
'(');.prctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..
SWITCHON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A....CASE.
s_logand:#0A.........prctxte(h2!x,.d-1,.4)#0A......
...wrch('&')#0A.........prctxte(h3!x,.d-1,.4)#0A...
......RETURN#0A..}#0A#0A..IF.prec>#3D4.DO.{.wrch('(
');.prctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SW
ITCHON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A....CASE.s_
logor:#0A.........prctxte(h2!x,.d-1,.3)#0A.........
wrch('|')#0A.........prctxte(h3!x,.d-1,.3)#0A......
...RETURN#0A..}#0A#0A..IF.prec>#3D3.DO.{.wrch('(');
.prctxte(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITC
HON.op.INTO#0A..{.DEFAULT:.ENDCASE#0A....CASE.s_eqv
:#0A....CASE.s_neqv:#0A.........prctxte(h2!x,.d-1,.
2)#0A.........writef(op#3Ds_eqv->".EQV.",".XOR.")#0A
.........prctxte(h3!x,.d-1,.2)#0A.........RETURN#0A
#0A..}#0A#0A..IF.prec>#3D2.DO.{.wrch('(');.prctxte(
x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.op.IN
TO#0A..{.DEFAULT:.ENDCASE#0A....CASE.s_cond:#0A....
.....prctxte(h2!x,.d-1,.1)#0A.........writef("->")#0A
.........prctxte(h3!x,.d-1,.1)#0A.........writef(",
")#0A.........prctxte(h4!x,.d-1,.1)#0A.........RETU
RN#0A..}#0A#0A..IF.prec>#3D1.DO.{.wrch('(');.prctxt
e(x,.d,.0);.wrch(')');.RETURN.}#0A#0A..SWITCHON.op.
INTO#0A..{.DEFAULT:.writef("Op%n",.op);.RETURN#0A#0A
....CASE.s_table:#0A.........writef("TABLE.")#0A...
......prctxte(h2!x,.d-1,.0)#0A.........RETURN#0A...
......#0A....CASE.s_valof:#0A.........writef("VALOF
.{")#0A.........prctxtc(h2!x,.d-1)#0A.........wrch(
'}')#0A.........RETURN#0A#0A....CASE.s_comma:#0A...
......prctxte(h2!x,.d-1,.0)#0A.........writef(",")#0A
.........prctxte(h3!x,.d-1,.0)#0A.........RETURN#0A
..}#0A}#0A#0A#0AAND.out1(x).BE.wrn(x)#0A.#0AAND.out
2(x,.y).BE.{.out1(x);.out1(y).}#0A.#0AAND.outstring
(s).BE.FOR.i.#3D.0.TO.s%0.DO.out1(s%i)#0A

######cintcode/com/bcpl.b#
//.This.is.the.BCPL.to.Cintcode.compiler#0A#0A//.Im
plemented.by.Martin.Richards.(c).May.2009#0A#0A//.N
ote:.#2E#2E/cintcode/.is.used.so.that.the.compiler.
can.be#0A//.compiled.in.a.directory.parallel.to.cin
tcode.(such.as.natbcpl)#2E#0A#0AGET."#2E#2E/cintcod
e/com/bcplfe#2Eb"#0A#0A#2E#0A#0AGET."#2E#2E/cintcod
e/com/bcplcgcin#2Eb"#0A

######cintcode/com/xencode.b#
SECTION."XENCODE"#0A#0AGET."libhdr"#0A#0A/*#0AThis.
program.encodes.a.collection.of.one.or.more.charact
er#0Aor.binary.files.into.a.file.of.printable.chara
cters.with.lines#0Aof.about.50.characters.suitable.
for.transmission.by.email#2E#0A#0AUsage:.xencode."F
ILE,LIST/K,TO/K/A"#0A#0Awhere.FILE.is.the.name.of.a
.single.file.to.encode#0A......LIST.is.a.list.of.fi
le.names.of.files.to.encode#2E#0A.and..TO...is.the.
encoded.file#0A#0AOne.or.other.of.FILE.and.LIST.mus
t.be.supplied#2E#0AIf.both.are.given.FILE.will.give
.the.first.filename.to.be.encoded#0Afollowed.by.tho
se.given.by.LIST#2E#0A#0AEach.encoded.file.is.prece
eded.by.a.separator.of.the.form:#0A#0A#23#23#23#23#23
filename#23#0A#0Afollowed.by.the.encoded.file.in.wh
ich.all.characters.with.ASCII.codes#0Ain.the.range.
33.to.126.except.for.'#23',.'#3D'.and.'#2E'.are.cop
ied,.spaces.are#0Areplaced.by.dots.('#2E').and.all.
other.characters.(including.'#23'.'#3D'.and#0A'#2E'
).are.encoded.by.#23hh.where.hh.is.the.ASCII.code.i
n.hex#2E.The.encoded#0Afile.is.broken.into.lines.of
.about.50.characters#2E#0A#0AThe.last.file.to.be.en
coded.is.terminated.by.#23#23#23#23#23#23+#23#2E#0A
#0ASuch.xencode'd.files.can.be.decoded.by.the.xdeco
de.command#2E#0A#0AWritten.by.Martin.Richards.(c).S
eptember.2008#0A*/#0A#0AGLOBAL#0A{#0Atostream:.ug#0A
stdin#0Astdout#0Aliststream#0A}#0A#0ALET.start().#3D
.VALOF#0A{.LET.file1name.#3D.0#0A..LET.listname.#3D
.0#0A..LET.rc.#3D.0#0A..LET.filename.#3D.VEC.256/by
tesperword#0A..LET.argv.#3D.VEC.50#0A#0A..stdin,.st
dout.:#3D.input(),.output()#0A#0A..tostream.:#3D.0#0A
..liststream.:#3D.0#0A..newline()#0A#0A..IF.rdargs(
"FILE,LIST/K,TO/K/A",.argv,.50).#3D.0.DO#0A..{.writ
es("Bad.args.for.XENCODE*n")#0A....rc.:#3D.20#0A...
.GOTO.exit#0A..}#0A#0A..file1name.:#3D.argv!0......
........//.FILE#0A..listname..:#3D.argv!1..........
....//.LIST#0A#0A..IF.argv!2.DO.{.tostream.:#3D.fin
doutput(argv!2)#0A.................UNLESS.tostream.
DO#0A.................{.writef("Can*'t.open.%s*n",.
argv!2)#0A...................rc.:#3D.20#0A.........
..........GOTO.exit#0A.................}#0A........
.......}#0A#0A#0A..UNLESS.file1name.|.listname.DO#0A
..{.writes("Error:.At.least.one.of.FILE.and.LIST.mu
st.be.given*n")#0A....rc.:#3D.20#0A....GOTO.exit#0A
..}#0A#0A..IF.file1name.DO.xencode(file1name)#0A#0A
..IF.listname..DO.xencodelist(listname)#0A#0A..sele
ctoutput(tostream)#0A#0A..writef("*n#23#23#23#23#23
#23+#23*n").//.The.termination.marker#0A#0Aexit:#0A
...UNLESS.tostream#3D0.DO.{.selectoutput(tostream);
.endwrite().}#0A...RESULTIS.rc#0A}#0A#0AAND.xencode
(name).BE#0A{.LET.oldin.#3D.input()#0A..LET.inputst
ream.#3D.findinput(name)#0A..LET.count.#3D.0#0A#0A.
.UNLESS.inputstream.DO.{.writef("Can*'t.open.%s*n",
.name)#0A..........................RETURN#0A.......
.................}#0A..writef("Encoding.file:.%s*n"
,.name)#0A#0A..selectinput(inputstream)#0A..selecto
utput(tostream)#0A#0A..writef("*n#23#23#23#23#23#23
%s#23*n",.name)#0A#0A..{.LET.ch.#3D.rdch()#0A....IF
.ch#3Dendstreamch.BREAK#0A#0A....TEST.32<#3Dch<127.
&.ch~#3D'#23'.&.ch~#3D'#2E'.&ch~#3D'#3D'#0A....THEN
.{.IF.ch#3D'.'.DO.ch.:#3D.'#2E'#0A...........wrch(c
h)#0A...........count.:#3D.count+1#0A.........}#0A.
...ELSE.{.writef("#23%x2",.ch);.count.:#3D.count+3.
}#0A#0A....IF.count>50.DO.{.newline();.count.:#3D.0
.}#0A..}.REPEAT#0A#0A..newline()#0A..endstream(inpu
tstream)#0A..selectinput(oldin)#0A..selectoutput(st
dout)#0A}#0A#0AAND.xencodelist(name).BE#0A{.LET.lis
tstream.#3D.findinput(name)#0A#0A..UNLESS.liststrea
m.DO.{.writef("Can*'t.open.%s*n",.name)#0A.........
................RETURN#0A.......................}#0A
..selectinput(liststream)#0A#0A..{.LET.ch.#3D.rdch(
)#0A....LET.len.#3D.0#0A....LET.filename.#3D.VEC.25
5/bytesperword#0A#0A....IF.ch#3Dendstreamch.BREAK#0A
....IF.ch#3D'*n'.|.ch#3D'*s'.LOOP#0A....len.:#3D.0#0A
....filename%0.:#3D.0#0A....#0A....UNTIL.ch#3D'*n'.
|.ch#3D'*s'.|.ch#3Dendstreamch.|.len>#3D255.DO#0A..
..{.len.:#3D.len+1#0A......filename%0,.filename%len
.:#3D.len,.ch#0A......ch.:#3D.rdch()#0A....}#0A#0A.
...IF.len.DO.xencode(filename)#0A....IF.ch#3Dendstr
eamch.BREAK#0A..}.REPEAT..#0A#0A..endstream(liststr
eam)#0A}#0A#0A

######cintcode/com/xdecode.b#
SECTION."XDECODE"#0A#0AGET."libhdr"#0A#0A/*#0AThis.
program.decodes.a.file.encoded.by.the.xencode.comma
nd#2E#0ASee.xencode#2Eb.for.details#2E#0A#0AWritten
.by.Martin.Richards.(c).September.2008#0A*/#0A#0AGL
OBAL#0A{#0Ainputstream:ug#0Aoutstream#0Ahashcount#0A
listing#0A}#0A#0ALET.start().#3D.VALOF#0A{.LET.coun
t.#3D.0#0A..LET.argv.#3D.VEC.50#0A..LET.fromname.#3D
."data"#0A..LET.toname.#3D.VEC.256/bytesperword#0A.
.LET.rc.#3D.0#0A..LET.ch.#3D.0#0A..LET.stdout.#3D.o
utput()#0A#0A..inputstream.:#3D.0#0A..outstream.:#3D
.0#0A..listing.:#3D.FALSE#0A..newline()#0A#0A..IF.r
dargs("FROM/A,LIST/S",.argv,.50).#3D.0.DO#0A..{.wri
tes("Bad.args.for.XDECODE*n")#0A.....rc.:#3D.20#0A.
....GOTO.exit#0A..}#0A#0A..fromname.:#3D.argv!0#0A.
.listing..:#3D.argv!1#0A#0A..inputstream.:#3D.findi
nput(fromname)#0A..UNLESS.inputstream.DO.{.writef("
Can*'t.open.%s*n",.fromname)#0A....................
......rc.:#3D.20#0A..........................GOTO.e
xit#0A........................}#0A..selectinput(inp
utstream)#0A#0A..hashcount.:#3D.0#0A#0Anext:#0A..//
.Start.of.main.extraction.loop#0A..selectoutput(std
out)#0A..#0A..{.//.Find.the.next.separator#0A....ch
.:#3D.rdch()#0A#0A....IF.ch#3Dendstreamch.GOTO.exit
#0A#0A....IF.ch#3D'#23'.DO#0A....{.hashcount.:#3D.h
ashcount+1#0A#0A......{.ch.:#3D.rdch()#0A........IF
.ch#3Dendstreamch.GOTO.exit#0A........UNLESS.ch#3D'
#23'.BREAK#0A........hashcount.:#3D.hashcount+1#0A.
.....}.REPEAT#0A#0A......//.Hashcount.#3D.number.of
.consecutive.'#23's#0A......//.If.>#3D.6.then.we.ha
ve.a.separator#2E.It.should.be.of.the.form#0A......
//.#23#23#23#23#23#23filename#23#0A......IF.hashcou
nt>#3D6.DO#0A......{.//.Read.the.filename.into.tona
me#0A........LET.len.#3D.0#0A........toname%0.:#3D.
0#0A........UNTIL.ch#3D'#23'.|.ch#3D'*n'.DO#0A.....
...{.IF.ch#3Dendstreamch.GOTO.exit#0A..........len.
:#3D.len+1#0A..........IF.len>255.BREAK#0A.........
.toname%0,.toname%len.:#3D.len,.ch#0A..........ch.:
#3D.rdch()#0A........}#0A#0A........//writef("Item.
separator.found*n")#0A........//FOR.i.#3D.1.TO.hash
count.DO.wrch('#23')#0A........//writef("%s%c*n",.t
oname,.ch)#0A#0A........IF.toname%0#3D1.&.toname%1#3D
'+'.DO#0A........{.//.Final.terminator.found#0A....
......GOTO.exit#0A........}#0A#0A........UNLESS.ch#3D
'#23'.&.0<len<256.&.hashcount>#3D6.DO#0A........{.w
ritef("Bad.item.separator*n")#0A..........FOR.i.#3D
.1.TO.hashcount.DO.wrch('#23')#0A..........writef("
%s%c*n",.toname,.ch)#0A..........GOTO.exit#0A......
..}#0A........BREAK#0A......}#0A....}#0A..}.REPEATU
NTIL.ch#3Dendstreamch#0A#0A..IF.ch#3Dendstreamch.GO
TO.exit#0A#0A..writef("Decoding.to.file:.%s*n",.ton
ame)#0A#0A..IF.listing.DO.toname.:#3D."NIL:"#0A#0A.
.outstream.:#3D.0#0A#0A..UNLESS.listing.DO#0A..{.ou
tstream.:#3D.findoutput(toname)#0A....UNLESS.outstr
eam.DO#0A....{.writef("Can*'t.open.%s*n",.toname)#0A
......rc.:#3D.20#0A......GOTO.exit#0A....}#0A#0A...
.selectoutput(outstream)#0A..}#0A#0A..{.ch.:#3D.rdc
h()#0A#0A....SWITCHON.ch.INTO#0A....{.DEFAULT:...IF
.outstream.DO.wrch(ch)#0A.................LOOP#0A#0A
......CASE.endstreamch:#0A.................GOTO.exi
t#0A#0A......CASE.'#2E':..IF.outstream.DO.wrch('.')
#0A.................LOOP#0A#0A......CASE.'#3D':....
......//.'#3D'.must.be.escaped!#0A......CASE.'*n':.
LOOP#0A#0A......CASE.'#23':..//.Either.an.escaped.c
haracter.or.the.start.of.a.separator#0A............
...{.LET.a.#3D.rdch()#0A.................LET.b.#3D.
rdch()#0A.................IF.a#3D'#23'.&.b#3D'#23'.
DO#0A.................{.//.It.must.be.a.separator#0A
...................hashcount.:#3D.3#0A.............
......IF.outstream.DO.endstream(outstream)#0A......
.............outstream.:#3D.0#0A...................
selectoutput(stdout)#0A...................GOTO.next
#0A.................}#0A.................IF.a#3Dend
streamch.|.b#3Dendstreamch.GOTO.exit#0A............
.....//.Otherwise.write.escaped.character#0A.......
..........IF.outstream.DO.wrch((value(a)<<4).+.valu
e(b))#0A.................LOOP#0A...............}#0A
....}#0A..}.REPEAT#0A#0Aexit:#0A..IF.inputstream..D
O.{.endstream(inputstream);.inputstream.:#3D.0.}#0A
..IF.outstream....DO.{.endstream(outstream);...outs
tream.:#3D.0.}#0A..RESULTIS.rc#0A}#0A#0AAND.value(c
h).#3D.VALOF.SWITCHON.ch.INTO#0A{.DEFAULT:#0A....wr
itef("#23#23%x2#23#23",.ch)#0A....RESULTIS.0#0A#0A.
.CASE.'0':CASE.'1':CASE.'2':CASE.'3':CASE.'4':#0A..
CASE.'5':CASE.'6':CASE.'7':CASE.'8':CASE.'9':#0A...
.RESULTIS.ch-'0'#0A....#0A..CASE.'A':CASE.'B':CASE.
'C':CASE.'D':CASE.'E':#0A..CASE.'F':#0A....RESULTIS
.ch.-.'A'.+.10#0A#0A..CASE.'a':CASE.'b':CASE.'c':CA
SE.'d':CASE.'e':#0A..CASE.'f':#0A....RESULTIS.ch.-.
'a'.+.10#0A}#0A

######cintcode/com/sortxref.b#
/*#0AThis.is.a.program.to.sort.raw.xref.data.into.a
lpabetical.order#0Aremoving.duplicates#2E#0A#0AImpl
emented.by.Martin.Richards.(c).3.April.2009#0A#0A*/
#0A#0AGET."libhdr"#0A#0AGLOBAL.{#0A..fromname:.ug#0A
..toname#0A..fromstream#0A..tostream#0A..stdin#0A..
stdout#0A..blklist..//.List.of.4096.word.block.to.h
old.the.sorted.binary#0A...........//.tree.of.xref.
lines#2E#0A..tree.....//.The.root.of.the.binary.tre
e.of.nodes#2E#0A..optfns#0A}#0A#0AMANIFEST.{#0A..bl
kupb.#3D.4095#0A}#0A#0ALET.start().#3D.VALOF#0A{.LE
T.format.#3D."from/a,to/k,fns/s"#0A..LET.argv.#3D.V
EC.50#0A..LET.linev.#3D.VEC.256/bytesperword#0A#0A.
.blklist.:#3D.0#0A..tree.:#3D.0#0A..stdin,.stdout.:
#3D.input(),.output()#0A..fromstream,.tostream.:#3D
.0,.0#0A..fromname,.toname.:#3D."**",."**"#0A#0A..U
NLESS.rdargs(format,.argv,.50).DO#0A..{.writef("Bad
.argument.for.format:.%s*n",.format)#0A....RESULTIS
.0#0A..}#0A#0A..fromname.:#3D.argv!0#0A..fromstream
.:#3D.findinput(fromname)#0A..UNLESS.fromstream.DO#0A
..{.writef("Unable.to.read.file:.%s*n",.fromname)#0A
....RESULTIS.0#0A..}#0A#0A..IF.argv!1.DO#0A..{.tona
me.:#3D.argv!1#0A....tostream.:#3D.findoutput(tonam
e)#0A....UNLESS.tostream.DO#0A....{.writef("Unable.
to.output.to.file:.%s*n",.toname)#0A......RESULTIS.
0#0A....}#0A..}#0A#0A..optfns.:#3D.argv!2#0A#0A..wr
itef("*nsorting.xrefs.from.%s.to.%s*n",.fromname,.t
oname)#0A..selectinput(fromstream)#0A#0A..WHILE.rdl
ine(linev).IF.filter(linev).DO.insertnode(linev)#0A
#0A..IF.tostream.DO.selectoutput(tostream)#0A..prtr
ee(tree)#0A#0Afin:#0A//abort(1000)#0A..IF.fromstrea
m.DO.endstream(fromstream)#0A..IF.tostream.&.tostre
am~#3Dstdout.DO.endstream(tostream)#0A#0A..WHILE.bl
klist.DO#0A..{.LET.blk.#3D.blklist#0A....blklist.:#3D
.!blk#0A....freevec(blk)#0A..}#0A..selectoutput(std
out)#0A..writef("done*n")#0A..RESULTIS.0#0A}#0A#0AA
ND.rdline(lnv).#3D.VALOF#0A{.LET.len.#3D.0#0A#0A..{
.LET.ch.#3D.rdch()#0A....IF.ch#3D'*c'.BREAK#0A....I
F.ch#3D'*n'.BREAK#0A....IF.ch#3Dendstreamch.RESULTI
S.0#0A....len.:#3D.len+1#0A....IF.len<#3D255.DO.lnv
%len.:#3D.ch....#0A..}.REPEAT#0A#0A..IF.len>255.DO.
len.:#3D.255#0A..lnv%0.:#3D.len#0A//writef("rdline:
.%s*n",.lnv)#0A..RESULTIS.TRUE.//.Successful.return
#0A}#0A#0AAND.filter(lnv).#3D.VALOF#0A{.//.Returns.
TRUE.if.lnv.contains.G:,.M:,.F:.or.S:#0A..LET.len.#3D
.lnv%0#0A..FOR.i.#3D.2.TO.len.IF.lnv%i#3D':'.DO#0A.
.{.LET.ch.#3D.lnv%(i-1)#0A....IF.ch#3D'G'.|.ch#3D'M
'.|.ch#3D'F'.|.ch#3D'S'.DO#0A....{.IF.optfns.DO#0A.
.....{.//.OK.if.lnv.contains.".RT.".or.".FN."#0A...
.....FOR.i.#3D.1.TO.len-3.IF.lnv%i#3D'.'.&.lnv%(i+3
)#3D'*s'.DO#0A........{.LET.a,.b.#3D.lnv%(i+1),.lnv
%(i+2)#0A..........IF.a#3D'R'.&.b#3D'T'.RESULTIS.TR
UE#0A..........IF.a#3D'F'.&.b#3D'N'.RESULTIS.TRUE#0A
........}#0A........RESULTIS.FALSE#0A......}#0A....
..RESULTIS.TRUE#0A....}#0A..}#0A..RESULTIS.FALSE#0A
}#0AAND.insertnode(str).BE.TEST.tree#0ATHEN.{.LET.t
.#3D.tree#0A#0A.......{.//.Find.the.position.in.the
.tree.to.insert.the.node#0A.........LET.rel.#3D.com
p(str,.@t!2)#0A.........LET.a.#3D.t#0A.........UNLE
SS.rel.RETURN.//.str.is.a.duplicate.so.don't.insert
#0A.........IF.rel>0.DO.a.:#3D.a+1#0A.........t.:#3D
.!a#0A.........UNLESS.t.DO.{.!a.:#3D.mknode(str);.R
ETURN.}#0A.......}.REPEATWHILE.t#0A#0A.....}#0AELSE
.tree.:#3D.mknode(str)#0A#0AAND.comp(s1,.s2).#3D.VA
LOF#0A{.LET.len1,.len2.#3D.s1%0,.s2%0#0A..LET.minle
n.#3D.len1<len2.->.len1,.len2#0A..FOR.i.#3D.1.TO.mi
nlen.DO#0A..{.LET.ch1,.ch2.#3D.s1%i,.s2%i#0A....IF.
ch1<ch2.RESULTIS.-1#0A....IF.ch1>ch2.RESULTIS.+1#0A
..}#0A..IF.len1<len2.RESULTIS.-1#0A..IF.len1>len2.R
ESULTIS.+1#0A..RESULTIS.0................//.The.str
ings.are.equal#0A}#0A#0AAND.mknode(str).#3D.VALOF#0A
{.//.Returns.the.pointer.to.the.new.node#0A..LET.no
desize.#3D.2.+.str%0/bytesperword.+.1.//.[left,.rig
ht,.<bytes>]#0A#0A//..writef("mknode:.str#3D%s*n",.
str)#0A#0A..IF.blklist#3D0.DO#0A..{.blklist.:#3D.ge
tvec(blkupb)#0A//writef("mknode:.allocating.blk.%n.
upb#3D%n*n",.blklist,.blkupb)#0A//abort(1000)#0A...
.UNLESS.blklist.RESULTIS.0#0A....blklist!0,.blklist
!1.:#3D.0,.1#0A..}#0A#0A..IF.blklist!1+nodesize.>.b
lkupb.DO#0A..{.//.There.is.insufficient.room.for.th
e.new.node.so.a.new#0A....//.block.must.be.allocate
d#2E#0A....LET.nb.#3D.getvec(blkupb)#0A....UNLESS.n
b.RESULTIS.0#0A....nb!0,.nb!1.:#3D.blklist,.1#0A...
.blklist.:#3D.nb#0A//writef("mknode:.allocating.blk
.%n.upb#3D%n*n",.blklist,.blkupb)#0A//abort(1001)#0A
..}#0A..//.The.current.block.is.large.enough.for.th
e.new.node#0A#0A..{.LET.pos.#3D.blklist!1........./
/.Position.of.the.new.node#0A....LET.node.#3D.@blkl
ist!pos.+.1.//.Pointer.to.new.node#0A....LET.newstr
.#3D.node+2.........//.Pointer.to.the.node.string.b
ytes#0A....blklist!1.:#3D.pos.+.nodesize#0A//writef
("mknode:.making.node#3D%n..str#3D%s*n",.node,.str)
#0A....node!0,.node!1.:#3D.0,.0....//.Null.left.and
.right.children#0A....FOR.i.#3D.0.TO.str%0/bytesper
word.DO.newstr!i.:#3D.str!i#0A....RESULTIS.node#0A.
.}#0A}#0A#0AAND.prtree(t).BE.IF.t.DO#0A{.//.t.#3D.0
..or..t.->.[left,.right,.<string>]#0A..LET.x,.y.#3D
.t!0,.t!1#0A..IF.x.DO.prtree(x)#0A..writef("%s*n",.
@t!2)#0A..IF.y.DO.prtree(y)#0A}#0A

######+#
